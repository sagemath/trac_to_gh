# Issue 13963: Fix checking for and resetting GAP workspaces

archive/issues_013759.json:
```json
{
    "assignees": [
        "https://github.com/sagetrac-GeorgSWeber"
    ],
    "body": "It seems that nothing really guarantees the existence of the directory `SAGE_EXTCODE` (`$SAGE_ROOT/local/share/sage/ext`) apart from the installers of some packages.\n\nIf Sage is started when that directory doesn't exist:\n\n```\n[...lots of stuff...]\n/release/merger/sage-5.7.beta0/local/lib/python2.7/site-packages/sage/interfaces/gap.py in <module>()\n   1457 # if the modification time of the gap link has changed (which signals\n   1458 # that gap has been somehow upgraded).\n-> 1459 if not os.path.exists(WORKSPACE) or os.path.getmtime(WORKSPACE) < os.path.getmtime(GAP_STAMP):\n   1460     #print \"Automatically updating the cached Gap workspace:\"\n   1461     #print WORKSPACE\n\n/release/merger/sage-5.7.beta0/local/lib/python/genericpath.py in getmtime(filename)\n     52 def getmtime(filename):\n     53     \"\"\"Return the last modification time of a file, reported by os.stat().\"\"\"\n---> 54     return os.stat(filename).st_mtime\n     55\n     56\n```\n\nThis is a regression because conway_polynomials from #12205 **runs Sage code at build time** at a time when the existence of `SAGE_EXTCODE` is not guaranteed.\n\nThe attached patch solves this problem in two ways:\n* It only checks for and generates workspaces when actually starting GAP, not when Sage is started.\n* Instead of using `SAGE_EXTCODE` (which doesn't really make sense), check the modification time of `$SAGE_LOCAL/bin/gap`.\n\n\n**Apply**: [attachment: 13963_gap_stamp.patch](https://github.com/sagemath/sage/files/ticket13963/13963_gap_stamp.patch.gz)\n\n**spkg**: [http://boxen.math.washington.edu/home/jdemeyer/spkg/gap-4.5.7.p2.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/gap-4.5.7.p2.spkg) (diff: [attachment: gap-4.5.7.p2.diff](https://github.com/sagemath/sage/files/ticket13963/gap-4.5.7.p2.diff.gz))\n\n**optional spkg**: [http://boxen.math.washington.edu/home/jdemeyer/spkg/gap_packages-4.5.7.p0.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/gap_packages-4.5.7.p0.spkg) (diff: [attachment: gap_packages-4.5.7.p0.diff](https://github.com/sagemath/sage/files/ticket13963/gap_packages-4.5.7.p0.diff.gz))\n\nComponent: **build**\n\nAuthor: **Jeroen Demeyer**\n\nReviewer: **Volker Braun**\n\nMerged: **sage-5.7.beta0**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/13963_\n\n",
    "closed_at": "2013-01-21T21:09:37Z",
    "created_at": "2013-01-17T11:37:26Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20build",
        "https://github.com/sagemath/sage/labels/p%3A%20critical%20/%202",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.7",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Fix checking for and resetting GAP workspaces",
    "type": "issue",
    "updated_at": "2013-01-21T21:09:37Z",
    "url": "https://github.com/sagemath/sage/issues/13963",
    "user": "https://github.com/jdemeyer"
}
```
It seems that nothing really guarantees the existence of the directory `SAGE_EXTCODE` (`$SAGE_ROOT/local/share/sage/ext`) apart from the installers of some packages.

If Sage is started when that directory doesn't exist:

```
[...lots of stuff...]
/release/merger/sage-5.7.beta0/local/lib/python2.7/site-packages/sage/interfaces/gap.py in <module>()
   1457 # if the modification time of the gap link has changed (which signals
   1458 # that gap has been somehow upgraded).
-> 1459 if not os.path.exists(WORKSPACE) or os.path.getmtime(WORKSPACE) < os.path.getmtime(GAP_STAMP):
   1460     #print "Automatically updating the cached Gap workspace:"
   1461     #print WORKSPACE

/release/merger/sage-5.7.beta0/local/lib/python/genericpath.py in getmtime(filename)
     52 def getmtime(filename):
     53     """Return the last modification time of a file, reported by os.stat()."""
---> 54     return os.stat(filename).st_mtime
     55
     56
```

This is a regression because conway_polynomials from #12205 **runs Sage code at build time** at a time when the existence of `SAGE_EXTCODE` is not guaranteed.

The attached patch solves this problem in two ways:
* It only checks for and generates workspaces when actually starting GAP, not when Sage is started.
* Instead of using `SAGE_EXTCODE` (which doesn't really make sense), check the modification time of `$SAGE_LOCAL/bin/gap`.


**Apply**: [attachment: 13963_gap_stamp.patch](https://github.com/sagemath/sage/files/ticket13963/13963_gap_stamp.patch.gz)

**spkg**: [http://boxen.math.washington.edu/home/jdemeyer/spkg/gap-4.5.7.p2.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/gap-4.5.7.p2.spkg) (diff: [attachment: gap-4.5.7.p2.diff](https://github.com/sagemath/sage/files/ticket13963/gap-4.5.7.p2.diff.gz))

**optional spkg**: [http://boxen.math.washington.edu/home/jdemeyer/spkg/gap_packages-4.5.7.p0.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/gap_packages-4.5.7.p0.spkg) (diff: [attachment: gap_packages-4.5.7.p0.diff](https://github.com/sagemath/sage/files/ticket13963/gap_packages-4.5.7.p0.diff.gz))

Component: **build**

Author: **Jeroen Demeyer**

Reviewer: **Volker Braun**

Merged: **sage-5.7.beta0**

_Issue created by migration from https://trac.sagemath.org/ticket/13963_





---

archive/issue_events_194247.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-17T11:37:26Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "milestone_number": null,
    "milestone_title": "sage-5.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13963#event-194247"
}
```



---

archive/issue_events_194248.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-17T11:37:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20build",
    "label_color": "0000b0",
    "label_name": "c: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13963#event-194248"
}
```



---

archive/issue_events_194249.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-17T11:37:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20critical%20/%202",
    "label_color": "ff7700",
    "label_name": "p: critical / 2",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13963#event-194249"
}
```



---

archive/issue_events_194250.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-17T11:37:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13963#event-194250"
}
```



---

archive/issue_events_194251.json:
```json
{
    "actor": "https://github.com/sagetrac-GeorgSWeber",
    "created_at": "2013-01-17T11:37:26Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "subject": "https://github.com/jdemeyer",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13963#event-194251"
}
```



---

archive/issue_comments_165258.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -30,3 +30,5 @@\n      55\n      56\n ```\n+\n+See also #13123, which (indirectly) caused this issue.\n``````\n",
    "created_at": "2013-01-17T11:43:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13963#issuecomment-165258",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -30,3 +30,5 @@
      55
      56
 ```
+
+See also #13123, which (indirectly) caused this issue.
``````




---

archive/issue_comments_165259.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,9 +1,4 @@\n-It seems that nothing really guarantees the existence of the directory\n-\n-```\n-$SAGE_ROOT/local/share/sage/ext\n-```\n-apart from the installers of some packages.\n+It seems that nothing really guarantees the existence of the directory `SAGE_EXTCODE` (`$SAGE_ROOT/local/share/sage/ext`) apart from the installers of some packages.\n \n When Sage is started when that directory doesn't exist:\n \n@@ -31,4 +26,6 @@\n      56\n ```\n \n+This is a regression because conway_polynomials from #12205 **runs Sage code at build time** at a time when the existence of `SAGE_EXTCODE` is not guaranteed.\n+\n See also #13123, which (indirectly) caused this issue.\n``````\n",
    "created_at": "2013-01-17T11:47:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13963#issuecomment-165259",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,9 +1,4 @@
-It seems that nothing really guarantees the existence of the directory
-
-```
-$SAGE_ROOT/local/share/sage/ext
-```
-apart from the installers of some packages.
+It seems that nothing really guarantees the existence of the directory `SAGE_EXTCODE` (`$SAGE_ROOT/local/share/sage/ext`) apart from the installers of some packages.
 
 When Sage is started when that directory doesn't exist:
 
@@ -31,4 +26,6 @@
      56
 ```
 
+This is a regression because conway_polynomials from #12205 **runs Sage code at build time** at a time when the existence of `SAGE_EXTCODE` is not guaranteed.
+
 See also #13123, which (indirectly) caused this issue.
``````




---

archive/issue_comments_165260.json:
```json
{
    "body": "Attachment: **[13963_gap_stamp.patch.gz](https://github.com/sagemath/sage/files/ticket13963/13963_gap_stamp.patch.gz)**",
    "created_at": "2013-01-17T13:30:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13963#issuecomment-165260",
    "user": "https://github.com/jdemeyer"
}
```

Attachment: **[13963_gap_stamp.patch.gz](https://github.com/sagemath/sage/files/ticket13963/13963_gap_stamp.patch.gz)**



---

archive/issue_comments_165261.json:
```json
{
    "body": "Author: **Jeroen Demeyer**",
    "created_at": "2013-01-17T13:32:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13963#issuecomment-165261",
    "user": "https://github.com/jdemeyer"
}
```

Author: **Jeroen Demeyer**



---

archive/issue_comments_165262.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -28,4 +28,6 @@\n \n This is a regression because conway_polynomials from #12205 **runs Sage code at build time** at a time when the existence of `SAGE_EXTCODE` is not guaranteed.\n \n-See also #13123, which (indirectly) caused this issue.\n+The attached patch solves this problem in two ways:\n+* It only checks for and generates workspaces when actually starting GAP, not when Sage is started.\n+* Instead of using `SAGE_EXTCODE` (which doesn't really make sense), check the modification time of `$SAGE_LOCAL/bin/gap`.\n``````\n",
    "created_at": "2013-01-17T13:32:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13963#issuecomment-165262",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -28,4 +28,6 @@
 
 This is a regression because conway_polynomials from #12205 **runs Sage code at build time** at a time when the existence of `SAGE_EXTCODE` is not guaranteed.
 
-See also #13123, which (indirectly) caused this issue.
+The attached patch solves this problem in two ways:
+* It only checks for and generates workspaces when actually starting GAP, not when Sage is started.
+* Instead of using `SAGE_EXTCODE` (which doesn't really make sense), check the modification time of `$SAGE_LOCAL/bin/gap`.
``````




---

archive/issue_events_194252.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-17T13:32:19Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13963#event-194252"
}
```



---

archive/issue_events_194253.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-17T13:32:45Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "title_is": "Sage doesn't start if SAGE_EXTCODE doesn't exist",
    "title_was": "Failure running Sage when local/share/sage/ext doesn't exist",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13963#event-194253"
}
```



---

archive/issue_events_194254.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-17T13:40:23Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "title_is": "Fix checking for and resetting GAP workspaces",
    "title_was": "Sage doesn't start if SAGE_EXTCODE doesn't exist",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13963#event-194254"
}
```



---

archive/issue_comments_165263.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,16 +1,9 @@\n It seems that nothing really guarantees the existence of the directory `SAGE_EXTCODE` (`$SAGE_ROOT/local/share/sage/ext`) apart from the installers of some packages.\n \n-When Sage is started when that directory doesn't exist:\n+If Sage is started when that directory doesn't exist:\n \n ```\n [...lots of stuff...]\n-/release/merger/sage-5.7.beta0/local/lib/python2.7/site-packages/sage/interfaces/all.py in <module>()\n-      7\n-      8 from expect import is_ExpectElement\n-----> 9 from gap import gap, gap_reset_workspace, gap_console, gap_version, set_gap_memory_pool_size, is_GapElement, Gap\n-     10 from gap3 import gap3, gap3_console, gap3_version, Gap3\n-     11 from genus2reduction import genus2reduction, Genus2reduction\n-\n /release/merger/sage-5.7.beta0/local/lib/python2.7/site-packages/sage/interfaces/gap.py in <module>()\n    1457 # if the modification time of the gap link has changed (which signals\n    1458 # that gap has been somehow upgraded).\n``````\n",
    "created_at": "2013-01-17T13:40:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13963#issuecomment-165263",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,16 +1,9 @@
 It seems that nothing really guarantees the existence of the directory `SAGE_EXTCODE` (`$SAGE_ROOT/local/share/sage/ext`) apart from the installers of some packages.
 
-When Sage is started when that directory doesn't exist:
+If Sage is started when that directory doesn't exist:
 
 ```
 [...lots of stuff...]
-/release/merger/sage-5.7.beta0/local/lib/python2.7/site-packages/sage/interfaces/all.py in <module>()
-      7
-      8 from expect import is_ExpectElement
-----> 9 from gap import gap, gap_reset_workspace, gap_console, gap_version, set_gap_memory_pool_size, is_GapElement, Gap
-     10 from gap3 import gap3, gap3_console, gap3_version, Gap3
-     11 from genus2reduction import genus2reduction, Genus2reduction
-
 /release/merger/sage-5.7.beta0/local/lib/python2.7/site-packages/sage/interfaces/gap.py in <module>()
    1457 # if the modification time of the gap link has changed (which signals
    1458 # that gap has been somehow upgraded).
``````




---

archive/issue_comments_165264.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\n+1\n\nIn the long run it would also be nice to have just a single cache dir with a single hashing scheme for SAGE_ROOT. Right now we have at least\n\n```\n~/.sage/gap/workspace-1816283156629376178\n~/.sage/cache/_home_vbraun_opt_sage-5.6.rc0_devel_sage-main-lazy_import_cache.pickle\n```",
    "created_at": "2013-01-17T14:02:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13963#issuecomment-165264",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:6" align="right">comment:6</div>

+1

In the long run it would also be nice to have just a single cache dir with a single hashing scheme for SAGE_ROOT. Right now we have at least

```
~/.sage/gap/workspace-1816283156629376178
~/.sage/cache/_home_vbraun_opt_sage-5.6.rc0_devel_sage-main-lazy_import_cache.pickle
```



---

archive/issue_events_194255.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-01-17T14:02:19Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13963#event-194255"
}
```



---

archive/issue_events_194256.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-01-17T14:02:19Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13963#event-194256"
}
```



---

archive/issue_comments_165265.json:
```json
{
    "body": "Reviewer: **Volker Braun**",
    "created_at": "2013-01-17T14:02:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13963#issuecomment-165265",
    "user": "https://github.com/vbraun"
}
```

Reviewer: **Volker Braun**



---

archive/issue_comments_165266.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nMinor comments:\n\n* `GAP_BINARY` is misleading, as `$SAGE_LOCAL/bin/gap` is a shell script.\n\n* A failure upon creation of `README.txt` is silently ignored in the first place.  (This has been in before.)\n\n* The created README could contain a note on the automatic deletion of old GAP workspaces.\n\n\n\n\nAvoiding to think of the race conditions we may run into here... ;-)",
    "created_at": "2013-01-17T14:34:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13963#issuecomment-165266",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:7" align="right">comment:7</div>

Minor comments:

* `GAP_BINARY` is misleading, as `$SAGE_LOCAL/bin/gap` is a shell script.

* A failure upon creation of `README.txt` is silently ignored in the first place.  (This has been in before.)

* The created README could contain a note on the automatic deletion of old GAP workspaces.




Avoiding to think of the race conditions we may run into here... ;-)



---

archive/issue_comments_165267.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nReplying to [@nexttime](#comment%3A7):\n> Minor comments:\n> \n> * `GAP_BINARY` is misleading, as `$SAGE_LOCAL/bin/gap` is a shell script.\n\nI think that the name `GAP_SCRIPT` would be even more misleading.  Besides, for this code it doesn't really matter whether it's a binary or a script, it's only needed to check the time when GAP was installed.\n\n> Avoiding to think of the race conditions we may run into here... ;-)\n\nIt mainly depends on how GAP's `SaveWorkspace()` is implemented because that would be the most obvious place to check for race conditions.",
    "created_at": "2013-01-17T14:44:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13963#issuecomment-165267",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:8" align="right">comment:8</div>

Replying to [@nexttime](#comment%3A7):
> Minor comments:
> 
> * `GAP_BINARY` is misleading, as `$SAGE_LOCAL/bin/gap` is a shell script.

I think that the name `GAP_SCRIPT` would be even more misleading.  Besides, for this code it doesn't really matter whether it's a binary or a script, it's only needed to check the time when GAP was installed.

> Avoiding to think of the race conditions we may run into here... ;-)

It mainly depends on how GAP's `SaveWorkspace()` is implemented because that would be the most obvious place to check for race conditions.



---

archive/issue_comments_165268.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nP.S.:\n\n`GAP_DIR` (here meaning the directory *for GAP workspaces*) should also get renamed, as that name is already used for the directory *where GAP lives*, in other contexts of course.",
    "created_at": "2013-01-17T14:45:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13963#issuecomment-165268",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:9" align="right">comment:9</div>

P.S.:

`GAP_DIR` (here meaning the directory *for GAP workspaces*) should also get renamed, as that name is already used for the directory *where GAP lives*, in other contexts of course.



---

archive/issue_comments_165269.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@jdemeyer](#comment%3A8):\n> Replying to [@nexttime](#comment%3A7):\n> > Minor comments:\n> > \n> > * `GAP_BINARY` is misleading, as `$SAGE_LOCAL/bin/gap` is a shell script.\n\n> I think that the name `GAP_SCRIPT` would be even more misleading.  Besides, for this code it doesn't really matter whether it's a binary or a script, it's only needed to check the time when GAP was installed.\n\nWell, a *binary* is more likely to change upon reinstallation than some (more or less generic) script.\n\n(Haven't checked whether it actually gets [re-]created by the GAP spkg.)",
    "created_at": "2013-01-17T14:55:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13963#issuecomment-165269",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@jdemeyer](#comment%3A8):
> Replying to [@nexttime](#comment%3A7):
> > Minor comments:
> > 
> > * `GAP_BINARY` is misleading, as `$SAGE_LOCAL/bin/gap` is a shell script.

> I think that the name `GAP_SCRIPT` would be even more misleading.  Besides, for this code it doesn't really matter whether it's a binary or a script, it's only needed to check the time when GAP was installed.

Well, a *binary* is more likely to change upon reinstallation than some (more or less generic) script.

(Haven't checked whether it actually gets [re-]created by the GAP spkg.)



---

archive/issue_comments_165270.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nI'd say this needs work, as in GAP's most recent `spkg-install` we have:\n\n```sh\n\n# Indicate that GAP has somehow been updated, which invalidates all workspaces:\ntouch \"$SAGE_LOCAL/bin/gap_stamp\"\n```",
    "created_at": "2013-01-17T15:06:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13963#issuecomment-165270",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:11" align="right">comment:11</div>

I'd say this needs work, as in GAP's most recent `spkg-install` we have:

```sh

# Indicate that GAP has somehow been updated, which invalidates all workspaces:
touch "$SAGE_LOCAL/bin/gap_stamp"
```



---

archive/issue_comments_165271.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nThe `gap_stamp` gets touched by the `gap` and `gap_packages` spkgs. Putting it in `/bin` was of course a bad call.",
    "created_at": "2013-01-17T15:14:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13963#issuecomment-165271",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:12" align="right">comment:12</div>

The `gap_stamp` gets touched by the `gap` and `gap_packages` spkgs. Putting it in `/bin` was of course a bad call.



---

archive/issue_comments_165272.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nReplying to [@vbraun](#comment%3A12):\n> The `gap_stamp` gets touched by the `gap` and `gap_packages` spkgs. Putting it in `/bin` was of course a bad call. \n\nNo matter *what* we use as the stamp, it wouldn't be bad to use *the same* in GAP-related spkgs as well as the Sage library... ;-)",
    "created_at": "2013-01-17T15:25:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13963#issuecomment-165272",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:13" align="right">comment:13</div>

Replying to [@vbraun](#comment%3A12):
> The `gap_stamp` gets touched by the `gap` and `gap_packages` spkgs. Putting it in `/bin` was of course a bad call. 

No matter *what* we use as the stamp, it wouldn't be bad to use *the same* in GAP-related spkgs as well as the Sage library... ;-)



---

archive/issue_comments_165273.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@vbraun](#comment%3A12):\n> The `gap_stamp` gets touched by the `gap` and `gap_packages` spkgs.\n\nDoes installing a new GAP package require a rebuild of the workspace?",
    "created_at": "2013-01-17T15:38:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13963#issuecomment-165273",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@vbraun](#comment%3A12):
> The `gap_stamp` gets touched by the `gap` and `gap_packages` spkgs.

Does installing a new GAP package require a rebuild of the workspace?



---

archive/issue_comments_165274.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nYes... just the other day I spent a fun few hours figuring out why some GAP command mysteriously crashes. Wrong gap workspace %-)",
    "created_at": "2013-01-17T15:55:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13963#issuecomment-165274",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:15" align="right">comment:15</div>

Yes... just the other day I spent a fun few hours figuring out why some GAP command mysteriously crashes. Wrong gap workspace %-)



---

archive/issue_comments_165275.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -24,3 +24,8 @@\n The attached patch solves this problem in two ways:\n * It only checks for and generates workspaces when actually starting GAP, not when Sage is started.\n * Instead of using `SAGE_EXTCODE` (which doesn't really make sense), check the modification time of `$SAGE_LOCAL/bin/gap`.\n+\n+\n+**Apply**: [attachment: 13963_gap_stamp.patch](https://github.com/sagemath/sage/files/ticket13963/13963_gap_stamp.patch.gz)\n+\n+**spkg**: [http://boxen.math.washington.edu/home/jdemeyer/spkg/gap-4.5.7.p2.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/gap-4.5.7.p2.spkg) (diff:[attachment: gap-4.5.7.p2.diff](https://github.com/sagemath/sage/files/ticket13963/gap-4.5.7.p2.diff.gz))\n``````\n",
    "created_at": "2013-01-17T16:01:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13963#issuecomment-165275",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -24,3 +24,8 @@
 The attached patch solves this problem in two ways:
 * It only checks for and generates workspaces when actually starting GAP, not when Sage is started.
 * Instead of using `SAGE_EXTCODE` (which doesn't really make sense), check the modification time of `$SAGE_LOCAL/bin/gap`.
+
+
+**Apply**: [attachment: 13963_gap_stamp.patch](https://github.com/sagemath/sage/files/ticket13963/13963_gap_stamp.patch.gz)
+
+**spkg**: [http://boxen.math.washington.edu/home/jdemeyer/spkg/gap-4.5.7.p2.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/gap-4.5.7.p2.spkg) (diff:[attachment: gap-4.5.7.p2.diff](https://github.com/sagemath/sage/files/ticket13963/gap-4.5.7.p2.diff.gz))
``````




---

archive/issue_events_194257.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-17T16:01:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13963#event-194257"
}
```



---

archive/issue_events_194258.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-17T16:01:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13963#event-194258"
}
```



---

archive/issue_comments_165276.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@vbraun](#comment%3A15):\n> Yes... just the other day I spent a fun few hours figuring out why some GAP command mysteriously crashes. Wrong gap workspace %-)\n\nAny suggestions for a way of properly checking whether a new package was installed?",
    "created_at": "2013-01-17T16:02:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13963#issuecomment-165276",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@vbraun](#comment%3A15):
> Yes... just the other day I spent a fun few hours figuring out why some GAP command mysteriously crashes. Wrong gap workspace %-)

Any suggestions for a way of properly checking whether a new package was installed?



---

archive/issue_comments_165277.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -28,4 +28,6 @@\n \n **Apply**: [attachment: 13963_gap_stamp.patch](https://github.com/sagemath/sage/files/ticket13963/13963_gap_stamp.patch.gz)\n \n-**spkg**: [http://boxen.math.washington.edu/home/jdemeyer/spkg/gap-4.5.7.p2.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/gap-4.5.7.p2.spkg) (diff:[attachment: gap-4.5.7.p2.diff](https://github.com/sagemath/sage/files/ticket13963/gap-4.5.7.p2.diff.gz))\n+**spkg**: [http://boxen.math.washington.edu/home/jdemeyer/spkg/gap-4.5.7.p2.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/gap-4.5.7.p2.spkg) (diff: [attachment: gap-4.5.7.p2.diff](https://github.com/sagemath/sage/files/ticket13963/gap-4.5.7.p2.diff.gz))\n+\n+**optional spkg**: [http://boxen.math.washington.edu/home/jdemeyer/spkg/gap_packages-4.5.7.p0.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/gap_packages-4.5.7.p0.spkg) (diff: [attachment: gap_packages-4.5.7.p0.diff](https://github.com/sagemath/sage/files/ticket13963/gap_packages-4.5.7.p0.diff.gz))\n``````\n",
    "created_at": "2013-01-17T16:20:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13963#issuecomment-165277",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -28,4 +28,6 @@
 
 **Apply**: [attachment: 13963_gap_stamp.patch](https://github.com/sagemath/sage/files/ticket13963/13963_gap_stamp.patch.gz)
 
-**spkg**: [http://boxen.math.washington.edu/home/jdemeyer/spkg/gap-4.5.7.p2.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/gap-4.5.7.p2.spkg) (diff:[attachment: gap-4.5.7.p2.diff](https://github.com/sagemath/sage/files/ticket13963/gap-4.5.7.p2.diff.gz))
+**spkg**: [http://boxen.math.washington.edu/home/jdemeyer/spkg/gap-4.5.7.p2.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/gap-4.5.7.p2.spkg) (diff: [attachment: gap-4.5.7.p2.diff](https://github.com/sagemath/sage/files/ticket13963/gap-4.5.7.p2.diff.gz))
+
+**optional spkg**: [http://boxen.math.washington.edu/home/jdemeyer/spkg/gap_packages-4.5.7.p0.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/gap_packages-4.5.7.p0.spkg) (diff: [attachment: gap_packages-4.5.7.p0.diff](https://github.com/sagemath/sage/files/ticket13963/gap_packages-4.5.7.p0.diff.gz))
``````




---

archive/issue_comments_165278.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nAttachment: **[gap_packages-4.5.7.p0.diff.gz](https://github.com/sagemath/sage/files/ticket13963/gap_packages-4.5.7.p0.diff.gz)**",
    "created_at": "2013-01-17T16:20:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13963#issuecomment-165278",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:18" align="right">comment:18</div>

Attachment: **[gap_packages-4.5.7.p0.diff.gz](https://github.com/sagemath/sage/files/ticket13963/gap_packages-4.5.7.p0.diff.gz)**



---

archive/issue_comments_165279.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nThis seems the best solution, although it is not very elegant.",
    "created_at": "2013-01-17T16:20:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13963#issuecomment-165279",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:19" align="right">comment:19</div>

This seems the best solution, although it is not very elegant.



---

archive/issue_comments_165280.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nHow about we check the date of `gap_stamp` for rebuilding the workspace, thats what its meant for.",
    "created_at": "2013-01-17T16:21:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13963#issuecomment-165280",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:20" align="right">comment:20</div>

How about we check the date of `gap_stamp` for rebuilding the workspace, thats what its meant for.



---

archive/issue_comments_165281.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nI'd still let `-O0` override a user's O-level (in `$CFLAGS`) if `SAGE_DEBUG=yes`, like most -- if not all -- other spkgs do.\n\nAnd while you're at it, change the `==` to `=` there, and/or use `[This is the Trac macro *... * that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#... -macro)`.\n\nThere are also a few error checks missing, and `SPKG_ROOT` isn't always quoted.  (One should also probably do some sanity check on `$VERSION` at least.)\n\nThe `-f` in `ln -sf ... latest` is redundant, as we always first delete the symbolic link (if present).",
    "created_at": "2013-01-17T16:35:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13963#issuecomment-165281",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:21" align="right">comment:21</div>

I'd still let `-O0` override a user's O-level (in `$CFLAGS`) if `SAGE_DEBUG=yes`, like most -- if not all -- other spkgs do.

And while you're at it, change the `==` to `=` there, and/or use `[This is the Trac macro *... * that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#... -macro)`.

There are also a few error checks missing, and `SPKG_ROOT` isn't always quoted.  (One should also probably do some sanity check on `$VERSION` at least.)

The `-f` in `ln -sf ... latest` is redundant, as we always first delete the symbolic link (if present).



---

archive/issue_comments_165282.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nReplying to [@nexttime](#comment%3A21):\n> I'd still let `-O0` override a user's O-level (in `$CFLAGS`) if `SAGE_DEBUG=yes`, like most -- if not all -- other spkgs do.\n\nI don't think Sage should ever override user-chosen flags, so we should always do\n\n```\nCFLAGS=\"-sage -specific -flags $CFLAGS\"\n```",
    "created_at": "2013-01-17T18:13:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13963#issuecomment-165282",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:22" align="right">comment:22</div>

Replying to [@nexttime](#comment%3A21):
> I'd still let `-O0` override a user's O-level (in `$CFLAGS`) if `SAGE_DEBUG=yes`, like most -- if not all -- other spkgs do.

I don't think Sage should ever override user-chosen flags, so we should always do

```
CFLAGS="-sage -specific -flags $CFLAGS"
```



---

archive/issue_comments_165283.json:
```json
{
    "body": "Attachment: **[gap-4.5.7.p2.diff.gz](https://github.com/sagemath/sage/files/ticket13963/gap-4.5.7.p2.diff.gz)**",
    "created_at": "2013-01-17T18:26:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13963#issuecomment-165283",
    "user": "https://github.com/jdemeyer"
}
```

Attachment: **[gap-4.5.7.p2.diff.gz](https://github.com/sagemath/sage/files/ticket13963/gap-4.5.7.p2.diff.gz)**



---

archive/issue_events_194259.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-17T18:28:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13963#event-194259"
}
```



---

archive/issue_events_194260.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-17T18:28:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13963#event-194260"
}
```



---

archive/issue_comments_165284.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nCan this be reviewed again please?",
    "created_at": "2013-01-19T09:32:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13963#issuecomment-165284",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:24" align="right">comment:24</div>

Can this be reviewed again please?



---

archive/issue_events_194261.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-01-19T13:21:37Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13963#event-194261"
}
```



---

archive/issue_events_194262.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-01-19T13:21:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13963#event-194262"
}
```



---

archive/issue_comments_165285.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nIts still fugly to touch bin/gap but at least it works. Cute trick with `autoconf --trace`...",
    "created_at": "2013-01-19T13:21:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13963#issuecomment-165285",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:25" align="right">comment:25</div>

Its still fugly to touch bin/gap but at least it works. Cute trick with `autoconf --trace`...



---

archive/issue_comments_165286.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nReplying to [@jdemeyer](#comment%3A22):\n> Replying to [@nexttime](#comment%3A21):\n> > I'd still let `-O0` override a user's O-level (in `$CFLAGS`) if `SAGE_DEBUG=yes`, like most -- if not all -- other spkgs do.\n\n> I don't think Sage should ever override user-chosen flags, so we should always do\n> \n> ```\n> CFLAGS=\"-sage -specific -flags $CFLAGS\"\n> ```\n\nWell, IMHO depends.  If `-foo` is mandatory to not break the build, it should be *ap*pended; same for options to `configure`.  (`-L` is even more troublesome, and `-I-` for example isn't portable.)\n\nUnfortunately there's not always an option to toggle or invalidate a previously (i.e., \"user-specified\") option, and flags may even conflict.  (The same is true for the opposite case, when a user wants to override some option added by Sage or an spkg's build system.  This especially holds for `-g`, which we almost always add by default -- thereby probably already overriding a user's choice; stripping afterwards may be inappropriate in some cases.)\n\nIf a user sets `SAGE_DEBUG=yes`, he will or should be aware of the consequences, which are documented (I think), and usually subject of a corresponding warning message.  If someone really wants to do debugging without e.g. `-O0`, he'll certainly be able to modify `spkg-install` for that purpose, which is trivial.  Temporarily modifying `C*FLAGS` is more tedious, and less experienced users may have (more or less intentionally) some of them set, while still expecting `SAGE_DEBUG` to work as advertised, without having to mess with other environment variables.\n\nIdeally, we'd have some `SAGE_DEBUG_LEVEL`, or we'd at least separate \"standard\" compiler options *probably* useful for debugging (such as `-O0`) from usually package-specific ones, like `-DDEBUG_FOO`;  `configure` may also take special debug options specific to the package (which IMHO is the main reason we do have `SAGE_DEBUG`).\n\nUntil we have `SAGE_DEBUG_CFLAGS`, say, which could easily be set/modified by the user, I'd still (try to) override e.g. `-O2` by default (if `SAGE_DEBUG=yes` of course).",
    "created_at": "2013-01-19T14:28:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13963#issuecomment-165286",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:26" align="right">comment:26</div>

Replying to [@jdemeyer](#comment%3A22):
> Replying to [@nexttime](#comment%3A21):
> > I'd still let `-O0` override a user's O-level (in `$CFLAGS`) if `SAGE_DEBUG=yes`, like most -- if not all -- other spkgs do.

> I don't think Sage should ever override user-chosen flags, so we should always do
> 
> ```
> CFLAGS="-sage -specific -flags $CFLAGS"
> ```

Well, IMHO depends.  If `-foo` is mandatory to not break the build, it should be *ap*pended; same for options to `configure`.  (`-L` is even more troublesome, and `-I-` for example isn't portable.)

Unfortunately there's not always an option to toggle or invalidate a previously (i.e., "user-specified") option, and flags may even conflict.  (The same is true for the opposite case, when a user wants to override some option added by Sage or an spkg's build system.  This especially holds for `-g`, which we almost always add by default -- thereby probably already overriding a user's choice; stripping afterwards may be inappropriate in some cases.)

If a user sets `SAGE_DEBUG=yes`, he will or should be aware of the consequences, which are documented (I think), and usually subject of a corresponding warning message.  If someone really wants to do debugging without e.g. `-O0`, he'll certainly be able to modify `spkg-install` for that purpose, which is trivial.  Temporarily modifying `C*FLAGS` is more tedious, and less experienced users may have (more or less intentionally) some of them set, while still expecting `SAGE_DEBUG` to work as advertised, without having to mess with other environment variables.

Ideally, we'd have some `SAGE_DEBUG_LEVEL`, or we'd at least separate "standard" compiler options *probably* useful for debugging (such as `-O0`) from usually package-specific ones, like `-DDEBUG_FOO`;  `configure` may also take special debug options specific to the package (which IMHO is the main reason we do have `SAGE_DEBUG`).

Until we have `SAGE_DEBUG_CFLAGS`, say, which could easily be set/modified by the user, I'd still (try to) override e.g. `-O2` by default (if `SAGE_DEBUG=yes` of course).



---

archive/issue_comments_165287.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nReplying to [@nexttime](#comment%3A26):\n> If `-foo` is mandatory to not break the build, it should be *ap*pended\n\nI don't think there are many situations where it's known that a flag is absolutely required to not break the build.  I like the principle of \"the user knows best\" and not \"the Sage developers know best\".\n\n> This especially holds for `-g`\n\nThe `-g` option can be cancelled by `-g0`.\n\n> If a user sets `SAGE_DEBUG=yes`, he will or should be aware of the consequences\n\nSure, but exactly the same holds for `CFLAGS`.\n\n> If someone really wants to do debugging without e.g. `-O0`, he'll certainly be able to modify `spkg-install` for that purpose, which is trivial.\n\nSo now we require users to **modify a spkg** to get the options they want?  Why make things hard which should be easy?\n\n> Temporarily modifying `C*FLAGS` is more tedious\n\nWhy that?  Changing `CFLAGS` is equally easy as changing `SAGE_DEBUG`.\n\n> and less experienced users may have (more or less intentionally) some of them set\n\nWhy do you think that?  Are there any distributions which have `CFLAGS` set in the environment by default?",
    "created_at": "2013-01-19T17:19:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13963#issuecomment-165287",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:27" align="right">comment:27</div>

Replying to [@nexttime](#comment%3A26):
> If `-foo` is mandatory to not break the build, it should be *ap*pended

I don't think there are many situations where it's known that a flag is absolutely required to not break the build.  I like the principle of "the user knows best" and not "the Sage developers know best".

> This especially holds for `-g`

The `-g` option can be cancelled by `-g0`.

> If a user sets `SAGE_DEBUG=yes`, he will or should be aware of the consequences

Sure, but exactly the same holds for `CFLAGS`.

> If someone really wants to do debugging without e.g. `-O0`, he'll certainly be able to modify `spkg-install` for that purpose, which is trivial.

So now we require users to **modify a spkg** to get the options they want?  Why make things hard which should be easy?

> Temporarily modifying `C*FLAGS` is more tedious

Why that?  Changing `CFLAGS` is equally easy as changing `SAGE_DEBUG`.

> and less experienced users may have (more or less intentionally) some of them set

Why do you think that?  Are there any distributions which have `CFLAGS` set in the environment by default?



---

archive/issue_comments_165288.json:
```json
{
    "body": "Merged: **sage-5.7.beta0**",
    "created_at": "2013-01-21T21:09:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/13963#issuecomment-165288",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-5.7.beta0**



---

archive/issue_events_194263.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-21T21:09:37Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13963#event-194263"
}
```



---

archive/issue_events_194264.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-21T21:09:37Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/13963",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/13963#event-194264"
}
```
