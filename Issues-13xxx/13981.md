# Issue 13981: Faster int -> Integer coercion for common ints

archive/issues_013777.json:
```json
{
    "body": "Defaulting to the same range as Python, namely [-5, 256]. \n\nAssignee: @aghitza\n\nBranch/Commit: 9ab4bd04dfac93d95c7b169be62a3054f2eef850\n\nReviewer: Paul Zimmermann, Marc Mezzarobba\n\nAuthor: Robert Bradshaw\n\nDependencies: #12615\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/13981\n\n",
    "closed_at": "2014-03-02T16:15:22Z",
    "created_at": "2013-01-22T05:37:43Z",
    "labels": [
        "component: basic arithmetic"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.2",
    "title": "Faster int -> Integer coercion for common ints",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13981",
    "user": "https://github.com/robertwb"
}
```
Defaulting to the same range as Python, namely [-5, 256]. 

Assignee: @aghitza

Branch/Commit: 9ab4bd04dfac93d95c7b169be62a3054f2eef850

Reviewer: Paul Zimmermann, Marc Mezzarobba

Author: Robert Bradshaw

Dependencies: #12615

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/13981





---

archive/issue_comments_182135.json:
```json
{
    "body": "<a id='comment:1'></a>Attachment [13981-fast-int-ZZ.patch](tarball://root/attachments/some-uuid/ticket13981/13981-fast-int-ZZ.patch) by @robertwb created at 2013-01-22 06:27:43",
    "created_at": "2013-01-22T06:27:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13981#issuecomment-182135",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:1'></a>Attachment [13981-fast-int-ZZ.patch](tarball://root/attachments/some-uuid/ticket13981/13981-fast-int-ZZ.patch) by @robertwb created at 2013-01-22 06:27:43



---

archive/issue_comments_182136.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-01-22T06:27:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13981#issuecomment-182136",
    "user": "https://github.com/robertwb"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_182137.json:
```json
{
    "body": "Attachment [13981-fast-int-ZZ-doctests.patch](tarball://root/attachments/some-uuid/ticket13981/13981-fast-int-ZZ-doctests.patch) by @robertwb created at 2013-01-22 23:53:19",
    "created_at": "2013-01-22T23:53:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13981#issuecomment-182137",
    "user": "https://github.com/robertwb"
}
```

Attachment [13981-fast-int-ZZ-doctests.patch](tarball://root/attachments/some-uuid/ticket13981/13981-fast-int-ZZ-doctests.patch) by @robertwb created at 2013-01-22 23:53:19



---

archive/issue_comments_182138.json:
```json
{
    "body": "<a id='comment:2'></a>Robert, please could you explain the rationale behind this ticket?\nAlso, any hint on how to review it would be welcome. Is there any standard efficiency test?\n\nPaul",
    "created_at": "2013-01-23T08:12:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13981#issuecomment-182138",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:2'></a>Robert, please could you explain the rationale behind this ticket?
Also, any hint on how to review it would be welcome. Is there any standard efficiency test?

Paul



---

archive/issue_comments_182139.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2013-01-23T08:12:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13981#issuecomment-182139",
    "user": "https://github.com/zimmermann6"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_182140.json:
```json
{
    "body": "<a id='comment:3'></a>Robert, the first patch failed to apply to 5.5:\n\n```\nsage: hg_sage.import_patch(\"/tmp/13981-fast-int-ZZ.patch\")\ncd \"/localdisk/tmp/sage-5.5/devel/sage\" && sage --hg import   \"/tmp/13981-fast-int-ZZ.patch\"\napplying /tmp/13981-fast-int-ZZ.patch\npatching file sage/rings/integer.pyx\nHunk #1 FAILED at 5666\n1 out of 2 hunks FAILED -- saving rejects to file sage/rings/integer.pyx.rej\nabort: patch failed to apply\n```\nPaul",
    "created_at": "2013-01-23T08:16:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13981#issuecomment-182140",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:3'></a>Robert, the first patch failed to apply to 5.5:

```
sage: hg_sage.import_patch("/tmp/13981-fast-int-ZZ.patch")
cd "/localdisk/tmp/sage-5.5/devel/sage" && sage --hg import   "/tmp/13981-fast-int-ZZ.patch"
applying /tmp/13981-fast-int-ZZ.patch
patching file sage/rings/integer.pyx
Hunk #1 FAILED at 5666
1 out of 2 hunks FAILED -- saving rejects to file sage/rings/integer.pyx.rej
abort: patch failed to apply
```
Paul



---

archive/issue_comments_182141.json:
```json
{
    "body": "<a id='comment:4'></a>Ticket #12615 is a dependency, you need to apply that first. \n\nI can't think of any standard efficiency tests, but this is most useful when creating a large number of small Sage integers. For example, \n\nBefore:\n\n```\nsage: sage: E = EllipticCurve('37a')             \nsage: sage: v = E.anlist(10000, python_ints=True)\nsage: sage: %timeit [ZZ(a) for a in v]           \n25 loops, best of 3: 15.5 ms per loop\n```\n\nAfter:\n\n```\nsage: E = EllipticCurve('37a')             \nsage: v = E.anlist(10000, python_ints=True)\nsage: %timeit [ZZ(a) for a in v]           \n25 loops, best of 3: 12.8 ms per loop\n```\n\nIt'll be faster elsewhere, but it's mostly a tiny improvement all over the place. Startup time may also be slightly improved (despite initializing the pool). The most important is to review the code for correctness (and of course verify the tests pass).",
    "created_at": "2013-01-23T17:45:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13981#issuecomment-182141",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:4'></a>Ticket #12615 is a dependency, you need to apply that first. 

I can't think of any standard efficiency tests, but this is most useful when creating a large number of small Sage integers. For example, 

Before:

```
sage: sage: E = EllipticCurve('37a')             
sage: sage: v = E.anlist(10000, python_ints=True)
sage: sage: %timeit [ZZ(a) for a in v]           
25 loops, best of 3: 15.5 ms per loop
```

After:

```
sage: E = EllipticCurve('37a')             
sage: v = E.anlist(10000, python_ints=True)
sage: %timeit [ZZ(a) for a in v]           
25 loops, best of 3: 12.8 ms per loop
```

It'll be faster elsewhere, but it's mostly a tiny improvement all over the place. Startup time may also be slightly improved (despite initializing the pool). The most important is to review the code for correctness (and of course verify the tests pass).



---

archive/issue_comments_182142.json:
```json
{
    "body": "<a id='comment:5'></a>Robert, I see nothing wrong in this patch, except the description says `[-1, 256]` but the code says `[-5, 256]`. Where is the default Python range documented?\n\nPaul",
    "created_at": "2013-01-24T08:03:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13981#issuecomment-182142",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:5'></a>Robert, I see nothing wrong in this patch, except the description says `[-1, 256]` but the code says `[-5, 256]`. Where is the default Python range documented?

Paul



---

archive/issue_comments_182143.json:
```json
{
    "body": "<a id='comment:6'></a>all doctests pass. The only issue is that in comment [comment:5].\n\nPaul",
    "created_at": "2013-01-24T09:23:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13981#issuecomment-182143",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:6'></a>all doctests pass. The only issue is that in comment [comment:5].

Paul



---

archive/issue_events_039278.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13981",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13981#event-39278"
}
```



---

archive/issue_comments_182144.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2014-01-28T05:09:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13981#issuecomment-182144",
    "user": "https://github.com/robertwb"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_182145.json:
```json
{
    "body": "<a id='comment:9'></a>New commits:",
    "created_at": "2014-01-28T05:09:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13981#issuecomment-182145",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:9'></a>New commits:



---

archive/issue_comments_182146.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-Defaulting to the same range as Python, namely [-1, 256].\n+Defaulting to the same range as Python, namely [-5, 256]. \n \n Dependencies: #12615\n \n```\n",
    "created_at": "2014-01-28T05:09:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13981#issuecomment-182146",
    "user": "https://github.com/robertwb"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,4 @@
-Defaulting to the same range as Python, namely [-1, 256].
+Defaulting to the same range as Python, namely [-5, 256]. 
 
 Dependencies: #12615
 
```




---

archive/issue_comments_182147.json:
```json
{
    "body": "<a id='comment:11'></a>I think this should be fixed also. Otherwise, I don't really see the point.\n\n```\nsage: 20 is 20\nFalse\n```",
    "created_at": "2014-01-28T17:15:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13981#issuecomment-182147",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>I think this should be fixed also. Otherwise, I don't really see the point.

```
sage: 20 is 20
False
```



---

archive/issue_comments_182148.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-01-28T17:15:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13981#issuecomment-182148",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_182149.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-01-30T12:02:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13981#issuecomment-182149",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_events_039279.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13981",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13981#event-39279"
}
```



---

archive/issue_events_039280.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13981",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13981#event-39280"
}
```



---

archive/issue_comments_182150.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-02-04T04:58:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13981#issuecomment-182150",
    "user": "https://github.com/robertwb"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_182151.json:
```json
{
    "body": "<a id='comment:14'></a>This helps for all the coercions. I did a bit of playing around with `Integer(20) is Integer(20)` and a bunch of stuff broke (probably due to people mutating `Integer(0)` for example), so let's split that off as a separate feature request. (By the time you get there you've already committed to making a new Integer..",
    "created_at": "2014-02-04T04:58:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13981#issuecomment-182151",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:14'></a>This helps for all the coercions. I did a bit of playing around with `Integer(20) is Integer(20)` and a bunch of stuff broke (probably due to people mutating `Integer(0)` for example), so let's split that off as a separate feature request. (By the time you get there you've already committed to making a new Integer..



---

archive/issue_comments_182152.json:
```json
{
    "body": "<a id='comment:15'></a>I fixed a typo and saved a few more cycles (I think) by changing two `cdef long`s into `DEF`s. The branch merges cleanly and all tests pass. Can you please check the changes and set the ticket to positive review (after reverting my patch if you disagree)?",
    "created_at": "2014-02-22T22:30:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13981#issuecomment-182152",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:15'></a>I fixed a typo and saved a few more cycles (I think) by changing two `cdef long`s into `DEF`s. The branch merges cleanly and all tests pass. Can you please check the changes and set the ticket to positive review (after reverting my patch if you disagree)?



---

archive/issue_comments_182153.json:
```json
{
    "body": "<a id='comment:16'></a>sorry with the change to git I don't know how to review that ticket (and no time currently to learn how to)\n\nPaul",
    "created_at": "2014-02-25T08:46:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13981#issuecomment-182153",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:16'></a>sorry with the change to git I don't know how to review that ticket (and no time currently to learn how to)

Paul



---

archive/issue_comments_182154.json:
```json
{
    "body": "<a id='comment:17'></a>New commits:",
    "created_at": "2014-02-25T10:02:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13981#issuecomment-182154",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:17'></a>New commits:



---

archive/issue_comments_182155.json:
```json
{
    "body": "<a id='comment:18'></a>[Hmm, there was a typo in the branch name, sorry for that.]\n\nReplying to [comment:16 zimmerma]:\n> sorry with the change to git I don't know how to review that ticket (and no time currently to learn how to)\n\n\nI think all that remains to do is for someone to have a look at my patch (http://git.sagemath.org/sage.git/commit/?id=9ab4bd04dfac93d95c7b169be62a3054f2eef850).\n\nIf you want to test it:\n* checkout the corresponding branch (using something like `git checkout trac/u/mmezzarobba/13981-small_int`);\n* optionally, merge in the main development branch (`git merge develop`);\n* rebuild sage, test;\n* use `git checkout master` or `git checkout develop` to go back to the mainline when you are done.",
    "created_at": "2014-02-25T10:08:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13981#issuecomment-182155",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:18'></a>[Hmm, there was a typo in the branch name, sorry for that.]

Replying to [comment:16 zimmerma]:
> sorry with the change to git I don't know how to review that ticket (and no time currently to learn how to)


I think all that remains to do is for someone to have a look at my patch (http://git.sagemath.org/sage.git/commit/?id=9ab4bd04dfac93d95c7b169be62a3054f2eef850).

If you want to test it:
* checkout the corresponding branch (using something like `git checkout trac/u/mmezzarobba/13981-small_int`);
* optionally, merge in the main development branch (`git merge develop`);
* rebuild sage, test;
* use `git checkout master` or `git checkout develop` to go back to the mainline when you are done.



---

archive/issue_comments_182156.json:
```json
{
    "body": "<a id='comment:19'></a>Your change looks fine to me.",
    "created_at": "2014-02-25T18:09:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13981#issuecomment-182156",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:19'></a>Your change looks fine to me.



---

archive/issue_comments_182157.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-02-25T20:33:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13981#issuecomment-182157",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_182158.json:
```json
{
    "body": "<a id='comment:21'></a>Marc, where should I do `git checkout ...`?\n\n```\ntarte% pwd\n/localdisk/tmp/sage-6.0\ntarte% git checkout trac/u/mmezzarobba/13981-small_int\nerror: pathspec 'trac/u/mmezzarobba/13981-small_int' did not match any file(s) known to git.\n```",
    "created_at": "2014-02-26T08:15:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13981#issuecomment-182158",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:21'></a>Marc, where should I do `git checkout ...`?

```
tarte% pwd
/localdisk/tmp/sage-6.0
tarte% git checkout trac/u/mmezzarobba/13981-small_int
error: pathspec 'trac/u/mmezzarobba/13981-small_int' did not match any file(s) known to git.
```



---

archive/issue_comments_182159.json:
```json
{
    "body": "<a id='comment:22'></a>`sage -dev checkout --ticket=13981` or within sage: `dev.checkout(ticket='13981')`",
    "created_at": "2014-02-26T08:56:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13981#issuecomment-182159",
    "user": "https://github.com/rwst"
}
```

<a id='comment:22'></a>`sage -dev checkout --ticket=13981` or within sage: `dev.checkout(ticket='13981')`



---

archive/issue_comments_182160.json:
```json
{
    "body": "<a id='comment:23'></a>many thanks!\n\nPaul",
    "created_at": "2014-02-26T09:02:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13981#issuecomment-182160",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:23'></a>many thanks!

Paul



---

archive/issue_comments_182161.json:
```json
{
    "body": "<a id='comment:24'></a>I confirm the speedup on my machine.\n\nVanilla 6.0:\n\n```\nsage: sage: E = EllipticCurve('37a')    \nsage: v = E.anlist(10000, python_ints=True)\nsage: %timeit [ZZ(a) for a in v]       \n100 loops, best of 3: 15.3 ms per loop\n```\n\nWith the patch applied:\n\n```\nsage: sage: E = EllipticCurve('37a')    \nsage: v = E.anlist(10000, python_ints=True)\nsage: %timeit [ZZ(a) for a in v]       \n100 loops, best of 3: 13.2 ms per loop\n```\nPaul",
    "created_at": "2014-02-26T09:06:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13981#issuecomment-182161",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:24'></a>I confirm the speedup on my machine.

Vanilla 6.0:

```
sage: sage: E = EllipticCurve('37a')    
sage: v = E.anlist(10000, python_ints=True)
sage: %timeit [ZZ(a) for a in v]       
100 loops, best of 3: 15.3 ms per loop
```

With the patch applied:

```
sage: sage: E = EllipticCurve('37a')    
sage: v = E.anlist(10000, python_ints=True)
sage: %timeit [ZZ(a) for a in v]       
100 loops, best of 3: 13.2 ms per loop
```
Paul



---

archive/issue_comments_182162.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-03-02T16:15:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13981#issuecomment-182162",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_039281.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-03-02T16:15:22Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/13981",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13981#event-39281"
}
```
