# Issue 13204: Element construction for CrystalOfTableaux should be robust versus  int's

archive/issues_013032.json:
```json
{
    "body": "\nWhen constructing elements of a crystal of tableaux, the entries are\nconverted to crystal letters if they are not yet such::\n\n```\n    sage: T = CrystalOfTableaux(['A',3], shape = [2,2])\n    sage: t = T(list=[3,1,4,2])\n    sage: t\n    [[1, 2], [3, 4]]\n    sage: type(t[0])\n    <class 'sage.combinat.crystals.letters.ClassicalCrystalOfLetters_with_category.element_class'>\n    sage: type(t[1])\n    <class 'sage.combinat.crystals.letters.ClassicalCrystalOfLetters_with_category.element_class'>\n```\n\nHowever this is currently not the case if the entries are plain int's::\n\n```\n    sage: t = T(list=[int(3),1,4,2])\n    sage: type(t[0])\n    <type 'int'>\n    sage: type(t[1])\n    <type 'sage.rings.integer.Integer'>\n```\n\nPossible fix: have CrystalOfTableauxElement.__init__ check whether\nlist[0] is not an instance of parent.letters.element_class instead of\ntesting for an Integer.\n\n\n**Assignee:** sage-combinat\n\n**CC:**  sage-combinat @anneschilling\n\n**Keywords:** crystals\n\n**Reviewer:** Anne Schilling\n\n**Author:** Travis Scrimshaw\n\n**Merged:** sage-5.7.beta2\n\n**Resolution:** fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/13204\n\n",
    "closed_at": "2013-01-31T09:19:34Z",
    "created_at": "2012-07-05T05:06:15Z",
    "labels": [
        "component: combinatorics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.7",
    "title": "Element construction for CrystalOfTableaux should be robust versus  int's",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13204",
    "user": "https://github.com/nthiery"
}
```

When constructing elements of a crystal of tableaux, the entries are
converted to crystal letters if they are not yet such::

```
    sage: T = CrystalOfTableaux(['A',3], shape = [2,2])
    sage: t = T(list=[3,1,4,2])
    sage: t
    [[1, 2], [3, 4]]
    sage: type(t[0])
    <class 'sage.combinat.crystals.letters.ClassicalCrystalOfLetters_with_category.element_class'>
    sage: type(t[1])
    <class 'sage.combinat.crystals.letters.ClassicalCrystalOfLetters_with_category.element_class'>
```

However this is currently not the case if the entries are plain int's::

```
    sage: t = T(list=[int(3),1,4,2])
    sage: type(t[0])
    <type 'int'>
    sage: type(t[1])
    <type 'sage.rings.integer.Integer'>
```

Possible fix: have CrystalOfTableauxElement.__init__ check whether
list[0] is not an instance of parent.letters.element_class instead of
testing for an Integer.


**Assignee:** sage-combinat

**CC:**  sage-combinat @anneschilling

**Keywords:** crystals

**Reviewer:** Anne Schilling

**Author:** Travis Scrimshaw

**Merged:** sage-5.7.beta2

**Resolution:** fixed

Issue created by migration from https://trac.sagemath.org/ticket/13204





---

archive/issue_comments_201099.json:
```json
{
    "body": "<a id='comment:1'></a>\nAnother (more subtle) bug which comes from the same issue:\n\n```\nsage: C = KirillovReshetikhinCrystal(['A',int(4),1], 1,1)\nsage: C[0].e0()\n# Boom\nAttributeError: 'int' object has no attribute 'epsilon'\n```\nThe problem seems to be in that elements are created from `C.cartan_type().n` somewhere (I didn't track this down).\n\nI've uploaded my fix for this which automatically calls the `CrystalOfLetters` on each element in the list (which should just type check and return the element back if it already is a letter). There is a slight performance hit (see below) for doing this rather than just checking the leading element. Also this takes care of input like:\n\n```\nsage: t = T(list=[T.letters(3),1,4,2])\nsage: t = T(list=[CrystalOfLetters(['D',6])(3),1,4,2])\n```\n(Note CrystalOfLetters checks (well lack thereof) are not robust enough to catch the second input as an error, but that's a separate issue.) Really the question boils down to how pathological do we think the users might be with this versus the speed hit? If people think this is a good fix, this is ready to review.\n\nThanks,\n Travis\n\nPerformance data before patch:\n\n```\nsage: B = KirillovReshetikhinCrystal(['A',4,1], 3,3)\n\nsage: %timeit L = [x for x in B]\n5 loops, best of 3: 584 ms per loop\nsage: %timeit L = [x for x in B]\n5 loops, best of 3: 550 ms per loop\n\nsage: %prun L = [x for x in B]\n   398355 function calls in 4.147 seconds\n\n   Ordered by: internal time\n\n   ncalls  tottime  percall  cumtime  percall filename:lineno(function)\n    45228    0.668    0.000    1.602    0.000 crystals.py:169(index_set)\n    45053    0.658    0.000    2.433    0.000 crystals.py:727(index_set)\n    45228    0.443    0.000    0.680    0.000 cartan_type.py:1822(index_set)\n...\n```\nafter patch:\n\n```\nsage: B = KirillovReshetikhinCrystal(['A',4,1], 3,3)\n\nsage: %timeit L = [x for x in B]\n5 loops, best of 3: 642 ms per loop\nsage: %timeit L = [x for x in B]\n5 loops, best of 3: 633 ms per loop\n\nsage: %prun L = [x for x in B]\n   426299 function calls in 5.135 seconds\n\n   Ordered by: internal time\n\n   ncalls  tottime  percall  cumtime  percall filename:lineno(function)\n    45228    0.791    0.000    1.942    0.000 crystals.py:167(index_set)\n    45053    0.728    0.000    2.874    0.000 crystals.py:726(index_set)\n    45228    0.572    0.000    0.838    0.000 cartan_type.py:1822(index_set)\n...\n```",
    "created_at": "2013-01-16T13:34:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13204#issuecomment-201099",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:1'></a>
Another (more subtle) bug which comes from the same issue:

```
sage: C = KirillovReshetikhinCrystal(['A',int(4),1], 1,1)
sage: C[0].e0()
# Boom
AttributeError: 'int' object has no attribute 'epsilon'
```
The problem seems to be in that elements are created from `C.cartan_type().n` somewhere (I didn't track this down).

I've uploaded my fix for this which automatically calls the `CrystalOfLetters` on each element in the list (which should just type check and return the element back if it already is a letter). There is a slight performance hit (see below) for doing this rather than just checking the leading element. Also this takes care of input like:

```
sage: t = T(list=[T.letters(3),1,4,2])
sage: t = T(list=[CrystalOfLetters(['D',6])(3),1,4,2])
```
(Note CrystalOfLetters checks (well lack thereof) are not robust enough to catch the second input as an error, but that's a separate issue.) Really the question boils down to how pathological do we think the users might be with this versus the speed hit? If people think this is a good fix, this is ready to review.

Thanks,
 Travis

Performance data before patch:

```
sage: B = KirillovReshetikhinCrystal(['A',4,1], 3,3)

sage: %timeit L = [x for x in B]
5 loops, best of 3: 584 ms per loop
sage: %timeit L = [x for x in B]
5 loops, best of 3: 550 ms per loop

sage: %prun L = [x for x in B]
   398355 function calls in 4.147 seconds

   Ordered by: internal time

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
    45228    0.668    0.000    1.602    0.000 crystals.py:169(index_set)
    45053    0.658    0.000    2.433    0.000 crystals.py:727(index_set)
    45228    0.443    0.000    0.680    0.000 cartan_type.py:1822(index_set)
...
```
after patch:

```
sage: B = KirillovReshetikhinCrystal(['A',4,1], 3,3)

sage: %timeit L = [x for x in B]
5 loops, best of 3: 642 ms per loop
sage: %timeit L = [x for x in B]
5 loops, best of 3: 633 ms per loop

sage: %prun L = [x for x in B]
   426299 function calls in 5.135 seconds

   Ordered by: internal time

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
    45228    0.791    0.000    1.942    0.000 crystals.py:167(index_set)
    45053    0.728    0.000    2.874    0.000 crystals.py:726(index_set)
    45228    0.572    0.000    0.838    0.000 cartan_type.py:1822(index_set)
...
```



---

archive/issue_comments_201100.json:
```json
{
    "body": "**Changing status** from new to needs_info.",
    "created_at": "2013-01-16T13:34:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13204#issuecomment-201100",
    "user": "https://github.com/tscrim"
}
```

**Changing status** from new to needs_info.



---

archive/issue_comments_201101.json:
```json
{
    "body": "<a id='comment:2'></a>\nHi Travis,\n\nThanks for looking into this. In principle your solution is good, though I am not so happy about the performance loss. Also, it might be better to spell out the problem before your added test in the patch than (or in addition) to refer to this ticket.\n\nBest,\n\nAnne",
    "created_at": "2013-01-28T13:56:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13204#issuecomment-201101",
    "user": "https://github.com/anneschilling"
}
```

<a id='comment:2'></a>
Hi Travis,

Thanks for looking into this. In principle your solution is good, though I am not so happy about the performance loss. Also, it might be better to spell out the problem before your added test in the patch than (or in addition) to refer to this ticket.

Best,

Anne



---

archive/issue_comments_201102.json:
```json
{
    "body": "<a id='comment:3'></a>\nHere's a few other things I've tried:\n\nWith first checking an `isinstance()`:\n\n```\nletters_type = type(parent.letters) # It was slightly slower to put this in the lambda function\nletters_check = lambda x: x if isinstance(x, letters_type) else parent.letters(x)\nTensorProductOfCrystalsElement.__init__(self, parent, map(letters_check, list))\n\nsage: %timeit L = [x for x in B]\n5 loops, best of 3: 661 ms per loop\n```\n\nBy using the `in` check:\n\n```\nletters_check = lambda x: x if x in parent.letters else parent.letters(x)\nTensorProductOfCrystalsElement.__init__(self, parent, map(letters_check, list))\n\nsage: %timeit L = [x for x in B]\n5 loops, best of 3: 852 ms per loop\n```\n\nHere's my baseline timing with the current patch:\n\n```\nsage: %timeit L = [x for x in B]\n5 loops, best of 3: 610 ms per loop\n```",
    "created_at": "2013-01-28T17:25:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13204#issuecomment-201102",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:3'></a>
Here's a few other things I've tried:

With first checking an `isinstance()`:

```
letters_type = type(parent.letters) # It was slightly slower to put this in the lambda function
letters_check = lambda x: x if isinstance(x, letters_type) else parent.letters(x)
TensorProductOfCrystalsElement.__init__(self, parent, map(letters_check, list))

sage: %timeit L = [x for x in B]
5 loops, best of 3: 661 ms per loop
```

By using the `in` check:

```
letters_check = lambda x: x if x in parent.letters else parent.letters(x)
TensorProductOfCrystalsElement.__init__(self, parent, map(letters_check, list))

sage: %timeit L = [x for x in B]
5 loops, best of 3: 852 ms per loop
```

Here's my baseline timing with the current patch:

```
sage: %timeit L = [x for x in B]
5 loops, best of 3: 610 ms per loop
```



---

archive/issue_comments_201103.json:
```json
{
    "body": "**Changing author** from \"Anne Schilling\" to \"Travis Scrimshaw\".",
    "created_at": "2013-01-28T23:13:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13204#issuecomment-201103",
    "user": "https://github.com/tscrim"
}
```

**Changing author** from "Anne Schilling" to "Travis Scrimshaw".



---

archive/issue_comments_201104.json:
```json
{
    "body": "**Changing keywords** from \"\" to \"crystals\".",
    "created_at": "2013-01-28T23:13:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13204#issuecomment-201104",
    "user": "https://github.com/tscrim"
}
```

**Changing keywords** from "" to "crystals".



---

archive/issue_comments_201105.json:
```json
{
    "body": "<a id='comment:4'></a>\nAdded expanded documentation.",
    "created_at": "2013-01-28T23:13:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13204#issuecomment-201105",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:4'></a>
Added expanded documentation.



---

archive/issue_comments_201106.json:
```json
{
    "body": "**Changing reviewer** from \"Nicolas M. Thi\u00e9ry\" to \"Anne Schilling\".",
    "created_at": "2013-01-28T23:13:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13204#issuecomment-201106",
    "user": "https://github.com/tscrim"
}
```

**Changing reviewer** from "Nicolas M. Thi√©ry" to "Anne Schilling".



---

archive/issue_comments_201107.json:
```json
{
    "body": "**Changing status** from needs_info to needs_review.",
    "created_at": "2013-01-28T23:13:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13204#issuecomment-201107",
    "user": "https://github.com/tscrim"
}
```

**Changing status** from needs_info to needs_review.



---

archive/issue_comments_201108.json:
```json
{
    "body": "<a id='comment:5'></a>\nI talked to Travis about this and we ran the tests. It looks good to me now.\n\nAnne",
    "created_at": "2013-01-28T23:20:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13204#issuecomment-201108",
    "user": "https://github.com/anneschilling"
}
```

<a id='comment:5'></a>
I talked to Travis about this and we ran the tests. It looks good to me now.

Anne



---

archive/issue_comments_201109.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2013-01-28T23:21:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13204#issuecomment-201109",
    "user": "https://github.com/anneschilling"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_201110.json:
```json
{
    "body": "<a id='comment:7'></a>\nSmall documentation problem:\n\n```\n/release/merger/sage-5.7.beta2/local/lib/python2.7/site-packages/sage/combinat/crystals/tensor_product.py:docstring of sage.combinat.crystals.tensor_product.CrystalOfTableauxElement:38: WARNING: Inline literal start-string without end-string.\n```",
    "created_at": "2013-01-29T11:13:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13204#issuecomment-201110",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>
Small documentation problem:

```
/release/merger/sage-5.7.beta2/local/lib/python2.7/site-packages/sage/combinat/crystals/tensor_product.py:docstring of sage.combinat.crystals.tensor_product.CrystalOfTableauxElement:38: WARNING: Inline literal start-string without end-string.
```



---

archive/issue_comments_201111.json:
```json
{
    "body": "**Changing status** from positive_review to needs_work.",
    "created_at": "2013-01-29T11:13:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13204#issuecomment-201111",
    "user": "https://github.com/jdemeyer"
}
```

**Changing status** from positive_review to needs_work.



---

archive/attachments_017845.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_13204-robust_crystal_int-ts.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket13204/trac_13204-robust_crystal_int-ts.patch",
    "created_at": "2013-01-29T18:03:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13204",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/tscrim"
}
```



---

archive/issue_comments_201112.json:
```json
{
    "body": "Modified docstring",
    "created_at": "2013-01-29T18:03:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13204#issuecomment-201112",
    "user": "https://github.com/tscrim"
}
```

Modified docstring



---

archive/issue_comments_201113.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2013-01-29T18:05:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13204#issuecomment-201113",
    "user": "https://github.com/tscrim"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_201114.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2013-01-29T18:12:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13204#issuecomment-201114",
    "user": "https://github.com/anneschilling"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_events_042427.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-31T09:19:34Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/13204",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13204#event-42427"
}
```



---

archive/issue_comments_201115.json:
```json
{
    "body": "**Resolution:** fixed",
    "created_at": "2013-01-31T09:19:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13204#issuecomment-201115",
    "user": "https://github.com/jdemeyer"
}
```

**Resolution:** fixed



---

archive/issue_comments_201116.json:
```json
{
    "body": "**Merged:** sage-5.7.beta2",
    "created_at": "2013-01-31T09:19:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13204#issuecomment-201116",
    "user": "https://github.com/jdemeyer"
}
```

**Merged:** sage-5.7.beta2
