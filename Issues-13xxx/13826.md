# Issue 13826: Race condition in star_imports cache

archive/issues_013622.json:
```json
{
    "body": "See https://groups.google.com/d/topic/sage-devel/SN88f9qEIV8/discussion\n\nThe patchbot there sporadically fails on various tests with errors of \nthe type \n\n```\nTraceback (most recent call last): \n  File \"/mnt/storage2TB/patchbot/.sage/tmp/ \nvolker_desktop.stp.dias.ie-14095/multireplace_29004.py\", line 6, in \n<module> \n    from sage.all_cmdline import *; \n  File \"/mnt/storage2TB/patchbot/Sage/sage-5.5.rc0/local/lib/python/ \nsite-packages/sage/all_cmdline.py\", line 14, in <module> \n    from sage.all import * \n  File \"/mnt/storage2TB/patchbot/Sage/sage-5.5.rc0/local/lib/python/ \nsite-packages/sage/all.py\", line 72, in <module> \n    from sage.rings.all      import * \n  File \"/mnt/storage2TB/patchbot/Sage/sage-5.5.rc0/local/lib/python/ \nsite-packages/sage/rings/all.py\", line 169, in <module> \n    lazy_import(\"sage.rings.universal_cyclotomic_field.all\",\"*\") \n  File \"lazy_import.pyx\", line 850, in \nsage.misc.lazy_import.lazy_import (sage/misc/lazy_import.c:5168) \n    names[ix:ix+1] = get_star_imports(module) \n  File \"lazy_import.pyx\", line 900, in \nsage.misc.lazy_import.get_star_imports (sage/misc/lazy_import.c:5924) \n    star_imports = pickle.load(open(cache_file)) \nEOFError \n```\nThe patchbot is on a separate harddisk, mounted under /mnt/storage2TB. But my temp directory is tmpfs. So the pickle is moved across block devices, which is of course not atomic. Hence the patchbot sometimes dies here while opening a half-written file. The temporary file should be created in the target directory, only then can we be sure that the move is atomic.\n\n**Apply** [attachment:13826_star_imports_race_v2.patch]\n\nAssignee: GeorgSWeber\n\nCC:  @nbruin @robertwb\n\nReviewer: Volker Braun\n\nAuthor: Volker Braun, Jeroen Demeyer\n\nMerged: sage-5.9.rc0\n\nDependencies: #14292\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/13826\n\n",
    "closed_at": "2013-04-23T09:41:31Z",
    "created_at": "2012-12-12T18:58:14Z",
    "labels": [
        "component: build",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.9",
    "title": "Race condition in star_imports cache",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13826",
    "user": "https://github.com/vbraun"
}
```
See https://groups.google.com/d/topic/sage-devel/SN88f9qEIV8/discussion

The patchbot there sporadically fails on various tests with errors of 
the type 

```
Traceback (most recent call last): 
  File "/mnt/storage2TB/patchbot/.sage/tmp/ 
volker_desktop.stp.dias.ie-14095/multireplace_29004.py", line 6, in 
<module> 
    from sage.all_cmdline import *; 
  File "/mnt/storage2TB/patchbot/Sage/sage-5.5.rc0/local/lib/python/ 
site-packages/sage/all_cmdline.py", line 14, in <module> 
    from sage.all import * 
  File "/mnt/storage2TB/patchbot/Sage/sage-5.5.rc0/local/lib/python/ 
site-packages/sage/all.py", line 72, in <module> 
    from sage.rings.all      import * 
  File "/mnt/storage2TB/patchbot/Sage/sage-5.5.rc0/local/lib/python/ 
site-packages/sage/rings/all.py", line 169, in <module> 
    lazy_import("sage.rings.universal_cyclotomic_field.all","*") 
  File "lazy_import.pyx", line 850, in 
sage.misc.lazy_import.lazy_import (sage/misc/lazy_import.c:5168) 
    names[ix:ix+1] = get_star_imports(module) 
  File "lazy_import.pyx", line 900, in 
sage.misc.lazy_import.get_star_imports (sage/misc/lazy_import.c:5924) 
    star_imports = pickle.load(open(cache_file)) 
EOFError 
```
The patchbot is on a separate harddisk, mounted under /mnt/storage2TB. But my temp directory is tmpfs. So the pickle is moved across block devices, which is of course not atomic. Hence the patchbot sometimes dies here while opening a half-written file. The temporary file should be created in the target directory, only then can we be sure that the move is atomic.

**Apply** [attachment:13826_star_imports_race_v2.patch]

Assignee: GeorgSWeber

CC:  @nbruin @robertwb

Reviewer: Volker Braun

Author: Volker Braun, Jeroen Demeyer

Merged: sage-5.9.rc0

Dependencies: #14292

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/13826





---

archive/issue_comments_215191.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-12-12T19:15:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215191",
    "user": "https://github.com/vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_215192.json:
```json
{
    "body": "Changing author from \"\" to \"Volker Braun\"",
    "created_at": "2012-12-12T19:15:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215192",
    "user": "https://github.com/vbraun"
}
```

Changing author from "" to "Volker Braun"



---

archive/issue_comments_215193.json:
```json
{
    "body": "<a id='comment:3'></a>\nWhile we're nitpicking on possible race conditions anyway, isn't this unsafe?\n\n```\n    if star_imports is None:\n        cache_file = get_cache_file()\n        if os.path.exists(cache_file):\n            star_imports = pickle.load(open(cache_file))\n        else:\n            star_imports = {}\n\n``` \nThe file could get deleted between the existence check and the open. Shouldn't one do\n\n```\n    if star_imports is None:\n        cache_file = get_cache_file()\n        try:\n            opened_cache_file=open(cache_file)\n        except IOError, <whatever other errors should be caught>:\n            opened_cache_file=None\n        if opened_cache_file:\n            star_imports = pickle.load(opened_cache_file)\n            opened_cache_file.close()\n        else:\n            star_imports = {}\n```\nThis is of course assuming that either the cachefile is valid or does not exist. A \"mv\" on the filename shouldn't affect an already opened file.",
    "created_at": "2012-12-12T20:30:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215193",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:3'></a>
While we're nitpicking on possible race conditions anyway, isn't this unsafe?

```
    if star_imports is None:
        cache_file = get_cache_file()
        if os.path.exists(cache_file):
            star_imports = pickle.load(open(cache_file))
        else:
            star_imports = {}

``` 
The file could get deleted between the existence check and the open. Shouldn't one do

```
    if star_imports is None:
        cache_file = get_cache_file()
        try:
            opened_cache_file=open(cache_file)
        except IOError, <whatever other errors should be caught>:
            opened_cache_file=None
        if opened_cache_file:
            star_imports = pickle.load(opened_cache_file)
            opened_cache_file.close()
        else:
            star_imports = {}
```
This is of course assuming that either the cachefile is valid or does not exist. A "mv" on the filename shouldn't affect an already opened file.



---

archive/issue_comments_215194.json:
```json
{
    "body": "<a id='comment:4'></a>\nI agree that one should always `open()` and then ask for forgiveness. Fixed, too.",
    "created_at": "2012-12-12T21:36:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215194",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:4'></a>
I agree that one should always `open()` and then ask for forgiveness. Fixed, too.



---

archive/issue_comments_215195.json:
```json
{
    "body": "<a id='comment:5'></a>\nI think you're guarding a little too much in the `try: ... except` now. Wouldn't we want to know if unpickling went wrong? We have a good reason to catch errors from `open`: That's how we catch the file being legitimately non-existent. I think it's a real error we want reported if the file exists but doesn't contain a valid pickle. With your proposed code one could end up with a corrupted cache and consistently, silently, lose the efficiency of having the cache.\n\nTo some extent it's a matter of taste: Do you want to continue on a best-effort basis as much as possible or do you want the user to know that something didn't go as expected? I think the latter leads to an easier to debug program and therefore is more suitable for sage.",
    "created_at": "2012-12-12T23:03:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215195",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:5'></a>
I think you're guarding a little too much in the `try: ... except` now. Wouldn't we want to know if unpickling went wrong? We have a good reason to catch errors from `open`: That's how we catch the file being legitimately non-existent. I think it's a real error we want reported if the file exists but doesn't contain a valid pickle. With your proposed code one could end up with a corrupted cache and consistently, silently, lose the efficiency of having the cache.

To some extent it's a matter of taste: Do you want to continue on a best-effort basis as much as possible or do you want the user to know that something didn't go as expected? I think the latter leads to an easier to debug program and therefore is more suitable for sage.



---

archive/issue_comments_215196.json:
```json
{
    "body": "Updated patch",
    "created_at": "2012-12-13T13:51:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215196",
    "user": "https://github.com/vbraun"
}
```

Updated patch



---

archive/issue_comments_215197.json:
```json
{
    "body": "<a id='comment:6'></a>\nAttachment [trac_13826_star_imports_race.patch](tarball://root/attachments/some-uuid/ticket13826/trac_13826_star_imports_race.patch) by @vbraun created at 2012-12-13 13:55:39\n\nI've added a warning if the pickle is corrupted and converted `sage.sandpiles` to lazily import so we actually have something to test. Though neither of these changes is anywhere near as important as fixing the race condition.",
    "created_at": "2012-12-13T13:55:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215197",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:6'></a>
Attachment [trac_13826_star_imports_race.patch](tarball://root/attachments/some-uuid/ticket13826/trac_13826_star_imports_race.patch) by @vbraun created at 2012-12-13 13:55:39

I've added a warning if the pickle is corrupted and converted `sage.sandpiles` to lazily import so we actually have something to test. Though neither of these changes is anywhere near as important as fixing the race condition.



---

archive/issue_comments_215198.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Nils Bruin\"",
    "created_at": "2012-12-14T04:50:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215198",
    "user": "https://github.com/nbruin"
}
```

Changing reviewer from "" to "Nils Bruin"



---

archive/issue_comments_215199.json:
```json
{
    "body": "<a id='comment:7'></a>\nLooks good to me (mostly). Few small issues:\n- whitespace plugin complains about introduced whitespace\n- the code writing the cache file first deletes the cachefile, writes the new one in a temporary file, and then moves it in place. Why not leave the old cache file in place while the new one gets written?\nI'm setting review to positive anyway.",
    "created_at": "2012-12-14T04:50:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215199",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:7'></a>
Looks good to me (mostly). Few small issues:
- whitespace plugin complains about introduced whitespace
- the code writing the cache file first deletes the cachefile, writes the new one in a temporary file, and then moves it in place. Why not leave the old cache file in place while the new one gets written?
I'm setting review to positive anyway.



---

archive/issue_comments_215200.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-12-14T04:50:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215200",
    "user": "https://github.com/nbruin"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_215201.json:
```json
{
    "body": "<a id='comment:8'></a>\nReplying to [nbruin](#comment%3A7):\n>  - whitespace plugin complains about introduced whitespace\n\n\nSo? Go ahead and design a workflow that takes care of it automatically if it bothers you.\n\n>  - the code writing the cache file first deletes the cachefile, writes the new one in a temporary file, and then moves it in place.\n\n\nBecause os.rename() will fail if the destination exists on Windows (thanks for the well-thought out filesystem semantics, Bill G.!)",
    "created_at": "2012-12-14T05:28:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215201",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:8'></a>
Replying to [nbruin](#comment%3A7):
>  - whitespace plugin complains about introduced whitespace


So? Go ahead and design a workflow that takes care of it automatically if it bothers you.

>  - the code writing the cache file first deletes the cachefile, writes the new one in a temporary file, and then moves it in place.


Because os.rename() will fail if the destination exists on Windows (thanks for the well-thought out filesystem semantics, Bill G.!)



---

archive/issue_comments_215202.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2012-12-14T06:10:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215202",
    "user": "https://github.com/nbruin"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_215203.json:
```json
{
    "body": "<a id='comment:9'></a>\nOK, it seems the issues I pointed out are a little less straightforward than I thought, so they should probably be cleared up before this ticket gets merged.\n\n> So? Go ahead and design a workflow that takes care of it automatically if it bothers you.\n\n\nIt's a space after a colon on a line you introduce, not some whitespace on an empty line left by an auto-indenting editor.\n\n> Because os.rename() will fail if the destination exists on Windows (thanks for the well-thought out filesystem semantics, Bill G.!)\n\n\nThat's not what I meant. You can first write the temp file and then unlink the old one and move the new one in place. Presently the old cache file is already gone while you're writing the new one. An old cache file is better than none at all, it seems in this setting?",
    "created_at": "2012-12-14T06:10:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215203",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:9'></a>
OK, it seems the issues I pointed out are a little less straightforward than I thought, so they should probably be cleared up before this ticket gets merged.

> So? Go ahead and design a workflow that takes care of it automatically if it bothers you.


It's a space after a colon on a line you introduce, not some whitespace on an empty line left by an auto-indenting editor.

> Because os.rename() will fail if the destination exists on Windows (thanks for the well-thought out filesystem semantics, Bill G.!)


That's not what I meant. You can first write the temp file and then unlink the old one and move the new one in place. Presently the old cache file is already gone while you're writing the new one. An old cache file is better than none at all, it seems in this setting?



---

archive/issue_comments_215204.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [nbruin](#comment%3A9):\n> It's a space after a colon on a line you introduce, not some whitespace on an empty line left by an auto-indenting editor.\n\n\nSo?\n\n> That's not what I meant. You can first write the temp file and then unlink the old one and move the new one in place. Presently the old cache file is already gone while you're writing the new one. An old cache file is better than none at all, it seems in this setting?\n\n\nOr one could argue that a potentially stale cache is worse than a non-existent one. Doesn't really matter either way, serializing a dict takes no time.",
    "created_at": "2012-12-14T06:58:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215204",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:10'></a>
Replying to [nbruin](#comment%3A9):
> It's a space after a colon on a line you introduce, not some whitespace on an empty line left by an auto-indenting editor.


So?

> That's not what I meant. You can first write the temp file and then unlink the old one and move the new one in place. Presently the old cache file is already gone while you're writing the new one. An old cache file is better than none at all, it seems in this setting?


Or one could argue that a potentially stale cache is worse than a non-existent one. Doesn't really matter either way, serializing a dict takes no time.



---

archive/issue_comments_215205.json:
```json
{
    "body": "<a id='comment:11'></a>\nOK, I don't know what we're supposed to do with whitespace anymore. I hope someone else can sign off on that.\n\nConcerning the caching strategy: I'm not so sure the current code is particularly safe in the face of now-current development practices: If a cache file is present and contains an entry for a module then a lazy star import of that module will use that entry to initialize the namespace. I don't think the cache ever gets updated should it be discovered the data is out-of-sync.\n\nThe cache-file is only specific to the \"branch\" of sage. Now that people mostly use mercurial queues, the branch name hardly identifies the particular sage version. In particular, if I apply a patch that changes a lazily imported module, the cache will not be marked as stale and I will continue working with that. The cache will be resaved upon startup (see `all.py`), but only the entries of modules that weren't in the cache before will be updated, because the cache is blindly trusted for the other ones.\n\nI don't quite know what the best solution is. Perhaps `sage -b` should just always mark the cache as invalid (i.e., delete it)? In that case, `sage -b` should perhaps create the cache as well. In that case, there is no need to rewrite the cache every time and there's no race condition either.\n\nIt means that the cache would only reflect the sage \"system library\" and would need to be located somewhere in the tree rather than in a user's `.sage`. The problem is that in general the only way to know if the cache is stale is by looking at the modification dates of the module files and once we're statting all of those, we've lost what we were trying to gain. For the sage library we can reasonably assume that only `sage -b` changes that, so there we can cache state without having to stat.\n\nI realize that this is escalating the scope of this ticket a bit, but if `lazy_import` lies about objects available in the to-be-imported namespace (due to using a stale cache), we have a rather critical problem. I'm including Robert on the CC here in the hope he can explain why the current approach is safe.\n\nOr perhaps we should simply not do lazy star imports, only specific ones. Then the whole cache is not necessary.",
    "created_at": "2012-12-14T08:35:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215205",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:11'></a>
OK, I don't know what we're supposed to do with whitespace anymore. I hope someone else can sign off on that.

Concerning the caching strategy: I'm not so sure the current code is particularly safe in the face of now-current development practices: If a cache file is present and contains an entry for a module then a lazy star import of that module will use that entry to initialize the namespace. I don't think the cache ever gets updated should it be discovered the data is out-of-sync.

The cache-file is only specific to the "branch" of sage. Now that people mostly use mercurial queues, the branch name hardly identifies the particular sage version. In particular, if I apply a patch that changes a lazily imported module, the cache will not be marked as stale and I will continue working with that. The cache will be resaved upon startup (see `all.py`), but only the entries of modules that weren't in the cache before will be updated, because the cache is blindly trusted for the other ones.

I don't quite know what the best solution is. Perhaps `sage -b` should just always mark the cache as invalid (i.e., delete it)? In that case, `sage -b` should perhaps create the cache as well. In that case, there is no need to rewrite the cache every time and there's no race condition either.

It means that the cache would only reflect the sage "system library" and would need to be located somewhere in the tree rather than in a user's `.sage`. The problem is that in general the only way to know if the cache is stale is by looking at the modification dates of the module files and once we're statting all of those, we've lost what we were trying to gain. For the sage library we can reasonably assume that only `sage -b` changes that, so there we can cache state without having to stat.

I realize that this is escalating the scope of this ticket a bit, but if `lazy_import` lies about objects available in the to-be-imported namespace (due to using a stale cache), we have a rather critical problem. I'm including Robert on the CC here in the hope he can explain why the current approach is safe.

Or perhaps we should simply not do lazy star imports, only specific ones. Then the whole cache is not necessary.



---

archive/issue_comments_215206.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-12-14T08:35:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215206",
    "user": "https://github.com/nbruin"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_215207.json:
```json
{
    "body": "Changing reviewer from \"Nils Bruin\" to \"\"",
    "created_at": "2012-12-14T08:35:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215207",
    "user": "https://github.com/nbruin"
}
```

Changing reviewer from "Nils Bruin" to ""



---

archive/issue_comments_215208.json:
```json
{
    "body": "<a id='comment:12'></a>\n`sage -b` deletes the lazy import cache already. Are you saying that it doesn't work on your system?\n\n```\n[vbraun@volker-desktop ~]$ ll .sage/cache/\ntotal 4\n-rw-------. 1 vbraun vbraun 464 Dec 13 18:11 _home_vbraun_opt_sage-5.5.rc0_devel_sage-main-lazy_import_cache.pickle\n[vbraun@volker-desktop ~]$ sage -b >& /dev/null\n[vbraun@volker-desktop ~]$ ll .sage/cache/\ntotal 0\n[vbraun@volker-desktop ~]$ \n```\nIts better to be specific about what you import if you know what you need. On the other hand, `sage.all` of course star-imports other `.all` files.",
    "created_at": "2012-12-14T10:59:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215208",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:12'></a>
`sage -b` deletes the lazy import cache already. Are you saying that it doesn't work on your system?

```
[vbraun@volker-desktop ~]$ ll .sage/cache/
total 4
-rw-------. 1 vbraun vbraun 464 Dec 13 18:11 _home_vbraun_opt_sage-5.5.rc0_devel_sage-main-lazy_import_cache.pickle
[vbraun@volker-desktop ~]$ sage -b >& /dev/null
[vbraun@volker-desktop ~]$ ll .sage/cache/
total 0
[vbraun@volker-desktop ~]$ 
```
Its better to be specific about what you import if you know what you need. On the other hand, `sage.all` of course star-imports other `.all` files.



---

archive/issue_comments_215209.json:
```json
{
    "body": "<a id='comment:13'></a>\nYes, `sage -b` deletes the cache file, so the cache should never be stale.  Making the replacement atomic should be fixed though, and this patch does that.\n\nThe code looks good, except that I think the explicit unlink of the cache file before writing a new one is unnecessary (and could cause issues with multiple stage startups at the same time).  We've decided to ignore whitespace, so modulo that one issue, positive review.",
    "created_at": "2012-12-14T20:31:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215209",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:13'></a>
Yes, `sage -b` deletes the cache file, so the cache should never be stale.  Making the replacement atomic should be fixed though, and this patch does that.

The code looks good, except that I think the explicit unlink of the cache file before writing a new one is unnecessary (and could cause issues with multiple stage startups at the same time).  We've decided to ignore whitespace, so modulo that one issue, positive review.



---

archive/issue_comments_215210.json:
```json
{
    "body": "<a id='comment:14'></a>\nAs I said before, `os.rename()` will fail on Windows if the target exists. We could count on `os.rename()` fail on Windows and succeed on Unix, but thats also a bit wonky. Explicitly deleting the cache ensures that `save_cache_file()` does what you would think it does.",
    "created_at": "2012-12-14T21:36:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215210",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:14'></a>
As I said before, `os.rename()` will fail on Windows if the target exists. We could count on `os.rename()` fail on Windows and succeed on Unix, but thats also a bit wonky. Explicitly deleting the cache ensures that `save_cache_file()` does what you would think it does.



---

archive/issue_comments_215211.json:
```json
{
    "body": "<a id='comment:15'></a>\nOK, code is probably less ambiguous than trying to explain in words. Why do you do\n\n```\n+    try:\n+        os.unlink(cache_file)\n+    except OSError:\n+        pass   # cache_file does not exist, fine\n+    # important: create temp dir in cache_dir (trac #13826) to move atomically\n+    _, tmp_file = tempfile.mkstemp(dir=cache_dir)\n+    with open(tmp_file, \"w\") as tmp:\n+        pickle.dump(star_imports, tmp)\n+    try:\n+        os.rename(tmp_file, cache_file)\n+    except OSError:\n+        pass   # Windows can end up here, ignore\n```\ninstead of\n\n```\n+    # important: create temp dir in cache_dir (trac #13826) to move atomically\n+    _, tmp_file = tempfile.mkstemp(dir=cache_dir)\n+    with open(tmp_file, \"w\") as tmp:\n+        pickle.dump(star_imports, tmp)\n+    try:\n+        os.unlink(cache_file)\n+    except OSError:\n+        pass   # cache_file does not exist, fine\n+    try:\n+        os.rename(tmp_file, cache_file)\n+    except OSError:\n+        remove tmp_file if rename failed.\n```\nReplying to [vbraun](#comment%3A12):\n> `sage -b` deletes the lazy import cache already. Are you saying that it doesn't work on your system?\n\n\nAh, ok, it does. That alleviates the problem to some degree. I haven't been able to locate the code that does it, but it will only delete the cache in the `.sage/cache` of the UID running `sage -b`. So other UIDs are still out of luck. It seems to me that if `sage -b` knows when the cache needs to be refreshed then it should do so and the cache should probably be somewhere in sage_root rather than in a user directory.\n\nPerhaps rationalizing where the cache is held is something for a follow-up ticket.",
    "created_at": "2012-12-14T22:37:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215211",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:15'></a>
OK, code is probably less ambiguous than trying to explain in words. Why do you do

```
+    try:
+        os.unlink(cache_file)
+    except OSError:
+        pass   # cache_file does not exist, fine
+    # important: create temp dir in cache_dir (trac #13826) to move atomically
+    _, tmp_file = tempfile.mkstemp(dir=cache_dir)
+    with open(tmp_file, "w") as tmp:
+        pickle.dump(star_imports, tmp)
+    try:
+        os.rename(tmp_file, cache_file)
+    except OSError:
+        pass   # Windows can end up here, ignore
```
instead of

```
+    # important: create temp dir in cache_dir (trac #13826) to move atomically
+    _, tmp_file = tempfile.mkstemp(dir=cache_dir)
+    with open(tmp_file, "w") as tmp:
+        pickle.dump(star_imports, tmp)
+    try:
+        os.unlink(cache_file)
+    except OSError:
+        pass   # cache_file does not exist, fine
+    try:
+        os.rename(tmp_file, cache_file)
+    except OSError:
+        remove tmp_file if rename failed.
```
Replying to [vbraun](#comment%3A12):
> `sage -b` deletes the lazy import cache already. Are you saying that it doesn't work on your system?


Ah, ok, it does. That alleviates the problem to some degree. I haven't been able to locate the code that does it, but it will only delete the cache in the `.sage/cache` of the UID running `sage -b`. So other UIDs are still out of luck. It seems to me that if `sage -b` knows when the cache needs to be refreshed then it should do so and the cache should probably be somewhere in sage_root rather than in a user directory.

Perhaps rationalizing where the cache is held is something for a follow-up ticket.



---

archive/issue_comments_215212.json:
```json
{
    "body": "<a id='comment:16'></a>\nThe cache is deleted in `setup.py`, so yes this will cause problem if you run a Sage version that somebody else built.\n\nI don't care about where to put the unlink, I put it right after the mkdir since it is part of preparing the directory. Of course other people like their bike shed pink. Or are you saying that you want to clean up after a potential race on Windows? Feel free to implement that if you want. Erasing can again fail on Windows for existing files. Doesn't strike me as the most urgent problem either.",
    "created_at": "2012-12-14T22:57:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215212",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:16'></a>
The cache is deleted in `setup.py`, so yes this will cause problem if you run a Sage version that somebody else built.

I don't care about where to put the unlink, I put it right after the mkdir since it is part of preparing the directory. Of course other people like their bike shed pink. Or are you saying that you want to clean up after a potential race on Windows? Feel free to implement that if you want. Erasing can again fail on Windows for existing files. Doesn't strike me as the most urgent problem either.



---

archive/issue_comments_215213.json:
```json
{
    "body": "<a id='comment:17'></a>\nI think we should plug this obvious race with the patch I posted. So please review if you care about patchbot results :-P",
    "created_at": "2013-01-24T12:17:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215213",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:17'></a>
I think we should plug this obvious race with the patch I posted. So please review if you care about patchbot results :-P



---

archive/issue_comments_215214.json:
```json
{
    "body": "<a id='comment:18'></a>\nSee #14292 for a general approach to solving the problem of race conditions when writing to a file, which should probably be used here.",
    "created_at": "2013-04-04T13:37:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215214",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>
See #14292 for a general approach to solving the problem of race conditions when writing to a file, which should probably be used here.



---

archive/issue_comments_215215.json:
```json
{
    "body": "Changing author from \"Volker Braun\" to \"Volker Braun, Jeroen Demeyer\"",
    "created_at": "2013-04-04T14:00:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215215",
    "user": "https://github.com/jdemeyer"
}
```

Changing author from "Volker Braun" to "Volker Braun, Jeroen Demeyer"



---

archive/issue_comments_215216.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -28,3 +28,4 @@\n ```\n The patchbot is on a separate harddisk, mounted under /mnt/storage2TB. But my temp directory is tmpfs. So the pickle is moved across block devices, which is of course not atomic. Hence the patchbot sometimes dies here while opening a half-written file. The temporary file should be created in the target directory, only then can we be sure that the move is atomic.\n \n+**Apply** [attachment:13826_star_imports_race_v2.patch]\n``````\n",
    "created_at": "2013-04-04T14:00:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215216",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -28,3 +28,4 @@
 ```
 The patchbot is on a separate harddisk, mounted under /mnt/storage2TB. But my temp directory is tmpfs. So the pickle is moved across block devices, which is of course not atomic. Hence the patchbot sometimes dies here while opening a half-written file. The temporary file should be created in the target directory, only then can we be sure that the move is atomic.
 
+**Apply** [attachment:13826_star_imports_race_v2.patch]
``````




---

archive/issue_comments_215217.json:
```json
{
    "body": "Changing dependencies from \"\" to \"#14292\"",
    "created_at": "2013-04-04T14:00:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215217",
    "user": "https://github.com/jdemeyer"
}
```

Changing dependencies from "" to "#14292"



---

archive/issue_comments_215218.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Volker Braun\"",
    "created_at": "2013-04-13T15:45:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215218",
    "user": "https://github.com/vbraun"
}
```

Changing reviewer from "" to "Volker Braun"



---

archive/issue_comments_215219.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-04-13T15:45:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215219",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_044922.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-13T15:49:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "milestone": "sage-5.10",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13826#event-44922"
}
```



---

archive/issue_comments_215220.json:
```json
{
    "body": "<a id='comment:22'></a>\nAdded\n\n```diff\ndiff --git a/sage/misc/lazy_import.pyx b/sage/misc/lazy_import.pyx\n--- a/sage/misc/lazy_import.pyx\n+++ b/sage/misc/lazy_import.pyx\n@@ -909,6 +909,7 @@\n     \"\"\"\n     global star_imports\n     if star_imports is None:\n+        star_imports = {}\n         try:\n             with open(get_cache_file()) as cache_file:\n                 star_imports = pickle.load(cache_file)\n@@ -917,7 +918,6 @@\n         except Exception:  # unpickling failed\n             import warnings\n             warnings.warn('star_imports cache is corrupted')\n-        star_imports = {}\n     try:\n         return star_imports[module_name]\n     except KeyError:\n```",
    "created_at": "2013-04-13T15:53:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215220",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'></a>
Added

```diff
diff --git a/sage/misc/lazy_import.pyx b/sage/misc/lazy_import.pyx
--- a/sage/misc/lazy_import.pyx
+++ b/sage/misc/lazy_import.pyx
@@ -909,6 +909,7 @@
     """
     global star_imports
     if star_imports is None:
+        star_imports = {}
         try:
             with open(get_cache_file()) as cache_file:
                 star_imports = pickle.load(cache_file)
@@ -917,7 +918,6 @@
         except Exception:  # unpickling failed
             import warnings
             warnings.warn('star_imports cache is corrupted')
-        star_imports = {}
     try:
         return star_imports[module_name]
     except KeyError:
```



---

archive/issue_comments_215221.json:
```json
{
    "body": "<a id='comment:23'></a>\nAttachment [13826_star_imports_race_v2.patch](tarball://root/attachments/some-uuid/ticket13826/13826_star_imports_race_v2.patch) by @jdemeyer created at 2013-04-13 15:53:56",
    "created_at": "2013-04-13T15:53:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215221",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:23'></a>
Attachment [13826_star_imports_race_v2.patch](tarball://root/attachments/some-uuid/ticket13826/13826_star_imports_race_v2.patch) by @jdemeyer created at 2013-04-13 15:53:56



---

archive/issue_comments_215222.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2013-04-13T15:53:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215222",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_215223.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-04-13T15:54:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215223",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_215224.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-04-13T16:08:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215224",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_044923.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-23T09:41:31Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13826#event-44923"
}
```



---

archive/issue_comments_215225.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-04-23T09:41:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215225",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_215226.json:
```json
{
    "body": "Changing merged from \"\" to \"sage-5.10.beta0\"",
    "created_at": "2013-04-23T09:41:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215226",
    "user": "https://github.com/jdemeyer"
}
```

Changing merged from "" to "sage-5.10.beta0"



---

archive/issue_events_044924.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-23T10:15:20Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "milestone": "sage-5.10",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13826#event-44924"
}
```



---

archive/issue_events_044925.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-23T10:15:20Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "milestone": "sage-5.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13826#event-44925"
}
```



---

archive/issue_comments_215227.json:
```json
{
    "body": "Changing merged from \"sage-5.10.beta0\" to \"sage-5.9.rc0\"",
    "created_at": "2013-04-23T10:15:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13826",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13826#issuecomment-215227",
    "user": "https://github.com/jdemeyer"
}
```

Changing merged from "sage-5.10.beta0" to "sage-5.9.rc0"
