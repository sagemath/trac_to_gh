# Issue 10904: new doctest for french book about Sage

Issue created by migration from https://trac.sagemath.org/ticket/10983

Original creator: casamayou

Original creation time: 2011-03-22 15:56:20

Assignee: mvngu

CC:  zimmerma saliola

The attached patch includes a new doctest for a book (in french) some people are writing about Sage, under the supervision of Paul Zimmermann.

This patch contains only the doctests for two chapters (about calculus and graphics and solutions for corresponding exercices). 

This doctest was tested successfully with Sage 4.6.2 under Debian Squeeze.


---

Attachment


---

Comment by zimmerma created at 2011-08-24 19:51:48

Changing status from new to needs_review.


---

Comment by zimmerma created at 2011-08-24 19:51:48

Franco, please could you review this ticket for inclusion in the Sage doctests?
This will ensure stability of the example of our book (see #9395).

Thank you,
Paul


---

Comment by saliola created at 2011-08-24 20:27:30

Changing status from needs_review to needs_info.


---

Comment by saliola created at 2011-08-24 20:27:30

Hello Paul. I think it is a great idea to include these tests in Sage. However, the files are just python files that contain docstrings; I suspect that one would prefer a patch instead (perhaps I am wrong about this). In order to produce a patch, one needs to first find the best place to put these tests within the sage library. Is there a standard location for such tests?


---

Comment by zimmerma created at 2011-08-24 20:37:06

Replying to [comment:4 saliola]:
> Hello Paul. I think it is a great idea to include these tests in Sage. However, the files are just python files that contain docstrings; I suspect that one would prefer a patch instead (perhaps I am wrong about this). In order to produce a patch, one needs to first find the best place to put these tests within the sage library. Is there a standard location for such tests?

Franco, you are right. The standard location is `tests/french_book` where there is already
the Python file corresponding to #9395.

Alexandre, please could you make a real patch? Do you know how to do that?

Paul


---

Attachment


---

Comment by casamayou created at 2011-08-25 13:16:27

Paul,
Here is the log-message for the patch.

Alexandre.


---

Comment by dimpase created at 2011-11-22 12:28:18

Changing status from needs_info to needs_review.


---

Comment by dimpase created at 2011-11-22 12:32:12

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2011-11-27 21:26:31

I am slightly worried about timings.  Did you check how long the tests take?  You might need to add `#long time` in various places.


---

Comment by dimpase created at 2011-11-28 03:41:30

Replying to [comment:10 jdemeyer]:
> I am slightly worried about timings.  Did you check how long the tests take?  You might need to add `#long time` in various places.

the longest test took about 2 minutes on  1.8Gz Intel. Is it something that should be marked as long? Do we have any specific guidelines on this?


---

Comment by jdemeyer created at 2011-11-28 08:40:26

Replying to [comment:11 dimpase]:
> the longest test took about 2 minutes on  1.8Gz Intel. Is it something that should be marked as long? Do we have any specific guidelines on this?

Guidelines say: anything more than 1 second (on sage.math) should be marked as long time.  No test should take more than 30 seconds (even though we have several tests taking more than 30 seconds).


---

Comment by dimpase created at 2011-11-28 09:02:50

Replying to [comment:12 jdemeyer]:
> Replying to [comment:11 dimpase]:
> > the longest test took about 2 minutes on  1.8Gz Intel. Is it something that should be marked as long? Do we have any specific guidelines on this?
> 
> Guidelines say: anything more than 1 second (on sage.math) should be marked as long time.  No test should take more than 30 seconds (even though we have several tests taking more than 30 seconds).

Oops, sorry. I'll revert to needs_work then!
As well, there are tests that ought to be broken into several subtests - as they are really long sequences of independent tests.
Would be great if this it taken care of, too.


---

Comment by dimpase created at 2011-11-28 09:02:50

Changing status from positive_review to needs_work.


---

Comment by casamayou created at 2011-11-29 11:40:01

Replying to [comment:13 dimpase]:
> As well, there are tests that ought to be broken into several subtests - as they are really long sequences of independent tests.
> Would be great if this it taken care of, too.

By breaking tests into several subtests, did you think test as file or as code line ? 
Shall I break the files 'graphique*.py' and 'sol_graphiques*.py' into shortest files ?


---

Comment by dimpase created at 2011-11-29 11:48:02

Replying to [comment:14 casamayou]:
> Replying to [comment:13 dimpase]:
> > As well, there are tests that ought to be broken into several subtests - as they are really long sequences of independent tests.
> > Would be great if this it taken care of, too.
> 
> By breaking tests into several subtests, did you think test as file or as code line ? 
> Shall I break the files 'graphique*.py' and 'sol_graphiques*.py' into shortest files ?

Yes, this looks like a good idea . 
Perhaps there is also a way to have several independent tests in one file, I don't know.


---

Comment by jdemeyer created at 2011-11-29 13:25:06

Replying to [comment:15 dimpase]:
> Perhaps there is also a way to have several independent tests in one file, I don't know.

Of course you can have several independent tests in one file, just like you can have more than one function or more than one class in a file.  Just put several test blocks in the file:

```
r"""
test1
"""

r"""
test2
"""
```

instead of

```
r"""
test1
test2
"""
```



---

Comment by casamayou created at 2011-11-29 20:36:03

Replying to [comment:16 jdemeyer]:
> Replying to [comment:15 dimpase]:
> > Perhaps there is also a way to have several independent tests in one file, I don't know.
> 
> Of course you can have several independent tests in one file, just like you can have more than one function or more than one class in a file.  Just put several test blocks in the file:



Attached you will find the test files corrected.

The too long tests were commented: # long time

Does that sound correct ?

Here are the execution time :


```
$ for i in *.py ; do sage -t $i; done; 
sage -t  "calculus_fixed.py"                                
	 [11.2 s]
 
----------------------------------------------------------------------
All tests passed!
Total time for all tests: 11.2 seconds
sage -t  "graphique_1_fixed.py"                             
	 [14.9 s]
 
----------------------------------------------------------------------
All tests passed!
Total time for all tests: 15.0 seconds
sage -t  "graphique_2_fixed.py"                             
	 [19.4 s]
 
----------------------------------------------------------------------
All tests passed!
Total time for all tests: 19.4 seconds
sage -t  "graphique_3_fixed.py"                             
	 [8.3 s]
 
----------------------------------------------------------------------
All tests passed!
Total time for all tests: 8.4 seconds
sage -t  "sol_calculus_fixed.py"                            
	 [8.9 s]
 
----------------------------------------------------------------------
All tests passed!
Total time for all tests: 9.0 seconds
sage -t  "sol_graphiques_1_fixed.py"                        
	 [13.0 s]
 
----------------------------------------------------------------------
All tests passed!
Total time for all tests: 13.1 seconds
sage -t  "sol_graphiques_2_fixed.py"                        
	 [4.8 s]
 
----------------------------------------------------------------------
All tests passed!
Total time for all tests: 4.8 seconds
```


And with the long tests :


```
$ for i in *.py ; do sage -t -long $i; done; 
sage -t -long "calculus_fixed.py"                           
	 [11.2 s]
 
----------------------------------------------------------------------
All tests passed!
Total time for all tests: 11.3 seconds
sage -t -long "graphique_1_fixed.py"                        
	 [323.1 s]
 
----------------------------------------------------------------------
All tests passed!
Total time for all tests: 323.1 seconds
sage -t -long "graphique_2_fixed.py"                        
	 [20.3 s]
 
----------------------------------------------------------------------
All tests passed!
Total time for all tests: 20.3 seconds
sage -t -long "graphique_3_fixed.py"                        
	 [8.1 s]
 
----------------------------------------------------------------------
All tests passed!
Total time for all tests: 8.1 seconds
sage -t -long "sol_calculus_fixed.py"                       
	 [8.9 s]
 
----------------------------------------------------------------------
All tests passed!
Total time for all tests: 9.0 seconds
sage -t -long "sol_graphiques_1_fixed.py"                   
	 [47.3 s]
 
----------------------------------------------------------------------
All tests passed!
Total time for all tests: 47.3 seconds
sage -t -long "sol_graphiques_2_fixed.py"                   
	 [64.9 s]
 
----------------------------------------------------------------------
All tests passed!
Total time for all tests: 65.0 seconds
```



It was the execution of the following instruction that is very long :


```
sage: f = lambda x, y : (abs(cos((x + I * y) ** 4)) - 1)
sage: g2 = implicit_plot(f, (-3, 3), (-3, 3), plot_points=400) # long time 
```



---

Attachment


---

Attachment


---

Attachment


---

Attachment


---

Attachment


---

Comment by casamayou created at 2011-11-30 17:27:51

updated file


---

Attachment

updated file


---

Attachment

updated file


---

Attachment

updated file


---

Comment by casamayou created at 2011-11-30 17:39:18

updated file


---

Attachment

updated file


---

Attachment

updated file


---

Comment by casamayou created at 2011-11-30 17:52:46

The files *_fixed.py are outdated, because they were tested under sage 7.4.1.

The following files have been updated and tested under sage 7.4.2 and are the only ones to consider:

calculus.py  
graphique_1.py  
graphique_2.py  
graphique_3.py  
sol_calculus.py  
sol_graphiques_1.py  
sol_graphiques_2.py


---

Comment by casamayou created at 2011-11-30 19:38:10

One more question.

Should I create a new file trac_10983.patch with a "hg commit" ?

(Sorry... I'm a newbie)


---

Comment by dimpase created at 2011-12-01 02:12:21

Replying to [comment:19 casamayou]:
> One more question.
> 
> Should I create a new file trac_10983.patch with a "hg commit" ?
> 
> (Sorry... I'm a newbie)

hg commit is what you might sometimes do after applying a patch. It certainly does not create patches. You can create patches using hg, e.g. by hg import. But you don't have to. I'll look at your updates later today.


---

Comment by mmezzarobba created at 2013-03-22 20:42:41

Here are updated tests that correspond to the current version of the book. (The division of chapters changed a little bit, but the tests I'm including here roughly correspond to those posted by Alexandre.)

On my machine, using Sage-5.9β0:


```
Running doctests with ID 2013-03-22-21-36-07-c7afe8cf.
Doctesting 3 files.
sage -t calculus_doctest.py
    [246 tests, 6.9 s]
sage -t graphique_doctest.py
    [167 tests, 26.8 s]
sage -t premierspas_doctest.py
    [49 tests, 1.5 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 35.4 seconds
    cpu time: 30.6 seconds
    cumulative wall time: 35.2 seconds
```



---

Comment by mmezzarobba created at 2013-03-22 20:42:41

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2013-07-04 09:46:11

Most of the doctests break on sage 5.1.beta3. Most output are ordered differently, so there's nothing to be worried about either.


```
----------------------------------------------------------------------
sage -t --long calculus_doctest.py  # 12 doctests failed
sage -t --long graphique_doctest.py  # 1 doctest failed
----------------------------------------------------------------------
```


Nathann

Apply trac_10983_doctests_from_french_book.patch


---

Comment by ncohen created at 2013-07-04 09:46:11

Changing status from needs_review to needs_work.


---

Comment by ncohen created at 2013-07-04 09:46:37

Ahem. 5.11.beta3 `:-P`

Nathann


---

Attachment

Combined patch


---

Comment by zimmerma created at 2013-08-23 08:03:31

I've made a new patch with a different ordering in the outputs, due to a recent change in Sage (I can't find the corresponding ticket). Unfortunately the book output now slightly differs with what we get in Sage. This patch works fine with Sage 5.11.

Paul


---

Comment by zimmerma created at 2013-08-23 08:03:31

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2013-08-23 08:13:23

The ticket which changed the ordering is #9880.


---

Comment by chapoton created at 2013-09-22 19:46:41

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2013-09-22 19:46:41

indentation should be 4 spaces rather than 2


---

Comment by chapoton created at 2013-10-15 18:11:37

for patchbot:

apply trac_10983_doctests_from_french_book.patch​


---

Comment by chapoton created at 2013-10-15 18:13:05

apply trac_10983_doctests_from_french_book.patch


---

Attachment


---

Comment by chapoton created at 2013-10-22 18:53:17

I have made a new patch with correct indentations.

Unfortunately, there are now 2 doctest errors with simplify_full !!!

for the *patchbots*:

apply trac_10983_doctests_from_french_book_v2.patch


---

Comment by dimpase created at 2013-10-23 10:26:14

Replying to [comment:30 chapoton]:
> I have made a new patch with correct indentations.
> 
> Unfortunately, there are now 2 doctest errors with simplify_full !!!

How about the following changes: (I suppose this also means minor corrections to the main text, which I can't do)


```
diff --git a/sage/tests/french_book/calculus_doctest.py b/sage/tests/french_book/calculus_doctest.py
--- a/sage/tests/french_book/calculus_doctest.py
+++ b/sage/tests/french_book/calculus_doctest.py
@@ -643,7 +643,7 @@
     sage: assume(8*n+1>0)
     sage: u(n) = integrate((4*sqrt(2)-8*t^3-4*sqrt(2)*t^4\
     ....:                  -8*t^5) * t^(8*n), t, 0, 1/sqrt(2))
-    sage: (u(n)-v(n)).simplify_full()
+    sage: (u(n)-v(n)).simplify_exp()
     0
 
 Sage example in ./sol/calculus.tex, line 258::
@@ -652,8 +652,8 @@
     sage: J = integrate((4*sqrt(2)-8*t^3 \
     ....:      - 4*sqrt(2)*t^4-8*t^5)\
     ....:      / (1-t^8), t, 0, 1/sqrt(2))
-    sage: J.simplify_full()
-    pi + 2*log(sqrt(2) + 1) + 2*log(sqrt(2) - 1)
+    sage: J.simplify_log().simplify_full()
+    pi
 
 Sage example in ./sol/calculus.tex, line 272::
 
```



---

Comment by zimmerma created at 2013-11-06 14:44:55

the second doctest failure looks like a regression in Sage, since the expression `2*e` is not simplified similarly to `e`:

```
sage: e=log(1/2*sqrt(2)*(sqrt(2) + 1)) + log(1/2*sqrt(2)*(sqrt(2) - 1))
sage: e.simplify_full()
-log(2)
sage: (2*e).simplify_full()
2*log(1/2*sqrt(2)*(sqrt(2) + 1)) + 2*log(1/2*sqrt(2)*(sqrt(2) - 1))
```

Should I open a ticket for that?

Paul


---

Comment by dimpase created at 2013-11-06 15:21:55

Replying to [comment:33 zimmerma]:
> the second doctest failure looks like a regression in Sage, since the expression `2*e` is not simplified similarly to `e`:
> {{{
> sage: (2*e).simplify_full()
> 2*log(1/2*sqrt(2)*(sqrt(2) + 1)) + 2*log(1/2*sqrt(2)*(sqrt(2) - 1))
> }}}
> Should I open a ticket for that?

Just as in the patch proposed, you may chain simplifies, getting 

```
sage: (2*e).simplify_log().simplify_full()
-log(4)
```

Not sure it's a Maxima regression, or a proper Sage regression. Opening a trac ticket won't hurt, I suppose.


---

Comment by zimmerma created at 2013-11-06 15:28:52

> Opening a trac ticket won't hurt, I suppose.

done, cf #15362.

Paul


---

Comment by zimmerma created at 2013-11-06 16:47:01

a simpler fix is to replace `simplify_full` by `simplify_radical` in the two failing doctests. See #15362. Since that change also works before #12737 (merged in Sage 5.12) I will do the change in our book too.

Paul


---

Attachment

with the new patch, the doctests pass again. Ready for review.

Paul


---

Comment by zimmerma created at 2013-11-06 16:53:06

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2013-11-08 13:25:38

looks good to me.


---

Comment by dimpase created at 2013-11-08 13:25:38

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-11-12 11:33:25

Resolution: fixed
