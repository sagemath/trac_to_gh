# Issue 28269: Direct sum of polyhedron is broken

archive/issues_028269.json:
```json
{
    "body": "CC:  @laisrast @kliem\n\nKeywords: polytopes\n\nThe following returns a `TypeError`:\n\n\n```\nsage: s2 = polytopes.simplex(2)\nsage: s3 = polytopes.simplex(3)\nsage: t = s2.direct_sum(s3)\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/28506\n\n",
    "created_at": "2019-09-16T11:57:17Z",
    "labels": [
        "geometry",
        "major",
        "bug"
    ],
    "title": "Direct sum of polyhedron is broken",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28269",
    "user": "jipilab"
}
```
CC:  @laisrast @kliem

Keywords: polytopes

The following returns a `TypeError`:


```
sage: s2 = polytopes.simplex(2)
sage: s3 = polytopes.simplex(3)
sage: t = s2.direct_sum(s3)
```


Issue created by migration from https://trac.sagemath.org/ticket/28506





---

archive/issue_comments_399266.json:
```json
{
    "body": "I'll fix it. Should be fast.\n\nAs far as I know, it's difficult to determine, whether this operation can be done with ring `ZZ`. So there are basically two options:\n\n- try the operation with coerced base rings and go to quotient field, if it fails (this is how `intersection` handles it)\n- just go to field in all cases.\n\nWhat do you think is better?",
    "created_at": "2019-09-16T13:10:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28269#issuecomment-399266",
    "user": "@kliem"
}
```

I'll fix it. Should be fast.

As far as I know, it's difficult to determine, whether this operation can be done with ring `ZZ`. So there are basically two options:

- try the operation with coerced base rings and go to quotient field, if it fails (this is how `intersection` handles it)
- just go to field in all cases.

What do you think is better?



---

archive/issue_comments_399267.json:
```json
{
    "body": "`minkowski_difference` fails for the same reason. This fails, as coercing base rings may not suffice:\n\n\n```\nsage: Q = Polyhedron([[1,0],[0,1]])\nsage: S = Polyhedron([[0,0],[1,2]])\nsage: S.minkowski_difference(Q)\n```\n\n\nSame for `face_truncation` (also there is no example of linear coefficients in the docstring):\n\n```\nsage: P = polytopes.permutahedron(3)\nsage: P.face_truncation(P.faces(0)[0], linear_coefficients=[0,1,2], cut_frac=1)\n```\n",
    "created_at": "2019-09-16T13:28:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28269#issuecomment-399267",
    "user": "@kliem"
}
```

`minkowski_difference` fails for the same reason. This fails, as coercing base rings may not suffice:


```
sage: Q = Polyhedron([[1,0],[0,1]])
sage: S = Polyhedron([[0,0],[1,2]])
sage: S.minkowski_difference(Q)
```


Same for `face_truncation` (also there is no example of linear coefficients in the docstring):

```
sage: P = polytopes.permutahedron(3)
sage: P.face_truncation(P.faces(0)[0], linear_coefficients=[0,1,2], cut_frac=1)
```




---

archive/issue_comments_399268.json:
```json
{
    "body": "I did both approaches. The approach that always takes the fraction is pushed into `public/28506-bis`.\n\nI guess there are pros and cons of both methods. I think most important cons are:\n- `try ... except` might take more much more time (I assume it can theoretically compute almost everything)\n- `try ... except` is a bad approach, if there was ever a thing as a lazy polyhedron (but then again, its a bad idea to set up a lazy Polyhedron in `ZZ` from inequalities and don't check, whether this works)\n- always taking fraction field changes the behavior of the methods (and it looks awful for Minkowski decomposition)\n----\nNew commits:",
    "created_at": "2019-09-16T15:47:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28269#issuecomment-399268",
    "user": "@kliem"
}
```

I did both approaches. The approach that always takes the fraction is pushed into `public/28506-bis`.

I guess there are pros and cons of both methods. I think most important cons are:
- `try ... except` might take more much more time (I assume it can theoretically compute almost everything)
- `try ... except` is a bad approach, if there was ever a thing as a lazy polyhedron (but then again, its a bad idea to set up a lazy Polyhedron in `ZZ` from inequalities and don't check, whether this works)
- always taking fraction field changes the behavior of the methods (and it looks awful for Minkowski decomposition)
----
New commits:



---

archive/issue_comments_399269.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-09-16T15:47:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28269#issuecomment-399269",
    "user": "@kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_399270.json:
```json
{
    "body": "Btw, the constructor sets up all H-Polyhedra with base ring as field unless one specifies a specific base ring.\n\nActually, I think this is the better approach, as construction should be done with a parent, for which they are well-defined, e.g.:\n\n- intersection of Polyhedra in `ZZ^2` are only well-defined in `QQ^2`, it's strange if some constructions have parent `ZZ^2`, while others have parent `QQ^2`\n- `face_truncation` for Polyhedra over `ZZ` is only well-defined if we lift them up to `QQ`",
    "created_at": "2019-09-16T16:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28269#issuecomment-399270",
    "user": "@kliem"
}
```

Btw, the constructor sets up all H-Polyhedra with base ring as field unless one specifies a specific base ring.

Actually, I think this is the better approach, as construction should be done with a parent, for which they are well-defined, e.g.:

- intersection of Polyhedra in `ZZ^2` are only well-defined in `QQ^2`, it's strange if some constructions have parent `ZZ^2`, while others have parent `QQ^2`
- `face_truncation` for Polyhedra over `ZZ` is only well-defined if we lift them up to `QQ`



---

archive/issue_comments_399271.json:
```json
{
    "body": "One comment:\n\nThe tests should actually return something, so I would remove `t = ` and let the output get printed.\n\nI am still a bit puzzled as to why it did not work for direct sum. What was going on there?",
    "created_at": "2019-09-20T08:44:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28269#issuecomment-399271",
    "user": "jipilab"
}
```

One comment:

The tests should actually return something, so I would remove `t = ` and let the output get printed.

I am still a bit puzzled as to why it did not work for direct sum. What was going on there?



---

archive/issue_comments_399272.json:
```json
{
    "body": "Replying to [comment:5 jipilab]:\n> One comment:\n> \n> The tests should actually return something, so I would remove `t = ` and let the output get printed.\n\nOk. Will do it.\n> \n> I am still a bit puzzled as to why it did not work for direct sum. What was going on there?\n\n\n```\nsage: s2 = polytopes.simplex(2)\nsage: s2.base_ring()\nInteger Ring\nsage: s = polytopes.simplex(2)\nsage: s.base_ring()\nInteger Ring\nsage: s = s.change_ring(QQ)\nsage: t = s.direct_sum(s)\nsage: t.vertices()\n(A vertex at (0, 0, 1, 0, 0, 0),\n A vertex at (0, 1, 0, 0, 0, 0),\n A vertex at (1, 0, 0, 0, 0, 0),\n A vertex at (1/3, 1/3, 1/3, -1/3, -1/3, 2/3),\n A vertex at (1/3, 1/3, 1/3, -1/3, 2/3, -1/3),\n A vertex at (1/3, 1/3, 1/3, 2/3, -1/3, -1/3))\n```\n\n\nDoes this answer your question? As mentioned, direct sum (as well as intersection, minkowski difference and face truncation) are only defined for polytopes/polyhedra over a field.\n\nIn the same way, that `sage: 6/2` returns a rational, I think those operations should return a polytope with base ring constructed by first coercing and then taking the fraction field.",
    "created_at": "2019-09-20T09:29:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28269#issuecomment-399272",
    "user": "@kliem"
}
```

Replying to [comment:5 jipilab]:
> One comment:
> 
> The tests should actually return something, so I would remove `t = ` and let the output get printed.

Ok. Will do it.
> 
> I am still a bit puzzled as to why it did not work for direct sum. What was going on there?


```
sage: s2 = polytopes.simplex(2)
sage: s2.base_ring()
Integer Ring
sage: s = polytopes.simplex(2)
sage: s.base_ring()
Integer Ring
sage: s = s.change_ring(QQ)
sage: t = s.direct_sum(s)
sage: t.vertices()
(A vertex at (0, 0, 1, 0, 0, 0),
 A vertex at (0, 1, 0, 0, 0, 0),
 A vertex at (1, 0, 0, 0, 0, 0),
 A vertex at (1/3, 1/3, 1/3, -1/3, -1/3, 2/3),
 A vertex at (1/3, 1/3, 1/3, -1/3, 2/3, -1/3),
 A vertex at (1/3, 1/3, 1/3, 2/3, -1/3, -1/3))
```


Does this answer your question? As mentioned, direct sum (as well as intersection, minkowski difference and face truncation) are only defined for polytopes/polyhedra over a field.

In the same way, that `sage: 6/2` returns a rational, I think those operations should return a polytope with base ring constructed by first coercing and then taking the fraction field.



---

archive/issue_comments_399273.json:
```json
{
    "body": "As mentioned. I think this approach is actually more suitable and at some point, we should change `intersection` accordingly.\n----\nNew commits:",
    "created_at": "2019-09-20T09:29:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28269#issuecomment-399273",
    "user": "@kliem"
}
```

As mentioned. I think this approach is actually more suitable and at some point, we should change `intersection` accordingly.
----
New commits:



---

archive/issue_comments_399274.json:
```json
{
    "body": "Replying to [comment:6 gh-kliem]:\n> Replying to [comment:5 jipilab]:\n> > One comment:\n> > \n> > The tests should actually return something, so I would remove `t = ` and let the output get printed.\n> \n> Ok. Will do it.\n> > \n> > I am still a bit puzzled as to why it did not work for direct sum. What was going on there?\n> \n> {{{\n> sage: s2 = polytopes.simplex(2)\n> sage: s2.base_ring()\n> Integer Ring\n> sage: s = polytopes.simplex(2)\n> sage: s.base_ring()\n> Integer Ring\n> sage: s = s.change_ring(QQ)\n> sage: t = s.direct_sum(s)\n> sage: t.vertices()\n> (A vertex at (0, 0, 1, 0, 0, 0),\n>  A vertex at (0, 1, 0, 0, 0, 0),\n>  A vertex at (1, 0, 0, 0, 0, 0),\n>  A vertex at (1/3, 1/3, 1/3, -1/3, -1/3, 2/3),\n>  A vertex at (1/3, 1/3, 1/3, -1/3, 2/3, -1/3),\n>  A vertex at (1/3, 1/3, 1/3, 2/3, -1/3, -1/3))\n> }}}\n> \n> Does this answer your question? As mentioned, direct sum (as well as intersection, minkowski difference and face truncation) are only defined for polytopes/polyhedra over a field.\n\nYes, this examples clarifies it. It should probably go right among the first examples to illustrate the construction.\n\nI was extremely confused, but now it makes sense. The problem is when we translate one of them to have center be the origin... \n\n> \n> In the same way, that `sage: 6/2` returns a rational, I think those operations should return a polytope with base ring constructed by first coercing and then taking the fraction field.\n\nYes, sounds reasonable.",
    "created_at": "2019-09-20T14:07:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28269#issuecomment-399274",
    "user": "jipilab"
}
```

Replying to [comment:6 gh-kliem]:
> Replying to [comment:5 jipilab]:
> > One comment:
> > 
> > The tests should actually return something, so I would remove `t = ` and let the output get printed.
> 
> Ok. Will do it.
> > 
> > I am still a bit puzzled as to why it did not work for direct sum. What was going on there?
> 
> {{{
> sage: s2 = polytopes.simplex(2)
> sage: s2.base_ring()
> Integer Ring
> sage: s = polytopes.simplex(2)
> sage: s.base_ring()
> Integer Ring
> sage: s = s.change_ring(QQ)
> sage: t = s.direct_sum(s)
> sage: t.vertices()
> (A vertex at (0, 0, 1, 0, 0, 0),
>  A vertex at (0, 1, 0, 0, 0, 0),
>  A vertex at (1, 0, 0, 0, 0, 0),
>  A vertex at (1/3, 1/3, 1/3, -1/3, -1/3, 2/3),
>  A vertex at (1/3, 1/3, 1/3, -1/3, 2/3, -1/3),
>  A vertex at (1/3, 1/3, 1/3, 2/3, -1/3, -1/3))
> }}}
> 
> Does this answer your question? As mentioned, direct sum (as well as intersection, minkowski difference and face truncation) are only defined for polytopes/polyhedra over a field.

Yes, this examples clarifies it. It should probably go right among the first examples to illustrate the construction.

I was extremely confused, but now it makes sense. The problem is when we translate one of them to have center be the origin... 

> 
> In the same way, that `sage: 6/2` returns a rational, I think those operations should return a polytope with base ring constructed by first coercing and then taking the fraction field.

Yes, sounds reasonable.



---

archive/issue_comments_399275.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-09-20T19:16:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28269#issuecomment-399275",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_399276.json:
```json
{
    "body": "Replying to [comment:8 jipilab]:\n> Replying to [comment:6 gh-kliem]:\n> > Replying to [comment:5 jipilab]:\n> > > One comment:\n> > > \n> > > The tests should actually return something, so I would remove `t = ` and let the output get printed.\n> > \n> > Ok. Will do it.\n> > > \n> > > I am still a bit puzzled as to why it did not work for direct sum. What was going on there?\n> > \n> > {{{\n> > sage: s2 = polytopes.simplex(2)\n> > sage: s2.base_ring()\n> > Integer Ring\n> > sage: s = polytopes.simplex(2)\n> > sage: s.base_ring()\n> > Integer Ring\n> > sage: s = s.change_ring(QQ)\n> > sage: t = s.direct_sum(s)\n> > sage: t.vertices()\n> > (A vertex at (0, 0, 1, 0, 0, 0),\n> >  A vertex at (0, 1, 0, 0, 0, 0),\n> >  A vertex at (1, 0, 0, 0, 0, 0),\n> >  A vertex at (1/3, 1/3, 1/3, -1/3, -1/3, 2/3),\n> >  A vertex at (1/3, 1/3, 1/3, -1/3, 2/3, -1/3),\n> >  A vertex at (1/3, 1/3, 1/3, 2/3, -1/3, -1/3))\n> > }}}\n> > \n> > Does this answer your question? As mentioned, direct sum (as well as intersection, minkowski difference and face truncation) are only defined for polytopes/polyhedra over a field.\n> \n> Yes, this examples clarifies it. It should probably go right among the first examples to illustrate the construction.\n\nI could of course do it. But doesn't the existing example already illustrate this?\n\n> \n> I was extremely confused, but now it makes sense. The problem is when we translate one of them to have center be the origin... \n> \n> > \n> > In the same way, that `sage: 6/2` returns a rational, I think those operations should return a polytope with base ring constructed by first coercing and then taking the fraction field.\n> \n> Yes, sounds reasonable.",
    "created_at": "2019-09-20T19:17:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28269#issuecomment-399276",
    "user": "@kliem"
}
```

Replying to [comment:8 jipilab]:
> Replying to [comment:6 gh-kliem]:
> > Replying to [comment:5 jipilab]:
> > > One comment:
> > > 
> > > The tests should actually return something, so I would remove `t = ` and let the output get printed.
> > 
> > Ok. Will do it.
> > > 
> > > I am still a bit puzzled as to why it did not work for direct sum. What was going on there?
> > 
> > {{{
> > sage: s2 = polytopes.simplex(2)
> > sage: s2.base_ring()
> > Integer Ring
> > sage: s = polytopes.simplex(2)
> > sage: s.base_ring()
> > Integer Ring
> > sage: s = s.change_ring(QQ)
> > sage: t = s.direct_sum(s)
> > sage: t.vertices()
> > (A vertex at (0, 0, 1, 0, 0, 0),
> >  A vertex at (0, 1, 0, 0, 0, 0),
> >  A vertex at (1, 0, 0, 0, 0, 0),
> >  A vertex at (1/3, 1/3, 1/3, -1/3, -1/3, 2/3),
> >  A vertex at (1/3, 1/3, 1/3, -1/3, 2/3, -1/3),
> >  A vertex at (1/3, 1/3, 1/3, 2/3, -1/3, -1/3))
> > }}}
> > 
> > Does this answer your question? As mentioned, direct sum (as well as intersection, minkowski difference and face truncation) are only defined for polytopes/polyhedra over a field.
> 
> Yes, this examples clarifies it. It should probably go right among the first examples to illustrate the construction.

I could of course do it. But doesn't the existing example already illustrate this?

> 
> I was extremely confused, but now it makes sense. The problem is when we translate one of them to have center be the origin... 
> 
> > 
> > In the same way, that `sage: 6/2` returns a rational, I think those operations should return a polytope with base ring constructed by first coercing and then taking the fraction field.
> 
> Yes, sounds reasonable.



---

archive/issue_comments_399277.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-09-20T19:31:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28269#issuecomment-399277",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_399278.json:
```json
{
    "body": "Replying to [comment:10 gh-kliem]:\n> I could of course do it. But doesn't the existing example already illustrate this?\n> \n\nTrue.",
    "created_at": "2019-09-23T07:25:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28269#issuecomment-399278",
    "user": "jipilab"
}
```

Replying to [comment:10 gh-kliem]:
> I could of course do it. But doesn't the existing example already illustrate this?
> 

True.



---

archive/issue_comments_399279.json:
```json
{
    "body": "The \"some tests::\" might be superfluous. I would remove it.",
    "created_at": "2019-10-14T09:37:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28269#issuecomment-399279",
    "user": "jipilab"
}
```

The "some tests::" might be superfluous. I would remove it.



---

archive/issue_comments_399280.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-10-14T11:23:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28269#issuecomment-399280",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_399281.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-10-27T15:42:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28269#issuecomment-399281",
    "user": "jipilab"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_399282.json:
```json
{
    "body": "Some tests are failing in the thematic tutorial. See patchbots.",
    "created_at": "2019-10-27T15:42:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28269#issuecomment-399282",
    "user": "jipilab"
}
```

Some tests are failing in the thematic tutorial. See patchbots.



---

archive/issue_comments_399283.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-10-28T06:04:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28269#issuecomment-399283",
    "user": "@kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_399284.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-10-28T06:04:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28269#issuecomment-399284",
    "user": "@kliem"
}
```

New commits:



---

archive/issue_comments_399285.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-10-28T06:05:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28269#issuecomment-399285",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_399286.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-11-01T17:04:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28269#issuecomment-399286",
    "user": "jipilab"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_399287.json:
```json
{
    "body": "LGTM",
    "created_at": "2019-11-01T17:04:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28269#issuecomment-399287",
    "user": "jipilab"
}
```

LGTM



---

archive/issue_comments_399288.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-11-07T23:30:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28269#issuecomment-399288",
    "user": "vbraun"
}
```

Resolution: fixed
