# Issue 25080: Special-case pol*term, term*pol for generic polynomials

Issue created by migration from https://trac.sagemath.org/ticket/25317

Original creator: mmezzarobba

Original creation time: 2018-05-09 12:46:58

Before:

```
sage: Pol0.<t> = ZZ[]
....: Pol1.<x> = Pol0[]
....: p = ((t^2 - 3*t)*x^10 + (-3*t^2 - 1)*x^9 + (-t^2 - t + 1)*x^8 + (-t^2 - 1)*x^7 + (-4*t^2 + 14*t - 4)*x^6 + (2*t^2 + 2)*x^5 + (-t^2 + 2*t + 2)*x^4 + (3*t^2 - t + 3)*x^3 + (t^2 - t + 156)*x^2 + (7*t - 3)*x - t^2 + 2*t)
....: q = 2*x
....: %timeit p*q
The slowest run took 4.91 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 10.1 µs per loop
```

After:

```
The slowest run took 6.00 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 4.49 µs per loop
```



---

Comment by mmezzarobba created at 2018-05-09 12:47:12

Changing status from new to needs_review.


---

Comment by mmezzarobba created at 2018-05-09 12:47:26

Changing type from PLEASE CHANGE to enhancement.


---

Comment by tscrim created at 2018-05-10 10:42:10

Perhaps it would be better to have a specialized `cdef scale_and_shift` method that can be overwritten by the specific data structures in order to avoid creating an intermediate object? In fact, the generic `_lmul_` and `_rmul_` just lift the coefficient to the polynomial ring and multiply. I would also rewrite `_mul_` and `_rmul_` to use this `scale_and_shift` with a shift of 0 to avoid code duplication.


---

Comment by mmezzarobba created at 2018-05-10 18:01:21

Replying to [comment:3 tscrim]:
> Perhaps it would be better to have a specialized `cdef scale_and_shift` method that can be overwritten by the specific data structures in order to avoid creating an intermediate object? In fact, the generic `_lmul_` and `_rmul_` just lift the coefficient to the polynomial ring and multiply. I would also rewrite `_mul_` and `_rmul_` to use this `scale_and_shift` with a shift of 0 to avoid code duplication.

Yes, why not... I'm not sure it is worth the pain now—I'm not really trying to make this operation as fast as possible, just to avoid the worst of the overhead (especially in the Karatsuba range). So I'm not going to implement your suggestion now, but perhaps later, and in any case I can review the implementation if you want to do it yourself.

Thanks for you comments in any case!


---

Comment by tscrim created at 2018-05-10 22:22:09

Replying to [comment:4 mmezzarobba]:
> Replying to [comment:3 tscrim]:
> > Perhaps it would be better to have a specialized `cdef scale_and_shift` method that can be overwritten by the specific data structures in order to avoid creating an intermediate object? In fact, the generic `_lmul_` and `_rmul_` just lift the coefficient to the polynomial ring and multiply. I would also rewrite `_mul_` and `_rmul_` to use this `scale_and_shift` with a shift of 0 to avoid code duplication.
> 
> Yes, why not... I'm not sure it is worth the pain now—I'm not really trying to make this operation as fast as possible, just to avoid the worst of the overhead (especially in the Karatsuba range). So I'm not going to implement your suggestion now, but perhaps later, and in any case I can review the implementation if you want to do it yourself.

I will do it today then.


---

Comment by tscrim created at 2018-05-11 02:50:27

Running the same test as in the description.

8.3.beta0:

```
sage: %timeit p*q
The slowest run took 2129.02 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 8.02 µs per loop
```

Your branch:

```
sage: %timeit p*q
The slowest run took 9.36 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 2.78 µs per loop
```

My branch:

```
The slowest run took 8.63 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 2.21 µs per loop
```

So my changes get us an extra ~20%.
----
New commits:


---

Comment by mmezzarobba created at 2018-05-11 10:48:29

Changing status from needs_review to positive_review.


---

Comment by mmezzarobba created at 2018-05-11 10:48:29

Great, thanks!


---

Comment by vbraun created at 2018-05-15 22:33:23

Resolution: fixed
