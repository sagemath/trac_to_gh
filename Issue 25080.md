# Issue 25080: Special-case pol*term, term*pol for generic polynomials

archive/issues_025080.json:
```json
{
    "body": "Before:\n\n```\nsage: Pol0.<t> = ZZ[]\n....: Pol1.<x> = Pol0[]\n....: p = ((t^2 - 3*t)*x^10 + (-3*t^2 - 1)*x^9 + (-t^2 - t + 1)*x^8 + (-t^2 - 1)*x^7 + (-4*t^2 + 14*t - 4)*x^6 + (2*t^2 + 2)*x^5 + (-t^2 + 2*t + 2)*x^4 + (3*t^2 - t + 3)*x^3 + (t^2 - t + 156)*x^2 + (7*t - 3)*x - t^2 + 2*t)\n....: q = 2*x\n....: %timeit p*q\nThe slowest run took 4.91 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 10.1 \u00b5s per loop\n```\n\nAfter:\n\n```\nThe slowest run took 6.00 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 4.49 \u00b5s per loop\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/25317\n\n",
    "created_at": "2018-05-09T12:46:58Z",
    "labels": [
        "basic arithmetic",
        "major"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.3",
    "title": "Special-case pol*term, term*pol for generic polynomials",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25080",
    "user": "@mezzarobba"
}
```
Before:

```
sage: Pol0.<t> = ZZ[]
....: Pol1.<x> = Pol0[]
....: p = ((t^2 - 3*t)*x^10 + (-3*t^2 - 1)*x^9 + (-t^2 - t + 1)*x^8 + (-t^2 - 1)*x^7 + (-4*t^2 + 14*t - 4)*x^6 + (2*t^2 + 2)*x^5 + (-t^2 + 2*t + 2)*x^4 + (3*t^2 - t + 3)*x^3 + (t^2 - t + 156)*x^2 + (7*t - 3)*x - t^2 + 2*t)
....: q = 2*x
....: %timeit p*q
The slowest run took 4.91 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 10.1 µs per loop
```

After:

```
The slowest run took 6.00 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 4.49 µs per loop
```


Issue created by migration from https://trac.sagemath.org/ticket/25317





---

archive/issue_comments_352885.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-05-09T12:47:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25080#issuecomment-352885",
    "user": "@mezzarobba"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_352886.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2018-05-09T12:47:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25080#issuecomment-352886",
    "user": "@mezzarobba"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_352887.json:
```json
{
    "body": "Perhaps it would be better to have a specialized `cdef scale_and_shift` method that can be overwritten by the specific data structures in order to avoid creating an intermediate object? In fact, the generic `_lmul_` and `_rmul_` just lift the coefficient to the polynomial ring and multiply. I would also rewrite `_mul_` and `_rmul_` to use this `scale_and_shift` with a shift of 0 to avoid code duplication.",
    "created_at": "2018-05-10T10:42:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25080#issuecomment-352887",
    "user": "@tscrim"
}
```

Perhaps it would be better to have a specialized `cdef scale_and_shift` method that can be overwritten by the specific data structures in order to avoid creating an intermediate object? In fact, the generic `_lmul_` and `_rmul_` just lift the coefficient to the polynomial ring and multiply. I would also rewrite `_mul_` and `_rmul_` to use this `scale_and_shift` with a shift of 0 to avoid code duplication.



---

archive/issue_comments_352888.json:
```json
{
    "body": "Replying to [comment:3 tscrim]:\n> Perhaps it would be better to have a specialized `cdef scale_and_shift` method that can be overwritten by the specific data structures in order to avoid creating an intermediate object? In fact, the generic `_lmul_` and `_rmul_` just lift the coefficient to the polynomial ring and multiply. I would also rewrite `_mul_` and `_rmul_` to use this `scale_and_shift` with a shift of 0 to avoid code duplication.\n\nYes, why not... I'm not sure it is worth the pain now\u2014I'm not really trying to make this operation as fast as possible, just to avoid the worst of the overhead (especially in the Karatsuba range). So I'm not going to implement your suggestion now, but perhaps later, and in any case I can review the implementation if you want to do it yourself.\n\nThanks for you comments in any case!",
    "created_at": "2018-05-10T18:01:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25080#issuecomment-352888",
    "user": "@mezzarobba"
}
```

Replying to [comment:3 tscrim]:
> Perhaps it would be better to have a specialized `cdef scale_and_shift` method that can be overwritten by the specific data structures in order to avoid creating an intermediate object? In fact, the generic `_lmul_` and `_rmul_` just lift the coefficient to the polynomial ring and multiply. I would also rewrite `_mul_` and `_rmul_` to use this `scale_and_shift` with a shift of 0 to avoid code duplication.

Yes, why not... I'm not sure it is worth the pain now—I'm not really trying to make this operation as fast as possible, just to avoid the worst of the overhead (especially in the Karatsuba range). So I'm not going to implement your suggestion now, but perhaps later, and in any case I can review the implementation if you want to do it yourself.

Thanks for you comments in any case!



---

archive/issue_comments_352889.json:
```json
{
    "body": "Replying to [comment:4 mmezzarobba]:\n> Replying to [comment:3 tscrim]:\n> > Perhaps it would be better to have a specialized `cdef scale_and_shift` method that can be overwritten by the specific data structures in order to avoid creating an intermediate object? In fact, the generic `_lmul_` and `_rmul_` just lift the coefficient to the polynomial ring and multiply. I would also rewrite `_mul_` and `_rmul_` to use this `scale_and_shift` with a shift of 0 to avoid code duplication.\n> \n> Yes, why not... I'm not sure it is worth the pain now\u2014I'm not really trying to make this operation as fast as possible, just to avoid the worst of the overhead (especially in the Karatsuba range). So I'm not going to implement your suggestion now, but perhaps later, and in any case I can review the implementation if you want to do it yourself.\n\nI will do it today then.",
    "created_at": "2018-05-10T22:22:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25080#issuecomment-352889",
    "user": "@tscrim"
}
```

Replying to [comment:4 mmezzarobba]:
> Replying to [comment:3 tscrim]:
> > Perhaps it would be better to have a specialized `cdef scale_and_shift` method that can be overwritten by the specific data structures in order to avoid creating an intermediate object? In fact, the generic `_lmul_` and `_rmul_` just lift the coefficient to the polynomial ring and multiply. I would also rewrite `_mul_` and `_rmul_` to use this `scale_and_shift` with a shift of 0 to avoid code duplication.
> 
> Yes, why not... I'm not sure it is worth the pain now—I'm not really trying to make this operation as fast as possible, just to avoid the worst of the overhead (especially in the Karatsuba range). So I'm not going to implement your suggestion now, but perhaps later, and in any case I can review the implementation if you want to do it yourself.

I will do it today then.



---

archive/issue_comments_352890.json:
```json
{
    "body": "Running the same test as in the description.\n\n8.3.beta0:\n\n```\nsage: %timeit p*q\nThe slowest run took 2129.02 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 8.02 \u00b5s per loop\n```\n\nYour branch:\n\n```\nsage: %timeit p*q\nThe slowest run took 9.36 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 2.78 \u00b5s per loop\n```\n\nMy branch:\n\n```\nThe slowest run took 8.63 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 2.21 \u00b5s per loop\n```\n\nSo my changes get us an extra ~20%.\n----\nNew commits:",
    "created_at": "2018-05-11T02:50:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25080#issuecomment-352890",
    "user": "@tscrim"
}
```

Running the same test as in the description.

8.3.beta0:

```
sage: %timeit p*q
The slowest run took 2129.02 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 8.02 µs per loop
```

Your branch:

```
sage: %timeit p*q
The slowest run took 9.36 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 2.78 µs per loop
```

My branch:

```
The slowest run took 8.63 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 2.21 µs per loop
```

So my changes get us an extra ~20%.
----
New commits:



---

archive/issue_comments_352891.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-05-11T10:48:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25080#issuecomment-352891",
    "user": "@mezzarobba"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_352892.json:
```json
{
    "body": "Great, thanks!",
    "created_at": "2018-05-11T10:48:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25080#issuecomment-352892",
    "user": "@mezzarobba"
}
```

Great, thanks!



---

archive/issue_comments_352893.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-05-15T22:33:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25080#issuecomment-352893",
    "user": "@vbraun"
}
```

Resolution: fixed
