# Issue 13755: Parse wonky "top" output on OSX PPC

Issue created by migration from https://trac.sagemath.org/ticket/13959

Original creator: vbraun

Original creation time: 2013-01-15 18:14:15

Assignee: GeorgSWeber




---

Comment by kcrisman created at 2013-01-15 18:26:47

As requested on sage-devel:

```
Processes:  53 total, 2 running, 51 sleeping... 168 threads            13:24:56
Load Avg:  0.79, 0.32, 0.24     CPU usage:  3.6% user, 14.3% sys, 82.1% idle
SharedLibs: num =  153, resident = 19.8M code, 2.62M data, 9.33M LinkEdit
MemRegions: num =  5064, resident =  119M + 4.68M private, 44.2M shared
PhysMem:  64.7M wired, 87.3M active,  141M inactive,  293M used,  218M free
VM: 3.09G +  104M   5143978(0) pageins, 1381318(0) pageouts

  PID COMMAND      %CPU   TIME   #TH #PRTS #MREGS RPRVT  RSHRD  RSIZE  VSIZE
15199 top         10.6%  0:06.80   1    18    21   404K   488K   860K  27.0M 
15198 lookupd      0.0%  0:00.04   2    17    27   260K   636K   768K  27.5M
14946 mdimport     0.0%  0:00.99   3    60    56  1.04M  2.54M  3.70M  40.9M
14938 bash         0.0%  0:13.98   1    14    19   416K   920K  1004K  27.3M
14937 login        0.0%  0:00.03   1    16    37   124K   528K   548K  26.9M
14935 Terminal     1.0%  2:29.06   6   174   166  3.01M  7.32M  8.24M   117M
14933 mdimport     0.0%  0:04.98   4    61    54   856K  2.62M  2.86M  42.0M
  207 automount    0.0%  0:00.10   3    40    30   116K   936K   108K  28.7M
  202 automount    0.0%  0:00.23   3    42    34   172K   940K   176K  29.0M
  199 rpc.lockd    0.0%  0:00.00   1    10    18     4K   400K    12K  26.7M
```



---

Comment by kcrisman created at 2013-01-15 18:32:54

Weirdly, doing it "by hand",

```
In [5]: meminfo = subprocess.check_output(['top', '-1','1'],stderr=subprocess.STDOUT)
---------------------------------------------------------------------------
CalledProcessError                        Traceback (most recent call last)

/Users/student/Desktop/sage-5.6.beta2/devel/sage-main/<ipython console> in <module>()

/Users/student/Desktop/sage-5.6.beta2/local/lib/python/subprocess.pyc in check_output(*popenargs, **kwargs)
    542         if cmd is None:
    543             cmd = popenargs[0]
--> 544         raise CalledProcessError(retcode, cmd, output=output)
    545     return output
    546 

CalledProcessError: Command '['top', '-1', '1']' returned non-zero exit status 1

```

even though top works fine.


---

Comment by kcrisman created at 2013-01-15 18:36:33

I think that what's happening is that the `free_ram` is somehow getting the active and not the free line.  I'm not sure what is going on that that is happening, since it does pass the check for parsing `PhysMem`.


---

Comment by vbraun created at 2013-01-15 19:46:02

Its `['top', '-l', '1']` (top dash-ell one).


---

Comment by kcrisman created at 2013-01-15 19:53:33

Erk.  That's what happens when you just type instead of cut-and-paste - sorry, I have three computers within a foot of each other on the desk, and only one ethernet cable (and don't want to use wifi for BLODA reasons on the Cygwin...).

With `sage -ipython`:

```
In [9]: for line in meminfo.splitlines():
    if line.startswith('PhysMem'):
        line = line.split()
   ....:         break
   ....:         
   ....:         

In [12]: line
Out[12]: 
['PhysMem:',
 '65.2M',
 'wired,',
 '89.6M',
 'active,',
 '138M',
 'inactive,',
 '293M',
 'used,',
 '218M',
 'free']
```

Seems okay here, I'm not sure why it is doing this.


---

Comment by vbraun created at 2013-01-15 20:07:35

Fixed. The problem is when the free memory drops below 100M, then you'll get a decimal point.


---

Comment by vbraun created at 2013-01-15 20:07:52

Changing status from new to needs_review.


---

Comment by kcrisman created at 2013-01-15 20:22:11

Heehee.

```
sage -t  "devel/sage/sage/interfaces/gap.py"                
         [195.5 s]
sage -t  "devel/sage/sage/misc/memory_info.py"              
**********************************************************************
File "/Users/student/Desktop/sage-5.6.beta2/devel/sage/sage/misc/memory_info.py", line 310:
    sage: m._parse_top_output(osx_x86)
Expected:
    {'available_ram': 20401094656, 'total_ram': 34359738368}
Got:
    {'available_ram': 20401094656L, 'total_ram': 34359738368L}
**********************************************************************
1 items had failures:
   1 of   9 in __main__.example_12
```

Sorry.  Nice work otherwise!


---

Attachment

Updated patch


---

Comment by vbraun created at 2013-01-15 22:40:03

I've added the 32-bit branch for the doctest.


---

Comment by kcrisman created at 2013-01-16 01:52:09

I'll try to check this tomorrow but looks good.  Well, that computer only has 500 MB of RAM, if I'm not mistaken, so it was inevitable :-) but I wouldn't be surprised if some OLPC or something had that too...


---

Comment by kcrisman created at 2013-01-16 04:04:27

Also, I assume this will not conflict with the long-awaited #13588?  I would hate for that to happen!  Though I suppose this is a blocker since it's a failing doctest and Jeroen asked me to open this asap.


---

Comment by kcrisman created at 2013-01-16 04:04:27

Changing priority from major to blocker.


---

Comment by vbraun created at 2013-01-16 13:08:25

There are no conflicts.


---

Comment by kcrisman created at 2013-01-16 13:57:22

All tests passed!


---

Comment by kcrisman created at 2013-01-16 13:57:22

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-01-18 07:41:44

Resolution: fixed
