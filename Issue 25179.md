# Issue 25179: src/sage/plot/animate.py: UnicodeDecodeError in doctesting framework

archive/issues_025179.json:
```json
{
    "body": "With 8.3.beta2\n\n```\nsage -t --optional=sage,imagemagick src/sage/plot/animate.py \n```\n\ngives:\n\n```\nRunning doctests with ID 2018-05-21-13-12-48-d70ec4f6.\nGit branch: develop\nUsing --optional=imagemagick,sage\nDoctesting 1 file.\nsage -t --warn-long 82.7 src/sage/plot/animate.py\n    UnicodeDecodeError in doctesting framework\n**********************************************************************\nTests run before doctest exception:\nsage: sines = [plot(c*sin(x), (-2*pi,2*pi), color=Color(c,0,0), ymin=-1, ymax=1) for c in sxrange(0,1,.2)] ## line 32 ##\nsage: a = animate(sines) ## line 33 ##\nsage: a         # optional -- ImageMagick ## line 34 ##\nAnimation with 5 frames\nsage: a.show()  # optional -- ImageMagick ## line 36 ##\nsage: f = tmp_filename(ext='.gif') ## line 40 ##\n\n...\n\nsage: a = animate([sin(x + float(k)) for k in srange(0,2*pi,0.7)],\n            xmin=0, xmax=2*pi, ymin=-1, ymax=1, figsize=[2,1]) ## line 559 ##\nsage: td = tmp_dir() ## line 561 ##\nsage: a.gif(savefile=td + 'my_animation.gif', delay=35, iterations=3)  # optional -- ImageMagick ## line 563 ##\nsage: with open(td + 'my_animation.gif', 'rb') as f: print('\\x21\\xf9\\x04\\x08\\x23\\x00') in f.read()  # optional -- ImageMagick ## line 564 ##\n!\ufffd#\n\n**********************************************************************\nTraceback (most recent call last):\n  File \"/home/slabbe/GitBox/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 2337, in __call__\n    doctests, extras = self._run(runner, options, results)\n  File \"/home/slabbe/GitBox/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 2384, in _run\n    result = runner.run(test)\n  File \"/home/slabbe/GitBox/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 746, in run\n    return self._run(test, compileflags, out)\n  File \"/home/slabbe/GitBox/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 581, in _run\n    got = got.decode('utf-8')\n  File \"/home/slabbe/GitBox/sage/local/lib/python2.7/encodings/utf_8.py\", line 16, in decode\n    return codecs.utf_8_decode(input, errors, True)\nUnicodeDecodeError: 'utf8' codec can't decode byte 0xf9 in position 1: invalid start byte\n\n----------------------------------------------------------------------\nsage -t --warn-long 82.7 src/sage/plot/animate.py  # UnicodeDecodeError in doctesting framework\n----------------------------------------------------------------------\nTotal time for all tests: 59.2 seconds\n    cpu time: 0.0 seconds\n    cumulative wall time: 0.0 seconds\n```\n\nIssue created by migration from https://trac.sagemath.org/ticket/25416\n\n",
    "closed_at": "2018-06-22T22:58:41Z",
    "created_at": "2018-05-21T11:18:29Z",
    "labels": [
        "component: doctest framework",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.3",
    "title": "src/sage/plot/animate.py: UnicodeDecodeError in doctesting framework",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25179",
    "user": "https://github.com/seblabbe"
}
```
With 8.3.beta2

```
sage -t --optional=sage,imagemagick src/sage/plot/animate.py 
```

gives:

```
Running doctests with ID 2018-05-21-13-12-48-d70ec4f6.
Git branch: develop
Using --optional=imagemagick,sage
Doctesting 1 file.
sage -t --warn-long 82.7 src/sage/plot/animate.py
    UnicodeDecodeError in doctesting framework
**********************************************************************
Tests run before doctest exception:
sage: sines = [plot(c*sin(x), (-2*pi,2*pi), color=Color(c,0,0), ymin=-1, ymax=1) for c in sxrange(0,1,.2)] ## line 32 ##
sage: a = animate(sines) ## line 33 ##
sage: a         # optional -- ImageMagick ## line 34 ##
Animation with 5 frames
sage: a.show()  # optional -- ImageMagick ## line 36 ##
sage: f = tmp_filename(ext='.gif') ## line 40 ##

...

sage: a = animate([sin(x + float(k)) for k in srange(0,2*pi,0.7)],
            xmin=0, xmax=2*pi, ymin=-1, ymax=1, figsize=[2,1]) ## line 559 ##
sage: td = tmp_dir() ## line 561 ##
sage: a.gif(savefile=td + 'my_animation.gif', delay=35, iterations=3)  # optional -- ImageMagick ## line 563 ##
sage: with open(td + 'my_animation.gif', 'rb') as f: print('\x21\xf9\x04\x08\x23\x00') in f.read()  # optional -- ImageMagick ## line 564 ##
!ï¿½#

**********************************************************************
Traceback (most recent call last):
  File "/home/slabbe/GitBox/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 2337, in __call__
    doctests, extras = self._run(runner, options, results)
  File "/home/slabbe/GitBox/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 2384, in _run
    result = runner.run(test)
  File "/home/slabbe/GitBox/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 746, in run
    return self._run(test, compileflags, out)
  File "/home/slabbe/GitBox/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 581, in _run
    got = got.decode('utf-8')
  File "/home/slabbe/GitBox/sage/local/lib/python2.7/encodings/utf_8.py", line 16, in decode
    return codecs.utf_8_decode(input, errors, True)
UnicodeDecodeError: 'utf8' codec can't decode byte 0xf9 in position 1: invalid start byte

----------------------------------------------------------------------
sage -t --warn-long 82.7 src/sage/plot/animate.py  # UnicodeDecodeError in doctesting framework
----------------------------------------------------------------------
Total time for all tests: 59.2 seconds
    cpu time: 0.0 seconds
    cumulative wall time: 0.0 seconds
```

Issue created by migration from https://trac.sagemath.org/ticket/25416





---

archive/issue_comments_354191.json:
```json
{
    "body": "Changing component from graphics to doctest framework.",
    "created_at": "2018-05-21T11:34:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25179#issuecomment-354191",
    "user": "https://github.com/seblabbe"
}
```

Changing component from graphics to doctest framework.



---

archive/issue_comments_354192.json:
```json
{
    "body": "could you try when adding the first line\n\n```\n# -*- coding: utf-8 -*-\n```\nto this file ?",
    "created_at": "2018-06-20T05:47:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25179#issuecomment-354192",
    "user": "https://github.com/fchapoton"
}
```

could you try when adding the first line

```
# -*- coding: utf-8 -*-
```
to this file ?



---

archive/issue_comments_354193.json:
```json
{
    "body": "and replace the print by `print(u'\\x21\\xf9\\x04\\x08\\x23\\x00')`\n\nand try replacing the output by the result given by sage",
    "created_at": "2018-06-20T07:24:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25179#issuecomment-354193",
    "user": "https://github.com/fchapoton"
}
```

and replace the print by `print(u'\x21\xf9\x04\x08\x23\x00')`

and try replacing the output by the result given by sage



---

archive/issue_comments_354194.json:
```json
{
    "body": "It seems to work.\n\nFor reference, I get\n\n```\nsage: print('\\x21\\xf9\\x04\\x08\\x23\\x00')\n!#\nsage: '\\x21\\xf9\\x04\\x08\\x23\\x00'\n'!\\xf9\\x04\\x08#\\x00'\n```\nI will post a branch soon.",
    "created_at": "2018-06-20T13:22:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25179#issuecomment-354194",
    "user": "https://github.com/seblabbe"
}
```

It seems to work.

For reference, I get

```
sage: print('\x21\xf9\x04\x08\x23\x00')
!#
sage: '\x21\xf9\x04\x08\x23\x00'
'!\xf9\x04\x08#\x00'
```
I will post a branch soon.



---

archive/issue_comments_354195.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-06-20T18:52:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25179#issuecomment-354195",
    "user": "https://github.com/seblabbe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_354196.json:
```json
{
    "body": "Removing the `print` solves the issue.\n\nutf-8 line is unncessary. Still I added it to the `animate.py` file.\n\nI also remove one utf-8 line in a file where there was 2 of them.\n\nNeeds review.\n\n---\nNew commits:",
    "created_at": "2018-06-20T18:52:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25179#issuecomment-354196",
    "user": "https://github.com/seblabbe"
}
```

Removing the `print` solves the issue.

utf-8 line is unncessary. Still I added it to the `animate.py` file.

I also remove one utf-8 line in a file where there was 2 of them.

Needs review.

---
New commits:



---

archive/issue_comments_354197.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-06-20T18:59:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25179#issuecomment-354197",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_354198.json:
```json
{
    "body": "I updated my commit. I decided to keep the print and just fix the parenthesis placement instead. The problem was introduced in the following commit where the parenthesis were not added at the good place when moving print to Python 3 style. Now it should be fine.\n\n```\ncommit f4589a2ff7090a3b1a1e71b3e3f542ce09c20734\nDate:   Tue May 3 17:27:58 2016 +0200\n\n    python3 print in plot\n```\n\nNeeds review.",
    "created_at": "2018-06-20T19:04:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25179#issuecomment-354198",
    "user": "https://github.com/seblabbe"
}
```

I updated my commit. I decided to keep the print and just fix the parenthesis placement instead. The problem was introduced in the following commit where the parenthesis were not added at the good place when moving print to Python 3 style. Now it should be fine.

```
commit f4589a2ff7090a3b1a1e71b3e3f542ce09c20734
Date:   Tue May 3 17:27:58 2016 +0200

    python3 print in plot
```

Needs review.



---

archive/issue_comments_354199.json:
```json
{
    "body": "ok, looks good. If you know that it pass the optional tests, you can set to positive.",
    "created_at": "2018-06-20T19:07:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25179#issuecomment-354199",
    "user": "https://github.com/fchapoton"
}
```

ok, looks good. If you know that it pass the optional tests, you can set to positive.



---

archive/issue_comments_354200.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-06-20T20:01:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25179#issuecomment-354200",
    "user": "https://github.com/seblabbe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_354201.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-06-22T22:58:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25179",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25179#issuecomment-354201",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_063811.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-06-22T22:58:41Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/25179",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25179#event-63811"
}
```
