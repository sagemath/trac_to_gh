# Issue 21152: docbuild: Don't use multiprocessing when SAGE_NUM_THREADS=1

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2016-09-01 09:50:50

CC:  tscrim

This is a slight tweak to the docbuild code to avoid the overhead of using `multiprocessing.Pool` for a single-process doc build.

On Cygwin particularly the docbuild crashes when using multiprocessing.  This seems to be a Cygwin fork problem.  Nevertheless this simple change makes sense in general (even if single-process doc builds are not common on any other platform).


---

Comment by embray created at 2016-09-01 09:51:04

Changing keywords from "" to "docbuild".


---

Comment by embray created at 2016-09-01 09:51:04

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2016-09-14 09:59:00

This actually breaks a single-process build, it seems that the forking is really required:

```
[dochtml] [categorie] /usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/categories/finite_groups.py:docstring of sage.categories.finite_groups.FiniteGroups.ParentMethods.cardinality:4: WARNING: more than one target found for cross-reference u'order': sage.combinat.diagram_algebras.DiagramAlgebra.order, sage.categories.groups.Groups.CartesianProducts.ParentMethods.order, sage.algebras.quatalg.quaternion_algebra.QuaternionAlgebra_abstract.order, sage.algebras.steenrod.steenrod_algebra.SteenrodAlgebra_generic.order
[dochtml] [categorie] /usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/categories/finite_groups.py:docstring of sage.categories.finite_groups.FiniteGroups.ParentMethods.cardinality:4: WARNING: more than one target found for cross-reference u'order': sage.combinat.diagram_algebras.DiagramAlgebra.order, sage.categories.groups.Groups.CartesianProducts.ParentMethods.order, sage.algebras.quatalg.quaternion_algebra.QuaternionAlgebra_abstract.order, sage.algebras.steenrod.steenrod_algebra.SteenrodAlgebra_generic.order
[dochtml] [categorie] /usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/categories/groups.py:docstring of sage.categories.groups.Groups.ParentMethods.group_generators:3: WARNING: more than one target found for cross-reference u'gens': sage.algebras.shuffle_algebra.DualPBWBasis.gens, sage.algebras.group_algebra.GroupAlgebra.gens, sage.algebras.free_algebra.FreeAlgebra_generic.gens, sage.categories.pushout.PermutationGroupFunctor.gens, sage.rings.asymptotic.growth_group.ExponentialGrowthGroup.gens, sage.algebras.free_zinbiel_algebra.FreeZinbielAlgebra.gens, sage.rings.asymptotic.asymptotic_ring.AsymptoticRing.gens, sage.algebras.quatalg.quaternion_algebra.QuaternionOrder.gens, sage.algebras.jordan_algebra.SpecialJordanAlgebra.gens, sage.combinat.free_prelie_algebra.FreePreLieAlgebra.gens, sage.algebras.jordan_algebra.JordanAlgebraSymmetricBilinear.gens, sage.algebras.steenrod.steenrod_algebra.SteenrodAlgebra_generic.gens, sage.rings.asymptotic.growth_group.GenericGrowthGroup.gens, sage.algebras.yokonuma_hecke_algebra.YokonumaHeckeAlgebra.gens, sage.algebras.free_algebra.PBWBasisOfFreeAlgebra.gens, sage.algebras.quatalg.quaternion_algebra.QuaternionFractionalIdeal_rational.gens, sage.algebras.clifford_algebra.CliffordAlgebra.gens, sage.algebras.shuffle_algebra.ShuffleAlgebra.gens
```



---

Comment by jdemeyer created at 2016-09-14 09:59:00

Changing status from needs_review to needs_work.


---

Comment by embray created at 2016-09-22 14:56:05

It's not so much that this breaks a single-process build, as single process builds are broken for other reasons outside the scope of this ticket.  For example: #21044

I think maybe this is not a problem without forking if it results in each document being built in a separate process though.  Try this with #21044 and see if that fixes it.


---

Comment by embray created at 2016-09-22 14:56:05

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2016-10-18 14:53:50

The doc seems to build now. I haven't looked at the patch yet.


---

Comment by jdemeyer created at 2016-10-21 10:41:38

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2016-10-21 10:41:38

Shouldn't this be in the single-threaded builder also:

```
        try:
            ...
        except Exception:
            if ABORT_ON_ERROR:
                raise
```

I must admit that I don't know its full purpose, but it should be there for consistency.

Other than that, this looks good.


---

Comment by embray created at 2016-11-07 12:38:57

I was't sure what it was for either at first--but I believe you're right that there should be a similar try/except.


---

Comment by git created at 2016-11-07 12:44:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2016-11-07 12:44:37

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2016-11-11 20:30:51

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2016-11-11 20:30:51

I get

```
[dochtml] 
[dochtml] Building reference manual, first pass.
[dochtml] 
[dochtml] Error building the documentation.
[dochtml] Traceback (most recent call last):
[dochtml]   File "/usr/local/src/sage-config/local/lib/python/runpy.py", line 162, in _run_module_as_main
[dochtml]     "__main__", fname, loader, pkg_name)
[dochtml]   File "/usr/local/src/sage-config/local/lib/python/runpy.py", line 72, in _run_code
[dochtml]     exec code in run_globals
[dochtml]   File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage_setup/docbuild/__main__.py", line 2, in <module>
[dochtml]     main()
[dochtml]   File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 1638, in main
[dochtml]     builder()
[dochtml]   File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 315, in _wrapper
[dochtml]     getattr(get_builder(document), 'inventory')(*args, **kwds)
[dochtml]   File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 509, in _wrapper
[dochtml]     build_many(build_ref_doc, L)
[dochtml]   File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 265, in build_many
[dochtml]     results.append(target(*arg))
[dochtml] TypeError: build_ref_doc() takes exactly 1 argument (4 given)
```



---

Comment by embray created at 2016-11-14 12:31:07

Ah, of course.  There shouldn't be a `*` there.


---

Comment by git created at 2016-11-14 12:32:52

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2016-11-14 12:33:23

Changing status from needs_work to needs_review.


---

Comment by embray created at 2016-11-14 12:33:23

New commits:


---

Comment by jdemeyer created at 2016-11-18 12:30:17

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-11-19 22:09:46

Resolution: fixed
