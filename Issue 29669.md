# Issue 29669: Run tests for `an_affine_basis`

Issue created by migration from https://trac.sagemath.org/ticket/29906

Original creator: @kliem

Original creation time: 2020-06-19 22:03:00

CC:  jipilab @laisrast

Keywords: polyhedra, test suite

This ticket adds a method that tests `an_affine_basis` to `Polyhedron_base`.

We move some basic tests there.


---

Comment by git created at 2020-06-19 22:03:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-19 22:04:05

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @kliem created at 2020-06-19 22:05:21

Changing status from new to needs_review.


---

Comment by @kliem created at 2020-06-19 22:05:21

New commits:


---

Comment by tscrim created at 2020-06-21 23:53:31

Is there some way to improve this test:

```python
m = matrix(b).transpose().stack(matrix([[1]*len(b)]))
```

It feels somewhat inefficient as you make a matrix then take its transpose. Plus you get a new matrix with the `stack` call. Wouldn't it be better to just add 1 to each of the vectors `b` then ask for the `rank`?


---

Comment by @kliem created at 2020-06-22 09:43:34

It does feel inefficient, but I think it is rather efficient (besides that it really doesn't matter as obtaining `an_affine_matrix` takes much longer than anything else here):


```
sage: P = polytopes.permutahedron(7)

sage: 
sage: b = P.vertices()
sage: len(b)
5040
sage: P = polytopes.permutahedron(7)
sage: b = P.vertices()
sage: len(b)
5040
sage: def hom_matrix1(b):
....:     return matrix(b).transpose().stack(matrix([[1]*len(b)]))
....: 
sage: def hom_matrix2(b):
....:     return matrix([1] + list(x) for x in b)
....: 
sage: def hom_matrix3(b):
....:     return matrix(b).transpose().stack(vector([1]*len(b)))
....: 
....: 
sage: %timeit hom_matrix1(b)
10 loops, best of 5: 19.6 ms per loop
sage: %timeit hom_matrix2(b)
10 loops, best of 5: 23.4 ms per loop
sage: %timeit hom_matrix3(b)
10 loops, best of 5: 26 ms per loop

sage: b = P.an_affine_basis()
sage: len(b)
sage: %timeit hom_matrix1(b)
The slowest run took 98.27 times longer than the fastest. This could mean that an intermediate result is being cached.
10000 loops, best of 5: 46.1 µs per loop
sage: %timeit hom_matrix2(b)
The slowest run took 12.89 times longer than the fastest. This could mean that an intermediate result is being cached.
10000 loops, best of 5: 35.1 µs per loop
sage: %timeit hom_matrix3(b)
The slowest run took 4.52 times longer than the fastest. This could mean that an intermediate result is being cached.
10000 loops, best of 5: 103 µs per loop
```


So it is a bit faster for small instances (which should always be true for `b` being an affine basis of any `TestSuite` polyhedron, but really not by much. Besides it is a meaningless time difference if you consider obtaining `an_affine_basis` first, even with #29841.

If you know argue that `matrix([1] + list(x) for x in b)` is much easier to understand, I agree with you and that is a good point.


---

Comment by git created at 2020-06-22 10:30:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2020-06-22 10:34:30

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2020-06-22 10:34:30

Likely in the small cases you're seeing the benefit from everything being done in Cython rather than Python. I am not sure if I would say it is easier to understand. The transpose and stacking makes it more clear how things should be grouped, but it is not as clear that things are being realized as embedding in an affine space in a vector space. However, there are less moving parts, so I think that is a bonus with changing it. Plus it is better on the memory side if someone is working with a large polytope and wants to run this test.

Thank you for making the change.


---

Comment by vbraun created at 2020-07-08 19:33:50

Resolution: fixed
