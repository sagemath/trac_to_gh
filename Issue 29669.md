# Issue 29669: Run tests for `an_affine_basis`

archive/issues_029669.json:
```json
{
    "body": "CC:  jipilab @laisrast\n\nKeywords: polyhedra, test suite\n\nThis ticket adds a method that tests `an_affine_basis` to `Polyhedron_base`.\n\nWe move some basic tests there.\n\nIssue created by migration from https://trac.sagemath.org/ticket/29906\n\n",
    "created_at": "2020-06-19T22:03:00Z",
    "labels": [
        "geometry",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Run tests for `an_affine_basis`",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29669",
    "user": "@kliem"
}
```
CC:  jipilab @laisrast

Keywords: polyhedra, test suite

This ticket adds a method that tests `an_affine_basis` to `Polyhedron_base`.

We move some basic tests there.

Issue created by migration from https://trac.sagemath.org/ticket/29906





---

archive/issue_comments_421362.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-19T22:03:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29669#issuecomment-421362",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_421363.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-06-19T22:04:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29669#issuecomment-421363",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_421364.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-06-19T22:05:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29669#issuecomment-421364",
    "user": "@kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_421365.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-06-19T22:05:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29669#issuecomment-421365",
    "user": "@kliem"
}
```

New commits:



---

archive/issue_comments_421366.json:
```json
{
    "body": "Is there some way to improve this test:\n\n```python\nm = matrix(b).transpose().stack(matrix([[1]*len(b)]))\n```\n\nIt feels somewhat inefficient as you make a matrix then take its transpose. Plus you get a new matrix with the `stack` call. Wouldn't it be better to just add 1 to each of the vectors `b` then ask for the `rank`?",
    "created_at": "2020-06-21T23:53:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29669#issuecomment-421366",
    "user": "tscrim"
}
```

Is there some way to improve this test:

```python
m = matrix(b).transpose().stack(matrix([[1]*len(b)]))
```

It feels somewhat inefficient as you make a matrix then take its transpose. Plus you get a new matrix with the `stack` call. Wouldn't it be better to just add 1 to each of the vectors `b` then ask for the `rank`?



---

archive/issue_comments_421367.json:
```json
{
    "body": "It does feel inefficient, but I think it is rather efficient (besides that it really doesn't matter as obtaining `an_affine_matrix` takes much longer than anything else here):\n\n\n```\nsage: P = polytopes.permutahedron(7)\n\nsage: \nsage: b = P.vertices()\nsage: len(b)\n5040\nsage: P = polytopes.permutahedron(7)\nsage: b = P.vertices()\nsage: len(b)\n5040\nsage: def hom_matrix1(b):\n....:     return matrix(b).transpose().stack(matrix([[1]*len(b)]))\n....: \nsage: def hom_matrix2(b):\n....:     return matrix([1] + list(x) for x in b)\n....: \nsage: def hom_matrix3(b):\n....:     return matrix(b).transpose().stack(vector([1]*len(b)))\n....: \n....: \nsage: %timeit hom_matrix1(b)\n10 loops, best of 5: 19.6 ms per loop\nsage: %timeit hom_matrix2(b)\n10 loops, best of 5: 23.4 ms per loop\nsage: %timeit hom_matrix3(b)\n10 loops, best of 5: 26 ms per loop\n\nsage: b = P.an_affine_basis()\nsage: len(b)\nsage: %timeit hom_matrix1(b)\nThe slowest run took 98.27 times longer than the fastest. This could mean that an intermediate result is being cached.\n10000 loops, best of 5: 46.1 \u00b5s per loop\nsage: %timeit hom_matrix2(b)\nThe slowest run took 12.89 times longer than the fastest. This could mean that an intermediate result is being cached.\n10000 loops, best of 5: 35.1 \u00b5s per loop\nsage: %timeit hom_matrix3(b)\nThe slowest run took 4.52 times longer than the fastest. This could mean that an intermediate result is being cached.\n10000 loops, best of 5: 103 \u00b5s per loop\n```\n\n\nSo it is a bit faster for small instances (which should always be true for `b` being an affine basis of any `TestSuite` polyhedron, but really not by much. Besides it is a meaningless time difference if you consider obtaining `an_affine_basis` first, even with #29841.\n\nIf you know argue that `matrix([1] + list(x) for x in b)` is much easier to understand, I agree with you and that is a good point.",
    "created_at": "2020-06-22T09:43:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29669#issuecomment-421367",
    "user": "@kliem"
}
```

It does feel inefficient, but I think it is rather efficient (besides that it really doesn't matter as obtaining `an_affine_matrix` takes much longer than anything else here):


```
sage: P = polytopes.permutahedron(7)

sage: 
sage: b = P.vertices()
sage: len(b)
5040
sage: P = polytopes.permutahedron(7)
sage: b = P.vertices()
sage: len(b)
5040
sage: def hom_matrix1(b):
....:     return matrix(b).transpose().stack(matrix([[1]*len(b)]))
....: 
sage: def hom_matrix2(b):
....:     return matrix([1] + list(x) for x in b)
....: 
sage: def hom_matrix3(b):
....:     return matrix(b).transpose().stack(vector([1]*len(b)))
....: 
....: 
sage: %timeit hom_matrix1(b)
10 loops, best of 5: 19.6 ms per loop
sage: %timeit hom_matrix2(b)
10 loops, best of 5: 23.4 ms per loop
sage: %timeit hom_matrix3(b)
10 loops, best of 5: 26 ms per loop

sage: b = P.an_affine_basis()
sage: len(b)
sage: %timeit hom_matrix1(b)
The slowest run took 98.27 times longer than the fastest. This could mean that an intermediate result is being cached.
10000 loops, best of 5: 46.1 µs per loop
sage: %timeit hom_matrix2(b)
The slowest run took 12.89 times longer than the fastest. This could mean that an intermediate result is being cached.
10000 loops, best of 5: 35.1 µs per loop
sage: %timeit hom_matrix3(b)
The slowest run took 4.52 times longer than the fastest. This could mean that an intermediate result is being cached.
10000 loops, best of 5: 103 µs per loop
```


So it is a bit faster for small instances (which should always be true for `b` being an affine basis of any `TestSuite` polyhedron, but really not by much. Besides it is a meaningless time difference if you consider obtaining `an_affine_basis` first, even with #29841.

If you know argue that `matrix([1] + list(x) for x in b)` is much easier to understand, I agree with you and that is a good point.



---

archive/issue_comments_421368.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-22T10:30:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29669#issuecomment-421368",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_421369.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-06-22T10:34:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29669#issuecomment-421369",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_421370.json:
```json
{
    "body": "Likely in the small cases you're seeing the benefit from everything being done in Cython rather than Python. I am not sure if I would say it is easier to understand. The transpose and stacking makes it more clear how things should be grouped, but it is not as clear that things are being realized as embedding in an affine space in a vector space. However, there are less moving parts, so I think that is a bonus with changing it. Plus it is better on the memory side if someone is working with a large polytope and wants to run this test.\n\nThank you for making the change.",
    "created_at": "2020-06-22T10:34:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29669#issuecomment-421370",
    "user": "tscrim"
}
```

Likely in the small cases you're seeing the benefit from everything being done in Cython rather than Python. I am not sure if I would say it is easier to understand. The transpose and stacking makes it more clear how things should be grouped, but it is not as clear that things are being realized as embedding in an affine space in a vector space. However, there are less moving parts, so I think that is a bonus with changing it. Plus it is better on the memory side if someone is working with a large polytope and wants to run this test.

Thank you for making the change.



---

archive/issue_comments_421371.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-07-08T19:33:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29669#issuecomment-421371",
    "user": "vbraun"
}
```

Resolution: fixed
