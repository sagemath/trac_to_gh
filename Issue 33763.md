# Issue 33763: cleaning and enhancement to PolyDict

archive/issues_033763.json:
```json
{
    "body": "CC:  caruso mmezzarobba saraedum\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/34000\n\n",
    "created_at": "2022-06-16T09:04:15Z",
    "labels": [
        "algebra",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "cleaning and enhancement to PolyDict",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33763",
    "user": "vdelecroix"
}
```
CC:  caruso mmezzarobba saraedum



Issue created by migration from https://trac.sagemath.org/ticket/34000





---

archive/issue_comments_480058.json:
```json
{
    "body": "New commits:",
    "created_at": "2022-06-16T16:28:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33763#issuecomment-480058",
    "user": "vdelecroix"
}
```

New commits:



---

archive/issue_comments_480059.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-06-16T16:28:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33763#issuecomment-480059",
    "user": "vdelecroix"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_480060.json:
```json
{
    "body": "Two things that I did not understand while skimming through the code:\n* in `MPolynomial_polydict.integral()`, why do you have two different code paths for determining the result's parent?\n* what do the `RuntimeError`s now raised by `PolyDict` on various occasions correspond to?",
    "created_at": "2022-06-18T07:54:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33763#issuecomment-480060",
    "user": "mmezzarobba"
}
```

Two things that I did not understand while skimming through the code:
* in `MPolynomial_polydict.integral()`, why do you have two different code paths for determining the result's parent?
* what do the `RuntimeError`s now raised by `PolyDict` on various occasions correspond to?



---

archive/issue_comments_480061.json:
```json
{
    "body": "Replying to [comment:3 mmezzarobba]:\n> Two things that I did not understand while skimming through the code:\n\nThanks for having a look.\n\n> * in `MPolynomial_polydict.integral()`, why do you have two different code paths for determining the result's parent?\n\nI shamefully copied the code from univariate polynomials, see [polynomial_element.pyx#L3980-L3985](https://github.com/sagemath/sage/blob/develop/src/sage/rings/polynomial/polynomial_element.pyx#L3980-L3985)\n\n> * what do the `RuntimeError`s now raised by `PolyDict` on various occasions correspond to?\n\nOne of them is ensuring that keys are `ETuple`. All others are here because I also made uniform that no coefficient is zero. At least, it did not break any test.",
    "created_at": "2022-06-18T12:31:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33763#issuecomment-480061",
    "user": "vdelecroix"
}
```

Replying to [comment:3 mmezzarobba]:
> Two things that I did not understand while skimming through the code:

Thanks for having a look.

> * in `MPolynomial_polydict.integral()`, why do you have two different code paths for determining the result's parent?

I shamefully copied the code from univariate polynomials, see [polynomial_element.pyx#L3980-L3985](https://github.com/sagemath/sage/blob/develop/src/sage/rings/polynomial/polynomial_element.pyx#L3980-L3985)

> * what do the `RuntimeError`s now raised by `PolyDict` on various occasions correspond to?

One of them is ensuring that keys are `ETuple`. All others are here because I also made uniform that no coefficient is zero. At least, it did not break any test.



---

archive/issue_comments_480062.json:
```json
{
    "body": "Replying to [comment:4 vdelecroix]:\n> > * what do the `RuntimeError`s now raised by `PolyDict` on various occasions correspond to?\n> \n> One of them is ensuring that keys are `ETuple`. All others are here because I also made uniform that no coefficient is zero. At least, it did not break any test.\n\nSorry, my question was not clear. I was mostly wondering why you were raising `RuntimeError`s rather than `ValueError`s/`TypeError`s/... (if the purpose was argument checking) or using assertions (if you wanted to guard against things that should never happen).",
    "created_at": "2022-06-18T18:30:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33763#issuecomment-480062",
    "user": "mmezzarobba"
}
```

Replying to [comment:4 vdelecroix]:
> > * what do the `RuntimeError`s now raised by `PolyDict` on various occasions correspond to?
> 
> One of them is ensuring that keys are `ETuple`. All others are here because I also made uniform that no coefficient is zero. At least, it did not break any test.

Sorry, my question was not clear. I was mostly wondering why you were raising `RuntimeError`s rather than `ValueError`s/`TypeError`s/... (if the purpose was argument checking) or using assertions (if you wanted to guard against things that should never happen).



---

archive/issue_comments_480063.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-06-18T19:28:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33763#issuecomment-480063",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_480064.json:
```json
{
    "body": "Replying to [comment:5 mmezzarobba]:\n> Replying to [comment:4 vdelecroix]:\n> > > * what do the `RuntimeError`s now raised by `PolyDict` on various occasions correspond to?\n> > \n> > One of them is ensuring that keys are `ETuple`. All others are here because I also made uniform that no coefficient is zero. At least, it did not break any test.\n> \n> Sorry, my question was not clear. I was mostly wondering why you were raising `RuntimeError`s rather than `ValueError`s/`TypeError`s/... (if the purpose was argument checking) or using assertions (if you wanted to guard against things that should never happen).\n\nIt is really a `RuntimeError` : it is assumed that keys are `ETuple` and coefficients are nonzero.",
    "created_at": "2022-06-18T19:29:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33763#issuecomment-480064",
    "user": "vdelecroix"
}
```

Replying to [comment:5 mmezzarobba]:
> Replying to [comment:4 vdelecroix]:
> > > * what do the `RuntimeError`s now raised by `PolyDict` on various occasions correspond to?
> > 
> > One of them is ensuring that keys are `ETuple`. All others are here because I also made uniform that no coefficient is zero. At least, it did not break any test.
> 
> Sorry, my question was not clear. I was mostly wondering why you were raising `RuntimeError`s rather than `ValueError`s/`TypeError`s/... (if the purpose was argument checking) or using assertions (if you wanted to guard against things that should never happen).

It is really a `RuntimeError` : it is assumed that keys are `ETuple` and coefficients are nonzero.



---

archive/issue_comments_480065.json:
```json
{
    "body": "I hope I clarified the code related to your comments in \u200b6eac6b0 and 065d42e.",
    "created_at": "2022-06-18T19:30:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33763#issuecomment-480065",
    "user": "vdelecroix"
}
```

I hope I clarified the code related to your comments in â€‹6eac6b0 and 065d42e.



---

archive/issue_comments_480066.json:
```json
{
    "body": "Let me change `RuntimeError` for assertions.",
    "created_at": "2022-06-18T19:39:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33763#issuecomment-480066",
    "user": "vdelecroix"
}
```

Let me change `RuntimeError` for assertions.



---

archive/issue_comments_480067.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-06-18T19:44:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33763#issuecomment-480067",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_480068.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-06-19T08:53:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33763#issuecomment-480068",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_480069.json:
```json
{
    "body": "In the last commit I fixed a bug in `eadd_p` and optimized `homogenize` in order to fix a bug that show up in doctests from `sage.schemes.elliptic_curve.constructor`.\n----\nNew commits:",
    "created_at": "2022-06-19T08:55:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33763#issuecomment-480069",
    "user": "vdelecroix"
}
```

In the last commit I fixed a bug in `eadd_p` and optimized `homogenize` in order to fix a bug that show up in doctests from `sage.schemes.elliptic_curve.constructor`.
----
New commits:



---

archive/issue_comments_480070.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-06-19T09:50:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33763#issuecomment-480070",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_480071.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-06-19T12:32:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33763#issuecomment-480071",
    "user": "vdelecroix"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_480072.json:
```json
{
    "body": "\n```\nsage -t --long src/sage/rings/tate_algebra_element.pyx  # 5 doctests failed\nsage -t --long src/sage/rings/tate_algebra_ideal.pyx  # 3 doctests failed\nsage -t --long src/sage/rings/polynomial/multi_polynomial.pyx  # 1 doctest failed\n```\n",
    "created_at": "2022-06-19T12:32:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33763#issuecomment-480072",
    "user": "vdelecroix"
}
```


```
sage -t --long src/sage/rings/tate_algebra_element.pyx  # 5 doctests failed
sage -t --long src/sage/rings/tate_algebra_ideal.pyx  # 3 doctests failed
sage -t --long src/sage/rings/polynomial/multi_polynomial.pyx  # 1 doctest failed
```




---

archive/issue_comments_480073.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-06-19T13:31:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33763#issuecomment-480073",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_480074.json:
```json
{
    "body": "`@`Xavier Caruso: now that I made systematic zero coefficient removal in `polydict.pyx` I have trouble with Tate algebras. Namely, it seems that you always want to keep zeros there even though there is no natural way we can make difference between exact and inexact zero in the base ring\n\n```\nsage: R = Zp(2, print_mode='digits', prec=10)\nsage: R(0, 5).is_zero()\nTrue\nsage: R(0, 5) == R(0)\nTrue\nsage: not (R(0, 5) != R(0))\nTrue\n```\n\nThis affects code such as\n\n```\nsage: R = Zp(2, print_mode='digits', prec=10)\nsage: A.<x,y> = TateAlgebra(R)\nsage: f = 1 + 64*x\nsage: f -= R(1, 5)\nsage: f\n...00000 + ...0000000001000000*x\n```\n\nwhich now returns `...0000000001000000*x`.\n\nOn the other hand, I believe that the code in Tate algebra is buggy for the following reason. The conversion `R -> A` does not commute with binary operations\n\n```\nsage: R = Zp(2, print_mode='digits', prec=10)\nsage: A.<x,y> = TateAlgebra(R)\nsage: A(R(1)) - A(R(1,5))\n...00000\nsage: A(R(1) - R(1,5))\n0\n```\n\nThe following is also broken\n\n```\nsage: A({(1,1): R(0,5)})\n0\n```\n\n(it should have been `R(0,5)*x*y` which prints as `...00000*x*y`)\n\nThe main question is : how do we test whether an element is exactly zero in `R` ? `r.precision_absolute() == infinity and r.is_zero()`? I could introduce an attribute `zero_test` in `PolyDict` to make this check consistently.",
    "created_at": "2022-06-19T13:44:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33763#issuecomment-480074",
    "user": "vdelecroix"
}
```

`@`Xavier Caruso: now that I made systematic zero coefficient removal in `polydict.pyx` I have trouble with Tate algebras. Namely, it seems that you always want to keep zeros there even though there is no natural way we can make difference between exact and inexact zero in the base ring

```
sage: R = Zp(2, print_mode='digits', prec=10)
sage: R(0, 5).is_zero()
True
sage: R(0, 5) == R(0)
True
sage: not (R(0, 5) != R(0))
True
```

This affects code such as

```
sage: R = Zp(2, print_mode='digits', prec=10)
sage: A.<x,y> = TateAlgebra(R)
sage: f = 1 + 64*x
sage: f -= R(1, 5)
sage: f
...00000 + ...0000000001000000*x
```

which now returns `...0000000001000000*x`.

On the other hand, I believe that the code in Tate algebra is buggy for the following reason. The conversion `R -> A` does not commute with binary operations

```
sage: R = Zp(2, print_mode='digits', prec=10)
sage: A.<x,y> = TateAlgebra(R)
sage: A(R(1)) - A(R(1,5))
...00000
sage: A(R(1) - R(1,5))
0
```

The following is also broken

```
sage: A({(1,1): R(0,5)})
0
```

(it should have been `R(0,5)*x*y` which prints as `...00000*x*y`)

The main question is : how do we test whether an element is exactly zero in `R` ? `r.precision_absolute() == infinity and r.is_zero()`? I could introduce an attribute `zero_test` in `PolyDict` to make this check consistently.



---

archive/issue_comments_480075.json:
```json
{
    "body": "For the same reason as in [This is the Trac macro *comment:16* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#comment:16-macro) multivariate polynomials over p-adics are similarly broken in the current sage\n\n```\nsage: R = Zp(2)\nsage: Rxy.<x,y> = R[]\nsage: Rxy(R(0,5))\n0\nsage: x - x\n0\n```\n",
    "created_at": "2022-06-19T18:07:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33763#issuecomment-480075",
    "user": "vdelecroix"
}
```

For the same reason as in [This is the Trac macro *comment:16* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#comment:16-macro) multivariate polynomials over p-adics are similarly broken in the current sage

```
sage: R = Zp(2)
sage: Rxy.<x,y> = R[]
sage: Rxy(R(0,5))
0
sage: x - x
0
```




---

archive/issue_comments_480076.json:
```json
{
    "body": "Replying to [comment:17 vdelecroix]:\n> For the same reason as in [This is the Trac macro *comment:16* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#comment:16-macro) multivariate polynomials over p-adics are similarly broken in the current sage\n> {{{\n> sage: R = Zp(2)\n> sage: Rxy.<x,y> = R[]\n> sage: Rxy(R(0,5))\n> 0\n> sage: x - x\n> 0\n> }}}\n\nhmm as well as multivariate polynomial rings over power series\n\n```\nsage: R.<x> = PowerSeriesRing(QQ)\nsage: A.<y,z> = R[]\nsage: O(x^3) * y\n0\n```\n",
    "created_at": "2022-06-19T18:16:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33763#issuecomment-480076",
    "user": "vdelecroix"
}
```

Replying to [comment:17 vdelecroix]:
> For the same reason as in [This is the Trac macro *comment:16* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#comment:16-macro) multivariate polynomials over p-adics are similarly broken in the current sage
> {{{
> sage: R = Zp(2)
> sage: Rxy.<x,y> = R[]
> sage: Rxy(R(0,5))
> 0
> sage: x - x
> 0
> }}}

hmm as well as multivariate polynomial rings over power series

```
sage: R.<x> = PowerSeriesRing(QQ)
sage: A.<y,z> = R[]
sage: O(x^3) * y
0
```




---

archive/issue_comments_480077.json:
```json
{
    "body": "Replying to [comment:16 vdelecroix]:\n> The main question is : how do we test whether an element is exactly zero in `R` ? `r.precision_absolute() == infinity and r.is_zero()`? I could introduce an attribute `zero_test` in `PolyDict` to make this check consistently.\n\nI think you can use the method `_is_exact_zero` for padics.\n\nI'll have a look at the bug in coercion from base ring to Tate algebra you noticed.",
    "created_at": "2022-06-19T18:31:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33763#issuecomment-480077",
    "user": "caruso"
}
```

Replying to [comment:16 vdelecroix]:
> The main question is : how do we test whether an element is exactly zero in `R` ? `r.precision_absolute() == infinity and r.is_zero()`? I could introduce an attribute `zero_test` in `PolyDict` to make this check consistently.

I think you can use the method `_is_exact_zero` for padics.

I'll have a look at the bug in coercion from base ring to Tate algebra you noticed.



---

archive/issue_comments_480078.json:
```json
{
    "body": "Replying to [comment:19 caruso]:\n> Replying to [comment:16 vdelecroix]:\n> > The main question is : how do we test whether an element is exactly zero in `R` ? `r.precision_absolute() == infinity and r.is_zero()`? I could introduce an attribute `zero_test` in `PolyDict` to make this check consistently.\n> \n> I think you can use the method `_is_exact_zero` for padics.\n\nThanks. Though very specific to p-adics. And it does not exist for power series.\n\n> I'll have a look at the bug in coercion from base ring to Tate algebra you noticed.\n\nIt is not a bug in the coercion system. It is the way elements of the Tate algebra are constructed. The `PolyDict` class does a cleaning of zero coefficients in its input.",
    "created_at": "2022-06-19T18:38:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33763#issuecomment-480078",
    "user": "vdelecroix"
}
```

Replying to [comment:19 caruso]:
> Replying to [comment:16 vdelecroix]:
> > The main question is : how do we test whether an element is exactly zero in `R` ? `r.precision_absolute() == infinity and r.is_zero()`? I could introduce an attribute `zero_test` in `PolyDict` to make this check consistently.
> 
> I think you can use the method `_is_exact_zero` for padics.

Thanks. Though very specific to p-adics. And it does not exist for power series.

> I'll have a look at the bug in coercion from base ring to Tate algebra you noticed.

It is not a bug in the coercion system. It is the way elements of the Tate algebra are constructed. The `PolyDict` class does a cleaning of zero coefficients in its input.



---

archive/issue_comments_480079.json:
```json
{
    "body": "As far as this ticket is concerned there is an easy way out : leave simplification of zero coefficients in `PolyDict` to the user (via the `PolyDict.remove_zeros` method). This will solve the construction issues with Tate algebra.\n\nI opened ticket #34024 to fix polynomials.",
    "created_at": "2022-06-19T18:44:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33763#issuecomment-480079",
    "user": "vdelecroix"
}
```

As far as this ticket is concerned there is an easy way out : leave simplification of zero coefficients in `PolyDict` to the user (via the `PolyDict.remove_zeros` method). This will solve the construction issues with Tate algebra.

I opened ticket #34024 to fix polynomials.



---

archive/issue_comments_480080.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-06-19T19:32:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33763#issuecomment-480080",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_480081.json:
```json
{
    "body": "`@`Xavier Caruso Even with [This is the Trac macro *comment:21* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#comment:21-macro) implemented I got the following failure\n\n```\nsage -t --random-seed=31078045756822634162710736872151007113 tate_algebra_ideal.pyx\n**********************************************************************\nFile \"tate_algebra_ideal.pyx\", line 857, in sage.rings.tate_algebra_ideal.groebner_basis_pote\nFailed example:\n    I.groebner_basis(algorithm=\"PoTe\", prec=100)  # indirect doctest\nExpected:\n    [...0000000001*x^3 + ...2222222222*y + ...000000000*x^2*y^2 + O(3^99 * <x, y>),\n     ...0000000001*x^2*y + ...01210121020 + O(3^100 * <x, y>),\n     ...0000000001*y^2 + ...01210121020*x + ...000000000*x^2*y^3 + ...0000000000*x^3*y + O(3^99 * <x, y>)]\nGot:\n    [...0000000001*x^3 + ...2222222222*y + ...000000000*x^2*y^2 + O(3^99 * <x, y>),\n     ...0000000001*x^2*y + ...01210121020 + O(3^100 * <x, y>),\n     ...0000000001*y^2 + ...01210121020*x + ...0000000000*x^3*y + O(3^99 * <x, y>)]\n**********************************************************************\nFile \"tate_algebra_ideal.pyx\", line 1104, in sage.rings.tate_algebra_ideal.groebner_basis_vapote\nFailed example:\n    I.groebner_basis(algorithm=\"VaPoTe\", prec=100)  # indirect doctest\nExpected:\n    [...0000000001*x^3 + ...2222222222*y + ...000000000*x^2*y^2 + O(3^99 * <x, y>),\n     ...0000000001*x^2*y + ...01210121020 + O(3^100 * <x, y>),\n     ...0000000001*y^2 + ...01210121020*x + ...000000000*x^2*y^3 + ...0000000000*x^3*y + O(3^99 * <x, y>)]\nGot:\n    [...0000000001*x^3 + ...2222222222*y + ...000000000*x^2*y^2 + O(3^99 * <x, y>),\n     ...0000000001*x^2*y + ...01210121020 + O(3^100 * <x, y>),\n     ...0000000001*y^2 + ...01210121020*x + ...0000000000*x^3*y + O(3^99 * <x, y>)]\n**********************************************************************\n2 items had failures:\n   1 of   9 in sage.rings.tate_algebra_ideal.groebner_basis_pote\n   1 of  10 in sage.rings.tate_algebra_ideal.groebner_basis_vapote\n    [126 tests, 2 failures, 3.46 s]\n```\n\n\nAlso, it did not magically fix [This is the Trac macro *comment:16* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#comment:16-macro) since Tate algebras use multivariate polynomials over p-adic rings...",
    "created_at": "2022-06-19T19:34:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33763#issuecomment-480081",
    "user": "vdelecroix"
}
```

`@`Xavier Caruso Even with [This is the Trac macro *comment:21* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#comment:21-macro) implemented I got the following failure

```
sage -t --random-seed=31078045756822634162710736872151007113 tate_algebra_ideal.pyx
**********************************************************************
File "tate_algebra_ideal.pyx", line 857, in sage.rings.tate_algebra_ideal.groebner_basis_pote
Failed example:
    I.groebner_basis(algorithm="PoTe", prec=100)  # indirect doctest
Expected:
    [...0000000001*x^3 + ...2222222222*y + ...000000000*x^2*y^2 + O(3^99 * <x, y>),
     ...0000000001*x^2*y + ...01210121020 + O(3^100 * <x, y>),
     ...0000000001*y^2 + ...01210121020*x + ...000000000*x^2*y^3 + ...0000000000*x^3*y + O(3^99 * <x, y>)]
Got:
    [...0000000001*x^3 + ...2222222222*y + ...000000000*x^2*y^2 + O(3^99 * <x, y>),
     ...0000000001*x^2*y + ...01210121020 + O(3^100 * <x, y>),
     ...0000000001*y^2 + ...01210121020*x + ...0000000000*x^3*y + O(3^99 * <x, y>)]
**********************************************************************
File "tate_algebra_ideal.pyx", line 1104, in sage.rings.tate_algebra_ideal.groebner_basis_vapote
Failed example:
    I.groebner_basis(algorithm="VaPoTe", prec=100)  # indirect doctest
Expected:
    [...0000000001*x^3 + ...2222222222*y + ...000000000*x^2*y^2 + O(3^99 * <x, y>),
     ...0000000001*x^2*y + ...01210121020 + O(3^100 * <x, y>),
     ...0000000001*y^2 + ...01210121020*x + ...000000000*x^2*y^3 + ...0000000000*x^3*y + O(3^99 * <x, y>)]
Got:
    [...0000000001*x^3 + ...2222222222*y + ...000000000*x^2*y^2 + O(3^99 * <x, y>),
     ...0000000001*x^2*y + ...01210121020 + O(3^100 * <x, y>),
     ...0000000001*y^2 + ...01210121020*x + ...0000000000*x^3*y + O(3^99 * <x, y>)]
**********************************************************************
2 items had failures:
   1 of   9 in sage.rings.tate_algebra_ideal.groebner_basis_pote
   1 of  10 in sage.rings.tate_algebra_ideal.groebner_basis_vapote
    [126 tests, 2 failures, 3.46 s]
```


Also, it did not magically fix [This is the Trac macro *comment:16* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#comment:16-macro) since Tate algebras use multivariate polynomials over p-adic rings...



---

archive/issue_comments_480082.json:
```json
{
    "body": "Replying to [comment:23 vdelecroix]:\n> `@`Xavier Caruso Even with [This is the Trac macro *comment:21* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#comment:21-macro) implemented I got the following failure\n\nHmm. Difficult to say what is the correct answer.\nI'll try to investigate this more but maybe, the easiest fix is to change the doctest.",
    "created_at": "2022-06-20T08:08:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33763#issuecomment-480082",
    "user": "caruso"
}
```

Replying to [comment:23 vdelecroix]:
> `@`Xavier Caruso Even with [This is the Trac macro *comment:21* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#comment:21-macro) implemented I got the following failure

Hmm. Difficult to say what is the correct answer.
I'll try to investigate this more but maybe, the easiest fix is to change the doctest.



---

archive/issue_comments_480083.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2022-08-12T16:01:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33763#issuecomment-480083",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_480084.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-08-12T16:02:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33763#issuecomment-480084",
    "user": "vdelecroix"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_480085.json:
```json
{
    "body": "rebased on 9.7.beta8 and failing doctests modified",
    "created_at": "2022-08-12T16:02:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33763#issuecomment-480085",
    "user": "vdelecroix"
}
```

rebased on 9.7.beta8 and failing doctests modified



---

archive/issue_comments_480086.json:
```json
{
    "body": "green bot",
    "created_at": "2022-08-13T06:41:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33763#issuecomment-480086",
    "user": "vdelecroix"
}
```

green bot



---

archive/issue_comments_480087.json:
```json
{
    "body": "I think some timings are needed here before a positive review to see what sort of speed regressions we incur because we no longer have the option to turn off certain features and checks.\n\nWhy is addition the only operation that gets a special in-place operation? I think it would be good to make this universal.\n\nIt is generally not a good ideal to check `if type(e) is not ETuple:`. I understand this is faster than `isinstance(e, ETuple)`, but it is less future-proof if someone subclasses `ETuple`.\n\nNaively coverage seems to have decreased; e.g., `__len__` no longer has documentation. It is a bit of a misdirect that the coverage has increased as it is just total percentage.",
    "created_at": "2022-08-16T06:16:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33763#issuecomment-480087",
    "user": "tscrim"
}
```

I think some timings are needed here before a positive review to see what sort of speed regressions we incur because we no longer have the option to turn off certain features and checks.

Why is addition the only operation that gets a special in-place operation? I think it would be good to make this universal.

It is generally not a good ideal to check `if type(e) is not ETuple:`. I understand this is faster than `isinstance(e, ETuple)`, but it is less future-proof if someone subclasses `ETuple`.

Naively coverage seems to have decreased; e.g., `__len__` no longer has documentation. It is a bit of a misdirect that the coverage has increased as it is just total percentage.
