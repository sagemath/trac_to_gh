# Issue 26975: spkg-configure.m4 for gmp

archive/issues_026975.json:
```json
{
    "body": "CC:  @embray\n\nThis should be easy, and it's a potential source of library conflicts, as gmp is often installed...\n\nnote that GMP is pulled in via `./configure --with-mp=gmp`\n(as well as by specifying SAGE_MP_LIBRARY?)\n\nIssue created by migration from https://trac.sagemath.org/ticket/27212\n\n",
    "created_at": "2019-02-04T04:37:00Z",
    "labels": [
        "component: packages: optional"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "spkg-configure.m4 for gmp",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26975",
    "user": "https://github.com/dimpase"
}
```
CC:  @embray

This should be easy, and it's a potential source of library conflicts, as gmp is often installed...

note that GMP is pulled in via `./configure --with-mp=gmp`
(as well as by specifying SAGE_MP_LIBRARY?)

Issue created by migration from https://trac.sagemath.org/ticket/27212





---

archive/issue_comments_379145.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-02-04T17:46:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379145",
    "user": "https://github.com/dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_379146.json:
```json
{
    "body": "here we check that GMP is new enough, by verifying it has a new function.\nThe rest is just copypaste.\n\nTo actually build with GMP, one needs\n\n```\n./configure --with-mp=gmp\n```\n\n(configure does the test regardless)\n----\nNew commits:",
    "created_at": "2019-02-04T17:46:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379146",
    "user": "https://github.com/dimpase"
}
```

here we check that GMP is new enough, by verifying it has a new function.
The rest is just copypaste.

To actually build with GMP, one needs

```
./configure --with-mp=gmp
```

(configure does the test regardless)
----
New commits:



---

archive/issue_comments_379147.json:
```json
{
    "body": "I suppose due to a special treatment of GMP/MPIR, despite configure reporting GMP as not being installed, it still gets picked up for installation from source.\n(I tested this on a clean build...)",
    "created_at": "2019-02-05T11:15:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379147",
    "user": "https://github.com/dimpase"
}
```

I suppose due to a special treatment of GMP/MPIR, despite configure reporting GMP as not being installed, it still gets picked up for installation from source.
(I tested this on a clean build...)



---

archive/issue_comments_379148.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-02-05T11:15:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379148",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_379149.json:
```json
{
    "body": "Yes, I've already put some thought into how to handle this case, though I don't have a solid answer.  The `spkg-configure.m4` seems fine, but we can't just leave it at that.\n\nThe tricky thing is that with MPIR it can be compiled with or without gmp-compatibility mode.  On Sage we use `--with-gmpcompat` so if we link to a gmp we're actually getting the one installed by MPIR.  But some systems might have MPIR built without gmp-compatiblity, and yet no separate libgmp.so.  So in that case we'd actually want to use libmpir (if such a system exists I'm not sure).\n\nSo if we run `./configure` with no `--with-mp=` flag the question is what to do?  Do we just try to detect any \"libgmp\" and use that if found?  Do look for a libmpir, ever?  If the user passes `--with-mp=mpir` or `--with-mp=gmp` should that imply that it should just build the Sage SPKG, or do we explicitly go searching for, say, a libmpir in the former case?",
    "created_at": "2019-02-06T16:49:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379149",
    "user": "https://github.com/embray"
}
```

Yes, I've already put some thought into how to handle this case, though I don't have a solid answer.  The `spkg-configure.m4` seems fine, but we can't just leave it at that.

The tricky thing is that with MPIR it can be compiled with or without gmp-compatibility mode.  On Sage we use `--with-gmpcompat` so if we link to a gmp we're actually getting the one installed by MPIR.  But some systems might have MPIR built without gmp-compatiblity, and yet no separate libgmp.so.  So in that case we'd actually want to use libmpir (if such a system exists I'm not sure).

So if we run `./configure` with no `--with-mp=` flag the question is what to do?  Do we just try to detect any "libgmp" and use that if found?  Do look for a libmpir, ever?  If the user passes `--with-mp=mpir` or `--with-mp=gmp` should that imply that it should just build the Sage SPKG, or do we explicitly go searching for, say, a libmpir in the former case?



---

archive/issue_comments_379150.json:
```json
{
    "body": "Deciding which BLAS to use from the system raises similar questions.",
    "created_at": "2019-02-06T16:51:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379150",
    "user": "https://github.com/embray"
}
```

Deciding which BLAS to use from the system raises similar questions.



---

archive/issue_comments_379151.json:
```json
{
    "body": "The more I think about it, the more I'm inclined toward `--with-mp=mpir` should mean that the MP library *must* by MPIR by explicit request of the user, and if not found on the system then we should build the SPKG.\n\nIf `--with-mp=` is not otherwise specified then we can take whatever MP lib was found on the system.\n\nWe should also add an `spkg-configure.m4` for MPIR.  We can impose an ordering (e.g. first check for MPIR, and then for plain GMP) by putting `AC_REQURE(SAGE_SPKG_CONFIGURE_MPIR)` at the beginning of the `spkg-configure.m4` for gmp.  I did something similar for gfortran/gcc and seems to work.",
    "created_at": "2019-02-06T16:56:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379151",
    "user": "https://github.com/embray"
}
```

The more I think about it, the more I'm inclined toward `--with-mp=mpir` should mean that the MP library *must* by MPIR by explicit request of the user, and if not found on the system then we should build the SPKG.

If `--with-mp=` is not otherwise specified then we can take whatever MP lib was found on the system.

We should also add an `spkg-configure.m4` for MPIR.  We can impose an ordering (e.g. first check for MPIR, and then for plain GMP) by putting `AC_REQURE(SAGE_SPKG_CONFIGURE_MPIR)` at the beginning of the `spkg-configure.m4` for gmp.  I did something similar for gfortran/gcc and seems to work.



---

archive/issue_comments_379152.json:
```json
{
    "body": "It should also be noted that we have also in the past patched other SPKGS (see e.g. #21188) to always link with `-lgmp` and `#include <gmp.h>` (and never use `-lmpir` and `#include <mpir.h>` respectively).\n\nI'm not 100% convinced that that's necessary, though certainly one or the other should be used.  So it's probably best to always ensure that there is at least a working `libgmp` and a `gmp.h`.  The question then is whether or not it's possible to determine if that `libgmp` happened to be provided by MPIR.\n\nUpdate: It seems that a `libgmp.so` provided by MPIR does contain a `__mpir_version` symbol, so that's something we can look for.",
    "created_at": "2019-02-06T17:11:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379152",
    "user": "https://github.com/embray"
}
```

It should also be noted that we have also in the past patched other SPKGS (see e.g. #21188) to always link with `-lgmp` and `#include <gmp.h>` (and never use `-lmpir` and `#include <mpir.h>` respectively).

I'm not 100% convinced that that's necessary, though certainly one or the other should be used.  So it's probably best to always ensure that there is at least a working `libgmp` and a `gmp.h`.  The question then is whether or not it's possible to determine if that `libgmp` happened to be provided by MPIR.

Update: It seems that a `libgmp.so` provided by MPIR does contain a `__mpir_version` symbol, so that's something we can look for.



---

archive/issue_comments_379153.json:
```json
{
    "body": "It seems MPIR is not in fact packaged for Debian (not sure about other distros): https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=708391  I had just assumed it would be a question of using either MPIR or GMP (in other words, they conflict with each other, and installing either one or the other is possible, as is the case in Sage).",
    "created_at": "2019-02-06T17:19:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379153",
    "user": "https://github.com/embray"
}
```

It seems MPIR is not in fact packaged for Debian (not sure about other distros): https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=708391  I had just assumed it would be a question of using either MPIR or GMP (in other words, they conflict with each other, and installing either one or the other is possible, as is the case in Sage).



---

archive/issue_comments_379154.json:
```json
{
    "body": "Replying to [comment:3 embray]:\n> Yes, I've already put some thought into how to handle this case, though I don't have a solid answer.  The `spkg-configure.m4` seems fine, but we can't just leave it at that.\n> \n> The tricky thing is that with MPIR it can be compiled with or without gmp-compatibility mode.  On Sage we use `--with-gmpcompat` so if we link to a gmp we're actually getting the one installed by MPIR.  But some systems might have MPIR built without gmp-compatiblity, and yet no separate libgmp.so.  So in that case we'd actually want to use libmpir (if such a system exists I'm not sure).\n\nFreeBSD provides GMP and MPIR, not  in GMP-compatibility mode (I looked at the corresponding makefile)\nhttps://www.freshports.org/math/mpir\nhttps://www.freshports.org/math/gmp\n\nboth are in /usr/local/ there. \n\nI would not be worried about a hypothetical situation of many libgmp's on the system\n(in fact, MPFR has a very long configure script dealing with detecting all sorts of info about GMP (or a GMP-compatible thing)",
    "created_at": "2019-02-06T17:45:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379154",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:3 embray]:
> Yes, I've already put some thought into how to handle this case, though I don't have a solid answer.  The `spkg-configure.m4` seems fine, but we can't just leave it at that.
> 
> The tricky thing is that with MPIR it can be compiled with or without gmp-compatibility mode.  On Sage we use `--with-gmpcompat` so if we link to a gmp we're actually getting the one installed by MPIR.  But some systems might have MPIR built without gmp-compatiblity, and yet no separate libgmp.so.  So in that case we'd actually want to use libmpir (if such a system exists I'm not sure).

FreeBSD provides GMP and MPIR, not  in GMP-compatibility mode (I looked at the corresponding makefile)
https://www.freshports.org/math/mpir
https://www.freshports.org/math/gmp

both are in /usr/local/ there. 

I would not be worried about a hypothetical situation of many libgmp's on the system
(in fact, MPFR has a very long configure script dealing with detecting all sorts of info about GMP (or a GMP-compatible thing)



---

archive/issue_comments_379155.json:
```json
{
    "body": "I guess the main question is what to do with the `--with-mp=` flag in Sage's `./configure` script.  I don't think it necessarily needs to continue working exactly the same way, but whatever it does it should be sensible.  The way I see there are a couple possible ways to interpret it:\n\nOne way is that there are really three possible values:\n\n- detect\n- gmp\n- mpir\n\nwhere the default value is \"detect\".  In the \"detect\" case we just try to find the best working libgmp on the system and use it if found.  If not found the next fallback would be to install the mpir SPKG (the current default).  If passed \"mpir\" or \"gmp\" explicitly we don't bother detecting and just install the specifically requested SPKG.\n\nAnother possible interpretation is something more like:\n\n- gmp\n- mpir\n\nwhere now default value \"gmp\" is similar to the first case: just try to detect *any* libgmp on the system to use, and failing that install an SPKG for some libgmp (where we might still use MPIR, but that fact is an implementation detail), whereas \"mpir\" means \"detect MPIR *specifically*\", which is to say find a libgmp that also, at a minimum, contains the `__mpir_version` flag.  Perhaps, for some reason, a user might specifically want to use MPIR e.g. for performance reasons.  If not found then we build the MPIR SPKG and use that.\n\nPerhaps there are some other ways of interpreting/re-interpreting this flag, but those are a couple I have in mind.",
    "created_at": "2019-02-07T16:35:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379155",
    "user": "https://github.com/embray"
}
```

I guess the main question is what to do with the `--with-mp=` flag in Sage's `./configure` script.  I don't think it necessarily needs to continue working exactly the same way, but whatever it does it should be sensible.  The way I see there are a couple possible ways to interpret it:

One way is that there are really three possible values:

- detect
- gmp
- mpir

where the default value is "detect".  In the "detect" case we just try to find the best working libgmp on the system and use it if found.  If not found the next fallback would be to install the mpir SPKG (the current default).  If passed "mpir" or "gmp" explicitly we don't bother detecting and just install the specifically requested SPKG.

Another possible interpretation is something more like:

- gmp
- mpir

where now default value "gmp" is similar to the first case: just try to detect *any* libgmp on the system to use, and failing that install an SPKG for some libgmp (where we might still use MPIR, but that fact is an implementation detail), whereas "mpir" means "detect MPIR *specifically*", which is to say find a libgmp that also, at a minimum, contains the `__mpir_version` flag.  Perhaps, for some reason, a user might specifically want to use MPIR e.g. for performance reasons.  If not found then we build the MPIR SPKG and use that.

Perhaps there are some other ways of interpreting/re-interpreting this flag, but those are a couple I have in mind.



---

archive/issue_comments_379156.json:
```json
{
    "body": "I think I lean more toward the latter case.  Most people who want to build Sage do not care what GMP implementation they use, so I think it's good enough to use the one they have, if any, and if not pick one for them.  Whereas if someone is explicitly passing `--with-mp=mpir` then the *really* want MPIR specifically, and we should not give them something that isn't it.\n\nOTOH I'd also be curious in what cases MPIR gives better performance, and if we're doing users a disservice by not at least strongly recommending that they use it.   I think this is more a question for the mailing list though.  The details of what to do at `configure`-time can be malleable.",
    "created_at": "2019-02-07T16:37:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379156",
    "user": "https://github.com/embray"
}
```

I think I lean more toward the latter case.  Most people who want to build Sage do not care what GMP implementation they use, so I think it's good enough to use the one they have, if any, and if not pick one for them.  Whereas if someone is explicitly passing `--with-mp=mpir` then the *really* want MPIR specifically, and we should not give them something that isn't it.

OTOH I'd also be curious in what cases MPIR gives better performance, and if we're doing users a disservice by not at least strongly recommending that they use it.   I think this is more a question for the mailing list though.  The details of what to do at `configure`-time can be malleable.



---

archive/issue_comments_379157.json:
```json
{
    "body": "Perhaps we could leave the mpir-based toolchain aside for a moment, after all mpir is an optional package, so it is a bug if it is pulled in once GMP is chosen,\nand concentrate on the rest of the surrounding number theory libs: mpc, mpfr, gf2x, ntl, pari.\n\nSo first we have to sort out why GMP is pulled in despite being recognised by configure as not to be installed, no?\n\n---------\n\nNote that this spurious GMP installation isn't even triggered before some of spkgs dependent on GMP are installed, e.g. MPFR happily installs long before it's started on GMP.\nI get\n\n```\n$ ldd local/lib/libmpfr.so\n\tlinux-vdso.so.1 (0x00007ffcc02e9000)\n\tlibgmp.so.10 => /usr/lib64/libgmp.so.10 (0x00007f9345368000)\n\tlibc.so.6 => /lib64/libc.so.6 (0x00007f9345199000)\n\t/lib64/ld-linux-x86-64.so.2 (0x00007f9345696000)\n```\n\nbut the beginning of MPFR install log says, wrongly,\n\n```\n  --with-gmp=\"/mnt/opt/Sage/sage-dev/local\"\n```\n\nThis is of course as expected, as it's hardwired in its spkg-install, as\n`sdh_configure --with-gmp=\"$SAGE_LOCAL\"...`\n\nIt appears to me that instead the main `./configure` should set up something like `SAGE_GMP` to be either `SAGE_LOCAL` or a location computed by GMP's `spkg-configure.m4`, and then this `SAGE_GMP` must be used by MPFR...",
    "created_at": "2019-02-07T19:42:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379157",
    "user": "https://github.com/dimpase"
}
```

Perhaps we could leave the mpir-based toolchain aside for a moment, after all mpir is an optional package, so it is a bug if it is pulled in once GMP is chosen,
and concentrate on the rest of the surrounding number theory libs: mpc, mpfr, gf2x, ntl, pari.

So first we have to sort out why GMP is pulled in despite being recognised by configure as not to be installed, no?

---------

Note that this spurious GMP installation isn't even triggered before some of spkgs dependent on GMP are installed, e.g. MPFR happily installs long before it's started on GMP.
I get

```
$ ldd local/lib/libmpfr.so
	linux-vdso.so.1 (0x00007ffcc02e9000)
	libgmp.so.10 => /usr/lib64/libgmp.so.10 (0x00007f9345368000)
	libc.so.6 => /lib64/libc.so.6 (0x00007f9345199000)
	/lib64/ld-linux-x86-64.so.2 (0x00007f9345696000)
```

but the beginning of MPFR install log says, wrongly,

```
  --with-gmp="/mnt/opt/Sage/sage-dev/local"
```

This is of course as expected, as it's hardwired in its spkg-install, as
`sdh_configure --with-gmp="$SAGE_LOCAL"...`

It appears to me that instead the main `./configure` should set up something like `SAGE_GMP` to be either `SAGE_LOCAL` or a location computed by GMP's `spkg-configure.m4`, and then this `SAGE_GMP` must be used by MPFR...



---

archive/issue_comments_379158.json:
```json
{
    "body": "And MPFR's only part of trouble:\n\n```\n$ grep \"gmp=..SAGE_LOCAL.\" */spkg-install  \narb/spkg-install:    --with-gmp=\"$SAGE_LOCAL\" --with-mpfr=\"$SAGE_LOCAL\"\ndeformation/spkg-install:            --with-gmp=\"$SAGE_LOCAL\" --with-mpfr=\"$SAGE_LOCAL\" \\\necm/spkg-install:sdh_configure --with-gmp=\"$SAGE_LOCAL\" $ECM_CONFIGURE\nflint/spkg-install:    --with-gmp=\"$SAGE_LOCAL\" \\\ngap/spkg-install:sdh_configure --with-gmp=\"$SAGE_LOCAL\"\ngcc/spkg-install:    --with-gmp=\"$SAGE_LOCAL\" --with-mpfr=\"$SAGE_LOCAL\" --with-mpc=\"$SAGE_LOCAL\" \\\ngdb/spkg-install:    --with-gmp=\"$SAGE_LOCAL\"\ngfortran/spkg-install:    --with-gmp=\"$SAGE_LOCAL\" --with-mpfr=\"$SAGE_LOCAL\" --with-mpc=\"$SAGE_LOCAL\" \\\ngivaro/spkg-install:sdh_configure --with-gmp=\"$SAGE_LOCAL\" --enable-shared $GIVARO_CONFIGURE\nglpk/spkg-install:#       GMP/MPIR and zlib, so we should just use `--with-gmp=\"$SAGE_LOCAL\"` and\nmpc/spkg-install:sdh_configure --with-gmp=\"$SAGE_LOCAL\" --with-mpfr=\"$SAGE_LOCAL\" $EXTRA\nmpfi/spkg-install:sdh_configure --with-mpfr=\"$SAGE_LOCAL\" --with-gmp=\"$SAGE_LOCAL\"\nmpfrcx/spkg-install:sdh_configure --with-gmp=\"$SAGE_LOCAL\" --with-mpfr=\"$SAGE_LOCAL\" \\\nmpfr/spkg-install:        ./configure --with-gmp=\"$SAGE_LOCAL\" $SAGE_CONF_OPTS $MPFR_CONFIGURE) &>/dev/null;\nmpfr/spkg-install:    sdh_configure --with-gmp=\"$SAGE_LOCAL\" \\\npari/spkg-install:    --with-readline=\"$SAGE_LOCAL\" --with-gmp=\"$SAGE_LOCAL\" \\\npolylib/spkg-install:sdh_configure --with-libgmp=${SAGE_LOCAL}/lib\nsingular/spkg-install:                  --with-gmp=\"$SAGE_LOCAL\" \\\ntopcom/spkg-install:    --with-gmp=\"$SAGE_LOCAL\" \\\n```\n\nSo passing SAGE_LOCAL left and right for everything is something to work on.",
    "created_at": "2019-02-07T22:20:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379158",
    "user": "https://github.com/dimpase"
}
```

And MPFR's only part of trouble:

```
$ grep "gmp=..SAGE_LOCAL." */spkg-install  
arb/spkg-install:    --with-gmp="$SAGE_LOCAL" --with-mpfr="$SAGE_LOCAL"
deformation/spkg-install:            --with-gmp="$SAGE_LOCAL" --with-mpfr="$SAGE_LOCAL" \
ecm/spkg-install:sdh_configure --with-gmp="$SAGE_LOCAL" $ECM_CONFIGURE
flint/spkg-install:    --with-gmp="$SAGE_LOCAL" \
gap/spkg-install:sdh_configure --with-gmp="$SAGE_LOCAL"
gcc/spkg-install:    --with-gmp="$SAGE_LOCAL" --with-mpfr="$SAGE_LOCAL" --with-mpc="$SAGE_LOCAL" \
gdb/spkg-install:    --with-gmp="$SAGE_LOCAL"
gfortran/spkg-install:    --with-gmp="$SAGE_LOCAL" --with-mpfr="$SAGE_LOCAL" --with-mpc="$SAGE_LOCAL" \
givaro/spkg-install:sdh_configure --with-gmp="$SAGE_LOCAL" --enable-shared $GIVARO_CONFIGURE
glpk/spkg-install:#       GMP/MPIR and zlib, so we should just use `--with-gmp="$SAGE_LOCAL"` and
mpc/spkg-install:sdh_configure --with-gmp="$SAGE_LOCAL" --with-mpfr="$SAGE_LOCAL" $EXTRA
mpfi/spkg-install:sdh_configure --with-mpfr="$SAGE_LOCAL" --with-gmp="$SAGE_LOCAL"
mpfrcx/spkg-install:sdh_configure --with-gmp="$SAGE_LOCAL" --with-mpfr="$SAGE_LOCAL" \
mpfr/spkg-install:        ./configure --with-gmp="$SAGE_LOCAL" $SAGE_CONF_OPTS $MPFR_CONFIGURE) &>/dev/null;
mpfr/spkg-install:    sdh_configure --with-gmp="$SAGE_LOCAL" \
pari/spkg-install:    --with-readline="$SAGE_LOCAL" --with-gmp="$SAGE_LOCAL" \
polylib/spkg-install:sdh_configure --with-libgmp=${SAGE_LOCAL}/lib
singular/spkg-install:                  --with-gmp="$SAGE_LOCAL" \
topcom/spkg-install:    --with-gmp="$SAGE_LOCAL" \
```

So passing SAGE_LOCAL left and right for everything is something to work on.



---

archive/issue_comments_379159.json:
```json
{
    "body": "I don't think I understand how the `.dummy` target for skipping \"dummy\" packages \nin `build/make/Makefile` works, in particular, why it's just a single `$(INST)/.dummy` file for all of them.\n\nOr perhaps it's because `gmp` spkg is known as well as `$(MP_LIBRARY)`, and it's not found on the list of \"dummy\" packages, which duly includes `gmp`...",
    "created_at": "2019-02-07T23:49:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379159",
    "user": "https://github.com/dimpase"
}
```

I don't think I understand how the `.dummy` target for skipping "dummy" packages 
in `build/make/Makefile` works, in particular, why it's just a single `$(INST)/.dummy` file for all of them.

Or perhaps it's because `gmp` spkg is known as well as `$(MP_LIBRARY)`, and it's not found on the list of "dummy" packages, which duly includes `gmp`...



---

archive/issue_comments_379160.json:
```json
{
    "body": "I've added spkg-configures to the whole \"toolchain\" bunch (see attachment) - the one for MPIR is basically just a plug, and will now try running the build to see if GMP install still surfaces...",
    "created_at": "2019-02-08T09:50:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379160",
    "user": "https://github.com/dimpase"
}
```

I've added spkg-configures to the whole "toolchain" bunch (see attachment) - the one for MPIR is basically just a plug, and will now try running the build to see if GMP install still surfaces...



---

archive/issue_comments_379161.json:
```json
{
    "body": "Attachment [mp_star.patch](tarball://root/attachments/some-uuid/ticket27212/mp_star.patch) by @dimpase created at 2019-02-08 10:18:51\n\nno, this does not help - and while I didn't have patience for the build to come to a halt, I still saw GMP getting built. (and none of MP*'s)",
    "created_at": "2019-02-08T10:18:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379161",
    "user": "https://github.com/dimpase"
}
```

Attachment [mp_star.patch](tarball://root/attachments/some-uuid/ticket27212/mp_star.patch) by @dimpase created at 2019-02-08 10:18:51

no, this does not help - and while I didn't have patience for the build to come to a halt, I still saw GMP getting built. (and none of MP*'s)



---

archive/issue_comments_379162.json:
```json
{
    "body": "The thing to do with all of these is that `configure` needs to output some config file based on its results which contains the correct prefixes for all these libraries (and likely others to come).\n\nFor this it might be useful to use the existing `sage-env-config` file, since I believe it gets sourced when building each package.  It would probably be useful to have there since having the correct paths to libraries may also be useful at runtime (e.g. when running `cython()`, I think).  To this end it would also be nice to have a sort of `sage.env_config` Python module that is also generated, so these values can easily be loaded by the Python library without `sage-env` being sourced, but this is not necessary for the SPKG build process.\n\nThen every `--with-gmp=$SAGE_LOCAL\"` should be replaced with `--with-gmp=$SAGE_GMP_PREFIX\"`, or something like that (the value of which is still ofc `$SAGE_LOCAL` when using a GMP installed from an SPKG).\n\nWhat I'm less sure about is how exactly to determine the value for `$SAGE_GMP_PREFIX`.  Macros like `AC_SEARCH_LIBS` only tests that linking with `-l<libname>` works; it has no clue about how the system searches library paths in that case.  I think the best way to handle this is not unlike the code I wrote in #27230, unfortunately.",
    "created_at": "2019-02-08T11:35:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379162",
    "user": "https://github.com/embray"
}
```

The thing to do with all of these is that `configure` needs to output some config file based on its results which contains the correct prefixes for all these libraries (and likely others to come).

For this it might be useful to use the existing `sage-env-config` file, since I believe it gets sourced when building each package.  It would probably be useful to have there since having the correct paths to libraries may also be useful at runtime (e.g. when running `cython()`, I think).  To this end it would also be nice to have a sort of `sage.env_config` Python module that is also generated, so these values can easily be loaded by the Python library without `sage-env` being sourced, but this is not necessary for the SPKG build process.

Then every `--with-gmp=$SAGE_LOCAL"` should be replaced with `--with-gmp=$SAGE_GMP_PREFIX"`, or something like that (the value of which is still ofc `$SAGE_LOCAL` when using a GMP installed from an SPKG).

What I'm less sure about is how exactly to determine the value for `$SAGE_GMP_PREFIX`.  Macros like `AC_SEARCH_LIBS` only tests that linking with `-l<libname>` works; it has no clue about how the system searches library paths in that case.  I think the best way to handle this is not unlike the code I wrote in #27230, unfortunately.



---

archive/issue_comments_379163.json:
```json
{
    "body": "I think the .dummy magic breaks for `$(MP_LIBRARY)`. To prove this, I did\n\n```diff\ndiff --git a/build/make/deps b/build/make/deps\nindex e9008d20e6..c37b6062ee 100644\n--- a/build/make/deps\n+++ b/build/make/deps\n@@ -77,7 +77,7 @@ toolchain: $(foreach pkgname,$(TOOLCHAIN),$(inst_$(pkgname)))\n # See #14168 and #14232.\n #\n # Note: This list consists of only the *runtime* dependencies of the toolchain.\n-TOOLCHAIN_DEPS = zlib $(MP_LIBRARY) mpfr mpc\n+TOOLCHAIN_DEPS = zlib gmp mpfr mpc\n TOOLCHAIN_DEP_INSTS = \\\n        $(foreach pkgname,$(TOOLCHAIN_DEPS),$(inst_$(pkgname)))\n \n@@ -156,7 +156,6 @@ sagelib: \\\n                $(inst_mpc) \\\n                $(inst_mpfi) \\\n                $(inst_mpfr) \\\n-               $(MP_LIBRARY) \\\n                $(inst_ntl) \\\n                $(inst_numpy) \\\n                $(inst_pari) \\\n```\n\n(probably only the 2nd change, removal from `sagelib:` deps matters, not the 1st change.)\n\nand, viola, no GMP building pops up. Needless to say, \"dummies\" of the form `$(inst_...)` do not get built.",
    "created_at": "2019-02-08T11:37:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379163",
    "user": "https://github.com/dimpase"
}
```

I think the .dummy magic breaks for `$(MP_LIBRARY)`. To prove this, I did

```diff
diff --git a/build/make/deps b/build/make/deps
index e9008d20e6..c37b6062ee 100644
--- a/build/make/deps
+++ b/build/make/deps
@@ -77,7 +77,7 @@ toolchain: $(foreach pkgname,$(TOOLCHAIN),$(inst_$(pkgname)))
 # See #14168 and #14232.
 #
 # Note: This list consists of only the *runtime* dependencies of the toolchain.
-TOOLCHAIN_DEPS = zlib $(MP_LIBRARY) mpfr mpc
+TOOLCHAIN_DEPS = zlib gmp mpfr mpc
 TOOLCHAIN_DEP_INSTS = \
        $(foreach pkgname,$(TOOLCHAIN_DEPS),$(inst_$(pkgname)))
 
@@ -156,7 +156,6 @@ sagelib: \
                $(inst_mpc) \
                $(inst_mpfi) \
                $(inst_mpfr) \
-               $(MP_LIBRARY) \
                $(inst_ntl) \
                $(inst_numpy) \
                $(inst_pari) \
```

(probably only the 2nd change, removal from `sagelib:` deps matters, not the 1st change.)

and, viola, no GMP building pops up. Needless to say, "dummies" of the form `$(inst_...)` do not get built.



---

archive/issue_comments_379164.json:
```json
{
    "body": "Replying to [comment:17 dimpase]:\n> I think the .dummy magic breaks for `$(MP_LIBRARY)`. To prove this, I did\n\nSorry, I didn't realize you were being stymied by this.  Yes, to me there was no mystery here, which is in part why I was focused on how best to handle the existing `--with-mp` flag. I should have been more clear about that.",
    "created_at": "2019-02-08T11:57:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379164",
    "user": "https://github.com/embray"
}
```

Replying to [comment:17 dimpase]:
> I think the .dummy magic breaks for `$(MP_LIBRARY)`. To prove this, I did

Sorry, I didn't realize you were being stymied by this.  Yes, to me there was no mystery here, which is in part why I was focused on how best to handle the existing `--with-mp` flag. I should have been more clear about that.



---

archive/issue_comments_379165.json:
```json
{
    "body": "Replying to [comment:16 embray]: \n> What I'm less sure about is how exactly to determine the value for `$SAGE_GMP_PREFIX`.  Macros like `AC_SEARCH_LIBS` only tests that linking with `-l<libname>` works; it has no clue about how the system searches library paths in that case.  I think the best way to handle this is not unlike the code I wrote in #27230, unfortunately.\n\nAnother possibility of course is to just leave it empty and not pass `--with-gmp` flags at all, in this case they will be forced to just pick up whatever GMP they find on the default paths as well, which *usually* will be the same one.",
    "created_at": "2019-02-08T12:03:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379165",
    "user": "https://github.com/embray"
}
```

Replying to [comment:16 embray]: 
> What I'm less sure about is how exactly to determine the value for `$SAGE_GMP_PREFIX`.  Macros like `AC_SEARCH_LIBS` only tests that linking with `-l<libname>` works; it has no clue about how the system searches library paths in that case.  I think the best way to handle this is not unlike the code I wrote in #27230, unfortunately.

Another possibility of course is to just leave it empty and not pass `--with-gmp` flags at all, in this case they will be forced to just pick up whatever GMP they find on the default paths as well, which *usually* will be the same one.



---

archive/issue_comments_379166.json:
```json
{
    "body": "Pragmatically, I'd say that`--with-mp=foo` ought to always install `foo` from Sage's source, unless `foo=detect`. This is your first possibility from comment 9.\n(And leaving it out would result in either picking up system's \"GMP\", be it real GMP or MPIR in compatibility mode.)\n\nThis is reasonably flexible. Experts who need special versions of GMP/MPIR may just update Sage's packages and use them, or install them system-wide.\n\nMost of all, it would not need fiddling with recongising \"hidden\" MPIR in a system's  libgmp, something that would otherwise cater for non-existing systems, i.e. pure over-design for nothing and nobody...",
    "created_at": "2019-02-08T13:51:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379166",
    "user": "https://github.com/dimpase"
}
```

Pragmatically, I'd say that`--with-mp=foo` ought to always install `foo` from Sage's source, unless `foo=detect`. This is your first possibility from comment 9.
(And leaving it out would result in either picking up system's "GMP", be it real GMP or MPIR in compatibility mode.)

This is reasonably flexible. Experts who need special versions of GMP/MPIR may just update Sage's packages and use them, or install them system-wide.

Most of all, it would not need fiddling with recongising "hidden" MPIR in a system's  libgmp, something that would otherwise cater for non-existing systems, i.e. pure over-design for nothing and nobody...



---

archive/issue_comments_379167.json:
```json
{
    "body": "Replying to [comment:20 dimpase]:\n> Pragmatically, I'd say that`--with-mp=foo` ought to always install `foo` from Sage's source, unless `foo=detect`. This is your first possibility from comment 9.\n> (And leaving it out would result in either picking up system's \"GMP\", be it real GMP or MPIR in compatibility mode.)\n> \n> This is reasonably flexible. Experts who need special versions of GMP/MPIR may just update Sage's packages and use them, or install them system-wide.\n> \n> Most of all, it would not need fiddling with recongising \"hidden\" MPIR in a system's  libgmp, something that would otherwise cater for non-existing systems, i.e. pure over-design for nothing and nobody...\n\nOkay, let's go with that then, for now.  That would be good because it is also the most \"backwards compatible\" with the current behavior.\n\nAs for the `--with-gmp=` question, I keep thinking about it and I think this is the best thing to do:\n\n* in the gmp/spkg-configure.m4 add support for our own `--with-gmp=` flag.  Most people\n  won't need this, but it does provide some desirable flexibility.  This would just set the\n  GMP prefix explicitly (and be saved to `$SAGE_GMP_PREFIX`) to be passed on to other\n  packages that look for a GMP\n\n* when passed an explicit `--with-gmp` flag that should also imply that we *want* to use\n  the system package, and if it can't be found this should be an error\n\n* if a usable system GMP is detected (with or without `--with-gmp`) just go with it; if\n  `--with-gmp` was not specified then we set `$SAGE_GMP_PREFIX` to blank, and in that\n  case explicitly do *not* pass `--with-gmp=` to other packages: let them just pick up\n  the system GMP (note: I checked, and passing `--with-gmp=` with a blank argument is buggy\n  in at least a few of these packages, so better not to use the flag at all in that case)\n\n* if a usable system GMP is not detected we just build the SPKG as normal, with whatever\n  option was selected by `--with-mp`, with MPIR by default and set `SAGE_GMP_PREFIX=$SAGE_LOCAL`.",
    "created_at": "2019-02-08T14:08:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379167",
    "user": "https://github.com/embray"
}
```

Replying to [comment:20 dimpase]:
> Pragmatically, I'd say that`--with-mp=foo` ought to always install `foo` from Sage's source, unless `foo=detect`. This is your first possibility from comment 9.
> (And leaving it out would result in either picking up system's "GMP", be it real GMP or MPIR in compatibility mode.)
> 
> This is reasonably flexible. Experts who need special versions of GMP/MPIR may just update Sage's packages and use them, or install them system-wide.
> 
> Most of all, it would not need fiddling with recongising "hidden" MPIR in a system's  libgmp, something that would otherwise cater for non-existing systems, i.e. pure over-design for nothing and nobody...

Okay, let's go with that then, for now.  That would be good because it is also the most "backwards compatible" with the current behavior.

As for the `--with-gmp=` question, I keep thinking about it and I think this is the best thing to do:

* in the gmp/spkg-configure.m4 add support for our own `--with-gmp=` flag.  Most people
  won't need this, but it does provide some desirable flexibility.  This would just set the
  GMP prefix explicitly (and be saved to `$SAGE_GMP_PREFIX`) to be passed on to other
  packages that look for a GMP

* when passed an explicit `--with-gmp` flag that should also imply that we *want* to use
  the system package, and if it can't be found this should be an error

* if a usable system GMP is detected (with or without `--with-gmp`) just go with it; if
  `--with-gmp` was not specified then we set `$SAGE_GMP_PREFIX` to blank, and in that
  case explicitly do *not* pass `--with-gmp=` to other packages: let them just pick up
  the system GMP (note: I checked, and passing `--with-gmp=` with a blank argument is buggy
  in at least a few of these packages, so better not to use the flag at all in that case)

* if a usable system GMP is not detected we just build the SPKG as normal, with whatever
  option was selected by `--with-mp`, with MPIR by default and set `SAGE_GMP_PREFIX=$SAGE_LOCAL`.



---

archive/issue_comments_379168.json:
```json
{
    "body": "I'm working on a prototype for the above scheme.  Which is not to say I'm convinced is the best way, but it seems worth a try.",
    "created_at": "2019-02-08T14:26:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379168",
    "user": "https://github.com/embray"
}
```

I'm working on a prototype for the above scheme.  Which is not to say I'm convinced is the best way, but it seems worth a try.



---

archive/issue_comments_379169.json:
```json
{
    "body": "OK, great. By the way, on Gentoo, with these extra spkg-configures in Attachment (all of them used to actually use system's libraries) , I let `make ptests` run, and all the tests passed.\n\nI actually had one more, for gf2x\n\n```\nSAGE_SPKG_CONFIGURE([gf2x], [\n    AC_CHECK_HEADER(gf2x.h, [], [sage_spkg_install_gf2x=yes])\ndnl gf2x_mul_r appeared in version 1.2 of GF2X \n    AC_SEARCH_LIBS([gf2x_mul_r], [gf2x], [break], [sage_spkg_install_gf2x=yes])\n])\n```\n\nI guess it should go on another ticket.",
    "created_at": "2019-02-08T15:01:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379169",
    "user": "https://github.com/dimpase"
}
```

OK, great. By the way, on Gentoo, with these extra spkg-configures in Attachment (all of them used to actually use system's libraries) , I let `make ptests` run, and all the tests passed.

I actually had one more, for gf2x

```
SAGE_SPKG_CONFIGURE([gf2x], [
    AC_CHECK_HEADER(gf2x.h, [], [sage_spkg_install_gf2x=yes])
dnl gf2x_mul_r appeared in version 1.2 of GF2X 
    AC_SEARCH_LIBS([gf2x_mul_r], [gf2x], [break], [sage_spkg_install_gf2x=yes])
])
```

I guess it should go on another ticket.



---

archive/issue_comments_379170.json:
```json
{
    "body": "Replying to [comment:21 embray]:\n>    * in the gmp/spkg-configure.m4 add support for our own `--with-gmp=` flag.  Most people\n>      won't need this, but it does provide some desirable flexibility.  This would just set the\n>      GMP prefix explicitly (and be saved to `$SAGE_GMP_PREFIX`) to be passed on to other\n>      packages that look for a GMP\n> \n>    * when passed an explicit `--with-gmp` flag that should also imply that we *want* to use\n>      the system package, and if it can't be found this should be an error\n\nIt turns out doing this right is likely more trouble than it's worth, so I'm going to say \"YAGNI\" to this, until and unless proven otherwise. It turns out even most of the packages that have a `--with-gmp` flag in their own configures don't really implement it well.  As long as Sage is using the system GMP, this flag shouldn't really be needed anyways for compiling other packages against the system GMP.  So better to just leave it off entirely, at least when using the system package.",
    "created_at": "2019-02-11T15:12:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379170",
    "user": "https://github.com/embray"
}
```

Replying to [comment:21 embray]:
>    * in the gmp/spkg-configure.m4 add support for our own `--with-gmp=` flag.  Most people
>      won't need this, but it does provide some desirable flexibility.  This would just set the
>      GMP prefix explicitly (and be saved to `$SAGE_GMP_PREFIX`) to be passed on to other
>      packages that look for a GMP
> 
>    * when passed an explicit `--with-gmp` flag that should also imply that we *want* to use
>      the system package, and if it can't be found this should be an error

It turns out doing this right is likely more trouble than it's worth, so I'm going to say "YAGNI" to this, until and unless proven otherwise. It turns out even most of the packages that have a `--with-gmp` flag in their own configures don't really implement it well.  As long as Sage is using the system GMP, this flag shouldn't really be needed anyways for compiling other packages against the system GMP.  So better to just leave it off entirely, at least when using the system package.



---

archive/issue_comments_379171.json:
```json
{
    "body": "I updated a bunch of spkg-installs to not use `--with-gmp` when using the system package.  The `./configure` happily detected my system's GMP 6.1.2 (the most recent).  Doing a full rebuild and `make ptestlong` against that to test.",
    "created_at": "2019-02-11T16:23:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379171",
    "user": "https://github.com/embray"
}
```

I updated a bunch of spkg-installs to not use `--with-gmp` when using the system package.  The `./configure` happily detected my system's GMP 6.1.2 (the most recent).  Doing a full rebuild and `make ptestlong` against that to test.



---

archive/issue_comments_379172.json:
```json
{
    "body": "Getting weird segfaults and other errors from cypari when building with my system's GMP.  Not sure if there's any relation though, something else could be wrong, at this point, with this build...",
    "created_at": "2019-02-11T20:19:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379172",
    "user": "https://github.com/embray"
}
```

Getting weird segfaults and other errors from cypari when building with my system's GMP.  Not sure if there's any relation though, something else could be wrong, at this point, with this build...



---

archive/issue_comments_379173.json:
```json
{
    "body": "Okay, I don't know where I got the idea that this system has GMP 6.1.2.  I appear to have gotten mixed up between machines.  This machine has GMP 5.1.3.   Nevertheless that does seem to be a problem because this `spkg-configure.m4` allowed me to use it.  But apparently PARI does not support this old a version.\n\nI get\n\n\n```\n[pari-2.11.1.p0] linux-x86_64-gmp30818: error while loading shared libraries: libgmp.so.23: cannot open shared object file: No such file or directory\n[pari-2.11.1.p0] ### Your version of GMP is too old for PARI. Please upgrade\n```\n\n\nI don't know why it's looking for some \"libgmp.so.23\" though.  I don't have anything like that on my system.  So this *could* be a bug in the PARI build system.  I will see if I can convince PARI to use this GMP and if it will work.  Nevertheless it's not encouraging.",
    "created_at": "2019-02-11T20:51:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379173",
    "user": "https://github.com/embray"
}
```

Okay, I don't know where I got the idea that this system has GMP 6.1.2.  I appear to have gotten mixed up between machines.  This machine has GMP 5.1.3.   Nevertheless that does seem to be a problem because this `spkg-configure.m4` allowed me to use it.  But apparently PARI does not support this old a version.

I get


```
[pari-2.11.1.p0] linux-x86_64-gmp30818: error while loading shared libraries: libgmp.so.23: cannot open shared object file: No such file or directory
[pari-2.11.1.p0] ### Your version of GMP is too old for PARI. Please upgrade
```


I don't know why it's looking for some "libgmp.so.23" though.  I don't have anything like that on my system.  So this *could* be a bug in the PARI build system.  I will see if I can convince PARI to use this GMP and if it will work.  Nevertheless it's not encouraging.



---

archive/issue_comments_379174.json:
```json
{
    "body": "here is what Singular does: https://github.com/Singular/LELA/blob/master/macros/gmp-check.m4",
    "created_at": "2019-02-11T21:28:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379174",
    "user": "https://github.com/dimpase"
}
```

here is what Singular does: https://github.com/Singular/LELA/blob/master/macros/gmp-check.m4



---

archive/issue_comments_379175.json:
```json
{
    "body": "Okay, I think pari does not *actually* need this version of GMP (which is not to say some other package might not need it, but I want to see how far I can get).\n\nWhat was messing me up was that I did not prevent mpir from being installed in this build, so it was partially picking up the MPIR in `$SAGE_LOCAL` but in an incomplete and broken manner.  After applying part of my fix to prevent MPIR from being installed, PARI built okay.",
    "created_at": "2019-02-11T22:18:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379175",
    "user": "https://github.com/embray"
}
```

Okay, I think pari does not *actually* need this version of GMP (which is not to say some other package might not need it, but I want to see how far I can get).

What was messing me up was that I did not prevent mpir from being installed in this build, so it was partially picking up the MPIR in `$SAGE_LOCAL` but in an incomplete and broken manner.  After applying part of my fix to prevent MPIR from being installed, PARI built okay.



---

archive/issue_comments_379176.json:
```json
{
    "body": "Final update on this before I really go to sleep: pynac uses `mpq_cmp_z` which is definitely only available as of GMP 6.1.0.  pynac could probably manage to not use it if it's not available, but I don't think it's worth bothering with.  I'm perfectly happy to just require GMP>=6.1.0 in that case, which is still rather old at this point.\n\nThe symbol to check for in this case is `__gmpq_cmp_z`.  I confirmed in does not exist in GMP 6.0.x or below, and has the benefit of being a function that is actually used in one of the dependents of GMP.",
    "created_at": "2019-02-11T23:25:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379176",
    "user": "https://github.com/embray"
}
```

Final update on this before I really go to sleep: pynac uses `mpq_cmp_z` which is definitely only available as of GMP 6.1.0.  pynac could probably manage to not use it if it's not available, but I don't think it's worth bothering with.  I'm perfectly happy to just require GMP>=6.1.0 in that case, which is still rather old at this point.

The symbol to check for in this case is `__gmpq_cmp_z`.  I confirmed in does not exist in GMP 6.0.x or below, and has the benefit of being a function that is actually used in one of the dependents of GMP.



---

archive/issue_comments_379177.json:
```json
{
    "body": "Changing keywords from \"\" to \"spkg-configure\".",
    "created_at": "2019-02-12T09:15:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379177",
    "user": "https://github.com/dimpase"
}
```

Changing keywords from "" to "spkg-configure".



---

archive/issue_comments_379178.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-02-12T10:00:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379178",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_379179.json:
```json
{
    "body": "Here's my attempt at this:\n\nMoved all the `--with-mp` logic into the `spkg-configure.m4` for MPIR so that it is local to where it is used. \n\nAlso, most of the logic is in mpir/spkg-configure.m4 rather than gmp/spkg-configure.m4 just because MPIR is the implementation we install by default if it can't be used from the sytem.  It could go either way, but this way seemed a bit more logical for that reason.\n\nThen, the gmp/spkg-configure.m4 is mostly just a stub.\n\nFinally, uses the symbol `__gmpq_cmp_z` to check for GMP>=6.1.0 (or whatever the equivalent MPIR is).\n\nSo to summarize, by default `--with-mp=system` and it tries to use the libgmp from the system.  If that check fails it falls back to installing the mpir SPKG.  If `--with-mp=mpir` it just doesn't even check the system and installs the mpir SPKG; similarly for `--with-mp=gmp`.",
    "created_at": "2019-02-12T10:00:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379179",
    "user": "https://github.com/embray"
}
```

Here's my attempt at this:

Moved all the `--with-mp` logic into the `spkg-configure.m4` for MPIR so that it is local to where it is used. 

Also, most of the logic is in mpir/spkg-configure.m4 rather than gmp/spkg-configure.m4 just because MPIR is the implementation we install by default if it can't be used from the sytem.  It could go either way, but this way seemed a bit more logical for that reason.

Then, the gmp/spkg-configure.m4 is mostly just a stub.

Finally, uses the symbol `__gmpq_cmp_z` to check for GMP>=6.1.0 (or whatever the equivalent MPIR is).

So to summarize, by default `--with-mp=system` and it tries to use the libgmp from the system.  If that check fails it falls back to installing the mpir SPKG.  If `--with-mp=mpir` it just doesn't even check the system and installs the mpir SPKG; similarly for `--with-mp=gmp`.



---

archive/issue_comments_379180.json:
```json
{
    "body": "Oops, typo on branch name.\n----\nNew commits:",
    "created_at": "2019-02-12T10:00:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379180",
    "user": "https://github.com/embray"
}
```

Oops, typo on branch name.
----
New commits:



---

archive/issue_comments_379181.json:
```json
{
    "body": "I accidentally left off a bunch of changes related to the `--with-gmp` flags in other packages.",
    "created_at": "2019-02-12T10:23:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379181",
    "user": "https://github.com/embray"
}
```

I accidentally left off a bunch of changes related to the `--with-gmp` flags in other packages.



---

archive/issue_comments_379182.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-02-12T10:23:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379182",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_379183.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-02-12T10:28:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379183",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_379184.json:
```json
{
    "body": "Also rebased on #27254.",
    "created_at": "2019-02-12T10:29:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379184",
    "user": "https://github.com/embray"
}
```

Also rebased on #27254.



---

archive/issue_comments_379185.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-02-12T10:29:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379185",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_379186.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-02-12T11:09:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379186",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_379187.json:
```json
{
    "body": "I just realized there is another problem with this, which didn't appear until I rebased.  Now if `SAGE_MP_LIBRARY=system` things break because there is no target \"system\".",
    "created_at": "2019-02-12T11:09:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379187",
    "user": "https://github.com/embray"
}
```

I just realized there is another problem with this, which didn't appear until I rebased.  Now if `SAGE_MP_LIBRARY=system` things break because there is no target "system".



---

archive/issue_comments_379188.json:
```json
{
    "body": "the ECM bit looks fishy:\n\n```\n--- a/build/pkgs/ecm/spkg-install\n+++ b/build/pkgs/ecm/spkg-install\n@@ -210,7 +210,10 @@ else\n fi\n echo \"  --prefix=\\\"$SAGE_LOCAL\\\"\"\n echo \"  --libdir=\\\"$SAGE_LOCAL/lib\\\"\"\n-echo \"  --with-gmp=\\\"$SAGE_LOCAL\\\"\"\n+if [ -n \"$SAGE_GMP_CONFIGURE\" ]; then\n+    echo \"  --with-gmp=\\\"$SAGE_LOCAL\\\"\"\n+fi\n+\n```\n",
    "created_at": "2019-02-12T11:25:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379188",
    "user": "https://github.com/dimpase"
}
```

the ECM bit looks fishy:

```
--- a/build/pkgs/ecm/spkg-install
+++ b/build/pkgs/ecm/spkg-install
@@ -210,7 +210,10 @@ else
 fi
 echo "  --prefix=\"$SAGE_LOCAL\""
 echo "  --libdir=\"$SAGE_LOCAL/lib\""
-echo "  --with-gmp=\"$SAGE_LOCAL\""
+if [ -n "$SAGE_GMP_CONFIGURE" ]; then
+    echo "  --with-gmp=\"$SAGE_LOCAL\""
+fi
+
```




---

archive/issue_comments_379189.json:
```json
{
    "body": "It is a typo.  It should be `$SAGE_CONFIGURE_GMP`.  It's not really important though, I was just retaining the existing behavior in that code.",
    "created_at": "2019-02-12T11:27:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379189",
    "user": "https://github.com/embray"
}
```

It is a typo.  It should be `$SAGE_CONFIGURE_GMP`.  It's not really important though, I was just retaining the existing behavior in that code.



---

archive/issue_comments_379190.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-12T13:50:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379190",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_379191.json:
```json
{
    "body": "I think this is fixed up now, though the commits should be squashed before setting final positive_review.",
    "created_at": "2019-02-12T13:51:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379191",
    "user": "https://github.com/embray"
}
```

I think this is fixed up now, though the commits should be squashed before setting final positive_review.



---

archive/issue_comments_379192.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-02-12T13:51:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379192",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_379193.json:
```json
{
    "body": "I see no chaining in mpir/mpfr macros - if I intentionally break mpir recognition I still get mpfr not being installed, but picked up from the system...\n---if I just run ./configire without parameters.\n\n(I don't know whether this breaks builds or not, but I guess we would like to see in such a case, if mpfr is not available, mpfr being built as well)",
    "created_at": "2019-02-12T21:13:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379193",
    "user": "https://github.com/dimpase"
}
```

I see no chaining in mpir/mpfr macros - if I intentionally break mpir recognition I still get mpfr not being installed, but picked up from the system...
---if I just run ./configire without parameters.

(I don't know whether this breaks builds or not, but I guess we would like to see in such a case, if mpfr is not available, mpfr being built as well)



---

archive/issue_comments_379194.json:
```json
{
    "body": "With this branch, I've run into a problem with IML package, see #27272",
    "created_at": "2019-02-13T14:07:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379194",
    "user": "https://github.com/dimpase"
}
```

With this branch, I've run into a problem with IML package, see #27272



---

archive/issue_comments_379195.json:
```json
{
    "body": "Replying to [comment:45 dimpase]:\n> With this branch, I've run into a problem with IML package, see #27272\n\nthis is platform-specific - e.g. on Fedora 26 I don't get this problem.",
    "created_at": "2019-02-13T16:42:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379195",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:45 dimpase]:
> With this branch, I've run into a problem with IML package, see #27272

this is platform-specific - e.g. on Fedora 26 I don't get this problem.



---

archive/issue_comments_379196.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-14T14:51:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379196",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_379197.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-02-14T15:41:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379197",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_379198.json:
```json
{
    "body": "There are some sage dependencies using `libgmpxx` and if `gmpxx` was compiled with a different C++ standard library, you'll get link failures. It'll be good check for this here.",
    "created_at": "2019-02-16T09:57:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379198",
    "user": "https://github.com/isuruf"
}
```

There are some sage dependencies using `libgmpxx` and if `gmpxx` was compiled with a different C++ standard library, you'll get link failures. It'll be good check for this here.



---

archive/issue_comments_379199.json:
```json
{
    "body": "Here's an example file you can use, https://github.com/symengine/symengine/blob/master/cmake/checkgmpxx.cpp. This check fails when gmpxx is compiled using g++ and the dependent library is compiled using clang++ and vice-versa on OSX.",
    "created_at": "2019-02-16T10:01:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379199",
    "user": "https://github.com/isuruf"
}
```

Here's an example file you can use, https://github.com/symengine/symengine/blob/master/cmake/checkgmpxx.cpp. This check fails when gmpxx is compiled using g++ and the dependent library is compiled using clang++ and vice-versa on OSX.



---

archive/issue_comments_379200.json:
```json
{
    "body": "Replying to [comment:50 isuruf]:\n> Here's an example file you can use, https://github.com/symengine/symengine/blob/master/cmake/checkgmpxx.cpp. This check fails when gmpxx is compiled using g++ and the dependent library is compiled using clang++ and vice-versa on OSX.\n\nI suppose that there is no compatibility even across different versions of g++, and perhaps not even when the same compiler is used with different `-std=`.",
    "created_at": "2019-02-17T09:04:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379200",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:50 isuruf]:
> Here's an example file you can use, https://github.com/symengine/symengine/blob/master/cmake/checkgmpxx.cpp. This check fails when gmpxx is compiled using g++ and the dependent library is compiled using clang++ and vice-versa on OSX.

I suppose that there is no compatibility even across different versions of g++, and perhaps not even when the same compiler is used with different `-std=`.



---

archive/issue_comments_379201.json:
```json
{
    "body": "https://stackoverflow.com/questions/46746878/is-it-safe-to-link-c17-c14-and-c11-objects should answer your general question. For gmpxx though, I don't think it matters a lot.",
    "created_at": "2019-02-17T21:12:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379201",
    "user": "https://github.com/isuruf"
}
```

https://stackoverflow.com/questions/46746878/is-it-safe-to-link-c17-c14-and-c11-objects should answer your general question. For gmpxx though, I don't think it matters a lot.



---

archive/issue_comments_379202.json:
```json
{
    "body": "Replying to [comment:52 isuruf]:\n> https://stackoverflow.com/questions/46746878/is-it-safe-to-link-c17-c14-and-c11-objects should answer your general question. For gmpxx though, I don't think it matters a lot.\n\nThanks. It seems that this link basically says that as far as linking issues are concerned, you might be unable to chase down all the corner cases if one used different versions of g++ (which is unsurprising to me...).",
    "created_at": "2019-02-17T21:34:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379202",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:52 isuruf]:
> https://stackoverflow.com/questions/46746878/is-it-safe-to-link-c17-c14-and-c11-objects should answer your general question. For gmpxx though, I don't think it matters a lot.

Thanks. It seems that this link basically says that as far as linking issues are concerned, you might be unable to chase down all the corner cases if one used different versions of g++ (which is unsurprising to me...).



---

archive/issue_comments_379203.json:
```json
{
    "body": "Replying to [comment:47 git]:\n> Branch pushed to git repo; I updated commit sha1. New commits:\n> ||[1e48b30](https://git.sagemath.org/sage.git/commit/?id=1e48b301165b7756b203e5a2935fb91375b1da7b)||`correct logic for SAGE_GMP_PREFIX etc`||\n\nsetting of `SAGE_GMP_PREFIX` does not quite work there, it's always `''`.",
    "created_at": "2019-02-18T08:55:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379203",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:47 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[1e48b30](https://git.sagemath.org/sage.git/commit/?id=1e48b301165b7756b203e5a2935fb91375b1da7b)||`correct logic for SAGE_GMP_PREFIX etc`||

setting of `SAGE_GMP_PREFIX` does not quite work there, it's always `''`.



---

archive/issue_comments_379204.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-02-18T08:55:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379204",
    "user": "https://github.com/dimpase"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_379205.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-18T09:27:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379205",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_379206.json:
```json
{
    "body": "Replying to [comment:55 git]:\n> Branch pushed to git repo; I updated commit sha1. New commits:\n> ||[50c3482](https://git.sagemath.org/sage.git/commit/?id=50c3482dd8700d4b62d229edf8beb3edc6fc7f5e)||`remove iffy if, do setting SAGE_GMP_PREFIX in cases`||\n\nThis is still wrong because in that `case` statement, in the `system)` case you can still wind up installing the Sage SPKG if any of the checks fail (hence setting `sage_spkg_install_mpir=yes`).  That's why there is a separate `if/then` clause later.\n\nI think the problem here is is with quoting.  You can see it in the configure log when running the previous version (and also fixing the `SAGE_MP_LIBRARY = mpir` line):\n\n\n```\n./configure: line 8899: test: too many arguments\n```\n\n\nI believe it's possible for `$sage_spkg_install_gmp` to not be defined here, so we need the `x` quoting.",
    "created_at": "2019-02-18T14:17:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379206",
    "user": "https://github.com/embray"
}
```

Replying to [comment:55 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[50c3482](https://git.sagemath.org/sage.git/commit/?id=50c3482dd8700d4b62d229edf8beb3edc6fc7f5e)||`remove iffy if, do setting SAGE_GMP_PREFIX in cases`||

This is still wrong because in that `case` statement, in the `system)` case you can still wind up installing the Sage SPKG if any of the checks fail (hence setting `sage_spkg_install_mpir=yes`).  That's why there is a separate `if/then` clause later.

I think the problem here is is with quoting.  You can see it in the configure log when running the previous version (and also fixing the `SAGE_MP_LIBRARY = mpir` line):


```
./configure: line 8899: test: too many arguments
```


I believe it's possible for `$sage_spkg_install_gmp` to not be defined here, so we need the `x` quoting.



---

archive/issue_comments_379207.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-02-18T14:21:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379207",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_379208.json:
```json
{
    "body": "This should fix it I think.  I also fixed the `AC_MSG_RESULT` calls to report the correct result when `--with-mp=system` but the system lib cannot be used (and hence we fall back on installing the MPIR SPKG).\n\nI think what might be continuing to confuse you is that the case for `--with-mp=system` can still result in the MPIR SPKG being selected instead.",
    "created_at": "2019-02-18T14:22:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379208",
    "user": "https://github.com/embray"
}
```

This should fix it I think.  I also fixed the `AC_MSG_RESULT` calls to report the correct result when `--with-mp=system` but the system lib cannot be used (and hence we fall back on installing the MPIR SPKG).

I think what might be continuing to confuse you is that the case for `--with-mp=system` can still result in the MPIR SPKG being selected instead.



---

archive/issue_comments_379209.json:
```json
{
    "body": "Building a fresh build from this branch on Ubuntu 16.04 I also ran into the same problem Dima was telling me about with iml, reported also at #27272.  I just wanted to confirm that that was the case, so now I can also review that ticket with some intelligence.",
    "created_at": "2019-02-18T17:35:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379209",
    "user": "https://github.com/embray"
}
```

Building a fresh build from this branch on Ubuntu 16.04 I also ran into the same problem Dima was telling me about with iml, reported also at #27272.  I just wanted to confirm that that was the case, so now I can also review that ticket with some intelligence.



---

archive/issue_comments_379210.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-19T17:09:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379210",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_379211.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-20T15:30:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379211",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_379212.json:
```json
{
    "body": "Added a fix to the `spkg-install` for iml for it to use the system GMP as specified by `SAGE_GMP_INCLUDE`.  \n\nI am a bit iffy on the hack for setting `SAGE_GMP_LIB` and am open to other ideas.  But I did confirm that this works when using the system GMP on Ubuntu 16.04.  With the above two fixes I was able to build Sage just fine and `make ptestlong` passes.",
    "created_at": "2019-02-20T15:31:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379212",
    "user": "https://github.com/embray"
}
```

Added a fix to the `spkg-install` for iml for it to use the system GMP as specified by `SAGE_GMP_INCLUDE`.  

I am a bit iffy on the hack for setting `SAGE_GMP_LIB` and am open to other ideas.  But I did confirm that this works when using the system GMP on Ubuntu 16.04.  With the above two fixes I was able to build Sage just fine and `make ptestlong` passes.



---

archive/issue_comments_379213.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-02-20T16:10:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379213",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_379214.json:
```json
{
    "body": "I think it will make more sense to keep this ticket as a dependency of #27272 (or close #27272) since this is now covering both.",
    "created_at": "2019-02-20T16:11:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379214",
    "user": "https://github.com/embray"
}
```

I think it will make more sense to keep this ticket as a dependency of #27272 (or close #27272) since this is now covering both.



---

archive/issue_comments_379215.json:
```json
{
    "body": "It's good to go, I think.",
    "created_at": "2019-02-22T08:02:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379215",
    "user": "https://github.com/dimpase"
}
```

It's good to go, I think.



---

archive/issue_comments_379216.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-02-22T08:02:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379216",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_379217.json:
```json
{
    "body": "Probably this one needs an updated configure package - unless all the bots nowadays run ./bootstrap (I don't recall the current state of this).",
    "created_at": "2019-02-22T08:15:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379217",
    "user": "https://github.com/dimpase"
}
```

Probably this one needs an updated configure package - unless all the bots nowadays run ./bootstrap (I don't recall the current state of this).



---

archive/issue_comments_379218.json:
```json
{
    "body": "Merge conflict",
    "created_at": "2019-02-22T23:29:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379218",
    "user": "https://github.com/vbraun"
}
```

Merge conflict



---

archive/issue_comments_379219.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-02-22T23:29:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379219",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_379220.json:
```json
{
    "body": "it's gcc and gfortran spkg's that were touched in the latest beta. Erik, could you rebase these, it's certainly your code there...",
    "created_at": "2019-02-24T11:23:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379220",
    "user": "https://github.com/dimpase"
}
```

it's gcc and gfortran spkg's that were touched in the latest beta. Erik, could you rebase these, it's certainly your code there...



---

archive/issue_comments_379221.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-02-25T20:09:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379221",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_379222.json:
```json
{
    "body": "ok, it was trivial to rebase.\nnow testing before setting it to positive again.",
    "created_at": "2019-02-25T20:10:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379222",
    "user": "https://github.com/dimpase"
}
```

ok, it was trivial to rebase.
now testing before setting it to positive again.



---

archive/issue_comments_379223.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2019-02-26T10:26:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379223",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_379224.json:
```json
{
    "body": "The present mpfrcx does not work with this branch, but it does with the new version. Thus the new dependence.",
    "created_at": "2019-02-26T22:33:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379224",
    "user": "https://github.com/dimpase"
}
```

The present mpfrcx does not work with this branch, but it does with the new version. Thus the new dependence.



---

archive/issue_comments_379225.json:
```json
{
    "body": "`$SAGE_LOCAL/bin/sage-env-config` must get updated after, say, `sage -i mpir` (or any other dummy package that sets anything in the build environment). Currently this does not happen. This is a bug that leads to `sage -i mpir` breaking stuff. \n\nSee #27373 to deal with this. (Hopefully everything that is on this ticket can stay as it is, so I don't flip it to \"needs work\")",
    "created_at": "2019-02-27T09:51:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379225",
    "user": "https://github.com/dimpase"
}
```

`$SAGE_LOCAL/bin/sage-env-config` must get updated after, say, `sage -i mpir` (or any other dummy package that sets anything in the build environment). Currently this does not happen. This is a bug that leads to `sage -i mpir` breaking stuff. 

See #27373 to deal with this. (Hopefully everything that is on this ticket can stay as it is, so I don't flip it to "needs work")



---

archive/issue_comments_379226.json:
```json
{
    "body": "We need to decide how to move forward here. I'm fine with a no-fix for #27373, i.e.\n\"re-run configure with the parameters you need, do not use `./sage -i` for *un-dummifying* packages\".",
    "created_at": "2019-03-05T11:19:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379226",
    "user": "https://github.com/dimpase"
}
```

We need to decide how to move forward here. I'm fine with a no-fix for #27373, i.e.
"re-run configure with the parameters you need, do not use `./sage -i` for *un-dummifying* packages".



---

archive/issue_comments_379227.json:
```json
{
    "body": "I guess I don't really see how #27373 is relevant here. Or at least, I don't see that it's an issue particular to this ticket or that should be a dependency of it.",
    "created_at": "2019-03-05T14:59:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379227",
    "user": "https://github.com/embray"
}
```

I guess I don't really see how #27373 is relevant here. Or at least, I don't see that it's an issue particular to this ticket or that should be a dependency of it.



---

archive/issue_comments_379228.json:
```json
{
    "body": "Merge conflict",
    "created_at": "2019-03-11T12:36:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379228",
    "user": "https://github.com/jdemeyer"
}
```

Merge conflict



---

archive/issue_comments_379229.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-03-11T12:36:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379229",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_379230.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-03-11T15:49:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379230",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_379231.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-03-11T16:12:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379231",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_379232.json:
```json
{
    "body": "the only manual part of the merge was here:\n\n```diff\n--- a/build/pkgs/arb/spkg-install\n+++ b/build/pkgs/arb/spkg-install\n@@ -4,8 +4,8 @@ cd src\n # be removed in arb >= 2.8 when it is released\n export EXTRA_SHARED_FLAGS=$LDFLAGS\n \n-./configure --disable-static --prefix=\"$SAGE_LOCAL\" --with-flint=\"$SAGE_LOCAL\" \\\n-    --with-gmp=\"$SAGE_LOCAL\" --with-mpfr=\"$SAGE_LOCAL\" || \\\n+./configure --disable-static --prefix=\"$SAGE_LOCAL\" $SAGE_CONFIGURE_GMP \\\n+            --with-flint=\"$SAGE_LOCAL\" --with-mpfr=\"$SAGE_LOCAL\" || \\\n     sdh_die \"Error configuring arb.\"\n \n sdh_make verbose\n```\n",
    "created_at": "2019-03-11T16:15:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379232",
    "user": "https://github.com/dimpase"
}
```

the only manual part of the merge was here:

```diff
--- a/build/pkgs/arb/spkg-install
+++ b/build/pkgs/arb/spkg-install
@@ -4,8 +4,8 @@ cd src
 # be removed in arb >= 2.8 when it is released
 export EXTRA_SHARED_FLAGS=$LDFLAGS
 
-./configure --disable-static --prefix="$SAGE_LOCAL" --with-flint="$SAGE_LOCAL" \
-    --with-gmp="$SAGE_LOCAL" --with-mpfr="$SAGE_LOCAL" || \
+./configure --disable-static --prefix="$SAGE_LOCAL" $SAGE_CONFIGURE_GMP \
+            --with-flint="$SAGE_LOCAL" --with-mpfr="$SAGE_LOCAL" || \
     sdh_die "Error configuring arb."
 
 sdh_make verbose
```




---

archive/issue_comments_379233.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-03-11T16:15:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379233",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_379234.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2019-03-13T09:24:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379234",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_379235.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2019-03-13T09:24:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379235",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_379236.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-03-20T11:59:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379236",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_067566.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-03-20T11:59:54Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "milestone": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26975#event-67566"
}
```



---

archive/issue_comments_379237.json:
```json
{
    "body": "I wonder whether for gcc and gfortran `--with-gmp=\"$SAGE_LOCAL\"` is left there on purpose, or it's simply a typo/omission?\n\nThis might have \"interesting\" interactions with what is to come on #27373.",
    "created_at": "2019-03-20T14:38:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379237",
    "user": "https://github.com/dimpase"
}
```

I wonder whether for gcc and gfortran `--with-gmp="$SAGE_LOCAL"` is left there on purpose, or it's simply a typo/omission?

This might have "interesting" interactions with what is to come on #27373.



---

archive/issue_comments_379238.json:
```json
{
    "body": "Isn't the nesting of `AC_CHECK_HEADER`'s and `AC_SEARCH_LIBS`  needed here?\nOtherwise we may end up with system's GMP library, but without headers available.",
    "created_at": "2019-03-21T14:29:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379238",
    "user": "https://github.com/dimpase"
}
```

Isn't the nesting of `AC_CHECK_HEADER`'s and `AC_SEARCH_LIBS`  needed here?
Otherwise we may end up with system's GMP library, but without headers available.



---

archive/issue_comments_379239.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-04-10T10:00:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379239",
    "user": "https://github.com/embray"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_379240.json:
```json
{
    "body": "Replying to [comment:85 dimpase]:\n> I wonder whether for gcc and gfortran `--with-gmp=\"$SAGE_LOCAL\"` is left there on purpose, or it's simply a typo/omission?\n> \n> This might have \"interesting\" interactions with what is to come on #27373.\n\nI was just about to ask you about this.  I'm working on rebasing this on top of current develop (mostly straightforward but not trivial).  In the current upstream version of this branch, which you were the last to touch, gcc/gfortran was omitted in [this commit](https://git.sagemath.org/sage.git/commit/?h=03dc987c6d475279b0008fa8f5ba37a0045bb75e&id=3b6eebda8df1ae7fbc86f81c0fcf123989504447).  However, in my local copy of the branch it still includes them.\n\nI was going to ask if that was intentional but now it's sounding like maybe it wasn't.  So I'll put it back in for now.",
    "created_at": "2019-04-10T10:00:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379240",
    "user": "https://github.com/embray"
}
```

Replying to [comment:85 dimpase]:
> I wonder whether for gcc and gfortran `--with-gmp="$SAGE_LOCAL"` is left there on purpose, or it's simply a typo/omission?
> 
> This might have "interesting" interactions with what is to come on #27373.

I was just about to ask you about this.  I'm working on rebasing this on top of current develop (mostly straightforward but not trivial).  In the current upstream version of this branch, which you were the last to touch, gcc/gfortran was omitted in [this commit](https://git.sagemath.org/sage.git/commit/?h=03dc987c6d475279b0008fa8f5ba37a0045bb75e&id=3b6eebda8df1ae7fbc86f81c0fcf123989504447).  However, in my local copy of the branch it still includes them.

I was going to ask if that was intentional but now it's sounding like maybe it wasn't.  So I'll put it back in for now.



---

archive/issue_comments_379241.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-04-10T10:11:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379241",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_379242.json:
```json
{
    "body": "Rebased on 8.8.beta0.  Now to test again; this is all toward making progress on #27373...",
    "created_at": "2019-04-10T10:12:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379242",
    "user": "https://github.com/embray"
}
```

Rebased on 8.8.beta0.  Now to test again; this is all toward making progress on #27373...



---

archive/issue_comments_379243.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-04-10T10:12:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379243",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_379244.json:
```json
{
    "body": "Once again, about nesting. Shouldn't e.g.\n\n```m4\n            AC_CHECK_HEADER(gmp.h, [], [sage_spkg_install_mpir=yes])\n            AC_CHECK_HEADER(gmpxx.h, [], [sage_spkg_install_mpir=yes])\n            dnl mpq_cmp_z appeared in GMP 6.1.0 and is used by pynac\n            AC_SEARCH_LIBS([__gmpq_cmp_z], [gmp], [break],\n                [sage_spkg_install_mpir=yes])\n```\n\nbe written as\n\n```m4\n            AC_CHECK_HEADER(gmp.h, [\n              AC_CHECK_HEADER(gmpxx.h, [\n                dnl mpq_cmp_z appeared in GMP 6.1.0 and is used by pynac\n                AC_SEARCH_LIBS([__gmpq_cmp_z], [gmp], [break],\n                   [sage_spkg_install_mpir=yes])\n              ], [sage_spkg_install_mpir=yes])\n            ], [sage_spkg_install_mpir=yes])            \n```\n\n\nAnd, by the way, what's that `break` doing there? I gather it's to interrupt loops, but there is no loop here...",
    "created_at": "2019-04-10T11:00:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379244",
    "user": "https://github.com/dimpase"
}
```

Once again, about nesting. Shouldn't e.g.

```m4
            AC_CHECK_HEADER(gmp.h, [], [sage_spkg_install_mpir=yes])
            AC_CHECK_HEADER(gmpxx.h, [], [sage_spkg_install_mpir=yes])
            dnl mpq_cmp_z appeared in GMP 6.1.0 and is used by pynac
            AC_SEARCH_LIBS([__gmpq_cmp_z], [gmp], [break],
                [sage_spkg_install_mpir=yes])
```

be written as

```m4
            AC_CHECK_HEADER(gmp.h, [
              AC_CHECK_HEADER(gmpxx.h, [
                dnl mpq_cmp_z appeared in GMP 6.1.0 and is used by pynac
                AC_SEARCH_LIBS([__gmpq_cmp_z], [gmp], [break],
                   [sage_spkg_install_mpir=yes])
              ], [sage_spkg_install_mpir=yes])
            ], [sage_spkg_install_mpir=yes])            
```


And, by the way, what's that `break` doing there? I gather it's to interrupt loops, but there is no loop here...



---

archive/issue_comments_379245.json:
```json
{
    "body": "I don't think the nesting is necessary.  If finding the headers fails then it will set `sage_spkg_install_mpir=yes`; there's no advantage to then skipping the library check because it will still keep `sage_spkg_install_mpir=yes` reagardless. Nesting it just makes the code harder to read IMO.\n\n> And, by the way, what's that break doing there? I gather it's to interrupt loops, but there is no loop here...\n\nRemember, most of these autoconf macros expand to shell code.  So that's where the loop is, and you can see what a break would do there by looking at the expanded macro in the actual `configure` script.\n\nHowever, I think it's superfluous in this case.  It would break out of the loop if `AC_SEARCH_LIBS` finds that you can link the test program without explicitly passing `-lgmp`, but I don't think that would ever be the case (it is the case sometimes with other libraries, such as libm, which may be linked automatically).  So I can just remove it if it's clearer (it's also harmless though).",
    "created_at": "2019-04-10T12:25:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379245",
    "user": "https://github.com/embray"
}
```

I don't think the nesting is necessary.  If finding the headers fails then it will set `sage_spkg_install_mpir=yes`; there's no advantage to then skipping the library check because it will still keep `sage_spkg_install_mpir=yes` reagardless. Nesting it just makes the code harder to read IMO.

> And, by the way, what's that break doing there? I gather it's to interrupt loops, but there is no loop here...

Remember, most of these autoconf macros expand to shell code.  So that's where the loop is, and you can see what a break would do there by looking at the expanded macro in the actual `configure` script.

However, I think it's superfluous in this case.  It would break out of the loop if `AC_SEARCH_LIBS` finds that you can link the test program without explicitly passing `-lgmp`, but I don't think that would ever be the case (it is the case sometimes with other libraries, such as libm, which may be linked automatically).  So I can just remove it if it's clearer (it's also harmless though).



---

archive/issue_comments_379246.json:
```json
{
    "body": "OK, it's fine then.",
    "created_at": "2019-04-10T22:21:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379246",
    "user": "https://github.com/dimpase"
}
```

OK, it's fine then.



---

archive/issue_comments_379247.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-04-10T22:21:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379247",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_379248.json:
```json
{
    "body": "Thanks--I still think it would be ok to remove #27373 as a dependency.  Because although it is a known bug, it's not entirely new after all as I explained in comment:73:ticket:27373.  In short, there are other cases where we should require re-running `configure` after installing new packages, but don't, resulting in an incorrect configuration.\n\nIt should still be fixed ASAP but I think for now it's good enough to say \"don't do that\".",
    "created_at": "2019-04-11T10:34:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379248",
    "user": "https://github.com/embray"
}
```

Thanks--I still think it would be ok to remove #27373 as a dependency.  Because although it is a known bug, it's not entirely new after all as I explained in comment:73:ticket:27373.  In short, there are other cases where we should require re-running `configure` after installing new packages, but don't, resulting in an incorrect configuration.

It should still be fixed ASAP but I think for now it's good enough to say "don't do that".



---

archive/issue_comments_379249.json:
```json
{
    "body": "OK, let's get it merged then!",
    "created_at": "2019-04-11T11:51:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379249",
    "user": "https://github.com/dimpase"
}
```

OK, let's get it merged then!



---

archive/issue_comments_379250.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-04-13T21:03:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379250",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_379251.json:
```json
{
    "body": "Singular doesn't build for me...",
    "created_at": "2019-04-13T21:03:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379251",
    "user": "https://github.com/vbraun"
}
```

Singular doesn't build for me...



---

archive/issue_comments_379252.json:
```json
{
    "body": "Logs please.\n\nDo you have gmp installed in a weird place?\n\nYou might need to start from `make distclean`, to be on the safe side.",
    "created_at": "2019-04-13T21:08:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379252",
    "user": "https://github.com/dimpase"
}
```

Logs please.

Do you have gmp installed in a weird place?

You might need to start from `make distclean`, to be on the safe side.



---

archive/issue_comments_379253.json:
```json
{
    "body": "and, needless to say, this needs a run of `./bootstrap`.\n\nwhat we might have forgotten is to bump up versions of gmp and mpir, to force re-building of appropriate packages, our poor man dependency resolution.\nI never understood why spkg-install and spkg-configure.m4 are not listed as package dependencies in automatically generated targets for packages.",
    "created_at": "2019-04-14T07:18:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379253",
    "user": "https://github.com/dimpase"
}
```

and, needless to say, this needs a run of `./bootstrap`.

what we might have forgotten is to bump up versions of gmp and mpir, to force re-building of appropriate packages, our poor man dependency resolution.
I never understood why spkg-install and spkg-configure.m4 are not listed as package dependencies in automatically generated targets for packages.



---

archive/issue_comments_379254.json:
```json
{
    "body": "Replying to [comment:95 vbraun]:\n> Singular doesn't build for me...\n\nThis that building from scratch, or what?  Note that the configure script should be regenerated or lots of things won'g build properly due to the changes to `sage-env-config.in`.",
    "created_at": "2019-04-15T16:12:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379254",
    "user": "https://github.com/embray"
}
```

Replying to [comment:95 vbraun]:
> Singular doesn't build for me...

This that building from scratch, or what?  Note that the configure script should be regenerated or lots of things won'g build properly due to the changes to `sage-env-config.in`.



---

archive/issue_comments_379255.json:
```json
{
    "body": "Set assignee to @vbraun.",
    "created_at": "2019-04-15T16:12:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379255",
    "user": "https://github.com/embray"
}
```

Set assignee to @vbraun.



---

archive/issue_comments_379256.json:
```json
{
    "body": "Changing status from needs_work to needs_info.",
    "created_at": "2019-04-15T16:12:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379256",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_info.



---

archive/issue_comments_379257.json:
```json
{
    "body": "If thats the case then a new confball is needed on the branch...",
    "created_at": "2019-04-16T09:12:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379257",
    "user": "https://github.com/vbraun"
}
```

If thats the case then a new confball is needed on the branch...



---

archive/issue_comments_379258.json:
```json
{
    "body": "Changing status from needs_info to positive_review.",
    "created_at": "2019-04-16T13:42:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379258",
    "user": "https://github.com/embray"
}
```

Changing status from needs_info to positive_review.



---

archive/issue_comments_379259.json:
```json
{
    "body": "Attachment [configure-314.tar.gz](tarball://root/attachments/some-uuid/ticket27212/configure-314.tar.gz) by @embray created at 2019-04-16 13:42:39\n\nNew configure tarball attached and linked in the description.\n\nNice number on that one =)",
    "created_at": "2019-04-16T13:42:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379259",
    "user": "https://github.com/embray"
}
```

Attachment [configure-314.tar.gz](tarball://root/attachments/some-uuid/ticket27212/configure-314.tar.gz) by @embray created at 2019-04-16 13:42:39

New configure tarball attached and linked in the description.

Nice number on that one =)



---

archive/issue_comments_379260.json:
```json
{
    "body": "This is a sub-optimal workflow, as ticket authors have little control over the moment the ticket comes up for merging, and thus it's not unlikely that the configure tarball would be out of sync, if there is more than one stream of tickets that touch configure.\n\nAnd we do have quite a few of them on #27330.",
    "created_at": "2019-04-16T19:59:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379260",
    "user": "https://github.com/dimpase"
}
```

This is a sub-optimal workflow, as ticket authors have little control over the moment the ticket comes up for merging, and thus it's not unlikely that the configure tarball would be out of sync, if there is more than one stream of tickets that touch configure.

And we do have quite a few of them on #27330.



---

archive/issue_comments_379261.json:
```json
{
    "body": "Indeed; I've complained about this as well.  A better solution isn't immediately obvious to me other than to make sure that all of the buildbot workers have up-to-date autotools installed and run `./bootstrap` as part of the normal build procedure.  I think that *should* be done but it's not always trivial I guess (e.g. on OSX?).\n\nIn the meantime I'm happy to follow the workflow as it is; it could just be confusing for all the tickets attached to #27330.  Maybe we can do something like bundle multiple of those tickets to be merged together once several of them have been otherwise positively reviewed individually.",
    "created_at": "2019-04-17T13:38:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379261",
    "user": "https://github.com/embray"
}
```

Indeed; I've complained about this as well.  A better solution isn't immediately obvious to me other than to make sure that all of the buildbot workers have up-to-date autotools installed and run `./bootstrap` as part of the normal build procedure.  I think that *should* be done but it's not always trivial I guess (e.g. on OSX?).

In the meantime I'm happy to follow the workflow as it is; it could just be confusing for all the tickets attached to #27330.  Maybe we can do something like bundle multiple of those tickets to be merged together once several of them have been otherwise positively reviewed individually.



---

archive/issue_comments_379262.json:
```json
{
    "body": "it is trivial to install autotools on OSX using Homebrew.",
    "created_at": "2019-04-17T13:44:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379262",
    "user": "https://github.com/dimpase"
}
```

it is trivial to install autotools on OSX using Homebrew.



---

archive/issue_comments_379263.json:
```json
{
    "body": "The one and only OSX buildbot worker is for testing that Sage installs on a as-vanilla-as-possible OSX install...",
    "created_at": "2019-04-17T17:32:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379263",
    "user": "https://github.com/vbraun"
}
```

The one and only OSX buildbot worker is for testing that Sage installs on a as-vanilla-as-possible OSX install...



---

archive/issue_comments_379264.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-04-17T17:38:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379264",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_379265.json:
```json
{
    "body": "configure-314.tar.gz is for 8.8.beta2, as always you are supposed to bump the version if you change the file.",
    "created_at": "2019-04-17T17:38:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379265",
    "user": "https://github.com/vbraun"
}
```

configure-314.tar.gz is for 8.8.beta2, as always you are supposed to bump the version if you change the file.



---

archive/issue_comments_379266.json:
```json
{
    "body": "I have no idea where this 314 can be found. If you update from source then upstream/configure-`xyz`.tar.gz might not correspond to anything at all, may not even exist.\n\nE.g. my different sage builds, all based on 8.8.beta2, have different from 314 `xyz`.\n\nI am tired of doing manually things that must have been automated 10 years ago.\nWhy is that `xyz` there at all?! The build is run by make, which is intelligent enough to know if a file has been updated, you know...",
    "created_at": "2019-04-17T19:13:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379266",
    "user": "https://github.com/dimpase"
}
```

I have no idea where this 314 can be found. If you update from source then upstream/configure-`xyz`.tar.gz might not correspond to anything at all, may not even exist.

E.g. my different sage builds, all based on 8.8.beta2, have different from 314 `xyz`.

I am tired of doing manually things that must have been automated 10 years ago.
Why is that `xyz` there at all?! The build is run by make, which is intelligent enough to know if a file has been updated, you know...



---

archive/issue_comments_379267.json:
```json
{
    "body": "Actually, 8.8.beta2 has already configure-315.tar.gz. The version number is in build/pkgs/configure/package-version.txt, like all tarballs.\n\nTo make a new confball:\n* merge in the latest beta (so you have the most up-to-date  build/pkgs/configure/package-version.txt)\n* run `./bootstrap -s -i`\n* Commit the new version and checksum, and upload the confball",
    "created_at": "2019-04-17T22:25:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379267",
    "user": "https://github.com/vbraun"
}
```

Actually, 8.8.beta2 has already configure-315.tar.gz. The version number is in build/pkgs/configure/package-version.txt, like all tarballs.

To make a new confball:
* merge in the latest beta (so you have the most up-to-date  build/pkgs/configure/package-version.txt)
* run `./bootstrap -s -i`
* Commit the new version and checksum, and upload the confball



---

archive/issue_comments_379268.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-04-18T07:47:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379268",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_379269.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-04-18T07:49:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379269",
    "user": "https://github.com/dimpase"
}
```

New commits:



---

archive/issue_comments_379270.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2019-04-18T07:49:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379270",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_379271.json:
```json
{
    "body": "rebased over 8.8.beta2, new configure tarball",
    "created_at": "2019-04-18T07:52:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379271",
    "user": "https://github.com/dimpase"
}
```

rebased over 8.8.beta2, new configure tarball



---

archive/issue_comments_379272.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-04-18T09:19:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379272",
    "user": "https://github.com/dimpase"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_379273.json:
```json
{
    "body": "and now this fails on OSX 10.14 with external gmp, specifically, flint does not build:\n\n```\n          make build/interfaces/NTL-interface.lo; \\\n          clang++ -std=gnu++11 -fno-common -pedantic -Wall -O2 -funroll-loops -g -mpopcnt   -shared -install_name /Users/administrator/\npy/sage/local/lib/libflint-13.5.2.dylib -compatibility_version 13.5 -current_version 13.5.2 -Wl,-rpath,/usr/local/lib -Wl,-rpath,/Users\n/administrator/py/sage/local/lib build/interfaces/NTL-interface.lo  build/printf.lo  build/fprintf.lo  build/sprintf.lo  build/scanf.lo\n  build/fscanf.lo  build/sscanf.lo  build/clz_tab.lo  build/memory_manager.lo  build/version.lo  build/profiler.lo  build/thread_support.lo  build/ulong_extras.lo  build/long_extras.lo  build/perm.lo  build/fmpz.lo  build/fmpz_vec.lo  build/fmpz_poly.lo  build/fmpq_poly.lo  build/fmpz_mat.lo  build/fmpz_lll.lo  build/mpfr_vec.lo  build/mpfr_mat.lo  build/mpf_vec.lo  build/mpf_mat.lo  build/nmod_vec.lo  build/nmod_poly.lo  build/nmod_poly_factor.lo  build/arith.lo  build/mpn_extras.lo  build/nmod_mat.lo  build/fmpq.lo  build/fmpq_vec.lo  build/fmpq_mat.lo  build/padic.lo  build/fmpz_poly_q.lo  build/fmpz_poly_mat.lo  build/nmod_poly_mat.lo  build/fmpz_mod_poly.lo  build/fmpz_mod_poly_factor.lo  build/fmpz_factor.lo  build/fmpz_poly_factor.lo  build/fft.lo  build/qsieve.lo  build/double_extras.lo  build/d_vec.lo  build/d_mat.lo  build/padic_poly.lo  build/padic_mat.lo  build/qadic.lo  build/fq.lo  build/fq_vec.lo  build/fq_mat.lo  build/fq_poly.lo  build/fq_poly_factor.lo  build/fq_nmod.lo  build/fq_nmod_vec.lo  build/fq_nmod_mat.lo  build/fq_nmod_poly.lo  build/fq_nmod_poly_factor.lo  build/fq_zech.lo  build/fq_zech_vec.lo  build/fq_zech_mat.lo  build/fq_zech_poly.lo  build/fq_zech_poly_factor.lo  -o libflint-13.5.2.dylib -L/Users/administrator/py/sage/local/lib -Wl,-rpath,/Users/administrator/py/sage/local/lib  -L/Users/administrator/py/sage/local/var/tmp/sage/build/flint-2.5.2.p4/src -L/usr/local/lib -L/Users/administrator/py/sage/local/lib -L/Users/administrator/py/sage/local/lib -lmpfr -lgmp -lm -lntl -lpthread ; \\\n        fi\nclang++ -std=gnu++11 -fPIC -fno-common -pedantic -Wall -O2 -funroll-loops -g -mpopcnt  -I/Users/administrator/py/sage/local/var/tmp/sage/build/flint-2.5.2.p4/src -I/usr/local/include -I/Users/administrator/py/sage/local/include -I/Users/administrator/py/sage/local/include -c interfaces/NTL-interface.cpp -o build/interfaces/NTL-interface.lo\nld: illegal thread local variable reference to regular symbol __ZN3NTL8ZZ_pInfoE for architecture x86_64\nclang: error: linker command failed with exit code 1 (use -v to see invocation)\nmake[4]: *** [libflint-13.5.2.dylib] Error 1\n```\n\nnote that mpfr and ntl, its dependencies build just fine with SAGE_CHECK=yes, so that's something in flint C++ interface that is broken...",
    "created_at": "2019-04-18T09:19:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379273",
    "user": "https://github.com/dimpase"
}
```

and now this fails on OSX 10.14 with external gmp, specifically, flint does not build:

```
          make build/interfaces/NTL-interface.lo; \
          clang++ -std=gnu++11 -fno-common -pedantic -Wall -O2 -funroll-loops -g -mpopcnt   -shared -install_name /Users/administrator/
py/sage/local/lib/libflint-13.5.2.dylib -compatibility_version 13.5 -current_version 13.5.2 -Wl,-rpath,/usr/local/lib -Wl,-rpath,/Users
/administrator/py/sage/local/lib build/interfaces/NTL-interface.lo  build/printf.lo  build/fprintf.lo  build/sprintf.lo  build/scanf.lo
  build/fscanf.lo  build/sscanf.lo  build/clz_tab.lo  build/memory_manager.lo  build/version.lo  build/profiler.lo  build/thread_support.lo  build/ulong_extras.lo  build/long_extras.lo  build/perm.lo  build/fmpz.lo  build/fmpz_vec.lo  build/fmpz_poly.lo  build/fmpq_poly.lo  build/fmpz_mat.lo  build/fmpz_lll.lo  build/mpfr_vec.lo  build/mpfr_mat.lo  build/mpf_vec.lo  build/mpf_mat.lo  build/nmod_vec.lo  build/nmod_poly.lo  build/nmod_poly_factor.lo  build/arith.lo  build/mpn_extras.lo  build/nmod_mat.lo  build/fmpq.lo  build/fmpq_vec.lo  build/fmpq_mat.lo  build/padic.lo  build/fmpz_poly_q.lo  build/fmpz_poly_mat.lo  build/nmod_poly_mat.lo  build/fmpz_mod_poly.lo  build/fmpz_mod_poly_factor.lo  build/fmpz_factor.lo  build/fmpz_poly_factor.lo  build/fft.lo  build/qsieve.lo  build/double_extras.lo  build/d_vec.lo  build/d_mat.lo  build/padic_poly.lo  build/padic_mat.lo  build/qadic.lo  build/fq.lo  build/fq_vec.lo  build/fq_mat.lo  build/fq_poly.lo  build/fq_poly_factor.lo  build/fq_nmod.lo  build/fq_nmod_vec.lo  build/fq_nmod_mat.lo  build/fq_nmod_poly.lo  build/fq_nmod_poly_factor.lo  build/fq_zech.lo  build/fq_zech_vec.lo  build/fq_zech_mat.lo  build/fq_zech_poly.lo  build/fq_zech_poly_factor.lo  -o libflint-13.5.2.dylib -L/Users/administrator/py/sage/local/lib -Wl,-rpath,/Users/administrator/py/sage/local/lib  -L/Users/administrator/py/sage/local/var/tmp/sage/build/flint-2.5.2.p4/src -L/usr/local/lib -L/Users/administrator/py/sage/local/lib -L/Users/administrator/py/sage/local/lib -lmpfr -lgmp -lm -lntl -lpthread ; \
        fi
clang++ -std=gnu++11 -fPIC -fno-common -pedantic -Wall -O2 -funroll-loops -g -mpopcnt  -I/Users/administrator/py/sage/local/var/tmp/sage/build/flint-2.5.2.p4/src -I/usr/local/include -I/Users/administrator/py/sage/local/include -I/Users/administrator/py/sage/local/include -c interfaces/NTL-interface.cpp -o build/interfaces/NTL-interface.lo
ld: illegal thread local variable reference to regular symbol __ZN3NTL8ZZ_pInfoE for architecture x86_64
clang: error: linker command failed with exit code 1 (use -v to see invocation)
make[4]: *** [libflint-13.5.2.dylib] Error 1
```

note that mpfr and ntl, its dependencies build just fine with SAGE_CHECK=yes, so that's something in flint C++ interface that is broken...



---

archive/issue_comments_379274.json:
```json
{
    "body": "I suppose this is caused by the very recent (Apr 6) NTL update.",
    "created_at": "2019-04-18T09:28:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379274",
    "user": "https://github.com/dimpase"
}
```

I suppose this is caused by the very recent (Apr 6) NTL update.



---

archive/issue_comments_379275.json:
```json
{
    "body": "No, it must be either lack of testing on OSX 10.14 (I tested on 10.13 before), or new clang in Xcode:\n\n```\n$ clang++ -v\nApple LLVM version 10.0.1 (clang-1001.0.46.3)\nTarget: x86_64-apple-darwin18.5.0\nThread model: posix\nInstalledDir: /Library/Developer/CommandLineTools/usr/bin\n```\n",
    "created_at": "2019-04-18T09:54:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379275",
    "user": "https://github.com/dimpase"
}
```

No, it must be either lack of testing on OSX 10.14 (I tested on 10.13 before), or new clang in Xcode:

```
$ clang++ -v
Apple LLVM version 10.0.1 (clang-1001.0.46.3)
Target: x86_64-apple-darwin18.5.0
Thread model: posix
InstalledDir: /Library/Developer/CommandLineTools/usr/bin
```




---

archive/issue_comments_379276.json:
```json
{
    "body": "Replying to [comment:105 vbraun]:\n> The one and only OSX buildbot worker is for testing that Sage installs on a as-vanilla-as-possible OSX install... \n\nWell, if you like I can install autotools on your OSX bot just from sources. (I recall doing that on OSX 10.12, it should still be possible on 10.14).\nThis would be vanilla enough then, still...",
    "created_at": "2019-04-18T10:44:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379276",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:105 vbraun]:
> The one and only OSX buildbot worker is for testing that Sage installs on a as-vanilla-as-possible OSX install... 

Well, if you like I can install autotools on your OSX bot just from sources. (I recall doing that on OSX 10.12, it should still be possible on 10.14).
This would be vanilla enough then, still...



---

archive/issue_comments_379277.json:
```json
{
    "body": "Replying to [comment:114 dimpase]:\n> No, it must be either lack of testing on OSX 10.14 (I tested on 10.13 before), or new clang in Xcode:\n> {{{\n> $ clang++ -v\n> Apple LLVM version 10.0.1 (clang-1001.0.46.3)\n> Target: x86_64-apple-darwin18.5.0\n> Thread model: posix\n> InstalledDir: /Library/Developer/CommandLineTools/usr/bin\n> }}}\n\nThe problem seems to be caused by `-std=gnu++11` option, see #25532#comment:88",
    "created_at": "2019-04-18T11:03:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379277",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:114 dimpase]:
> No, it must be either lack of testing on OSX 10.14 (I tested on 10.13 before), or new clang in Xcode:
> {{{
> $ clang++ -v
> Apple LLVM version 10.0.1 (clang-1001.0.46.3)
> Target: x86_64-apple-darwin18.5.0
> Thread model: posix
> InstalledDir: /Library/Developer/CommandLineTools/usr/bin
> }}}

The problem seems to be caused by `-std=gnu++11` option, see #25532#comment:88



---

archive/issue_comments_379278.json:
```json
{
    "body": "facepalm.... That was just a library clash - I did have libntl installed in /usr/local, and this seems to be deadly on OSX...",
    "created_at": "2019-04-18T18:37:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379278",
    "user": "https://github.com/dimpase"
}
```

facepalm.... That was just a library clash - I did have libntl installed in /usr/local, and this seems to be deadly on OSX...



---

archive/issue_comments_379279.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2019-04-18T18:37:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379279",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_379280.json:
```json
{
    "body": "Replying to [comment:115 dimpase]:\n> Well, if you like I can install autotools on your OSX bot just from sources. (I recall doing that on OSX 10.12, it should still be possible on 10.14).\n\nAgain, unless we make autotools a prerequisite we need a way to verify that Sage builds on OSX without autotools installed...",
    "created_at": "2019-04-18T20:02:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379280",
    "user": "https://github.com/vbraun"
}
```

Replying to [comment:115 dimpase]:
> Well, if you like I can install autotools on your OSX bot just from sources. (I recall doing that on OSX 10.12, it should still be possible on 10.14).

Again, unless we make autotools a prerequisite we need a way to verify that Sage builds on OSX without autotools installed...



---

archive/issue_comments_379281.json:
```json
{
    "body": "Replying to [comment:118 vbraun]:\n> Replying to [comment:115 dimpase]:\n> > Well, if you like I can install autotools on your OSX bot just from sources. (I recall doing that on OSX 10.12, it should still be possible on 10.14).\n> \n> Again, unless we make autotools a prerequisite we need a way to verify that Sage builds on OSX without autotools installed...\n\nDo we have Linux buildbots without autotools installed?\n\nAnyhow, one can have autotools installed in a non-standard location only buildbot knows, so that it can run ./bootstrap, and then it's as if there are not present.\n\nIt's hard for me to understand the problem without knowing how exactly a release is made.\n(if be any chance you are in Berlin, you can show me - I'm here until 21st Apr).",
    "created_at": "2019-04-18T20:17:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379281",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:118 vbraun]:
> Replying to [comment:115 dimpase]:
> > Well, if you like I can install autotools on your OSX bot just from sources. (I recall doing that on OSX 10.12, it should still be possible on 10.14).
> 
> Again, unless we make autotools a prerequisite we need a way to verify that Sage builds on OSX without autotools installed...

Do we have Linux buildbots without autotools installed?

Anyhow, one can have autotools installed in a non-standard location only buildbot knows, so that it can run ./bootstrap, and then it's as if there are not present.

It's hard for me to understand the problem without knowing how exactly a release is made.
(if be any chance you are in Berlin, you can show me - I'm here until 21st Apr).



---

archive/issue_events_067567.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-04-18T22:21:42Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26975#event-67567"
}
```



---

archive/issue_comments_379282.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-04-18T22:21:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379282",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_379283.json:
```json
{
    "body": "No matter how you slice it, either the buildbot has access to autotools OR it tests that you can build without autotools. The only safe way to avoid generating a confball by hand is to have some automatic system, e.g. whenever I submit a new buildbot job. That requires some work to avoid version clashes when I back out commits. Truth be told, changes to the configure in Sage are pretty rare so this issue does not come up very often.\n\nI'm in Berlin, hit me up when you have some time. I'm located in the East (Elsenstrasse).",
    "created_at": "2019-04-18T22:33:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379283",
    "user": "https://github.com/vbraun"
}
```

No matter how you slice it, either the buildbot has access to autotools OR it tests that you can build without autotools. The only safe way to avoid generating a confball by hand is to have some automatic system, e.g. whenever I submit a new buildbot job. That requires some work to avoid version clashes when I back out commits. Truth be told, changes to the configure in Sage are pretty rare so this issue does not come up very often.

I'm in Berlin, hit me up when you have some time. I'm located in the East (Elsenstrasse).



---

archive/issue_comments_379284.json:
```json
{
    "body": "Replying to [comment:117 dimpase]:\n> facepalm.... That was just a library clash - I did have libntl installed in /usr/local, and this seems to be deadly on OSX...\n\nI have had similar problems--not necessarily with NTL--but with other packages where having a copy of the development package already installed on my system created difficult to avoid clashes when trying to build some Sage SPKGs.  See e.g. #22768.  In that case it's more due to bugginess with Python's module build system, but I can envision similar problems in other build systems that make too many assumptions about your paths in some context.",
    "created_at": "2019-04-19T14:21:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379284",
    "user": "https://github.com/embray"
}
```

Replying to [comment:117 dimpase]:
> facepalm.... That was just a library clash - I did have libntl installed in /usr/local, and this seems to be deadly on OSX...

I have had similar problems--not necessarily with NTL--but with other packages where having a copy of the development package already installed on my system created difficult to avoid clashes when trying to build some Sage SPKGs.  See e.g. #22768.  In that case it's more due to bugginess with Python's module build system, but I can envision similar problems in other build systems that make too many assumptions about your paths in some context.



---

archive/issue_comments_379285.json:
```json
{
    "body": "Replying to [comment:121 vbraun]:\n>  Truth be told, changes to the configure in Sage are pretty rare \n\nI have a dozen tickets open that do change configure, see #27330.\nFor the purpose of testing the configure spkg versioning, today I attached\nconfigure tarballs to 3 of them:\n#27258, #27265, #27186. No matter in which order they would be merged, I'd need to re-do these tarballs for all but one, you know. This is not exactly entertaining...",
    "created_at": "2019-04-19T19:26:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379285",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:121 vbraun]:
>  Truth be told, changes to the configure in Sage are pretty rare 

I have a dozen tickets open that do change configure, see #27330.
For the purpose of testing the configure spkg versioning, today I attached
configure tarballs to 3 of them:
#27258, #27265, #27186. No matter in which order they would be merged, I'd need to re-do these tarballs for all but one, you know. This is not exactly entertaining...



---

archive/issue_comments_379286.json:
```json
{
    "body": "Breakage: #27751",
    "created_at": "2019-04-30T13:10:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26975#issuecomment-379286",
    "user": "https://github.com/jdemeyer"
}
```

Breakage: #27751
