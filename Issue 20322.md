# Issue 20322: InteractiveLPProblem, dictionaries: add_constraint / add_row methods

Issue created by migration from Trac.

Original creator: mkoeppe

Original creation time: 2016-05-04 22:20:22

CC:  novoselt pjxiao

This ticket adds `add_constraint` and `add_row` methods. 
Following the suggestion at 
http://trac.sagemath.org/ticket/18805#comment:27
these methods create new problems / dictionaries, leaving the original ones unmodified.

(Split out from the larger ticket #18805.)



---

Comment by mkoeppe created at 2016-05-05 00:08:14

New commits:


---

Comment by mkoeppe created at 2016-05-05 00:08:14

Changing status from new to needs_review.


---

Comment by git created at 2016-05-08 01:05:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-05-08 01:12:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by novoselt created at 2016-05-21 22:16:17

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-05-23 15:54:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2016-05-23 15:56:58

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2016-05-23 15:57:19

Rebased on 7.3.beta0


---

Comment by mkoeppe created at 2016-06-02 13:29:03

ping?


---

Comment by novoselt created at 2016-06-10 04:23:47

1. "a 1 by n matrix of the new constraint coefficients" is a bit weird, especially since examples show using a list rather than a matrix. I'd write just "coefficients of the new constraint"
2. `new_row` does not reflect very well the meaning, how about `coefficients`?..
3. I think the method for adding constraints should not do input check that can be done by the problem constructor - it will reduce code duplication and lead to more uniform error messages.
4. When constructing a new problem, as much of the old one as possible should be preserved. The current version does not keep even the type of the problem!!!
5. It should not be necessary to explicitly name a new slack variable.
6. It would be better not to construct polynomial rings where variables leave directly - leave it to the constructor of the problem in case we want to do something else later.
7. I don't think that `add_row` should be supported by abstract dictionaries - for the current revised dictionaries I'd say it is confusing what does it even mean. And the convoluted code to achieve it agrees with me ;-) Rather I'd suggest having it for regular dictionaries (perhaps `add_relation` would be a better name). For the revised ones `add_constraint`, the same as for the problem with more or less the same parameters, would make more sense - since revised dictionaries are linked to the problem, they can construct the new one and then based on it construct a new suitable dictionary.


---

Comment by novoselt created at 2016-06-10 04:23:47

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2016-06-10 05:10:30

Just a quick reply to point 7:

Replying to [comment:10 novoselt]:
> 7. I don't think that `add_row` should be supported by abstract dictionaries - for the current revised dictionaries I'd say it is confusing what does it even mean. And the convoluted code to achieve it agrees with me ;-) Rather I'd suggest having it for regular dictionaries (perhaps `add_relation` would be a better name). For the revised ones `add_constraint`, the same as for the problem with more or less the same parameters, would make more sense - since revised dictionaries are linked to the problem, they can construct the new one and then based on it construct a new suitable dictionary.

No, no, it's crucial that `add_row` is supported by abstract dictionaries. 
The whole point is to have a method that adds a row to the dictionary, no matter how the dictionary is internally represented. This is the operation needed by tableau cutting plane procedures.
In the revised dictionary, one needs to do this kind of transformation to compute the new row of the problem, which gives the desired tableau row. (This is how tableau cutting planes are actually implemented in numerical solvers.)


---

Comment by mkoeppe created at 2016-06-10 16:18:35

Replying to [comment:10 novoselt]:
> 5. It should not be necessary to explicitly name a new slack variable.

Agreed, this argument should be optional; and a name should be generated if it is not provided.


---

Comment by mkoeppe created at 2016-06-10 16:25:30

Replying to [comment:10 novoselt]:
> 6. It would be better not to construct polynomial rings where variables leave directly - leave it to the constructor of the problem in case we want to do something else later.
What do you mean by "where variables leave"?


---

Comment by git created at 2016-06-12 00:08:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pjxiao created at 2016-06-12 00:17:22

I fixed the problems your comments 1, 2, 4, and 5. 

Replying to [comment:10 novoselt]:
> 1. "a 1 by n matrix of the new constraint coefficients" is a bit weird, especially since examples show using a list rather than a matrix. I'd write just "coefficients of the new constraint"
> 2. `new_row` does not reflect very well the meaning, how about `coefficients`?..
> ...
> 4. When constructing a new problem, as much of the old one as possible should be preserved. The current version does not keep even the type of the problem!!!
> 5. It should not be necessary to explicitly name a new slack variable.


Please take a look at the last three commits listed in comment:15.

Thanks!


---

Comment by novoselt created at 2016-06-12 05:07:28

Replying to [comment:11 mkoeppe]:
> No, no, it's crucial that `add_row` is supported by abstract dictionaries. 
> The whole point is to have a method that adds a row to the dictionary, no matter how the dictionary is internally represented. This is the operation needed by tableau cutting plane procedures.
> In the revised dictionary, one needs to do this kind of transformation to compute the new row of the problem, which gives the desired tableau row. (This is how tableau cutting planes are actually implemented in numerical solvers.)

OK, let's have it, but I still find the name confusing - can it be `add_relation`? While for the revised dictionaries it will add a row to the only of the two tables that can get an extra row, data there will not be the provided coefficients. Hence I'd like something more conceptual than layout reference.


---

Comment by novoselt created at 2016-06-12 05:08:18

Replying to [comment:13 mkoeppe]:
> Replying to [comment:10 novoselt]:
> > 6. It would be better not to construct polynomial rings where variables leave directly - leave it to the constructor of the problem in case we want to do something else later.
> What do you mean by "where variables leave"?

Sorry, I meant "where variables live" - I am not a native speaker ;-)


---

Comment by novoselt created at 2016-06-12 05:14:29

I can no longer see cumulative changes, please rebase!


---

Comment by mkoeppe created at 2016-06-12 05:55:57

rebased on 7.2.beta3
----
New commits:


---

Comment by mkoeppe created at 2016-06-12 06:10:21

Replying to [comment:17 novoselt]:
> Replying to [comment:11 mkoeppe]:
> > No, no, it's crucial that `add_row` is supported by abstract dictionaries. 
> > The whole point is to have a method that adds a row to the dictionary, no matter how the dictionary is internally represented. This is the operation needed by tableau cutting plane procedures.
> > In the revised dictionary, one needs to do this kind of transformation to compute the new row of the problem, which gives the desired tableau row. (This is how tableau cutting planes are actually implemented in numerical solvers.)
> 
> OK, let's have it, but I still find the name confusing - can it be `add_relation`? While for the revised dictionaries it will add a row to the only of the two tables that can get an extra row, data there will not be the provided coefficients. Hence I'd like something more conceptual than layout reference.

"add_relation" wouldn't express the operation well; because we're not just adding a relation but also a new basic variable. 
I've never heard anyone call this operation other than "adding a row" (whether it's a textbook dictionary or a revised dictionary). 
Also note that "row" matches the method `row_coefficients`.


---

Comment by pjxiao created at 2016-06-13 17:01:13

New commits:


---

Comment by pjxiao created at 2016-06-18 17:13:18

New commits:


---

Comment by pjxiao created at 2016-06-18 17:13:18

Changing status from needs_work to needs_review.


---

Comment by novoselt created at 2016-06-20 02:40:32

7 is retracted, 3 and 6 still stand. And I wanted to look closer and do some changes but was not able to checkout due to trac problems...


---

Comment by mkoeppe created at 2016-06-24 21:56:40

I've made some changes that address points 3 and 6.
Also rebased on latest beta.
Ready for review.
----
New commits:


---

Comment by novoselt created at 2016-06-26 05:39:29

Going carefully doing some tweaks, not done yet, but have to stop for the moment.

- I thought it is clear that if `new_` prefix is not great for one argument, it is not great for another ;-)
- There were still some data of problems not preserved, I think everything that can be preserved should be.
- `a number of the constant term for the new row`?..
- Explicit hard-coded ring `LPDictionary(matrix(QQ, A)`?!?!?!
----
New commits:


---

Comment by mkoeppe created at 2016-06-26 21:31:40

Thanks for fixing these.


---

Comment by git created at 2016-07-19 03:17:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by novoselt created at 2016-07-19 03:27:25

With all due respect the old code for `add_row` for revised dictionaries was incomprehensible and extremely unnecessary complicated.

The current code will probably break on a dictionary for an auxiliary problem - is there any point in properly supporting these or there is never a need to add rows there and we can just throw an exception?

Documentation of `add_row` and `row_coefficients` needs some clarification with respect to signs (since I got confused and presumably some poor students may get as well). How about something like `These are the coefficients with which nonbasic variables are subtracted in the relation of this basic variable.` ?


---

Comment by git created at 2016-07-20 00:34:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by novoselt created at 2016-07-20 00:36:57

After some more thinking, it is perfectly fine to add rows to auxiliary problems with this code, but there is a constraint on input.

If you are OK with my changes, set to positive review.


---

Comment by pjxiao created at 2016-07-22 00:55:02

Thank you for your work! They look fine.


---

Comment by pjxiao created at 2016-07-22 00:55:02

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-07-23 18:41:03

Resolution: fixed
