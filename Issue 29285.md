# Issue 29285: layout_planar fails on disconnected graphs

Issue created by migration from https://trac.sagemath.org/ticket/29522

Original creator: @jfraymond

Original creation time: 2020-04-17 17:02:03

Keywords: layout planar embedding connected triangulate

`layout_planar` fails on disconnected graphs


```
sage: g = Graph(2)
sage: g.layout_planar()
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-5-5590605c1dc8> in <module>()
----> 1 g.layout_planar()

/home/jf/sage/local/lib/python3.7/site-packages/sage/graphs/generic_graph.py in layout_planar(self, set_embedding, on_embedding, external_face, test, circular, **options)
   5355                                  ''.format(external_face, self))
   5356 
-> 5357         _triangulate(G, G._embedding)
   5358 
   5359         # Optional error-checking

/home/jf/sage/local/lib/python3.7/site-packages/sage/graphs/schnyder.py in _triangulate(g, comb_emb)
     68     # first make sure that the graph has at least 3 vertices, and that it is connected
     69     if g.order() < 3:
---> 70         raise ValueError("A Graph with less than 3 vertices doesn't have any triangulation.")
     71     if not g.is_connected():
     72         raise NotImplementedError("_triangulate() only knows how to handle connected graphs.")

ValueError: A Graph with less than 3 vertices doesn't have any triangulation.
```


The error message is different when the graph has more vertices:

```
sage: g = Graph(3)
sage: g.layout_planar()
---------------------------------------------------------------------------
NotImplementedError                       Traceback (most recent call last)
<ipython-input-7-5590605c1dc8> in <module>()
----> 1 g.layout_planar()

/home/jf/sage/local/lib/python3.7/site-packages/sage/graphs/generic_graph.py in layout_planar(self, set_embedding, on_embedding, external_face, test, circular, **options)
   5355                                  ''.format(external_face, self))
   5356 
-> 5357         _triangulate(G, G._embedding)
   5358 
   5359         # Optional error-checking

/home/jf/sage/local/lib/python3.7/site-packages/sage/graphs/schnyder.py in _triangulate(g, comb_emb)
     70         raise ValueError("A Graph with less than 3 vertices doesn't have any triangulation.")
     71     if not g.is_connected():
---> 72         raise NotImplementedError("_triangulate() only knows how to handle connected graphs.")
     73 
     74     # At this point we know that the graph is connected, has at least 3

NotImplementedError: _triangulate() only knows how to handle connected graphs.
```



---

Comment by dcoudert created at 2020-04-18 10:06:36

Changing status from new to needs_review.


---

Comment by dcoudert created at 2020-04-18 10:06:36

I changed the order of the first tests in method `_triangulate` of `schnyder.py`.
----
New commits:


---

Comment by git created at 2020-04-18 21:13:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @jfraymond created at 2020-04-18 21:21:57

I changed the code of the function dealing with disconnected graphs for the spring layout (`spring_layout_fast_split`) so that it can work with any layout function.
The new function dealing with disconnected graphs and arbitrary layout functions is `layout_split`.
The `layout_planar` function now calls it when the graph is not connected.


---

Comment by @jfraymond created at 2020-04-19 08:49:53

Changing status from needs_review to needs_work.


---

Comment by @jfraymond created at 2020-04-19 08:49:53

There are still some issues with my code. Working on it.


---

Comment by git created at 2020-04-19 10:27:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @jfraymond created at 2020-04-19 10:33:45

It should be good now. I also fixed the following bug of `layout_planar`:

```
H = graphs.LadderGraph(4)
em = {0:[1,4], 4:[0,5], 1:[5,2,0], 5:[4,6,1], 2:[1,3,6], 6:[7,5,2], 3:[7,2], 7:[3,6]}
H.layout_planar(on_embedding=em)
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
<ipython-input-1-fa5d8c0766a4> in <module>()
      1 H = graphs.LadderGraph(Integer(4))
      2 em = {Integer(0):[Integer(1),Integer(4)], Integer(4):[Integer(0),Integer(5)], Integer(1):[Integer(5),Integer(2),Integer(0)], Integer(5):[Integer(4),Integer(6),Integer(1)], Integer(2):[Integer(1),Integer(3),Integer(6)], Integer(6):[Integer(7),Integer(5),Integer(2)], Integer(3):[Integer(7),Integer(2)], Integer(7):[Integer(3),Integer(6)]}
----> 3 H.layout_planar(on_embedding=em)

/home/jf/recherche/sage/local/lib/python3.7/site-packages/sage/graphs/generic_graph.py in layout_planar(self, set_embedding, on_embedding, external_face, test, circular, **options)
   5355                                  ''.format(external_face, self))
   5356 
-> 5357         _triangulate(G, G._embedding)
   5358 
   5359         # Optional error-checking

AttributeError: 'Graph' object has no attribute '_embedding'
```



---

Comment by @jfraymond created at 2020-04-19 10:33:45

Changing keywords from "layout planar embedding connected triangulate" to "layout planar embedding spring connected triangulate".


---

Comment by @jfraymond created at 2020-04-19 10:33:45

Changing status from needs_work to needs_review.


---

Comment by dcoudert created at 2020-04-19 12:27:39

I have 3 failing doctests

```
sage -t src/sage/graphs/schnyder.py
**********************************************************************
File "src/sage/graphs/schnyder.py", line 73, in sage.graphs.schnyder._triangulate
Failed example:
    g.layout_planar()
Expected:
    Traceback (most recent call last):
    ...
    NotImplementedError: _triangulate() only knows how to handle connected graphs
Got:
    {0: [0, 0], 1: [0, 1]}
**********************************************************************
File "src/sage/graphs/schnyder.py", line 78, in sage.graphs.schnyder._triangulate
Failed example:
    g.layout_planar()
Expected:
    Traceback (most recent call last):
    ...
    ValueError: a Graph with less than 3 vertices doesn't have any triangulation
Got:
    {0: [0, 0], 1: [0, 1]}
**********************************************************************
File "src/sage/graphs/schnyder.py", line 83, in sage.graphs.schnyder._triangulate
Failed example:
    g.layout_planar()
Expected:
    Traceback (most recent call last):
    ...
    NotImplementedError: _triangulate() only knows how to handle connected graphs
Got:
    {0: [0.5773502691896258, 0],
     1: [1.1547005383792517, 0],
     2: [1.7320508075688776, 0]}
```



---

Comment by git created at 2020-04-19 13:41:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @jfraymond created at 2020-04-19 13:46:01

My bad, I only ran tests for `generic_graph.py`.
Tests now pass on the whole `graphs` folder.


---

Comment by dcoudert created at 2020-04-19 17:46:07

The patchbot complains because you must add at least one doctest in `spring_layout_fast_split`.


---

Comment by git created at 2020-04-20 08:35:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @jfraymond created at 2020-04-20 08:41:57

I added the missing test and also fixed the error message when one asks for a planar layout of a non-planar graph. Previously:

```
sage: G = graphs.PetersenGraph()
sage: G.layout_planar()
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
<ipython-input-2-33ae44b2d717> in <module>()
----> 1 G.layout_planar()

/home/jf/recherche/sage/local/lib/python3.7/site-packages/sage/graphs/generic_graph.py in layout_planar(self, set_embedding, on_embedding, external_face, test, circular, **options)
   5355                                  ''.format(external_face, self))
   5356 
-> 5357         _triangulate(G, G._embedding)
   5358 
   5359         # Optional error-checking

AttributeError: 'Graph' object has no attribute '_embedding'
```

Now it raises a `ValueError`.


---

Comment by git created at 2020-04-20 09:03:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2020-04-20 09:05:29

I did a small pep8 commit.

For me this patch is good.


---

Comment by dcoudert created at 2020-04-20 09:05:29

Changing status from needs_review to positive_review.


---

Comment by @jfraymond created at 2020-04-20 09:53:25

Thanks!


---

Comment by vbraun created at 2020-04-23 22:32:40

Resolution: fixed
