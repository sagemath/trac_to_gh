# Issue 14793: Switch standard 2D plotting from `fast_float` to `fast_callable`

Issue created by migration from https://trac.sagemath.org/ticket/15030

Original creator: eviatarbach

Original creation time: 2013-08-10 09:39:20

Switch the `plot` command to use `fast_callable` instead of `fast_float`. This will make commands like `plot(abs(log(x)), x)` work.


---

Attachment

The patch changes `plot` to use `fast_callable`. It doesn't fix `contour_plot` or `plot3d`, for example, since that seems to be more involved, and should be fixed in a future patch.

Patchbot apply trac15030.patchâ€‹


---

Comment by eviatarbach created at 2013-08-10 10:04:48

Changing status from new to needs_review.


---

Comment by tkluck created at 2013-08-16 07:11:58

Thanks for looking into this important issue!

Did you check to see what the performance implications of your patch are? I assume that `fast_float` is faster than `fast_callable`, but that is not based on any data.


---

Comment by eviatarbach created at 2013-08-16 23:20:54

Yes, `fast_float` is slightly faster in my tests. However, I think the plan is to deprecate `fast_float` anyway; see #5572.


---

Comment by ppurka created at 2013-09-25 14:16:15

This doesn't really fix #13559. Do you have an idea why? I thought this change to `fast_callable` should take care of that other ticket too.


---

Comment by eviatarbach created at 2013-09-26 05:16:50

I think it's because `plot` (look at the function `generate_plot_points` in `sage.plot.plot`) generates float points, and


```
sage: exp(1e5r)
OverflowError: math range error
```


Maybe it should generate RealNumber points instead (I guess they should also be faster than floats for many functions, because MPFR functions are functions are fast)? In any case, that doesn't affect this ticket.


---

Comment by ppurka created at 2013-09-28 11:59:40

Hmm.. so, you are changing only the plots for symbolic expressions. This patch makes the symbolic expression plots about five times slower.

```
sage: timeit('plot(abs(log(x)), (x, -20, 20))') # with patch
25 loops, best of 3: 18.5 ms per loop

sage: timeit('plot(abs(log(x)), (x, -20, 20))') # without patch
125 loops, best of 3: 3.58 ms per loop
```


What do you think of the following change which introduces only a factor of two slowdown? The main problem seems to be that the fast float stuff does not handle complex numbers, and so we can explicitly specify the domain as CDF. I am not sure what is the default domain.

```
+        from sage.ext.fast_callable import fast_callable
+        from sage.rings.all import CDF
+        return fast_callable(self, vars=vars, expect_one_var=True,
+                             domain=CDF)
```


The timeit results are as follows:

```
sage: timeit('plot(abs(log(x)), (x, -20, 20))')
125 loops, best of 3: 6 ms per loop
```

A few doctests in `expression.pyx` fail, but they can be fixed (by changing their output).


---

Comment by rws created at 2014-04-03 09:12:49

Changing status from needs_review to needs_work.


---

Comment by rws created at 2014-04-13 16:09:19

Changing status from needs_work to positive_review.


---

Comment by rws created at 2014-04-13 16:09:19

Changing keywords from "" to "plot".


---

Comment by rws created at 2014-04-13 16:09:19


```
                                                           this patch    before
sage: timeit('plot(abs(log(x)), (x, -20, 20))')            11.4 ms         2.4
sage: timeit('circle((1,1), 1) + plot(x^2, (x,0,5))')       2.7 ms         2.3
sage: timeit('plot(x^2,(x,300,500),ticks=[None,50000])')   10.8 ms         9.4
sage: i = CDF.0      # define i this way for maximum speed.
sage: timeit('plot(lambda t: arg(zeta(0.5+t*i)), 1,27,rgbcolor=(0.8,0,0))')
                                                           52.2 ms        52.2
sage: timeit('plot([sin(n*x) for n in [1..4]], (0, pi))')  10.4 ms        10.2
sage: f = (2*x^3+2*x-1)/((x-2)*(x+1))
sage: timeit('plot([f, 2*x+2], -7,7, fill = {0: [1]})')    11.2 ms        11.1
```

so, in my opinion, there is only a slowdown where the original behaviour was incorrect. It is not correct to say "This patch makes the symbolic expression plots about five times slower."

I rebased the patch on 6.2.beta7. LGTM and tests fine in `plot/` and `symbolic/`.
----
New commits:


---

Comment by vbraun created at 2014-04-14 19:57:29

Resolution: fixed


---

Comment by kcrisman created at 2014-04-21 13:36:57

Note that #13355 which is related, if not the same...

Also, anyone know how this impacts 3d plots?


---

Comment by ppurka created at 2014-05-11 07:10:00

Replying to [comment:12 kcrisman]:
> Also, anyone know how this impacts 3d plots?
I believe this has no impact on 3d plots. 3d plots from 2d objects goes via `.plot3d()` methods which usually just take the already generated data points. 3d plots created directly are not affected by this patch.
