# Issue 26188: Coercion problem between Laurent polynomial ring and its field of fraction

Issue created by migration from https://trac.sagemath.org/ticket/26425

Original creator: soehms

Original creation time: 2018-10-07 09:23:14

CC:  tscrim simonking

Keywords: coercion, laurent plynomial, field of fraction

The issue is explained by the following example:


```
sage: R = LaurentPolynomialRing(ZZ, 'x')
sage: F1 = FractionField(R)
sage: R(F1(1/t))
Traceback (most recent call last):
...
TypeError: fraction must have unit denominato
```


On the other hand:


```
sage: from sage.rings.fraction_field import FractionField_generic
sage: F2 = FractionField_generic(R)
sage: R(F2(1/t))
x^-1
```


For further information see the discussion in #26421.


---

Comment by tscrim created at 2018-10-07 10:22:50

This is not a coercion, but a conversion (as it does not have to be defined going back to `R`).


---

Comment by soehms created at 2019-07-19 20:09:14

Changing keywords from "coercion, laurent plynomial, field of fraction" to "coercion, laurent plynomial, field of fraction, days100".


---

Comment by soehms created at 2019-07-23 12:07:03

Changing status from new to needs_review.


---

Comment by soehms created at 2019-07-23 12:07:03

The check for being a unit is performed in the section map of the natural inclusion of a ring into its ring of fractions. Thus, since this ring is not the Laurent polynomial ring itself but the corresponding polynomial ring, that test fails.

My attempt for a fix is to implement the conversion in the `_element_constructor` of the Laurent polynomial ring!

----
New commits:


---

Comment by SimonKing created at 2019-07-24 09:41:12

Note this:

```
sage: R.<t> = LaurentPolynomialRing(ZZ)
sage: t.is_unit()
True
```

So, things SHOULD work, as the denominator of `1/t` is a unit. But:

```
sage: T = F(1/t)
sage: T.denominator().parent()
Univariate Polynomial Ring in t over Integer Ring
sage: R.fraction_field() is R.polynomial_ring().fraction_field()
True
```

Isn't that a bug? EDIT: No, because mathematically the two fraction fields are isomorphic.

Actually I recall that a couple of years ago I tried to let `FractionField(R)` be the `LaurentSeriesRing`, which mathematically is correct. EDIT: ... correct in the same way as the current fraction field is correct.

I think the following patch is not optimal:

```diff
+            P = x.parent()
+            if P.ring() == self.polynomial_ring():
+                d = self(x.denominator())
+                if not d.is_unit():
+                     raise TypeError("fraction must have unit denominator")
+                return self(x.numerator()) * d.inverse_of_unit()
```

I think we don't want to test that `P.ring() == self.polynomial_ring()`, but it is enough that `self.polynomial_ring().has_coerce_map_from(P.ring())`.

Or even better: We are talking about conversion here. So, there is no need to test whether the denominator coerces into `self`. We could just do

```diff
+        elif isinstance(x, FractionFieldElement):
+            # since the field of fraction of self is defined corresponding to the polynomial ring of self
+            # the conversion of its elements back must be treated separately (:trac:`26425`).
+            d = self(x.denominator())
+            if not d.is_unit():
+                 raise TypeError("fraction must have unit denominator")
+            return self(x.numerator()) * d.inverse_of_unit()
```



---

Comment by git created at 2019-07-24 11:10:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2019-07-24 11:13:19

Replying to [comment:8 SimonKing]:
> Or even better: We are talking about conversion here. So, there is no need to test whether the denominator coerces into `self`. We could just do
> {{{
> #!diff
> +        elif isinstance(x, FractionFieldElement):
> +            # since the field of fraction of self is defined corresponding to the polynomial ring of self
> +            # the conversion of its elements back must be treated separately (:trac:`26425`).
> +            d = self(x.denominator())
> +            if not d.is_unit():
> +                 raise TypeError("fraction must have unit denominator")
> +            return self(x.numerator()) * d.inverse_of_unit()
> }}}
As we talked before, the check was just matter of caution. I agree to have that removed!


---

Comment by vdelecroix created at 2019-07-24 15:34:44

You need two `:` at the end of this line

```
+        Check that conversion back from fraction field does work (:trac:`26425`):
```



---

Comment by SimonKing created at 2019-07-24 22:09:57

I fixed the missing `::`.

All but one tests pass. The failing test is

```
king@klap:~/Sage/git/sage$ ./sage -t --warn-long 47.6 src/doc/common/conf.py  # 1 doctest failed

Running doctests with ID 2019-07-25-00-01-10-c2c7af32.
Git branch: t/26425/conversion_problem_laurent_fraction_field_26425
Using --optional=build,ccache,dochtml,frobby,gap_packages,gdb,gfortran,meataxe,memlimit,mpir,p_group_cohomology,python2,sage
Doctesting 1 file.
sage -t --warn-long 47.6 src/doc/common/conf.py
**********************************************************************
File "src/doc/common/conf.py", line 662, in doc.common.conf.call_intersphinx
Failed example:
    for line in open(thematic_index).readlines():  # optional - dochtml
        if "padics" in line:
            _ = sys.stdout.write(line)
Expected:
    <li><a class="reference external" href="../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial" title="(in Sage Reference Manual: p-Adics v...)"><span>Introduction to the p-adics</span></a></li>
Got:
    <li><a class="reference external" href="../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial" title="(in Sage Reference Manual: p-Adics v8.6.rc1)"><span>Introduction to the -adics</span></a></li>
**********************************************************************
1 item had failures:
   1 of   4 in doc.common.conf.call_intersphinx
    [3 tests, 1 failure, 0.01 s]
----------------------------------------------------------------------
sage -t --warn-long 47.6 src/doc/common/conf.py  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 0.1 seconds
    cpu time: 0.0 seconds
    cumulative wall time: 0.0 seconds
```

Is that related? Probably not. But before I give a positive review, I'd like to be sure that the error has not been introduced by this ticket.

I added reviewer and author names. Please check for misspellings. 
----
New commits:


---

Comment by SimonKing created at 2019-07-24 22:15:41

Indeed:

```
king@klap:~/Sage/git/sage$ git checkout 8.9.beta3
HEAD is now at a1e1a8f... Updated SageMath version to 8.9.beta3
king@klap:~/Sage/git/sage$ ./sage -b
...
king@klap:~/Sage/git/sage$ ./sage -t --warn-long 47.6 src/doc/common/conf.py
Running doctests with ID 2019-07-25-00-12-53-64443448.
Git branch: HEAD
Using --optional=build,ccache,dochtml,frobby,gap_packages,gdb,gfortran,meataxe,memlimit,mpir,p_group_cohomology,python2,sage
Doctesting 1 file.
sage -t --warn-long 47.6 src/doc/common/conf.py
**********************************************************************
File "src/doc/common/conf.py", line 662, in doc.common.conf.call_intersphinx
Failed example:
    for line in open(thematic_index).readlines():  # optional - dochtml
        if "padics" in line:
            _ = sys.stdout.write(line)
Expected:
    <li><a class="reference external" href="../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial" title="(in Sage Reference Manual: p-Adics v...)"><span>Introduction to the p-adics</span></a></li>
Got:
    <li><a class="reference external" href="../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial" title="(in Sage Reference Manual: p-Adics v8.6.rc1)"><span>Introduction to the -adics</span></a></li>
**********************************************************************
1 item had failures:
   1 of   4 in doc.common.conf.call_intersphinx
    [3 tests, 1 failure, 0.01 s]
----------------------------------------------------------------------
sage -t --warn-long 47.6 src/doc/common/conf.py  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 0.1 seconds
    cpu time: 0.0 seconds
    cumulative wall time: 0.0 seconds
```


Since this error has not been introduced by this ticket, I think I can give a positive review. Unless Vincent or someone else disagrees.


---

Comment by SimonKing created at 2019-07-24 22:15:41

Changing status from needs_review to positive_review.


---

Comment by soehms created at 2019-07-25 09:11:22

Thanks a lot, Simon!


---

Comment by vbraun created at 2019-07-27 19:51:19

Resolution: fixed
