# Issue 14495: Get iml to install correctly and pass its self-tests on sage.math

Issue created by migration from Trac.

Original creator: jhpalmieri

Original creation time: 2013-06-06 21:23:23

Assignee: jdemeyer

CC:  leif jpflori jdemeyer vbraun

With the new ATLAS spkg from #10508, iml fails its self tests. See [http://trac.sagemath.org/sage_trac/ticket/10508#comment:518](http://trac.sagemath.org/sage_trac/ticket/10508#comment:518) and later comments.


---

Comment by jpflori created at 2013-06-06 21:28:55

Surely an ATLAS problem, see http://trac.sagemath.org/sage_trac/ticket/10508#comment:526 for a solution.

I suggest we call at least install_inc and potentially install_lib from ATLAS build system to install headers and static libs.


---

Comment by jpflori created at 2013-06-06 21:29:59

Or just install which should call both of them.


---

Comment by leif created at 2013-06-06 21:30:09

John, U sure about *sage*.math?

```
128.208.160.191	sage.math.washington.edu sage sage.math
```



---

Comment by leif created at 2013-06-06 21:32:51

Replying to [comment:3 leif]:
> John, U sure about *sage*.math?
> {{{
> 128.208.160.191	sage.math.washington.edu sage sage.math
> }}}
(As opposed to

```
;; ANSWER SECTION:
sage.math.washington.edu. 600	IN	A	128.208.160.197
```

which is boxen.)


---

Comment by jpflori created at 2013-06-06 21:33:16

It would be nice to fix that on top of #14605 which I've tested quite extensively and is finished since some time.


---

Comment by leif created at 2013-06-06 21:37:17

+1 to also again install static libs.


---

Comment by jpflori created at 2013-06-06 21:41:41

Changing keywords from "" to "atlas".


---

Comment by jpflori created at 2013-06-06 21:41:41

Changing priority from major to critical.


---

Comment by jpflori created at 2013-06-06 21:41:41

In fact disregard my comment about #14605.
We should fix the issue here quickly, hopefully before 5.10 official release if it's not too late.
Although as it does not seem to prevent anything from working except for IML testsuite, 5.11 should be ok as well.


---

Comment by leif created at 2013-06-06 21:55:57

Changing keywords from "atlas" to "atlas IML testsuite check cblas.h".


---

Comment by Koen created at 2013-06-06 22:05:02

A side-effect of this ticket is probably that numpy gets built without ATLAS acceleration.


---

Comment by leif created at 2013-06-06 22:12:04

For the record, I did get

```
ATLAS_CFLAGS=''
ATLAS_LIBS='-lcblas -latlas'
```

`-L${SAGE_LOCAL}/lib` "incidentally" came from / for GMP, although *after* `-lcblas -latlas`, but we meanwhile add `${SAGE_LOCAL}/lib` to `LIBRARY_PATH` (in `sage-env`), so that it worked.


---

Comment by leif created at 2013-06-06 22:15:50

P.S.:  Although IIRC according to POSIX, `-Ldir1 -lfoo -Ldir2 -lbar` is the same as `-Ldir1 -Ldir2 -lfoo -lbar`.


---

Comment by jpflori created at 2013-06-06 22:17:03

Changing status from new to needs_review.


---

Comment by leif created at 2013-06-06 22:18:50

Replying to [comment:11 leif]:
> P.S.:  Although IIRC according to POSIX, `-Ldir1 -lfoo -Ldir2 -lbar` is the same as `-Ldir1 -Ldir2 -lfoo -lbar`.

At least GNU `ld` docs agree with this:

  _All -L options apply to all -l options, regardless of the order in which the options appear._


---

Comment by Koen created at 2013-06-06 22:22:53

You'd still need a line

```
    cmd += ' --incdir=' + os.path.join(conf['SAGE_LOCAL'],'include') 
```

in `configure_atlas_library()` for the header files to go the correct place?

And currently numpy is built without Atlas (it uses another blas): local/lib/python2.7/site-packages/numpy/core/_dotblas.so normally contains ATL_* symbols (for an old Atlas 3.8.3 version, at least).


---

Comment by jpflori created at 2013-06-06 22:26:22

Replying to [comment:14 Koen]:
> You'd still need a line
> {{{
>     cmd += ' --incdir=' + os.path.join(conf['SAGE_LOCAL'],'include') 
> }}}
> in `configure_atlas_library()` for the header files to go the correct place?
I don't think so.
We use prefix and that should be enough from what I've seen in ATLAS configure script.


---

Comment by jpflori created at 2013-06-06 22:29:58

Replying to [comment:14 Koen]:
> And currently numpy is built without Atlas (it uses another blas): local/lib/python2.7/site-packages/numpy/core/_dotblas.so normally contains ATL_* symbols (for an old Atlas 3.8.3 version, at least).
On my gcc110 install (where IML testsuite fails), numpy uses ATLAS correctly.
There is no ATLAS symbols in the file you pointed because we now use a shared version of ATLAS.
But if I run ldd on the file it points to the ATLAS libs.

And I seem to remember we had lots of troubles correctly biulding numpy and scipy with the new ATLAS so hopefully it was actually used.


---

Comment by leif created at 2013-06-06 22:33:09

s/inlcude/include/

and IMHO (=WTF?) also s/serial/single-threaded/g s/parallel/multi-threaded/g ... 

(but the latter is not JP's invention I guess)


---

Comment by jpflori created at 2013-06-06 22:38:58

Replying to [comment:17 leif]:
> s/inlcude/include/
Done.
> 
> and IMHO (=WTF?) also s/serial/single-threaded/g s/parallel/multi-threaded/g ... 
> 
> (but the latter is not JP's invention I guess)
Not mine indeed.


---

Comment by leif created at 2013-06-06 22:39:19

Replying to [comment:16 jpflori]:
> Replying to [comment:14 Koen]:
> > And currently numpy is built without Atlas (it uses another blas): local/lib/python2.7/site-packages/numpy/core/_dotblas.so normally contains ATL_* symbols (for an old Atlas 3.8.3 version, at least).
> On my gcc110 install (where IML testsuite fails), numpy uses ATLAS correctly.
> There is no ATLAS symbols in the file you pointed because we now use a shared version of ATLAS.
> But if I run ldd on the file it points to the ATLAS libs.

Yes.

```
$ readelf -d local/lib/python2.7/site-packages/numpy/core/_dotblas.so

Dynamic section at offset 0x4dc0 contains 26 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libptf77blas.so.2]
 0x0000000000000001 (NEEDED)             Shared library: [libptcblas.so.2]
 0x0000000000000001 (NEEDED)             Shared library: [libatlas.so.2]
 0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]
 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
 ...
```



---

Comment by jpflori created at 2013-06-06 22:52:58

make_atlas() takes no argument.


---

Comment by jpflori created at 2013-06-06 22:52:58

Changing status from needs_review to needs_work.


---

Comment by jpflori created at 2013-06-06 22:56:24

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2013-06-06 23:30:35

I saw the error on boxen. I thought that sage.math was dead? In any case, it's the machine I get to by typing `ssh sage.math.washington.edu`, and when I log off it says `Connection to sage.math.washington.edu closed.` The `$HOSTNAME` is boxen, though.


---

Comment by jhpalmieri created at 2013-06-07 00:03:40

On boxen, after installing the new ATLAS spkg, the current iml spkg installs and passes its tests. Same for an iml spkg which doesn't copy over the patched version of `configure`.


---

Comment by leif created at 2013-06-07 00:12:18

P.S.:  I guess the odd "patch" to IML's `configure` dates back to the times when ATLAS was somehow optional, or at least did not get properly detected on all systems.  Running / building IML's test suite on such systems was always broken then.

(In other parts of Sage using IML, BLAS libraries get explicitly added by us when linking.)


---

Comment by jdemeyer created at 2013-06-07 07:05:23

Changing priority from critical to blocker.


---

Comment by vbraun created at 2013-06-07 09:09:46

**Do not install static libraries**, its a feature that we don't.

Also, nobody in his right mind expects blas headers. This is why the iml testsuite, which the authors probably didn't expect to be distributed, is the only place that trips over it. For starters, there is no universal naming standard (blas.h vs. cblas.h vs. foo_cblas.h vs. foo/cblas.h). There are multiple blas implementations and if you all install them at the same place then they would overwrite each other.


---

Comment by vbraun created at 2013-06-07 09:15:37

And if you need a reason for not installing static libraries you just have to look at this ticket where you got confused about whether something links against atlas or not. Shared libraries are the only way that make it clear **which particular atlas version** you are linking against and that you didn't accidentally pick up some system atlas.


---

Comment by Koen created at 2013-06-07 09:30:05

I disagree that nobody expects the blas headers. If I try to install a package on top of Sage, e.g. the Shogun machine learning toolbox, then it will only compile in certain features if it can find a blas - and for that it needs blas headers. With older sage versions this works just fine.


---

Comment by vbraun created at 2013-06-07 09:45:54

Shogun just makes it unnecessarily complicated for themselves, you need to define preprocessor constants to tell it which blas header to look for...

I agree that we should have blas/cblas/f77blas **headers** since its the right thing to do. But when we fix the IML testsuite we shouldn't introduce that as a dependency, because very often the headers are either not installed or installed with a funky name.


---

Comment by leif created at 2013-06-07 10:16:45

Replying to [comment:26 vbraun]:
> **Do not install static libraries**, its a feature that we don't.

At least they shouldn't get discarded, which is simply stupid.


---

Comment by leif created at 2013-06-07 10:19:32

Btw., the new spkg and afterwards IML installed without problems, and both passed their test suites on Linux x86_64 (Ubuntu 10.04.4, Sage 5.10.rc0).


---

Comment by vbraun created at 2013-06-07 10:23:39

Replying to [comment:31 leif]:
> At least they shouldn't get discarded, which is simply stupid.

Do you also object to discarding the `*.o` files? We delete what we don't want around in the install, thats the way it works. Ideally upstream would have an `--disable-static` switch, but they don't.


---

Comment by vbraun created at 2013-06-07 10:33:10

Removed the static library install bit from the spkg


---

Comment by leif created at 2013-06-07 11:29:05

Replying to [comment:33 vbraun]:
> Replying to [comment:31 leif]:
> > At least they shouldn't get discarded, which is simply stupid.
> 
> Do you also object to discarding the `*.o` files?

`man ar`?


---

Comment by vbraun created at 2013-06-07 11:42:08

Replying to [comment:35 leif]:
> `man ar`?

I take it that this means that you agree with me, and we should neither install object files nor static libraries ;-)


---

Comment by leif created at 2013-06-08 13:28:36

Changing status from needs_review to needs_info.


---

Comment by leif created at 2013-06-08 13:28:36

Probably vote on sage-devel on whether to discard the static libraries or not.


---

Comment by jpflori created at 2013-06-08 13:32:38

Replying to [comment:31 leif]:
> Replying to [comment:26 vbraun]:
> > **Do not install static libraries**, its a feature that we don't.
> 
> At least they shouldn't get discarded, which is simply stupid.
Having static libraries rather than nothing on systems where building shared ones is problematic might be nice...
Also note it's the only option upstream really supports.


---

Comment by leif created at 2013-06-08 13:43:24

Replying to [comment:38 leif]:
> Probably vote on sage-devel on whether to discard the static libraries or not.

... or make it optional.


---

Comment by vbraun created at 2013-06-08 15:14:28

Done, see https://groups.google.com/d/msg/sage-devel/mthuvh5SRpQ/nDekknXc76IJ


---

Comment by jdemeyer created at 2013-06-10 12:20:24

Can we please concentrate on the actual ticket issue here, which is about header files and iml failing? I don't think this has anything to do with static libraries (but please correct me if I'm wrong).


---

Attachment


---

Comment by jpflori created at 2013-06-10 12:46:02

Changing status from needs_info to needs_review.


---

Comment by jpflori created at 2013-06-10 12:46:02

Ok.
Only concentrating on that, I'm ok with Volker changes to my changes.


---

Comment by vbraun created at 2013-06-10 12:57:59

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2013-06-10 12:57:59

I'm ok with Jean-Pierre changes to the extent that I haven't changed them, of course.


---

Comment by leif created at 2013-06-10 13:45:18

Replying to [comment:42 jdemeyer]:
> Can we please concentrate on the actual ticket issue here, which is about header files and iml failing? I don't think this has anything to do with static libraries (but please correct me if I'm wrong).

Well, if we used ATLAS' install rather than further hacking, we'd get both the headers and the static libraries.

I don't see any reason why *discarding* static libraries should be done by default; if someone feels they're dangerous to him/her, we could add some option to _automatically_ remove them, although that's IMHO a pretty unimportant feature.


---

Comment by leif created at 2013-06-10 13:49:31

P.S.:  Removing the "patch" to IML's `configure` from the IML spkg IMHO belongs to this ticket as well, as that was hiding (or rather obscuring) the real problem.


---

Comment by vbraun created at 2013-06-10 13:56:22

Replying to [comment:46 leif]:
> P.S.:  Removing the "patch" to IML's `configure` from the IML spkg IMHO belongs to this ticket as well, as that was hiding (or rather obscuring) the real problem.

Then either attach a fixed iml spkg to this packet real soon (TM) or open a ticket for it. But don't leave footnotes on finished tickets.


---

Comment by leif created at 2013-06-10 14:04:30

Replying to [comment:47 vbraun]:
> Replying to [comment:46 leif]:
> > P.S.:  Removing the "patch" to IML's `configure` from the IML spkg IMHO belongs to this ticket as well, as that was hiding (or rather obscuring) the real problem.
> 
> Then either attach a fixed iml spkg to this packet real soon (TM) or open a ticket for it. But don't leave footnotes on finished tickets.

I was saying it's *IMHO* not finished.


---

Comment by jpflori created at 2013-06-10 15:13:36

Indeed, the ticket original title was about IML testsuite, so we should also provide an IML spkg (quite trivial just remove the horrible patch disabling test for cblas.h).

leif: could you make the spkg? I'll quickly review it.


---

Comment by jpflori created at 2013-06-10 15:13:44

Changing status from positive_review to needs_work.


---

Comment by jpflori created at 2013-06-10 15:18:30

Or at least we should provide this fixed IML spkg in a follow up ticket mentioned here and put as blocker for 5.10.


---

Comment by leif created at 2013-06-10 19:25:58

This doesn't at all work with `SAGE_ATLAS_LIB` [unless the headers happen to be installed system-wide, which is the same situation as before], since headers don't get copied / symlinked.




What happens on MacOS X (where Sage's ATLAS by default doesn't get built)?

(Similar for Cygwin perhaps.)

Replying to [comment:49 jpflori]:
> Indeed, the ticket original title was about IML testsuite, so we should also provide an IML spkg (quite trivial just remove the horrible patch disabling test for cblas.h).

So I'm not sure if it's really that easy.


---

Comment by jpflori created at 2013-06-10 19:32:54

Yeah, I was just looking into that...
Not really anything useful to do when a system-wide ATLAS is used.

Does really no software linking to ATLAS expect to find headers in some standard or provided place?
Do they all provide their own BLAS headers and expect everything to be fine?


---

Comment by vbraun created at 2013-06-10 19:52:49

Its pretty much common practice to use your own blas/lapack headers. For example, linbox/fflas: http://linalg.org/projects/fflas-ffpack/browser/fflas-ffpack/config-blas.h Definitely weird, but then its probably the most stable API ever. And the lack of uniform naming of the header across vendors doesn't help.


---

Comment by jpflori created at 2013-06-10 20:24:38

A test spkg is at:
* http://boxen.math.washington.edu/home/jpflori/spkg/iml-1.0.1.p15.spkg
Not really wonderful as the src directory still includes a modified upstream source, but maybe a little bit better looking.
Not tested yet, I'm doing it right now.


---

Comment by jpflori created at 2013-06-10 20:27:47

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2013-06-10 20:46:39

The use of `"$SAGE_LOCAL"/lib/libatlas.so.*.*` seems to assume that there is exactly one file matching `"$SAGE_LOCAL"/lib/libatlas.so.*.*`

I doubt that this assumption is true in general.


---

Comment by jdemeyer created at 2013-06-10 20:46:39

Changing status from needs_review to needs_work.


---

Comment by jpflori created at 2013-06-10 20:52:36

Quite true (just wondering if we really want to support Sage's installs with multiple ATLAS version installed?).


---

Comment by jdemeyer created at 2013-06-10 21:23:23

Working on IML spkg, hang on...


---

Comment by jpflori created at 2013-06-10 21:41:04

Of course I guess the IML testsuite will still fail on OS X or Cygwin.


---

Comment by jdemeyer created at 2013-06-10 22:20:12

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2013-06-10 22:20:12

IML spkg needs review, I restored upstream sources and added patches in the `patches/` directory. I know the patches can be catalogued and documented better, but let's leave that for next time...

Tested on Linux and OS X x86_64, IML (with testsuite) works.


---

Attachment


---

Comment by jdemeyer created at 2013-06-11 06:53:33

I'm adding [attachment:14699_env_version_bump.patch] because ATLAS now requires the `FC` environment variable to be set, so it needs an up-to-date `sage-env`.


---

Attachment

Spkg diff, for review only.


---

Comment by jpflori created at 2013-06-11 08:36:22

Replying to [comment:66 jdemeyer]:
> I'm adding [attachment:14699_env_version_bump.patch] because ATLAS now requires the `FC` environment variable to be set, so it needs an up-to-date `sage-env`.
What does that achieve exactly?
Just looking at the patch, I cannot really guess.
Does it force upgrading the sage-env script?

A question for Volker: How does the SO_VERSION variable in the ATLAS autotools project be updated?


---

Comment by jdemeyer created at 2013-06-11 09:05:35

I'll copy the comments from `sage-env`:

```
# Don't execute the commands more than once for the same version of
# sage-env.  Check this after checking the validity of SAGE_ROOT, but
# before modifying its value.
#
# The idea of versioning is that SAGE_ENV_SOURCED will be set to a
# "version number" of sage-env.  If a different version of sage-env was
# sourced earlier (when upgrading), we still source the new version.
# The sage-env version should be increased whenever a newer sage-env is
# required for upgrading.  Note that spkg/standard/deps might also need
# to be changed: the packages which need the new sage-env must depend on
# SAGE_ROOT_REPO (the root repo contains sage-env).
#
# sage-env version history:
# - sage-4.7.1: version 1 (#10469)
# - sage-5.4:   version 2 (#13395)
#
SAGE_ENV_VERSION=2
if [ "$SAGE_ENV_SOURCED" = "$SAGE_ENV_VERSION" ]; then
    # Already sourced, nothing to do.
    return 0
fi
export SAGE_ENV_SOURCED=$SAGE_ENV_VERSION
```



---

Comment by jpflori created at 2013-06-11 21:49:30

Changing status from needs_review to needs_work.


---

Comment by jpflori created at 2013-06-11 21:49:30

In the IMl spkg, you don't reexport CFLAGS after checking for SAGE64 (both in spkg-check and spkg-install).

And when looking through trac there is a strange .patch part about renaming sage3_memleak, but that may just be a trac issue.


---

Comment by jdemeyer created at 2013-06-12 06:54:57

Replying to [comment:69 jpflori]:
> In the IMl spkg, you don't reexport CFLAGS after checking for SAGE64 (both in spkg-check and spkg-install).
It's already exported before. No need to "reexport" it.

> And when looking through trac there is a strange .patch part about renaming sage3_memleak, but that may just be a trac issue.
Indeed, that's a Trac bug.


---

Comment by jdemeyer created at 2013-06-12 06:54:57

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2013-06-12 07:09:27

I should also note that the only _new_ patch in IML is `patches/remove_repl.patch`, all the others were already (pre-patched) in the spkg.


---

Comment by jpflori created at 2013-06-12 18:05:11

Replying to [comment:70 jdemeyer]:
> Replying to [comment:69 jpflori]:
> > In the IMl spkg, you don't reexport CFLAGS after checking for SAGE64 (both in spkg-check and spkg-install).
> It's already exported before. No need to "reexport" it.
> 
Damn, I was not aware of that!
> > And when looking through trac there is a strange .patch part about renaming sage3_memleak, but that may just be a trac issue.
> Indeed, that's a Trac bug.


---

Comment by jpflori created at 2013-06-14 08:38:26

Changing status from needs_review to positive_review.


---

Comment by jpflori created at 2013-06-14 08:38:26

The spkg looks good, seems to work on my systems.


---

Comment by jdemeyer created at 2013-06-14 09:19:42

Resolution: fixed


---

Comment by jdemeyer created at 2013-06-14 09:42:03

Thanks for the review, do you by chance feel like reviewing the IML upgrade at #748?


---

Comment by jdemeyer created at 2013-06-17 12:04:33

Changing status from closed to new.


---

Comment by jdemeyer created at 2013-06-17 12:04:33

Resolution changed from fixed to 


---

Comment by jdemeyer created at 2013-06-17 12:04:33

Reverting the ATLAS package: #14753.


---

Comment by jdemeyer created at 2013-06-17 12:06:01

Resolution: fixed


---

Comment by jdemeyer created at 2013-06-17 12:06:34

Keeping "merged in" information for future reference, we should not change this ticket further.
