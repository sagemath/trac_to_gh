# Issue 15042: RootSystem __init__ builds the dual twice, breaking initialization of non-crystallographic root systems

archive/issues_015042.json:
```json
{
    "body": "CC:  @anneschilling @tscrim sage-combinat @nthiery @mwhansen @dwbump\n\nKeywords: root-system, sage-combinat\n\nRelevant piece of the code:\n\n```\n        if as_dual_of is None:\n            self.dual_side = False\n            self.dual = RootSystem(self._cartan_type.dual(), as_dual_of=self);\n            # still fails for CartanType G2xA1\n            try:\n                self.dual = RootSystem(self._cartan_type.dual(), as_dual_of=self);\n            except StandardError:\n                pass\n```\n\nThe definition of `self.dual` is done twice, one time in a try clause, one time outside. I don't know if the breaking of non-crystallographic root systems is intentional or not (might be it is because there doesn't seem to be much functionality implemented for that), but it certainly slows down things.\n\nIssue created by migration from https://trac.sagemath.org/ticket/15279\n\n",
    "created_at": "2013-10-14T20:07:20Z",
    "labels": [
        "component: please change",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.13",
    "title": "RootSystem __init__ builds the dual twice, breaking initialization of non-crystallographic root systems",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15042",
    "user": "https://github.com/darijgr"
}
```
CC:  @anneschilling @tscrim sage-combinat @nthiery @mwhansen @dwbump

Keywords: root-system, sage-combinat

Relevant piece of the code:

```
        if as_dual_of is None:
            self.dual_side = False
            self.dual = RootSystem(self._cartan_type.dual(), as_dual_of=self);
            # still fails for CartanType G2xA1
            try:
                self.dual = RootSystem(self._cartan_type.dual(), as_dual_of=self);
            except StandardError:
                pass
```

The definition of `self.dual` is done twice, one time in a try clause, one time outside. I don't know if the breaking of non-crystallographic root systems is intentional or not (might be it is because there doesn't seem to be much functionality implemented for that), but it certainly slows down things.

Issue created by migration from https://trac.sagemath.org/ticket/15279





---

archive/issue_comments_192092.json:
```json
{
    "body": "Attachment [trac_15279-init_RootSystem-dg.patch](tarball://root/attachments/some-uuid/ticket15279/trac_15279-init_RootSystem-dg.patch) by @darijgr created at 2013-10-14 20:07:57",
    "created_at": "2013-10-14T20:07:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15042",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15042#issuecomment-192092",
    "user": "https://github.com/darijgr"
}
```

Attachment [trac_15279-init_RootSystem-dg.patch](tarball://root/attachments/some-uuid/ticket15279/trac_15279-init_RootSystem-dg.patch) by @darijgr created at 2013-10-14 20:07:57



---

archive/issue_comments_192093.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-10-16T05:39:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15042",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15042#issuecomment-192093",
    "user": "https://github.com/darijgr"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_192094.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to combinatorics.",
    "created_at": "2013-10-16T05:40:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15042",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15042#issuecomment-192094",
    "user": "https://github.com/darijgr"
}
```

Changing component from PLEASE CHANGE to combinatorics.



---

archive/issue_comments_192095.json:
```json
{
    "body": "Looks good to me.",
    "created_at": "2013-10-16T21:43:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15042",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15042#issuecomment-192095",
    "user": "https://github.com/tscrim"
}
```

Looks good to me.



---

archive/issue_comments_192096.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-10-16T21:43:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15042",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15042#issuecomment-192096",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_192097.json:
```json
{
    "body": "This sounds like a merge that went wrong, so +1 on the change. You might want to add a test if this impacts non crystalographic root systems (yes we want to progressively support them!!!).\n\nIn the long run, we would want something better than just trying and hoping for the best. We should be able to tell exactly when the dual should be defined or not.",
    "created_at": "2013-10-16T21:49:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15042",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15042#issuecomment-192097",
    "user": "https://github.com/nthiery"
}
```

This sounds like a merge that went wrong, so +1 on the change. You might want to add a test if this impacts non crystalographic root systems (yes we want to progressively support them!!!).

In the long run, we would want something better than just trying and hoping for the best. We should be able to tell exactly when the dual should be defined or not.



---

archive/issue_comments_192098.json:
```json
{
    "body": "I don't know what to test for the non-crystallographic ones, since nothing nontrivial seems to work for them so far... Once they are actually implemented, they will have their own doctests, which of course will implicitly test __init__ as well, so I'm not worried about __init__. As for now, this is more about speed and just getting rid of a line that doesn't make sense.\n\nTravis: thanks for looking at it!",
    "created_at": "2013-10-16T22:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15042",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15042#issuecomment-192098",
    "user": "https://github.com/darijgr"
}
```

I don't know what to test for the non-crystallographic ones, since nothing nontrivial seems to work for them so far... Once they are actually implemented, they will have their own doctests, which of course will implicitly test __init__ as well, so I'm not worried about __init__. As for now, this is more about speed and just getting rid of a line that doesn't make sense.

Travis: thanks for looking at it!



---

archive/issue_comments_192099.json:
```json
{
    "body": "Replying to [comment:4 nthiery]:\n> This sounds like a merge that went wrong\nIt would be interesting to know why/how it went wrong. The patch is from #5794, 4 years ago.\n\nInterestingly, the patch [attachment:trac_5794-exceptional.patch:ticket:5794] on Trac is correct, it does remove the duplicate line. However, the patch which is merged (revision `-r13366` in Mercurial) has a different commit message (`trac_5794-exceptional.patch modified for combinat server`) and does *not* remove that line. I can only hope that the \"combinat server\" doesn't make these mistakes any more.",
    "created_at": "2013-10-16T23:00:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15042",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15042#issuecomment-192099",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:4 nthiery]:
> This sounds like a merge that went wrong
It would be interesting to know why/how it went wrong. The patch is from #5794, 4 years ago.

Interestingly, the patch [attachment:trac_5794-exceptional.patch:ticket:5794] on Trac is correct, it does remove the duplicate line. However, the patch which is merged (revision `-r13366` in Mercurial) has a different commit message (`trac_5794-exceptional.patch modified for combinat server`) and does *not* remove that line. I can only hope that the "combinat server" doesn't make these mistakes any more.



---

archive/issue_comments_192100.json:
```json
{
    "body": "There is also this suspicious commit, which was never actually reverted.\n\n```\nchangeset:   13363:359efb582d39\nuser:        Mike Hansen <mhansen@gmail.com>\ndate:        Thu Nov 19 08:25:56 2009 -0800\nsummary:     this temporary patch to be taken down when root system and 5794 patches stabilize.\n```\n",
    "created_at": "2013-10-17T07:28:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15042",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15042#issuecomment-192100",
    "user": "https://github.com/jdemeyer"
}
```

There is also this suspicious commit, which was never actually reverted.

```
changeset:   13363:359efb582d39
user:        Mike Hansen <mhansen@gmail.com>
date:        Thu Nov 19 08:25:56 2009 -0800
summary:     this temporary patch to be taken down when root system and 5794 patches stabilize.
```




---

archive/issue_comments_192101.json:
```json
{
    "body": "More generally, the patches on Trac from #5794 are not the ones which were merged. I don't plan to further investigate this, but perhaps somebody should.",
    "created_at": "2013-10-17T07:32:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15042",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15042#issuecomment-192101",
    "user": "https://github.com/jdemeyer"
}
```

More generally, the patches on Trac from #5794 are not the ones which were merged. I don't plan to further investigate this, but perhaps somebody should.



---

archive/issue_comments_192102.json:
```json
{
    "body": "Is there a way to see the patches which were merged? This is spooky. Thanks for getting to the roots (oops) of this, Jeroen!",
    "created_at": "2013-10-17T17:37:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15042",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15042#issuecomment-192102",
    "user": "https://github.com/darijgr"
}
```

Is there a way to see the patches which were merged? This is spooky. Thanks for getting to the roots (oops) of this, Jeroen!



---

archive/issue_comments_192103.json:
```json
{
    "body": "Replying to [comment:9 darij]:\n> Is there a way to see the patches which were merged?\nUse `hg log` and `hg export -r13366` to see a particular commit.",
    "created_at": "2013-10-17T17:42:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15042",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15042#issuecomment-192103",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:9 darij]:
> Is there a way to see the patches which were merged?
Use `hg log` and `hg export -r13366` to see a particular commit.



---

archive/issue_comments_192104.json:
```json
{
    "body": "Replying to [comment:6 jdemeyer]:\n> Replying to [comment:4 nthiery]:\n> > This sounds like a merge that went wrong\n> It would be interesting to know why/how it went wrong. The patch is from #5794, 4 years ago.\n> \n> Interestingly, the patch [attachment:trac_5794-exceptional.patch:ticket:5794] on Trac is correct, it does remove the duplicate line. However, the patch which is merged (revision `-r13366` in Mercurial) has a different commit message (`trac_5794-exceptional.patch modified for combinat server`) and does *not* remove that line. I can only hope that the \"combinat server\" doesn't make these mistakes any more.\n\nNot having duplication between patches on the combinat server and on trac and not having to rebase constantly, like we will have with the new workflow, will certainly help ... \n\nThanks for tracking this down!",
    "created_at": "2013-10-17T21:37:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15042",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15042#issuecomment-192104",
    "user": "https://github.com/nthiery"
}
```

Replying to [comment:6 jdemeyer]:
> Replying to [comment:4 nthiery]:
> > This sounds like a merge that went wrong
> It would be interesting to know why/how it went wrong. The patch is from #5794, 4 years ago.
> 
> Interestingly, the patch [attachment:trac_5794-exceptional.patch:ticket:5794] on Trac is correct, it does remove the duplicate line. However, the patch which is merged (revision `-r13366` in Mercurial) has a different commit message (`trac_5794-exceptional.patch modified for combinat server`) and does *not* remove that line. I can only hope that the "combinat server" doesn't make these mistakes any more.

Not having duplication between patches on the combinat server and on trac and not having to rebase constantly, like we will have with the new workflow, will certainly help ... 

Thanks for tracking this down!



---

archive/issue_comments_192105.json:
```json
{
    "body": "Replying to [comment:11 nthiery]:\n> not having to rebase constantly, like we will have with the new workflow\nWhy would one need to rebase less with the new workflow? A merge conflict is a merge conflict, and the new workflow is not going to change that.",
    "created_at": "2013-10-19T09:26:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15042",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15042#issuecomment-192105",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:11 nthiery]:
> not having to rebase constantly, like we will have with the new workflow
Why would one need to rebase less with the new workflow? A merge conflict is a merge conflict, and the new workflow is not going to change that.



---

archive/issue_comments_192106.json:
```json
{
    "body": "Replying to [comment:12 jdemeyer]:\n> Replying to [comment:11 nthiery]:\n> > not having to rebase constantly, like we will have with the new workflow\n> Why would one need to rebase less with the new workflow? A merge conflict is a merge conflict, and the new workflow is not going to change that.\n\nGranted, there will be as many merges as before; but unlike what we had with our patch queues those will be 3-way merges, so there will be better support from the revision control system, with less error-prone manual operations.\n\nCheers,",
    "created_at": "2013-10-19T09:45:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15042",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15042#issuecomment-192106",
    "user": "https://github.com/nthiery"
}
```

Replying to [comment:12 jdemeyer]:
> Replying to [comment:11 nthiery]:
> > not having to rebase constantly, like we will have with the new workflow
> Why would one need to rebase less with the new workflow? A merge conflict is a merge conflict, and the new workflow is not going to change that.

Granted, there will be as many merges as before; but unlike what we had with our patch queues those will be 3-way merges, so there will be better support from the revision control system, with less error-prone manual operations.

Cheers,



---

archive/issue_events_014731.json:
```json
{
    "actor": "@jdemeyer",
    "created_at": "2013-10-20T20:57:34Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/15042",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15042#event-14731"
}
```



---

archive/issue_comments_192107.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-10-20T20:57:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15042",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15042#issuecomment-192107",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_192108.json:
```json
{
    "body": "I am CCing Daniel Bump and Mike Hansen; maybe they can shed more light on the question what exactly ended up merged from #5794.\n\nSo these seem to be the #5794-related commits in the log (thank you, Jeroen, for the help with getting it):\n\n\n```\n\nchangeset:   13469:7d776d3652ea\nuser:        Nicolas M. Thiery <nthiery@users.sf.net>\ndate:        Thu Nov 19 12:23:11 2009 +0100\nsummary:     [mq]: trac_5794-long-time-nt.patch\n\n[...]\n\nchangeset:   13368:2fcea95a7e9c\nuser:        Mike Hansen <mhansen@gmail.com>\ndate:        Thu Nov 19 08:26:08 2009 -0800\nsummary:     ReST fixes and improvements\n\nchangeset:   13367:4a11faf380b3\nuser:        Daniel Bump <bump@match.stanford.edu>\ndate:        Wed May 20 13:55:19 2009 -0700\nsummary:     Further exceptional branching rules\n\nchangeset:   13366:ffe6380fbc20\nuser:        Daniel Bump <bump@match.stanford.edu>\ndate:        Tue May 12 21:56:35 2009 -0700\nsummary:     trac_5794-exceptional.patch modified for combinat server\n\nchangeset:   13365:a28740f742ec\nuser:        Mike Hansen <mhansen@gmail.com>\ndate:        Thu Nov 19 08:26:00 2009 -0800\nsummary:     imported patch trac_5794-continued-combinat\n\nchangeset:   13364:e75cad2172eb\nuser:        Mike Hansen <mhansen@gmail.com>\ndate:        Thu Nov 19 08:25:57 2009 -0800\nsummary:     imported patch cartan_type_temporary-1.patch\n\nchangeset:   13363:359efb582d39\nuser:        Mike Hansen <mhansen@gmail.com>\ndate:        Thu Nov 19 08:25:56 2009 -0800\nsummary:     this temporary patch to be taken down when root system and 5794 patches stabilize.\n\nchangeset:   13362:3fef40a05bb4\nuser:        Daniel Bump <bump@match.stanford.edu>\ndate:        Wed May 06 13:17:39 2009 -0700\nsummary:     trac_5794-revised.patch modified for combinat server\n\n```\n\n\nI can tell that\n\nchangeset 13469 == trac_5794-long-time-nt.patch (modulo fuzz)\n\nand\n\nchangeset 13368 == trac_5794-reviewer-nt.patch.\n\nFurthermore,\n\nchangeset 13367 differs from trac_5794-more-exceptional.patch only in having `is_irreducible` and `is_reducible` in lieu of `is_atomic` and `is_compound`.\n\nThe difference between changeset 13366 and trac_5794-exceptional.patch is more substantial, and is what caused the bug in the present ticket. Someone else should look into the diff to check if this is the only issue caused!\n\nThe difference between changeset 13365 and trac_5794-continued.patch is again only in irreducible-vs-atomic and reducible-vs-compound.\n\nChangeset 13364 is not an attachment on #5794 and all it does is replacing some \"reducible\" by \"compound\" resp. \"irreducible\" by \"atomic\".\n\nChangeset 13363 (\"this temporary patch to be taken down when root system and 5794 patches stabilize.\") seems not to be from the #5794 attachments either, and I don't really understand what it does. I don't know if anyone has ever \"taken it down\" or reverted its edits.\n\nChangeset 13362 has noticeable differences from trac_5794-revised.patch and maybe someone should look into that.",
    "created_at": "2013-10-21T03:53:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15042",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15042#issuecomment-192108",
    "user": "https://github.com/darijgr"
}
```

I am CCing Daniel Bump and Mike Hansen; maybe they can shed more light on the question what exactly ended up merged from #5794.

So these seem to be the #5794-related commits in the log (thank you, Jeroen, for the help with getting it):


```

changeset:   13469:7d776d3652ea
user:        Nicolas M. Thiery <nthiery@users.sf.net>
date:        Thu Nov 19 12:23:11 2009 +0100
summary:     [mq]: trac_5794-long-time-nt.patch

[...]

changeset:   13368:2fcea95a7e9c
user:        Mike Hansen <mhansen@gmail.com>
date:        Thu Nov 19 08:26:08 2009 -0800
summary:     ReST fixes and improvements

changeset:   13367:4a11faf380b3
user:        Daniel Bump <bump@match.stanford.edu>
date:        Wed May 20 13:55:19 2009 -0700
summary:     Further exceptional branching rules

changeset:   13366:ffe6380fbc20
user:        Daniel Bump <bump@match.stanford.edu>
date:        Tue May 12 21:56:35 2009 -0700
summary:     trac_5794-exceptional.patch modified for combinat server

changeset:   13365:a28740f742ec
user:        Mike Hansen <mhansen@gmail.com>
date:        Thu Nov 19 08:26:00 2009 -0800
summary:     imported patch trac_5794-continued-combinat

changeset:   13364:e75cad2172eb
user:        Mike Hansen <mhansen@gmail.com>
date:        Thu Nov 19 08:25:57 2009 -0800
summary:     imported patch cartan_type_temporary-1.patch

changeset:   13363:359efb582d39
user:        Mike Hansen <mhansen@gmail.com>
date:        Thu Nov 19 08:25:56 2009 -0800
summary:     this temporary patch to be taken down when root system and 5794 patches stabilize.

changeset:   13362:3fef40a05bb4
user:        Daniel Bump <bump@match.stanford.edu>
date:        Wed May 06 13:17:39 2009 -0700
summary:     trac_5794-revised.patch modified for combinat server

```


I can tell that

changeset 13469 == trac_5794-long-time-nt.patch (modulo fuzz)

and

changeset 13368 == trac_5794-reviewer-nt.patch.

Furthermore,

changeset 13367 differs from trac_5794-more-exceptional.patch only in having `is_irreducible` and `is_reducible` in lieu of `is_atomic` and `is_compound`.

The difference between changeset 13366 and trac_5794-exceptional.patch is more substantial, and is what caused the bug in the present ticket. Someone else should look into the diff to check if this is the only issue caused!

The difference between changeset 13365 and trac_5794-continued.patch is again only in irreducible-vs-atomic and reducible-vs-compound.

Changeset 13364 is not an attachment on #5794 and all it does is replacing some "reducible" by "compound" resp. "irreducible" by "atomic".

Changeset 13363 ("this temporary patch to be taken down when root system and 5794 patches stabilize.") seems not to be from the #5794 attachments either, and I don't really understand what it does. I don't know if anyone has ever "taken it down" or reverted its edits.

Changeset 13362 has noticeable differences from trac_5794-revised.patch and maybe someone should look into that.
