# Issue 16369: Symmetric function computations in Witt basis leak into quotient field

Issue created by migration from Trac.

Original creator: darij

Original creation time: 2014-07-03 05:16:02

CC:  sage-combinat nthiery zabrocki

Keywords: symmetric functions, sage-combinat


```
Sym = SymmetricFunctions(ZZ)
w = Sym.w()
w[4].coproduct()
```

This would fail because `w[4]` would be transformed into the h-basis, which would make some of its coefficients into rationals even though they should be integers.

The cause is the fact that inverting an integer matrix can turn its entries into rationals even if the matrix is invertible over ZZ. I have fixed this in a way I believe to be suboptimal, but this is all I have time for...


---

Comment by git created at 2014-07-04 07:05:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-07-04 07:07:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-07-04 07:21:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-07-04 07:29:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-07-14 23:33:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by darij created at 2014-07-15 00:17:51

Changing status from new to needs_info.


---

Comment by darij created at 2014-07-15 00:19:35

The info that this ticket is in need for is whether it is OK to rely on sage's ability to invert an invertible matrix over an arbitrary base ring. The matrix is defined over ZZ (and is invertible over ZZ), but Sage does not know that, and the worry is that over some rings it might not find the inverse despite its existence.


---

Comment by tscrim created at 2014-07-15 03:13:35

I would perhaps do something like this as the workaround:

```python
inv_m = ~m
try:
    inv_m = inv_m.change_ring(m.base_ring())
except TypeError: # It's not in the base ring as we thought it was
    pass
```

or without the `try/except` block if it should fail.

I would also say the using Sage's ability to invert the matrix over general base rings is the only realistic way to work (unless I'm missing something).


---

Comment by darij created at 2014-07-15 09:19:53

Thanks, but this begs my question, which I guess was unclear.

The thing that can fail is not the "change_ring"; it's the inversion itself. And what I am worried is that it could fail despite the matrix (which is actually an integer matrix with determinant -+1) having an inverse. The one realistic workaround for that is to do these matrix computations over the base ring ZZ rather than the given base ring for the symmetric functions. This could have the additional advantage that the matrices are constructed only once even if I work over different rings at the same time. Is it worth redesigning the Witt basis?


---

Comment by tscrim created at 2014-07-15 17:37:23

Are you worried about rings with positive characteristic (in which case, if it fails, is the basis even well-defined)? I believe we should just leave it as (doing the matrix inversion over the base ring) is until we come across a definite problem.


---

Comment by darij created at 2014-07-15 17:40:14

Not so much positive-characteristic as rings which are too complicated for inversion (I'm thinking of symmetric functions over symmetric functions, but right now this is probably made impossible by other issues).

OK, needs_review then (and thanks for the feedback!).


---

Comment by darij created at 2014-07-15 17:40:14

Changing status from needs_info to needs_review.


---

Comment by git created at 2014-07-29 10:49:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-08-23 00:37:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2014-08-23 00:38:53

I made some review tweaks. If you're happy with them, then go ahead and set a positive review.


---

Comment by darij created at 2014-08-23 01:02:51

Thanks a lot for the review! I wish I had the time to reciprocate...

Sorry, but your Bernstein operator on the immaculate basis doesn't work, since n could be nonpositive. Maybe you can delegate this case to the "super" version of the method? (I'm not saying you should; removing the thing is just as fine.)


---

Comment by darij created at 2014-08-23 11:28:45

Alternatively, you could use the `immaculate_function` method on any basis (I think they all go through the complete basis, so that's where you want to do it). That gives you the immaculate function for every integer vector.


```
sage: NSym = NonCommutativeSymmetricFunctions(QQ)
sage: I = NSym.I()
sage: I.immaculate_function([-1,2,2,2]) # that should be the -1-st Bernstein of I[2,2,2]
I[1, 1, 1, 2] + I[1, 1, 2, 1] + I[1, 2, 1, 1] - I[1, 2, 2]
sage: I.immaculate_function([0,2,3,2])
-I[1, 1, 3, 2] - I[1, 2, 2, 2] - I[1, 2, 3, 1] + I[2, 3, 2]
```


But I am not sure if this is faster than just going through the complete basis...


---

Comment by git created at 2014-08-23 14:54:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2014-08-23 14:54:43

I decided to push to the super. Fixed.


---

Comment by git created at 2014-08-23 15:08:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by darij created at 2014-08-23 15:09:02

Thanks again. If you are fine with my last commit, please set to positive_review.


---

Comment by tscrim created at 2014-08-23 15:24:54

LGTM


---

Comment by tscrim created at 2014-08-23 15:24:54

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-08-24 12:31:43

Resolution: fixed
