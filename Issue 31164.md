# Issue 31164: Segmentation fault when calculating the taylor series of a specific function

Issue created by migration from https://trac.sagemath.org/ticket/31401

Original creator: @frcl

Original creation time: 2021-02-15 14:01:35

The following code evaluated in Sage 9.2 leads to a segmentation fault


```
sin(4*arctan(1/(sqrt(3) + 2))-x).taylor(x, 0, 1)
```


The error message is


```
;;;
;;; Detected access to protected memory, also known as 'bus or segmentation fault'.
;;; Jumping to the outermost toplevel prompt
;;;
```


Changing the constant slightly gives the desired result, e.g.


```
sin(4*arctan(1/(sqrt(3) + 1))-x).taylor(x, 0, 1)
```


evaluates to 


```
-x*cos(4*arctan(1/2*sqrt(3) - 1/2)) + sin(4*arctan(1/2*sqrt(3) - 1/2))
```



---

Comment by @DaveWitteMorris created at 2021-02-16 07:50:12

This is a maxima bug:

```
(%i1) taylor(sin(atan(1/(sqrt(3) + 2)) - x), x, 0, 1);

      Message from maxima's stderr stream: INFO: Control stack guard page unprotected
      Control stack guard page temporarily disabled: proceed with caution
      Control stack guard page temporarily disabled: proceed with caution
      Maxima encountered a Lisp error:
       Control stack exhausted (no more space for function call frames).
      This is probably due to heavily nested or infinitely recursive function
      calls, or a tail call that SBCL cannot or has not optimized away.
```

I tested with some other nonzero integers `a` and `b` in the place of `3` and `2`. It seems that the crash happens whenever `a < b^2` (including all cases where `a < 0`).


---

Comment by @DaveWitteMorris created at 2021-02-16 07:50:12

Changing keywords from "" to "maxima, taylor series".


---

Comment by @frcl created at 2021-02-16 13:51:55

Replying to [comment:1 gh-DaveWitteMorris]:
> I tested with some other nonzero integers `a` and `b` in the place of `3` and `2`. It seems that the crash happens whenever `a < b^2` (including all cases where `a < 0`).

This seems to be the case, except if `a` is a square number. I guess the `sqrt` is evaluated first in that case. This implies that the `sqrt` is somehow involved in triggering the bug.

I will file a bug report on the maxima bug tracker. Should I close the ticket here?


---

Comment by @DaveWitteMorris created at 2021-02-16 20:19:58

Thanks for volunteering to report the bug to maxima (and for clarifying that `a` should not be a square). 

Please keep this ticket open.  The "Report Upstream" field of this ticket should be set to "Reported upstream. No feedback yet", and that field can be updated as the situation progresses. It would also be helpful if you can add a comment here with a link to the maxima bug report, so it is easy for sage trac followers to check on the status in maxima.


---

Comment by @DaveWitteMorris created at 2021-02-16 20:38:29

PS If you need a workaround for the bug, you can replace `2` with a variable, and then substitute at the end:

```
sage: var('a');
sage: sin(4*arctan(1/(sqrt(3) + a))-x).taylor(x, 0, 1).subs(a=2)
-x*cos(4*arctan(1/(sqrt(3) + 2))) + sin(4*arctan(1/(sqrt(3) + 2)))
```



---

Comment by slelievre created at 2021-02-16 23:08:24

Upstream ticket in the Maxima bug tracker:

- https://sourceforge.net/p/maxima/bugs/3716/


---

Comment by mkoeppe created at 2021-05-10 17:42:09

Moving to 9.4, as 9.3 has been released.
