# Issue 18655: Singular fails to build on Ubuntu 15.04 32-bit

Issue created by migration from https://trac.sagemath.org/ticket/18892

Original creator: vbraun

Original creation time: 2015-07-13 18:04:38

CC:  jdemeyer

Singular fails to build on Ubuntu 15.04 32-bit due to a missing symbol related to the stack protector:

```
checking for __stack_chk_fail_local in -lc_nonshared... yes
[...]
g++ -g -pipe -fno-implicit-templates -I. -I.. -I/mnt/highperf/buildbot/slave/sage_git/build/local  -I/mnt/highperf/buildbot/slave/sage_git/build/local/include -I/mnt/highperf/buildbot/slave/sage_git/build/local/include -I/mnt/highperf/buildbot/slave/sage_git/build/local/include   -Dix86_Linux -DHAVE_CONFIG_H -DDL_TAIL=\"sog\" -fpic -DPIC -Dp_Procs_FieldZp -c p_Procs_Lib.cc -o p_Procs_Lib_FieldZp.dl_og
ld -shared -L/mnt/highperf/buildbot/slave/sage_git/build/local/lib -lflint -lmpfr -lmpir -o p_Procs_FieldZp.sog p_Procs_Lib_FieldZp.dl_og
p_Procs_Lib_FieldZp.dl_og: In function `p_Copy__FieldZp_LengthGeneral_OrdGeneral':
/mnt/highperf/buildbot/slave/sage_git/build/local/var/tmp/sage/build/singular-3.1.7p1.p0/src/latest/kernel/../kernel/p_Copy__T.cc:36: undefined reference to `__stack_chk_fail_local'
p_Procs_Lib_FieldZp.dl_og: In function `pp_Mult_nn__FieldZp_LengthGeneral_OrdGeneral':
/mnt/highperf/buildbot/slave/sage_git/build/local/var/tmp/sage/build/singular-3.1.7p1.p0/src/latest/kernel/../kernel/pp_Mult_nn__T.cc:58: undefined reference to `__stack_chk_fail_local'
p_Procs_Lib_FieldZp.dl_og: In function `pp_Mult_mm__FieldZp_LengthGeneral_OrdGeneral':
/mnt/highperf/buildbot/slave/sage_git/build/local/var/tmp/sage/build/singular-3.1.7p1.p0/src/latest/kernel/../kernel/pp_Mult_mm__T.cc:61: undefined reference to `__stack_chk_fail_local'
p_Procs_Lib_FieldZp.dl_og: In function `p_Minus_mm_Mult_qq__FieldZp_LengthGeneral_OrdGeneral':
/mnt/highperf/buildbot/slave/sage_git/build/local/var/tmp/sage/build/singular-3.1.7p1.p0/src/latest/kernel/../kernel/p_Minus_mm_Mult_qq__T.cc:164: undefined reference to `__stack_chk_fail_local'
p_Procs_Lib_FieldZp.dl_og: In function `pp_Mult_mm_Noether__FieldZp_LengthGeneral_OrdGeneral':
/mnt/highperf/buildbot/slave/sage_git/build/local/var/tmp/sage/build/singular-3.1.7p1.p0/src/latest/kernel/../kernel/pp_Mult_mm_Noether__T.cc:69: undefined reference to `__stack_chk_fail_local'
p_Procs_Lib_FieldZp.dl_og:/mnt/highperf/buildbot/slave/sage_git/build/local/var/tmp/sage/build/singular-3.1.7p1.p0/src/latest/kernel/../kernel/p_Add_q__T.cc:92: more undefined references to `__stack_chk_fail_local' follow
ld: p_Procs_FieldZp.sog: hidden symbol `__stack_chk_fail_local' isn't defined
ld: final link failed: Bad value
Makefile:377: recipe for target 'p_Procs_FieldZp.sog' failed
```

Full log: http://build.sagedev.org/release/builders/%20%20slow%20AIMS%20bu15_32s02%20%28Ubuntu%2015.04%2032%20bit%29%20full/builds/3/steps/compile_1/logs/singular


---

Comment by fbissey created at 2015-07-13 20:03:26

I solved this in sage-on-gentoo by linking with `g++` instead of `ld` see https://github.com/cschwan/sage-on-gentoo/issues/352
and I have a patch here: https://raw.githubusercontent.com/cschwan/sage-on-gentoo/master/sci-mathematics/singular/files/singular-3.1.7-use_cxx_for_linking.patch


---

Comment by vbraun created at 2015-07-13 20:57:35

Changing status from new to needs_review.


---

Comment by vbraun created at 2015-07-13 20:57:35

New commits:


---

Comment by vbraun created at 2015-07-13 20:57:55

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-07-14 20:41:56

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2015-07-14 20:41:56

Doesn't work on OSX: with the patch Sage then can't link to libsingular

```
g++ -bundle -undefined dynamic_lookup -L/Users/buildslave-sage/slave/sage_git/build/local/lib build/temp.macosx-10.9-x86_64-2.7/Users/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/algebras/letterplace/letterplace_ideal.o -L/Users/buildslave-sage/slave/sage_git/build/local/lib -L/Users/buildslave-sage/slave/sage_git/build/local/lib -lsingular -lntl -lflint -lgmp -lgmpxx -lm -lreadline -lstdc++ -o build/lib.macosx-10.9-x86_64-2.7/sage/algebras/letterplace/letterplace_ideal.so
ld: can't link with a main executable file '/Users/buildslave-sage/slave/sage_git/build/local/lib/libsingular.dylib' for architecture x86_64
collect2: error: ld returned 1 exit status
```



---

Comment by fbissey created at 2015-07-14 21:29:48

Hum, sage-on-gentoo on OS X is not currently working so I hadn't tested that. It looks like `libsingular.dylib` is linked wrong. Need to check what it exactly does.


---

Comment by fbissey created at 2015-07-14 22:11:56

Linking needs to be changed from `dynamic` to `dynamiclib` on OS X I think looking into it.


---

Comment by fbissey created at 2015-07-14 23:10:06

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2015-07-14 23:10:06

Small addition to `Singular/configure` the default option for linking meant that with the change from `ld` to `g++`, `libsingular.dylib` became an executable rather than a library as stated in the error when building sage. The added patch corrects this behaviour and `libsingular.dylib` is again a dynamic library.
----
New commits:


---

Comment by vbraun created at 2015-07-15 20:07:16

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-07-15 22:23:51

Resolution: fixed
