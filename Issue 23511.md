# Issue 23511: Run doctests with limited memory

archive/issues_023511.json:
```json
{
    "body": "Sometimes, due to bugs, it can happen that doctests take a very large amount of memory, causing trouble for the OS. I suggest to find a reasonable value of `ulimit -v` and use that to limit the virtual memory taken by doctests. This is also a check that doctests do not use too large amounts of memory.\n\nIssue created by migration from https://trac.sagemath.org/ticket/23748\n\n",
    "created_at": "2017-08-30T08:28:11Z",
    "labels": [
        "doctest framework",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Run doctests with limited memory",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23511",
    "user": "jdemeyer"
}
```
Sometimes, due to bugs, it can happen that doctests take a very large amount of memory, causing trouble for the OS. I suggest to find a reasonable value of `ulimit -v` and use that to limit the virtual memory taken by doctests. This is also a check that doctests do not use too large amounts of memory.

Issue created by migration from https://trac.sagemath.org/ticket/23748





---

archive/issue_comments_329457.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-08-30T15:10:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329457",
    "user": "jdemeyer"
}
```

New commits:



---

archive/issue_comments_329458.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-08-30T15:10:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329458",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_329459.json:
```json
{
    "body": "Maybe this should be discussed on sage-devel, but my vote would be for 1Gb as IMO, doctests should in general not use a large amount of memory similar to the paradigm that they should be fast.",
    "created_at": "2017-08-30T15:56:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329459",
    "user": "tscrim"
}
```

Maybe this should be discussed on sage-devel, but my vote would be for 1Gb as IMO, doctests should in general not use a large amount of memory similar to the paradigm that they should be fast.



---

archive/issue_comments_329460.json:
```json
{
    "body": "Replying to [comment:3 tscrim]:\n> Maybe this should be discussed on sage-devel, but my vote would be for 1Gb as IMO, doctests should in general not use a large amount of memory similar to the paradigm that they should be fast.\n\nWith 1GB, you cannot even start Sage.\n\nAnd some doctests in `src/sage/schemes/elliptic_curves/heegner.py` do not pass with a limit of only 3GB.",
    "created_at": "2017-08-30T17:09:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329460",
    "user": "jdemeyer"
}
```

Replying to [comment:3 tscrim]:
> Maybe this should be discussed on sage-devel, but my vote would be for 1Gb as IMO, doctests should in general not use a large amount of memory similar to the paradigm that they should be fast.

With 1GB, you cannot even start Sage.

And some doctests in `src/sage/schemes/elliptic_curves/heegner.py` do not pass with a limit of only 3GB.



---

archive/issue_comments_329461.json:
```json
{
    "body": "Replying to [comment:3 tscrim]:\n> doctests should in general not use a large amount of memory similar to the paradigm that they should be fast.\n\nThat's precisely the reason for this patch.",
    "created_at": "2017-08-30T17:10:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329461",
    "user": "jdemeyer"
}
```

Replying to [comment:3 tscrim]:
> doctests should in general not use a large amount of memory similar to the paradigm that they should be fast.

That's precisely the reason for this patch.



---

archive/issue_comments_329462.json:
```json
{
    "body": "Replying to [comment:4 jdemeyer]:\n> Replying to [comment:3 tscrim]:\n> > Maybe this should be discussed on sage-devel, but my vote would be for 1Gb as IMO, doctests should in general not use a large amount of memory similar to the paradigm that they should be fast.\n> \n> With 1GB, you cannot even start Sage.\n\nOh, I was thinking this was the amount of memory specifically used by any particular doctest, not Sage + doctests. What about when doctests are run in parallel? Since it is using threads, we still have the same limit of 4Gb, so I am worried we will hit this limit on systems with larger amounts of cores.\n\n> And some doctests in `src/sage/schemes/elliptic_curves/heegner.py` do not pass with a limit of only 3GB.\n\nMaybe we also want to consider a `# high memory` marker (another ticket?) or have `# long time` also allow higher memory?",
    "created_at": "2017-08-30T17:23:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329462",
    "user": "tscrim"
}
```

Replying to [comment:4 jdemeyer]:
> Replying to [comment:3 tscrim]:
> > Maybe this should be discussed on sage-devel, but my vote would be for 1Gb as IMO, doctests should in general not use a large amount of memory similar to the paradigm that they should be fast.
> 
> With 1GB, you cannot even start Sage.

Oh, I was thinking this was the amount of memory specifically used by any particular doctest, not Sage + doctests. What about when doctests are run in parallel? Since it is using threads, we still have the same limit of 4Gb, so I am worried we will hit this limit on systems with larger amounts of cores.

> And some doctests in `src/sage/schemes/elliptic_curves/heegner.py` do not pass with a limit of only 3GB.

Maybe we also want to consider a `# high memory` marker (another ticket?) or have `# long time` also allow higher memory?



---

archive/issue_comments_329463.json:
```json
{
    "body": "Replying to [comment:7 tscrim]:\n> Oh, I was thinking this was the amount of memory specifically used by any particular doctest, not Sage + doctests.\n\nNo, it is the virtual memory limit for the whole process. This includes code (Python + Python modules + libraries) and data, also unused but allocated memory (like the PARI stack).\n\n> What about when doctests are run in parallel? Since it is using threads\n\nNo! It uses processes, not threads. The limit is per process, so we do not need to worry about that.\n\n> > And some doctests in `src/sage/schemes/elliptic_curves/heegner.py` do not pass with a limit of only 3GB.\n> \n> Maybe we also want to consider a `# high memory` marker (another ticket?) or have `# long time` also allow higher memory?\n\nPerhaps, but this is just a very simple limit, comparable to the absolute doctest time limit of 360s (short tests) or 1800s (long tests).",
    "created_at": "2017-08-30T19:16:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329463",
    "user": "jdemeyer"
}
```

Replying to [comment:7 tscrim]:
> Oh, I was thinking this was the amount of memory specifically used by any particular doctest, not Sage + doctests.

No, it is the virtual memory limit for the whole process. This includes code (Python + Python modules + libraries) and data, also unused but allocated memory (like the PARI stack).

> What about when doctests are run in parallel? Since it is using threads

No! It uses processes, not threads. The limit is per process, so we do not need to worry about that.

> > And some doctests in `src/sage/schemes/elliptic_curves/heegner.py` do not pass with a limit of only 3GB.
> 
> Maybe we also want to consider a `# high memory` marker (another ticket?) or have `# long time` also allow higher memory?

Perhaps, but this is just a very simple limit, comparable to the absolute doctest time limit of 360s (short tests) or 1800s (long tests).



---

archive/issue_comments_329464.json:
```json
{
    "body": "I'll try to lower the limit of 4GiB somewhat, but it certainly must be higher than 3GiB.",
    "created_at": "2017-08-30T19:21:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329464",
    "user": "jdemeyer"
}
```

I'll try to lower the limit of 4GiB somewhat, but it certainly must be higher than 3GiB.



---

archive/issue_comments_329465.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-08-30T19:46:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329465",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_329466.json:
```json
{
    "body": "Replying to [comment:8 jdemeyer]:\n> Replying to [comment:7 tscrim]:\n> > What about when doctests are run in parallel? Since it is using threads\n> \n> No! It uses processes, not threads. The limit is per process, so we do not need to worry about that.\n\nWe should probably change this then:\n\n```\ntravis@apricot:~/sage/src/sage/categories$ sage -tp category.py category_types.py \n[snip]\nDoctesting 2 files using 8 threads.\n```\n\nAlthough I am somewhat surprised my memory usage is not higher when I am running parallel tests since each copy of Sage should take a minimum of 1Gb. *shrugs*, oh well, not important.\n\n> > > And some doctests in `src/sage/schemes/elliptic_curves/heegner.py` do not pass with a limit of only 3GB.\n> > \n> > Maybe we also want to consider a `# high memory` marker (another ticket?) or have `# long time` also allow higher memory?\n> \n> Perhaps, but this is just a very simple limit, comparable to the absolute doctest time limit of 360s (short tests) or 1800s (long tests).\n\nI don't mind 4Gb, I probably prefer it over the 3.x for simplicity.",
    "created_at": "2017-08-30T21:23:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329466",
    "user": "tscrim"
}
```

Replying to [comment:8 jdemeyer]:
> Replying to [comment:7 tscrim]:
> > What about when doctests are run in parallel? Since it is using threads
> 
> No! It uses processes, not threads. The limit is per process, so we do not need to worry about that.

We should probably change this then:

```
travis@apricot:~/sage/src/sage/categories$ sage -tp category.py category_types.py 
[snip]
Doctesting 2 files using 8 threads.
```

Although I am somewhat surprised my memory usage is not higher when I am running parallel tests since each copy of Sage should take a minimum of 1Gb. *shrugs*, oh well, not important.

> > > And some doctests in `src/sage/schemes/elliptic_curves/heegner.py` do not pass with a limit of only 3GB.
> > 
> > Maybe we also want to consider a `# high memory` marker (another ticket?) or have `# long time` also allow higher memory?
> 
> Perhaps, but this is just a very simple limit, comparable to the absolute doctest time limit of 360s (short tests) or 1800s (long tests).

I don't mind 4Gb, I probably prefer it over the 3.x for simplicity.



---

archive/issue_comments_329467.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-08-31T08:29:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329467",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_329468.json:
```json
{
    "body": "Replying to [comment:14 tscrim]:\n> each copy of Sage should take a minimum of 1Gb.\n\nWell, remember that this is *virtual* memory. Most of that 1GB is shared between processes. If you run 10 copies of Sage, the executable code of Sage needs to be in *physical* memory only once: the OS maps the same physical memory inside the 10 processes.\n\nThen there is also memory which is reserved but typically not used: Sage might allocate a large PARI stack and GAP memory pool for example which counts against virtual memory. However, as long as this memory is not actually used, you don't need that much physical memory.",
    "created_at": "2017-08-31T08:35:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329468",
    "user": "jdemeyer"
}
```

Replying to [comment:14 tscrim]:
> each copy of Sage should take a minimum of 1Gb.

Well, remember that this is *virtual* memory. Most of that 1GB is shared between processes. If you run 10 copies of Sage, the executable code of Sage needs to be in *physical* memory only once: the OS maps the same physical memory inside the 10 processes.

Then there is also memory which is reserved but typically not used: Sage might allocate a large PARI stack and GAP memory pool for example which counts against virtual memory. However, as long as this memory is not actually used, you don't need that much physical memory.



---

archive/issue_comments_329469.json:
```json
{
    "body": "It turns out that even 4GiB is not enough... This new version uses 4500MiB which passes `make ptestlong` on my machine.",
    "created_at": "2017-08-31T08:39:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329469",
    "user": "jdemeyer"
}
```

It turns out that even 4GiB is not enough... This new version uses 4500MiB which passes `make ptestlong` on my machine.



---

archive/issue_comments_329470.json:
```json
{
    "body": "Replying to [comment:17 jdemeyer]:\n> Replying to [comment:14 tscrim]:\n> > each copy of Sage should take a minimum of 1Gb.\n> \n> Well, remember that this is *virtual* memory. Most of that 1GB is shared between processes. If you run 10 copies of Sage, the executable code of Sage needs to be in *physical* memory only once: the OS maps the same physical memory inside the 10 processes.\n> \n> Then there is also memory which is reserved but typically not used: Sage might allocate a large PARI stack and GAP memory pool for example which counts against virtual memory. However, as long as this memory is not actually used, you don't need that much physical memory.\n\nAh, right. Thank you for the explanation.",
    "created_at": "2017-08-31T14:04:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329470",
    "user": "tscrim"
}
```

Replying to [comment:17 jdemeyer]:
> Replying to [comment:14 tscrim]:
> > each copy of Sage should take a minimum of 1Gb.
> 
> Well, remember that this is *virtual* memory. Most of that 1GB is shared between processes. If you run 10 copies of Sage, the executable code of Sage needs to be in *physical* memory only once: the OS maps the same physical memory inside the 10 processes.
> 
> Then there is also memory which is reserved but typically not used: Sage might allocate a large PARI stack and GAP memory pool for example which counts against virtual memory. However, as long as this memory is not actually used, you don't need that much physical memory.

Ah, right. Thank you for the explanation.



---

archive/issue_comments_329471.json:
```json
{
    "body": "Replying to [comment:18 jdemeyer]:\n> It turns out that even 4GiB is not enough... This new version uses 4500MiB which passes `make ptestlong` on my machine.\n\nI am pretty sure it is this block of tests that takes the large amount of memory (with `n = 10`):\n\n```\n        sage: from itertools import permutations\n        sage: suitr_preferences = list(permutations([-i-1 for i in range(n)]))\n        sage: revr_preferences = list(permutations([i+1 for i in range(n)]))\n        sage: for player in range(n):\n        ....:     big_game.suitors()[player].pref = suitr_preferences[player]\n        ....:     big_game.reviewers()[player].pref = revr_preferences[-player]\n        sage: big_game.solve()\n        {1: -1, 2: -8, 3: -9, 4: -10, 5: -7, 6: -6, 7: -5, 8: -4, 9: -3, 10: -2}\n```\n\nThat is `2 * 10! * 10 == 72576000` integers plus other stuff. Might consider dropping `n = 8` instead for this example.",
    "created_at": "2017-08-31T14:13:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329471",
    "user": "tscrim"
}
```

Replying to [comment:18 jdemeyer]:
> It turns out that even 4GiB is not enough... This new version uses 4500MiB which passes `make ptestlong` on my machine.

I am pretty sure it is this block of tests that takes the large amount of memory (with `n = 10`):

```
        sage: from itertools import permutations
        sage: suitr_preferences = list(permutations([-i-1 for i in range(n)]))
        sage: revr_preferences = list(permutations([i+1 for i in range(n)]))
        sage: for player in range(n):
        ....:     big_game.suitors()[player].pref = suitr_preferences[player]
        ....:     big_game.reviewers()[player].pref = revr_preferences[-player]
        sage: big_game.solve()
        {1: -1, 2: -8, 3: -9, 4: -10, 5: -7, 6: -6, 7: -5, 8: -4, 9: -3, 10: -2}
```

That is `2 * 10! * 10 == 72576000` integers plus other stuff. Might consider dropping `n = 8` instead for this example.



---

archive/issue_comments_329472.json:
```json
{
    "body": "Maybe, but I consider lowering the actual memory requirements of doctests outside the scope of this ticket.",
    "created_at": "2017-08-31T14:59:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329472",
    "user": "jdemeyer"
}
```

Maybe, but I consider lowering the actual memory requirements of doctests outside the scope of this ticket.



---

archive/issue_comments_329473.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-08-31T15:23:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329473",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_329474.json:
```json
{
    "body": "This is failing badly on the patchbot",
    "created_at": "2017-08-31T15:23:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329474",
    "user": "jdemeyer"
}
```

This is failing badly on the patchbot



---

archive/issue_comments_329475.json:
```json
{
    "body": "The problem seems to be that `setrlimit()` is done way too late. We need to limit the memory *before* starting Sage.",
    "created_at": "2017-09-04T08:50:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329475",
    "user": "jdemeyer"
}
```

The problem seems to be that `setrlimit()` is done way too late. We need to limit the memory *before* starting Sage.



---

archive/issue_comments_329476.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-09-04T09:48:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329476",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_329477.json:
```json
{
    "body": "New attempt, this time limiting the memory in the `sage-runtests` script. Let's see what the patchbot says...",
    "created_at": "2017-09-04T09:50:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329477",
    "user": "jdemeyer"
}
```

New attempt, this time limiting the memory in the `sage-runtests` script. Let's see what the patchbot says...



---

archive/issue_comments_329478.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-09-04T09:50:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329478",
    "user": "jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_329479.json:
```json
{
    "body": "Hmm, patchbots won't test this because it's \"unsafe\".",
    "created_at": "2017-09-05T08:42:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329479",
    "user": "jdemeyer"
}
```

Hmm, patchbots won't test this because it's "unsafe".



---

archive/issue_comments_329480.json:
```json
{
    "body": "In case it helps, I did test this on `sardonis` (ppc64le with lots of RAM) and on my laptop (`x86_64` with 6GB of RAM) and it passed tests. 32-bit should also pass for the simple reason that the condition `memlimit <= sys.maxsize()` will be false.\n\nI just got hit again by the issue of doctests taking infinite memory, apparently this creates an infinite list:\n\n```\nsage: L = [1, 2, 3]\nsage: L.extend(-x for x in L)\n```\n\n\nI'm just saying that this ticket protects against stupid mistakes like this, which might otherwise cause the system to start to swap and become unresponsive.",
    "created_at": "2017-09-05T08:45:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329480",
    "user": "jdemeyer"
}
```

In case it helps, I did test this on `sardonis` (ppc64le with lots of RAM) and on my laptop (`x86_64` with 6GB of RAM) and it passed tests. 32-bit should also pass for the simple reason that the condition `memlimit <= sys.maxsize()` will be false.

I just got hit again by the issue of doctests taking infinite memory, apparently this creates an infinite list:

```
sage: L = [1, 2, 3]
sage: L.extend(-x for x in L)
```


I'm just saying that this ticket protects against stupid mistakes like this, which might otherwise cause the system to start to swap and become unresponsive.



---

archive/issue_comments_329481.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-09-05T14:00:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329481",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_329482.json:
```json
{
    "body": "Replying to [comment:27 jdemeyer]:\n> In case it helps, I did test this on `sardonis` (ppc64le with lots of RAM) and on my laptop (`x86_64` with 6GB of RAM) and it passed tests. 32-bit should also pass for the simple reason that the condition `memlimit <= sys.maxsize()` will be false.\n\nEverything seems to be okay on my laptop as well (`x86_64` with 8Gb of RAM).\n\n> I just got hit again by the issue of doctests taking infinite memory, apparently this creates an infinite list:\n> {{{\n> sage: L = [1, 2, 3]\n> sage: L.extend(-x for x in L)\n> }}}\n\nI'm actually slightly surprised Python doesn't catch that as it does so well (sometimes too well) with mutating `dict`s.\n\n> I'm just saying that this ticket protects against stupid mistakes like this, which might otherwise cause the system to start to swap and become unresponsive.\n\nIndeed. Let's kick this to the buildbots and into a beta to see if this causes any trouble.",
    "created_at": "2017-09-05T14:00:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329482",
    "user": "tscrim"
}
```

Replying to [comment:27 jdemeyer]:
> In case it helps, I did test this on `sardonis` (ppc64le with lots of RAM) and on my laptop (`x86_64` with 6GB of RAM) and it passed tests. 32-bit should also pass for the simple reason that the condition `memlimit <= sys.maxsize()` will be false.

Everything seems to be okay on my laptop as well (`x86_64` with 8Gb of RAM).

> I just got hit again by the issue of doctests taking infinite memory, apparently this creates an infinite list:
> {{{
> sage: L = [1, 2, 3]
> sage: L.extend(-x for x in L)
> }}}

I'm actually slightly surprised Python doesn't catch that as it does so well (sometimes too well) with mutating `dict`s.

> I'm just saying that this ticket protects against stupid mistakes like this, which might otherwise cause the system to start to swap and become unresponsive.

Indeed. Let's kick this to the buildbots and into a beta to see if this causes any trouble.



---

archive/issue_comments_329483.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-09-06T17:49:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329483",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_329484.json:
```json
{
    "body": "I'm getting \n\n```\nsage -t --warn-long 69.8 src/sage/game_theory/matching_game.py\n**********************************************************************\nFile \"src/sage/game_theory/matching_game.py\", line 161, in sage.game_theory.matching_game.MatchingGame\nFailed example:\n    revr_preferences = list(permutations([i+1 for i in range(n)]))\nException raised:\n    Traceback (most recent call last):\n      File \"/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 515, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 885, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.game_theory.matching_game.MatchingGame[17]>\", line 1, in <module>\n        revr_preferences = list(permutations([i+Integer(1) for i in range(n)]))\n    MemoryError\n```\n\nHere n=10, so 10! permutations...\n\nPS: This is x86_64 with 32GB ram",
    "created_at": "2017-09-06T17:49:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329484",
    "user": "vbraun"
}
```

I'm getting 

```
sage -t --warn-long 69.8 src/sage/game_theory/matching_game.py
**********************************************************************
File "src/sage/game_theory/matching_game.py", line 161, in sage.game_theory.matching_game.MatchingGame
Failed example:
    revr_preferences = list(permutations([i+1 for i in range(n)]))
Exception raised:
    Traceback (most recent call last):
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 515, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 885, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.game_theory.matching_game.MatchingGame[17]>", line 1, in <module>
        revr_preferences = list(permutations([i+Integer(1) for i in range(n)]))
    MemoryError
```

Here n=10, so 10! permutations...

PS: This is x86_64 with 32GB ram



---

archive/issue_comments_329485.json:
```json
{
    "body": "Same as Volker. Also x86_64 with 32GB (although `free` says 12GB are free and 25GB available).",
    "created_at": "2017-09-06T21:18:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329485",
    "user": "fbissey"
}
```

Same as Volker. Also x86_64 with 32GB (although `free` says 12GB are free and 25GB available).



---

archive/issue_comments_329486.json:
```json
{
    "body": "Replying to [comment:29 vbraun]:\n> I'm getting \n> {{{\n> sage -t --warn-long 69.8 src/sage/game_theory/matching_game.py\n> **********************************************************************\n> File \"src/sage/game_theory/matching_game.py\", line 161, in sage.game_theory.matching_game.MatchingGame\n> Failed example:\n>     revr_preferences = list(permutations([i+1 for i in range(n)]))\n> Exception raised:\n>     Traceback (most recent call last):\n>       File \"/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 515, in _run\n>         self.compile_and_execute(example, compiler, test.globs)\n>       File \"/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 885, in compile_and_execute\n>         exec(compiled, globs)\n>       File \"<doctest sage.game_theory.matching_game.MatchingGame[17]>\", line 1, in <module>\n>         revr_preferences = list(permutations([i+Integer(1) for i in range(n)]))\n>     MemoryError\n> }}}\n\nDid you run all doctests? Is this the only file which fails?",
    "created_at": "2017-09-06T21:24:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329486",
    "user": "jdemeyer"
}
```

Replying to [comment:29 vbraun]:
> I'm getting 
> {{{
> sage -t --warn-long 69.8 src/sage/game_theory/matching_game.py
> **********************************************************************
> File "src/sage/game_theory/matching_game.py", line 161, in sage.game_theory.matching_game.MatchingGame
> Failed example:
>     revr_preferences = list(permutations([i+1 for i in range(n)]))
> Exception raised:
>     Traceback (most recent call last):
>       File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 515, in _run
>         self.compile_and_execute(example, compiler, test.globs)
>       File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 885, in compile_and_execute
>         exec(compiled, globs)
>       File "<doctest sage.game_theory.matching_game.MatchingGame[17]>", line 1, in <module>
>         revr_preferences = list(permutations([i+Integer(1) for i in range(n)]))
>     MemoryError
> }}}

Did you run all doctests? Is this the only file which fails?



---

archive/issue_comments_329487.json:
```json
{
    "body": "Full failure\n\n```\nsage -t --long /usr/lib64/python2.7/site-packages/sage/game_theory/matching_game.py\n**********************************************************************\nFile \"/usr/lib64/python2.7/site-packages/sage/game_theory/matching_game.py\", line 161, in sage.game_theory.matching_game.MatchingGame\nFailed example:\n    revr_preferences = list(permutations([i+1 for i in range(n)]))\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib64/python2.7/site-packages/sage/doctest/forker.py\", line 518, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib64/python2.7/site-packages/sage/doctest/forker.py\", line 888, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.game_theory.matching_game.MatchingGame[17]>\", line 1, in <module>\n        revr_preferences = list(permutations([i+Integer(1) for i in range(n)]))\n    MemoryError\n**********************************************************************\nFile \"/usr/lib64/python2.7/site-packages/sage/game_theory/matching_game.py\", line 162, in sage.game_theory.matching_game.MatchingGame\nFailed example:\n    for player in range(n):\n        big_game.suitors()[player].pref = suitr_preferences[player]\n        big_game.reviewers()[player].pref = revr_preferences[-player]\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib64/python2.7/site-packages/sage/doctest/forker.py\", line 518, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib64/python2.7/site-packages/sage/doctest/forker.py\", line 888, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.game_theory.matching_game.MatchingGame[18]>\", line 3, in <module>\n        big_game.reviewers()[player].pref = revr_preferences[-player]\n    NameError: name 'revr_preferences' is not defined\n**********************************************************************\nFile \"/usr/lib64/python2.7/site-packages/sage/game_theory/matching_game.py\", line 165, in sage.game_theory.matching_game.MatchingGame\nFailed example:\n    big_game.solve()\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib64/python2.7/site-packages/sage/doctest/forker.py\", line 518, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib64/python2.7/site-packages/sage/doctest/forker.py\", line 888, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.game_theory.matching_game.MatchingGame[19]>\", line 1, in <module>\n        big_game.solve()\n      File \"/usr/lib64/python2.7/site-packages/sage/game_theory/matching_game.py\", line 901, in solve\n        self._is_complete()\n      File \"/usr/lib64/python2.7/site-packages/sage/game_theory/matching_game.py\", line 668, in _is_complete\n        raise ValueError(\"suitor preferences are not complete\")\n    ValueError: suitor preferences are not complete\n**********************************************************************\n```\n\nI cannot talk for Volker but this is the only file for which I have a failure related to this ticket. The other failure I got was #23497#comment:39",
    "created_at": "2017-09-06T21:42:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329487",
    "user": "fbissey"
}
```

Full failure

```
sage -t --long /usr/lib64/python2.7/site-packages/sage/game_theory/matching_game.py
**********************************************************************
File "/usr/lib64/python2.7/site-packages/sage/game_theory/matching_game.py", line 161, in sage.game_theory.matching_game.MatchingGame
Failed example:
    revr_preferences = list(permutations([i+1 for i in range(n)]))
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 518, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 888, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.game_theory.matching_game.MatchingGame[17]>", line 1, in <module>
        revr_preferences = list(permutations([i+Integer(1) for i in range(n)]))
    MemoryError
**********************************************************************
File "/usr/lib64/python2.7/site-packages/sage/game_theory/matching_game.py", line 162, in sage.game_theory.matching_game.MatchingGame
Failed example:
    for player in range(n):
        big_game.suitors()[player].pref = suitr_preferences[player]
        big_game.reviewers()[player].pref = revr_preferences[-player]
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 518, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 888, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.game_theory.matching_game.MatchingGame[18]>", line 3, in <module>
        big_game.reviewers()[player].pref = revr_preferences[-player]
    NameError: name 'revr_preferences' is not defined
**********************************************************************
File "/usr/lib64/python2.7/site-packages/sage/game_theory/matching_game.py", line 165, in sage.game_theory.matching_game.MatchingGame
Failed example:
    big_game.solve()
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 518, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 888, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.game_theory.matching_game.MatchingGame[19]>", line 1, in <module>
        big_game.solve()
      File "/usr/lib64/python2.7/site-packages/sage/game_theory/matching_game.py", line 901, in solve
        self._is_complete()
      File "/usr/lib64/python2.7/site-packages/sage/game_theory/matching_game.py", line 668, in _is_complete
        raise ValueError("suitor preferences are not complete")
    ValueError: suitor preferences are not complete
**********************************************************************
```

I cannot talk for Volker but this is the only file for which I have a failure related to this ticket. The other failure I got was #23497#comment:39



---

archive/issue_comments_329488.json:
```json
{
    "body": "Thats the only file that failed for me, too",
    "created_at": "2017-09-06T22:12:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329488",
    "user": "vbraun"
}
```

Thats the only file that failed for me, too



---

archive/issue_comments_329489.json:
```json
{
    "body": "If you both have only that file failing, it's a good reason to revisit those doctests after all and make them use less memory.",
    "created_at": "2017-09-07T10:31:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329489",
    "user": "jdemeyer"
}
```

If you both have only that file failing, it's a good reason to revisit those doctests after all and make them use less memory.



---

archive/issue_comments_329490.json:
```json
{
    "body": "But it didn't fail before this ticket and this ticket doesn't touch this particular file.",
    "created_at": "2017-09-07T10:35:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329490",
    "user": "fbissey"
}
```

But it didn't fail before this ticket and this ticket doesn't touch this particular file.



---

archive/issue_comments_329491.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-09-07T11:08:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329491",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_329492.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-09-07T11:10:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329492",
    "user": "jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_329493.json:
```json
{
    "body": "Replying to [comment:35 fbissey]:\n> But it didn't fail before this ticket and this ticket doesn't touch this particular file.\n\nThe point of this ticket is to limit the amount of memory that doctests are allowed to use. Apparently `matching_game.py` is the file which uses the most memory of all doctests. There is no reason why the testcase in the `matching_game.py` doctests must be so large. I just simplified that.",
    "created_at": "2017-09-07T11:10:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329493",
    "user": "jdemeyer"
}
```

Replying to [comment:35 fbissey]:
> But it didn't fail before this ticket and this ticket doesn't touch this particular file.

The point of this ticket is to limit the amount of memory that doctests are allowed to use. Apparently `matching_game.py` is the file which uses the most memory of all doctests. There is no reason why the testcase in the `matching_game.py` doctests must be so large. I just simplified that.



---

archive/issue_comments_329494.json:
```json
{
    "body": "Replying to [comment:35 fbissey]:\n> But it didn't fail before this ticket and this ticket doesn't touch this particular file.\n\nSo what would you suggest instead? Simply increasing the limit from 3300 MiB to some higher number?",
    "created_at": "2017-09-10T09:52:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329494",
    "user": "jdemeyer"
}
```

Replying to [comment:35 fbissey]:
> But it didn't fail before this ticket and this ticket doesn't touch this particular file.

So what would you suggest instead? Simply increasing the limit from 3300 MiB to some higher number?



---

archive/issue_comments_329495.json:
```json
{
    "body": "Replying to [comment:38 jdemeyer]:\n> Replying to [comment:35 fbissey]:\n> > But it didn't fail before this ticket and this ticket doesn't touch this particular file.\n> \n> So what would you suggest instead? Simply increasing the limit from 3300 MiB to some higher number?\n\nNo, after reading the description again properly, the fact that it passed before for me is irrelevant to what you try to achieve. I'll put it back to positive review to send it back to the bots.",
    "created_at": "2017-09-10T09:54:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329495",
    "user": "fbissey"
}
```

Replying to [comment:38 jdemeyer]:
> Replying to [comment:35 fbissey]:
> > But it didn't fail before this ticket and this ticket doesn't touch this particular file.
> 
> So what would you suggest instead? Simply increasing the limit from 3300 MiB to some higher number?

No, after reading the description again properly, the fact that it passed before for me is irrelevant to what you try to achieve. I'll put it back to positive review to send it back to the bots.



---

archive/issue_comments_329496.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-09-10T09:54:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329496",
    "user": "fbissey"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_329497.json:
```json
{
    "body": "Thanks!",
    "created_at": "2017-09-10T15:32:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329497",
    "user": "jdemeyer"
}
```

Thanks!



---

archive/issue_comments_329498.json:
```json
{
    "body": "Now I get this on Volker's develop branch\n\n```\nsage -t --long /usr/lib64/python2.7/site-packages/sage/rings/integer.pyx\n**********************************************************************\nFile \"/usr/lib64/python2.7/site-packages/sage/rings/integer.pyx\", line 2828, in sage.rings.integer.Integer.divisors\nFailed example:\n    for i in range(20):  # long time\n        try:\n            alarm(RDF.random_element(1e-3, 0.5))\n            _ = n.divisors()\n            cancel_alarm()  # we never get here\n        except AlarmInterrupt:\n            pass\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib64/python2.7/site-packages/sage/doctest/forker.py\", line 518, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib64/python2.7/site-packages/sage/doctest/forker.py\", line 888, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.rings.integer.Integer.divisors[19]>\", line 4, in <module>\n        _ = n.divisors()\n      File \"sage/rings/integer.pyx\", line 2897, in sage.rings.integer.Integer.divisors (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/rings/integer.c:19409)\n        ptr = <unsigned long*>check_allocarray(divisor_count, 3 * sizeof(unsigned long))\n      File \"memory.pxd\", line 87, in cysignals.memory.check_allocarray (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/rings/integer.c:45630)\n    MemoryError: failed to allocate 33554432 * 24 bytes\n**********************************************************************\n```\n\nI have another failure in that file that is not related to memory, so there is probably problems with other tickets touching that file. I'll see if I can find out which one(s).",
    "created_at": "2017-09-11T09:04:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329498",
    "user": "fbissey"
}
```

Now I get this on Volker's develop branch

```
sage -t --long /usr/lib64/python2.7/site-packages/sage/rings/integer.pyx
**********************************************************************
File "/usr/lib64/python2.7/site-packages/sage/rings/integer.pyx", line 2828, in sage.rings.integer.Integer.divisors
Failed example:
    for i in range(20):  # long time
        try:
            alarm(RDF.random_element(1e-3, 0.5))
            _ = n.divisors()
            cancel_alarm()  # we never get here
        except AlarmInterrupt:
            pass
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 518, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 888, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.integer.Integer.divisors[19]>", line 4, in <module>
        _ = n.divisors()
      File "sage/rings/integer.pyx", line 2897, in sage.rings.integer.Integer.divisors (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/rings/integer.c:19409)
        ptr = <unsigned long*>check_allocarray(divisor_count, 3 * sizeof(unsigned long))
      File "memory.pxd", line 87, in cysignals.memory.check_allocarray (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/rings/integer.c:45630)
    MemoryError: failed to allocate 33554432 * 24 bytes
**********************************************************************
```

I have another failure in that file that is not related to memory, so there is probably problems with other tickets touching that file. I'll see if I can find out which one(s).



---

archive/issue_comments_329499.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-09-11T13:47:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329499",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_329500.json:
```json
{
    "body": "Could this be the source of the problem in #24075?",
    "created_at": "2017-10-20T08:40:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329500",
    "user": "vdelecroix"
}
```

Could this be the source of the problem in #24075?



---

archive/issue_comments_329501.json:
```json
{
    "body": "Replying to [comment:44 vdelecroix]:\n> Could this be the source of the problem in #24075?\n\nI wouldn't think so but if you can repeat the failure you can just comment those two lines in `sage-runtests`\n\n```\n        if lim == resource.RLIM_INFINITY or lim > memlimit:\n            resource.setrlimit(resource.RLIMIT_AS, (memlimit, hard))\n```\n\nand see if it improves things.",
    "created_at": "2017-10-20T08:52:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329501",
    "user": "fbissey"
}
```

Replying to [comment:44 vdelecroix]:
> Could this be the source of the problem in #24075?

I wouldn't think so but if you can repeat the failure you can just comment those two lines in `sage-runtests`

```
        if lim == resource.RLIM_INFINITY or lim > memlimit:
            resource.setrlimit(resource.RLIMIT_AS, (memlimit, hard))
```

and see if it improves things.



---

archive/issue_comments_329502.json:
```json
{
    "body": "Replying to [comment:44 vdelecroix]:\n> Could this be the source of the problem in #24075?\n\nThat would be very surprising. How can runnning doctests with limited memory make something work accidentally?",
    "created_at": "2017-10-20T09:38:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23511#issuecomment-329502",
    "user": "jdemeyer"
}
```

Replying to [comment:44 vdelecroix]:
> Could this be the source of the problem in #24075?

That would be very surprising. How can runnning doctests with limited memory make something work accidentally?
