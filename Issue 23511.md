# Issue 23511: Run doctests with limited memory

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2017-08-30 08:28:11

Sometimes, due to bugs, it can happen that doctests take a very large amount of memory, causing trouble for the OS. I suggest to find a reasonable value of `ulimit -v` and use that to limit the virtual memory taken by doctests. This is also a check that doctests do not use too large amounts of memory.


---

Comment by jdemeyer created at 2017-08-30 15:10:57

New commits:


---

Comment by jdemeyer created at 2017-08-30 15:10:57

Changing status from new to needs_review.


---

Comment by tscrim created at 2017-08-30 15:56:08

Maybe this should be discussed on sage-devel, but my vote would be for 1Gb as IMO, doctests should in general not use a large amount of memory similar to the paradigm that they should be fast.


---

Comment by jdemeyer created at 2017-08-30 17:09:29

Replying to [comment:3 tscrim]:
> Maybe this should be discussed on sage-devel, but my vote would be for 1Gb as IMO, doctests should in general not use a large amount of memory similar to the paradigm that they should be fast.

With 1GB, you cannot even start Sage.

And some doctests in `src/sage/schemes/elliptic_curves/heegner.py` do not pass with a limit of only 3GB.


---

Comment by jdemeyer created at 2017-08-30 17:10:36

Replying to [comment:3 tscrim]:
> doctests should in general not use a large amount of memory similar to the paradigm that they should be fast.

That's precisely the reason for this patch.


---

Comment by tscrim created at 2017-08-30 17:23:44

Replying to [comment:4 jdemeyer]:
> Replying to [comment:3 tscrim]:
> > Maybe this should be discussed on sage-devel, but my vote would be for 1Gb as IMO, doctests should in general not use a large amount of memory similar to the paradigm that they should be fast.
> 
> With 1GB, you cannot even start Sage.

Oh, I was thinking this was the amount of memory specifically used by any particular doctest, not Sage + doctests. What about when doctests are run in parallel? Since it is using threads, we still have the same limit of 4Gb, so I am worried we will hit this limit on systems with larger amounts of cores.

> And some doctests in `src/sage/schemes/elliptic_curves/heegner.py` do not pass with a limit of only 3GB.

Maybe we also want to consider a `# high memory` marker (another ticket?) or have `# long time` also allow higher memory?


---

Comment by jdemeyer created at 2017-08-30 19:16:26

Replying to [comment:7 tscrim]:
> Oh, I was thinking this was the amount of memory specifically used by any particular doctest, not Sage + doctests.

No, it is the virtual memory limit for the whole process. This includes code (Python + Python modules + libraries) and data, also unused but allocated memory (like the PARI stack).

> What about when doctests are run in parallel? Since it is using threads

No! It uses processes, not threads. The limit is per process, so we do not need to worry about that.

> > And some doctests in `src/sage/schemes/elliptic_curves/heegner.py` do not pass with a limit of only 3GB.
> 
> Maybe we also want to consider a `# high memory` marker (another ticket?) or have `# long time` also allow higher memory?

Perhaps, but this is just a very simple limit, comparable to the absolute doctest time limit of 360s (short tests) or 1800s (long tests).


---

Comment by jdemeyer created at 2017-08-30 19:21:12

I'll try to lower the limit of 4GiB somewhat, but it certainly must be higher than 3GiB.


---

Comment by git created at 2017-08-30 19:46:49

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by tscrim created at 2017-08-30 21:23:05

Replying to [comment:8 jdemeyer]:
> Replying to [comment:7 tscrim]:
> > What about when doctests are run in parallel? Since it is using threads
> 
> No! It uses processes, not threads. The limit is per process, so we do not need to worry about that.

We should probably change this then:

```
travis`@`apricot:~/sage/src/sage/categories$ sage -tp category.py category_types.py 
[snip]
Doctesting 2 files using 8 threads.
```

Although I am somewhat surprised my memory usage is not higher when I am running parallel tests since each copy of Sage should take a minimum of 1Gb. *shrugs*, oh well, not important.

> > > And some doctests in `src/sage/schemes/elliptic_curves/heegner.py` do not pass with a limit of only 3GB.
> > 
> > Maybe we also want to consider a `# high memory` marker (another ticket?) or have `# long time` also allow higher memory?
> 
> Perhaps, but this is just a very simple limit, comparable to the absolute doctest time limit of 360s (short tests) or 1800s (long tests).

I don't mind 4Gb, I probably prefer it over the 3.x for simplicity.


---

Comment by git created at 2017-08-31 08:29:53

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-08-31 08:35:38

Replying to [comment:14 tscrim]:
> each copy of Sage should take a minimum of 1Gb.

Well, remember that this is _virtual_ memory. Most of that 1GB is shared between processes. If you run 10 copies of Sage, the executable code of Sage needs to be in _physical_ memory only once: the OS maps the same physical memory inside the 10 processes.

Then there is also memory which is reserved but typically not used: Sage might allocate a large PARI stack and GAP memory pool for example which counts against virtual memory. However, as long as this memory is not actually used, you don't need that much physical memory.


---

Comment by jdemeyer created at 2017-08-31 08:39:17

It turns out that even 4GiB is not enough... This new version uses 4500MiB which passes `make ptestlong` on my machine.


---

Comment by tscrim created at 2017-08-31 14:04:24

Replying to [comment:17 jdemeyer]:
> Replying to [comment:14 tscrim]:
> > each copy of Sage should take a minimum of 1Gb.
> 
> Well, remember that this is _virtual_ memory. Most of that 1GB is shared between processes. If you run 10 copies of Sage, the executable code of Sage needs to be in _physical_ memory only once: the OS maps the same physical memory inside the 10 processes.
> 
> Then there is also memory which is reserved but typically not used: Sage might allocate a large PARI stack and GAP memory pool for example which counts against virtual memory. However, as long as this memory is not actually used, you don't need that much physical memory.

Ah, right. Thank you for the explanation.


---

Comment by tscrim created at 2017-08-31 14:13:53

Replying to [comment:18 jdemeyer]:
> It turns out that even 4GiB is not enough... This new version uses 4500MiB which passes `make ptestlong` on my machine.

I am pretty sure it is this block of tests that takes the large amount of memory (with `n = 10`):

```
        sage: from itertools import permutations
        sage: suitr_preferences = list(permutations([-i-1 for i in range(n)]))
        sage: revr_preferences = list(permutations([i+1 for i in range(n)]))
        sage: for player in range(n):
        ....:     big_game.suitors()[player].pref = suitr_preferences[player]
        ....:     big_game.reviewers()[player].pref = revr_preferences[-player]
        sage: big_game.solve()
        {1: -1, 2: -8, 3: -9, 4: -10, 5: -7, 6: -6, 7: -5, 8: -4, 9: -3, 10: -2}
```

That is `2 * 10! * 10 == 72576000` integers plus other stuff. Might consider dropping `n = 8` instead for this example.


---

Comment by jdemeyer created at 2017-08-31 14:59:53

Maybe, but I consider lowering the actual memory requirements of doctests outside the scope of this ticket.


---

Comment by jdemeyer created at 2017-08-31 15:23:20

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-08-31 15:23:20

This is failing badly on the patchbot


---

Comment by jdemeyer created at 2017-09-04 08:50:43

The problem seems to be that `setrlimit()` is done way too late. We need to limit the memory _before_ starting Sage.


---

Comment by git created at 2017-09-04 09:48:39

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-09-04 09:50:20

New attempt, this time limiting the memory in the `sage-runtests` script. Let's see what the patchbot says...


---

Comment by jdemeyer created at 2017-09-04 09:50:20

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-09-05 08:42:08

Hmm, patchbots won't test this because it's "unsafe".


---

Comment by jdemeyer created at 2017-09-05 08:45:24

In case it helps, I did test this on `sardonis` (ppc64le with lots of RAM) and on my laptop (`x86_64` with 6GB of RAM) and it passed tests. 32-bit should also pass for the simple reason that the condition `memlimit <= sys.maxsize()` will be false.

I just got hit again by the issue of doctests taking infinite memory, apparently this creates an infinite list:

```
sage: L = [1, 2, 3]
sage: L.extend(-x for x in L)
```


I'm just saying that this ticket protects against stupid mistakes like this, which might otherwise cause the system to start to swap and become unresponsive.


---

Comment by tscrim created at 2017-09-05 14:00:12

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2017-09-05 14:00:12

Replying to [comment:27 jdemeyer]:
> In case it helps, I did test this on `sardonis` (ppc64le with lots of RAM) and on my laptop (`x86_64` with 6GB of RAM) and it passed tests. 32-bit should also pass for the simple reason that the condition `memlimit <= sys.maxsize()` will be false.

Everything seems to be okay on my laptop as well (`x86_64` with 8Gb of RAM).

> I just got hit again by the issue of doctests taking infinite memory, apparently this creates an infinite list:
> {{{
> sage: L = [1, 2, 3]
> sage: L.extend(-x for x in L)
> }}}

I'm actually slightly surprised Python doesn't catch that as it does so well (sometimes too well) with mutating `dict`s.

> I'm just saying that this ticket protects against stupid mistakes like this, which might otherwise cause the system to start to swap and become unresponsive.

Indeed. Let's kick this to the buildbots and into a beta to see if this causes any trouble.


---

Comment by vbraun created at 2017-09-06 17:49:21

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2017-09-06 17:49:21

I'm getting 

```
sage -t --warn-long 69.8 src/sage/game_theory/matching_game.py
**********************************************************************
File "src/sage/game_theory/matching_game.py", line 161, in sage.game_theory.matching_game.MatchingGame
Failed example:
    revr_preferences = list(permutations([i+1 for i in range(n)]))
Exception raised:
    Traceback (most recent call last):
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 515, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 885, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.game_theory.matching_game.MatchingGame[17]>", line 1, in <module>
        revr_preferences = list(permutations([i+Integer(1) for i in range(n)]))
    MemoryError
```

Here n=10, so 10! permutations...

PS: This is x86_64 with 32GB ram


---

Comment by fbissey created at 2017-09-06 21:18:03

Same as Volker. Also x86_64 with 32GB (although `free` says 12GB are free and 25GB available).


---

Comment by jdemeyer created at 2017-09-06 21:24:30

Replying to [comment:29 vbraun]:
> I'm getting 
> {{{
> sage -t --warn-long 69.8 src/sage/game_theory/matching_game.py
> **********************************************************************
> File "src/sage/game_theory/matching_game.py", line 161, in sage.game_theory.matching_game.MatchingGame
> Failed example:
>     revr_preferences = list(permutations([i+1 for i in range(n)]))
> Exception raised:
>     Traceback (most recent call last):
>       File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 515, in _run
>         self.compile_and_execute(example, compiler, test.globs)
>       File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 885, in compile_and_execute
>         exec(compiled, globs)
>       File "<doctest sage.game_theory.matching_game.MatchingGame[17]>", line 1, in <module>
>         revr_preferences = list(permutations([i+Integer(1) for i in range(n)]))
>     MemoryError
> }}}

Did you run all doctests? Is this the only file which fails?


---

Comment by fbissey created at 2017-09-06 21:42:24

Full failure

```
sage -t --long /usr/lib64/python2.7/site-packages/sage/game_theory/matching_game.py
**********************************************************************
File "/usr/lib64/python2.7/site-packages/sage/game_theory/matching_game.py", line 161, in sage.game_theory.matching_game.MatchingGame
Failed example:
    revr_preferences = list(permutations([i+1 for i in range(n)]))
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 518, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 888, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.game_theory.matching_game.MatchingGame[17]>", line 1, in <module>
        revr_preferences = list(permutations([i+Integer(1) for i in range(n)]))
    MemoryError
**********************************************************************
File "/usr/lib64/python2.7/site-packages/sage/game_theory/matching_game.py", line 162, in sage.game_theory.matching_game.MatchingGame
Failed example:
    for player in range(n):
        big_game.suitors()[player].pref = suitr_preferences[player]
        big_game.reviewers()[player].pref = revr_preferences[-player]
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 518, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 888, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.game_theory.matching_game.MatchingGame[18]>", line 3, in <module>
        big_game.reviewers()[player].pref = revr_preferences[-player]
    NameError: name 'revr_preferences' is not defined
**********************************************************************
File "/usr/lib64/python2.7/site-packages/sage/game_theory/matching_game.py", line 165, in sage.game_theory.matching_game.MatchingGame
Failed example:
    big_game.solve()
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 518, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 888, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.game_theory.matching_game.MatchingGame[19]>", line 1, in <module>
        big_game.solve()
      File "/usr/lib64/python2.7/site-packages/sage/game_theory/matching_game.py", line 901, in solve
        self._is_complete()
      File "/usr/lib64/python2.7/site-packages/sage/game_theory/matching_game.py", line 668, in _is_complete
        raise ValueError("suitor preferences are not complete")
    ValueError: suitor preferences are not complete
**********************************************************************
```

I cannot talk for Volker but this is the only file for which I have a failure related to this ticket. The other failure I got was #23497#comment:39


---

Comment by vbraun created at 2017-09-06 22:12:05

Thats the only file that failed for me, too


---

Comment by jdemeyer created at 2017-09-07 10:31:09

If you both have only that file failing, it's a good reason to revisit those doctests after all and make them use less memory.


---

Comment by fbissey created at 2017-09-07 10:35:31

But it didn't fail before this ticket and this ticket doesn't touch this particular file.


---

Comment by git created at 2017-09-07 11:08:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-09-07 11:10:27

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-09-07 11:10:27

Replying to [comment:35 fbissey]:
> But it didn't fail before this ticket and this ticket doesn't touch this particular file.

The point of this ticket is to limit the amount of memory that doctests are allowed to use. Apparently `matching_game.py` is the file which uses the most memory of all doctests. There is no reason why the testcase in the `matching_game.py` doctests must be so large. I just simplified that.


---

Comment by jdemeyer created at 2017-09-10 09:52:00

Replying to [comment:35 fbissey]:
> But it didn't fail before this ticket and this ticket doesn't touch this particular file.

So what would you suggest instead? Simply increasing the limit from 3300 MiB to some higher number?


---

Comment by fbissey created at 2017-09-10 09:54:49

Replying to [comment:38 jdemeyer]:
> Replying to [comment:35 fbissey]:
> > But it didn't fail before this ticket and this ticket doesn't touch this particular file.
> 
> So what would you suggest instead? Simply increasing the limit from 3300 MiB to some higher number?

No, after reading the description again properly, the fact that it passed before for me is irrelevant to what you try to achieve. I'll put it back to positive review to send it back to the bots.


---

Comment by fbissey created at 2017-09-10 09:54:49

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2017-09-10 15:32:37

Thanks!


---

Comment by fbissey created at 2017-09-11 09:04:42

Now I get this on Volker's develop branch

```
sage -t --long /usr/lib64/python2.7/site-packages/sage/rings/integer.pyx
**********************************************************************
File "/usr/lib64/python2.7/site-packages/sage/rings/integer.pyx", line 2828, in sage.rings.integer.Integer.divisors
Failed example:
    for i in range(20):  # long time
        try:
            alarm(RDF.random_element(1e-3, 0.5))
            _ = n.divisors()
            cancel_alarm()  # we never get here
        except AlarmInterrupt:
            pass
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 518, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 888, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.integer.Integer.divisors[19]>", line 4, in <module>
        _ = n.divisors()
      File "sage/rings/integer.pyx", line 2897, in sage.rings.integer.Integer.divisors (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/rings/integer.c:19409)
        ptr = <unsigned long*>check_allocarray(divisor_count, 3 * sizeof(unsigned long))
      File "memory.pxd", line 87, in cysignals.memory.check_allocarray (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/rings/integer.c:45630)
    MemoryError: failed to allocate 33554432 * 24 bytes
**********************************************************************
```

I have another failure in that file that is not related to memory, so there is probably problems with other tickets touching that file. I'll see if I can find out which one(s).


---

Comment by vbraun created at 2017-09-11 13:47:16

Resolution: fixed


---

Comment by vdelecroix created at 2017-10-20 08:40:18

Could this be the source of the problem in #24075?


---

Comment by fbissey created at 2017-10-20 08:52:25

Replying to [comment:44 vdelecroix]:
> Could this be the source of the problem in #24075?

I wouldn't think so but if you can repeat the failure you can just comment those two lines in `sage-runtests`

```
        if lim == resource.RLIM_INFINITY or lim > memlimit:
            resource.setrlimit(resource.RLIMIT_AS, (memlimit, hard))
```

and see if it improves things.


---

Comment by jdemeyer created at 2017-10-20 09:38:16

Replying to [comment:44 vdelecroix]:
> Could this be the source of the problem in #24075?

That would be very surprising. How can runnning doctests with limited memory make something work accidentally?
