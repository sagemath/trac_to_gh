# Issue 30766: Add minimal pytest configuration

Issue created by migration from https://trac.sagemath.org/ticket/31003

Original creator: @tobiasdiez

Original creation time: 2020-12-04 11:43:13

CC:  mkoeppe

Add a minimal pytest configuration, so that calling `pytest` from `src` passes without any errors (and without finding any tests for the moment). 

This is a preparation for future usages of pytest, such as #30362 or #30738, and is in the general spirit of #28936 (since pytest is perhaps _the_ testing framework for python). For example, one could imagine using `pytest doctest_modules` to run all sage doctests as well.


---

Comment by @tobiasdiez created at 2020-12-04 11:43:20

Changing status from new to needs_review.


---

Comment by git created at 2020-12-04 11:45:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-04 18:10:05

This file would need comments at the top that explain its purpose


---

Comment by git created at 2020-12-05 15:06:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-12-05 15:07:33

I've now added documentation, also in the `tools.rst`.


---

Comment by mkoeppe created at 2020-12-05 18:01:37

Does this really need the line `from __future__ import annotations`?


---

Comment by mkoeppe created at 2020-12-05 18:02:44

Also, should this not be hooked into tox?


---

Comment by mkoeppe created at 2020-12-05 18:05:41

I think it should be said explicitly in the file comments (and the documentation) that this is a no-op and we do not offer ANY tests tested by pytest.

(similar to the wording in the ticket description: "Add a minimal pytest configuration, so that calling pytest from src passes without any errors (and without finding any tests for the moment).")


---

Comment by @tobiasdiez created at 2020-12-05 19:36:04

Replying to [comment:6 mkoeppe]:
> Does this really need the line `from __future__ import annotations`? 

Yes, for `dict[str, Any]`.


---

Comment by @tobiasdiez created at 2020-12-05 19:37:10

Replying to [comment:7 mkoeppe]:
> Also, should this not be hooked into tox?

That would be the way to go, but I wanted to keep the ticket small (for a change ;-)).


---

Comment by git created at 2020-12-05 19:40:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-12-05 19:40:41

Replying to [comment:8 mkoeppe]:
> I think it should be said explicitly in the file comments (and the documentation) that this is a no-op and we do not offer ANY tests tested by pytest.
> 

Done!


---

Comment by mkoeppe created at 2020-12-05 19:42:08

Replying to [comment:10 gh-tobiasdiez]:
> Replying to [comment:7 mkoeppe]:
> > Also, should this not be hooked into tox?
> 
> That would be the way to go, but I wanted to keep the ticket small (for a change ;-)).

I agree. (Given that it's a no-op, there's no point to hook it into tox now.)


---

Comment by mkoeppe created at 2020-12-05 19:44:12

Replying to [comment:9 gh-tobiasdiez]:
> Replying to [comment:6 mkoeppe]:
> > Does this really need the line `from __future__ import annotations`? 
> 
> Yes, for `dict[str, Any]`.

Thanks. So it won't be compatible with Python 3.6, but I guess that's OK because we don't really use pytest for anything.


---

Comment by mkoeppe created at 2020-12-06 00:26:00

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-12-06 00:26:00

I am getting the following:

```
$ sage -sh
$ (cd src && pytest)
=========================================================== test session starts ===========================================================
platform darwin -- Python 3.8.6, pytest-6.1.2, py-1.9.0, pluggy-0.13.1
rootdir: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src
collected 0 items / 1 error                                                                                                               

================================================================= ERRORS ==================================================================
_____________________________________________ ERROR collecting sage/tests/deprecation_test.py _____________________________________________
ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/sage/tests/deprecation_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/local/Cellar/python@3.8/3.8.6/Frameworks/Python.framework/Versions/3.8/lib/python3.8/importlib/__init__.py:127: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
sage/tests/deprecation_test.py:12: in <module>
    from sage.misc.superseded import deprecated_function_alias
sage/misc/superseded.py:30: in <module>
    from sage.misc.lazy_attribute import lazy_attribute
E   ModuleNotFoundError: No module named 'sage.misc.lazy_attribute'
========================================================= short test summary info =========================================================
ERROR sage/tests/deprecation_test.py
```



---

Comment by git created at 2020-12-07 21:15:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-12-07 21:17:08

You need to run pytest from a virtual environment where Sage has been installed (e.g. using the editable install), since otherwise the imports to cython modules are not resolved. I've clarified this point in the documentation.


---

Comment by @tobiasdiez created at 2020-12-07 21:17:08

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2020-12-20 22:49:21

Does it work for you now?


---

Comment by mkoeppe created at 2020-12-21 01:23:38

`sage -sh` does set up an environment in which `python3` is Sage's python (and `pytest` is from this environment too when it is installed).


---

Comment by mkoeppe created at 2020-12-21 01:23:45

Changing status from needs_review to needs_work.


---

Comment by @tobiasdiez created at 2020-12-21 08:21:25

The same code/steps is working for me and correctly reports `collected 0 items`. I think there is a problem with your setup that cythonized sage modules cannot be found. Can you manually import `from sage.misc.lazy_attribute import lazy_attribute`?


---

Comment by git created at 2020-12-21 08:22:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-21 17:48:24

Replying to [comment:21 gh-tobiasdiez]:
> The same code/steps is working for me

... in your custom setup from #30371, I assume...

> and correctly reports `collected 0 items`. I think there is a problem with your setup that cythonized sage modules cannot be found. Can you manually import `from sage.misc.lazy_attribute import lazy_attribute`?

Yes.


---

Comment by @tobiasdiez created at 2020-12-21 20:05:00

Replying to [comment:23 mkoeppe]:
> Replying to [comment:21 gh-tobiasdiez]:
> > The same code/steps is working for me
> 
> ... in your custom setup from #30371, I assume...

No, with `sage -sh` as you did above...


---

Comment by mkoeppe created at 2020-12-21 20:11:59

So you have a working standard installation of sage now?


---

Comment by @tobiasdiez created at 2020-12-21 20:30:53

Yes, after a PC upgrade and with Ubuntu 20.10 in WSL 2 and as many system packages installed it works now. I still prefer my setup from #30371 for testing things though (because of the editable install and the nice integration with vscode).


---

Comment by @tobiasdiez created at 2020-12-21 20:46:05

I did a bit of googling, and found essentially nothing. The closest was https://stackoverflow.com/questions/49068162/pytest-cannot-find-module-on-import-but-code-runs-just-fine/49068163#49068163 but that doesn't suggest a clear solution.


---

Comment by mkoeppe created at 2020-12-21 22:31:59

Replying to [comment:26 gh-tobiasdiez]:
> Yes, after a PC upgrade and with Ubuntu 20.10 in WSL 2 and as many system packages installed it works now. I still prefer my setup from #30371 for testing things though (because of the editable install and the nice integration with vscode).
Great. So how about reducing #30371 then, finally, to something that makes the editable install work on top of the normal installation via the distribution?


---

Comment by git created at 2020-12-27 18:16:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-27 18:21:40

As discussed in #31103, `src/bin/sage-coverage`, `src/bin/sage-coverageall` will need updating so that they do not complain about `..._test.py` files.
(They are also used by the patchbot.)


---

Comment by mkoeppe created at 2020-12-27 18:26:46

Developer's guide (src/doc/en/developer/) would need updates in 
- coding_basics.rst
- reviewer_checklist.rst


---

Comment by @tobiasdiez created at 2020-12-27 22:58:00

Can I do this as follow-up tickets? The purpose of this one here was to provide a minimal test configuration that works for sage. Using pytest in an effective way definitely needs more changes in various areas.


---

Comment by mkoeppe created at 2020-12-28 02:07:33

Replying to [comment:32 gh-tobiasdiez]:
> Can I do this as follow-up tickets?
Sure


---

Comment by @tobiasdiez created at 2020-12-28 10:09:58

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2020-12-28 10:09:58

Ok, this is now #31123.

Can you please retry if it works for you? For me `sage -sh` followed by `pip install pytest` and `pytest` works. You need to run pytest from a python installation in which sage is installed including the Cython modules.


---

Comment by git created at 2020-12-28 10:10:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-01-23 18:12:20

Still needs review.


---

Comment by mkoeppe created at 2021-01-23 19:50:36

The issue persists. I think the problem is that, when executing `pytest` from the `src` directory, the subdirectory `sage` (which does not have the compiled modules) shadows the installed `sage` package. So I think you need to set some option for `pytest` so that `.` is not in the path.


---

Comment by mkoeppe created at 2021-01-23 19:50:36

Changing status from needs_review to needs_work.


---

Comment by @tobiasdiez created at 2021-01-23 21:21:17

I read a bit more about it, and in order for pytest to find cython modules you need to use an editable install (that's why it was always working for me, regardless of how I started pytest). For now, I've added deprecation_test.py to the ignored list, so the issue should be fixed.


---

Comment by @tobiasdiez created at 2021-01-23 21:21:17

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-01-23 21:21:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-01-23 22:13:06

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-01-23 22:13:06

OK this looks like a nice clean no-op now.


---

Comment by @tobiasdiez created at 2021-01-23 22:59:27

Thanks!


---

Comment by vbraun created at 2021-01-24 23:42:16

Documentation doesn't build


---

Comment by vbraun created at 2021-01-24 23:42:16

Changing status from positive_review to needs_work.


---

Comment by git created at 2021-01-28 16:09:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-01-28 16:10:05

Sorry overlooked this. Since the fix was trivial, I'll put it back to "positive review".


---

Comment by @tobiasdiez created at 2021-01-28 16:10:05

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2021-03-07 17:06:08

Resolution: fixed
