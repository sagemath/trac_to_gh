# Issue 13073: sage --clone: give option to not rebuild the docs

Issue created by migration from https://trac.sagemath.org/ticket/13245

Original creator: jhpalmieri

Original creation time: 2012-07-12 23:38:22

Assignee: leif

CC:  nthiery saliola leif hivert jdemeyer

With the attached patch, passing the argument `-N` to `sage -clone` says not to rebuild the reference manual. The patch also uses the option during the clone in the `sage-combinat` script: there are usually so many patches applied in the queue, it would make more sense to build the manual after applying the patches, not before.


---

Comment by jhpalmieri created at 2012-07-12 23:39:08

scripts repo


---

Attachment


---

Comment by jhpalmieri created at 2012-07-12 23:39:54

Changing status from new to needs_review.


---

Attachment

Here is a different patch; this one just turns off docbuilding in `sage-clone` altogether.


---

Comment by leif created at 2013-05-15 12:53:27

Ping.




Not directly related, but meanwhile `sage-clone` also regenerates *all* Cython-generated files, because we don't copy `.cython_version`, which is fixed by:


```patch
diff --git a/sage-clone b/sage-clone
--- a/sage-clone
+++ b/sage-clone
@@ -53,6 +53,10 @@

 cpdir(os.path.abspath('sage/sage'), os.path.abspath(branch + '/sage'))

+if os.path.isfile('sage/.cython_version'):
+    print "Copying over hidden Cython version file..."
+    os.link('sage/.cython_version', branch+'/.cython_version')
+
 def copy_dtree(src_dir, dest_dir):
     src_root = os.path.abspath(src_dir)
     dest_root = os.path.abspath(dest_dir)
```





But there are other issues as well (e.g. rebuilding the `fast_callable` interpreters, which IMHO isn't necessary either).


---

Comment by leif created at 2013-05-15 13:08:37

Replying to [comment:3 leif]:
> But there are other issues as well (e.g. rebuilding the `fast_callable` interpreters, which IMHO isn't necessary either).

Oh, forgot:  Cython-generated header files (`*.h`) don't contain a special comment on that on the first line (which is probably an upstream Cython bug), so the following currently doesn't work as expected either:

```python
            if ext in ['.h', '.c', '.cpp']:
                if 'Cython' in open(src + '/' + F).readline():
                    os.link(src + '/' + F, dest + '/' +F)
                    os.utime(dest + '/' +F, None)
```


(For the moment, we could look for `^#ifndef __PYX_HAVE__sage__` in those, probably even without the `sage__`.)


---

Comment by jhpalmieri created at 2013-05-15 22:10:54

Okay, here is a patch to deal with the `.h` files and `.cython_version`. Rebuilding the fast_callable interpreters doesn't take too much time, so I'm not dealing with it right now. Leif, would you like to be listed as an author?


---

Attachment


---

Comment by leif created at 2013-05-16 13:33:23

Replying to [comment:5 jhpalmieri]:
> Rebuilding the fast_callable interpreters doesn't take too much time, so I'm not dealing with it right now.

Yes, but it also triggers the rebuild of (currently) at least one _other_ Cython module (besides the newly generated five `sage.ext.interpreters.wrapper_*.pyx`):

```
...
Building interpreters for fast_callable
Updating Cython code....
Compiling sage/plot/plot3d/parametric_surface.pyx because it depends on ./sage/ext/interpreters/wrapper_rdf.pxd.
...
building 'sage.plot.plot3d.parametric_surface' extension
...
```


(I think we could just copy over _all_ files in `sage/ext/interpreters/`, which is in `.hgignore`.)

Note sure what or whether doc-rebuilding is triggered (upon next `sage --docbuild ...`) by rebuilding the interpreters though.




Could you explain why we "touch" almost all manually copied (more precisely, linked) files?




> Leif, would you like to be listed as an author?

Does the patch introduce new environment variables? :P




[Haven't tried the patches here yet.]


---

Comment by leif created at 2013-05-16 13:53:33

Replying to [comment:6 leif]:
> Could you explain why we "touch" almost all manually copied (more precisely, linked) files?

Ok, seems like Mercurial is to blame.  We could use `hg clone -U` though instead, and create the working copy by ourselves.  (Not tested.)


---

Comment by leif created at 2013-05-16 14:10:04

Replying to [comment:7 leif]:
> Replying to [comment:6 leif]:
> > Could you explain why we "touch" almost all manually copied (more precisely, linked) files?
> 
> Ok, seems like Mercurial is to blame.  We could use `hg clone -U` though instead, and create the working copy by ourselves.  (Not tested.)

Or change back the modification times of the files (of the working copy) Mercurial created... ;-)

OMG.


---

Comment by leif created at 2013-05-16 14:43:56

Replying to [comment:8 leif]:
> Replying to [comment:7 leif]:
> > Ok, seems like Mercurial is to blame.  We could use `hg clone -U` though instead, and create the working copy by ourselves.  (Not tested.)
> 
> Or change back the modification times of the files (of the working copy) Mercurial created... ;-)
> 
> OMG.

[Thank you, nanny!](http://mercurial.selenic.com/wiki/FAQ#FAQ.2FCommonProblems.Why_is_the_modification_time_of_files_not_restored_on_checkout.3F)

(How about making this optional?!?)


---

Comment by leif created at 2013-05-16 15:44:32

Since apparently `hg archive` (meanwhile?) doesn't preserve modification times either, we could use `hg clone -U` and some `cp -pPR` of `hg manifest` magic instead (of plain `hg clone`).


---

Comment by jhpalmieri created at 2013-05-16 17:29:55

Given the upcoming transition to git, I don't think it's worth trying to wrestle with Mercurial very much. I don't want to spend much more time on it, anyway.


---

Comment by leif created at 2013-05-16 17:33:31

Replying to [comment:11 jhpalmieri]:
> Given the upcoming transition to git, I don't think it's worth trying to wrestle with Mercurial very much. I don't want to spend much more time on it, anyway.

Yes, hopefully.

Anyway, the title (and parts of the description) still advertise _an option_ to disable docbuilding, but the currently listed patch just disables it unconditionally.  Which way do we want to go?


---

Comment by jhpalmieri created at 2013-05-16 19:39:41

I think it makes more sense not to build the docs at all. But I don't use `sage --clone` myself, I only opened this in response to experiences of various sage-combinat users.


---

Comment by jhpalmieri created at 2013-05-31 18:55:14

I think that rebuilding the files in `sage/ext/interpreters/` is because of code in `devel/sage/setup.py`, and any changes to this should be on another ticket.

Meanwhile, the patch [attachment:trac_13245-clone-cython.patch] seems to fix the main cloning problem. I'm happy with that one.


---

Comment by leif created at 2013-06-06 08:20:51

Adjusting priority to reflect the changed subject.

Will try to finally review this asap...


---

Comment by leif created at 2013-06-06 08:20:51

Changing priority from minor to blocker.


---

Comment by leif created at 2013-06-06 08:21:57

Changing type from enhancement to defect.


---

Comment by leif created at 2013-06-06 17:49:35

Replying to [comment:4 leif]:
> Oh, forgot:  Cython-generated header files (`*.h`) don't contain a special comment on that on the first line (which is probably an upstream Cython bug), so the following currently doesn't work as expected either:
> {{{
> #!python
>             if ext in ['.h', '.c', '.cpp']:
>                 if 'Cython' in open(src + '/' + F).readline():
>                     os.link(src + '/' + F, dest + '/' +F)
>                     os.utime(dest + '/' +F, None)
> }}}
> 
> (For the moment, we could look for `^#ifndef __PYX_HAVE__sage__` in those, probably even without the `sage__`.)



 

I'm having another header file in the original but not the clone:

`sage/rings/complex_double_api.h`, which starts with

```c
#ifndef __PYX_HAVE_API__sage__rings__complex_double
#define __PYX_HAVE_API__sage__rings__complex_double
#include "Python.h"
#include "complex_double.h"

static struct __pyx_obj_4sage_5rings_14complex_double_ComplexDoubleElement *(*__pyx_f_4sage_5rings_14complex_double_new_ComplexDoubleElement)(void) = 0;
#define new_ComplexDoubleElement __pyx_f_4sage_5rings_14complex_double_new_ComplexDoubleElement

#ifndef __PYX_HAVE_RT_ImportModule
#define __PYX_HAVE_RT_ImportModule
```


(and is explicitly listed in `.hgignore`).

I couldn't find any places where this is actually used though, nor do I know where it originates from.


---

Comment by leif created at 2013-06-06 18:25:07

Replying to [comment:19 leif]:
> I'm having another header file in the original but not the clone:
> 
> `sage/rings/complex_double_api.h` [...]
> (and is explicitly listed in `.hgignore`).
> 
> I couldn't find any places where this is actually used though, nor do I know where it originates from.

Although it looks Cython-generated, it doesn't get recreated when I touch `complex_double*` sources.

It _seems_<sup>TM</sup> to be some left-over file we still ship, despite it being in `.hgignore`; the file date is July 9th 2012...

So it apparently doesn't matter whether we copy / link it or not, but I feel a bit uncomfortable.


---

Comment by jhpalmieri created at 2013-06-06 18:46:58

I think that being in `MANIFEST.in` is more relevant to what we ship than being in `.hgignore`, since as far as I can tell, we're using Python's distutils to produce the Sage library spkg (by calling `python setup.py sdist` in `devel/sage/spkg-dist`). I'll try deleting the file and running the full test suite...


---

Comment by leif created at 2013-06-07 11:41:42

Replying to [comment:20 leif]:
> Replying to [comment:19 leif]:
> > I'm having another header file in the original but not the clone:
> > 
> > `sage/rings/complex_double_api.h` [...]
> > (and is explicitly listed in `.hgignore`).
> > 
> > I couldn't find any places where this is actually used though, nor do I know where it originates from.
> 
> Although it looks Cython-generated, it doesn't get recreated when I touch `complex_double*` sources.
> 
> It _seems_<sup>TM</sup> to be some left-over file we still ship, despite it being in `.hgignore`; the file date is July 9th 2012...

See #14700 for removing some (shipped but) unused files.


---

Comment by leif created at 2013-06-07 15:25:34

Hmmm, did some testing, and it seems copying over any already built documentation doesn't make sense (or doesn't work as expected at least).

I've made sure that the documentation (and the Sage library) is up-to-date, but if I run `sage --docbuild reference html` afterwards in a fresh clone, apparently _everything_ (of the reference manual) gets rebuilt.

It says

```
[foo] building [html]: targets for N source files that are out of date
[foo] updating environment: 0 added, N changed, 0 removed
...
```

for all components AFAICS.

(This is with 5.10.rc0.)


---

Comment by leif created at 2013-06-07 15:52:05

Replying to [comment:23 leif]:
> [...] if I run `sage --docbuild reference html` afterwards in a fresh clone, apparently _everything_ (of the reference manual) gets rebuilt.
> 
> It says
> {{{
> [foo] building [html]: targets for N source files that are out of date
> [foo] updating environment: 0 added, N changed, 0 removed
> ...
> }}}
> for all components AFAICS.

The same happens when I switch back to the main branch and (re)run `sage --docbuild reference html`.


---

Comment by jhpalmieri created at 2013-06-07 17:03:20

Replying to [comment:23 leif]:
> Hmmm, did some testing, and it seems copying over any already built documentation doesn't make sense (or doesn't work as expected at least).

I think that it makes sense, but it doesn't work as expected. That is, if you clone the Sage library, you should still be able to find documentation in the usual place. The fact that it needs to be rebuilt is annoying (although less so, now that the docs don't take as long to rebuild), and a bug with Sphinx or mercurial or something we do, I'm not sure which. It's been an issue with cloning for years, and it's never been resolved satisfactorily.

I don't know if cloning is even going to be part of the new git workflow, whenever that arrives. In any case, I don't feel like spending any energy to try to fix this problem.


---

Comment by leif created at 2013-06-07 17:20:02

FWIW,

```diff

diff --git a/sage-clone b/sage-clone
--- a/sage-clone
+++ b/sage-clone
@@ -90,7 +90,7 @@
                     fr = os.path.join(ref, f, directory)
                     if os.path.exists(fr):
                         to = os.path.join(branch, 'doc', lang, 'reference', f, directory)
-                        cmd = 'cp -pR %s %s' % (fr, to)
+                        cmd = 'cp -R %s %s' % (fr, to)
                         subprocess.call([cmd], shell=True)
     except:
         pass
```

(alone, at least) doesn't make a difference.


---

Comment by leif created at 2013-06-07 17:35:30

Replying to [comment:25 jhpalmieri]:
> Replying to [comment:23 leif]:
> > Hmmm, did some testing, and it seems copying over any already built documentation doesn't make sense (or doesn't work as expected at least).
> 
> I think that it makes sense, but it doesn't work as expected.

I meant that we should either drop copying over any "pre-built" documentation (since it doesn't work -- there's apparently no difference to building all from scratch), or fix rebuilding [all of it].

Since we both seem to be unable to do (or don't want to spend time on) the latter, I think we should go with the former.




> That is, if you clone the Sage library, you should still be able to find documentation in the usual place.

? I don't understand what you mean by that; `$SAGE_ROOT/devel/sage-main/doc/output/...` at least is always there.




> I don't know if cloning is even going to be part of the new git workflow, whenever that arrives.

I don't see why cloning should vanish with the switch to git.




> In any case, I don't feel like spending any energy to try to fix this problem.

Me neither.


---

Comment by jhpalmieri created at 2013-06-07 18:36:52

Replying to [comment:27 leif]:
> Replying to [comment:25 jhpalmieri]:
> > That is, if you clone the Sage library, you should still be able to find documentation in the usual place.
> 
> ? I don't understand what you mean by that; `$SAGE_ROOT/devel/sage-main/doc/output/...` at least is always there.

I want it to be available in `$SAGE_ROOT/devel/sage/doc/output/...`. If you run `tutorial()` or `reference()` from within Sage, it should open up documentation, for example.


---

Comment by jhpalmieri created at 2013-06-07 18:46:13

Replying to [comment:27 leif]:
> Replying to [comment:25 jhpalmieri]:
> > I don't know if cloning is even going to be part of the new git workflow, whenever that arrives.
> 
> I don't see why cloning should vanish with the switch to git.

Okay, but cloning will have to be rewritten to use git instead of mercurial. I don't know what affect that will have on modification times and other issues relating to rebuilding the documentation.


---

Comment by leif created at 2013-06-07 18:52:45

What's most annoying to me is that the whole documentation gets rebuilt (upon `sage --docbuild reference html`) when I switch back to the original branch (which is supposed to be left untouched).

(I can't believe that's always been the case, at least I don't recall having ever experienced that, but perhaps I simply never tried.)

It seems `python setup.py install` somehow doesn't play well with Sphinx...


---

Comment by leif created at 2013-06-07 19:03:27

Replying to [comment:28 jhpalmieri]:
> If you run `tutorial()` or `reference()` from within Sage, it should open up documentation, for example.

I did not even know these commands... :-)

Shouldn't they get advertised in the startup banner?


---

Comment by jhpalmieri created at 2013-06-07 19:48:13

The startup banner says `Type "help()" for help.`. If you type `help()`, you get information about these commands.


---

Comment by tscrim created at 2013-06-10 06:10:08

I tried this with `5.10.rc1` by applying the patches to the script repo (`$SAGE_ROOT/local/bin`), then running

```
sage -combinat install
```

and all of the extensions are being rebuilt for me. Did I need to run `sage -b` first? (I did like the fact that I didn't have to wait for the doc to be rebuilt.)


---

Comment by tscrim created at 2013-06-10 11:50:19

I also just ran

```
sage -b main
```

and this is recompiling all of the extension classes as well.

```
travis@travis-virtualbox:~/sage-5.10.rc1/devel/sage-main$ sage -b main

----------------------------------------------------------
sage: Building and installing modified Sage library files.


Installing c_lib
scons: `install' is up to date.
Updating Cython code....
Finished compiling Cython code (time = 33.1963000298 seconds)
running install
running build
running build_py
running build_ext
building 'sage.algebras.quatalg.quaternion_algebra_element' extension
building 'sage.algebras.letterplace.free_algebra_letterplace' extension
building 'sage.algebras.letterplace.free_algebra_element_letterplace' extension
building 'sage.algebras.letterplace.letterplace_ideal' extension
building 'sage.algebras.quatalg.quaternion_algebra_cython' extension
building 'sage.calculus.var' extension
building 'sage.calculus.riemann' extension
building 'sage.calculus.interpolators' extension
building 'sage.categories.action' extension
building 'sage.categories.category_singleton' extension
building 'sage.categories.functor' extension
building 'sage.categories.map' extension
building 'sage.categories.morphism' extension
building 'sage.categories.examples.semigroups_cython' extension
building 'sage.coding.binary_code' extension
building 'sage.combinat.expnums' extension
...
```

Could this be a result of the changes to `sync-build`? (I'd be surprised if it was since this what I got when doing the `-combinat install`.)


---

Comment by leif created at 2013-06-10 14:37:05

Replying to [comment:33 tscrim]:
> I tried this with `5.10.rc1` by applying the patches to the script repo (`$SAGE_ROOT/local/bin`), then running
> {{{
> sage -combinat install
> }}}
> and all of the extensions are being rebuilt for me. Did I need to run `sage -b` first?

a) If you had committed changes to the main repo, you should of course run `sage -b` before cloning.  (It would be better to test with a vanilla Sage library.)

b) Are you sure _everything_ (= _all_ extension modules) got rebuilt, as opposed to just changed modules and those that depend on the changed ones (the latter potentially being many, even if not many got changed)?

c) Is that a regression?

(The current brokenness of `sage -sync-build` _might_ be related, although I don't see that `sage -combinat` calls it.)


---

Comment by leif created at 2013-06-10 14:43:17

Replying to [comment:34 tscrim]:
> I also just ran
> {{{
> sage -b main
> }}}
> and this is recompiling all of the extension classes as well.
> {{{
> travis`@`travis-virtualbox:~/sage-5.10.rc1/devel/sage-main$ sage -b main
> 
> ----------------------------------------------------------
> sage: Building and installing modified Sage library files.
> 
> 
> Installing c_lib
> scons: `install' is up to date.
> Updating Cython code....
> Finished compiling Cython code (time = 33.1963000298 seconds)
> running install
> running build
> running build_py
> running build_ext
> building 'sage.algebras.quatalg.quaternion_algebra_element' extension
> building 'sage.algebras.letterplace.free_algebra_letterplace' extension
> building 'sage.algebras.letterplace.free_algebra_element_letterplace' extension
> building 'sage.algebras.letterplace.letterplace_ideal' extension
> building 'sage.algebras.quatalg.quaternion_algebra_cython' extension
> building 'sage.calculus.var' extension
> building 'sage.calculus.riemann' extension
> building 'sage.calculus.interpolators' extension
> building 'sage.categories.action' extension
> building 'sage.categories.category_singleton' extension
> building 'sage.categories.functor' extension
> building 'sage.categories.map' extension
> building 'sage.categories.morphism' extension
> building 'sage.categories.examples.semigroups_cython' extension
> building 'sage.coding.binary_code' extension
> building 'sage.combinat.expnums' extension
> ...
> }}}

The messages don't seem to be in chronological order (probably `stdout` and `stderr` out of sync); I somehow doubt all extension modules got rebuilt if "re-cythonizing" took just 33 seconds...




> Could this be a result of the changes to `sync-build`?

There are no changes to `sage -sync-build` yet.


---

Comment by leif created at 2013-06-10 14:48:06

P.S.:

`sage --clone foo; sage -b main` works for me (modulo that the `fast_callable` interpreters [and IIRC six extension modules that depend on them] get rebuilt in both cases, which is a known but in our opinion minor issue we didn't want to address here).


---

Comment by leif created at 2013-06-10 14:52:42

Travis, the interesting lines should be

```
Executing N commands (using M threads)
...
Time to execute N commands: n seconds
...
Total time spent compiling C/C++ extensions: m seconds.
```



---

Comment by leif created at 2013-06-10 15:29:59

From a clean `sage-main` repo,

```sh
$ (./sage --clone foo; ./sage -b main) 2>&1 | egrep '^(building|Cythonizing|Compiling)'
```

gives me

```
Compiling sage/plot/plot3d/parametric_surface.pyx because it depends on ./sage/ext/interpreters/wrapper_rdf.pxd.
Compiling sage/ext/interpreters/wrapper_rdf.pyx because it changed.
Compiling sage/ext/interpreters/wrapper_cdf.pyx because it changed.
Compiling sage/ext/interpreters/wrapper_rr.pyx because it changed.
Compiling sage/ext/interpreters/wrapper_py.pyx because it changed.
Compiling sage/ext/interpreters/wrapper_el.pyx because it changed.
building 'sage.plot.plot3d.parametric_surface' extension
building 'sage.ext.interpreters.wrapper_rdf' extension
building 'sage.ext.interpreters.wrapper_cdf' extension
building 'sage.ext.interpreters.wrapper_rr' extension
building 'sage.ext.interpreters.wrapper_py' extension
building 'sage.ext.interpreters.wrapper_el' extension
Cythonizing sage/ext/interpreters/wrapper_py.pyx
Cythonizing sage/ext/interpreters/wrapper_rdf.pyx
Cythonizing sage/plot/plot3d/parametric_surface.pyx
Cythonizing sage/ext/interpreters/wrapper_el.pyx
Cythonizing sage/ext/interpreters/wrapper_rr.pyx
Cythonizing sage/ext/interpreters/wrapper_cdf.pyx
```



---

Comment by tscrim created at 2013-06-10 15:41:41

a) I only applied the two patches to the scripts repo, nothing to the main repo (I had just built sage, didn't even start it yet).

b) Not 100% but almost since there are far fewer extensions that get rebuilt after pushing/popping the entire combinat queue, and it seemed like the same number of modules after running `-sync-build` (which currently erases all cython files). I can't tell you the interesting lines because I didn't think I would need it (and I really don't want to go through rebuilding it all again) At least afterwards, switching between branches is fast. Nevertheless I would think changes in one branch's built extensions would not affect another's...

Did you run

```
sage --clone foo
sage -b foo
```

and then

```
sage -b main
```

?


---

Comment by leif created at 2013-06-10 16:02:48

Replying to [comment:40 tscrim]:
> Did you run
> {{{
> sage --clone foo
> sage -b foo
> }}}
> and then
> {{{
> sage -b main
> }}}
> ?

Not explicitly, since `sage-clone` already runs `sage -b` in the new clone.


---

Comment by jhpalmieri created at 2013-06-10 17:51:56

Just for reference: with Sage 5.10.rc1 (not that the version should matter, as far as I know), I applied the two patches here and did

```
./sage -b   # to make sure everything was up to date
./sage --combinat install
```

and it only built 6 Cython files before applying the combinat queue:

```
Building interpreters for fast_callable
Updating Cython code....
Compiling sage/plot/plot3d/parametric_surface.pyx because it depends on ./sage/ext/interpreters/wrapper_rdf.pxd.
Compiling sage/ext/interpreters/wrapper_rdf.pyx because it changed.
Compiling sage/ext/interpreters/wrapper_cdf.pyx because it changed.
Compiling sage/ext/interpreters/wrapper_rr.pyx because it changed.
Compiling sage/ext/interpreters/wrapper_py.pyx because it changed.
Compiling sage/ext/interpreters/wrapper_el.pyx because it changed.
Cythonizing sage/ext/interpreters/wrapper_cdf.pyx
Cythonizing sage/ext/interpreters/wrapper_el.pyx
Cythonizing sage/ext/interpreters/wrapper_py.pyx
Cythonizing sage/ext/interpreters/wrapper_rdf.pyx
Cythonizing sage/ext/interpreters/wrapper_rr.pyx
Cythonizing sage/plot/plot3d/parametric_surface.pyx
Finished compiling Cython code (time = 17.591463089 seconds)
running install
running build
running build_py
running build_ext
warning: Replacing library search directory in linker command:
  "/Users/palmieri/Desktop/Sage_stuff/sage_builds/clean/sage-5.10.rc1/local/lib" -> "/Users/palmieri/Desktop/Sage_stuff/sage_builds/sage-5.10.rc1/local/lib"

building 'sage.plot.plot3d.parametric_surface' extension
building 'sage.ext.interpreters.wrapper_rdf' extension
building 'sage.ext.interpreters.wrapper_cdf' extension
building 'sage.ext.interpreters.wrapper_rr' extension
building 'sage.ext.interpreters.wrapper_py' extension
building 'sage.ext.interpreters.wrapper_el' extension
Executing 6 commands (using 2 threads)
...
```



---

Comment by tscrim created at 2013-06-10 18:01:37

Here's a snippet of what I get -- with no patches applied, double-checking the patches are applied in `local/bin`, and then running `sage -b` -- when I run

```
sage --clone foo
...
Building interpreters for fast_callable
Updating Cython code....
Compiling sage/plot/plot3d/parametric_surface.pyx because it depends on ./sage/ext/interpreters/wrapper_rdf.pxd.
Compiling sage/ext/interpreters/wrapper_rdf.pyx because it changed.
Compiling sage/ext/interpreters/wrapper_cdf.pyx because it changed.
Compiling sage/ext/interpreters/wrapper_rr.pyx because it changed.
Compiling sage/ext/interpreters/wrapper_py.pyx because it changed.
Compiling sage/ext/interpreters/wrapper_el.pyx because it changed.
Cythonizing sage/ext/interpreters/wrapper_cdf.pyx
Cythonizing sage/ext/interpreters/wrapper_el.pyx
Cythonizing sage/ext/interpreters/wrapper_py.pyx
Cythonizing sage/ext/interpreters/wrapper_rdf.pyx
Cythonizing sage/ext/interpreters/wrapper_rr.pyx
Cythonizing sage/plot/plot3d/parametric_surface.pyx
Finished compiling Cython code (time = 70.2989528179 seconds)
running install
running build
running build_py
running build_ext
building 'sage.algebras.quatalg.quaternion_algebra_element' extension
building 'sage.algebras.letterplace.free_algebra_letterplace' extension
...
building 'sage.ext.interpreters.wrapper_py' extension
building 'sage.ext.interpreters.wrapper_el' extension
Executing 343 commands (using 1 thread)
```

I'll upload a full log once it's done. Could it be because I didn't run `sage -b` after first installing the patches the first time around? Either that or (more likely) it's something specific to me or my system...


---

Attachment

Here's a log from calling `sage -b main` afterwards (because I stupidly overwrote the first log).


---

Comment by jhpalmieri created at 2013-06-10 19:52:17

When I called `sage -b main` afterwards, I got

```

----------------------------------------------------------
sage: Building and installing modified Sage library files.


Installing c_lib
scons: `install' is up to date.
Updating Cython code....
Finished compiling Cython code (time = 11.5694179535 seconds)
running install
running build
running build_py
running build_ext
warning: Replacing library search directory in linker command:
  "/Users/palmieri/Desktop/Sage_stuff/sage_builds/clean/sage-5.10.rc1/local/lib" -> "/Users/palmieri/Desktop/Sage_stuff/sage_builds/sage-5.10.rc1/local/lib"

Executing 0 commands (using 1 thread)
Time to execute 0 commands: 0.0257179737091 seconds
Total time spent compiling C/C++ extensions:  0.278106927872 seconds.
running install_lib
running install_egg_info
Removing /Users/palmieri/Desktop/Sage_stuff/sage_builds/sage-5.10.rc1/local/lib/python2.7/site-packages/sage-0.0.0-py2.7.egg-info
Writing /Users/palmieri/Desktop/Sage_stuff/sage_builds/sage-5.10.rc1/local/lib/python2.7/site-packages/sage-0.0.0-py2.7.egg-info

real	0m17.365s
user	0m6.021s
sys	0m2.604s
```

So it looks like there is something odd with your system.


---

Comment by leif created at 2013-06-10 19:56:33

Replying to [comment:41 leif]:
> Replying to [comment:40 tscrim]:
> > Did you run
> > {{{
> > sage --clone foo
> > sage -b foo
> > }}}
> > and then
> > {{{
> > sage -b main
> > }}}
> > ?
> 
> Not explicitly, since `sage-clone` already runs `sage -b` in the new clone.

But even when I do, that doesn't make any difference, as expected.


---

Comment by leif created at 2013-06-10 19:59:57

P.S.: I also touched some pyx files in the clone, ran `sage -b`, then `sage -b main`.  Not surprisingly, the latter didn't trigger any rebuilds either.


---

Comment by jhpalmieri created at 2013-06-10 20:38:51

Just to make sure, when you run `./sage --hg -R local/bin log`, it shows that the two patches have been applied, right?


---

Comment by tscrim created at 2013-06-10 20:57:08


```
travis@travis-virtualbox:~/sage-5.10.rc1$ sage --hg -R local/bin log | head -n 21
changeset:   1953:64e1b84c2d39
tag:         qtip
tag:         tip
tag:         trac_13245-clone-nodocbuild.patch
user:        J. H. Palmieri <palmieri@math.washington.edu>
date:        Mon Mar 11 10:53:04 2013 -0700
summary:     Don't rebuild docs after cloning.

changeset:   1952:148e4ed48517
tag:         qbase
tag:         trac_13245-clone-cython.patch
user:        J. H. Palmieri <palmieri@math.washington.edu>
date:        Mon Mar 11 10:53:04 2013 -0700
summary:     sage-clone: copy over autogenerated .h files, and also .cython_version

changeset:   1951:0eb3c4df6d10
tag:         qparent
user:        Jeroen Demeyer <jdemeyer@cage.ugent.be>
date:        Wed Jun 05 22:11:28 2013 +0000
summary:     5.10.rc1
```

So it's probably just something I messed up with my install (my guess by applying the patches and then running `-combinat install` before (rebuilding and) starting sage) and/or system.


---

Comment by leif created at 2013-06-10 21:03:50

I _think<sup>TM</sup>_ I know what the problem might be, namely the _order_ in which subdirectories of `devel/sage/build/` are copied.

Since the odd addition of `build_dir` in `setup.py`, which already breaks `sage-sync-build`, the Cython-generated `.c` and `.cpp` files also end up below `build/`.

Now if these get copied (and touched!) *after* their corresponding `.o` and `.so` files, the latter will get rebuilt.




Travis, could you switch back to the main branch, remove the line setting `build_dir` from `setup.py` (or change `build_dir='build/cythonized'` to `build_dir=None`), do `sage -b` to get a clean new main repo, and retry your test? B)


---

Comment by tscrim created at 2013-06-10 21:28:44

Doing so right now, although the change seems to have triggered a recompile/recythonizing of the cython files (it might have been a side effect of one of my other tests). However I need to sleep, so I'll finish the test in the morning. Thanks.


---

Comment by leif created at 2013-06-10 22:22:28

Replying to [comment:50 leif]:
> I _think<sup>TM</sup>_ I know what the problem might be, namely the _order_ in which subdirectories of `devel/sage/build/` are copied.
> 
> Since the odd addition of `build_dir` in `setup.py`, which already breaks `sage-sync-build`, the Cython-generated `.c` and `.cpp` files also end up below `build/`.
> 
> Now if these get copied (and touched!) *after* their corresponding `.o` and `.so` files, the latter will get rebuilt.

With

```python
def copy_dtree(src_dir, dest_dir):
    src_root = os.path.abspath(src_dir)
    dest_root = os.path.abspath(dest_dir)

    for root, dirs, files in os.walk(src_root):
        nroot = dest_root + root[len(src_root):]
        for d in dirs:
            os.makedirs(nroot+'/'+d)
        for f in files:
            if os.path.splitext(f)[1] in [".c",".cpp",".o",".so"]: # ADDED
                print("  %s" % f) # ADDED
            os.link(root+'/'+f,nroot+'/'+f)
            os.utime(nroot+'/'+f, None)

sys.stdout.flush(); sys.stderr.flush() # ADDED
print "Copying over build directory..."
copy_dtree('sage/build', branch + '/build')
sys.stdout.flush(); sys.stderr.flush() # ADDED
```

I can at least confirm that _for me_ all `.o` and `.so` files get copied _after_ all `.c` and `.cpp` files have been copied -- rather incidentally I think.


---

Comment by tscrim created at 2013-06-11 07:25:52

My `.o` files get copied, then my `.c` and `.cpp`, then my `.so` (with the changes to `setup.py`).


---

Comment by tscrim created at 2013-06-11 07:34:22

Also I only get the rebuilding of the 7 extensions and switch back to main is trivial.


---

Comment by jdemeyer created at 2013-06-11 13:51:45

Any progress? Does this still deserve to be a Sage 5.10 blocker?


---

Comment by leif created at 2013-06-11 16:19:24

Replying to [comment:55 jdemeyer]:
> Any progress? Does this still deserve to be a Sage 5.10 blocker?

At least the `.cython_version` part here.

And we should really disable (postpone) Cython-generated files "out-of-tree", since this breaks both `sage-clone` and `sage-sync-build`, i.e., set `build_dir` to `None` in `setup.py`.

([Even] with that, upgrading from beta4+ will still trigger the rebuild of the whole Sage library, but only once.)


---

Comment by leif created at 2013-06-11 16:25:06

Replying to [comment:56 leif]:
> And we should really disable (postpone) Cython-generated files "out-of-tree", since this breaks both `sage-clone` and `sage-sync-build`, i.e., set `build_dir` to `None` in `setup.py`.

Inline patch, worth its own (blocker) ticket:

```diff
diff --git a/setup.py b/setup.py
--- a/setup.py
+++ b/setup.py
@@ -537,7 +537,8 @@
     ext_modules = cythonize(
         ext_modules,
         nthreads = int(os.environ.get('SAGE_NUM_THREADS', 0)),
-        build_dir = 'build/cythonized',
+        build_dir = None, # Don't "cythonize out-of-tree" (cf. #14570) until
+                          # sage-clone and sage-sync-build can deal with that.
         force=force)
 
     open(version_file, 'w').write(Cython.__version__)
```


EDIT:  Added ticket reference to the patch.


---

Comment by leif created at 2013-06-11 16:31:14

Replying to [comment:55 jdemeyer]:
> Any progress?

I was (more or less reluctantly) going to give this positive review, but then Travis discovered that using `build_dir` can also break `sage-clone`.

So I'm happy provided we make this ticket depend on the above patch / its ticket.


---

Comment by nthiery created at 2013-06-11 16:39:24

Replying to [comment:55 jdemeyer]:
> Any progress? Does this still deserve to be a Sage 5.10 blocker?

It would be great indeed to have 5.10 ready for the Sage-Combinat days next week! There is a lot of good stuff there.


---

Comment by leif created at 2013-06-11 16:49:04

Replying to [comment:58 leif]:
> Replying to [comment:55 jdemeyer]:
> > Any progress?
> 
> I was (more or less reluctantly) going to give this positive review, but then Travis discovered that using `build_dir` can also break `sage-clone`.
> 
> So I'm happy provided we make this ticket depend on the above patch / its ticket.

I've now created #14721.

>


---

Comment by leif created at 2013-06-11 16:49:04

Changing status from needs_review to positive_review.


---

Comment by leif created at 2013-06-11 17:12:00

Replying to [comment:60 leif]:
> Replying to [comment:58 leif]:
> > So I'm happy provided we make this ticket depend on the above patch / its ticket.
> 
> I've now created #14721.

Needs review... :P


---

Comment by jdemeyer created at 2013-06-13 08:21:11

Resolution: fixed
