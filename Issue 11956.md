# Issue 11956: "hg verify" is not a proper way to check whether there is an hg repo

Issue created by migration from https://trac.sagemath.org/ticket/12128

Original creator: jdemeyer

Original creation time: 2011-12-08 22:11:15

Assignee: GeorgSWeber

CC:  vbraun mjo

From the root `spkg-install`:

```
# see if there is a valid Mercurial repository in $SAGE_ROOT
hg verify 1>/dev/null 2>/dev/null
```


Unfortunately, this is a bad way to check for Mercurial repository because this can succeed even if there is no `SAGE_ROOT/.hg` but a `.hg` in some parent directory.

I propose to change this to

```
if [ -d .hg ]; then
```



---

Attachment


---

Comment by jdemeyer created at 2011-12-08 22:16:13

Changing status from new to needs_review.


---

Comment by mjo created at 2011-12-09 22:48:22

Changing status from needs_review to positive_review.


---

Comment by mjo created at 2011-12-09 22:48:22

At first I though this was trading one edge case for another (albeit less likely) one. It seems, however, that testing for a `.hg` directory is as good as it gets.

First of all, the issue is valid:


```
$ cd ~/tmp
tmp $ hg init
tmp $ mkdir subdir
tmp $ cd subdir
subdir $ hg verify
checking changesets
checking manifests
crosschecking files in changesets and manifests
checking files
0 files, 0 changesets, 0 total revisions
```


Within `subdir`, I thought there would be an issue: we can have an `.hg` subdirectory that isn't Mercurial data. However, it looks like Mercurial itself ignores that fact:


```
subdir $ ls -a
total 8.0K
drwxr-xr-x 2 mjo mjo 4.0K 2011-12-09 15:38 .
drwxr-xr-x 4 mjo mjo 4.0K 2011-12-09 15:38 ..
subdir $ hg root
/home/mjo/tmp
subdir $ mkdir .hg
subdir $ hg root
/home/mjo/tmp/subdir
```


Moreover, `hg verify` and the like work with just an empty `.hg` directory. So, we don't gain anything by doing both tests.


---

Comment by jdemeyer created at 2011-12-10 10:41:04

Resolution: fixed
