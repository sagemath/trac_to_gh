# Issue 13964: Fix race condition rebuilding MPIR,... with GCC spkg

Issue created by migration from https://trac.sagemath.org/ticket/14168

Original creator: jdemeyer

Original creation time: 2013-02-23 10:19:03

Assignee: GeorgSWeber

CC:  kcrisman leif

If the GCC spkg has been installed and MPIR (or MPFR, MPC) gets rebuilt, then GCC doesn't work properly during the "install" phase of MPIR, because GCC uses the MPIR libraries.

Therefore we must ensure that nothing gets built in parallel with MPIR, MPFR, MPC if the GCC spkg has been installed.


---

Comment by leif created at 2013-02-23 11:13:58

Hopefully nobody uses `${SAGE_LOCAL}/bin/gcc`  just as a wrapper script (or a link to some `gcc`)... ;-)




Regarding useless rebuilds, doesn't `sage-spkg mpir` (e.g.) always `touch` `spkg/installed/mpir-...` such that `make` will (at least attempt to) rebuild anything depending on it (same for MPFR, MPC)?

This will usually just lead to "foo is already installed" (although again `touch`ing the corresponding file `spkg/installed/foo-...`), but if `SAGE_UPGRADING=yes`, all packages depending on it/these will actually (recursively) get rebuilt.


---

Comment by jdemeyer created at 2013-02-23 11:26:27

Replying to [comment:1 leif]:
> Regarding useless rebuilds, doesn't `sage-spkg mpir` (e.g.) always `touch` `spkg/installed/mpir-...` such that `make` will (at least attempt to) rebuild anything depending on it (same for MPFR, MPC)?
In fact, you're right but that's more because of the way Sage is abusing `make`, which I don't want to fix on this ticket.


---

Comment by jdemeyer created at 2013-02-23 11:29:22

See #14170.


---

Comment by leif created at 2013-02-23 12:16:16

Replying to [comment:2 jdemeyer]:
> Replying to [comment:1 leif]:
> > Regarding useless rebuilds, doesn't `sage-spkg mpir` (e.g.) always `touch` `spkg/installed/mpir-...` such that `make` will (at least attempt to) rebuild anything depending on it (same for MPFR, MPC)?
> In fact, you're right but that's more because of the way Sage is abusing `make`, which I don't want to fix on this ticket.

:-)

If any of MPIR, MPFR or MPC (or ZLIB, wow!) changed, GCC gets rebuilt (in upgrades) anyway, so I'd move rebuilding MPIR/MPFR/MPC (with the just-built GCC) just to the GCC build rule.


---

Comment by jdemeyer created at 2013-02-26 06:45:13

Replying to [comment:1 leif]:
> Regarding useless rebuilds, doesn't `sage-spkg mpir` (e.g.) always `touch` `spkg/installed/mpir-...`
On second thought, this actually is not a problem. What I overlooked is that `make` simply will not run `sage-spkg mpir` if mpir is up-to-date. My patch still respects make dependencies, I cannot think of a situation where my patch would cause more packages to be built than necessary.


---

Comment by jdemeyer created at 2013-02-27 19:39:34

Changing status from new to needs_review.


---

Comment by kcrisman created at 2013-02-28 03:11:13

I'm on my second test run and it seems to be both working fine as well as not adding appreciably to the build time.  MPIR, MPFR, and MPC really do not take long on an even semi-modern computer; on this one, the total time I see in the `spkg/logs` is about 2 extra minutes (gcc takes about 15 minutes, even with many threads).  The logic looks fine but I'm not a makefile expert so I don't want to give final positive review.  The proof will be in the building of others, of course, after it's merged.


---

Comment by leif created at 2013-03-01 01:53:09

In case anybody is wondering:

The rebuild of MPIR, MPFR and MPC gets triggered by the GCC spkg's `spkg-install`:

```sh
...
# Force re-installation of mpir, mpfr and mpc with the GCC we just built.
cd "$SAGE_ROOT/spkg/installed"
rm -f mpir-* mpfr-* mpc-*
```


(It would IMHO be much clearer if that was part of the `make` receipt for GCC.)


---

Comment by leif created at 2013-03-01 02:31:25

Replying to [comment:5 jdemeyer]:
> Replying to [comment:1 leif]:
> > Regarding useless rebuilds, doesn't `sage-spkg mpir` (e.g.) always `touch` `spkg/installed/mpir-...`
> On second thought, this actually is not a problem. What I overlooked is that `make` simply will not run `sage-spkg mpir` if mpir is up-to-date. My patch still respects make dependencies, I cannot think of a situation where my patch would cause more packages to be built than necessary.

Ok, it doesn't cause _more_ rebuilds than now, but...

Imagine (just) zlib got upgraded, and GCC gets (re)built:  Then any spkg (directly or indirectly) depending on any of MPIR, MPFR or MPC will also get rebuilt.  (You may argue that if GCC got rebuilt, it's "ok" or "necessary" to rebuild the rest as well, but compare this to the situation when Sage's GCC is _not_ installed/used...)

Anyway, the patch here fixes the race condition _with Sage's GCC_ (although actually only small parts of the `make install` of MPIR, MPFR and MPC are critical, and the race conditions can still happen with "non-Sage" GCCs).

So if Karl-Dieter is happy (and doesn't object), I'd reluctantly say "positive review"...


---

Comment by leif created at 2013-03-01 02:46:42

Replying to [comment:9 leif]:
> Replying to [comment:5 jdemeyer]:
> > `make` simply will not run `sage-spkg mpir` if mpir is up-to-date.
> ([...] the race conditions can still happen with "non-Sage" GCCs).

To be more precise:  You could actually drop the `if [ -x "$$SAGE_LOCAL/bin/gcc" ]; then ...`, because such race conditions could happen with "non-Sage" GCCs as well, and because of what you said above (and because building these spkgs serially doesn't significantly increase the overall build time).


---

Comment by kcrisman created at 2013-03-01 02:53:49

Any such solution is fine with me.  If we can avoid other race conditions, that is great too.


---

Attachment


---

Comment by jdemeyer created at 2013-03-02 11:11:00

Patch updated to do this unconditionally, so it also works for system GCCs.


---

Comment by leif created at 2013-03-05 00:14:46

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-03-05 06:47:17

Resolution: fixed


---

Comment by leif created at 2013-03-05 13:03:27

Now probably for a follow-up:

`$(INST)/$(GCC)` should also depend on `toolchain-deps`, since otherwise MPIR, MPFR, MPC and ZLIB may (still) get built in parallel as prerequisites of the GCC spkg (i.e., when built the first time, and GCC gets installed).


We could also be a bit smarter regarding whether `CC` is GCC, and whether we're using a GCC version >= 4.5 (as older versions don't use GMP/MPFR/MPC).

(Re)building PPL may also break a running GCC (if LTO is used);  fortunately our PPL spkg is pretty outdated... ;-)


---

Comment by leif created at 2013-03-05 13:13:54

Replying to [comment:15 leif]:
> We could also be a bit smarter regarding whether `CC` is GCC, and whether we're using a GCC version >= 4.5 (as older versions don't use GMP/MPFR/MPC).

Ooops, >= 4.4?  I don't recall right now.  (At least Ubuntu's GCC 4.4.3 already uses GMP and MPFR.)
