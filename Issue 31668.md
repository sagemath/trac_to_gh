# Issue 31668: cvxopt links wrong M1 directory

Issue created by migration from https://trac.sagemath.org/ticket/31905

Original creator: kcrisman

Original creation time: 2021-06-04 11:26:55

CC:  dimpase mkoeppe mjo fbissey

I was able to successfully build Sage on M1 (see #30592) but had two main types of doctest errors.

```
> However, I did see some of this type as well in the sage/numerical tests: 
> 
> ImportError: dlopen(/Users/karl.crisman/Downloads/BrewSage/sage-9.4.beta0/local/lib/python3.9/site-packages/cvxopt/cholmod.cpython-39-darwin.so, 2): Symbol not found: _cholmod_l_allocate_dense 
> Referenced from: /Users/karl.crisman/Downloads/BrewSage/sage-9.4.beta0/local/lib/python3.9/site-packages/cvxopt/cholmod.cpython-39-darwin.so 
> Expected in: flat namespace 
> in /Users/karl.crisman/Downloads/BrewSage/sage-9.4.beta0/local/lib/python3.9/site-packages/cvxopt/cholmod.cpython-39-darwin.so 


otool -L /Users/karl.crisman/Downloads/BrewSage/sage-9.4.beta0/local/lib/python3.9/site-packages/cvxopt/cholmod.cpython-39-darwin.so 


/Users/karl.crisman/Downloads/BrewSage/sage-9.4.beta0/local/lib/python3.9/site-packages/cvxopt/cholmod.cpython-39-darwin.so:
	/opt/homebrew/opt/openblas/lib/libopenblas.0.dylib (compatibility version 0.0.0, current version 0.0.0)
	/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1292.100.5) 
```

This apparently requires a change in the setup.py (see [this sage-devel discussion](https://groups.google.com/g/sage-devel/c/6LldEeJu3ZA/m/HXp3lFwCCgAJ)):

```
if sys.platform.startswith("darwin"): 
SUITESPARSE_LIB_DIR = '/usr/local/lib' 
SUITESPARSE_INC_DIR = '/usr/local/include' 
```

to allow `/opt/homebrew`.


---

Comment by kcrisman created at 2021-06-04 11:55:52

The following diff works and fixes the bad doctests for me (except some unrelated ones for graphics). 

```diff
diff --git a/build/pkgs/cvxopt/patches/libsuitesparse_path.patch b/build/pkgs/cvxopt/patches/libsuitesparse_path.patch
index fc8908aa7f..2da0e1f36a 100644
--- a/build/pkgs/cvxopt/patches/libsuitesparse_path.patch
+++ b/build/pkgs/cvxopt/patches/libsuitesparse_path.patch
@@ -1,10 +1,13 @@
 diff --git a/setup.py b/setup.py
-index d312416..4fa14c4 100644
 --- a/setup.py
 +++ b/setup.py
-@@ -58,9 +58,9 @@ if sys.platform.startswith("darwin"):
-     SUITESPARSE_LIB_DIR = '/usr/local/lib'
-     SUITESPARSE_INC_DIR = '/usr/local/include'
+@@ -56,11 +56,11 @@
+ if sys.platform.startswith("darwin"):
+     # macOS
+-    SUITESPARSE_LIB_DIR = '/usr/local/lib'
+-    SUITESPARSE_INC_DIR = '/usr/local/include'
++    SUITESPARSE_LIB_DIR = '/opt/homebrew/lib'
++    SUITESPARSE_INC_DIR = '/opt/homebrew/include'
  else:
 -    if glob("/usr/lib/x86_64-linux-gnu/libsuitesparse*"):
 -        # Ubuntu/Debian
```

I am _not_ currently in a position to make a proper branch with this testing setup, my apologies, and in any case it needs some additional logic to test for which version of MacOS we have and/or if homebrew is being used.


---

Comment by mkoeppe created at 2021-06-04 18:28:58

Upstream report...


---

Comment by kcrisman created at 2021-06-04 18:46:06

> Upstream report...

Will they see this as a bug? I already asked about whether to report upstream [here](https://groups.google.com/g/sage-devel/c/6LldEeJu3ZA/m/SIvNj5s-CgAJ).


---

Comment by kcrisman created at 2021-06-04 18:54:37

https://github.com/cvxopt/cvxopt/issues/195


---

Comment by mkoeppe created at 2022-01-17 07:32:27

These defaults in cvxopt's setup.py can be overridden using environment variables
`CVXOPT_SUITESPARSE_INC_DIR`, `CVXOPT_SUITESPARSE_LIB_DIR`.
We already set these variables when we build our own `suitesparse` (then `SAGE_SUITESPARSE_PREFIX` is nonempty). 

On macOS, we could just set these variables also (to something arbitrary) when system suitesparse is in use.

See also #33083#comment:40 - a related issue on `alpine`.


---

Comment by jhpalmieri created at 2022-09-26 18:50:17

Maybe this is resolved? I can build Sage (including `cvxopt`) on an M2 computer using homebrew's suitesparse, and all tests pass. If that's the issue, perhaps it's solved. Or is it about using Sage's suitesparse + Sage's cvxopt?


---

Comment by mkoeppe created at 2022-09-26 19:27:13

It's plausible that the cvxopt update in #34150 may have fixed it, but I haven't checked


---

Comment by jhpalmieri created at 2022-09-26 19:53:48

`setup.py` still says

```
if sys.platform.startswith("darwin"):
    # macOS
    SUITESPARSE_LIB_DIR = '/usr/local/lib'
    SUITESPARSE_INC_DIR = '/usr/local/include'
```

and `/opt` is not found anywhere in that file, and looking at the log file, I don't know how it's finding the suitesparse libraries.


---

Comment by jhpalmieri created at 2022-11-16 01:04:05

I propose closing this. Sage builds fine on my `M2`, using a homebrew installation of `suitesparse`.


---

Comment by jhpalmieri created at 2022-11-16 01:04:18

Changing status from new to needs_review.


---

Comment by dimpase created at 2022-11-16 12:43:05

Replying to [comment:14 John Palmieri]:
> I propose closing this. Sage builds fine on my `M2`, using a homebrew installation of `suitesparse`.

can one build Sage's `suitsparse` on M2, and use it to build `cvxopt`?
If so, we can close it.


---

Comment by jhpalmieri created at 2022-11-16 19:40:17

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2022-11-16 19:40:17

Replying to [comment:16 Dima Pasechnik]:
> Replying to [comment:14 John Palmieri]:
> > I propose closing this. Sage builds fine on my `M2`, using a homebrew installation of `suitesparse`.
> 
> can one build Sage's `suitsparse` on M2, and use it to build `cvxopt`?
> If so, we can close it.

I can build successfully using Sage's `suitesparse` and also homebrew's `suitesparse`, so setting to positive review.
