# Issue 22351: Let make (doc) really always work

Issue created by migration from Trac.

Original creator: klee

Original creation time: 2017-03-13 00:24:58

If we change git branches, make (doc) often fails. It turns out that the caching mechanism in sage doc builder is unreliable and is the root cause of these failures. The patch removes the caching mechanism and implements a more robust logic to auto-update module docs.


---

Comment by git created at 2017-03-13 00:35:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by hivert created at 2017-03-13 15:40:20

Hi,

Thanks for this suggestion ! I've a few question for your patch.

- Usually caching is here for performance reason. Did you test that there isn't a huge speed loss ?

- Can you explain a little in the description of this patch how your new robust logic works ?

- Finally, from a first glance, It seems that you don't handle the 'underscore' option anymore, do you ?

Cheers,

Florent


---

Comment by hivert created at 2017-03-13 16:16:40

I got

```
[...]
cd ../.. && sage-logger -p './sage --docbuild --no-pdf-links all html ' logs/dochtml.log
[dochtml] 
[dochtml] Building reference manual, first pass.
[dochtml] 
[dochtml] Error building the documentation.
[dochtml] Traceback (most recent call last):
[dochtml]   File "/home/data/Sage-Install/sage-7.5.1/local/lib/python/runpy.py", line 174, in _run_module_as_main
[dochtml]     "__main__", fname, loader, pkg_name)
[dochtml]   File "/home/data/Sage-Install/sage-7.5.1/local/lib/python/runpy.py", line 72, in _run_code
[dochtml]     exec code in run_globals
[dochtml]   File "/home/data/Sage-Install/sage-7.5.1/local/lib/python2.7/site-packages/sage_setup/docbuild/__main__.py", line 2, in <module>
[dochtml]     main()
[dochtml]   File "/home/data/Sage-Install/sage-7.5.1/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 1618, in main
[dochtml]     builder()
[dochtml]   File "/home/data/Sage-Install/sage-7.5.1/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 316, in _wrapper
[dochtml]     getattr(get_builder(document), 'inventory')(*args, **kwds)
[dochtml]   File "/home/data/Sage-Install/sage-7.5.1/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 510, in _wrapper
[dochtml]     build_many(build_ref_doc, L)
[dochtml]   File "/home/data/Sage-Install/sage-7.5.1/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 252, in build_many
[dochtml]     ret = x.get(99999)
[dochtml]   File "/home/data/Sage-Install/sage-7.5.1/local/lib/python/multiprocessing/pool.py", line 567, in get
[dochtml]     raise self._value
[dochtml] AttributeError: 'NoneType' object has no attribute 'all_docs'
[...]
```

Here is how to reproduce the problem: I went to `7.6.beta6` and compiled the doc normally. Then I switched to `22588` and issued a `make doc-clean` and `make doc`. 

Also the git managed file `src/doc/en/reference/misc/sagetex.rst` was deleted.


---

Comment by jdemeyer created at 2017-03-13 16:41:04

Changing keywords from "" to "days85".


---

Comment by git created at 2017-03-13 16:55:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2017-03-13 17:00:46

Try the quickfix to fix the problem. Meanwhile I will think to reply to your questions.


---

Comment by git created at 2017-03-13 17:20:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2017-03-13 17:23:38

Yes, the new code is to blame for the phenomenon that the innocent "sagetex.rst" disappears! Hope that the two quickfixes work.


---

Comment by klee created at 2017-03-13 19:14:21

Now the code with the quickfixes works fine for me. How about you?

I will try to answer your questions as far as I understand the old and the new code :-) First I describe the use of cache in the old code:

The cache stores the list of the modules for which rst files were auto-generated in the previous run of the doc builder. In a new run, the list of the modules for which rst files should be auto-generated is computed and compared with the list in the cache. The rst files of newly added modules are auto-generated. Then the cache is updated.  

In the new code:

In a new run, the list of the modules for which rst files should be auto-generated is computed, and the modules are put into "new", "updated", "removed", "old" bins, comparing with the list of rst files which were auto-generated in the previous run of the doc builder (this formation is in the Sphinx environment). For modules in "new" and "updated" bins, new rst files are auto-generated. The modules in "removed" are removed. The modules in "old"  are just kept.

Replying to [comment:3 hivert]:
> Usually caching is here for performance reason. Did you test that there isn't a huge speed loss ?

The merit of caching here is that supposedly we do not need to look into the "sage/..." folder to get the list of modules for which rst files were auto-generated. The new code gets the information from the Sphinx environment (`.all_docs`). There is no loss in speed.

> Can you explain a little in the description of this patch how your new robust logic works ?

The information about the files in "sage/..." from the Sphinx environment is *independent* from git branch changing, unlike the cache. The dependence of the cache on git branch was the cause of the failures. 

> Finally, from a first glance, It seems that you don't handle the 'underscore' option anymore, do you?

The (new/old) code is not responsible for handling the 'underscore' option. Is it?

Thanks for asking.


---

Comment by hivert created at 2017-03-14 12:47:32

Replying to [comment:10 klee]:
> Now the code with the quickfixes works fine for me. How about you?
> 
> I will try to answer your questions as far as I understand the old and the new code :-) First I describe the use of cache in the old code:

Thanks for clarifying all of these

> The (new/old) code is not responsible for handling the 'underscore' option. Is it?

I'm pretty sure the old code is:

```
if (inherit_prev is None or inherit_prev != options.inherited or
            underscore_prev is None or underscore_prev != options.underscore):
```

They are two options that force us to regenerate all the stub:

- `inherit` -- whether we show inherited funs and attrs in the doc
- `underscore` -- whether we show private (starting with __) funs and attrs

If any of those two option are changed, then every stub must be regenerated, because these option are included in the stub file as in

```
.. automodule:: sage.sets.integer_range
   :members:
   :undoc-members:
   :show-inheritance:
```

This needs to be taken care of in your logic.


---

Comment by klee created at 2017-03-14 13:35:45

You are right. It seems that putting the options back in work forces us to resurrect the cache file. Then the role of the cache file is just to keep the previous settings of the options. I think I can do this. Do you have any other idea? 

One alternative approach could be to resurrect the cache file in full force as it was and make its pickle *not* git-tracted... I am not sure if this is really possible and sound... What do you think?


---

Comment by klee created at 2017-03-14 20:21:33

I somehow presumed that the pickle of the cache is git branch dependent or git-tracted, and that caused failures. It is not true: the pickle is not git-tracted! Now I think problems were that the cache lacked the modification time info (so it could not be used to detect updated module) and that the old code did not remove rst files for removed modules.

I am now experimenting with the options. I resurrected the cache and use it to store the previously used options. I will push the commits after I am confirmed that it works well...


---

Comment by klee created at 2017-03-14 20:41:53

With the underscore option, it ends with an error (independent from the present patch). With the inherited option, it takes forever (understandably...). So I stopped this experiment. Anyway I can confirm that the options take effect :-)


---

Comment by git created at 2017-03-14 21:20:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2017-03-14 21:34:58

This is extremely minor, but as far as I can tell, the preferred capitalization is "reST", not "ReST". The official documentation only uses "reStructuredText", not the abbreviation, but the lowercase "r" suggests "reST", and that's what others use (see http://www.sphinx-doc.org/en/stable/rest.html, for example).


---

Comment by git created at 2017-03-15 01:54:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2017-03-15 08:46:39

Changing status from new to needs_review.


---

Comment by klee created at 2017-03-15 08:46:39

Changing component from documentation to build.


---

Comment by klee created at 2017-03-15 09:43:45

One annoying problem I noticed is that we now have these warning as a side effect of `__import__(module)`: 

```
[dochtml] /Users/Kwankyu/GitHub/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py:909: DeprecationWarning: the module sage.rings.commutative_ring is deprecated and will be removed
[dochtml] See http://trac.sagemath.org/20011 for details.
[dochtml]   __import__(module)
```


Could we just ignore these or can you provide how to fix this?

As I understand, the Sphinx autodoc extension also import a module to do its work. So importing a module is not a problem. Sphinx seems not to spit out the warning messages...


---

Comment by git created at 2017-03-15 10:27:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2017-03-15 10:33:02

I decided to suppress the deprecation warnings. It works well.


---

Comment by jhpalmieri created at 2017-03-15 21:03:22

I'm not sure it's a good idea to suppress deprecation warnings. The underlying issues should be fixed, instead. (There are deprecation warnings already. Does your branch create new ones?)


---

Comment by jdemeyer created at 2017-03-15 22:30:34

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-03-15 22:30:34

Please do not make useless changes like

```diff
 def format_annotation(annotation):
-    """Return formatted representation of a type annotation.
+    """
+    Return formatted representation of a type annotation.
```


That will only introduce merge conflicts.


---

Comment by git created at 2017-03-16 00:35:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2017-03-16 01:08:50

Replying to [comment:24 jhpalmieri]:
> I'm not sure it's a good idea to suppress deprecation warnings. The underlying issues should be fixed, instead. (There are deprecation warnings already. Does your branch create new ones?)

You are right. Deprecation warnings were already there. My branch did not create new ones.

I think this is a good case where suppressing deprecation warnings is good and harmless. Those warnings are targeted for *users* of deprecated classes and methods. In our case, there is no real use of the deprecated. And the user who is building the reference manual would just wonder why he or she gets those warnings and has nothing to do to avoid them.


---

Comment by git created at 2017-03-16 01:16:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2017-03-16 01:19:16

Changing status from needs_work to needs_review.


---

Comment by git created at 2017-03-29 10:39:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2017-03-29 10:44:40

It is a pain to see document building fail with the branch changed. This patch should be merged as soon as possible. Please review if you agree.


---

Comment by jdemeyer created at 2017-04-04 19:14:16

Florent, can you review this?


---

Comment by embray created at 2017-04-05 09:18:03

Thanks for trying to fix this--it's been a huge source of irritation for me as well.  

Florent is the expert on this code so he should have final say (but I'm not sure where he is--I haven't seen him in the office this week).  But the logic here makes sense to me.  I just have a few questions:

In the old `get_newly_included_modules(self, save=False)` method (which is now obsolete--it is not used anywhere and could be removed?) there is a `save` argument.  Your new `get_new_and_updated_modules()` method also has the `save` argument but it isn't used anywhere (nor would it be).

Also I think it's a little confusing that what is now being called the "cache" is just storing the options that were used in the last docbuild run, and nothing else AFAICT (since as you point out the same information can be found in the Sphinx environment).


---

Comment by git created at 2017-04-05 10:23:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2017-04-05 10:33:22

Replying to [comment:33 embray]:
> In the old `get_newly_included_modules(self, save=False)` method (which is now obsolete--it is not used anywhere and could be removed?) there is a `save` argument.  Your new `get_new_and_updated_modules()` method also has the `save` argument but it isn't used anywhere (nor would it be).

I agree. Removed them just now.

> Also I think it's a little confusing that what is now being called the "cache" is just storing the options that were used in the last docbuild run, and nothing else AFAICT (since as you point out the same information can be found in the Sphinx environment).

You are right. I wanted to get rid of the cache file. But unfortunately, as Florent noted, it turned out that we need to save the last options used somewhere, to decide whether to rebuild all modules or not given the new options. So the main role of the cache changed (and I started to call the cache "reference cache" -- a cache for building the reference)


---

Comment by hivert created at 2017-04-05 19:15:52

Replying to [comment:33 embray]:

> Florent is the expert on this code so he should have final say (but I'm not sure where he is--I haven't seen him in the office this week).  But the logic here makes sense to me.  

Hi Embray ! I've been sick and unable to work for one week. That's why you haven't seen me. I'm currently catching up and then I'll review this ticket.


---

Comment by klee created at 2017-05-11 21:52:55

I wonder which is the case: this patch is not so useful to developers as I believe or they are too busy to spare some time for this ticket...


---

Comment by embray created at 2017-05-12 09:47:47

I think it's definitely useful--people are just busy.


---

Comment by git created at 2017-06-04 10:52:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-06-11 21:27:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2017-06-11 21:30:26

Florent, I beg your review.


---

Comment by kcrisman created at 2017-07-05 15:26:29

I'm not quite competent to review this but it would be really useful ... ping!


---

Comment by klee created at 2017-07-05 15:41:39

Replying to [comment:43 kcrisman]:
> I'm not quite competent to review this but it would be really useful ... ping!

Yes! I repeatedly rely on this patch when I work with my branch, since without it "make" often fails while building docs. I just wonder how other developers live with the limped doc builder. I hoped this had been merged to Sage 8.0...


---

Comment by embray created at 2017-07-05 16:18:31

I wonder if it would also enable speeding up patchbot builds, if we don't have to do a full `make doc-clean` on every build...


---

Comment by klee created at 2017-07-05 16:54:16

Replying to [comment:45 embray]:
> I wonder if it would also enable speeding up patchbot builds, if we don't have to do a full `make doc-clean` on every build...

In theory, yes.  If we are 100% sure that the doc builder is totally reliable and robust against changing branches after this ticket is merged, then we may make it an option to do `make doc-clean` in the patchbot.

On the other hand, I once observed that some hyperlinks don't work properly in the docs built without `make doc-clean`.


---

Comment by embray created at 2017-07-06 08:45:38

I think, for the patchbot's purposes, it's fine if the docs don't build 100% correctly as long as they _can_ be built without errors from Sphinx, or problems that impact the doctests.

If nothing else, once this (or a fix like it) is merged it would be worth updating the patchbot to make the doc-clean an option, as you suggest, and experiment with running without it for a while.


---

Comment by jhpalmieri created at 2017-08-04 17:05:03

I would like to give this a positive review, but here is an issue: I tested this by deleting a file – I happened to choose `homology/koszul_complex.py`, along with its link in the reference manual. When I rebuilt the docs with the `develop` branch, it crashed because of the missing file, but with this branch, the docs built. That's great. What's not as great is that with this branch, the other pages in the `homology` part of the reference manual were not changed to reflect the missing page, so for example, `cell_complex.html` was not rewritten and so still has the line

```
    <link rel="next" title="Koszul Complexes" href="koszul_complex.html" />
```

(This means that at the top of that page, it says "Next page: Koszul complexes".) Fortunately (?), the page `koszul_complex.html` was not deleted, so the link still works.

Note also that there are still references to `koszul_complex.html` in the search indices.

The problem with docbuilding before this branch is that the auto-generated `koszul_complex.rst` would remain, while this branch does a good job of cleaning it up. What about these other references to `koszul_complex.html`? Deal with here or on another ticket, or ignore altogether?


---

Comment by jhpalmieri created at 2017-08-04 18:10:41

A similar problem happens when you add a file: suppose you are adding a file "B.py" whose html file is supposed to go between "A.html" and "C.html" (that is, in "A.html", the next topic should point to "B.html"). If the docs have already been built, with A.html pointing to C.html, then you add B.html, the links in A.html and C.html will not change: they will point to each other as previous and next topics.

With the "develop" branch, docbuilding fails completely so you have to delete the built docs, so you never see this problem. With the branch from this ticket, you see it. Essentially the same question as in my previous comment: is the rest of this enough of an improvement that we can put off this problem to another ticket?


---

Comment by klee created at 2017-08-05 14:22:29

Replying to [comment:48 jhpalmieri]:
> The problem with docbuilding before this branch is that the auto-generated `koszul_complex.rst` would remain, while this branch does a good job of cleaning it up. What about these other references to `koszul_complex.html`? Deal with here or on another ticket, or ignore altogether?

This branch is about auto-generating .rst files correctly. So the problem of wrong cross-references could be dealt with separately in another ticket.

The problem of wrong cross-references seems related with how intersphinx extension works. I guess that the intersphinx inventory files should be updated somehow when the auto-generated .rst files are updated. I am not Sphinx expert though, and it would take me some time to figure out what is wrong and to find a proper fix.


---

Comment by embray created at 2017-08-07 09:38:21

I agree--the way I feel about this ticket is that it's not fixing every possible issue with incremental doc builds between branch changes, of which there are many.  More importantly, it's just making it so that the doc build succeeds without crashing.  It's not _generally_ too important for the docs themselves to be exactly correct in this case--for perfectly correct docs they should be built from scratch.  Rather, this avoids having to rebuild the docs from scratch every time a branch is switched (this is especially nice for the patchbot).

I wouldn't say this would never lead to confusion--people might want to read the development docs, especially if they're working on the docs themselves.  But this isn't a showstopper.  The current situation, however, is very annoying :)


---

Comment by jhpalmieri created at 2017-08-07 15:17:03

Okay, then let's merge this and see how it goes.


---

Comment by jhpalmieri created at 2017-08-07 15:17:03

Changing status from needs_review to positive_review.


---

Comment by klee created at 2017-08-09 01:34:06

Here is the ticket for the problem of wrong cross references

https://trac.sagemath.org/ticket/23602


---

Comment by vbraun created at 2017-08-11 18:18:09

Resolution: fixed


---

Comment by kcrisman created at 2017-08-18 18:27:21

Nice work!


---

Comment by jdemeyer created at 2017-10-07 14:49:49

There is an important regression: #23975


---

Comment by klee created at 2017-10-08 00:42:20

Replying to [comment:56 jdemeyer]:
> There is an important regression: #23975

I looked at #23975. As far as I understand, an issue was raised about sage-location and fixed by a patch there. Is the regression still present? What is the regression? Is there something to be done here? Help me catch up.
