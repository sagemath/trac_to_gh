# Issue 24924: Sphinx build hangs when a BaseException occurs

Issue created by migration from https://trac.sagemath.org/ticket/25161

Original creator: saraedum

Original creation time: 2018-04-13 12:44:40

CC:  infinity0

Python's `multiprocessing.Pool` hangs when a `BaseException` that is not an `Excepion` happens in the function it runs; we need to wrap these in "normal" Exception's so they get thrown correctly by the pool's `get`.


```
Python 2.7.14 (default, Jan  5 2018, 10:41:29) 
[GCC 7.2.1 20171224] on linux2
Type "help", "copyright", "credits" or "license" for more information.
>>> def work(x):
...     raise BaseException(x)
... 
>>> from multiprocessing import Pool
>>> pool = Pool(2)
>>> pool.map_async(work, ["error", "error"]).get()
Process PoolWorker-1:
Process PoolWorker-2:
Traceback (most recent call last):
Traceback (most recent call last):
  File "/usr/lib/python2.7/multiprocessing/process.py", line 267, in _bootstrap
  File "/usr/lib/python2.7/multiprocessing/process.py", line 267, in _bootstrap
    self.run()
  File "/usr/lib/python2.7/multiprocessing/process.py", line 114, in run
    self.run()
  File "/usr/lib/python2.7/multiprocessing/process.py", line 114, in run
    self._target(*self._args, **self._kwargs)
    self._target(*self._args, **self._kwargs)
  File "/usr/lib/python2.7/multiprocessing/pool.py", line 113, in worker
  File "/usr/lib/python2.7/multiprocessing/pool.py", line 113, in worker
    result = (True, func(*args, **kwds))
  File "/usr/lib/python2.7/multiprocessing/pool.py", line 65, in mapstar
    result = (True, func(*args, **kwds))
    return map(*args)
  File "/usr/lib/python2.7/multiprocessing/pool.py", line 65, in mapstar
  File "<stdin>", line 2, in work
    return map(*args)
  File "<stdin>", line 2, in work
BaseException: error
BaseException: error
[hangs]
```


This upstreams part of Debian's `u2-better-sphinx-failure-modes.patch`.


---

Comment by saraedum created at 2018-04-13 13:08:11

Now, how could I possibly doctest this?
----
New commits:


---

Comment by saraedum created at 2018-04-13 13:09:23

Changing status from new to needs_review.


---

Comment by saraedum created at 2018-04-13 13:10:57

Setting this to needs review as I'd like to get some feedback on this.


---

Comment by saraedum created at 2018-04-13 13:10:57

Changing status from needs_review to needs_work.


---

Comment by embray created at 2018-04-13 13:58:38

I think I've seen a similar issue before, albeit rarely.  Last year I started working on a generalized version of the parallel doctest runner from `sage.doctest.forker` that could also be used in docbuilds (and provided better exception handling for free).  

However, I had some minor bugs in my implementation that I never quite finished working out, and then got distracted and never finished it.  I'd really like that get that project up and running again...


---

Comment by embray created at 2018-04-13 14:02:35

Do you have any idea what's causing a non-`Exception` exception to be raised from the docbuild?

The only thing I can think of is if it's an exception coming from Cysignals, and even then it's not clear what the exception would be in that case (an alarm, maybe?)

Otherwise the fix certainly makes sense.


---

Comment by embray created at 2018-04-13 14:03:00

Changing status from needs_work to needs_info.


---

Comment by jdemeyer created at 2018-04-13 15:06:43

Replying to [comment:7 embray]:
> Last year I started working on a generalized version of the parallel doctest runner from `sage.doctest.forker` that could also be used in docbuilds (and provided better exception handling for free).

Huge +1 (disclaimer: I wrote that doctest forker).

`multiprocessing` is broken in many ways. For this ticket, wouldn't it be possible to patch `multiprocessing` instead? That way, all users of `multiprocessing` would benefit, not only the docbuilder.


---

Comment by jdemeyer created at 2018-04-13 15:09:44

Replying to [comment:8 embray]:
> Do you have any idea what's causing a non-`Exception` exception to be raised from the docbuild?

`KeyboardInterrupt` is a likely candidate. This probably explains why interrupting the docbuilder is unreliable.


---

Comment by saraedum created at 2018-04-13 16:28:40

Replying to [comment:11 jdemeyer]:
> Replying to [comment:8 embray]:
> > Do you have any idea what's causing a non-`Exception` exception to be raised from the docbuild?
Maybe something coming out of cysignals. But I have no clue really.

> `KeyboardInterrupt` is a likely candidate. This probably explains why interrupting the docbuilder is unreliable.
I observed this problem in a CI run, so I don't think it's a KeyboardInterrupt. But you're right, the above example can not be killed with Ctrl-c. It just prints the KeyboardInterrupt on Python 2.7. (Works on Python 3.6.)


---

Comment by saraedum created at 2018-04-13 16:29:47

Replying to [comment:10 jdemeyer]:
> Replying to [comment:7 embray]:
> > Last year I started working on a generalized version of the parallel doctest runner from `sage.doctest.forker` that could also be used in docbuilds (and provided better exception handling for free).
> 
> Huge +1 (disclaimer: I wrote that doctest forker).
> 
> `multiprocessing` is broken in many ways. For this ticket, wouldn't it be possible to patch `multiprocessing` instead? That way, all users of `multiprocessing` would benefit, not only the docbuilder.

What do you mean? Patch our Python SPKG or monkey-patch the multiprocessing module?


---

Comment by saraedum created at 2018-04-13 16:43:55

Changing status from needs_info to needs_review.


---

Comment by saraedum created at 2018-04-13 16:45:51

(Without the `catch BaseException:`, the added doctest just hangs btw.)


---

Comment by git created at 2018-04-13 18:07:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2018-04-13 22:14:40

Ok, here's what's been happening in #24655:

```
[dochtml] Exception in thread Thread-7:
[dochtml] Traceback (most recent call last):
[dochtml]   File "/home/sage/sage/local/lib/python2.7/threading.py", line 801, in __bootstrap_inner
[dochtml]     self.run()
[dochtml]   File "/home/sage/sage/local/lib/python2.7/threading.py", line 754, in run
[dochtml]     self.__target(*self.__args, **self.__kwargs)
[dochtml]   File "/home/sage/sage/local/lib/python2.7/multiprocessing/pool.py", line 328, in _handle_workers
[dochtml]     pool._maintain_pool()
[dochtml]   File "/home/sage/sage/local/lib/python2.7/multiprocessing/pool.py", line 232, in _maintain_pool
[dochtml]     self._repopulate_pool()
[dochtml]   File "/home/sage/sage/local/lib/python2.7/multiprocessing/pool.py", line 225, in _repopulate_pool
[dochtml]     w.start()
[dochtml]   File "/home/sage/sage/local/lib/python2.7/multiprocessing/process.py", line 130, in start
[dochtml]     self._popen = Popen(self)
[dochtml]   File "/home/sage/sage/local/lib/python2.7/multiprocessing/forking.py", line 121, in __init__
[dochtml]     self.pid = os.fork()
[dochtml] OSError: [Errno 12] Cannot allocate memory
```


That seems to make the docbuild hang. But that's an Exception, so the problem there seems to be something else.


---

Comment by git created at 2018-04-14 00:49:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by infinity0 created at 2018-04-14 15:48:49

This is only slightly related, but I wanted to bring this other patch to your attention:

https://salsa.debian.org/science-team/sagemath/blob/master/debian/patches/df-subprocess-sphinx.patch

If that is adopted, a side-effect (I think) would be to avoid the need for this patch, since all errors would instead become CalledProcessErrors.


---

Comment by saraedum created at 2018-04-17 17:52:30

Ah, thanks for pointing that out. I'm working through all the Debian patches at the moment so I might create a ticket for that one as well. (But I think it's maybe more controversial.)

Apart from that multiprocessing seems to work much better in Python 3, so maybe the problem goes away thereâ€¦


---

Comment by embray created at 2018-04-18 13:08:31

Replying to [comment:13 saraedum]:
> Replying to [comment:10 jdemeyer]:
> > Replying to [comment:7 embray]:
> > > Last year I started working on a generalized version of the parallel doctest runner from `sage.doctest.forker` that could also be used in docbuilds (and provided better exception handling for free).
> > 
> > Huge +1 (disclaimer: I wrote that doctest forker).
> > 
> > `multiprocessing` is broken in many ways. For this ticket, wouldn't it be possible to patch `multiprocessing` instead? That way, all users of `multiprocessing` would benefit, not only the docbuilder.
> 
> What do you mean? Patch our Python SPKG or monkey-patch the multiprocessing module?

I think what Jeroen means is as a more robust alternative to using `multiprocessing.Pool.map` and the like, as is currently used by the docbuilder.

My prototype implementation was compatible with (and this is why it was a bit difficult to get right) [concurrent.futures](https://docs.python.org/3/library/concurrent.futures.html) API, albeit extended to cover the additional features that the doctest runner has, such as capturing standard I/O from the worker processes.


---

Comment by embray created at 2018-04-18 13:11:56

Replying to [comment:12 saraedum]:
> Replying to [comment:11 jdemeyer]:
> > Replying to [comment:8 embray]:
> > > Do you have any idea what's causing a non-`Exception` exception to be raised from the docbuild?
> Maybe something coming out of cysignals. But I have no clue really.
> 
> > `KeyboardInterrupt` is a likely candidate. This probably explains why interrupting the docbuilder is unreliable.
> I observed this problem in a CI run, so I don't think it's a KeyboardInterrupt. But you're right, the above example can not be killed with Ctrl-c. It just prints the KeyboardInterrupt on Python 2.7. (Works on Python 3.6.)

It's possible that if a process is taking too long, or otherwise going beyond its allowed resource usage the CI runner tries to stop it, and it might start out "nice" and just send Ctrl-Cs, though it also might move on to SIGTERM and/or SIGKILL.

It sounds to me like the enormous memory usage of the docbuild might still be a problem for #24655.  We may need to try to do more work on fixing that...


---

Comment by saraedum created at 2018-04-21 19:17:34

So, the underlying problem here was really the memory usage of the sequential docbuild, see #24655. Anyway, I think the change proposed here still makes sense.


---

Comment by embray created at 2018-04-23 14:10:21

Changing status from needs_review to positive_review.


---

Comment by embray created at 2018-04-23 14:10:21

Agreed.


---

Comment by vbraun created at 2018-05-14 17:35:59

Resolution: fixed
