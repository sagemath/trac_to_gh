# Issue 32932: Update awali to v2.1.1-220111

Issue created by migration from https://trac.sagemath.org/ticket/33169

Original creator: slabbe

Original creation time: 2022-01-14 15:07:19

It was released on January 11, 2022: http://files.vaucanson-project.org/2.1/tarballs/awali-all-v2.1.1-220111.tgz


---

Comment by slabbe created at 2022-01-14 15:19:11

Changing status from new to needs_review.


---

Comment by slabbe created at 2022-01-14 15:19:11

New commits:


---

Comment by mkoeppe created at 2022-01-14 15:59:47

Needs `upstream_url` in `checksums.ini`


---

Comment by mkoeppe created at 2022-01-14 15:59:47

Changing status from needs_review to needs_work.


---

Comment by slabbe created at 2022-01-14 16:04:45

I first put it, and then removed it before the commit because the url 

```
upstream_url=http://files.vaucanson-project.org/2.1/tarballs/awali-all-vVERSION.tgz
```

contains a `2.1` which is kind of not so generic. Do I still put it?


---

Comment by mkoeppe created at 2022-01-14 16:24:08

Yes


---

Comment by git created at 2022-01-14 17:05:51

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by slabbe created at 2022-01-14 17:06:27

Changing status from needs_work to needs_review.


---

Comment by slabbe created at 2022-01-14 17:06:27

and rebased on top of 9.5.rc1


---

Comment by slabbe created at 2022-01-14 17:10:12

oups, spkg-install needs to be updated:

```
[awali-2.1.1-220111] make[3]: *** No rule to make target 'b'.  Stop.
[awali-2.1.1-220111] ***************************************************
[awali-2.1.1-220111] Error building awali-2.1.1-220111
```



---

Comment by slabbe created at 2022-01-14 17:10:12

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-01-14 17:13:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2022-01-14 17:14:04

The change is not sufficient. I now get

```
[awali-2.1.1-220111] -- Installing: /usr/local/lib/libawalidyn.so
[awali-2.1.1-220111] CMake Error at awali/cmake_install.cmake:55 (file):
[awali-2.1.1-220111]   file INSTALL cannot copy file
[awali-2.1.1-220111]   "/home/slabbe/GitBox/sage/local/var/tmp/sage/build/awali-2.1.1-220111/src/_build/awali/libawalidyn.so"
[awali-2.1.1-220111]   to "/usr/local/lib/libawalidyn.so": Permission denied.
[awali-2.1.1-220111] Call Stack (most recent call first):
[awali-2.1.1-220111]   cmake_install.cmake:46 (include)
[awali-2.1.1-220111] 
[awali-2.1.1-220111] 
[awali-2.1.1-220111] make[3]: *** [Makefile:74: install] Error 1
[awali-2.1.1-220111] ****************************************************************************************************************************************************************
[awali-2.1.1-220111] Error building awali-2.1.1-220111
```


Indeed, http://vaucanson-project.org/Awali/2.1/download.html and their readme says to use `sudo`:

```
$ cd _build

### Configuration
$ cmake ..

### Compilation
$ make

### Installation
$ sudo make install
```

but I think we don't want to use sudo.


---

Comment by slabbe created at 2022-01-14 17:28:02

We need to specify environment variables, but I am not an expert on this. They speak about a dozen of such variables and I don't know which we need to set and how.

I tried

```diff
diff --git a/build/pkgs/awali/spkg-install.in b/build/pkgs/awali/spkg-install.in
index 6ad2f054b5..e0e52f93dd 100644
--- a/build/pkgs/awali/spkg-install.in
+++ b/build/pkgs/awali/spkg-install.in
@@ -4,7 +4,8 @@ mkdir _build
 cd _build
 cmake ..  -DINSTALL_DIR="${SAGE_LOCAL}" \
           -DPYTHON=python3 \
-          -DCORA=False
+          -DCORA=False \
+          -AWALICPP_DYNLIB_INSTALL_DIR="${SAGE_LOCAL}/lib/"
 
 sdh_make
 sdh_make install
```

but it is not sufficient as it creates the error

```
[awali-2.1.1-220111] CMake Error: CMAKE_CXX_COMPILER not set, after EnableLanguage
[awali-2.1.1-220111] -- Configuring incomplete, errors occurred!
```

`CMAKE_CXX_COMPILER` is not mentionned in their readme. I take a break on this now.


---

Comment by @marsault created at 2022-01-26 07:44:17

Hi,

I'm one of the developer of awali and I managed to have awali compiling and installing boxed into sage.

I tweaked `spkg-install.in` as:

```bash
cd src/

mkdir _build
cd _build
cmake ..  -DCMAKE_INSTALL_PREFIX="${SAGE_LOCAL}" \
          -DCOMPILE_MODULE_IN_INSTALL_DIR=TRUE \
          -DFORCE_INSTALL_IN_PREFIX=TRUE \
          -DPYTHON_BIN=python3 \
          -DCYTHON_BIN=cython \
          -DCORA=FALSE \
          -DDOCUMENTATION=FALSE

sdh_make
sdh_make recommended
sdh_make install
```

and `dependencies` as:

```
$(PYTHON) cmake cython graphviz
```


However I did not solve the error _CMake Error: CMAKE_CXX_COMPILER not set, after EnableLanguage _ mentioned above.   I simply did not encounter it.  This error apparently indicates that CMake does not find the C++ compiler.

I managed to obtain it by uninstalling g++ from my system.  In that case, it seemed that CMake was failing to infer the compiler path from environment variable `${CXX}`.  The value of `${CXX}` was set by sage as `g++ -std=gnu++11`, and according to a Google search, it seems it is because CMake does not like the space in it.

Precisely:

```
[awali-2.1.2-220122] CMake Error at /usr/share/cmake-3.18/Modules/CMakeDetermineCXXCompiler.cmake:48 (message):
[awali-2.1.2-220122]   Could not find compiler set in environment variable CXX:
[awali-2.1.2-220122]
[awali-2.1.2-220122]   g++ -std=gnu++11.
[awali-2.1.2-220122]
[awali-2.1.2-220122] Call Stack (most recent call first):
[awali-2.1.2-220122]   CMakeLists.txt:22 (project)
[awali-2.1.2-220122]
[awali-2.1.2-220122]
[awali-2.1.2-220122] CMake Error: CMAKE_CXX_COMPILER not set, after EnableLanguage
[awali-2.1.2-220122] -- Configuring incomplete, errors occurred!
```


Since having a C++ compiler is a general prerequisite for sage, it seems this error should not happen.  I don't how to solve it.

(I did not try adding `-DCMAKE_CXX_COMPILER=${CXX}` to the `cmake` line.  It could work but seems wrong: awali uses a different C++ standard, `--std=c++11`, and probably `--std=c++17` in future versions.)


---

Comment by git created at 2022-01-26 20:00:28

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by slabbe created at 2022-01-26 20:01:18

Merci Victor, I made the changes you suggested in comment:11.


---

Comment by slabbe created at 2022-01-26 20:02:05

Now, I get this:


```
[awali-2.1.1-220111] Attempting to download from http://files.vaucanson-project.org/2.1/tarballs/awali-all-v2.1.1-220111.tgz
[awali-2.1.1-220111] [......................................................................]
[awali-2.1.1-220111] awali-2.1.1-220111
[awali-2.1.1-220111] ====================================================
[awali-2.1.1-220111] Setting up build directory for awali-2.1.1-220111
[awali-2.1.1-220111] Finished extraction
[awali-2.1.1-220111] No patch files found in ../patches
[awali-2.1.1-220111] ****************************************************
[awali-2.1.1-220111] Host system:
[awali-2.1.1-220111] Linux miami 4.15.0-162-generic #170-Ubuntu SMP Mon Oct 18 11:38:05 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux
[awali-2.1.1-220111] ****************************************************
[awali-2.1.1-220111] C compiler: gcc
[awali-2.1.1-220111] C compiler version:
[awali-2.1.1-220111] Using built-in specs.
[awali-2.1.1-220111] COLLECT_GCC=/usr/bin/gcc
[awali-2.1.1-220111] COLLECT_LTO_WRAPPER=/usr/lib/gcc/x86_64-linux-gnu/7/lto-wrapper
[awali-2.1.1-220111] OFFLOAD_TARGET_NAMES=nvptx-none
[awali-2.1.1-220111] OFFLOAD_TARGET_DEFAULT=1
[awali-2.1.1-220111] Target: x86_64-linux-gnu
[awali-2.1.1-220111] Configured with: ../src/configure -v --with-pkgversion='Ubuntu 7.5.0-3ubuntu1~18.04' --with-bugurl=file:///usr/share/doc/gcc-7/README.Bugs --enable-languages=c,ada,c++,go,brig,d,fortran,objc,obj-c++ --prefix=/usr --with-gcc-major-version-only --program-suffix=-7 --program-prefix=x86_64-linux-gnu- --enable-shared --enable-linker-build-id --libexecdir=/usr/lib --without-included-gettext --enable-threads=posix --libdir=/usr/lib --enable-nls --enable-bootstrap --enable-clocale=gnu --enable-libstdcxx-debug --enable-libstdcxx-time=yes --with-default-libstdcxx-abi=new --enable-gnu-unique-object --disable-vtable-verify --enable-libmpx --enable-plugin --enable-default-pie --with-system-zlib --with-target-system-zlib --enable-objc-gc=auto --enable-multiarch --disable-werror --with-arch-32=i686 --with-abi=m64 --with-multilib-list=m32,m64,mx32 --enable-multilib --with-tune=generic --enable-offload-targets=nvptx-none --without-cuda-driver --enable-checking=release --build=x86_64-linux-gnu --host=x86_64-linux-gnu --target=x86_64-linux-gnu
[awali-2.1.1-220111] Thread model: posix
[awali-2.1.1-220111] gcc version 7.5.0 (Ubuntu 7.5.0-3ubuntu1~18.04) 
[awali-2.1.1-220111] ****************************************************
[awali-2.1.1-220111] Warning: No files to uninstall for 'awali'
[awali-2.1.1-220111] Uninstalling existing 'awali'
[awali-2.1.1-220111] Removing stamp file '/home/slabbe/GitBox/sage/local/var/lib/sage/installed/awali-1.0.2-190218'
[awali-2.1.1-220111] -- The CXX compiler identification is GNU 7.5.0
[awali-2.1.1-220111] -- Check for working CXX compiler: /home/slabbe/GitBox/sage/local/libexec/ccache/g++
[awali-2.1.1-220111] -- Check for working CXX compiler: /home/slabbe/GitBox/sage/local/libexec/ccache/g++ -- works
[awali-2.1.1-220111] -- Detecting CXX compiler ABI info
[awali-2.1.1-220111] -- Detecting CXX compiler ABI info - done
[awali-2.1.1-220111] -- Detecting CXX compile features
[awali-2.1.1-220111] -- Detecting CXX compile features - done
[awali-2.1.1-220111] -- CMake configuration for Awali, version 2.1.1
[awali-2.1.1-220111] -- Performing Test COMPILER_SUPPORTS_CXX11
[awali-2.1.1-220111] -- Performing Test COMPILER_SUPPORTS_CXX11 - Success
[awali-2.1.1-220111] -- Found PkgConfig: /usr/bin/pkg-config (found version "0.29.1") 
[awali-2.1.1-220111] CMake Warning at awali/CMakeLists.txt:45 (MESSAGE):
[awali-2.1.1-220111]   A directory was specified for on-the-fly compilation of module.  Any
[awali-2.1.1-220111]   program linked to awalidyn might attempt to write in that directory; it
[awali-2.1.1-220111]   thus must be writable by any user that might use the program.
[awali-2.1.1-220111] 
[awali-2.1.1-220111] 
[awali-2.1.1-220111] CMake Error at awali/sttc/tests/CMakeLists.txt:44 (add_compile_definitions):
[awali-2.1.1-220111]   Unknown CMake command "add_compile_definitions".
[awali-2.1.1-220111] 
[awali-2.1.1-220111] 
[awali-2.1.1-220111] -- Configuring incomplete, errors occurred!
[awali-2.1.1-220111] See also "/home/slabbe/GitBox/sage/local/var/tmp/sage/build/awali-2.1.1-220111/src/_build/CMakeFiles/CMakeOutput.log".
[awali-2.1.1-220111] Building awali-2.1.1-220111
[awali-2.1.1-220111] make[3]: *** No targets specified and no makefile found.  Stop.
[awali-2.1.1-220111] *****************************************************************************************************
[awali-2.1.1-220111] Error building awali-2.1.1-220111
[awali-2.1.1-220111] *****************************************************************************************************
```



---

Comment by @marsault created at 2022-01-27 09:00:31

Function `add_compile_definitions` was added to CMake 3.12, you probably have a prior version.

We generally require a much lesser version of CMake (3.0) hence the cryptic error message.  We will use a substitute for `add_compile_definitions` for the next release of awali (2.1.3) to enforce compatibility with CMake 3.0.  It should be out by the end of the week.

On another topic, I created a generic address for tarballs download: http://files.vaucanson-project.org/tarballs/


---

Comment by slabbe created at 2022-01-27 14:01:32

My config.log says that my system cmake was accepted by sagemath:

```
## ------------------------------------------------------ ##
## Checking whether SageMath should install SPKG cmake... ##
## ------------------------------------------------------ ##
configure:18367: checking for cmake >= 3.4
configure:18445: result: /usr/bin/cmake
configure:18454: will use system package and not install SPKG cmake
```


The version of cmake on my machine is:

```
$ /usr/bin/cmake --version
cmake version 3.10.2

CMake suite maintained and supported by Kitware (kitware.com/cmake).
```

Indeed, it is older than 3.12.

I think it is better if awali is compatible with the cmake that is currently accepted by sage, i.e., >=3.4.


---

Comment by mkoeppe created at 2022-01-27 20:19:20

I agree; `cmake` older than 3.12 is still widespread on many of our supported platforms (see https://repology.org/project/cmake/versions). We could probably increase the lower bound 3.4 a bit, but not by much unless well motivated


---

Comment by @marsault created at 2022-01-28 19:29:49

Version 2.1.3 of awali was released earlier today: http://files.vaucanson-project.org/tarballs/awali-all-v2.1.3-220128.tgz

It is compatible with CMake 3.1.0 so the above problem should no longer happen.


---

Comment by git created at 2022-05-05 09:34:27

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by slabbe created at 2022-05-05 09:35:02

I rebased the branch and updated the url and version and checksums to the 2.1.3 version.


---

Comment by slabbe created at 2022-05-05 09:36:10

Unfortunately, I can still not build it on my machine. The main error seems to be `g++: fatal error: no input files` :


```
[awali-2.1.3-220128] [100%] Building Awalipy
[awali-2.1.3-220128] -- Awalipy (1/3) - Start
[awali-2.1.3-220128] -- Awalipy (2/3) - Defering to Python module 'distutils'
[awali-2.1.3-220128] -- Awalipy (3/3) - Done
[awali-2.1.3-220128] Building awali-2.1.3-220128
[awali-2.1.3-220128] Scanning dependencies of target touch_module_directories
[awali-2.1.3-220128] Scanning dependencies of target awali_module_compiler
[awali-2.1.3-220128] [  0%] Building CXX object awali/extras/CMakeFiles/awali_module_compiler.dir/module-compiler.cc.o
[awali-2.1.3-220128] [  2%] Linking CXX executable awali_module_compiler
[awali-2.1.3-220128] Scanning dependencies of target lat-lan-lal_char-_lal_char-_b_lat-lan-lal_char-_lal_char-_b-compose
[awali-2.1.3-220128] Scanning dependencies of target lat-lan-lal_char-_lan-lal_char--_b-transducer
[awali-2.1.3-220128] Scanning dependencies of target lat-lan-lal_char-_lan-lal_char--_b-output
[awali-2.1.3-220128] Scanning dependencies of target lat-lan-lal_char-_lan-lal_char--_b-context
[awali-2.1.3-220128] Scanning dependencies of target lan-lal_char-_b-output
[awali-2.1.3-220128] Scanning dependencies of target lal_char_b-ratexp
[awali-2.1.3-220128] Scanning dependencies of target lan-lal_char-_b-context
[awali-2.1.3-220128] Compiling module "compose" for a new automaton context (lat<lan<lal_char>,lal_char>_b_lat<lan<lal_char>,lal_char>_b)
[awali-2.1.3-220128] Compiling module "transducer" for a new automaton context (lat<lan<lal_char>,lan<lal_char>>_b)
[awali-2.1.3-220128] Compiling module "ratexp" for a new automaton context (lal_char_b)
[awali-2.1.3-220128] Compiling module "context" for a new automaton context (lat<lan<lal_char>,lan<lal_char>>_b)
[awali-2.1.3-220128] Compiling module "output" for a new automaton context (lan<lal_char>_b)
[awali-2.1.3-220128] Compiling module "output" for a new automaton context (lat<lan<lal_char>,lan<lal_char>>_b)
[awali-2.1.3-220128] Compiling module "context" for a new automaton context (lan<lal_char>_b)
[awali-2.1.3-220128] Linking module "output" for a new automaton context (lat<lan<lal_char>,lan<lal_char>>_b)
[awali-2.1.3-220128] Scanning dependencies of target lan-lal_char-_b-ratexp
[awali-2.1.3-220128] Compiling module "ratexp" for a new automaton context (lan<lal_char>_b)
[awali-2.1.3-220128] Linking module "output" for a new automaton context (lan<lal_char>_b)
[awali-2.1.3-220128] Scanning dependencies of target lal_char_b_lal_char_b-product
[awali-2.1.3-220128] Compiling module "product" for a new automaton context (lal_char_b_lal_char_b)
[awali-2.1.3-220128] Linking module "compose" for a new automaton context (lat<lan<lal_char>,lal_char>_b_lat<lan<lal_char>,lal_char>_b)
[awali-2.1.3-220128] Scanning dependencies of target lal_char_b-determinize
[awali-2.1.3-220128] Compiling module "determinize" for a new automaton context (lal_char_b)
[awali-2.1.3-220128] Linking module "context" for a new automaton context (lat<lan<lal_char>,lan<lal_char>>_b)
[awali-2.1.3-220128] Scanning dependencies of target lal_char_b-context
[awali-2.1.3-220128] Compiling module "context" for a new automaton context (lal_char_b)
[awali-2.1.3-220128] Linking module "ratexp" for a new automaton context (lal_char_b)
[awali-2.1.3-220128] Linking module "context" for a new automaton context (lan<lal_char>_b)
[awali-2.1.3-220128] Scanning dependencies of target lal_char_b-automaton
[awali-2.1.3-220128] Compiling module "automaton" for a new automaton context (lal_char_b)
[awali-2.1.3-220128] Scanning dependencies of target lal_char_b-quotient
[awali-2.1.3-220128] Compiling module "quotient" for a new automaton context (lal_char_b)
[awali-2.1.3-220128] Linking module "product" for a new automaton context (lal_char_b_lal_char_b)
[awali-2.1.3-220128] Scanning dependencies of target lal_char_b-derivation
[awali-2.1.3-220128] Compiling module "derivation" for a new automaton context (lal_char_b)
[awali-2.1.3-220128] Linking module "determinize" for a new automaton context (lal_char_b)
[awali-2.1.3-220128] Scanning dependencies of target lal_char_b-partial_id
[awali-2.1.3-220128] Compiling module "partial_id" for a new automaton context (lal_char_b)
[awali-2.1.3-220128] g++: fatal error: no input files
[awali-2.1.3-220128] compilation terminated.
[awali-2.1.3-220128] terminate called after throwing an instance of 'std::runtime_error'
[awali-2.1.3-220128]   what():  Compilation of module partial_id for lal_char_b failed, command was: /home/slabbe/GitBox/sage/local/libexec/ccache/g++ -g -O2 -std=c++11 -I. -Wall -Wextra -Wsign-conversion -g -rdynamic -w -O3 -fpic -I/home/slabbe/.awali/tmp/liblal_char_b-partial_id -I/home/slabbe/GitBox/sage/local/var/tmp/sage/build/awali-1.0.2-190218/src -I/home/slabbe/GitBox/sage/local/include -I/home/slabbe/GitBox/sage/local/var/tmp/sage/build/awali-1.0.2-190218/src/_build -I/home/slabbe/GitBox/sage/local/var/tmp/sage/build/awali-1.0.2-190218/src -I/home/slabbe/GitBox/sage/local/share -c  -o /home/slabbe/.awali/tmp/liblal_char_b-partial_id/liblal_char_b-partial_id.o -MMD -MF /home/slabbe/.awali/tmp/liblal_char_b-partial_id/Makefile -MT /home/slabbe/.awali/otf/liblal_char_b-partial_id.so
[awali-2.1.3-220128] Aborted
[awali-2.1.3-220128] awali/extras/CMakeFiles/lal_char_b-partial_id.dir/build.make:58: recipe for target 'awali/extras/CMakeFiles/lal_char_b-partial_id' failed
[awali-2.1.3-220128] make[6]: *** [awali/extras/CMakeFiles/lal_char_b-partial_id] Error 134
[awali-2.1.3-220128] CMakeFiles/Makefile2:99588: recipe for target 'awali/extras/CMakeFiles/lal_char_b-partial_id.dir/all' failed
[awali-2.1.3-220128] make[5]: *** [awali/extras/CMakeFiles/lal_char_b-partial_id.dir/all] Error 2
[awali-2.1.3-220128] make[5]: *** Waiting for unfinished jobs....
[awali-2.1.3-220128] Linking module "context" for a new automaton context (lal_char_b)
[awali-2.1.3-220128] Linking module "ratexp" for a new automaton context (lan<lal_char>_b)
[awali-2.1.3-220128] Linking module "automaton" for a new automaton context (lal_char_b)
[awali-2.1.3-220128] Linking module "quotient" for a new automaton context (lal_char_b)
[awali-2.1.3-220128] Linking module "derivation" for a new automaton context (lal_char_b)
[awali-2.1.3-220128] Linking module "transducer" for a new automaton context (lat<lan<lal_char>,lan<lal_char>>_b)
[awali-2.1.3-220128] CMakeFiles/Makefile2:378: recipe for target 'CMakeFiles/recommended.dir/rule' failed
[awali-2.1.3-220128] make[4]: *** [CMakeFiles/recommended.dir/rule] Error 2
[awali-2.1.3-220128] Makefile:253: recipe for target 'recommended' failed
[awali-2.1.3-220128] make[3]: *** [recommended] Error 2
[awali-2.1.3-220128] *****************************************************************************************************
[awali-2.1.3-220128] Error building awali-2.1.3-220128
[awali-2.1.3-220128] *****************************************************************************************************
```

