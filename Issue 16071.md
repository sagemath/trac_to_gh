# Issue 16071: Improve sums of squares

archive/issues_016071.json:
```json
{
    "body": "CC:  @nathanncohen @kcrisman @videlec\n\nWriting an integer as sum of N squares.\n\nIssue created by migration from https://trac.sagemath.org/ticket/16308\n\n",
    "created_at": "2014-05-08T09:28:38Z",
    "labels": [
        "component: basic arithmetic"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.3",
    "title": "Improve sums of squares",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16071",
    "user": "https://github.com/jdemeyer"
}
```
CC:  @nathanncohen @kcrisman @videlec

Writing an integer as sum of N squares.

Issue created by migration from https://trac.sagemath.org/ticket/16308





---

archive/issue_comments_208986.json:
```json
{
    "body": "Changing component from basic arithmetic to number theory.",
    "created_at": "2014-05-08T09:53:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-208986",
    "user": "https://github.com/pjbruin"
}
```

Changing component from basic arithmetic to number theory.



---

archive/issue_comments_208987.json:
```json
{
    "body": "Replying to [comment:2 jdemeyer]:\n\nOK, I should have written a comment to ask what the idea was instead of adding possible interpretations to the description.  Given that your name is in the Author field, are you working on this?",
    "created_at": "2014-05-08T13:51:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-208987",
    "user": "https://github.com/pjbruin"
}
```

Replying to [comment:2 jdemeyer]:

OK, I should have written a comment to ask what the idea was instead of adding possible interpretations to the description.  Given that your name is in the Author field, are you working on this?



---

archive/issue_comments_208988.json:
```json
{
    "body": "Define \"number\".",
    "created_at": "2014-05-08T14:02:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-208988",
    "user": "https://github.com/nexttime"
}
```

Define "number".



---

archive/issue_comments_208989.json:
```json
{
    "body": "Replying to [comment:6 leif]:\n> Define \"number\".\nElement of `ZZ`.",
    "created_at": "2014-05-08T15:59:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-208989",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:6 leif]:
> Define "number".
Element of `ZZ`.



---

archive/issue_comments_208990.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-05-08T16:15:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-208990",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_208991.json:
```json
{
    "body": "New commits:",
    "created_at": "2014-05-08T16:15:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-208991",
    "user": "https://github.com/jdemeyer"
}
```

New commits:



---

archive/issue_comments_208992.json:
```json
{
    "body": "It is embarrassing to say so, but for many examples, the old GAP code is actually faster. The reason seems to be that GAP beats PARI on factoring small numbers (which is a big surprise to me!). But GAP doesn't support large numbers:\n\n```\nsage: two_squares(3^100+1)\nRuntimeError: Gap produced error output\nError, sorry,  cannot factor [ 1109667565348268894775749972955601 ]\ntype 'return;' to try again with a larger number of trials in\nFactorsRho (or use option 'RhoTrials')\n\n\n   executing TwoSquares(515377520732011331036461129765621272702107522002);\n\n```\n",
    "created_at": "2014-05-08T16:25:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-208992",
    "user": "https://github.com/jdemeyer"
}
```

It is embarrassing to say so, but for many examples, the old GAP code is actually faster. The reason seems to be that GAP beats PARI on factoring small numbers (which is a big surprise to me!). But GAP doesn't support large numbers:

```
sage: two_squares(3^100+1)
RuntimeError: Gap produced error output
Error, sorry,  cannot factor [ 1109667565348268894775749972955601 ]
type 'return;' to try again with a larger number of trials in
FactorsRho (or use option 'RhoTrials')


   executing TwoSquares(515377520732011331036461129765621272702107522002);

```




---

archive/issue_comments_208993.json:
```json
{
    "body": "GAP is amazing:\n\n\n```\nsage: timeit('libgap(19180172397815991981).FactorsInt()', number=1000, repeat=10)\n1000 loops, best of 10: 103 \u00b5s per loop\nsage: timeit('pari(19180172397815991981).factor(proof=False)', number=1000, repeat=10)\n1000 loops, best of 10: 2.43 ms per loop\n```\n",
    "created_at": "2014-05-08T16:31:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-208993",
    "user": "https://github.com/jdemeyer"
}
```

GAP is amazing:


```
sage: timeit('libgap(19180172397815991981).FactorsInt()', number=1000, repeat=10)
1000 loops, best of 10: 103 µs per loop
sage: timeit('pari(19180172397815991981).factor(proof=False)', number=1000, repeat=10)
1000 loops, best of 10: 2.43 ms per loop
```




---

archive/issue_comments_208994.json:
```json
{
    "body": "Interesting...  Since this code is probably not the place where Sage should have to make a decision about which factoring algorithm to use, it looks tempting to use `Integer.factor()` instead of `pari.factor()` and spend some effort on #1145.  (And possibly add support for `algorithm=gap` in `Integer.factor()` if it is worthwhile?)",
    "created_at": "2014-05-08T16:47:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-208994",
    "user": "https://github.com/pjbruin"
}
```

Interesting...  Since this code is probably not the place where Sage should have to make a decision about which factoring algorithm to use, it looks tempting to use `Integer.factor()` instead of `pari.factor()` and spend some effort on #1145.  (And possibly add support for `algorithm=gap` in `Integer.factor()` if it is worthwhile?)



---

archive/issue_comments_208995.json:
```json
{
    "body": "And I'd still support the `algorithm` keyword...\n\nDoes make returning `(a,b)` with a (or b) zero any sense?",
    "created_at": "2014-05-08T16:59:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-208995",
    "user": "https://github.com/nexttime"
}
```

And I'd still support the `algorithm` keyword...

Does make returning `(a,b)` with a (or b) zero any sense?



---

archive/issue_comments_208996.json:
```json
{
    "body": "Replying to [comment:13 leif]:\n> Does make returning `(a,b)` with a (or b) zero any sense?\n\nTo be more precise, IMHO both a and b should be < n<sup>1/2</sup> (for `two_squares()`).\n\nI don't think anybody would expect e.g. `two_squares(25)` to return the trivial solution `(0,5)` instead of `(3,4)`.",
    "created_at": "2014-05-08T17:19:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-208996",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:13 leif]:
> Does make returning `(a,b)` with a (or b) zero any sense?

To be more precise, IMHO both a and b should be < n<sup>1/2</sup> (for `two_squares()`).

I don't think anybody would expect e.g. `two_squares(25)` to return the trivial solution `(0,5)` instead of `(3,4)`.



---

archive/issue_comments_208997.json:
```json
{
    "body": "(GAP apparently only returns (0,sqrt(n)) if there is no other solution, with sqrt(n) integer of course.)",
    "created_at": "2014-05-08T17:32:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-208997",
    "user": "https://github.com/nexttime"
}
```

(GAP apparently only returns (0,sqrt(n)) if there is no other solution, with sqrt(n) integer of course.)



---

archive/issue_comments_208998.json:
```json
{
    "body": "> I don't think anybody would expect e.g. two_squares(25) to return the trivial solution (0,5) instead of (3,4).\nHmm, well that IS a solution.  And if you want to use it to approximate the value of pi, you need all of them (though this one in any case wouldn't give negative solutions).",
    "created_at": "2014-05-08T17:58:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-208998",
    "user": "https://github.com/kcrisman"
}
```

> I don't think anybody would expect e.g. two_squares(25) to return the trivial solution (0,5) instead of (3,4).
Hmm, well that IS a solution.  And if you want to use it to approximate the value of pi, you need all of them (though this one in any case wouldn't give negative solutions).



---

archive/issue_comments_208999.json:
```json
{
    "body": "Replying to [comment:16 kcrisman]:\n> > I don't think anybody would expect e.g. two_squares(25) to return the trivial solution (0,5) instead of (3,4).\n> Hmm, well that IS a solution.\n\nDepends on the definition of two_squares(); the previous one in Sage was pretty vague.",
    "created_at": "2014-05-08T18:02:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-208999",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:16 kcrisman]:
> > I don't think anybody would expect e.g. two_squares(25) to return the trivial solution (0,5) instead of (3,4).
> Hmm, well that IS a solution.

Depends on the definition of two_squares(); the previous one in Sage was pretty vague.



---

archive/issue_comments_209000.json:
```json
{
    "body": "Replying to [comment:14 leif]:\n> I don't think anybody would expect e.g. `two_squares(25)` to return the trivial solution `(0,5)` instead of `(3,4)`.\n\nFrom a number-theory point of view, there is nothing wrong with `(0,5)`. In fact, in some cases, the only solution is the \"trivial\" one, for example for 9.",
    "created_at": "2014-05-08T19:45:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-209000",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:14 leif]:
> I don't think anybody would expect e.g. `two_squares(25)` to return the trivial solution `(0,5)` instead of `(3,4)`.

From a number-theory point of view, there is nothing wrong with `(0,5)`. In fact, in some cases, the only solution is the "trivial" one, for example for 9.



---

archive/issue_comments_209001.json:
```json
{
    "body": "Replying to [comment:12 pbruin]:\n> Interesting...  Since this code is probably not the place where Sage should have to make a decision about which factoring algorithm to use, it looks tempting to use `Integer.factor()` instead of `pari.factor()`\nI guess you're right, but I decided to do everything in PARI for speed, also with the idea that the code could be changed to use direct calls to the PARI library if needed.",
    "created_at": "2014-05-08T19:49:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-209001",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:12 pbruin]:
> Interesting...  Since this code is probably not the place where Sage should have to make a decision about which factoring algorithm to use, it looks tempting to use `Integer.factor()` instead of `pari.factor()`
I guess you're right, but I decided to do everything in PARI for speed, also with the idea that the code could be changed to use direct calls to the PARI library if needed.



---

archive/issue_comments_209002.json:
```json
{
    "body": "Replying to [comment:18 jdemeyer]:\n> Replying to [comment:14 leif]:\n> > I don't think anybody would expect e.g. `two_squares(25)` to return the trivial solution `(0,5)` instead of `(3,4)`.\n> \n> From a number-theory point of view, there is nothing wrong with `(0,5)`. In fact, in some cases, the only solution is the \"trivial\" one, for example for 9.\n\nAs mentioned, depends on how you specify two_squares().\n\nFrom a user perspective, I think there should be some optional argument `no_trivial_solutions`, as feeding the function with perfect squares otherwise doesn't make much sense.",
    "created_at": "2014-05-08T19:51:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-209002",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:18 jdemeyer]:
> Replying to [comment:14 leif]:
> > I don't think anybody would expect e.g. `two_squares(25)` to return the trivial solution `(0,5)` instead of `(3,4)`.
> 
> From a number-theory point of view, there is nothing wrong with `(0,5)`. In fact, in some cases, the only solution is the "trivial" one, for example for 9.

As mentioned, depends on how you specify two_squares().

From a user perspective, I think there should be some optional argument `no_trivial_solutions`, as feeding the function with perfect squares otherwise doesn't make much sense.



---

archive/issue_comments_209003.json:
```json
{
    "body": "Replying to [comment:20 leif]:\n> as feeding the function with perfect squares otherwise doesn't make much sense.\nDepends on your application...\n\nAnyway, if people really care about non-trivial solutions, let those people implement such a flag, I'm not going to do it.",
    "created_at": "2014-05-08T20:07:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-209003",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:20 leif]:
> as feeding the function with perfect squares otherwise doesn't make much sense.
Depends on your application...

Anyway, if people really care about non-trivial solutions, let those people implement such a flag, I'm not going to do it.



---

archive/issue_comments_209004.json:
```json
{
    "body": "Replying to [comment:18 jdemeyer]:\n> Replying to [comment:14 leif]:\n> > I don't think anybody would expect e.g. `two_squares(25)` to return the trivial solution `(0,5)` instead of `(3,4)`.\n> \n> From a number-theory point of view, there is nothing wrong with `(0,5)`. In fact, in some cases, the only solution is the \"trivial\" one, for example for 9.\nI agree.  Given that 0 is a square, it makes complete sense to allow it as a term in a sum of squares.  That convention makes a lot of things nicer, for example:\n- every square is also a sum of two squares, and more generally every sum of *k* squares is also a sum of *k* + 1 squares;\n- *n* is a sum of 2 squares if and only if *n* can be factored non-trivially in **Z**[*i*];\n- *n* is a sum of *k* squares if and only if the lattice **Z**<sup>*k*</sup> has a point of squared distance *n* from the origin.\nThere are also nice formulae for the number of ways to write *n* as a sum of *k* squares if you interpret this number as the number of points (*x*<sub>1</sub> , ... , *x*<sub>k</sub>) in **Z**<sup>*k*</sup> with *x*<sub>1</sub><sup>2</sup> + ... + *x<sub>k</sub>*<sup>2</sup> = *n*.",
    "created_at": "2014-05-08T20:10:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-209004",
    "user": "https://github.com/pjbruin"
}
```

Replying to [comment:18 jdemeyer]:
> Replying to [comment:14 leif]:
> > I don't think anybody would expect e.g. `two_squares(25)` to return the trivial solution `(0,5)` instead of `(3,4)`.
> 
> From a number-theory point of view, there is nothing wrong with `(0,5)`. In fact, in some cases, the only solution is the "trivial" one, for example for 9.
I agree.  Given that 0 is a square, it makes complete sense to allow it as a term in a sum of squares.  That convention makes a lot of things nicer, for example:
- every square is also a sum of two squares, and more generally every sum of *k* squares is also a sum of *k* + 1 squares;
- *n* is a sum of 2 squares if and only if *n* can be factored non-trivially in **Z**[*i*];
- *n* is a sum of *k* squares if and only if the lattice **Z**<sup>*k*</sup> has a point of squared distance *n* from the origin.
There are also nice formulae for the number of ways to write *n* as a sum of *k* squares if you interpret this number as the number of points (*x*<sub>1</sub> , ... , *x*<sub>k</sub>) in **Z**<sup>*k*</sup> with *x*<sub>1</sub><sup>2</sup> + ... + *x<sub>k</sub>*<sup>2</sup> = *n*.



---

archive/issue_comments_209005.json:
```json
{
    "body": "Replying to [comment:21 jdemeyer]:\n> Anyway, if people really care about non-trivial solutions, let those people implement such a flag, I'm not going to do it.\n\n`algorithm=\"gap\"`?\n\nWe'd need that for backwards compatibility anyway, besides that you said GAP is faster (in factoring at least) for some (which kind of?) inputs.",
    "created_at": "2014-05-08T20:12:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-209005",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:21 jdemeyer]:
> Anyway, if people really care about non-trivial solutions, let those people implement such a flag, I'm not going to do it.

`algorithm="gap"`?

We'd need that for backwards compatibility anyway, besides that you said GAP is faster (in factoring at least) for some (which kind of?) inputs.



---

archive/issue_comments_209006.json:
```json
{
    "body": "Hi there,\n\nFor very small integers (<500) a naive cython implementation is **much** faster (at least x100)... as this was the initial purpose of Nathann I make the remark here.\n\n```\ndef two_squares_pyx(int n):\n    cdef int i,ii,j,nn\n    if n < 2:\n        return True\n\n    i = ii = 0\n    while ii < n:\n        j = 0\n        while j <= i:\n            nn = ii + j*j\n            if nn >= n:\n                break\n            j += 1\n\n        if nn == n:\n            return (i,j)\n\n        i += 1\n        ii = i*i\n\n    raise ValueError(\"%d is not the sum of 2 squares\"%n)\n```\n\nthen\n\n```\nsage: %timeit two_squares(37)\n10000 loops, best of 3: 108 \u00b5s per loop\nsage: %timeit two_squares_pyx(37)\n1000000 loops, best of 3: 464 ns per loop\n\nsage: %timeit two_squares(97)\n10000 loops, best of 3: 185 \u00b5s per loop\nsage: %timeit two_squares_pyx(97)\n1000000 loops, best of 3: 558 ns per loop\n\nsage: %timeit two_squares(212)\n10000 loops, best of 3: 130 \u00b5s per loop\nsage: %timeit two_squares_pyx(212)\n1000000 loops, best of 3: 734 ns per loop\n\nsage: %timeit two_squares(500)\n10000 loops, best of 3: 131 \u00b5s per loop\nsage: %timeit two_squares_pyx(500)\n1000000 loops, best of 3: 1 \u00b5s per loop\n```\n\n\nWhat do you think of using it for entries < 500?\n\nVincent",
    "created_at": "2014-05-08T21:16:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-209006",
    "user": "https://github.com/videlec"
}
```

Hi there,

For very small integers (<500) a naive cython implementation is **much** faster (at least x100)... as this was the initial purpose of Nathann I make the remark here.

```
def two_squares_pyx(int n):
    cdef int i,ii,j,nn
    if n < 2:
        return True

    i = ii = 0
    while ii < n:
        j = 0
        while j <= i:
            nn = ii + j*j
            if nn >= n:
                break
            j += 1

        if nn == n:
            return (i,j)

        i += 1
        ii = i*i

    raise ValueError("%d is not the sum of 2 squares"%n)
```

then

```
sage: %timeit two_squares(37)
10000 loops, best of 3: 108 µs per loop
sage: %timeit two_squares_pyx(37)
1000000 loops, best of 3: 464 ns per loop

sage: %timeit two_squares(97)
10000 loops, best of 3: 185 µs per loop
sage: %timeit two_squares_pyx(97)
1000000 loops, best of 3: 558 ns per loop

sage: %timeit two_squares(212)
10000 loops, best of 3: 130 µs per loop
sage: %timeit two_squares_pyx(212)
1000000 loops, best of 3: 734 ns per loop

sage: %timeit two_squares(500)
10000 loops, best of 3: 131 µs per loop
sage: %timeit two_squares_pyx(500)
1000000 loops, best of 3: 1 µs per loop
```


What do you think of using it for entries < 500?

Vincent



---

archive/issue_comments_209007.json:
```json
{
    "body": "(and the Cython version can even be improved)",
    "created_at": "2014-05-08T21:18:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-209007",
    "user": "https://github.com/videlec"
}
```

(and the Cython version can even be improved)



---

archive/issue_comments_209008.json:
```json
{
    "body": "I was hoping someone would do this.\n\nI agree with pbruin, though of course this is not the same function as \"number of ways to write as two squares\" or \"all ways to write as sum of two squares\".  This is what happens when we \"unwrap\" :-)",
    "created_at": "2014-05-09T01:18:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-209008",
    "user": "https://github.com/kcrisman"
}
```

I was hoping someone would do this.

I agree with pbruin, though of course this is not the same function as "number of ways to write as two squares" or "all ways to write as sum of two squares".  This is what happens when we "unwrap" :-)



---

archive/issue_comments_209009.json:
```json
{
    "body": "Replying to [comment:25 vdelecroix]:\n> {{{\n> def two_squares_pyx(int n):\n>     cdef int i,ii,j,nn\n>     if n < 2:\n>         return True\n> \n>     i = ii = 0\n>     while ii < n:\n>         j = 0\n>         while j <= i:\n>             nn = ii + j*j\n>             if nn >= n:\n>                 break\n>             j += 1\n> \n>         if nn == n:\n>             return (i,j)\n> \n>         i += 1\n>         ii = i*i\n> \n>     raise ValueError(\"%d is not the sum of 2 squares\"%n)\n> }}}\n\nMinor correction: `while ii <= n` (such that we get \"trivial\" solutions with `j==0` as well).  Also, I'd swap i and j, or `return (j,i)`.",
    "created_at": "2014-05-09T01:19:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-209009",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:25 vdelecroix]:
> {{{
> def two_squares_pyx(int n):
>     cdef int i,ii,j,nn
>     if n < 2:
>         return True
> 
>     i = ii = 0
>     while ii < n:
>         j = 0
>         while j <= i:
>             nn = ii + j*j
>             if nn >= n:
>                 break
>             j += 1
> 
>         if nn == n:
>             return (i,j)
> 
>         i += 1
>         ii = i*i
> 
>     raise ValueError("%d is not the sum of 2 squares"%n)
> }}}

Minor correction: `while ii <= n` (such that we get "trivial" solutions with `j==0` as well).  Also, I'd swap i and j, or `return (j,i)`.



---

archive/issue_comments_209010.json:
```json
{
    "body": "Well, I don't care much about `a==0` (a matter of definition, it's ok, and one usually has to treat zeroes differently anyway), but normally one isn't interested in a trivial solution, unless it's *the only one*, and if there's no way to get (or even get to know whether there is) a non-trivial solution [as well]...",
    "created_at": "2014-05-09T01:27:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-209010",
    "user": "https://github.com/nexttime"
}
```

Well, I don't care much about `a==0` (a matter of definition, it's ok, and one usually has to treat zeroes differently anyway), but normally one isn't interested in a trivial solution, unless it's *the only one*, and if there's no way to get (or even get to know whether there is) a non-trivial solution [as well]...



---

archive/issue_comments_209011.json:
```json
{
    "body": "And feel free to implement a *different* function that returns *a list of* [all] solutions...",
    "created_at": "2014-05-09T01:29:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-209011",
    "user": "https://github.com/nexttime"
}
```

And feel free to implement a *different* function that returns *a list of* [all] solutions...



---

archive/issue_comments_209012.json:
```json
{
    "body": "Hello,\n\nI implemented what I said in Cython (i.e. `two_squares_pyx`, `three_squares_pyx` and `four_squares_pyx`). Timings are now much better for small values (but it also influences small values).\n\nBased on the timings below (with the old version), I put the threshold to 500 for the three functions. But if you have strong opinion for another threshold please tell me. \n\nThere are many comments, but is there somebody up for a review ?\n\nVincent\n\nTwo squares\n\n```\nsage: %timeit two_squares(101)\n10000 loops, best of 3: 94.5 \u00b5s per loop\nsage: %timeit two_squares_pyx(101)\n1000000 loops, best of 3: 780 ns per loop\n\nsage: timeit(\"try:\\n    two_squares(102)\\nexcept ValueError:\\n    pass\")\n625 loops, best of 3: 57.4 \u00b5s per loop\nsage: timeit(\"try:\\n    two_squares_pyx(102)\\nexcept ValueError:\\n    pass\")\n625 loops, best of 3: 6.4 \u00b5s per loop\n\nsage: %timeit two_squares(200)\n10000 loops, best of 3: 87.3 \u00b5s per loop\nsage: %timeit two_squares_pyx(200)\n1000000 loops, best of 3: 788 ns per loop\n\nsage: timeit(\"try:\\n    two_squares(201)\\nexcept ValueError:\\n    pass\")\n625 loops, best of 3: 39.6 \u00b5s per loop\nsage: timeit(\"try:\\n    two_squares_pyx(201)\\nexcept ValueError:\\n    pass\")\n625 loops, best of 3: 6.61 \u00b5s per loop\n\nsage: %timeit two_squares(305)\n10000 loops, best of 3: 158 \u00b5s per loop\nsage: %timeit two_squares_pyx(305)\n1000000 loops, best of 3: 998 ns per loop\n\nsage: timeit(\"try:\\n    two_squares(304)\\nexcept ValueError:\\n    pass\")\n625 loops, best of 3: 50.8 \u00b5s per loop\nsage: timeit(\"try:\\n    two_squares_pyx(304)\\nexcept ValueError:\\n    pass\")\n625 loops, best of 3: 6.71 \u00b5s per loop\n\nsage: %timeit two_squares(400)\n10000 loops, best of 3: 69.4 \u00b5s per loop\nsage: %timeit two_squares_pyx(400)\n1000000 loops, best of 3: 1.01 \u00b5s per loop\n\nsage: timeit(\"try:\\n    two_squares(402)\\nexcept ValueError:\\n    pass\")\n625 loops, best of 3: 57.5 \u00b5s per loop\nsage: timeit(\"try:\\n    two_squares_pyx(402)\\nexcept ValueError:\\n    pass\")\n625 loops, best of 3: 6.85 \u00b5s per loop\n\nsage: %timeit two_squares(500)\n10000 loops, best of 3: 119 \u00b5s per loop\nsage: %timeit two_squares_pyx(500)\n1000000 loops, best of 3: 1.18 \u00b5s per loop\n\nsage: timeit(\"try:\\n    two_squares(501)\\nexcept ValueError:\\n    pass\")\n625 loops, best of 3: 39.5 \u00b5s per loop\nsage: timeit(\"try:\\n    two_squares_pyx(501)\\nexcept ValueError:\\n    pass\")\n625 loops, best of 3: 6.76 \u00b5s per loop\n```\n\n\nThree squares\n\n```\nsage: %timeit three_squares(106)\n1000 loops, best of 3: 266 \u00b5s per loop\nsage: %timeit three_squares_pyx(106)\n1000000 loops, best of 3: 1.38 \u00b5s per loop\n\nsage: timeit(\"try:\\n    three_squares(103)\\nexcept ValueError:\\n    pass\")\n625 loops, best of 3: 52.2 \u00b5s per loop\nsage: timeit(\"try:\\n    three_squares_pyx(103)\\nexcept ValueError:\\n    pass\")\n625 loops, best of 3: 6.9 \u00b5s per loop\n\nsage: %timeit three_squares(200)\n1000 loops, best of 3: 205 \u00b5s per loop\nsage: %timeit three_squares_pyx(200)\n1000000 loops, best of 3: 1.81 \u00b5s per loop\n\nsage: timeit(\"try:\\n    three_squares(303)\\nexcept ValueError:\\n    pass\")\n625 loops, best of 3: 52.1 \u00b5s per loop\nsage: timeit(\"try:\\n    three_squares_pyx(303)\\nexcept ValueError:\\n    pass\")\n625 loops, best of 3: 9.24 \u00b5s per loop\n\nsage: %timeit three_squares(406)\n1000 loops, best of 3: 189 \u00b5s per loop\nsage: %timeit three_squares_pyx(406)\n100000 loops, best of 3: 3.46 \u00b5s per loop\n\nsage: timeit(\"try:\\n    three_squares(407)\\nexcept ValueError:\\n    pass\")\n625 loops, best of 3: 51.6 \u00b5s per loop\nsage: timeit(\"try:\\n    three_squares_pyx(407)\\nexcept ValueError:\\n    pass\")\n625 loops, best of 3: 10.5 \u00b5s per loop\n\nsage: %timeit three_squares(500)\n10000 loops, best of 3: 167 \u00b5s per loop\nsage: %timeit three_squares_pyx(500)\n100000 loops, best of 3: 3.89 \u00b5s per loop\n\nsage: timeit(\"try:\\n    three_squares(503)\\nexcept ValueError:\\n    pass\")\n625 loops, best of 3: 51.2 \u00b5s per loop\nsage: timeit(\"try:\\n    three_squares_pyx(503)\\nexcept ValueError:\\n    pass\")\n625 loops, best of 3: 10.7 \u00b5s per loop\n```\n\n\nFour squares\n\n```\nsage: %timeit four_squares(503)\n1000 loops, best of 3: 259 \u00b5s per loop\nsage: %timeit four_squares_pyx(503)\n100000 loops, best of 3: 13.5 \u00b5s per loop\n```\n\n----\nNew commits:",
    "created_at": "2014-05-15T20:37:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-209012",
    "user": "https://github.com/videlec"
}
```

Hello,

I implemented what I said in Cython (i.e. `two_squares_pyx`, `three_squares_pyx` and `four_squares_pyx`). Timings are now much better for small values (but it also influences small values).

Based on the timings below (with the old version), I put the threshold to 500 for the three functions. But if you have strong opinion for another threshold please tell me. 

There are many comments, but is there somebody up for a review ?

Vincent

Two squares

```
sage: %timeit two_squares(101)
10000 loops, best of 3: 94.5 µs per loop
sage: %timeit two_squares_pyx(101)
1000000 loops, best of 3: 780 ns per loop

sage: timeit("try:\n    two_squares(102)\nexcept ValueError:\n    pass")
625 loops, best of 3: 57.4 µs per loop
sage: timeit("try:\n    two_squares_pyx(102)\nexcept ValueError:\n    pass")
625 loops, best of 3: 6.4 µs per loop

sage: %timeit two_squares(200)
10000 loops, best of 3: 87.3 µs per loop
sage: %timeit two_squares_pyx(200)
1000000 loops, best of 3: 788 ns per loop

sage: timeit("try:\n    two_squares(201)\nexcept ValueError:\n    pass")
625 loops, best of 3: 39.6 µs per loop
sage: timeit("try:\n    two_squares_pyx(201)\nexcept ValueError:\n    pass")
625 loops, best of 3: 6.61 µs per loop

sage: %timeit two_squares(305)
10000 loops, best of 3: 158 µs per loop
sage: %timeit two_squares_pyx(305)
1000000 loops, best of 3: 998 ns per loop

sage: timeit("try:\n    two_squares(304)\nexcept ValueError:\n    pass")
625 loops, best of 3: 50.8 µs per loop
sage: timeit("try:\n    two_squares_pyx(304)\nexcept ValueError:\n    pass")
625 loops, best of 3: 6.71 µs per loop

sage: %timeit two_squares(400)
10000 loops, best of 3: 69.4 µs per loop
sage: %timeit two_squares_pyx(400)
1000000 loops, best of 3: 1.01 µs per loop

sage: timeit("try:\n    two_squares(402)\nexcept ValueError:\n    pass")
625 loops, best of 3: 57.5 µs per loop
sage: timeit("try:\n    two_squares_pyx(402)\nexcept ValueError:\n    pass")
625 loops, best of 3: 6.85 µs per loop

sage: %timeit two_squares(500)
10000 loops, best of 3: 119 µs per loop
sage: %timeit two_squares_pyx(500)
1000000 loops, best of 3: 1.18 µs per loop

sage: timeit("try:\n    two_squares(501)\nexcept ValueError:\n    pass")
625 loops, best of 3: 39.5 µs per loop
sage: timeit("try:\n    two_squares_pyx(501)\nexcept ValueError:\n    pass")
625 loops, best of 3: 6.76 µs per loop
```


Three squares

```
sage: %timeit three_squares(106)
1000 loops, best of 3: 266 µs per loop
sage: %timeit three_squares_pyx(106)
1000000 loops, best of 3: 1.38 µs per loop

sage: timeit("try:\n    three_squares(103)\nexcept ValueError:\n    pass")
625 loops, best of 3: 52.2 µs per loop
sage: timeit("try:\n    three_squares_pyx(103)\nexcept ValueError:\n    pass")
625 loops, best of 3: 6.9 µs per loop

sage: %timeit three_squares(200)
1000 loops, best of 3: 205 µs per loop
sage: %timeit three_squares_pyx(200)
1000000 loops, best of 3: 1.81 µs per loop

sage: timeit("try:\n    three_squares(303)\nexcept ValueError:\n    pass")
625 loops, best of 3: 52.1 µs per loop
sage: timeit("try:\n    three_squares_pyx(303)\nexcept ValueError:\n    pass")
625 loops, best of 3: 9.24 µs per loop

sage: %timeit three_squares(406)
1000 loops, best of 3: 189 µs per loop
sage: %timeit three_squares_pyx(406)
100000 loops, best of 3: 3.46 µs per loop

sage: timeit("try:\n    three_squares(407)\nexcept ValueError:\n    pass")
625 loops, best of 3: 51.6 µs per loop
sage: timeit("try:\n    three_squares_pyx(407)\nexcept ValueError:\n    pass")
625 loops, best of 3: 10.5 µs per loop

sage: %timeit three_squares(500)
10000 loops, best of 3: 167 µs per loop
sage: %timeit three_squares_pyx(500)
100000 loops, best of 3: 3.89 µs per loop

sage: timeit("try:\n    three_squares(503)\nexcept ValueError:\n    pass")
625 loops, best of 3: 51.2 µs per loop
sage: timeit("try:\n    three_squares_pyx(503)\nexcept ValueError:\n    pass")
625 loops, best of 3: 10.7 µs per loop
```


Four squares

```
sage: %timeit four_squares(503)
1000 loops, best of 3: 259 µs per loop
sage: %timeit four_squares_pyx(503)
100000 loops, best of 3: 13.5 µs per loop
```

----
New commits:



---

archive/issue_comments_209013.json:
```json
{
    "body": "Of course, we can revert to the jeroen branch if my contribution seems useless...\n\nVincent",
    "created_at": "2014-05-15T21:54:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-209013",
    "user": "https://github.com/videlec"
}
```

Of course, we can revert to the jeroen branch if my contribution seems useless...

Vincent



---

archive/issue_comments_209014.json:
```json
{
    "body": "Hi,\n\nSorry. I was a bit fast. The decision of choosing my branch or not might be the choice of the author of the ticket. So if you want to have a look at my changes, see either u/vdelecroix/16308 or public/16308\n\nVincent",
    "created_at": "2014-05-15T22:01:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-209014",
    "user": "https://github.com/videlec"
}
```

Hi,

Sorry. I was a bit fast. The decision of choosing my branch or not might be the choice of the author of the ticket. So if you want to have a look at my changes, see either u/vdelecroix/16308 or public/16308

Vincent



---

archive/issue_comments_209015.json:
```json
{
    "body": "New commits:",
    "created_at": "2014-05-15T22:01:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-209015",
    "user": "https://github.com/videlec"
}
```

New commits:



---

archive/issue_comments_209016.json:
```json
{
    "body": "There's even more room for optimizations; a C/Cython version is probably faster up to at least 10000 or even 2<sup>16</sup> (for `two_squares()`).\n\nI'd also compare the overall speed over a range.",
    "created_at": "2014-05-15T23:43:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-209016",
    "user": "https://github.com/nexttime"
}
```

There's even more room for optimizations; a C/Cython version is probably faster up to at least 10000 or even 2<sup>16</sup> (for `two_squares()`).

I'd also compare the overall speed over a range.



---

archive/issue_comments_209017.json:
```json
{
    "body": "P.S.:  If a solution exists, *k*`_squares()` should IMHO **always** return a *k*-tuple.",
    "created_at": "2014-05-15T23:47:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-209017",
    "user": "https://github.com/nexttime"
}
```

P.S.:  If a solution exists, *k*`_squares()` should IMHO **always** return a *k*-tuple.



---

archive/issue_comments_209018.json:
```json
{
    "body": "Replying to [comment:33 vdelecroix]:\n> Sorry. I was a bit fast. The decision of choosing my branch or not might be the choice of the author of the ticket. So if you want to have a look at my changes, see either u/vdelecroix/16308 or public/16308\n\nProbably open a separate ticket \"Improve sums of squares *for small input*\" and we can later (re)base one of them on the other.",
    "created_at": "2014-05-16T15:03:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-209018",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:33 vdelecroix]:
> Sorry. I was a bit fast. The decision of choosing my branch or not might be the choice of the author of the ticket. So if you want to have a look at my changes, see either u/vdelecroix/16308 or public/16308

Probably open a separate ticket "Improve sums of squares *for small input*" and we can later (re)base one of them on the other.



---

archive/issue_comments_209019.json:
```json
{
    "body": "Replying to [comment:37 leif]:\n> Replying to [comment:33 vdelecroix]:\n> > Sorry. I was a bit fast. The decision of choosing my branch or not might be the choice of the author of the ticket. So if you want to have a look at my changes, see either u/vdelecroix/16308 or public/16308\n> \n> Probably open a separate ticket \"Improve sums of squares *for small input*\" and we can later (re)base one of them on the other.\n\nGood idea. Done in #16374.",
    "created_at": "2014-05-17T19:38:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-209019",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:37 leif]:
> Replying to [comment:33 vdelecroix]:
> > Sorry. I was a bit fast. The decision of choosing my branch or not might be the choice of the author of the ticket. So if you want to have a look at my changes, see either u/vdelecroix/16308 or public/16308
> 
> Probably open a separate ticket "Improve sums of squares *for small input*" and we can later (re)base one of them on the other.

Good idea. Done in #16374.



---

archive/issue_comments_209020.json:
```json
{
    "body": "Replying to [comment:36 leif]:\n> P.S.:  If a solution exists, *k*`_squares()` should IMHO **always** return a *k*-tuple.\nSure, in which case does it not do that?",
    "created_at": "2014-05-19T10:10:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-209020",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:36 leif]:
> P.S.:  If a solution exists, *k*`_squares()` should IMHO **always** return a *k*-tuple.
Sure, in which case does it not do that?



---

archive/issue_comments_209021.json:
```json
{
    "body": "Replying to [comment:40 jdemeyer]:\n> Replying to [comment:36 leif]:\n> > P.S.:  If a solution exists, *k*`_squares()` should IMHO **always** return a *k*-tuple.\n> Sure, in which case does it not do that?\n\nSorry, I had been looking at some diff of Vincent's code against yours, and only saw some `return (foo,)` (and I **swear** it was more than one!1!!1 ;-) ), but in your original code, or the one that's again here now, it's of course only in the case k=1 (sum of *one* square), which is correct.\n\nSorry for the noise.",
    "created_at": "2014-05-19T19:27:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-209021",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:40 jdemeyer]:
> Replying to [comment:36 leif]:
> > P.S.:  If a solution exists, *k*`_squares()` should IMHO **always** return a *k*-tuple.
> Sure, in which case does it not do that?

Sorry, I had been looking at some diff of Vincent's code against yours, and only saw some `return (foo,)` (and I **swear** it was more than one!1!!1 ;-) ), but in your original code, or the one that's again here now, it's of course only in the case k=1 (sum of *one* square), which is correct.

Sorry for the noise.



---

archive/issue_comments_209022.json:
```json
{
    "body": "Hi,\n\nRelated to comment:12, can you justify why using pari? We already have `factor` and `is_pseudoprime` and `sqrtrem` might be the replacement for `N.sqrtint`.\n\nThere are also trailing whitespaces on the lines 5161 and 5246.\n\nVincent",
    "created_at": "2014-06-06T16:17:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-209022",
    "user": "https://github.com/videlec"
}
```

Hi,

Related to comment:12, can you justify why using pari? We already have `factor` and `is_pseudoprime` and `sqrtrem` might be the replacement for `N.sqrtint`.

There are also trailing whitespaces on the lines 5161 and 5246.

Vincent



---

archive/issue_comments_209023.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2014-06-06T16:17:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-209023",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_209024.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-06-25T09:14:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-209024",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_209025.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2014-06-25T09:15:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-209025",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_209026.json:
```json
{
    "body": "Hey,\n\nLooks cool! I added micro optimizations and random tests at `u/vdelecroix/16308`. If you like my changes, this is good for a positive review!\n\nVincent",
    "created_at": "2014-06-25T18:48:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-209026",
    "user": "https://github.com/videlec"
}
```

Hey,

Looks cool! I added micro optimizations and random tests at `u/vdelecroix/16308`. If you like my changes, this is good for a positive review!

Vincent



---

archive/issue_comments_209027.json:
```json
{
    "body": "New commits:",
    "created_at": "2014-06-25T21:41:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-209027",
    "user": "https://github.com/jdemeyer"
}
```

New commits:



---

archive/issue_comments_209028.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-06-25T21:42:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-209028",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_209029.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-06-26T19:37:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16071#issuecomment-209029",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_048065.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-06-26T19:37:47Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16071",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16071#event-48065"
}
```
