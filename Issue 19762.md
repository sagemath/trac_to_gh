# Issue 19762: infinite recursion creating certain asymptotic expansion

Issue created by migration from https://trac.sagemath.org/ticket/19999

Original creator: dkrenn

Original creation time: 2016-02-01 12:00:57

CC:  behackl cheuberg


```
sage: 1 + (-1)^x + (1/2)^x
```

gives

```
RuntimeError: maximum recursion depth exceeded in __instancecheck__
```

But

```
sage: (-1)^x + (1/2)^x + 1
1 + (-1)^x + (1/2)^x
```

works.


---

Comment by behackl created at 2016-02-01 12:35:29

It seems that there is a problem with the comparison in these cartesian products of growth groups.

This might also cause this behavior:

```
sage: (-1)^x + O(1/x)
O(x^(-1))
```



---

Comment by behackl created at 2016-02-03 10:10:14

I've tried to find the actual reason for this infinite loop. It turns out that the entire poset structure breaks down after inserting `(-1)^x`:


```
sage: ex = 1 + (-1)^x
sage: s = ex.summands; s
poset((-1)^x, 1)
sage: print s.repr_full()
poset((-1)^x, 1)
+-- (-1)^x
+-- null
+-- 1
+-- oo
```



---

Comment by behackl created at 2016-02-03 11:10:10

The problem is that, in general, `q^x` and `(-q)^x` can be compared in the sense of

```
sage: q^x <= (-q)^x and (-q)^x <= q^x
True
```


For example, the same problem occurrs here:


```
sage: print (2^x + (-2)^x).summands.repr_full()
poset((-2)^x, 2^x)
+-- (-2)^x
+-- null
+-- 2^x
+-- oo
```

|   +-- predecessors:   2^x
|   +-- successors:   2^x
|   +-- no predecessors
|   +-- successors:   2^x
|   +-- predecessors:   (-2)^x, null
|   +-- successors:   (-2)^x, oo
|   +-- predecessors:   2^x
|   +-- no successors
I see three possibilities (well, two proper ones...) to fix this. 

1. Making the (exponential growth) elements `(-q)^x` and `q^x` incomparable. (very simple)

2. The other (equally simple) option would be to check for `l <= r and r <= l` (in `le_lex` of `combinat/posets/cartesian_product.py`) after `l == r`, and then return `False` (this means that the poset sees the two elements as incomparable, when actually, they very well are comparable). This introduces inconsistencies (behavior in `QQ^x` vs. `QQ^x * x^QQ`...) and should probably not be implemented.

3. Refactoring parts of the `MutablePoset` such that it properly handles the case where some element can be the successor as well as the predecessor of another element simultanously. I'm not an expert regarding the code there, but I think that while this might be the "correct" solution, it is also the most complicated and it might also have a negative impact on the overall performance of the `AsymptoticRing` (which is, needless to say, bad).

Opinions?


---

Comment by behackl created at 2016-02-03 11:17:50

Replying to [comment:3 behackl]:
> 1. Making the (exponential growth) elements `(-q)^x` and `q^x` incomparable. (very simple)
> 
> 2. The other (equally simple) option would be to check for `l <= r and r <= l` (in `le_lex` of `combinat/posets/cartesian_product.py`) after `l == r`, and then return `False` (this means that the poset sees the two elements as incomparable, when actually, they very well are comparable). This introduces inconsistencies (behavior in `QQ^x` vs. `QQ^x * x^QQ`...) and should probably not be implemented.
> 
> 3. Refactoring parts of the `MutablePoset` such that it properly handles the case where some element can be the successor as well as the predecessor of another element simultanously. I'm not an expert regarding the code there, but I think that while this might be the "correct" solution, it is also the most complicated and it might also have a negative impact on the overall performance of the `AsymptoticRing` (which is, needless to say, bad).


For the sake of completeness: the fact that absorption does not work properly (`O(2^x)` should absorb both `2^x` and `(-2)^x`) speaks against the first option.


---

Comment by dkrenn created at 2016-02-03 12:38:43

Replying to [comment:4 behackl]:
> Replying to [comment:3 behackl]:
> > 1. Making the (exponential growth) elements `(-q)^x` and `q^x` incomparable. (very simple)

+1 for 1., since then the elements really build a poset.

> For the sake of completeness: the fact that absorption does not work properly (`O(2^x)` should absorb both `2^x` and `(-2)^x`) speaks against the first option.

It's not that nice to have both terms; however, I don't see a good way to fix this at the moment.


---

Comment by cheuberg created at 2016-02-03 12:41:20

My impressions:

- Refactoring `MutablePoset` seems to be incorrect. We should make sure to have a poset when we call it a poset.

- Having `(-q)^x` and `q^x` incomparable is inconvenient, but no tragedy. (doubles the number of `O` terms, but I do not see other side effect)


---

Comment by cheuberg created at 2016-02-03 12:41:49

(continued; trac timeout)

- Having `(-q)<= q^x` would be fine, but not in the context of a cartesian product where the order would no longer be lexicographic (we'd need to compare |q|, k, sign(q) lexicographically for terms `q^n n^k`)

- Forbidding negative bases in exponential growth groups. `(-q)^n` can be modeled by `q^n alpha` where alpha is a root of `alpha^2-1`, so the coefficient ring is `ZZ[alpha]/(alpha^2-1).` Inconvenient, but correct.


---

Comment by behackl created at 2016-02-03 12:58:16

Changing status from new to needs_review.


---

Comment by behackl created at 2016-02-03 12:58:16

I forgot that the proposed refactoring of `MutablePoset` would result in a structure that does not resemble a poset any more; thanks for the hint.

Therefore, as the resulting increased number of required `O`-terms is just inconvenient I've implemented option 1.
----
New commits:


---

Comment by dkrenn created at 2016-02-03 13:15:32

Replying to [comment:8 behackl]:
> ||[4f3c707](http://git.sagemath.org/sage.git/commit/?id=4f3c7072d66a3788b1fb06484c9cf70d92c19c57)||`fix lexicographically ordered cartesian products`||

Can you add a doctest there?


---

Comment by dkrenn created at 2016-02-03 13:19:45

Replying to [comment:8 behackl]:
> ||[c023a81](http://git.sagemath.org/sage.git/commit/?id=c023a81fc39966b870d467382a66dab94d1d52b0)||`let (-q)^x and q^x be incomparable`||

I believe the `-other.base` in

```
return bool(abs(self.base) <= abs(other.base)) and \
       bool(self.base != -other.base)
```

is not general enough (you could have complex bases as well).
Why not

```
bool(abs(self.base) < abs(other.base)) or bool(self.base == other.base)
```

?


---

Comment by behackl created at 2016-02-03 22:58:19

Replying to [comment:10 dkrenn]:
> Replying to [comment:8 behackl]:
> > ||[c023a81](http://git.sagemath.org/sage.git/commit/?id=c023a81fc39966b870d467382a66dab94d1d52b0)||`let (-q)^x and q^x be incomparable`||
> 
> I believe the `-other.base` in
> {{{
> return bool(abs(self.base) <= abs(other.base)) and \
>        bool(self.base != -other.base)
> }}}
> is not general enough (you could have complex bases as well).
> Why not
> {{{
> bool(abs(self.base) < abs(other.base)) or bool(self.base == other.base)
> }}}
> ?

Yep, I was thinking of reals a bit too much; I'll change the statement.


---

Comment by git created at 2016-02-03 22:58:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cheuberg created at 2016-02-04 16:46:18

LGTM.


---

Comment by cheuberg created at 2016-02-04 16:46:18

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-02-05 19:30:03

Resolution: fixed
