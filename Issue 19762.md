# Issue 19762: infinite recursion creating certain asymptotic expansion

archive/issues_019762.json:
```json
{
    "body": "CC:  @behackl @cheuberg\n\n\n```\nsage: 1 + (-1)^x + (1/2)^x\n```\n\ngives\n\n```\nRuntimeError: maximum recursion depth exceeded in __instancecheck__\n```\n\nBut\n\n```\nsage: (-1)^x + (1/2)^x + 1\n1 + (-1)^x + (1/2)^x\n```\n\nworks.\n\nIssue created by migration from https://trac.sagemath.org/ticket/19999\n\n",
    "created_at": "2016-02-01T12:00:57Z",
    "labels": [
        "component: asymptotic expansions",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.1",
    "title": "infinite recursion creating certain asymptotic expansion",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19762",
    "user": "https://github.com/dkrenn"
}
```
CC:  @behackl @cheuberg


```
sage: 1 + (-1)^x + (1/2)^x
```

gives

```
RuntimeError: maximum recursion depth exceeded in __instancecheck__
```

But

```
sage: (-1)^x + (1/2)^x + 1
1 + (-1)^x + (1/2)^x
```

works.

Issue created by migration from https://trac.sagemath.org/ticket/19999





---

archive/issue_comments_271299.json:
```json
{
    "body": "It seems that there is a problem with the comparison in these cartesian products of growth groups.\n\nThis might also cause this behavior:\n\n```\nsage: (-1)^x + O(1/x)\nO(x^(-1))\n```\n",
    "created_at": "2016-02-01T12:35:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19762#issuecomment-271299",
    "user": "https://github.com/behackl"
}
```

It seems that there is a problem with the comparison in these cartesian products of growth groups.

This might also cause this behavior:

```
sage: (-1)^x + O(1/x)
O(x^(-1))
```




---

archive/issue_comments_271300.json:
```json
{
    "body": "I've tried to find the actual reason for this infinite loop. It turns out that the entire poset structure breaks down after inserting `(-1)^x`:\n\n\n```\nsage: ex = 1 + (-1)^x\nsage: s = ex.summands; s\nposet((-1)^x, 1)\nsage: print s.repr_full()\nposet((-1)^x, 1)\n+-- (-1)^x\n+-- null\n+-- 1\n+-- oo\n```\n",
    "created_at": "2016-02-03T10:10:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19762#issuecomment-271300",
    "user": "https://github.com/behackl"
}
```

I've tried to find the actual reason for this infinite loop. It turns out that the entire poset structure breaks down after inserting `(-1)^x`:


```
sage: ex = 1 + (-1)^x
sage: s = ex.summands; s
poset((-1)^x, 1)
sage: print s.repr_full()
poset((-1)^x, 1)
+-- (-1)^x
+-- null
+-- 1
+-- oo
```




---

archive/issue_comments_271301.json:
```json
{
    "body": "The problem is that, in general, `q^x` and `(-q)^x` can be compared in the sense of\n\n```\nsage: q^x <= (-q)^x and (-q)^x <= q^x\nTrue\n```\n\n\nFor example, the same problem occurrs here:\n\n\n```\nsage: print (2^x + (-2)^x).summands.repr_full()\nposet((-2)^x, 2^x)\n+-- (-2)^x\n+-- null\n+-- 2^x\n+-- oo\n```\n\n|   +-- predecessors:   2^x\n|   +-- successors:   2^x\n|   +-- no predecessors\n|   +-- successors:   2^x\n|   +-- predecessors:   (-2)^x, null\n|   +-- successors:   (-2)^x, oo\n|   +-- predecessors:   2^x\n|   +-- no successors\nI see three possibilities (well, two proper ones...) to fix this. \n\n1. Making the (exponential growth) elements `(-q)^x` and `q^x` incomparable. (very simple)\n\n2. The other (equally simple) option would be to check for `l <= r and r <= l` (in `le_lex` of `combinat/posets/cartesian_product.py`) after `l == r`, and then return `False` (this means that the poset sees the two elements as incomparable, when actually, they very well are comparable). This introduces inconsistencies (behavior in `QQ^x` vs. `QQ^x * x^QQ`...) and should probably not be implemented.\n\n3. Refactoring parts of the `MutablePoset` such that it properly handles the case where some element can be the successor as well as the predecessor of another element simultanously. I'm not an expert regarding the code there, but I think that while this might be the \"correct\" solution, it is also the most complicated and it might also have a negative impact on the overall performance of the `AsymptoticRing` (which is, needless to say, bad).\n\nOpinions?",
    "created_at": "2016-02-03T11:10:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19762#issuecomment-271301",
    "user": "https://github.com/behackl"
}
```

The problem is that, in general, `q^x` and `(-q)^x` can be compared in the sense of

```
sage: q^x <= (-q)^x and (-q)^x <= q^x
True
```


For example, the same problem occurrs here:


```
sage: print (2^x + (-2)^x).summands.repr_full()
poset((-2)^x, 2^x)
+-- (-2)^x
+-- null
+-- 2^x
+-- oo
```

|   +-- predecessors:   2^x
|   +-- successors:   2^x
|   +-- no predecessors
|   +-- successors:   2^x
|   +-- predecessors:   (-2)^x, null
|   +-- successors:   (-2)^x, oo
|   +-- predecessors:   2^x
|   +-- no successors
I see three possibilities (well, two proper ones...) to fix this. 

1. Making the (exponential growth) elements `(-q)^x` and `q^x` incomparable. (very simple)

2. The other (equally simple) option would be to check for `l <= r and r <= l` (in `le_lex` of `combinat/posets/cartesian_product.py`) after `l == r`, and then return `False` (this means that the poset sees the two elements as incomparable, when actually, they very well are comparable). This introduces inconsistencies (behavior in `QQ^x` vs. `QQ^x * x^QQ`...) and should probably not be implemented.

3. Refactoring parts of the `MutablePoset` such that it properly handles the case where some element can be the successor as well as the predecessor of another element simultanously. I'm not an expert regarding the code there, but I think that while this might be the "correct" solution, it is also the most complicated and it might also have a negative impact on the overall performance of the `AsymptoticRing` (which is, needless to say, bad).

Opinions?



---

archive/issue_comments_271302.json:
```json
{
    "body": "Replying to [comment:3 behackl]:\n> 1. Making the (exponential growth) elements `(-q)^x` and `q^x` incomparable. (very simple)\n> \n> 2. The other (equally simple) option would be to check for `l <= r and r <= l` (in `le_lex` of `combinat/posets/cartesian_product.py`) after `l == r`, and then return `False` (this means that the poset sees the two elements as incomparable, when actually, they very well are comparable). This introduces inconsistencies (behavior in `QQ^x` vs. `QQ^x * x^QQ`...) and should probably not be implemented.\n> \n> 3. Refactoring parts of the `MutablePoset` such that it properly handles the case where some element can be the successor as well as the predecessor of another element simultanously. I'm not an expert regarding the code there, but I think that while this might be the \"correct\" solution, it is also the most complicated and it might also have a negative impact on the overall performance of the `AsymptoticRing` (which is, needless to say, bad).\n\n\nFor the sake of completeness: the fact that absorption does not work properly (`O(2^x)` should absorb both `2^x` and `(-2)^x`) speaks against the first option.",
    "created_at": "2016-02-03T11:17:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19762#issuecomment-271302",
    "user": "https://github.com/behackl"
}
```

Replying to [comment:3 behackl]:
> 1. Making the (exponential growth) elements `(-q)^x` and `q^x` incomparable. (very simple)
> 
> 2. The other (equally simple) option would be to check for `l <= r and r <= l` (in `le_lex` of `combinat/posets/cartesian_product.py`) after `l == r`, and then return `False` (this means that the poset sees the two elements as incomparable, when actually, they very well are comparable). This introduces inconsistencies (behavior in `QQ^x` vs. `QQ^x * x^QQ`...) and should probably not be implemented.
> 
> 3. Refactoring parts of the `MutablePoset` such that it properly handles the case where some element can be the successor as well as the predecessor of another element simultanously. I'm not an expert regarding the code there, but I think that while this might be the "correct" solution, it is also the most complicated and it might also have a negative impact on the overall performance of the `AsymptoticRing` (which is, needless to say, bad).


For the sake of completeness: the fact that absorption does not work properly (`O(2^x)` should absorb both `2^x` and `(-2)^x`) speaks against the first option.



---

archive/issue_comments_271303.json:
```json
{
    "body": "Replying to [comment:4 behackl]:\n> Replying to [comment:3 behackl]:\n> > 1. Making the (exponential growth) elements `(-q)^x` and `q^x` incomparable. (very simple)\n\n+1 for 1., since then the elements really build a poset.\n\n> For the sake of completeness: the fact that absorption does not work properly (`O(2^x)` should absorb both `2^x` and `(-2)^x`) speaks against the first option.\n\nIt's not that nice to have both terms; however, I don't see a good way to fix this at the moment.",
    "created_at": "2016-02-03T12:38:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19762#issuecomment-271303",
    "user": "https://github.com/dkrenn"
}
```

Replying to [comment:4 behackl]:
> Replying to [comment:3 behackl]:
> > 1. Making the (exponential growth) elements `(-q)^x` and `q^x` incomparable. (very simple)

+1 for 1., since then the elements really build a poset.

> For the sake of completeness: the fact that absorption does not work properly (`O(2^x)` should absorb both `2^x` and `(-2)^x`) speaks against the first option.

It's not that nice to have both terms; however, I don't see a good way to fix this at the moment.



---

archive/issue_comments_271304.json:
```json
{
    "body": "My impressions:\n\n- Refactoring `MutablePoset` seems to be incorrect. We should make sure to have a poset when we call it a poset.\n\n- Having `(-q)^x` and `q^x` incomparable is inconvenient, but no tragedy. (doubles the number of `O` terms, but I do not see other side effect)",
    "created_at": "2016-02-03T12:41:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19762#issuecomment-271304",
    "user": "https://github.com/cheuberg"
}
```

My impressions:

- Refactoring `MutablePoset` seems to be incorrect. We should make sure to have a poset when we call it a poset.

- Having `(-q)^x` and `q^x` incomparable is inconvenient, but no tragedy. (doubles the number of `O` terms, but I do not see other side effect)



---

archive/issue_comments_271305.json:
```json
{
    "body": "(continued; trac timeout)\n\n- Having `(-q)<= q^x` would be fine, but not in the context of a cartesian product where the order would no longer be lexicographic (we'd need to compare |q|, k, sign(q) lexicographically for terms `q^n n^k`)\n\n- Forbidding negative bases in exponential growth groups. `(-q)^n` can be modeled by `q^n alpha` where alpha is a root of `alpha^2-1`, so the coefficient ring is `ZZ[alpha]/(alpha^2-1).` Inconvenient, but correct.",
    "created_at": "2016-02-03T12:41:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19762#issuecomment-271305",
    "user": "https://github.com/cheuberg"
}
```

(continued; trac timeout)

- Having `(-q)<= q^x` would be fine, but not in the context of a cartesian product where the order would no longer be lexicographic (we'd need to compare |q|, k, sign(q) lexicographically for terms `q^n n^k`)

- Forbidding negative bases in exponential growth groups. `(-q)^n` can be modeled by `q^n alpha` where alpha is a root of `alpha^2-1`, so the coefficient ring is `ZZ[alpha]/(alpha^2-1).` Inconvenient, but correct.



---

archive/issue_comments_271306.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-02-03T12:58:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19762#issuecomment-271306",
    "user": "https://github.com/behackl"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_271307.json:
```json
{
    "body": "I forgot that the proposed refactoring of `MutablePoset` would result in a structure that does not resemble a poset any more; thanks for the hint.\n\nTherefore, as the resulting increased number of required `O`-terms is just inconvenient I've implemented option 1.\n----\nNew commits:",
    "created_at": "2016-02-03T12:58:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19762#issuecomment-271307",
    "user": "https://github.com/behackl"
}
```

I forgot that the proposed refactoring of `MutablePoset` would result in a structure that does not resemble a poset any more; thanks for the hint.

Therefore, as the resulting increased number of required `O`-terms is just inconvenient I've implemented option 1.
----
New commits:



---

archive/issue_comments_271308.json:
```json
{
    "body": "Replying to [comment:8 behackl]:\n> ||[4f3c707](http://git.sagemath.org/sage.git/commit/?id=4f3c7072d66a3788b1fb06484c9cf70d92c19c57)||`fix lexicographically ordered cartesian products`||\n\nCan you add a doctest there?",
    "created_at": "2016-02-03T13:15:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19762#issuecomment-271308",
    "user": "https://github.com/dkrenn"
}
```

Replying to [comment:8 behackl]:
> ||[4f3c707](http://git.sagemath.org/sage.git/commit/?id=4f3c7072d66a3788b1fb06484c9cf70d92c19c57)||`fix lexicographically ordered cartesian products`||

Can you add a doctest there?



---

archive/issue_comments_271309.json:
```json
{
    "body": "Replying to [comment:8 behackl]:\n> ||[c023a81](http://git.sagemath.org/sage.git/commit/?id=c023a81fc39966b870d467382a66dab94d1d52b0)||`let (-q)^x and q^x be incomparable`||\n\nI believe the `-other.base` in\n\n```\nreturn bool(abs(self.base) <= abs(other.base)) and \\\n       bool(self.base != -other.base)\n```\n\nis not general enough (you could have complex bases as well).\nWhy not\n\n```\nbool(abs(self.base) < abs(other.base)) or bool(self.base == other.base)\n```\n\n?",
    "created_at": "2016-02-03T13:19:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19762#issuecomment-271309",
    "user": "https://github.com/dkrenn"
}
```

Replying to [comment:8 behackl]:
> ||[c023a81](http://git.sagemath.org/sage.git/commit/?id=c023a81fc39966b870d467382a66dab94d1d52b0)||`let (-q)^x and q^x be incomparable`||

I believe the `-other.base` in

```
return bool(abs(self.base) <= abs(other.base)) and \
       bool(self.base != -other.base)
```

is not general enough (you could have complex bases as well).
Why not

```
bool(abs(self.base) < abs(other.base)) or bool(self.base == other.base)
```

?



---

archive/issue_comments_271310.json:
```json
{
    "body": "Replying to [comment:10 dkrenn]:\n> Replying to [comment:8 behackl]:\n> > ||[c023a81](http://git.sagemath.org/sage.git/commit/?id=c023a81fc39966b870d467382a66dab94d1d52b0)||`let (-q)^x and q^x be incomparable`||\n> \n> I believe the `-other.base` in\n> {{{\n> return bool(abs(self.base) <= abs(other.base)) and \\\n>        bool(self.base != -other.base)\n> }}}\n> is not general enough (you could have complex bases as well).\n> Why not\n> {{{\n> bool(abs(self.base) < abs(other.base)) or bool(self.base == other.base)\n> }}}\n> ?\n\nYep, I was thinking of reals a bit too much; I'll change the statement.",
    "created_at": "2016-02-03T22:58:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19762#issuecomment-271310",
    "user": "https://github.com/behackl"
}
```

Replying to [comment:10 dkrenn]:
> Replying to [comment:8 behackl]:
> > ||[c023a81](http://git.sagemath.org/sage.git/commit/?id=c023a81fc39966b870d467382a66dab94d1d52b0)||`let (-q)^x and q^x be incomparable`||
> 
> I believe the `-other.base` in
> {{{
> return bool(abs(self.base) <= abs(other.base)) and \
>        bool(self.base != -other.base)
> }}}
> is not general enough (you could have complex bases as well).
> Why not
> {{{
> bool(abs(self.base) < abs(other.base)) or bool(self.base == other.base)
> }}}
> ?

Yep, I was thinking of reals a bit too much; I'll change the statement.



---

archive/issue_comments_271311.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-02-03T22:58:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19762#issuecomment-271311",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_271312.json:
```json
{
    "body": "LGTM.",
    "created_at": "2016-02-04T16:46:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19762#issuecomment-271312",
    "user": "https://github.com/cheuberg"
}
```

LGTM.



---

archive/issue_comments_271313.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-02-04T16:46:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19762#issuecomment-271313",
    "user": "https://github.com/cheuberg"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_271314.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-02-05T19:30:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19762#issuecomment-271314",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_018813.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2016-02-05T19:30:03Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/19762",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19762#event-18813"
}
```
