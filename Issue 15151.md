# Issue 15151: log of NaN in RealField and ComplexField results in infinite loop

Issue created by migration from https://trac.sagemath.org/ticket/15388

Original creator: paulfili

Original creation time: 2013-11-09 15:46:09

Assignee: Paul Fili

CC:  atowsley

Keywords: sage-days55

If you have a RealField or ComplexField NaN value and attempt to compute log, the fact that NaN is considered < 0 results in RealField.log calling ComplexField.log, but then ComplexField.log calls RealField.log again, but again on the values NaN for the absolute value. This results in an infinite loop. Example code for the code: 

x = RealField()(NaN)
x.log() # Results in infinite loop

This patch fixes the log function in RealField and ComplexField to return NaN if fed a number which is NaN (in either the real or the imaginary coordinate). 


---

Comment by paulfili created at 2013-11-09 16:26:03

Changing status from new to needs_review.


---

Comment by paulfili created at 2013-11-09 16:37:17

Changing component from PLEASE CHANGE to numerical.


---

Comment by bhutz created at 2013-11-10 00:42:07

A couple things

1) the patch needs a commit message

2) the patch name should be trac_15388_<description>.patch

3) Please add a doctest to each log function to demonstrate the fix

4) lines 2063, 2064 which are commented out look like they can just be removed as they add no value to the code


---

Comment by bhutz created at 2013-11-10 00:42:07

Changing status from needs_review to needs_work.


---

Comment by bhutz created at 2013-11-10 02:20:52

long doctest looks fine with this, so I'm happy with the code change, just make the minor changes suggested above.

Just to note, I had a few unrelated longtest failures on 5.12 that failed both with and without the patch.


```
sage -t --long /home/bhutz/sage/sage-5.12/devel/sage/sage/tests/cmdline.py  # 11 doctests failed
sage -t --long /home/bhutz/sage/sage-5.12/devel/sage/sage/calculus/desolvers.py  # 8 doctests failed
sage -t --long /home/bhutz/sage/sage-5.12/devel/sage/doc/en/constructions/calculus.rst  # 4 doctests failed
sage -t --long /home/bhutz/sage/sage-5.12/devel/sage/doc/en/prep/Quickstarts/Differential-Equations.rst  # 2 doctests failed
sage -t --long /home/bhutz/sage/sage-5.12/devel/sage/sage/misc/interpreter.py  # 1 doctest failed
sage -t --long /home/bhutz/sage/sage-5.12/devel/sage/sage/misc/trace.py  # 2 doctests failed
sage -t --long /home/bhutz/sage/sage-5.12/devel/sage/sage/tests/interrupt.pyx  # Time out
```



---

Comment by paulfili created at 2013-11-10 15:31:48

It is probably best not to have an example involving NaN in the log's documentation, as it is such a basic function and this case is rather exceptional. (Although we still want it to work in case a log appears in someone's code after an NaN has already appeared, as happened to us when we found this bug.)


---

Comment by paulfili created at 2013-11-10 15:34:32

We have made the changes Ben suggested, except for adding a doctest, which seems undesirable as noted above.


---

Comment by paulfili created at 2013-11-10 15:36:58

Changing status from needs_work to needs_review.


---

Comment by bhutz created at 2013-11-10 16:41:32

This looks good.


---

Comment by bhutz created at 2013-11-10 16:41:32

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-11-10 22:50:25

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-11-10 22:50:25

Replying to [comment:7 paulfili]:
> Although we still want it to work in case a log appears in someone's code after an NaN has already appeared, as happened to us when we found this bug.
Which is exactly why a doctest is needed.


---

Comment by paulfili created at 2013-11-12 00:36:49

I have added a doctest that explains the behavior for NaN.


---

Comment by paulfili created at 2013-11-12 00:36:49

Changing status from needs_work to needs_review.


---

Comment by bhutz created at 2013-11-12 01:36:20

Changing status from needs_review to positive_review.


---

Comment by bhutz created at 2013-11-12 01:36:20

Ok. This still looks fine and now we have the doctests.


---

Comment by jdemeyer created at 2013-11-12 07:27:38

You should add a meaningful commit message (use `hg qrefresh -e` for that)


---

Comment by jdemeyer created at 2013-11-12 07:27:38

Changing status from positive_review to needs_work.


---

Comment by paulfili created at 2013-11-12 16:05:55

Fixes the behavior of log(NaN) in real and complex fields


---

Attachment

Commit message has been added.


---

Comment by paulfili created at 2013-11-12 16:06:19

Changing status from needs_work to needs_review.


---

Comment by bhutz created at 2013-11-13 12:19:23

Changing status from needs_review to positive_review.


---

Comment by bhutz created at 2013-11-13 12:19:23

ok. still looks good, but with a commit message this time.


---

Comment by jdemeyer created at 2013-11-14 07:54:21

Resolution: fixed
