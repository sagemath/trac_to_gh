# Issue 17422: make symbolic series subclass of Expression

Issue created by migration from Trac.

Original creator: rws

Original creation time: 2015-01-22 14:54:03

Making `Expression.series` create `SymbolicSeries` (a subclass of `Expression`) and moving the series code into a separate file `series.pyx` 
* reflects the fact that expressions and series don't commute
* allows upcoming fixes that don't clutter `Expression` methods with `if ex.is_a_series():`
* makes for better documentation via having a `Symbolic Series` ref man page


---

Comment by rws created at 2015-01-22 14:57:35

Changing status from new to needs_review.


---

Comment by rws created at 2015-01-22 14:57:35

New commits:


---

Comment by nbruin created at 2015-01-22 20:56:33

I have nothing invested in how symbolics and series interact, but I see some immediate problems that would arise from subclassing Expression for a Series type:
 - when does a SymbolicSeries expression get created? The problem is that the SymbolicRing by itself is a rather untyped environment, so how do you know that an object needs to be made in this specialized class
 - How do SymbolicSeries in different variables interact, e.g.:

```
F = (1/(x+1))*y+sin(x)*y^2+O(y^3)
G = (y/(y^2-2)*x + cos(y)*x^2 +O(x^3)
F+G
```

Is the result a series? If so, in which variable(s)? One solution would be a SymbolicSeriesRing as a parent, which declares in what variables the series are. I suspect this would be nearly useless for whatever problem the current design tries to solve, though.


---

Comment by rws created at 2015-01-23 06:44:48

Nils, this is not about creating a ring but simple refactoring. No behaviour change.

http://www.refactoring.com/catalog/replaceConditionalWithPolymorphism.html

Replying to [comment:3 nbruin]:
> I have nothing invested in how symbolics and series interact, but I see some immediate problems that would arise from subclassing Expression for a Series type:
These problems already exist, so nothing is new.


---

Comment by git created at 2015-01-23 08:10:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nbruin created at 2015-01-23 20:43:31

OK, I thought that `f.is_series()` would do some non-trivial logic to see if `f` can be used as a series, but it's just exposing a flag that is held internally somewhere. You could indeed expose that information in the type instead, but with ducktyping, subtyping and sage's parent infrastructure doing so might not be as convenient as it might be in systems that are really governed by explicit types. You'd need to think if this refactoring actually will help for further development.

Indeed, being a "series" seems a rather fickle property. It doesn't seem to be preserved under anything:


```
sage: var('x,y');
sage: f=cos(y).series(y,10)
sage: g=sin(x).series(x,10)
sage: var('x,y');
sage: f=cos(y).series(y,10)
sage: g=sin(x).series(x,10)
sage: f.is_series()
True
sage: (f+f).is_series()
False
sage: (-f).is_series()
False
sage: (f+g).series(x,10)
Order(1)
```

The last result probably follows from interpreting the `Order(x^10)` term in `g` as an order term in `y`, and hence equivalent to `Order(y^0)`.


---

Comment by rws created at 2015-01-24 07:22:29

Replying to [comment:8 nbruin]:
> You'd need to think if this refactoring actually will help for further development.
It isolates the code and the documentation.
> Indeed, being a "series" seems a rather fickle property. It doesn't seem to be preserved under anything:
There are functions in `pynac-0.3.2/ginac/pseries.cpp` to compare, add, multiply (also with constant), power (to constant). My plan is to only provide conversion to and from `PowerSeries` (#10846, #16203, #17402) and fix the worst bugs (#17400, #16213) and that's it. I'd rather improve `PowerSeries` but symbolic is what people use.


---

Comment by git created at 2015-01-25 15:09:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-01-25 16:24:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-03-05 14:16:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2015-03-30 07:21:01

There is a spurious unreprodcible doctest failure in the 6.6beta2 pachbot run.


---

Comment by git created at 2015-04-20 15:09:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2015-04-20 15:48:01

This now uncovers a regression of #12255 which was not really fixed.

```
File "src/sage/symbolic/expression.pyx", line 5279, in sage.symbolic.expression.Expression.coefficients
Failed example:
    f.coefficients(g)
Exception raised:
    ValueError: The name "g(t)" is not a valid Python identifier.
```

I will now let this ticket (and with it its dependencies) lie in limbo because, as a posting on sage-devel showed, there is no interest in symbolic series.


---

Comment by rws created at 2015-04-20 15:48:01

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-06-18 06:05:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2015-06-18 06:06:17

Changing status from needs_work to needs_review.


---

Comment by git created at 2015-06-18 14:05:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-11-28 13:45:38

Hello,

The ticket looks good.

1. Why do you need all these include

```
include "sage/ext/interrupt.pxi"
include "sage/ext/stdsage.pxi"
include "sage/ext/cdefs.pxi"
include "sage/ext/python.pxi"
```

  As far as I saw you are using none of them.

2. You should fix your mind

```
... about 0, about `1` ...
```

   Either ``0`` and ``1`` or `0` and `1`.

3. In the example, instead of `float(expr)` could you use `numerical_approx(expr)`?

4. You should not put `self` as an argument of a method (you did it in `truncate`). Moreover, it is better to avoid `self` in the documentation. Always prefer `this expression` or `this object`.

5. In `coefficients`, the argument `sparse` is not documented in the `INPUT` section

6. In `coefficients`, you should replace `if sparse is True` by `if sparse`.


---

Comment by vdelecroix created at 2015-11-28 13:45:38

Changing status from needs_review to needs_work.


---

Comment by rws created at 2015-11-28 16:47:22

Changing status from needs_work to needs_review.


---

Comment by rws created at 2015-11-28 16:47:22

Thanks for looking at this.
----
New commits:


---

Comment by vdelecroix created at 2015-11-28 16:51:46

Is the method `is_series` really usefull?


---

Comment by rws created at 2015-11-29 07:13:44

Replying to [comment:25 vdelecroix]:
> Is the method `is_series` really usefull?
Series are still expressions. How would you know a symbol holding a specific expression holds a series?


---

Comment by git created at 2015-11-29 07:18:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-11-29 12:24:08

Replying to [comment:26 rws]:
> Replying to [comment:25 vdelecroix]:
> > Is the method `is_series` really usefull?
> Series are still expressions. How would you know a symbol holding a specific expression holds a series?

`instance(my_object, SymbolicSeries)`?


---

Comment by git created at 2015-11-30 07:36:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2015-11-30 07:38:43

Indeed. Anything else?


---

Comment by vdelecroix created at 2015-11-30 09:12:31

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2015-11-30 09:12:31

Replying to [comment:30 rws]:
> Indeed. Anything else?

Yes: you are not allowed to remove a public function without (one year) deprecation with an error message that indicates the new procedure: http://doc.sagemath.org/html/en/developer/coding_in_python.html#deprecation


---

Comment by git created at 2015-11-30 14:36:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2015-11-30 14:37:12

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2015-11-30 14:43:16

Isn't it dangerous to expose globally `SymbolicSeries`? If people don't know about classes they do not want to see it. And if they do, they know how to import modules. You can just be explicit in the deprecation message

```
isinstance(my_expr, sage.symbolic.series.SymbolicSeries)
```


(I would also hide `Expression` from the global namespace but this does not concern this ticket.)


---

Comment by git created at 2015-11-30 16:38:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-11-30 18:15:05

Good for me.


---

Comment by vdelecroix created at 2015-11-30 18:15:05

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-12-01 08:33:50

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2015-12-01 08:33:50


```
sage -t --long src/sage/symbolic/series.pyx
**********************************************************************
File "src/sage/symbolic/series.pyx", line 71, in sage.symbolic.series
Failed example:
    x*ex1
Expected:
    (1*x + (-1/6)*x^3 + Order(x^4))*x
Got:
    x*(1*x + (-1/6)*x^3 + Order(x^4))
**********************************************************************
1 item had failures:
   1 of  23 in sage.symbolic.series
    [42 tests, 1 failure, 0.04 s]
```



---

Comment by rws created at 2015-12-01 09:47:57

That happens in 6 out of 10 attempts here. Bummer.


---

Comment by rws created at 2015-12-01 15:45:24

For the record, only when doctesting and in different processes does it fail often enough to be noticed (regardless of if testing in parallel or not). When not leaving the Sage process the results seem always the same. One possbility would be therefore an uninitialized variable in Pynac affecting the result depending on what's in the memory at Sage start.


---

Comment by vbraun created at 2015-12-01 15:54:20

Might also depend on Python memory locations (are the underlying ginac objects cached or not?). If its an uninitialized pynac variable then valgrind should find it.


---

Comment by rws created at 2015-12-01 16:02:11

I would have found it if it were in the upcoming pynac-0.5.2 because I used valgrind extensively there. So it might just disappear with #19312.


---

Comment by rws created at 2016-01-11 16:47:53

Okay, for some reason printing order here is according to hash value, and hash values of symbols are not preserved over different processes. Putting `sage: hash(x)` in an arbitrary doctest and testing multiple times shows this clearly, also in Sage-6.6. It's just that such series manipulations produced an error until recently, so the differences over time couldn't be observed.


---

Comment by rws created at 2016-01-12 09:13:40

See https://github.com/pynac/pynac/issues/22

This is now fixed in pynac and depends on the upgrade to pynac-0.6.1.


---

Comment by rws created at 2016-01-24 07:26:49

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2016-01-28 08:01:55

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2016-01-28 08:01:55


```
sage -t --long src/sage/symbolic/series.pyx
**********************************************************************
File "src/sage/symbolic/series.pyx", line 71, in sage.symbolic.series
Failed example:
    x*ex1
Expected:
    (1*x + (-1/6)*x^3 + Order(x^4))*x
Got:
    x*(1*x + (-1/6)*x^3 + Order(x^4))
**********************************************************************
1 item had failures:
   1 of  23 in sage.symbolic.series
    [42 tests, 1 failure, 0.04 s]
```



---

Comment by rws created at 2016-01-28 09:00:05

Beware the dependency!


---

Comment by rws created at 2016-01-29 07:18:23

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2016-01-29 13:08:06

Patchbot also shows failure


---

Comment by vbraun created at 2016-01-29 13:08:06

Changing status from needs_review to needs_work.


---

Comment by rws created at 2016-01-29 13:29:22

Yes, a remainder from the time before #19948.
----
New commits:


---

Comment by rws created at 2016-01-29 13:29:22

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2016-01-29 13:33:38

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2016-01-29 20:33:27

Ralf, did you intend for this to wait to 7.2 or did you mean 7.1?


---

Comment by vbraun created at 2016-01-30 00:11:07

Resolution: fixed
