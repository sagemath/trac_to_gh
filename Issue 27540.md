# Issue 27540: Py3: Fix combinat.set_partition doctests

archive/issues_027540.json:
```json
{
    "body": "Fix combinat.set_partition doctests for python.\n\nIssue created by migration from https://trac.sagemath.org/ticket/27777\n\n",
    "created_at": "2019-05-06T08:26:04Z",
    "labels": [
        "python3",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "Py3: Fix combinat.set_partition doctests",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27540",
    "user": "@vinklein"
}
```
Fix combinat.set_partition doctests for python.

Issue created by migration from https://trac.sagemath.org/ticket/27777





---

archive/issue_comments_388563.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-05-06T08:35:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27540#issuecomment-388563",
    "user": "@vinklein"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_388564.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-05-06T08:35:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27540#issuecomment-388564",
    "user": "@vinklein"
}
```

New commits:



---

archive/issue_comments_388565.json:
```json
{
    "body": "This change worries me:\n\n```diff\n-            sage: SetPartitions([\"a\", \"b\", \"c\"], [2,1]).list()\n-            [{{'a'}, {'b', 'c'}}, {{'a', 'c'}, {'b'}}, {{'a', 'b'}, {'c'}}]\n+            sage: sorted(SetPartitions([\"a\", \"b\", \"c\"], [2,1]), key=str)\n+            [{{'a', 'b'}, {'c'}}, {{'a', 'c'}, {'b'}}, {{'a'}, {'b', 'c'}}]\n```\n\nas the enumeration of set partitions should be constant. Maybe something is slightly different in the algorithm, but this needs a closer examination (that I do not have time for tonight).",
    "created_at": "2019-05-08T08:47:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27540#issuecomment-388565",
    "user": "@tscrim"
}
```

This change worries me:

```diff
-            sage: SetPartitions(["a", "b", "c"], [2,1]).list()
-            [{{'a'}, {'b', 'c'}}, {{'a', 'c'}, {'b'}}, {{'a', 'b'}, {'c'}}]
+            sage: sorted(SetPartitions(["a", "b", "c"], [2,1]), key=str)
+            [{{'a', 'b'}, {'c'}}, {{'a', 'c'}, {'b'}}, {{'a'}, {'b', 'c'}}]
```

as the enumeration of set partitions should be constant. Maybe something is slightly different in the algorithm, but this needs a closer examination (that I do not have time for tonight).



---

archive/issue_comments_388566.json:
```json
{
    "body": "Okay, so the issue should be in enumerating the linear extensions of a poset. I am not sure what to do about that, but I think we should not sort the output here as it is just a symptom of an underlying issue.\n\nI am also getting a failure in the `_latex_` method, but that also should not happen. My guess is the underlying (frozen)sets are not ordered the same way, which falls out from applying the `str`.",
    "created_at": "2019-05-09T03:36:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27540#issuecomment-388566",
    "user": "@tscrim"
}
```

Okay, so the issue should be in enumerating the linear extensions of a poset. I am not sure what to do about that, but I think we should not sort the output here as it is just a symptom of an underlying issue.

I am also getting a failure in the `_latex_` method, but that also should not happen. My guess is the underlying (frozen)sets are not ordered the same way, which falls out from applying the `str`.



---

archive/issue_comments_388567.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-05-09T03:36:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27540#issuecomment-388567",
    "user": "@tscrim"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_388568.json:
```json
{
    "body": "In this case it looks like the difference of order depend on that :\\\\\n\npy2\n\n```\nsage: sp = SetPartitions([\"a\", \"b\", \"c\"], [2,1])\nsage: sp._set\nfrozenset({'a', 'b', 'c'})\nsage: list(sp._set)\n['a', 'c', 'b']\n```\n\n\npy3\n\n```\nsage: sp = SetPartitions([\"a\", \"b\", \"c\"], [2,1])\nsage: sp._set\nfrozenset({'a', 'b', 'c'})\nsage: list(sp._set)\n['a', 'b', 'c']\n```\n\n\nThe position of elements of `list(sp._set)` is used for generating `SetPartitions_setparts.__iter__` results.\n\nEnumerating the linear extensions give me the same orders in py2 and py3: \n\n```\nsage: P = sp._set_partition_poset()\nsage: [e for e in P.linear_extensions()]\n[[0, 1, 2], [1, 2, 0], [1, 0, 2]]\n```\n",
    "created_at": "2019-05-21T15:47:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27540#issuecomment-388568",
    "user": "@vinklein"
}
```

In this case it looks like the difference of order depend on that :\\

py2

```
sage: sp = SetPartitions(["a", "b", "c"], [2,1])
sage: sp._set
frozenset({'a', 'b', 'c'})
sage: list(sp._set)
['a', 'c', 'b']
```


py3

```
sage: sp = SetPartitions(["a", "b", "c"], [2,1])
sage: sp._set
frozenset({'a', 'b', 'c'})
sage: list(sp._set)
['a', 'b', 'c']
```


The position of elements of `list(sp._set)` is used for generating `SetPartitions_setparts.__iter__` results.

Enumerating the linear extensions give me the same orders in py2 and py3: 

```
sage: P = sp._set_partition_poset()
sage: [e for e in P.linear_extensions()]
[[0, 1, 2], [1, 2, 0], [1, 0, 2]]
```




---

archive/issue_comments_388569.json:
```json
{
    "body": "Replying to [comment:3 tscrim]:\n> as the enumeration of set partitions should be constant.\n\nWhy ? The sames elements are present in both lists.",
    "created_at": "2019-05-21T15:57:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27540#issuecomment-388569",
    "user": "@vinklein"
}
```

Replying to [comment:3 tscrim]:
> as the enumeration of set partitions should be constant.

Why ? The sames elements are present in both lists.



---

archive/issue_comments_388570.json:
```json
{
    "body": "That is a good catch, I missed that. It is also good to know that enumerating the linear extensions is the same. So that is where we need to fix things. In the `__iter__`:\n\n```diff\n-s = list(self._set)\n+try:\n+    s = sorted(self._set)\n+except TypeError:\n+    s = sorted(self._set, key=str)\n```\n\n\nIt should be consistent because it is an enumerated set, so the unranking should be compatible. Imagine you run something in parallel, get the `i`-th element in the worker process, and then want to use the `i`-th element in the main process. Being an enumerated set guarantees that this is consistent. (Another scenario is replace process by sessions.)",
    "created_at": "2019-05-21T22:55:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27540#issuecomment-388570",
    "user": "@tscrim"
}
```

That is a good catch, I missed that. It is also good to know that enumerating the linear extensions is the same. So that is where we need to fix things. In the `__iter__`:

```diff
-s = list(self._set)
+try:
+    s = sorted(self._set)
+except TypeError:
+    s = sorted(self._set, key=str)
```


It should be consistent because it is an enumerated set, so the unranking should be compatible. Imagine you run something in parallel, get the `i`-th element in the worker process, and then want to use the `i`-th element in the main process. Being an enumerated set guarantees that this is consistent. (Another scenario is replace process by sessions.)



---

archive/issue_comments_388571.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-05-22T07:53:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27540#issuecomment-388571",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_388572.json:
```json
{
    "body": "`@`tscrim Thanks for your help and the explanation.\n\n- `SetPartitions_setparts.__iter__` has been fixed.\n- The `_latex_` failure, which used to appear randomly, is fixed.\n- Branch has been rebased on 8.8.beta5.",
    "created_at": "2019-05-22T07:58:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27540#issuecomment-388572",
    "user": "@vinklein"
}
```

`@`tscrim Thanks for your help and the explanation.

- `SetPartitions_setparts.__iter__` has been fixed.
- The `_latex_` failure, which used to appear randomly, is fixed.
- Branch has been rebased on 8.8.beta5.



---

archive/issue_comments_388573.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-05-22T07:58:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27540#issuecomment-388573",
    "user": "@vinklein"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_388574.json:
```json
{
    "body": "One last little thing, you should not have a bare `except:` statement.",
    "created_at": "2019-05-22T09:12:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27540#issuecomment-388574",
    "user": "@tscrim"
}
```

One last little thing, you should not have a bare `except:` statement.



---

archive/issue_comments_388575.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-05-22T09:38:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27540#issuecomment-388575",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_388576.json:
```json
{
    "body": "Yes my mistake. It's fixed.",
    "created_at": "2019-05-22T09:39:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27540#issuecomment-388576",
    "user": "@vinklein"
}
```

Yes my mistake. It's fixed.



---

archive/issue_comments_388577.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-05-22T10:06:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27540#issuecomment-388577",
    "user": "@tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_388578.json:
```json
{
    "body": "Thank you. LGTM.",
    "created_at": "2019-05-22T10:06:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27540#issuecomment-388578",
    "user": "@tscrim"
}
```

Thank you. LGTM.



---

archive/issue_comments_388579.json:
```json
{
    "body": "`self._set` is sorted in several places in this module, wouldn't it be good to make this uniform? (it is not clear to me to what extent a non-sortable `self._set` is supported)",
    "created_at": "2019-05-22T11:02:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27540#issuecomment-388579",
    "user": "@mantepse"
}
```

`self._set` is sorted in several places in this module, wouldn't it be good to make this uniform? (it is not clear to me to what extent a non-sortable `self._set` is supported)



---

archive/issue_comments_388580.json:
```json
{
    "body": "I am getting this failure which is also in the buildbot [https://patchbot.sagemath.org/log/27777/Ubuntu/14.04/i686/3.13.0-167-generic/arando/2019-05-22%2012:12:39?short](https://patchbot.sagemath.org/log/27777/Ubuntu/14.04/i686/3.13.0-167-generic/arando/2019-05-22%2012:12:39?short)\n\n```\nsage -t --long src/sage/groups/perm_gps/symgp_conjugacy_class.py\n**********************************************************************\nFile \"src/sage/groups/perm_gps/symgp_conjugacy_class.py\", line 345, in sage.groups.perm_gps.symgp_conjugacy_class.conjugacy_class_iterator\nFailed example:\n    next(it)\nExpected:\n    [('a', 'c'), ('b', 'e'), ('d', 'f')]\nGot:\n    [('a', 'b'), ('c', 'd'), ('e', 'f')]\n**********************************************************************\n```\n",
    "created_at": "2019-05-23T00:59:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27540#issuecomment-388580",
    "user": "@kiwifb"
}
```

I am getting this failure which is also in the buildbot [https://patchbot.sagemath.org/log/27777/Ubuntu/14.04/i686/3.13.0-167-generic/arando/2019-05-22%2012:12:39?short](https://patchbot.sagemath.org/log/27777/Ubuntu/14.04/i686/3.13.0-167-generic/arando/2019-05-22%2012:12:39?short)

```
sage -t --long src/sage/groups/perm_gps/symgp_conjugacy_class.py
**********************************************************************
File "src/sage/groups/perm_gps/symgp_conjugacy_class.py", line 345, in sage.groups.perm_gps.symgp_conjugacy_class.conjugacy_class_iterator
Failed example:
    next(it)
Expected:
    [('a', 'c'), ('b', 'e'), ('d', 'f')]
Got:
    [('a', 'b'), ('c', 'd'), ('e', 'f')]
**********************************************************************
```




---

archive/issue_comments_388581.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-05-23T07:37:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27540#issuecomment-388581",
    "user": "@vinklein"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_388582.json:
```json
{
    "body": "Indeed it looks like it's a side effect of this ticket",
    "created_at": "2019-05-23T07:37:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27540#issuecomment-388582",
    "user": "@vinklein"
}
```

Indeed it looks like it's a side effect of this ticket



---

archive/issue_comments_388583.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-05-23T09:16:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27540#issuecomment-388583",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_388584.json:
```json
{
    "body": "Rebase ticket on 8.8.beta6.\nFix doctest in sympgp_conjugacy_class.py.",
    "created_at": "2019-05-23T09:18:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27540#issuecomment-388584",
    "user": "@vinklein"
}
```

Rebase ticket on 8.8.beta6.
Fix doctest in sympgp_conjugacy_class.py.



---

archive/issue_comments_388585.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-05-23T09:18:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27540#issuecomment-388585",
    "user": "@vinklein"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_388586.json:
```json
{
    "body": "Changing keywords from \"\" to \"thursdaysbdx\".",
    "created_at": "2019-05-23T09:18:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27540#issuecomment-388586",
    "user": "@vinklein"
}
```

Changing keywords from "" to "thursdaysbdx".



---

archive/issue_comments_388587.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-05-23T12:38:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27540#issuecomment-388587",
    "user": "@tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_388588.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-05-25T08:18:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27540",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27540#issuecomment-388588",
    "user": "@vbraun"
}
```

Resolution: fixed
