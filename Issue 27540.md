# Issue 27540: Py3: Fix combinat.set_partition doctests

Issue created by migration from https://trac.sagemath.org/ticket/27777

Original creator: vklein

Original creation time: 2019-05-06 08:26:04

Fix combinat.set_partition doctests for python.


---

Comment by vklein created at 2019-05-06 08:35:33

Changing status from new to needs_review.


---

Comment by vklein created at 2019-05-06 08:35:33

New commits:


---

Comment by tscrim created at 2019-05-08 08:47:54

This change worries me:

```diff
-            sage: SetPartitions(["a", "b", "c"], [2,1]).list()
-            [{{'a'}, {'b', 'c'}}, {{'a', 'c'}, {'b'}}, {{'a', 'b'}, {'c'}}]
+            sage: sorted(SetPartitions(["a", "b", "c"], [2,1]), key=str)
+            [{{'a', 'b'}, {'c'}}, {{'a', 'c'}, {'b'}}, {{'a'}, {'b', 'c'}}]
```

as the enumeration of set partitions should be constant. Maybe something is slightly different in the algorithm, but this needs a closer examination (that I do not have time for tonight).


---

Comment by tscrim created at 2019-05-09 03:36:01

Okay, so the issue should be in enumerating the linear extensions of a poset. I am not sure what to do about that, but I think we should not sort the output here as it is just a symptom of an underlying issue.

I am also getting a failure in the `_latex_` method, but that also should not happen. My guess is the underlying (frozen)sets are not ordered the same way, which falls out from applying the `str`.


---

Comment by tscrim created at 2019-05-09 03:36:01

Changing status from needs_review to needs_work.


---

Comment by vklein created at 2019-05-21 15:47:21

In this case it looks like the difference of order depend on that :\\

py2

```
sage: sp = SetPartitions(["a", "b", "c"], [2,1])
sage: sp._set
frozenset({'a', 'b', 'c'})
sage: list(sp._set)
['a', 'c', 'b']
```


py3

```
sage: sp = SetPartitions(["a", "b", "c"], [2,1])
sage: sp._set
frozenset({'a', 'b', 'c'})
sage: list(sp._set)
['a', 'b', 'c']
```


The position of elements of `list(sp._set)` is used for generating `SetPartitions_setparts.__iter__` results.

Enumerating the linear extensions give me the same orders in py2 and py3: 

```
sage: P = sp._set_partition_poset()
sage: [e for e in P.linear_extensions()]
[[0, 1, 2], [1, 2, 0], [1, 0, 2]]
```



---

Comment by vklein created at 2019-05-21 15:57:51

Replying to [comment:3 tscrim]:
> as the enumeration of set partitions should be constant.

Why ? The sames elements are present in both lists.


---

Comment by tscrim created at 2019-05-21 22:55:46

That is a good catch, I missed that. It is also good to know that enumerating the linear extensions is the same. So that is where we need to fix things. In the `__iter__`:

```diff
-s = list(self._set)
+try:
+    s = sorted(self._set)
+except TypeError:
+    s = sorted(self._set, key=str)
```


It should be consistent because it is an enumerated set, so the unranking should be compatible. Imagine you run something in parallel, get the `i`-th element in the worker process, and then want to use the `i`-th element in the main process. Being an enumerated set guarantees that this is consistent. (Another scenario is replace process by sessions.)


---

Comment by git created at 2019-05-22 07:53:58

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vklein created at 2019-05-22 07:58:18

`@`tscrim Thanks for your help and the explanation.

- `SetPartitions_setparts.__iter__` has been fixed.
- The `_latex_` failure, which used to appear randomly, is fixed.
- Branch has been rebased on 8.8.beta5.


---

Comment by vklein created at 2019-05-22 07:58:18

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2019-05-22 09:12:11

One last little thing, you should not have a bare `except:` statement.


---

Comment by git created at 2019-05-22 09:38:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vklein created at 2019-05-22 09:39:00

Yes my mistake. It's fixed.


---

Comment by tscrim created at 2019-05-22 10:06:47

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2019-05-22 10:06:47

Thank you. LGTM.


---

Comment by mantepse created at 2019-05-22 11:02:51

`self._set` is sorted in several places in this module, wouldn't it be good to make this uniform? (it is not clear to me to what extent a non-sortable `self._set` is supported)


---

Comment by fbissey created at 2019-05-23 00:59:30

I am getting this failure which is also in the buildbot [https://patchbot.sagemath.org/log/27777/Ubuntu/14.04/i686/3.13.0-167-generic/arando/2019-05-22%2012:12:39?short](https://patchbot.sagemath.org/log/27777/Ubuntu/14.04/i686/3.13.0-167-generic/arando/2019-05-22%2012:12:39?short)

```
sage -t --long src/sage/groups/perm_gps/symgp_conjugacy_class.py
**********************************************************************
File "src/sage/groups/perm_gps/symgp_conjugacy_class.py", line 345, in sage.groups.perm_gps.symgp_conjugacy_class.conjugacy_class_iterator
Failed example:
    next(it)
Expected:
    [('a', 'c'), ('b', 'e'), ('d', 'f')]
Got:
    [('a', 'b'), ('c', 'd'), ('e', 'f')]
**********************************************************************
```



---

Comment by vklein created at 2019-05-23 07:37:52

Changing status from positive_review to needs_work.


---

Comment by vklein created at 2019-05-23 07:37:52

Indeed it looks like it's a side effect of this ticket


---

Comment by git created at 2019-05-23 09:16:34

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vklein created at 2019-05-23 09:18:00

Rebase ticket on 8.8.beta6.
Fix doctest in sympgp_conjugacy_class.py.


---

Comment by vklein created at 2019-05-23 09:18:00

Changing status from needs_work to needs_review.


---

Comment by vklein created at 2019-05-23 09:18:00

Changing keywords from "" to "thursdaysbdx".


---

Comment by tscrim created at 2019-05-23 12:38:29

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-05-25 08:18:27

Resolution: fixed
