# Issue 24048: cleaning reall and complex balls

archive/issues_024048.json:
```json
{
    "body": "CC:  @mezzarobba\n\nWe perform various cleaning with respect to balls in order to make them more likely their interval friends.\n\n- remove c++ clumsy dependency\n- `with X bits precision` -> `with X bits of precision`\n- use factories in order for parent to be extension class\n- implement a `_new` on parent as well\n\nIssue created by migration from https://trac.sagemath.org/ticket/24285\n\n",
    "created_at": "2017-11-27T08:08:59Z",
    "labels": [
        "basic arithmetic",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "cleaning reall and complex balls",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24048",
    "user": "@videlec"
}
```
CC:  @mezzarobba

We perform various cleaning with respect to balls in order to make them more likely their interval friends.

- remove c++ clumsy dependency
- `with X bits precision` -> `with X bits of precision`
- use factories in order for parent to be extension class
- implement a `_new` on parent as well

Issue created by migration from https://trac.sagemath.org/ticket/24285





---

archive/issue_comments_337095.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-11-27T08:12:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24048#issuecomment-337095",
    "user": "@videlec"
}
```

New commits:



---

archive/issue_comments_337096.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-11-27T08:12:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24048#issuecomment-337096",
    "user": "@videlec"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_337097.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-11-27T09:36:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24048#issuecomment-337097",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_337098.json:
```json
{
    "body": "Quick comments (no time for a full review before several weeks): I like some of the refactoring you did, especially the part related to the interface with number fields and the NTL dependency. However, I feel that using a Cython class for the parent is a big step backward. The only advantage I see is that it should make accessing the precision field much faster, but there are other ways to do that\u2014even storing a copy of the precision in every ball would be a better option IMO\u2014and to date it wasn't much of an issue in my benchmarks anyway. Do you have other reasons for making this change? I have mixed feelings about the change to `_repr_()`, which may break users' doctests just to fix a cosmetic issue, but I won't fight against it.",
    "created_at": "2017-11-27T12:11:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24048#issuecomment-337098",
    "user": "@mezzarobba"
}
```

Quick comments (no time for a full review before several weeks): I like some of the refactoring you did, especially the part related to the interface with number fields and the NTL dependency. However, I feel that using a Cython class for the parent is a big step backward. The only advantage I see is that it should make accessing the precision field much faster, but there are other ways to do that—even storing a copy of the precision in every ball would be a better option IMO—and to date it wasn't much of an issue in my benchmarks anyway. Do you have other reasons for making this change? I have mixed feelings about the change to `_repr_()`, which may break users' doctests just to fix a cosmetic issue, but I won't fight against it.



---

archive/issue_comments_337099.json:
```json
{
    "body": "Replying to [comment:3 mmezzarobba]:\n> Quick comments (no time for a full review before several weeks):\n\nThanks for having a quick look already. After reading your comments I would propose to:\n- make this ticket only about moving number field stuff and C++ care\n- open a more general ticket about \"convergence between real intervals and balls\"\n\n> I like some of the refactoring you did, especially the part related to the interface with number fields and the NTL dependency.\n\nIndeed. If you try to use Cython in a `pyx` file and use balls you are in troubles because there is no proper distutils directive in the headers. Moreover, it make more sense implemented that way.\n\n> However, I feel that using a Cython class for the parent is a big step backward. The only advantage I see is that it should make accessing the precision field much faster, but there are other ways to do that\u2014even storing a copy of the precision in every ball would be a better option IMO\u2014and to date it wasn't much of an issue in my benchmarks anyway. Do you have other reasons for making this change?\n\nWhy would you prefer a Python class over an extension class inside a `pyx` file? To benefit from `UniqueRepresentation`?\n\nThe real point is: \"How do you create a ball from nothing in Cython?\". This is needed here in the code\n\n```\ndef _arb_(self, R):\n    cdef RealBall x = ---> what do I put here? <----\n```\n\nThe way it is for interval is at least simple `R._new()`. And I just copied it for balls. I really dislike how people implementing balls just made their own coding conventions. I do not discuss the fact that they might be better (sometimes they do). Just the fact that they are different. The two interfaces should just be the same.\n\n> I have mixed feelings about the change to `_repr_()`, which may break users' doctests just to fix a cosmetic issue, but I won't fight against it.\n\nSame comment applies: uniformity with real intervals. (BTW, a docstring is not any serious doctest breaking)",
    "created_at": "2017-11-27T13:43:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24048#issuecomment-337099",
    "user": "@videlec"
}
```

Replying to [comment:3 mmezzarobba]:
> Quick comments (no time for a full review before several weeks):

Thanks for having a quick look already. After reading your comments I would propose to:
- make this ticket only about moving number field stuff and C++ care
- open a more general ticket about "convergence between real intervals and balls"

> I like some of the refactoring you did, especially the part related to the interface with number fields and the NTL dependency.

Indeed. If you try to use Cython in a `pyx` file and use balls you are in troubles because there is no proper distutils directive in the headers. Moreover, it make more sense implemented that way.

> However, I feel that using a Cython class for the parent is a big step backward. The only advantage I see is that it should make accessing the precision field much faster, but there are other ways to do that—even storing a copy of the precision in every ball would be a better option IMO—and to date it wasn't much of an issue in my benchmarks anyway. Do you have other reasons for making this change?

Why would you prefer a Python class over an extension class inside a `pyx` file? To benefit from `UniqueRepresentation`?

The real point is: "How do you create a ball from nothing in Cython?". This is needed here in the code

```
def _arb_(self, R):
    cdef RealBall x = ---> what do I put here? <----
```

The way it is for interval is at least simple `R._new()`. And I just copied it for balls. I really dislike how people implementing balls just made their own coding conventions. I do not discuss the fact that they might be better (sometimes they do). Just the fact that they are different. The two interfaces should just be the same.

> I have mixed feelings about the change to `_repr_()`, which may break users' doctests just to fix a cosmetic issue, but I won't fight against it.

Same comment applies: uniformity with real intervals. (BTW, a docstring is not any serious doctest breaking)



---

archive/issue_comments_337100.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-11-27T20:44:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24048#issuecomment-337100",
    "user": "@videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_337101.json:
```json
{
    "body": "Replying to [comment:4 vdelecroix]:\n> Replying to [comment:3 mmezzarobba]:\n> > However, I feel that using a Cython class for the parent is a big step backward. The only advantage I see is that it should make accessing the precision field much faster, but there are other ways to do that\u2014even storing a copy of the precision in every ball would be a better option IMO\u2014and to date it wasn't much of an issue in my benchmarks anyway. Do you have other reasons for making this change?\n> \n> Why would you prefer a Python class over an extension class inside a `pyx` file? To benefit from `UniqueRepresentation`?\n\nYes, and there are real benefits. The first is that by using a custom cache, you are making a strong reference to each parent. With `UniqueRepresentation`, it is only a weak reference, so you do not get the parents nailed in memory. It also is far less clean code:\n\n- You lose localization of the input and code; in particular, you either have duplicate documentation or either the creation function or object is lacking in documentation.\n- (Essentially) Duplicate code:\n\n  - You have to maintain the cache.\n  - You do not have the guarantees of uniqueness unless you handle pickles, `__copy__`, etc.\n  - You have to handle pickles.\n  - You have to handle comparisons.\n\n- Comparisons are now slower because they are not by `id`.\n\nSo I also think removing the `UniqueRepresentation` inheritance is a big step backwards. I do not see why you need the parent to be a `cdef` class. This does not seem to be a common optimization of creating an uninitialized ball, so just put `<RealBall> (RealBall.__new__(RealBall, R))` the place you need it. Yes, readability suffers slightly, but I think that is a marginal concern for code that is being optimized to the extent that you care about creating an uninitialized object in contrast to `RealBall(R)`.",
    "created_at": "2017-11-27T23:16:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24048#issuecomment-337101",
    "user": "@tscrim"
}
```

Replying to [comment:4 vdelecroix]:
> Replying to [comment:3 mmezzarobba]:
> > However, I feel that using a Cython class for the parent is a big step backward. The only advantage I see is that it should make accessing the precision field much faster, but there are other ways to do that—even storing a copy of the precision in every ball would be a better option IMO—and to date it wasn't much of an issue in my benchmarks anyway. Do you have other reasons for making this change?
> 
> Why would you prefer a Python class over an extension class inside a `pyx` file? To benefit from `UniqueRepresentation`?

Yes, and there are real benefits. The first is that by using a custom cache, you are making a strong reference to each parent. With `UniqueRepresentation`, it is only a weak reference, so you do not get the parents nailed in memory. It also is far less clean code:

- You lose localization of the input and code; in particular, you either have duplicate documentation or either the creation function or object is lacking in documentation.
- (Essentially) Duplicate code:

  - You have to maintain the cache.
  - You do not have the guarantees of uniqueness unless you handle pickles, `__copy__`, etc.
  - You have to handle pickles.
  - You have to handle comparisons.

- Comparisons are now slower because they are not by `id`.

So I also think removing the `UniqueRepresentation` inheritance is a big step backwards. I do not see why you need the parent to be a `cdef` class. This does not seem to be a common optimization of creating an uninitialized ball, so just put `<RealBall> (RealBall.__new__(RealBall, R))` the place you need it. Yes, readability suffers slightly, but I think that is a marginal concern for code that is being optimized to the extent that you care about creating an uninitialized object in contrast to `RealBall(R)`.



---

archive/issue_comments_337102.json:
```json
{
    "body": "Also, the category framework works better when the parents are plain Python classes. More generally, I thought there was a consensus that parents should always be Python classes, except perhaps in a few very special cases.\n\nRegarding the convergence between interval fields and ball fields, I am not really convinced that they serve the same purpose and need to be interchangeable, though of course it is better if they are somewhat compatible. And I don't think we made up our own coding conventions when implementing the arb interface. Rather, the implementation of MPFI intervals is quite outdated (and their behavior sometimes plainly incorrect), while the arb interface is more modern and more careful about giving correct results\u2014at the price that some things that rely on questionable behavior elsewhere in sage simply don't work.\n\nThe first step to improve the situation IMO would be to modernize the implementation of intervals. I have an old branch where I started doing that at `u/mmezzarobba/wip/intervals`, but I had to stop because it broke things elsewhere due to a deeper issue (probably something related to comparisons, as usual, but I don't remember for sure).",
    "created_at": "2017-11-28T09:18:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24048#issuecomment-337102",
    "user": "@mezzarobba"
}
```

Also, the category framework works better when the parents are plain Python classes. More generally, I thought there was a consensus that parents should always be Python classes, except perhaps in a few very special cases.

Regarding the convergence between interval fields and ball fields, I am not really convinced that they serve the same purpose and need to be interchangeable, though of course it is better if they are somewhat compatible. And I don't think we made up our own coding conventions when implementing the arb interface. Rather, the implementation of MPFI intervals is quite outdated (and their behavior sometimes plainly incorrect), while the arb interface is more modern and more careful about giving correct results—at the price that some things that rely on questionable behavior elsewhere in sage simply don't work.

The first step to improve the situation IMO would be to modernize the implementation of intervals. I have an old branch where I started doing that at `u/mmezzarobba/wip/intervals`, but I had to stop because it broke things elsewhere due to a deeper issue (probably something related to comparisons, as usual, but I don't remember for sure).



---

archive/issue_comments_337103.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-28T20:46:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24048#issuecomment-337103",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_337104.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-11-28T20:49:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24048#issuecomment-337104",
    "user": "@videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_337105.json:
```json
{
    "body": "Please move your interesting balls comments on #24289. This ticket stands for moving the quadratic number field conversion.",
    "created_at": "2017-11-28T20:49:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24048#issuecomment-337105",
    "user": "@videlec"
}
```

Please move your interesting balls comments on #24289. This ticket stands for moving the quadratic number field conversion.



---

archive/issue_comments_337106.json:
```json
{
    "body": "Replying to [comment:7 mmezzarobba]:\n> Regarding the convergence between interval fields and ball fields, I am not really convinced that they serve the same purpose and need to be interchangeable, though of course it is better if they are somewhat compatible.\n\nYou really need to explain me what is the difference in usage then.\n\n> The first step to improve the situation IMO would be to modernize the implementation of intervals. I have an old branch where I started doing that at `u/mmezzarobba/wip/intervals`, but I had to stop because it broke things elsewhere due to a deeper issue (probably something related to comparisons, as usual, but I don't remember for sure).\n\nIndeed. It might be more reasonable starting in this direction. If you make your branch alive again I can review it.",
    "created_at": "2017-11-28T20:54:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24048#issuecomment-337106",
    "user": "@videlec"
}
```

Replying to [comment:7 mmezzarobba]:
> Regarding the convergence between interval fields and ball fields, I am not really convinced that they serve the same purpose and need to be interchangeable, though of course it is better if they are somewhat compatible.

You really need to explain me what is the difference in usage then.

> The first step to improve the situation IMO would be to modernize the implementation of intervals. I have an old branch where I started doing that at `u/mmezzarobba/wip/intervals`, but I had to stop because it broke things elsewhere due to a deeper issue (probably something related to comparisons, as usual, but I don't remember for sure).

Indeed. It might be more reasonable starting in this direction. If you make your branch alive again I can review it.



---

archive/issue_comments_337107.json:
```json
{
    "body": "And patchbots are happy!",
    "created_at": "2017-11-29T08:08:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24048#issuecomment-337107",
    "user": "@videlec"
}
```

And patchbots are happy!



---

archive/issue_comments_337108.json:
```json
{
    "body": "Since `RealBallField` is a `UniqueRepresentation` it shouldn't need a custom `__reduce__` (left over from the previous changes?). Modulo that, I am happy. Marc?",
    "created_at": "2017-11-29T08:24:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24048#issuecomment-337108",
    "user": "@tscrim"
}
```

Since `RealBallField` is a `UniqueRepresentation` it shouldn't need a custom `__reduce__` (left over from the previous changes?). Modulo that, I am happy. Marc?



---

archive/issue_comments_337109.json:
```json
{
    "body": "Right! Good catch.",
    "created_at": "2017-11-29T08:25:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24048#issuecomment-337109",
    "user": "@videlec"
}
```

Right! Good catch.



---

archive/issue_comments_337110.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-11-29T08:25:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24048#issuecomment-337110",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_337111.json:
```json
{
    "body": "Replying to [comment:12 tscrim]:\n> Modulo that, I am happy. Marc?\n\nLooks reasonable to me, but I only skimmed through the code.\n\nWhy remove the ability to construct a complex ball from a machine integer? Since this is something supported by arb, `ComplexBall.__cinit__` does look like the most natural place for it to me.\n\nTypos: \u201cthat the map go through\u201d, \u201dcancellationss\u201d.\n\nVincent: Yes, I'll try to see if I can do something with my old branch(es) about intervals, post my comments on the other ticket, etc. ...but not now.",
    "created_at": "2017-11-29T08:56:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24048#issuecomment-337111",
    "user": "@mezzarobba"
}
```

Replying to [comment:12 tscrim]:
> Modulo that, I am happy. Marc?

Looks reasonable to me, but I only skimmed through the code.

Why remove the ability to construct a complex ball from a machine integer? Since this is something supported by arb, `ComplexBall.__cinit__` does look like the most natural place for it to me.

Typos: “that the map go through”, ”cancellationss”.

Vincent: Yes, I'll try to see if I can do something with my old branch(es) about intervals, post my comments on the other ticket, etc. ...but not now.



---

archive/issue_comments_337112.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-11-29T09:05:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24048#issuecomment-337112",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_337113.json:
```json
{
    "body": "Replying to [comment:15 mmezzarobba]:\n> Replying to [comment:12 tscrim]:\n> > Modulo that, I am happy. Marc?\n> \n> Why remove the ability to construct a complex ball from a machine integer?\n\nIt does work through `int -> ZZ` when you call `RBF(14r)` which is just fine. What would be the point of having one more special case in the init for something that is anyway slow because of Python and will be useless in Python3?\n\n> Since this is something supported by arb, `ComplexBall.__cinit__` does look like the most natural place for it to me.\n\nNote that it used to be in `__init__` and not `__cinit__`. I does think that `__cinit__` should do the minimal job (memory allocation) and not set any value. If the user wants quick initialization she uses arb functions directly as in\n\n```\ncdef RealBall a = RealBall.__new__(RealBall)\na._parent = TheParent      # can possibly move in __cinit__?\narb_set_si(a.value, 13)\n```\n\n\n> Typos: \u201cthat the map go through\u201d\n\nis that a typo?\n\n> \u201dcancellationss\u201d.\n\nright. Fixed in 27ac94b",
    "created_at": "2017-11-29T09:06:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24048#issuecomment-337113",
    "user": "@videlec"
}
```

Replying to [comment:15 mmezzarobba]:
> Replying to [comment:12 tscrim]:
> > Modulo that, I am happy. Marc?
> 
> Why remove the ability to construct a complex ball from a machine integer?

It does work through `int -> ZZ` when you call `RBF(14r)` which is just fine. What would be the point of having one more special case in the init for something that is anyway slow because of Python and will be useless in Python3?

> Since this is something supported by arb, `ComplexBall.__cinit__` does look like the most natural place for it to me.

Note that it used to be in `__init__` and not `__cinit__`. I does think that `__cinit__` should do the minimal job (memory allocation) and not set any value. If the user wants quick initialization she uses arb functions directly as in

```
cdef RealBall a = RealBall.__new__(RealBall)
a._parent = TheParent      # can possibly move in __cinit__?
arb_set_si(a.value, 13)
```


> Typos: “that the map go through”

is that a typo?

> ”cancellationss”.

right. Fixed in 27ac94b



---

archive/issue_comments_337114.json:
```json
{
    "body": "Replying to [comment:17 vdelecroix]:\n> Replying to [comment:15 mmezzarobba]:\n> > Typos: \u201cthat the map go through\u201d\n> \n> is that a typo?\n\nShould be \"that the map goes through\".",
    "created_at": "2017-11-29T09:14:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24048#issuecomment-337114",
    "user": "@tscrim"
}
```

Replying to [comment:17 vdelecroix]:
> Replying to [comment:15 mmezzarobba]:
> > Typos: “that the map go through”
> 
> is that a typo?

Should be "that the map goes through".



---

archive/issue_comments_337115.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-11-29T09:17:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24048#issuecomment-337115",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_337116.json:
```json
{
    "body": "thanks",
    "created_at": "2017-11-29T09:17:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24048#issuecomment-337116",
    "user": "@videlec"
}
```

thanks



---

archive/issue_comments_337117.json:
```json
{
    "body": "Replying to [comment:17 vdelecroix]:\n> It does work through `int -> ZZ` when you call `RBF(14r)` which is just fine. What would be the point of having one more special case in the init for something that is anyway slow because of Python and will be useless in Python3?\n\nI'm not sure it needs to be that slow when called from Cython code, but I admit I didn't measure. I don't really care anyway.\n\n> Note that it used to be in `__init__` and not `__cinit__`. I does think that `__cinit__` should do the minimal job (memory allocation) and not set any value.\n\nYes, that's what I meant, sorry. As far as I can say, the general logic how how constructors are organized in the arb interface is that (i)\u00a0`__cinit__()` does basic initialization, (ii)\u00a0`__init__()` wraps the C-level intializers provided by arb (and should be reasonably fast), and (iii)\u00a0`_element_constructor_()`, conversion morphisms and the like take care of everything else. This organization has pros and cons, but it sort of makes sense to me.",
    "created_at": "2017-11-29T09:36:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24048#issuecomment-337117",
    "user": "@mezzarobba"
}
```

Replying to [comment:17 vdelecroix]:
> It does work through `int -> ZZ` when you call `RBF(14r)` which is just fine. What would be the point of having one more special case in the init for something that is anyway slow because of Python and will be useless in Python3?

I'm not sure it needs to be that slow when called from Cython code, but I admit I didn't measure. I don't really care anyway.

> Note that it used to be in `__init__` and not `__cinit__`. I does think that `__cinit__` should do the minimal job (memory allocation) and not set any value.

Yes, that's what I meant, sorry. As far as I can say, the general logic how how constructors are organized in the arb interface is that (i) `__cinit__()` does basic initialization, (ii) `__init__()` wraps the C-level intializers provided by arb (and should be reasonably fast), and (iii) `_element_constructor_()`, conversion morphisms and the like take care of everything else. This organization has pros and cons, but it sort of makes sense to me.



---

archive/issue_comments_337118.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-12-06T13:58:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24048#issuecomment-337118",
    "user": "@tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_337119.json:
```json
{
    "body": "I am going to consider that as a positive review.",
    "created_at": "2017-12-06T13:58:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24048#issuecomment-337119",
    "user": "@tscrim"
}
```

I am going to consider that as a positive review.



---

archive/issue_comments_337120.json:
```json
{
    "body": "Thanks Travis and Marc. Indeed, remaining remarks mostly concern the parts of the ticket that have been moved to #24289.",
    "created_at": "2017-12-06T20:19:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24048#issuecomment-337120",
    "user": "@videlec"
}
```

Thanks Travis and Marc. Indeed, remaining remarks mostly concern the parts of the ticket that have been moved to #24289.



---

archive/issue_comments_337121.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-12-13T17:37:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24048#issuecomment-337121",
    "user": "@vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_337122.json:
```json
{
    "body": "Actually this change:\n\n```\n-        elif isinstance(other, number_field.NumberField_quadratic):\n[...]\n+        from sage.rings.number_field.number_field_base import is_NumberField\n+        if is_NumberField(other):\n             emb = other.coerce_embedding()\n-            if emb is not None:\n-                return self.has_coerce_map_from(emb.codomain())\n+            return emb is not None and self.has_coerce_map_from(emb.codomain())\n }}}\nis not correct, because the ball constructor only accepts *quadratic* NF elements. NF elements of higher degree can be converted to complex balls, but only through CLF or CIF.\n\nFixed at #24621.",
    "created_at": "2018-01-31T08:31:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24048#issuecomment-337122",
    "user": "@mezzarobba"
}
```

Actually this change:

```
-        elif isinstance(other, number_field.NumberField_quadratic):
[...]
+        from sage.rings.number_field.number_field_base import is_NumberField
+        if is_NumberField(other):
             emb = other.coerce_embedding()
-            if emb is not None:
-                return self.has_coerce_map_from(emb.codomain())
+            return emb is not None and self.has_coerce_map_from(emb.codomain())
 }}}
is not correct, because the ball constructor only accepts *quadratic* NF elements. NF elements of higher degree can be converted to complex balls, but only through CLF or CIF.

Fixed at #24621.
