# Issue 14790: Inconsistent primitive_root_of_unity for number fields

archive/issues_014790.json:
```json
{
    "body": "Assignee: @JohnCremona\n\nKeywords: number field unit\n\nIn 5.11.rc0:\n\n```\nsage: K = QuadraticField(-3)\nsage: K.primitive_root_of_unity()    \n1/2*a + 1/2\nsage: UK = K.unit_group()\nsage: K.primitive_root_of_unity()           \nu\nsage: K.primitive_root_of_unity().value()     \n-1/2*a + 1/2\n```\nIn the first call since the unit group has not yet been computed and cached, a fundamental torsion unit is computed idrectly (using pari).  In the second case it is obtained from the cached unit group, but should have value() applied to convert from an abstract element of the unit group to an actual number field element.\n\nIssue created by migration from https://trac.sagemath.org/ticket/15027\n\n",
    "closed_at": "2013-11-06T12:49:32Z",
    "created_at": "2013-08-09T14:38:36Z",
    "labels": [
        "component: number fields",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.13",
    "title": "Inconsistent primitive_root_of_unity for number fields",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14790",
    "user": "https://github.com/JohnCremona"
}
```
Assignee: @JohnCremona

Keywords: number field unit

In 5.11.rc0:

```
sage: K = QuadraticField(-3)
sage: K.primitive_root_of_unity()    
1/2*a + 1/2
sage: UK = K.unit_group()
sage: K.primitive_root_of_unity()           
u
sage: K.primitive_root_of_unity().value()     
-1/2*a + 1/2
```
In the first call since the unit group has not yet been computed and cached, a fundamental torsion unit is computed idrectly (using pari).  In the second case it is obtained from the cached unit group, but should have value() applied to convert from an abstract element of the unit group to an actual number field element.

Issue created by migration from https://trac.sagemath.org/ticket/15027





---

archive/issue_comments_188363.json:
```json
{
    "body": "Patch fixes the problem, now testing.",
    "created_at": "2013-08-09T14:47:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14790#issuecomment-188363",
    "user": "https://github.com/JohnCremona"
}
```

Patch fixes the problem, now testing.



---

archive/issue_comments_188364.json:
```json
{
    "body": "Set assignee to @JohnCremona.",
    "created_at": "2013-08-09T15:12:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14790#issuecomment-188364",
    "user": "https://github.com/JohnCremona"
}
```

Set assignee to @JohnCremona.



---

archive/issue_comments_188365.json:
```json
{
    "body": "John,\n\nThe patch doesn't seem to eliminate the other inconsistency: between `-1/2*a + 1/2` and `1/2*a + 1/2`.  For when `primitive_root_of_unity` is called before `unit_group` it selects the primitive with the shortest string representation.  On the other hand, `UnitGroup.__init__` just uses the element given by Pari's `nfrootsof1`.  There are clearly a variety of ways to sort this out.",
    "created_at": "2013-08-11T14:54:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14790#issuecomment-188365",
    "user": "https://trac.sagemath.org/admin/accounts/users/fwclarke"
}
```

John,

The patch doesn't seem to eliminate the other inconsistency: between `-1/2*a + 1/2` and `1/2*a + 1/2`.  For when `primitive_root_of_unity` is called before `unit_group` it selects the primitive with the shortest string representation.  On the other hand, `UnitGroup.__init__` just uses the element given by Pari's `nfrootsof1`.  There are clearly a variety of ways to sort this out.



---

archive/issue_comments_188366.json:
```json
{
    "body": "Replying to [comment:3 fwclarke]:\n> John,\n> \n> The patch doesn't seem to eliminate the other inconsistency: between `-1/2*a + 1/2` and `1/2*a + 1/2`.  For when `primitive_root_of_unity` is called before `unit_group` it selects the primitive with the shortest string representation.  On the other hand, `UnitGroup.__init__` just uses the element given by Pari's `nfrootsof1`.  There are clearly a variety of ways to sort this out.\n\n\nFair comment, but once you have computed the unit group it's quite important to go with its generators or discrete logs get confused.  The shortest-string business (which I wrote, though I cannot quite remember the issue which led me to) is less important.  But what was really needed was not to have the root of unity displaying on the lmfdb.org page of a number field as \"u0\"!",
    "created_at": "2013-08-11T16:02:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14790#issuecomment-188366",
    "user": "https://github.com/JohnCremona"
}
```

Replying to [comment:3 fwclarke]:
> John,
> 
> The patch doesn't seem to eliminate the other inconsistency: between `-1/2*a + 1/2` and `1/2*a + 1/2`.  For when `primitive_root_of_unity` is called before `unit_group` it selects the primitive with the shortest string representation.  On the other hand, `UnitGroup.__init__` just uses the element given by Pari's `nfrootsof1`.  There are clearly a variety of ways to sort this out.


Fair comment, but once you have computed the unit group it's quite important to go with its generators or discrete logs get confused.  The shortest-string business (which I wrote, though I cannot quite remember the issue which led me to) is less important.  But what was really needed was not to have the root of unity displaying on the lmfdb.org page of a number field as "u0"!



---

archive/issue_comments_188367.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-08-19T16:26:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14790#issuecomment-188367",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_188368.json:
```json
{
    "body": "`TESTS::` should be `TESTS:`",
    "created_at": "2013-08-21T08:51:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14790#issuecomment-188368",
    "user": "https://github.com/jdemeyer"
}
```

`TESTS::` should be `TESTS:`



---

archive/issue_comments_188369.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-08-21T08:51:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14790#issuecomment-188369",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_188370.json:
```json
{
    "body": "Replying to [comment:6 jdemeyer]:\n> `TESTS::` should be `TESTS:`\n\n\n--fixed.",
    "created_at": "2013-08-21T13:28:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14790#issuecomment-188370",
    "user": "https://github.com/JohnCremona"
}
```

Replying to [comment:6 jdemeyer]:
> `TESTS::` should be `TESTS:`


--fixed.



---

archive/issue_comments_188371.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-08-21T13:28:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14790#issuecomment-188371",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_188372.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-08-21T22:01:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14790#issuecomment-188372",
    "user": "https://trac.sagemath.org/admin/accounts/users/fwclarke"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_188373.json:
```json
{
    "body": "Here's a strange thing.  If I apply the patch (to 5.11), build and test, everything is fine.  But if I restart Sage and type\n\n```\nsage: K =\u00a0QuadraticField(-3)\nsage: K.primitive_root_of_unity()1/2*a + 1/2\n```\nI get\n\n```\n1/2*a + 1/2\n```\nrather than the\n\n```\n-1/2*a + 1/2\n```\nin the doctest.\n\nNow if edit the doctest to read\n\n```\n            sage: K = QuadraticField(-3, 'b')\n            sage: K.primitive_root_of_unity()\n            -1/2*b + 1/2\n            sage: UK = K.unit_group()\n            sage: K.primitive_root_of_unity()\n            -1/2*b + 1/2\n```\nrebuild and test I get\n\n```\nFailed example:\n    K.primitive_root_of_unity()\nExpected:\n    -1/2*b + 1/2\nGot:\n    1/2*b + 1/2\n```\nThe reason that there is no failure when the generator has the default name `'a'` is caused by the fact that the unit group of this field has already been computed in a doctest for the `S_units` method.  Thus as written the doctest is not testing that the problem has been fixed, since both instances of `K.primitive_root_of_unity()` use the same code.",
    "created_at": "2013-08-21T22:01:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14790#issuecomment-188373",
    "user": "https://trac.sagemath.org/admin/accounts/users/fwclarke"
}
```

Here's a strange thing.  If I apply the patch (to 5.11), build and test, everything is fine.  But if I restart Sage and type

```
sage: K = QuadraticField(-3)
sage: K.primitive_root_of_unity()1/2*a + 1/2
```
I get

```
1/2*a + 1/2
```
rather than the

```
-1/2*a + 1/2
```
in the doctest.

Now if edit the doctest to read

```
            sage: K = QuadraticField(-3, 'b')
            sage: K.primitive_root_of_unity()
            -1/2*b + 1/2
            sage: UK = K.unit_group()
            sage: K.primitive_root_of_unity()
            -1/2*b + 1/2
```
rebuild and test I get

```
Failed example:
    K.primitive_root_of_unity()
Expected:
    -1/2*b + 1/2
Got:
    1/2*b + 1/2
```
The reason that there is no failure when the generator has the default name `'a'` is caused by the fact that the unit group of this field has already been computed in a doctest for the `S_units` method.  Thus as written the doctest is not testing that the problem has been fixed, since both instances of `K.primitive_root_of_unity()` use the same code.



---

archive/issue_comments_188374.json:
```json
{
    "body": "Wow, that is subtlety i had certainly missed.  I cannot look into it now as I'm about to go on holiday, so feel free to repatch, or wait.",
    "created_at": "2013-08-22T08:27:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14790#issuecomment-188374",
    "user": "https://github.com/JohnCremona"
}
```

Wow, that is subtlety i had certainly missed.  I cannot look into it now as I'm about to go on holiday, so feel free to repatch, or wait.



---

archive/issue_comments_188375.json:
```json
{
    "body": "Enjoy your holiday.  I too am off on holiday, so I'll wait.",
    "created_at": "2013-08-22T09:12:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14790#issuecomment-188375",
    "user": "https://trac.sagemath.org/admin/accounts/users/fwclarke"
}
```

Enjoy your holiday.  I too am off on holiday, so I'll wait.



---

archive/issue_comments_188376.json:
```json
{
    "body": "Since the primitive root of unity is computed using PARI in both cases (either as part of full unit group or using `nfrootsof1`), wouldn't the problem be solved by simply returning whatever is answered by PARI? That is, don't try to find the generator with shortest string representation.",
    "created_at": "2013-08-22T09:29:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14790#issuecomment-188376",
    "user": "https://github.com/jdemeyer"
}
```

Since the primitive root of unity is computed using PARI in both cases (either as part of full unit group or using `nfrootsof1`), wouldn't the problem be solved by simply returning whatever is answered by PARI? That is, don't try to find the generator with shortest string representation.



---

archive/issue_comments_188377.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-11-02T15:29:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14790#issuecomment-188377",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_188378.json:
```json
{
    "body": "Apply to 5.11.rc0",
    "created_at": "2013-11-02T16:48:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14790#issuecomment-188378",
    "user": "https://github.com/jdemeyer"
}
```

Apply to 5.11.rc0



---

archive/issue_comments_188379.json:
```json
{
    "body": "Attachment [trac15027-unit.patch](tarball://root/attachments/some-uuid/ticket15027/trac15027-unit.patch) by @pjbruin created at 2013-11-02 18:28:52\n\nPatch looks good and solves the problem.  Doctests pass on x86_64 GNU/Linux.  (I don't expect any 32-bit/64-bit differences, which can occur for some computations with number fields in PARI.)",
    "created_at": "2013-11-02T18:28:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14790#issuecomment-188379",
    "user": "https://github.com/pjbruin"
}
```

Attachment [trac15027-unit.patch](tarball://root/attachments/some-uuid/ticket15027/trac15027-unit.patch) by @pjbruin created at 2013-11-02 18:28:52

Patch looks good and solves the problem.  Doctests pass on x86_64 GNU/Linux.  (I don't expect any 32-bit/64-bit differences, which can occur for some computations with number fields in PARI.)



---

archive/issue_comments_188380.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-11-02T18:28:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14790#issuecomment-188380",
    "user": "https://github.com/pjbruin"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_043197.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-11-06T12:49:32Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/14790",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14790#event-43197"
}
```



---

archive/issue_comments_188381.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-11-06T12:49:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14790#issuecomment-188381",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_188382.json:
```json
{
    "body": "For reference, let me add that PARI never guaranteed that the result of `nfrootsof1` corresponds to the \"torsion unit\" computed as part of the class group. However, in practice the units often did correspond.\n\nIt seems that PARI-2.9.1 has made this worse with far less cases where the units are the same.",
    "created_at": "2017-01-05T11:04:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14790#issuecomment-188382",
    "user": "https://github.com/jdemeyer"
}
```

For reference, let me add that PARI never guaranteed that the result of `nfrootsof1` corresponds to the "torsion unit" computed as part of the class group. However, in practice the units often did correspond.

It seems that PARI-2.9.1 has made this worse with far less cases where the units are the same.
