# Issue 14790: Inconsistent primitive_root_of_unity for number fields

Issue created by migration from Trac.

Original creator: cremona

Original creation time: 2013-08-09 14:38:36

Keywords: number field unit

In 5.11.rc0:

```
sage: K = QuadraticField(-3)
sage: K.primitive_root_of_unity()    
1/2*a + 1/2
sage: UK = K.unit_group()
sage: K.primitive_root_of_unity()           
u
sage: K.primitive_root_of_unity().value()     
-1/2*a + 1/2
```

In the first call since the unit group has not yet been computed and cached, a fundamental torsion unit is computed idrectly (using pari).  In the second case it is obtained from the cached unit group, but should have value() applied to convert from an abstract element of the unit group to an actual number field element.

This can be fixed with a one-line edit to line 5526 of number_field.py.


---

Comment by cremona created at 2013-08-09 14:47:44

Patch fixes the problem, now testing.


---

Comment by cremona created at 2013-08-09 15:12:55

Set assignee to cremona.


---

Comment by fwclarke created at 2013-08-11 14:54:28

John,

The patch doesn't seem to eliminate the other inconsistency: between `-1/2*a + 1/2` and `1/2*a + 1/2`.  For when `primitive_root_of_unity` is called before `unit_group` it selects the primitive with the shortest string representation.  On the other hand, `UnitGroup.__init__` just uses the element given by Pari's `nfrootsof1`.  There are clearly a variety of ways to sort this out.


---

Comment by cremona created at 2013-08-11 16:02:03

Replying to [comment:3 fwclarke]:
> John,
> 
> The patch doesn't seem to eliminate the other inconsistency: between `-1/2*a + 1/2` and `1/2*a + 1/2`.  For when `primitive_root_of_unity` is called before `unit_group` it selects the primitive with the shortest string representation.  On the other hand, `UnitGroup.__init__` just uses the element given by Pari's `nfrootsof1`.  There are clearly a variety of ways to sort this out.

Fair comment, but once you have computed the unit group it's quite important to go with its generators or discrete logs get confused.  The shortest-string business (which I wrote, though I cannot quite remember the issue which led me to) is less important.  But what was really needed was not to have the root of unity displaying on the lmfdb.org page of a number field as "u0"!


---

Comment by cremona created at 2013-08-19 16:26:08

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2013-08-21 08:51:14

`TESTS::` should be `TESTS:`


---

Comment by jdemeyer created at 2013-08-21 08:51:14

Changing status from needs_review to needs_work.


---

Comment by cremona created at 2013-08-21 13:28:11

Replying to [comment:6 jdemeyer]:
> `TESTS::` should be `TESTS:`

--fixed.


---

Comment by cremona created at 2013-08-21 13:28:11

Changing status from needs_work to needs_review.


---

Comment by fwclarke created at 2013-08-21 22:01:30

Changing status from needs_review to needs_work.


---

Comment by fwclarke created at 2013-08-21 22:01:30

Here's a strange thing.  If I apply the patch (to 5.11), build and test, everything is fine.  But if I restart Sage and type

```
sage: K =Â QuadraticField(-3)
sage: K.primitive_root_of_unity()1/2*a + 1/2
```

I get

```
1/2*a + 1/2
```

rather than the

```
-1/2*a + 1/2
```

in the doctest.

Now if edit the doctest to read

```
            sage: K = QuadraticField(-3, 'b')
            sage: K.primitive_root_of_unity()
            -1/2*b + 1/2
            sage: UK = K.unit_group()
            sage: K.primitive_root_of_unity()
            -1/2*b + 1/2
```

rebuild and test I get

```
Failed example:
    K.primitive_root_of_unity()
Expected:
    -1/2*b + 1/2
Got:
    1/2*b + 1/2
```

The reason that there is no failure when the generator has the default name `'a'` is caused by the fact that the unit group of this field has already been computed in a doctest for the `S_units` method.  Thus as written the doctest is not testing that the problem has been fixed, since both instances of `K.primitive_root_of_unity()` use the same code.


---

Comment by cremona created at 2013-08-22 08:27:10

Wow, that is subtlety i had certainly missed.  I cannot look into it now as I'm about to go on holiday, so feel free to repatch, or wait.


---

Comment by fwclarke created at 2013-08-22 09:12:14

Enjoy your holiday.  I too am off on holiday, so I'll wait.


---

Comment by jdemeyer created at 2013-08-22 09:29:10

Since the primitive root of unity is computed using PARI in both cases (either as part of full unit group or using `nfrootsof1`), wouldn't the problem be solved by simply returning whatever is answered by PARI? That is, don't try to find the generator with shortest string representation.


---

Comment by jdemeyer created at 2013-11-02 15:29:16

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2013-11-02 16:48:34

Apply to 5.11.rc0


---

Attachment

Patch looks good and solves the problem.  Doctests pass on x86_64 GNU/Linux.  (I don't expect any 32-bit/64-bit differences, which can occur for some computations with number fields in PARI.)


---

Comment by pbruin created at 2013-11-02 18:28:52

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-11-06 12:49:32

Resolution: fixed


---

Comment by jdemeyer created at 2017-01-05 11:04:00

For reference, let me add that PARI never guaranteed that the result of `nfrootsof1` corresponds to the "torsion unit" computed as part of the class group. However, in practice the units often did correspond.

It seems that PARI-2.9.1 has made this worse with far less cases where the units are the same.
