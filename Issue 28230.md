# Issue 28230: wrong bound in "Cannot compute primes beyond ..."

Issue created by migration from https://trac.sagemath.org/ticket/28467

Original creator: zimmerma

Original creation time: 2019-09-09 15:52:31

CC:  chapoton

with Sage 8.8:

```
sage: sum(1./p for p in prime_range(436272668))
...
ValueError: Cannot compute primes beyond 436273290
```

Clearly the value 436272668 is below the given bound, thus the error message is misleading.


---

Comment by @DaveWitteMorris created at 2019-10-07 20:33:41

Instead of improving the error message, this PR eliminates the error. The function now prints a warning message and switches to the algorithm that works. This seems more user friendly, and addresses the misunderstanding expressed in https://groups.google.com/forum/#!topic/sage-support/TeBjfcKC9Jw

I also revised the docstring, added a doctest, and deleted the declaration of the unused variable "maxpr".


---

Comment by @DaveWitteMorris created at 2019-10-07 20:34:42

Changing status from new to needs_review.


---

Attachment


---

Comment by zimmerma created at 2019-10-10 09:08:23

I tried to compile the code in that branch, but it failed with openblas (see attached file):

```
gcc -O2 -DMAX_STACK_ALLOC=2048 -Wall -m64 ... -l4 -lgfortran -lm -lquadmath -lm -lc
/usr/bin/ld: cannot find -l4
```

Any hint? My machine has gcc 9.2.1 20190909 (Debian 9.2.1-8).


---

Comment by @DaveWitteMorris created at 2019-10-10 17:19:22

Thanks for trying to test the patch. I'm not at all a sage expert, but I don't see how my patch would have caused this problem. Instead, the log file seems to suggest that it has to do with updating openblas ("Uninstalling existing 'openblas'", etc.), which should not be related to any changes in my patch. Your openblas does seem to be out of date (version 0.2.20.p2 instead of 0.3.6.p0), compared to my sage installation, but I am on Mac OS.

Could you try building sage without the branch? If that works, then you could try to add the branch by using ./sage -br


---

Comment by kcrisman created at 2019-10-13 01:39:54

Just a minor note - I feel like we may have a way to generate warnings of this type that is more Sage-specific, similarly to how deprecations are handled.  On the other hand, I'm not sure we even want to generate warnings in standard output at all in this case, since there isn't anything mathematically wrong (I assume) done, just that we need big notes in the documentation for what will happen.  E.g. the `WARNING::` block in Sphinx, or whatever we use nowadays.

Thoughts?  Could be worth a sage-devel discussion if we don't have anything currently in the developer guide on this (not because this ticket is bad, just having a standardized way to deal with these things in the future will be helpful, if we don't already).


---

Comment by @DaveWitteMorris created at 2019-10-13 06:22:51

Sorry, it didn't occur to me to write a warning in the docstring. I searched sage source for a function call that would produce a warning, but didn't find one. Instead, I found a function that printed a warning (I don't remember what), and I used that as a template. 

There is indeed no mathematical error (that I know of). The warning addresses two issues: the user's request for a particular algorithm is being countermanded, and a small change in input may lead to a much slower calculation (because of the need to switch to the other algorithm).

I defer to the sage experts (e.g., kcrisman) on what should be done. (A warning in the docs does seem reasonable to me. Or maybe there is no need for any warning at all.) I'll be happy to make whatever change is desired, but the branch is public, which I think means that anyone can fix it, without having to explain to me exactly what should be done.


---

Comment by @DaveWitteMorris created at 2019-10-13 06:27:28

Oops. Even though the problem is dead easy, my code has a bug: start and stop should be cast to Integer before any comparison is made. We obviously want 90 < 100, but it is not true that "90" < "100". I'll make a PR to fix this.


---

Comment by git created at 2019-10-13 06:30:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by zimmerma created at 2019-10-14 14:38:05

I have a question about the following:

```
sage: prime_range("90","100")
[97]
```

This syntax was not allowed before. What is the purpose?


---

Comment by zimmerma created at 2019-10-14 14:41:29

also maybe the warning (if any) should be printed only once?


---

Comment by zimmerma created at 2019-10-14 14:49:32

I don't know where the bound 1500 comes from, but in http://primerecords.dk/primegaps/maximal.htm we already see a gap of 1476 between primes of 61 bits, thus this bound might be wrong.


---

Comment by zimmerma created at 2019-10-14 14:50:33

apart from the above tiny remarks, I have satisfied by this patch. Thank you!


---

Comment by zimmerma created at 2019-10-14 14:51:00

Changing status from needs_review to needs_info.


---

Comment by @DaveWitteMorris created at 2019-10-24 01:34:31

Replying to [comment:11 zimmerma]:
> I have a question about the following:
> {{{
> sage: prime_range("90","100")
> [97]
> }}}
> This syntax was not allowed before. What is the purpose?

Thanks for your helpful comments. I'm sorry for taking so long to respond.

It's a surprise to me that this syntax was not allowed -- I assumed that it would be ok (but my cython knowledge is rudimentary and I never tested it).  It was accepted for the "pari_isprime" algorithm: 

```
sage: prime_range("90","100", "pari_isprime")
[97]
```

I would consider the incompatible behaviors of the two algorithms to be a (minor) bug.

Actually, though, my motivation for the doctest was not really about that particular syntax. The original code assumes that start and stop are integers (or None), and it's hard to predict how it will react if the user passes in some other type of object that is not exactly an integer. So I added `start = Integer(start)` (and similarly for stop), in order to make sure that each input will act exactly like an integer, and also to produce an understandable error message if the function is called on an unacceptable type. (My original code gave a misleading error message when the strings "90" and "100" were passed for start and stop. I think that message would give the clear impression that there was a bug, rather than user error.) It seems to me that type-checking or coercion should be in the code, but I don't know whether sage developers have some other standard convention for this.

I added the doctest to verify that the `start = Integer(start)` patch is still there (but perhaps it would be better to have a doctest to confirm that non-Integer input produces a reasonable error message).


---

Comment by @DaveWitteMorris created at 2019-10-24 01:39:31

Replying to [comment:13 zimmerma]:
> I don't know where the bound 1500 comes from, but in http://primerecords.dk/primegaps/maximal.htm we already see a gap of 1476 between primes of 61 bits, thus this bound might be wrong.

That's a very good point! 1500 was already in the code and I assumed it had been chosen by a number theorist to be clearly large enough. However, we actually do not need `prime_gap_bound` to be anywhere near that large, because `c_stop` is less than than 436273290 in this part of the code. I have now revised the code to use a smaller value of `prime_gap_bound` (namely, 250) that can be confirmed by sage in less than 2 minutes on my 7-year-old laptop.

PS The hardcoded limit 436273290 is because pari stores the list of small primes via a list of gaps between the primes, and no gap can be larger than 255. The first prime gap that is larger than 255 is from 436273009 to 436273291. So the prime 436273291 cannot be stored in this manner.


---

Comment by @DaveWitteMorris created at 2019-10-24 01:40:28

Replying to [comment:14 zimmerma]:
> apart from the above tiny remarks, I have satisfied by this patch. Thank you!

Thanks again for your comments! I will submit a PR that removes the warning. (Using a warning in this situation was an error in judgment on my part.) And I revised the docstring to be consistent with the new behaviour of the function, and made other edits in an attempt to make the documentation more clear and accurate.


---

Comment by git created at 2019-10-24 01:41:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DaveWitteMorris created at 2019-10-24 03:33:19

Changing status from needs_info to needs_review.


---

Comment by @DaveWitteMorris created at 2019-10-24 06:32:18

Changing status from needs_review to needs_work.


---

Comment by @DaveWitteMorris created at 2019-10-24 06:32:18

Failed doctest:


```
File "src/sage/functions/prime_pi.pyx", line 454, in sage.functions.prime_pi.PrimePi.plot
Failed example:
    prime_pi.plot(-2, sqrt(2501), thickness=2, vertical_lines=False)
Exception raised:
    Traceback (most recent call last):
      File "/home/sage-patchbot/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/sage-patchbot/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1123, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.functions.prime_pi.PrimePi.plot[1]>", line 1, in <module>
        prime_pi.plot(-Integer(2), sqrt(Integer(2501)), thickness=Integer(2), vertical_lines=False)
      File "sage/functions/prime_pi.pyx", line 465, in sage.functions.prime_pi.PrimePi.plot (build/cythonized/sage/functions/prime_pi.c:6223)
        for p in prime_range(xmin+1, xmax+1, py_ints=True):
      File "sage/rings/fast_arith.pyx", line 48, in sage.rings.fast_arith.prime_range (build/cythonized/sage/rings/fast_arith.c:3429)
        cpdef prime_range(start, stop=None, algorithm="pari_primes", bint py_ints=False):
      File "sage/rings/fast_arith.pyx", line 145, in sage.rings.fast_arith.prime_range (build/cythonized/sage/rings/fast_arith.c:2760)
        stop = Integer(stop)
      File "sage/rings/integer.pyx", line 692, in sage.rings.integer.Integer.__init__ (build/cythonized/sage/rings/integer.c:6191)
        set_from_Integer(self, otmp(the_integer_ring))
      File "sage/symbolic/expression.pyx", line 1086, in sage.symbolic.expression.Expression._integer_ (build/cythonized/sage/symbolic/expression.cpp:8681)
        raise TypeError("unable to convert %r to an integer" % self)
    TypeError: unable to convert sqrt(2501) + 1 to an integer
```

I will need to think about this. 

The failed example calls `prime_range` with an argument that is a non-integer real number, which I did not think was allowed. It seems that, for backward compatibility, such an argument needs to be allowed at least when `algorithm="pari_primes"`, even though the original function gives a `TypeError` when `algorithm="is_prime"`.


---

Comment by @DaveWitteMorris created at 2019-10-28 04:20:03

I do not see any reason to reject real numbers as inputs. (I don't think I ever realized before that the Python function `range` accepts real numbers.) So I have revised the code to take real numbers, and I added a note to the docstring.


---

Comment by git created at 2019-10-28 04:21:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DaveWitteMorris created at 2019-10-28 07:43:58

Changing status from needs_work to needs_review.


---

Comment by zimmerma created at 2019-11-04 15:40:08

I'm dubious about allowing real numbers and strings. This was not allowed before, and if you propose to change this behaviour, I believe this should be in a separate ticket. If so, I would give a positive review.


---

Comment by @DaveWitteMorris created at 2019-11-08 19:19:10

You are right. I was confused. Before I started work on this, the algorithm "pari_primes" allowed real numbers, and the algorithm "pari_isprime" allowed strings, but neither allowed both. I will upload a PR to restore this behavior (i.e., the patch removes the code that tests and coerces the input). The patch also mentions this behavior in a note in the docstring.

I opened ticket:28712 to discuss the allowable input.


---

Comment by git created at 2019-11-08 20:07:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by zimmerma created at 2019-11-13 10:15:55

Changing status from needs_review to positive_review.


---

Comment by zimmerma created at 2019-11-13 10:15:55

I give a positive review, but I'm still unable to try the new code because Sage fails to build on my machine (see #28104, comment [comment:12]).


---

Comment by vbraun created at 2019-11-16 12:49:52

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2019-11-16 12:49:52

This causes various py3-related test failures


---

Comment by vbraun created at 2019-11-16 12:50:21

(which will be the default in the next beta, so mere that one in and run tests)


---

Comment by @DaveWitteMorris created at 2019-11-19 01:59:51

OK, I'm compiling a Python-3 version of sage, and I will try to figure out what is wrong. (I don't see how my "innocent little patch" could be causing build errors outside the file that I touched, so this is a learning opportunity for me.)


---

Comment by @DaveWitteMorris created at 2019-12-28 03:58:15

Bug is fixed: we no longer ask `max` to compare an integer with `None`. This should eliminate the doctest failures, but I do not know why some of the patchbots gave build errors -- the problems do not seem to be related to this patch.

Unfortunately, I cannot do a full doctest because I have not yet been able to compile a good copy of Python 3 sage. (My Mac OS Catalina installation has many doctest failures on an unmodified copy of the develop branch.)


---

Comment by @DaveWitteMorris created at 2019-12-28 03:58:15

Changing status from needs_work to needs_review.


---

Comment by git created at 2019-12-28 03:58:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2020-01-01 23:35:01

Looks like this has a couple of clean patchbot runs under Py3 (which is officially the default now that 9.0 is released).


---

Comment by chapoton created at 2020-02-15 10:52:22

branch no longer applies cleanly


---

Comment by chapoton created at 2020-02-15 10:52:22

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-03-12 01:25:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DaveWitteMorris created at 2020-03-12 01:28:03

Changing status from needs_work to needs_review.


---

Comment by @DaveWitteMorris created at 2020-03-12 01:28:03

Merged with 9.1b6 to fix the conflict with #29123, which revised the documentation.


---

Comment by @DaveWitteMorris created at 2020-03-12 01:32:27

I tried not to mess up the intent of #29123, but I think chapoton should be informed that I revised the docstring.


---

Comment by vdelecroix created at 2020-04-12 08:18:54

The change in behavior you proposed is bad. If a user provides `algorithm="pari_primes"` the function should not silently switch to the `"pari_isprime"` version. The adaptation should only applies when the algorithm is not explicitly specified.

Also, the NOTE is more confusing than anything else. You don't want to document that kind of behavior that forces you to stick to it in the future. If you feel it needs something, simply write: `if the input is not numerical then the behavior is not specified.`

Minor comments
- Instead of writing `The sage command ``primes``` you would better use references `The sage command :func:`~sage.arith.misc.primes``. That produces a link in the compiled documentation.
- To describe strings as argument I think Sage preferrs ```"pari_primes"``` rather than `"pari_primes"`.
- Don't write `trac ticket 28467` but `:trac:`28467`` (which produces a link in the compiled documentation).
- Please test `prime_range(9.5, 14.3)` with both `"pari_primes"` and `"pari_isprime"`.


---

Comment by vdelecroix created at 2020-04-12 08:19:40

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-04-12 22:31:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DaveWitteMorris created at 2020-04-12 22:40:54

Thanks for the corrections!

PS IMHO, the two algorithms should have similar behavior, so the followup ticket #28712 addresses the fact that `prime_range(9.5, 14.3)` raises an error for one algorithm, but not the other.


---

Comment by @DaveWitteMorris created at 2020-04-12 22:40:54

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2020-04-15 07:34:52

Replying to [comment:44 gh-DaveWitteMorris]:
> Thanks for the corrections!
> 
> PS IMHO, the two algorithms should have similar behavior,

Why is that? If one can not do beyond `436273290` and the other can, we should restrict the latter to not do it so that they behave the same?

> so the followup ticket #28712 addresses the fact that `prime_range(9.5, 14.3)` raises an error for one algorithm, but not the other.

This is about the interface, and I agree that it should be consistent.


---

Comment by @DaveWitteMorris created at 2020-04-15 07:39:43

You're right: "behavior" was the wrong word. I'm glad you agree that the interface (or this part, at least) should be consistent.


---

Comment by vdelecroix created at 2020-04-15 07:42:22

Please clarify what you are trying to do with prime_pi. Doctest are not meant for comments about the code such as

```
To avoid a doctest error in functions/prime_pi.pyx, prime_range must allow real input::
```

First of all, while reading the documentation nobody cares about the doctests in distinct files. Even though the information might be relevant for someone, its place is not in the doc. Moreover, if there is a doctest in `functions/prime_pi.pyx` why would you need to duplicate it here? Finally, if somebody decides to fix the underlying problem in `functions/prime_pi.pyx`, this doctest will remain here for no good reason at all.


---

Comment by @DaveWitteMorris created at 2020-04-15 07:56:05

I was trying to be helpful (I was surprised that one of my edits caused a doctest failure in `functions/prime_pi.pyx`), but I now understand, from your explanation, that this redundant doctest is problematic.  I will delete it.


---

Comment by git created at 2020-04-15 08:08:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slelievre created at 2020-08-22 19:53:29

Minor style comments.

Compare to `None` with `is`, not `==`:

```diff
-    if algorithm == None:
+    if algorithm is None:
```


Two spaces before `#` for inline comments:

```diff
-    DEF small_prime_max = 436273009 # a prime < init_primes_max (preferably the largest)
-    DEF prime_gap_bound = 250 # upper bound for gap between primes <= small_prime_max
+    DEF small_prime_max = 436273009  # a prime < init_primes_max (preferably the largest)
+    DEF prime_gap_bound = 250  # upper bound for gap between primes <= small_prime_max
```


Proposed rephrasing and reformatting for the `ValueError` message:

```diff
         if max(start, stop or 0) > small_prime_max:
-            raise ValueError('algorithm "pari_primes" cannot compute primes larger than'
-                + ' {}'.format(small_prime_max - 1))
+            s = 'algorithm "pari_primes" is limited to primes less than {}'
+            raise ValueError(s.format(small_prime_max - 1))
```


Patchbots are happy. What do other reviewers think?


---

Comment by git created at 2020-09-08 11:39:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-09-08 11:57:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-09-08 12:05:21

lgtm


---

Comment by dimpase created at 2020-09-08 12:05:21

Changing status from needs_review to positive_review.


---

Comment by @DaveWitteMorris created at 2020-09-20 04:35:31

Thanks for the corrections, and the review!


---

Comment by vbraun created at 2020-11-07 16:23:18

Resolution: fixed
