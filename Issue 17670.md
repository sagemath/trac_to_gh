# Issue 17670: Random failure in enum_projective_number_field

Issue created by migration from Trac.

Original creator: vbraun

Original creation time: 2015-03-07 13:10:40

CC:  gjorgenson bhutz dkrumm jdoyle

Keywords: random_fail

`enum_projective_number_field` (#17386) is missing points on OSX 10.6.8, possibly other platforms. This suggests that there is a bug in the algorithm where memory locations (determining sort order of objects without coercion into a common parent) matter.

```
  File "src/sage/schemes/projective/projective_rational_point.py", line 162, in sa  ge.schemes.projective.projective_rational_point.enum_projective_number_field 
  Failed example: 
    enum_projective_number_field(X(K),125) 
  Expected: 
    [(0 : 0 : 1), (-1 : -1 : 1), (1 : 1 : 1), (-1/5*v^2 : -1/5*v^2 : 1), (-v : -v : 1), 
    (1/5*v^2 : 1/5*v^2 : 1), (v : v : 1), (1 : 1 : 0)] 
  Got: 
    [(0 : 0 : 1), (-1 : -1 : 1), (1 : 1 : 1), (1 : 1 : 0)] 
********************************************************************** 
```



---

Comment by bhutz created at 2015-03-07 15:35:23

I haven't been able to reproduce this yet, but the issue is likely in #15389 since #17386 is just using that algorithm. So I've added John and David to the CC.


---

Comment by jdoyle created at 2015-03-07 16:52:39

There seems to be an issue with the way 'bound' is defined for points_of_bounded_height. If the expected bound is an absolute height bound and you want to convert to a relative height bound, you need to raise to the power (degree of number field), not 1/(degree of number field). In particular, the expected output in this example contains points with relative height at most 5. For example, the point (2 : 2 : 1) doesn't appear in the expected output, though it certainly has height (relative and absolute) less than 125.

This doesn't address the discrepancy in the two lists, though, at least not entirely. The issue must be related to the floating point arithmetic being used for elements_of_bounded_height. The four points appearing in the "expected" list and not the "for" list have relative height exactly equal to 5, which is the bound that is being passed to the elements_of_bounded_height function. I seem to remember something like this happening when we were testing elements_of_bounded_height, where sometimes points of exact height B would appear in the output, and occasionally they would not, depending on the machine.

One last comment: Because of the floating point arithmetic involved, the output of elements_of_bounded_height cannot be guaranteed correct (as per the warning in the documentation). Probably a warning to this effect should be included in the documentation here.


---

Comment by bhutz created at 2015-03-08 21:24:05

Changing status from new to needs_review.


---

Comment by bhutz created at 2015-03-08 21:24:05

I've made a start here. I fixed the exponent on the bound. I added a precision parameter and the warning to the appropriate functions. I also upped the precision for the failed example, but since I can't reproduce, I can't be sure that will fix it.

I guess I'll mark this as needs-review, although I'm not 100% sure I've resolved it. I won't be able to work on this for a few days if someone wants to take over in the meantime.
----
New commits:


---

Comment by vbraun created at 2015-03-30 08:19:55

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-03-30 08:19:55

Seems to fix the issue, at least. 

Of course it would be nice to pick the right precision automatically ...


---

Comment by bhutz created at 2015-03-30 13:04:20

Thanks for checking this. I've been having trouble finding someone with a machine which can reproduce the original error.

Yes, there is a TODO in the enumeration of points of bounded height in number fields (from #15389) to address the precision sensitivity.


---

Comment by vbraun created at 2015-04-14 19:43:52

Resolution: fixed


---

Comment by leif created at 2015-04-18 09:25:13

Replying to [ticket:17907 vbraun]:
> `enum_projective_number_field` (#17386) is missing points on OSX 10.6.8, possibly other platforms.

Just seen (with Sage 6.6) on Linux x86_64 (Haswell-E CPU), FSF GCC 4.9.2 (but not e.g. 4.4.3); patch fixes the doctest failure.
