# Issue 17670: Random failure in enum_projective_number_field

archive/issues_017670.json:
```json
{
    "body": "CC:  gjorgenson @bhutz dkrumm jdoyle\n\nKeywords: random_fail\n\n`enum_projective_number_field` (#17386) is missing points on OSX 10.6.8, possibly other platforms. This suggests that there is a bug in the algorithm where memory locations (determining sort order of objects without coercion into a common parent) matter.\n\n```\n  File \"src/sage/schemes/projective/projective_rational_point.py\", line 162, in sa  ge.schemes.projective.projective_rational_point.enum_projective_number_field \n  Failed example: \n    enum_projective_number_field(X(K),125) \n  Expected: \n    [(0 : 0 : 1), (-1 : -1 : 1), (1 : 1 : 1), (-1/5*v^2 : -1/5*v^2 : 1), (-v : -v : 1), \n    (1/5*v^2 : 1/5*v^2 : 1), (v : v : 1), (1 : 1 : 0)] \n  Got: \n    [(0 : 0 : 1), (-1 : -1 : 1), (1 : 1 : 1), (1 : 1 : 0)] \n********************************************************************** \n```\n\nIssue created by migration from https://trac.sagemath.org/ticket/17907\n\n",
    "closed_at": "2015-04-14T19:43:52Z",
    "created_at": "2015-03-07T13:10:40Z",
    "labels": [
        "component: algebraic geometry",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.7",
    "title": "Random failure in enum_projective_number_field",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17670",
    "user": "https://github.com/vbraun"
}
```
CC:  gjorgenson @bhutz dkrumm jdoyle

Keywords: random_fail

`enum_projective_number_field` (#17386) is missing points on OSX 10.6.8, possibly other platforms. This suggests that there is a bug in the algorithm where memory locations (determining sort order of objects without coercion into a common parent) matter.

```
  File "src/sage/schemes/projective/projective_rational_point.py", line 162, in sa  ge.schemes.projective.projective_rational_point.enum_projective_number_field 
  Failed example: 
    enum_projective_number_field(X(K),125) 
  Expected: 
    [(0 : 0 : 1), (-1 : -1 : 1), (1 : 1 : 1), (-1/5*v^2 : -1/5*v^2 : 1), (-v : -v : 1), 
    (1/5*v^2 : 1/5*v^2 : 1), (v : v : 1), (1 : 1 : 0)] 
  Got: 
    [(0 : 0 : 1), (-1 : -1 : 1), (1 : 1 : 1), (1 : 1 : 0)] 
********************************************************************** 
```

Issue created by migration from https://trac.sagemath.org/ticket/17907





---

archive/issue_comments_235867.json:
```json
{
    "body": "I haven't been able to reproduce this yet, but the issue is likely in #15389 since #17386 is just using that algorithm. So I've added John and David to the CC.",
    "created_at": "2015-03-07T15:35:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-235867",
    "user": "https://github.com/bhutz"
}
```

I haven't been able to reproduce this yet, but the issue is likely in #15389 since #17386 is just using that algorithm. So I've added John and David to the CC.



---

archive/issue_comments_235868.json:
```json
{
    "body": "There seems to be an issue with the way 'bound' is defined for points_of_bounded_height. If the expected bound is an absolute height bound and you want to convert to a relative height bound, you need to raise to the power (degree of number field), not 1/(degree of number field). In particular, the expected output in this example contains points with relative height at most 5. For example, the point (2 : 2 : 1) doesn't appear in the expected output, though it certainly has height (relative and absolute) less than 125.\n\nThis doesn't address the discrepancy in the two lists, though, at least not entirely. The issue must be related to the floating point arithmetic being used for elements_of_bounded_height. The four points appearing in the \"expected\" list and not the \"for\" list have relative height exactly equal to 5, which is the bound that is being passed to the elements_of_bounded_height function. I seem to remember something like this happening when we were testing elements_of_bounded_height, where sometimes points of exact height B would appear in the output, and occasionally they would not, depending on the machine.\n\nOne last comment: Because of the floating point arithmetic involved, the output of elements_of_bounded_height cannot be guaranteed correct (as per the warning in the documentation). Probably a warning to this effect should be included in the documentation here.",
    "created_at": "2015-03-07T16:52:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-235868",
    "user": "https://trac.sagemath.org/admin/accounts/users/jdoyle"
}
```

There seems to be an issue with the way 'bound' is defined for points_of_bounded_height. If the expected bound is an absolute height bound and you want to convert to a relative height bound, you need to raise to the power (degree of number field), not 1/(degree of number field). In particular, the expected output in this example contains points with relative height at most 5. For example, the point (2 : 2 : 1) doesn't appear in the expected output, though it certainly has height (relative and absolute) less than 125.

This doesn't address the discrepancy in the two lists, though, at least not entirely. The issue must be related to the floating point arithmetic being used for elements_of_bounded_height. The four points appearing in the "expected" list and not the "for" list have relative height exactly equal to 5, which is the bound that is being passed to the elements_of_bounded_height function. I seem to remember something like this happening when we were testing elements_of_bounded_height, where sometimes points of exact height B would appear in the output, and occasionally they would not, depending on the machine.

One last comment: Because of the floating point arithmetic involved, the output of elements_of_bounded_height cannot be guaranteed correct (as per the warning in the documentation). Probably a warning to this effect should be included in the documentation here.



---

archive/issue_comments_235869.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-03-08T21:24:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-235869",
    "user": "https://github.com/bhutz"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_235870.json:
```json
{
    "body": "I've made a start here. I fixed the exponent on the bound. I added a precision parameter and the warning to the appropriate functions. I also upped the precision for the failed example, but since I can't reproduce, I can't be sure that will fix it.\n\nI guess I'll mark this as needs-review, although I'm not 100% sure I've resolved it. I won't be able to work on this for a few days if someone wants to take over in the meantime.\n\n---\nNew commits:",
    "created_at": "2015-03-08T21:24:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-235870",
    "user": "https://github.com/bhutz"
}
```

I've made a start here. I fixed the exponent on the bound. I added a precision parameter and the warning to the appropriate functions. I also upped the precision for the failed example, but since I can't reproduce, I can't be sure that will fix it.

I guess I'll mark this as needs-review, although I'm not 100% sure I've resolved it. I won't be able to work on this for a few days if someone wants to take over in the meantime.

---
New commits:



---

archive/issue_comments_235871.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-03-30T08:19:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-235871",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_235872.json:
```json
{
    "body": "Seems to fix the issue, at least. \n\nOf course it would be nice to pick the right precision automatically ...",
    "created_at": "2015-03-30T08:19:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-235872",
    "user": "https://github.com/vbraun"
}
```

Seems to fix the issue, at least. 

Of course it would be nice to pick the right precision automatically ...



---

archive/issue_comments_235873.json:
```json
{
    "body": "Thanks for checking this. I've been having trouble finding someone with a machine which can reproduce the original error.\n\nYes, there is a TODO in the enumeration of points of bounded height in number fields (from #15389) to address the precision sensitivity.",
    "created_at": "2015-03-30T13:04:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-235873",
    "user": "https://github.com/bhutz"
}
```

Thanks for checking this. I've been having trouble finding someone with a machine which can reproduce the original error.

Yes, there is a TODO in the enumeration of points of bounded height in number fields (from #15389) to address the precision sensitivity.



---

archive/issue_events_050974.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-04-14T19:43:52Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17670#event-50974"
}
```



---

archive/issue_comments_235874.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-04-14T19:43:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-235874",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_050975.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2015-04-18T09:25:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "milestone": "sage-6.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17670#event-50975"
}
```



---

archive/issue_comments_235875.json:
```json
{
    "body": "Replying to [ticket:17907 vbraun]:\n> `enum_projective_number_field` (#17386) is missing points on OSX 10.6.8, possibly other platforms.\n\n\nJust seen (with Sage 6.6) on Linux x86_64 (Haswell-E CPU), FSF GCC 4.9.2 (but not e.g. 4.4.3); patch fixes the doctest failure.",
    "created_at": "2015-04-18T09:25:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-235875",
    "user": "https://github.com/nexttime"
}
```

Replying to [ticket:17907 vbraun]:
> `enum_projective_number_field` (#17386) is missing points on OSX 10.6.8, possibly other platforms.


Just seen (with Sage 6.6) on Linux x86_64 (Haswell-E CPU), FSF GCC 4.9.2 (but not e.g. 4.4.3); patch fixes the doctest failure.
