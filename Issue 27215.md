# Issue 27215: py3: fundamental group of simplicial complexes

archive/issues_027215.json:
```json
{
    "body": "This should fix the last py3 doctest failures in src/homology.\n\nIssue created by migration from https://trac.sagemath.org/ticket/27452\n\n",
    "created_at": "2019-03-10T00:12:46Z",
    "labels": [
        "python3",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.7",
    "title": "py3: fundamental group of simplicial complexes",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27215",
    "user": "@jhpalmieri"
}
```
This should fix the last py3 doctest failures in src/homology.

Issue created by migration from https://trac.sagemath.org/ticket/27452





---

archive/issue_comments_383469.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-03-10T00:14:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27215#issuecomment-383469",
    "user": "@jhpalmieri"
}
```

New commits:



---

archive/issue_comments_383470.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-03-10T00:14:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27215#issuecomment-383470",
    "user": "@jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_383471.json:
```json
{
    "body": "I first tried something a little more complicated: first computing the minimal spanning tree, and if that raises an error, then do the stuff in this branch. That was not much faster; I tested on `simplicial_complexes.PoincareHomologyThreeSphere()` which has integers as vertices.",
    "created_at": "2019-03-10T00:16:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27215#issuecomment-383471",
    "user": "@jhpalmieri"
}
```

I first tried something a little more complicated: first computing the minimal spanning tree, and if that raises an error, then do the stuff in this branch. That was not much faster; I tested on `simplicial_complexes.PoincareHomologyThreeSphere()` which has integers as vertices.



---

archive/issue_comments_383472.json:
```json
{
    "body": "So I think there is a problem with this that is exposing another problem with `graph()`. Mainly if the result of `graph()` is an immutatble graph, then doing `G.copy()` will give another immutable.\n\n```sage\nsage: G = graphs.CycleGraph(3)\nsage: GI = G.copy(immutable=True)\nsage: G.is_immutable()\nFalse\nsage: GI.is_immutable()\nTrue\nsage: C = GI.copy()\nsage: C.is_immutable()   # This is the problem\nTrue\nsage: C.relabel({0:'a',1:'b',2:'c'})\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n...\nValueError: To relabel an immutable graph use inplace=False\n```\n\nThe result of `graph()` should be an immutable graph because it is cached, which can be easily achieved when constructing the result by giving `immutable=True` as an argument. To fix the problem here, you should do `G.copy(immutable=False)`.\n\nI would also think it would be faster to use `v_to_int` to construct `int_to_v` than redoing `enumerate(G.vertex_iterator())` because of `int_to_v` being a Python builtin type (a `dict`).\n\nI would also change the test to be more indicative of the cyclic structure:\n\n```\n-            sage: (x**5).is_one()\n-            True\n+            sage: [(x**n).is_one() for n in range(1,6)]\n+            [False, False, False, False, True]\n```\n",
    "created_at": "2019-03-10T00:45:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27215#issuecomment-383472",
    "user": "@tscrim"
}
```

So I think there is a problem with this that is exposing another problem with `graph()`. Mainly if the result of `graph()` is an immutatble graph, then doing `G.copy()` will give another immutable.

```sage
sage: G = graphs.CycleGraph(3)
sage: GI = G.copy(immutable=True)
sage: G.is_immutable()
False
sage: GI.is_immutable()
True
sage: C = GI.copy()
sage: C.is_immutable()   # This is the problem
True
sage: C.relabel({0:'a',1:'b',2:'c'})
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
...
ValueError: To relabel an immutable graph use inplace=False
```

The result of `graph()` should be an immutable graph because it is cached, which can be easily achieved when constructing the result by giving `immutable=True` as an argument. To fix the problem here, you should do `G.copy(immutable=False)`.

I would also think it would be faster to use `v_to_int` to construct `int_to_v` than redoing `enumerate(G.vertex_iterator())` because of `int_to_v` being a Python builtin type (a `dict`).

I would also change the test to be more indicative of the cyclic structure:

```
-            sage: (x**5).is_one()
-            True
+            sage: [(x**n).is_one() for n in range(1,6)]
+            [False, False, False, False, True]
```




---

archive/issue_comments_383473.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-03-10T01:28:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27215#issuecomment-383473",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_383474.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-03-10T01:29:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27215#issuecomment-383474",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_383475.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-03-10T01:32:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27215#issuecomment-383475",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_383476.json:
```json
{
    "body": "Thanks for the comments. I made those changes, plus a few others along these lines:\n\n```diff\n             True\n         \"\"\"\n         d = self._vertex_to_index\n-        return {d[v]:v for v in d}\n+        return {idx: v for v, idx in d.items()}\n \n     def _chomp_repr_(self):\n         r\"\"\"\n```\n\nThe point is that instead of doing a lot of separate dictionary lookups, it should be faster to dump it once using `items` and then convert that to a dict.",
    "created_at": "2019-03-10T01:33:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27215#issuecomment-383476",
    "user": "@jhpalmieri"
}
```

Thanks for the comments. I made those changes, plus a few others along these lines:

```diff
             True
         """
         d = self._vertex_to_index
-        return {d[v]:v for v in d}
+        return {idx: v for v, idx in d.items()}
 
     def _chomp_repr_(self):
         r"""
```

The point is that instead of doing a lot of separate dictionary lookups, it should be faster to dump it once using `items` and then convert that to a dict.



---

archive/issue_comments_383477.json:
```json
{
    "body": "It might not be a bad idea to explicitly specify `immutable=False` when creating the graph associated to a simplicial complex (since it can be changed using `add_face` or `remove_face`), or maybe set `immutable` to whatever the setting is for the simplicial complex. On another ticket, though.",
    "created_at": "2019-03-10T01:35:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27215#issuecomment-383477",
    "user": "@jhpalmieri"
}
```

It might not be a bad idea to explicitly specify `immutable=False` when creating the graph associated to a simplicial complex (since it can be changed using `add_face` or `remove_face`), or maybe set `immutable` to whatever the setting is for the simplicial complex. On another ticket, though.



---

archive/issue_comments_383478.json:
```json
{
    "body": "A bit of the downside of doing `foo.items()` is that it creates the whole list in Python2. So it is not so memory friendly. Anyways, just food for thought.\n\nYes, we can fix the `graph()` issue on another ticket.\n\nIf the patchbot comes back green, then this can be set to a positive review.",
    "created_at": "2019-03-10T01:41:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27215#issuecomment-383478",
    "user": "@tscrim"
}
```

A bit of the downside of doing `foo.items()` is that it creates the whole list in Python2. So it is not so memory friendly. Anyways, just food for thought.

Yes, we can fix the `graph()` issue on another ticket.

If the patchbot comes back green, then this can be set to a positive review.



---

archive/issue_comments_383479.json:
```json
{
    "body": "Replying to [comment:10 tscrim]:\n> A bit of the downside of doing `foo.items()` is that it creates the whole list in Python2. So it is not so memory friendly. Anyways, just food for thought.\n\nIt's a tradeoff between time and memory. Fortunately, I don't think simplicial complexes are likely to have so many vertices where it is an issue, or if they do, it's not going to be practical to compute the fundamental group.\n\n(For example, `simplicial_complexes.NotIConnectedGraphs(7,2)` has over a million simplices overall, but just 21 vertices.)",
    "created_at": "2019-03-10T02:06:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27215#issuecomment-383479",
    "user": "@jhpalmieri"
}
```

Replying to [comment:10 tscrim]:
> A bit of the downside of doing `foo.items()` is that it creates the whole list in Python2. So it is not so memory friendly. Anyways, just food for thought.

It's a tradeoff between time and memory. Fortunately, I don't think simplicial complexes are likely to have so many vertices where it is an issue, or if they do, it's not going to be practical to compute the fundamental group.

(For example, `simplicial_complexes.NotIConnectedGraphs(7,2)` has over a million simplices overall, but just 21 vertices.)



---

archive/issue_comments_383480.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-03-10T05:43:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27215#issuecomment-383480",
    "user": "@jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_383481.json:
```json
{
    "body": "You could simplify some parts of this code using `frozenset` instead of tuples for the spanning tree, the keys of `gens_dict`, and may be `gens` (not sure for that one). And also make `spanning_tree` a set.",
    "created_at": "2019-03-10T10:55:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27215#issuecomment-383481",
    "user": "@dcoudert"
}
```

You could simplify some parts of this code using `frozenset` instead of tuples for the spanning tree, the keys of `gens_dict`, and may be `gens` (not sure for that one). And also make `spanning_tree` a set.



---

archive/issue_comments_383482.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2019-03-10T19:07:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27215#issuecomment-383482",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_383483.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2019-03-10T19:07:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27215#issuecomment-383483",
    "user": "git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_383484.json:
```json
{
    "body": "Like this?",
    "created_at": "2019-03-10T19:08:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27215#issuecomment-383484",
    "user": "@jhpalmieri"
}
```

Like this?



---

archive/issue_comments_383485.json:
```json
{
    "body": "Yes. I assume that it's not possible to do it also for `gens`, right?",
    "created_at": "2019-03-10T20:05:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27215#issuecomment-383485",
    "user": "@dcoudert"
}
```

Yes. I assume that it's not possible to do it also for `gens`, right?



---

archive/issue_comments_383486.json:
```json
{
    "body": "`gens` doesn't get used much, only in these two lines:\n\n```\n        if len(gens) == 0:\n            return gap.TrivialGroup()\n        ...\n        gens_dict = {frozenset(g): i for i, g in enumerate(gens)}\n        FG = FreeGroup(len(gens), 'e')\n```\n\nSo I don't think it will make much difference if it is made up of tuples or frozensets.",
    "created_at": "2019-03-10T20:39:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27215#issuecomment-383486",
    "user": "@jhpalmieri"
}
```

`gens` doesn't get used much, only in these two lines:

```
        if len(gens) == 0:
            return gap.TrivialGroup()
        ...
        gens_dict = {frozenset(g): i for i, g in enumerate(gens)}
        FG = FreeGroup(len(gens), 'e')
```

So I don't think it will make much difference if it is made up of tuples or frozensets.



---

archive/issue_comments_383487.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-03-10T20:53:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27215#issuecomment-383487",
    "user": "@dcoudert"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_383488.json:
```json
{
    "body": "LGTM",
    "created_at": "2019-03-10T20:53:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27215#issuecomment-383488",
    "user": "@dcoudert"
}
```

LGTM



---

archive/issue_comments_383489.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-03-13T18:29:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27215#issuecomment-383489",
    "user": "@vbraun"
}
```

Resolution: fixed
