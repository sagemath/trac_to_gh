# Issue 32902: Fix sagemath_doc_html-none build failure on Cygwin

Issue created by migration from https://trac.sagemath.org/ticket/33139

Original creator: slelievre

Original creation time: 2022-01-10 06:46:53

CC:  chapoton mkoeppe slabbe slelievre

Keywords: cygwin

As reported on sage-release:

- https://groups.google.com/g/sage-release/c/gTNMEVbzb6M/m/oLwrXx6yAQAJ


---

Comment by slelievre created at 2022-01-10 22:44:30

Also observed on Linux, where `make distclean` fixed it.

- https://groups.google.com/g/sage-release/c/gTNMEVbzb6M/m/4iALmgfJAQAJ
- https://groups.google.com/g/sage-release/c/gTNMEVbzb6M/m/k152YqXPAQAJ

So this ticket's component is not "porting: Cygwin".

Maybe "build" or "documentation" or "packages: standard"?


---

Comment by slelievre created at 2022-01-10 22:44:30

Changing component from porting: Cygwin to packages: standard.


---

Comment by slelievre created at 2022-01-10 23:22:23

Changing keywords from "cygwin" to "".


---

Comment by slelievre created at 2022-01-10 23:22:23

See also ticket:33142#comment:4 and patchbot reports for #33142:

- https://patchbot.sagemath.org/ticket/33142/


---

Comment by mkoeppe created at 2022-01-12 06:11:33

I think this is "only" an incremental docbuild failure, probably nothing to be fixed here

From-scratch build of Sage on Cygwin on GH Actions succeeded in https://github.com/sagemath/sage/runs/4768915824?check_suite_focus=true - including documentation


---

Comment by slelievre created at 2022-01-12 07:55:33

In my case it was a fresh git clone. I'll try again.


---

Comment by chapoton created at 2022-01-14 20:28:45

There are persistent problems with patchbots. Somebody needs to fix them. Maybe the people that introduced "make doc-uninstall" can pick up the task ?


---

Comment by slelievre created at 2022-01-15 08:48:00

Changing keywords from "" to "cygwin".


---

Comment by slelievre created at 2022-01-15 08:48:00

New report on sage-release for Sage 9.5.rc1:

- https://groups.google.com/g/sage-release/c/8ctwsUGl6LQ/m/CeIBwxSBBwAJ


---

Comment by slelievre created at 2022-01-15 08:48:00

Changing priority from major to critical.


---

Comment by slelievre created at 2022-01-22 13:06:18

Happened again on Cygwin and Debian as reported at

- https://groups.google.com/g/sage-release/c/1YV0dNtEZz4/m/T8IAplFRAgAJ


---

Comment by slelievre created at 2022-01-26 16:29:26

This failed on Cygwin for all releases from
Sage 9.5.beta7 to Sage 9.5.rc4 for me.


---

Comment by slelievre created at 2022-01-27 14:30:26

A link with #32789 was initially suspected, but then ruled out, see:

- https://groups.google.com/g/sage-release/c/FXpakLURP_0/m/rzFhVu5nBgAJ
- ticket:32954#comment:8

For Sage 9.5.rc4, the file `logs/pkgs/sagemath_doc_html-none.log`
is as follows, up to replacing:

- `INVENTORY_REF`: `local/share/doc/sage/inventory/en/reference`
- `DOCTREES_REF`: `local/share/doc/sage/doctrees/en/reference`
- `SITE_PKGS`: `local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages`
- `SRC_REF`: `src/doc/en/reference`


```
[reference] building [inventory]: targets for 1 source files that are out of date
[reference] updating environment: [new config] 1 added, 0 changed, 0 removed
[reference] The inventory files are in INVENTORY_REF/references.
Build finished. The built documents can be found in INVENTORY_REF/references
[spkg     ] building [inventory]: targets for 354 source files that are out of date
[spkg     ] updating environment: [new config] 354 added, 0 changed, 0 removed
[spkg     ] The inventory files are in INVENTORY_REF/spkg.
Build finished. The built documents can be found in INVENTORY_REF/spkg
[manifolds] building [inventory]: targets for 84 source files that are out of date
[manifolds] updating environment: [new config] 84 added, 0 changed, 0 removed
[manifolds] The inventory files are in INVENTORY_REF/manifolds.
Build finished. The built documents can be found in INVENTORY_REF/manifolds
[polynomia] building [inventory]: targets for 62 source files that are out of date
[polynomia] updating environment: [new config] 62 added, 0 changed, 0 removed
[polynomia] The inventory files are in INVENTORY_REF/polynomial_rings.
Build finished. The built documents can be found in INVENTORY_REF/polynomial_rings
[repl     ] building [inventory]: targets for 36 source files that are out of date
[repl     ] updating environment: [new config] 36 added, 0 changed, 0 removed
[repl     ] The inventory files are in INVENTORY_REF/repl.
Build finished. The built documents can be found in INVENTORY_REF/repl
[algebras ] building [inventory]: targets for 99 source files that are out of date
[algebras ] updating environment: [new config] 99 added, 0 changed, 0 removed
[tensor_fr] building [inventory]: targets for 19 source files that are out of date
[tensor_fr] updating environment: [new config] 19 added, 0 changed, 0 removed
[tensor_fr] The inventory files are in INVENTORY_REF/tensor_free_modules.
Build finished. The built documents can be found in INVENTORY_REF/tensor_free_modules
[combinat ] building [inventory]: targets for 369 source files that are out of date
[combinat ] updating environment: [new config] 369 added, 0 changed, 0 removed
[dynamics ] building [inventory]: targets for 16 source files that are out of date
[dynamics ] updating environment: [new config] 16 added, 0 changed, 0 removed
[dynamics ] The inventory files are in INVENTORY_REF/dynamics.
Build finished. The built documents can be found in INVENTORY_REF/dynamics
[plot3d   ] building [inventory]: targets for 20 source files that are out of date
[plot3d   ] updating environment: [new config] 20 added, 0 changed, 0 removed
[plot3d   ] The inventory files are in INVENTORY_REF/plot3d.
Build finished. The built documents can be found in INVENTORY_REF/plot3d
...
[structure] building [inventory]: targets for 32 source files that are out of date
[structure] updating environment: [new config] 32 added, 0 changed, 0 removed
[structure] The inventory files are in INVENTORY_REF/structure.
Build finished. The built documents can be found in INVENTORY_REF/structure
[valuation] building [inventory]: targets for 14 source files that are out of date
[valuation] updating environment: [new config] 14 added, 0 changed, 0 removed
[valuation] The inventory files are in INVENTORY_REF/valuations.
Build finished. The built documents can be found in INVENTORY_REF/valuations
[reference] building [inventory]: targets for 1 source files that are out of date
[reference] updating environment: [new config] 1 added, 0 changed, 0 removed
[reference] Merging environment/index file
[reference]     algebras:
[reference]     arithgroup: 1 todos, 12 index, 0 citations, 11 modules
[reference]     arithmetic_curves: 12 todos, 59 index, 2 citations, 58 modules
[reference]     asymptotic: 6 todos, 8 index, 0 citations, 7 modules
[reference]     calculus: 2 todos, 38 index, 0 citations, 37 modules
[reference]     categories:
[reference]     coding:
[reference]     coercion: 0 todos, 8 index, 0 citations, 7 modules
[reference]     combinat:
[reference]     constants: 0 todos, 3 index, 0 citations, 2 modules
[reference]     cpython: 0 todos, 8 index, 0 citations, 7 modules
...
[reference]     tensor_free_modules: 2 todos, 19 index, 0 citations, 15 modules
[reference]     topology: 0 todos, 14 index, 0 citations, 13 modules
[reference]     valuations: 1 todos, 14 index, 0 citations, 13 modules
[reference] ... done (184 todos, 1670 index, 1434 citations, 1281 modules)
[reference] WARNING: Unable to fetch DOCTREES_REF/algebras/environment.pickle
[reference] WARNING: Unable to fetch DOCTREES_REF/categories/environment.pickle
[reference] WARNING: Unable to fetch DOCTREES_REF/coding/environment.pickle
[reference] WARNING: Unable to fetch DOCTREES_REF/combinat/environment.pickle
[reference] WARNING: Unable to fetch DOCTREES_REF/graphs/environment.pickle
[reference] WARNING: Unable to fetch DOCTREES_REF/groups/environment.pickle
[reference] WARNING: Unable to fetch DOCTREES_REF/knots/environment.pickle
[reference] WARNING: Unable to fetch DOCTREES_REF/libs/environment.pickle
[reference] preparing documents... skipping loading of indexes... done
[reference] SRC_REF/index.rst:35: WARNING: unknown document: categories/index
[reference] SRC_REF/index.rst:77: WARNING: unknown document: groups/index
[reference] SRC_REF/index.rst:80: WARNING: unknown document: algebras/index
[reference] SRC_REF/index.rst:85: WARNING: unknown document: combinat/index
[reference] SRC_REF/index.rst:86: WARNING: unknown document: graphs/index
[reference] SRC_REF/index.rst:90: WARNING: unknown document: coding/index
[reference] SRC_REF/index.rst:105: WARNING: unknown document: knots/index
[reference] SRC_REF/index.rst:156: WARNING: unknown document: libs/index
[reference] The inventory files are in INVENTORY_REF.
Error building the documentation.
Traceback (most recent call last):
  File "/usr/lib/python3.9/runpy.py", line 197, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/usr/lib/python3.9/runpy.py", line 87, in _run_code
    exec(code, run_globals)
  File "SITE_PKGS/sage_docbuild/__main__.py", line 2, in <module>
    main()
  File "SITE_PKGS/sage_docbuild/__init__.py", line 1729, in main
    builder()
  File "SITE_PKGS/sage_docbuild/__init__.py", line 137, in f
    runsphinx()
  File "SITE_PKGS/sage_docbuild/sphinxbuild.py", line 323, in runsphinx
    sys.stderr.raise_errors()
  File "SITE_PKGS/sage_docbuild/sphinxbuild.py", line 258, in raise_errors
    raise OSError(self._error)
OSError: WARNING: Unable to fetch DOCTREES_REF/algebras/environment.pickle 

    Note: incremental documentation builds sometimes cause spurious
    error messages. To be certain that these are real errors, run
    "make doc-clean doc-uninstall" first and try again.
make[6]: *** [Makefile:20: doc-inventory--reference_top] Error 1
make[5]: *** [Makefile:38: doc-inventory-reference] Error 2
```


What are the `environment.pickle` files
in `local/share/doc/sage/doctrees/en/reference/*`?

Why are some of them missing?


---

Comment by chapoton created at 2022-01-29 08:58:50

bump to 9.6


---

Comment by slelievre created at 2022-01-29 15:23:55

This breaks my development versions of Sage
on Cygwin, Debian, macOS, Ubuntu.

I agree Sage 9.5 needs to get out though,
and I have no clue on solving this failure.


---

Comment by slelievre created at 2022-01-31 08:51:33

~~This blocked merging a positively reviewed ticket,
see ticket:32505#comment:83.~~

Oops, no it did not. Something else caused an error
in sagemath_doc_html there.


---

Comment by @tobiasdiez created at 2022-02-08 19:40:41

I hit the same issue (on WSL2, tried to clean the doc build and error persisted). What helped for me was to demote the warning (which is then treated as an error) to a debug message.
The build seems to succeed without any issues without the pickled env file.

A very similar issue occurs also on the github workflow added in #31415.
There, sphinx (not the sage code invoking sphinx) reports the following messages:

```
[sagemath_doc_html-none] [spkg     ] loading pickled environment... failed
[sagemath_doc_html-none] [spkg     ] failed: source directory has changed
[sagemath_doc_html-none] [spkg     ] building [inventory]: targets for 355 source files that are out of date
[sagemath_doc_html-none] [spkg     ] updating environment: [new config] 355 added, 0 changed, 0 removed
```

But since there is no "Warning" prefix, these are then not upgraded to errors.

See for example, https://github.com/sagemath/sagetrac-mirror/runs/5112648667?check_suite_focus=true
----
New commits:


---

Comment by @tobiasdiez created at 2022-02-08 19:40:41

Changing status from new to needs_review.


---

Comment by slelievre created at 2022-03-10 04:58:16

Let us deal with the Cygwin failure here,
and with the Linux failure at #33488.


---

Comment by @tobiasdiez created at 2022-03-10 17:41:14

It looks like #33488 is about a different error, though, or not?

What you think about the fix here in this ticket? It solves the issue for me also on Ubuntu.


---

Comment by @WindowsSystemAdmin created at 2022-03-10 20:50:00

Can I be notified of this as well?


---

Comment by @WindowsSystemAdmin created at 2022-03-21 20:43:56

So on the latest version of sage, 9.6.beta5, the sagemath_doc_html_none did successfully build :) and now I have a functioning version of sage!!


---

Comment by @WindowsSystemAdmin created at 2022-03-21 20:45:24

Changing status from needs_review to positive_review.


---

Comment by @tobiasdiez created at 2022-03-21 20:57:48

Thanks for the review!


---

Comment by mkoeppe created at 2022-03-21 21:25:18

Full reviewer name please


---

Comment by vbraun created at 2022-03-21 23:41:25

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2022-03-21 23:41:25

Merge failure on top of:

6dbf0930e7 Trac #30845: Fixes for the conda-for-Sage-developers installation method, add GH Actions workflow

95307a68b5 Trac #33522: pythran: Update to 0.11.0

3afe1c712a Trac #33440: sage.libs.singular: Do not fail if the Singular binary is not in PATH

3cc2873986 Trac #33437: Add Lehrer-Solomon symmetric function

6e77b3fd5b Trac #33416: Colormaps and contours for complex_plot

a636498287 Trac #33407: sage -t --installed

ff2baed67c Trac #33396: removing some useless ...: in the doc

dce5f06cf9 Trac #33233: sage -t --baseline-stats-path

f06a7f845e Trac #33170: Update doctests for compatibility with ipython 8.x

2fbf359176 Trac #33156: fix wrong results & huge slowdown due to broken caching in .multiplication_by_m()

b8d91ace4f Trac #33141: Fix doctests in sage_setup and sage_docbuild for sage-on-distribution

f30a4c8b06 Trac #32942: Introduce `align_latex` option that allows latex displays aligned left or centered

39de62bca0 Trac #32429: Typos

d79b00d98a Trac #30078: Check for duplicate hyperplanes in arrangements over any base ring

a633cce6f8 Trac #33532: Doctest failure when SAGE_LIB doesn't match `.../site-packages`

9873ee5a57 Trac #33361: configure: Handle the case of SAGE_LOCAL = a system directory with gcc better

dc311dcd82 Trac #32975: Improve doctest interaction with pytest

0e4f121222 Trac #33471: Add pictures to various 2d graphics manual pages

5b20998e56 Trac #33487: Package CyLP

df50acb8cc Trac #33477: Conversion problem between multivariate Laurent polynomial ring and its field of fraction

3c80055420 Trac #33475: deTeX document titles of sage documentation

5b872c9d08 Trac #30717: add "How to cite SageMath" to FAQ

a61c15ecd6 Trac #29631: spkg-configure.m4 for linbox

55a711e3d6 Updated [SageMath](SageMath) version to 9.6.beta5



reviewer 'gh-WindowsSystemAdmin' does not look right


---

Comment by mkoeppe created at 2022-03-25 16:42:33

Changing status from needs_work to needs_review.


---

Comment by @WindowsSystemAdmin created at 2022-03-25 20:53:45

How do I change my username?


---

Comment by slelievre created at 2022-03-25 23:14:52

Your username is fine. Type in your real name
in the "Reviewers" field.


---

Comment by @WindowsSystemAdmin created at 2022-03-26 17:13:42

k


---

Comment by slelievre created at 2022-03-26 20:44:16

Thank you. And now you can set to positive review!


---

Comment by @WindowsSystemAdmin created at 2022-03-28 15:14:48

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-04-02 10:53:32

Resolution: fixed
