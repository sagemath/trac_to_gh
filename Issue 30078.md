# Issue 30078: Switch jsmol to jupyter-jsmol, make jmol optional

Issue created by migration from https://trac.sagemath.org/ticket/30315

Original creator: mkoeppe

Original creation time: 2020-08-07 18:26:49

CC:  kcrisman novoselt chapoton arojas fbissey slelievre nbruin paulmasson egourgoulhon klee enriqueartal @jcamp0x2a

Currently, jsmol is installed by the jmol spkg and then symlinked into the jupyter notebook directory. 

We should switch to https://pypi.org/project/jupyter-jsmol/ (https://github.com/fekad/jupyter-jsmol), which can be installed by standard Python tools.

Then we can downgrade `jmol` to `optional`.


---

Comment by mkoeppe created at 2020-08-08 05:50:17

(deleted)


---

Comment by mkoeppe created at 2020-08-08 05:56:39

`./sage -pip install jupyter-jsmol` installs proper nbextensions:

```
$ jupyter nbextension list
Known nbextensions:
  config dir: /Users/mkoeppe/s/sage/sage-rebasing/local/etc/jupyter/nbconfig
    notebook section
      jupyter_jsmol/extension  enabled 
      - Validating: OK
      jupyter-js-widgets/extension  enabled 
      - Validating: OK
```

The installed files can be seen in `$SAGE_LOCAL/share/jupyter/nbextensions/jupyter_jsmol/`


---

Comment by mkoeppe created at 2020-11-29 07:00:27

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-11-29 07:00:27

New commits:


---

Comment by git created at 2020-11-29 07:02:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-11-29 07:05:17

`sagetex` declares `jmol` as a dependency - what is it used for?


---

Comment by kcrisman created at 2020-11-29 21:11:58

> `sagetex` declares `jmol` as a dependency - what is it used for?

I think for generating a 3d image in its documentation, compilation of which is part of its test suite.


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Changing keywords from "" to "sd111".


---

Comment by git created at 2020-12-07 04:09:29

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-12-07 04:10:39

Replying to [comment:10 kcrisman]:
> > `sagetex` declares `jmol` as a dependency - what is it used for?
> 
> I think for generating a 3d image in its documentation, compilation of which is part of its test suite.

Thanks! I have adjusted the dependencies in #31020 (now a dependency) so that `jmol` is only treated as a dependency when `SAGE_CHECK` is active.


---

Comment by git created at 2020-12-07 04:34:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kcrisman created at 2020-12-07 13:12:25

That is not a good idea.  Because we want people to be able to build the documentation for SageTeX, which after all isn't "really" upstream.  Instead, we should see if jsmol or some other tool suffices to build 3d pictures in SageTeX, which is a very useful use case for it.  Untested = broken, and I don't think that we've ever had a dependency only in `SAGE_CHECK` before.


---

Comment by kcrisman created at 2020-12-07 13:12:53

> and I don't think that we've ever had a dependency only in `SAGE_CHECK` before.
Though my info on the build system is pretty outdated :-)


---

Comment by mkoeppe created at 2020-12-07 18:31:01

Replying to [comment:19 kcrisman]:
> > and I don't think that we've ever had a dependency only in `SAGE_CHECK` before.
> Though my info on the build system is pretty outdated :-)

Actually, we've introduced a few of these this year because the complexity of Python test frameworks has escalated and we don't want to ship all of their dependencies.  Currently, `networkx`, `rpy2`, and `sage_sws2rst` all have check-only dependencies.


---

Comment by kcrisman created at 2020-12-07 18:34:03

Interesting.  I wonder whether jsmol might be a drop-in replacement for this specific use case though. Or even Tachyon ...


---

Comment by novoselt created at 2020-12-07 20:32:00

Replying to [comment:21 kcrisman]:
> Interesting.  I wonder whether jsmol might be a drop-in replacement for this specific use case though. Or even Tachyon ... 

What's the status of generating 3D plots and saving them using threejs? I think for SageTeX it is irrelevant what is producing pictures, just show that it works well. Tachyon is not the best in this regard.


---

Comment by mkoeppe created at 2020-12-07 23:35:11

A discussion has unfolded in https://groups.google.com/g/sage-devel/c/qKqTmLzHAbg/m/6YxQ_qWUBQAJ


---

Comment by git created at 2020-12-08 01:50:02

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-12-08 01:52:26

I have narrowed this ticket to only separating the `jmol` and `jsmol` installation.


---

Comment by mkoeppe created at 2020-12-08 01:53:17

Making jmol optional, and the discussion about new technologies to create images from 3d graphics, is now on #31027.


---

Comment by @jcamp0x2a created at 2020-12-08 18:14:04

I was able to verify that JSmol still works correctly in both Jupyter and JupyterLab. However, I did notice a test failure in `src/sage/repl/ipython_kernel/install.py` due to the new deprecation warning:


```
File "src/sage/repl/ipython_kernel/install.py", line 142, in sage.repl.ipython_kernel.install.SageKernelSpec.use_local_jsmol
Failed example:
    spec.use_local_jsmol()
Expected nothing
Got:
    doctest:warning
      File "/home/joshua/sage/src/bin/sage-runtests", line 182, in <module>
        err = DC.run()
    [...]
    :
    DeprecationWarning: Symlinking jsmol is no longer necessary
    See https://trac.sagemath.org/30315 for details.
```


Also, after removing the `local/share/jsmol` folder since it is no longer needed (and wouldn't be present on a clean install), I get a couple more test failures in the same file:


```
File "src/sage/repl/ipython_kernel/install.py", line 144, in sage.repl.ipython_kernel.install.SageKernelSpec.use_local_jsmol
Failed example:
    os.path.isdir(jsmol)
Expected:
    True
Got:
    False
```


and


```
File "src/sage/repl/ipython_kernel/install.py", line 146, in sage.repl.ipython_kernel.install.SageKernelSpec.use_local_jsmol
Failed example:
    os.path.isfile(os.path.join(jsmol, "JSmol.min.js"))
Expected:
    True
Got:
    False
```



---

Comment by git created at 2020-12-09 00:53:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-09 00:55:15

Thanks. This function, after all, does not make sense any more, so there's no point in trying to go through deprecation.  I have now removed it completely (alongside with the variable `JSMOL_DIR`).


---

Comment by @jcamp0x2a created at 2020-12-09 16:41:36

Changing status from needs_review to positive_review.


---

Comment by @jcamp0x2a created at 2020-12-09 16:41:36

Looks good. JSmol still works in Jupyter and JupyterLab.


---

Comment by mkoeppe created at 2020-12-09 19:59:21

Thank you!


---

Comment by git created at 2020-12-10 00:56:37

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2020-12-10 00:56:37

Changing status from positive_review to needs_review.


---

Comment by mkoeppe created at 2020-12-10 00:57:13

Forgot to actually use #31002 - this change is necessary for correct installation on WSL


---

Comment by @jcamp0x2a created at 2020-12-10 02:01:03

Changing status from needs_review to positive_review.


---

Comment by @jcamp0x2a created at 2020-12-10 02:01:03

Replying to [comment:34 mkoeppe]:
> Forgot to actually use #31002 - this change is necessary for correct installation on WSL

Ok. I tested this on Ubuntu WSL earlier without any installation issues. If I understand #31002 correctly, the problem was occurring due to mounting Windows folders, which I'm not doing, so that's probably why I didn't run into it.

I've gone ahead and re-verified that JSmol still works in Jupyter and JupyterLab.


---

Comment by mkoeppe created at 2020-12-10 03:16:51

Thanks again!


---

Comment by vbraun created at 2020-12-13 20:30:50

Resolution: fixed
