# Issue 10686: speed up computation of T_p in characteristic p

archive/issues_010633.json:
```json
{
    "assignees": [
        "https://github.com/craigcitro"
    ],
    "body": "In characteristic p, the formula for the Hecke operator Tp is much simpler (and faster to work through) than in the general case.  It's worth having this as a special case in the code.  \n\nThe attached simple patch does this.  Here are some timings on sage-4.6.1, with a speedup factor of 9:\n\nBEFORE:\n\n```\nsage: p = 199\nsage: fp = delta_qexp(prec=p^2+1, K=GF(p))\nsage: timeit(\"tfp = hecke_operator_on_qexp(fp, p, 12)\")\n25 loops, best of 3: 22.7 ms per loop\n```\n\nAFTER:\n\n```\nsage: p = 199\nsage: fp = delta_qexp(prec=p^2+1, K=GF(p))\nsage: timeit(\"tfp = hecke_operator_on_qexp(fp, p, 12)\")\n125 loops, best of 3: 2.51 ms per loop\n```\n\n\nCC:  @loefflerd @sagetrac-mraum @JohnCremona\n\nKeywords: **hecke operator q-expansion**\n\nComponent: **modular forms**\n\nAuthor: **Alex Ghitza**\n\nReviewer: **David Loeffler**\n\nMerged: **sage-4.6.2.alpha3**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/10686_\n\n",
    "closed_at": "2011-01-27T13:15:19Z",
    "created_at": "2011-01-25T04:33:15Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20modular%20forms",
        "https://github.com/sagemath/sage/labels/p%3A%204%20%E2%80%93%20minor",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-4.6.2",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "speed up computation of T_p in characteristic p",
    "type": "issue",
    "updated_at": "2011-01-27T13:15:19Z",
    "url": "https://github.com/sagemath/sage/issues/10686",
    "user": "https://github.com/aghitza"
}
```
In characteristic p, the formula for the Hecke operator Tp is much simpler (and faster to work through) than in the general case.  It's worth having this as a special case in the code.  

The attached simple patch does this.  Here are some timings on sage-4.6.1, with a speedup factor of 9:

BEFORE:

```
sage: p = 199
sage: fp = delta_qexp(prec=p^2+1, K=GF(p))
sage: timeit("tfp = hecke_operator_on_qexp(fp, p, 12)")
25 loops, best of 3: 22.7 ms per loop
```

AFTER:

```
sage: p = 199
sage: fp = delta_qexp(prec=p^2+1, K=GF(p))
sage: timeit("tfp = hecke_operator_on_qexp(fp, p, 12)")
125 loops, best of 3: 2.51 ms per loop
```


CC:  @loefflerd @sagetrac-mraum @JohnCremona

Keywords: **hecke operator q-expansion**

Component: **modular forms**

Author: **Alex Ghitza**

Reviewer: **David Loeffler**

Merged: **sage-4.6.2.alpha3**

_Issue created by migration from https://trac.sagemath.org/ticket/10686_





---

archive/issue_events_141153.json:
```json
{
    "actor": "https://github.com/aghitza",
    "created_at": "2011-01-25T04:33:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/10686",
    "milestone_number": null,
    "milestone_title": "sage-4.6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10686#event-141153"
}
```



---

archive/issue_events_141154.json:
```json
{
    "actor": "https://github.com/aghitza",
    "created_at": "2011-01-25T04:33:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10686",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20modular%20forms",
    "label_color": "0000ff",
    "label_name": "c: modular forms",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10686#event-141154"
}
```



---

archive/issue_events_141155.json:
```json
{
    "actor": "https://github.com/aghitza",
    "created_at": "2011-01-25T04:33:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10686",
    "label": "https://github.com/sagemath/sage/labels/p%3A%204%20%E2%80%93%20minor",
    "label_color": "ffe799",
    "label_name": "p: 4 \u2013 minor",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10686#event-141155"
}
```



---

archive/issue_events_141156.json:
```json
{
    "actor": "https://github.com/aghitza",
    "created_at": "2011-01-25T04:33:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10686",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10686#event-141156"
}
```



---

archive/issue_events_141157.json:
```json
{
    "actor": "https://github.com/craigcitro",
    "created_at": "2011-01-25T04:33:15Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/10686",
    "subject": "https://github.com/aghitza",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10686#event-141157"
}
```



---

archive/issue_events_141158.json:
```json
{
    "actor": "https://github.com/aghitza",
    "created_at": "2011-01-25T04:38:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10686",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10686#event-141158"
}
```



---

archive/issue_comments_102674.json:
```json
{
    "body": "Author: **Alex Ghitza**",
    "created_at": "2011-01-25T04:38:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10686#issuecomment-102674",
    "user": "https://github.com/aghitza"
}
```

Author: **Alex Ghitza**



---

archive/issue_comments_102675.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nCc-ing some of the usual suspects in case they are looking for something quick to review :)",
    "created_at": "2011-01-25T04:38:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10686#issuecomment-102675",
    "user": "https://github.com/aghitza"
}
```

<div id="comment:1" align="right">comment:1</div>

Cc-ing some of the usual suspects in case they are looking for something quick to review :)



---

archive/issue_comments_102676.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nIs this formula valid for weight 1 forms? The fact that you're assuming that ` p**(k-1) == 0 ` worries me if `k==1`. I know we haven't implemented weight 1 cusp forms yet, but we do have weight 1 Eis series, and weight 1 cusp forms have been on the to-do list since forever.\n\nAs for a review, I'll swap you for any of #5048/#10450/#10451/#10452/#10453/#10658 :-)\n\nDavid",
    "created_at": "2011-01-25T08:19:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10686#issuecomment-102676",
    "user": "https://github.com/loefflerd"
}
```

<div id="comment:2" align="right">comment:2</div>

Is this formula valid for weight 1 forms? The fact that you're assuming that ` p**(k-1) == 0 ` worries me if `k==1`. I know we haven't implemented weight 1 cusp forms yet, but we do have weight 1 Eis series, and weight 1 cusp forms have been on the to-do list since forever.

As for a review, I'll swap you for any of #5048/#10450/#10451/#10452/#10453/#10658 :-)

David



---

archive/issue_events_141159.json:
```json
{
    "actor": "https://github.com/loefflerd",
    "created_at": "2011-01-25T08:19:28Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10686",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10686#event-141159"
}
```



---

archive/issue_events_141160.json:
```json
{
    "actor": "https://github.com/loefflerd",
    "created_at": "2011-01-25T08:19:28Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10686",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10686#event-141160"
}
```



---

archive/issue_events_141161.json:
```json
{
    "actor": "https://github.com/aghitza",
    "created_at": "2011-01-25T10:08:41Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10686",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10686#event-141161"
}
```



---

archive/issue_events_141162.json:
```json
{
    "actor": "https://github.com/aghitza",
    "created_at": "2011-01-25T10:08:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10686",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10686#event-141162"
}
```



---

archive/issue_comments_102677.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nThanks David!  You are completely right, the action on weight 1 forms is not given by the same formula.  I have modified the patch accordingly.\n\nThe already existing code should give the right result in weight 1.",
    "created_at": "2011-01-25T10:08:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10686#issuecomment-102677",
    "user": "https://github.com/aghitza"
}
```

<div id="comment:3" align="right">comment:3</div>

Thanks David!  You are completely right, the action on weight 1 forms is not given by the same formula.  I have modified the patch accordingly.

The already existing code should give the right result in weight 1.



---

archive/issue_comments_102678.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nReplying to [@loefflerd](#comment:2):\n> As for a review, I'll swap you for any of #5048/#10450/#10451/#10452/#10453/#10658 :-)\n\nI had a shot at #10450, I hope to have some more time to look at some of the others.",
    "created_at": "2011-01-25T10:10:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10686#issuecomment-102678",
    "user": "https://github.com/aghitza"
}
```

<div id="comment:4" align="right">comment:4</div>

Replying to [@loefflerd](#comment:2):
> As for a review, I'll swap you for any of #5048/#10450/#10451/#10452/#10453/#10658 :-)

I had a shot at #10450, I hope to have some more time to look at some of the others.



---

archive/issue_events_141163.json:
```json
{
    "actor": "https://github.com/loefflerd",
    "created_at": "2011-01-25T11:54:08Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10686",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10686#event-141163"
}
```



---

archive/issue_events_141164.json:
```json
{
    "actor": "https://github.com/loefflerd",
    "created_at": "2011-01-25T11:54:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10686",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10686#event-141164"
}
```



---

archive/issue_comments_102679.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nI think there's still an error for the case of non-field base rings. Sage defines the \"characteristic\" of `Zmod(N)` to be N, which leads to problems modulo prime powers:\n\n```python\nsage: E = 240*eisenstein_series_qexp(2, 1000)\nsage: hecke_operator_on_qexp(E.change_ring(Zmod(49)), 49, 2) - hecke_operator_on_qexp(E, 49, 2).change_ring(Zmod(49))\n21 + 35*q^7 + 7*q^14 + O(q^21)\n```",
    "created_at": "2011-01-25T11:54:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10686#issuecomment-102679",
    "user": "https://github.com/loefflerd"
}
```

<div id="comment:5" align="right">comment:5</div>

I think there's still an error for the case of non-field base rings. Sage defines the "characteristic" of `Zmod(N)` to be N, which leads to problems modulo prime powers:

```python
sage: E = 240*eisenstein_series_qexp(2, 1000)
sage: hecke_operator_on_qexp(E.change_ring(Zmod(49)), 49, 2) - hecke_operator_on_qexp(E, 49, 2).change_ring(Zmod(49))
21 + 35*q^7 + 7*q^14 + O(q^21)
```



---

archive/issue_comments_102680.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nWell, Z/49 does really have characteristic 49!\n\nPerhaps the simplest thing to do is just detect prime characteristic and use the special code for powers of that, only.  Surely non-prime (positive) characteristic is not used a lot, so efficiency in that case is not crucial?",
    "created_at": "2011-01-25T12:00:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10686#issuecomment-102680",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:6" align="right">comment:6</div>

Well, Z/49 does really have characteristic 49!

Perhaps the simplest thing to do is just detect prime characteristic and use the special code for powers of that, only.  Surely non-prime (positive) characteristic is not used a lot, so efficiency in that case is not crucial?



---

archive/issue_comments_102681.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nReplying to [@JohnCremona](#comment:6):\n> Well, Z/49 does really have characteristic 49!\n> \n> Perhaps the simplest thing to do is just detect prime characteristic and use the special code for powers of that, only.  Surely non-prime (positive) characteristic is not used a lot, so efficiency in that case is not crucial?\n\nAgreed. Alex, can you do a new patch?",
    "created_at": "2011-01-25T12:12:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10686#issuecomment-102681",
    "user": "https://github.com/loefflerd"
}
```

<div id="comment:7" align="right">comment:7</div>

Replying to [@JohnCremona](#comment:6):
> Well, Z/49 does really have characteristic 49!
> 
> Perhaps the simplest thing to do is just detect prime characteristic and use the special code for powers of that, only.  Surely non-prime (positive) characteristic is not used a lot, so efficiency in that case is not crucial?

Agreed. Alex, can you do a new patch?



---

archive/issue_comments_102682.json:
```json
{
    "body": "Attachment: **[trac_10686.patch.gz](https://github.com/sagemath/sage/files/ticket10686/trac_10686.patch.gz)**",
    "created_at": "2011-01-25T12:19:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10686#issuecomment-102682",
    "user": "https://github.com/aghitza"
}
```

Attachment: **[trac_10686.patch.gz](https://github.com/sagemath/sage/files/ticket10686/trac_10686.patch.gz)**



---

archive/issue_comments_102683.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nDone.  Thanks for catching this.",
    "created_at": "2011-01-25T12:20:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10686#issuecomment-102683",
    "user": "https://github.com/aghitza"
}
```

<div id="comment:8" align="right">comment:8</div>

Done.  Thanks for catching this.



---

archive/issue_events_141165.json:
```json
{
    "actor": "https://github.com/aghitza",
    "created_at": "2011-01-25T12:20:34Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10686",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10686#event-141165"
}
```



---

archive/issue_events_141166.json:
```json
{
    "actor": "https://github.com/aghitza",
    "created_at": "2011-01-25T12:20:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10686",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10686#event-141166"
}
```



---

archive/issue_comments_102684.json:
```json
{
    "body": "Reviewer: **David Loeffler**",
    "created_at": "2011-01-25T13:05:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10686#issuecomment-102684",
    "user": "https://github.com/loefflerd"
}
```

Reviewer: **David Loeffler**



---

archive/issue_events_141167.json:
```json
{
    "actor": "https://github.com/loefflerd",
    "created_at": "2011-01-25T13:05:52Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10686",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10686#event-141167"
}
```



---

archive/issue_events_141168.json:
```json
{
    "actor": "https://github.com/loefflerd",
    "created_at": "2011-01-25T13:05:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10686",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10686#event-141168"
}
```



---

archive/issue_comments_102685.json:
```json
{
    "body": "Merged: **sage-4.6.2.alpha3**",
    "created_at": "2011-01-27T13:15:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10686#issuecomment-102685",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-4.6.2.alpha3**



---

archive/issue_events_141169.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-01-27T13:15:19Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10686",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10686#event-141169"
}
```



---

archive/issue_events_141170.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-01-27T13:15:19Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/10686",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10686#event-141170"
}
```
