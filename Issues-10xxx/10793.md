# Issue 10793: Matrices can be "constructed" from matrices of wrong dimensions

archive/issues_010728.json:
```json
{
    "assignees": [
        "https://github.com/jasongrout",
        "https://github.com/williamstein"
    ],
    "body": "Let's make a matrix and use it to define a morphism:\n\n```\nsage: projection = matrix(ZZ,[[1,0,0],[0,1,0]])\nsage: projection\n[1 0 0]\n[0 1 0]\nsage: H = Hom(ZZ^3, ZZ^2)\nsage: H(projection)\nFree module morphism defined by the matrix\n[1 0]\n[0 0]\n[1 0]\nDomain: Ambient free module of rank 3 over the principal ideal domain ...\nCodomain: Ambient free module of rank 2 over the principal ideal domain ...\n```\nAs we see, the matrix of the morphism is very unlikely to be what it should be. Here is the source of the problem:\n\n```\nsage: projection.parent()\nFull MatrixSpace of 2 by 3 dense matrices over Integer Ring\nsage: M = MatrixSpace(ZZ, 3 , 2)\nsage: M\nFull MatrixSpace of 3 by 2 dense matrices over Integer Ring\nsage: M(projection)\n[1 0]\n[0 0]\n[1 0]\n```\nSo the matrix space converts the input to the matrix no matter what (same with `matrix` command, but inside morphisms matrix spaces are used). I suppose this will work any time the number of entries in the original and in the destination is matching. I think that if one really wants to do it, then this one is very welcome to insert an explicit conversion of a matrix to a list and then back to a matrix, but the above should raise exceptions.\n\n\nApply trac_10793_bug_in_matrix_construction.patch, trac_10793_fixing_existing_bugs.patch\n\n\nDepends on #11200\nDepends on #11552\n\nCC:  @rbeezer @kcrisman\n\nComponent: **linear algebra**\n\nKeywords: **sd31**\n\nAuthor: **Andrey Novoseltsev**\n\nReviewer: **Volker Braun**\n\nMerged: **sage-4.7.2.alpha2**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/10793_\n\n",
    "closed_at": "2011-08-18T22:02:18Z",
    "created_at": "2011-02-17T11:52:58Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20linear%20algebra",
        "https://github.com/sagemath/sage/labels/p%3A%20critical%20/%202",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-4.7.2",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Matrices can be \"constructed\" from matrices of wrong dimensions",
    "type": "issue",
    "updated_at": "2011-08-18T22:02:18Z",
    "url": "https://github.com/sagemath/sage/issues/10793",
    "user": "https://github.com/vbraun"
}
```
Let's make a matrix and use it to define a morphism:

```
sage: projection = matrix(ZZ,[[1,0,0],[0,1,0]])
sage: projection
[1 0 0]
[0 1 0]
sage: H = Hom(ZZ^3, ZZ^2)
sage: H(projection)
Free module morphism defined by the matrix
[1 0]
[0 0]
[1 0]
Domain: Ambient free module of rank 3 over the principal ideal domain ...
Codomain: Ambient free module of rank 2 over the principal ideal domain ...
```
As we see, the matrix of the morphism is very unlikely to be what it should be. Here is the source of the problem:

```
sage: projection.parent()
Full MatrixSpace of 2 by 3 dense matrices over Integer Ring
sage: M = MatrixSpace(ZZ, 3 , 2)
sage: M
Full MatrixSpace of 3 by 2 dense matrices over Integer Ring
sage: M(projection)
[1 0]
[0 0]
[1 0]
```
So the matrix space converts the input to the matrix no matter what (same with `matrix` command, but inside morphisms matrix spaces are used). I suppose this will work any time the number of entries in the original and in the destination is matching. I think that if one really wants to do it, then this one is very welcome to insert an explicit conversion of a matrix to a list and then back to a matrix, but the above should raise exceptions.


Apply trac_10793_bug_in_matrix_construction.patch, trac_10793_fixing_existing_bugs.patch


Depends on #11200
Depends on #11552

CC:  @rbeezer @kcrisman

Component: **linear algebra**

Keywords: **sd31**

Author: **Andrey Novoseltsev**

Reviewer: **Volker Braun**

Merged: **sage-4.7.2.alpha2**

_Issue created by migration from https://trac.sagemath.org/ticket/10793_





---

archive/issue_events_141264.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-02-17T11:52:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "milestone_number": null,
    "milestone_title": "sage-4.7.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10793#event-141264"
}
```



---

archive/issue_events_141265.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-02-17T11:52:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20algebraic%20geometry",
    "label_color": "0000ff",
    "label_name": "c: algebraic geometry",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10793#event-141265"
}
```



---

archive/issue_events_141266.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-02-17T11:52:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10793#event-141266"
}
```



---

archive/issue_events_141267.json:
```json
{
    "actor": "https://github.com/aghitza",
    "created_at": "2011-02-17T11:52:58Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "subject": "https://github.com/vbraun",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10793#event-141267"
}
```



---

archive/issue_comments_104023.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,36 +1,31 @@\n-Here I use a projection matrix to map a 3d cone to a 2d cone:\n+Let's make a matrix and use it to define a morphism:\n \n ```\n sage: projection = matrix(ZZ,[[1,0,0],[0,1,0]])\n sage: projection\n [1 0 0]\n [0 1 0]\n-sage: cone3d = Cone([(1,0,0),(0,1,0)])\n-sage: cone2d = Cone([ projection*r for r in cone3d.rays() ])\n-sage: cone2d.rays()\n-(N(0, 1), N(1, 0))\n-```\n-If you use the same matrix in `FanMorphism`, you get an unexpected result:\n-\n-```\n-sage: FanMorphism( projection, Fan([cone3d]), Fan([cone2d]) )\n-Fan morphism defined by the matrix\n+sage: H = Hom(ZZ^3, ZZ^2)\n+sage: H(projection)\n+Free module morphism defined by the matrix\n [1 0]\n [0 0]\n [1 0]\n-Domain fan: Rational polyhedral fan in 3-d lattice N\n-Codomain fan: Rational polyhedral fan in 2-d lattice N\n+Domain: Ambient free module of rank 3 over the principal ideal domain ...\n+Codomain: Ambient free module of rank 2 over the principal ideal domain ...\n ```\n-Sharp eyes reveal that the matrix is not the one I wanted; I understand that Sage expects a left matrix action.  But having gotten a matrix of the wrong shape, no error is produced. Only a nonsensical output? Expected behavior would be an error, stating that the matrix dimensions do not match.\n-\n-For reference, the correct way to construct the morphism is with the transposed matrix.\n+As we see, the matrix of the morphism is very unlikely to be what it should be. Here is the source of the problem:\n \n ```\n-sage: FanMorphism( projection.transpose(), Fan([cone3d]), Fan([cone2d]) )\n-Fan morphism defined by the matrix\n+sage: projection.parent()\n+Full MatrixSpace of 2 by 3 dense matrices over Integer Ring\n+sage: M = MatrixSpace(ZZ, 3 , 2)\n+sage: M\n+Full MatrixSpace of 3 by 2 dense matrices over Integer Ring\n+sage: M(projection)\n [1 0]\n-[0 1]\n [0 0]\n-Domain fan: Rational polyhedral fan in 3-d lattice N\n-Codomain fan: Rational polyhedral fan in 2-d lattice N\n+[1 0]\n ```\n+So the matrix space converts the input to the matrix no matter what (same with `matrix` command, but inside morphisms matrix spaces are used). I suppose this will work any time the number of entries in the original and in the destination is matching. I think that if one really wants to do it, then this one is very welcome to insert an explicit conversion of a matrix to a list and then back to a matrix, but the above should raise exceptions.\n+\n``````\n",
    "created_at": "2011-02-17T15:43:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10793#issuecomment-104023",
    "user": "https://github.com/novoselt"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,36 +1,31 @@
-Here I use a projection matrix to map a 3d cone to a 2d cone:
+Let's make a matrix and use it to define a morphism:
 
 ```
 sage: projection = matrix(ZZ,[[1,0,0],[0,1,0]])
 sage: projection
 [1 0 0]
 [0 1 0]
-sage: cone3d = Cone([(1,0,0),(0,1,0)])
-sage: cone2d = Cone([ projection*r for r in cone3d.rays() ])
-sage: cone2d.rays()
-(N(0, 1), N(1, 0))
-```
-If you use the same matrix in `FanMorphism`, you get an unexpected result:
-
-```
-sage: FanMorphism( projection, Fan([cone3d]), Fan([cone2d]) )
-Fan morphism defined by the matrix
+sage: H = Hom(ZZ^3, ZZ^2)
+sage: H(projection)
+Free module morphism defined by the matrix
 [1 0]
 [0 0]
 [1 0]
-Domain fan: Rational polyhedral fan in 3-d lattice N
-Codomain fan: Rational polyhedral fan in 2-d lattice N
+Domain: Ambient free module of rank 3 over the principal ideal domain ...
+Codomain: Ambient free module of rank 2 over the principal ideal domain ...
 ```
-Sharp eyes reveal that the matrix is not the one I wanted; I understand that Sage expects a left matrix action.  But having gotten a matrix of the wrong shape, no error is produced. Only a nonsensical output? Expected behavior would be an error, stating that the matrix dimensions do not match.
-
-For reference, the correct way to construct the morphism is with the transposed matrix.
+As we see, the matrix of the morphism is very unlikely to be what it should be. Here is the source of the problem:
 
 ```
-sage: FanMorphism( projection.transpose(), Fan([cone3d]), Fan([cone2d]) )
-Fan morphism defined by the matrix
+sage: projection.parent()
+Full MatrixSpace of 2 by 3 dense matrices over Integer Ring
+sage: M = MatrixSpace(ZZ, 3 , 2)
+sage: M
+Full MatrixSpace of 3 by 2 dense matrices over Integer Ring
+sage: M(projection)
 [1 0]
-[0 1]
 [0 0]
-Domain fan: Rational polyhedral fan in 3-d lattice N
-Codomain fan: Rational polyhedral fan in 2-d lattice N
+[1 0]
 ```
+So the matrix space converts the input to the matrix no matter what (same with `matrix` command, but inside morphisms matrix spaces are used). I suppose this will work any time the number of entries in the original and in the destination is matching. I think that if one really wants to do it, then this one is very welcome to insert an explicit conversion of a matrix to a list and then back to a matrix, but the above should raise exceptions.
+
``````




---

archive/issue_events_141268.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2011-02-17T15:43:08Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10793#event-141268"
}
```



---

archive/issue_events_141269.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2011-02-17T15:43:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20critical%20/%202",
    "label_color": "ff7700",
    "label_name": "p: critical / 2",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10793#event-141269"
}
```



---

archive/issue_events_141270.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2011-02-17T15:43:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10793#event-141270"
}
```



---

archive/issue_events_141271.json:
```json
{
    "actor": "https://github.com/aghitza",
    "created_at": "2011-02-17T15:43:08Z",
    "event": "unassigned",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "subject": "https://github.com/novoselt",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10793#event-141271"
}
```



---

archive/issue_events_141272.json:
```json
{
    "actor": "https://github.com/jasongrout",
    "created_at": "2011-02-17T15:43:08Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "subject": "https://github.com/novoselt",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10793#event-141272"
}
```



---

archive/issue_events_141273.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2011-02-17T15:43:08Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "subject": "https://github.com/novoselt",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10793#event-141273"
}
```



---

archive/issue_comments_104024.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nI have completely replaced the original Volker's description since the problem is unrelated to fan morphisms themselves.\n\nAlso I think that this is an extremely dangerous bug and will take the liberty to elevate its priority...",
    "created_at": "2011-02-17T15:43:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10793#issuecomment-104024",
    "user": "https://github.com/novoselt"
}
```

<div id="comment:1" align="right">comment:1</div>

I have completely replaced the original Volker's description since the problem is unrelated to fan morphisms themselves.

Also I think that this is an extremely dangerous bug and will take the liberty to elevate its priority...



---

archive/issue_events_141274.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2011-02-17T15:43:08Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "title_is": "Matrices can be \"constructed\" from matrices of wrong dimensions",
    "title_was": "FanMorphism defined by matrices are dangerous",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10793#event-141274"
}
```



---

archive/issue_events_141275.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2011-02-17T15:43:08Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20algebraic%20geometry",
    "label_color": "0000ff",
    "label_name": "c: algebraic geometry",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10793#event-141275"
}
```



---

archive/issue_events_141276.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2011-02-17T15:43:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20linear%20algebra",
    "label_color": "0000ff",
    "label_name": "c: linear algebra",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10793#event-141276"
}
```



---

archive/issue_comments_104025.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nSo it seems that the problem here is that in converting to an element of the matrix space, it views the entries of the matrix (or indeed, the entries of a nested list as well) as a flattened list:\n\n```\nsage: M\nFull MatrixSpace of 3 by 2 dense matrices over Integer Ring\nsage: M([[1,2,3],[4,5,6]])\n[1 2]\n[3 4]\n[5 6]\n```\n\nSo I guess you're saying that MatrixSpace shouldn't flatten the list, but instead should throw an error?",
    "created_at": "2011-02-17T16:00:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10793#issuecomment-104025",
    "user": "https://github.com/jasongrout"
}
```

<div id="comment:2" align="right">comment:2</div>

So it seems that the problem here is that in converting to an element of the matrix space, it views the entries of the matrix (or indeed, the entries of a nested list as well) as a flattened list:

```
sage: M
Full MatrixSpace of 3 by 2 dense matrices over Integer Ring
sage: M([[1,2,3],[4,5,6]])
[1 2]
[3 4]
[5 6]
```

So I guess you're saying that MatrixSpace shouldn't flatten the list, but instead should throw an error?



---

archive/issue_comments_104026.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nAround line 361 in `matrix/matrix_space.py`, we see:\n\n```\n        if isinstance(entries, (list, tuple)) and len(entries) > 0 and \\\n           sage.modules.free_module_element.is_FreeModuleElement(entries[0]):\n            #Try to determine whether or not the entries should\n            #be rows or columns\n            if rows is None:\n                #If the matrix is square, default to rows\n                if self.__ncols == self.__nrows:\n                    rows = True\n                elif len(entries[0]) == self.__ncols:\n                    rows = True\n                elif len(entries[0]) == self.__nrows:\n                    rows = False\n                else:\n                    raise ValueError, \"incorrect dimensions\"\n            \n            if self.__is_sparse:\n                e = {}\n                zero = self.base_ring()(0)\n                for i in xrange(len(entries)):\n                    for j, x in entries[i].iteritems():\n                        if x != zero:\n                            if rows:\n                                e[(i,j)] = x\n                            else:\n                                e[(j,i)] = x\n                entries = e\n            else:\n                entries = sum([v.list() for v in entries],[])\n```\n\nSo:\n\n1. I think it tries to be too intelligent about guessing whether you have rows or columns.  That leads to inconsistent behavior when you have code dealing with different matrix spaces with different dimensions.\n\n2. It indeed does flatten the list if all else fails (that's the sum([v.list()... line).  I agree that that looks dangerous as well.",
    "created_at": "2011-02-17T16:05:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10793#issuecomment-104026",
    "user": "https://github.com/jasongrout"
}
```

<div id="comment:3" align="right">comment:3</div>

Around line 361 in `matrix/matrix_space.py`, we see:

```
        if isinstance(entries, (list, tuple)) and len(entries) > 0 and \
           sage.modules.free_module_element.is_FreeModuleElement(entries[0]):
            #Try to determine whether or not the entries should
            #be rows or columns
            if rows is None:
                #If the matrix is square, default to rows
                if self.__ncols == self.__nrows:
                    rows = True
                elif len(entries[0]) == self.__ncols:
                    rows = True
                elif len(entries[0]) == self.__nrows:
                    rows = False
                else:
                    raise ValueError, "incorrect dimensions"
            
            if self.__is_sparse:
                e = {}
                zero = self.base_ring()(0)
                for i in xrange(len(entries)):
                    for j, x in entries[i].iteritems():
                        if x != zero:
                            if rows:
                                e[(i,j)] = x
                            else:
                                e[(j,i)] = x
                entries = e
            else:
                entries = sum([v.list() for v in entries],[])
```

So:

1. I think it tries to be too intelligent about guessing whether you have rows or columns.  That leads to inconsistent behavior when you have code dealing with different matrix spaces with different dimensions.

2. It indeed does flatten the list if all else fails (that's the sum([v.list()... line).  I agree that that looks dangerous as well.



---

archive/issue_comments_104027.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nReplying to [@jasongrout](#comment%3A2):\n> So it seems that the problem here is that in converting to an element of the matrix space, it views the entries of the matrix (or indeed, the entries of a nested list as well) as a flattened list:\n> \n> ```\n> sage: M\n> Full MatrixSpace of 3 by 2 dense matrices over Integer Ring\n> sage: M([[1,2,3],[4,5,6]])\n> [1 2]\n> [3 4]\n> [5 6]\n> ```\n> \n> So I guess you're saying that MatrixSpace shouldn't flatten the list, but instead should throw an error?\n\nAbsolutely! I see no reason why such flattening can make sense, so even if there some - I think they should do it explicitly.\n\nI find it a bit confusing that Sage uses right matrix action, so in the description I tend to think that `projection` itself is the matrix of the morphism, not its transpose. I suspect I am not the only one who can fall into this trap: it is accepted as an input, but some other not-very-related matrix is then used in the morphism.",
    "created_at": "2011-02-17T16:08:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10793#issuecomment-104027",
    "user": "https://github.com/novoselt"
}
```

<div id="comment:4" align="right">comment:4</div>

Replying to [@jasongrout](#comment%3A2):
> So it seems that the problem here is that in converting to an element of the matrix space, it views the entries of the matrix (or indeed, the entries of a nested list as well) as a flattened list:
> 
> ```
> sage: M
> Full MatrixSpace of 3 by 2 dense matrices over Integer Ring
> sage: M([[1,2,3],[4,5,6]])
> [1 2]
> [3 4]
> [5 6]
> ```
> 
> So I guess you're saying that MatrixSpace shouldn't flatten the list, but instead should throw an error?

Absolutely! I see no reason why such flattening can make sense, so even if there some - I think they should do it explicitly.

I find it a bit confusing that Sage uses right matrix action, so in the description I tend to think that `projection` itself is the matrix of the morphism, not its transpose. I suspect I am not the only one who can fall into this trap: it is accepted as an input, but some other not-very-related matrix is then used in the morphism.



---

archive/issue_comments_104028.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nHi Rob, this is the ticket I was talking about!",
    "created_at": "2011-06-14T16:52:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10793#issuecomment-104028",
    "user": "https://github.com/novoselt"
}
```

<div id="comment:5" align="right">comment:5</div>

Hi Rob, this is the ticket I was talking about!



---

archive/issue_comments_104029.json:
```json
{
    "body": "Attachment: **[trac_10793_bug_in_matrix_construction.patch.gz](https://github.com/sagemath/sage/files/ticket10793/trac_10793_bug_in_matrix_construction.patch.gz)**",
    "created_at": "2011-06-16T22:54:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10793#issuecomment-104029",
    "user": "https://github.com/novoselt"
}
```

Attachment: **[trac_10793_bug_in_matrix_construction.patch.gz](https://github.com/sagemath/sage/files/ticket10793/trac_10793_bug_in_matrix_construction.patch.gz)**



---

archive/issue_events_141277.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2011-06-16T22:55:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10793#event-141277"
}
```



---

archive/issue_comments_104030.json:
```json
{
    "body": "Author: **Andrey Novoseltsev**",
    "created_at": "2011-06-16T22:55:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10793#issuecomment-104030",
    "user": "https://github.com/novoselt"
}
```

Author: **Andrey Novoseltsev**



---

archive/issue_comments_104031.json:
```json
{
    "body": "Changed keywords from none to **sd31**",
    "created_at": "2011-06-16T22:56:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10793#issuecomment-104031",
    "user": "https://github.com/novoselt"
}
```

Changed keywords from none to **sd31**



---

archive/issue_comments_104032.json:
```json
{
    "body": "Work Issues: **doctest failures**",
    "created_at": "2011-06-16T23:04:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10793#issuecomment-104032",
    "user": "https://github.com/novoselt"
}
```

Work Issues: **doctest failures**



---

archive/issue_comments_104033.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nThere are doctest failures that have to be addressed. I suspect that all places that are affected were just kind of wrong. For Nx1 and 1xN matrices nothing too horrible is going on, hopefully there are no other cases.",
    "created_at": "2011-06-16T23:04:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10793#issuecomment-104033",
    "user": "https://github.com/novoselt"
}
```

<div id="comment:8" align="right">comment:8</div>

There are doctest failures that have to be addressed. I suspect that all places that are affected were just kind of wrong. For Nx1 and 1xN matrices nothing too horrible is going on, hopefully there are no other cases.



---

archive/issue_events_141278.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2011-06-16T23:04:53Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10793#event-141278"
}
```



---

archive/issue_events_141279.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2011-06-16T23:04:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10793#event-141279"
}
```



---

archive/issue_comments_104034.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nHere is the list of offenders:\n\n```\n\tsage -t -long devel/sage-main/sage/crypto/mq/sr.py # 15 doctests failed\n\tsage -t -long devel/sage-main/sage/interfaces/sage0.py # 2 doctests failed\n\tsage -t -long devel/sage-main/sage/crypto/mq/mpolynomialsystem.py # 50 doctests failed\n\tsage -t -long devel/sage-main/sage/geometry/fan_morphism.py # 4 doctests failed\n\tsage -t -long devel/sage-main/sage/rings/polynomial/multi_polynomial_sequence.py # 33 doctests failed\n\tsage -t -long devel/sage-main/sage/categories/map.pyx # 16 doctests failed\n\tsage -t -long devel/sage-main/sage/interfaces/magma.py # 2 doctests failed\n\tsage -t -long devel/sage-main/sage/modules/matrix_morphism.py # 9 doctests failed\n```\n\nIMHO, all these files are full of bugs!",
    "created_at": "2011-06-17T00:02:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10793#issuecomment-104034",
    "user": "https://github.com/novoselt"
}
```

<div id="comment:9" align="right">comment:9</div>

Here is the list of offenders:

```
	sage -t -long devel/sage-main/sage/crypto/mq/sr.py # 15 doctests failed
	sage -t -long devel/sage-main/sage/interfaces/sage0.py # 2 doctests failed
	sage -t -long devel/sage-main/sage/crypto/mq/mpolynomialsystem.py # 50 doctests failed
	sage -t -long devel/sage-main/sage/geometry/fan_morphism.py # 4 doctests failed
	sage -t -long devel/sage-main/sage/rings/polynomial/multi_polynomial_sequence.py # 33 doctests failed
	sage -t -long devel/sage-main/sage/categories/map.pyx # 16 doctests failed
	sage -t -long devel/sage-main/sage/interfaces/magma.py # 2 doctests failed
	sage -t -long devel/sage-main/sage/modules/matrix_morphism.py # 9 doctests failed
```

IMHO, all these files are full of bugs!



---

archive/issue_events_141280.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2011-06-17T00:34:48Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10793#event-141280"
}
```



---

archive/issue_events_141281.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2011-06-17T00:34:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10793#event-141281"
}
```



---

archive/issue_comments_104035.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nOK, it turned out to be not as scary as it seemed to me originally. Most of the errors were due to forgetting that matrices act from the right. In crypto I have added explicit conversion of matrices to lists since it seems that they wanted it. I don't understand that code to make sure that this is indeed correct, but at the very least I didn't introduce a new bug ;-)",
    "created_at": "2011-06-17T00:34:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10793#issuecomment-104035",
    "user": "https://github.com/novoselt"
}
```

<div id="comment:10" align="right">comment:10</div>

OK, it turned out to be not as scary as it seemed to me originally. Most of the errors were due to forgetting that matrices act from the right. In crypto I have added explicit conversion of matrices to lists since it seems that they wanted it. I don't understand that code to make sure that this is indeed correct, but at the very least I didn't introduce a new bug ;-)



---

archive/issue_comments_104036.json:
```json
{
    "body": "Changed work issues from **doctest failures** to none",
    "created_at": "2011-06-17T00:34:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10793#issuecomment-104036",
    "user": "https://github.com/novoselt"
}
```

Changed work issues from **doctest failures** to none



---

archive/issue_comments_104037.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nPatches should apply fine on top of sage-4.7.1.alpha4, as #11200 (and other patches modifying fan morphisms) was merged.",
    "created_at": "2011-07-06T00:15:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10793#issuecomment-104037",
    "user": "https://github.com/novoselt"
}
```

<div id="comment:11" align="right">comment:11</div>

Patches should apply fine on top of sage-4.7.1.alpha4, as #11200 (and other patches modifying fan morphisms) was merged.



---

archive/issue_comments_104038.json:
```json
{
    "body": "Dependencies: **#11200**",
    "created_at": "2011-07-06T00:15:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10793#issuecomment-104038",
    "user": "https://github.com/novoselt"
}
```

Dependencies: **#11200**



---

archive/issue_events_141282.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-08-14T02:58:55Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10793#event-141282"
}
```



---

archive/issue_events_141283.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-08-14T02:58:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10793#event-141283"
}
```



---

archive/issue_comments_104039.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -29,3 +29,6 @@\n ```\n So the matrix space converts the input to the matrix no matter what (same with `matrix` command, but inside morphisms matrix spaces are used). I suppose this will work any time the number of entries in the original and in the destination is matching. I think that if one really wants to do it, then this one is very welcome to insert an explicit conversion of a matrix to a list and then back to a matrix, but the above should raise exceptions.\n \n+\n+Apply trac_10793_bug_in_matrix_construction.patch, trac_10793_fixing_existing_bugs.patch\n+\n``````\n",
    "created_at": "2011-08-14T02:58:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10793#issuecomment-104039",
    "user": "https://github.com/vbraun"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -29,3 +29,6 @@
 ```
 So the matrix space converts the input to the matrix no matter what (same with `matrix` command, but inside morphisms matrix spaces are used). I suppose this will work any time the number of entries in the original and in the destination is matching. I think that if one really wants to do it, then this one is very welcome to insert an explicit conversion of a matrix to a list and then back to a matrix, but the above should raise exceptions.
 
+
+Apply trac_10793_bug_in_matrix_construction.patch, trac_10793_fixing_existing_bugs.patch
+
``````




---

archive/issue_events_141284.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-08-14T02:58:55Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "milestone_number": null,
    "milestone_title": "sage-4.7.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10793#event-141284"
}
```



---

archive/issue_events_141285.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-08-14T02:58:55Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "milestone_number": null,
    "milestone_title": "sage-4.7.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10793#event-141285"
}
```



---

archive/issue_comments_104040.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nI totally forgot that we haven't merged this ticket yet. Applies fine on Sage-4.7.1.rc2. Positive review.",
    "created_at": "2011-08-14T02:58:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10793#issuecomment-104040",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:13" align="right">comment:13</div>

I totally forgot that we haven't merged this ticket yet. Applies fine on Sage-4.7.1.rc2. Positive review.



---

archive/issue_comments_104041.json:
```json
{
    "body": "Reviewer: **Volker Braun**",
    "created_at": "2011-08-14T02:58:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10793#issuecomment-104041",
    "user": "https://github.com/vbraun"
}
```

Reviewer: **Volker Braun**



---

archive/issue_events_141286.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-08-17T20:34:25Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10793#event-141286"
}
```



---

archive/issue_events_141287.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-08-17T20:34:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10793#event-141287"
}
```



---

archive/issue_comments_104042.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nThis patch conflicts with #11552.  Since the latter is older, I propose that this patch is rebased to #11552.",
    "created_at": "2011-08-17T20:34:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10793#issuecomment-104042",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:14" align="right">comment:14</div>

This patch conflicts with #11552.  Since the latter is older, I propose that this patch is rebased to #11552.



---

archive/issue_events_141288.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2011-08-17T21:41:13Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10793#event-141288"
}
```



---

archive/issue_events_141289.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2011-08-17T21:41:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10793#event-141289"
}
```



---

archive/issue_comments_104043.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nAttachment: **[trac_10793_fixing_existing_bugs.patch.gz](https://github.com/sagemath/sage/files/ticket10793/trac_10793_fixing_existing_bugs.patch.gz)**\n\nRebased on top of #11552, needs review.",
    "created_at": "2011-08-17T21:41:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10793#issuecomment-104043",
    "user": "https://github.com/novoselt"
}
```

<div id="comment:15" align="right">comment:15</div>

Attachment: **[trac_10793_fixing_existing_bugs.patch.gz](https://github.com/sagemath/sage/files/ticket10793/trac_10793_fixing_existing_bugs.patch.gz)**

Rebased on top of #11552, needs review.



---

archive/issue_comments_104044.json:
```json
{
    "body": "Changed dependencies from **#11200** to **#11200, #11552**",
    "created_at": "2011-08-17T21:41:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10793#issuecomment-104044",
    "user": "https://github.com/novoselt"
}
```

Changed dependencies from **#11200** to **#11200, #11552**



---

archive/issue_comments_104045.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nI think that if a rebase is straightforward (ie there is no real change to code), then it does not need to be reviewed.  I can't tell here, since the rebased patch replaced the old patch.\n\nNo matter - I've applied it and done minimal tests.  All looks good.  I'm running all tests right now and then will flip to positive review.\n\nI'm glad this got fixed.  While doing work on free module morphisms I ran into this frequently, where domains and codomains got confused, and so on.  I'm surprised it survived this long.  Thanks Volker and Andrey for the fix!\n\nRob",
    "created_at": "2011-08-17T23:46:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10793#issuecomment-104045",
    "user": "https://github.com/rbeezer"
}
```

<div id="comment:16" align="right">comment:16</div>

I think that if a rebase is straightforward (ie there is no real change to code), then it does not need to be reviewed.  I can't tell here, since the rebased patch replaced the old patch.

No matter - I've applied it and done minimal tests.  All looks good.  I'm running all tests right now and then will flip to positive review.

I'm glad this got fixed.  While doing work on free module morphisms I ran into this frequently, where domains and codomains got confused, and so on.  I'm surprised it survived this long.  Thanks Volker and Andrey for the fix!

Rob



---

archive/issue_comments_104046.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nIt was straightforward, your patch added spaces after commas in two lines that I have altered...",
    "created_at": "2011-08-18T00:01:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10793#issuecomment-104046",
    "user": "https://github.com/novoselt"
}
```

<div id="comment:17" align="right">comment:17</div>

It was straightforward, your patch added spaces after commas in two lines that I have altered...



---

archive/issue_events_141290.json:
```json
{
    "actor": "https://github.com/rbeezer",
    "created_at": "2011-08-18T00:05:41Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10793#event-141290"
}
```



---

archive/issue_events_141291.json:
```json
{
    "actor": "https://github.com/rbeezer",
    "created_at": "2011-08-18T00:05:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10793#event-141291"
}
```



---

archive/issue_comments_104047.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nSorry.  ;-)  Thanks for the rebase.  Passes all tests.\n\nRob",
    "created_at": "2011-08-18T00:05:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10793#issuecomment-104047",
    "user": "https://github.com/rbeezer"
}
```

<div id="comment:18" align="right">comment:18</div>

Sorry.  ;-)  Thanks for the rebase.  Passes all tests.

Rob



---

archive/issue_events_141292.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-08-18T22:02:18Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10793#event-141292"
}
```



---

archive/issue_events_141293.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-08-18T22:02:18Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10793#event-141293"
}
```



---

archive/issue_comments_104048.json:
```json
{
    "body": "Merged: **sage-4.7.2.alpha2**",
    "created_at": "2011-08-18T22:02:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10793",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10793#issuecomment-104048",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-4.7.2.alpha2**
