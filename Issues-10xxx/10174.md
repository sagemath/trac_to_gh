# Issue 10174: relative norm and trace in relative number fields are slow

archive/issues_010173.json:
```json
{
    "body": "There seems to be no relative_norm or absolute_norm method for elements of relative number fields (while there is for ideals). norm() works with an optional base parameter, which can be set to the base field for obtaining the relative norm.\n\nHowever it's dog slow.\n\n```\nsage: K.<v>=NumberField(x^4 + 514*x^2 + 64321)\nsage: L.<w>,e=K.galois_closure(map=True)\nsage: R.<r,v>=L.relativize(e)\nsage: time _=r.norm(K)\nCPU times: user 0.44 s, sys: 0.00 s, total: 0.44 s\nWall time: 0.45 s\n```\n\nThe attached patch changes the matrix() method to identify the base field as a trivial case, so that r.norm(K) computes the relative norm quickly:\n\n```\nsage: K.<v>=NumberField(x^4 + 514*x^2 + 64321)\nsage: L.<w>,e=K.galois_closure(map=True)\nsage: R.<r,v>=L.relativize(e)\nsage: time _=r.norm(K)\nCPU times: user 0.00 s, sys: 0.00 s, total: 0.00 s\nWall time: 0.00 s\n```\n\nApply (in order)\n\nrelative_norm.5.patch\n\ncorrect_doc_typo.patch\n\nAssignee: @loefflerd\n\nKeywords: Efficiency, number field, matrix\n\nResolution: fixed\n\nAuthor: Emmanuel Thome\n\nReviewer: Luis Felipe Tabera Alonso\n\nMerged: sage-4.6.1.alpha0\n\nIssue created by migration from https://trac.sagemath.org/ticket/10174\n\n",
    "closed_at": "2010-11-01T10:18:04Z",
    "created_at": "2010-10-26T12:39:44Z",
    "labels": [
        "component: number fields",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.6.1",
    "title": "relative norm and trace in relative number fields are slow",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10174",
    "user": "https://github.com/emmanuelthome"
}
```
There seems to be no relative_norm or absolute_norm method for elements of relative number fields (while there is for ideals). norm() works with an optional base parameter, which can be set to the base field for obtaining the relative norm.

However it's dog slow.

```
sage: K.<v>=NumberField(x^4 + 514*x^2 + 64321)
sage: L.<w>,e=K.galois_closure(map=True)
sage: R.<r,v>=L.relativize(e)
sage: time _=r.norm(K)
CPU times: user 0.44 s, sys: 0.00 s, total: 0.44 s
Wall time: 0.45 s
```

The attached patch changes the matrix() method to identify the base field as a trivial case, so that r.norm(K) computes the relative norm quickly:

```
sage: K.<v>=NumberField(x^4 + 514*x^2 + 64321)
sage: L.<w>,e=K.galois_closure(map=True)
sage: R.<r,v>=L.relativize(e)
sage: time _=r.norm(K)
CPU times: user 0.00 s, sys: 0.00 s, total: 0.00 s
Wall time: 0.00 s
```

Apply (in order)

relative_norm.5.patch

correct_doc_typo.patch

Assignee: @loefflerd

Keywords: Efficiency, number field, matrix

Resolution: fixed

Author: Emmanuel Thome

Reviewer: Luis Felipe Tabera Alonso

Merged: sage-4.6.1.alpha0

Issue created by migration from https://trac.sagemath.org/ticket/10174





---

archive/issue_comments_121901.json:
```json
{
    "body": "proposed patch",
    "created_at": "2010-10-26T12:42:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10174#issuecomment-121901",
    "user": "https://github.com/emmanuelthome"
}
```

proposed patch



---

archive/issue_comments_121902.json:
```json
{
    "body": "Changing status from new to needs_work.",
    "created_at": "2010-10-26T13:52:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10174#issuecomment-121902",
    "user": "https://github.com/lftabera"
}
```

Changing status from new to needs_work.



---

archive/issue_comments_121903.json:
```json
{
    "body": "<a id='comment:1'></a>\nAttachment [relative_norm.patch](tarball://root/attachments/some-uuid/ticket10174/relative_norm.patch) by @lftabera created at 2010-10-26 13:52:25\n\nThis will also improve the trace in the important case where the field is the base field.\n\nI think I would call self.base_ring() instead of self.parent().base_field()\n\nI wonder if this can be further improved. For example if base equals self.parent() the returning 1x1 matrix should be instantaneous (although this is  a very corner case).\n\nAlso, you need to add a doctest for the change.",
    "created_at": "2010-10-26T13:52:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10174#issuecomment-121903",
    "user": "https://github.com/lftabera"
}
```

<a id='comment:1'></a>
Attachment [relative_norm.patch](tarball://root/attachments/some-uuid/ticket10174/relative_norm.patch) by @lftabera created at 2010-10-26 13:52:25

This will also improve the trace in the important case where the field is the base field.

I think I would call self.base_ring() instead of self.parent().base_field()

I wonder if this can be further improved. For example if base equals self.parent() the returning 1x1 matrix should be instantaneous (although this is  a very corner case).

Also, you need to add a doctest for the change.



---

archive/issue_comments_121904.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -2,19 +2,22 @@\n \n However it's dog slow.\n \n+```\n sage: K.<v>=NumberField(x^4 + 514*x^2 + 64321)\n sage: L.<w>,e=K.galois_closure(map=True)\n sage: R.<r,v>=L.relativize(e)\n sage: time _=r.norm(K)\n CPU times: user 0.44 s, sys: 0.00 s, total: 0.44 s\n Wall time: 0.45 s\n+```\n \n The attached patch changes the matrix() method to identify the base field as a trivial case, so that r.norm(K) computes the relative norm quickly:\n \n+```\n sage: K.<v>=NumberField(x^4 + 514*x^2 + 64321)\n sage: L.<w>,e=K.galois_closure(map=True)\n sage: R.<r,v>=L.relativize(e)\n sage: time _=r.norm(K)\n CPU times: user 0.00 s, sys: 0.00 s, total: 0.00 s\n Wall time: 0.00 s\n-\n+```\n``````\n",
    "created_at": "2010-10-26T13:55:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10174#issuecomment-121904",
    "user": "https://github.com/lftabera"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -2,19 +2,22 @@
 
 However it's dog slow.
 
+```
 sage: K.<v>=NumberField(x^4 + 514*x^2 + 64321)
 sage: L.<w>,e=K.galois_closure(map=True)
 sage: R.<r,v>=L.relativize(e)
 sage: time _=r.norm(K)
 CPU times: user 0.44 s, sys: 0.00 s, total: 0.44 s
 Wall time: 0.45 s
+```
 
 The attached patch changes the matrix() method to identify the base field as a trivial case, so that r.norm(K) computes the relative norm quickly:
 
+```
 sage: K.<v>=NumberField(x^4 + 514*x^2 + 64321)
 sage: L.<w>,e=K.galois_closure(map=True)
 sage: R.<r,v>=L.relativize(e)
 sage: time _=r.norm(K)
 CPU times: user 0.00 s, sys: 0.00 s, total: 0.00 s
 Wall time: 0.00 s
-
+```
``````




---

archive/issue_comments_121905.json:
```json
{
    "body": "Attachment [relative_norm.2.patch](tarball://root/attachments/some-uuid/ticket10174/relative_norm.2.patch) by @emmanuelthome created at 2010-10-26 14:28:05",
    "created_at": "2010-10-26T14:28:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10174#issuecomment-121905",
    "user": "https://github.com/emmanuelthome"
}
```

Attachment [relative_norm.2.patch](tarball://root/attachments/some-uuid/ticket10174/relative_norm.2.patch) by @emmanuelthome created at 2010-10-26 14:28:05



---

archive/issue_comments_121906.json:
```json
{
    "body": "<a id='comment:3'></a>\nAttachment [relative_norm.3.patch](tarball://root/attachments/some-uuid/ticket10174/relative_norm.3.patch) by @emmanuelthome created at 2010-10-26 14:44:17\n\nReplying to [lftabera](#comment%3A1):\n> This will also improve the trace in the important case where the field is the base field.\n\n\nyes indeed.\n \n> I think I would call self.base_ring() instead of self.parent().base_field()\n\n\ndone\n\n> I wonder if this can be further improved. For example if base equals self.parent() the returning 1x1 matrix should be instantaneous (although this is  a very corner case).\n\n\nindeed. I considered at first it wasn't worth the trouble, but it's so ridiculously expensive that the 1-line additional diff is worth it, I believe.\n\n> Also, you need to add a doctest for the change.\n\n\nSure, done. However there's no difference in functionality beyond speed.\n\nE.",
    "created_at": "2010-10-26T14:44:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10174#issuecomment-121906",
    "user": "https://github.com/emmanuelthome"
}
```

<a id='comment:3'></a>
Attachment [relative_norm.3.patch](tarball://root/attachments/some-uuid/ticket10174/relative_norm.3.patch) by @emmanuelthome created at 2010-10-26 14:44:17

Replying to [lftabera](#comment%3A1):
> This will also improve the trace in the important case where the field is the base field.


yes indeed.
 
> I think I would call self.base_ring() instead of self.parent().base_field()


done

> I wonder if this can be further improved. For example if base equals self.parent() the returning 1x1 matrix should be instantaneous (although this is  a very corner case).


indeed. I considered at first it wasn't worth the trouble, but it's so ridiculously expensive that the 1-line additional diff is worth it, I believe.

> Also, you need to add a doctest for the change.


Sure, done. However there's no difference in functionality beyond speed.

E.



---

archive/issue_events_038969.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/10174",
    "rename": {
        "from": "relative norm in relative number fields is slow",
        "to": "relative norm and trace in relative number fields are slow"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10174#event-38969"
}
```



---

archive/issue_comments_121907.json:
```json
{
    "body": "<a id='comment:4'></a>\nAttachment [relative_norm.4.patch](tarball://root/attachments/some-uuid/ticket10174/relative_norm.4.patch) by @lftabera created at 2010-10-27 08:42:00\n\nNote that the code you have added for the case base = R is never executed. You are comparing base which is (presumably) a field with self which is a NumberFieldElement.\n\nAlso the code for the case **base is self.parent()** is wrong, it will not work in the following case:\n\n```\nsage: f = R.random_element()\nsage: matrix(1,1,[f]) == f.matrix(R)\nFalse\n``` \n\nI would also add a doctest for a random element as f above.\n\nOne last comment. In the doctest you write\n\n```\nsage: K.<v>=NumberField(QQ['x']([64321, 0, 514, 0, 1]))\n```\n\nwhile correct, it can be confusing for the nonexperienced reader. Would it not be more convenient something like?\n\n```\nsage: x = QQ['x'].gen()\nsage: K.<v>=NumberField(QQ[x](x^4 + 514*x^2 + 64321))\nsage: R.<r>=NumberField(K[x](x^2 + 4*v*x + 5*v^2 + 514))\n```\n\nI could make the changes myself, but I prefer not to change the patch to give later a faster possitive review.",
    "created_at": "2010-10-27T08:42:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10174#issuecomment-121907",
    "user": "https://github.com/lftabera"
}
```

<a id='comment:4'></a>
Attachment [relative_norm.4.patch](tarball://root/attachments/some-uuid/ticket10174/relative_norm.4.patch) by @lftabera created at 2010-10-27 08:42:00

Note that the code you have added for the case base = R is never executed. You are comparing base which is (presumably) a field with self which is a NumberFieldElement.

Also the code for the case **base is self.parent()** is wrong, it will not work in the following case:

```
sage: f = R.random_element()
sage: matrix(1,1,[f]) == f.matrix(R)
False
``` 

I would also add a doctest for a random element as f above.

One last comment. In the doctest you write

```
sage: K.<v>=NumberField(QQ['x']([64321, 0, 514, 0, 1]))
```

while correct, it can be confusing for the nonexperienced reader. Would it not be more convenient something like?

```
sage: x = QQ['x'].gen()
sage: K.<v>=NumberField(QQ[x](x^4 + 514*x^2 + 64321))
sage: R.<r>=NumberField(K[x](x^2 + 4*v*x + 5*v^2 + 514))
```

I could make the changes myself, but I prefer not to change the patch to give later a faster possitive review.



---

archive/issue_comments_121908.json:
```json
{
    "body": "Changing author from \"\" to \"Emmanuel Thome\"",
    "created_at": "2010-10-27T08:42:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10174#issuecomment-121908",
    "user": "https://github.com/lftabera"
}
```

Changing author from "" to "Emmanuel Thome"



---

archive/issue_comments_121909.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -21,3 +21,5 @@\n CPU times: user 0.00 s, sys: 0.00 s, total: 0.00 s\n Wall time: 0.00 s\n ```\n+\n+When you are done, mark the ticket as needing review to advertise the potential reviewers that they should take a look at the patch.\n``````\n",
    "created_at": "2010-10-27T08:42:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10174#issuecomment-121909",
    "user": "https://github.com/lftabera"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -21,3 +21,5 @@
 CPU times: user 0.00 s, sys: 0.00 s, total: 0.00 s
 Wall time: 0.00 s
 ```
+
+When you are done, mark the ticket as needing review to advertise the potential reviewers that they should take a look at the patch.
``````




---

archive/issue_comments_121910.json:
```json
{
    "body": "Attachment [relative_norm.5.patch](tarball://root/attachments/some-uuid/ticket10174/relative_norm.5.patch) by @emmanuelthome created at 2010-10-27 09:19:01",
    "created_at": "2010-10-27T09:19:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10174#issuecomment-121910",
    "user": "https://github.com/emmanuelthome"
}
```

Attachment [relative_norm.5.patch](tarball://root/attachments/some-uuid/ticket10174/relative_norm.5.patch) by @emmanuelthome created at 2010-10-27 09:19:01



---

archive/issue_comments_121911.json:
```json
{
    "body": "<a id='comment:5'></a>\nYou are right, sorry for the buggy code. That one should be better.",
    "created_at": "2010-10-27T09:20:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10174#issuecomment-121911",
    "user": "https://github.com/emmanuelthome"
}
```

<a id='comment:5'></a>
You are right, sorry for the buggy code. That one should be better.



---

archive/issue_comments_121912.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2010-10-27T09:36:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10174#issuecomment-121912",
    "user": "https://github.com/emmanuelthome"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_events_038970.json:
```json
{
    "actor": "https://github.com/lftabera",
    "created_at": "2010-10-27T15:39:43Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10174",
    "milestone": "sage-4.6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10174#event-38970"
}
```



---

archive/issue_comments_121913.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2010-10-27T15:39:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10174#issuecomment-121913",
    "user": "https://github.com/lftabera"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_121914.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Luis Felipe Tabera\"",
    "created_at": "2010-10-27T15:39:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10174#issuecomment-121914",
    "user": "https://github.com/lftabera"
}
```

Changing reviewer from "" to "Luis Felipe Tabera"



---

archive/issue_comments_121915.json:
```json
{
    "body": "<a id='comment:7'></a>\nAttachment [correct_doc_typo.patch](tarball://root/attachments/some-uuid/ticket10174/correct_doc_typo.patch) by @lftabera created at 2010-10-27 15:39:43\n\nThe patch applies cleanly and passes all doctests.\n\nThe main advantage is that the result of matrix is cached for the base_field() so you do not have to recompute it. However, when casting directly matrix(self.base_ring()) then caching was not taken into account and the method to compute the matrix is harder. Thome's patch corrects this. The case matrix(self.parent()) is also taken into account separately.\n\nI have added another patch that allows the documentation to build without problems. But, since it is a trivial typo in thome's patch I feel I can give a possitive review.",
    "created_at": "2010-10-27T15:39:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10174#issuecomment-121915",
    "user": "https://github.com/lftabera"
}
```

<a id='comment:7'></a>
Attachment [correct_doc_typo.patch](tarball://root/attachments/some-uuid/ticket10174/correct_doc_typo.patch) by @lftabera created at 2010-10-27 15:39:43

The patch applies cleanly and passes all doctests.

The main advantage is that the result of matrix is cached for the base_field() so you do not have to recompute it. However, when casting directly matrix(self.base_ring()) then caching was not taken into account and the method to compute the matrix is harder. Thome's patch corrects this. The case matrix(self.parent()) is also taken into account separately.

I have added another patch that allows the documentation to build without problems. But, since it is a trivial typo in thome's patch I feel I can give a possitive review.



---

archive/issue_comments_121916.json:
```json
{
    "body": "Changing keywords from \"\" to \"Efficiency, number field, matrix\".",
    "created_at": "2010-10-27T15:39:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10174#issuecomment-121916",
    "user": "https://github.com/lftabera"
}
```

Changing keywords from "" to "Efficiency, number field, matrix".



---

archive/issue_comments_121917.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -22,4 +22,8 @@\n Wall time: 0.00 s\n ```\n \n-When you are done, mark the ticket as needing review to advertise the potential reviewers that they should take a look at the patch.\n+Apply (in order)\n+\n+relative_norm.5.patch\n+\n+correct_doc_typo.patch\n``````\n",
    "created_at": "2010-10-27T15:39:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10174#issuecomment-121917",
    "user": "https://github.com/lftabera"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -22,4 +22,8 @@
 Wall time: 0.00 s
 ```
 
-When you are done, mark the ticket as needing review to advertise the potential reviewers that they should take a look at the patch.
+Apply (in order)
+
+relative_norm.5.patch
+
+correct_doc_typo.patch
``````




---

archive/issue_comments_121918.json:
```json
{
    "body": "Changing merged from \"\" to \"sage-4.6.1.alpha0\"",
    "created_at": "2010-11-01T10:18:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10174#issuecomment-121918",
    "user": "https://github.com/jdemeyer"
}
```

Changing merged from "" to "sage-4.6.1.alpha0"



---

archive/issue_comments_121919.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2010-11-01T10:18:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10174#issuecomment-121919",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_038971.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2010-11-01T10:18:04Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/10174",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10174#event-38971"
}
```



---

archive/issue_comments_121920.json:
```json
{
    "body": "Changing reviewer from \"Luis Felipe Tabera\" to \"Luis Felipe Tabera Alonso\"",
    "created_at": "2011-01-12T17:31:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10174#issuecomment-121920",
    "user": "https://github.com/jdemeyer"
}
```

Changing reviewer from "Luis Felipe Tabera" to "Luis Felipe Tabera Alonso"
