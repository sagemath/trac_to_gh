# Issue 10469: Don't (effectively) source sage-env more than once

archive/issues_010416.json:
```json
{
    "body": "This can currently happen because\n\n* some scripts source it themselves (like e.g. at least `sage-spkg`, which is necessary since `sage-spkg` isn't always called through `sage-sage`, which also sources it),\n\n* some receipts in the top-level `Makefile` source it before some other script is called through `sage-sage`,\n\n* `sage-sage` itself or other (e.g. Python) code may run `sage ...` commands such that `sage-sage` is then called recursively, again sourcing `sage-env`.\n\nTo achieve this, we could simply add\n\n```sh\n# Don't execute the commands below more than once:\nif [ -z \"$SAGE_ENV_SOURCED\" ]; then\n    export SAGE_ENV_SOURCED=1  # or \"yes\", \"true\" or alike, but see below (versioning)\nelse\n    # Already sourced, nothing to do.\n    return 0\nfi\n```\nnear its top.\n\nWe *may* even put a version number into that variable and execute (perhaps only some of) the commands in `sage-env` \"again\" in case it was modified during running scripts, which could be helpful when upgrading Sage.\n\n---\n\nSuch a variable also allows still generic, but safer tests than the usual `[ -z \"$SAGE_LOCAL\" ]`, since `SAGE_LOCAL` being defined doesn't really imply `sage-env` was sourced, but we usually intend to ensure that some environment variables (like e.g. `CC` or `UNAME`) are properly set up, without testing each of these individually.\n\nEffectively sourcing (at least parts of) `sage-env` only once also\n\n* avoids redundant entries in `PATH` etc.,\n* avoids special tests if some variable was already defined / modified (like e.g. `SAGE_ORIG_LD_LIBRARY_PATH`), also simplifying other scripts (cf. #10286),\n* IMHO reduces the risk of unintentional side-effects, and\n* speeds up execution.\n\n---\n\nAlso, we should change the permissions of `sage-env` to non-executable (it must be *sourced*, not executed).\n\n- Apply [attachment:trac_10469.v5[1].patch] to the scripts repo.\n- Apply [attachment:trac_10469-sage-repo.patch] to the Sage library repo.\n\nAssignee: GeorgSWeber\n\nCC:  @jhpalmieri @qed777 @gvol\n\nKeywords: environment variables sage-sage scripts\n\nReviewer: Ivan Andrus, Jeroen Demeyer\n\nAuthor: Ivan Andrus, John Palmieri, Keshav Kini\n\nMerged: sage-4.7.1.alpha0\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/10469\n\n",
    "closed_at": "2011-04-14T07:19:56Z",
    "created_at": "2010-12-13T18:25:44Z",
    "labels": [
        "component: build",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.7.1",
    "title": "Don't (effectively) source sage-env more than once",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10469",
    "user": "https://github.com/nexttime"
}
```
This can currently happen because

* some scripts source it themselves (like e.g. at least `sage-spkg`, which is necessary since `sage-spkg` isn't always called through `sage-sage`, which also sources it),

* some receipts in the top-level `Makefile` source it before some other script is called through `sage-sage`,

* `sage-sage` itself or other (e.g. Python) code may run `sage ...` commands such that `sage-sage` is then called recursively, again sourcing `sage-env`.

To achieve this, we could simply add

```sh
# Don't execute the commands below more than once:
if [ -z "$SAGE_ENV_SOURCED" ]; then
    export SAGE_ENV_SOURCED=1  # or "yes", "true" or alike, but see below (versioning)
else
    # Already sourced, nothing to do.
    return 0
fi
```
near its top.

We *may* even put a version number into that variable and execute (perhaps only some of) the commands in `sage-env` "again" in case it was modified during running scripts, which could be helpful when upgrading Sage.

---

Such a variable also allows still generic, but safer tests than the usual `[ -z "$SAGE_LOCAL" ]`, since `SAGE_LOCAL` being defined doesn't really imply `sage-env` was sourced, but we usually intend to ensure that some environment variables (like e.g. `CC` or `UNAME`) are properly set up, without testing each of these individually.

Effectively sourcing (at least parts of) `sage-env` only once also

* avoids redundant entries in `PATH` etc.,
* avoids special tests if some variable was already defined / modified (like e.g. `SAGE_ORIG_LD_LIBRARY_PATH`), also simplifying other scripts (cf. #10286),
* IMHO reduces the risk of unintentional side-effects, and
* speeds up execution.

---

Also, we should change the permissions of `sage-env` to non-executable (it must be *sourced*, not executed).

- Apply [attachment:trac_10469.v5[1].patch] to the scripts repo.
- Apply [attachment:trac_10469-sage-repo.patch] to the Sage library repo.

Assignee: GeorgSWeber

CC:  @jhpalmieri @qed777 @gvol

Keywords: environment variables sage-sage scripts

Reviewer: Ivan Andrus, Jeroen Demeyer

Author: Ivan Andrus, John Palmieri, Keshav Kini

Merged: sage-4.7.1.alpha0

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/10469





---

archive/issue_comments_129239.json:
```json
{
    "body": "<a id='comment:1'></a>Thoughts?",
    "created_at": "2010-12-13T18:26:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129239",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:1'></a>Thoughts?



---

archive/issue_comments_129240.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,6 @@\n This can currently happen because\n \n-* some scripts (like e.g. at least `sage-spkg`) sources it itself (which is necessary since `sage-spkg` isn't always called through `sage-sage`, which also sources it),\n+* some scripts source it themselves (like e.g. at least `sage-spkg`, which is necessary since `sage-spkg` isn't always called through `sage-sage`, which also sources it),\n \n * some receipts in the top-level `Makefile` source it before some other script is called through `sage-sage`,\n \n@@ -46,6 +46,8 @@\n ```\n which causes an error if `sage-env` is called rather than sourced (which makes no sense and therefore *is* indeed an error), with an \"appropriate\" error message since such an interpreter certainly does not exist.\n \n+\n+\n Comment: 1\n \n Issue created by migration from https://trac.sagemath.org/ticket/10469\n``````\n",
    "created_at": "2010-12-13T18:30:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129240",
    "user": "https://github.com/nexttime"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,6 @@
 This can currently happen because
 
-* some scripts (like e.g. at least `sage-spkg`) sources it itself (which is necessary since `sage-spkg` isn't always called through `sage-sage`, which also sources it),
+* some scripts source it themselves (like e.g. at least `sage-spkg`, which is necessary since `sage-spkg` isn't always called through `sage-sage`, which also sources it),
 
 * some receipts in the top-level `Makefile` source it before some other script is called through `sage-sage`,
 
@@ -46,6 +46,8 @@
 ```
 which causes an error if `sage-env` is called rather than sourced (which makes no sense and therefore *is* indeed an error), with an "appropriate" error message since such an interpreter certainly does not exist.
 
+
+
 Comment: 1
 
 Issue created by migration from https://trac.sagemath.org/ticket/10469
``````




---

archive/issue_comments_129241.json:
```json
{
    "body": "Attachment [trac_10469.patch](tarball://root/attachments/some-uuid/ticket10469/trac_10469.patch) by @gvol created at 2011-03-24 00:06:05",
    "created_at": "2011-03-24T00:06:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129241",
    "user": "https://github.com/gvol"
}
```

Attachment [trac_10469.patch](tarball://root/attachments/some-uuid/ticket10469/trac_10469.patch) by @gvol created at 2011-03-24 00:06:05



---

archive/issue_comments_129242.json:
```json
{
    "body": "<a id='comment:3'></a>It seems reasonable to me, so I've included a patch which does everything except versioning.  This will obsolete #4029.",
    "created_at": "2011-03-24T00:07:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129242",
    "user": "https://github.com/gvol"
}
```

<a id='comment:3'></a>It seems reasonable to me, so I've included a patch which does everything except versioning.  This will obsolete #4029.



---

archive/issue_comments_129243.json:
```json
{
    "body": "Changing author from \"\" to \"Ivan Andrus\"",
    "created_at": "2011-03-24T00:07:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129243",
    "user": "https://github.com/gvol"
}
```

Changing author from "" to "Ivan Andrus"



---

archive/issue_comments_129244.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-03-24T00:07:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129244",
    "user": "https://github.com/gvol"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_129245.json:
```json
{
    "body": "scripts repo; replaces other patch",
    "created_at": "2011-03-24T20:58:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129245",
    "user": "https://github.com/jhpalmieri"
}
```

scripts repo; replaces other patch



---

archive/issue_comments_129246.json:
```json
{
    "body": "Attachment [trac_10469.v3.patch](tarball://root/attachments/some-uuid/ticket10469/trac_10469.v3.patch) by @kini created at 2011-03-25 00:30:11",
    "created_at": "2011-03-25T00:30:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129246",
    "user": "https://github.com/kini"
}
```

Attachment [trac_10469.v3.patch](tarball://root/attachments/some-uuid/ticket10469/trac_10469.v3.patch) by @kini created at 2011-03-25 00:30:11



---

archive/issue_comments_129247.json:
```json
{
    "body": "<a id='comment:4'></a>While we're at it, why don't we just make sage-env non-executable? Patch attached.",
    "created_at": "2011-03-25T00:31:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129247",
    "user": "https://github.com/kini"
}
```

<a id='comment:4'></a>While we're at it, why don't we just make sage-env non-executable? Patch attached.



---

archive/issue_comments_129248.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,52 @@\n+This can currently happen because\n \n+* some scripts source it themselves (like e.g. at least `sage-spkg`, which is necessary since `sage-spkg` isn't always called through `sage-sage`, which also sources it),\n+\n+* some receipts in the top-level `Makefile` source it before some other script is called through `sage-sage`,\n+\n+* `sage-sage` itself or other (e.g. Python) code may run `sage ...` commands such that `sage-sage` is then called recursively, again sourcing `sage-env`.\n+\n+To achieve this, we could simply add\n+\n+```sh\n+# Don't execute the commands below more than once:\n+if [ -z \"$SAGE_ENV_SOURCED\" ]; then\n+    export SAGE_ENV_SOURCED=1  # or \"yes\", \"true\" or alike, but see below (versioning)\n+else\n+    # Already sourced, nothing to do.\n+    return 0\n+fi\n+```\n+near its top.\n+\n+We *may* even put a version number into that variable and execute (perhaps only some of) the commands in `sage-env` \"again\" in case it was modified during running scripts, which could be helpful when upgrading Sage.\n+\n+---\n+\n+Such a variable also allows still generic, but safer tests than the usual `[ -z \"$SAGE_LOCAL\" ]`, since `SAGE_LOCAL` being defined doesn't really imply `sage-env` was sourced, but we usually intend to ensure that some environment variables (like e.g. `CC` or `UNAME`) are properly set up, without testing each of these individually.\n+\n+Effectively sourcing (at least parts of) `sage-env` only once also\n+\n+* avoids redundant entries in `PATH` etc.,\n+* avoids special tests if some variable was already defined / modified (like e.g. `SAGE_ORIG_LD_LIBRARY_PATH`), also simplifying other scripts (cf. #10286),\n+* IMHO reduces the risk of unintentional side-effects, and\n+* speeds up execution.\n+\n+---\n+\n+Also, we should replace the useless\n+\n+```sh\n+#!/usr/bin/env bash\n+```\n+at its top by (e.g.)\n+\n+```sh\n+#!/this/script/must/be/sourced\n+```\n+which causes an error if `sage-env` is called rather than sourced (which makes no sense and therefore *is* indeed an error), with an \"appropriate\" error message since such an interpreter certainly does not exist.\n+\n+Apply trac_10469.v3.patch to local/bin\n \n Comment: 1\n \n``````\n",
    "created_at": "2011-03-25T00:31:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129248",
    "user": "https://github.com/kini"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,52 @@
+This can currently happen because
 
+* some scripts source it themselves (like e.g. at least `sage-spkg`, which is necessary since `sage-spkg` isn't always called through `sage-sage`, which also sources it),
+
+* some receipts in the top-level `Makefile` source it before some other script is called through `sage-sage`,
+
+* `sage-sage` itself or other (e.g. Python) code may run `sage ...` commands such that `sage-sage` is then called recursively, again sourcing `sage-env`.
+
+To achieve this, we could simply add
+
+```sh
+# Don't execute the commands below more than once:
+if [ -z "$SAGE_ENV_SOURCED" ]; then
+    export SAGE_ENV_SOURCED=1  # or "yes", "true" or alike, but see below (versioning)
+else
+    # Already sourced, nothing to do.
+    return 0
+fi
+```
+near its top.
+
+We *may* even put a version number into that variable and execute (perhaps only some of) the commands in `sage-env` "again" in case it was modified during running scripts, which could be helpful when upgrading Sage.
+
+---
+
+Such a variable also allows still generic, but safer tests than the usual `[ -z "$SAGE_LOCAL" ]`, since `SAGE_LOCAL` being defined doesn't really imply `sage-env` was sourced, but we usually intend to ensure that some environment variables (like e.g. `CC` or `UNAME`) are properly set up, without testing each of these individually.
+
+Effectively sourcing (at least parts of) `sage-env` only once also
+
+* avoids redundant entries in `PATH` etc.,
+* avoids special tests if some variable was already defined / modified (like e.g. `SAGE_ORIG_LD_LIBRARY_PATH`), also simplifying other scripts (cf. #10286),
+* IMHO reduces the risk of unintentional side-effects, and
+* speeds up execution.
+
+---
+
+Also, we should replace the useless
+
+```sh
+#!/usr/bin/env bash
+```
+at its top by (e.g.)
+
+```sh
+#!/this/script/must/be/sourced
+```
+which causes an error if `sage-env` is called rather than sourced (which makes no sense and therefore *is* indeed an error), with an "appropriate" error message since such an interpreter certainly does not exist.
+
+Apply trac_10469.v3.patch to local/bin
 
 Comment: 1
 
``````




---

archive/issue_comments_129249.json:
```json
{
    "body": "<a id='comment:5'></a>What is the purpose of checking `SAGE_ROOT` but not doing anything with it?  Is it just so that it prints a warning?  It seems that if `sage-env` has been sourced `SAGE_ROOT` should be set correctly.",
    "created_at": "2011-03-25T00:46:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129249",
    "user": "https://github.com/gvol"
}
```

<a id='comment:5'></a>What is the purpose of checking `SAGE_ROOT` but not doing anything with it?  Is it just so that it prints a warning?  It seems that if `sage-env` has been sourced `SAGE_ROOT` should be set correctly.



---

archive/issue_comments_129250.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:5 iandrus]:\n> What is the purpose of checking `SAGE_ROOT` but not doing anything with it?  Is it just so that it prints a warning?  It seems that if `sage-env` has been sourced `SAGE_ROOT` should be set correctly.\n\n\nYou're probably right, and if this is always called via a call to sage, this could probably be deleted.  As it stands, the changes here look pretty safe to me, but removing that check seems a bit riskier, and something which would require more serious testing.",
    "created_at": "2011-03-25T01:46:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129250",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:6'></a>Replying to [comment:5 iandrus]:
> What is the purpose of checking `SAGE_ROOT` but not doing anything with it?  Is it just so that it prints a warning?  It seems that if `sage-env` has been sourced `SAGE_ROOT` should be set correctly.


You're probably right, and if this is always called via a call to sage, this could probably be deleted.  As it stands, the changes here look pretty safe to me, but removing that check seems a bit riskier, and something which would require more serious testing.



---

archive/issue_comments_129251.json:
```json
{
    "body": "Changing author from \"Ivan Andrus\" to \"Ivan Andrus, John Palmieri, Keshav Kini\"",
    "created_at": "2011-03-25T17:09:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129251",
    "user": "https://github.com/jhpalmieri"
}
```

Changing author from "Ivan Andrus" to "Ivan Andrus, John Palmieri, Keshav Kini"



---

archive/issue_comments_129252.json:
```json
{
    "body": "<a id='comment:7'></a>I'm happy with all of the changes here, but since I helped to write them, I don't think I should give this a positive review.  Anyone else?  Ivan or Keshav?",
    "created_at": "2011-03-25T17:09:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129252",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:7'></a>I'm happy with all of the changes here, but since I helped to write them, I don't think I should give this a positive review.  Anyone else?  Ivan or Keshav?



---

archive/issue_comments_129253.json:
```json
{
    "body": "<a id='comment:8'></a>I'm happy to give it a positive review.",
    "created_at": "2011-03-25T17:13:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129253",
    "user": "https://github.com/gvol"
}
```

<a id='comment:8'></a>I'm happy to give it a positive review.



---

archive/issue_comments_129254.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-03-25T17:13:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129254",
    "user": "https://github.com/gvol"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_129255.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Ivan Andrus\"",
    "created_at": "2011-03-25T17:13:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129255",
    "user": "https://github.com/gvol"
}
```

Changing reviewer from "" to "Ivan Andrus"



---

archive/issue_comments_129256.json:
```json
{
    "body": "Attachment [trac_10469.v4.patch](tarball://root/attachments/some-uuid/ticket10469/trac_10469.v4.patch) by @jdemeyer created at 2011-03-26 20:03:32",
    "created_at": "2011-03-26T20:03:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129256",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [trac_10469.v4.patch](tarball://root/attachments/some-uuid/ticket10469/trac_10469.v4.patch) by @jdemeyer created at 2011-03-26 20:03:32



---

archive/issue_comments_129257.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2011-03-26T20:07:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129257",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_129258.json:
```json
{
    "body": "<a id='comment:9'></a>I don't like the #!/this/script/must/be/sourced\nIn my v4 patch, I removed that line.\nInstead, I think a much better solution is simply to make `sage-env` not executable.",
    "created_at": "2011-03-26T20:07:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129258",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>I don't like the #!/this/script/must/be/sourced
In my v4 patch, I removed that line.
Instead, I think a much better solution is simply to make `sage-env` not executable.



---

archive/issue_comments_129259.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-03-26T20:08:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129259",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_129260.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,52 @@\n+This can currently happen because\n \n+* some scripts source it themselves (like e.g. at least `sage-spkg`, which is necessary since `sage-spkg` isn't always called through `sage-sage`, which also sources it),\n+\n+* some receipts in the top-level `Makefile` source it before some other script is called through `sage-sage`,\n+\n+* `sage-sage` itself or other (e.g. Python) code may run `sage ...` commands such that `sage-sage` is then called recursively, again sourcing `sage-env`.\n+\n+To achieve this, we could simply add\n+\n+```sh\n+# Don't execute the commands below more than once:\n+if [ -z \"$SAGE_ENV_SOURCED\" ]; then\n+    export SAGE_ENV_SOURCED=1  # or \"yes\", \"true\" or alike, but see below (versioning)\n+else\n+    # Already sourced, nothing to do.\n+    return 0\n+fi\n+```\n+near its top.\n+\n+We *may* even put a version number into that variable and execute (perhaps only some of) the commands in `sage-env` \"again\" in case it was modified during running scripts, which could be helpful when upgrading Sage.\n+\n+---\n+\n+Such a variable also allows still generic, but safer tests than the usual `[ -z \"$SAGE_LOCAL\" ]`, since `SAGE_LOCAL` being defined doesn't really imply `sage-env` was sourced, but we usually intend to ensure that some environment variables (like e.g. `CC` or `UNAME`) are properly set up, without testing each of these individually.\n+\n+Effectively sourcing (at least parts of) `sage-env` only once also\n+\n+* avoids redundant entries in `PATH` etc.,\n+* avoids special tests if some variable was already defined / modified (like e.g. `SAGE_ORIG_LD_LIBRARY_PATH`), also simplifying other scripts (cf. #10286),\n+* IMHO reduces the risk of unintentional side-effects, and\n+* speeds up execution.\n+\n+---\n+\n+Also, we should replace the useless\n+\n+```sh\n+#!/usr/bin/env bash\n+```\n+at its top by (e.g.)\n+\n+```sh\n+#!/this/script/must/be/sourced\n+```\n+which causes an error if `sage-env` is called rather than sourced (which makes no sense and therefore *is* indeed an error), with an \"appropriate\" error message since such an interpreter certainly does not exist.\n+\n+Apply [attachment:trac_10469.v4.patch] to `local/bin` and change permissions of `local/bin/sage-env` to 0644.\n \n Comment: 1\n \n``````\n",
    "created_at": "2011-03-26T20:09:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129260",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,52 @@
+This can currently happen because
 
+* some scripts source it themselves (like e.g. at least `sage-spkg`, which is necessary since `sage-spkg` isn't always called through `sage-sage`, which also sources it),
+
+* some receipts in the top-level `Makefile` source it before some other script is called through `sage-sage`,
+
+* `sage-sage` itself or other (e.g. Python) code may run `sage ...` commands such that `sage-sage` is then called recursively, again sourcing `sage-env`.
+
+To achieve this, we could simply add
+
+```sh
+# Don't execute the commands below more than once:
+if [ -z "$SAGE_ENV_SOURCED" ]; then
+    export SAGE_ENV_SOURCED=1  # or "yes", "true" or alike, but see below (versioning)
+else
+    # Already sourced, nothing to do.
+    return 0
+fi
+```
+near its top.
+
+We *may* even put a version number into that variable and execute (perhaps only some of) the commands in `sage-env` "again" in case it was modified during running scripts, which could be helpful when upgrading Sage.
+
+---
+
+Such a variable also allows still generic, but safer tests than the usual `[ -z "$SAGE_LOCAL" ]`, since `SAGE_LOCAL` being defined doesn't really imply `sage-env` was sourced, but we usually intend to ensure that some environment variables (like e.g. `CC` or `UNAME`) are properly set up, without testing each of these individually.
+
+Effectively sourcing (at least parts of) `sage-env` only once also
+
+* avoids redundant entries in `PATH` etc.,
+* avoids special tests if some variable was already defined / modified (like e.g. `SAGE_ORIG_LD_LIBRARY_PATH`), also simplifying other scripts (cf. #10286),
+* IMHO reduces the risk of unintentional side-effects, and
+* speeds up execution.
+
+---
+
+Also, we should replace the useless
+
+```sh
+#!/usr/bin/env bash
+```
+at its top by (e.g.)
+
+```sh
+#!/this/script/must/be/sourced
+```
+which causes an error if `sage-env` is called rather than sourced (which makes no sense and therefore *is* indeed an error), with an "appropriate" error message since such an interpreter certainly does not exist.
+
+Apply [attachment:trac_10469.v4.patch] to `local/bin` and change permissions of `local/bin/sage-env` to 0644.
 
 Comment: 1
 
``````




---

archive/issue_comments_129261.json:
```json
{
    "body": "<a id='comment:12'></a>John, Mercurial tracks file modes. The diffs it exports (and thus the patches mq exports) do not mention them unless you put \"[diff]\\ngit = true\" in your .hgrc. My patch does this - you can just remove the hashbang line from it.\n\nGenerally putting \"[diff]\\ngit = true\" in your .hgrc is a good idea, since it frees Mercurial from having to remain compatible with ancient pre-dvcs diff formats.",
    "created_at": "2011-03-26T22:09:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129261",
    "user": "https://github.com/kini"
}
```

<a id='comment:12'></a>John, Mercurial tracks file modes. The diffs it exports (and thus the patches mq exports) do not mention them unless you put "[diff]\ngit = true" in your .hgrc. My patch does this - you can just remove the hashbang line from it.

Generally putting "[diff]\ngit = true" in your .hgrc is a good idea, since it frees Mercurial from having to remain compatible with ancient pre-dvcs diff formats.



---

archive/issue_comments_129262.json:
```json
{
    "body": "<a id='comment:13'></a>Oh, I'm sorry Jeroen. Somehow I thought you were John Palmieri...",
    "created_at": "2011-03-26T22:10:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129262",
    "user": "https://github.com/kini"
}
```

<a id='comment:13'></a>Oh, I'm sorry Jeroen. Somehow I thought you were John Palmieri...



---

archive/issue_comments_129263.json:
```json
{
    "body": "git format of Jeroen's v4 patch, which tracks the filemode change",
    "created_at": "2011-03-26T22:27:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129263",
    "user": "https://github.com/kini"
}
```

git format of Jeroen's v4 patch, which tracks the filemode change



---

archive/issue_comments_129264.json:
```json
{
    "body": "<a id='comment:14'></a>Attachment [trac_10469.v5[1].patch](tarball://root/attachments/some-uuid/ticket10469/trac_10469.v5[1].patch) by @kini created at 2011-03-26 22:28:56\n\nAdded a patch as described and simplified the application instructions so the patchbot can read them more easily (?)",
    "created_at": "2011-03-26T22:28:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129264",
    "user": "https://github.com/kini"
}
```

<a id='comment:14'></a>Attachment [trac_10469.v5[1].patch](tarball://root/attachments/some-uuid/ticket10469/trac_10469.v5[1].patch) by @kini created at 2011-03-26 22:28:56

Added a patch as described and simplified the application instructions so the patchbot can read them more easily (?)



---

archive/issue_comments_129265.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,52 @@\n+This can currently happen because\n \n+* some scripts source it themselves (like e.g. at least `sage-spkg`, which is necessary since `sage-spkg` isn't always called through `sage-sage`, which also sources it),\n+\n+* some receipts in the top-level `Makefile` source it before some other script is called through `sage-sage`,\n+\n+* `sage-sage` itself or other (e.g. Python) code may run `sage ...` commands such that `sage-sage` is then called recursively, again sourcing `sage-env`.\n+\n+To achieve this, we could simply add\n+\n+```sh\n+# Don't execute the commands below more than once:\n+if [ -z \"$SAGE_ENV_SOURCED\" ]; then\n+    export SAGE_ENV_SOURCED=1  # or \"yes\", \"true\" or alike, but see below (versioning)\n+else\n+    # Already sourced, nothing to do.\n+    return 0\n+fi\n+```\n+near its top.\n+\n+We *may* even put a version number into that variable and execute (perhaps only some of) the commands in `sage-env` \"again\" in case it was modified during running scripts, which could be helpful when upgrading Sage.\n+\n+---\n+\n+Such a variable also allows still generic, but safer tests than the usual `[ -z \"$SAGE_LOCAL\" ]`, since `SAGE_LOCAL` being defined doesn't really imply `sage-env` was sourced, but we usually intend to ensure that some environment variables (like e.g. `CC` or `UNAME`) are properly set up, without testing each of these individually.\n+\n+Effectively sourcing (at least parts of) `sage-env` only once also\n+\n+* avoids redundant entries in `PATH` etc.,\n+* avoids special tests if some variable was already defined / modified (like e.g. `SAGE_ORIG_LD_LIBRARY_PATH`), also simplifying other scripts (cf. #10286),\n+* IMHO reduces the risk of unintentional side-effects, and\n+* speeds up execution.\n+\n+---\n+\n+Also, we should replace the useless\n+\n+```sh\n+#!/usr/bin/env bash\n+```\n+at its top by (e.g.)\n+\n+```sh\n+#!/this/script/must/be/sourced\n+```\n+which causes an error if `sage-env` is called rather than sourced (which makes no sense and therefore *is* indeed an error), with an \"appropriate\" error message since such an interpreter certainly does not exist.\n+\n+Apply trac_10469.v5[1].patch to local/bin\n \n Comment: 1\n \n``````\n",
    "created_at": "2011-03-26T22:28:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129265",
    "user": "https://github.com/kini"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,52 @@
+This can currently happen because
 
+* some scripts source it themselves (like e.g. at least `sage-spkg`, which is necessary since `sage-spkg` isn't always called through `sage-sage`, which also sources it),
+
+* some receipts in the top-level `Makefile` source it before some other script is called through `sage-sage`,
+
+* `sage-sage` itself or other (e.g. Python) code may run `sage ...` commands such that `sage-sage` is then called recursively, again sourcing `sage-env`.
+
+To achieve this, we could simply add
+
+```sh
+# Don't execute the commands below more than once:
+if [ -z "$SAGE_ENV_SOURCED" ]; then
+    export SAGE_ENV_SOURCED=1  # or "yes", "true" or alike, but see below (versioning)
+else
+    # Already sourced, nothing to do.
+    return 0
+fi
+```
+near its top.
+
+We *may* even put a version number into that variable and execute (perhaps only some of) the commands in `sage-env` "again" in case it was modified during running scripts, which could be helpful when upgrading Sage.
+
+---
+
+Such a variable also allows still generic, but safer tests than the usual `[ -z "$SAGE_LOCAL" ]`, since `SAGE_LOCAL` being defined doesn't really imply `sage-env` was sourced, but we usually intend to ensure that some environment variables (like e.g. `CC` or `UNAME`) are properly set up, without testing each of these individually.
+
+Effectively sourcing (at least parts of) `sage-env` only once also
+
+* avoids redundant entries in `PATH` etc.,
+* avoids special tests if some variable was already defined / modified (like e.g. `SAGE_ORIG_LD_LIBRARY_PATH`), also simplifying other scripts (cf. #10286),
+* IMHO reduces the risk of unintentional side-effects, and
+* speeds up execution.
+
+---
+
+Also, we should replace the useless
+
+```sh
+#!/usr/bin/env bash
+```
+at its top by (e.g.)
+
+```sh
+#!/this/script/must/be/sourced
+```
+which causes an error if `sage-env` is called rather than sourced (which makes no sense and therefore *is* indeed an error), with an "appropriate" error message since such an interpreter certainly does not exist.
+
+Apply trac_10469.v5[1].patch to local/bin
 
 Comment: 1
 
``````




---

archive/issue_comments_129266.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-03-27T20:59:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129266",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_129267.json:
```json
{
    "body": "<a id='comment:15'></a>Doctest error:\n\n```\nsage -t  -force_lib devel/sage/sage/misc/dist.py\n**********************************************************************\nFile \"/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.alpha2-10469/devel/sage-main/sage/misc/dist.py\", line 46:\n    sage: install_scripts(SAGE_TMP)\nExpected:\n    Checking that Sage has the command 'gap' installed\n    Created script ...\nGot:\n    Checking that Sage has the command 'gap' installed\n    The command 'gap' is installed outside of Sage; not adding shortcut\n    <BLANKLINE>\n    Checking that Sage has the command 'gp' installed\n    The command 'gp' is installed outside of Sage; not adding shortcut\n    <BLANKLINE>\n    Checking that Sage has the command 'singular' installed\n    The command 'singular' is installed outside of Sage; not adding shortcut\n    <BLANKLINE>\n    Checking that Sage has the command 'maxima' installed\n    The command 'maxima' is installed outside of Sage; not adding shortcut\n    <BLANKLINE>\n    Checking that Sage has the command 'M2' installed\n    The command 'M2' is not available; not adding shortcut\n    <BLANKLINE>\n    Checking that Sage has the command 'kash' installed\n    The command 'kash' is installed outside of Sage; not adding shortcut\n    <BLANKLINE>\n    Checking that Sage has the command 'mwrank' installed\n    The command 'mwrank' is installed outside of Sage; not adding shortcut\n    <BLANKLINE>\n    Checking that Sage has the command 'ipython' installed\n    The command 'ipython' is installed outside of Sage; not adding shortcut\n    <BLANKLINE>\n    Checking that Sage has the command 'hg' installed\n    The command 'hg' is installed outside of Sage; not adding shortcut\n    <BLANKLINE>\n    Checking that Sage has the command 'R' installed\n    The command 'R' is installed outside of Sage; not adding shortcut\n    <BLANKLINE>\n    Finished creating scripts.\n    You need not do this again even if you upgrade or move Sage.\n    The only requirement is that the command 'sage' is in the PATH.\n**********************************************************************\n```",
    "created_at": "2011-03-27T20:59:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129267",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:15'></a>Doctest error:

```
sage -t  -force_lib devel/sage/sage/misc/dist.py
**********************************************************************
File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.alpha2-10469/devel/sage-main/sage/misc/dist.py", line 46:
    sage: install_scripts(SAGE_TMP)
Expected:
    Checking that Sage has the command 'gap' installed
    Created script ...
Got:
    Checking that Sage has the command 'gap' installed
    The command 'gap' is installed outside of Sage; not adding shortcut
    <BLANKLINE>
    Checking that Sage has the command 'gp' installed
    The command 'gp' is installed outside of Sage; not adding shortcut
    <BLANKLINE>
    Checking that Sage has the command 'singular' installed
    The command 'singular' is installed outside of Sage; not adding shortcut
    <BLANKLINE>
    Checking that Sage has the command 'maxima' installed
    The command 'maxima' is installed outside of Sage; not adding shortcut
    <BLANKLINE>
    Checking that Sage has the command 'M2' installed
    The command 'M2' is not available; not adding shortcut
    <BLANKLINE>
    Checking that Sage has the command 'kash' installed
    The command 'kash' is installed outside of Sage; not adding shortcut
    <BLANKLINE>
    Checking that Sage has the command 'mwrank' installed
    The command 'mwrank' is installed outside of Sage; not adding shortcut
    <BLANKLINE>
    Checking that Sage has the command 'ipython' installed
    The command 'ipython' is installed outside of Sage; not adding shortcut
    <BLANKLINE>
    Checking that Sage has the command 'hg' installed
    The command 'hg' is installed outside of Sage; not adding shortcut
    <BLANKLINE>
    Checking that Sage has the command 'R' installed
    The command 'R' is installed outside of Sage; not adding shortcut
    <BLANKLINE>
    Finished creating scripts.
    You need not do this again even if you upgrade or move Sage.
    The only requirement is that the command 'sage' is in the PATH.
**********************************************************************
```



---

archive/issue_comments_129268.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,42 @@\n+This can currently happen because\n \n+* some scripts source it themselves (like e.g. at least `sage-spkg`, which is necessary since `sage-spkg` isn't always called through `sage-sage`, which also sources it),\n+\n+* some receipts in the top-level `Makefile` source it before some other script is called through `sage-sage`,\n+\n+* `sage-sage` itself or other (e.g. Python) code may run `sage ...` commands such that `sage-sage` is then called recursively, again sourcing `sage-env`.\n+\n+To achieve this, we could simply add\n+\n+```sh\n+# Don't execute the commands below more than once:\n+if [ -z \"$SAGE_ENV_SOURCED\" ]; then\n+    export SAGE_ENV_SOURCED=1  # or \"yes\", \"true\" or alike, but see below (versioning)\n+else\n+    # Already sourced, nothing to do.\n+    return 0\n+fi\n+```\n+near its top.\n+\n+We *may* even put a version number into that variable and execute (perhaps only some of) the commands in `sage-env` \"again\" in case it was modified during running scripts, which could be helpful when upgrading Sage.\n+\n+---\n+\n+Such a variable also allows still generic, but safer tests than the usual `[ -z \"$SAGE_LOCAL\" ]`, since `SAGE_LOCAL` being defined doesn't really imply `sage-env` was sourced, but we usually intend to ensure that some environment variables (like e.g. `CC` or `UNAME`) are properly set up, without testing each of these individually.\n+\n+Effectively sourcing (at least parts of) `sage-env` only once also\n+\n+* avoids redundant entries in `PATH` etc.,\n+* avoids special tests if some variable was already defined / modified (like e.g. `SAGE_ORIG_LD_LIBRARY_PATH`), also simplifying other scripts (cf. #10286),\n+* IMHO reduces the risk of unintentional side-effects, and\n+* speeds up execution.\n+\n+---\n+\n+Also, we should change the permissions of `sage-env` to non-executable (it must be *sourced*, not executed).\n+\n+Apply [attachment:trac_10469.v5[1].patch] to local/bin\n \n Comment: 1\n \n``````\n",
    "created_at": "2011-03-27T21:05:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129268",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,42 @@
+This can currently happen because
 
+* some scripts source it themselves (like e.g. at least `sage-spkg`, which is necessary since `sage-spkg` isn't always called through `sage-sage`, which also sources it),
+
+* some receipts in the top-level `Makefile` source it before some other script is called through `sage-sage`,
+
+* `sage-sage` itself or other (e.g. Python) code may run `sage ...` commands such that `sage-sage` is then called recursively, again sourcing `sage-env`.
+
+To achieve this, we could simply add
+
+```sh
+# Don't execute the commands below more than once:
+if [ -z "$SAGE_ENV_SOURCED" ]; then
+    export SAGE_ENV_SOURCED=1  # or "yes", "true" or alike, but see below (versioning)
+else
+    # Already sourced, nothing to do.
+    return 0
+fi
+```
+near its top.
+
+We *may* even put a version number into that variable and execute (perhaps only some of) the commands in `sage-env` "again" in case it was modified during running scripts, which could be helpful when upgrading Sage.
+
+---
+
+Such a variable also allows still generic, but safer tests than the usual `[ -z "$SAGE_LOCAL" ]`, since `SAGE_LOCAL` being defined doesn't really imply `sage-env` was sourced, but we usually intend to ensure that some environment variables (like e.g. `CC` or `UNAME`) are properly set up, without testing each of these individually.
+
+Effectively sourcing (at least parts of) `sage-env` only once also
+
+* avoids redundant entries in `PATH` etc.,
+* avoids special tests if some variable was already defined / modified (like e.g. `SAGE_ORIG_LD_LIBRARY_PATH`), also simplifying other scripts (cf. #10286),
+* IMHO reduces the risk of unintentional side-effects, and
+* speeds up execution.
+
+---
+
+Also, we should change the permissions of `sage-env` to non-executable (it must be *sourced*, not executed).
+
+Apply [attachment:trac_10469.v5[1].patch] to local/bin
 
 Comment: 1
 
``````




---

archive/issue_comments_129269.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,43 @@\n+This can currently happen because\n \n+* some scripts source it themselves (like e.g. at least `sage-spkg`, which is necessary since `sage-spkg` isn't always called through `sage-sage`, which also sources it),\n+\n+* some receipts in the top-level `Makefile` source it before some other script is called through `sage-sage`,\n+\n+* `sage-sage` itself or other (e.g. Python) code may run `sage ...` commands such that `sage-sage` is then called recursively, again sourcing `sage-env`.\n+\n+To achieve this, we could simply add\n+\n+```sh\n+# Don't execute the commands below more than once:\n+if [ -z \"$SAGE_ENV_SOURCED\" ]; then\n+    export SAGE_ENV_SOURCED=1  # or \"yes\", \"true\" or alike, but see below (versioning)\n+else\n+    # Already sourced, nothing to do.\n+    return 0\n+fi\n+```\n+near its top.\n+\n+We *may* even put a version number into that variable and execute (perhaps only some of) the commands in `sage-env` \"again\" in case it was modified during running scripts, which could be helpful when upgrading Sage.\n+\n+---\n+\n+Such a variable also allows still generic, but safer tests than the usual `[ -z \"$SAGE_LOCAL\" ]`, since `SAGE_LOCAL` being defined doesn't really imply `sage-env` was sourced, but we usually intend to ensure that some environment variables (like e.g. `CC` or `UNAME`) are properly set up, without testing each of these individually.\n+\n+Effectively sourcing (at least parts of) `sage-env` only once also\n+\n+* avoids redundant entries in `PATH` etc.,\n+* avoids special tests if some variable was already defined / modified (like e.g. `SAGE_ORIG_LD_LIBRARY_PATH`), also simplifying other scripts (cf. #10286),\n+* IMHO reduces the risk of unintentional side-effects, and\n+* speeds up execution.\n+\n+---\n+\n+Also, we should change the permissions of `sage-env` to non-executable (it must be *sourced*, not executed).\n+\n+- Apply [attachment:trac_10469.v5[1].patch] to the scripts repo.\n+- Apply [attachment:trac_10469-sage-repo.patch] to the Sage library repo.\n \n Comment: 1\n \n``````\n",
    "created_at": "2011-03-27T23:37:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129269",
    "user": "https://github.com/jhpalmieri"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,43 @@
+This can currently happen because
 
+* some scripts source it themselves (like e.g. at least `sage-spkg`, which is necessary since `sage-spkg` isn't always called through `sage-sage`, which also sources it),
+
+* some receipts in the top-level `Makefile` source it before some other script is called through `sage-sage`,
+
+* `sage-sage` itself or other (e.g. Python) code may run `sage ...` commands such that `sage-sage` is then called recursively, again sourcing `sage-env`.
+
+To achieve this, we could simply add
+
+```sh
+# Don't execute the commands below more than once:
+if [ -z "$SAGE_ENV_SOURCED" ]; then
+    export SAGE_ENV_SOURCED=1  # or "yes", "true" or alike, but see below (versioning)
+else
+    # Already sourced, nothing to do.
+    return 0
+fi
+```
+near its top.
+
+We *may* even put a version number into that variable and execute (perhaps only some of) the commands in `sage-env` "again" in case it was modified during running scripts, which could be helpful when upgrading Sage.
+
+---
+
+Such a variable also allows still generic, but safer tests than the usual `[ -z "$SAGE_LOCAL" ]`, since `SAGE_LOCAL` being defined doesn't really imply `sage-env` was sourced, but we usually intend to ensure that some environment variables (like e.g. `CC` or `UNAME`) are properly set up, without testing each of these individually.
+
+Effectively sourcing (at least parts of) `sage-env` only once also
+
+* avoids redundant entries in `PATH` etc.,
+* avoids special tests if some variable was already defined / modified (like e.g. `SAGE_ORIG_LD_LIBRARY_PATH`), also simplifying other scripts (cf. #10286),
+* IMHO reduces the risk of unintentional side-effects, and
+* speeds up execution.
+
+---
+
+Also, we should change the permissions of `sage-env` to non-executable (it must be *sourced*, not executed).
+
+- Apply [attachment:trac_10469.v5[1].patch] to the scripts repo.
+- Apply [attachment:trac_10469-sage-repo.patch] to the Sage library repo.
 
 Comment: 1
 
``````




---

archive/issue_comments_129270.json:
```json
{
    "body": "<a id='comment:17'></a>Okay, I know what's going on.  This is a bug in a different aspect of Sage, but perhaps it can be fixed on this ticket.  On sage.math.washington.edu, the directory `/scratch` is actually a link, pointing to `/mnt/usb1/scratch/`.  If you have a copy of Sage in a subdirectory of /scratch, then for reasons I don't understand, sometimes Sage thinks SAGE_ROOT is /scratch/... and sometimes it thinks it is /mnt/usb1/scratch/....  This doctest is failing because when the doctest runs, it thinks SAGE_ROOT is /mnt/usb1/scratch/..., while the output from \"which gap\" starts with /scratch/..., so the first entry in $PATH is the right directory, but with the wrong name.  Maybe when sage-env gets run twice, it manages to use /mnt/... both times.\n\nHere's a patch (to the Sage library) which applies os.path.realpath to both the value of SAGE_ROOT and the output from \"which gap\" (etc.).  This fixes the problem for me.",
    "created_at": "2011-03-27T23:37:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129270",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:17'></a>Okay, I know what's going on.  This is a bug in a different aspect of Sage, but perhaps it can be fixed on this ticket.  On sage.math.washington.edu, the directory `/scratch` is actually a link, pointing to `/mnt/usb1/scratch/`.  If you have a copy of Sage in a subdirectory of /scratch, then for reasons I don't understand, sometimes Sage thinks SAGE_ROOT is /scratch/... and sometimes it thinks it is /mnt/usb1/scratch/....  This doctest is failing because when the doctest runs, it thinks SAGE_ROOT is /mnt/usb1/scratch/..., while the output from "which gap" starts with /scratch/..., so the first entry in $PATH is the right directory, but with the wrong name.  Maybe when sage-env gets run twice, it manages to use /mnt/... both times.

Here's a patch (to the Sage library) which applies os.path.realpath to both the value of SAGE_ROOT and the output from "which gap" (etc.).  This fixes the problem for me.



---

archive/issue_comments_129271.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-03-27T23:37:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129271",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_129272.json:
```json
{
    "body": "Attachment [trac_10469-sage-repo.patch](tarball://root/attachments/some-uuid/ticket10469/trac_10469-sage-repo.patch) by @jhpalmieri created at 2011-03-27 23:37:35\n\nmain Sage repo",
    "created_at": "2011-03-27T23:37:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129272",
    "user": "https://github.com/jhpalmieri"
}
```

Attachment [trac_10469-sage-repo.patch](tarball://root/attachments/some-uuid/ticket10469/trac_10469-sage-repo.patch) by @jhpalmieri created at 2011-03-27 23:37:35

main Sage repo



---

archive/issue_comments_129273.json:
```json
{
    "body": "<a id='comment:18'></a>The patch makes sense to me, I will test that it works.",
    "created_at": "2011-03-30T07:54:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129273",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>The patch makes sense to me, I will test that it works.



---

archive/issue_comments_129274.json:
```json
{
    "body": "Changing reviewer from \"Ivan Andrus\" to \"Ivan Andrus, Jeroen Demeyer\"",
    "created_at": "2011-03-30T07:54:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129274",
    "user": "https://github.com/jdemeyer"
}
```

Changing reviewer from "Ivan Andrus" to "Ivan Andrus, Jeroen Demeyer"



---

archive/issue_comments_129275.json:
```json
{
    "body": "<a id='comment:20'></a>For reviewing this, my opinion is that only [attachment:trac_10469-sage-repo.patch] needs to be reviewed: the other patch has a positive review already.  For this Sage repo patch, make sure to test it on sage.math, and in particular, build and test Sage in a subdirectory of the /scratch directory (since /scratch is symbolically linked to another directory).  It might be a good idea to build it on some other platforms in directories which are symbolic links, to make sure os.path.realpath(...) is doing the right thing.",
    "created_at": "2011-04-13T18:38:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129275",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:20'></a>For reviewing this, my opinion is that only [attachment:trac_10469-sage-repo.patch] needs to be reviewed: the other patch has a positive review already.  For this Sage repo patch, make sure to test it on sage.math, and in particular, build and test Sage in a subdirectory of the /scratch directory (since /scratch is symbolically linked to another directory).  It might be a good idea to build it on some other platforms in directories which are symbolic links, to make sure os.path.realpath(...) is doing the right thing.



---

archive/issue_comments_129276.json:
```json
{
    "body": "<a id='comment:21'></a>I promised to test it and I'm actually going to do it for real this time :-)",
    "created_at": "2011-04-13T18:41:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129276",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'></a>I promised to test it and I'm actually going to do it for real this time :-)



---

archive/issue_events_026804.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-04-13T18:41:48Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "milestone": "sage-4.7.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10469#event-26804"
}
```



---

archive/issue_events_026805.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-04-14T07:19:56Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10469#event-26805"
}
```



---

archive/issue_comments_129277.json:
```json
{
    "body": "<a id='comment:22'></a>Works for me, on `sage.math.washington.edu` using `/scratch`.",
    "created_at": "2011-04-14T07:19:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129277",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'></a>Works for me, on `sage.math.washington.edu` using `/scratch`.



---

archive/issue_comments_129278.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-04-14T07:19:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129278",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_129279.json:
```json
{
    "body": "Changing merged from \"\" to \"sage-4.7.1.alpha0\"",
    "created_at": "2011-04-14T07:19:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129279",
    "user": "https://github.com/jdemeyer"
}
```

Changing merged from "" to "sage-4.7.1.alpha0"



---

archive/issue_comments_129280.json:
```json
{
    "body": "<a id='comment:23'></a>See #11449 for a follow-up (do not make `sage-env` executable in `sage-make_devel_packages`.",
    "created_at": "2011-06-08T15:27:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129280",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:23'></a>See #11449 for a follow-up (do not make `sage-env` executable in `sage-make_devel_packages`.



---

archive/issue_comments_129281.json:
```json
{
    "body": "<a id='comment:24'></a>Some funny side effect, i.e. a bug that only gets really visible with #11021 (substituting almost all instances of `build` in `sage-spkg` with `$BUILD`, which by itself is pretty ok, but also replacing the odd `mymkdir()` with `mkdir -p`, the latter then finally showing the bug):\n\n```\nleif@portland:~/Sage/sage-4.7.1.alpha4$ ./sage -i flint-1.5.0.p5.spkg \nInstalling flint-1.5.0.p5.spkg\nCalling sage-spkg on flint-1.5.0.p5.spkg\nWarning: Attempted to overwrite SAGE_ROOT environment variable\nmkdir: cannot create directory `': No such file or directory\nflint-1.5.0.p5\nMachine:\nLinux portland 2.6.28-19-generic #66-Ubuntu SMP Sat Oct 16 18:00:58 UTC 2010 x86_64 GNU/Linux\nsage: /home/leif/Sage/sage-4.7.1.alpha4/flint-1.5.0.p5.spkg is already installed\n```\n\nThe error originates from `mkdir -p \"$BUILD\"`, previously `mymkdir \"$BUILD\"`, which incidentally didn't try to create the \"empty\" directory, because its test in advance `[ ! -d $1 ]` evaluates to `false` (although the directory of course does not exist).\n\nThe following `cd \"$BUILD\"` becomes a no-op, and most other instances of `$BUILD` happen to be `.../$BUILD`, so don't raise an error either. Only `rm` also fails when trying to remove the temporary files in the wrong directory (still `.../build/...`).\n\nNote that previously, after merging this ticket (#10469), the error just didn't show up because during the build `sage-spkg` gets called directly, hence fully sourcing `sage-env` (such that `$BUILD` gets `build`), creating the `build` directory, which can later be used when otherwise its creation and therefore also references to it would fail.\n\nLong story, for short:\n\nIf `sage-env` is (effectively) sourced only once, all variables must be exported, since the script first sourcing it can call other scripts that source `sage-env` again, but if `sage-env` then returns early, the second script doesn't get non-exported variables set.\n\n(At least) `BUILD` is one such variable that currently doesn't get exported.\n\nI'll provide a patch to `sage-env` at #11021.",
    "created_at": "2011-07-07T04:01:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129281",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:24'></a>Some funny side effect, i.e. a bug that only gets really visible with #11021 (substituting almost all instances of `build` in `sage-spkg` with `$BUILD`, which by itself is pretty ok, but also replacing the odd `mymkdir()` with `mkdir -p`, the latter then finally showing the bug):

```
leif@portland:~/Sage/sage-4.7.1.alpha4$ ./sage -i flint-1.5.0.p5.spkg 
Installing flint-1.5.0.p5.spkg
Calling sage-spkg on flint-1.5.0.p5.spkg
Warning: Attempted to overwrite SAGE_ROOT environment variable
mkdir: cannot create directory `': No such file or directory
flint-1.5.0.p5
Machine:
Linux portland 2.6.28-19-generic #66-Ubuntu SMP Sat Oct 16 18:00:58 UTC 2010 x86_64 GNU/Linux
sage: /home/leif/Sage/sage-4.7.1.alpha4/flint-1.5.0.p5.spkg is already installed
```

The error originates from `mkdir -p "$BUILD"`, previously `mymkdir "$BUILD"`, which incidentally didn't try to create the "empty" directory, because its test in advance `[ ! -d $1 ]` evaluates to `false` (although the directory of course does not exist).

The following `cd "$BUILD"` becomes a no-op, and most other instances of `$BUILD` happen to be `.../$BUILD`, so don't raise an error either. Only `rm` also fails when trying to remove the temporary files in the wrong directory (still `.../build/...`).

Note that previously, after merging this ticket (#10469), the error just didn't show up because during the build `sage-spkg` gets called directly, hence fully sourcing `sage-env` (such that `$BUILD` gets `build`), creating the `build` directory, which can later be used when otherwise its creation and therefore also references to it would fail.

Long story, for short:

If `sage-env` is (effectively) sourced only once, all variables must be exported, since the script first sourcing it can call other scripts that source `sage-env` again, but if `sage-env` then returns early, the second script doesn't get non-exported variables set.

(At least) `BUILD` is one such variable that currently doesn't get exported.

I'll provide a patch to `sage-env` at #11021.



---

archive/issue_comments_129282.json:
```json
{
    "body": "<a id='comment:25'></a>The idea of versioning `sage-env` and `SAGE_ENV_SOURCED` is a good idea: I'm going to implement this in #13395.",
    "created_at": "2012-08-29T20:01:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10469",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10469#issuecomment-129282",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:25'></a>The idea of versioning `sage-env` and `SAGE_ENV_SOURCED` is a good idea: I'm going to implement this in #13395.
