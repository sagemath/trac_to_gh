# Issue 10314: speed up comparison of Integers and native Python numeric types

archive/issues_010313.json:
```json
{
    "body": "Following the discussion at http://groups.google.com/group/sage-devel/browse_thread/thread/631cd4e0a927d793?pli=1, it seemed like a good idea to speed up comparisons of integers with ints, because this often arises when using the preparser.  I also added shortcuts for python longs and floats because it seemed like a good idea.\n\n\n\nAssignee: @aghitza\n\nResolution: fixed\n\nAuthor: David Roe\n\nReviewer: Aly Deines\n\nMerged: sage-4.6.2.alpha1\n\nIssue created by migration from https://trac.sagemath.org/ticket/10314\n\n",
    "closed_at": "2011-01-19T22:22:42Z",
    "created_at": "2010-11-23T19:24:54Z",
    "labels": [
        "component: basic arithmetic"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.6.2",
    "title": "speed up comparison of Integers and native Python numeric types",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10314",
    "user": "https://github.com/roed314"
}
```
Following the discussion at http://groups.google.com/group/sage-devel/browse_thread/thread/631cd4e0a927d793?pli=1, it seemed like a good idea to speed up comparisons of integers with ints, because this often arises when using the preparser.  I also added shortcuts for python longs and floats because it seemed like a good idea.



Assignee: @aghitza

Resolution: fixed

Author: David Roe

Reviewer: Aly Deines

Merged: sage-4.6.2.alpha1

Issue created by migration from https://trac.sagemath.org/ticket/10314





---

archive/issue_comments_110521.json:
```json
{
    "body": "Attachment [10314.patch](tarball://root/attachments/some-uuid/ticket10314/10314.patch) by @roed314 created at 2010-11-23 19:26:21",
    "created_at": "2010-11-23T19:26:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10314",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10314#issuecomment-110521",
    "user": "https://github.com/roed314"
}
```

Attachment [10314.patch](tarball://root/attachments/some-uuid/ticket10314/10314.patch) by @roed314 created at 2010-11-23 19:26:21



---

archive/issue_comments_110522.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2010-11-23T19:28:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10314",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10314#issuecomment-110522",
    "user": "https://github.com/roed314"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_110523.json:
```json
{
    "body": "<a id='comment:2'></a>Here's a major bug this introduces:\n\n```\n        822\t            elif PyFloat_CheckExact(left): \n \t823\t                c = -mpz_cmp_d((<Integer>right).value, PyFloat_AsDouble(right))\n```\n\nNote that you're comparing right to itself.\n\nAnother thought I had is that the tmp mpz could be put at the module scope and never mpz_clear'd.  This means a tiny leak, but it removes the mpz_init and mpz_clear completely, and replaces them with a single mpz_set, which could be a big savings in time, since memory allocation is so expensive. \n\nIn fact, looking in integer.pyx I see this near the top:\n\n```\ncdef mpz_t mpz_tmp\nmpz_init(mpz_tmp)\n```\nso just use that mpz_tmp that is sitting there, instead of making another one.",
    "created_at": "2010-11-23T19:53:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10314",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10314#issuecomment-110523",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:2'></a>Here's a major bug this introduces:

```
        822	            elif PyFloat_CheckExact(left): 
 	823	                c = -mpz_cmp_d((<Integer>right).value, PyFloat_AsDouble(right))
```

Note that you're comparing right to itself.

Another thought I had is that the tmp mpz could be put at the module scope and never mpz_clear'd.  This means a tiny leak, but it removes the mpz_init and mpz_clear completely, and replaces them with a single mpz_set, which could be a big savings in time, since memory allocation is so expensive. 

In fact, looking in integer.pyx I see this near the top:

```
cdef mpz_t mpz_tmp
mpz_init(mpz_tmp)
```
so just use that mpz_tmp that is sitting there, instead of making another one.



---

archive/issue_comments_110524.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2010-11-23T19:53:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10314",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10314#issuecomment-110524",
    "user": "https://github.com/williamstein"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_110525.json:
```json
{
    "body": "<a id='comment:3'></a>Thanks for catching that.  I don't know why my test -1.5r < 3 didn't crash horribly...\n\nI've switched to using the mpz_tmp as you suggested.\n\nOn adding some more tests, I've discovered that this patch changes the behavior of comparison of large floats to sage integers.  Now we have\n\n```\nsage: 1000000000000000000000000000000000000000000000000000.0r==1000000000000000000000000000000000000000000000000000\nFalse\n```\nwhereas it was True before.  Of course, before\n\n```\nsage: 1000000000000000000000000000000000000000000000000000.1r==1000000000000000000000000000000000000000000000000000\nTrue\n```\n\nI think it's still worth using `mpz_cmp_d` because of the speed benefit; users should know to be careful with these kinds of floating point comparisons.  Do you agree?",
    "created_at": "2010-11-23T20:20:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10314",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10314#issuecomment-110525",
    "user": "https://github.com/roed314"
}
```

<a id='comment:3'></a>Thanks for catching that.  I don't know why my test -1.5r < 3 didn't crash horribly...

I've switched to using the mpz_tmp as you suggested.

On adding some more tests, I've discovered that this patch changes the behavior of comparison of large floats to sage integers.  Now we have

```
sage: 1000000000000000000000000000000000000000000000000000.0r==1000000000000000000000000000000000000000000000000000
False
```
whereas it was True before.  Of course, before

```
sage: 1000000000000000000000000000000000000000000000000000.1r==1000000000000000000000000000000000000000000000000000
True
```

I think it's still worth using `mpz_cmp_d` because of the speed benefit; users should know to be careful with these kinds of floating point comparisons.  Do you agree?



---

archive/issue_comments_110526.json:
```json
{
    "body": "Attachment [10314.2.patch](tarball://root/attachments/some-uuid/ticket10314/10314.2.patch) by @roed314 created at 2010-11-23 20:36:33\n\nupdated based on referee comments; apply instead of previous patch",
    "created_at": "2010-11-23T20:36:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10314",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10314#issuecomment-110526",
    "user": "https://github.com/roed314"
}
```

Attachment [10314.2.patch](tarball://root/attachments/some-uuid/ticket10314/10314.2.patch) by @roed314 created at 2010-11-23 20:36:33

updated based on referee comments; apply instead of previous patch



---

archive/issue_comments_110527.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2010-11-23T20:37:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10314",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10314#issuecomment-110527",
    "user": "https://github.com/roed314"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_110528.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-01-07T22:22:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10314",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10314#issuecomment-110528",
    "user": "https://github.com/adeines"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_110529.json:
```json
{
    "body": "<a id='comment:5'></a>When checking the doc tests I got the following failure:\n\n\nsage -t  \"devel/sage/sage/rings/integer.pyx\"                \n**********************************************************************\nFile \"/Applications/sage/sage-4.5.3/devel/sage/sage/rings/integer.pyx\", line 410:\n    sage: TestSuite(n).run()\nExpected:\n    Failure in _test_pickling:\n    Traceback (most recent call last):\n    ...\n    AssertionError: 3 != 3\n    ------------------------------------------------------------\n    The following tests failed: _test_pickling\nGot nothing\n**********************************************************************\n1 items had failures:\n   1 of  10 in __main__.example_7\n***Test Failed*** 1 failures.\nFor whitespace errors, see the file /Users/aly/.sage//tmp/.doctest_integer.py\n\t [6.0 s]\n \n---\nThe following tests failed:\n\n\n\tsage -t  \"devel/sage/sage/rings/integer.pyx\"\nTotal time for all tests: 6.0 seconds",
    "created_at": "2011-01-07T22:22:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10314",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10314#issuecomment-110529",
    "user": "https://github.com/adeines"
}
```

<a id='comment:5'></a>When checking the doc tests I got the following failure:


sage -t  "devel/sage/sage/rings/integer.pyx"                
**********************************************************************
File "/Applications/sage/sage-4.5.3/devel/sage/sage/rings/integer.pyx", line 410:
    sage: TestSuite(n).run()
Expected:
    Failure in _test_pickling:
    Traceback (most recent call last):
    ...
    AssertionError: 3 != 3
    ------------------------------------------------------------
    The following tests failed: _test_pickling
Got nothing
**********************************************************************
1 items had failures:
   1 of  10 in __main__.example_7
***Test Failed*** 1 failures.
For whitespace errors, see the file /Users/aly/.sage//tmp/.doctest_integer.py
	 [6.0 s]
 
---
The following tests failed:


	sage -t  "devel/sage/sage/rings/integer.pyx"
Total time for all tests: 6.0 seconds



---

archive/issue_comments_110530.json:
```json
{
    "body": "Apply instead of previous patches: fixes doctest",
    "created_at": "2011-01-12T00:42:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10314",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10314#issuecomment-110530",
    "user": "https://github.com/roed314"
}
```

Apply instead of previous patches: fixes doctest



---

archive/issue_comments_110531.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-01-12T00:45:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10314",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10314#issuecomment-110531",
    "user": "https://github.com/roed314"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_110532.json:
```json
{
    "body": "<a id='comment:7'></a>Attachment [10314.3.patch](tarball://root/attachments/some-uuid/ticket10314/10314.3.patch) by @roed314 created at 2011-01-12 00:45:28\n\nApply 10314.3.patch\n\nThis fixes the doctest, which shows that pickling integers works better now.  :-)",
    "created_at": "2011-01-12T00:45:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10314",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10314#issuecomment-110532",
    "user": "https://github.com/roed314"
}
```

<a id='comment:7'></a>Attachment [10314.3.patch](tarball://root/attachments/some-uuid/ticket10314/10314.3.patch) by @roed314 created at 2011-01-12 00:45:28

Apply 10314.3.patch

This fixes the doctest, which shows that pickling integers works better now.  :-)



---

archive/issue_comments_110533.json:
```json
{
    "body": "<a id='comment:8'></a>Great!  Looks good.",
    "created_at": "2011-01-12T01:23:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10314",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10314#issuecomment-110533",
    "user": "https://github.com/adeines"
}
```

<a id='comment:8'></a>Great!  Looks good.



---

archive/issue_comments_110534.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-01-12T01:23:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10314",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10314#issuecomment-110534",
    "user": "https://github.com/adeines"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_026534.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-01-12T23:50:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10314",
    "milestone": "sage-4.6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10314#event-26534"
}
```



---

archive/issue_events_026535.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-01-19T22:22:42Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/10314",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10314#event-26535"
}
```



---

archive/issue_comments_110535.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-01-19T22:22:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10314",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10314#issuecomment-110535",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_110536.json:
```json
{
    "body": "<a id='comment:11'></a>It turns out that the line I flagged above as introducing a major bug, which roed fixed, in fact introduces an easy 1-liner way to segfault Sage:\n\n```\nsage: float('nan') > 1\nProgram received signal SIGFPE, Arithmetic exception.\nBOOM\n```\n\nSee #12149.",
    "created_at": "2011-12-13T05:08:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10314",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10314#issuecomment-110536",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:11'></a>It turns out that the line I flagged above as introducing a major bug, which roed fixed, in fact introduces an easy 1-liner way to segfault Sage:

```
sage: float('nan') > 1
Program received signal SIGFPE, Arithmetic exception.
BOOM
```

See #12149.
