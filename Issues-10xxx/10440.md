# Issue 10440: preparser does not correctly identify encoding lines

archive/issues_010387.json:
```json
{
    "body": "[PEP 263](http://www.python.org/dev/peps/pep-0263/) says that the encoding line for a Python file should match a certain regular expression in the first or second line, but the preparser seems to be looking for the precise string \"# -*- coding: utf-8 -*-\".\n\nWe should follow PEP 263 precisely. In particular, this will make it easy for SageTeX users to specify an encoding; because of TeX weirdness that I don't entirely understand, it is easiest to write the line \"## -*- coding: utf-8 -*-\" to the generated script.\n\n* Apply `trac_10440.patch` to the sage library repository.\n* Apply `trac_10440_scripts_repo.patch` to the sage scripts repository.\n\nAssignee: @dandrake\n\nKeywords: preparser encoding\n\nResolution: fixed\n\nAuthor: Dan Drake\n\nReviewer: Volker Braun, Maxim Cournoyer\n\nMerged: sage-4.6.2.alpha4\n\nIssue created by migration from https://trac.sagemath.org/ticket/10440\n\n",
    "closed_at": "2011-02-07T08:14:15Z",
    "created_at": "2010-12-07T23:45:56Z",
    "labels": [
        "component: misc",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.6.2",
    "title": "preparser does not correctly identify encoding lines",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10440",
    "user": "https://github.com/dandrake"
}
```
[PEP 263](http://www.python.org/dev/peps/pep-0263/) says that the encoding line for a Python file should match a certain regular expression in the first or second line, but the preparser seems to be looking for the precise string "# -*- coding: utf-8 -*-".

We should follow PEP 263 precisely. In particular, this will make it easy for SageTeX users to specify an encoding; because of TeX weirdness that I don't entirely understand, it is easiest to write the line "## -*- coding: utf-8 -*-" to the generated script.

* Apply `trac_10440.patch` to the sage library repository.
* Apply `trac_10440_scripts_repo.patch` to the sage scripts repository.

Assignee: @dandrake

Keywords: preparser encoding

Resolution: fixed

Author: Dan Drake

Reviewer: Volker Braun, Maxim Cournoyer

Merged: sage-4.6.2.alpha4

Issue created by migration from https://trac.sagemath.org/ticket/10440





---

archive/issue_comments_111865.json:
```json
{
    "body": "Attachment [trac_10440.patch](tarball://root/attachments/some-uuid/ticket10440/trac_10440.patch) by @dandrake created at 2010-12-08 03:47:22",
    "created_at": "2010-12-08T03:47:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10440",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10440#issuecomment-111865",
    "user": "https://github.com/dandrake"
}
```

Attachment [trac_10440.patch](tarball://root/attachments/some-uuid/ticket10440/trac_10440.patch) by @dandrake created at 2010-12-08 03:47:22



---

archive/issue_comments_111866.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2010-12-08T03:49:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10440",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10440#issuecomment-111866",
    "user": "https://github.com/dandrake"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_111867.json:
```json
{
    "body": "Changing assignee from @jasongrout to @dandrake.",
    "created_at": "2010-12-08T03:51:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10440",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10440#issuecomment-111867",
    "user": "https://github.com/dandrake"
}
```

Changing assignee from @jasongrout to @dandrake.



---

archive/issue_comments_111868.json:
```json
{
    "body": "<a id='comment:2'></a>Note that we aren't following PEP 263, since we default to UTF-8 and not ASCII. The patch now allows the encoding declaration to be in the first or second line, and makes the `handle_encoding_declaration()` much simpler and easier to understand.",
    "created_at": "2010-12-08T03:51:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10440",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10440#issuecomment-111868",
    "user": "https://github.com/dandrake"
}
```

<a id='comment:2'></a>Note that we aren't following PEP 263, since we default to UTF-8 and not ASCII. The patch now allows the encoding declaration to be in the first or second line, and makes the `handle_encoding_declaration()` much simpler and easier to understand.



---

archive/issue_comments_111869.json:
```json
{
    "body": "<a id='comment:3'></a>Hmm, this doesn't fix the SageTeX issue: it looks like the preparser is still looking for \"# -*- coding: utf-8 -*-\". I'll work on an updated patch.",
    "created_at": "2010-12-08T04:12:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10440",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10440#issuecomment-111869",
    "user": "https://github.com/dandrake"
}
```

<a id='comment:3'></a>Hmm, this doesn't fix the SageTeX issue: it looks like the preparser is still looking for "# -*- coding: utf-8 -*-". I'll work on an updated patch.



---

archive/issue_comments_111870.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2010-12-08T04:12:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10440",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10440#issuecomment-111870",
    "user": "https://github.com/dandrake"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_111871.json:
```json
{
    "body": "apply to scripts repo",
    "created_at": "2010-12-08T04:50:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10440",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10440#issuecomment-111871",
    "user": "https://github.com/dandrake"
}
```

apply to scripts repo



---

archive/issue_comments_111872.json:
```json
{
    "body": "<a id='comment:4'></a>Attachment [trac_10440_scripts_repo.patch](tarball://root/attachments/some-uuid/ticket10440/trac_10440_scripts_repo.patch) by @dandrake created at 2010-12-08 04:54:46\n\nApply both patches, although I suspect only the second is necessary to fix the immediate SageTeX problem. It seems like unnecessary code duplication to have two places where we look through a string and extract an encoding declaration, but at least both bits of code work properly now.",
    "created_at": "2010-12-08T04:54:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10440",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10440#issuecomment-111872",
    "user": "https://github.com/dandrake"
}
```

<a id='comment:4'></a>Attachment [trac_10440_scripts_repo.patch](tarball://root/attachments/some-uuid/ticket10440/trac_10440_scripts_repo.patch) by @dandrake created at 2010-12-08 04:54:46

Apply both patches, although I suspect only the second is necessary to fix the immediate SageTeX problem. It seems like unnecessary code duplication to have two places where we look through a string and extract an encoding declaration, but at least both bits of code work properly now.



---

archive/issue_comments_111873.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2010-12-08T04:55:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10440",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10440#issuecomment-111873",
    "user": "https://github.com/dandrake"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_111874.json:
```json
{
    "body": "Changing keywords from \"prepaser encoding\" to \"preparser encoding\".",
    "created_at": "2010-12-08T04:55:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10440",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10440#issuecomment-111874",
    "user": "https://github.com/dandrake"
}
```

Changing keywords from "prepaser encoding" to "preparser encoding".



---

archive/issue_comments_111875.json:
```json
{
    "body": "<a id='comment:7'></a>Concerning the default of UTF-8 instead of ASCII: that's perfectly fine since any valid ASCII text is also valid UTF-8.  If we default to UTF-8, there is also no reason to look for a UTF-8 byte order mark (BOM).",
    "created_at": "2010-12-16T15:51:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10440",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10440#issuecomment-111875",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>Concerning the default of UTF-8 instead of ASCII: that's perfectly fine since any valid ASCII text is also valid UTF-8.  If we default to UTF-8, there is also no reason to look for a UTF-8 byte order mark (BOM).



---

archive/issue_comments_111876.json:
```json
{
    "body": "<a id='comment:8'></a>Irregardless of SageTeX, we should hand through the encoding. This patch works for me. Applies cleanly on Sage-4.6.2.alpha3.",
    "created_at": "2011-02-03T11:36:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10440",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10440#issuecomment-111876",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:8'></a>Irregardless of SageTeX, we should hand through the encoding. This patch works for me. Applies cleanly on Sage-4.6.2.alpha3.



---

archive/issue_comments_111877.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-02-03T11:36:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10440",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10440#issuecomment-111877",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_111878.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -2,9 +2,8 @@\n \n We should follow PEP 263 precisely. In particular, this will make it easy for SageTeX users to specify an encoding; because of TeX weirdness that I don't entirely understand, it is easiest to write the line \"## -*- coding: utf-8 -*-\" to the generated script.\n \n-Assignee: @jasongrout\n-\n-Keywords: prepaser encoding\n+* Apply `trac_10440.patch` to the sage library repository.\n+* Apply `trac_10440_scripts_repo.patch` to the sage scripts repository.\n \n Issue created by migration from https://trac.sagemath.org/ticket/10440\n \n``````\n",
    "created_at": "2011-02-03T11:38:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10440",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10440#issuecomment-111878",
    "user": "https://github.com/vbraun"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -2,9 +2,8 @@
 
 We should follow PEP 263 precisely. In particular, this will make it easy for SageTeX users to specify an encoding; because of TeX weirdness that I don't entirely understand, it is easiest to write the line "## -*- coding: utf-8 -*-" to the generated script.
 
-Assignee: @jasongrout
-
-Keywords: prepaser encoding
+* Apply `trac_10440.patch` to the sage library repository.
+* Apply `trac_10440_scripts_repo.patch` to the sage scripts repository.
 
 Issue created by migration from https://trac.sagemath.org/ticket/10440
 
``````




---

archive/issue_comments_111879.json:
```json
{
    "body": "<a id='comment:10'></a>I confirmed that by installing the second patch (trac_10440_scripts_repo.patch), I can now process code comments containing utf-8 characters (\u00e2 \u00f4 \u00e0 \u00e9...) with sagetex correctly.\n\nThank you for looking into this, Dr. Drake!",
    "created_at": "2011-02-04T18:42:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10440",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10440#issuecomment-111879",
    "user": "https://trac.sagemath.org/admin/accounts/users/maxim"
}
```

<a id='comment:10'></a>I confirmed that by installing the second patch (trac_10440_scripts_repo.patch), I can now process code comments containing utf-8 characters (â ô à é...) with sagetex correctly.

Thank you for looking into this, Dr. Drake!



---

archive/issue_comments_111880.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-02-07T08:14:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10440",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10440#issuecomment-111880",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_026740.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-02-07T08:14:15Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/10440",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10440#event-26740"
}
```
