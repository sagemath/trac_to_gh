# Issue 10548: The coercion model is keeping references to tracebacks which causes memory leaks.

archive/issues_010495.json:
```json
{
    "assignees": [
        "https://github.com/robertwb"
    ],
    "body": "When I was doing some computations on modular forms, I noticed that the ModularSymbols_clear_cache() was not doing what it claims to do.\n\n```\nsage: import gc  \nsage: m=ModularSymbols(Gamma1(29),sign=1)\nsage: m=[]\nsage: ModularSymbols_clear_cache()\nsage: gc.collect()\n57\nsage: [x for x in gc.get_objects() if isinstance(x,sage.modular.modsym.ambient.ModularSymbolsAmbient_wtk_g1)]\n[Modular Symbols space of dimension 49 for Gamma_1(29) of weight 2 with sign 1 and over Rational Field]\nsage: \n```\nSo even after garbage collection the modular symbols element is still in memory.\n\nWhen testing please also make sure that the last stackframe from #10570 is also gone.\n\nApply [attachment: 10548-coerce-traceback.2.patch](https://github.com/sagemath/sage/files/ticket10548/10548-coerce-traceback.2.patch.gz) and [attachment: trac_10548-coerce-traceback-doctest.v2.patch](https://github.com/sagemath/sage/files/ticket10548/trac_10548-coerce-traceback-doctest.v2.patch.gz)\n\nCC:  @loefflerd\n\nComponent: **coercion**\n\nAuthor: **Robert Bradshaw**\n\nReviewer: **Maarten Derickx**\n\nMerged: **sage-4.7.alpha4**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/10548_\n\n",
    "closed_at": "2011-04-07T19:56:57Z",
    "created_at": "2011-01-03T14:43:49Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20coercion",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-4.7",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "The coercion model is keeping references to tracebacks which causes memory leaks.",
    "type": "issue",
    "updated_at": "2011-04-07T19:56:57Z",
    "url": "https://github.com/sagemath/sage/issues/10548",
    "user": "https://github.com/koffie"
}
```
When I was doing some computations on modular forms, I noticed that the ModularSymbols_clear_cache() was not doing what it claims to do.

```
sage: import gc  
sage: m=ModularSymbols(Gamma1(29),sign=1)
sage: m=[]
sage: ModularSymbols_clear_cache()
sage: gc.collect()
57
sage: [x for x in gc.get_objects() if isinstance(x,sage.modular.modsym.ambient.ModularSymbolsAmbient_wtk_g1)]
[Modular Symbols space of dimension 49 for Gamma_1(29) of weight 2 with sign 1 and over Rational Field]
sage: 
```
So even after garbage collection the modular symbols element is still in memory.

When testing please also make sure that the last stackframe from #10570 is also gone.

Apply [attachment: 10548-coerce-traceback.2.patch](https://github.com/sagemath/sage/files/ticket10548/10548-coerce-traceback.2.patch.gz) and [attachment: trac_10548-coerce-traceback-doctest.v2.patch](https://github.com/sagemath/sage/files/ticket10548/trac_10548-coerce-traceback-doctest.v2.patch.gz)

CC:  @loefflerd

Component: **coercion**

Author: **Robert Bradshaw**

Reviewer: **Maarten Derickx**

Merged: **sage-4.7.alpha4**

_Issue created by migration from https://trac.sagemath.org/ticket/10548_





---

archive/issue_events_139366.json:
```json
{
    "actor": "https://github.com/koffie",
    "created_at": "2011-01-03T14:43:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "milestone_number": null,
    "milestone_title": "sage-4.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10548#event-139366"
}
```



---

archive/issue_events_139367.json:
```json
{
    "actor": "https://github.com/koffie",
    "created_at": "2011-01-03T14:43:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20modular%20forms",
    "label_color": "0000ff",
    "label_name": "c: modular forms",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10548#event-139367"
}
```



---

archive/issue_events_139368.json:
```json
{
    "actor": "https://github.com/koffie",
    "created_at": "2011-01-03T14:43:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10548#event-139368"
}
```



---

archive/issue_events_139369.json:
```json
{
    "actor": "https://github.com/koffie",
    "created_at": "2011-01-03T14:43:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10548#event-139369"
}
```



---

archive/issue_events_139370.json:
```json
{
    "actor": "https://github.com/craigcitro",
    "created_at": "2011-01-03T14:43:49Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "subject": "https://github.com/koffie",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10548#event-139370"
}
```



---

archive/issue_comments_100436.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nPs. you might want to use smaller numbers then 97 to test because ModularSymbols(Gamma1(97),sign=1) takes a while. It behaves the same, but with smaller memory usage for smaller numbers.",
    "created_at": "2011-01-03T14:48:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10548#issuecomment-100436",
    "user": "https://github.com/koffie"
}
```

<div id="comment:1" align="right">comment:1</div>

Ps. you might want to use smaller numbers then 97 to test because ModularSymbols(Gamma1(97),sign=1) takes a while. It behaves the same, but with smaller memory usage for smaller numbers.



---

archive/issue_comments_100437.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nAccording to heapy the aditional memory comes from;\n\ndict of sage.modular.modsym.manin_symbols.ManinSymbol\n\n\n```\nmderickx@mod:~$ sage\n----------------------------------------------------------------------\n| Sage Version 4.6, Release Date: 2010-10-30                         |\n| Type notebook() for the GUI, and license() for information.        |\n----------------------------------------------------------------------\nsage: import gc\nsage: from guppy import hpy; hp=hpy()\nsage: M=ModularSymbols(Gamma1(97),sign=1)\nsage: get_memory_usage()\n848.1953125\nsage: M=[]\nsage: get_memory_usage()\n848.1953125\nsage: ModularSymbols_clear_cache()\nsage: get_memory_usage()\n848.1953125\nsage: hp.heap()\nPartition of a set of 445281 objects. Total size = 68518056 bytes.\n Index  Count   %     Size   % Cumulative  % Kind (class / dict of class)\n     0 169534  38 28541776  42  28541776  42 str\n     1 125494  28 10674696  16  39216472  57 tuple\n     2   1624   0  3964480   6  43180952  63 dict of module\n     3  25817   6  3098040   5  46278992  68 types.CodeType\n     4  24634   6  2956080   4  49235072  72 function\n     5   2798   1  2949584   4  52184656  76 dict (no owner)\n     6   2660   1  2727392   4  54912048  80 dict of type\n     7   9408   2  2634240   4  57546288  84 dict of sage.modular.modsym.manin_symbols.ManinSymbol\n     8   2660   1  2388040   3  59934328  87 type\n     9   4293   1  1010536   1  60944864  89 list\n<895 more rows. Type e.g. '_.more' to view.>\nsage: \n```",
    "created_at": "2011-01-03T15:07:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10548#issuecomment-100437",
    "user": "https://github.com/koffie"
}
```

<div id="comment:2" align="right">comment:2</div>

According to heapy the aditional memory comes from;

dict of sage.modular.modsym.manin_symbols.ManinSymbol


```
mderickx@mod:~$ sage
----------------------------------------------------------------------
| Sage Version 4.6, Release Date: 2010-10-30                         |
| Type notebook() for the GUI, and license() for information.        |
----------------------------------------------------------------------
sage: import gc
sage: from guppy import hpy; hp=hpy()
sage: M=ModularSymbols(Gamma1(97),sign=1)
sage: get_memory_usage()
848.1953125
sage: M=[]
sage: get_memory_usage()
848.1953125
sage: ModularSymbols_clear_cache()
sage: get_memory_usage()
848.1953125
sage: hp.heap()
Partition of a set of 445281 objects. Total size = 68518056 bytes.
 Index  Count   %     Size   % Cumulative  % Kind (class / dict of class)
     0 169534  38 28541776  42  28541776  42 str
     1 125494  28 10674696  16  39216472  57 tuple
     2   1624   0  3964480   6  43180952  63 dict of module
     3  25817   6  3098040   5  46278992  68 types.CodeType
     4  24634   6  2956080   4  49235072  72 function
     5   2798   1  2949584   4  52184656  76 dict (no owner)
     6   2660   1  2727392   4  54912048  80 dict of type
     7   9408   2  2634240   4  57546288  84 dict of sage.modular.modsym.manin_symbols.ManinSymbol
     8   2660   1  2388040   3  59934328  87 type
     9   4293   1  1010536   1  60944864  89 list
<895 more rows. Type e.g. '_.more' to view.>
sage: 
```



---

archive/issue_comments_100438.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,47 +1,14 @@\n-When I was doing some computations on modular forms, I noticed the following strange memory usage behaviour which. After the first two iterations it seems like there is a memory leak. But strangely enough it stops leaking at the third iteration.\n+When I was doing some computations on modular forms, I noticed that the ModularSymbols_clear_cache() was not doing what it claims to do.\n \n ```\n-sage: import gc\n+sage: import gc  \n+sage: ModularSymbols(Gamma1(29),sign=1)\n+Modular Symbols space of dimension 49 for Gamma_1(29) of weight 2 with sign 1 and over Rational Field\n+sage: ModularSymbols_clear_cache()\n sage: gc.collect()\n-54\n-sage: get_memory_usage()\n-819.7578125\n-sage: for i in xrange(10):\n-....:     ModularSymbols(Gamma1(97),sign=1)\n-....:     ModularSymbols_clear_cache()\n-....:     gc.collect()\n-....:     get_memory_usage()\n-....:     \n-Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field\n-0\n-842.58984375\n-Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field\n-0\n-860.08203125\n-Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field\n-37640\n-876.63671875\n-Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field\n-37640\n-878.2421875\n-Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field\n-37640\n-878.76953125\n-Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field\n-37640\n-880.2421875\n-Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field\n-37640\n-880.2421875\n-Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field\n-37640\n-880.2421875\n-Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field\n-37640\n-880.2421875\n-Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field\n-37640\n-880.2421875\n+57\n+sage: [x for x in gc.get_objects() if isinstance(x,sage.modular.modsym.ambient.ModularSymbolsAmbient_wtk_g1)]\n+[Modular Symbols space of dimension 49 for Gamma_1(29) of weight 2 with sign 1 and over Rational Field]\n+sage: \n ```\n-\n-It would be nice to be able to create modular symbols without needing to restart sage to get all your memory back.\n+So even after garbage collection the modular symbols element is still in memory.\n``````\n",
    "created_at": "2011-01-07T22:04:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10548#issuecomment-100438",
    "user": "https://github.com/koffie"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,47 +1,14 @@
-When I was doing some computations on modular forms, I noticed the following strange memory usage behaviour which. After the first two iterations it seems like there is a memory leak. But strangely enough it stops leaking at the third iteration.
+When I was doing some computations on modular forms, I noticed that the ModularSymbols_clear_cache() was not doing what it claims to do.
 
 ```
-sage: import gc
+sage: import gc  
+sage: ModularSymbols(Gamma1(29),sign=1)
+Modular Symbols space of dimension 49 for Gamma_1(29) of weight 2 with sign 1 and over Rational Field
+sage: ModularSymbols_clear_cache()
 sage: gc.collect()
-54
-sage: get_memory_usage()
-819.7578125
-sage: for i in xrange(10):
-....:     ModularSymbols(Gamma1(97),sign=1)
-....:     ModularSymbols_clear_cache()
-....:     gc.collect()
-....:     get_memory_usage()
-....:     
-Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field
-0
-842.58984375
-Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field
-0
-860.08203125
-Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field
-37640
-876.63671875
-Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field
-37640
-878.2421875
-Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field
-37640
-878.76953125
-Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field
-37640
-880.2421875
-Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field
-37640
-880.2421875
-Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field
-37640
-880.2421875
-Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field
-37640
-880.2421875
-Modular Symbols space of dimension 440 for Gamma_1(97) of weight 2 with sign 1 and over Rational Field
-37640
-880.2421875
+57
+sage: [x for x in gc.get_objects() if isinstance(x,sage.modular.modsym.ambient.ModularSymbolsAmbient_wtk_g1)]
+[Modular Symbols space of dimension 49 for Gamma_1(29) of weight 2 with sign 1 and over Rational Field]
+sage: 
 ```
-
-It would be nice to be able to create modular symbols without needing to restart sage to get all your memory back.
+So even after garbage collection the modular symbols element is still in memory.
``````




---

archive/issue_comments_100439.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nIt's not an error of the ModularSymbols_clear_cache() function\n\n```\nsage: ModularSymbols(Gamma1(29),sign=1,use_cache=False)\nModular Symbols space of dimension 49 for Gamma_1(29) of weight 2 with sign 1 and over Rational Field\nsage: None\nsage: gc.collect()\n54\nsage: [x for x in gc.get_objects() if isinstance(x,sage.modular.modsym.ambient.ModularSymbolsAmbient_wtk_g1)]\n[Modular Symbols space of dimension 49 for Gamma_1(29) of weight 2 with sign 1 and over Rational Field]\n```",
    "created_at": "2011-01-07T22:15:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10548#issuecomment-100439",
    "user": "https://github.com/koffie"
}
```

<div id="comment:4" align="right">comment:4</div>

It's not an error of the ModularSymbols_clear_cache() function

```
sage: ModularSymbols(Gamma1(29),sign=1,use_cache=False)
Modular Symbols space of dimension 49 for Gamma_1(29) of weight 2 with sign 1 and over Rational Field
sage: None
sage: gc.collect()
54
sage: [x for x in gc.get_objects() if isinstance(x,sage.modular.modsym.ambient.ModularSymbolsAmbient_wtk_g1)]
[Modular Symbols space of dimension 49 for Gamma_1(29) of weight 2 with sign 1 and over Rational Field]
```



---

archive/issue_comments_100440.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nSee the attached chain.png picture created with objgraph. There is a reference chain to the homset module. And the homeset module will not get destroyed so we have to find out where this chain comes from.",
    "created_at": "2011-01-08T00:52:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10548#issuecomment-100440",
    "user": "https://github.com/koffie"
}
```

<div id="comment:5" align="right">comment:5</div>

See the attached chain.png picture created with objgraph. There is a reference chain to the homset module. And the homeset module will not get destroyed so we have to find out where this chain comes from.



---

archive/issue_comments_100441.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nMight this be an instance of #715? Modular symbols spaces are Parents, so various maps in and out of them are probably getting cached by the coercion model machinery.",
    "created_at": "2011-01-20T13:02:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10548#issuecomment-100441",
    "user": "https://github.com/loefflerd"
}
```

<div id="comment:6" align="right">comment:6</div>

Might this be an instance of #715? Modular symbols spaces are Parents, so various maps in and out of them are probably getting cached by the coercion model machinery.



---

archive/issue_comments_100442.json:
```json
{
    "body": "Attachment: **[chain.png](https://github.com/sagemath/sage/files/ticket10548/chain.png)**",
    "created_at": "2011-01-20T13:08:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10548#issuecomment-100442",
    "user": "https://github.com/koffie"
}
```

Attachment: **[chain.png](https://github.com/sagemath/sage/files/ticket10548/chain.png)**



---

archive/issue_comments_100443.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nSorry I failed in adding the mentioned chain.png before. It shows a reference chain explaining why ManinSymbol(37,35) is still in the memory. It seems that it has at least to do something with code in the homset module. I don't know enough details about the coercion and category framework and their interaction to say that it has something to do with 715. But the description of 715 really looks like it could be the cause.\n\nIf it is coercion, it might also be related to: #10570",
    "created_at": "2011-01-20T13:20:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10548#issuecomment-100443",
    "user": "https://github.com/koffie"
}
```

<div id="comment:7" align="right">comment:7</div>

Sorry I failed in adding the mentioned chain.png before. It shows a reference chain explaining why ManinSymbol(37,35) is still in the memory. It seems that it has at least to do something with code in the homset module. I don't know enough details about the coercion and category framework and their interaction to say that it has something to do with 715. But the description of 715 really looks like it could be the cause.

If it is coercion, it might also be related to: #10570



---

archive/issue_comments_100444.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nHaving looked at #10570, I don't think that's the reason. #715 seems a much more likely culprit.",
    "created_at": "2011-01-20T15:48:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10548#issuecomment-100444",
    "user": "https://github.com/loefflerd"
}
```

<div id="comment:8" align="right">comment:8</div>

Having looked at #10570, I don't think that's the reason. #715 seems a much more likely culprit.



---

archive/issue_comments_100445.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -2,8 +2,8 @@\n \n ```\n sage: import gc  \n-sage: ModularSymbols(Gamma1(29),sign=1)\n-Modular Symbols space of dimension 49 for Gamma_1(29) of weight 2 with sign 1 and over Rational Field\n+sage: m=ModularSymbols(Gamma1(29),sign=1)\n+sage: m=[]\n sage: ModularSymbols_clear_cache()\n sage: gc.collect()\n 57\n``````\n",
    "created_at": "2011-03-21T20:54:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10548#issuecomment-100445",
    "user": "https://github.com/koffie"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -2,8 +2,8 @@
 
 ```
 sage: import gc  
-sage: ModularSymbols(Gamma1(29),sign=1)
-Modular Symbols space of dimension 49 for Gamma_1(29) of weight 2 with sign 1 and over Rational Field
+sage: m=ModularSymbols(Gamma1(29),sign=1)
+sage: m=[]
 sage: ModularSymbols_clear_cache()
 sage: gc.collect()
 57
``````




---

archive/issue_comments_100446.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nHere is some code run on sage 4.6.1 showing that it is really the coercion framework.\n\n```\nsage: import gc  \nsage: import objgraph\nsage: import inspect\nsage: m=ModularSymbols(Gamma1(29),use_cache=False)\nsage: m=[]\nsage: ModularSymbols_clear_cache()\nsage: gc.collect()\n54\nsage: a=[x for x in gc.get_objects() if isinstance(x,sage.modular.modsym.ambient.ModularSymbolsAmbient_wtk_g1)]\nsage: l=objgraph.find_backref_chain(a[0],inspect.ismodule,max_depth=15,extra_ignore=[id(a)])\nsage: map(type,l)\n[<type 'module'>, <type 'dict'>, <type 'sage.structure.coerce.CoercionModel_cache_maps'>, <type 'list'>, <type 'tuple'>, <type 'traceback'>, <type 'frame'>, <type 'frame'>, <type 'frame'>, <type 'frame'>, <class 'sage.modular.modsym.ambient.ModularSymbolsAmbient_wtk_g1_with_category'>]\n```",
    "created_at": "2011-03-21T21:55:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10548#issuecomment-100446",
    "user": "https://github.com/koffie"
}
```

<div id="comment:10" align="right">comment:10</div>

Here is some code run on sage 4.6.1 showing that it is really the coercion framework.

```
sage: import gc  
sage: import objgraph
sage: import inspect
sage: m=ModularSymbols(Gamma1(29),use_cache=False)
sage: m=[]
sage: ModularSymbols_clear_cache()
sage: gc.collect()
54
sage: a=[x for x in gc.get_objects() if isinstance(x,sage.modular.modsym.ambient.ModularSymbolsAmbient_wtk_g1)]
sage: l=objgraph.find_backref_chain(a[0],inspect.ismodule,max_depth=15,extra_ignore=[id(a)])
sage: map(type,l)
[<type 'module'>, <type 'dict'>, <type 'sage.structure.coerce.CoercionModel_cache_maps'>, <type 'list'>, <type 'tuple'>, <type 'traceback'>, <type 'frame'>, <type 'frame'>, <type 'frame'>, <type 'frame'>, <class 'sage.modular.modsym.ambient.ModularSymbolsAmbient_wtk_g1_with_category'>]
```



---

archive/issue_comments_100447.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nbtw it goes wrong in the same way on 4.7.alpha1",
    "created_at": "2011-03-21T21:57:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10548#issuecomment-100447",
    "user": "https://github.com/koffie"
}
```

<div id="comment:11" align="right">comment:11</div>

btw it goes wrong in the same way on 4.7.alpha1



---

archive/issue_events_139371.json:
```json
{
    "actor": "https://github.com/craigcitro",
    "created_at": "2011-03-21T22:22:41Z",
    "event": "unassigned",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "subject": "https://github.com/koffie",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10548#event-139371"
}
```



---

archive/issue_events_139372.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2011-03-21T22:22:41Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "subject": "https://github.com/koffie",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10548#event-139372"
}
```



---

archive/issue_events_139373.json:
```json
{
    "actor": "https://github.com/koffie",
    "created_at": "2011-03-21T22:22:41Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20modular%20forms",
    "label_color": "0000ff",
    "label_name": "c: modular forms",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10548#event-139373"
}
```



---

archive/issue_events_139374.json:
```json
{
    "actor": "https://github.com/koffie",
    "created_at": "2011-03-21T22:22:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20coercion",
    "label_color": "eeeeee",
    "label_name": "c: coercion",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10548#event-139374"
}
```



---

archive/issue_events_139375.json:
```json
{
    "actor": "https://github.com/koffie",
    "created_at": "2011-03-21T22:22:41Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "title_is": "The coercion model is keeping references to tracebacks which causes memory leaks.",
    "title_was": "ModularSymbols_clear_cache() not clearing everything?",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10548#event-139375"
}
```



---

archive/issue_comments_100448.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -12,3 +12,5 @@\n sage: \n ```\n So even after garbage collection the modular symbols element is still in memory.\n+\n+When testing please also make sure that the last stackframe from #10570 is also gone.\n``````\n",
    "created_at": "2011-03-21T22:32:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10548#issuecomment-100448",
    "user": "https://github.com/koffie"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -12,3 +12,5 @@
 sage: 
 ```
 So even after garbage collection the modular symbols element is still in memory.
+
+When testing please also make sure that the last stackframe from #10570 is also gone.
``````




---

archive/issue_comments_100449.json:
```json
{
    "body": "Attachment: **[10548-coerce-traceback.patch.gz](https://github.com/sagemath/sage/files/ticket10548/10548-coerce-traceback.patch.gz)**",
    "created_at": "2011-03-22T06:04:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10548#issuecomment-100449",
    "user": "https://github.com/robertwb"
}
```

Attachment: **[10548-coerce-traceback.patch.gz](https://github.com/sagemath/sage/files/ticket10548/10548-coerce-traceback.patch.gz)**



---

archive/issue_events_139376.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2011-03-22T06:05:23Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10548#event-139376"
}
```



---

archive/issue_comments_100450.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nThe attached patch fixes the issue described in the title, but does not fix #715.",
    "created_at": "2011-03-22T06:05:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10548#issuecomment-100450",
    "user": "https://github.com/robertwb"
}
```

<div id="comment:14" align="right">comment:14</div>

The attached patch fixes the issue described in the title, but does not fix #715.



---

archive/issue_comments_100451.json:
```json
{
    "body": "Attachment: **[10548-coerce-traceback.2.patch.gz](https://github.com/sagemath/sage/files/ticket10548/10548-coerce-traceback.2.patch.gz)**\n\nrebased against 4.7.alpha1",
    "created_at": "2011-03-23T18:55:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10548#issuecomment-100451",
    "user": "https://github.com/koffie"
}
```

Attachment: **[10548-coerce-traceback.2.patch.gz](https://github.com/sagemath/sage/files/ticket10548/10548-coerce-traceback.2.patch.gz)**

rebased against 4.7.alpha1



---

archive/issue_comments_100452.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nLooks good to me.",
    "created_at": "2011-03-23T20:09:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10548#issuecomment-100452",
    "user": "https://github.com/koffie"
}
```

<div id="comment:15" align="right">comment:15</div>

Looks good to me.



---

archive/issue_events_139377.json:
```json
{
    "actor": "https://github.com/koffie",
    "created_at": "2011-03-23T20:09:15Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10548#event-139377"
}
```



---

archive/issue_events_139378.json:
```json
{
    "actor": "https://github.com/koffie",
    "created_at": "2011-03-23T20:09:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10548#event-139378"
}
```



---

archive/issue_events_139379.json:
```json
{
    "actor": "https://github.com/koffie",
    "created_at": "2011-03-23T20:30:02Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10548#event-139379"
}
```



---

archive/issue_events_139380.json:
```json
{
    "actor": "https://github.com/koffie",
    "created_at": "2011-03-23T20:30:02Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10548#event-139380"
}
```



---

archive/issue_comments_100453.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nAttachment: **[10548-coerce-traceback-doctest.patch.gz](https://github.com/sagemath/sage/files/ticket10548/10548-coerce-traceback-doctest.patch.gz)**",
    "created_at": "2011-03-23T20:30:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10548#issuecomment-100453",
    "user": "https://github.com/koffie"
}
```

<div id="comment:16" align="right">comment:16</div>

Attachment: **[10548-coerce-traceback-doctest.patch.gz](https://github.com/sagemath/sage/files/ticket10548/10548-coerce-traceback-doctest.patch.gz)**



---

archive/issue_comments_100454.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nRobert, (or someone else), can you review the doctest I added?",
    "created_at": "2011-03-23T20:31:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10548#issuecomment-100454",
    "user": "https://github.com/koffie"
}
```

<div id="comment:17" align="right">comment:17</div>

Robert, (or someone else), can you review the doctest I added?



---

archive/issue_events_139381.json:
```json
{
    "actor": "https://github.com/koffie",
    "created_at": "2011-03-23T20:31:52Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10548#event-139381"
}
```



---

archive/issue_events_139382.json:
```json
{
    "actor": "https://github.com/koffie",
    "created_at": "2011-03-23T20:31:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10548#event-139382"
}
```



---

archive/issue_comments_100455.json:
```json
{
    "body": "Reviewer: **Maarten Derickx**",
    "created_at": "2011-03-23T20:33:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10548#issuecomment-100455",
    "user": "https://github.com/koffie"
}
```

Reviewer: **Maarten Derickx**



---

archive/issue_comments_100456.json:
```json
{
    "body": "Author: **Robert Bradshaw**",
    "created_at": "2011-03-23T20:33:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10548#issuecomment-100456",
    "user": "https://github.com/koffie"
}
```

Author: **Robert Bradshaw**



---

archive/issue_comments_100457.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -14,3 +14,5 @@\n So even after garbage collection the modular symbols element is still in memory.\n \n When testing please also make sure that the last stackframe from #10570 is also gone.\n+\n+apply 10548-coerce-traceback.2.patch  and 10548-coerce-traceback-doctest.patch\n``````\n",
    "created_at": "2011-03-23T20:33:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10548#issuecomment-100457",
    "user": "https://github.com/koffie"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -14,3 +14,5 @@
 So even after garbage collection the modular symbols element is still in memory.
 
 When testing please also make sure that the last stackframe from #10570 is also gone.
+
+apply 10548-coerce-traceback.2.patch  and 10548-coerce-traceback-doctest.patch
``````




---

archive/issue_events_139383.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2011-03-23T21:32:16Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10548#event-139383"
}
```



---

archive/issue_events_139384.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2011-03-23T21:32:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10548#event-139384"
}
```



---

archive/issue_comments_100458.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nThe doctest looks good to me.",
    "created_at": "2011-03-23T21:32:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10548#issuecomment-100458",
    "user": "https://github.com/robertwb"
}
```

<div id="comment:19" align="right">comment:19</div>

The doctest looks good to me.



---

archive/issue_comments_100459.json:
```json
{
    "body": "Attachment: **[trac_10548-coerce-traceback-doctest.v2.patch.gz](https://github.com/sagemath/sage/files/ticket10548/trac_10548-coerce-traceback-doctest.v2.patch.gz)**\n\nnew doctest",
    "created_at": "2011-03-24T22:51:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10548#issuecomment-100459",
    "user": "https://github.com/kini"
}
```

Attachment: **[trac_10548-coerce-traceback-doctest.v2.patch.gz](https://github.com/sagemath/sage/files/ticket10548/trac_10548-coerce-traceback-doctest.v2.patch.gz)**

new doctest



---

archive/issue_comments_100460.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -15,4 +15,4 @@\n \n When testing please also make sure that the last stackframe from #10570 is also gone.\n \n-apply 10548-coerce-traceback.2.patch  and 10548-coerce-traceback-doctest.patch\n+Apply 10548-coerce-traceback.2.patch, trac_10548-coerce-traceback-doctest.v2.patch\n``````\n",
    "created_at": "2011-03-24T22:53:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10548#issuecomment-100460",
    "user": "https://github.com/kini"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -15,4 +15,4 @@
 
 When testing please also make sure that the last stackframe from #10570 is also gone.
 
-apply 10548-coerce-traceback.2.patch  and 10548-coerce-traceback-doctest.patch
+Apply 10548-coerce-traceback.2.patch, trac_10548-coerce-traceback-doctest.v2.patch
``````




---

archive/issue_comments_100461.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nI folded in the doctest from the current patch at #10570, also by Maarten.",
    "created_at": "2011-03-24T22:53:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10548#issuecomment-100461",
    "user": "https://github.com/kini"
}
```

<div id="comment:20" align="right">comment:20</div>

I folded in the doctest from the current patch at #10570, also by Maarten.



---

archive/issue_comments_100462.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -15,4 +15,4 @@\n \n When testing please also make sure that the last stackframe from #10570 is also gone.\n \n-Apply 10548-coerce-traceback.2.patch, trac_10548-coerce-traceback-doctest.v2.patch\n+Apply [attachment: 10548-coerce-traceback.2.patch](https://github.com/sagemath/sage/files/ticket10548/10548-coerce-traceback.2.patch.gz) and [attachment: trac_10548-coerce-traceback-doctest.v2.patch](https://github.com/sagemath/sage/files/ticket10548/trac_10548-coerce-traceback-doctest.v2.patch.gz)\n``````\n",
    "created_at": "2011-04-05T12:09:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10548#issuecomment-100462",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -15,4 +15,4 @@
 
 When testing please also make sure that the last stackframe from #10570 is also gone.
 
-Apply 10548-coerce-traceback.2.patch, trac_10548-coerce-traceback-doctest.v2.patch
+Apply [attachment: 10548-coerce-traceback.2.patch](https://github.com/sagemath/sage/files/ticket10548/10548-coerce-traceback.2.patch.gz) and [attachment: trac_10548-coerce-traceback-doctest.v2.patch](https://github.com/sagemath/sage/files/ticket10548/trac_10548-coerce-traceback-doctest.v2.patch.gz)
``````




---

archive/issue_comments_100463.json:
```json
{
    "body": "Merged: **sage-4.7.alpha4**",
    "created_at": "2011-04-07T19:56:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10548#issuecomment-100463",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-4.7.alpha4**



---

archive/issue_events_139385.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-04-07T19:56:57Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10548#event-139385"
}
```



---

archive/issue_events_139386.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-04-07T19:56:57Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/10548",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10548#event-139386"
}
```
