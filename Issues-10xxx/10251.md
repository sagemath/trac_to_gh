# Issue 10251: Bessel functions of real argument have small imaginary component when scipy is used

archive/issues_010250.json:
```json
{
    "body": "When the scipy algorithm is used to compute the Bessel I, J, Y, K function, the return value often has a small imaginary component (even though the argument is real):\n\n```\n  sage: bessel_J(5, 1.5)\n  0.00179942176736061\n  sage: bessel_J(5, 1.5, algorithm='scipy')\n  0.00179942176736000 + 4.40731221543000e-19*I\n```\nThis does not seem to be a problem with scipy, but is a result of the way in which scipy is called: the argument is first converted into a complex number, and then the corresponding function is called:\n\n```\n  sage: import scipy.special\n  sage: scipy.special.jv(5, 1.5)\n  0.0017994217673606115\n  sage: scipy.special.jv(5, complex(1.5, 0.0))\n  (0.0017994217673606126+4.4073122154284958e-19j)\n```\nOne annoying consequence of this behavior is that straightforward plotting of the bessel functions becomes problematic when the scipy algorithm is used (the command below works fine when another algorithm is used): \n\n```\n  sage: Bessel(5, typ='J', algorithm='scipy').plot(1, 10)\n  verbose 0 (3989: plot.py, generate_plot_points) WARNING: When plotting, failed to evaluate function at 200 points.\n  verbose 0 (3989: plot.py, generate_plot_points) Last error message: 'unable to simplify to float approximation'\n```\n\nThe present patch simply remedies this by adding a few lines to `bessel_{I, J, K, Y}` to check whether the input was real, and if so, to take the real part of the return value.  This is definitely the easiest solution, but maybe a better one exists based on how Sage calls scipy.\n\n**Assignee:** @jasongrout, jkantor\n\n**CC:**  @jdemeyer @jasongrout jkantor\n\n**Keywords:** bessel, scipy, complex\n\n**Author:** Joris Vankerschaver\n\n**Reviewer:** Simon Spicer\n\n**Merged:** sage-4.6.2.alpha3\n\nIssue created by migration from https://trac.sagemath.org/ticket/10251\n\n",
    "closed_at": "2011-01-28T08:48:53Z",
    "created_at": "2010-11-12T06:12:09Z",
    "labels": [
        "component: numerical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.6.2",
    "title": "Bessel functions of real argument have small imaginary component when scipy is used",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10251",
    "user": "https://github.com/jvkersch"
}
```
When the scipy algorithm is used to compute the Bessel I, J, Y, K function, the return value often has a small imaginary component (even though the argument is real):

```
  sage: bessel_J(5, 1.5)
  0.00179942176736061
  sage: bessel_J(5, 1.5, algorithm='scipy')
  0.00179942176736000 + 4.40731221543000e-19*I
```
This does not seem to be a problem with scipy, but is a result of the way in which scipy is called: the argument is first converted into a complex number, and then the corresponding function is called:

```
  sage: import scipy.special
  sage: scipy.special.jv(5, 1.5)
  0.0017994217673606115
  sage: scipy.special.jv(5, complex(1.5, 0.0))
  (0.0017994217673606126+4.4073122154284958e-19j)
```
One annoying consequence of this behavior is that straightforward plotting of the bessel functions becomes problematic when the scipy algorithm is used (the command below works fine when another algorithm is used): 

```
  sage: Bessel(5, typ='J', algorithm='scipy').plot(1, 10)
  verbose 0 (3989: plot.py, generate_plot_points) WARNING: When plotting, failed to evaluate function at 200 points.
  verbose 0 (3989: plot.py, generate_plot_points) Last error message: 'unable to simplify to float approximation'
```

The present patch simply remedies this by adding a few lines to `bessel_{I, J, K, Y}` to check whether the input was real, and if so, to take the real part of the return value.  This is definitely the easiest solution, but maybe a better one exists based on how Sage calls scipy.

**Assignee:** @jasongrout, jkantor

**CC:**  @jdemeyer @jasongrout jkantor

**Keywords:** bessel, scipy, complex

**Author:** Joris Vankerschaver

**Reviewer:** Simon Spicer

**Merged:** sage-4.6.2.alpha3

Issue created by migration from https://trac.sagemath.org/ticket/10251





---

archive/attachments_013404.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "10251_bessel_scipy.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket10251/10251_bessel_scipy.patch",
    "created_at": "2010-11-12T06:19:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/jvkersch"
}
```



---

archive/issue_comments_121433.json:
```json
{
    "body": "",
    "created_at": "2010-11-12T06:19:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-121433",
    "user": "https://github.com/jvkersch"
}
```





---

archive/issue_comments_121434.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2010-11-12T06:21:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-121434",
    "user": "https://github.com/jvkersch"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_121435.json:
```json
{
    "body": "Updated doctests",
    "created_at": "2011-01-07T22:20:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-121435",
    "user": "https://github.com/haikona"
}
```

Updated doctests



---

archive/issue_comments_121436.json:
```json
{
    "body": "**Author:** Joris Vankerschaver",
    "created_at": "2011-01-07T22:23:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-121436",
    "user": "https://github.com/haikona"
}
```

**Author:** Joris Vankerschaver



---

archive/attachments_013405.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "10251_bessel_scipy.2.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket10251/10251_bessel_scipy.2.patch",
    "created_at": "2011-01-07T22:23:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/haikona"
}
```



---

archive/issue_comments_121437.json:
```json
{
    "body": "<a id='comment:2'></a>\nThis patch modifies three functions, but a new doctest was only added for one. This updated patch includes doctests for the remaining two. Otherwise, all checks out.",
    "created_at": "2011-01-07T22:23:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-121437",
    "user": "https://github.com/haikona"
}
```

<a id='comment:2'></a>
This patch modifies three functions, but a new doctest was only added for one. This updated patch includes doctests for the remaining two. Otherwise, all checks out.



---

archive/issue_comments_121438.json:
```json
{
    "body": "**Reviewer:** Simon Spicer",
    "created_at": "2011-01-07T22:23:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-121438",
    "user": "https://github.com/haikona"
}
```

**Reviewer:** Simon Spicer



---

archive/issue_comments_121439.json:
```json
{
    "body": "<a id='comment:3'></a>\nHi Simon,\n\nThanks for spotting this omission and for uploading a new patch!  I ran `make ptestlong` on it and all tests passed correctly, and the modifications look good to me too.  So if you're willing to give the patch a positive review, I think you can go ahead and do so.  Thanks again for your time and effort.\n\nJ.",
    "created_at": "2011-01-24T05:23:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-121439",
    "user": "https://github.com/jvkersch"
}
```

<a id='comment:3'></a>
Hi Simon,

Thanks for spotting this omission and for uploading a new patch!  I ran `make ptestlong` on it and all tests passed correctly, and the modifications look good to me too.  So if you're willing to give the patch a positive review, I think you can go ahead and do so.  Thanks again for your time and effort.

J.



---

archive/issue_comments_121440.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2011-01-24T15:52:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-121440",
    "user": "https://github.com/haikona"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_121441.json:
```json
{
    "body": "<a id='comment:4'></a>\nHi Joris\n\nRoger. I'm not sure if I'm allowed to positive review my own patch submission, but I've gone ahead anyway. 'Twas a pleasure reviewing your work :-)\n\nSimon",
    "created_at": "2011-01-24T15:52:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-121441",
    "user": "https://github.com/haikona"
}
```

<a id='comment:4'></a>
Hi Joris

Roger. I'm not sure if I'm allowed to positive review my own patch submission, but I've gone ahead anyway. 'Twas a pleasure reviewing your work :-)

Simon



---

archive/issue_comments_121442.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [spice](#comment%3A4):\n> Hi Joris\n> \n> Roger. I'm not sure if I'm allowed to positive review my own patch submission, but I've gone ahead anyway.\n\n\nWell, Joris said it was okay.",
    "created_at": "2011-01-24T16:51:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-121442",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>
Replying to [spice](#comment%3A4):
> Hi Joris
> 
> Roger. I'm not sure if I'm allowed to positive review my own patch submission, but I've gone ahead anyway.


Well, Joris said it was okay.



---

archive/issue_comments_121443.json:
```json
{
    "body": "<a id='comment:6'></a>\nI saw it more as you reviewing my contributions and me reviewing your changes, but now that we have the blessing of the release manager himself we're definitely in the clear :)   Thanks guys.",
    "created_at": "2011-01-24T17:01:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-121443",
    "user": "https://github.com/jvkersch"
}
```

<a id='comment:6'></a>
I saw it more as you reviewing my contributions and me reviewing your changes, but now that we have the blessing of the release manager himself we're definitely in the clear :)   Thanks guys.



---

archive/issue_comments_121444.json:
```json
{
    "body": "<a id='comment:7'></a>\nReplying to [jvkersch](#comment%3A6):\n> I saw it more as you reviewing my contributions and me reviewing your changes, but now that we have the blessing of the release manager himself we're definitely in the clear :)\n\n\nDid I mention that these blessings come [at a price](http://www.orval.be/fr/produits/brasserie/brasserie1.html)? :-)",
    "created_at": "2011-01-25T09:22:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-121444",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>
Replying to [jvkersch](#comment%3A6):
> I saw it more as you reviewing my contributions and me reviewing your changes, but now that we have the blessing of the release manager himself we're definitely in the clear :)


Did I mention that these blessings come [at a price](http://www.orval.be/fr/produits/brasserie/brasserie1.html)? :-)



---

archive/issue_events_031892.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-01-25T09:22:37Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "milestone": "sage-4.6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10251#event-31892"
}
```



---

archive/issue_comments_121445.json:
```json
{
    "body": "<a id='comment:8'></a>\nNeeds to be rebased to sage-4.6.2.alpha2:\n\n```\npatching file sage/functions/special.py\nHunk #5 FAILED at 875\nHunk #7 succeeded at 960 with fuzz 2 (offset 12 lines).\n1 out of 7 hunks FAILED -- saving rejects to file sage/functions/special.py.rej\n```",
    "created_at": "2011-01-26T17:27:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-121445",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>
Needs to be rebased to sage-4.6.2.alpha2:

```
patching file sage/functions/special.py
Hunk #5 FAILED at 875
Hunk #7 succeeded at 960 with fuzz 2 (offset 12 lines).
1 out of 7 hunks FAILED -- saving rejects to file sage/functions/special.py.rej
```



---

archive/issue_comments_121446.json:
```json
{
    "body": "**Work_Issues:** rebase",
    "created_at": "2011-01-26T17:27:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-121446",
    "user": "https://github.com/jdemeyer"
}
```

**Work_Issues:** rebase



---

archive/issue_comments_121447.json:
```json
{
    "body": "**Changing status** from positive_review to needs_work.",
    "created_at": "2011-01-26T17:27:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-121447",
    "user": "https://github.com/jdemeyer"
}
```

**Changing status** from positive_review to needs_work.



---

archive/attachments_013406.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "10251_rebase_bessel_scipy.2.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket10251/10251_rebase_bessel_scipy.2.patch",
    "created_at": "2011-01-27T01:00:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/jvkersch"
}
```



---

archive/issue_comments_121448.json:
```json
{
    "body": "",
    "created_at": "2011-01-27T01:00:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-121448",
    "user": "https://github.com/jvkersch"
}
```





---

archive/issue_comments_121449.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2011-01-27T01:11:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-121449",
    "user": "https://github.com/jvkersch"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_121450.json:
```json
{
    "body": "<a id='comment:9'></a>\nI've updated the patch.  The file `sage/functions/special.py` passes doctests, and I'm currently running `make ptestlong`.  I'm updating the status to needs_review since I don't want to give a positive review myself, but this should just be a formality.\n\nJeroen, why don't we have an Orval at one of the upcoming Sage days ;)",
    "created_at": "2011-01-27T01:11:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-121450",
    "user": "https://github.com/jvkersch"
}
```

<a id='comment:9'></a>
I've updated the patch.  The file `sage/functions/special.py` passes doctests, and I'm currently running `make ptestlong`.  I'm updating the status to needs_review since I don't want to give a positive review myself, but this should just be a formality.

Jeroen, why don't we have an Orval at one of the upcoming Sage days ;)



---

archive/issue_comments_121451.json:
```json
{
    "body": "**Changing work_issues** from \"rebase\" to \"\".",
    "created_at": "2011-01-27T14:02:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-121451",
    "user": "https://github.com/jdemeyer"
}
```

**Changing work_issues** from "rebase" to "".



---

archive/issue_comments_121452.json:
```json
{
    "body": "**Merged:** sage-4.6.2.alpha3",
    "created_at": "2011-01-28T08:48:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-121452",
    "user": "https://github.com/jdemeyer"
}
```

**Merged:** sage-4.6.2.alpha3



---

archive/issue_comments_121453.json:
```json
{
    "body": "<a id='comment:11'></a>\nLooks good to me.  Positive review.",
    "created_at": "2011-01-28T08:48:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10251#issuecomment-121453",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>
Looks good to me.  Positive review.



---

archive/issue_events_031893.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-01-28T08:48:53Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/10251",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10251#event-31893"
}
```
