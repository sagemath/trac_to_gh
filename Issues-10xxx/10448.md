# Issue 10448: Extensions of ZZ are not unique parents

archive/issues_010395.json:
```json
{
    "body": "With an unpatched sage-4.6, we have:\n\n```\nsage: R1 = ZZ.extension(x**2+1,'i')\nsage: R1 is ZZ.extension(x**2+1,'i')\nFalse\nsage: R1 is ZZ.extension(x**2+1,'i')\nFalse\n```\n\nI think that should be changed.\n\n**Assignee:** @loefflerd\n\n**Keywords:** uniqueness of parents\n\n**Branch/Commit:** [598334dc5cc01af4bc7a8707e8fc9d77298d9977](https://github.com/sagemath/sagetrac-mirror/commit/598334dc5cc01af4bc7a8707e8fc9d77298d9977)\n\n**Reviewer:** Peter Bruin\n\n**Author:** Julian R\u00fcth\n\nIssue created by migration from https://trac.sagemath.org/ticket/10448\n\n",
    "closed_at": "2014-06-02T12:54:46Z",
    "created_at": "2010-12-09T13:44:32Z",
    "labels": [
        "component: number fields",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-6.3",
    "title": "Extensions of ZZ are not unique parents",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/10448",
    "user": "https://github.com/simon-king-jena"
}
```
With an unpatched sage-4.6, we have:

```
sage: R1 = ZZ.extension(x**2+1,'i')
sage: R1 is ZZ.extension(x**2+1,'i')
False
sage: R1 is ZZ.extension(x**2+1,'i')
False
```

I think that should be changed.

**Assignee:** @loefflerd

**Keywords:** uniqueness of parents

**Branch/Commit:** [598334dc5cc01af4bc7a8707e8fc9d77298d9977](https://github.com/sagemath/sagetrac-mirror/commit/598334dc5cc01af4bc7a8707e8fc9d77298d9977)

**Reviewer:** Peter Bruin

**Author:** Julian RÃ¼th

Issue created by migration from https://trac.sagemath.org/ticket/10448





---

archive/issue_events_079717.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2010-12-09T13:53:26Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "label": "component: elliptic curves",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10448#event-79717"
}
```



---

archive/issue_events_079718.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2010-12-09T13:53:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "label": "component: number fields",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10448#event-79718"
}
```



---

archive/issue_events_079719.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2010-12-09T13:53:26Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "rename": {
        "from": "Side-effect of EllipticCurve.torsion_group: Destroying uniqueness of parents",
        "to": "Extensions of ZZ are not unique parents"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10448#event-79719"
}
```



---

archive/issue_comments_099914.json:
```json
{
    "body": "**Changing assignee** from @JohnCremona to @loefflerd.",
    "created_at": "2010-12-09T13:53:26Z",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10448#issuecomment-99914",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing assignee** from @JohnCremona to @loefflerd.



---

archive/issue_events_079720.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2010-12-09T13:53:26Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "label": "critical",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10448#event-79720"
}
```



---

archive/issue_comments_099915.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,20 +1,11 @@\n-We have\n+With an unpatched sage-4.6, we have:\n \n ```\n-sage: K.<i>=NumberField(x^2 + 1)\n-sage: R = ZZ.extension(x**2+1,'i')\n-sage: f1 = K.coerce_map_from(R)\n-sage: f1.domain() is R\n-True\n-sage: E = EllipticCurve(K,[0,0,0,1,0])\n-sage: E.torsion_subgroup()\n-Torsion Subgroup isomorphic to Z/2 + Z/2 associated to the Elliptic Curve defined by y^2 = x^3 + x over Number Field in i with defining polynomial x^2 + 1\n-sage: R = ZZ.extension(x**2+1,'i')\n-sage: f2 = K.coerce_map_from(R)\n-sage: f2.domain() is R\n+sage: R1 = ZZ.extension(x**2+1,'i')\n+sage: R1 is ZZ.extension(x**2+1,'i')\n False\n-sage: f2.domain() == R\n-True\n+sage: R1 is ZZ.extension(x**2+1,'i')\n+False\n ```\n \n-Hence, on the one hand, computing the torsion group destroys uniqueness of parents, and moreover, it makes the coerce map from an order to its ambient field have a domain that is not the same that is requested.\n+I think that should be changed.\n``````\n",
    "created_at": "2010-12-09T13:53:26Z",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10448#issuecomment-99915",
    "user": "https://github.com/simon-king-jena"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,20 +1,11 @@
-We have
+With an unpatched sage-4.6, we have:
 
 ```
-sage: K.<i>=NumberField(x^2 + 1)
-sage: R = ZZ.extension(x**2+1,'i')
-sage: f1 = K.coerce_map_from(R)
-sage: f1.domain() is R
-True
-sage: E = EllipticCurve(K,[0,0,0,1,0])
-sage: E.torsion_subgroup()
-Torsion Subgroup isomorphic to Z/2 + Z/2 associated to the Elliptic Curve defined by y^2 = x^3 + x over Number Field in i with defining polynomial x^2 + 1
-sage: R = ZZ.extension(x**2+1,'i')
-sage: f2 = K.coerce_map_from(R)
-sage: f2.domain() is R
+sage: R1 = ZZ.extension(x**2+1,'i')
+sage: R1 is ZZ.extension(x**2+1,'i')
 False
-sage: f2.domain() == R
-True
+sage: R1 is ZZ.extension(x**2+1,'i')
+False
 ```
 
-Hence, on the one hand, computing the torsion group destroys uniqueness of parents, and moreover, it makes the coerce map from an order to its ambient field have a domain that is not the same that is requested.
+I think that should be changed.
``````




---

archive/issue_comments_099916.json:
```json
{
    "body": "**Changing keywords** from \"torsion_group, uniqueness of parents, coerce map\" to \"uniqueness of parents\".",
    "created_at": "2010-12-09T13:53:26Z",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10448#issuecomment-99916",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing keywords** from "torsion_group, uniqueness of parents, coerce map" to "uniqueness of parents".



---

archive/issue_comments_099917.json:
```json
{
    "body": "<a id='comment:2'></a>\nSorry for changing the original ticket completely: When I created it, I thought it was a side effect of torsion_subgroup. But in fact, the lacking uniqueness is an independent problem.",
    "created_at": "2010-12-09T13:54:31Z",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10448#issuecomment-99917",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:2'></a>
Sorry for changing the original ticket completely: When I created it, I thought it was a side effect of torsion_subgroup. But in fact, the lacking uniqueness is an independent problem.



---

archive/issue_events_079721.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2010-12-09T14:07:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10448#event-79721"
}
```



---

archive/issue_comments_099918.json:
```json
{
    "body": "**Author:** Simon King",
    "created_at": "2010-12-09T14:07:08Z",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10448#issuecomment-99918",
    "user": "https://github.com/simon-king-jena"
}
```

**Author:** Simon King



---

archive/issue_comments_099919.json:
```json
{
    "body": "<a id='comment:3'></a>\nApparently it suffices to decorate the `order` method of number fields so that it is cached. I added a doctest. I did not do `sage -testall` yet, but I'll do now, and I think I can mark it as \"ready for review\".",
    "created_at": "2010-12-09T14:07:08Z",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10448#issuecomment-99919",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:3'></a>
Apparently it suffices to decorate the `order` method of number fields so that it is cached. I added a doctest. I did not do `sage -testall` yet, but I'll do now, and I think I can mark it as "ready for review".



---

archive/issue_comments_099920.json:
```json
{
    "body": "<a id='comment:4'></a>\nIt needs work: There is some code in heegner.py which calls `.order(...)` with a list, not a tuple. Hence, the `@cached_method` decorator complains.\n\nI'll change it and post a new patch as soon as all tests pass.",
    "created_at": "2010-12-09T16:43:35Z",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10448#issuecomment-99920",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:4'></a>
It needs work: There is some code in heegner.py which calls `.order(...)` with a list, not a tuple. Hence, the `@cached_method` decorator complains.

I'll change it and post a new patch as soon as all tests pass.



---

archive/issue_events_079722.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2010-12-09T16:43:35Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10448#event-79722"
}
```



---

archive/issue_events_079723.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2010-12-09T16:43:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10448#event-79723"
}
```



---

archive/issue_comments_099921.json:
```json
{
    "body": "**Work Issues:** use `order()` with tuples, not lists",
    "created_at": "2010-12-09T16:43:35Z",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10448#issuecomment-99921",
    "user": "https://github.com/simon-king-jena"
}
```

**Work Issues:** use `order()` with tuples, not lists



---

archive/issue_comments_099922.json:
```json
{
    "body": "<a id='comment:5'></a>\nThe updated patch ensures that the new cached `order()` method is called with tuples, not lists. `sage -tp 4` passes for me. Ready for review!",
    "created_at": "2010-12-09T18:26:55Z",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10448#issuecomment-99922",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:5'></a>
The updated patch ensures that the new cached `order()` method is called with tuples, not lists. `sage -tp 4` passes for me. Ready for review!



---

archive/issue_events_079724.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2010-12-09T18:26:55Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10448#event-79724"
}
```



---

archive/issue_events_079725.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2010-12-09T18:26:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10448#event-79725"
}
```



---

archive/issue_comments_099923.json:
```json
{
    "body": "**Changing work issues** from \"use `order()` with tuples, not lists\" to \"\".",
    "created_at": "2010-12-09T18:26:55Z",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10448#issuecomment-99923",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing work issues** from "use `order()` with tuples, not lists" to "".



---

archive/issue_comments_099924.json:
```json
{
    "body": "<a id='comment:6'></a>\nI don't like this: it's something of a convention in Sage that functions creating an object given some generators tend to take lists, and forcing \"order\" to take only tuples breaks that, which is confusing for the user. I'd be much happier if this was implemented differently so `order` could take a list (e.g. by tuplifying its arguments and calling a second internal method, `_order_from_cache` or suchlike, which used the `@cached_method` machinery).\n\nOthers may disagree, so I'm leaving this at \"needs_review\".",
    "created_at": "2010-12-16T13:28:27Z",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10448#issuecomment-99924",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:6'></a>
I don't like this: it's something of a convention in Sage that functions creating an object given some generators tend to take lists, and forcing "order" to take only tuples breaks that, which is confusing for the user. I'd be much happier if this was implemented differently so `order` could take a list (e.g. by tuplifying its arguments and calling a second internal method, `_order_from_cache` or suchlike, which used the `@cached_method` machinery).

Others may disagree, so I'm leaving this at "needs_review".



---

archive/issue_comments_099925.json:
```json
{
    "body": "<a id='comment:7'></a>\nThat was exactly my first thought as well, we should not require the list of generators to be a tuple. (As well as breaking convention, this will break people's existing code.) \n\nMuch better to just convert gens to a tuple in the called function.",
    "created_at": "2010-12-16T16:57:37Z",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10448#issuecomment-99925",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:7'></a>
That was exactly my first thought as well, we should not require the list of generators to be a tuple. (As well as breaking convention, this will break people's existing code.) 

Much better to just convert gens to a tuple in the called function.



---

archive/issue_events_079726.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2010-12-16T16:57:37Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10448#event-79726"
}
```



---

archive/issue_events_079727.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2010-12-16T16:57:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10448#event-79727"
}
```



---

archive/attachments_014110.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "10448_unique_orders_in_numberfields.patch",
    "asset_url": "tarball://root/attachments/ticket10448/10448_unique_orders_in_numberfields.patch",
    "created_at": "2010-12-16T20:50:53Z",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket10448/10448_unique_orders_in_numberfields.patch",
    "user": "https://github.com/simon-king-jena"
}
```



---

archive/issue_comments_099926.json:
```json
{
    "body": "**Attachment:** [10448_unique_orders_in_numberfields.patch](https://github.com/sagemath/sage/files/ticket10448/10448_unique_orders_in_numberfields.patch)\n\nMake orders in number fields unique",
    "created_at": "2010-12-16T20:50:53Z",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10448#issuecomment-99926",
    "user": "https://github.com/simon-king-jena"
}
```

**Attachment:** [10448_unique_orders_in_numberfields.patch](https://github.com/sagemath/sage/files/ticket10448/10448_unique_orders_in_numberfields.patch)

Make orders in number fields unique



---

archive/issue_comments_099927.json:
```json
{
    "body": "<a id='comment:8'></a>\nDear David, dear Robert\n\nReplying to [robertwb](#comment%3A7):\n> That was exactly my first thought as well, we should not require the list of generators to be a tuple. (As well as breaking convention, this will break people's existing code.) \n> \n> Much better to just convert gens to a tuple in the called function. \n\n\nThere is a convenient way: Everything is based on the function `sage.rings.number_field.order.absolute_order_from_module_generators`. This function is not supposed to be called directly, if I understand correctly. Hence, it won't hurt to change the expected input of that function (or of `sage.rings.number_field.order.absolute_order_from_ring_generators`).\n\nMy solution is:\n* Prepend `sage.rings.number_field.order.absolute_order_from_module_generators` with `@cached_function`.\n* The generators must form a tuple, so, the internals of some methods need to be adapted.\n* In addition to the tuple of generators, I suggest that the field is passed as an argument as well.\n\nThe last point is for preventing coercion trouble: If there is a coercion from number field K to number field L and if only the tuple of generators would be cached, then orders in K would be identic to orders in L. Therefore, the field *must* be included in the cache data.\n\nAnyway. I reverted part of the doctests, so that we have tests where `K.order(...)` is called with a single element, with a list of elements, or with a tuple of elements. And of course we have a new test for the cache. Ready for review, I guess.",
    "created_at": "2010-12-16T21:01:49Z",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10448#issuecomment-99927",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:8'></a>
Dear David, dear Robert

Replying to [robertwb](#comment%3A7):
> That was exactly my first thought as well, we should not require the list of generators to be a tuple. (As well as breaking convention, this will break people's existing code.) 
> 
> Much better to just convert gens to a tuple in the called function. 


There is a convenient way: Everything is based on the function `sage.rings.number_field.order.absolute_order_from_module_generators`. This function is not supposed to be called directly, if I understand correctly. Hence, it won't hurt to change the expected input of that function (or of `sage.rings.number_field.order.absolute_order_from_ring_generators`).

My solution is:
* Prepend `sage.rings.number_field.order.absolute_order_from_module_generators` with `@cached_function`.
* The generators must form a tuple, so, the internals of some methods need to be adapted.
* In addition to the tuple of generators, I suggest that the field is passed as an argument as well.

The last point is for preventing coercion trouble: If there is a coercion from number field K to number field L and if only the tuple of generators would be cached, then orders in K would be identic to orders in L. Therefore, the field *must* be included in the cache data.

Anyway. I reverted part of the doctests, so that we have tests where `K.order(...)` is called with a single element, with a list of elements, or with a tuple of elements. And of course we have a new test for the cache. Ready for review, I guess.



---

archive/issue_events_079728.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2010-12-16T21:01:49Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10448#event-79728"
}
```



---

archive/issue_events_079729.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2010-12-16T21:01:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10448#event-79729"
}
```



---

archive/issue_comments_099928.json:
```json
{
    "body": "<a id='comment:9'></a>\nI somewhat prefer using `sage.structure.factory.UniqueFactory` rather than `cached_function` for object creation.  The benefits are that you get better handling of duplicate keys, pickling and unpickling via the factory.  What you've implemented is certainly better than the status quo though, and I'd be up for giving it a positive review; I just wanted to bring up the `UniqueFactory` approach in case you felt motivated to do it.  :-)",
    "created_at": "2010-12-22T10:47:47Z",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10448#issuecomment-99928",
    "user": "https://github.com/roed314"
}
```

<a id='comment:9'></a>
I somewhat prefer using `sage.structure.factory.UniqueFactory` rather than `cached_function` for object creation.  The benefits are that you get better handling of duplicate keys, pickling and unpickling via the factory.  What you've implemented is certainly better than the status quo though, and I'd be up for giving it a positive review; I just wanted to bring up the `UniqueFactory` approach in case you felt motivated to do it.  :-)



---

archive/issue_comments_099929.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [roed](#comment%3A9):\n> I somewhat prefer using `sage.structure.factory.UniqueFactory` rather than `cached_function` for object creation.  The benefits are that you get better handling of duplicate keys, pickling and unpickling via the factory.\n\n\nThat would indeed be nice, but I currently don't have the time resources to implement it.",
    "created_at": "2011-01-18T06:58:07Z",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10448#issuecomment-99929",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:10'></a>
Replying to [roed](#comment%3A9):
> I somewhat prefer using `sage.structure.factory.UniqueFactory` rather than `cached_function` for object creation.  The benefits are that you get better handling of duplicate keys, pickling and unpickling via the factory.


That would indeed be nice, but I currently don't have the time resources to implement it.



---

archive/issue_events_079730.json:
```json
{
    "actor": "https://github.com/loefflerd",
    "created_at": "2011-01-20T11:27:00Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10448#event-79730"
}
```



---

archive/issue_events_079731.json:
```json
{
    "actor": "https://github.com/loefflerd",
    "created_at": "2011-01-20T11:27:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10448#event-79731"
}
```



---

archive/issue_comments_099930.json:
```json
{
    "body": "<a id='comment:11'></a>\nThere is a risk of this breaking garbage collection of number fields. \n\nThe number field code is quite carefully written so that number fields are globally unique, but only weak references to them are cached, so the uniqueness doesn't mean they hang around in memory longer than they should. The patch here would have the disadvantage that as soon as one created any order in a number field, the order (and hence also its parent number field) would hang around for the rest of the Sage session, as an entry in the cache of `absolute_order_from_module_generators`. \n\n(Using `UniqueFactory` wouldn't solve this; it would cache weak references so that orders could still be garbage collected, but these weakrefs would be stored in a cache whose *keys* included the number field, so the number field still couldn't be garbage collected.)\n\nThe best solution I can think of would be to store orders in a cache which was itself an attribute of the parent number field. This could be implemented by making `order` tuplify its arguments and then call a second *method* `_order_from_cache`, implemented using `@cached_method` as usual. Then the second method's cache is then an attribute of the number field, and hence (a) there is no need to include the number field in the arguments, and (b) the number field and the orders can be garbage collected without problems. (This is what I suggested 5 weeks ago.)\n\nOn the other hand, this is all a bit theoretical, because of the issue at ticket #715: it's basically impossible to get rid of *any* parent object created in a Sage session, because the coercion model caches stuff all over the place. But I think we shouldn't compound the problem further here.",
    "created_at": "2011-01-20T11:27:00Z",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10448#issuecomment-99930",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:11'></a>
There is a risk of this breaking garbage collection of number fields. 

The number field code is quite carefully written so that number fields are globally unique, but only weak references to them are cached, so the uniqueness doesn't mean they hang around in memory longer than they should. The patch here would have the disadvantage that as soon as one created any order in a number field, the order (and hence also its parent number field) would hang around for the rest of the Sage session, as an entry in the cache of `absolute_order_from_module_generators`. 

(Using `UniqueFactory` wouldn't solve this; it would cache weak references so that orders could still be garbage collected, but these weakrefs would be stored in a cache whose *keys* included the number field, so the number field still couldn't be garbage collected.)

The best solution I can think of would be to store orders in a cache which was itself an attribute of the parent number field. This could be implemented by making `order` tuplify its arguments and then call a second *method* `_order_from_cache`, implemented using `@cached_method` as usual. Then the second method's cache is then an attribute of the number field, and hence (a) there is no need to include the number field in the arguments, and (b) the number field and the orders can be garbage collected without problems. (This is what I suggested 5 weeks ago.)

On the other hand, this is all a bit theoretical, because of the issue at ticket #715: it's basically impossible to get rid of *any* parent object created in a Sage session, because the coercion model caches stuff all over the place. But I think we shouldn't compound the problem further here.



---

archive/issue_comments_099931.json:
```json
{
    "body": "**Work Issues:** Breaks garbage collection",
    "created_at": "2011-01-20T11:27:00Z",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10448#issuecomment-99931",
    "user": "https://github.com/loefflerd"
}
```

**Work Issues:** Breaks garbage collection



---

archive/issue_comments_099932.json:
```json
{
    "body": "<a id='comment:12'></a>\nHi David,\n\nCurrently I try to produce a patch according to your suggestions. However:\n\nReplying to [davidloeffler](#comment%3A11):\n> There is a risk of this breaking garbage collection of number fields. \n> \n> The number field code is quite carefully written so that number fields are globally unique...\n\n\nThat's not true.\n\n```\nsage: K.<z7> = QuadraticField(7)\nsage: K is loads(dumps(K))\nFalse\n```\n\n> The best solution I can think of would be to store orders in a cache which was itself an attribute of the parent number field. This could be implemented by making `order` tuplify its arguments and then call a second *method* `_order_from_cache`, implemented using `@cached_method` as usual.\n\n\nDoing so, there is indeed uniqueness of orders, and that should also be useful for pickling. However, number fields are not unique parents, and so orders can only be unique in their number fields, but not globally.",
    "created_at": "2011-03-25T14:53:26Z",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10448#issuecomment-99932",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:12'></a>
Hi David,

Currently I try to produce a patch according to your suggestions. However:

Replying to [davidloeffler](#comment%3A11):
> There is a risk of this breaking garbage collection of number fields. 
> 
> The number field code is quite carefully written so that number fields are globally unique...


That's not true.

```
sage: K.<z7> = QuadraticField(7)
sage: K is loads(dumps(K))
False
```

> The best solution I can think of would be to store orders in a cache which was itself an attribute of the parent number field. This could be implemented by making `order` tuplify its arguments and then call a second *method* `_order_from_cache`, implemented using `@cached_method` as usual.


Doing so, there is indeed uniqueness of orders, and that should also be useful for pickling. However, number fields are not unique parents, and so orders can only be unique in their number fields, but not globally.



---

archive/issue_events_079732.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "milestone": "sage-5.11",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10448#event-79732"
}
```



---

archive/issue_events_079733.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10448#event-79733"
}
```



---

archive/issue_events_079734.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "milestone": "sage-6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10448#event-79734"
}
```



---

archive/issue_events_079735.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10448#event-79735"
}
```



---

archive/issue_comments_099933.json:
```json
{
    "body": "**Branch:** [u/saraedum/ticket/10448](https://github.com/sagemath/sagetrac-mirror/tree/u/saraedum/ticket/10448)",
    "created_at": "2014-04-03T06:57:26Z",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10448#issuecomment-99933",
    "user": "https://github.com/saraedum"
}
```

**Branch:** [u/saraedum/ticket/10448](https://github.com/sagemath/sagetrac-mirror/tree/u/saraedum/ticket/10448)



---

archive/issue_comments_099934.json:
```json
{
    "body": "<a id='comment:16'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/598334dc5cc01af4bc7a8707e8fc9d77298d9977\">598334d</a></td><td><code>Improved caching for orders in number fields.</code></td></tr></table>\n",
    "created_at": "2014-04-03T07:01:48Z",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10448#issuecomment-99934",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/598334dc5cc01af4bc7a8707e8fc9d77298d9977">598334d</a></td><td><code>Improved caching for orders in number fields.</code></td></tr></table>




---

archive/issue_comments_099935.json:
```json
{
    "body": "**Commit:** [598334dc5cc01af4bc7a8707e8fc9d77298d9977](https://github.com/sagemath/sagetrac-mirror/commit/598334dc5cc01af4bc7a8707e8fc9d77298d9977)",
    "created_at": "2014-04-03T07:01:48Z",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10448#issuecomment-99935",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Commit:** [598334dc5cc01af4bc7a8707e8fc9d77298d9977](https://github.com/sagemath/sagetrac-mirror/commit/598334dc5cc01af4bc7a8707e8fc9d77298d9977)



---

archive/issue_events_079736.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2014-04-03T07:03:32Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10448#event-79736"
}
```



---

archive/issue_events_079737.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2014-04-03T07:03:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10448#event-79737"
}
```



---

archive/issue_events_079738.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10448#event-79738"
}
```



---

archive/issue_events_079739.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10448#event-79739"
}
```



---

archive/issue_comments_099936.json:
```json
{
    "body": "**Reviewer:** Peter Bruin",
    "created_at": "2014-05-20T17:53:20Z",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10448#issuecomment-99936",
    "user": "https://github.com/pjbruin"
}
```

**Reviewer:** Peter Bruin



---

archive/issue_comments_099937.json:
```json
{
    "body": "<a id='comment:19'></a>\nLooks good to me and passes all tests.  The \"work issues: breaks garbage collection\" isn't relevant anymore, is it?  And what about the \"Authors\" field?",
    "created_at": "2014-05-20T17:53:20Z",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10448#issuecomment-99937",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:19'></a>
Looks good to me and passes all tests.  The "work issues: breaks garbage collection" isn't relevant anymore, is it?  And what about the "Authors" field?



---

archive/issue_comments_099938.json:
```json
{
    "body": "**Changing work issues** from \"Breaks garbage collection\" to \"\".",
    "created_at": "2014-05-29T22:59:22Z",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10448#issuecomment-99938",
    "user": "https://github.com/saraedum"
}
```

**Changing work issues** from "Breaks garbage collection" to "".



---

archive/issue_comments_099939.json:
```json
{
    "body": "**Changing author** from \"Simon King\" to \"Julian R\u00fcth\".",
    "created_at": "2014-05-29T22:59:22Z",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10448#issuecomment-99939",
    "user": "https://github.com/saraedum"
}
```

**Changing author** from "Simon King" to "Julian RÃ¼th".



---

archive/issue_events_079740.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2014-05-29T23:06:48Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10448#event-79740"
}
```



---

archive/issue_events_079741.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2014-05-29T23:06:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10448#event-79741"
}
```



---

archive/issue_comments_099940.json:
```json
{
    "body": "**Changing branch** from \"[u/saraedum/ticket/10448](https://github.com/sagemath/sagetrac-mirror/tree/u/saraedum/ticket/10448)\" to \"[598334dc5cc01af4bc7a8707e8fc9d77298d9977](https://github.com/sagemath/sagetrac-mirror/commit/598334dc5cc01af4bc7a8707e8fc9d77298d9977)\".",
    "created_at": "2014-06-02T12:54:46Z",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10448#issuecomment-99940",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/saraedum/ticket/10448](https://github.com/sagemath/sagetrac-mirror/tree/u/saraedum/ticket/10448)" to "[598334dc5cc01af4bc7a8707e8fc9d77298d9977](https://github.com/sagemath/sagetrac-mirror/commit/598334dc5cc01af4bc7a8707e8fc9d77298d9977)".



---

archive/issue_events_079742.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-06-02T12:54:46Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10448#event-79742"
}
```



---

archive/issue_events_079743.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "abbc216dcc4a6621e976cdca76bba1005902cf27",
    "created_at": "2014-06-02T12:54:46Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/10448",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10448#event-79743"
}
```
