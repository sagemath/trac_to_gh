# Issue 10665: bug in elliptic curve two_descent command

archive/issues_010612.json:
```json
{
    "body": "Don't do it twice:\n\n```\n\nsage: E = EllipticCurve([1,1,0,0,528])\nsage: E.two_descent(verbose=False)\nTrue\nsage: E.two_descent(verbose=False)\n---------------------------------------------------------------------------\nRuntimeError                              Traceback (most recent call last)\n\n/Users/wstein/<ipython console> in <module>()\n\n/Users/wstein/sage/install/sage-4.6.1/local/lib/python2.6/site-packages/sage/schemes/elliptic_curves/ell_rational_field.pyc in two_descent(self, verbose, selmer_only, first_limit, second_limit, n_aux, second_descent)\n    868                         n_aux, second_descent)\n    869         if C.certain():\n--> 870             self.__gens[True] = [self.point(x, check=True) for x in C.gens()]\n    871             self.__gens[True].sort()\n    872             self.__rank[True] = len(self.__gens[True])\n\n/Users/wstein/sage/install/sage-4.6.1/local/lib/python2.6/site-packages/sage/libs/mwrank/interface.pyc in gens(self)\n    598         from sage.misc.all import preparse\n    599         from sage.rings.all import Integer\n--> 600         return eval(preparse(self.__two_descent_data().getbasis().replace(\":\",\",\")))\n    601 \n    602     def certain(self):\n\nRuntimeError: \n```\n\nAssignee: @JohnCremona\n\nBranch/Commit: b437f3539dbda9bdb16c400d406925f3f2a20293\n\nReviewer: Fr\u00e9d\u00e9ric Chapoton\n\nAuthor: Peter Bruin\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/10665\n\n",
    "closed_at": "2014-06-26T19:37:37Z",
    "created_at": "2011-01-20T22:36:34Z",
    "labels": [
        "component: elliptic curves",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.3",
    "title": "bug in elliptic curve two_descent command",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10665",
    "user": "https://github.com/williamstein"
}
```
Don't do it twice:

```

sage: E = EllipticCurve([1,1,0,0,528])
sage: E.two_descent(verbose=False)
True
sage: E.two_descent(verbose=False)
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)

/Users/wstein/<ipython console> in <module>()

/Users/wstein/sage/install/sage-4.6.1/local/lib/python2.6/site-packages/sage/schemes/elliptic_curves/ell_rational_field.pyc in two_descent(self, verbose, selmer_only, first_limit, second_limit, n_aux, second_descent)
    868                         n_aux, second_descent)
    869         if C.certain():
--> 870             self.__gens[True] = [self.point(x, check=True) for x in C.gens()]
    871             self.__gens[True].sort()
    872             self.__rank[True] = len(self.__gens[True])

/Users/wstein/sage/install/sage-4.6.1/local/lib/python2.6/site-packages/sage/libs/mwrank/interface.pyc in gens(self)
    598         from sage.misc.all import preparse
    599         from sage.rings.all import Integer
--> 600         return eval(preparse(self.__two_descent_data().getbasis().replace(":",",")))
    601 
    602     def certain(self):

RuntimeError: 
```

Assignee: @JohnCremona

Branch/Commit: b437f3539dbda9bdb16c400d406925f3f2a20293

Reviewer: Frédéric Chapoton

Author: Peter Bruin

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/10665





---

archive/issue_comments_110954.json:
```json
{
    "body": "<a id='comment:1'></a>This is probably explained by Cremona's comment at #10108:\n\n\"I think I can explain this. The problem to be solved for this ticket was that if mwrank is given incomplete but otherwise correct input, it just waits for the rest of the input, making Sage appear to hang. To fix this I made sure that the input provided by Sage always has some other stuff appended to it, so mwrank never has insufficient input. But then, the *next* time input is sent to mwrank, there is likely to be still some of that extra stuff in its input buffer. To get around that (I thought) I made sure that mwrank was restarted at every call.\n\nClearly what I did was insufficient, but this does explain who the order of executing commands does matter.\"",
    "created_at": "2011-03-23T02:04:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10665#issuecomment-110954",
    "user": "https://trac.sagemath.org/admin/accounts/users/weigandt"
}
```

<a id='comment:1'></a>This is probably explained by Cremona's comment at #10108:

"I think I can explain this. The problem to be solved for this ticket was that if mwrank is given incomplete but otherwise correct input, it just waits for the rest of the input, making Sage appear to hang. To fix this I made sure that the input provided by Sage always has some other stuff appended to it, so mwrank never has insufficient input. But then, the *next* time input is sent to mwrank, there is likely to be still some of that extra stuff in its input buffer. To get around that (I thought) I made sure that mwrank was restarted at every call.

Clearly what I did was insufficient, but this does explain who the order of executing commands does matter."



---

archive/issue_comments_110955.json:
```json
{
    "body": "<a id='comment:2'></a>And there are patches at #10108 which represent a lot of work which have been lying about unused and unmerged just because they are not perfect, even if Sage is better with them than without.",
    "created_at": "2011-03-23T04:02:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10665#issuecomment-110955",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:2'></a>And there are patches at #10108 which represent a lot of work which have been lying about unused and unmerged just because they are not perfect, even if Sage is better with them than without.



---

archive/issue_events_027446.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10665",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10665#event-27446"
}
```



---

archive/issue_events_027447.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10665",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10665#event-27447"
}
```



---

archive/issue_events_027448.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10665",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10665#event-27448"
}
```



---

archive/issue_comments_110956.json:
```json
{
    "body": "<a id='comment:5'></a>Even after #10108, this is still a problem !",
    "created_at": "2014-03-31T12:07:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10665#issuecomment-110956",
    "user": "https://github.com/categorie"
}
```

<a id='comment:5'></a>Even after #10108, this is still a problem !



---

archive/issue_events_027449.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10665",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10665#event-27449"
}
```



---

archive/issue_events_027450.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10665",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10665#event-27450"
}
```



---

archive/issue_comments_110957.json:
```json
{
    "body": "<a id='comment:7'></a>The cause is that each time you call `mwrank_EllipticCurve.two_descent()`, it creates a new `__descent` (the 2-descent data) but does not reset the `__saturate` bound.  Therefore no saturation is done on the new `__descent` data, which is bad because `getbasis()` depends on the saturation having been done.  I'm now testing a patch.",
    "created_at": "2014-06-23T17:45:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10665#issuecomment-110957",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:7'></a>The cause is that each time you call `mwrank_EllipticCurve.two_descent()`, it creates a new `__descent` (the 2-descent data) but does not reset the `__saturate` bound.  Therefore no saturation is done on the new `__descent` data, which is bad because `getbasis()` depends on the saturation having been done.  I'm now testing a patch.



---

archive/issue_comments_110958.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-06-23T18:12:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10665#issuecomment-110958",
    "user": "https://github.com/pjbruin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_110959.json:
```json
{
    "body": "<a id='comment:8'></a>(Note: the change to `if not self.__descent.ok()` is just a trivial simplification, the important line is `self.__saturate = -2`.)",
    "created_at": "2014-06-23T18:12:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10665#issuecomment-110959",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:8'></a>(Note: the change to `if not self.__descent.ok()` is just a trivial simplification, the important line is `self.__saturate = -2`.)



---

archive/issue_comments_110960.json:
```json
{
    "body": "<a id='comment:9'></a>ok, the patchbot is green, and the patch looks simple enough to me.\n\nSo let me give a positive review.",
    "created_at": "2014-06-26T07:11:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10665#issuecomment-110960",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:9'></a>ok, the patchbot is green, and the patch looks simple enough to me.

So let me give a positive review.



---

archive/issue_comments_110961.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-06-26T07:11:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10665#issuecomment-110961",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_110962.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-06-26T19:37:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10665#issuecomment-110962",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_027451.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-06-26T19:37:37Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/10665",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10665#event-27451"
}
```
