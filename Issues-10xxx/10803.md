# Issue 10803: critical bug in real_roots

archive/issues_010737.json:
```json
{
    "body": "This was reported on http://groups.google.com/group/sage-support/msg/6a7c93ad16b892bf:\n\n```\nsage: from sage.rings.polynomial.real_roots import real_roots\nsage: x = polygen(QQ)\nsage: f = 2503841067*x^13 - 15465014877*x^12 + 37514382885*x^11 - 44333754994*x^10 + 24138665092*x^9 - 2059014842*x^8 - 3197810701*x^7 + 803983752*x^6 + 123767204*x^5 - 26596986*x^4 - 2327140*x^3 + 75923*x^2 + 7174*x + 102\nsage: len(real_roots(f)), len(real_roots(f,strategy='warp'))\n(11, 13)\n```\nIt seems different seeds give different numbers of roots:\n\n```\nsage: len(real_roots(f,seed=1))\n11\nsage: len(real_roots(f,seed=3))\n13\n```\n\n**Assignee:** @jasongrout, jkantor\n\n**CC:**  cwitty @williamstein\n\n**Keywords:** real roots, sd40.5\n\n**Reviewer:** Jeroen Demeyer\n\n**Author:** Paul Zimmermann\n\n**Merged:** sage-5.4.1.rc0\n\nIssue created by migration from https://trac.sagemath.org/ticket/10803\n\n",
    "closed_at": "2012-10-17T20:58:58Z",
    "created_at": "2011-02-19T09:04:21Z",
    "labels": [
        "component: numerical",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.4.1",
    "title": "critical bug in real_roots",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10803",
    "user": "https://github.com/zimmermann6"
}
```
This was reported on http://groups.google.com/group/sage-support/msg/6a7c93ad16b892bf:

```
sage: from sage.rings.polynomial.real_roots import real_roots
sage: x = polygen(QQ)
sage: f = 2503841067*x^13 - 15465014877*x^12 + 37514382885*x^11 - 44333754994*x^10 + 24138665092*x^9 - 2059014842*x^8 - 3197810701*x^7 + 803983752*x^6 + 123767204*x^5 - 26596986*x^4 - 2327140*x^3 + 75923*x^2 + 7174*x + 102
sage: len(real_roots(f)), len(real_roots(f,strategy='warp'))
(11, 13)
```
It seems different seeds give different numbers of roots:

```
sage: len(real_roots(f,seed=1))
11
sage: len(real_roots(f,seed=3))
13
```

**Assignee:** @jasongrout, jkantor

**CC:**  cwitty @williamstein

**Keywords:** real roots, sd40.5

**Reviewer:** Jeroen Demeyer

**Author:** Paul Zimmermann

**Merged:** sage-5.4.1.rc0

Issue created by migration from https://trac.sagemath.org/ticket/10803





---

archive/issue_comments_132130.json:
```json
{
    "body": "<a id='comment:1'></a>\nNote that it's not just that real_roots hasn't fully resolved the roots, and so an interval contains more than one root with the right multiplicity being reported, which would also lower len(real_roots(f)).  In the above case two roots are simply missing, as can be confirmed by looking at the reported roots themselves.",
    "created_at": "2011-02-19T12:30:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10803#issuecomment-132130",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

<a id='comment:1'></a>
Note that it's not just that real_roots hasn't fully resolved the roots, and so an interval contains more than one root with the right multiplicity being reported, which would also lower len(real_roots(f)).  In the above case two roots are simply missing, as can be confirmed by looking at the reported roots themselves.



---

archive/issue_comments_132131.json:
```json
{
    "body": "<a id='comment:2'></a>\nReplying to [dsm](#comment%3A1):\n> Note that it's not just that real_roots hasn't fully resolved the roots, and so an interval contains more than one root with the right multiplicity being reported, which would also lower len(real_roots(f)).  In the above case two roots are simply missing, as can be confirmed by looking at the reported roots themselves.\n\n\ngood point. I should have written:\n\n```\nsage: sum(x[1] for x in real_roots(f))\n11\nsage: sum(x[1] for x in real_roots(f,seed=2))\n13\n```\nPaul",
    "created_at": "2011-02-19T12:38:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10803#issuecomment-132131",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:2'></a>
Replying to [dsm](#comment%3A1):
> Note that it's not just that real_roots hasn't fully resolved the roots, and so an interval contains more than one root with the right multiplicity being reported, which would also lower len(real_roots(f)).  In the above case two roots are simply missing, as can be confirmed by looking at the reported roots themselves.


good point. I should have written:

```
sage: sum(x[1] for x in real_roots(f))
11
sage: sum(x[1] for x in real_roots(f,seed=2))
13
```
Paul



---

archive/issue_comments_132132.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -3,10 +3,7 @@\n ```\n sage: from sage.rings.polynomial.real_roots import real_roots\n sage: x = polygen(QQ)\n-sage: f = 2503841067*x^13 - 15465014877*x^12 + 37514382885*x^11 -\n-44333754994*x^10 + 24138665092*x^9 - 2059014842*x^8 - 3197810701*x^7 +\n-803983752*x^6 + 123767204*x^5 - 26596986*x^4 - 2327140*x^3 + 75923*x^2\n-+ 7174*x + 102\n+sage: f = 2503841067*x^13 - 15465014877*x^12 + 37514382885*x^11 - 44333754994*x^10 + 24138665092*x^9 - 2059014842*x^8 - 3197810701*x^7 + 803983752*x^6 + 123767204*x^5 - 26596986*x^4 - 2327140*x^3 + 75923*x^2 + 7174*x + 102\n sage: len(real_roots(f)), len(real_roots(f,strategy='warp'))\n (11, 13)\n ```\n``````\n",
    "created_at": "2011-02-28T19:53:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10803#issuecomment-132132",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -3,10 +3,7 @@
 ```
 sage: from sage.rings.polynomial.real_roots import real_roots
 sage: x = polygen(QQ)
-sage: f = 2503841067*x^13 - 15465014877*x^12 + 37514382885*x^11 -
-44333754994*x^10 + 24138665092*x^9 - 2059014842*x^8 - 3197810701*x^7 +
-803983752*x^6 + 123767204*x^5 - 26596986*x^4 - 2327140*x^3 + 75923*x^2
-+ 7174*x + 102
+sage: f = 2503841067*x^13 - 15465014877*x^12 + 37514382885*x^11 - 44333754994*x^10 + 24138665092*x^9 - 2059014842*x^8 - 3197810701*x^7 + 803983752*x^6 + 123767204*x^5 - 26596986*x^4 - 2327140*x^3 + 75923*x^2 + 7174*x + 102
 sage: len(real_roots(f)), len(real_roots(f,strategy='warp'))
 (11, 13)
 ```
``````




---

archive/issue_comments_132133.json:
```json
{
    "body": "<a id='comment:4'></a>\nLet me point out that `f.real_roots()` **does** seem to work (and uses a different algorithm).",
    "created_at": "2011-04-18T08:38:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10803#issuecomment-132133",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>
Let me point out that `f.real_roots()` **does** seem to work (and uses a different algorithm).



---

archive/issue_comments_132134.json:
```json
{
    "body": "<a id='comment:5'></a>\nHere's what might be a clue:  somehow calling the roots method on the \"ocean\" class fixes the problem (I don't yet have any idea why):\n\n```\nfrom sage.rings.polynomial.real_roots import *\nx = polygen(QQ)\nf = 2503841067*x^13 - 15465014877*x^12 + 37514382885*x^11 - 44333754994*x^10 + 24138665092*x^9 - 2059014842*x^8 - 3197810701*x^7 + 803983752*x^6 + 123767204*x^5 - 26596986*x^4 - 2327140*x^3 + 75923*x^2 + 7174*x + 102\n```\n\n```\nctx = context(False, 1, 32)\nb, other = to_bernstein(f, -1, 7)\noc1 = ocean(ctx, bernstein_polynomial_factory_ratlist(b), linear_map(-1, 7))\noc1.find_roots()\nlen(oc1.roots())\n```\noutputs 11.\n\n```\noc = ocean(ctx, bernstein_polynomial_factory_ratlist(b), linear_map(-1, 7))\n_ =  oc.roots()\noc.find_roots()\nprint len(oc.roots())\n```\noutputs 13.",
    "created_at": "2011-04-22T16:08:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10803#issuecomment-132134",
    "user": "https://trac.sagemath.org/admin/accounts/users/mhampton"
}
```

<a id='comment:5'></a>
Here's what might be a clue:  somehow calling the roots method on the "ocean" class fixes the problem (I don't yet have any idea why):

```
from sage.rings.polynomial.real_roots import *
x = polygen(QQ)
f = 2503841067*x^13 - 15465014877*x^12 + 37514382885*x^11 - 44333754994*x^10 + 24138665092*x^9 - 2059014842*x^8 - 3197810701*x^7 + 803983752*x^6 + 123767204*x^5 - 26596986*x^4 - 2327140*x^3 + 75923*x^2 + 7174*x + 102
```

```
ctx = context(False, 1, 32)
b, other = to_bernstein(f, -1, 7)
oc1 = ocean(ctx, bernstein_polynomial_factory_ratlist(b), linear_map(-1, 7))
oc1.find_roots()
len(oc1.roots())
```
outputs 11.

```
oc = ocean(ctx, bernstein_polynomial_factory_ratlist(b), linear_map(-1, 7))
_ =  oc.roots()
oc.find_roots()
print len(oc.roots())
```
outputs 13.



---

archive/issue_comments_132135.json:
```json
{
    "body": "<a id='comment:6'></a>\nSorry, that was misleading.  Its not calling roots(), its the re-use of the context object that seems to be fixing things.",
    "created_at": "2011-04-22T16:13:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10803#issuecomment-132135",
    "user": "https://trac.sagemath.org/admin/accounts/users/mhampton"
}
```

<a id='comment:6'></a>
Sorry, that was misleading.  Its not calling roots(), its the re-use of the context object that seems to be fixing things.



---

archive/issue_comments_132136.json:
```json
{
    "body": "<a id='comment:7'></a>\nPresumably the re-use of the context object means the seed is not the same, so I guess that's a red herring - my apologies.",
    "created_at": "2011-04-22T16:57:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10803#issuecomment-132136",
    "user": "https://trac.sagemath.org/admin/accounts/users/mhampton"
}
```

<a id='comment:7'></a>
Presumably the re-use of the context object means the seed is not the same, so I guess that's a red herring - my apologies.



---

archive/issue_comments_132137.json:
```json
{
    "body": "<a id='comment:8'></a>\nFYI, here's the smallest case I know:\n\n```\nsage: f = 535944*x^12 - 3312356*x^11 + 8042902*x^10 - 9521317*x^9 + 5204589*x^8 - 461471*x^7 - 682572*x^6 + 174775*x^5 + 25797*x^4 - 5793*x^3 - 473*x^2 + 17*x + 1\nsage: sum(r[1] for r in real_roots(f,seed=1))\n10\nsage: len(f.real_roots())\n12\n```\n\nIt seems pretty sensitive to the initial bounds: (-1,7) fails, as does `(-1,7+1/2^k)` for k=13,14,15,17,21,.. etc. \nUnfortunately debugging is incredibly slow as real_roots.pyx takes forever to compile for me. `:-(`",
    "created_at": "2011-04-22T18:22:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10803#issuecomment-132137",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

<a id='comment:8'></a>
FYI, here's the smallest case I know:

```
sage: f = 535944*x^12 - 3312356*x^11 + 8042902*x^10 - 9521317*x^9 + 5204589*x^8 - 461471*x^7 - 682572*x^6 + 174775*x^5 + 25797*x^4 - 5793*x^3 - 473*x^2 + 17*x + 1
sage: sum(r[1] for r in real_roots(f,seed=1))
10
sage: len(f.real_roots())
12
```

It seems pretty sensitive to the initial bounds: (-1,7) fails, as does `(-1,7+1/2^k)` for k=13,14,15,17,21,.. etc. 
Unfortunately debugging is incredibly slow as real_roots.pyx takes forever to compile for me. `:-(`



---

archive/issue_comments_132138.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [dsm](#comment%3A8):\n> FYI, here's the smallest case I know:\n> \n> ```\n> sage: f = 535944*x^12 - 3312356*x^11 + 8042902*x^10 - 9521317*x^9 + 5204589*x^8 - 461471*x^7 - 682572*x^6 + 174775*x^5 + 25797*x^4 - 5793*x^3 - 473*x^2 + 17*x + 1\n> sage: sum(r[1] for r in real_roots(f,seed=1))\n> 10\n> sage: len(f.real_roots())\n> 12\n> ```\n\n\n\nFYI,\n\n```\nMathematica 7.0 for Sun Solaris x86 (64-bit)\nCopyright 1988-2009 Wolfram Research, Inc.\n\nIn[1]:= f = 535944*x^12 - 3312356*x^11 + 8042902*x^10 - 9521317*x^9 + 5204589*x^8 - 461471*x^7 - 682572*x^6 + 174775*x^5 + 25797*x^4 - 5793*x^3 - 473*x^2 + 17*x + 1\n\n                        2         3          4           5           6\nOut[1]= 1 + 17 x - 473 x  - 5793 x  + 25797 x  + 174775 x  - 682572 x  - \n \n             7            8            9            10            11\n>    461471 x  + 5204589 x  - 9521317 x  + 8042902 x   - 3312356 x   + \n \n             12\n>    535944 x\n\nIn[2]:= NSolve[f==0,x]\n\nOut[2]= {{x -> -0.279345}, {x -> -0.169895}, {x -> -0.0836443}, \n \n>    {x -> -0.0391184}, {x -> 0.0525278}, {x -> 0.217266}, {x -> 0.608742}, \n \n>    {x -> 0.743349}, {x -> 0.955059}, {x -> 0.956605}, {x -> 1.40057}, \n \n>    {x -> 1.8183}}\n\nIn[3]:= Length[%]\n\nOut[3]= 12\n```\n\nWe should add a doctest for this, to check the bug does not come back once it gets fixed. \n\nDave",
    "created_at": "2011-04-27T16:38:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10803#issuecomment-132138",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

<a id='comment:9'></a>
Replying to [dsm](#comment%3A8):
> FYI, here's the smallest case I know:
> 
> ```
> sage: f = 535944*x^12 - 3312356*x^11 + 8042902*x^10 - 9521317*x^9 + 5204589*x^8 - 461471*x^7 - 682572*x^6 + 174775*x^5 + 25797*x^4 - 5793*x^3 - 473*x^2 + 17*x + 1
> sage: sum(r[1] for r in real_roots(f,seed=1))
> 10
> sage: len(f.real_roots())
> 12
> ```



FYI,

```
Mathematica 7.0 for Sun Solaris x86 (64-bit)
Copyright 1988-2009 Wolfram Research, Inc.

In[1]:= f = 535944*x^12 - 3312356*x^11 + 8042902*x^10 - 9521317*x^9 + 5204589*x^8 - 461471*x^7 - 682572*x^6 + 174775*x^5 + 25797*x^4 - 5793*x^3 - 473*x^2 + 17*x + 1

                        2         3          4           5           6
Out[1]= 1 + 17 x - 473 x  - 5793 x  + 25797 x  + 174775 x  - 682572 x  - 
 
             7            8            9            10            11
>    461471 x  + 5204589 x  - 9521317 x  + 8042902 x   - 3312356 x   + 
 
             12
>    535944 x

In[2]:= NSolve[f==0,x]

Out[2]= {{x -> -0.279345}, {x -> -0.169895}, {x -> -0.0836443}, 
 
>    {x -> -0.0391184}, {x -> 0.0525278}, {x -> 0.217266}, {x -> 0.608742}, 
 
>    {x -> 0.743349}, {x -> 0.955059}, {x -> 0.956605}, {x -> 1.40057}, 
 
>    {x -> 1.8183}}

In[3]:= Length[%]

Out[3]= 12
```

We should add a doctest for this, to check the bug does not come back once it gets fixed. 

Dave



---

archive/issue_events_033527.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-05-01T09:40:55Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "milestone": "sage-4.7.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10803#event-33527"
}
```



---

archive/issue_events_033528.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-10-12T20:12:15Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "milestone": "sage-4.7.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10803#event-33528"
}
```



---

archive/issue_comments_132139.json:
```json
{
    "body": "<a id='comment:12'></a>\nI'm concerned by the fact that this ticket was delayed twice (first from 4.7 to 4.7.1, now\nfrom 4.7.2 to 4.7.3, btw why is there no trace of the change from 4.7.1 to 4.7.2) and moreover\nthe priority is now changed from blocker to critical, without any justification.\n\nIs Carl Witty (who wrote the real_roots code as far as I know) still out there?\n\nPaul",
    "created_at": "2011-10-12T20:21:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10803#issuecomment-132139",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:12'></a>
I'm concerned by the fact that this ticket was delayed twice (first from 4.7 to 4.7.1, now
from 4.7.2 to 4.7.3, btw why is there no trace of the change from 4.7.1 to 4.7.2) and moreover
the priority is now changed from blocker to critical, without any justification.

Is Carl Witty (who wrote the real_roots code as far as I know) still out there?

Paul



---

archive/issue_comments_132140.json:
```json
{
    "body": "<a id='comment:13'></a>\nReplying to [zimmerma](#comment%3A12):\n> I'm concerned by the fact that this ticket was delayed twice (first from 4.7 to 4.7.1, now\n> from 4.7.2 to 4.7.3, btw why is there no trace of the change from 4.7.1 to 4.7.2) and moreover\n> the priority is now changed from blocker to critical, without any justification.\n\nWell, it seems nobody really cares much to solve this problem.  I have glanced at the code and it's also hard to understand what is going on.\n\nPersonally I don't think this should a \"blocker\".  Simple mathematical bugs are almost never blockers.  This `real_roots()` code is also not the default real-root computing code.  If you simply do `pol.roots(ring=RR)`, this will use PARI and not this buggy code (there could still be bugs in PARI though).\n\n> Is Carl Witty (who wrote the real_roots code as far as I know) still out there?\n\nAFAIK, he is not really into Sage development anymore.",
    "created_at": "2011-10-13T08:50:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10803#issuecomment-132140",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>
Replying to [zimmerma](#comment%3A12):
> I'm concerned by the fact that this ticket was delayed twice (first from 4.7 to 4.7.1, now
> from 4.7.2 to 4.7.3, btw why is there no trace of the change from 4.7.1 to 4.7.2) and moreover
> the priority is now changed from blocker to critical, without any justification.

Well, it seems nobody really cares much to solve this problem.  I have glanced at the code and it's also hard to understand what is going on.

Personally I don't think this should a "blocker".  Simple mathematical bugs are almost never blockers.  This `real_roots()` code is also not the default real-root computing code.  If you simply do `pol.roots(ring=RR)`, this will use PARI and not this buggy code (there could still be bugs in PARI though).

> Is Carl Witty (who wrote the real_roots code as far as I know) still out there?

AFAIK, he is not really into Sage development anymore.



---

archive/issue_comments_132141.json:
```json
{
    "body": "<a id='comment:14'></a>\n> Well, it seems nobody really cares much to solve this problem.\n\n\nunless someone looks at it first, I will work on this ticket during the SageFlint days in\nDecember.\n\nPaul",
    "created_at": "2011-10-13T09:01:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10803#issuecomment-132141",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:14'></a>
> Well, it seems nobody really cares much to solve this problem.


unless someone looks at it first, I will work on this ticket during the SageFlint days in
December.

Paul



---

archive/issue_comments_132142.json:
```json
{
    "body": "Milestone sage-4.7.3 deleted",
    "created_at": "2011-11-03T16:14:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10803#issuecomment-132142",
    "user": "https://github.com/jdemeyer"
}
```

Milestone sage-4.7.3 deleted



---

archive/issue_events_033529.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/dsm",
    "created_at": "2012-05-31T02:39:22Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "milestone": "sage-5.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10803#event-33529"
}
```



---

archive/issue_comments_132143.json:
```json
{
    "body": "<a id='comment:16'></a>\nIs it likely that anyone's going to look at this?  If not, we should either put in a stopgap (now that we have them) or take a more drastic measure.",
    "created_at": "2012-05-31T02:39:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10803#issuecomment-132143",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

<a id='comment:16'></a>
Is it likely that anyone's going to look at this?  If not, we should either put in a stopgap (now that we have them) or take a more drastic measure.



---

archive/issue_comments_132144.json:
```json
{
    "body": "<a id='comment:17'></a>\nwith the example in the description, over all seeds in [0,999], the number of roots is incorrect only for 1 and 304. Unfortunately 1 is the default seed!\n\nPaul",
    "created_at": "2012-05-31T07:50:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10803#issuecomment-132144",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:17'></a>
with the example in the description, over all seeds in [0,999], the number of roots is incorrect only for 1 and 304. Unfortunately 1 is the default seed!

Paul



---

archive/issue_comments_132145.json:
```json
{
    "body": "**Author:** Paul Zimmermann",
    "created_at": "2012-05-31T09:04:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10803#issuecomment-132145",
    "user": "https://github.com/zimmermann6"
}
```

**Author:** Paul Zimmermann



---

archive/issue_comments_132146.json:
```json
{
    "body": "<a id='comment:18'></a>\nI found out that reducing the Bernstein coefficients to integers fixes the two instances of this bug (the one in the description and the one from comment [comment:8]). Maybe it does not solve all instances, but it is better than nothing, and it should not hurt to work with integers instead of rationals.\n\nI suggest reviewers try to find other instances, for example with:\n\n```\nfrom sage.rings.polynomial.real_roots import real_roots\nR.<x> = ZZ[]\nB=10^11\nfor i in range(10^6):\n   f = R.random_element((i%13)+1,-B,B)\n   print f\n   sys.stdout.flush()\n   n = len(real_roots(f,seed=-1))\n   for s in range(1000):\n      if len(real_roots(f,seed=s))<>n:\n         print f, n, s\n         sys.stdout.flush()\n         raise ValueError\n```\n\nPaul",
    "created_at": "2012-05-31T09:04:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10803#issuecomment-132146",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:18'></a>
I found out that reducing the Bernstein coefficients to integers fixes the two instances of this bug (the one in the description and the one from comment [comment:8]). Maybe it does not solve all instances, but it is better than nothing, and it should not hurt to work with integers instead of rationals.

I suggest reviewers try to find other instances, for example with:

```
from sage.rings.polynomial.real_roots import real_roots
R.<x> = ZZ[]
B=10^11
for i in range(10^6):
   f = R.random_element((i%13)+1,-B,B)
   print f
   sys.stdout.flush()
   n = len(real_roots(f,seed=-1))
   for s in range(1000):
      if len(real_roots(f,seed=s))<>n:
         print f, n, s
         sys.stdout.flush()
         raise ValueError
```

Paul



---

archive/issue_comments_132147.json:
```json
{
    "body": "**Changing keywords** from \"real roots\" to \"real roots, sd40.5\".",
    "created_at": "2012-05-31T09:04:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10803#issuecomment-132147",
    "user": "https://github.com/zimmermann6"
}
```

**Changing keywords** from "real roots" to "real roots, sd40.5".



---

archive/issue_comments_132148.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2012-05-31T09:04:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10803#issuecomment-132148",
    "user": "https://github.com/zimmermann6"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_132149.json:
```json
{
    "body": "<a id='comment:19'></a>\nGiven how sensitive the problem is I think we're going to need to know why whatever we find fixes the problem before we're confident that we've fixed it.  Here I'm not sure that it does.  Digging up some of my old notes, even with the patch, we have problems we shouldn't:\n\n```\nsage: from sage.rings.polynomial.real_roots import real_roots\nsage: R.<x> = ZZ[]       \nsage: f = 535944*x^12 - 3312356*x^11 + 8042902*x^10 - 9521317*x^9 + 5204589*x^8 - 461471*x^7 - 682572*x^6 + 174775*x^5 + 25797*x^4 - 5793*x^3 - 473*x^2 + 17*x + 1\nsage: len(f.roots(RR))\n12\nsage: len(real_roots(f, seed=1))\n12\nsage: # but..\nsage: f.roots(RR)\n[(-0.279345282327294, 1), (-0.169895157384578, 1), (-0.0836442589128367, 1), (-0.0391184461806829, 1), (0.0525277889691767, 1), (0.217266273158562, 1), (0.608742206578326, 1), (0.743349076348040, 1), (0.955058967243006, 1), (0.956604779629507, 1), (1.40057197815310, 1), (1.81829644637645, 1)]\nsage: [len(real_roots(f, seed=1, bounds=(-1, 7+1/2**k))) for k in [0..200]]\n[12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 10, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12]\n```\n\nAnd we see a clearly periodic pattern.  For me real_roots.pyx takes a long time to compile so I got frustrated chasing this clue, but changing the bounds like this -- outside the range of all of the roots! -- should have no effect.  If we could figure out why this happens I think we'd have it.",
    "created_at": "2012-05-31T12:39:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10803#issuecomment-132149",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

<a id='comment:19'></a>
Given how sensitive the problem is I think we're going to need to know why whatever we find fixes the problem before we're confident that we've fixed it.  Here I'm not sure that it does.  Digging up some of my old notes, even with the patch, we have problems we shouldn't:

```
sage: from sage.rings.polynomial.real_roots import real_roots
sage: R.<x> = ZZ[]       
sage: f = 535944*x^12 - 3312356*x^11 + 8042902*x^10 - 9521317*x^9 + 5204589*x^8 - 461471*x^7 - 682572*x^6 + 174775*x^5 + 25797*x^4 - 5793*x^3 - 473*x^2 + 17*x + 1
sage: len(f.roots(RR))
12
sage: len(real_roots(f, seed=1))
12
sage: # but..
sage: f.roots(RR)
[(-0.279345282327294, 1), (-0.169895157384578, 1), (-0.0836442589128367, 1), (-0.0391184461806829, 1), (0.0525277889691767, 1), (0.217266273158562, 1), (0.608742206578326, 1), (0.743349076348040, 1), (0.955058967243006, 1), (0.956604779629507, 1), (1.40057197815310, 1), (1.81829644637645, 1)]
sage: [len(real_roots(f, seed=1, bounds=(-1, 7+1/2**k))) for k in [0..200]]
[12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 10, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12, 12, 12, 10, 12]
```

And we see a clearly periodic pattern.  For me real_roots.pyx takes a long time to compile so I got frustrated chasing this clue, but changing the bounds like this -- outside the range of all of the roots! -- should have no effect.  If we could figure out why this happens I think we'd have it.



---

archive/issue_comments_132150.json:
```json
{
    "body": "<a id='comment:20'></a>\nI've worked a little more on this. It seems the `_count_variations` function is called with a wrong `usign` (sign in x=1 if I understand correctly) in the following case:\n\n```\nenter _count_variations, self= <IBP: ((67412088, 41929949, 16504578, -2435470, -4640) + [0 .. 18683)) * 2^-10 over [3921/16384 .. 8017/32768]; usign 1; level 3; slope_err [-41131.637071203295 .. 41131.637071203295]>\n```\nand then returns 2 changes of sign whereas there is evidently only one in the coefficients.\n\nPaul",
    "created_at": "2012-06-01T08:44:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10803#issuecomment-132150",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:20'></a>
I've worked a little more on this. It seems the `_count_variations` function is called with a wrong `usign` (sign in x=1 if I understand correctly) in the following case:

```
enter _count_variations, self= <IBP: ((67412088, 41929949, 16504578, -2435470, -4640) + [0 .. 18683)) * 2^-10 over [3921/16384 .. 8017/32768]; usign 1; level 3; slope_err [-41131.637071203295 .. 41131.637071203295]>
```
and then returns 2 changes of sign whereas there is evidently only one in the coefficients.

Paul



---

archive/issue_comments_132151.json:
```json
{
    "body": "<a id='comment:21'></a>\nI believe I've found the reason for the bug: the function `down_degree` decreases the\ndegree of the (interval) polynomial, but keeps the value `self.usign`. With the example in the description and `seed=1`, `down_degree` is called with:\n\n```\nenter down_degree, self= <IBP: ((34519150034, 25826190301, 17130808432, 9120071648, 2724478006, -830629355, 3694263) + [0 .. 21299)) * 2^-19 over [3921/16384 .. 8017/32768]; level 2; slope_err [-136.91992834614365 .. 136.91992834614365]> usign= 1\n```\nand the polynomial is reduced to:\n\n```\ncoeffs= (67412088, 41929949, 16504578, -2435470, -4640) n= 5\n```\nwhere it is clear that `usign=1` is wrong, since the sign of `-4640` is -1.\n\nPaul",
    "created_at": "2012-06-01T10:00:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10803#issuecomment-132151",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:21'></a>
I believe I've found the reason for the bug: the function `down_degree` decreases the
degree of the (interval) polynomial, but keeps the value `self.usign`. With the example in the description and `seed=1`, `down_degree` is called with:

```
enter down_degree, self= <IBP: ((34519150034, 25826190301, 17130808432, 9120071648, 2724478006, -830629355, 3694263) + [0 .. 21299)) * 2^-19 over [3921/16384 .. 8017/32768]; level 2; slope_err [-136.91992834614365 .. 136.91992834614365]> usign= 1
```
and the polynomial is reduced to:

```
coeffs= (67412088, 41929949, 16504578, -2435470, -4640) n= 5
```
where it is clear that `usign=1` is wrong, since the sign of `-4640` is -1.

Paul



---

archive/attachments_014152.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_10803.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket10803/trac_10803.patch",
    "created_at": "2012-06-01T12:41:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/zimmermann6"
}
```



---

archive/issue_comments_132152.json:
```json
{
    "body": "<a id='comment:22'></a>\nthe new patch fixes the bug. Ready for review. Thanks Douglas for pushing me to really isolate\nthe reason of the bug.\n\nPaul",
    "created_at": "2012-06-01T12:41:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10803#issuecomment-132152",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:22'></a>
the new patch fixes the bug. Ready for review. Thanks Douglas for pushing me to really isolate
the reason of the bug.

Paul



---

archive/issue_comments_132153.json:
```json
{
    "body": "<a id='comment:23'></a>\nI just checked: the example from comment [comment:19] passes too with the new patch.\n\nPaul",
    "created_at": "2012-06-01T12:44:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10803#issuecomment-132153",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:23'></a>
I just checked: the example from comment [comment:19] passes too with the new patch.

Paul



---

archive/issue_comments_132154.json:
```json
{
    "body": "<a id='comment:24'></a>\nLooks like nice work!  I think we're going to have to add way more testing, though (I can do some of it as a reviewer patch this weekend.)  I have a collection of failing cases and I want to make sure that more of them work; we should specifically doctest your diagnosis, not just the outcome; and I want to test that the bound stuff now works.\n\nNow that we know the problem it should be much easier to construct more test cases, too.",
    "created_at": "2012-06-01T12:56:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10803#issuecomment-132154",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

<a id='comment:24'></a>
Looks like nice work!  I think we're going to have to add way more testing, though (I can do some of it as a reviewer patch this weekend.)  I have a collection of failing cases and I want to make sure that more of them work; we should specifically doctest your diagnosis, not just the outcome; and I want to test that the bound stuff now works.

Now that we know the problem it should be much easier to construct more test cases, too.



---

archive/issue_comments_132155.json:
```json
{
    "body": "<a id='comment:25'></a>\nSince the reviewer patch didn't happen, let's put positive_review here.  You can still add more examples on a new ticket.",
    "created_at": "2012-10-05T10:24:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10803#issuecomment-132155",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:25'></a>
Since the reviewer patch didn't happen, let's put positive_review here.  You can still add more examples on a new ticket.



---

archive/issue_comments_132156.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2012-10-05T10:24:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10803#issuecomment-132156",
    "user": "https://github.com/jdemeyer"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_events_033530.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-10-05T10:24:36Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "milestone": "sage-5.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10803#event-33530"
}
```



---

archive/issue_events_033531.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-10-05T10:24:36Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "milestone": "sage-5.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10803#event-33531"
}
```



---

archive/issue_comments_132157.json:
```json
{
    "body": "**Reviewer:** Jeroen Demeyer",
    "created_at": "2012-10-05T10:24:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10803#issuecomment-132157",
    "user": "https://github.com/jdemeyer"
}
```

**Reviewer:** Jeroen Demeyer



---

archive/issue_comments_132158.json:
```json
{
    "body": "**Merged:** sage-5.5.beta0",
    "created_at": "2012-10-17T20:58:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10803#issuecomment-132158",
    "user": "https://github.com/jdemeyer"
}
```

**Merged:** sage-5.5.beta0



---

archive/issue_events_033532.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-10-17T20:58:58Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10803#event-33532"
}
```



---

archive/issue_comments_132159.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -15,7 +15,3 @@\n sage: len(real_roots(f,seed=3))\n 13\n ```\n-I mark this as blocker since counting properly the number of real\n-roots of a polynomial is a very basic thing for a computer algebra system.\n-\n-Paul\n``````\n",
    "created_at": "2012-11-05T14:47:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10803#issuecomment-132159",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -15,7 +15,3 @@
 sage: len(real_roots(f,seed=3))
 13
 ```
-I mark this as blocker since counting properly the number of real
-roots of a polynomial is a very basic thing for a computer algebra system.
-
-Paul
``````




---

archive/issue_comments_132160.json:
```json
{
    "body": "**Changing merged** from \"sage-5.5.beta0\" to \"sage-5.4.1.rc0\".",
    "created_at": "2012-11-05T14:47:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10803#issuecomment-132160",
    "user": "https://github.com/jdemeyer"
}
```

**Changing merged** from "sage-5.5.beta0" to "sage-5.4.1.rc0".



---

archive/issue_events_033533.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-11-05T14:48:10Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "milestone": "sage-5.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10803#event-33533"
}
```



---

archive/issue_events_033534.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-11-05T14:48:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10803",
    "milestone": "sage-5.4.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10803#event-33534"
}
```
