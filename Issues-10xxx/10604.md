# Issue 10604: Rewrite diagonal matrix constructor

archive/issues_010551.json:
```json
{
    "assignees": [],
    "body": "Diagonal matrix constructor fails when given a tuple, and there is a request to support numpy arrays as input.  This seems easiest to accomplish with a re-write and documentation upgrade.\n\n`NumPy` array request:\nhttp://groups.google.com/group/sage-devel/browse_thread/thread/f0ecd06fcf9efb1b\n\n```\nsage: diagonal_matrix( (1,2,3) )\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n\n/home/sage/sage-4.6.1.rc1/devel/sage-main/<ipython console> in <module>()\n\n/home/sage/sage-4.6.1.rc1/local/lib/python2.6/site-packages/sage/matrix/constructor.pyc in diagonal_matrix(arg0, arg1, arg2, sparse)\n   1271 \n   1272     if ring is None:\n-> 1273         return matrix(nrows, nrows, w, sparse=sparse)\n   1274     else:\n   1275         return matrix(ring, nrows, nrows, w, sparse=sparse)\n\n/home/sage/sage-4.6.1.rc1/local/lib/python2.6/site-packages/sage/matrix/constructor.pyc in matrix(*args, **kwds)\n    577                         ncols = len(args[0]) // nrows\n    578                     elif ncols != len(args[0]) // nrows:\n--> 579                         raise ValueError, \"entries has the wrong length\"\n    580                 elif len(args[0]) > 0:\n    581                     raise ValueError, \"entries has the wrong length\"\n\nValueError: entries has the wrong length\n```\n\n**Apply:**\n\n* [attachment:trac_10604-diagonal-matrix-constructor-v2.patch](https://github.com/sagemath/sage/files/ticket10604/trac_10604-diagonal-matrix-constructor-v2.patch) \n* [attachment:trac_10604_fix_matrix_stack](https://github.com/sagemath/sage/files/ticket10604/trac_10604_fix_matrix_stack)\n\nDepends: #10626\n\n**Assignee:** @dandrake\n\n**CC:**  @dandrake\n\n**Author:** Rob Beezer, Dan Drake\n\n**Reviewer:** Dan Drake, Rob Beezer\n\n**Merged:** sage-4.6.2.alpha4\n\nIssue created by migration from https://trac.sagemath.org/ticket/10604\n\n",
    "closed_at": "2011-02-07T08:15:35Z",
    "created_at": "2011-01-12T18:53:22Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20linear%20algebra",
        "https://github.com/sagemath/sage/labels/minor",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-4.6.2",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Rewrite diagonal matrix constructor",
    "type": "issue",
    "updated_at": "2011-02-07T08:15:35Z",
    "url": "https://github.com/sagemath/sage/issues/10604",
    "user": "https://github.com/rbeezer"
}
```
Diagonal matrix constructor fails when given a tuple, and there is a request to support numpy arrays as input.  This seems easiest to accomplish with a re-write and documentation upgrade.

`NumPy` array request:
http://groups.google.com/group/sage-devel/browse_thread/thread/f0ecd06fcf9efb1b

```
sage: diagonal_matrix( (1,2,3) )
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)

/home/sage/sage-4.6.1.rc1/devel/sage-main/<ipython console> in <module>()

/home/sage/sage-4.6.1.rc1/local/lib/python2.6/site-packages/sage/matrix/constructor.pyc in diagonal_matrix(arg0, arg1, arg2, sparse)
   1271 
   1272     if ring is None:
-> 1273         return matrix(nrows, nrows, w, sparse=sparse)
   1274     else:
   1275         return matrix(ring, nrows, nrows, w, sparse=sparse)

/home/sage/sage-4.6.1.rc1/local/lib/python2.6/site-packages/sage/matrix/constructor.pyc in matrix(*args, **kwds)
    577                         ncols = len(args[0]) // nrows
    578                     elif ncols != len(args[0]) // nrows:
--> 579                         raise ValueError, "entries has the wrong length"
    580                 elif len(args[0]) > 0:
    581                     raise ValueError, "entries has the wrong length"

ValueError: entries has the wrong length
```

**Apply:**

* [attachment:trac_10604-diagonal-matrix-constructor-v2.patch](https://github.com/sagemath/sage/files/ticket10604/trac_10604-diagonal-matrix-constructor-v2.patch) 
* [attachment:trac_10604_fix_matrix_stack](https://github.com/sagemath/sage/files/ticket10604/trac_10604_fix_matrix_stack)

Depends: #10626

**Assignee:** @dandrake

**CC:**  @dandrake

**Author:** Rob Beezer, Dan Drake

**Reviewer:** Dan Drake, Rob Beezer

**Merged:** sage-4.6.2.alpha4

Issue created by migration from https://trac.sagemath.org/ticket/10604





---

archive/issue_events_117465.json:
```json
{
    "actor": "https://github.com/rbeezer",
    "created_at": "2011-01-12T18:53:22Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "milestone_number": null,
    "milestone_title": "sage-4.6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10604#event-117465"
}
```



---

archive/issue_events_117466.json:
```json
{
    "actor": "https://github.com/rbeezer",
    "created_at": "2011-01-12T18:53:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20linear%20algebra",
    "label_color": "08517b",
    "label_name": "component: linear algebra",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10604#event-117466"
}
```



---

archive/issue_events_117467.json:
```json
{
    "actor": "https://github.com/rbeezer",
    "created_at": "2011-01-12T18:53:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "label": "https://github.com/sagemath/sage/labels/minor",
    "label_color": "ff0000",
    "label_name": "minor",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10604#event-117467"
}
```



---

archive/issue_events_117468.json:
```json
{
    "actor": "https://github.com/rbeezer",
    "created_at": "2011-01-12T18:53:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "008080",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10604#event-117468"
}
```



---

archive/issue_comments_103296.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1 +1,28 @@\n Diagonal matrix constructor fails when given a tuple, and there is a request to support numpy arrays as input.  This seems easiest to accomplish with a re-write and documentation upgrade.\n+\n+`NumPy` array request:\n+http://groups.google.com/group/sage-devel/browse_thread/thread/f0ecd06fcf9efb1b\n+\n+```\n+sage: diagonal_matrix( (1,2,3) )\n+---------------------------------------------------------------------------\n+ValueError                                Traceback (most recent call last)\n+\n+/home/sage/sage-4.6.1.rc1/devel/sage-main/<ipython console> in <module>()\n+\n+/home/sage/sage-4.6.1.rc1/local/lib/python2.6/site-packages/sage/matrix/constructor.pyc in diagonal_matrix(arg0, arg1, arg2, sparse)\n+   1271 \n+   1272     if ring is None:\n+-> 1273         return matrix(nrows, nrows, w, sparse=sparse)\n+   1274     else:\n+   1275         return matrix(ring, nrows, nrows, w, sparse=sparse)\n+\n+/home/sage/sage-4.6.1.rc1/local/lib/python2.6/site-packages/sage/matrix/constructor.pyc in matrix(*args, **kwds)\n+    577                         ncols = len(args[0]) // nrows\n+    578                     elif ncols != len(args[0]) // nrows:\n+--> 579                         raise ValueError, \"entries has the wrong length\"\n+    580                 elif len(args[0]) > 0:\n+    581                     raise ValueError, \"entries has the wrong length\"\n+\n+ValueError: entries has the wrong length\n+```\n``````\n",
    "created_at": "2011-01-12T18:57:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10604#issuecomment-103296",
    "user": "https://github.com/rbeezer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1 +1,28 @@
 Diagonal matrix constructor fails when given a tuple, and there is a request to support numpy arrays as input.  This seems easiest to accomplish with a re-write and documentation upgrade.
+
+`NumPy` array request:
+http://groups.google.com/group/sage-devel/browse_thread/thread/f0ecd06fcf9efb1b
+
+```
+sage: diagonal_matrix( (1,2,3) )
+---------------------------------------------------------------------------
+ValueError                                Traceback (most recent call last)
+
+/home/sage/sage-4.6.1.rc1/devel/sage-main/<ipython console> in <module>()
+
+/home/sage/sage-4.6.1.rc1/local/lib/python2.6/site-packages/sage/matrix/constructor.pyc in diagonal_matrix(arg0, arg1, arg2, sparse)
+   1271 
+   1272     if ring is None:
+-> 1273         return matrix(nrows, nrows, w, sparse=sparse)
+   1274     else:
+   1275         return matrix(ring, nrows, nrows, w, sparse=sparse)
+
+/home/sage/sage-4.6.1.rc1/local/lib/python2.6/site-packages/sage/matrix/constructor.pyc in matrix(*args, **kwds)
+    577                         ncols = len(args[0]) // nrows
+    578                     elif ncols != len(args[0]) // nrows:
+--> 579                         raise ValueError, "entries has the wrong length"
+    580                 elif len(args[0]) > 0:
+    581                     raise ValueError, "entries has the wrong length"
+
+ValueError: entries has the wrong length
+```
``````




---

archive/issue_comments_103297.json:
```json
{
    "body": "<a id='comment:3'></a>\n**Attachment:** [trac_10604-diagonal-matrix-constructor.patch.gz](https://github.com/sagemath/sage/files/ticket10604/trac_10604-diagonal-matrix-constructor.patch.gz)\n\nPatch contains an overhaul of the `diagonal_matrix()` constructor, fixing at least one bug, and adding support for `NumPy` arrays as input.  Two observations:\n\n1.  Results are now sparse matrices by default.  This is a change in behavior, but causes no doctest failures anywhere in the Sage library.\n\n2.  Original doctests for this function will still pass.  They are gone now, but were the last thing to be deleted and were fully tested.",
    "created_at": "2011-01-12T21:56:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10604#issuecomment-103297",
    "user": "https://github.com/rbeezer"
}
```

<a id='comment:3'></a>
**Attachment:** [trac_10604-diagonal-matrix-constructor.patch.gz](https://github.com/sagemath/sage/files/ticket10604/trac_10604-diagonal-matrix-constructor.patch.gz)

Patch contains an overhaul of the `diagonal_matrix()` constructor, fixing at least one bug, and adding support for `NumPy` arrays as input.  Two observations:

1.  Results are now sparse matrices by default.  This is a change in behavior, but causes no doctest failures anywhere in the Sage library.

2.  Original doctests for this function will still pass.  They are gone now, but were the last thing to be deleted and were fully tested.



---

archive/issue_events_117469.json:
```json
{
    "actor": "https://github.com/rbeezer",
    "created_at": "2011-01-12T21:56:50Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10604#event-117469"
}
```



---

archive/issue_comments_103298.json:
```json
{
    "body": "**Reviewer:** Dan Drake",
    "created_at": "2011-01-12T22:20:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10604#issuecomment-103298",
    "user": "https://github.com/dandrake"
}
```

**Reviewer:** Dan Drake



---

archive/issue_comments_103299.json:
```json
{
    "body": "**Author:** Rob Beezer",
    "created_at": "2011-01-12T22:20:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10604#issuecomment-103299",
    "user": "https://github.com/dandrake"
}
```

**Author:** Rob Beezer



---

archive/issue_comments_103300.json:
```json
{
    "body": "<a id='comment:4'></a>\nI read over the code and it looks nice. I love patches that add tons and tons of documentation! I'll run some doctests and make sure this works properly.",
    "created_at": "2011-01-12T22:20:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10604#issuecomment-103300",
    "user": "https://github.com/dandrake"
}
```

<a id='comment:4'></a>
I read over the code and it looks nice. I love patches that add tons and tons of documentation! I'll run some doctests and make sure this works properly.



---

archive/issue_comments_103301.json:
```json
{
    "body": "**Changing assignee** from @jasongrout, @williamstein to @dandrake.",
    "created_at": "2011-01-12T23:18:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10604#issuecomment-103301",
    "user": "https://github.com/dandrake"
}
```

**Changing assignee** from @jasongrout, @williamstein to @dandrake.



---

archive/issue_comments_103302.json:
```json
{
    "body": "<a id='comment:5'></a>\nHmm, this is weird:\n\n```\nsage: v = numpy.array([1,2,3,100000])\nsage: m = diagonal_matrix(v)\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n\n/mnt/usb1/scratch/drake/days27/sage-4.6.1.rc1/<ipython console> in <module>()\n\n/mnt/usb1/scratch/drake/days27/sage-4.6.1.rc1/local/lib/python2.6/site-packages/sage/matrix/constructor.pyc in diagonal_matrix(arg0, arg1, arg2, sparse)\n   1392         if str(entries.dtype).count('complex')==1:\n   1393             ring = CDF\n-> 1394         v = [ring(x) for x in entries]\n   1395     else:\n   1396         raise TypeError('diagonal matrix entries are not a supported type (list, tuple, vector, or NumPy array)')\n\nTypeError: 'NoneType' object is not callable\n```\n\nYour examples seem to have all RDF entries; my example has numpy int64 entries. Do you see what's going on here?",
    "created_at": "2011-01-12T23:18:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10604#issuecomment-103302",
    "user": "https://github.com/dandrake"
}
```

<a id='comment:5'></a>
Hmm, this is weird:

```
sage: v = numpy.array([1,2,3,100000])
sage: m = diagonal_matrix(v)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)

/mnt/usb1/scratch/drake/days27/sage-4.6.1.rc1/<ipython console> in <module>()

/mnt/usb1/scratch/drake/days27/sage-4.6.1.rc1/local/lib/python2.6/site-packages/sage/matrix/constructor.pyc in diagonal_matrix(arg0, arg1, arg2, sparse)
   1392         if str(entries.dtype).count('complex')==1:
   1393             ring = CDF
-> 1394         v = [ring(x) for x in entries]
   1395     else:
   1396         raise TypeError('diagonal matrix entries are not a supported type (list, tuple, vector, or NumPy array)')

TypeError: 'NoneType' object is not callable
```

Your examples seem to have all RDF entries; my example has numpy int64 entries. Do you see what's going on here?



---

archive/issue_comments_103303.json:
```json
{
    "body": "<a id='comment:6'></a>\nI'm also seeing a doctest failure:\n\n```\ndrake@sage.math:/scratch/drake/days27/sage-4.6.1.rc1$ ./sage -t  devel/sage-main/sage/rings/number_field/number_field_ideal.p\ny\nsage -t  \"devel/sage-main/sage/rings/number_field/number_field_ideal.py\" \n**********************************************************************   \nFile \"/mnt/usb1/scratch/drake/days27/sage-4.6.1.rc1/devel/sage-main/sage/rings/number_field/number_field_ideal.py\", line 1831\n:\n    sage: units=I.invertible_residues()\nException raised:\n    Traceback (most recent call last):\n      File \"/mnt/usb1/scratch/drake/days27/sage-4.6.1.rc1/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/mnt/usb1/scratch/drake/days27/sage-4.6.1.rc1/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/mnt/usb1/scratch/drake/days27/sage-4.6.1.rc1/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_61[9]>\", line 1, in <module>\n        units=I.invertible_residues()###line 1831:\n    sage: units=I.invertible_residues()\n      File \"/mnt/usb1/scratch/drake/days27/sage-4.6.1.rc1/local/lib/python/site-packages/sage/rings/number_field/number_field_ideal.py\", line 1846, in invertible_residues\n        return self.invertible_residues_mod(subgp_gens=None, reduce=reduce)\n      File \"/mnt/usb1/scratch/drake/days27/sage-4.6.1.rc1/local/lib/python/site-packages/sage/rings/number_field/number_field_ideal.py\", line 1929, in invertible_residues_mod\n        A, U, V = M.smith_form()\n      File \"matrix2.pyx\", line 7108, in sage.matrix.matrix2.Matrix.smith_form (sage/matrix/matrix2.c:37793)\n      File \"matrix2.pyx\", line 7269, in sage.matrix.matrix2._smith_diag (sage/matrix/matrix2.c:39676)\n      File \"integer.pyx\", line 5163, in sage.rings.integer.Integer.inverse_mod (sage/rings/integer.c:28740)\n      File \"integer.pyx\", line 367, in sage.rings.integer.as_Integer (sage/rings/integer.c:6052)\n      File \"integer.pyx\", line 680, in sage.rings.integer.Integer.__init__ (sage/rings/integer.c:7312)\n    TypeError: unable to coerce <class 'sage.rings.ideal.Ideal_pid'> to an integer\n```\n\n...and a bunch of similar failures in the same file.",
    "created_at": "2011-01-12T23:28:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10604#issuecomment-103303",
    "user": "https://github.com/dandrake"
}
```

<a id='comment:6'></a>
I'm also seeing a doctest failure:

```
drake@sage.math:/scratch/drake/days27/sage-4.6.1.rc1$ ./sage -t  devel/sage-main/sage/rings/number_field/number_field_ideal.p
y
sage -t  "devel/sage-main/sage/rings/number_field/number_field_ideal.py" 
**********************************************************************   
File "/mnt/usb1/scratch/drake/days27/sage-4.6.1.rc1/devel/sage-main/sage/rings/number_field/number_field_ideal.py", line 1831
:
    sage: units=I.invertible_residues()
Exception raised:
    Traceback (most recent call last):
      File "/mnt/usb1/scratch/drake/days27/sage-4.6.1.rc1/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/mnt/usb1/scratch/drake/days27/sage-4.6.1.rc1/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/mnt/usb1/scratch/drake/days27/sage-4.6.1.rc1/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_61[9]>", line 1, in <module>
        units=I.invertible_residues()###line 1831:
    sage: units=I.invertible_residues()
      File "/mnt/usb1/scratch/drake/days27/sage-4.6.1.rc1/local/lib/python/site-packages/sage/rings/number_field/number_field_ideal.py", line 1846, in invertible_residues
        return self.invertible_residues_mod(subgp_gens=None, reduce=reduce)
      File "/mnt/usb1/scratch/drake/days27/sage-4.6.1.rc1/local/lib/python/site-packages/sage/rings/number_field/number_field_ideal.py", line 1929, in invertible_residues_mod
        A, U, V = M.smith_form()
      File "matrix2.pyx", line 7108, in sage.matrix.matrix2.Matrix.smith_form (sage/matrix/matrix2.c:37793)
      File "matrix2.pyx", line 7269, in sage.matrix.matrix2._smith_diag (sage/matrix/matrix2.c:39676)
      File "integer.pyx", line 5163, in sage.rings.integer.Integer.inverse_mod (sage/rings/integer.c:28740)
      File "integer.pyx", line 367, in sage.rings.integer.as_Integer (sage/rings/integer.c:6052)
      File "integer.pyx", line 680, in sage.rings.integer.Integer.__init__ (sage/rings/integer.c:7312)
    TypeError: unable to coerce <class 'sage.rings.ideal.Ideal_pid'> to an integer
```

...and a bunch of similar failures in the same file.



---

archive/issue_comments_103304.json:
```json
{
    "body": "<a id='comment:7'></a>\nReplying to [@dandrake](#comment%3A6):\n\nThanks, Dan.  The int64 makes sense, I think I need to return the `NumPy` matrices sooner, and coerce them further.  The Smith Normal Form certainly should involve diagonal matrices, but I can't quite see where that is coming from (and the failure was not evident in my tests run last night).\n\nI'll get back to it again in a bit.\n\nRob",
    "created_at": "2011-01-13T00:57:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10604#issuecomment-103304",
    "user": "https://github.com/rbeezer"
}
```

<a id='comment:7'></a>
Replying to [@dandrake](#comment%3A6):

Thanks, Dan.  The int64 makes sense, I think I need to return the `NumPy` matrices sooner, and coerce them further.  The Smith Normal Form certainly should involve diagonal matrices, but I can't quite see where that is coming from (and the failure was not evident in my tests run last night).

I'll get back to it again in a bit.

Rob



---

archive/issue_events_117470.json:
```json
{
    "actor": "https://github.com/rbeezer",
    "created_at": "2011-01-13T00:57:00Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10604#event-117470"
}
```



---

archive/issue_events_117471.json:
```json
{
    "actor": "https://github.com/rbeezer",
    "created_at": "2011-01-13T00:57:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10604#event-117471"
}
```



---

archive/issue_comments_103305.json:
```json
{
    "body": "<a id='comment:8'></a>\nReplying to [@dandrake](#comment%3A6):\n> I'm also seeing a doctest failure:\n> \n> ```\n> drake@sage.math:/scratch/drake/days27/sage-4.6.1.rc1$ ./sage -t  devel/sage-main/sage/rings/number_field/number_field_ideal.py\n> ```\n\nSmith Form seems to be unhappy about getting a sparse matrix:\n\n```\nsage: B=diagonal_matrix(ZZ, [3,4])\nsage: B.is_sparse()\nTrue\nsage: B.smith_form()\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n\n<snip>\n\nTypeError: unable to coerce <class 'sage.rings.ideal.Ideal_pid'> to an integer\n\nsage: C=B.dense_matrix()\nsage: C.smith_form()\n(\n[ 1  0]  [ 1  1]  [-1 -4]\n[ 0 12], [-4 -3], [ 1  3]\n)\n```",
    "created_at": "2011-01-13T16:49:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10604#issuecomment-103305",
    "user": "https://github.com/rbeezer"
}
```

<a id='comment:8'></a>
Replying to [@dandrake](#comment%3A6):
> I'm also seeing a doctest failure:
> 
> ```
> drake@sage.math:/scratch/drake/days27/sage-4.6.1.rc1$ ./sage -t  devel/sage-main/sage/rings/number_field/number_field_ideal.py
> ```

Smith Form seems to be unhappy about getting a sparse matrix:

```
sage: B=diagonal_matrix(ZZ, [3,4])
sage: B.is_sparse()
True
sage: B.smith_form()
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)

<snip>

TypeError: unable to coerce <class 'sage.rings.ideal.Ideal_pid'> to an integer

sage: C=B.dense_matrix()
sage: C.smith_form()
(
[ 1  0]  [ 1  1]  [-1 -4]
[ 0 12], [-4 -3], [ 1  3]
)
```



---

archive/issue_comments_103306.json:
```json
{
    "body": "<a id='comment:9'></a>\nSparse integer matrices get sent to the *generic* Smith form routine (which I suspect is broken, #10625).  It fails on an integer matrix.  Solution is to direct sparse integer matrices to the dense version and report the generic version.  \n\nThat change is at #10626, and this ticket will now depend on that patch.",
    "created_at": "2011-01-13T19:14:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10604#issuecomment-103306",
    "user": "https://github.com/rbeezer"
}
```

<a id='comment:9'></a>
Sparse integer matrices get sent to the *generic* Smith form routine (which I suspect is broken, #10625).  It fails on an integer matrix.  Solution is to direct sparse integer matrices to the dense version and report the generic version.  

That change is at #10626, and this ticket will now depend on that patch.



---

archive/issue_comments_103307.json:
```json
{
    "body": "**Attachment:** [trac_10604-diagonal-matrix-constructor-v2.patch.gz](https://github.com/sagemath/sage/files/ticket10604/trac_10604-diagonal-matrix-constructor-v2.patch.gz)",
    "created_at": "2011-01-13T22:13:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10604#issuecomment-103307",
    "user": "https://github.com/rbeezer"
}
```

**Attachment:** [trac_10604-diagonal-matrix-constructor-v2.patch.gz](https://github.com/sagemath/sage/files/ticket10604/trac_10604-diagonal-matrix-constructor-v2.patch.gz)



---

archive/issue_comments_103308.json:
```json
{
    "body": "<a id='comment:10'></a>\nv2 patch depends on #10626 to avoid the sparse/smith-form problem, and the numpy types are now all automatically handled by the `prepare()` method for free module elements.  Passes tests in sage/matrix and I'll start full tests right now.",
    "created_at": "2011-01-13T22:15:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10604#issuecomment-103308",
    "user": "https://github.com/rbeezer"
}
```

<a id='comment:10'></a>
v2 patch depends on #10626 to avoid the sparse/smith-form problem, and the numpy types are now all automatically handled by the `prepare()` method for free module elements.  Passes tests in sage/matrix and I'll start full tests right now.



---

archive/issue_events_117472.json:
```json
{
    "actor": "https://github.com/rbeezer",
    "created_at": "2011-01-13T22:15:12Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10604#event-117472"
}
```



---

archive/issue_events_117473.json:
```json
{
    "actor": "https://github.com/rbeezer",
    "created_at": "2011-01-13T22:15:12Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10604#event-117473"
}
```



---

archive/issue_comments_103309.json:
```json
{
    "body": "<a id='comment:11'></a>\nThis will likely depend on the following sequence:\n\n4.6.1.rc1, #10364, #10537, #10626",
    "created_at": "2011-01-13T22:23:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10604#issuecomment-103309",
    "user": "https://github.com/rbeezer"
}
```

<a id='comment:11'></a>
This will likely depend on the following sequence:

4.6.1.rc1, #10364, #10537, #10626



---

archive/issue_comments_103310.json:
```json
{
    "body": "<a id='comment:12'></a>\nPasses all tests in devel/sage with patches described above, so I think this is ready now.",
    "created_at": "2011-01-13T23:25:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10604#issuecomment-103310",
    "user": "https://github.com/rbeezer"
}
```

<a id='comment:12'></a>
Passes all tests in devel/sage with patches described above, so I think this is ready now.



---

archive/issue_events_117474.json:
```json
{
    "actor": "https://github.com/dandrake",
    "created_at": "2011-01-20T09:48:14Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10604#event-117474"
}
```



---

archive/issue_events_117475.json:
```json
{
    "actor": "https://github.com/dandrake",
    "created_at": "2011-01-20T09:48:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10604#event-117475"
}
```



---

archive/issue_comments_103311.json:
```json
{
    "body": "<a id='comment:13'></a>\nGreen light from the patchbot...code is good. Positive review.\n\nRelease manager: apply #10537 and #10626 *first*, then only [attachment:trac_10604-diagonal-matrix-constructor-v2.patch.](https://github.com/sagemath/sage/files/ticket10604/trac_10604-diagonal-matrix-constructor-v2.patch.)",
    "created_at": "2011-01-20T09:48:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10604#issuecomment-103311",
    "user": "https://github.com/dandrake"
}
```

<a id='comment:13'></a>
Green light from the patchbot...code is good. Positive review.

Release manager: apply #10537 and #10626 *first*, then only [attachment:trac_10604-diagonal-matrix-constructor-v2.patch.](https://github.com/sagemath/sage/files/ticket10604/trac_10604-diagonal-matrix-constructor-v2.patch.)



---

archive/issue_comments_103312.json:
```json
{
    "body": "<a id='comment:14'></a>\nHi Dan,\n\nThanks for your help with this and staying with it - much improved based on your testing (and I may be able to excise some `NumPy`-specific code in the vector constructor based on the `prepare()` experience here.\n\nI missed seeing the green light.  Dang. I've not been paying much attention to the patchbot since it would fail so often on the startup tests, but maybe that is fixed now.\n\nRob",
    "created_at": "2011-01-20T19:46:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10604#issuecomment-103312",
    "user": "https://github.com/rbeezer"
}
```

<a id='comment:14'></a>
Hi Dan,

Thanks for your help with this and staying with it - much improved based on your testing (and I may be able to excise some `NumPy`-specific code in the vector constructor based on the `prepare()` experience here.

I missed seeing the green light.  Dang. I've not been paying much attention to the patchbot since it would fail so often on the startup tests, but maybe that is fixed now.

Rob



---

archive/issue_comments_103313.json:
```json
{
    "body": "<a id='comment:15'></a>\nThere are some doctest failures:\n\n```\nsage -t  \"devel/sage/sage/rings/number_field/number_field_ideal.py\"\n**********************************************************************\nFile \"/usr/local/src/sage-4.6.2.alpha1/devel/sage/sage/rings/number_field/number_field_ideal.py\", line 2304:\n    sage: I.ideallog(a + 7, [1+a, 2])\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/local/src/sage-4.6.2.alpha1/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/usr/local/src/sage-4.6.2.alpha1/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/usr/local/src/sage-4.6.2.alpha1/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_71[11]>\", line 1, in <module>\n        I.ideallog(a + Integer(7), [Integer(1)+a, Integer(2)])###line 2304:\n    sage: I.ideallog(a + 7, [1+a, 2])\n      File \"/usr/local/src/sage-4.6.2.alpha1/local/lib/python/site-packages/sage/rings/number_field/number_field_ideal.py\", line 2357, in ideallog\n        mat = mat.stack( diagonal_matrix(ZZ, invs).augment(zero_matrix(ZZ, len(invs), len(gens))))\n      File \"matrix_integer_dense.pyx\", line 4426, in sage.matrix.matrix_integer_dense.Matrix_integer_dense.stack (sage/matrix/matrix_integer_dense.c:32907)\n    TypeError: Cannot convert sage.matrix.matrix_integer_sparse.Matrix_integer_sparse to sage.matrix.matrix_integer_dense.Matrix_integer_dense\n**********************************************************************\nFile \"/usr/local/src/sage-4.6.2.alpha1/devel/sage/sage/rings/number_field/number_field_ideal.py\", line 2306:\n    sage: I.ideallog(a + 7, [2, 1+a])\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/local/src/sage-4.6.2.alpha1/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/usr/local/src/sage-4.6.2.alpha1/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/usr/local/src/sage-4.6.2.alpha1/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_71[12]>\", line 1, in <module>\n        I.ideallog(a + Integer(7), [Integer(2), Integer(1)+a])###line 2306:\n    sage: I.ideallog(a + 7, [2, 1+a])\n      File \"/usr/local/src/sage-4.6.2.alpha1/local/lib/python/site-packages/sage/rings/number_field/number_field_ideal.py\", line 2357, in ideallog\n        mat = mat.stack( diagonal_matrix(ZZ, invs).augment(zero_matrix(ZZ, len(invs), len(gens))))\n      File \"matrix_integer_dense.pyx\", line 4426, in sage.matrix.matrix_integer_dense.Matrix_integer_dense.stack (sage/matrix/matrix_integer_dense.c:32907)\n    TypeError: Cannot convert sage.matrix.matrix_integer_sparse.Matrix_integer_sparse to sage.matrix.matrix_integer_dense.Matrix_integer_dense\n**********************************************************************\nFile \"/usr/local/src/sage-4.6.2.alpha1/devel/sage/sage/rings/number_field/number_field_ideal.py\", line 2313:\n    sage: J.ideallog(5+2*b, [u, v], check=True)\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/local/src/sage-4.6.2.alpha1/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/usr/local/src/sage-4.6.2.alpha1/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/usr/local/src/sage-4.6.2.alpha1/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_71[17]>\", line 1, in <module>\n        J.ideallog(Integer(5)+Integer(2)*b, [u, v], check=True)###line 2313:\n    sage: J.ideallog(5+2*b, [u, v], check=True)\n      File \"/usr/local/src/sage-4.6.2.alpha1/local/lib/python/site-packages/sage/rings/number_field/number_field_ideal.py\", line 2357, in ideallog\n        mat = mat.stack( diagonal_matrix(ZZ, invs).augment(zero_matrix(ZZ, len(invs), len(gens))))\n      File \"matrix_integer_dense.pyx\", line 4426, in sage.matrix.matrix_integer_dense.Matrix_integer_dense.stack (sage/matrix/matrix_integer_dense.c:32907)\n    TypeError: Cannot convert sage.matrix.matrix_integer_sparse.Matrix_integer_sparse to sage.matrix.matrix_integer_dense.Matrix_integer_dense\n**********************************************************************\nFile \"/usr/local/src/sage-4.6.2.alpha1/devel/sage/sage/rings/number_field/number_field_ideal.py\", line 2318:\n    sage: I.ideallog(a + 7, [2])\nExpected:\n    Traceback (most recent call last):\n    ...\n    ValueError: Given elements do not generate unit group -- they generate a subgroup of index 36\nGot:\n    Traceback (most recent call last):\n      File \"/usr/local/src/sage-4.6.2.alpha1/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/usr/local/src/sage-4.6.2.alpha1/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/usr/local/src/sage-4.6.2.alpha1/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_71[18]>\", line 1, in <module>\n        I.ideallog(a + Integer(7), [Integer(2)])###line 2318:\n    sage: I.ideallog(a + 7, [2])\n      File \"/usr/local/src/sage-4.6.2.alpha1/local/lib/python/site-packages/sage/rings/number_field/number_field_ideal.py\", line 2357, in ideallog\n        mat = mat.stack( diagonal_matrix(ZZ, invs).augment(zero_matrix(ZZ, len(invs), len(gens))))\n      File \"matrix_integer_dense.pyx\", line 4426, in sage.matrix.matrix_integer_dense.Matrix_integer_dense.stack (sage/matrix/matrix_integer_dense.c:32907)\n    TypeError: Cannot convert sage.matrix.matrix_integer_sparse.Matrix_integer_sparse to sage.matrix.matrix_integer_dense.Matrix_integer_dense\n**********************************************************************\n```",
    "created_at": "2011-01-26T22:10:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10604#issuecomment-103313",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:15'></a>
There are some doctest failures:

```
sage -t  "devel/sage/sage/rings/number_field/number_field_ideal.py"
**********************************************************************
File "/usr/local/src/sage-4.6.2.alpha1/devel/sage/sage/rings/number_field/number_field_ideal.py", line 2304:
    sage: I.ideallog(a + 7, [1+a, 2])
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/src/sage-4.6.2.alpha1/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/usr/local/src/sage-4.6.2.alpha1/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/usr/local/src/sage-4.6.2.alpha1/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_71[11]>", line 1, in <module>
        I.ideallog(a + Integer(7), [Integer(1)+a, Integer(2)])###line 2304:
    sage: I.ideallog(a + 7, [1+a, 2])
      File "/usr/local/src/sage-4.6.2.alpha1/local/lib/python/site-packages/sage/rings/number_field/number_field_ideal.py", line 2357, in ideallog
        mat = mat.stack( diagonal_matrix(ZZ, invs).augment(zero_matrix(ZZ, len(invs), len(gens))))
      File "matrix_integer_dense.pyx", line 4426, in sage.matrix.matrix_integer_dense.Matrix_integer_dense.stack (sage/matrix/matrix_integer_dense.c:32907)
    TypeError: Cannot convert sage.matrix.matrix_integer_sparse.Matrix_integer_sparse to sage.matrix.matrix_integer_dense.Matrix_integer_dense
**********************************************************************
File "/usr/local/src/sage-4.6.2.alpha1/devel/sage/sage/rings/number_field/number_field_ideal.py", line 2306:
    sage: I.ideallog(a + 7, [2, 1+a])
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/src/sage-4.6.2.alpha1/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/usr/local/src/sage-4.6.2.alpha1/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/usr/local/src/sage-4.6.2.alpha1/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_71[12]>", line 1, in <module>
        I.ideallog(a + Integer(7), [Integer(2), Integer(1)+a])###line 2306:
    sage: I.ideallog(a + 7, [2, 1+a])
      File "/usr/local/src/sage-4.6.2.alpha1/local/lib/python/site-packages/sage/rings/number_field/number_field_ideal.py", line 2357, in ideallog
        mat = mat.stack( diagonal_matrix(ZZ, invs).augment(zero_matrix(ZZ, len(invs), len(gens))))
      File "matrix_integer_dense.pyx", line 4426, in sage.matrix.matrix_integer_dense.Matrix_integer_dense.stack (sage/matrix/matrix_integer_dense.c:32907)
    TypeError: Cannot convert sage.matrix.matrix_integer_sparse.Matrix_integer_sparse to sage.matrix.matrix_integer_dense.Matrix_integer_dense
**********************************************************************
File "/usr/local/src/sage-4.6.2.alpha1/devel/sage/sage/rings/number_field/number_field_ideal.py", line 2313:
    sage: J.ideallog(5+2*b, [u, v], check=True)
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/src/sage-4.6.2.alpha1/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/usr/local/src/sage-4.6.2.alpha1/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/usr/local/src/sage-4.6.2.alpha1/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_71[17]>", line 1, in <module>
        J.ideallog(Integer(5)+Integer(2)*b, [u, v], check=True)###line 2313:
    sage: J.ideallog(5+2*b, [u, v], check=True)
      File "/usr/local/src/sage-4.6.2.alpha1/local/lib/python/site-packages/sage/rings/number_field/number_field_ideal.py", line 2357, in ideallog
        mat = mat.stack( diagonal_matrix(ZZ, invs).augment(zero_matrix(ZZ, len(invs), len(gens))))
      File "matrix_integer_dense.pyx", line 4426, in sage.matrix.matrix_integer_dense.Matrix_integer_dense.stack (sage/matrix/matrix_integer_dense.c:32907)
    TypeError: Cannot convert sage.matrix.matrix_integer_sparse.Matrix_integer_sparse to sage.matrix.matrix_integer_dense.Matrix_integer_dense
**********************************************************************
File "/usr/local/src/sage-4.6.2.alpha1/devel/sage/sage/rings/number_field/number_field_ideal.py", line 2318:
    sage: I.ideallog(a + 7, [2])
Expected:
    Traceback (most recent call last):
    ...
    ValueError: Given elements do not generate unit group -- they generate a subgroup of index 36
Got:
    Traceback (most recent call last):
      File "/usr/local/src/sage-4.6.2.alpha1/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/usr/local/src/sage-4.6.2.alpha1/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/usr/local/src/sage-4.6.2.alpha1/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_71[18]>", line 1, in <module>
        I.ideallog(a + Integer(7), [Integer(2)])###line 2318:
    sage: I.ideallog(a + 7, [2])
      File "/usr/local/src/sage-4.6.2.alpha1/local/lib/python/site-packages/sage/rings/number_field/number_field_ideal.py", line 2357, in ideallog
        mat = mat.stack( diagonal_matrix(ZZ, invs).augment(zero_matrix(ZZ, len(invs), len(gens))))
      File "matrix_integer_dense.pyx", line 4426, in sage.matrix.matrix_integer_dense.Matrix_integer_dense.stack (sage/matrix/matrix_integer_dense.c:32907)
    TypeError: Cannot convert sage.matrix.matrix_integer_sparse.Matrix_integer_sparse to sage.matrix.matrix_integer_dense.Matrix_integer_dense
**********************************************************************
```



---

archive/issue_events_117476.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-01-26T22:10:56Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10604#event-117476"
}
```



---

archive/issue_events_117477.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-01-26T22:10:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10604#event-117477"
}
```



---

archive/issue_comments_103314.json:
```json
{
    "body": "<a id='comment:16'></a>\nReplying to [@jdemeyer](#comment%3A15):\n> There are some doctest failures:\n\n[The second-to-last comment](#comment%3A13) says that you need to apply #10626 first.",
    "created_at": "2011-01-27T04:26:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10604#issuecomment-103314",
    "user": "https://github.com/dandrake"
}
```

<a id='comment:16'></a>
Replying to [@jdemeyer](#comment%3A15):
> There are some doctest failures:

[The second-to-last comment](#comment%3A13) says that you need to apply #10626 first.



---

archive/issue_events_117478.json:
```json
{
    "actor": "https://github.com/dandrake",
    "created_at": "2011-01-27T04:26:27Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10604#event-117478"
}
```



---

archive/issue_events_117479.json:
```json
{
    "actor": "https://github.com/dandrake",
    "created_at": "2011-01-27T04:26:27Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10604#event-117479"
}
```



---

archive/issue_comments_103315.json:
```json
{
    "body": "<a id='comment:17'></a>\nDan,\n\nDid you try this against a very recent alpha?  (4.6.2.alpha1 or better?).  The failures look exactly like what happened on #4492, owing to #10443 that snuck in.  (Wrong culprit listed on #4492).\n\nI'm on the road so cannot check immediately, but will soon.\n\nThanks,\nRob",
    "created_at": "2011-01-27T05:30:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10604#issuecomment-103315",
    "user": "https://github.com/rbeezer"
}
```

<a id='comment:17'></a>
Dan,

Did you try this against a very recent alpha?  (4.6.2.alpha1 or better?).  The failures look exactly like what happened on #4492, owing to #10443 that snuck in.  (Wrong culprit listed on #4492).

I'm on the road so cannot check immediately, but will soon.

Thanks,
Rob



---

archive/issue_events_117480.json:
```json
{
    "actor": "https://github.com/dandrake",
    "created_at": "2011-01-27T06:57:35Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10604#event-117480"
}
```



---

archive/issue_events_117481.json:
```json
{
    "actor": "https://github.com/dandrake",
    "created_at": "2011-01-27T06:57:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10604#event-117481"
}
```



---

archive/issue_comments_103316.json:
```json
{
    "body": "<a id='comment:18'></a>\nReplying to [@rbeezer](#comment%3A17):\n> Dan,\n> \n> Did you try this against a very recent alpha?  (4.6.2.alpha1 or better?).  The failures look exactly like what happened on #4492, owing to #10443 that snuck in.  (Wrong culprit listed on #4492).\n\nI tried it against 4.6.2.alpha2, and I think I spoke too soon above...I applied #10626 and I'm still seeing the failure. So this does need some work, but (like Rob) I won't be able to do it in the next couple days.",
    "created_at": "2011-01-27T06:57:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10604#issuecomment-103316",
    "user": "https://github.com/dandrake"
}
```

<a id='comment:18'></a>
Replying to [@rbeezer](#comment%3A17):
> Dan,
> 
> Did you try this against a very recent alpha?  (4.6.2.alpha1 or better?).  The failures look exactly like what happened on #4492, owing to #10443 that snuck in.  (Wrong culprit listed on #4492).

I tried it against 4.6.2.alpha2, and I think I spoke too soon above...I applied #10626 and I'm still seeing the failure. So this does need some work, but (like Rob) I won't be able to do it in the next couple days.



---

archive/issue_comments_103317.json:
```json
{
    "body": "<a id='comment:19'></a>\nReplying to [@jdemeyer](#comment%3A15):\n> There are some doctest failures:\n\nThe root of the problem is line 4426 in the `stack()` method in `matrix_integer_dense.pyx`:\n\n```\ncdef Matrix_integer_dense A = other\n```\nwhich works poorly when given a sparse matrix.\n\nInterestingly, it works the other way around: you can stack a sparse matrix on top of a dense one. So we need to fix `stack()` for dense matrices.",
    "created_at": "2011-01-27T12:45:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10604#issuecomment-103317",
    "user": "https://github.com/dandrake"
}
```

<a id='comment:19'></a>
Replying to [@jdemeyer](#comment%3A15):
> There are some doctest failures:

The root of the problem is line 4426 in the `stack()` method in `matrix_integer_dense.pyx`:

```
cdef Matrix_integer_dense A = other
```
which works poorly when given a sparse matrix.

Interestingly, it works the other way around: you can stack a sparse matrix on top of a dense one. So we need to fix `stack()` for dense matrices.



---

archive/issue_comments_103318.json:
```json
{
    "body": "fix failing doctest in number_field_ideal.py",
    "created_at": "2011-01-27T14:18:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10604#issuecomment-103318",
    "user": "https://github.com/dandrake"
}
```

fix failing doctest in number_field_ideal.py



---

archive/issue_comments_103319.json:
```json
{
    "body": "<a id='comment:20'></a>\n**Attachment:** [trac_10604_fix_matrix_stack.gz](https://github.com/sagemath/sage/files/ticket10604/trac_10604_fix_matrix_stack.gz)\n\nCan someone who knows the matrix code take a look at my patch? All doctests pass with the two patches here applied to 4.6.2.alpha2.",
    "created_at": "2011-01-27T14:44:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10604#issuecomment-103319",
    "user": "https://github.com/dandrake"
}
```

<a id='comment:20'></a>
**Attachment:** [trac_10604_fix_matrix_stack.gz](https://github.com/sagemath/sage/files/ticket10604/trac_10604_fix_matrix_stack.gz)

Can someone who knows the matrix code take a look at my patch? All doctests pass with the two patches here applied to 4.6.2.alpha2.



---

archive/issue_events_117482.json:
```json
{
    "actor": "https://github.com/dandrake",
    "created_at": "2011-01-27T14:44:22Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10604#event-117482"
}
```



---

archive/issue_events_117483.json:
```json
{
    "actor": "https://github.com/dandrake",
    "created_at": "2011-01-27T14:44:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10604#event-117483"
}
```



---

archive/issue_comments_103320.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -26,3 +26,9 @@\n \n ValueError: entries has the wrong length\n ```\n+\n+**Apply:**\n+\n+* [attachment:trac_10604-diagonal-matrix-constructor-v2.patch](https://github.com/sagemath/sage/files/ticket10604/trac_10604-diagonal-matrix-constructor-v2.patch) \n+* [attachment:trac_10604_fix_matrix_stack](https://github.com/sagemath/sage/files/ticket10604/trac_10604_fix_matrix_stack)\n+\n``````\n",
    "created_at": "2011-01-27T14:47:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10604#issuecomment-103320",
    "user": "https://github.com/dandrake"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -26,3 +26,9 @@
 
 ValueError: entries has the wrong length
 ```
+
+**Apply:**
+
+* [attachment:trac_10604-diagonal-matrix-constructor-v2.patch](https://github.com/sagemath/sage/files/ticket10604/trac_10604-diagonal-matrix-constructor-v2.patch) 
+* [attachment:trac_10604_fix_matrix_stack](https://github.com/sagemath/sage/files/ticket10604/trac_10604_fix_matrix_stack)
+
``````




---

archive/issue_comments_103321.json:
```json
{
    "body": "<a id='comment:22'></a>\nReplying to [@dandrake](#comment%3A20):\n> Can someone who knows the matrix code take a look at my patch? All doctests pass with the two patches here applied to 4.6.2.alpha2.\n\nThanks, Dan.  I'll look at this more carefully this evening - should have time then.\n\nThe root problem here is my decision to return a diagonal matrix as sparse since that is exposing a variety of inconsistencies.  If I had it to do over....\n\nAnyway, I suspect `augment()` suffers the same affliction.  I jazzed up `augment()` on #10424 with a promise to sync up `stack()` so maybe I better make good on that.\n\nThanks for the detective work on this one.\n\nRob",
    "created_at": "2011-01-27T18:17:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10604#issuecomment-103321",
    "user": "https://github.com/rbeezer"
}
```

<a id='comment:22'></a>
Replying to [@dandrake](#comment%3A20):
> Can someone who knows the matrix code take a look at my patch? All doctests pass with the two patches here applied to 4.6.2.alpha2.

Thanks, Dan.  I'll look at this more carefully this evening - should have time then.

The root problem here is my decision to return a diagonal matrix as sparse since that is exposing a variety of inconsistencies.  If I had it to do over....

Anyway, I suspect `augment()` suffers the same affliction.  I jazzed up `augment()` on #10424 with a promise to sync up `stack()` so maybe I better make good on that.

Thanks for the detective work on this one.

Rob



---

archive/issue_comments_103322.json:
```json
{
    "body": "**Changing author** from \"Rob Beezer\" to \"Rob Beezer, Dan Drake\".",
    "created_at": "2011-01-29T04:37:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10604#issuecomment-103322",
    "user": "https://github.com/rbeezer"
}
```

**Changing author** from "Rob Beezer" to "Rob Beezer, Dan Drake".



---

archive/issue_comments_103323.json:
```json
{
    "body": "**Changing reviewer** from \"Dan Drake\" to \"Dan Drake, Rob Beezer\".",
    "created_at": "2011-01-29T04:37:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10604#issuecomment-103323",
    "user": "https://github.com/rbeezer"
}
```

**Changing reviewer** from "Dan Drake" to "Dan Drake, Rob Beezer".



---

archive/issue_comments_103324.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -32,3 +32,4 @@\n * [attachment:trac_10604-diagonal-matrix-constructor-v2.patch](https://github.com/sagemath/sage/files/ticket10604/trac_10604-diagonal-matrix-constructor-v2.patch) \n * [attachment:trac_10604_fix_matrix_stack](https://github.com/sagemath/sage/files/ticket10604/trac_10604_fix_matrix_stack)\n \n+Depends: #10626\n``````\n",
    "created_at": "2011-01-29T04:37:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10604#issuecomment-103324",
    "user": "https://github.com/rbeezer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -32,3 +32,4 @@
 * [attachment:trac_10604-diagonal-matrix-constructor-v2.patch](https://github.com/sagemath/sage/files/ticket10604/trac_10604-diagonal-matrix-constructor-v2.patch) 
 * [attachment:trac_10604_fix_matrix_stack](https://github.com/sagemath/sage/files/ticket10604/trac_10604_fix_matrix_stack)
 
+Depends: #10626
``````




---

archive/issue_comments_103325.json:
```json
{
    "body": "<a id='comment:23'></a>\nReplying to [@dandrake](#comment%3A20):\n> Can someone who knows the matrix code take a look at my patch? All doctests pass with the two patches here applied to 4.6.2.alpha2.\n\nDan's patch looks good and with it, all tests pass.  So I'll flip this back to positive review.\n\nThanks, Dan.",
    "created_at": "2011-01-29T04:37:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10604#issuecomment-103325",
    "user": "https://github.com/rbeezer"
}
```

<a id='comment:23'></a>
Replying to [@dandrake](#comment%3A20):
> Can someone who knows the matrix code take a look at my patch? All doctests pass with the two patches here applied to 4.6.2.alpha2.

Dan's patch looks good and with it, all tests pass.  So I'll flip this back to positive review.

Thanks, Dan.



---

archive/issue_events_117484.json:
```json
{
    "actor": "https://github.com/rbeezer",
    "created_at": "2011-01-29T04:37:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10604#event-117484"
}
```



---

archive/issue_events_117485.json:
```json
{
    "actor": "https://github.com/rbeezer",
    "created_at": "2011-01-29T04:37:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10604#event-117485"
}
```



---

archive/issue_comments_103326.json:
```json
{
    "body": "**Merged:** sage-4.6.2.alpha4",
    "created_at": "2011-02-07T08:15:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10604#issuecomment-103326",
    "user": "https://github.com/jdemeyer"
}
```

**Merged:** sage-4.6.2.alpha4



---

archive/issue_events_117486.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-02-07T08:15:35Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10604#event-117486"
}
```



---

archive/issue_events_117487.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-02-07T08:15:35Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/10604",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10604#event-117487"
}
```
