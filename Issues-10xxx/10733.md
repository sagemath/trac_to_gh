# Issue 10733: Faster echelon form code for matrix_modn_sparse

archive/issues_010670.json:
```json
{
    "body": "In the method `_echelon_in_place_classical` of `matrix_modn_sparse` there's this comment:\n\n```\nTODO: Implement switching to a dense method when the matrix gets\n      dense.\n```\nThat's what we will do in this ticket, by switching to linbox echelon form code when rows start to get non-dense.\n\n**Assignee:** @williamstein\n\n**Reviewer:** William Stein, Gonzalo Tornar\u00eda\n\n**Author:** Gonzalo Tornar\u00eda, William Stein\n\n**Status:** needs_work\n\n**Dependencies:** #10734\n\nIssue created by migration from https://trac.sagemath.org/ticket/10733\n\n",
    "created_at": "2011-02-03T01:24:25Z",
    "labels": [
        "component: linear algebra"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-pending",
    "title": "Faster echelon form code for matrix_modn_sparse",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10733",
    "user": "https://github.com/tornaria"
}
```
In the method `_echelon_in_place_classical` of `matrix_modn_sparse` there's this comment:

```
TODO: Implement switching to a dense method when the matrix gets
      dense.
```
That's what we will do in this ticket, by switching to linbox echelon form code when rows start to get non-dense.

**Assignee:** @williamstein

**Reviewer:** William Stein, Gonzalo Tornaría

**Author:** Gonzalo Tornaría, William Stein

**Status:** needs_work

**Dependencies:** #10734

Issue created by migration from https://trac.sagemath.org/ticket/10733





---

archive/issue_comments_141457.json:
```json
{
    "body": "<a id='comment:1'></a>\nNOTE: The patches in this ticket require #10734 to be applied first.",
    "created_at": "2011-02-03T01:45:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141457",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:1'></a>
NOTE: The patches in this ticket require #10734 to be applied first.



---

archive/issue_comments_141458.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2011-02-05T23:02:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141458",
    "user": "https://github.com/tornaria"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_141459.json:
```json
{
    "body": "<a id='comment:3'></a>\nThere are no doctests to illustrate the new functionality added by this patch.",
    "created_at": "2011-03-21T19:16:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141459",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:3'></a>
There are no doctests to illustrate the new functionality added by this patch.



---

archive/issue_comments_141460.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2011-03-21T19:16:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141460",
    "user": "https://github.com/williamstein"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_141461.json:
```json
{
    "body": "<a id='comment:4'></a>\nThe patch doesn't add any new functionality.\n\nThe function didn't have a doctest before.\n\nI've attached a patch (to be applied in top of the other two) which adds a test for the sparse echelon form. The test takes about 20 seconds, so it's labeled as long.\n\nWhat the test does is to construct a 1000x1000 sparse matrix with density=1%, and compute the echelon form using different values for \"switch_density\", and also using the dense matrix echelon form method. Of course everything should give the same echelon form. I'm not sure if it makes sense to test with smaller matrices.\n\nIn any case, feel free to add more tests or modify the current one in any way you see fits.",
    "created_at": "2011-03-24T03:52:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141461",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:4'></a>
The patch doesn't add any new functionality.

The function didn't have a doctest before.

I've attached a patch (to be applied in top of the other two) which adds a test for the sparse echelon form. The test takes about 20 seconds, so it's labeled as long.

What the test does is to construct a 1000x1000 sparse matrix with density=1%, and compute the echelon form using different values for "switch_density", and also using the dense matrix echelon form method. Of course everything should give the same echelon form. I'm not sure if it makes sense to test with smaller matrices.

In any case, feel free to add more tests or modify the current one in any way you see fits.



---

archive/issue_comments_141462.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2011-03-24T03:52:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141462",
    "user": "https://github.com/tornaria"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_141463.json:
```json
{
    "body": "<a id='comment:5'></a>\nI replaced the patch by a new version. In the new version, I copied the test twice, so it's always run for 100x100 matrices (5% density) and optionally (long) run for 1000x1000 matrices (1% density).\n\nThe test for 100x100 matrices takes about 0.1 s, so it's ok. I think it's still a useful test since it runs the algorithm switching to dense at several different columns.\n\nThe test for 1000x1000 takes about 25 s (I changed the modulus from 97 to 997) and it's still optional (long). Is that too long for a \"long\" test?",
    "created_at": "2011-03-24T04:01:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141463",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:5'></a>
I replaced the patch by a new version. In the new version, I copied the test twice, so it's always run for 100x100 matrices (5% density) and optionally (long) run for 1000x1000 matrices (1% density).

The test for 100x100 matrices takes about 0.1 s, so it's ok. I think it's still a useful test since it runs the algorithm switching to dense at several different columns.

The test for 1000x1000 takes about 25 s (I changed the modulus from 97 to 997) and it's still optional (long). Is that too long for a "long" test?



---

archive/issue_comments_141464.json:
```json
{
    "body": "<a id='comment:6'></a>\nPS: 500x500  with 1% density takes about 5s, so we may want to replace the 1000x1000 test by a 500x500 test (and still make it long time optional).",
    "created_at": "2011-03-24T04:02:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141464",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:6'></a>
PS: 500x500  with 1% density takes about 5s, so we may want to replace the 1000x1000 test by a 500x500 test (and still make it long time optional).



---

archive/issue_events_033093.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2011-03-25T01:48:40Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "milestone": "sage-4.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10733#event-33093"
}
```



---

archive/issue_comments_141465.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -5,3 +5,5 @@\n       dense.\n ```\n That's what we will do in this ticket, by switching to linbox echelon form code when rows start to get non-dense.\n+\n+DEPENDS ON: #10734\n``````\n",
    "created_at": "2011-03-25T01:48:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141465",
    "user": "https://github.com/williamstein"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -5,3 +5,5 @@
       dense.
 ```
 That's what we will do in this ticket, by switching to linbox echelon form code when rows start to get non-dense.
+
+DEPENDS ON: #10734
``````




---

archive/issue_comments_141466.json:
```json
{
    "body": "<a id='comment:8'></a>\nREVIEW:\n\nAnnoyingly, there are issues when the modulus is 2, e.g.:\n\n```\nsage -t  sage/coding/linear_code.py\n**********************************************************************\nFile \"/tmp/wstein/sage-4.7.alpha3-sage.math.washington.edu-x86_64-Linux/devel/sage-main/sage/coding/linear_code.py\", line 1523:\n    sage: C.is_permutation_automorphism(g)\nException raised:\n    Traceback (most recent call last):\n      File \"/tmp/wstein/sage-4.7.alpha3-sage.math.washington.edu-x86_64-Linux/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/tmp/wstein/sage-4.7.alpha3-sage.math.washington.edu-x86_64-Linux/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/tmp/wstein/sage-4.7.alpha3-sage.math.washington.edu-x86_64-Linux/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_31[10]>\", line 1, in <module>\n        C.is_permutation_automorphism(g)###line 1523:\n    sage: C.is_permutation_automorphism(g)\n      File \"/tmp/wstein/sage-4.7.alpha3-sage.math.washington.edu-x86_64-Linux/local/lib/python/site-packages/sage/coding/linear_code.py\", line 1532, in is_permutation_automorphism\n        HGm = H*g.matrix()\n      File \"element.pyx\", line 2282, in sage.structure.element.Matrix.__mul__ (sage/structure/element.c:15874)\n      File \"coerce.pyx\", line 709, in sage.structure.coerce.CoercionModel_cache_maps.bin_op (sage/structure/coerce.c:6368)\n      File \"action.pyx\", line 144, in sage.matrix.action.MatrixMatrixAction._call_ (sage/matrix/action.c:2818)\n      File \"matrix_modn_sparse.pyx\", line 683, in sage.matrix.matrix_modn_sparse.Matrix_modn_sparse.dense_matrix (sage/matrix/matrix_modn_sparse.c:11767)\n    TypeError: Cannot convert sage.matrix.matrix_mod2_dense.Matrix_mod2_dense to sage.matrix.matrix_modn_dense.Matrix_modn_dense\n**********************************************************************\n```\n\nand\n\n```\nsage -t  sage/homology/cell_complex.py\n**********************************************************************\nFile \"/tmp/wstein/sage-4.7.alpha3-sage.math.washington.edu-x86_64-Linux/devel/sage-main/sage/homology/cell_complex.py\", line 456:\n    sage: P.homology(base_ring=GF(2))\nException raised:\n    Traceback (most recent call last):\n      File \"/tmp/wstein/sage-4.7.alpha3-sage.math.washington.edu-x86_64-Linux/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/tmp/wstein/sage-4.7.alpha3-sage.math.washington.edu-x86_64-Linux/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/tmp/wstein/sage-4.7.alpha3-sage.math.washington.edu-x86_64-Linux/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_15[4]>\", line 1, in <module>\n        P.homology(base_ring=GF(Integer(2)))###line 456:\n    sage: P.homology(base_ring=GF(2))\n      File \"/tmp/wstein/sage-4.7.alpha3-sage.math.washington.edu-x86_64-Linux/local/lib/python/site-packages/sage/homology/cell_complex.py\", line 552, in homology\n        dimensions=dims, **kwds)\n      File \"/tmp/wstein/sage-4.7.alpha3-sage.math.washington.edu-x86_64-Linux/local/lib/python/site-packages/sage/homology/delta_complex.py\", line 662, in chain_complex\n        return ChainComplex(data=differentials, degree=-1, **kwds)\n      File \"/tmp/wstein/sage-4.7.alpha3-sage.math.washington.edu-x86_64-Linux/local/lib/python/site-packages/sage/homology/chain_complex.py\", line 462, in __init__\n        raise TypeError, \"The differentials d_{%s} and d_{%s} are not compatible: their product is not defined.\" % (n, n+degree)\n    TypeError: The differentials d_{1} and d_{0} are not compatible: their product is not defined.\n```\n\nThe result of running the whole test suite:\n\n```\n\n\n```\n\n\nHere is another style comment.  In Cython now doing\n\n```\nfor c from 0 <= c < self._ncols:\n```\nis *identical* to doing:\n\n```\nfor c in range(self._ncols):\n```\n\n\nOtherwise, everything looks great, and this is going to be *extremeley* useful for my research!!",
    "created_at": "2011-03-25T02:03:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141466",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:8'></a>
REVIEW:

Annoyingly, there are issues when the modulus is 2, e.g.:

```
sage -t  sage/coding/linear_code.py
**********************************************************************
File "/tmp/wstein/sage-4.7.alpha3-sage.math.washington.edu-x86_64-Linux/devel/sage-main/sage/coding/linear_code.py", line 1523:
    sage: C.is_permutation_automorphism(g)
Exception raised:
    Traceback (most recent call last):
      File "/tmp/wstein/sage-4.7.alpha3-sage.math.washington.edu-x86_64-Linux/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/tmp/wstein/sage-4.7.alpha3-sage.math.washington.edu-x86_64-Linux/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/tmp/wstein/sage-4.7.alpha3-sage.math.washington.edu-x86_64-Linux/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_31[10]>", line 1, in <module>
        C.is_permutation_automorphism(g)###line 1523:
    sage: C.is_permutation_automorphism(g)
      File "/tmp/wstein/sage-4.7.alpha3-sage.math.washington.edu-x86_64-Linux/local/lib/python/site-packages/sage/coding/linear_code.py", line 1532, in is_permutation_automorphism
        HGm = H*g.matrix()
      File "element.pyx", line 2282, in sage.structure.element.Matrix.__mul__ (sage/structure/element.c:15874)
      File "coerce.pyx", line 709, in sage.structure.coerce.CoercionModel_cache_maps.bin_op (sage/structure/coerce.c:6368)
      File "action.pyx", line 144, in sage.matrix.action.MatrixMatrixAction._call_ (sage/matrix/action.c:2818)
      File "matrix_modn_sparse.pyx", line 683, in sage.matrix.matrix_modn_sparse.Matrix_modn_sparse.dense_matrix (sage/matrix/matrix_modn_sparse.c:11767)
    TypeError: Cannot convert sage.matrix.matrix_mod2_dense.Matrix_mod2_dense to sage.matrix.matrix_modn_dense.Matrix_modn_dense
**********************************************************************
```

and

```
sage -t  sage/homology/cell_complex.py
**********************************************************************
File "/tmp/wstein/sage-4.7.alpha3-sage.math.washington.edu-x86_64-Linux/devel/sage-main/sage/homology/cell_complex.py", line 456:
    sage: P.homology(base_ring=GF(2))
Exception raised:
    Traceback (most recent call last):
      File "/tmp/wstein/sage-4.7.alpha3-sage.math.washington.edu-x86_64-Linux/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/tmp/wstein/sage-4.7.alpha3-sage.math.washington.edu-x86_64-Linux/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/tmp/wstein/sage-4.7.alpha3-sage.math.washington.edu-x86_64-Linux/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_15[4]>", line 1, in <module>
        P.homology(base_ring=GF(Integer(2)))###line 456:
    sage: P.homology(base_ring=GF(2))
      File "/tmp/wstein/sage-4.7.alpha3-sage.math.washington.edu-x86_64-Linux/local/lib/python/site-packages/sage/homology/cell_complex.py", line 552, in homology
        dimensions=dims, **kwds)
      File "/tmp/wstein/sage-4.7.alpha3-sage.math.washington.edu-x86_64-Linux/local/lib/python/site-packages/sage/homology/delta_complex.py", line 662, in chain_complex
        return ChainComplex(data=differentials, degree=-1, **kwds)
      File "/tmp/wstein/sage-4.7.alpha3-sage.math.washington.edu-x86_64-Linux/local/lib/python/site-packages/sage/homology/chain_complex.py", line 462, in __init__
        raise TypeError, "The differentials d_{%s} and d_{%s} are not compatible: their product is not defined." % (n, n+degree)
    TypeError: The differentials d_{1} and d_{0} are not compatible: their product is not defined.
```

The result of running the whole test suite:

```


```


Here is another style comment.  In Cython now doing

```
for c from 0 <= c < self._ncols:
```
is *identical* to doing:

```
for c in range(self._ncols):
```


Otherwise, everything looks great, and this is going to be *extremeley* useful for my research!!



---

archive/issue_comments_141467.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2011-03-25T02:03:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141467",
    "user": "https://github.com/williamstein"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_141468.json:
```json
{
    "body": "<a id='comment:10'></a>\nOh, here are the files with failures:\n\n```\n\n \n----------------------------------------------------------------------\n\nThe following tests failed:\n\n\tsage -t  devel/sage-main/sage/modular/modsym/ambient.py # 4 doctests failed\n\tsage -t  devel/sage-main/sage/matrix/matrix_space.py # 1 doctests failed\n\tsage -t  devel/sage-main/sage/coding/linear_code.py # 2 doctests failed\n\tsage -t  devel/sage-main/sage/rings/polynomial/pbori.pyx # 1 doctests failed\n\tsage -t  devel/sage-main/sage/homology/cell_complex.py # 2 doctests failed\n\tsage -t  devel/sage-main/sage/homology/examples.py # 2 doctests failed\n\tsage -t  devel/sage-main/sage/homology/delta_complex.py # 3 doctests failed\n----------------------------------------------------------------------\nTimings have been updated.\nTotal time for all tests: 328.6 seconds\n```\n\nIt's all p=2 weirdness, I suspect.",
    "created_at": "2011-03-25T02:04:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141468",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:10'></a>
Oh, here are the files with failures:

```

 
----------------------------------------------------------------------

The following tests failed:

	sage -t  devel/sage-main/sage/modular/modsym/ambient.py # 4 doctests failed
	sage -t  devel/sage-main/sage/matrix/matrix_space.py # 1 doctests failed
	sage -t  devel/sage-main/sage/coding/linear_code.py # 2 doctests failed
	sage -t  devel/sage-main/sage/rings/polynomial/pbori.pyx # 1 doctests failed
	sage -t  devel/sage-main/sage/homology/cell_complex.py # 2 doctests failed
	sage -t  devel/sage-main/sage/homology/examples.py # 2 doctests failed
	sage -t  devel/sage-main/sage/homology/delta_complex.py # 3 doctests failed
----------------------------------------------------------------------
Timings have been updated.
Total time for all tests: 328.6 seconds
```

It's all p=2 weirdness, I suspect.



---

archive/issue_comments_141469.json:
```json
{
    "body": "<a id='comment:11'></a>\nComment: I haven't run the full test suite yet -- will report back later...",
    "created_at": "2011-04-08T06:29:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141469",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:11'></a>
Comment: I haven't run the full test suite yet -- will report back later...



---

archive/issue_comments_141470.json:
```json
{
    "body": "<a id='comment:12'></a>\nTest suite run and it fully passes for me.   Gonzalo (say) needs to review patch 4 and then this can get a positive review.",
    "created_at": "2011-04-08T15:37:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141470",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:12'></a>
Test suite run and it fully passes for me.   Gonzalo (say) needs to review patch 4 and then this can get a positive review.



---

archive/issue_comments_141471.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2011-04-08T15:37:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141471",
    "user": "https://github.com/williamstein"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_141472.json:
```json
{
    "body": "<a id='comment:13'></a>\nI reviewed the new patch and ran the test suite, which passes for me as well.\n\nThe problematic method was `Matrix_modn_sparse.set_block_unsafe(..., Matrix_modn_dense m)` which is meant to set a block of a sparse matrix given by a dense matrix. But for mod 2, the dense matrices are implemented by a different class (`Matrix_mod2_dense`) so calls to `set_block_unsafe` will fail. What the reviewer patch does is to factor out a common superclass for both `Matrix_mod_dense` which can be used in the implementation of `set_block_unsafe`.\n\nI noticed that computing echelon form for a sparse mod2 matrix is much slower than converting the matrix to dense and using echelon form (which uses M4RI and is quite fast). Thus, it could make sense to reimplement sparse mod2 echelon form via conversion to dense. However, note that conversion from mod2 dense to mod2 sparse is quite slow currently.\n\nIn spite of the above comment, I'm giving positive review to patch 4 based on:\n- the code works properly for mod2 sparse matrices, so no functionality regression.\n- it runs definitely faster than what we had before for sparse matrices, so no performance regression.\nSince this ticket gives significant improvements for larger modulus, it's important that we merge it even if it's not the best we could do for the modulus 2.",
    "created_at": "2011-04-08T18:19:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141472",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:13'></a>
I reviewed the new patch and ran the test suite, which passes for me as well.

The problematic method was `Matrix_modn_sparse.set_block_unsafe(..., Matrix_modn_dense m)` which is meant to set a block of a sparse matrix given by a dense matrix. But for mod 2, the dense matrices are implemented by a different class (`Matrix_mod2_dense`) so calls to `set_block_unsafe` will fail. What the reviewer patch does is to factor out a common superclass for both `Matrix_mod_dense` which can be used in the implementation of `set_block_unsafe`.

I noticed that computing echelon form for a sparse mod2 matrix is much slower than converting the matrix to dense and using echelon form (which uses M4RI and is quite fast). Thus, it could make sense to reimplement sparse mod2 echelon form via conversion to dense. However, note that conversion from mod2 dense to mod2 sparse is quite slow currently.

In spite of the above comment, I'm giving positive review to patch 4 based on:
- the code works properly for mod2 sparse matrices, so no functionality regression.
- it runs definitely faster than what we had before for sparse matrices, so no performance regression.
Since this ticket gives significant improvements for larger modulus, it's important that we merge it even if it's not the best we could do for the modulus 2.



---

archive/issue_comments_141473.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2011-04-08T18:19:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141473",
    "user": "https://github.com/tornaria"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_141474.json:
```json
{
    "body": "<a id='comment:14'></a>\nFor the record, this is what I think could be used for mod2 sparse via dense:\n\n```\n   dense = self.dense_matrix()\n   dense.echelonize()\n   self.set_block_unsafe(0, 0, dense)\n```\nThe last step does the conversion from dense to sparse, and it's way faster than calling dense.matrix_sparse(), but it's still slow.",
    "created_at": "2011-04-08T18:34:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141474",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:14'></a>
For the record, this is what I think could be used for mod2 sparse via dense:

```
   dense = self.dense_matrix()
   dense.echelonize()
   self.set_block_unsafe(0, 0, dense)
```
The last step does the conversion from dense to sparse, and it's way faster than calling dense.matrix_sparse(), but it's still slow.



---

archive/issue_comments_141475.json:
```json
{
    "body": "<a id='comment:15'></a>\nI added two more patches to the sequence:\n\n- trac_10733.05: adds a doctest for the case of mod2, because it is using different code it's worth testing separately\n- trac_10733.06: adds a special case to the method for the case when \"switch_density\" is 0.\n\nThe latter basically implements what I suggested in my last comment as part of the `_echelon_in_place_classical()` method. As is now, the default for \"switch_density\" is always 0.1 so this code would not be normally used. But if one explicitly uses \"switch_density=0\", then the method will run faster after this patch. And for the case of mod 2, it seems that it could indeed be faster to use switch_density=0 instead of the default 0.1.\n\nI guess these two patches need to go back to review, although trac doesn't give me the option of changing the status to needs_review...",
    "created_at": "2011-04-08T19:22:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141475",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:15'></a>
I added two more patches to the sequence:

- trac_10733.05: adds a doctest for the case of mod2, because it is using different code it's worth testing separately
- trac_10733.06: adds a special case to the method for the case when "switch_density" is 0.

The latter basically implements what I suggested in my last comment as part of the `_echelon_in_place_classical()` method. As is now, the default for "switch_density" is always 0.1 so this code would not be normally used. But if one explicitly uses "switch_density=0", then the method will run faster after this patch. And for the case of mod 2, it seems that it could indeed be faster to use switch_density=0 instead of the default 0.1.

I guess these two patches need to go back to review, although trac doesn't give me the option of changing the status to needs_review...



---

archive/issue_comments_141476.json:
```json
{
    "body": "<a id='comment:16'></a>\nNote that the \"switch_density=0\" case is already tested by the doctests so there's no need to add another doctest after patch 06.",
    "created_at": "2011-04-08T19:26:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141476",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:16'></a>
Note that the "switch_density=0" case is already tested by the doctests so there's no need to add another doctest after patch 06.



---

archive/issue_comments_141477.json:
```json
{
    "body": "<a id='comment:17'></a>\nPositive review (on the two extra little patches added, hence everything)!",
    "created_at": "2011-04-08T19:43:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141477",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:17'></a>
Positive review (on the two extra little patches added, hence everything)!



---

archive/issue_events_033094.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-04-13T07:46:43Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "milestone": "sage-4.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10733#event-33094"
}
```



---

archive/issue_events_033095.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-04-13T07:46:43Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "milestone": "sage-4.7.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10733#event-33095"
}
```



---

archive/issue_events_033096.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-04-20T15:06:59Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "milestone": "sage-4.7.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10733#event-33096"
}
```



---

archive/issue_events_033097.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-04-20T15:06:59Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "milestone": "sage-feature",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10733#event-33097"
}
```



---

archive/issue_comments_141478.json:
```json
{
    "body": "<a id='comment:19'></a>\nMoving the milestone since this depends on a non-positively-reviewed ticket.",
    "created_at": "2011-04-20T15:06:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141478",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:19'></a>
Moving the milestone since this depends on a non-positively-reviewed ticket.



---

archive/issue_comments_141479.json:
```json
{
    "body": "**Dependencies:** #10734",
    "created_at": "2011-05-27T07:51:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141479",
    "user": "https://github.com/jdemeyer"
}
```

**Dependencies:** #10734



---

archive/issue_comments_141480.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -5,5 +5,3 @@\n       dense.\n ```\n That's what we will do in this ticket, by switching to linbox echelon form code when rows start to get non-dense.\n-\n-DEPENDS ON: #10734\n``````\n",
    "created_at": "2011-05-27T07:51:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141480",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -5,5 +5,3 @@
       dense.
 ```
 That's what we will do in this ticket, by switching to linbox echelon form code when rows start to get non-dense.
-
-DEPENDS ON: #10734
``````




---

archive/issue_events_033098.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-06-10T08:40:20Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "milestone": "sage-feature",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10733#event-33098"
}
```



---

archive/attachments_014046.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_10733.01-echelon_better_verbose",
    "asset_url": "tarball://root/attachments/some-uuid/ticket10733/trac_10733.01-echelon_better_verbose",
    "created_at": "2011-06-13T18:32:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.01-echelon_better_verbose",
    "user": "https://github.com/tornaria"
}
```



---

archive/issue_comments_141481.json:
```json
{
    "body": "Improve verbose logging of echelon_in_place_classical",
    "created_at": "2011-06-13T18:32:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141481",
    "user": "https://github.com/tornaria"
}
```

Improve verbose logging of echelon_in_place_classical



---

archive/issue_comments_141482.json:
```json
{
    "body": "Make matrix modn sparse echelon form way faster by switching to dense linbox at a good time when the matrix gets too dense",
    "created_at": "2011-06-13T18:33:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141482",
    "user": "https://github.com/tornaria"
}
```

Make matrix modn sparse echelon form way faster by switching to dense linbox at a good time when the matrix gets too dense



---

archive/attachments_014047.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_10733.03-documentation",
    "asset_url": "tarball://root/attachments/some-uuid/ticket10733/trac_10733.03-documentation",
    "created_at": "2011-06-13T18:35:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.03-documentation",
    "user": "https://github.com/tornaria"
}
```



---

archive/issue_comments_141483.json:
```json
{
    "body": "Add a test for matrix_modn_sparse._echelon_in_place_classical",
    "created_at": "2011-06-13T18:35:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141483",
    "user": "https://github.com/tornaria"
}
```

Add a test for matrix_modn_sparse._echelon_in_place_classical



---

archive/attachments_014048.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_10733.04-referee_refactor_to_support_p2.2.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket10733/trac_10733.04-referee_refactor_to_support_p2.2.patch",
    "created_at": "2011-06-13T18:35:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/tornaria"
}
```



---

archive/issue_comments_141484.json:
```json
{
    "body": "refactor code to support p=2 case (part 2)",
    "created_at": "2011-06-13T18:35:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141484",
    "user": "https://github.com/tornaria"
}
```

refactor code to support p=2 case (part 2)



---

archive/attachments_014049.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_10733.05-doctest_mod2.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket10733/trac_10733.05-doctest_mod2.patch",
    "created_at": "2011-06-13T18:36:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/tornaria"
}
```



---

archive/issue_comments_141485.json:
```json
{
    "body": "Add testing for echelonize of mod2 sparse matrices",
    "created_at": "2011-06-13T18:36:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141485",
    "user": "https://github.com/tornaria"
}
```

Add testing for echelonize of mod2 sparse matrices



---

archive/attachments_014050.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_10733.06-fastpath_for_strictly_dense_method.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket10733/trac_10733.06-fastpath_for_strictly_dense_method.patch",
    "created_at": "2011-06-13T18:36:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/tornaria"
}
```



---

archive/issue_comments_141486.json:
```json
{
    "body": "Implement a fast path for strictly using a dense method (could be useful for mod2)",
    "created_at": "2011-06-13T18:36:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141486",
    "user": "https://github.com/tornaria"
}
```

Implement a fast path for strictly using a dense method (could be useful for mod2)



---

archive/issue_comments_141487.json:
```json
{
    "body": "<a id='comment:22'></a>\nI've reuploaded all the patches with the right format (see #10734).\n\nAlso, I moved part of the referee patch to #10734, otherwise some doctests would fail if that ticket is merged without the current one.\n\nThere's no new code at all, so I assume the positive review is still valid.\n\n---\n\nOTOH, I screwed up filenames because (a) I made a mistake uploading one patch (b) I don't have permissions to delete incorrectly uploaded patches (c) I don't have permissions to replace the referee patch.\n\nWhoever has the rights, what needs to be done is:\na. delete attachment  trac_10733.2.03-documentation (uploaded by mistake)\nb. delete the original referee patch trac_10733.04-referee_refactor_to_support_p2.patch, and replace it by the new trac_10733.04-referee_refactor_to_support_p2.2.patch\n\nAfter those two changes, the six patches are applied one after other in numerical order.",
    "created_at": "2011-06-13T18:43:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141487",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:22'></a>
I've reuploaded all the patches with the right format (see #10734).

Also, I moved part of the referee patch to #10734, otherwise some doctests would fail if that ticket is merged without the current one.

There's no new code at all, so I assume the positive review is still valid.

---

OTOH, I screwed up filenames because (a) I made a mistake uploading one patch (b) I don't have permissions to delete incorrectly uploaded patches (c) I don't have permissions to replace the referee patch.

Whoever has the rights, what needs to be done is:
a. delete attachment  trac_10733.2.03-documentation (uploaded by mistake)
b. delete the original referee patch trac_10733.04-referee_refactor_to_support_p2.patch, and replace it by the new trac_10733.04-referee_refactor_to_support_p2.2.patch

After those two changes, the six patches are applied one after other in numerical order.



---

archive/issue_comments_141488.json:
```json
{
    "body": "<a id='comment:23'></a>\napply trac_10733.01-echelon_better_verbose, trac_10733.02-echelon_make_faster, trac_10733.03-documentation, trac_10733.04-referee_refactor_to_support_p2.2.patch, trac_10733.05-doctest_mod2.patch, trac_10733.06-fastpath_for_strictly_dense_method.patch",
    "created_at": "2011-06-15T12:55:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141488",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:23'></a>
apply trac_10733.01-echelon_better_verbose, trac_10733.02-echelon_make_faster, trac_10733.03-documentation, trac_10733.04-referee_refactor_to_support_p2.2.patch, trac_10733.05-doctest_mod2.patch, trac_10733.06-fastpath_for_strictly_dense_method.patch



---

archive/issue_comments_141489.json:
```json
{
    "body": "<a id='comment:24'></a>\nPlease fill in your real name as Reviewer.",
    "created_at": "2012-07-27T20:44:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141489",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'></a>
Please fill in your real name as Reviewer.



---

archive/issue_comments_141490.json:
```json
{
    "body": "**Changing author** from \"Gonzalo Tornaria\" to \"Gonzalo Tornar\u00eda, William Stein\".",
    "created_at": "2013-12-20T17:58:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141490",
    "user": "https://github.com/vbraun"
}
```

**Changing author** from "Gonzalo Tornaria" to "Gonzalo Tornaría, William Stein".



---

archive/issue_comments_141491.json:
```json
{
    "body": "**Reviewer:** William Stein, Gonzalo Tornar\u00eda",
    "created_at": "2013-12-20T17:58:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141491",
    "user": "https://github.com/vbraun"
}
```

**Reviewer:** William Stein, Gonzalo Tornaría



---

archive/issue_comments_141492.json:
```json
{
    "body": "<a id='comment:26'></a>\nI'm setting this to needs works since its not a git branch.",
    "created_at": "2015-03-12T23:55:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141492",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:26'></a>
I'm setting this to needs works since its not a git branch.



---

archive/issue_comments_141493.json:
```json
{
    "body": "**Changing status** from positive_review to needs_work.",
    "created_at": "2015-03-12T23:55:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10733",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10733#issuecomment-141493",
    "user": "https://github.com/vbraun"
}
```

**Changing status** from positive_review to needs_work.
