# Issue 10098: Flaky doctest in sage/interfaces/expect.py

archive/issues_010097.json:
```json
{
    "assignees": [],
    "body": "With #10004 merged into 4.6.alpha3, I get the doctest failures\n\n```python\nsage -t -long  -force_lib devel/sage/sage/interfaces/expect.py\n**********************************************************************\nFile \"/home/buildbot/build/sage/cleo-1/cleo_full/build/sage-4.6.alpha3/devel/sage-main/sage/interfaces/expect.py\", line 596:\n    sage: L = [t[1] for t in f(range(5))]\nExpected nothing\nGot:\n    [Errno 16] Device or resource busy: '/home/buildbot/build/sage/cleo-1/cleo_full/build/sage-4.6.alpha3/.sage/temp/cleo/32313/dir_0/.nfs00000000007d541a0000abe9'\n**********************************************************************\nFile \"/home/buildbot/build/sage/cleo-1/cleo_full/build/sage-4.6.alpha3/devel/sage-main/sage/interfaces/expect.py\", line 603:\n    sage: L = [t[1] for t in f(range(5))]\nExpected nothing\nGot:\n    [Errno 16] Device or resource busy: '/home/buildbot/build/sage/cleo-1/cleo_full/build/sage-4.6.alpha3/.sage/temp/cleo/32313/dir_1/.nfs00000000007d541a0000abf1'\n```\non the Skynet machines cleo, eno, fulvia, sextus, and taurus.\n\nThe `@fork` decorator tickets #9501, #9616, and #9631 are related.\n\nAssignee: **@sagetrac-mvngu**\n\nCC:  @boothby @sagetrac-drkirkby @malb @sagetrac-mariah @simon-king-jena @vbraun @williamstein\n\nAuthor: **Volker Braun**\n\nReviewer: **Mitesh Patel**\n\nMerged: **sage-4.6.rc0**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/10098_\n\n",
    "closed_at": "2010-10-21T08:41:00Z",
    "created_at": "2010-10-07T22:09:38Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/doctest%20coverage",
        "https://github.com/sagemath/sage/labels/p1%20%E2%80%93%20blocker",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-4.6",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Flaky doctest in sage/interfaces/expect.py",
    "type": "issue",
    "updated_at": "2010-10-21T08:41:00Z",
    "url": "https://github.com/sagemath/sage/issues/10098",
    "user": "https://github.com/qed777"
}
```
With #10004 merged into 4.6.alpha3, I get the doctest failures

```python
sage -t -long  -force_lib devel/sage/sage/interfaces/expect.py
**********************************************************************
File "/home/buildbot/build/sage/cleo-1/cleo_full/build/sage-4.6.alpha3/devel/sage-main/sage/interfaces/expect.py", line 596:
    sage: L = [t[1] for t in f(range(5))]
Expected nothing
Got:
    [Errno 16] Device or resource busy: '/home/buildbot/build/sage/cleo-1/cleo_full/build/sage-4.6.alpha3/.sage/temp/cleo/32313/dir_0/.nfs00000000007d541a0000abe9'
**********************************************************************
File "/home/buildbot/build/sage/cleo-1/cleo_full/build/sage-4.6.alpha3/devel/sage-main/sage/interfaces/expect.py", line 603:
    sage: L = [t[1] for t in f(range(5))]
Expected nothing
Got:
    [Errno 16] Device or resource busy: '/home/buildbot/build/sage/cleo-1/cleo_full/build/sage-4.6.alpha3/.sage/temp/cleo/32313/dir_1/.nfs00000000007d541a0000abf1'
```
on the Skynet machines cleo, eno, fulvia, sextus, and taurus.

The `@fork` decorator tickets #9501, #9616, and #9631 are related.

Assignee: **@sagetrac-mvngu**

CC:  @boothby @sagetrac-drkirkby @malb @sagetrac-mariah @simon-king-jena @vbraun @williamstein

Author: **Volker Braun**

Reviewer: **Mitesh Patel**

Merged: **sage-4.6.rc0**

_Issue created by migration from https://trac.sagemath.org/ticket/10098_





---

archive/issue_events_120406.json:
```json
{
    "actor": "https://github.com/qed777",
    "created_at": "2010-10-07T22:09:38Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/10098",
    "milestone_number": null,
    "milestone_title": "sage-4.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10098#event-120406"
}
```



---

archive/issue_events_120407.json:
```json
{
    "actor": "https://github.com/qed777",
    "created_at": "2010-10-07T22:09:38Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10098",
    "label": "https://github.com/sagemath/sage/labels/doctest%20coverage",
    "label_color": "696969",
    "label_name": "doctest coverage",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10098#event-120407"
}
```



---

archive/issue_events_120408.json:
```json
{
    "actor": "https://github.com/qed777",
    "created_at": "2010-10-07T22:09:38Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10098",
    "label": "https://github.com/sagemath/sage/labels/p1%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10098#event-120408"
}
```



---

archive/issue_events_120409.json:
```json
{
    "actor": "https://github.com/qed777",
    "created_at": "2010-10-07T22:09:38Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10098",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10098#event-120409"
}
```



---

archive/issue_events_120410.json:
```json
{
    "actor": "https://github.com/qed777",
    "created_at": "2010-10-07T22:11:47Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/10098",
    "title_is": "Flaky doctest in sage/interfaces/expect.py",
    "title_was": "Flaky doctest in",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10098#event-120410"
}
```



---

archive/issue_comments_094747.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">Comment 1</div>\n\nThis is reminiscent of #9501 / #9616.  Since the fix at #10004 works (right?), maybe we should tag these tests as \"not tested\" instead of reverting the patch?  Or is there another way?",
    "created_at": "2010-10-07T22:11:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10098#issuecomment-94747",
    "user": "https://github.com/qed777"
}
```

<div id="comment:1" align="right">Comment 1</div>

This is reminiscent of #9501 / #9616.  Since the fix at #10004 works (right?), maybe we should tag these tests as "not tested" instead of reverting the patch?  Or is there another way?



---

archive/issue_comments_094748.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">Comment 2</div>\n\nReplying to [@qed777](#comment%3A1):\n> This is reminiscent of #9501 / #9616.  Since the fix at #10004 works (right?),\n\nI hope so...\n\n> maybe we should tag these tests as \"not tested\" instead of reverting the patch?  Or is there another way?\n\nWhat doees \"device busy\" exactly mean? Can one trac this down? Actually the purpose of #10004 was to avoid conflicts (race conditions) on the hard disk.",
    "created_at": "2010-10-07T23:31:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10098#issuecomment-94748",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:2" align="right">Comment 2</div>

Replying to [@qed777](#comment%3A1):
> This is reminiscent of #9501 / #9616.  Since the fix at #10004 works (right?),

I hope so...

> maybe we should tag these tests as "not tested" instead of reverting the patch?  Or is there another way?

What doees "device busy" exactly mean? Can one trac this down? Actually the purpose of #10004 was to avoid conflicts (race conditions) on the hard disk.



---

archive/issue_comments_094749.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -16,5 +16,5 @@\n Got:\n     [Errno 16] Device or resource busy: '/home/buildbot/build/sage/cleo-1/cleo_full/build/sage-4.6.alpha3/.sage/temp/cleo/32313/dir_1/.nfs00000000007d541a0000abf1'\n ```\n-on the Skynet machines cleo, eno, fulvia, and sextus.\n+on the Skynet machines cleo, eno, fulvia, sextus, and taurus.\n \n``````\n",
    "created_at": "2010-10-09T08:05:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10098#issuecomment-94749",
    "user": "https://github.com/qed777"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -16,5 +16,5 @@
 Got:
     [Errno 16] Device or resource busy: '/home/buildbot/build/sage/cleo-1/cleo_full/build/sage-4.6.alpha3/.sage/temp/cleo/32313/dir_1/.nfs00000000007d541a0000abf1'
 ```
-on the Skynet machines cleo, eno, fulvia, and sextus.
+on the Skynet machines cleo, eno, fulvia, sextus, and taurus.
 
``````




---

archive/issue_comments_094750.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">Comment 3</div>\n\nI think this is a filesystem quirk (a problem?), but I'm not sure.  David, Mariah, and Volker, any thoughts?",
    "created_at": "2010-10-09T08:05:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10098#issuecomment-94750",
    "user": "https://github.com/qed777"
}
```

<div id="comment:3" align="right">Comment 3</div>

I think this is a filesystem quirk (a problem?), but I'm not sure.  David, Mariah, and Volker, any thoughts?



---

archive/issue_comments_094751.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">Comment 4</div>\n\nDid that appear at the same time as the \"sync\" was removed from NFS? Or did we upgrade the `expect` python module?\n\nI think something is tripping over the following fact: In UNIX, you can open a file, then delete it, then delete the containing directory. The file is still open for business until you close it. But NFS doesn't have inodes, so if you delete an open file the NFS volume will contain a fake directory entry `.nfs00000000007d541a0000abf1` that only disappears when you close the file. I guess that the  \"Device or resource busy\" error is from trying to delete the non-empty directory. Either because the open file descriptor was leaked or because of some concurrency issue with NFS.",
    "created_at": "2010-10-09T09:49:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10098#issuecomment-94751",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:4" align="right">Comment 4</div>

Did that appear at the same time as the "sync" was removed from NFS? Or did we upgrade the `expect` python module?

I think something is tripping over the following fact: In UNIX, you can open a file, then delete it, then delete the containing directory. The file is still open for business until you close it. But NFS doesn't have inodes, so if you delete an open file the NFS volume will contain a fake directory entry `.nfs00000000007d541a0000abf1` that only disappears when you close the file. I guess that the  "Device or resource busy" error is from trying to delete the non-empty directory. Either because the open file descriptor was leaked or because of some concurrency issue with NFS.



---

archive/issue_comments_094752.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">Comment 5</div>\n\nReplying to [@qed777](#comment%3A3):\n> I think this is a filesystem quirk (a problem?), but I'm not sure.  David, Mariah, and Volker, any thoughts?\n\nI tend to agree in this case - it looks like file systems issues. \n\nHowever, I've seen problems with the pexpect interface on systems which use local file systems. I'm not convinced it is a very reliable tool myself. \n\nI made a point on sage-devel half an hour or so ago, but I'll make it briefly here. The SQlite developers take testing very seriously \n\nhttp://www.sqlite.org/testing.html \n\nTheir test code is more than 600 times as big as code in the SQlite database!\n\nThey advise against the use of NFS as fcntl() file locking is broken on many NFS implementations.\n\nhttp://www.sqlite.org/faq.html#q5\n\nMy own money would be that if a Sun running Solaris was serving another Sun running Solaris, it would work! But perhaps I'm biased - I tend to trust Solaris more than random collections of Linux. (Of course, when William disabled the ZIL log on a ZFS file system on disk.math to improve performance, all bets were off. That is well documented to be a bad policy, and should never be used except for test purposes). \n\nDave",
    "created_at": "2010-10-09T11:11:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10098#issuecomment-94752",
    "user": "https://github.com/sagetrac-drkirkby"
}
```

<div id="comment:5" align="right">Comment 5</div>

Replying to [@qed777](#comment%3A3):
> I think this is a filesystem quirk (a problem?), but I'm not sure.  David, Mariah, and Volker, any thoughts?

I tend to agree in this case - it looks like file systems issues. 

However, I've seen problems with the pexpect interface on systems which use local file systems. I'm not convinced it is a very reliable tool myself. 

I made a point on sage-devel half an hour or so ago, but I'll make it briefly here. The SQlite developers take testing very seriously 

http://www.sqlite.org/testing.html 

Their test code is more than 600 times as big as code in the SQlite database!

They advise against the use of NFS as fcntl() file locking is broken on many NFS implementations.

http://www.sqlite.org/faq.html#q5

My own money would be that if a Sun running Solaris was serving another Sun running Solaris, it would work! But perhaps I'm biased - I tend to trust Solaris more than random collections of Linux. (Of course, when William disabled the ZIL log on a ZFS file system on disk.math to improve performance, all bets were off. That is well documented to be a bad policy, and should never be used except for test purposes). 

Dave



---

archive/issue_comments_094753.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">Comment 6</div>\n\nReplying to [@vbraun](#comment%3A4):\n> Did that appear at the same time as the \"sync\" was removed from NFS? Or did we upgrade the `expect` python module?\n\nAs far as I'm aware, the Skynet cluster is administered independently (by Mariah Lenox) from the Sage cluster.  I don't know whether Mariah has made any recent changes to Skynet's NFS configuration.\n\nWe made some changes to `sage.interfaces.expect` at #10004.\n\n> I think something is tripping over the following fact: In UNIX, you can open a file, then delete it, then delete the containing directory. The file is still open for business until you close it. But NFS doesn't have inodes, so if you delete an open file the NFS volume will contain a fake directory entry `.nfs00000000007d541a0000abf1` that only disappears when you close the file. I guess that the  \"Device or resource busy\" error is from trying to delete the non-empty directory. Either because the open file descriptor was leaked or because of some concurrency issue with NFS.\n\nThanks!  I've tried to make an example:\n\n```python\nsage: import os\nsage: os.mkdir('dir')\nsage: f = open('dir/foo', 'w')\nsage: os.listdir('dir')\n['foo']\nsage: # Now 'rm dir/foo' in a separate window.\nsage: sage: os.listdir('dir')\n['.nfs000000000143f92500013636']\nsage:  os.unlink('dir/.nfs000000000143f92500013636')\n---------------------------------------------------------------------------\nOSError                                   Traceback (most recent call last)\n\n/home/mpatel/<ipython console> in <module>()\n\nOSError: [Errno 16] Device or resource busy: 'dir/.nfs000000000143f92500013636'\nsage: os.rmdir('dir')\n---------------------------------------------------------------------------\nOSError                                   Traceback (most recent call last)\n\n/home/mpatel/<ipython console> in <module>()\n\nOSError: [Errno 39] Directory not empty: 'dir'\nsage: f.close()\nsage: os.rmdir('dir')\nsage: \n```\n\nFor the problem in the description, I suppose Sage tries to empty a temporary directory.  What if we wrap that in a `try-except` block?",
    "created_at": "2010-10-10T08:29:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10098#issuecomment-94753",
    "user": "https://github.com/qed777"
}
```

<div id="comment:6" align="right">Comment 6</div>

Replying to [@vbraun](#comment%3A4):
> Did that appear at the same time as the "sync" was removed from NFS? Or did we upgrade the `expect` python module?

As far as I'm aware, the Skynet cluster is administered independently (by Mariah Lenox) from the Sage cluster.  I don't know whether Mariah has made any recent changes to Skynet's NFS configuration.

We made some changes to `sage.interfaces.expect` at #10004.

> I think something is tripping over the following fact: In UNIX, you can open a file, then delete it, then delete the containing directory. The file is still open for business until you close it. But NFS doesn't have inodes, so if you delete an open file the NFS volume will contain a fake directory entry `.nfs00000000007d541a0000abf1` that only disappears when you close the file. I guess that the  "Device or resource busy" error is from trying to delete the non-empty directory. Either because the open file descriptor was leaked or because of some concurrency issue with NFS.

Thanks!  I've tried to make an example:

```python
sage: import os
sage: os.mkdir('dir')
sage: f = open('dir/foo', 'w')
sage: os.listdir('dir')
['foo']
sage: # Now 'rm dir/foo' in a separate window.
sage: sage: os.listdir('dir')
['.nfs000000000143f92500013636']
sage:  os.unlink('dir/.nfs000000000143f92500013636')
---------------------------------------------------------------------------
OSError                                   Traceback (most recent call last)

/home/mpatel/<ipython console> in <module>()

OSError: [Errno 16] Device or resource busy: 'dir/.nfs000000000143f92500013636'
sage: os.rmdir('dir')
---------------------------------------------------------------------------
OSError                                   Traceback (most recent call last)

/home/mpatel/<ipython console> in <module>()

OSError: [Errno 39] Directory not empty: 'dir'
sage: f.close()
sage: os.rmdir('dir')
sage: 
```

For the problem in the description, I suppose Sage tries to empty a temporary directory.  What if we wrap that in a `try-except` block?



---

archive/issue_comments_094754.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,7 +1,6 @@\n With #10004 merged into 4.6.alpha3, I get the doctest failures\n \n-```\n-#!\n+```python\n sage -t -long  -force_lib devel/sage/sage/interfaces/expect.py\n **********************************************************************\n File \"/home/buildbot/build/sage/cleo-1/cleo_full/build/sage-4.6.alpha3/devel/sage-main/sage/interfaces/expect.py\", line 596:\n``````\n",
    "created_at": "2010-10-10T08:29:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10098#issuecomment-94754",
    "user": "https://github.com/qed777"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,7 +1,6 @@
 With #10004 merged into 4.6.alpha3, I get the doctest failures
 
-```
-#!
+```python
 sage -t -long  -force_lib devel/sage/sage/interfaces/expect.py
 **********************************************************************
 File "/home/buildbot/build/sage/cleo-1/cleo_full/build/sage-4.6.alpha3/devel/sage-main/sage/interfaces/expect.py", line 596:
``````




---

archive/issue_comments_094755.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">Comment 7</div>\n\nReplying to [@qed777](#comment%3A6):\n\n> As far as I'm aware, the Skynet cluster is administered independently (by Mariah Lenox) from the Sage cluster.  I don't know whether Mariah has made any recent changes to Skynet's NFS configuration.\n\nThinking about it, Skynet was made unavailable a few days ago for scheduled maintenance, so some changes have been made there.",
    "created_at": "2010-10-10T08:50:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10098#issuecomment-94755",
    "user": "https://github.com/sagetrac-drkirkby"
}
```

<div id="comment:7" align="right">Comment 7</div>

Replying to [@qed777](#comment%3A6):

> As far as I'm aware, the Skynet cluster is administered independently (by Mariah Lenox) from the Sage cluster.  I don't know whether Mariah has made any recent changes to Skynet's NFS configuration.

Thinking about it, Skynet was made unavailable a few days ago for scheduled maintenance, so some changes have been made there.



---

archive/issue_comments_094756.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">Comment 8</div>\n\nI think this shows the value of a suggestion I've made before on other ticket(s).\n\nIf we knew the exact date/time of the tests (pass or fail), we could look at the logs on the machine and see if there was a problem. Problems with NFS are often logged - I've seen them logged on t2.math, when William had disabled the ZIL. We can even tie them up with user name - here's a few errors logged for both Simon and John. \n\n```\nSep 12 09:05:40 t2 nfs: [ID 814820 kern.info] NOTICE: [NFS4][Server: disk][Mntpt: /home]Lost OP_CLOSE request for fs /home, file ./palmieri/.sage-t2/temp/t2/23760/qsieve_0/lprels.1005.23843 (rn\node_pt: 0x30009d028d8), dir <null string> (0x0) for server disk\nSep 12 09:05:40 t2 nfs: [ID 581112 kern.info] NOTICE: [NFS4][Server: disk][Mntpt: /home]NFS Starting recovery for mount /home (mi 0x60040c42000 mi_recovflags [0x40]) on server disk, rnode_pt1 .\n/palmieri/.sage-t2/temp/t2/23760/qsieve_0/lprels.1005.23843 (0x30009d028d8), rnode_pt2 <null string> (0x0)\nSep 12 09:05:40 t2 nfs: [ID 273629 kern.info] NOTICE: [NFS4][Server: disk][Mntpt: /home]NFS Recovery done for mount /home (mi 0x60040c42000) on server disk, rnode_pt1 ./palmieri/.sage-t2/temp/t\n2/23760/qsieve_0/lprels.1005.23843 (0x30009d028d8), rnode_pt2 <null string> (0x0)\nSep 12 09:05:40 t2 nfs: [ID 220977 kern.info] NOTICE: [NFS4][Server: disk][Mntpt: /home]NFS op OP_CLOSE got error 4 causing recovery action NR_LOST_STATE_RQST.\nSep 12 09:05:40 t2 nfs: [ID 814820 kern.info] NOTICE: [NFS4][Server: disk][Mntpt: /home]Lost OP_CLOSE request for fs /home, file ./palmieri/.sage-t2/ipython/history-sage (rnode_pt: 0x300375c68f\n0), dir <null string> (0x0) for server disk\nSep 12 09:05:40 t2 nfs: [ID 581112 kern.info] NOTICE: [NFS4][Server: disk][Mntpt: /home]NFS Starting recovery for mount /home (mi 0x60040c42000 mi_recovflags [0x40]) on server disk, rnode_pt1 .\n/palmieri/.sage-t2/ipython/history-sage (0x300375c68f0), rnode_pt2 <null string> (0x0)\nSep 12 09:05:40 t2 nfs: [ID 273629 kern.info] NOTICE: [NFS4][Server: disk][Mntpt: /home]NFS Recovery done for mount /home (mi 0x60040c42000) on server disk, rnode_pt1 ./palmieri/.sage-t2/ipytho\nn/history-sage (0x300375c68f0), rnode_pt2 <null string> (0x0)\nSep 12 09:05:40 t2 nfs: [ID 236337 kern.info] NOTICE: [NFS4][Server: disk][Mntpt: /home]NFS op OP_CLOSE got error NFS4ERR_STALE causing recovery action NR_STALE.\nSep 12 09:05:40 t2 nfs: [ID 286389 kern.info] NOTICE: [NFS4][Server: disk][Mntpt: /home]File ./SimonKing/.sage/temp/t2/13276/dir_2/.nfsD44308 (rnode_pt: 3000da37bd8) was closed due to NFS recov\nery error on server disk(failed to recover from NFS4ERR_STALE NFS4ERR_STALE)\n```\n\nIf the doc tests had the exact times, it would go some way to helping determine if the system detected a problem.",
    "created_at": "2010-10-10T09:23:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10098#issuecomment-94756",
    "user": "https://github.com/sagetrac-drkirkby"
}
```

<div id="comment:8" align="right">Comment 8</div>

I think this shows the value of a suggestion I've made before on other ticket(s).

If we knew the exact date/time of the tests (pass or fail), we could look at the logs on the machine and see if there was a problem. Problems with NFS are often logged - I've seen them logged on t2.math, when William had disabled the ZIL. We can even tie them up with user name - here's a few errors logged for both Simon and John. 

```
Sep 12 09:05:40 t2 nfs: [ID 814820 kern.info] NOTICE: [NFS4][Server: disk][Mntpt: /home]Lost OP_CLOSE request for fs /home, file ./palmieri/.sage-t2/temp/t2/23760/qsieve_0/lprels.1005.23843 (rn
ode_pt: 0x30009d028d8), dir <null string> (0x0) for server disk
Sep 12 09:05:40 t2 nfs: [ID 581112 kern.info] NOTICE: [NFS4][Server: disk][Mntpt: /home]NFS Starting recovery for mount /home (mi 0x60040c42000 mi_recovflags [0x40]) on server disk, rnode_pt1 .
/palmieri/.sage-t2/temp/t2/23760/qsieve_0/lprels.1005.23843 (0x30009d028d8), rnode_pt2 <null string> (0x0)
Sep 12 09:05:40 t2 nfs: [ID 273629 kern.info] NOTICE: [NFS4][Server: disk][Mntpt: /home]NFS Recovery done for mount /home (mi 0x60040c42000) on server disk, rnode_pt1 ./palmieri/.sage-t2/temp/t
2/23760/qsieve_0/lprels.1005.23843 (0x30009d028d8), rnode_pt2 <null string> (0x0)
Sep 12 09:05:40 t2 nfs: [ID 220977 kern.info] NOTICE: [NFS4][Server: disk][Mntpt: /home]NFS op OP_CLOSE got error 4 causing recovery action NR_LOST_STATE_RQST.
Sep 12 09:05:40 t2 nfs: [ID 814820 kern.info] NOTICE: [NFS4][Server: disk][Mntpt: /home]Lost OP_CLOSE request for fs /home, file ./palmieri/.sage-t2/ipython/history-sage (rnode_pt: 0x300375c68f
0), dir <null string> (0x0) for server disk
Sep 12 09:05:40 t2 nfs: [ID 581112 kern.info] NOTICE: [NFS4][Server: disk][Mntpt: /home]NFS Starting recovery for mount /home (mi 0x60040c42000 mi_recovflags [0x40]) on server disk, rnode_pt1 .
/palmieri/.sage-t2/ipython/history-sage (0x300375c68f0), rnode_pt2 <null string> (0x0)
Sep 12 09:05:40 t2 nfs: [ID 273629 kern.info] NOTICE: [NFS4][Server: disk][Mntpt: /home]NFS Recovery done for mount /home (mi 0x60040c42000) on server disk, rnode_pt1 ./palmieri/.sage-t2/ipytho
n/history-sage (0x300375c68f0), rnode_pt2 <null string> (0x0)
Sep 12 09:05:40 t2 nfs: [ID 236337 kern.info] NOTICE: [NFS4][Server: disk][Mntpt: /home]NFS op OP_CLOSE got error NFS4ERR_STALE causing recovery action NR_STALE.
Sep 12 09:05:40 t2 nfs: [ID 286389 kern.info] NOTICE: [NFS4][Server: disk][Mntpt: /home]File ./SimonKing/.sage/temp/t2/13276/dir_2/.nfsD44308 (rnode_pt: 3000da37bd8) was closed due to NFS recov
ery error on server disk(failed to recover from NFS4ERR_STALE NFS4ERR_STALE)
```

If the doc tests had the exact times, it would go some way to helping determine if the system detected a problem.



---

archive/issue_comments_094757.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">Comment 9</div>\n\nReplying to [@qed777](#comment%3A6):\n> For the problem in the description, I suppose Sage tries to empty a temporary directory.  What if we wrap that in a `try-except` block?\n\nIt's already wrapped in a such block.  From near the end of `sage.parallel.use_fork.p_iter_fork.__call__`:\n\n```python\n       finally:\n\n            # Clean up all temporary files.                                     \n            try:\n                for X in os.listdir(dir):\n                    os.unlink(os.path.join(dir, X))\n                os.rmdir(dir)\n            except OSError, msg:\n                if self.verbose:\n                    print msg\n```\n\nChanging the doctest to\n\n```python\n@parallel(verbose=False)\ndef f(n):\n    return gap._local_tmpfile()\n\nL = [t[1] for t in f(range(5))]\nlen(set(L))\n```\nshould \"fix\" the problem.  This example is not intended to test `use_fork`, which has it's own tests, so we could justify doing this here.",
    "created_at": "2010-10-10T09:28:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10098#issuecomment-94757",
    "user": "https://github.com/qed777"
}
```

<div id="comment:9" align="right">Comment 9</div>

Replying to [@qed777](#comment%3A6):
> For the problem in the description, I suppose Sage tries to empty a temporary directory.  What if we wrap that in a `try-except` block?

It's already wrapped in a such block.  From near the end of `sage.parallel.use_fork.p_iter_fork.__call__`:

```python
       finally:

            # Clean up all temporary files.                                     
            try:
                for X in os.listdir(dir):
                    os.unlink(os.path.join(dir, X))
                os.rmdir(dir)
            except OSError, msg:
                if self.verbose:
                    print msg
```

Changing the doctest to

```python
@parallel(verbose=False)
def f(n):
    return gap._local_tmpfile()

L = [t[1] for t in f(range(5))]
len(set(L))
```
should "fix" the problem.  This example is not intended to test `use_fork`, which has it's own tests, so we could justify doing this here.



---

archive/issue_comments_094758.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">Comment 10</div>\n\nOr, perhaps, we could optionally re-`raise` in `__call__` (see the previous comment) and wrap `L = [t[1] for t in f(range(5))]` in a `try-except` block.  We'd just `pass` if the exception is of the form in the description.  This might also help with the very similar problem at #9501, #9616, and #9631.",
    "created_at": "2010-10-10T09:40:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10098#issuecomment-94758",
    "user": "https://github.com/qed777"
}
```

<div id="comment:10" align="right">Comment 10</div>

Or, perhaps, we could optionally re-`raise` in `__call__` (see the previous comment) and wrap `L = [t[1] for t in f(range(5))]` in a `try-except` block.  We'd just `pass` if the exception is of the form in the description.  This might also help with the very similar problem at #9501, #9616, and #9631.



---

archive/issue_comments_094759.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">Comment 11</div>\n\nThe only use of `verbose` is to print something in case of a timeout and if the temp files could not be cleaned up. The former is pretty much intentional (you have to set a timeout), the latter is a fact of life on some OS/filesystem combinations. I think we should just change the default to `verbose=False`.",
    "created_at": "2010-10-10T10:48:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10098#issuecomment-94759",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:11" align="right">Comment 11</div>

The only use of `verbose` is to print something in case of a timeout and if the temp files could not be cleaned up. The former is pretty much intentional (you have to set a timeout), the latter is a fact of life on some OS/filesystem combinations. I think we should just change the default to `verbose=False`.



---

archive/issue_comments_094760.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">Comment 12</div>\n\nReplying to [@vbraun](#comment%3A11):\n> The only use of `verbose` is to print something in case of a timeout and if the temp files could not be cleaned up. The former is pretty much intentional (you have to set a timeout), the latter is a fact of life on some OS/filesystem combinations. I think we should just change the default to `verbose=False`.\n\nUsers of forking `@parallel` could activate the potentially useful timeout messages with `verbose=True`.  If they didn't do this, they'd still learn about timeouts from the results, although not until all subprocesses had ended or been killed.  Is this OK?  I don't use `@`parallel very often.",
    "created_at": "2010-10-12T00:58:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10098#issuecomment-94760",
    "user": "https://github.com/qed777"
}
```

<div id="comment:12" align="right">Comment 12</div>

Replying to [@vbraun](#comment%3A11):
> The only use of `verbose` is to print something in case of a timeout and if the temp files could not be cleaned up. The former is pretty much intentional (you have to set a timeout), the latter is a fact of life on some OS/filesystem combinations. I think we should just change the default to `verbose=False`.

Users of forking `@parallel` could activate the potentially useful timeout messages with `verbose=True`.  If they didn't do this, they'd still learn about timeouts from the results, although not until all subprocesses had ended or been killed.  Is this OK?  I don't use `@`parallel very often.



---

archive/issue_comments_094761.json:
```json
{
    "body": "Use `verbose=False` by default for forking `@parallel`.",
    "created_at": "2010-10-12T01:05:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10098#issuecomment-94761",
    "user": "https://github.com/qed777"
}
```

Use `verbose=False` by default for forking `@parallel`.



---

archive/issue_comments_094762.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">Comment 13</div>\n\nAttachment: **[trac_10098-use_fork_verbose.patch.gz](https://github.com/sagemath/sage/files/ticket10098/trac_10098-use_fork_verbose.patch.gz)**\n\nI've added a patch using Volker's suggestion.",
    "created_at": "2010-10-12T01:08:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10098#issuecomment-94762",
    "user": "https://github.com/qed777"
}
```

<div id="comment:13" align="right">Comment 13</div>

Attachment: **[trac_10098-use_fork_verbose.patch.gz](https://github.com/sagemath/sage/files/ticket10098/trac_10098-use_fork_verbose.patch.gz)**

I've added a patch using Volker's suggestion.



---

archive/issue_comments_094763.json:
```json
{
    "body": "Author: **Volker Braun**",
    "created_at": "2010-10-12T01:08:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10098#issuecomment-94763",
    "user": "https://github.com/qed777"
}
```

Author: **Volker Braun**



---

archive/issue_events_120411.json:
```json
{
    "actor": "https://github.com/qed777",
    "created_at": "2010-10-12T01:08:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10098",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10098#event-120411"
}
```



---

archive/issue_comments_094764.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -17,3 +17,4 @@\n ```\n on the Skynet machines cleo, eno, fulvia, sextus, and taurus.\n \n+The `@fork` decorator tickets #9501, #9616, and #9631 are related.\n``````\n",
    "created_at": "2010-10-12T10:44:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10098#issuecomment-94764",
    "user": "https://github.com/qed777"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -17,3 +17,4 @@
 ```
 on the Skynet machines cleo, eno, fulvia, sextus, and taurus.
 
+The `@fork` decorator tickets #9501, #9616, and #9631 are related.
``````




---

archive/issue_comments_094765.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">Comment 17</div>\n\nHi, did you CC me because you need a reviewer? Or is there a particular question I should answer?",
    "created_at": "2010-10-12T12:14:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10098#issuecomment-94765",
    "user": "https://github.com/malb"
}
```

<div id="comment:17" align="right">Comment 17</div>

Hi, did you CC me because you need a reviewer? Or is there a particular question I should answer?



---

archive/issue_comments_094766.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">Comment 18</div>\n\nReplying to [@malb](#comment%3A17):\n> Hi, did you CC me because you need a reviewer? Or is there a particular question I should answer?\n\nOops. I should have added a comment like this:\n\nMartin, Simon, Tom, and William, do you have any objections to changing the `verbose` parameter of the forking `@parallel` decorator to default to `False`?  The patch above does this, but I'm not sure if it's OK to some of the potential heavy users of the decorator (see [this comment](#comment%3A12)).  With the patch, we'll suppress the NFS-related doctest messages in the description.\n\nAlternatively, we could use `@parallel(verbose=False)` in individual doctests.",
    "created_at": "2010-10-12T22:10:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10098#issuecomment-94766",
    "user": "https://github.com/qed777"
}
```

<div id="comment:18" align="right">Comment 18</div>

Replying to [@malb](#comment%3A17):
> Hi, did you CC me because you need a reviewer? Or is there a particular question I should answer?

Oops. I should have added a comment like this:

Martin, Simon, Tom, and William, do you have any objections to changing the `verbose` parameter of the forking `@parallel` decorator to default to `False`?  The patch above does this, but I'm not sure if it's OK to some of the potential heavy users of the decorator (see [this comment](#comment%3A12)).  With the patch, we'll suppress the NFS-related doctest messages in the description.

Alternatively, we could use `@parallel(verbose=False)` in individual doctests.



---

archive/issue_comments_094767.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">Comment 19</div>\n\nWe can use a similar workaround at #9501/#9616/#9631, if we add a `verbose` parameter to `fork` and propagate its value to `Parallel`.",
    "created_at": "2010-10-13T01:07:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10098#issuecomment-94767",
    "user": "https://github.com/qed777"
}
```

<div id="comment:19" align="right">Comment 19</div>

We can use a similar workaround at #9501/#9616/#9631, if we add a `verbose` parameter to `fork` and propagate its value to `Parallel`.



---

archive/issue_comments_094768.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">Comment 20</div>\n\nReplying to [@qed777](#comment%3A18):\n> Martin, Simon, Tom, and William, do you have any objections to changing the `verbose` parameter of the forking `@parallel` decorator to default to `False`?  The patch above does this, but I'm not sure if it's OK to some of the potential heavy users of the decorator (see [this comment](#comment%3A12)).  With the patch, we'll suppress the NFS-related doctest messages in the description.\n> \n> Alternatively, we could use `@parallel(verbose=False)` in individual doctests.\n\nI think something like \"verbose\" should not be default. A warning about a device being busy is not necessary from my point of view if the program is designed to deal with that problem (so that the \"problem\" is in fact no problem).",
    "created_at": "2010-10-13T07:39:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10098#issuecomment-94768",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:20" align="right">Comment 20</div>

Replying to [@qed777](#comment%3A18):
> Martin, Simon, Tom, and William, do you have any objections to changing the `verbose` parameter of the forking `@parallel` decorator to default to `False`?  The patch above does this, but I'm not sure if it's OK to some of the potential heavy users of the decorator (see [this comment](#comment%3A12)).  With the patch, we'll suppress the NFS-related doctest messages in the description.
> 
> Alternatively, we could use `@parallel(verbose=False)` in individual doctests.

I think something like "verbose" should not be default. A warning about a device being busy is not necessary from my point of view if the program is designed to deal with that problem (so that the "problem" is in fact no problem).



---

archive/issue_comments_094769.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">Comment 21</div>\n\nReplying to [@qed777](#comment%3A18):\n> Martin, Simon, Tom, and William, do you have any objections to changing the `verbose` parameter of the forking `@parallel` decorator to default to `False`?  \n\nThat is fine with me (I'm actually not a heavy user of the decorator :))",
    "created_at": "2010-10-13T12:03:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10098#issuecomment-94769",
    "user": "https://github.com/malb"
}
```

<div id="comment:21" align="right">Comment 21</div>

Replying to [@qed777](#comment%3A18):
> Martin, Simon, Tom, and William, do you have any objections to changing the `verbose` parameter of the forking `@parallel` decorator to default to `False`?  

That is fine with me (I'm actually not a heavy user of the decorator :))



---

archive/issue_comments_094770.json:
```json
{
    "body": "Reviewer: **Mitesh Patel**",
    "created_at": "2010-10-17T01:27:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10098#issuecomment-94770",
    "user": "https://github.com/qed777"
}
```

Reviewer: **Mitesh Patel**



---

archive/issue_events_120412.json:
```json
{
    "actor": "https://github.com/qed777",
    "created_at": "2010-10-17T01:27:37Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10098",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10098#event-120412"
}
```



---

archive/issue_events_120413.json:
```json
{
    "actor": "https://github.com/qed777",
    "created_at": "2010-10-17T01:27:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10098",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10098#event-120413"
}
```



---

archive/issue_comments_094771.json:
```json
{
    "body": "Merged: **sage-4.6.rc0**",
    "created_at": "2010-10-21T08:41:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10098#issuecomment-94771",
    "user": "https://github.com/qed777"
}
```

Merged: **sage-4.6.rc0**



---

archive/issue_events_120414.json:
```json
{
    "actor": "https://github.com/qed777",
    "created_at": "2010-10-21T08:41:00Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10098",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10098#event-120414"
}
```



---

archive/issue_events_120415.json:
```json
{
    "actor": "https://github.com/qed777",
    "created_at": "2010-10-21T08:41:00Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/10098",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10098#event-120415"
}
```
