# Issue 10763: Speedup of  matrix multiplication

archive/issues_010699.json:
```json
{
    "body": "When multiplying two matrices M and N, typically one first creates a zero matrix of an appropriate matrix space. That means:\n\n* Call `M.matrix_space(...)`.\n* This calls `M.parent().matrix_space(...)`.\n* This calls `MatrixSpace(...)`.\n* This tests, whether the base ring really is a ring and whether the matrix space is already in the cache.\n\nThis can obviously be improved:\n\n* `M.matrix_space(...)` should avoid the overhead of calling `M.parent()` but create the matrix space directly.\n* It is already known that the base ring is a ring. So, there is no need to test it.\n* One may access the cache directly, thus, avoid the overhead of calling `MatrixSpace`.\n\nI guess the ticket belongs to linear algebra. Correct me if I'm wrong.\n\n\n**Assignee:** @jasongrout, @williamstein\n\n**Keywords:** matrix multiplication\n\n**Author:** Simon King\n\n**Reviewer:** Rob Beezer\n\n**Merged:** sage-4.7.alpha2\n\nIssue created by migration from https://trac.sagemath.org/ticket/10763\n\n",
    "closed_at": "2011-03-17T19:23:17Z",
    "created_at": "2011-02-09T17:53:58Z",
    "labels": [
        "component: linear algebra",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.7",
    "title": "Speedup of  matrix multiplication",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10763",
    "user": "https://github.com/simon-king-jena"
}
```
When multiplying two matrices M and N, typically one first creates a zero matrix of an appropriate matrix space. That means:

* Call `M.matrix_space(...)`.
* This calls `M.parent().matrix_space(...)`.
* This calls `MatrixSpace(...)`.
* This tests, whether the base ring really is a ring and whether the matrix space is already in the cache.

This can obviously be improved:

* `M.matrix_space(...)` should avoid the overhead of calling `M.parent()` but create the matrix space directly.
* It is already known that the base ring is a ring. So, there is no need to test it.
* One may access the cache directly, thus, avoid the overhead of calling `MatrixSpace`.

I guess the ticket belongs to linear algebra. Correct me if I'm wrong.


**Assignee:** @jasongrout, @williamstein

**Keywords:** matrix multiplication

**Author:** Simon King

**Reviewer:** Rob Beezer

**Merged:** sage-4.7.alpha2

Issue created by migration from https://trac.sagemath.org/ticket/10763





---

archive/issue_events_083206.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2011-02-09T18:23:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10763#event-83206"
}
```



---

archive/issue_comments_105513.json:
```json
{
    "body": "<a id='comment:1'></a>\nI did not run the doc test yet, but I think it already ready for review.\n\nHere are timings. Note that the reduced overhead is most visible when the multiplication itself is trivial.\n\nWithout the patch:\n\n```\nsage: def test(M):\n....:     for i in xrange(10^6):\n....:         M*=M\n....:     return M\n....:\nsage: m = matrix(GF(3),[[1]])\nsage: %time test(m)\nCPU times: user 51.36 s, sys: 0.16 s, total: 51.52 s\nWall time: 51.67 s\n[1]\nsage: m = matrix(GF(2),[[1]])\nsage: %time test(m)\nCPU times: user 39.16 s, sys: 0.20 s, total: 39.36 s\nWall time: 39.47 s\n[1]\nsage: m = matrix(ZZ,[[1]])\n# apparently there is no overhead for matrices over ZZ\nsage: %time test(m)\nCPU times: user 7.81 s, sys: 0.15 s, total: 7.96 s\nWall time: 7.99 s\n[1]\n```\n\nWith the patch\n\n```\nsage: def test(M):\n....:     for i in xrange(10^6):\n....:         M*=M\n....:     return M\n....:\nsage: m = matrix(GF(3),[[1]])\nsage: %time test(m)\nCPU times: user 33.65 s, sys: 0.30 s, total: 33.95 s\nWall time: 34.05 s\n[1]\nsage: m = matrix(GF(2),[[1]])\nsage: %time test(m)\nCPU times: user 25.41 s, sys: 0.10 s, total: 25.51 s\nWall time: 25.58 s\n[1]\nsage: m = matrix(ZZ,[[1]])\nsage: %time test(m)\nCPU times: user 7.62 s, sys: 0.16 s, total: 7.78 s\nWall time: 7.80 s\n[1]\n```\n\nThus, over `GF(3)` and `GF(2)` the overhead is clearly reduced.\n\nI don't know how the patch could be doc-tested, as it only concerns the performance.",
    "created_at": "2011-02-09T18:23:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10763#issuecomment-105513",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:1'></a>
I did not run the doc test yet, but I think it already ready for review.

Here are timings. Note that the reduced overhead is most visible when the multiplication itself is trivial.

Without the patch:

```
sage: def test(M):
....:     for i in xrange(10^6):
....:         M*=M
....:     return M
....:
sage: m = matrix(GF(3),[[1]])
sage: %time test(m)
CPU times: user 51.36 s, sys: 0.16 s, total: 51.52 s
Wall time: 51.67 s
[1]
sage: m = matrix(GF(2),[[1]])
sage: %time test(m)
CPU times: user 39.16 s, sys: 0.20 s, total: 39.36 s
Wall time: 39.47 s
[1]
sage: m = matrix(ZZ,[[1]])
# apparently there is no overhead for matrices over ZZ
sage: %time test(m)
CPU times: user 7.81 s, sys: 0.15 s, total: 7.96 s
Wall time: 7.99 s
[1]
```

With the patch

```
sage: def test(M):
....:     for i in xrange(10^6):
....:         M*=M
....:     return M
....:
sage: m = matrix(GF(3),[[1]])
sage: %time test(m)
CPU times: user 33.65 s, sys: 0.30 s, total: 33.95 s
Wall time: 34.05 s
[1]
sage: m = matrix(GF(2),[[1]])
sage: %time test(m)
CPU times: user 25.41 s, sys: 0.10 s, total: 25.51 s
Wall time: 25.58 s
[1]
sage: m = matrix(ZZ,[[1]])
sage: %time test(m)
CPU times: user 7.62 s, sys: 0.16 s, total: 7.78 s
Wall time: 7.80 s
[1]
```

Thus, over `GF(3)` and `GF(2)` the overhead is clearly reduced.

I don't know how the patch could be doc-tested, as it only concerns the performance.



---

archive/issue_comments_105514.json:
```json
{
    "body": "**Author:** Simon King",
    "created_at": "2011-02-09T18:23:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10763#issuecomment-105514",
    "user": "https://github.com/simon-king-jena"
}
```

**Author:** Simon King



---

archive/issue_comments_105515.json:
```json
{
    "body": "<a id='comment:2'></a>\nApparently the small change led to some problems. So, it needs work.",
    "created_at": "2011-02-10T08:59:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10763#issuecomment-105515",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:2'></a>
Apparently the small change led to some problems. So, it needs work.



---

archive/issue_events_083207.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2011-02-10T08:59:49Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10763#event-83207"
}
```



---

archive/issue_events_083208.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2011-02-10T08:59:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10763#event-83208"
}
```



---

archive/issue_comments_105516.json:
```json
{
    "body": "<a id='comment:3'></a>\nThe problem was that the matrix spaces are cached with weak references. It could happen that the key was still available, but `_cache[key]` was a reference to `None`. So, in the updated patch I am not simply trying to return `_cache[key]()` but I first test if it is not None.\n\nBack to \"needs review\"...",
    "created_at": "2011-02-10T09:18:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10763#issuecomment-105516",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:3'></a>
The problem was that the matrix spaces are cached with weak references. It could happen that the key was still available, but `_cache[key]` was a reference to `None`. So, in the updated patch I am not simply trying to return `_cache[key]()` but I first test if it is not None.

Back to "needs review"...



---

archive/issue_events_083209.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2011-02-10T09:18:30Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10763#event-83209"
}
```



---

archive/issue_events_083210.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2011-02-10T09:18:30Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10763#event-83210"
}
```



---

archive/issue_comments_105517.json:
```json
{
    "body": "<a id='comment:4'></a>\nPS:\n\nThe timings with the new patch are\n\n```\nsage: def test(M):\n....:     for i in xrange(10^6):\n....:         M*=M\n....:     return M\n....: \nsage: m = matrix(GF(3),[[1]])\nsage: %time test(m)\nCPU times: user 37.70 s, sys: 0.18 s, total: 37.89 s\nWall time: 38.00 s\n[1]\nsage: m = matrix(GF(2),[[1]])\nsage: %time test(m)\nCPU times: user 27.09 s, sys: 0.17 s, total: 27.26 s\nWall time: 27.34 s\n[1]\n```\n\nThat's still a lot faster than without patch.",
    "created_at": "2011-02-10T09:21:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10763#issuecomment-105517",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:4'></a>
PS:

The timings with the new patch are

```
sage: def test(M):
....:     for i in xrange(10^6):
....:         M*=M
....:     return M
....: 
sage: m = matrix(GF(3),[[1]])
sage: %time test(m)
CPU times: user 37.70 s, sys: 0.18 s, total: 37.89 s
Wall time: 38.00 s
[1]
sage: m = matrix(GF(2),[[1]])
sage: %time test(m)
CPU times: user 27.09 s, sys: 0.17 s, total: 27.26 s
Wall time: 27.34 s
[1]
```

That's still a lot faster than without patch.



---

archive/issue_comments_105518.json:
```json
{
    "body": "<a id='comment:5'></a>\nI updated the patch, so that it cleanly applies to `sage-4.6.2.alpha4`.",
    "created_at": "2011-02-11T07:33:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10763#issuecomment-105518",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:5'></a>
I updated the patch, so that it cleanly applies to `sage-4.6.2.alpha4`.



---

archive/issue_comments_105519.json:
```json
{
    "body": "<a id='comment:6'></a>\nI ran tests in sage/matrix and got failures in matrix_mod2_dense.pyx and matrix2.pyx.  Mostly complaints about improper dimensions it seems.  The mod2 code appears to have some internal checks that are triggered even before the test itself fails.",
    "created_at": "2011-02-15T05:03:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10763#issuecomment-105519",
    "user": "https://github.com/rbeezer"
}
```

<a id='comment:6'></a>
I ran tests in sage/matrix and got failures in matrix_mod2_dense.pyx and matrix2.pyx.  Mostly complaints about improper dimensions it seems.  The mod2 code appears to have some internal checks that are triggered even before the test itself fails.



---

archive/issue_comments_105520.json:
```json
{
    "body": "<a id='comment:7'></a>\nReplying to [rbeezer](#comment%3A6):\n> I ran tests in sage/matrix and got failures in matrix_mod2_dense.pyx and matrix2.pyx.  Mostly complaints about improper dimensions it seems.  The mod2 code appears to have some internal checks that are triggered even before the test itself fails.\n\n\nThank you! As I wrote when I posted my patch, I hadn't run the tests, and then I was working on different tickets. Now I'll try to hunt it down.",
    "created_at": "2011-02-15T07:25:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10763#issuecomment-105520",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:7'></a>
Replying to [rbeezer](#comment%3A6):
> I ran tests in sage/matrix and got failures in matrix_mod2_dense.pyx and matrix2.pyx.  Mostly complaints about improper dimensions it seems.  The mod2 code appears to have some internal checks that are triggered even before the test itself fails.


Thank you! As I wrote when I posted my patch, I hadn't run the tests, and then I was working on different tickets. Now I'll try to hunt it down.



---

archive/issue_events_083211.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2011-02-15T07:25:56Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10763#event-83211"
}
```



---

archive/issue_events_083212.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2011-02-15T07:25:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10763#event-83212"
}
```



---

archive/issue_events_083213.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2011-02-15T07:52:35Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10763#event-83213"
}
```



---

archive/issue_events_083214.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2011-02-15T07:52:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10763#event-83214"
}
```



---

archive/issue_comments_105521.json:
```json
{
    "body": "<a id='comment:8'></a>\nThe test failures were caused by a very stupid mistake: `self.new_matrix()` by default assumes that the dimension of the new matrix is the same as the dimension of the old matrix. In the multiplication algorithms, I saw `self.new_matrix(nrows=self.nrows(),...)`, was not reading further, and thought that we are in the default case, thus, deleted the arguments.\n\nOf course, it continues \"(..., ncols=right.ncols())`.\n\nWhat I did now was to avoid calling `self.nrows()` and `right.ncols()` - direct access to the attributes `self._nrows` and `right._ncols` is faster.\n\nTo my surprise, the timings improved a little more:\n\n```\nsage: def test(M):\n....:     for i in xrange(10^6):\n....:         M*=M\n....:     return M\n....: \nsage: m = matrix(GF(3),[[1]])\nsage: %time test(m)\nCPU times: user 36.67 s, sys: 0.16 s, total: 36.83 s\nWall time: 36.95 s\n[1]\nsage: m = matrix(GF(2),[[1]])\nsage: %time test(m)\nCPU times: user 26.29 s, sys: 0.14 s, total: 26.43 s\nWall time: 26.50 s\n[1]\n```\n\nIs it faster to provide arguments with a default value *explicitly*?\n\nThe tests for `sage/matrix/` passed. I am now running all doctests (not the long ones), but I think I can already revert it to \"needs review\".",
    "created_at": "2011-02-15T07:52:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10763#issuecomment-105521",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:8'></a>
The test failures were caused by a very stupid mistake: `self.new_matrix()` by default assumes that the dimension of the new matrix is the same as the dimension of the old matrix. In the multiplication algorithms, I saw `self.new_matrix(nrows=self.nrows(),...)`, was not reading further, and thought that we are in the default case, thus, deleted the arguments.

Of course, it continues "(..., ncols=right.ncols())`.

What I did now was to avoid calling `self.nrows()` and `right.ncols()` - direct access to the attributes `self._nrows` and `right._ncols` is faster.

To my surprise, the timings improved a little more:

```
sage: def test(M):
....:     for i in xrange(10^6):
....:         M*=M
....:     return M
....: 
sage: m = matrix(GF(3),[[1]])
sage: %time test(m)
CPU times: user 36.67 s, sys: 0.16 s, total: 36.83 s
Wall time: 36.95 s
[1]
sage: m = matrix(GF(2),[[1]])
sage: %time test(m)
CPU times: user 26.29 s, sys: 0.14 s, total: 26.43 s
Wall time: 26.50 s
[1]
```

Is it faster to provide arguments with a default value *explicitly*?

The tests for `sage/matrix/` passed. I am now running all doctests (not the long ones), but I think I can already revert it to "needs review".



---

archive/issue_comments_105522.json:
```json
{
    "body": "<a id='comment:9'></a>\nI was updating the patch again. I am now also taking more care of sparse matrices, and I found yet another spot where overhead by calling methods could be reduced.\n\n**__Updated timings in sage.4.6.2.alpha4__**\n\n```\nsage: def test(M):\n....:     for i in xrange(10^6):\n....:         M*=M\n....:     return M\n....: \nsage: MS = MatrixSpace(GF(5),5,5,sparse=True)\nsage: ms = MS([3, 1, 0, 0, 4, 1, 2, 2, 3, 4, 2, 4, 1, 0, 3, 4, 3, 1, 2, 4, 0, 0, 0, 1, 3])\nsage: MD = MatrixSpace(GF(5),5,5,sparse=False)\nsage: md = MD([3, 1, 0, 0, 4, 1, 2, 2, 3, 4, 2, 4, 1, 0, 3, 4, 3, 1, 2, 4, 0, 0, 0, 1, 3])\n```\n\nWithout patch:\n\n```\nsage: %time test(ms)\nCPU times: user 42.41 s, sys: 0.01 s, total: 42.43 s\nWall time: 42.57 s\n[1 2 4 4 3]\n[3 1 2 1 3]\n[1 2 2 3 1]\n[2 4 0 4 4]\n[2 4 2 1 3]\nsage: %time test(md)\nCPU times: user 53.54 s, sys: 0.20 s, total: 53.74 s\nWall time: 53.90 s\n[1 2 4 4 3]\n[3 1 2 1 3]\n[1 2 2 3 1]\n[2 4 0 4 4]\n[2 4 2 1 3]\n```\n\nWith patch:\n\n```\nsage: %time test(ms)\nCPU times: user 29.72 s, sys: 0.03 s, total: 29.75 s\nWall time: 29.84 s\n[1 2 4 4 3]\n[3 1 2 1 3]\n[1 2 2 3 1]\n[2 4 0 4 4]\n[2 4 2 1 3]\nsage: %time test(md)\nCPU times: user 34.13 s, sys: 0.36 s, total: 34.49 s\nWall time: 34.59 s\n[1 2 4 4 3]\n[3 1 2 1 3]\n[1 2 2 3 1]\n[2 4 0 4 4]\n[2 4 2 1 3]\n```\n\nOr, with the (dense) examples that I used in the previous posts:\n\n```\nsage: m = matrix(GF(2),[[1]])\nsage: %time test(m)\nCPU times: user 22.87 s, sys: 0.12 s, total: 22.99 s\nWall time: 23.06 s\n[1]\nsage: m = matrix(GF(3),[[1]])\nsage: %time test(m)\nCPU times: user 33.31 s, sys: 0.12 s, total: 33.43 s\nWall time: 33.52 s\n[1]\n```\n\nSo, the progress is clear.\n\nI am now running doc tests (there was no problem for the previous patch), but I think it is safe to keep it \"needs review\".",
    "created_at": "2011-02-16T10:22:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10763#issuecomment-105522",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:9'></a>
I was updating the patch again. I am now also taking more care of sparse matrices, and I found yet another spot where overhead by calling methods could be reduced.

**__Updated timings in sage.4.6.2.alpha4__**

```
sage: def test(M):
....:     for i in xrange(10^6):
....:         M*=M
....:     return M
....: 
sage: MS = MatrixSpace(GF(5),5,5,sparse=True)
sage: ms = MS([3, 1, 0, 0, 4, 1, 2, 2, 3, 4, 2, 4, 1, 0, 3, 4, 3, 1, 2, 4, 0, 0, 0, 1, 3])
sage: MD = MatrixSpace(GF(5),5,5,sparse=False)
sage: md = MD([3, 1, 0, 0, 4, 1, 2, 2, 3, 4, 2, 4, 1, 0, 3, 4, 3, 1, 2, 4, 0, 0, 0, 1, 3])
```

Without patch:

```
sage: %time test(ms)
CPU times: user 42.41 s, sys: 0.01 s, total: 42.43 s
Wall time: 42.57 s
[1 2 4 4 3]
[3 1 2 1 3]
[1 2 2 3 1]
[2 4 0 4 4]
[2 4 2 1 3]
sage: %time test(md)
CPU times: user 53.54 s, sys: 0.20 s, total: 53.74 s
Wall time: 53.90 s
[1 2 4 4 3]
[3 1 2 1 3]
[1 2 2 3 1]
[2 4 0 4 4]
[2 4 2 1 3]
```

With patch:

```
sage: %time test(ms)
CPU times: user 29.72 s, sys: 0.03 s, total: 29.75 s
Wall time: 29.84 s
[1 2 4 4 3]
[3 1 2 1 3]
[1 2 2 3 1]
[2 4 0 4 4]
[2 4 2 1 3]
sage: %time test(md)
CPU times: user 34.13 s, sys: 0.36 s, total: 34.49 s
Wall time: 34.59 s
[1 2 4 4 3]
[3 1 2 1 3]
[1 2 2 3 1]
[2 4 0 4 4]
[2 4 2 1 3]
```

Or, with the (dense) examples that I used in the previous posts:

```
sage: m = matrix(GF(2),[[1]])
sage: %time test(m)
CPU times: user 22.87 s, sys: 0.12 s, total: 22.99 s
Wall time: 23.06 s
[1]
sage: m = matrix(GF(3),[[1]])
sage: %time test(m)
CPU times: user 33.31 s, sys: 0.12 s, total: 33.43 s
Wall time: 33.52 s
[1]
```

So, the progress is clear.

I am now running doc tests (there was no problem for the previous patch), but I think it is safe to keep it "needs review".



---

archive/issue_comments_105523.json:
```json
{
    "body": "<a id='comment:10'></a>\nPS: Long tests in devel/sage/sage and devel/sage/doc pass without error. The error that the patchbot reports is the usual error in startup.py and seems independent of my patch.",
    "created_at": "2011-02-16T12:56:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10763#issuecomment-105523",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:10'></a>
PS: Long tests in devel/sage/sage and devel/sage/doc pass without error. The error that the patchbot reports is the usual error in startup.py and seems independent of my patch.



---

archive/issue_events_083215.json:
```json
{
    "actor": "https://github.com/rbeezer",
    "created_at": "2011-02-21T20:56:45Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10763#event-83215"
}
```



---

archive/issue_events_083216.json:
```json
{
    "actor": "https://github.com/rbeezer",
    "created_at": "2011-02-21T20:56:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "label": "needs info",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10763#event-83216"
}
```



---

archive/issue_comments_105524.json:
```json
{
    "body": "<a id='comment:11'></a>\nSimon,\n\nLooks real good.  One suggestion - and it really is *just* a suggestion.  Your call.\n\nTwo instances of basically:\n\n```\ntry:\n    from sage.matrix.matrix_space import _cache\n    MS = _cache[base_ring, nrows, ncols, sparse]()\nexcept KeyError:\n    return MatrixSpace(base_ring, nrows, ncols, sparse)\nif MS is not None:\n    return MS\nreturn MatrixSpace(base_ring, nrows, ncols, sparse)\n```\n\nand a suggested replacement:\n\n```\ntry:\n    from sage.matrix.matrix_space import _cache\n    MS = _cache[base_ring, nrows, ncols, sparse]()\nexcept KeyError:\n    MS = None\nif MS is None:\n    return MatrixSpace(base_ring, nrows, ncols, sparse)\nelse:\n    return MS\n```\n\nSuggestion uses try/except to form \"best guess\" for `MS`.  Either we find it, or we get `None`.  Then if/else returns it, or creates it and returns it.\n\nAn extra line, an extra comparison in one case, but the `not` is gone and most importantly, just one place to describe the actual `MatrixSpace` call (instead of two that are identical).  Anyway, a toss-up, I'd guess, so just a suggestion.\n\nIn the meantime, I am going to run the full test suite right now.\n\nRob",
    "created_at": "2011-02-21T20:56:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10763#issuecomment-105524",
    "user": "https://github.com/rbeezer"
}
```

<a id='comment:11'></a>
Simon,

Looks real good.  One suggestion - and it really is *just* a suggestion.  Your call.

Two instances of basically:

```
try:
    from sage.matrix.matrix_space import _cache
    MS = _cache[base_ring, nrows, ncols, sparse]()
except KeyError:
    return MatrixSpace(base_ring, nrows, ncols, sparse)
if MS is not None:
    return MS
return MatrixSpace(base_ring, nrows, ncols, sparse)
```

and a suggested replacement:

```
try:
    from sage.matrix.matrix_space import _cache
    MS = _cache[base_ring, nrows, ncols, sparse]()
except KeyError:
    MS = None
if MS is None:
    return MatrixSpace(base_ring, nrows, ncols, sparse)
else:
    return MS
```

Suggestion uses try/except to form "best guess" for `MS`.  Either we find it, or we get `None`.  Then if/else returns it, or creates it and returns it.

An extra line, an extra comparison in one case, but the `not` is gone and most importantly, just one place to describe the actual `MatrixSpace` call (instead of two that are identical).  Anyway, a toss-up, I'd guess, so just a suggestion.

In the meantime, I am going to run the full test suite right now.

Rob



---

archive/issue_comments_105525.json:
```json
{
    "body": "<a id='comment:12'></a>\nPassed all long tests.  So, other than my suggestion above, this looks ready to go.",
    "created_at": "2011-02-22T01:37:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10763#issuecomment-105525",
    "user": "https://github.com/rbeezer"
}
```

<a id='comment:12'></a>
Passed all long tests.  So, other than my suggestion above, this looks ready to go.



---

archive/issue_comments_105526.json:
```json
{
    "body": "<a id='comment:13'></a>\nReplying to [rbeezer](#comment%3A12):\n> Passed all long tests.  So, other than my suggestion above, this looks ready to go.\n\n\nCan you turn your suggestion into a referee patch? I wouldn't object to the change.\n\nCheers,\n\nSimon",
    "created_at": "2011-02-26T13:21:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10763#issuecomment-105526",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:13'></a>
Replying to [rbeezer](#comment%3A12):
> Passed all long tests.  So, other than my suggestion above, this looks ready to go.


Can you turn your suggestion into a referee patch? I wouldn't object to the change.

Cheers,

Simon



---

archive/issue_events_083217.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2011-02-26T13:21:01Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "label": "needs info",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10763#event-83217"
}
```



---

archive/issue_events_083218.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2011-02-26T13:21:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10763#event-83218"
}
```



---

archive/attachments_014091.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_10763-speedup-matrix-multiplication-reviewer.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket10763/trac_10763-speedup-matrix-multiplication-reviewer.patch",
    "created_at": "2011-02-27T17:19:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/rbeezer"
}
```



---

archive/issue_comments_105527.json:
```json
{
    "body": "",
    "created_at": "2011-02-27T17:19:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10763#issuecomment-105527",
    "user": "https://github.com/rbeezer"
}
```





---

archive/issue_comments_105528.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [SimonKing](#comment%3A13):\n> Can you turn your suggestion into a referee patch? I wouldn't object to the change.\n\n\nDone and attached. Passes all long tests with the change.  When you are satisfied with my changes, go ahead and flip this to \"positive review\" - everything looks good on my end.\n\nThanks for the speed increase!\n\nRob",
    "created_at": "2011-02-27T17:22:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10763#issuecomment-105528",
    "user": "https://github.com/rbeezer"
}
```

<a id='comment:14'></a>
Replying to [SimonKing](#comment%3A13):
> Can you turn your suggestion into a referee patch? I wouldn't object to the change.


Done and attached. Passes all long tests with the change.  When you are satisfied with my changes, go ahead and flip this to "positive review" - everything looks good on my end.

Thanks for the speed increase!

Rob



---

archive/issue_comments_105529.json:
```json
{
    "body": "<a id='comment:15'></a>\nHi Rob,\n\nReplying to [rbeezer](#comment%3A14):\n> Replying to [SimonKing](#comment%3A13):\n> > Can you turn your suggestion into a referee patch? I wouldn't object to the change.\n\n> \n> Done and attached. Passes all long tests with the change.  When you are satisfied with my changes, go ahead and flip this to \"positive review\" \n\n\nDone, adding your name in the \"Reviewer\" field.\n\n> Thanks for the speed increase!\n\n\nYou're welcome! After all, the speed increase was in my own interest.\n\nCheers,\n\nSimon",
    "created_at": "2011-02-27T18:09:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10763#issuecomment-105529",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:15'></a>
Hi Rob,

Replying to [rbeezer](#comment%3A14):
> Replying to [SimonKing](#comment%3A13):
> > Can you turn your suggestion into a referee patch? I wouldn't object to the change.

> 
> Done and attached. Passes all long tests with the change.  When you are satisfied with my changes, go ahead and flip this to "positive review" 


Done, adding your name in the "Reviewer" field.

> Thanks for the speed increase!


You're welcome! After all, the speed increase was in my own interest.

Cheers,

Simon



---

archive/issue_events_083219.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2011-02-27T18:09:23Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10763#event-83219"
}
```



---

archive/issue_events_083220.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2011-02-27T18:09:23Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10763#event-83220"
}
```



---

archive/issue_comments_105530.json:
```json
{
    "body": "**Reviewer:** Rob Beezer",
    "created_at": "2011-02-27T18:09:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10763#issuecomment-105530",
    "user": "https://github.com/simon-king-jena"
}
```

**Reviewer:** Rob Beezer



---

archive/issue_events_083221.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-02-28T08:42:16Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "milestone": "sage-4.6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10763#event-83221"
}
```



---

archive/issue_events_083222.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-02-28T08:42:16Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "milestone": "sage-4.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10763#event-83222"
}
```



---

archive/issue_events_083223.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-03-16T11:31:35Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10763#event-83223"
}
```



---

archive/issue_events_083224.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-03-16T11:31:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10763#event-83224"
}
```



---

archive/issue_comments_105531.json:
```json
{
    "body": "<a id='comment:17'></a>\nThe commit message of the patch should be broken up in multiple lines instead of one long line.  The first line should stand by itself and must mention the ticket number, a more detailed message can come on following lines.  Use `hg qrefresh -e` to change the commit message.",
    "created_at": "2011-03-16T11:31:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10763#issuecomment-105531",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>
The commit message of the patch should be broken up in multiple lines instead of one long line.  The first line should stand by itself and must mention the ticket number, a more detailed message can come on following lines.  Use `hg qrefresh -e` to change the commit message.



---

archive/attachments_014092.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac10763-speedup_matrix_multiplication.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket10763/trac10763-speedup_matrix_multiplication.patch",
    "created_at": "2011-03-16T11:48:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/simon-king-jena"
}
```



---

archive/issue_comments_105532.json:
```json
{
    "body": "Improve performance of matrix multiplication by using a shortpath to matrix spaces and a shortpath in multiplication algorithms for creating a zero matrix",
    "created_at": "2011-03-16T11:48:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10763#issuecomment-105532",
    "user": "https://github.com/simon-king-jena"
}
```

Improve performance of matrix multiplication by using a shortpath to matrix spaces and a shortpath in multiplication algorithms for creating a zero matrix



---

archive/issue_events_083225.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2011-03-16T11:50:57Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10763#event-83225"
}
```



---

archive/issue_events_083226.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2011-03-16T11:50:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10763#event-83226"
}
```



---

archive/issue_comments_105533.json:
```json
{
    "body": "<a id='comment:18'></a>\nReplying to [jdemeyer](#comment%3A17):\n> The commit message of the patch should be broken up in multiple lines instead of one long line.  The first line should stand by itself and must mention the ticket number, a more detailed message can come on following lines.  Use `hg qrefresh -e` to change the commit message.\n\n\nBoth patches *did* mention the ticket number, and I think it is questionable whether the message of my original patch was to long. Anyway, I just replaced it, and I hope you'll find that it is fine.",
    "created_at": "2011-03-16T11:50:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10763#issuecomment-105533",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:18'></a>
Replying to [jdemeyer](#comment%3A17):
> The commit message of the patch should be broken up in multiple lines instead of one long line.  The first line should stand by itself and must mention the ticket number, a more detailed message can come on following lines.  Use `hg qrefresh -e` to change the commit message.


Both patches *did* mention the ticket number, and I think it is questionable whether the message of my original patch was to long. Anyway, I just replaced it, and I hope you'll find that it is fine.



---

archive/issue_comments_105534.json:
```json
{
    "body": "<a id='comment:19'></a>\nReplying to [SimonKing](#comment%3A18):\n> I think it is questionable whether the message of my original patch was to long.\n\n\nJust to clarify: the message itself was *not* too long, the problem was that the whole message was one long line without newlines.  It should be wrapped to multiple lines instead (as you did in this case).",
    "created_at": "2011-03-16T18:47:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10763#issuecomment-105534",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:19'></a>
Replying to [SimonKing](#comment%3A18):
> I think it is questionable whether the message of my original patch was to long.


Just to clarify: the message itself was *not* too long, the problem was that the whole message was one long line without newlines.  It should be wrapped to multiple lines instead (as you did in this case).



---

archive/issue_events_083227.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-03-17T19:23:17Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10763#event-83227"
}
```



---

archive/issue_events_083228.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-03-17T19:23:17Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10763#event-83228"
}
```



---

archive/issue_comments_105535.json:
```json
{
    "body": "**Merged:** sage-4.7.alpha2",
    "created_at": "2011-03-17T19:23:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10763",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10763#issuecomment-105535",
    "user": "https://github.com/jdemeyer"
}
```

**Merged:** sage-4.7.alpha2
