# Issue 10999: Elliptic curve generators from the database lie on the wrong curve

archive/issues_010914.json:
```json
{
    "body": "Assignee: @JohnCremona\n\nCC:  @JohnCremona @rlmill @adeines @mstreng\n\nKeywords: Cremona database, integral points, gens\n\nAfter installing the large cremona database. The following code \nshows something strange (which then causes a failure in E.integral_points()(:\n\n```\nsage: E=EllipticCurve('389a1')\nsage: [P.curve() is E for P in E.gens()]\n[False, False]\nsage: [P.curve() == E for P in E.gens()]\n[True, True]\n```\n\nThere is no problem when the database is not installed, since then the generators are computed on E itself.  But with the database,  an isomorphism is applied to the generators on the database curve to this curve (in this case it is the identity map) and somewhere in that process E is replaced by a copy.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/10999\n\n",
    "closed_at": "2011-06-15T15:23:51Z",
    "created_at": "2011-03-23T19:31:11Z",
    "labels": [
        "component: elliptic curves",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.7.1",
    "title": "Elliptic curve generators from the database lie on the wrong curve",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10999",
    "user": "https://trac.sagemath.org/admin/accounts/users/gagansekhon"
}
```
Assignee: @JohnCremona

CC:  @JohnCremona @rlmill @adeines @mstreng

Keywords: Cremona database, integral points, gens

After installing the large cremona database. The following code 
shows something strange (which then causes a failure in E.integral_points()(:

```
sage: E=EllipticCurve('389a1')
sage: [P.curve() is E for P in E.gens()]
[False, False]
sage: [P.curve() == E for P in E.gens()]
[True, True]
```

There is no problem when the database is not installed, since then the generators are computed on E itself.  But with the database,  an isomorphism is applied to the generators on the database curve to this curve (in this case it is the identity map) and somewhere in that process E is replaced by a copy.


Issue created by migration from https://trac.sagemath.org/ticket/10999





---

archive/issue_comments_116998.json:
```json
{
    "body": "I have found the problem, in lines 190-199 in ell_rational_field.py.  It copies the points from the database curve in a way which does not change te curve those points lie on.\n\nPatch on its way!",
    "created_at": "2011-03-24T19:37:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10999#issuecomment-116998",
    "user": "https://github.com/JohnCremona"
}
```

I have found the problem, in lines 190-199 in ell_rational_field.py.  It copies the points from the database curve in a way which does not change te curve those points lie on.

Patch on its way!



---

archive/issue_comments_116999.json:
```json
{
    "body": "I'm testing the whole library now and will ask for reviews if that goes ok.",
    "created_at": "2011-03-24T20:43:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10999#issuecomment-116999",
    "user": "https://github.com/JohnCremona"
}
```

I'm testing the whole library now and will ask for reviews if that goes ok.



---

archive/issue_comments_117000.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-03-24T20:52:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10999#issuecomment-117000",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_117001.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-03-25T01:06:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10999#issuecomment-117001",
    "user": "https://trac.sagemath.org/admin/accounts/users/weigandt"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_117002.json:
```json
{
    "body": "Looks good. The tests pass.",
    "created_at": "2011-03-25T01:06:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10999#issuecomment-117002",
    "user": "https://trac.sagemath.org/admin/accounts/users/weigandt"
}
```

Looks good. The tests pass.



---

archive/issue_comments_117003.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2011-03-28T14:16:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10999#issuecomment-117003",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_117004.json:
```json
{
    "body": "Replying to [comment:5 weigandt]:\n> The tests pass.\n\n\nReally?  Both the patchbot and my personal testing seems to indicate doctest problems.  Am I missing something?\n\n```\n**********************************************************************\nFile \"/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.alpha3/devel/sage-main/doc/en/bordeaux_2008/elliptic_curves.rst\", line 139:\n    sage: E.padic_regulator(5, 10)\nException raised:\n    Traceback (most recent call last):\n      File \"/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.alpha3/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.alpha3/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.alpha3/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_3[3]>\", line 1, in <module>\n        E.padic_regulator(Integer(5), Integer(10))###line 139:\n    sage: E.padic_regulator(5, 10)\n      File \"/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.alpha3/local/lib/python/site-packages/sage/schemes/elliptic_curves/padics.py\", line\n 269, in padic_regulator\n        d = self.padic_height_pairing_matrix(p=p, prec=prec, height=height, check_hypotheses=False)\n      File \"/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.alpha3/local/lib/python/site-packages/sage/schemes/elliptic_curves/padics.py\", line\n 344, in padic_height_pairing_matrix\n        basis = self.gens()\n      File \"/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.alpha3/local/lib/python/site-packages/sage/schemes/elliptic_curves/ell_rational_fie\nld.py\", line 1802, in gens\n        return list(self.__gens[proof])  # return copy so not changed\n      File \"parent.pyx\", line 738, in sage.structure.parent.Parent.__getattr__ (sage/structure/parent.c:5752)\n      File \"parent.pyx\", line 177, in sage.structure.parent.raise_attribute_error (sage/structure/parent.c:2724)\n    AttributeError: 'EllipticCurve_rational_field' object has no attribute '_EllipticCurve_rational_field__gens'\n**********************************************************************\n```\n\n```\nThe following tests failed:\n\n        sage -t  -long -force_lib devel/sage/doc/en/bordeaux_2008/elliptic_curves.rst # 7 doctests failed\n        sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/padics.py # 23 doctests failed\n        sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/ell_generic.py # 13 doctests failed\n        sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/padic_lseries.py # 2 doctests failed\n        sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/ell_point.py # 11 doctests failed\n        sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/ell_tate_curve.py # 4 doctests failed\n        sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/BSD.py # 4 doctests failed\n        sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/gp_simon.py # 1 doctests failed\n        sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/ell_number_field.py # 3 doctests failed\n        sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/heegner.py # 33 doctests failed\n        sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/sha_tate.py # 27 doctests failed\n        sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py # 17 doctests failed\n```",
    "created_at": "2011-03-28T14:16:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10999#issuecomment-117004",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:5 weigandt]:
> The tests pass.


Really?  Both the patchbot and my personal testing seems to indicate doctest problems.  Am I missing something?

```
**********************************************************************
File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.alpha3/devel/sage-main/doc/en/bordeaux_2008/elliptic_curves.rst", line 139:
    sage: E.padic_regulator(5, 10)
Exception raised:
    Traceback (most recent call last):
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.alpha3/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.alpha3/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.alpha3/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_3[3]>", line 1, in <module>
        E.padic_regulator(Integer(5), Integer(10))###line 139:
    sage: E.padic_regulator(5, 10)
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.alpha3/local/lib/python/site-packages/sage/schemes/elliptic_curves/padics.py", line
 269, in padic_regulator
        d = self.padic_height_pairing_matrix(p=p, prec=prec, height=height, check_hypotheses=False)
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.alpha3/local/lib/python/site-packages/sage/schemes/elliptic_curves/padics.py", line
 344, in padic_height_pairing_matrix
        basis = self.gens()
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.alpha3/local/lib/python/site-packages/sage/schemes/elliptic_curves/ell_rational_fie
ld.py", line 1802, in gens
        return list(self.__gens[proof])  # return copy so not changed
      File "parent.pyx", line 738, in sage.structure.parent.Parent.__getattr__ (sage/structure/parent.c:5752)
      File "parent.pyx", line 177, in sage.structure.parent.raise_attribute_error (sage/structure/parent.c:2724)
    AttributeError: 'EllipticCurve_rational_field' object has no attribute '_EllipticCurve_rational_field__gens'
**********************************************************************
```

```
The following tests failed:

        sage -t  -long -force_lib devel/sage/doc/en/bordeaux_2008/elliptic_curves.rst # 7 doctests failed
        sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/padics.py # 23 doctests failed
        sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/ell_generic.py # 13 doctests failed
        sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/padic_lseries.py # 2 doctests failed
        sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/ell_point.py # 11 doctests failed
        sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/ell_tate_curve.py # 4 doctests failed
        sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/BSD.py # 4 doctests failed
        sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/gp_simon.py # 1 doctests failed
        sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/ell_number_field.py # 3 doctests failed
        sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/heegner.py # 33 doctests failed
        sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/sha_tate.py # 27 doctests failed
        sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py # 17 doctests failed
```



---

archive/issue_comments_117005.json:
```json
{
    "body": "It would appear that I have made a serious error. I did run doctests, and they passed. I will admit to the possibility of having made a rookie mistake and tested the wrong copy of sage on my machine. \n\nAnother possible explanation is that I didn't have the large Cremona database installed when I applied the patch. So I applied the patch THEN installed the database and it seems the doctests passed under those circumstances.\n\nI'm running to tests again to see what happened.",
    "created_at": "2011-03-28T14:46:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10999#issuecomment-117005",
    "user": "https://trac.sagemath.org/admin/accounts/users/weigandt"
}
```

It would appear that I have made a serious error. I did run doctests, and they passed. I will admit to the possibility of having made a rookie mistake and tested the wrong copy of sage on my machine. 

Another possible explanation is that I didn't have the large Cremona database installed when I applied the patch. So I applied the patch THEN installed the database and it seems the doctests passed under those circumstances.

I'm running to tests again to see what happened.



---

archive/issue_comments_117006.json:
```json
{
    "body": "Jamie, let me take another look at this.",
    "created_at": "2011-03-29T01:43:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10999#issuecomment-117006",
    "user": "https://github.com/JohnCremona"
}
```

Jamie, let me take another look at this.



---

archive/issue_comments_117007.json:
```json
{
    "body": "OK, fixed.  There was a simple indentation error in the patch so removing 3 spaces did the trick.  The patch did work OK on Sage+large database but not without the large database.  Luckily I still had a 4.6.rc1 lying around without the database installed so I could test on that as well as on 4.7.alpha2 + database.  (There's no way of uninstalling the database!)\n\nI'm now doing full test of entire library with and without the database, and will post a new patch when done.",
    "created_at": "2011-03-29T02:05:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10999#issuecomment-117007",
    "user": "https://github.com/JohnCremona"
}
```

OK, fixed.  There was a simple indentation error in the patch so removing 3 spaces did the trick.  The patch did work OK on Sage+large database but not without the large database.  Luckily I still had a 4.6.rc1 lying around without the database installed so I could test on that as well as on 4.7.alpha2 + database.  (There's no way of uninstalling the database!)

I'm now doing full test of entire library with and without the database, and will post a new patch when done.



---

archive/issue_comments_117008.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-03-29T02:34:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10999#issuecomment-117008",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_117009.json:
```json
{
    "body": "OK, please re-review this one.  As I said, the difference between the previous patch and this one is just one indentation.\n\nIn order to test this one should test against a Sage installation with and without the spkg database_cremona_ellcurve.  I have done that (full test of entire library).",
    "created_at": "2011-03-29T02:34:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10999#issuecomment-117009",
    "user": "https://github.com/JohnCremona"
}
```

OK, please re-review this one.  As I said, the difference between the previous patch and this one is just one indentation.

In order to test this one should test against a Sage installation with and without the spkg database_cremona_ellcurve.  I have done that (full test of entire library).



---

archive/issue_comments_117010.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-06-09T09:45:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10999#issuecomment-117010",
    "user": "https://github.com/mstreng"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_117011.json:
```json
{
    "body": "sage 4.7 without database spkg without patch:\n\n```\nsage: E=EllipticCurve('389a1')\nsage: E.gens()\n[(-1 : 1 : 1), (0 : -1 : 1)]\n```\nsage 4.7 without database spkg with patch:\n\n```\nsage: E=EllipticCurve('389a1')\nsage: E.gens()\n...\nAttributeError: 'EllipticCurve_rational_field' object has no attribute '_EllipticCurve_rational_field__gens'\n```",
    "created_at": "2011-06-09T09:45:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10999#issuecomment-117011",
    "user": "https://github.com/mstreng"
}
```

sage 4.7 without database spkg without patch:

```
sage: E=EllipticCurve('389a1')
sage: E.gens()
[(-1 : 1 : 1), (0 : -1 : 1)]
```
sage 4.7 without database spkg with patch:

```
sage: E=EllipticCurve('389a1')
sage: E.gens()
...
AttributeError: 'EllipticCurve_rational_field' object has no attribute '_EllipticCurve_rational_field__gens'
```



---

archive/issue_comments_117012.json:
```json
{
    "body": "Applies to 4.7.1.alpha2",
    "created_at": "2011-06-09T14:42:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10999#issuecomment-117012",
    "user": "https://github.com/JohnCremona"
}
```

Applies to 4.7.1.alpha2



---

archive/issue_comments_117013.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-06-09T14:43:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10999#issuecomment-117013",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_117014.json:
```json
{
    "body": "Attachment [trac_10999-gens.patch](tarball://root/attachments/some-uuid/ticket10999/trac_10999-gens.patch) by @JohnCremona created at 2011-06-09 14:43:14\n\nI have fixed that problem (which was a real problem, not just a rebase).  Please retest!  I did test the whole library before and after installing the optional database.",
    "created_at": "2011-06-09T14:43:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10999#issuecomment-117014",
    "user": "https://github.com/JohnCremona"
}
```

Attachment [trac_10999-gens.patch](tarball://root/attachments/some-uuid/ticket10999/trac_10999-gens.patch) by @JohnCremona created at 2011-06-09 14:43:14

I have fixed that problem (which was a real problem, not just a rebase).  Please retest!  I did test the whole library before and after installing the optional database.



---

archive/issue_comments_117015.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-06-09T16:12:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10999#issuecomment-117015",
    "user": "https://github.com/mstreng"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_028569.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-06-15T15:23:51Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/10999",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10999#event-28569"
}
```



---

archive/issue_comments_117016.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-06-15T15:23:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10999#issuecomment-117016",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
