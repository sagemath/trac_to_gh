# Issue 10204: Random test in sage.graphs.generic_graph_pyx.find_hamiltonian takes a very long time

archive/issues_010204.json:
```json
{
    "body": "Assignee: mvngu\n\nCC:  fidelbarrera @rlmill boothby @nathanncohen\n\nKeywords: graph find_hamiltonian\n\nThe following test from `sage/graphs/generic_graph_pyx.pyx` takes a very long time:\n\n```\n    TESTS:\n\n    Running the algorithm on random instances, just to make sure the\n    answers are still satisfiable path (the algorithm would raise an\n    exception otherwise)::\n\n        sage: for i in range(200):\n        ...      g = graphs.RandomGNP(20,.1)\n        ...      _ = fh(G,find_path=True)\n```\nIt looks like `g` should be `G`.  Making this change makes the runtime even larger.\n\nAt the very least, it should be marked `# long time` but even then I think it takes way too long.  Possibly some other tests in that file should also be marked `# long time`.\n\nSee #9698 where the algorithm was implemented, see also #10206 for more issues.\n\nIssue created by migration from https://trac.sagemath.org/ticket/10205\n\n",
    "closed_at": "2010-11-12T13:03:41Z",
    "created_at": "2010-11-02T19:51:02Z",
    "labels": [
        "component: doctest coverage",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.6.1",
    "title": "Random test in sage.graphs.generic_graph_pyx.find_hamiltonian takes a very long time",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10204",
    "user": "https://github.com/jdemeyer"
}
```
Assignee: mvngu

CC:  fidelbarrera @rlmill boothby @nathanncohen

Keywords: graph find_hamiltonian

The following test from `sage/graphs/generic_graph_pyx.pyx` takes a very long time:

```
    TESTS:

    Running the algorithm on random instances, just to make sure the
    answers are still satisfiable path (the algorithm would raise an
    exception otherwise)::

        sage: for i in range(200):
        ...      g = graphs.RandomGNP(20,.1)
        ...      _ = fh(G,find_path=True)
```
It looks like `g` should be `G`.  Making this change makes the runtime even larger.

At the very least, it should be marked `# long time` but even then I think it takes way too long.  Possibly some other tests in that file should also be marked `# long time`.

See #9698 where the algorithm was implemented, see also #10206 for more issues.

Issue created by migration from https://trac.sagemath.org/ticket/10205





---

archive/issue_comments_103685.json:
```json
{
    "body": "Changing keywords from \"\" to \"graph find_hamiltonian\".",
    "created_at": "2010-11-02T20:09:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10204#issuecomment-103685",
    "user": "https://github.com/jdemeyer"
}
```

Changing keywords from "" to "graph find_hamiltonian".



---

archive/issue_comments_103686.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2010-11-03T09:07:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10204#issuecomment-103686",
    "user": "https://github.com/jdemeyer"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_103687.json:
```json
{
    "body": "Attachment [trac-10205_long-tests.patch](tarball://root/attachments/some-uuid/ticket10205/trac-10205_long-tests.patch) by mvngu created at 2010-11-05 07:36:30",
    "created_at": "2010-11-05T07:36:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10204#issuecomment-103687",
    "user": "https://trac.sagemath.org/admin/accounts/users/mvngu"
}
```

Attachment [trac-10205_long-tests.patch](tarball://root/attachments/some-uuid/ticket10205/trac-10205_long-tests.patch) by mvngu created at 2010-11-05 07:36:30



---

archive/issue_comments_103688.json:
```json
{
    "body": "The test can take a very long time because it's possible that a randomly generated graph has a vertex of degree one. The warning in the documentation of `find_hamiltonian()` says that the function could loop endlessly when the input graph has a vertex of degree one. So something like the following is likely to loop endlessly.\n\n```python\nsage: from sage.graphs.generic_graph_pyx import find_hamiltonian as fh\nsage: def long_test(n):\n....:     for i in range(n):\n....:         G = graphs.RandomGNP(20, 0.1)\n....:         _ = fh(G, find_path=True)\n....:         \nsage: long_test(1)\n```\n\nWe need to avoid using graphs that have a vertex of degree one. Something like the following should reduce the runtime of the doctest.\n\n```python\nsage: from sage.graphs.generic_graph_pyx import find_hamiltonian as fh\nsage: for i in range(100):  # long time\n...       G = graphs.RandomGNP(20, 0.1)\n...       while 1 in G.degree():\n...           G = graphs.RandomGNP(20, 0.1)\n...       _ = fh(G, find_path=True)\n```\n\nBut even then, `graphs.RandomGNP(20, 0.1)` could generate a graph with a vertex that has no out-neighbours. An exception similar to the following would then be returned (see #10206):\n\n```python\nsage: from sage.graphs.generic_graph_pyx import find_hamiltonian as fh\nsage: G = graphs.RandomGNP(20, 0.1)\nsage: while 1 in G.degree():\n....:     G = graphs.RandomGNP(20, 0.1)\n....:     \nsage: fh(G, find_path=True)\n(False, [1, 11, 16, 15, 12, 10, 9, 19, 13, 2, 7, 14, 8, 3, 0, 18, 5])\nsage: fh(G, find_path=True)\n(False, [14, 8, 3, 0, 18, 5, 7, 2, 13, 19, 1, 11, 16, 15, 12, 10, 9])\nsage: fh(G, find_path=True)\n(False, [9, 10, 12, 15, 16, 11, 1, 19, 13, 2, 7, 5, 18, 0, 3, 8, 14])\nsage: fh(G, find_path=True)\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n\n/dev/shm/mvngu/sage-4.6.1.alpha0/<ipython console> in <module>()\n\n/dev/shm/mvngu/sage-4.6.1.alpha0/local/lib/python2.6/site-packages/sage/graphs/generic_graph_pyx.so in sage.graphs.generic_graph_pyx.find_hamiltonian (sage/graphs/generic_graph_pyx.c:9771)()\n\n/dev/shm/mvngu/sage-4.6.1.alpha0/local/lib/python2.6/site-packages/sage/graphs/generic_graph_pyx.so in sage.graphs.generic_graph_pyx.find_hamiltonian (sage/graphs/generic_graph_pyx.c:8106)()\n\n/dev/shm/mvngu/sage-4.6.1.alpha0/local/lib/python2.6/site-packages/sage/misc/prandom.pyc in randint(a, b)\n    114         -46\n    115     \"\"\"\n--> 116     return _pyrand().randint(a, b)\n    117 \n    118 def choice(seq):\n\n/dev/shm/mvngu/sage-4.6.1.alpha0/local/lib/python/random.pyc in randint(self, a, b)\n    226         \"\"\"\n    227 \n--> 228         return self.randrange(a, b+1)\n    229 \n    230     def _randbelow(self, n, _log=_log, int=int, _maxwidth=1L<<BPF,\n\n/dev/shm/mvngu/sage-4.6.1.alpha0/local/lib/python/random.pyc in randrange(self, start, stop, step, int, default, maxwidth)\n    202             return int(istart + int(self.random()*width))\n    203         if step == 1:\n--> 204             raise ValueError, \"empty range for randrange() (%d,%d, %d)\" % (istart, istop, width)\n    205 \n    206         # Non-unit step argument supplied.\n\n\nValueError: empty range for randrange() (0,0, 0)\n```\n\nThe attached patch makes sure that when choosing a random vertex, the chosen vertex must have at least one out-neighbour. It also reduces the runtime to a \"reasonable\" amount.\n\n\n\n\nI came across a non-reproducible segfault with the following code:\n\n```python\nsage: from sage.graphs.generic_graph_pyx import find_hamiltonian as fh\nsage: def long_test(n):\n....:     for i in range(n):\n....:         G = graphs.RandomGNP(20, 0.1)\n....:         while 1 in G.degree():\n....:             G = graphs.RandomGNP(20, 0.1)\n....:         _ = fh(G, find_path=True)\n....:         \nsage: %time long_test(200)\n\n\n------------------------------------------------------------\nUnhandled SIGSEGV: A segmentation fault occurred in Sage.\nThis probably occurred because a *compiled* component\nof Sage has a bug in it (typically accessing invalid memory)\nand is not properly wrapped with sig_on(), sig_off().\nYou might want to run Sage under gdb with 'sage -gdb' to debug this.\nSage will now terminate (sorry).\n```",
    "created_at": "2010-11-05T07:53:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10204#issuecomment-103688",
    "user": "https://trac.sagemath.org/admin/accounts/users/mvngu"
}
```

The test can take a very long time because it's possible that a randomly generated graph has a vertex of degree one. The warning in the documentation of `find_hamiltonian()` says that the function could loop endlessly when the input graph has a vertex of degree one. So something like the following is likely to loop endlessly.

```python
sage: from sage.graphs.generic_graph_pyx import find_hamiltonian as fh
sage: def long_test(n):
....:     for i in range(n):
....:         G = graphs.RandomGNP(20, 0.1)
....:         _ = fh(G, find_path=True)
....:         
sage: long_test(1)
```

We need to avoid using graphs that have a vertex of degree one. Something like the following should reduce the runtime of the doctest.

```python
sage: from sage.graphs.generic_graph_pyx import find_hamiltonian as fh
sage: for i in range(100):  # long time
...       G = graphs.RandomGNP(20, 0.1)
...       while 1 in G.degree():
...           G = graphs.RandomGNP(20, 0.1)
...       _ = fh(G, find_path=True)
```

But even then, `graphs.RandomGNP(20, 0.1)` could generate a graph with a vertex that has no out-neighbours. An exception similar to the following would then be returned (see #10206):

```python
sage: from sage.graphs.generic_graph_pyx import find_hamiltonian as fh
sage: G = graphs.RandomGNP(20, 0.1)
sage: while 1 in G.degree():
....:     G = graphs.RandomGNP(20, 0.1)
....:     
sage: fh(G, find_path=True)
(False, [1, 11, 16, 15, 12, 10, 9, 19, 13, 2, 7, 14, 8, 3, 0, 18, 5])
sage: fh(G, find_path=True)
(False, [14, 8, 3, 0, 18, 5, 7, 2, 13, 19, 1, 11, 16, 15, 12, 10, 9])
sage: fh(G, find_path=True)
(False, [9, 10, 12, 15, 16, 11, 1, 19, 13, 2, 7, 5, 18, 0, 3, 8, 14])
sage: fh(G, find_path=True)
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)

/dev/shm/mvngu/sage-4.6.1.alpha0/<ipython console> in <module>()

/dev/shm/mvngu/sage-4.6.1.alpha0/local/lib/python2.6/site-packages/sage/graphs/generic_graph_pyx.so in sage.graphs.generic_graph_pyx.find_hamiltonian (sage/graphs/generic_graph_pyx.c:9771)()

/dev/shm/mvngu/sage-4.6.1.alpha0/local/lib/python2.6/site-packages/sage/graphs/generic_graph_pyx.so in sage.graphs.generic_graph_pyx.find_hamiltonian (sage/graphs/generic_graph_pyx.c:8106)()

/dev/shm/mvngu/sage-4.6.1.alpha0/local/lib/python2.6/site-packages/sage/misc/prandom.pyc in randint(a, b)
    114         -46
    115     """
--> 116     return _pyrand().randint(a, b)
    117 
    118 def choice(seq):

/dev/shm/mvngu/sage-4.6.1.alpha0/local/lib/python/random.pyc in randint(self, a, b)
    226         """
    227 
--> 228         return self.randrange(a, b+1)
    229 
    230     def _randbelow(self, n, _log=_log, int=int, _maxwidth=1L<<BPF,

/dev/shm/mvngu/sage-4.6.1.alpha0/local/lib/python/random.pyc in randrange(self, start, stop, step, int, default, maxwidth)
    202             return int(istart + int(self.random()*width))
    203         if step == 1:
--> 204             raise ValueError, "empty range for randrange() (%d,%d, %d)" % (istart, istop, width)
    205 
    206         # Non-unit step argument supplied.


ValueError: empty range for randrange() (0,0, 0)
```

The attached patch makes sure that when choosing a random vertex, the chosen vertex must have at least one out-neighbour. It also reduces the runtime to a "reasonable" amount.




I came across a non-reproducible segfault with the following code:

```python
sage: from sage.graphs.generic_graph_pyx import find_hamiltonian as fh
sage: def long_test(n):
....:     for i in range(n):
....:         G = graphs.RandomGNP(20, 0.1)
....:         while 1 in G.degree():
....:             G = graphs.RandomGNP(20, 0.1)
....:         _ = fh(G, find_path=True)
....:         
sage: %time long_test(200)


------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred in Sage.
This probably occurred because a *compiled* component
of Sage has a bug in it (typically accessing invalid memory)
and is not properly wrapped with sig_on(), sig_off().
You might want to run Sage under gdb with 'sage -gdb' to debug this.
Sage will now terminate (sorry).
```



---

archive/issue_comments_103689.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2010-11-05T07:53:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10204#issuecomment-103689",
    "user": "https://trac.sagemath.org/admin/accounts/users/mvngu"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_103690.json:
```json
{
    "body": "Minh: I think the most sensible fix is to fix the issues at #10206: I consider it a **bug** that the algorithm loops endlessly when the graph has a vertex of degree 1 (even if there is a warning in the documentation).  We should not change the test but change the `find_hamiltonian` algorithm.",
    "created_at": "2010-11-05T08:41:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10204#issuecomment-103690",
    "user": "https://github.com/jdemeyer"
}
```

Minh: I think the most sensible fix is to fix the issues at #10206: I consider it a **bug** that the algorithm loops endlessly when the graph has a vertex of degree 1 (even if there is a warning in the documentation).  We should not change the test but change the `find_hamiltonian` algorithm.



---

archive/issue_comments_103691.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2010-11-05T08:41:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10204#issuecomment-103691",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_103692.json:
```json
{
    "body": "Also: your patch would loop forever in the case the graph has no edges at all.",
    "created_at": "2010-11-11T21:48:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10204#issuecomment-103692",
    "user": "https://github.com/jdemeyer"
}
```

Also: your patch would loop forever in the case the graph has no edges at all.



---

archive/issue_comments_103693.json:
```json
{
    "body": "Attachment [10205_remove_doctest.patch](tarball://root/attachments/some-uuid/ticket10205/10205_remove_doctest.patch) by @jdemeyer created at 2010-11-11 21:51:17\n\nRemove the offending doctest completely, apply instead of other patch",
    "created_at": "2010-11-11T21:51:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10204#issuecomment-103693",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [10205_remove_doctest.patch](tarball://root/attachments/some-uuid/ticket10205/10205_remove_doctest.patch) by @jdemeyer created at 2010-11-11 21:51:17

Remove the offending doctest completely, apply instead of other patch



---

archive/issue_comments_103694.json:
```json
{
    "body": "Since there are so many issues with find_hamiltonian(), I would propose to simply remove the broken doctest for now. If anybody wants to fix the problems, please do it at #10206.  So I'm asking for review of [attachment:10205_remove_doctest.patch]",
    "created_at": "2010-11-11T21:54:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10204#issuecomment-103694",
    "user": "https://github.com/jdemeyer"
}
```

Since there are so many issues with find_hamiltonian(), I would propose to simply remove the broken doctest for now. If anybody wants to fix the problems, please do it at #10206.  So I'm asking for review of [attachment:10205_remove_doctest.patch]



---

archive/issue_comments_103695.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2010-11-11T21:54:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10204#issuecomment-103695",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_103696.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2010-11-12T12:30:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10204#issuecomment-103696",
    "user": "https://trac.sagemath.org/admin/accounts/users/mvngu"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_103697.json:
```json
{
    "body": "The patch [attachment:10205_remove_doctest.patch] is sensible to me. Remove the problematic doctest for now; the issue should be addressed at #10206 instead.",
    "created_at": "2010-11-12T12:30:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10204#issuecomment-103697",
    "user": "https://trac.sagemath.org/admin/accounts/users/mvngu"
}
```

The patch [attachment:10205_remove_doctest.patch] is sensible to me. Remove the problematic doctest for now; the issue should be addressed at #10206 instead.



---

archive/issue_comments_103698.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2010-11-12T13:03:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10204#issuecomment-103698",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_026155.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2010-11-12T13:03:41Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/10204",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10204#event-26155"
}
```
