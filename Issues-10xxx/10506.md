# Issue 10506: efficient counting of cusps for the principal congruence subgroup Gamma(n)

archive/issues_010453.json:
```json
{
    "body": "In the sage-support group, John Cremona suggested writing a ticket aimed at replacing the current code for G.ncusps, where G is the principal congruence subgroup Gamma(n), with more efficient code.  Please make a patch using the following replacement code.  This new code will compute say Gamma(15).ncusps() in less than a second, instead of the hours it takes with the current code.\n\nn=self.level() \n\nif n<=2: \n\n        return[None,1,3][n] \n\nreturn ZZ((1/2)*sum([moebius(d)*(n/d)*(n/d)   for d in n.divisors()])) \n\n\nAssignee: John Cremona\n\nKeywords: cusps, ncusps(), Gamma(n), principal congruence subgroup\n\nResolution: fixed\n\nAuthor: Ron Evans, John Cremona\n\nReviewer: Ron Evans\n\nMerged: sage-4.6.2.alpha2\n\nIssue created by migration from https://trac.sagemath.org/ticket/10506\n\n",
    "closed_at": "2011-01-25T08:16:25Z",
    "created_at": "2010-12-21T07:32:25Z",
    "labels": [
        "component: modular forms",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.6.2",
    "title": "efficient counting of cusps for the principal congruence subgroup Gamma(n)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10506",
    "user": "https://trac.sagemath.org/admin/accounts/users/rje"
}
```
In the sage-support group, John Cremona suggested writing a ticket aimed at replacing the current code for G.ncusps, where G is the principal congruence subgroup Gamma(n), with more efficient code.  Please make a patch using the following replacement code.  This new code will compute say Gamma(15).ncusps() in less than a second, instead of the hours it takes with the current code.

n=self.level() 

if n<=2: 

        return[None,1,3][n] 

return ZZ((1/2)*sum([moebius(d)*(n/d)*(n/d)   for d in n.divisors()])) 


Assignee: John Cremona

Keywords: cusps, ncusps(), Gamma(n), principal congruence subgroup

Resolution: fixed

Author: Ron Evans, John Cremona

Reviewer: Ron Evans

Merged: sage-4.6.2.alpha2

Issue created by migration from https://trac.sagemath.org/ticket/10506





---

archive/issue_comments_136189.json:
```json
{
    "body": "Attachment [trac_10506-ncusps.patch](tarball://root/attachments/some-uuid/ticket10506/trac_10506-ncusps.patch) by @JohnCremona created at 2010-12-21 12:08:58\n\napplies to 4.6.1.alpha3",
    "created_at": "2010-12-21T12:08:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10506#issuecomment-136189",
    "user": "https://github.com/JohnCremona"
}
```

Attachment [trac_10506-ncusps.patch](tarball://root/attachments/some-uuid/ticket10506/trac_10506-ncusps.patch) by @JohnCremona created at 2010-12-21 12:08:58

applies to 4.6.1.alpha3



---

archive/issue_comments_136190.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2010-12-21T12:13:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10506#issuecomment-136190",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_136191.json:
```json
{
    "body": "<a id='comment:1'></a>\nThe patch adds an implentation using the idea I posted on sage-support, namely using the formula (valid for n>2) that the number of cusps for Gamma(n) is half the index of Gamma1(n).\n\nSome times:\n\n```\nsage: timeit('Gamma(15).ncusps()')\n625 loops, best of 3: 174 \u00b5s per loop\nsage: timeit('Gamma(115).ncusps()')\n625 loops, best of 3: 176 \u00b5s per loop\nsage: timeit('Gamma(12115).ncusps()')\n625 loops, best of 3: 176 \u00b5s per loop\nsage: timeit('Gamma(1312115).ncusps()')\n625 loops, best of 3: 201 \u00b5s per loop\n```\n\nNote that the next job is to add a method to return a set of inequivalent cusps.  The default implementation is stupidly slow (as proved by the fact that the old default for ncusps() was to find all the cusps and count them).\n\nThat should be on another ticket.",
    "created_at": "2010-12-21T12:13:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10506#issuecomment-136191",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:1'></a>
The patch adds an implentation using the idea I posted on sage-support, namely using the formula (valid for n>2) that the number of cusps for Gamma(n) is half the index of Gamma1(n).

Some times:

```
sage: timeit('Gamma(15).ncusps()')
625 loops, best of 3: 174 µs per loop
sage: timeit('Gamma(115).ncusps()')
625 loops, best of 3: 176 µs per loop
sage: timeit('Gamma(12115).ncusps()')
625 loops, best of 3: 176 µs per loop
sage: timeit('Gamma(1312115).ncusps()')
625 loops, best of 3: 201 µs per loop
```

Note that the next job is to add a method to return a set of inequivalent cusps.  The default implementation is stupidly slow (as proved by the fact that the old default for ncusps() was to find all the cusps and count them).

That should be on another ticket.



---

archive/issue_comments_136192.json:
```json
{
    "body": "Changing author from \"Ron Evans\" to \"Ron Evans / John Cremona\"",
    "created_at": "2010-12-21T13:34:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10506#issuecomment-136192",
    "user": "https://trac.sagemath.org/admin/accounts/users/rje"
}
```

Changing author from "Ron Evans" to "Ron Evans / John Cremona"



---

archive/issue_comments_136193.json:
```json
{
    "body": "<a id='comment:2'></a>\nThe product formula in the patch is equivalent to the summation formula in my ticket, and is faster!  The examples given are all correct.",
    "created_at": "2010-12-21T13:34:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10506#issuecomment-136193",
    "user": "https://trac.sagemath.org/admin/accounts/users/rje"
}
```

<a id='comment:2'></a>
The product formula in the patch is equivalent to the summation formula in my ticket, and is faster!  The examples given are all correct.



---

archive/issue_comments_136194.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Ron Evans\"",
    "created_at": "2010-12-21T13:34:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10506#issuecomment-136194",
    "user": "https://trac.sagemath.org/admin/accounts/users/rje"
}
```

Changing reviewer from "" to "Ron Evans"



---

archive/issue_comments_136195.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2010-12-21T13:34:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10506#issuecomment-136195",
    "user": "https://trac.sagemath.org/admin/accounts/users/rje"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_032328.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2010-12-24T10:16:38Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10506",
    "milestone": "sage-4.6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10506#event-32328"
}
```



---

archive/issue_events_032329.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-01-25T08:16:25Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/10506",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10506#event-32329"
}
```



---

archive/issue_comments_136196.json:
```json
{
    "body": "Changing merged from \"\" to \"sage-4.6.2.alpha2\"",
    "created_at": "2011-01-25T08:16:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10506#issuecomment-136196",
    "user": "https://github.com/jdemeyer"
}
```

Changing merged from "" to "sage-4.6.2.alpha2"



---

archive/issue_comments_136197.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-01-25T08:16:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10506#issuecomment-136197",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_136198.json:
```json
{
    "body": "Changing author from \"Ron Evans / John Cremona\" to \"Ron Evans, John Cremona\"",
    "created_at": "2011-02-28T09:53:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10506",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10506#issuecomment-136198",
    "user": "https://github.com/jdemeyer"
}
```

Changing author from "Ron Evans / John Cremona" to "Ron Evans, John Cremona"
