# Issue 10159: matplotlib: avoid race conditions when creating (config) directories

archive/issues_010158.json:
```json
{
    "body": "This is a followup to #6235.  You can find a new spkg at \n\n[http://sage.math.washington.edu/home/palmieri/SPKG/matplotlib-1.0.0.p0.spkg](http://sage.math.washington.edu/home/palmieri/SPKG/matplotlib-1.0.0.p0.spkg)\n\nand I've attached the mercurial patch from the old version to the new, for reference.  There are two changes: record in the SPKG.txt file the change from #6235 about MPLCONFIGDIR, so that in future upgrades, we don't screw up how that variable is set.  Also, patch texmanager.py so that it creates the config dir in a way less likely to cause problems.  (See #8677 for a similar situation; the solution was taken from there.)\n\nAssignee: tbd\n\nKeywords: matplotlib MPLCONFIGDIR tex.cache condition errno 17\n\nResolution: fixed\n\nAuthor: John Palmieri\n\nReviewer: Leif Leonhardy\n\nUpstream: Reported upstream. Little or no feedback.\n\nMerged: sage-4.6.1.alpha0\n\nIssue created by migration from https://trac.sagemath.org/ticket/10159\n\n",
    "closed_at": "2010-11-01T10:17:40Z",
    "created_at": "2010-10-23T18:33:09Z",
    "labels": [
        "component: packages: standard",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.6.1",
    "title": "matplotlib: avoid race conditions when creating (config) directories",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10159",
    "user": "https://github.com/jhpalmieri"
}
```
This is a followup to #6235.  You can find a new spkg at 

[http://sage.math.washington.edu/home/palmieri/SPKG/matplotlib-1.0.0.p0.spkg](http://sage.math.washington.edu/home/palmieri/SPKG/matplotlib-1.0.0.p0.spkg)

and I've attached the mercurial patch from the old version to the new, for reference.  There are two changes: record in the SPKG.txt file the change from #6235 about MPLCONFIGDIR, so that in future upgrades, we don't screw up how that variable is set.  Also, patch texmanager.py so that it creates the config dir in a way less likely to cause problems.  (See #8677 for a similar situation; the solution was taken from there.)

Assignee: tbd

Keywords: matplotlib MPLCONFIGDIR tex.cache condition errno 17

Resolution: fixed

Author: John Palmieri

Reviewer: Leif Leonhardy

Upstream: Reported upstream. Little or no feedback.

Merged: sage-4.6.1.alpha0

Issue created by migration from https://trac.sagemath.org/ticket/10159





---

archive/issue_comments_121559.json:
```json
{
    "body": "<a id='comment:1'></a>\nA note about the patch: it is a little large because I had to add the file patches/texmanager.py to the repository.  Also, in addition to the important changes, it also changes various parts of SPKG.txt so that the lines are shorter than 80 characters.",
    "created_at": "2010-10-23T18:39:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10159",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10159#issuecomment-121559",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:1'></a>
A note about the patch: it is a little large because I had to add the file patches/texmanager.py to the repository.  Also, in addition to the important changes, it also changes various parts of SPKG.txt so that the lines are shorter than 80 characters.



---

archive/issue_comments_121560.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2010-10-23T18:39:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10159",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10159#issuecomment-121560",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_121561.json:
```json
{
    "body": "Changing upstream from \"N/A\" to \"Reported upstream. Little or no feedback.\"",
    "created_at": "2010-10-23T19:01:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10159",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10159#issuecomment-121561",
    "user": "https://github.com/jhpalmieri"
}
```

Changing upstream from "N/A" to "Reported upstream. Little or no feedback."



---

archive/issue_comments_121562.json:
```json
{
    "body": "<a id='comment:2'></a>\nI just reported this upstream.  If I get any feedback, I'll report it here.",
    "created_at": "2010-10-23T19:01:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10159",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10159#issuecomment-121562",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:2'></a>
I just reported this upstream.  If I get any feedback, I'll report it here.



---

archive/issue_comments_121563.json:
```json
{
    "body": "<a id='comment:3'></a>\nApart from the typo in the commit message, and I'm not sure if I like `assert` there, I'm ok with the patch, and the spkg is clean.\n\nWorks for me as advertised, so positive review.\n\n(Tested on Ubuntu 10.04 x86_64, Core2 Quad. I also deleted the MPL config dir and then ran\n\n```sh\n$ ./sage -tp N -long devel/sage/sage/plot/ # N={32,64} (though only 49 files)\n```\nEach time all doctests passed. Perhaps others should stress-[doc]test it on other platforms like MacOS X, too.)",
    "created_at": "2010-10-23T21:18:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10159",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10159#issuecomment-121563",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:3'></a>
Apart from the typo in the commit message, and I'm not sure if I like `assert` there, I'm ok with the patch, and the spkg is clean.

Works for me as advertised, so positive review.

(Tested on Ubuntu 10.04 x86_64, Core2 Quad. I also deleted the MPL config dir and then ran

```sh
$ ./sage -tp N -long devel/sage/sage/plot/ # N={32,64} (though only 49 files)
```
Each time all doctests passed. Perhaps others should stress-[doc]test it on other platforms like MacOS X, too.)



---

archive/issue_comments_121564.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2010-10-23T21:18:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10159",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10159#issuecomment-121564",
    "user": "https://github.com/nexttime"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_121565.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Leif Leonhardy\"",
    "created_at": "2010-10-23T21:18:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10159",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10159#issuecomment-121565",
    "user": "https://github.com/nexttime"
}
```

Changing reviewer from "" to "Leif Leonhardy"



---

archive/issue_comments_121566.json:
```json
{
    "body": "<a id='comment:4'></a>\nReplying to [leif](#comment%3A3):\n> Apart from the typo in the commit message\n\n\nIf you mean the spurious apostrophe, I've removed it.\n\n> , and I'm not sure if I like `assert` \n\n\nI just took that from #8677. \n\n> Works for me as advertised, so positive review.\n\n\nGreat, thanks!",
    "created_at": "2010-10-23T21:25:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10159",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10159#issuecomment-121566",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:4'></a>
Replying to [leif](#comment%3A3):
> Apart from the typo in the commit message


If you mean the spurious apostrophe, I've removed it.

> , and I'm not sure if I like `assert` 


I just took that from #8677. 

> Works for me as advertised, so positive review.


Great, thanks!



---

archive/issue_comments_121567.json:
```json
{
    "body": "<a id='comment:5'></a>\nOh, I just noticed the patch does *not* (exactly) what the ticket advertises... \n(In fact, the patch addresses the race condition in the creation of the TeX cache.)\n\nThere are still some other instances of `if not os.path.exists(foo): mkdir(foo)` and similar, so it's a bit surprising I did not run into any race condition.\n\nJohn, are you willing to fix these, too?\n\nUnless you meanwhile have Sun's grep installed, you can find them by e.g.\n\n```sh\n$ grep -B5 -A2  mkdir `find src -name \\*.py`\n```\n(Giving about two false positives; also not all are equally important I think.)",
    "created_at": "2010-10-23T21:43:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10159",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10159#issuecomment-121567",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:5'></a>
Oh, I just noticed the patch does *not* (exactly) what the ticket advertises... 
(In fact, the patch addresses the race condition in the creation of the TeX cache.)

There are still some other instances of `if not os.path.exists(foo): mkdir(foo)` and similar, so it's a bit surprising I did not run into any race condition.

John, are you willing to fix these, too?

Unless you meanwhile have Sun's grep installed, you can find them by e.g.

```sh
$ grep -B5 -A2  mkdir `find src -name \*.py`
```
(Giving about two false positives; also not all are equally important I think.)



---

archive/issue_comments_121568.json:
```json
{
    "body": "<a id='comment:6'></a>\nI tried the same multiple times with `DOT_SAGE` set to some NFS-mounted filesystem, made that busy by another machine, but still don't get any errors...",
    "created_at": "2010-10-23T22:09:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10159",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10159#issuecomment-121568",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:6'></a>
I tried the same multiple times with `DOT_SAGE` set to some NFS-mounted filesystem, made that busy by another machine, but still don't get any errors...



---

archive/issue_comments_121569.json:
```json
{
    "body": "<a id='comment:7'></a>\nOkay, I've fixed some more of these.  I think that only the files in src/lib/matplotlib get installed, so I haven't bothered with the other ones.  I also ignored the function \"mkdirs\" in cbook.py.  This is only used in sphinxext/plot_directive.py, so I don't think it should affect us.  Also, the function could perhaps just be replaced with a call to [os.makedirs](http://docs.python.org/library/os.html#os.makedirs), which is already recursive and allows you to set the mode.  Maybe the matplotlib people are worried about the presence of \"..\" in the pathname?  Anyway, I don't have a good way to test any changes to that part of the code, so I'm going to leave it alone.",
    "created_at": "2010-10-23T22:37:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10159",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10159#issuecomment-121569",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:7'></a>
Okay, I've fixed some more of these.  I think that only the files in src/lib/matplotlib get installed, so I haven't bothered with the other ones.  I also ignored the function "mkdirs" in cbook.py.  This is only used in sphinxext/plot_directive.py, so I don't think it should affect us.  Also, the function could perhaps just be replaced with a call to [os.makedirs](http://docs.python.org/library/os.html#os.makedirs), which is already recursive and allows you to set the mode.  Maybe the matplotlib people are worried about the presence of ".." in the pathname?  Anyway, I don't have a good way to test any changes to that part of the code, so I'm going to leave it alone.



---

archive/issue_comments_121570.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2010-10-23T22:37:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10159",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10159#issuecomment-121570",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_121571.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2010-10-23T22:38:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10159",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10159#issuecomment-121571",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_121572.json:
```json
{
    "body": "Mercurial patch for matplotlib spkg; for reference only",
    "created_at": "2010-10-23T22:40:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10159",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10159#issuecomment-121572",
    "user": "https://github.com/jhpalmieri"
}
```

Mercurial patch for matplotlib spkg; for reference only



---

archive/issue_comments_121573.json:
```json
{
    "body": "Changing keywords from \"matplotlib\" to \"matplotlib MPLCONFIGDIR tex.cache condition errno 17\".",
    "created_at": "2010-10-23T23:33:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10159",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10159#issuecomment-121573",
    "user": "https://github.com/nexttime"
}
```

Changing keywords from "matplotlib" to "matplotlib MPLCONFIGDIR tex.cache condition errno 17".



---

archive/issue_events_038885.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/10159",
    "rename": {
        "from": "matplotlib: avoid race condition when creating config directory",
        "to": "matplotlib: avoid race conditions when creating (config) directories"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10159#event-38885"
}
```



---

archive/issue_comments_121574.json:
```json
{
    "body": "<a id='comment:10'></a>\nAttachment [trac_10159-matplotlib.patch](tarball://root/attachments/some-uuid/ticket10159/trac_10159-matplotlib.patch) by @nexttime created at 2010-10-23 23:33:20\n\nOk.\n\nAlso, `raise` is more adequate there, since one cannot assert the only possible `OSError` is `EEXIST`, so it's less confusing now.\n\n(I still can't force errors.)",
    "created_at": "2010-10-23T23:33:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10159",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10159#issuecomment-121574",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:10'></a>
Attachment [trac_10159-matplotlib.patch](tarball://root/attachments/some-uuid/ticket10159/trac_10159-matplotlib.patch) by @nexttime created at 2010-10-23 23:33:20

Ok.

Also, `raise` is more adequate there, since one cannot assert the only possible `OSError` is `EEXIST`, so it's less confusing now.

(I still can't force errors.)



---

archive/issue_comments_121575.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2010-10-23T23:33:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10159",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10159#issuecomment-121575",
    "user": "https://github.com/nexttime"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_121576.json:
```json
{
    "body": "Changing merged from \"\" to \"sage-4.6.1.alpha0\"",
    "created_at": "2010-11-01T10:17:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10159",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10159#issuecomment-121576",
    "user": "https://github.com/jdemeyer"
}
```

Changing merged from "" to "sage-4.6.1.alpha0"



---

archive/issue_events_038886.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2010-11-01T10:17:40Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/10159",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10159#event-38886"
}
```



---

archive/issue_comments_121577.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2010-11-01T10:17:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10159",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10159#issuecomment-121577",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_038887.json:
```json
{
    "actor": "https://github.com/qed777",
    "created_at": "2010-11-01T10:26:56Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10159",
    "milestone": "sage-4.6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10159#event-38887"
}
```
