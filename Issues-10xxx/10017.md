# Issue 10017: reduced_basis for number field multiples wrong

archive/issues_010016.json:
```json
{
    "body": "This was reported by the \"report a problem\" link:\n\nThe reduced_basis for number fields applies LLL to basis of the maximal order in order to get a reduced basis. The problem is that after applying LLL, it multiples the transformation matrix by the vector [1,a,a<sup>2</sup>,...], where 'a' is generator of the field - instead of using the vector it actually used for the maximal order.\n\nHow to reproduce:\n\n```\nx = QQ['x'].0\nk = NumberField(x^6 + 2218926655879913714112*x^4 - \\\n32507675650290949030789018433536*x^3 + \\\n4923635504174417014460581055002374467948544*x^2 - \\\n36066074010564497464129951249279114076897746988630016*x + \\\n264187244046129768986806800244258952598300346857154900812365824,'a')\nnew_basis = k.reduced_basis()\nprint new_basis[0].minpoly()\n```\nThis prints a crazy big polynomial. Looking a bit at what is returned it is clear that reduced_basis is multiplying the transformation matrix by the wrong vector.\n\nTo solve you just need to multiply by the vector of generators of the maximal order:\n\n```\nmp = pari( k.Minkowski_embedding(k.maximal_order().gens(), prec=120) )\nml = sage.libs.pari.gen.gen.qflll(mp)\nT = matrix([[ZZ(y) for y in list(x)] for x in list(ml)]).transpose()\nr = Matrix(O.gens())* T\nfor rr in r[0]:\nprint rr.minpoly()\n```\nThis works fine.\n\nAssignee: @loefflerd\n\nBranch/Commit: 8f1f51d83fc198a31683740001bcffe9a3d30bbc\n\nStopgaps: todo\n\nReviewer: Jeroen Demeyer\n\nAuthor: John Cremona\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/10017\n\n",
    "closed_at": "2018-01-20T20:20:23Z",
    "created_at": "2010-09-26T10:24:30Z",
    "labels": [
        "component: number fields",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "reduced_basis for number field multiples wrong",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10017",
    "user": "https://github.com/haraldschilly"
}
```
This was reported by the "report a problem" link:

The reduced_basis for number fields applies LLL to basis of the maximal order in order to get a reduced basis. The problem is that after applying LLL, it multiples the transformation matrix by the vector [1,a,a<sup>2</sup>,...], where 'a' is generator of the field - instead of using the vector it actually used for the maximal order.

How to reproduce:

```
x = QQ['x'].0
k = NumberField(x^6 + 2218926655879913714112*x^4 - \
32507675650290949030789018433536*x^3 + \
4923635504174417014460581055002374467948544*x^2 - \
36066074010564497464129951249279114076897746988630016*x + \
264187244046129768986806800244258952598300346857154900812365824,'a')
new_basis = k.reduced_basis()
print new_basis[0].minpoly()
```
This prints a crazy big polynomial. Looking a bit at what is returned it is clear that reduced_basis is multiplying the transformation matrix by the wrong vector.

To solve you just need to multiply by the vector of generators of the maximal order:

```
mp = pari( k.Minkowski_embedding(k.maximal_order().gens(), prec=120) )
ml = sage.libs.pari.gen.gen.qflll(mp)
T = matrix([[ZZ(y) for y in list(x)] for x in list(ml)]).transpose()
r = Matrix(O.gens())* T
for rr in r[0]:
print rr.minpoly()
```
This works fine.

Assignee: @loefflerd

Branch/Commit: 8f1f51d83fc198a31683740001bcffe9a3d30bbc

Stopgaps: todo

Reviewer: Jeroen Demeyer

Author: John Cremona

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/10017





---

archive/issue_comments_105066.json:
```json
{
    "body": "<a id='comment:1'></a>Looks like the definition of `O` was omitted.  The following slightly simplified code works ok for me:\n\n```\nsage: O = k.ring_of_integers()\nsage: mp = pari( k.Minkowski_embedding(O.gens(), prec=120) )\nsage: ml = sage.libs.pari.gen.gen.qflll(mp)\nsage: T = ml.sage()\nsage: r = vector(O.gens())*T\nsage: for rr in r:\n....:     rr.minpoly()\n```",
    "created_at": "2010-09-27T06:27:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105066",
    "user": "https://trac.sagemath.org/admin/accounts/users/fwclarke"
}
```

<a id='comment:1'></a>Looks like the definition of `O` was omitted.  The following slightly simplified code works ok for me:

```
sage: O = k.ring_of_integers()
sage: mp = pari( k.Minkowski_embedding(O.gens(), prec=120) )
sage: ml = sage.libs.pari.gen.gen.qflll(mp)
sage: T = ml.sage()
sage: r = vector(O.gens())*T
sage: for rr in r:
....:     rr.minpoly()
```



---

archive/issue_events_025397.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10017#event-25397"
}
```



---

archive/issue_events_025398.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10017#event-25398"
}
```



---

archive/issue_events_025399.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10017#event-25399"
}
```



---

archive/issue_events_025400.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10017#event-25400"
}
```



---

archive/issue_events_025401.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10017#event-25401"
}
```



---

archive/issue_events_025402.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10017#event-25402"
}
```



---

archive/issue_events_025403.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10017#event-25403"
}
```



---

archive/issue_comments_105067.json:
```json
{
    "body": "<a id='comment:7'></a>While the original diagnosis is not wrong, there is a more basic problem as this smaller example shows:\n\n```\nsage: K.<a> = NumberField(x^3-10)\nsage: ZK = K.ring_of_integers()\nsage: ZK.basis()\n[1/3*a^2 + 1/3*a + 1/3, a, a^2]\nsage: ZK([1,2,3])\n3*a^2 + 2*a + 1\n```\nAlthough the ring of integers is an order which knows its own Z-basis, when you construct an element of the order from an integer vector it ignores that and uses the power_basis of the field and not its integral basis.\n\nI think the problem is in these lines of _element_constructor() (order.py lines 1142-1143):\n\n```\n       if not is_Element(x) or x.parent() is not self._K:\n            x = self._K(x)\n```\n\nThere appears to be a related problem in the constructor of OrderElementAbsolute in number_field_element:\n\n```\n       K = order.number_field()\n        NumberFieldElement_absolute.__init__(self, K, f)\n        self._number_field = K\n```\nwhere the parameter f is not documented and there are no relevant tests, but this seems to be saying \"take the data in f and construct a field element from it\".\n\nPerhaps the simplest solution is to go to those lines in order.py and insert code to handle the case where the input data is an integer vector of the right length.",
    "created_at": "2017-11-12T15:27:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105067",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:7'></a>While the original diagnosis is not wrong, there is a more basic problem as this smaller example shows:

```
sage: K.<a> = NumberField(x^3-10)
sage: ZK = K.ring_of_integers()
sage: ZK.basis()
[1/3*a^2 + 1/3*a + 1/3, a, a^2]
sage: ZK([1,2,3])
3*a^2 + 2*a + 1
```
Although the ring of integers is an order which knows its own Z-basis, when you construct an element of the order from an integer vector it ignores that and uses the power_basis of the field and not its integral basis.

I think the problem is in these lines of _element_constructor() (order.py lines 1142-1143):

```
       if not is_Element(x) or x.parent() is not self._K:
            x = self._K(x)
```

There appears to be a related problem in the constructor of OrderElementAbsolute in number_field_element:

```
       K = order.number_field()
        NumberFieldElement_absolute.__init__(self, K, f)
        self._number_field = K
```
where the parameter f is not documented and there are no relevant tests, but this seems to be saying "take the data in f and construct a field element from it".

Perhaps the simplest solution is to go to those lines in order.py and insert code to handle the case where the input data is an integer vector of the right length.



---

archive/issue_comments_105068.json:
```json
{
    "body": "<a id='comment:8'></a>After doing the above \"simplest solution\", which did fix the `x^3-10` example above, I saw that it's not the fix needed for the original which is to take the vectors output by the LLL reduction and push them into the ring of integers rather than the field.  Now I get \n\n```\nsage: [c.minpoly() for c in new_basis]\n\n[x - 1,\n x^6 + 3*x^5 + 258*x^4 + 511*x^3 + 3564*x^2 + 3309*x + 2347,\n x^6 - 24*x^5 + 6126*x^4 - 312664*x^3 + 5407566*x^2 - 33643572*x + 95921443,\n x^6 + 18*x^5 + 3366*x^4 + 82008*x^3 + 886962*x^2 - 840726*x + 5521647,\n x^6 + 27*x^5 + 9579*x^4 + 623358*x^3 + 5060091*x^2 - 139224285*x + 880944177,\n x^6 - 72*x^5 + 65286*x^4 - 10762768*x^3 + 473072922*x^2 - 2502686322*x + 54227921641]\n```\nwhich is a lot better.\n\nPatch up when I have added doctests...",
    "created_at": "2017-11-12T15:48:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105068",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:8'></a>After doing the above "simplest solution", which did fix the `x^3-10` example above, I saw that it's not the fix needed for the original which is to take the vectors output by the LLL reduction and push them into the ring of integers rather than the field.  Now I get 

```
sage: [c.minpoly() for c in new_basis]

[x - 1,
 x^6 + 3*x^5 + 258*x^4 + 511*x^3 + 3564*x^2 + 3309*x + 2347,
 x^6 - 24*x^5 + 6126*x^4 - 312664*x^3 + 5407566*x^2 - 33643572*x + 95921443,
 x^6 + 18*x^5 + 3366*x^4 + 82008*x^3 + 886962*x^2 - 840726*x + 5521647,
 x^6 + 27*x^5 + 9579*x^4 + 623358*x^3 + 5060091*x^2 - 139224285*x + 880944177,
 x^6 - 72*x^5 + 65286*x^4 - 10762768*x^3 + 473072922*x^2 - 2502686322*x + 54227921641]
```
which is a lot better.

Patch up when I have added doctests...



---

archive/issue_comments_105069.json:
```json
{
    "body": "<a id='comment:9'></a>The doctest based on the original post works fine for me when run manually, but when run as a doctest something weird happens -- it takes ages and then gives an enormous python crash.  I have no idea what this is but hope that a human can help before this breaks all the patchbots out there...\n\n---\nNew commits:",
    "created_at": "2017-11-12T16:36:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105069",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:9'></a>The doctest based on the original post works fine for me when run manually, but when run as a doctest something weird happens -- it takes ages and then gives an enormous python crash.  I have no idea what this is but hope that a human can help before this breaks all the patchbots out there...

---
New commits:



---

archive/issue_comments_105070.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-11-12T16:36:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105070",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_105071.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-11-21T13:05:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105071",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_105072.json:
```json
{
    "body": "<a id='comment:11'></a>Quick comments (more might come):\n\n1. Replace `See (:trac:`10017`)::` by `Check that :trac:`10017` is fixed::` or something along those lines.\n\n2. Replace\n\n```\nsage: assert R.discriminant()==k.discriminant()\n```\nby\n\n```\nsage: R.discriminant() == k.discriminant()\nTrue\n```",
    "created_at": "2017-11-21T13:47:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105072",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>Quick comments (more might come):

1. Replace `See (:trac:`10017`)::` by `Check that :trac:`10017` is fixed::` or something along those lines.

2. Replace

```
sage: assert R.discriminant()==k.discriminant()
```
by

```
sage: R.discriminant() == k.discriminant()
True
```



---

archive/issue_comments_105073.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-11-21T14:25:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105073",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_105074.json:
```json
{
    "body": "<a id='comment:13'></a>In this block of code:\n\n```\n            M = self.Minkowski_embedding(self.integral_basis(), prec=prec)\n            T = pari(M).qflll().sage()\n            ZK = self.ring_of_integers()\n            self.__reduced_basis = [ ZK(v.list()) for v in T.columns() ]\n```\nyou are assuming that `self.integral_basis()` corresponds to the basis chosen in `ZK(v.list())`. After all, that's the bug on this ticket, right? To me, this looks way too implicit. I would prefer to see the code written in such a way that you are actually using `self.integral_basis()` in this computation, instead of the `ZK()` call. I.e. something like\n\n```\nZK = self.integral_basis()\nreduced_basis = [sum(x * g for x, g in zip(v.list(), ZK)) for v in T.columns()]\n```",
    "created_at": "2017-11-28T13:45:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105074",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>In this block of code:

```
            M = self.Minkowski_embedding(self.integral_basis(), prec=prec)
            T = pari(M).qflll().sage()
            ZK = self.ring_of_integers()
            self.__reduced_basis = [ ZK(v.list()) for v in T.columns() ]
```
you are assuming that `self.integral_basis()` corresponds to the basis chosen in `ZK(v.list())`. After all, that's the bug on this ticket, right? To me, this looks way too implicit. I would prefer to see the code written in such a way that you are actually using `self.integral_basis()` in this computation, instead of the `ZK()` call. I.e. something like

```
ZK = self.integral_basis()
reduced_basis = [sum(x * g for x, g in zip(v.list(), ZK)) for v in T.columns()]
```



---

archive/issue_comments_105075.json:
```json
{
    "body": "<a id='comment:14'></a>Yes, you are right, and perhaps being explicit like this is safest.  I still think (do you agree?) that being able to do ZK(list) is useful and must give the linear combination of ZK's basis with coefficients from the list.\n\nA related different point is that after computing the reduced basis, it is stored as `self.__reduced_basis`, but not actually used anywhere.  Perhaps we should implement the ability to change the integral basis itself; but that might be too dangerous since various functions using pari directly will assume that the integral basis does not change.",
    "created_at": "2017-11-28T14:02:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105075",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:14'></a>Yes, you are right, and perhaps being explicit like this is safest.  I still think (do you agree?) that being able to do ZK(list) is useful and must give the linear combination of ZK's basis with coefficients from the list.

A related different point is that after computing the reduced basis, it is stored as `self.__reduced_basis`, but not actually used anywhere.  Perhaps we should implement the ability to change the integral basis itself; but that might be too dangerous since various functions using pari directly will assume that the integral basis does not change.



---

archive/issue_comments_105076.json:
```json
{
    "body": "<a id='comment:15'></a>(fixing exponentiation in ticket description)",
    "created_at": "2017-12-03T11:43:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105076",
    "user": "https://github.com/videlec"
}
```

<a id='comment:15'></a>(fixing exponentiation in ticket description)



---

archive/issue_comments_105077.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,6 @@\n This was reported by the \"report a problem\" link:\n \n-The reduced_basis for number fields applies LLL to basis of the maximal order in order to get a reduced basis. The problem is that after applying LLL, it multiples the transformation matrix by the vector [1,a,a^2,...], where 'a' is generator of the field - instead of using the vector it actually used for the maximal order.\n+The reduced_basis for number fields applies LLL to basis of the maximal order in order to get a reduced basis. The problem is that after applying LLL, it multiples the transformation matrix by the vector [1,a,a<sup>2</sup>,...], where 'a' is generator of the field - instead of using the vector it actually used for the maximal order.\n \n How to reproduce:\n \n``````\n",
    "created_at": "2017-12-03T11:43:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105077",
    "user": "https://github.com/videlec"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,6 @@
 This was reported by the "report a problem" link:
 
-The reduced_basis for number fields applies LLL to basis of the maximal order in order to get a reduced basis. The problem is that after applying LLL, it multiples the transformation matrix by the vector [1,a,a^2,...], where 'a' is generator of the field - instead of using the vector it actually used for the maximal order.
+The reduced_basis for number fields applies LLL to basis of the maximal order in order to get a reduced basis. The problem is that after applying LLL, it multiples the transformation matrix by the vector [1,a,a<sup>2</sup>,...], where 'a' is generator of the field - instead of using the vector it actually used for the maximal order.
 
 How to reproduce:
 
``````




---

archive/issue_comments_105078.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:14 cremona]:\n> Yes, you are right, and perhaps being explicit like this is safest.  I still think (do you agree?) that being able to do ZK(list) is useful and must give the linear combination of ZK's basis with coefficients from the list.\n\n\nSure, why not.\n\n> A related different point is that after computing the reduced basis, it is stored as `self.__reduced_basis`, but not actually used anywhere.\n\n\nI would be fine to not store it.\n\n> Perhaps we should implement the ability to change the integral basis itself; but that might be too dangerous since various functions using pari directly will assume that the integral basis does not change.\n\n\nI agree with the latter. Better not do this.",
    "created_at": "2018-01-08T08:45:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105078",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:16'></a>Replying to [comment:14 cremona]:
> Yes, you are right, and perhaps being explicit like this is safest.  I still think (do you agree?) that being able to do ZK(list) is useful and must give the linear combination of ZK's basis with coefficients from the list.


Sure, why not.

> A related different point is that after computing the reduced basis, it is stored as `self.__reduced_basis`, but not actually used anywhere.


I would be fine to not store it.

> Perhaps we should implement the ability to change the integral basis itself; but that might be too dangerous since various functions using pari directly will assume that the integral basis does not change.


I agree with the latter. Better not do this.



---

archive/issue_comments_105079.json:
```json
{
    "body": "<a id='comment:17'></a>The problems I was having with testing were due to a cut-and-paste error: in the patch the coefficient of x starts 3666 instead of 36066 which makes the polynomial rather harder to work with.  I will fix that and the other issues from the previous comment now.",
    "created_at": "2018-01-11T12:55:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105079",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:17'></a>The problems I was having with testing were due to a cut-and-paste error: in the patch the coefficient of x starts 3666 instead of 36066 which makes the polynomial rather harder to work with.  I will fix that and the other issues from the previous comment now.



---

archive/issue_comments_105080.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-01-11T13:05:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105080",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_105081.json:
```json
{
    "body": "<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-01-11T13:06:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105081",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_105082.json:
```json
{
    "body": "<a id='comment:20'></a>New changes: code simplified since there's really only 2 lines different between the two cases (totally real or not).  Removed caching of reduced basis (was never used).  Follow suggestion of comments 13 and following.\n\nNeeds review again!",
    "created_at": "2018-01-11T13:08:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105082",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:20'></a>New changes: code simplified since there's really only 2 lines different between the two cases (totally real or not).  Removed caching of reduced basis (was never used).  Follow suggestion of comments 13 and following.

Needs review again!



---

archive/issue_comments_105083.json:
```json
{
    "body": "<a id='comment:21'></a>Style issue: better write\n\n```\nif isinstance(x, (tuple, list)):\n```\ninstead of\n\n```\nif isinstance(x,list) or isinstance(x,tuple):\n```",
    "created_at": "2018-01-11T15:02:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105083",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'></a>Style issue: better write

```
if isinstance(x, (tuple, list)):
```
instead of

```
if isinstance(x,list) or isinstance(x,tuple):
```



---

archive/issue_comments_105084.json:
```json
{
    "body": "<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-01-11T15:11:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105084",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_105085.json:
```json
{
    "body": "<a id='comment:23'></a>The patchbot reports a failure on 32-bit:\n\n```\nsage -t --long src/sage/rings/number_field/number_field.py\n**********************************************************************\nFile \"src/sage/rings/number_field/number_field.py\", line 5599, in sage.rings.number_field.number_field.NumberField_generic.reduced_basis\nFailed example:\n    [c.minpoly() for c in new_basis]\nExpected:\n    [x - 1,\n     x^6 + 3*x^5 + 258*x^4 + 511*x^3 + 3564*x^2 + 3309*x + 2347,\n     x^6 - 24*x^5 + 6126*x^4 - 312664*x^3 + 5407566*x^2 - 33643572*x + 95921443,\n     x^6 + 18*x^5 + 3366*x^4 + 82008*x^3 + 886962*x^2 - 840726*x + 5521647,\n     x^6 + 27*x^5 + 9579*x^4 + 623358*x^3 + 5060091*x^2 - 139224285*x + 880944177,\n     x^6 - 72*x^5 + 65286*x^4 - 10762768*x^3 + 473072922*x^2 - 2502686322*x + 54227921641]\nGot:\n    [x - 1,\n     x^6 - 45*x^5 + 6993*x^4 - 519048*x^3 + 8139204*x^2 + 64936080*x + 394386192,\n     x^6 + 3*x^5 + 258*x^4 + 511*x^3 + 3564*x^2 + 3309*x + 2347,\n     x^6 - 12*x^5 + 459*x^4 - 13068*x^3 + 171423*x^2 - 1008720*x + 2218941,\n     x^6 - 72*x^5 + 21618*x^4 - 2725154*x^3 + 96844941*x^2 - 367602102*x + 5299367596,\n     x^6 - 36*x^5 + 4104*x^4 - 225746*x^3 + 4831632*x^2 - 39603546*x + 130361299]\n**********************************************************************\n```",
    "created_at": "2018-01-12T14:00:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105085",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:23'></a>The patchbot reports a failure on 32-bit:

```
sage -t --long src/sage/rings/number_field/number_field.py
**********************************************************************
File "src/sage/rings/number_field/number_field.py", line 5599, in sage.rings.number_field.number_field.NumberField_generic.reduced_basis
Failed example:
    [c.minpoly() for c in new_basis]
Expected:
    [x - 1,
     x^6 + 3*x^5 + 258*x^4 + 511*x^3 + 3564*x^2 + 3309*x + 2347,
     x^6 - 24*x^5 + 6126*x^4 - 312664*x^3 + 5407566*x^2 - 33643572*x + 95921443,
     x^6 + 18*x^5 + 3366*x^4 + 82008*x^3 + 886962*x^2 - 840726*x + 5521647,
     x^6 + 27*x^5 + 9579*x^4 + 623358*x^3 + 5060091*x^2 - 139224285*x + 880944177,
     x^6 - 72*x^5 + 65286*x^4 - 10762768*x^3 + 473072922*x^2 - 2502686322*x + 54227921641]
Got:
    [x - 1,
     x^6 - 45*x^5 + 6993*x^4 - 519048*x^3 + 8139204*x^2 + 64936080*x + 394386192,
     x^6 + 3*x^5 + 258*x^4 + 511*x^3 + 3564*x^2 + 3309*x + 2347,
     x^6 - 12*x^5 + 459*x^4 - 13068*x^3 + 171423*x^2 - 1008720*x + 2218941,
     x^6 - 72*x^5 + 21618*x^4 - 2725154*x^3 + 96844941*x^2 - 367602102*x + 5299367596,
     x^6 - 36*x^5 + 4104*x^4 - 225746*x^3 + 4831632*x^2 - 39603546*x + 130361299]
**********************************************************************
```



---

archive/issue_comments_105086.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-01-12T14:00:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105086",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_105087.json:
```json
{
    "body": "<a id='comment:24'></a>Would it be OK to tag the current output as 64-bit and this alternative as 32-bit?  Of course this \"reduced basis\" is in no way canonical.",
    "created_at": "2018-01-12T14:09:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105087",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:24'></a>Would it be OK to tag the current output as 64-bit and this alternative as 32-bit?  Of course this "reduced basis" is in no way canonical.



---

archive/issue_comments_105088.json:
```json
{
    "body": "<a id='comment:25'></a>let me check if the `prec` argument makes a difference.",
    "created_at": "2018-01-12T14:18:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105088",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:25'></a>let me check if the `prec` argument makes a difference.



---

archive/issue_comments_105089.json:
```json
{
    "body": "<a id='comment:26'></a>On 64-bit, the output stabilizes for `prec >= 117`; the result it\n\n```\n[x - 1,\n x^2 - x + 1,\n x^6 + 3*x^5 - 102*x^4 - 103*x^3 + 10572*x^2 - 59919*x + 127657,\n x^6 - 3*x^5 - 102*x^4 + 315*x^3 + 10254*x^2 - 80955*x + 198147,\n x^3 - 171*x + 848,\n x^6 + 171*x^4 + 1696*x^3 + 29241*x^2 + 145008*x + 719104]\n```",
    "created_at": "2018-01-12T14:21:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105089",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:26'></a>On 64-bit, the output stabilizes for `prec >= 117`; the result it

```
[x - 1,
 x^2 - x + 1,
 x^6 + 3*x^5 - 102*x^4 - 103*x^3 + 10572*x^2 - 59919*x + 127657,
 x^6 - 3*x^5 - 102*x^4 + 315*x^3 + 10254*x^2 - 80955*x + 198147,
 x^3 - 171*x + 848,
 x^6 + 171*x^4 + 1696*x^3 + 29241*x^2 + 145008*x + 719104]
```



---

archive/issue_comments_105090.json:
```json
{
    "body": "<a id='comment:27'></a>That's a lot better -- can you check if it's the same on 32-bit using the same prec (say 120)?",
    "created_at": "2018-01-12T14:22:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105090",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:27'></a>That's a lot better -- can you check if it's the same on 32-bit using the same prec (say 120)?



---

archive/issue_comments_105091.json:
```json
{
    "body": "<a id='comment:28'></a>Yes, on 32-bit I get the same result for `prec >= 68`.\n\nSo the best solution is increasing the `prec` in the doctest. While you're at it, could you please replace `k = NumberField(...,'a')` by `k.<a> = NumberField(...)`?",
    "created_at": "2018-01-12T14:54:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105091",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:28'></a>Yes, on 32-bit I get the same result for `prec >= 68`.

So the best solution is increasing the `prec` in the doctest. While you're at it, could you please replace `k = NumberField(...,'a')` by `k.<a> = NumberField(...)`?



---

archive/issue_comments_105092.json:
```json
{
    "body": "<a id='comment:29'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-01-16T14:32:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105092",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:29'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_105093.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-01-16T14:33:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105093",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_105094.json:
```json
{
    "body": "<a id='comment:30'></a>Apologies for the delay -- I pushed to u/cremona/20017 by mistake 4 days ago.  It's now where it should be.",
    "created_at": "2018-01-16T14:33:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105094",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:30'></a>Apologies for the delay -- I pushed to u/cremona/20017 by mistake 4 days ago.  It's now where it should be.



---

archive/issue_comments_105095.json:
```json
{
    "body": "<a id='comment:31'></a>OK, looks good but let's wait for the patchbot.",
    "created_at": "2018-01-16T14:36:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105095",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:31'></a>OK, looks good but let's wait for the patchbot.



---

archive/issue_comments_105096.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-01-18T09:59:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105096",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_105097.json:
```json
{
    "body": "<a id='comment:32'></a>Sorry to say this, but the branch doesn't merge cleanly...",
    "created_at": "2018-01-18T09:59:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105097",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:32'></a>Sorry to say this, but the branch doesn't merge cleanly...



---

archive/issue_comments_105098.json:
```json
{
    "body": "<a id='comment:33'></a>Replying to [comment:32 jdemeyer]:\n> Sorry to say this, but the branch doesn't merge cleanly...\n\n\nNot your fault!  I am just building the latest beta and will merge it with my branch shortly.",
    "created_at": "2018-01-18T11:40:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105098",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:33'></a>Replying to [comment:32 jdemeyer]:
> Sorry to say this, but the branch doesn't merge cleanly...


Not your fault!  I am just building the latest beta and will merge it with my branch shortly.



---

archive/issue_comments_105099.json:
```json
{
    "body": "<a id='comment:34'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-01-18T16:11:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105099",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:34'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_105100.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-01-18T16:12:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105100",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_105101.json:
```json
{
    "body": "<a id='comment:35'></a>OK, I merged, fixed the small conflict and a deprecation warning.  Let's see if the patchbots like this one better.",
    "created_at": "2018-01-18T16:12:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105101",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:35'></a>OK, I merged, fixed the small conflict and a deprecation warning.  Let's see if the patchbots like this one better.



---

archive/issue_comments_105102.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-01-18T21:14:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105102",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_025404.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-01-20T20:20:23Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10017#event-25404"
}
```



---

archive/issue_comments_105103.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-01-20T20:20:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10017",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10017#issuecomment-105103",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
