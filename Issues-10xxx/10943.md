# Issue 10943: Domain subdivision bugs in FanMorphism

archive/issues_010864.json:
```json
{
    "body": "For example:\n\n```\nsage: Sigma = Fan(rays=[(1,1,0), (1,-1,0)], cones=[(0,1)])\nsage: Sigma_prime = FaceFan(lattice_polytope.octahedron(3))\nsage: FanMorphism(identity_matrix(3), Sigma, Sigma_prime, subdivide=True, verbose=True)\nPlacing ray images... 0.841 ms\nComputing chambers... 0.806 ms\nSubdividing cone 1 of 1... 0.172 ms\nChecking for missing pieces... \nTraceback (most recent call last):\n...\nIndexError: list assignment index out of range\n```\nThe problem is that the source cone intersects four target ones, but there are only two different intersections.\n\nAnother issue:\n\n```\nsage: sigma = Cone([(0,1), (3,1)])\nsage: Sigma = Fan([sigma])\nsage: Sigma_s = Sigma.subdivide([(1,1), (2,1)])\nsage: FanMorphism(identity_matrix(2), Sigma, Sigma_s, subdivide=True)\nTraceback (most recent call last):\n...\nValueError: morphism defined by\n[1 0]\n[0 1]\ndoes not map\nRational polyhedral fan in 2-d lattice N\ninto the support of\nRational polyhedral fan in 2-d lattice N!\n```\nHere the problem is that one of the \"chambers\" is in the interior of the domain cone and none of its rays are in the chamber. The fix is to stop being very smart and honestly check intersections with all chambers.\n\nWhile working on fixes, I have also adjusted verbose printing to make it more informative.\n\nApply [attachment:trac_10943_subdivision_bugs_in_fan_morphism.patch] only!\n\nAssignee: @novoselt\n\nCC:  @vbraun\n\nResolution: fixed\n\nAuthor: Andrey Novoseltsev\n\nReviewer: Volker Braun\n\nMerged: sage-4.7.1.alpha1\n\nIssue created by migration from https://trac.sagemath.org/ticket/10943\n\n",
    "closed_at": "2011-05-27T12:01:58Z",
    "created_at": "2011-03-16T02:28:07Z",
    "labels": [
        "component: geometry",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.7.1",
    "title": "Domain subdivision bugs in FanMorphism",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10943",
    "user": "https://github.com/novoselt"
}
```
For example:

```
sage: Sigma = Fan(rays=[(1,1,0), (1,-1,0)], cones=[(0,1)])
sage: Sigma_prime = FaceFan(lattice_polytope.octahedron(3))
sage: FanMorphism(identity_matrix(3), Sigma, Sigma_prime, subdivide=True, verbose=True)
Placing ray images... 0.841 ms
Computing chambers... 0.806 ms
Subdividing cone 1 of 1... 0.172 ms
Checking for missing pieces... 
Traceback (most recent call last):
...
IndexError: list assignment index out of range
```
The problem is that the source cone intersects four target ones, but there are only two different intersections.

Another issue:

```
sage: sigma = Cone([(0,1), (3,1)])
sage: Sigma = Fan([sigma])
sage: Sigma_s = Sigma.subdivide([(1,1), (2,1)])
sage: FanMorphism(identity_matrix(2), Sigma, Sigma_s, subdivide=True)
Traceback (most recent call last):
...
ValueError: morphism defined by
[1 0]
[0 1]
does not map
Rational polyhedral fan in 2-d lattice N
into the support of
Rational polyhedral fan in 2-d lattice N!
```
Here the problem is that one of the "chambers" is in the interior of the domain cone and none of its rays are in the chamber. The fix is to stop being very smart and honestly check intersections with all chambers.

While working on fixes, I have also adjusted verbose printing to make it more informative.

Apply [attachment:trac_10943_subdivision_bugs_in_fan_morphism.patch] only!

Assignee: @novoselt

CC:  @vbraun

Resolution: fixed

Author: Andrey Novoseltsev

Reviewer: Volker Braun

Merged: sage-4.7.1.alpha1

Issue created by migration from https://trac.sagemath.org/ticket/10943





---

archive/issue_comments_121068.json:
```json
{
    "body": "Attachment [trac_10943_fan_morphism_non_full_dim_fan.patch](tarball://root/attachments/some-uuid/ticket10943/trac_10943_fan_morphism_non_full_dim_fan.patch) by @novoselt created at 2011-03-16 04:43:27",
    "created_at": "2011-03-16T04:43:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10943#issuecomment-121068",
    "user": "https://github.com/novoselt"
}
```

Attachment [trac_10943_fan_morphism_non_full_dim_fan.patch](tarball://root/attachments/some-uuid/ticket10943/trac_10943_fan_morphism_non_full_dim_fan.patch) by @novoselt created at 2011-03-16 04:43:27



---

archive/issue_comments_121069.json:
```json
{
    "body": "<a id='comment:1'></a>OK, I rewrote related code to make it a little more clear, but basically I just added check for repeated intersections.",
    "created_at": "2011-03-16T04:46:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10943#issuecomment-121069",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:1'></a>OK, I rewrote related code to make it a little more clear, but basically I just added check for repeated intersections.



---

archive/issue_comments_121070.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-03-16T04:46:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10943#issuecomment-121070",
    "user": "https://github.com/novoselt"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_121071.json:
```json
{
    "body": "Changing assignee from mhampton to @novoselt.",
    "created_at": "2011-03-20T19:14:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10943#issuecomment-121071",
    "user": "https://github.com/novoselt"
}
```

Changing assignee from mhampton to @novoselt.



---

archive/issue_comments_121072.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -12,9 +12,28 @@\n ...\n IndexError: list assignment index out of range\n \\`\\`\\`\n-The problem is that the source cone intersects four target ones, but there are only two different intersections. I will post a fix soon.\n+The problem is that the source cone intersects four target ones, but there are only two different intersections.\n \n-Assignee: mhampton\n+Another issue:\n+\n+\\`\\`\\`\n+sage: sigma = Cone([(0,1), (3,1)])\n+sage: Sigma = Fan([sigma])\n+sage: Sigma_s = Sigma.subdivide([(1,1), (2,1)])\n+sage: FanMorphism(identity_matrix(2), Sigma, Sigma_s, subdivide=True)\n+Traceback (most recent call last):\n+...\n+ValueError: morphism defined by\n+[1 0]\n+[0 1]\n+does not map\n+Rational polyhedral fan in 2-d lattice N\n+into the support of\n+Rational polyhedral fan in 2-d lattice N!\n+\\`\\`\\`\n+Here the problem is that one of the \"chambers\" is in the interior of the domain cone and none of its rays are in the chamber. The fix is to stop being very smart and honestly check intersections with all chambers.\n+\n+While working on fixes, I have also adjusted verbose printing to make it more informative.\n \n Author: Andrey Novoseltsev\n \n```\n",
    "created_at": "2011-03-20T19:14:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10943#issuecomment-121072",
    "user": "https://github.com/novoselt"
}
```

Description changed:
```diff
--- 
+++ 
@@ -12,9 +12,28 @@
 ...
 IndexError: list assignment index out of range
 \`\`\`
-The problem is that the source cone intersects four target ones, but there are only two different intersections. I will post a fix soon.
+The problem is that the source cone intersects four target ones, but there are only two different intersections.
 
-Assignee: mhampton
+Another issue:
+
+\`\`\`
+sage: sigma = Cone([(0,1), (3,1)])
+sage: Sigma = Fan([sigma])
+sage: Sigma_s = Sigma.subdivide([(1,1), (2,1)])
+sage: FanMorphism(identity_matrix(2), Sigma, Sigma_s, subdivide=True)
+Traceback (most recent call last):
+...
+ValueError: morphism defined by
+[1 0]
+[0 1]
+does not map
+Rational polyhedral fan in 2-d lattice N
+into the support of
+Rational polyhedral fan in 2-d lattice N!
+\`\`\`
+Here the problem is that one of the "chambers" is in the interior of the domain cone and none of its rays are in the chamber. The fix is to stop being very smart and honestly check intersections with all chambers.
+
+While working on fixes, I have also adjusted verbose printing to make it more informative.
 
 Author: Andrey Novoseltsev
 
```




---

archive/issue_comments_121073.json:
```json
{
    "body": "Attachment [trac_10943_subdivision_bugs_in_fan_morphism.patch](tarball://root/attachments/some-uuid/ticket10943/trac_10943_subdivision_bugs_in_fan_morphism.patch) by @novoselt created at 2011-03-20 19:15:19\n\nApply this patch only",
    "created_at": "2011-03-20T19:15:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10943#issuecomment-121073",
    "user": "https://github.com/novoselt"
}
```

Attachment [trac_10943_subdivision_bugs_in_fan_morphism.patch](tarball://root/attachments/some-uuid/ticket10943/trac_10943_subdivision_bugs_in_fan_morphism.patch) by @novoselt created at 2011-03-20 19:15:19

Apply this patch only



---

archive/issue_comments_121074.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-05-05T11:31:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10943#issuecomment-121074",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_121075.json:
```json
{
    "body": "<a id='comment:3'></a>Looks good!",
    "created_at": "2011-05-05T11:31:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10943#issuecomment-121075",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:3'></a>Looks good!



---

archive/issue_comments_121076.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,41 @@\n+For example:\n \n+\\`\\`\\`\n+sage: Sigma = Fan(rays=[(1,1,0), (1,-1,0)], cones=[(0,1)])\n+sage: Sigma_prime = FaceFan(lattice_polytope.octahedron(3))\n+sage: FanMorphism(identity_matrix(3), Sigma, Sigma_prime, subdivide=True, verbose=True)\n+Placing ray images... 0.841 ms\n+Computing chambers... 0.806 ms\n+Subdividing cone 1 of 1... 0.172 ms\n+Checking for missing pieces... \n+Traceback (most recent call last):\n+...\n+IndexError: list assignment index out of range\n+\\`\\`\\`\n+The problem is that the source cone intersects four target ones, but there are only two different intersections.\n+\n+Another issue:\n+\n+\\`\\`\\`\n+sage: sigma = Cone([(0,1), (3,1)])\n+sage: Sigma = Fan([sigma])\n+sage: Sigma_s = Sigma.subdivide([(1,1), (2,1)])\n+sage: FanMorphism(identity_matrix(2), Sigma, Sigma_s, subdivide=True)\n+Traceback (most recent call last):\n+...\n+ValueError: morphism defined by\n+[1 0]\n+[0 1]\n+does not map\n+Rational polyhedral fan in 2-d lattice N\n+into the support of\n+Rational polyhedral fan in 2-d lattice N!\n+\\`\\`\\`\n+Here the problem is that one of the \"chambers\" is in the interior of the domain cone and none of its rays are in the chamber. The fix is to stop being very smart and honestly check intersections with all chambers.\n+\n+While working on fixes, I have also adjusted verbose printing to make it more informative.\n+\n+Apply trac_10943_subdivision_bugs_in_fan_morphism.patch only!\n \n Author: Andrey Novoseltsev\n \n```\n",
    "created_at": "2011-05-05T11:31:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10943#issuecomment-121076",
    "user": "https://github.com/vbraun"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,41 @@
+For example:
 
+\`\`\`
+sage: Sigma = Fan(rays=[(1,1,0), (1,-1,0)], cones=[(0,1)])
+sage: Sigma_prime = FaceFan(lattice_polytope.octahedron(3))
+sage: FanMorphism(identity_matrix(3), Sigma, Sigma_prime, subdivide=True, verbose=True)
+Placing ray images... 0.841 ms
+Computing chambers... 0.806 ms
+Subdividing cone 1 of 1... 0.172 ms
+Checking for missing pieces... 
+Traceback (most recent call last):
+...
+IndexError: list assignment index out of range
+\`\`\`
+The problem is that the source cone intersects four target ones, but there are only two different intersections.
+
+Another issue:
+
+\`\`\`
+sage: sigma = Cone([(0,1), (3,1)])
+sage: Sigma = Fan([sigma])
+sage: Sigma_s = Sigma.subdivide([(1,1), (2,1)])
+sage: FanMorphism(identity_matrix(2), Sigma, Sigma_s, subdivide=True)
+Traceback (most recent call last):
+...
+ValueError: morphism defined by
+[1 0]
+[0 1]
+does not map
+Rational polyhedral fan in 2-d lattice N
+into the support of
+Rational polyhedral fan in 2-d lattice N!
+\`\`\`
+Here the problem is that one of the "chambers" is in the interior of the domain cone and none of its rays are in the chamber. The fix is to stop being very smart and honestly check intersections with all chambers.
+
+While working on fixes, I have also adjusted verbose printing to make it more informative.
+
+Apply trac_10943_subdivision_bugs_in_fan_morphism.patch only!
 
 Author: Andrey Novoseltsev
 
```




---

archive/issue_comments_121077.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,41 @@\n+For example:\n \n+\\`\\`\\`\n+sage: Sigma = Fan(rays=[(1,1,0), (1,-1,0)], cones=[(0,1)])\n+sage: Sigma_prime = FaceFan(lattice_polytope.octahedron(3))\n+sage: FanMorphism(identity_matrix(3), Sigma, Sigma_prime, subdivide=True, verbose=True)\n+Placing ray images... 0.841 ms\n+Computing chambers... 0.806 ms\n+Subdividing cone 1 of 1... 0.172 ms\n+Checking for missing pieces... \n+Traceback (most recent call last):\n+...\n+IndexError: list assignment index out of range\n+\\`\\`\\`\n+The problem is that the source cone intersects four target ones, but there are only two different intersections.\n+\n+Another issue:\n+\n+\\`\\`\\`\n+sage: sigma = Cone([(0,1), (3,1)])\n+sage: Sigma = Fan([sigma])\n+sage: Sigma_s = Sigma.subdivide([(1,1), (2,1)])\n+sage: FanMorphism(identity_matrix(2), Sigma, Sigma_s, subdivide=True)\n+Traceback (most recent call last):\n+...\n+ValueError: morphism defined by\n+[1 0]\n+[0 1]\n+does not map\n+Rational polyhedral fan in 2-d lattice N\n+into the support of\n+Rational polyhedral fan in 2-d lattice N!\n+\\`\\`\\`\n+Here the problem is that one of the \"chambers\" is in the interior of the domain cone and none of its rays are in the chamber. The fix is to stop being very smart and honestly check intersections with all chambers.\n+\n+While working on fixes, I have also adjusted verbose printing to make it more informative.\n+\n+Apply [attachment:trac_10943_subdivision_bugs_in_fan_morphism.patch] only!\n \n Author: Andrey Novoseltsev\n \n```\n",
    "created_at": "2011-05-05T11:32:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10943#issuecomment-121077",
    "user": "https://github.com/vbraun"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,41 @@
+For example:
 
+\`\`\`
+sage: Sigma = Fan(rays=[(1,1,0), (1,-1,0)], cones=[(0,1)])
+sage: Sigma_prime = FaceFan(lattice_polytope.octahedron(3))
+sage: FanMorphism(identity_matrix(3), Sigma, Sigma_prime, subdivide=True, verbose=True)
+Placing ray images... 0.841 ms
+Computing chambers... 0.806 ms
+Subdividing cone 1 of 1... 0.172 ms
+Checking for missing pieces... 
+Traceback (most recent call last):
+...
+IndexError: list assignment index out of range
+\`\`\`
+The problem is that the source cone intersects four target ones, but there are only two different intersections.
+
+Another issue:
+
+\`\`\`
+sage: sigma = Cone([(0,1), (3,1)])
+sage: Sigma = Fan([sigma])
+sage: Sigma_s = Sigma.subdivide([(1,1), (2,1)])
+sage: FanMorphism(identity_matrix(2), Sigma, Sigma_s, subdivide=True)
+Traceback (most recent call last):
+...
+ValueError: morphism defined by
+[1 0]
+[0 1]
+does not map
+Rational polyhedral fan in 2-d lattice N
+into the support of
+Rational polyhedral fan in 2-d lattice N!
+\`\`\`
+Here the problem is that one of the "chambers" is in the interior of the domain cone and none of its rays are in the chamber. The fix is to stop being very smart and honestly check intersections with all chambers.
+
+While working on fixes, I have also adjusted verbose printing to make it more informative.
+
+Apply [attachment:trac_10943_subdivision_bugs_in_fan_morphism.patch] only!
 
 Author: Andrey Novoseltsev
 
```




---

archive/issue_events_028343.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-05-05T11:55:46Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10943",
    "milestone": "sage-4.7.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10943#event-28343"
}
```



---

archive/issue_events_028344.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-05-27T12:01:58Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/10943",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10943#event-28344"
}
```



---

archive/issue_comments_121078.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-05-27T12:01:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10943#issuecomment-121078",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
