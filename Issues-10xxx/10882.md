# Issue 10882: Add kernel fan to fan morphism

archive/issues_010811.json:
```json
{
    "assignees": [
        "https://github.com/sagetrac-mhampton"
    ],
    "body": "The attached patch adds `preimage_fan(cone)` and `kernel_fan` methods to `FanMorphism` class.\n\nApply [attachment: trac_10882_kernel_fan.patch](https://github.com/sagemath/sage/files/ticket10882/trac_10882_kernel_fan.patch.gz)\n\nDepends on #10140\n\nCC:  @vbraun\n\nKeywords: **toric geometry**\n\nComponent: **geometry**\n\nAuthor: **Andrey Novoseltsev**\n\nReviewer: **Volker Braun**\n\nMerged: **sage-4.7.1.alpha1**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/10882_\n\n",
    "closed_at": "2011-05-27T12:01:46Z",
    "created_at": "2011-03-06T05:06:01Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20geometry",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/enhancement",
        "https://github.com/sagemath/sage/labels/c%3A%20geometry"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-4.7.1",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Add kernel fan to fan morphism",
    "type": "issue",
    "updated_at": "2011-05-27T12:01:46Z",
    "url": "https://github.com/sagemath/sage/issues/10882",
    "user": "https://github.com/novoselt"
}
```
The attached patch adds `preimage_fan(cone)` and `kernel_fan` methods to `FanMorphism` class.

Apply [attachment: trac_10882_kernel_fan.patch](https://github.com/sagemath/sage/files/ticket10882/trac_10882_kernel_fan.patch.gz)

Depends on #10140

CC:  @vbraun

Keywords: **toric geometry**

Component: **geometry**

Author: **Andrey Novoseltsev**

Reviewer: **Volker Braun**

Merged: **sage-4.7.1.alpha1**

_Issue created by migration from https://trac.sagemath.org/ticket/10882_





---

archive/issue_events_142816.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2011-03-06T05:06:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/10882",
    "milestone_number": null,
    "milestone_title": "sage-4.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10882#event-142816"
}
```



---

archive/issue_events_142817.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2011-03-06T05:06:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10882",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20geometry",
    "label_color": "0000ff",
    "label_name": "c: geometry",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10882#event-142817"
}
```



---

archive/issue_events_142818.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2011-03-06T05:06:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10882",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10882#event-142818"
}
```



---

archive/issue_events_142819.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2011-03-06T05:06:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10882",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10882#event-142819"
}
```



---

archive/issue_events_142820.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2011-03-06T05:06:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10882",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20geometry",
    "label_color": "0000ff",
    "label_name": "c: geometry",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10882#event-142820"
}
```



---

archive/issue_events_142821.json:
```json
{
    "actor": "https://github.com/sagetrac-mhampton",
    "created_at": "2011-03-06T05:06:01Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/10882",
    "subject": "https://github.com/novoselt",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10882#event-142821"
}
```



---

archive/issue_comments_105402.json:
```json
{
    "body": "Work Issues: **degenerate cases**",
    "created_at": "2011-03-06T05:23:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10882#issuecomment-105402",
    "user": "https://github.com/novoselt"
}
```

Work Issues: **degenerate cases**



---

archive/issue_comments_105403.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nHi Volker,\n\nThe patch is quite easy, as `preimage_cones` were already implemented, but in order to make everything shiny it would be nice to improve handling of degenerate cases. For this I need to resolve the situation with trivial fans, namely: is an empty set a fan, or it must include at least the origin? Fulton and Cox-Little-Schenck don't mention it explicitly, but from the point of view of nice correspondence to toric varieties it seems that completely empty fans should be prohibited as they seem to correspond to empty varieties, but then they don't really contain a torus.\n\nRight now it is possible in Sage to create a fan without cones, I propose to automatically add the origin of the provided lattice in this case and treat it as the generating cone. Any objections?\n\nRegarding `preimage_fans(cone)` it would imply that usually it is generated by `preimage_cones(cone)`, but some of them maybe unnecessary for generation (e.g. in the case of blow-up, described in the documentation), i.e. generating cones of `preimage_fan(cone)` are a subset of `preimage_cones(cone)`. However, if `preimage_cones(cone)` is empty, then `preimage_fan(cone)` will have an \"extra\" generating cone, namely the origin.",
    "created_at": "2011-03-06T05:23:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10882#issuecomment-105403",
    "user": "https://github.com/novoselt"
}
```

<div id="comment:1" align="right">comment:1</div>

Hi Volker,

The patch is quite easy, as `preimage_cones` were already implemented, but in order to make everything shiny it would be nice to improve handling of degenerate cases. For this I need to resolve the situation with trivial fans, namely: is an empty set a fan, or it must include at least the origin? Fulton and Cox-Little-Schenck don't mention it explicitly, but from the point of view of nice correspondence to toric varieties it seems that completely empty fans should be prohibited as they seem to correspond to empty varieties, but then they don't really contain a torus.

Right now it is possible in Sage to create a fan without cones, I propose to automatically add the origin of the provided lattice in this case and treat it as the generating cone. Any objections?

Regarding `preimage_fans(cone)` it would imply that usually it is generated by `preimage_cones(cone)`, but some of them maybe unnecessary for generation (e.g. in the case of blow-up, described in the documentation), i.e. generating cones of `preimage_fan(cone)` are a subset of `preimage_cones(cone)`. However, if `preimage_cones(cone)` is empty, then `preimage_fan(cone)` will have an "extra" generating cone, namely the origin.



---

archive/issue_events_142822.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2011-03-06T05:23:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10882",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10882#event-142822"
}
```



---

archive/issue_comments_105404.json:
```json
{
    "body": "Changed work issues from **degenerate cases** to none",
    "created_at": "2011-03-07T03:02:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10882#issuecomment-105404",
    "user": "https://github.com/novoselt"
}
```

Changed work issues from **degenerate cases** to none



---

archive/issue_comments_105405.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nAfter some thinking, I have decided to make `kernel_fan` live in the kernel sublattice. The drawback is that currently sublattices don't work extremely well as ambient ones for cones and fans, but that should eventually change. I have made some changes improving the situation, but dual objects still don't work and so one cannot ask for cones of this kernel fan (the doctest is marked as not tested). I propose to include it nevertheless, since the constructed fan is still correct and will be completely functional once other part are improved. (And the \"old\" version is still available as explicit `preimage_fan` of the origin.)\n\nI have also tweaked the fan constructor a little to ensure adding at least the origin cone and allowing one to specify the fan lattice which is different then cone lattices, as long as it is possible to do the conversion:\n\n```\nsage: P2 = toric_varieties.P2()\nsage: f = P2.fan()\nsage: f\nRational polyhedral fan in 2-d lattice N\nsage: Fan(f.generating_cones())                             \nRational polyhedral fan in 2-d lattice N\nsage: Fan(f.generating_cones(), lattice=f.lattice().dual())\nRational polyhedral fan in 2-d lattice M\n```\nIf the lattice is not given explicitly, no conversion will be made and all cones must belong to the same lattice. But giving the lattice explicitly may be quite handy for switching between lattices/sublattices/quotients and the above example with \"switching to dual\" is sometimes used when one wants to compare fans of polar polytopes and think of them as fans in the same lattice.\n\nReady for review!",
    "created_at": "2011-03-07T03:02:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10882#issuecomment-105405",
    "user": "https://github.com/novoselt"
}
```

<div id="comment:2" align="right">comment:2</div>

After some thinking, I have decided to make `kernel_fan` live in the kernel sublattice. The drawback is that currently sublattices don't work extremely well as ambient ones for cones and fans, but that should eventually change. I have made some changes improving the situation, but dual objects still don't work and so one cannot ask for cones of this kernel fan (the doctest is marked as not tested). I propose to include it nevertheless, since the constructed fan is still correct and will be completely functional once other part are improved. (And the "old" version is still available as explicit `preimage_fan` of the origin.)

I have also tweaked the fan constructor a little to ensure adding at least the origin cone and allowing one to specify the fan lattice which is different then cone lattices, as long as it is possible to do the conversion:

```
sage: P2 = toric_varieties.P2()
sage: f = P2.fan()
sage: f
Rational polyhedral fan in 2-d lattice N
sage: Fan(f.generating_cones())                             
Rational polyhedral fan in 2-d lattice N
sage: Fan(f.generating_cones(), lattice=f.lattice().dual())
Rational polyhedral fan in 2-d lattice M
```
If the lattice is not given explicitly, no conversion will be made and all cones must belong to the same lattice. But giving the lattice explicitly may be quite handy for switching between lattices/sublattices/quotients and the above example with "switching to dual" is sometimes used when one wants to compare fans of polar polytopes and think of them as fans in the same lattice.

Ready for review!



---

archive/issue_events_142823.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2011-03-07T03:05:55Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10882",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10882#event-142823"
}
```



---

archive/issue_events_142824.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2011-03-07T03:05:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10882",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10882#event-142824"
}
```



---

archive/issue_comments_105406.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nSeems to apply cleanly on Sage-4.6.2 without anything else.",
    "created_at": "2011-03-07T03:05:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10882#issuecomment-105406",
    "user": "https://github.com/novoselt"
}
```

<div id="comment:3" align="right">comment:3</div>

Seems to apply cleanly on Sage-4.6.2 without anything else.



---

archive/issue_events_142825.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2011-04-06T04:27:54Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10882",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10882#event-142825"
}
```



---

archive/issue_events_142826.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2011-04-06T04:27:54Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10882",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10882#event-142826"
}
```



---

archive/issue_comments_105407.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nI am having second thoughts about preimage fans: shouldn't they be full fans that are mapped into a given cone? Rather then be generated by cones whose relative interior is mapped into the relative interior of the given one. I am convinced now that `preimage_cones` does the correct thing, but for `preimage_fan` it seems a bit weird.\n\nThe reason why I didn't think enough about it before is that for the moment I only needed the kernel fan where both approaches give the same result.",
    "created_at": "2011-04-06T04:27:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10882#issuecomment-105407",
    "user": "https://github.com/novoselt"
}
```

<div id="comment:4" align="right">comment:4</div>

I am having second thoughts about preimage fans: shouldn't they be full fans that are mapped into a given cone? Rather then be generated by cones whose relative interior is mapped into the relative interior of the given one. I am convinced now that `preimage_cones` does the correct thing, but for `preimage_fan` it seems a bit weird.

The reason why I didn't think enough about it before is that for the moment I only needed the kernel fan where both approaches give the same result.



---

archive/issue_comments_105408.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nRebased the patch on top of new PPL interface and implemented the change in the above comment: the preimage fan consists of all cones mapped into the given one, no matter whether they are its preimage cones or not. Ready for review once again!",
    "created_at": "2011-04-24T19:00:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10882#issuecomment-105408",
    "user": "https://github.com/novoselt"
}
```

<div id="comment:5" align="right">comment:5</div>

Rebased the patch on top of new PPL interface and implemented the change in the above comment: the preimage fan consists of all cones mapped into the given one, no matter whether they are its preimage cones or not. Ready for review once again!



---

archive/issue_events_142827.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2011-04-24T19:00:13Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10882",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10882#event-142827"
}
```



---

archive/issue_events_142828.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2011-04-24T19:00:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10882",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10882#event-142828"
}
```



---

archive/issue_comments_105409.json:
```json
{
    "body": "Dependencies: **#10140**",
    "created_at": "2011-04-24T19:00:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10882#issuecomment-105409",
    "user": "https://github.com/novoselt"
}
```

Dependencies: **#10140**



---

archive/issue_comments_105410.json:
```json
{
    "body": "Attachment: **[trac_10882_kernel_fan.patch.gz](https://github.com/sagemath/sage/files/ticket10882/trac_10882_kernel_fan.patch.gz)**",
    "created_at": "2011-04-24T19:00:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10882#issuecomment-105410",
    "user": "https://github.com/novoselt"
}
```

Attachment: **[trac_10882_kernel_fan.patch.gz](https://github.com/sagemath/sage/files/ticket10882/trac_10882_kernel_fan.patch.gz)**



---

archive/issue_events_142829.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-05-05T12:45:47Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10882",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10882#event-142829"
}
```



---

archive/issue_events_142830.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-05-05T12:45:47Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10882",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10882#event-142830"
}
```



---

archive/issue_comments_105411.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nI agree with the definitions. Looks good to me!",
    "created_at": "2011-05-05T12:45:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10882#issuecomment-105411",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:6" align="right">comment:6</div>

I agree with the definitions. Looks good to me!



---

archive/issue_events_142831.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-05-05T12:45:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/10882",
    "milestone_number": null,
    "milestone_title": "sage-4.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10882#event-142831"
}
```



---

archive/issue_events_142832.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-05-05T12:45:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/10882",
    "milestone_number": null,
    "milestone_title": "sage-4.7.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10882#event-142832"
}
```



---

archive/issue_comments_105412.json:
```json
{
    "body": "Reviewer: **Volker Braun**",
    "created_at": "2011-05-05T12:45:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10882#issuecomment-105412",
    "user": "https://github.com/vbraun"
}
```

Reviewer: **Volker Braun**



---

archive/issue_comments_105413.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,3 @@\n The attached patch adds `preimage_fan(cone)` and `kernel_fan` methods to `FanMorphism` class.\n+\n+Apply [attachment: trac_10882_kernel_fan.patch](https://github.com/sagemath/sage/files/ticket10882/trac_10882_kernel_fan.patch.gz)\n``````\n",
    "created_at": "2011-05-05T12:46:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10882#issuecomment-105413",
    "user": "https://github.com/vbraun"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,3 @@
 The attached patch adds `preimage_fan(cone)` and `kernel_fan` methods to `FanMorphism` class.
+
+Apply [attachment: trac_10882_kernel_fan.patch](https://github.com/sagemath/sage/files/ticket10882/trac_10882_kernel_fan.patch.gz)
``````




---

archive/issue_comments_105414.json:
```json
{
    "body": "Merged: **sage-4.7.1.alpha1**",
    "created_at": "2011-05-27T12:01:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10882#issuecomment-105414",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-4.7.1.alpha1**



---

archive/issue_events_142833.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-05-27T12:01:46Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10882",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10882#event-142833"
}
```



---

archive/issue_events_142834.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-05-27T12:01:46Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/10882",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10882#event-142834"
}
```
