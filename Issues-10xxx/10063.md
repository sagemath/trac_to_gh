# Issue 10063: Some determinants can not be computed

archive/issues_010062.json:
```json
{
    "assignees": [
        "https://github.com/sagetrac-tmonteil"
    ],
    "body": "To use some fast algorithms that only work for fields, the `determinant` method uses the `is_field` method for rings which uses the `is_maximal` method for ideals. Unfortunately, this method is not always implemented.\n\nThe determinant is a very fundamental function, and there are many division-free algorithms that work in every ring, hence this method should never raise an error.\n\nHere is an example of the bug i encountered while testing a conjecture in combinatorics:\n\n```\nsage: A = GF(2)['x,y,z']                                                                                \nsage: A.inject_variables()                                                                              \nDefining x, y, z\nsage: R = A.quotient(x^2 + 1).quotient(y^2 + 1).quotient(z^2 + 1)                                       \nsage: R.inject_variables()                                                                              \nDefining xbarbarbar, ybarbarbar, zbarbarbar\nsage: M = matrix([[1,1,1,1],[xbarbarbar,ybarbarbar,1,1],[0,1,zbarbarbar,1],[xbarbarbar,zbarbarbar,1,1]])\nsage: M.determinant()\n---------------------------------------------------------------------------\nNotImplementedError                       Traceback (most recent call last)\n\n/tmp/<ipython console> in <module>()\n\n/opt/sagemath/sage-4.5.3/local/lib/python2.6/site-packages/sage/matrix/matrix2.so in sage.matrix.matrix2.Matrix.determinant (sage/matrix/matrix2.c:6942)()\n   1092         # TODO: Find a reasonable cutoff point.  (This is field specific, but\n   1093         # seems to be quite large for Q[x].)\n-> 1094         if (R.is_field() and R.is_exact() and algorithm is None) or (algorithm == \"hessenberg\"):\n   1095             try:\n   1096                 c = self.charpoly('x', algorithm=\"hessenberg\")[0]\n\n/opt/sagemath/sage-4.5.3/local/lib/python2.6/site-packages/sage/rings/quotient_ring.pyc in is_field(self, proof)\n    420         \"\"\"\n    421         if proof:\n--> 422             return self.defining_ideal().is_maximal()\n    423         else:\n    424             try:\n\n/opt/sagemath/sage-4.5.3/local/lib/python2.6/site-packages/sage/rings/ideal.pyc in is_maximal(self)\n    559             NotImplementedError\n    560         \"\"\"\n--> 561         raise NotImplementedError\n    562 \n    563     def is_primary(self, P=None):\n\nNotImplementedError: \n\n```\n\nA simple (maybe dirty) solution might be to add a `try` at the beginning of the method and an `except` that use a basic division-free formula in case of error.\n\nI am not an algebraist, so i prefer not to fix this bug by myself.\n\n\nCC:  @sagetrac-sage-combinat @sagetrac-spancratz @aghitza @nthiery @jasongrout\n\nKeywords: **determinant, ring, ideal**\n\nComponent: **commutative algebra**\n\nAuthor: **Thierry Monteil**\n\nReviewer: **Mike Hansen, S\u00e9bastien Labb\u00e9**\n\nMerged: **sage-4.6.1.alpha0**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/10063_\n\n",
    "closed_at": "2010-11-01T10:14:30Z",
    "created_at": "2010-10-03T16:45:32Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20commutative%20algebra",
        "https://github.com/sagemath/sage/labels/p%3A%202%20%E2%80%93%20critical",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-4.6.1",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Some determinants can not be computed",
    "type": "issue",
    "updated_at": "2010-11-01T10:14:30Z",
    "url": "https://github.com/sagemath/sage/issues/10063",
    "user": "https://github.com/sagetrac-tmonteil"
}
```
To use some fast algorithms that only work for fields, the `determinant` method uses the `is_field` method for rings which uses the `is_maximal` method for ideals. Unfortunately, this method is not always implemented.

The determinant is a very fundamental function, and there are many division-free algorithms that work in every ring, hence this method should never raise an error.

Here is an example of the bug i encountered while testing a conjecture in combinatorics:

```
sage: A = GF(2)['x,y,z']                                                                                
sage: A.inject_variables()                                                                              
Defining x, y, z
sage: R = A.quotient(x^2 + 1).quotient(y^2 + 1).quotient(z^2 + 1)                                       
sage: R.inject_variables()                                                                              
Defining xbarbarbar, ybarbarbar, zbarbarbar
sage: M = matrix([[1,1,1,1],[xbarbarbar,ybarbarbar,1,1],[0,1,zbarbarbar,1],[xbarbarbar,zbarbarbar,1,1]])
sage: M.determinant()
---------------------------------------------------------------------------
NotImplementedError                       Traceback (most recent call last)

/tmp/<ipython console> in <module>()

/opt/sagemath/sage-4.5.3/local/lib/python2.6/site-packages/sage/matrix/matrix2.so in sage.matrix.matrix2.Matrix.determinant (sage/matrix/matrix2.c:6942)()
   1092         # TODO: Find a reasonable cutoff point.  (This is field specific, but
   1093         # seems to be quite large for Q[x].)
-> 1094         if (R.is_field() and R.is_exact() and algorithm is None) or (algorithm == "hessenberg"):
   1095             try:
   1096                 c = self.charpoly('x', algorithm="hessenberg")[0]

/opt/sagemath/sage-4.5.3/local/lib/python2.6/site-packages/sage/rings/quotient_ring.pyc in is_field(self, proof)
    420         """
    421         if proof:
--> 422             return self.defining_ideal().is_maximal()
    423         else:
    424             try:

/opt/sagemath/sage-4.5.3/local/lib/python2.6/site-packages/sage/rings/ideal.pyc in is_maximal(self)
    559             NotImplementedError
    560         """
--> 561         raise NotImplementedError
    562 
    563     def is_primary(self, P=None):

NotImplementedError: 

```

A simple (maybe dirty) solution might be to add a `try` at the beginning of the method and an `except` that use a basic division-free formula in case of error.

I am not an algebraist, so i prefer not to fix this bug by myself.


CC:  @sagetrac-sage-combinat @sagetrac-spancratz @aghitza @nthiery @jasongrout

Keywords: **determinant, ring, ideal**

Component: **commutative algebra**

Author: **Thierry Monteil**

Reviewer: **Mike Hansen, Sébastien Labbé**

Merged: **sage-4.6.1.alpha0**

_Issue created by migration from https://trac.sagemath.org/ticket/10063_





---

archive/issue_events_132010.json:
```json
{
    "actor": "https://github.com/sagetrac-tmonteil",
    "created_at": "2010-10-03T16:45:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20algebra",
    "label_color": "0000ff",
    "label_name": "c: algebra",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10063#event-132010"
}
```



---

archive/issue_events_132011.json:
```json
{
    "actor": "https://github.com/sagetrac-tmonteil",
    "created_at": "2010-10-03T16:45:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "label": "https://github.com/sagemath/sage/labels/p%3A%202%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p: 2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10063#event-132011"
}
```



---

archive/issue_events_132012.json:
```json
{
    "actor": "https://github.com/sagetrac-tmonteil",
    "created_at": "2010-10-03T16:45:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10063#event-132012"
}
```



---

archive/issue_events_132013.json:
```json
{
    "actor": "https://github.com/aghitza",
    "created_at": "2010-10-03T16:45:32Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "subject": "https://github.com/sagetrac-tmonteil",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10063#event-132013"
}
```



---

archive/issue_comments_092320.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nHi Thierry!\n\nI already stumbled into similar annoyances. Adding an exception handling in order to fall back to the default division-free algorithm when Sage can't determine if the base ring is a field sounds very reasonable to me!\n\nCheers,\n             Nicolas",
    "created_at": "2010-10-03T20:32:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10063#issuecomment-92320",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:1" align="right">comment:1</div>

Hi Thierry!

I already stumbled into similar annoyances. Adding an exception handling in order to fall back to the default division-free algorithm when Sage can't determine if the base ring is a field sounds very reasonable to me!

Cheers,
             Nicolas



---

archive/issue_events_132014.json:
```json
{
    "actor": "https://github.com/sagetrac-tmonteil",
    "created_at": "2010-10-04T21:35:46Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20algebra",
    "label_color": "0000ff",
    "label_name": "c: algebra",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10063#event-132014"
}
```



---

archive/issue_events_132015.json:
```json
{
    "actor": "https://github.com/sagetrac-tmonteil",
    "created_at": "2010-10-04T21:35:46Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20commutative%20algebra",
    "label_color": "0000ff",
    "label_name": "c: commutative algebra",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10063#event-132015"
}
```



---

archive/issue_events_132016.json:
```json
{
    "actor": "https://github.com/aghitza",
    "created_at": "2010-10-04T21:35:46Z",
    "event": "unassigned",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "subject": "https://github.com/sagetrac-tmonteil",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10063#event-132016"
}
```



---

archive/issue_events_132017.json:
```json
{
    "actor": "https://github.com/sagetrac-tmonteil",
    "created_at": "2010-10-04T21:35:46Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "subject": "https://github.com/sagetrac-tmonteil",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10063#event-132017"
}
```



---

archive/issue_comments_092321.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nok, i will make a very basic (purely logical (a simple `try:` followed by `except:pass` works at least for my example)) patch for it, and add my example as a test for the determinant method.",
    "created_at": "2010-10-04T21:35:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10063#issuecomment-92321",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

<div id="comment:3" align="right">comment:3</div>

ok, i will make a very basic (purely logical (a simple `try:` followed by `except:pass` works at least for my example)) patch for it, and add my example as a test for the determinant method.



---

archive/issue_comments_092322.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nHere is a patch that fixes the problem. I also took the opportunity of this bugfix to accelerate the method a bit when the division-free algorithm `df` is explicitly chosen. For this, i changed the ordering in the `and` boolean expression: the method first test if the chosen algorithm in `None` before checking if the ring is a field.",
    "created_at": "2010-10-04T23:09:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10063#issuecomment-92322",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

<div id="comment:4" align="right">comment:4</div>

Here is a patch that fixes the problem. I also took the opportunity of this bugfix to accelerate the method a bit when the division-free algorithm `df` is explicitly chosen. For this, i changed the ordering in the `and` boolean expression: the method first test if the chosen algorithm in `None` before checking if the ring is a field.



---

archive/issue_events_132018.json:
```json
{
    "actor": "https://github.com/sagetrac-tmonteil",
    "created_at": "2010-10-04T23:16:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10063#event-132018"
}
```



---

archive/issue_comments_092323.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nWe don't want to put a bare \"except:\" clause since that will catch things like\u00a0KeyboardInterrupt\u00a0exceptions. \u00a0We should be explicit about the type of exceptions that we want to catch.",
    "created_at": "2010-10-04T23:23:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10063#issuecomment-92323",
    "user": "https://github.com/mwhansen"
}
```

<div id="comment:6" align="right">comment:6</div>

We don't want to put a bare "except:" clause since that will catch things like KeyboardInterrupt exceptions.  We should be explicit about the type of exceptions that we want to catch.



---

archive/issue_events_132019.json:
```json
{
    "actor": "https://github.com/mwhansen",
    "created_at": "2010-10-04T23:23:23Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10063#event-132019"
}
```



---

archive/issue_events_132020.json:
```json
{
    "actor": "https://github.com/mwhansen",
    "created_at": "2010-10-04T23:23:23Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10063#event-132020"
}
```



---

archive/issue_comments_092324.json:
```json
{
    "body": "Reviewer: **Mike Hansen**",
    "created_at": "2010-10-04T23:23:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10063#issuecomment-92324",
    "user": "https://github.com/mwhansen"
}
```

Reviewer: **Mike Hansen**



---

archive/issue_comments_092325.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nOk, since a general robust (division-free) algorithm follows, i thought any error could be corrected, i didn't thought to the KeyboardInterrupt exception. Thanks for the hint! I will be explicit about the type of exception.",
    "created_at": "2010-10-04T23:35:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10063#issuecomment-92325",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

<div id="comment:7" align="right">comment:7</div>

Ok, since a general robust (division-free) algorithm follows, i thought any error could be corrected, i didn't thought to the KeyboardInterrupt exception. Thanks for the hint! I will be explicit about the type of exception.



---

archive/issue_comments_092326.json:
```json
{
    "body": "Attachment: **[trac_10063-determinant_not_computed_in_some_rings_bugfix-tm.patch.gz](https://github.com/sagemath/sage/files/ticket10063/trac_10063-determinant_not_computed_in_some_rings_bugfix-tm.patch.gz)**\n\nTested on 4.5.3",
    "created_at": "2010-10-05T01:35:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10063#issuecomment-92326",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

Attachment: **[trac_10063-determinant_not_computed_in_some_rings_bugfix-tm.patch.gz](https://github.com/sagemath/sage/files/ticket10063/trac_10063-determinant_not_computed_in_some_rings_bugfix-tm.patch.gz)**

Tested on 4.5.3



---

archive/issue_comments_092327.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nOnly the `NotImplementedError` is catched now, so that the bug i found is still fixed.\n\nOther types of errors (possibly) arising from what is behind `is_field` or `is_exact` methods will not be catched (which is bad for the user, but good for debugging).\n\nSince both the patch and the modification are small, i replaced the existing patch by another one with the same name.",
    "created_at": "2010-10-05T02:10:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10063#issuecomment-92327",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

<div id="comment:8" align="right">comment:8</div>

Only the `NotImplementedError` is catched now, so that the bug i found is still fixed.

Other types of errors (possibly) arising from what is behind `is_field` or `is_exact` methods will not be catched (which is bad for the user, but good for debugging).

Since both the patch and the modification are small, i replaced the existing patch by another one with the same name.



---

archive/issue_comments_092328.json:
```json
{
    "body": "Author: **Thierry Monteil**",
    "created_at": "2010-10-05T02:10:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10063#issuecomment-92328",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

Author: **Thierry Monteil**



---

archive/issue_events_132021.json:
```json
{
    "actor": "https://github.com/sagetrac-tmonteil",
    "created_at": "2010-10-05T02:10:26Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10063#event-132021"
}
```



---

archive/issue_events_132022.json:
```json
{
    "actor": "https://github.com/sagetrac-tmonteil",
    "created_at": "2010-10-05T02:10:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10063#event-132022"
}
```



---

archive/issue_comments_092329.json:
```json
{
    "body": "Changed reviewer from **Mike Hansen** to **Mike Hansen, S\u00e9bastien Labb\u00e9**",
    "created_at": "2010-10-05T19:46:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10063#issuecomment-92329",
    "user": "https://github.com/seblabbe"
}
```

Changed reviewer from **Mike Hansen** to **Mike Hansen, Sébastien Labbé**



---

archive/issue_events_132023.json:
```json
{
    "actor": "https://github.com/seblabbe",
    "created_at": "2010-10-05T19:46:10Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10063#event-132023"
}
```



---

archive/issue_events_132024.json:
```json
{
    "actor": "https://github.com/seblabbe",
    "created_at": "2010-10-05T19:46:10Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10063#event-132024"
}
```



---

archive/issue_comments_092330.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nDear Thierry,\n\nYou included too much code inside of the try statement. You are \"trying\" a lot more than what is necessary, that is, `R.is_field()` in this case. From the [PEP0008](http://www.python.org/dev/peps/pep-0008/), cited in the Python coding conventions of the [Sage Developpers Guide](http://www.sagemath.org/doc/developer/conventions.html#python-coding-conventions), one can read :\n\n```\n    - Additionally, for all try/except clauses, limit the 'try' clause\n      to the absolute minimum amount of code necessary.  Again, this\n      avoids masking bugs.\n\n      Yes:\n\n          try:\n              value = collection[key]\n          except KeyError:\n              return key_not_found(key)\n          else:\n              return handle_value(value)\n\n      No:\n\n          try:\n              # Too broad!\n              return handle_value(collection[key])\n          except KeyError:\n              # Will also catch KeyError raised by handle_value()\n              return key_not_found(key)\n```\n\nHence, you could do something like :\n\n```\n    try:\n        R_is_field = R.is_field()\n    except NotImplementedError:\n        ...\n    \n    if (algorithm is None and R_is_field and blablablal) or ...:\n        ...\n```\n\nFinally, you need an empty line after the `::` for the documentation to build properly.\n\nHence, I change the status of this ticket to needs work.\n\nS\u00e9bastien",
    "created_at": "2010-10-05T19:46:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10063#issuecomment-92330",
    "user": "https://github.com/seblabbe"
}
```

<div id="comment:9" align="right">comment:9</div>

Dear Thierry,

You included too much code inside of the try statement. You are "trying" a lot more than what is necessary, that is, `R.is_field()` in this case. From the [PEP0008](http://www.python.org/dev/peps/pep-0008/), cited in the Python coding conventions of the [Sage Developpers Guide](http://www.sagemath.org/doc/developer/conventions.html#python-coding-conventions), one can read :

```
    - Additionally, for all try/except clauses, limit the 'try' clause
      to the absolute minimum amount of code necessary.  Again, this
      avoids masking bugs.

      Yes:

          try:
              value = collection[key]
          except KeyError:
              return key_not_found(key)
          else:
              return handle_value(value)

      No:

          try:
              # Too broad!
              return handle_value(collection[key])
          except KeyError:
              # Will also catch KeyError raised by handle_value()
              return key_not_found(key)
```

Hence, you could do something like :

```
    try:
        R_is_field = R.is_field()
    except NotImplementedError:
        ...
    
    if (algorithm is None and R_is_field and blablablal) or ...:
        ...
```

Finally, you need an empty line after the `::` for the documentation to build properly.

Hence, I change the status of this ticket to needs work.

Sébastien



---

archive/issue_comments_092331.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nHi Sebastien,\n\nthanks for your comments. As you know, i am not a computer scientist nor a programmer, so i do not know much about design principles, but if i had to code a determinant function from scratch, knowing that:\n* the determinant is an fundamental function\n* there exist a division-free algorithm that works in any case\n* there are some fast/fancy/pretty/lounge/fieldic... optimizations that are very good in some particular cases but not completely finished, i will have written a code like (even *before* meeting any bug):\n\n```\ntry:\n    all the kind of optimized algorithms\nexcept StandardError:\n    pass #or send an automatic bug report if the error seems new.\nthe division-free algorithm that always works\n```\n\nI do not feel it is a dirty code, since its structure shows that one algorithm works everywhere and the other are fragile optimizations.\n\nMaking patches that only repair the bugs found will make a code whose architecture depend on the history of the bugs discovery, not necessarily a readable code (why is there a test for the `is_field` method and not for `is_exact`,...).\n\nThe aim of the Python convention is to avoid masking bugs, but if the exception is `NotImplementedError`, then the \"bug\" is already known, since it means that someone wrote an empty method which raises this `NotImplementedError`.\n\nNote also that the Python convention is a bit slower since i have to test the `is_field` method even if the algorithm is not `None`. Should i replace: \n\n```\ntry:\n    R_is_field_attempt = R.is_field()\nexcept NotImplementedError:\n    R_is_field_attempt = False\n\n```\n\nby:\n\n```\nif algorithm is None:\n    try:\n        R_is_field_attempt = R.is_field()\n    except NotImplementedError:\n        R_is_field_attempt = False\n```\n\nin order to skip the test when another algorithm is is called?\n\nAnyway, here is a patch that implements your recommendations (i rename it to keep the previous version on the trac server and follow the discussion).\n\nI fixed the problem of the documentation as well (i took the opportunity to fix the existing test, which i copied).\n\nShould we think to clean the whole `determinant` code?",
    "created_at": "2010-10-06T00:02:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10063#issuecomment-92331",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

<div id="comment:10" align="right">comment:10</div>

Hi Sebastien,

thanks for your comments. As you know, i am not a computer scientist nor a programmer, so i do not know much about design principles, but if i had to code a determinant function from scratch, knowing that:
* the determinant is an fundamental function
* there exist a division-free algorithm that works in any case
* there are some fast/fancy/pretty/lounge/fieldic... optimizations that are very good in some particular cases but not completely finished, i will have written a code like (even *before* meeting any bug):

```
try:
    all the kind of optimized algorithms
except StandardError:
    pass #or send an automatic bug report if the error seems new.
the division-free algorithm that always works
```

I do not feel it is a dirty code, since its structure shows that one algorithm works everywhere and the other are fragile optimizations.

Making patches that only repair the bugs found will make a code whose architecture depend on the history of the bugs discovery, not necessarily a readable code (why is there a test for the `is_field` method and not for `is_exact`,...).

The aim of the Python convention is to avoid masking bugs, but if the exception is `NotImplementedError`, then the "bug" is already known, since it means that someone wrote an empty method which raises this `NotImplementedError`.

Note also that the Python convention is a bit slower since i have to test the `is_field` method even if the algorithm is not `None`. Should i replace: 

```
try:
    R_is_field_attempt = R.is_field()
except NotImplementedError:
    R_is_field_attempt = False

```

by:

```
if algorithm is None:
    try:
        R_is_field_attempt = R.is_field()
    except NotImplementedError:
        R_is_field_attempt = False
```

in order to skip the test when another algorithm is is called?

Anyway, here is a patch that implements your recommendations (i rename it to keep the previous version on the trac server and follow the discussion).

I fixed the problem of the documentation as well (i took the opportunity to fix the existing test, which i copied).

Should we think to clean the whole `determinant` code?



---

archive/issue_comments_092332.json:
```json
{
    "body": "Tested on 4.5.3",
    "created_at": "2010-10-06T00:03:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10063#issuecomment-92332",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

Tested on 4.5.3



---

archive/issue_comments_092333.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nAttachment: **[trac_10063-determinant_not_computed_in_some_rings_bugfix_attempt_3-tm.patch.gz](https://github.com/sagemath/sage/files/ticket10063/trac_10063-determinant_not_computed_in_some_rings_bugfix_attempt_3-tm.patch.gz)**\n\nIn this version, the `is_field` method is tested only if `algorithm` is not `None`. If another algorithm is chosen, the test is skipped to save some time.",
    "created_at": "2010-10-06T23:30:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10063#issuecomment-92333",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

<div id="comment:11" align="right">comment:11</div>

Attachment: **[trac_10063-determinant_not_computed_in_some_rings_bugfix_attempt_3-tm.patch.gz](https://github.com/sagemath/sage/files/ticket10063/trac_10063-determinant_not_computed_in_some_rings_bugfix_attempt_3-tm.patch.gz)**

In this version, the `is_field` method is tested only if `algorithm` is not `None`. If another algorithm is chosen, the test is skipped to save some time.



---

archive/issue_comments_092334.json:
```json
{
    "body": "Tested on 4.5.3",
    "created_at": "2010-10-06T23:30:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10063#issuecomment-92334",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

Tested on 4.5.3



---

archive/issue_comments_092335.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nAttachment: **[trac_10063-determinant_not_computed_in_some_rings_bugfix_attempt_4-tm.patch.gz](https://github.com/sagemath/sage/files/ticket10063/trac_10063-determinant_not_computed_in_some_rings_bugfix_attempt_4-tm.patch.gz)**\n\nA typo in the previous comment: the `is_field` method is tested only if `algorithm` **is** `None`.",
    "created_at": "2010-10-06T23:35:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10063#issuecomment-92335",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

<div id="comment:12" align="right">comment:12</div>

Attachment: **[trac_10063-determinant_not_computed_in_some_rings_bugfix_attempt_4-tm.patch.gz](https://github.com/sagemath/sage/files/ticket10063/trac_10063-determinant_not_computed_in_some_rings_bugfix_attempt_4-tm.patch.gz)**

A typo in the previous comment: the `is_field` method is tested only if `algorithm` **is** `None`.



---

archive/issue_events_132025.json:
```json
{
    "actor": "https://github.com/sagetrac-tmonteil",
    "created_at": "2010-10-06T23:35:38Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10063#event-132025"
}
```



---

archive/issue_events_132026.json:
```json
{
    "actor": "https://github.com/sagetrac-tmonteil",
    "created_at": "2010-10-06T23:35:38Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10063#event-132026"
}
```



---

archive/issue_comments_092336.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\n> Should we think to clean the whole `determinant` code?\n\nMaybe. I don't know. But, I don't feel I am the determinant expert that could rethink/refactor/improve that code.\n\nAlthough, I reviewed your most recent patch (` trac_10063-determinant_not_computed_in_some_rings_bugfix_attempt_4-tm.patch`).\n\nI was able to reproduce the problem on my computer. The problem is indeed fixed by the patch. All test passed in the repository `sage/matrix`. Documentation builds fine.\n\nThe problem originated from a `NotImplementedError` when computing `R.is_field()` in the case where `algorithm=None` (see below). So your new code instead tries to compute `R.is_field()` and if `R.is_field()` raises a `NotImplementedError` you consider this as `R.is_field() == False`. This computation is done only if algorithm is None so that the method doesn't get slower. You also followed my earlier advise, that is, the try statement only tries what is necessary.\n\nHence, from the knowledge I have, I am OK with giving a positive review to this ticket. Maybe Mike Hanson or Jason have comments, so I wait 24 hours, and then I will change the status to positive review.\n\nS\u00e9bastien\n\nPS : The `is_field` method is not implemented for the following ring (should we open a ticket for it?):\n\n```\nsage: A = GF(2)['x,y,z']\nsage: A.inject_variables()\nDefining x, y, z\nsage: R = A.quotient(x^2 + 1).quotient(y^2 + 1).quotient(z^2 + 1) \nsage: R.is_field()\nTraceback (most recent call last):\n\nNotImplementedError: \n```",
    "created_at": "2010-10-08T18:46:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10063#issuecomment-92336",
    "user": "https://github.com/seblabbe"
}
```

<div id="comment:14" align="right">comment:14</div>

> Should we think to clean the whole `determinant` code?

Maybe. I don't know. But, I don't feel I am the determinant expert that could rethink/refactor/improve that code.

Although, I reviewed your most recent patch (` trac_10063-determinant_not_computed_in_some_rings_bugfix_attempt_4-tm.patch`).

I was able to reproduce the problem on my computer. The problem is indeed fixed by the patch. All test passed in the repository `sage/matrix`. Documentation builds fine.

The problem originated from a `NotImplementedError` when computing `R.is_field()` in the case where `algorithm=None` (see below). So your new code instead tries to compute `R.is_field()` and if `R.is_field()` raises a `NotImplementedError` you consider this as `R.is_field() == False`. This computation is done only if algorithm is None so that the method doesn't get slower. You also followed my earlier advise, that is, the try statement only tries what is necessary.

Hence, from the knowledge I have, I am OK with giving a positive review to this ticket. Maybe Mike Hanson or Jason have comments, so I wait 24 hours, and then I will change the status to positive review.

Sébastien

PS : The `is_field` method is not implemented for the following ring (should we open a ticket for it?):

```
sage: A = GF(2)['x,y,z']
sage: A.inject_variables()
Defining x, y, z
sage: R = A.quotient(x^2 + 1).quotient(y^2 + 1).quotient(z^2 + 1) 
sage: R.is_field()
Traceback (most recent call last):

NotImplementedError: 
```



---

archive/issue_events_132027.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2010-10-12T10:25:10Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10063#event-132027"
}
```



---

archive/issue_events_132028.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2010-10-12T10:25:10Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10063#event-132028"
}
```



---

archive/issue_comments_092337.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nI did a full ptestlong against sage-4.6.alpha3, works fine.  Positive review considering the comments of S\u00e9bastien Labb\u00e9.",
    "created_at": "2010-10-12T10:25:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10063#issuecomment-92337",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:15" align="right">comment:15</div>

I did a full ptestlong against sage-4.6.alpha3, works fine.  Positive review considering the comments of Sébastien Labbé.



---

archive/issue_events_132029.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2010-10-12T10:25:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "milestone_number": null,
    "milestone_title": "sage-4.6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10063#event-132029"
}
```



---

archive/issue_events_132030.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2010-11-01T10:14:30Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10063#event-132030"
}
```



---

archive/issue_events_132031.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2010-11-01T10:14:30Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10063#event-132031"
}
```



---

archive/issue_comments_092338.json:
```json
{
    "body": "Merged: **sage-4.6.1.alpha0**",
    "created_at": "2010-11-01T10:14:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10063",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10063#issuecomment-92338",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-4.6.1.alpha0**
