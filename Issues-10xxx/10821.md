# Issue 10821: riemann.pyx gives lots of invalid value in divide warnings

archive/issues_010755.json:
```json
{
    "body": "I keep getting Warning: invalid value encountered in divide, and the error happens in these lines in the _generate_theta_array function in calculus/riemann.pyx:\n\n```\n        K = np.array(\n            [-TWOPI / N * sadp * sadp[t] * 1 / (TWOPI * I) *\n              ((dp / adp) / (cp - cp[t]) -\n               ((dp[t] / adp[t]) / (cp - cp[t])).conjugate())\n              for t in np.arange(NB)], dtype=np.complex128)\n```\n\nAssignee: @burcin\n\nCC:  evanandel @kiwifb\n\nResolution: fixed\n\nAuthor: Fran\u00e7ois Bissey, Jason Grout\n\nReviewer: Ethan Van Andel, Karl-Dieter Crisman\n\nMerged: sage-4.7.1.alpha0\n\nIssue created by migration from https://trac.sagemath.org/ticket/10821\n\n",
    "closed_at": "2011-04-29T13:27:55Z",
    "created_at": "2011-02-22T18:43:01Z",
    "labels": [
        "component: calculus",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.7.1",
    "title": "riemann.pyx gives lots of invalid value in divide warnings",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10821",
    "user": "https://github.com/jasongrout"
}
```
I keep getting Warning: invalid value encountered in divide, and the error happens in these lines in the _generate_theta_array function in calculus/riemann.pyx:

```
        K = np.array(
            [-TWOPI / N * sadp * sadp[t] * 1 / (TWOPI * I) *
              ((dp / adp) / (cp - cp[t]) -
               ((dp[t] / adp[t]) / (cp - cp[t])).conjugate())
              for t in np.arange(NB)], dtype=np.complex128)
```

Assignee: @burcin

CC:  evanandel @kiwifb

Resolution: fixed

Author: Fran√ßois Bissey, Jason Grout

Reviewer: Ethan Van Andel, Karl-Dieter Crisman

Merged: sage-4.7.1.alpha0

Issue created by migration from https://trac.sagemath.org/ticket/10821





---

archive/issue_comments_119175.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,6 +1,13 @@\n+I keep getting Warning: invalid value encountered in divide, and the error happens in these lines in the _generate_theta_array function in calculus/riemann.pyx:\n \n+\\`\\`\\`\n+        K = np.array(\n+            [-TWOPI / N * sadp * sadp[t] * 1 / (TWOPI * I) *\n+              ((dp / adp) / (cp - cp[t]) -\n+               ((dp[t] / adp[t]) / (cp - cp[t])).conjugate())\n+              for t in np.arange(NB)], dtype=np.complex128)\n+\\`\\`\\`\n \n-Assignee: tbd\n \n Component: PLEASE CHANGE\n \n```\n",
    "created_at": "2011-02-22T18:55:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10821#issuecomment-119175",
    "user": "https://github.com/jasongrout"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,6 +1,13 @@
+I keep getting Warning: invalid value encountered in divide, and the error happens in these lines in the _generate_theta_array function in calculus/riemann.pyx:
 
+\`\`\`
+        K = np.array(
+            [-TWOPI / N * sadp * sadp[t] * 1 / (TWOPI * I) *
+              ((dp / adp) / (cp - cp[t]) -
+               ((dp[t] / adp[t]) / (cp - cp[t])).conjugate())
+              for t in np.arange(NB)], dtype=np.complex128)
+\`\`\`
 
-Assignee: tbd
 
 Component: PLEASE CHANGE
 
```




---

archive/issue_events_027943.json:
```json
{
    "actor": "https://github.com/jasongrout",
    "created_at": "2011-02-22T18:55:05Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10821",
    "milestone": "sage-4.6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10821#event-27943"
}
```



---

archive/issue_comments_119176.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to calculus.",
    "created_at": "2011-02-22T18:55:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10821#issuecomment-119176",
    "user": "https://github.com/jasongrout"
}
```

Changing component from PLEASE CHANGE to calculus.



---

archive/issue_comments_119177.json:
```json
{
    "body": "<a id='comment:1'></a>Ethan, I noticed several things that could be pulled out of the inner loop, and so rewrote this line in the attached patch. However, I don't know this code or the algorithms very well---can you look at the patch?\n\nIt appears that the warnings happen when there is a division by zero, as in this test case:\n\n```\nsage: import numpy as np\nsage: a=np.array([1,2],dtype=np.complex128)\nsage: b=np.array([0,1],dtype=np.complex128)\nsage: a/b\nWarning: invalid value encountered in divide\narray([ nan nanj,   2. +0.j])\nsage: a[0]/b[0]\n(nan+nan*j)\n```\nSo should we turn off the error checking for this error when doing this operation since at least one entry in cp-cp[t] will be zero? Or should we check for zero denominators and not calculate the fraction with those?",
    "created_at": "2011-02-22T18:55:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10821#issuecomment-119177",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:1'></a>Ethan, I noticed several things that could be pulled out of the inner loop, and so rewrote this line in the attached patch. However, I don't know this code or the algorithms very well---can you look at the patch?

It appears that the warnings happen when there is a division by zero, as in this test case:

```
sage: import numpy as np
sage: a=np.array([1,2],dtype=np.complex128)
sage: b=np.array([0,1],dtype=np.complex128)
sage: a/b
Warning: invalid value encountered in divide
array([ nan nanj,   2. +0.j])
sage: a[0]/b[0]
(nan+nan*j)
```
So should we turn off the error checking for this error when doing this operation since at least one entry in cp-cp[t] will be zero? Or should we check for zero denominators and not calculate the fraction with those?



---

archive/issue_comments_119178.json:
```json
{
    "body": "Changing assignee from tbd to @burcin.",
    "created_at": "2011-02-22T18:55:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10821#issuecomment-119178",
    "user": "https://github.com/jasongrout"
}
```

Changing assignee from tbd to @burcin.



---

archive/issue_comments_119179.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2011-02-22T18:55:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10821#issuecomment-119179",
    "user": "https://github.com/jasongrout"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_119180.json:
```json
{
    "body": "<a id='comment:3'></a>Attachment [trac-10821-riemann-invalid-divide.patch](tarball://root/attachments/some-uuid/ticket10821/trac-10821-riemann-invalid-divide.patch) by @jasongrout created at 2011-02-22 19:02:49\n\nUnfortunately, it appears that I really changed something in my patch, or introduced a significant amount of numerical error, as now the doctests give results that are way different than documented.",
    "created_at": "2011-02-22T19:02:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10821#issuecomment-119180",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:3'></a>Attachment [trac-10821-riemann-invalid-divide.patch](tarball://root/attachments/some-uuid/ticket10821/trac-10821-riemann-invalid-divide.patch) by @jasongrout created at 2011-02-22 19:02:49

Unfortunately, it appears that I really changed something in my patch, or introduced a significant amount of numerical error, as now the doctests give results that are way different than documented.



---

archive/issue_comments_119181.json:
```json
{
    "body": "<a id='comment:4'></a>I am not sure what to do with arrays quoted with indices and without, as in:\n\n```\ncp -cp[t]\n```\nbut I am fairly sure you attached .conjugate() to the wrong expression.\nI am attaching a corrected patch. I cannot try it right now.",
    "created_at": "2011-02-27T09:05:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10821#issuecomment-119181",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:4'></a>I am not sure what to do with arrays quoted with indices and without, as in:

```
cp -cp[t]
```
but I am fairly sure you attached .conjugate() to the wrong expression.
I am attaching a corrected patch. I cannot try it right now.



---

archive/issue_comments_119182.json:
```json
{
    "body": "my own version of the patch",
    "created_at": "2011-02-27T09:06:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10821#issuecomment-119182",
    "user": "https://github.com/kiwifb"
}
```

my own version of the patch



---

archive/issue_comments_119183.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,12 @@\n+I keep getting Warning: invalid value encountered in divide, and the error happens in these lines in the _generate_theta_array function in calculus/riemann.pyx:\n \n+\\`\\`\\`\n+        K = np.array(\n+            [-TWOPI / N * sadp * sadp[t] * 1 / (TWOPI * I) *\n+              ((dp / adp) / (cp - cp[t]) -\n+               ((dp[t] / adp[t]) / (cp - cp[t])).conjugate())\n+              for t in np.arange(NB)], dtype=np.complex128)\n+\\`\\`\\`\n \n Component: PLEASE CHANGE\n \n```\n",
    "created_at": "2011-02-27T17:33:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10821#issuecomment-119183",
    "user": "https://trac.sagemath.org/admin/accounts/users/evanandel"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,12 @@
+I keep getting Warning: invalid value encountered in divide, and the error happens in these lines in the _generate_theta_array function in calculus/riemann.pyx:
 
+\`\`\`
+        K = np.array(
+            [-TWOPI / N * sadp * sadp[t] * 1 / (TWOPI * I) *
+              ((dp / adp) / (cp - cp[t]) -
+               ((dp[t] / adp[t]) / (cp - cp[t])).conjugate())
+              for t in np.arange(NB)], dtype=np.complex128)
+\`\`\`
 
 Component: PLEASE CHANGE
 
```




---

archive/issue_comments_119184.json:
```json
{
    "body": "<a id='comment:5'></a>Attachment [trac-10821-riemann-invalid-divide.2.patch](tarball://root/attachments/some-uuid/ticket10821/trac-10821-riemann-invalid-divide.2.patch) by evanandel created at 2011-02-27 17:33:29\n\nThis code generates a square array of dimension NB. The 't'th row is generated by (among other things) computing the difference between every element of cp and cp[t]. That's the meaning of\n\n```\ncp - cp[t]\n```\nfbissey: It looks like your patch is correct, I'll try it shortly.\n\nJason: If it interests you, this section of code is preparing a square matrix for nystrom numerical integration. The `cp` array holds the collocation points, that is the points around the boundary of the figure where the integral is being evaluated. `dp` contains the derivatives at those points.\n\ncomputing the square array will of course end up with illegal divisions for the 't'th element of the 't'th row. However, the next line of code:\n\n```\nfor i in xrange(NB):\n    K[i, i] = 1\n```\noverwrites the bad elements with 1's. Thus the divisions by zero don't affect the algorithm. (If we have any other divisions by 0, that means that the user has tried to evaluate a self intersecting figure (and gotten very unlucky) for which the algorithm is meaningless anyway.)\n\nWe can deal with the zero divides whatever way fits sage style best. If there's an efficient way to not perform those divisions that's fine. Otherwise I have no problems with simply ignoring the warnings.\n\n- Ethan",
    "created_at": "2011-02-27T17:33:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10821#issuecomment-119184",
    "user": "https://trac.sagemath.org/admin/accounts/users/evanandel"
}
```

<a id='comment:5'></a>Attachment [trac-10821-riemann-invalid-divide.2.patch](tarball://root/attachments/some-uuid/ticket10821/trac-10821-riemann-invalid-divide.2.patch) by evanandel created at 2011-02-27 17:33:29

This code generates a square array of dimension NB. The 't'th row is generated by (among other things) computing the difference between every element of cp and cp[t]. That's the meaning of

```
cp - cp[t]
```
fbissey: It looks like your patch is correct, I'll try it shortly.

Jason: If it interests you, this section of code is preparing a square matrix for nystrom numerical integration. The `cp` array holds the collocation points, that is the points around the boundary of the figure where the integral is being evaluated. `dp` contains the derivatives at those points.

computing the square array will of course end up with illegal divisions for the 't'th element of the 't'th row. However, the next line of code:

```
for i in xrange(NB):
    K[i, i] = 1
```
overwrites the bad elements with 1's. Thus the divisions by zero don't affect the algorithm. (If we have any other divisions by 0, that means that the user has tried to evaluate a self intersecting figure (and gotten very unlucky) for which the algorithm is meaningless anyway.)

We can deal with the zero divides whatever way fits sage style best. If there's an efficient way to not perform those divisions that's fine. Otherwise I have no problems with simply ignoring the warnings.

- Ethan



---

archive/issue_events_027944.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2011-02-28T07:51:18Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10821",
    "milestone": "sage-4.6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10821#event-27944"
}
```



---

archive/issue_events_027945.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2011-02-28T07:51:18Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10821",
    "milestone": "sage-4.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10821#event-27945"
}
```



---

archive/issue_comments_119185.json:
```json
{
    "body": "Changing status from new to needs_work.",
    "created_at": "2011-02-28T07:51:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10821#issuecomment-119185",
    "user": "https://github.com/kiwifb"
}
```

Changing status from new to needs_work.



---

archive/issue_comments_119186.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:5 evanandel]:\n> We can deal with the zero divides whatever way fits sage style best. If there's an efficient way to not perform those divisions that's fine. Otherwise I have no problems with simply ignoring the warnings.\n> \n\n\nI will think about that a little bit but given the context we can indeed ignore\nthese warnings. I think they show up in stderr and don't affect the results of the tests. They are obvious when the tests fail but I am not sure they are otherwise.",
    "created_at": "2011-02-28T07:51:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10821#issuecomment-119186",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:6'></a>Replying to [comment:5 evanandel]:
> We can deal with the zero divides whatever way fits sage style best. If there's an efficient way to not perform those divisions that's fine. Otherwise I have no problems with simply ignoring the warnings.
> 


I will think about that a little bit but given the context we can indeed ignore
these warnings. I think they show up in stderr and don't affect the results of the tests. They are obvious when the tests fail but I am not sure they are otherwise.



---

archive/issue_comments_119187.json:
```json
{
    "body": "<a id='comment:7'></a>Do I have the syntax right in thinking that K off-diagonal elements are defined by\n\n```\nK[i,j]= -TWOPI / N * sadp[i] * sadp[j] * 1 / (TWOPI * I) *\n              ((dp[i] / adp[i]) / (cp[i] - cp[j]) -\n               ((dp[j] / adp[j]) / (cp[i] - cp[j])).conjugate())\n```\nor do I have i and j mixed up?",
    "created_at": "2011-02-28T08:05:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10821#issuecomment-119187",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:7'></a>Do I have the syntax right in thinking that K off-diagonal elements are defined by

```
K[i,j]= -TWOPI / N * sadp[i] * sadp[j] * 1 / (TWOPI * I) *
              ((dp[i] / adp[i]) / (cp[i] - cp[j]) -
               ((dp[j] / adp[j]) / (cp[i] - cp[j])).conjugate())
```
or do I have i and j mixed up?



---

archive/issue_comments_119188.json:
```json
{
    "body": "<a id='comment:8'></a>Seeing this made me look through riemann.pyx, and it turns out that file could use some general TLC.  Esp. with regard to a few doc things and some fairly massive redundancy with complex plots.  See #10945.",
    "created_at": "2011-03-16T13:12:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10821#issuecomment-119188",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:8'></a>Seeing this made me look through riemann.pyx, and it turns out that file could use some general TLC.  Esp. with regard to a few doc things and some fairly massive redundancy with complex plots.  See #10945.



---

archive/issue_comments_119189.json:
```json
{
    "body": "slight fix",
    "created_at": "2011-03-22T03:53:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10821#issuecomment-119189",
    "user": "https://trac.sagemath.org/admin/accounts/users/evanandel"
}
```

slight fix



---

archive/issue_comments_119190.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-03-22T03:54:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10821#issuecomment-119190",
    "user": "https://trac.sagemath.org/admin/accounts/users/evanandel"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_119191.json:
```json
{
    "body": "<a id='comment:9'></a>Attachment [trac-10821-riemann-invalid-divide.3.patch](tarball://root/attachments/some-uuid/ticket10821/trac-10821-riemann-invalid-divide.3.patch) by evanandel created at 2011-03-22 03:54:56\n\nAlright, I wrapped the offending code in calls that tell numpy to ignore those invalid divide warnings then restore the original settings. It seems to fix things well.",
    "created_at": "2011-03-22T03:54:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10821#issuecomment-119191",
    "user": "https://trac.sagemath.org/admin/accounts/users/evanandel"
}
```

<a id='comment:9'></a>Attachment [trac-10821-riemann-invalid-divide.3.patch](tarball://root/attachments/some-uuid/ticket10821/trac-10821-riemann-invalid-divide.3.patch) by evanandel created at 2011-03-22 03:54:56

Alright, I wrapped the offending code in calls that tell numpy to ignore those invalid divide warnings then restore the original settings. It seems to fix things well.



---

archive/issue_comments_119192.json:
```json
{
    "body": "<a id='comment:11'></a>Okay, the code seems right, (and slightly refactored but fine), conforms with Numpy specs, passes the tests, and Ethan says it's correct for his algorithm.",
    "created_at": "2011-04-21T01:47:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10821#issuecomment-119192",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:11'></a>Okay, the code seems right, (and slightly refactored but fine), conforms with Numpy specs, passes the tests, and Ethan says it's correct for his algorithm.



---

archive/issue_comments_119193.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-04-21T01:47:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10821#issuecomment-119193",
    "user": "https://github.com/kcrisman"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_027946.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-04-21T08:41:08Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10821",
    "milestone": "sage-4.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10821#event-27946"
}
```



---

archive/issue_events_027947.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-04-21T08:41:08Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10821",
    "milestone": "sage-4.7.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10821#event-27947"
}
```



---

archive/issue_events_027948.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-04-29T13:27:55Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/10821",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10821#event-27948"
}
```



---

archive/issue_comments_119194.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-04-29T13:27:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10821",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10821#issuecomment-119194",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
