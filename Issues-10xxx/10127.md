# Issue 10127: Fix initialization order in CombinatorialFreeModule

archive/issues_010126.json:
```json
{
    "body": "This patch fixes ``CombinatorialFreeModule.__init__`` in order to set ``self._basis_keys`` early enough in case the initialization of the categories use ``self.basis().keys()``. This occured on several occasions in non trivial constructions. In the following example, ``AlgebrasWithBasis`` constructs ``Homset(self,self)`` to extend by bilinearity the ``product_on_basis`` method, which in turn triggers the `self._repr_()`::\n\n```\n    sage: class MyAlgebra(CombinatorialFreeModule):\n    ...       def `_repr_`(self):\n    ...           return \"MyAlgebra on %s\"%(self.basis().keys())\n    ...       def product_on_basis(self,i,j):\n    ...           pass\n    sage: MyAlgebra(ZZ, ZZ, category = AlgebrasWithBasis(QQ))\nTraceback (most recent call last):\n  File \"<ipython console>\", line 1, in <module>\n  File \"/opt/sage-4.5.2/local/lib/python2.6/site-packages/sage/misc/classcall_metaclass.py\", line 258, in `__call__`\n    return cls.__classcall__(cls, *args, **options)\n  File \"/opt/sage-4.5.2/local/lib/python2.6/site-packages/sage/misc/cachefunc.py\", line 115, in `__call__`\n    w = self.f(*args, **kwds)\n  File \"/opt/sage-4.5.2/local/lib/python2.6/site-packages/sage/structure/unique_representation.py\", line 449, in `__classcall__`\n    instance = type.__call__(cls, *args, **options)\n  File \"/opt/sage-4.5.2/local/lib/python2.6/site-packages/sage/combinat/free_module.py\", line 827, in `__init__`\n    element_constructor = self._element_constructor_)\n  File \"parent.pyx\", line 458, in sage.structure.parent.Parent.__init__ (sage/structure/parent.c:3855)\n  File \"/opt/sage-4.5.2/local/lib/python2.6/site-packages/sage/categories/magmas.py\", line 115, in `__init_extra__`\n    if (self.product != self.product_from_element_class_mul) and hasattr(self, \"element_class\") and hasattr(self.element_class, \"_mul_parent\"):\n  File \"element.pyx\", line 863, in sage.structure.element.Element.__richcmp__ (sage/structure/element.c:7107)\n  File \"element.pyx\", line 804, in sage.structure.element.Element._richcmp (sage/structure/element.c:6487)\n  File \"coerce.pyx\", line 907, in sage.structure.coerce.CoercionModel_cache_maps.canonical_coercion (sage/structure/coerce.c:8540)\n  File \"sage_object.pyx\", line 101, in sage.structure.sage_object.SageObject.__repr__ (sage/structure/sage_object.c:1370)\n  File \"/opt/sage-4.5.2/local/lib/python2.6/site-packages/sage/categories/homset.py\", line 302, in `_repr_`\n    self._domain, self._codomain, self.__category)\n  File \"sage_object.pyx\", line 101, in sage.structure.sage_object.SageObject.__repr__ (sage/structure/sage_object.c:1370)\n  File \"<string>\", line 4, in `_repr_`\n  File \"/opt/sage-4.5.2/local/lib/python2.6/site-packages/sage/combinat/free_module.py\", line 869, in basis\n    return Family(self._basis_keys, self.monomial) #.\n  File \"parent.pyx\", line 680, in sage.structure.parent.Parent.__getattr__ (sage/structure/parent.c:5311)\n  File \"parent.pyx\", line 264, in sage.structure.parent.getattr_from_other_class (sage/structure/parent.c:2757)\n  File \"parent.pyx\", line 172, in sage.structure.parent.raise_attribute_error (sage/structure/parent.c:2629)\nAttributeError: 'MyAlgebra_with_category' object has no attribute '_basis_keys'\n```\n\nDepends on #9648\n\n**Assignee:** @aghitza\n\n**CC:**  sage-combinat nborie\n\n**Resolution:** fixed\n\n**Author:** Nicolas Borie\n\n**Reviewer:** Nicolas M. Thi\u00e9ry\n\n**Merged:** sage-4.6.1.alpha0\n\nIssue created by migration from https://trac.sagemath.org/ticket/10127\n\n",
    "closed_at": "2010-11-01T10:16:28Z",
    "created_at": "2010-10-13T14:11:32Z",
    "labels": [
        "component: algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.6.1",
    "title": "Fix initialization order in CombinatorialFreeModule",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10127",
    "user": "https://github.com/nthiery"
}
```
This patch fixes ``CombinatorialFreeModule.__init__`` in order to set ``self._basis_keys`` early enough in case the initialization of the categories use ``self.basis().keys()``. This occured on several occasions in non trivial constructions. In the following example, ``AlgebrasWithBasis`` constructs ``Homset(self,self)`` to extend by bilinearity the ``product_on_basis`` method, which in turn triggers the `self._repr_()`::

```
    sage: class MyAlgebra(CombinatorialFreeModule):
    ...       def `_repr_`(self):
    ...           return "MyAlgebra on %s"%(self.basis().keys())
    ...       def product_on_basis(self,i,j):
    ...           pass
    sage: MyAlgebra(ZZ, ZZ, category = AlgebrasWithBasis(QQ))
Traceback (most recent call last):
  File "<ipython console>", line 1, in <module>
  File "/opt/sage-4.5.2/local/lib/python2.6/site-packages/sage/misc/classcall_metaclass.py", line 258, in `__call__`
    return cls.__classcall__(cls, *args, **options)
  File "/opt/sage-4.5.2/local/lib/python2.6/site-packages/sage/misc/cachefunc.py", line 115, in `__call__`
    w = self.f(*args, **kwds)
  File "/opt/sage-4.5.2/local/lib/python2.6/site-packages/sage/structure/unique_representation.py", line 449, in `__classcall__`
    instance = type.__call__(cls, *args, **options)
  File "/opt/sage-4.5.2/local/lib/python2.6/site-packages/sage/combinat/free_module.py", line 827, in `__init__`
    element_constructor = self._element_constructor_)
  File "parent.pyx", line 458, in sage.structure.parent.Parent.__init__ (sage/structure/parent.c:3855)
  File "/opt/sage-4.5.2/local/lib/python2.6/site-packages/sage/categories/magmas.py", line 115, in `__init_extra__`
    if (self.product != self.product_from_element_class_mul) and hasattr(self, "element_class") and hasattr(self.element_class, "_mul_parent"):
  File "element.pyx", line 863, in sage.structure.element.Element.__richcmp__ (sage/structure/element.c:7107)
  File "element.pyx", line 804, in sage.structure.element.Element._richcmp (sage/structure/element.c:6487)
  File "coerce.pyx", line 907, in sage.structure.coerce.CoercionModel_cache_maps.canonical_coercion (sage/structure/coerce.c:8540)
  File "sage_object.pyx", line 101, in sage.structure.sage_object.SageObject.__repr__ (sage/structure/sage_object.c:1370)
  File "/opt/sage-4.5.2/local/lib/python2.6/site-packages/sage/categories/homset.py", line 302, in `_repr_`
    self._domain, self._codomain, self.__category)
  File "sage_object.pyx", line 101, in sage.structure.sage_object.SageObject.__repr__ (sage/structure/sage_object.c:1370)
  File "<string>", line 4, in `_repr_`
  File "/opt/sage-4.5.2/local/lib/python2.6/site-packages/sage/combinat/free_module.py", line 869, in basis
    return Family(self._basis_keys, self.monomial) #.
  File "parent.pyx", line 680, in sage.structure.parent.Parent.__getattr__ (sage/structure/parent.c:5311)
  File "parent.pyx", line 264, in sage.structure.parent.getattr_from_other_class (sage/structure/parent.c:2757)
  File "parent.pyx", line 172, in sage.structure.parent.raise_attribute_error (sage/structure/parent.c:2629)
AttributeError: 'MyAlgebra_with_category' object has no attribute '_basis_keys'
```

Depends on #9648

**Assignee:** @aghitza

**CC:**  sage-combinat nborie

**Resolution:** fixed

**Author:** Nicolas Borie

**Reviewer:** Nicolas M. Thi√©ry

**Merged:** sage-4.6.1.alpha0

Issue created by migration from https://trac.sagemath.org/ticket/10127





---

archive/issue_comments_128975.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1 +1,38 @@\n-Preliminary patch on the Sage-Combinat patch server\n+This patch fixes ``CombinatorialFreeModule.__init__`` in order to set ``self._basis_keys`` early enough in case the initialization of the categories use ``self.basis().keys()``. This occured on several occasions in non trivial constructions. In the following example, ``AlgebrasWithBasis`` constructs ``Homset(self,self)`` to extend by bilinearity the ``product_on_basis`` method, which in turn triggers the `self._repr_()`::\n+\n+```\n+    sage: class MyAlgebra(CombinatorialFreeModule):\n+    ...       def `_repr_`(self):\n+    ...           return \"MyAlgebra on %s\"%(self.basis().keys())\n+    ...       def product_on_basis(self,i,j):\n+    ...           pass\n+    sage: MyAlgebra(ZZ, ZZ, category = AlgebrasWithBasis(QQ))\n+Traceback (most recent call last):\n+  File \"<ipython console>\", line 1, in <module>\n+  File \"/opt/sage-4.5.2/local/lib/python2.6/site-packages/sage/misc/classcall_metaclass.py\", line 258, in `__call__`\n+    return cls.__classcall__(cls, *args, **options)\n+  File \"/opt/sage-4.5.2/local/lib/python2.6/site-packages/sage/misc/cachefunc.py\", line 115, in `__call__`\n+    w = self.f(*args, **kwds)\n+  File \"/opt/sage-4.5.2/local/lib/python2.6/site-packages/sage/structure/unique_representation.py\", line 449, in `__classcall__`\n+    instance = type.__call__(cls, *args, **options)\n+  File \"/opt/sage-4.5.2/local/lib/python2.6/site-packages/sage/combinat/free_module.py\", line 827, in `__init__`\n+    element_constructor = self._element_constructor_)\n+  File \"parent.pyx\", line 458, in sage.structure.parent.Parent.__init__ (sage/structure/parent.c:3855)\n+  File \"/opt/sage-4.5.2/local/lib/python2.6/site-packages/sage/categories/magmas.py\", line 115, in `__init_extra__`\n+    if (self.product != self.product_from_element_class_mul) and hasattr(self, \"element_class\") and hasattr(self.element_class, \"_mul_parent\"):\n+  File \"element.pyx\", line 863, in sage.structure.element.Element.__richcmp__ (sage/structure/element.c:7107)\n+  File \"element.pyx\", line 804, in sage.structure.element.Element._richcmp (sage/structure/element.c:6487)\n+  File \"coerce.pyx\", line 907, in sage.structure.coerce.CoercionModel_cache_maps.canonical_coercion (sage/structure/coerce.c:8540)\n+  File \"sage_object.pyx\", line 101, in sage.structure.sage_object.SageObject.__repr__ (sage/structure/sage_object.c:1370)\n+  File \"/opt/sage-4.5.2/local/lib/python2.6/site-packages/sage/categories/homset.py\", line 302, in `_repr_`\n+    self._domain, self._codomain, self.__category)\n+  File \"sage_object.pyx\", line 101, in sage.structure.sage_object.SageObject.__repr__ (sage/structure/sage_object.c:1370)\n+  File \"<string>\", line 4, in `_repr_`\n+  File \"/opt/sage-4.5.2/local/lib/python2.6/site-packages/sage/combinat/free_module.py\", line 869, in basis\n+    return Family(self._basis_keys, self.monomial) #.\n+  File \"parent.pyx\", line 680, in sage.structure.parent.Parent.__getattr__ (sage/structure/parent.c:5311)\n+  File \"parent.pyx\", line 264, in sage.structure.parent.getattr_from_other_class (sage/structure/parent.c:2757)\n+  File \"parent.pyx\", line 172, in sage.structure.parent.raise_attribute_error (sage/structure/parent.c:2629)\n+AttributeError: 'MyAlgebra_with_category' object has no attribute '_basis_keys'\n+```\n+\n``````\n",
    "created_at": "2010-10-15T08:27:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10127#issuecomment-128975",
    "user": "https://github.com/nthiery"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1 +1,38 @@
-Preliminary patch on the Sage-Combinat patch server
+This patch fixes ``CombinatorialFreeModule.__init__`` in order to set ``self._basis_keys`` early enough in case the initialization of the categories use ``self.basis().keys()``. This occured on several occasions in non trivial constructions. In the following example, ``AlgebrasWithBasis`` constructs ``Homset(self,self)`` to extend by bilinearity the ``product_on_basis`` method, which in turn triggers the `self._repr_()`::
+
+```
+    sage: class MyAlgebra(CombinatorialFreeModule):
+    ...       def `_repr_`(self):
+    ...           return "MyAlgebra on %s"%(self.basis().keys())
+    ...       def product_on_basis(self,i,j):
+    ...           pass
+    sage: MyAlgebra(ZZ, ZZ, category = AlgebrasWithBasis(QQ))
+Traceback (most recent call last):
+  File "<ipython console>", line 1, in <module>
+  File "/opt/sage-4.5.2/local/lib/python2.6/site-packages/sage/misc/classcall_metaclass.py", line 258, in `__call__`
+    return cls.__classcall__(cls, *args, **options)
+  File "/opt/sage-4.5.2/local/lib/python2.6/site-packages/sage/misc/cachefunc.py", line 115, in `__call__`
+    w = self.f(*args, **kwds)
+  File "/opt/sage-4.5.2/local/lib/python2.6/site-packages/sage/structure/unique_representation.py", line 449, in `__classcall__`
+    instance = type.__call__(cls, *args, **options)
+  File "/opt/sage-4.5.2/local/lib/python2.6/site-packages/sage/combinat/free_module.py", line 827, in `__init__`
+    element_constructor = self._element_constructor_)
+  File "parent.pyx", line 458, in sage.structure.parent.Parent.__init__ (sage/structure/parent.c:3855)
+  File "/opt/sage-4.5.2/local/lib/python2.6/site-packages/sage/categories/magmas.py", line 115, in `__init_extra__`
+    if (self.product != self.product_from_element_class_mul) and hasattr(self, "element_class") and hasattr(self.element_class, "_mul_parent"):
+  File "element.pyx", line 863, in sage.structure.element.Element.__richcmp__ (sage/structure/element.c:7107)
+  File "element.pyx", line 804, in sage.structure.element.Element._richcmp (sage/structure/element.c:6487)
+  File "coerce.pyx", line 907, in sage.structure.coerce.CoercionModel_cache_maps.canonical_coercion (sage/structure/coerce.c:8540)
+  File "sage_object.pyx", line 101, in sage.structure.sage_object.SageObject.__repr__ (sage/structure/sage_object.c:1370)
+  File "/opt/sage-4.5.2/local/lib/python2.6/site-packages/sage/categories/homset.py", line 302, in `_repr_`
+    self._domain, self._codomain, self.__category)
+  File "sage_object.pyx", line 101, in sage.structure.sage_object.SageObject.__repr__ (sage/structure/sage_object.c:1370)
+  File "<string>", line 4, in `_repr_`
+  File "/opt/sage-4.5.2/local/lib/python2.6/site-packages/sage/combinat/free_module.py", line 869, in basis
+    return Family(self._basis_keys, self.monomial) #.
+  File "parent.pyx", line 680, in sage.structure.parent.Parent.__getattr__ (sage/structure/parent.c:5311)
+  File "parent.pyx", line 264, in sage.structure.parent.getattr_from_other_class (sage/structure/parent.c:2757)
+  File "parent.pyx", line 172, in sage.structure.parent.raise_attribute_error (sage/structure/parent.c:2629)
+AttributeError: 'MyAlgebra_with_category' object has no attribute '_basis_keys'
+```
+
``````




---

archive/issue_comments_128976.json:
```json
{
    "body": "**Changing work_issues** from \"Just needs a regression test\" to \"\".",
    "created_at": "2010-10-15T08:27:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10127#issuecomment-128976",
    "user": "https://github.com/nthiery"
}
```

**Changing work_issues** from "Just needs a regression test" to "".



---

archive/issue_comments_128977.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -36,3 +36,4 @@\n AttributeError: 'MyAlgebra_with_category' object has no attribute '_basis_keys'\n ```\n \n+Depends on #9648\n``````\n",
    "created_at": "2010-10-15T13:47:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10127#issuecomment-128977",
    "user": "https://github.com/nthiery"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -36,3 +36,4 @@
 AttributeError: 'MyAlgebra_with_category' object has no attribute '_basis_keys'
 ```
 
+Depends on #9648
``````




---

archive/issue_comments_128978.json:
```json
{
    "body": "<a id='comment:2'></a>\nAll test pass on 4.5.3, with #9648 applied first, and the latest version of this patch on the Sage-Combinat patch server.\n\nNicolas: you may set a positive review on my behalf as soon as you have uploaded the patch here.",
    "created_at": "2010-10-15T13:47:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10127#issuecomment-128978",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:2'></a>
All test pass on 4.5.3, with #9648 applied first, and the latest version of this patch on the Sage-Combinat patch server.

Nicolas: you may set a positive review on my behalf as soon as you have uploaded the patch here.



---

archive/issue_comments_128979.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2010-10-15T14:20:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10127#issuecomment-128979",
    "user": "https://trac.sagemath.org/admin/accounts/users/nborie"
}
```

**Changing status** from new to needs_review.



---

archive/attachments_013206.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_10127_free_module_basis_key_initialisation-nb.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket10127/trac_10127_free_module_basis_key_initialisation-nb.patch",
    "created_at": "2010-10-15T14:20:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10127",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://trac.sagemath.org/admin/accounts/users/nborie"
}
```



---

archive/issue_comments_128980.json:
```json
{
    "body": "<a id='comment:3'></a>\nTest and Doc are ok!\n\nMore important than the patch, thanks for giving this precise description of the problem...\n\nI give this patch a positive review.",
    "created_at": "2010-10-15T14:20:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10127#issuecomment-128980",
    "user": "https://trac.sagemath.org/admin/accounts/users/nborie"
}
```

<a id='comment:3'></a>
Test and Doc are ok!

More important than the patch, thanks for giving this precise description of the problem...

I give this patch a positive review.



---

archive/issue_comments_128981.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2010-10-15T14:21:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10127#issuecomment-128981",
    "user": "https://trac.sagemath.org/admin/accounts/users/nborie"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_128982.json:
```json
{
    "body": "**Merged:** sage-4.6.1.alpha0",
    "created_at": "2010-11-01T10:16:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10127#issuecomment-128982",
    "user": "https://github.com/jdemeyer"
}
```

**Merged:** sage-4.6.1.alpha0



---

archive/issue_events_031156.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2010-11-01T10:16:28Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/10127",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10127#event-31156"
}
```



---

archive/issue_comments_128983.json:
```json
{
    "body": "**Resolution:** fixed",
    "created_at": "2010-11-01T10:16:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10127#issuecomment-128983",
    "user": "https://github.com/jdemeyer"
}
```

**Resolution:** fixed
