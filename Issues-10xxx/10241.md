# Issue 10241: Remove unportable '-q' option to grep on SAGE_ROOT/spkg/install

archive/issues_010240.json:
```json
{
    "body": "Although the -q option to grep is defined by POSIX, many older greps do not implement this. Even the man page of `grep` on a Linux machine says not to use -q or -s on scripts that are supposed to be portable. \n\nThe grep in /usr/bin on Solaris does not support the option. This is done by Sun to maintain backward compatibility with older versions which did not support it. So this causes a problem. \n\n```\ndrkirkby@hawk:~/sage-4.6.1.alpha0$ make\nspkg/pipestatus \"cd spkg && ./install all 2>&1\" \"tee -a ../install.log\"\ngrep: illegal option -- q\nUsage: grep -hblcnsviw pattern file . . .\n```\n\nPOSIX says:\n\n```\n-q\n    Quiet. Nothing shall be written to the standard output, regardless of matching lines. Exit with zero status if an input line is selected.\n```\n\nso it is quite easy to work around. In general, \n\nThe -q option only suppresses the output. The exit code is then used to determine if there was a match or not - 0 if if there was a math, 1 if there was not.\n\nThat exit code works on Solaris too, so it's only necessary to drop the -q and send the output to /dev/null.\n\n```\ngrep -q sometext somefile\n```\n\nneeds to be changed to\n\n```\ngrep sometext somefile > /dev/null\n```\n\nSee also:\n\nhttp://www.gnu.org/software/hello/manual/autoconf/Limitations-of-Usual-Tools.html#grep\n\n\n\nAssignee: GeorgSWeber\n\nCC:  @nexttime @jhpalmieri\n\nResolution: fixed\n\nAuthor: David Kirkby\n\nReviewer: Dmitrii Pasechnik\n\nMerged: sage-4.6.1.alpha1\n\nIssue created by migration from https://trac.sagemath.org/ticket/10241\n\n",
    "closed_at": "2010-11-11T13:02:59Z",
    "created_at": "2010-11-09T21:09:42Z",
    "labels": [
        "component: build",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.6.1",
    "title": "Remove unportable '-q' option to grep on SAGE_ROOT/spkg/install",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10241",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```
Although the -q option to grep is defined by POSIX, many older greps do not implement this. Even the man page of `grep` on a Linux machine says not to use -q or -s on scripts that are supposed to be portable. 

The grep in /usr/bin on Solaris does not support the option. This is done by Sun to maintain backward compatibility with older versions which did not support it. So this causes a problem. 

```
drkirkby@hawk:~/sage-4.6.1.alpha0$ make
spkg/pipestatus "cd spkg && ./install all 2>&1" "tee -a ../install.log"
grep: illegal option -- q
Usage: grep -hblcnsviw pattern file . . .
```

POSIX says:

```
-q
    Quiet. Nothing shall be written to the standard output, regardless of matching lines. Exit with zero status if an input line is selected.
```

so it is quite easy to work around. In general, 

The -q option only suppresses the output. The exit code is then used to determine if there was a match or not - 0 if if there was a math, 1 if there was not.

That exit code works on Solaris too, so it's only necessary to drop the -q and send the output to /dev/null.

```
grep -q sometext somefile
```

needs to be changed to

```
grep sometext somefile > /dev/null
```

See also:

http://www.gnu.org/software/hello/manual/autoconf/Limitations-of-Usual-Tools.html#grep



Assignee: GeorgSWeber

CC:  @nexttime @jhpalmieri

Resolution: fixed

Author: David Kirkby

Reviewer: Dmitrii Pasechnik

Merged: sage-4.6.1.alpha1

Issue created by migration from https://trac.sagemath.org/ticket/10241





---

archive/issue_comments_125546.json:
```json
{
    "body": "Revised install file, which avoids the unportable grep -q",
    "created_at": "2010-11-09T21:59:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10241#issuecomment-125546",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

Revised install file, which avoids the unportable grep -q



---

archive/issue_comments_125547.json:
```json
{
    "body": "Attachment [install](tarball://root/attachments/some-uuid/ticket10241/install) by drkirkby created at 2010-11-09 21:59:54\n\nUnified diff, for review purposes only. The install file is not in a repository",
    "created_at": "2010-11-09T21:59:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10241#issuecomment-125547",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

Attachment [install](tarball://root/attachments/some-uuid/ticket10241/install) by drkirkby created at 2010-11-09 21:59:54

Unified diff, for review purposes only. The install file is not in a repository



---

archive/issue_comments_125548.json:
```json
{
    "body": "<a id='comment:1'></a>\nAttachment [install.diff](tarball://root/attachments/some-uuid/ticket10241/install.diff) by drkirkby created at 2010-11-09 22:02:28",
    "created_at": "2010-11-09T22:02:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10241#issuecomment-125548",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

<a id='comment:1'></a>
Attachment [install.diff](tarball://root/attachments/some-uuid/ticket10241/install.diff) by drkirkby created at 2010-11-09 22:02:28



---

archive/issue_comments_125549.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2010-11-09T22:02:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10241#issuecomment-125549",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_125550.json:
```json
{
    "body": "Changing author from \"\" to \"David Kirkby\"",
    "created_at": "2010-11-09T22:02:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10241#issuecomment-125550",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

Changing author from "" to "David Kirkby"



---

archive/issue_comments_125551.json:
```json
{
    "body": "<a id='comment:2'></a>\nThis needs review.",
    "created_at": "2010-11-09T22:05:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10241#issuecomment-125551",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

<a id='comment:2'></a>
This needs review.



---

archive/issue_comments_125552.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -16,7 +16,21 @@\n     Quiet. Nothing shall be written to the standard output, regardless of matching lines. Exit with zero status if an input line is selected.\n ```\n \n-so it is quite easy to work around. \n+so it is quite easy to work around. In general, \n+\n+The -q option only suppresses the output. The exit code is then used to determine if there was a match or not - 0 if if there was a math, 1 if there was not.\n+\n+That exit code works on Solaris too, so it's only necessary to drop the -q and send the output to /dev/null.\n+\n+```\n+grep -q sometext somefile\n+```\n+\n+needs to be changed to\n+\n+```\n+grep sometext somefile > /dev/null\n+```\n \n See also:\n \n``````\n",
    "created_at": "2010-11-09T22:05:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10241#issuecomment-125552",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -16,7 +16,21 @@
     Quiet. Nothing shall be written to the standard output, regardless of matching lines. Exit with zero status if an input line is selected.
 ```
 
-so it is quite easy to work around. 
+so it is quite easy to work around. In general, 
+
+The -q option only suppresses the output. The exit code is then used to determine if there was a match or not - 0 if if there was a math, 1 if there was not.
+
+That exit code works on Solaris too, so it's only necessary to drop the -q and send the output to /dev/null.
+
+```
+grep -q sometext somefile
+```
+
+needs to be changed to
+
+```
+grep sometext somefile > /dev/null
+```
 
 See also:
 
``````




---

archive/issue_comments_125553.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2010-11-09T23:00:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10241#issuecomment-125553",
    "user": "https://github.com/jhpalmieri"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_125554.json:
```json
{
    "body": "<a id='comment:4'></a>\nlooks and works good.",
    "created_at": "2010-11-10T03:47:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10241#issuecomment-125554",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:4'></a>
looks and works good.



---

archive/issue_comments_125555.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2010-11-10T03:47:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10241#issuecomment-125555",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_125556.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Dmitrii Pasechnik\"",
    "created_at": "2010-11-10T19:00:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10241#issuecomment-125556",
    "user": "https://github.com/jdemeyer"
}
```

Changing reviewer from "" to "Dmitrii Pasechnik"



---

archive/issue_comments_125557.json:
```json
{
    "body": "Changing merged from \"\" to \"sage-4.6.1.alpha1\"",
    "created_at": "2010-11-11T13:02:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10241#issuecomment-125557",
    "user": "https://github.com/jdemeyer"
}
```

Changing merged from "" to "sage-4.6.1.alpha1"



---

archive/issue_comments_125558.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2010-11-11T13:02:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10241#issuecomment-125558",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_026306.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2010-11-11T13:02:59Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/10241",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10241#event-26306"
}
```



---

archive/issue_comments_125559.json:
```json
{
    "body": "<a id='comment:7'></a>\nPost-mortem comment: ;-)\n\nIn general I'm not very happy with avoiding POSIX options just because some people don't set their `PATH` properly.\n\nIMHO Sage's `configure` should handle such. We're not building `gcc`, nor do we support last millenium's systems...\n\n(Btw, `egrep` and `echo -n` aren't very portable in that sense either. If we only use the smallest subset of all systems or program versions one could think of, the code gets unreadable and harder to maintain.)\n\nFortunately, `sage-upgrade` won't get very large (I hope), but that's not the case for other uses of `grep -q`. Abusing `sed` is IMHO not an option (see above).",
    "created_at": "2010-11-21T20:32:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10241#issuecomment-125559",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:7'></a>
Post-mortem comment: ;-)

In general I'm not very happy with avoiding POSIX options just because some people don't set their `PATH` properly.

IMHO Sage's `configure` should handle such. We're not building `gcc`, nor do we support last millenium's systems...

(Btw, `egrep` and `echo -n` aren't very portable in that sense either. If we only use the smallest subset of all systems or program versions one could think of, the code gets unreadable and harder to maintain.)

Fortunately, `sage-upgrade` won't get very large (I hope), but that's not the case for other uses of `grep -q`. Abusing `sed` is IMHO not an option (see above).



---

archive/issue_comments_125560.json:
```json
{
    "body": "<a id='comment:8'></a>\nReplying to [leif](#comment%3A7):\n> Post-mortem comment: ;-)\n> \n> In general I'm not very happy with avoiding POSIX options just because some people don't set their `PATH` properly.\n\n\nWhat has this to do with setting `PATH`?",
    "created_at": "2010-11-21T21:55:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10241#issuecomment-125560",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>
Replying to [leif](#comment%3A7):
> Post-mortem comment: ;-)
> 
> In general I'm not very happy with avoiding POSIX options just because some people don't set their `PATH` properly.


What has this to do with setting `PATH`?



---

archive/issue_comments_125561.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [jdemeyer](#comment%3A8):\n> Replying to [leif](#comment%3A7):\n> > Post-mortem comment: ;-)\n> > \n> > In general I'm not very happy with avoiding POSIX options just because some people don't set their `PATH` properly.\n\n> \n> What has this to do with setting `PATH`?\n\n\nAsk Oracle... ;-)\n\n(The POSIX-conformant versions aren't in the default `PATH`, for \"compatibility\" reasons.)",
    "created_at": "2010-11-21T22:51:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10241#issuecomment-125561",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:9'></a>
Replying to [jdemeyer](#comment%3A8):
> Replying to [leif](#comment%3A7):
> > Post-mortem comment: ;-)
> > 
> > In general I'm not very happy with avoiding POSIX options just because some people don't set their `PATH` properly.

> 
> What has this to do with setting `PATH`?


Ask Oracle... ;-)

(The POSIX-conformant versions aren't in the default `PATH`, for "compatibility" reasons.)



---

archive/issue_comments_125562.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [leif](#comment%3A9):\n> Replying to [jdemeyer](#comment%3A8):\n> > What has this to do with setting `PATH`?\n\n> \n> Ask Oracle... ;-)\n> \n> (The POSIX-conformant versions aren't in the default `PATH`, for \"compatibility\" reasons.)\n\n\nOf course the fact the default path does not always have POSIX options is a little unfortunate, but does mean Solaris has excellent backward compatibility. A 20 years old SunOS binary will still run today on Solaris. \n\nI do occasionally build Sage on the 2005 edition of Solaris 10, and it works on the latest revision. \n\nThe same can not be said for Linux, where it seems that there is a never ending battle of keeping things working as the operating systems are updated. \n\n* ECL does not work on Fedora 14 -  #10185\n* Readline not work on the latest Arch or openSUSE #9530\n* etc, etc etc.\n\n**I've yet to see one single example of where Sage builds on an old version of Solaris, but not on a newer one.**\n \nIt should also be noted that Linux does not ship with POSIX commands - `ls`, `df`, `du` being 3 simple examples. But there are tons of them. \n\nhttps://www.opengroup.org/platform/single_unix_specification/uploads/40/13450/POSIX_and_Linux_Application_Compatibility_Final_-_v1.0.pdf\n\nLike it or not, to create portable code, it is best to test on multiple platforms and whenever possible work around non-portable options. In a case like `grep` it is trivial. \n\nSome common examples of non-portable code are given at\n\nhttp://www.gnu.org/software/hello/manual/autoconf/Limitations-of-Usual-Tools.html#grep\n\nDave",
    "created_at": "2010-11-22T17:42:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10241",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10241#issuecomment-125562",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

<a id='comment:10'></a>
Replying to [leif](#comment%3A9):
> Replying to [jdemeyer](#comment%3A8):
> > What has this to do with setting `PATH`?

> 
> Ask Oracle... ;-)
> 
> (The POSIX-conformant versions aren't in the default `PATH`, for "compatibility" reasons.)


Of course the fact the default path does not always have POSIX options is a little unfortunate, but does mean Solaris has excellent backward compatibility. A 20 years old SunOS binary will still run today on Solaris. 

I do occasionally build Sage on the 2005 edition of Solaris 10, and it works on the latest revision. 

The same can not be said for Linux, where it seems that there is a never ending battle of keeping things working as the operating systems are updated. 

* ECL does not work on Fedora 14 -  #10185
* Readline not work on the latest Arch or openSUSE #9530
* etc, etc etc.

**I've yet to see one single example of where Sage builds on an old version of Solaris, but not on a newer one.**
 
It should also be noted that Linux does not ship with POSIX commands - `ls`, `df`, `du` being 3 simple examples. But there are tons of them. 

https://www.opengroup.org/platform/single_unix_specification/uploads/40/13450/POSIX_and_Linux_Application_Compatibility_Final_-_v1.0.pdf

Like it or not, to create portable code, it is best to test on multiple platforms and whenever possible work around non-portable options. In a case like `grep` it is trivial. 

Some common examples of non-portable code are given at

http://www.gnu.org/software/hello/manual/autoconf/Limitations-of-Usual-Tools.html#grep

Dave
