# Issue 10244: legends don't save correctly

archive/issues_010243.json:
```json
{
    "body": "The new plot legends look great, but generate an error when you try to save them.\n\nFor example:\n\n```\na1 = plot(sin,-pi,pi,legend_label='sin')\na2 = plot(cos,-pi,pi,legend_label='cos',rgbcolor='red')\ntwo_plots = a1+a2\ntwo_plots.save('./two_plots.png')\n```\n\ngives the error:\n\n```\nKeyError: 'pop(): dictionary is empty'\n```\n\n**Apply:** [attachment:trac_10244_legend_label_fix_v3.patch] and [attachment:trac_10244-reviewer.patch]\n\nAssignee: jason, was\n\nCC:  @kcrisman @jasongrout @novoselt\n\nResolution: fixed\n\nAuthor: Marshall Hampton\n\nReviewer: Karl-Dieter Crisman\n\nMerged: sage-4.6.2.alpha2\n\nIssue created by migration from https://trac.sagemath.org/ticket/10244\n\n",
    "closed_at": "2011-01-25T08:15:08Z",
    "created_at": "2010-11-10T06:33:07Z",
    "labels": [
        "component: graphics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.6.2",
    "title": "legends don't save correctly",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10244",
    "user": "https://trac.sagemath.org/admin/accounts/users/mhampton"
}
```
The new plot legends look great, but generate an error when you try to save them.

For example:

```
a1 = plot(sin,-pi,pi,legend_label='sin')
a2 = plot(cos,-pi,pi,legend_label='cos',rgbcolor='red')
two_plots = a1+a2
two_plots.save('./two_plots.png')
```

gives the error:

```
KeyError: 'pop(): dictionary is empty'
```

**Apply:** [attachment:trac_10244_legend_label_fix_v3.patch] and [attachment:trac_10244-reviewer.patch]

Assignee: jason, was

CC:  @kcrisman @jasongrout @novoselt

Resolution: fixed

Author: Marshall Hampton

Reviewer: Karl-Dieter Crisman

Merged: sage-4.6.2.alpha2

Issue created by migration from https://trac.sagemath.org/ticket/10244





---

archive/issue_comments_125577.json:
```json
{
    "body": "<a id='comment:1'></a>Thanks for noticing this, Marshall.  In particular:\n\n```\n/Users/.../sage-4.6.1.alpha0/local/lib/python2.6/site-packages/sage/plot/plot.pyc in matplotlib(self, filename, xmin, xmax, ymin, ymax, figsize, figure, sub, axes, axes_labels, fontsize, frame, verify, aspect_ratio, gridlines, gridlinesstyle, vgridlinesstyle, hgridlinesstyle, show_legend, legend_options, axes_pad, ticks_integer, tick_formatter, ticks)\n   1965             lopts.update(legend_options)\n   1966             lopts.update(self.__legend_opts)\n-> 1967             prop = FontProperties(family=lopts.pop('font_family'), weight=lopts.pop('font_weight'), \\\n   1968                     size=lopts.pop('font_size'), style=lopts.pop('font_style'), variant=lopts.pop('font_variant'))\n   1969             color = lopts.pop('back_color')\n```\nSo we've already popped everything while saving in `.matplotlib`, but then try to pop some other options like `font_family`.  I would think those were already given in some ``@`options` thingie, but maybe they weren't.  I don't have time to check more into this, but I suspect the suboptions decorator has something to do with this - maybe we never initialized them but then try to access them.",
    "created_at": "2010-11-10T16:05:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125577",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:1'></a>Thanks for noticing this, Marshall.  In particular:

```
/Users/.../sage-4.6.1.alpha0/local/lib/python2.6/site-packages/sage/plot/plot.pyc in matplotlib(self, filename, xmin, xmax, ymin, ymax, figsize, figure, sub, axes, axes_labels, fontsize, frame, verify, aspect_ratio, gridlines, gridlinesstyle, vgridlinesstyle, hgridlinesstyle, show_legend, legend_options, axes_pad, ticks_integer, tick_formatter, ticks)
   1965             lopts.update(legend_options)
   1966             lopts.update(self.__legend_opts)
-> 1967             prop = FontProperties(family=lopts.pop('font_family'), weight=lopts.pop('font_weight'), \
   1968                     size=lopts.pop('font_size'), style=lopts.pop('font_style'), variant=lopts.pop('font_variant'))
   1969             color = lopts.pop('back_color')
```
So we've already popped everything while saving in `.matplotlib`, but then try to pop some other options like `font_family`.  I would think those were already given in some ``@`options` thingie, but maybe they weren't.  I don't have time to check more into this, but I suspect the suboptions decorator has something to do with this - maybe we never initialized them but then try to access them.



---

archive/issue_comments_125578.json:
```json
{
    "body": "<a id='comment:2'></a>Then a probably related issue is that this saving command:\n\n```\nplot(x,(x,0,1),aspect_ratio=1).save('test.png')\n```\n\ndoes *not* save a plot with aspect_ratio=1.  If this isn't related, I guess we should open a new ticket.",
    "created_at": "2010-11-10T16:15:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125578",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:2'></a>Then a probably related issue is that this saving command:

```
plot(x,(x,0,1),aspect_ratio=1).save('test.png')
```

does *not* save a plot with aspect_ratio=1.  If this isn't related, I guess we should open a new ticket.



---

archive/issue_comments_125579.json:
```json
{
    "body": "<a id='comment:3'></a>I wonder if something like #7981 (or a rebased and updated version) could fix this?  I think the problem in my comment is directly related to #7981.",
    "created_at": "2010-11-10T16:17:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125579",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:3'></a>I wonder if something like #7981 (or a rebased and updated version) could fix this?  I think the problem in my comment is directly related to #7981.



---

archive/issue_comments_125580.json:
```json
{
    "body": "<a id='comment:4'></a>Replying to [comment:3 jason]:\n> I wonder if something like #7981 (or a rebased and updated version) could fix this?  I think the problem in my comment is directly related to #7981.\n\nHmm, this seems quite likely - if the options are mostly used in show, not save.  I'd have to actually try it out and follow the code through, though, and that won't happen soon :(",
    "created_at": "2010-11-11T01:12:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125580",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:4'></a>Replying to [comment:3 jason]:
> I wonder if something like #7981 (or a rebased and updated version) could fix this?  I think the problem in my comment is directly related to #7981.

Hmm, this seems quite likely - if the options are mostly used in show, not save.  I'd have to actually try it out and follow the code through, though, and that won't happen soon :(



---

archive/issue_comments_125581.json:
```json
{
    "body": "<a id='comment:5'></a>Unfortunately the current fix at #7981 does NOT fix this.  Its extremely annoying for me, since I am currently in a project in which my group needs rather baroque plots and the legend is essential.",
    "created_at": "2011-01-12T01:00:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125581",
    "user": "https://trac.sagemath.org/admin/accounts/users/mhampton"
}
```

<a id='comment:5'></a>Unfortunately the current fix at #7981 does NOT fix this.  Its extremely annoying for me, since I am currently in a project in which my group needs rather baroque plots and the legend is essential.



---

archive/issue_comments_125582.json:
```json
{
    "body": "<a id='comment:6'></a>This seems like a clue:\n\n```\nsage: p= plot(x,(x,0,10),legend_label='Fantastic legend label', gridlines='major')\nsage: print p._extra_kwds\n{'gridlines': 'major'}\n```\n\nI would think that the legend info would show up in _extra_kwds, but I my understanding of the plotting code is weak.",
    "created_at": "2011-01-12T01:13:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125582",
    "user": "https://trac.sagemath.org/admin/accounts/users/mhampton"
}
```

<a id='comment:6'></a>This seems like a clue:

```
sage: p= plot(x,(x,0,10),legend_label='Fantastic legend label', gridlines='major')
sage: print p._extra_kwds
{'gridlines': 'major'}
```

I would think that the legend info would show up in _extra_kwds, but I my understanding of the plotting code is weak.



---

archive/issue_comments_125583.json:
```json
{
    "body": "<a id='comment:8'></a>I think I figured this out, patch coming in a moment.",
    "created_at": "2011-01-12T02:09:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125583",
    "user": "https://trac.sagemath.org/admin/accounts/users/mhampton"
}
```

<a id='comment:8'></a>I think I figured this out, patch coming in a moment.



---

archive/issue_comments_125584.json:
```json
{
    "body": "Fixes problem by adding suboptions decorator to save command",
    "created_at": "2011-01-12T02:14:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125584",
    "user": "https://trac.sagemath.org/admin/accounts/users/mhampton"
}
```

Fixes problem by adding suboptions decorator to save command



---

archive/issue_comments_125585.json:
```json
{
    "body": "Changing author from \"\" to \"Marshall Hampton\"",
    "created_at": "2011-01-12T02:14:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125585",
    "user": "https://trac.sagemath.org/admin/accounts/users/mhampton"
}
```

Changing author from "" to "Marshall Hampton"



---

archive/issue_comments_125586.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-01-12T02:14:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125586",
    "user": "https://trac.sagemath.org/admin/accounts/users/mhampton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_125587.json:
```json
{
    "body": "<a id='comment:9'></a>Attachment [trac_10244_legend_label_fix.patch](tarball://root/attachments/some-uuid/ticket10244/trac_10244_legend_label_fix.patch) by mhampton created at 2011-01-12 02:14:19",
    "created_at": "2011-01-12T02:14:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125587",
    "user": "https://trac.sagemath.org/admin/accounts/users/mhampton"
}
```

<a id='comment:9'></a>Attachment [trac_10244_legend_label_fix.patch](tarball://root/attachments/some-uuid/ticket10244/trac_10244_legend_label_fix.patch) by mhampton created at 2011-01-12 02:14:19



---

archive/issue_comments_125588.json:
```json
{
    "body": "<a id='comment:10'></a>\"maybe we never initialized them but then try to access them.\"   Glad to know that I did sort of understand it :)  If no one reviews this, I might look at it tomorrow.",
    "created_at": "2011-01-12T02:43:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125588",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:10'></a>"maybe we never initialized them but then try to access them."   Glad to know that I did sort of understand it :)  If no one reviews this, I might look at it tomorrow.



---

archive/issue_comments_125589.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-01-12T15:19:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125589",
    "user": "https://github.com/kcrisman"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_125590.json:
```json
{
    "body": "<a id='comment:11'></a>This does fix the original problem.  That should be doctested, something like\n\n```\nsage: P = plot(x,(x,0,1),legend_label='$xyz$')\nsage: P.set_legend_options(back_color=(1,0,0))\nsage: P.set_legend_options(loc=7)\nsage: P.save() # but with the usual temp saving directory used!\n```\n\nIt does NOT seem to fix Jason's issue with\n\n```\nplot(x,(x,0,1),aspect_ratio=1).save('test.png')\n```\nNor does it fix this :(\n\n```\nsage: P = plot(x,(x,0,1),legend_label='$xyz$')\nsage: P.set_legend_options(back_color=(1,0,0))\nsage: P # has nasty red background for label\nsage: Q = plot(x,(x,0,1),legend_label='$xyz$')\nsage: Q = plot(x,(x,0,1),legend_label='$xyz$',legend_back_color=(1,0,0))\n---------------------------------------------------------------------------\nRuntimeError                              Traceback (most recent call last)\n<snip>\n/Users/.../sage-4.6.1.rc1/local/lib/python2.6/site-packages/sage/plot/line.pyc in __init__(self, xdata, ydata, options)\n     46         for opt in options.iterkeys():\n     47             if opt not in valid_options:\n---> 48                 raise RuntimeError(\"Error in line(): option '%s' not valid.\"%opt)\n     49         self.xdata = xdata\n     50         self.ydata = ydata\n\nRuntimeError: Error in line(): option 'legend_back_color' not valid.\n```\nSo we aren't done yet.  But probably that should be a different ticket, since these suboptions didn't work before anyway.  Apparently we never doctested them!  Which is probably my and/or Jason's fault... :(",
    "created_at": "2011-01-12T15:19:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125590",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:11'></a>This does fix the original problem.  That should be doctested, something like

```
sage: P = plot(x,(x,0,1),legend_label='$xyz$')
sage: P.set_legend_options(back_color=(1,0,0))
sage: P.set_legend_options(loc=7)
sage: P.save() # but with the usual temp saving directory used!
```

It does NOT seem to fix Jason's issue with

```
plot(x,(x,0,1),aspect_ratio=1).save('test.png')
```
Nor does it fix this :(

```
sage: P = plot(x,(x,0,1),legend_label='$xyz$')
sage: P.set_legend_options(back_color=(1,0,0))
sage: P # has nasty red background for label
sage: Q = plot(x,(x,0,1),legend_label='$xyz$')
sage: Q = plot(x,(x,0,1),legend_label='$xyz$',legend_back_color=(1,0,0))
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
<snip>
/Users/.../sage-4.6.1.rc1/local/lib/python2.6/site-packages/sage/plot/line.pyc in __init__(self, xdata, ydata, options)
     46         for opt in options.iterkeys():
     47             if opt not in valid_options:
---> 48                 raise RuntimeError("Error in line(): option '%s' not valid."%opt)
     49         self.xdata = xdata
     50         self.ydata = ydata

RuntimeError: Error in line(): option 'legend_back_color' not valid.
```
So we aren't done yet.  But probably that should be a different ticket, since these suboptions didn't work before anyway.  Apparently we never doctested them!  Which is probably my and/or Jason's fault... :(



---

archive/issue_comments_125591.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Karl-Dieter Crisman\"",
    "created_at": "2011-01-12T15:19:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125591",
    "user": "https://github.com/kcrisman"
}
```

Changing reviewer from "" to "Karl-Dieter Crisman"



---

archive/issue_comments_125592.json:
```json
{
    "body": "<a id='comment:12'></a>Sorry - to be clear, the 'needs work' is with respect to the doctest which is needed.\n\nJason's thing is probably about `SHOW_OPTIONS` having `aspect_ratio` but `save` not having it directly defined.  Interestingly, in the documentation for `save()`, this example DOES work.\n\n```\n\n        EXAMPLES::\n        \n            sage: c = circle((1,1),1,color='red')\n            sage: filename=os.path.join(SAGE_TMP, 'test.png')\n            sage: c.save(filename, xmin=-1,xmax=3,ymin=-1,ymax=3)\n\n        To correct the aspect ratio of certain graphics, you can \n        set the ``aspect_ratio`` to 1::\n        \n            sage: c.save(filename, aspect_ratio=1, xmin=-1, xmax=3, ymin=-1, ymax=3)\n```\nBut I think this is because we have new defaults for `aspect_ratio`, not because this works in general.\n\n```\nsage: c = circle((1,1),1,color='red')\nsage: c.save(xmin=-1,xmax=5,aspect_ratio=4) # works\nsage: c = circle((1,1),1,color='red',aspect_ratio=4)\nsage: c.save(xmin=-1,xmax=5) # still aspect ratio 1\n```\n\nAny thoughts on how many tickets this should all get divided into?",
    "created_at": "2011-01-12T15:27:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125592",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:12'></a>Sorry - to be clear, the 'needs work' is with respect to the doctest which is needed.

Jason's thing is probably about `SHOW_OPTIONS` having `aspect_ratio` but `save` not having it directly defined.  Interestingly, in the documentation for `save()`, this example DOES work.

```

        EXAMPLES::
        
            sage: c = circle((1,1),1,color='red')
            sage: filename=os.path.join(SAGE_TMP, 'test.png')
            sage: c.save(filename, xmin=-1,xmax=3,ymin=-1,ymax=3)

        To correct the aspect ratio of certain graphics, you can 
        set the ``aspect_ratio`` to 1::
        
            sage: c.save(filename, aspect_ratio=1, xmin=-1, xmax=3, ymin=-1, ymax=3)
```
But I think this is because we have new defaults for `aspect_ratio`, not because this works in general.

```
sage: c = circle((1,1),1,color='red')
sage: c.save(xmin=-1,xmax=5,aspect_ratio=4) # works
sage: c = circle((1,1),1,color='red',aspect_ratio=4)
sage: c.save(xmin=-1,xmax=5) # still aspect ratio 1
```

Any thoughts on how many tickets this should all get divided into?



---

archive/issue_comments_125593.json:
```json
{
    "body": "<a id='comment:13'></a>Attachment [trac_10244_legend_label_fix_v2.patch](tarball://root/attachments/some-uuid/ticket10244/trac_10244_legend_label_fix_v2.patch) by mhampton created at 2011-01-12 17:59:08\n\nAttached patch trac_10244_legend_label_fix_v2.patch is cumulative, includes Karl-Dieter's test suggestion.\n\nI am also posting a cumulative patch with #7981 since they don't merge nicely.",
    "created_at": "2011-01-12T17:59:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125593",
    "user": "https://trac.sagemath.org/admin/accounts/users/mhampton"
}
```

<a id='comment:13'></a>Attachment [trac_10244_legend_label_fix_v2.patch](tarball://root/attachments/some-uuid/ticket10244/trac_10244_legend_label_fix_v2.patch) by mhampton created at 2011-01-12 17:59:08

Attached patch trac_10244_legend_label_fix_v2.patch is cumulative, includes Karl-Dieter's test suggestion.

I am also posting a cumulative patch with #7981 since they don't merge nicely.



---

archive/issue_comments_125594.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-01-12T17:59:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125594",
    "user": "https://trac.sagemath.org/admin/accounts/users/mhampton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_125595.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-01-12T18:42:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125595",
    "user": "https://trac.sagemath.org/admin/accounts/users/mhampton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_125596.json:
```json
{
    "body": "<a id='comment:15'></a>Just realized I need to format my test better for documentation.",
    "created_at": "2011-01-12T18:42:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125596",
    "user": "https://trac.sagemath.org/admin/accounts/users/mhampton"
}
```

<a id='comment:15'></a>Just realized I need to format my test better for documentation.



---

archive/issue_comments_125597.json:
```json
{
    "body": "<a id='comment:16'></a>This is not directly related to this ticket, but are there any plans to make something better for the numerous plot options? My concern is that the default values seems to be repeated in different places, e.g. this ticket adds them for save. This makes is difficult to change the default values since one has to find all places where they are set. It would be nice also to provide some user interface for adjusting all defaults, i.e. let the user call some commands in the beginning of the session to affect all plots. I have tried to address this for fans and cones at #9664: single storage for all defaults and a possibility to tweak them. Clearly I like that approach since I have written it, but I think that it has some objective advantages.",
    "created_at": "2011-01-12T18:55:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125597",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:16'></a>This is not directly related to this ticket, but are there any plans to make something better for the numerous plot options? My concern is that the default values seems to be repeated in different places, e.g. this ticket adds them for save. This makes is difficult to change the default values since one has to find all places where they are set. It would be nice also to provide some user interface for adjusting all defaults, i.e. let the user call some commands in the beginning of the session to affect all plots. I have tried to address this for fans and cones at #9664: single storage for all defaults and a possibility to tweak them. Clearly I like that approach since I have written it, but I think that it has some objective advantages.



---

archive/issue_comments_125598.json:
```json
{
    "body": "<a id='comment:17'></a>That's a great idea.  Some of these defaults can be manipulated already (such as xmin!) but I don't know that one would want to do each one by hand.   If you have a concrete idea for making this all work (once tickets like these are closed) please put me in the cc: field.  The plot code is already pretty hard for newcomers to find their way around, despite simplifications and refactorings of the past, so more help is great.",
    "created_at": "2011-01-12T20:46:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125598",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:17'></a>That's a great idea.  Some of these defaults can be manipulated already (such as xmin!) but I don't know that one would want to do each one by hand.   If you have a concrete idea for making this all work (once tickets like these are closed) please put me in the cc: field.  The plot code is already pretty hard for newcomers to find their way around, despite simplifications and refactorings of the past, so more help is great.



---

archive/issue_comments_125599.json:
```json
{
    "body": "<a id='comment:18'></a>Replying to [comment:17 kcrisman]:\n> That's a great idea.  Some of these defaults can be manipulated already (such as xmin!) but I don't know that one would want to do each one by hand.   If you have a concrete idea for making this all work (once tickets like these are closed) please put me in the cc: field.  The plot code is already pretty hard for newcomers to find their way around, despite simplifications and refactorings of the past, so more help is great.\n\n\nWell, in principal `toric_plotter` (which is merged and is in the global name space) is concrete and working.\n\nIt has inside a dictionary for \"Sage default options\" and another one for \"current user default options.\" Users can use commands like `toric_plotter.options(ray_thickness=2)` to change defaults for consecutive commands (and I found it very convenient for use with SageTeX, where \"Sage defaults\" don't work nicely). There is no separation into options that are easy to change and options that are difficult to change, all are treated in the same way.\n\nWhen a fan or a cone is plotted, it starts with a copy of \"current user default options\" and replaces any values in it with arguments of the plot command, if any. Then these options are used for actual plotting.\n\nAlso, all toric plotting commands have a reference to `toric_plotter.options` so all options are described in a singe place, eliminating redundancy and improving consistency.\n\nSo I was thinking of something like `plot.options(xmin=-10, xmax=10, color=\"red\")` to affect all future plotting commands in the session. One of the drawbacks of current decorators like\n\n```\nsage: plot.options\n{'fillalpha': 0.5, 'detect_poles': False, 'plot_points': 200, 'thickness': 1,\n 'alpha': 1, 'adaptive_tolerance': 0.01, 'fillcolor': 'automatic',\n 'adaptive_recursion': 5, 'exclude': None, 'legend_label': None,\n 'rgbcolor': (0, 0, 1), 'fill': False}\n```\nis that there is no description of options and they are not always easy to understand, e.g. what is `adaptive_recursion`? This is especially important if some options are \"smartly\" chosen based on others. E.g. it would be reasonable to set `fill=True` if the user has explicitly provided `fillcolor`, but such a behaviour should be explained. Note that in `circle.options` there is `FACEcolor` instead of `FILLcolor`. I suppose they are the same but got named differently because of writing the same thing in different places. Inconsistency in naming parameters and their interpretation also makes it hard to write plotting code that works both for 2d and 3d, leading to extra `if dim == 2: ... elif dim ==3: ...` for no good reason.\n\nUnfortunately, I already put a bit on my plate so rewriting plotting code is not on my todo list for now and I just complain...",
    "created_at": "2011-01-12T23:06:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125599",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:18'></a>Replying to [comment:17 kcrisman]:
> That's a great idea.  Some of these defaults can be manipulated already (such as xmin!) but I don't know that one would want to do each one by hand.   If you have a concrete idea for making this all work (once tickets like these are closed) please put me in the cc: field.  The plot code is already pretty hard for newcomers to find their way around, despite simplifications and refactorings of the past, so more help is great.


Well, in principal `toric_plotter` (which is merged and is in the global name space) is concrete and working.

It has inside a dictionary for "Sage default options" and another one for "current user default options." Users can use commands like `toric_plotter.options(ray_thickness=2)` to change defaults for consecutive commands (and I found it very convenient for use with SageTeX, where "Sage defaults" don't work nicely). There is no separation into options that are easy to change and options that are difficult to change, all are treated in the same way.

When a fan or a cone is plotted, it starts with a copy of "current user default options" and replaces any values in it with arguments of the plot command, if any. Then these options are used for actual plotting.

Also, all toric plotting commands have a reference to `toric_plotter.options` so all options are described in a singe place, eliminating redundancy and improving consistency.

So I was thinking of something like `plot.options(xmin=-10, xmax=10, color="red")` to affect all future plotting commands in the session. One of the drawbacks of current decorators like

```
sage: plot.options
{'fillalpha': 0.5, 'detect_poles': False, 'plot_points': 200, 'thickness': 1,
 'alpha': 1, 'adaptive_tolerance': 0.01, 'fillcolor': 'automatic',
 'adaptive_recursion': 5, 'exclude': None, 'legend_label': None,
 'rgbcolor': (0, 0, 1), 'fill': False}
```
is that there is no description of options and they are not always easy to understand, e.g. what is `adaptive_recursion`? This is especially important if some options are "smartly" chosen based on others. E.g. it would be reasonable to set `fill=True` if the user has explicitly provided `fillcolor`, but such a behaviour should be explained. Note that in `circle.options` there is `FACEcolor` instead of `FILLcolor`. I suppose they are the same but got named differently because of writing the same thing in different places. Inconsistency in naming parameters and their interpretation also makes it hard to write plotting code that works both for 2d and 3d, leading to extra `if dim == 2: ... elif dim ==3: ...` for no good reason.

Unfortunately, I already put a bit on my plate so rewriting plotting code is not on my todo list for now and I just complain...



---

archive/issue_comments_125600.json:
```json
{
    "body": "cumulative new patch for 7981 and 10244",
    "created_at": "2011-01-12T23:22:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125600",
    "user": "https://trac.sagemath.org/admin/accounts/users/mhampton"
}
```

cumulative new patch for 7981 and 10244



---

archive/issue_comments_125601.json:
```json
{
    "body": "<a id='comment:19'></a>Attachment [trac_7981_and_10244_cumulative.patch](tarball://root/attachments/some-uuid/ticket10244/trac_7981_and_10244_cumulative.patch) by mhampton created at 2011-01-12 23:24:07\n\nOK, I think I fixed it so the reference manual looks OK.\n\nI agree these options are a mess, but cleaning it up like Andrey suggests is beyond the scope of this ticket and my available effort.",
    "created_at": "2011-01-12T23:24:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125601",
    "user": "https://trac.sagemath.org/admin/accounts/users/mhampton"
}
```

<a id='comment:19'></a>Attachment [trac_7981_and_10244_cumulative.patch](tarball://root/attachments/some-uuid/ticket10244/trac_7981_and_10244_cumulative.patch) by mhampton created at 2011-01-12 23:24:07

OK, I think I fixed it so the reference manual looks OK.

I agree these options are a mess, but cleaning it up like Andrey suggests is beyond the scope of this ticket and my available effort.



---

archive/issue_comments_125602.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-01-12T23:25:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125602",
    "user": "https://trac.sagemath.org/admin/accounts/users/mhampton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_125603.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [comment:19 mhampton]:\n> OK, I think I fixed it so the reference manual looks OK.\n\n\nThis is fairly important, so I will try to review it soon.\n\n> I agree these options are a mess, but cleaning it up like Andrey suggests is beyond the scope of this ticket and my available effort.\n\n\nAgreed.  See #10615.",
    "created_at": "2011-01-13T01:35:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125603",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:21'></a>Replying to [comment:19 mhampton]:
> OK, I think I fixed it so the reference manual looks OK.


This is fairly important, so I will try to review it soon.

> I agree these options are a mess, but cleaning it up like Andrey suggests is beyond the scope of this ticket and my available effort.


Agreed.  See #10615.



---

archive/issue_comments_125604.json:
```json
{
    "body": "<a id='comment:22'></a>> It does NOT seem to fix Jason's issue with\n\n{{{\nplot(x,(x,0,1),aspect_ratio=1).save('test.png')\n}}}\n\nThis *is* fixed by #7981, thankfully.\n\n> Nor does it fix this :(\n\n{{{\nsage: Q = plot(x,(x,0,1),legend_label='$xyz$')\nsage: Q = plot(x,(x,0,1),legend_label='$xyz$',legend_back_color=(1,0,0))\n\n---\nRuntimeError                              Traceback (most recent call last)\n<snip>\n/Users/.../sage-4.6.1.rc1/local/lib/python2.6/site-packages/sage/plot/line.pyc in __init__(self, xdata, ydata, options)\n     46         for opt in options.iterkeys():\n     47             if opt not in valid_options:\n---> 48                 raise RuntimeError(\"Error in line(): option '%s' not valid.\"%opt)\n     49         self.xdata = xdata\n     50         self.ydata = ydata\n\nRuntimeError: Error in line(): option 'legend_back_color' not valid.\n}}}\nThis still isn't fixed in either patch, so it's now #10616.",
    "created_at": "2011-01-13T01:44:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125604",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:22'></a>> It does NOT seem to fix Jason's issue with

{{{
plot(x,(x,0,1),aspect_ratio=1).save('test.png')
}}}

This *is* fixed by #7981, thankfully.

> Nor does it fix this :(

{{{
sage: Q = plot(x,(x,0,1),legend_label='$xyz$')
sage: Q = plot(x,(x,0,1),legend_label='$xyz$',legend_back_color=(1,0,0))

---
RuntimeError                              Traceback (most recent call last)
<snip>
/Users/.../sage-4.6.1.rc1/local/lib/python2.6/site-packages/sage/plot/line.pyc in __init__(self, xdata, ydata, options)
     46         for opt in options.iterkeys():
     47             if opt not in valid_options:
---> 48                 raise RuntimeError("Error in line(): option '%s' not valid."%opt)
     49         self.xdata = xdata
     50         self.ydata = ydata

RuntimeError: Error in line(): option 'legend_back_color' not valid.
}}}
This still isn't fixed in either patch, so it's now #10616.



---

archive/issue_comments_125605.json:
```json
{
    "body": "<a id='comment:23'></a>This may need to be rebased for the slight change in #7981.  Also would be best to have a separate patch for just this - if they don't merge nicely, maybe the original needs to be rebased?",
    "created_at": "2011-01-13T03:29:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125605",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:23'></a>This may need to be rebased for the slight change in #7981.  Also would be best to have a separate patch for just this - if they don't merge nicely, maybe the original needs to be rebased?



---

archive/issue_comments_125606.json:
```json
{
    "body": "Rebased to #7981 and #8632",
    "created_at": "2011-01-14T02:50:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125606",
    "user": "https://github.com/kcrisman"
}
```

Rebased to #7981 and #8632



---

archive/issue_comments_125607.json:
```json
{
    "body": "<a id='comment:24'></a>Attachment [trac_10244_legend_label_fix_v3.patch](tarball://root/attachments/some-uuid/ticket10244/trac_10244_legend_label_fix_v3.patch) by @kcrisman created at 2011-01-14 02:59:49\n\nOkay, this should apply correctly.  \n\nTo buildbot: Depends on #7981 and #8632, apply only trac_10244_legend_label_fix_v3.patch\n\nI noticed a few other things that apparently weren't caught the first time (meaning they were already present before this ticket), and may fix them in a brief reviewer patch shortly.",
    "created_at": "2011-01-14T02:59:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125607",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:24'></a>Attachment [trac_10244_legend_label_fix_v3.patch](tarball://root/attachments/some-uuid/ticket10244/trac_10244_legend_label_fix_v3.patch) by @kcrisman created at 2011-01-14 02:59:49

Okay, this should apply correctly.  

To buildbot: Depends on #7981 and #8632, apply only trac_10244_legend_label_fix_v3.patch

I noticed a few other things that apparently weren't caught the first time (meaning they were already present before this ticket), and may fix them in a brief reviewer patch shortly.



---

archive/issue_comments_125608.json:
```json
{
    "body": "reviewer patch",
    "created_at": "2011-01-14T03:21:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125608",
    "user": "https://github.com/kcrisman"
}
```

reviewer patch



---

archive/issue_comments_125609.json:
```json
{
    "body": "<a id='comment:25'></a>Attachment [trac_10244-reviewer.patch](tarball://root/attachments/some-uuid/ticket10244/trac_10244-reviewer.patch) by @kcrisman created at 2011-01-14 03:24:44\n\nTurns out that some of the defaults weren't the same as the documentation.  The legends look nice, so I changed the documentation to reflect the defaults.  Also, it was `handlelength`, not `handlelen`.  I also accidentally didn't get the right formatting since I based it on the earlier patch, so I fixed that goof of mine in the rebase.\n\nThis is significant enough that I would appreciate a review by someone of the review patch - original author is fine!  But all should be well.\n\nTo buildbot: Depends on #7981 and #8632, apply trac_10244_legend_label_fix_v3.patch and trac_10244-reviewer.patch",
    "created_at": "2011-01-14T03:24:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125609",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:25'></a>Attachment [trac_10244-reviewer.patch](tarball://root/attachments/some-uuid/ticket10244/trac_10244-reviewer.patch) by @kcrisman created at 2011-01-14 03:24:44

Turns out that some of the defaults weren't the same as the documentation.  The legends look nice, so I changed the documentation to reflect the defaults.  Also, it was `handlelength`, not `handlelen`.  I also accidentally didn't get the right formatting since I based it on the earlier patch, so I fixed that goof of mine in the rebase.

This is significant enough that I would appreciate a review by someone of the review patch - original author is fine!  But all should be well.

To buildbot: Depends on #7981 and #8632, apply trac_10244_legend_label_fix_v3.patch and trac_10244-reviewer.patch



---

archive/issue_comments_125610.json:
```json
{
    "body": "<a id='comment:26'></a>Just FYI - still applies fine on 4.6.2.alpha0.",
    "created_at": "2011-01-15T03:21:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125610",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:26'></a>Just FYI - still applies fine on 4.6.2.alpha0.



---

archive/issue_comments_125611.json:
```json
{
    "body": "<a id='comment:27'></a>Upon actually looking at the patch I generated, it's much smaller than I thought, and only a few numbers are changed in the doc (the other change is fixing the formatting, which Marshall had already done).  So I'm comfortable with giving this positive review after all.",
    "created_at": "2011-01-17T18:03:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125611",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:27'></a>Upon actually looking at the patch I generated, it's much smaller than I thought, and only a few numbers are changed in the doc (the other change is fixing the formatting, which Marshall had already done).  So I'm comfortable with giving this positive review after all.



---

archive/issue_comments_125612.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-01-17T18:03:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125612",
    "user": "https://github.com/kcrisman"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_125613.json:
```json
{
    "body": "<a id='comment:28'></a>Depends on #8632\n\n(I think that build bot get's confused if we methion the first one which is already listed in the second one).",
    "created_at": "2011-01-18T22:43:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125613",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:28'></a>Depends on #8632

(I think that build bot get's confused if we methion the first one which is already listed in the second one).



---

archive/issue_comments_125614.json:
```json
{
    "body": "Changing status from positive_review to needs_info.",
    "created_at": "2011-01-19T01:33:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125614",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_info.



---

archive/issue_comments_125615.json:
```json
{
    "body": "<a id='comment:29'></a>Please clarify which patches have to be applied.",
    "created_at": "2011-01-19T01:33:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125615",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:29'></a>Please clarify which patches have to be applied.



---

archive/issue_comments_125616.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2011-01-19T01:35:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125616",
    "user": "https://github.com/novoselt"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_125617.json:
```json
{
    "body": "<a id='comment:30'></a>Please apply trac_10244_legend_label_fix_v3.patch and trac_10244-reviewer.patch",
    "created_at": "2011-01-19T01:35:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125617",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:30'></a>Please apply trac_10244_legend_label_fix_v3.patch and trac_10244-reviewer.patch



---

archive/issue_comments_125618.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-01-19T01:35:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125618",
    "user": "https://github.com/novoselt"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_125619.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -15,6 +15,8 @@\n KeyError: 'pop(): dictionary is empty'\n ```\n \n+**Apply:** [attachment:trac_10244_legend_label_fix_v3.patch] and [attachment:trac_10244-reviewer.patch]\n+\n Comment: 1\n \n Issue created by migration from https://trac.sagemath.org/ticket/10244\n``````\n",
    "created_at": "2011-01-19T01:39:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125619",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -15,6 +15,8 @@
 KeyError: 'pop(): dictionary is empty'
 ```
 
+**Apply:** [attachment:trac_10244_legend_label_fix_v3.patch] and [attachment:trac_10244-reviewer.patch]
+
 Comment: 1
 
 Issue created by migration from https://trac.sagemath.org/ticket/10244
``````




---

archive/issue_events_026315.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2011-01-20T06:04:00Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "milestone": "sage-4.6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10244#event-26315"
}
```



---

archive/issue_events_026316.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-01-25T08:15:08Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10244#event-26316"
}
```



---

archive/issue_comments_125620.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-01-25T08:15:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125620",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_125621.json:
```json
{
    "body": "Changing merged from \"\" to \"sage-4.6.2.alpha2\"",
    "created_at": "2011-01-25T08:15:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10244",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10244#issuecomment-125621",
    "user": "https://github.com/jdemeyer"
}
```

Changing merged from "" to "sage-4.6.2.alpha2"
