# Issue 10195: Occasional doctest failure in libs/fplll/fplll.pyx

archive/issues_010194.json:
```json
{
    "assignees": [
        "https://github.com/sagetrac-mvngu"
    ],
    "body": "Reported on [sage-devel](http://groups.google.com/group/sage-devel/browse_thread/thread/145fb7e073d4e12b):\n\n```\nI ran\n\n./sage -t -long -force_lib \"devel/sage/sage/libs/fplll/fplll.pyx\"\n\n1000 times in serial [1] with a 64-bit 4.6.rc0 built on OS X 10.6\n(bsd.math).  All but one of the runs pass.  The failure:\n\nRun 766 of 1000\nDetected SAGE64 flag\nBuilding Sage on OS X in 64-bit mode\nsage -t -long -force_lib \"devel/sage/sage/libs/fplll/fplll.pyx\"\n**********************************************************************\nFile\n\"/Users/buildbot/build/sage/bsd-2/bsd_64_full/build/sage-4.6.0pre0/devel/sa\nge/sage/libs/fplll/fplll.pyx\", line 853:\n    sage: L.echelon_form() == A.echelon_form()\nExpected:\n    True\nGot:\n    False\n```\n\nThe error also occurs with a 32-bit build on bsd.math (OS X 10.6, 5 out of 1000 runs) and on sage.math (64-bit Ubuntu 8.04.4 LTS, 6 of 1000 runs).\n\nDavid Kirkby does **not** get any incorrect results on OpenSolaris 06/2009 after more than 15000 runs with 4.6.rc0 and more than 16000 with 4.6.1.alpha0. He had a total of 31748 passes. However, he did experience 109 doctest failures which are likely to be result of doctesting two copies of Sage simultaneously, as these were using the same directory for temporary files (`$HOME/.sage/tmp`). His errors were like  this:\n\n```\nRun 442 of 100000\nsage -t -long -force_lib \"devel/sage/sage/libs/fplll/fplll.pyx\"\npython: can't open file '/export/home/drkirkby/.sage//tmp/fplll.py':\n[Errno 2] No such file or directory\n\n        [0.2 s]\n```\n\nand never due to False being return instead of True. His problems are probably the result of the issues discussed on #9739. Once David only tested one copy of Sage at a time, there were 0 failures in 17230 tests of sage-4.6.rc0. (Note, since Sage currently only works well on Solaris or OpenSolaris if built as a 32-bit application, this was a 32-bit build).  \n\nDepends on #11130\n\nCC:  @sagetrac-drkirkby @malb @jdemeyer\n\nComponent: **doctest coverage**\n\nReviewer: **Jeroen Demeyer**\n\nUpstream: **Fixed upstream, in a later stable release.**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/10195_\n\n",
    "closed_at": "2011-10-17T07:57:39Z",
    "created_at": "2010-10-31T10:10:58Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/bug",
        "https://github.com/sagemath/sage/labels/doctest%20coverage",
        "https://github.com/sagemath/sage/labels/duplicate"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Occasional doctest failure in libs/fplll/fplll.pyx",
    "type": "issue",
    "updated_at": "2011-10-17T07:57:39Z",
    "url": "https://github.com/sagemath/sage/issues/10195",
    "user": "https://github.com/qed777"
}
```
Reported on [sage-devel](http://groups.google.com/group/sage-devel/browse_thread/thread/145fb7e073d4e12b):

```
I ran

./sage -t -long -force_lib "devel/sage/sage/libs/fplll/fplll.pyx"

1000 times in serial [1] with a 64-bit 4.6.rc0 built on OS X 10.6
(bsd.math).  All but one of the runs pass.  The failure:

Run 766 of 1000
Detected SAGE64 flag
Building Sage on OS X in 64-bit mode
sage -t -long -force_lib "devel/sage/sage/libs/fplll/fplll.pyx"
**********************************************************************
File
"/Users/buildbot/build/sage/bsd-2/bsd_64_full/build/sage-4.6.0pre0/devel/sa
ge/sage/libs/fplll/fplll.pyx", line 853:
    sage: L.echelon_form() == A.echelon_form()
Expected:
    True
Got:
    False
```

The error also occurs with a 32-bit build on bsd.math (OS X 10.6, 5 out of 1000 runs) and on sage.math (64-bit Ubuntu 8.04.4 LTS, 6 of 1000 runs).

David Kirkby does **not** get any incorrect results on OpenSolaris 06/2009 after more than 15000 runs with 4.6.rc0 and more than 16000 with 4.6.1.alpha0. He had a total of 31748 passes. However, he did experience 109 doctest failures which are likely to be result of doctesting two copies of Sage simultaneously, as these were using the same directory for temporary files (`$HOME/.sage/tmp`). His errors were like  this:

```
Run 442 of 100000
sage -t -long -force_lib "devel/sage/sage/libs/fplll/fplll.pyx"
python: can't open file '/export/home/drkirkby/.sage//tmp/fplll.py':
[Errno 2] No such file or directory

        [0.2 s]
```

and never due to False being return instead of True. His problems are probably the result of the issues discussed on #9739. Once David only tested one copy of Sage at a time, there were 0 failures in 17230 tests of sage-4.6.rc0. (Note, since Sage currently only works well on Solaris or OpenSolaris if built as a 32-bit application, this was a 32-bit build).  

Depends on #11130

CC:  @sagetrac-drkirkby @malb @jdemeyer

Component: **doctest coverage**

Reviewer: **Jeroen Demeyer**

Upstream: **Fixed upstream, in a later stable release.**

_Issue created by migration from https://trac.sagemath.org/ticket/10195_





---

archive/issue_events_133712.json:
```json
{
    "actor": "https://github.com/qed777",
    "created_at": "2010-10-31T10:10:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "milestone_number": null,
    "milestone_title": "sage-4.7.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10195#event-133712"
}
```



---

archive/issue_events_133713.json:
```json
{
    "actor": "https://github.com/qed777",
    "created_at": "2010-10-31T10:10:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "label": "https://github.com/sagemath/sage/labels/doctest%20coverage",
    "label_color": "696969",
    "label_name": "doctest coverage",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10195#event-133713"
}
```



---

archive/issue_events_133714.json:
```json
{
    "actor": "https://github.com/qed777",
    "created_at": "2010-10-31T10:10:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10195#event-133714"
}
```



---

archive/issue_events_133715.json:
```json
{
    "actor": "https://github.com/sagetrac-mvngu",
    "created_at": "2010-10-31T10:10:58Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "subject": "https://github.com/qed777",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10195#event-133715"
}
```



---

archive/issue_events_133716.json:
```json
{
    "actor": "https://github.com/qed777",
    "created_at": "2010-10-31T10:19:30Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10195#event-133716"
}
```



---

archive/issue_comments_094730.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nLeif Leonhardy's results:\n\n```\n3/1000 failures on Ubuntu 10.04 x86_64 (Core2), Sage 4.6.rc0, first\nrun.\n4/1000 failures on Ubuntu 10.04 x86_64 (Core2), Sage 4.6.rc0, second\nrun.\n3/1000 failures on Ubuntu 9.04 x86_64 (Core2), Sage 4.6.rc0, first\nrun.\n2/ 500 failures on Ubuntu 9.04 x86_64 (Core2), Sage 4.6.rc0, second\nrun.\n5/1000 failures on Ubuntu 9.04 x86 (Pentium 4 Prescott), Sage 4.6.rc0.\n\n(Exactly the same as above, line 853, False instead of True.) \n```",
    "created_at": "2010-10-31T10:23:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10195#issuecomment-94730",
    "user": "https://github.com/qed777"
}
```

<div id="comment:2" align="right">comment:2</div>

Leif Leonhardy's results:

```
3/1000 failures on Ubuntu 10.04 x86_64 (Core2), Sage 4.6.rc0, first
run.
4/1000 failures on Ubuntu 10.04 x86_64 (Core2), Sage 4.6.rc0, second
run.
3/1000 failures on Ubuntu 9.04 x86_64 (Core2), Sage 4.6.rc0, first
run.
2/ 500 failures on Ubuntu 9.04 x86_64 (Core2), Sage 4.6.rc0, second
run.
5/1000 failures on Ubuntu 9.04 x86 (Pentium 4 Prescott), Sage 4.6.rc0.

(Exactly the same as above, line 853, False instead of True.) 
```



---

archive/issue_comments_094731.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -25,12 +25,4 @@\n \n The error also occurs with a 32-bit build on bsd.math (OS X 10.6, 5 out of 1000 runs) and on sage.math (64-bit Ubuntu 8.04.4 LTS, 6 of 1000 runs).\n \n-David Kirkby does not get the error above on OpenSolaris but does see\n-\n-```\n-Run 442 of 100000\n-sage -t -long -force_lib \"devel/sage/sage/libs/fplll/fplll.pyx\"\n-python: can't open file '/export/home/drkirkby/.sage//tmp/fplll.py':\n-[Errno 2] No such file or directory \n-```\n-38 times after 14875 runs.\n+David Kirkby does **not** any failures on OpenSolaris after about 15000 runs with 4.6.rc0 and about 15000 with 4.6.alpha1.\n``````\n",
    "created_at": "2010-10-31T10:23:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10195#issuecomment-94731",
    "user": "https://github.com/qed777"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -25,12 +25,4 @@
 
 The error also occurs with a 32-bit build on bsd.math (OS X 10.6, 5 out of 1000 runs) and on sage.math (64-bit Ubuntu 8.04.4 LTS, 6 of 1000 runs).
 
-David Kirkby does not get the error above on OpenSolaris but does see
-
-```
-Run 442 of 100000
-sage -t -long -force_lib "devel/sage/sage/libs/fplll/fplll.pyx"
-python: can't open file '/export/home/drkirkby/.sage//tmp/fplll.py':
-[Errno 2] No such file or directory 
-```
-38 times after 14875 runs.
+David Kirkby does **not** any failures on OpenSolaris after about 15000 runs with 4.6.rc0 and about 15000 with 4.6.alpha1.
``````




---

archive/issue_comments_094732.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -25,4 +25,4 @@\n \n The error also occurs with a 32-bit build on bsd.math (OS X 10.6, 5 out of 1000 runs) and on sage.math (64-bit Ubuntu 8.04.4 LTS, 6 of 1000 runs).\n \n-David Kirkby does **not** any failures on OpenSolaris after about 15000 runs with 4.6.rc0 and about 15000 with 4.6.alpha1.\n+David Kirkby does **not** get any failures on OpenSolaris after about 15000 runs with 4.6.rc0 and about 15000 with 4.6.alpha1.\n``````\n",
    "created_at": "2010-10-31T10:23:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10195#issuecomment-94732",
    "user": "https://github.com/qed777"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -25,4 +25,4 @@
 
 The error also occurs with a 32-bit build on bsd.math (OS X 10.6, 5 out of 1000 runs) and on sage.math (64-bit Ubuntu 8.04.4 LTS, 6 of 1000 runs).
 
-David Kirkby does **not** any failures on OpenSolaris after about 15000 runs with 4.6.rc0 and about 15000 with 4.6.alpha1.
+David Kirkby does **not** get any failures on OpenSolaris after about 15000 runs with 4.6.rc0 and about 15000 with 4.6.alpha1.
``````




---

archive/issue_comments_094733.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -25,4 +25,15 @@\n \n The error also occurs with a 32-bit build on bsd.math (OS X 10.6, 5 out of 1000 runs) and on sage.math (64-bit Ubuntu 8.04.4 LTS, 6 of 1000 runs).\n \n-David Kirkby does **not** get any failures on OpenSolaris after about 15000 runs with 4.6.rc0 and about 15000 with 4.6.alpha1.\n+David Kirkby does **not** get any incorrect results on OpenSolaris 06/2009 after more than 15000 runs with 4.6.rc0 and more than 16000 with 4.6.1.alpha0. He had a total of 31748 passes. However, he did experience 109 doctest failures which are likely to be result of doctesting two copies of Sage simultaneously, as these were using the same directory for temporary files (`$HOME/.sage/tmp`). His errors were like  this:\n+\n+```\n+Run 442 of 100000\n+sage -t -long -force_lib \"devel/sage/sage/libs/fplll/fplll.pyx\"\n+python: can't open file '/export/home/drkirkby/.sage//tmp/fplll.py':\n+[Errno 2] No such file or directory\n+\n+        [0.2 s]\n+```\n+\n+and never due to False being return instead of True. \n``````\n",
    "created_at": "2010-10-31T10:34:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10195#issuecomment-94733",
    "user": "https://github.com/sagetrac-drkirkby"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -25,4 +25,15 @@
 
 The error also occurs with a 32-bit build on bsd.math (OS X 10.6, 5 out of 1000 runs) and on sage.math (64-bit Ubuntu 8.04.4 LTS, 6 of 1000 runs).
 
-David Kirkby does **not** get any failures on OpenSolaris after about 15000 runs with 4.6.rc0 and about 15000 with 4.6.alpha1.
+David Kirkby does **not** get any incorrect results on OpenSolaris 06/2009 after more than 15000 runs with 4.6.rc0 and more than 16000 with 4.6.1.alpha0. He had a total of 31748 passes. However, he did experience 109 doctest failures which are likely to be result of doctesting two copies of Sage simultaneously, as these were using the same directory for temporary files (`$HOME/.sage/tmp`). His errors were like  this:
+
+```
+Run 442 of 100000
+sage -t -long -force_lib "devel/sage/sage/libs/fplll/fplll.pyx"
+python: can't open file '/export/home/drkirkby/.sage//tmp/fplll.py':
+[Errno 2] No such file or directory
+
+        [0.2 s]
+```
+
+and never due to False being return instead of True. 
``````




---

archive/issue_comments_094734.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nI reckon you Linux and OS X users should upgrade to Solaris! \n\nDave",
    "created_at": "2010-10-31T10:58:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10195#issuecomment-94734",
    "user": "https://github.com/sagetrac-drkirkby"
}
```

<div id="comment:5" align="right">comment:5</div>

I reckon you Linux and OS X users should upgrade to Solaris! 

Dave



---

archive/issue_comments_094735.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nReplying to [@sagetrac-drkirkby](#comment:5):\n> I reckon you Linux and OS X users should upgrade to Solaris! \n> \n> Dave \n\nWhat if those failures are *intended* by the fplll authors, but just do *not* work on *your* machine / operating system? Or just those \"file not found\" instances would have been the ones failing... Nobody knows. ;-)\n\n(At least regarding memory and CPUs, I trust most of my machines; they didn't show any bit errors I certainly would have noticed for at least month of continuous computations whose results I could verify...)\n\nBtw, one could also try something like\n\n```sh\n$ export SAGE_TEST_GLOBAL_ITER=1000\n$ ./sage -tp 1 -long devel/sage/sage/libs/fplll/fplll.pyx 2>&1 | tee fplll-test.log\n$ echo \"`grep -c All fplll-test.log` out of 1000 runs did NOT fail.\"\n$ echo \"`grep -c Got fplll-test.log` tests out of 1000 gave an unexpected result.\"\n```",
    "created_at": "2010-10-31T12:31:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10195#issuecomment-94735",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:6" align="right">comment:6</div>

Replying to [@sagetrac-drkirkby](#comment:5):
> I reckon you Linux and OS X users should upgrade to Solaris! 
> 
> Dave 

What if those failures are *intended* by the fplll authors, but just do *not* work on *your* machine / operating system? Or just those "file not found" instances would have been the ones failing... Nobody knows. ;-)

(At least regarding memory and CPUs, I trust most of my machines; they didn't show any bit errors I certainly would have noticed for at least month of continuous computations whose results I could verify...)

Btw, one could also try something like

```sh
$ export SAGE_TEST_GLOBAL_ITER=1000
$ ./sage -tp 1 -long devel/sage/sage/libs/fplll/fplll.pyx 2>&1 | tee fplll-test.log
$ echo "`grep -c All fplll-test.log` out of 1000 runs did NOT fail."
$ echo "`grep -c Got fplll-test.log` tests out of 1000 gave an unexpected result."
```



---

archive/issue_comments_094736.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nReplying to [@nexttime](#comment:6):\n> Replying to [@sagetrac-drkirkby](#comment:5):\n> > I reckon you Linux and OS X users should upgrade to Solaris! \n> > \n> > Dave \n\n> \n> What if those failures are *intended* by the fplll authors, but just do *not* work on *your* machine / operating system? Or just those \"file not found\" instances would have been the ones failing... Nobody knows. ;-)\n\nI was rather expecting you to have something to say on this;-) \n\nFWIW, I'm now doctesting again, but this time only testing one instance of Sage. So errors due to using the one directory for temp files should not exist. I've only managed to run the tests 3723 times, but none of them have failed in any way whatsoever. \n\nI personally think my initial failures were due to #9739. \n\nI think the matrix used for this test might be random, which could explain failures which occur when (for example) all elements are zero. However, that would probably not explain why I don't get any failures.",
    "created_at": "2010-10-31T13:08:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10195#issuecomment-94736",
    "user": "https://github.com/sagetrac-drkirkby"
}
```

<div id="comment:7" align="right">comment:7</div>

Replying to [@nexttime](#comment:6):
> Replying to [@sagetrac-drkirkby](#comment:5):
> > I reckon you Linux and OS X users should upgrade to Solaris! 
> > 
> > Dave 

> 
> What if those failures are *intended* by the fplll authors, but just do *not* work on *your* machine / operating system? Or just those "file not found" instances would have been the ones failing... Nobody knows. ;-)

I was rather expecting you to have something to say on this;-) 

FWIW, I'm now doctesting again, but this time only testing one instance of Sage. So errors due to using the one directory for temp files should not exist. I've only managed to run the tests 3723 times, but none of them have failed in any way whatsoever. 

I personally think my initial failures were due to #9739. 

I think the matrix used for this test might be random, which could explain failures which occur when (for example) all elements are zero. However, that would probably not explain why I don't get any failures.



---

archive/issue_comments_094737.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -36,4 +36,4 @@\n         [0.2 s]\n ```\n \n-and never due to False being return instead of True. \n+and never due to False being return instead of True. His problems are probably the result of the issues discussed on #9739.\n``````\n",
    "created_at": "2010-10-31T13:08:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10195#issuecomment-94737",
    "user": "https://github.com/sagetrac-drkirkby"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -36,4 +36,4 @@
         [0.2 s]
 ```
 
-and never due to False being return instead of True. 
+and never due to False being return instead of True. His problems are probably the result of the issues discussed on #9739.
``````




---

archive/issue_comments_094738.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nI'm cc'ing  Martin Albrecht on this, as he is the author of the library interface. \n\nI'll take a guess at what is happening here. I believe gcc uses the 387 by default on 32-bit builds and the SSE instructions on 32-bit builds for 64-bit builds. So the precision of the results will be increased on 32-bit builds, as the FPU is using 80 bits internally, not 64 as it does with the SSE instructions. \n\nI suspect recompiling libfpll with -mfpmath=387 on 64-bit builds would solve this. See\n\nhttp://gcc.gnu.org/onlinedocs/gcc/i386-and-x86_002d64-Options.html#i386-and-x86_002d64-Options\n\nDave",
    "created_at": "2010-10-31T13:28:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10195#issuecomment-94738",
    "user": "https://github.com/sagetrac-drkirkby"
}
```

<div id="comment:8" align="right">comment:8</div>

I'm cc'ing  Martin Albrecht on this, as he is the author of the library interface. 

I'll take a guess at what is happening here. I believe gcc uses the 387 by default on 32-bit builds and the SSE instructions on 32-bit builds for 64-bit builds. So the precision of the results will be increased on 32-bit builds, as the FPU is using 80 bits internally, not 64 as it does with the SSE instructions. 

I suspect recompiling libfpll with -mfpmath=387 on 64-bit builds would solve this. See

http://gcc.gnu.org/onlinedocs/gcc/i386-and-x86_002d64-Options.html#i386-and-x86_002d64-Options

Dave



---

archive/issue_comments_094739.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nMore data (Ubuntu 9.04 x86_64, Core2):\n\n```\nFailures: 29/5000\nFailed runs: 468 560 588 656 691 849 909 993 1054 1133 1391 1437 1443 1761 1845 1848 2293 2294 2529 2801 2848 2938 2992 3433 3665 3862 3940 4432 4661\n```\n\nUbuntu 9.04 x86 with `env SAGE_TEST_GLOBAL_ITER=1000 ./sage -tp 1 -long ...`: 3/1000 failed.",
    "created_at": "2010-10-31T14:12:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10195#issuecomment-94739",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:9" align="right">comment:9</div>

More data (Ubuntu 9.04 x86_64, Core2):

```
Failures: 29/5000
Failed runs: 468 560 588 656 691 849 909 993 1054 1133 1391 1437 1443 1761 1845 1848 2293 2294 2529 2801 2848 2938 2992 3433 3665 3862 3940 4432 4661
```

Ubuntu 9.04 x86 with `env SAGE_TEST_GLOBAL_ITER=1000 ./sage -tp 1 -long ...`: 3/1000 failed.



---

archive/issue_comments_094740.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nDave, what happens if you run the following?\n\n```python\nfrom sage.libs.fplll.fplll import gen_ajtai\n\nruns=1000000\nverbose=1\nfailed=[]\n\nfor i in xrange(1,runs):\n    A = gen_ajtai(10, 0.7)\n    L = A.LLL()\n    # L.is_LLL_reduced()\n    # True\n    if not (L.echelon_form() == A.echelon_form()):\n        failed += [ i ]\n        print \"Test #%d failed:\" % i\n        if verbose:\n            print \"A:\\n\", A\n            print \"L:\\n\", L\n            if verbose>1:\n                print \"A.echelon_form()\\n\", A.echelon_form()\n                print \"L.echelon_form()\\n\", L.echelon_form()\n\nprint \"%d out of %d tests failed:\\n\" % (len(failed), runs)\nprint failed\n```",
    "created_at": "2010-10-31T15:23:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10195#issuecomment-94740",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:10" align="right">comment:10</div>

Dave, what happens if you run the following?

```python
from sage.libs.fplll.fplll import gen_ajtai

runs=1000000
verbose=1
failed=[]

for i in xrange(1,runs):
    A = gen_ajtai(10, 0.7)
    L = A.LLL()
    # L.is_LLL_reduced()
    # True
    if not (L.echelon_form() == A.echelon_form()):
        failed += [ i ]
        print "Test #%d failed:" % i
        if verbose:
            print "A:\n", A
            print "L:\n", L
            if verbose>1:
                print "A.echelon_form()\n", A.echelon_form()
                print "L.echelon_form()\n", L.echelon_form()

print "%d out of %d tests failed:\n" % (len(failed), runs)
print failed
```



---

archive/issue_comments_094741.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nReplying to [@sagetrac-drkirkby](#comment:8):\n> I suspect recompiling libfpll with -mfpmath=387 on 64-bit builds would solve this.\n\nAt least recompilation of libfplll and `sage/libs/fplll/*` with `-mfpmath=387` on the (32-bit) Pentium 4 Prescott doesn't change the outcome (on which I usually compile with `-mfpmath=sse`).",
    "created_at": "2010-10-31T15:49:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10195#issuecomment-94741",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:11" align="right">comment:11</div>

Replying to [@sagetrac-drkirkby](#comment:8):
> I suspect recompiling libfpll with -mfpmath=387 on 64-bit builds would solve this.

At least recompilation of libfplll and `sage/libs/fplll/*` with `-mfpmath=387` on the (32-bit) Pentium 4 Prescott doesn't change the outcome (on which I usually compile with `-mfpmath=sse`).



---

archive/issue_comments_094742.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@nexttime](#comment:10):\n> Dave, what happens if you run the following?\n\n<snip>\n\nWell, I did a quick check - just 10,000 runs, and there were 19 failures\n\n```\nsage: print \"%d out of %d tests failed:\\n\" % (len(failed), runs)\n19 out of 10000 tests failed:\n\nsage: print failed\n[432, 654, 1219, 1264, 1326, 1490, 1696, 2366, 2622, 3049, 3626, 3835, 4239, 5221, 5368, 6148, 7007, 9661, 9792]\n```\n\nSee attached file\n\nDave",
    "created_at": "2010-11-01T00:20:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10195#issuecomment-94742",
    "user": "https://github.com/sagetrac-drkirkby"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@nexttime](#comment:10):
> Dave, what happens if you run the following?

<snip>

Well, I did a quick check - just 10,000 runs, and there were 19 failures

```
sage: print "%d out of %d tests failed:\n" % (len(failed), runs)
19 out of 10000 tests failed:

sage: print failed
[432, 654, 1219, 1264, 1326, 1490, 1696, 2366, 2622, 3049, 3626, 3835, 4239, 5221, 5368, 6148, 7007, 9661, 9792]
```

See attached file

Dave



---

archive/issue_comments_094743.json:
```json
{
    "body": "Attachment: **[OpenSolaris-failures-with-Leifs-program.txt](https://github.com/sagemath/sage/files/ticket10195/OpenSolaris-failures-with-Leifs-program.txt)**\n\n19 failures in 10,000 runs on OpenSolaris using Leifs script. The actual doctest has never failed in many thosands of runs",
    "created_at": "2010-11-01T00:21:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10195#issuecomment-94743",
    "user": "https://github.com/sagetrac-drkirkby"
}
```

Attachment: **[OpenSolaris-failures-with-Leifs-program.txt](https://github.com/sagemath/sage/files/ticket10195/OpenSolaris-failures-with-Leifs-program.txt)**

19 failures in 10,000 runs on OpenSolaris using Leifs script. The actual doctest has never failed in many thosands of runs



---

archive/issue_comments_094744.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -36,4 +36,4 @@\n         [0.2 s]\n ```\n \n-and never due to False being return instead of True. His problems are probably the result of the issues discussed on #9739.\n+and never due to False being return instead of True. His problems are probably the result of the issues discussed on #9739. Once David only tested one copy of Sage at a time, there were 0 failures in 17230 tests of sage-4.6.rc0. (Note, since Sage currently only works well on Solaris or OpenSolaris if built as a 32-bit application, this was a 32-bit build).  \n``````\n",
    "created_at": "2010-11-01T00:32:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10195#issuecomment-94744",
    "user": "https://github.com/sagetrac-drkirkby"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -36,4 +36,4 @@
         [0.2 s]
 ```
 
-and never due to False being return instead of True. His problems are probably the result of the issues discussed on #9739.
+and never due to False being return instead of True. His problems are probably the result of the issues discussed on #9739. Once David only tested one copy of Sage at a time, there were 0 failures in 17230 tests of sage-4.6.rc0. (Note, since Sage currently only works well on Solaris or OpenSolaris if built as a 32-bit application, this was a 32-bit build).  
``````




---

archive/issue_comments_094745.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@sagetrac-drkirkby](#comment:12):\n> Replying to [@nexttime](#comment:10):\n> > Dave, what happens if you run the following?\n\n> \n> <snip>\n> \n> Well, I did a quick check - just 10,000 runs, and there were 19 failures\n\nWow, that's more then I get. (I did a couple of tests on three machines, with 100,000 and 1,000,000 \"runs\"; the failure rate in comparison to the doctests dropped to about 0.15-0.17%.)\n\nI've also rebuilt rc0 from scratch with `SAGE87=yes` on x86_64, and besides 7 new doctest errors, three of them PARI \"bugs\", one numerical noise, the failures remain; approximately same ratio with the Python program.",
    "created_at": "2010-11-01T00:40:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10195#issuecomment-94745",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@sagetrac-drkirkby](#comment:12):
> Replying to [@nexttime](#comment:10):
> > Dave, what happens if you run the following?

> 
> <snip>
> 
> Well, I did a quick check - just 10,000 runs, and there were 19 failures

Wow, that's more then I get. (I did a couple of tests on three machines, with 100,000 and 1,000,000 "runs"; the failure rate in comparison to the doctests dropped to about 0.15-0.17%.)

I've also rebuilt rc0 from scratch with `SAGE87=yes` on x86_64, and besides 7 new doctest errors, three of them PARI "bugs", one numerical noise, the failures remain; approximately same ratio with the Python program.



---

archive/issue_comments_094746.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nThis may actually be a bug in `echelon_form()`. Manual inspection of one of the failing matrices shows that `A.echelon_form()` doesn't actually return a matrix in HNF, but that the row spaces of `A.echelon_form()` and `L.echelon_form()` are in fact equal.",
    "created_at": "2011-01-10T03:24:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10195#issuecomment-94746",
    "user": "https://github.com/wjp"
}
```

<div id="comment:15" align="right">comment:15</div>

This may actually be a bug in `echelon_form()`. Manual inspection of one of the failing matrices shows that `A.echelon_form()` doesn't actually return a matrix in HNF, but that the row spaces of `A.echelon_form()` and `L.echelon_form()` are in fact equal.



---

archive/issue_comments_094747.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nBy the way, these failures are deterministic, so there's no need to do extensive loops.\n\nOne example that fails in pari/gp 2.4.3 (in sage), but works with pari/gp 2.3.1:\n\n```\nmathnf([0, 0, 0, 0, 0, 0, 0, 0, 0, 13; 0, 0, 0, 0, 0, 0, 0, 0, 23, 6; \\\n0, 0, 0, 0, 0, 0, 0, 23, -4, -7; 0, 0, 0, 0, 0, 0, 17, -3, 5, -5; \\\n0, 0, 0, 0, 0, 56, 16, -16, -15, -17; 0, 0, 0, 0, 57, 24, -16, -25, 2, -21; \\\n0, 0, 0, 114, 9, 56, 51, -52, 25, -55; 0, 0, 113, -31, -11, 24, 0, 28, 34, -16; \\\n0, 50, 3, 2, 16, -6, -2, 7, -19, -21; 118, 43, 51, 23, 37, -52, 18, 38, 51, 28], 0)\n```\n\nI'll investigate some more, and then report this upstream.",
    "created_at": "2011-01-10T05:57:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10195#issuecomment-94747",
    "user": "https://github.com/wjp"
}
```

<div id="comment:16" align="right">comment:16</div>

By the way, these failures are deterministic, so there's no need to do extensive loops.

One example that fails in pari/gp 2.4.3 (in sage), but works with pari/gp 2.3.1:

```
mathnf([0, 0, 0, 0, 0, 0, 0, 0, 0, 13; 0, 0, 0, 0, 0, 0, 0, 0, 23, 6; \
0, 0, 0, 0, 0, 0, 0, 23, -4, -7; 0, 0, 0, 0, 0, 0, 17, -3, 5, -5; \
0, 0, 0, 0, 0, 56, 16, -16, -15, -17; 0, 0, 0, 0, 57, 24, -16, -25, 2, -21; \
0, 0, 0, 114, 9, 56, 51, -52, 25, -55; 0, 0, 113, -31, -11, 24, 0, 28, 34, -16; \
0, 50, 3, 2, 16, -6, -2, 7, -19, -21; 118, 43, 51, 23, 37, -52, 18, 38, 51, 28], 0)
```

I'll investigate some more, and then report this upstream.



---

archive/issue_comments_094748.json:
```json
{
    "body": "Upstream: **Reported upstream. Little or no feedback.**",
    "created_at": "2011-01-10T18:32:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10195#issuecomment-94748",
    "user": "https://github.com/wjp"
}
```

Upstream: **Reported upstream. Little or no feedback.**



---

archive/issue_comments_094749.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nThis is now http://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=1153",
    "created_at": "2011-01-10T18:32:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10195#issuecomment-94749",
    "user": "https://github.com/wjp"
}
```

<div id="comment:17" align="right">comment:17</div>

This is now http://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=1153



---

archive/issue_comments_094750.json:
```json
{
    "body": "Changed upstream from **Reported upstream. Little or no feedback.** to **Reported upstream. Developers acknowledge bug.**",
    "created_at": "2011-01-25T14:33:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10195#issuecomment-94750",
    "user": "https://github.com/wjp"
}
```

Changed upstream from **Reported upstream. Little or no feedback.** to **Reported upstream. Developers acknowledge bug.**



---

archive/issue_comments_094751.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\n> I have no documentation on \"Batut's algorithm\" (probably in Christian\n> Batut's thesis), I'm reverse-engineering the code to try and understand\n> what is going wrong.\n\nThis doesn't sound good :-)",
    "created_at": "2011-01-25T14:38:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10195#issuecomment-94751",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:20" align="right">comment:20</div>

> I have no documentation on "Batut's algorithm" (probably in Christian
> Batut's thesis), I'm reverse-engineering the code to try and understand
> what is going wrong.

This doesn't sound good :-)



---

archive/issue_comments_094752.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nAccording to Karim Belabas this is now fixed in pari svn r12889.\n\n(How many more times am I expected to change the upstream status field? :-) )",
    "created_at": "2011-01-31T21:19:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10195#issuecomment-94752",
    "user": "https://github.com/wjp"
}
```

<div id="comment:21" align="right">comment:21</div>

According to Karim Belabas this is now fixed in pari svn r12889.

(How many more times am I expected to change the upstream status field? :-) )



---

archive/issue_comments_094753.json:
```json
{
    "body": "Changed upstream from **Reported upstream. Developers acknowledge bug.** to **Fixed upstream, but not in a stable release.**",
    "created_at": "2011-01-31T21:19:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10195#issuecomment-94753",
    "user": "https://github.com/wjp"
}
```

Changed upstream from **Reported upstream. Developers acknowledge bug.** to **Fixed upstream, but not in a stable release.**



---

archive/issue_comments_094754.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nSee #11130.",
    "created_at": "2011-04-05T15:01:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10195#issuecomment-94754",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:22" align="right">comment:22</div>

See #11130.



---

archive/issue_comments_094755.json:
```json
{
    "body": "Dependencies: **#11130**",
    "created_at": "2011-09-16T17:40:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10195#issuecomment-94755",
    "user": "https://github.com/nexttime"
}
```

Dependencies: **#11130**



---

archive/issue_events_133717.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2011-09-16T17:40:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10195#event-133717"
}
```



---

archive/issue_comments_094756.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nReplying to [@jdemeyer](#comment:22):\n> See #11130.\n\nI.e., #11130 will (also) fix this. [Hopefully.]",
    "created_at": "2011-09-16T17:40:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10195#issuecomment-94756",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:23" align="right">comment:23</div>

Replying to [@jdemeyer](#comment:22):
> See #11130.

I.e., #11130 will (also) fix this. [Hopefully.]



---

archive/issue_events_133718.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2011-09-16T17:40:00Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "milestone_number": null,
    "milestone_title": "sage-4.7.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10195#event-133718"
}
```



---

archive/issue_events_133719.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2011-09-16T17:40:00Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10195#event-133719"
}
```



---

archive/issue_events_133720.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2011-09-16T17:40:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "label": "https://github.com/sagemath/sage/labels/invalid",
    "label_color": "a6a6a6",
    "label_name": "invalid",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10195#event-133720"
}
```



---

archive/issue_events_133721.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-09-23T19:36:24Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10195#event-133721"
}
```



---

archive/issue_events_133722.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-09-23T19:36:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10195#event-133722"
}
```



---

archive/issue_comments_094757.json:
```json
{
    "body": "Changed upstream from **Fixed upstream, but not in a stable release.** to **Fixed upstream, in a later stable release.**",
    "created_at": "2011-09-23T19:36:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10195#issuecomment-94757",
    "user": "https://github.com/jdemeyer"
}
```

Changed upstream from **Fixed upstream, but not in a stable release.** to **Fixed upstream, in a later stable release.**



---

archive/issue_comments_094758.json:
```json
{
    "body": "Reviewer: **Jeroen Demeyer**",
    "created_at": "2011-09-27T09:43:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/10195#issuecomment-94758",
    "user": "https://github.com/jdemeyer"
}
```

Reviewer: **Jeroen Demeyer**



---

archive/issue_events_133723.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-10-17T07:57:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "label": "https://github.com/sagemath/sage/labels/duplicate",
    "label_color": "a6a6a6",
    "label_name": "duplicate",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10195#event-133723"
}
```



---

archive/issue_events_133724.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-10-17T07:57:39Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10195#event-133724"
}
```



---

archive/issue_events_133725.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-10-17T07:57:39Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/10195",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/10195#event-133725"
}
```
