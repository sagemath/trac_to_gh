# Issue 19230: Make OSX app package relocatable

Issue created by migration from https://trac.sagemath.org/ticket/19467

Original creator: vbraun

Original creation time: 2015-10-24 10:30:36

CC:  fbissey yomcat

Since #19370, the build tree is no longer relocatable on OSX due to absolute linker paths.

I wrote a tool to make them all relative: https://github.com/vbraun/ld-vulcanize

Alternative: forbid relocation #19410


---

Comment by vbraun created at 2015-10-24 10:31:13

TODO:
* Rewrite all paths to relative in sage-bdist
* Get rid of cross-directory hardlinks in our git install


---

Comment by fbissey created at 2015-10-24 11:20:51

New commits:


---

Comment by cnassau created at 2015-10-24 13:51:06

This seems to work in principle, but here's one other case where the ``@`executable_path` needs some tweaking:

```
   RuntimeError: ECL says: LOAD: Could not load file #P"/Applications/SageMath-6.10.moved/local/lib/ecl-15.3.7/maxima.fas" (Error: "dlopen(/Applications/SageMath-6.10.moved/local/lib/ecl-15.3.7/maxima.fas, 10): Library not loaded: @executable_path/../libecl.15.3.7.dylib
```

For this binary the path also needs an extra "../".


---

Comment by cnassau created at 2015-10-24 13:52:15

Also, I think the tool needs to run after the installtion of every new package, so maybe sage-location would be a better place for it than sage-bdist.


---

Comment by git created at 2015-10-24 15:36:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2015-10-24 16:08:15

* sage-location runs after move, this will not work.
* I fixed the maxima/ecl problem


---

Comment by cnassau created at 2015-10-24 16:55:02

Replying to [comment:7 vbraun]:
> * sage-location runs after move, this will not work.

I believe it also runs the first time that sage is started, before anybody can legitimately move it away. That makes it work then. 

The point is that it also runs whenever somebody installs a new package. But maybe you want to add a sage-post-install hook instead...


---

Comment by vbraun created at 2015-10-24 20:04:07

It doesn't work because you can't reliably deduce the correct libraries *after* the move; Once the paths are wrong you can't ask ld what the right library is.


---

Comment by vbraun created at 2015-10-25 14:13:57

Another issue are Python eggs; they are essentially zip files that may contain shared libraries. Python unpacks them on use into `DOT_SAGE/.python-eggs` but they don't get rewritten to relative paths while inside the egg. This is at least an issue for cvxopt.


---

Comment by vbraun created at 2015-10-25 14:27:07

cvxopt and Pillow seem to be the only offenders with shared libraries in egg files.


---

Comment by git created at 2015-10-25 14:40:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2015-11-19 16:38:40

Changing keywords from "" to "osx".


---

Comment by git created at 2015-11-19 16:44:31

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vbraun created at 2015-11-23 19:32:33

Changing status from new to needs_review.


---

Comment by vbraun created at 2015-11-23 19:32:33

This is good enough to get us started. A later ticket should remove unnecessary checks from sage-location.


---

Comment by cnassau created at 2015-11-24 07:00:17

The `http://files.sagemath.org/osx/intel/sage-6.10.beta4-OSX_10.11.1-x86_64.tar.bz2` seems to work quite well. I get these failures from running `sage -tp5 --long`:

```
----------------------------------------------------------------------
sage -t --long --warn-long 50.2 src/sage/numerical/optimize.py  # 6 doctests failed
sage -t --long --warn-long 50.2 src/sage/numerical/backends/cvxopt_backend.pyx  # Killed due to segmentation fault
sage -t --long --warn-long 50.2 src/sage/modules/vector_rational_dense.pyx  # 1 doctest failed
----------------------------------------------------------------------
```

I suppose for cvxopt something still needs to be fixed... (?)


---

Comment by cnassau created at 2015-11-24 07:09:28

Replying to [comment:19 cnassau]: Executing `MixedIntegerLinearProgram(solver = "cvxopt", maximization=False)` gives me this backtrace:

```
     19 from sage.numerical.mip import MIPSolverException
---> 20 from cvxopt import solvers
     21 
     22 cdef class CVXOPTBackend(GenericBackend):

build/bdist.macosx-10.9-x86_64/egg/cvxopt/__init__.py in <module>()

build/bdist.macosx-10.9-x86_64/egg/cvxopt/base.py in <module>()

build/bdist.macosx-10.9-x86_64/egg/cvxopt/base.py in __bootstrap__()

ImportError: dlopen(/Users/cn/.sage//.python-eggs/cvxopt-1.1.7-py2.7-macosx-10.9-x86_64.egg-tmp/cvxopt/base.so, 2): Library not loaded: /Users/vbraun/Code/binary-pkg/source/SageMath/jc4b6yulaujayb9sr94ia88eourzeqip0oidmas391yaj24ng0bmdu/local/lib/libgfortran.3.dylib
  Referenced from: /Users/cn/.sage//.python-eggs/cvxopt-1.1.7-py2.7-macosx-10.9-x86_64.egg-tmp/cvxopt/base.so
  Reason: image not found
```



---

Comment by fbissey created at 2015-11-24 07:24:22

Oh, yuk. Can you paste the output of `otool -L /Users/cn/.sage//.python-eggs/cvxopt-1.1.7-py2.7-macosx-10.9-x86_64.egg-tmp/cvxopt/base.so`?


---

Comment by cnassau created at 2015-11-24 07:34:00

Replying to [comment:21 fbissey]:
> Oh, yuk. Can you paste the output of `otool -L /Users/cn/.sage//.python-eggs/cvxopt-1.1.7-py2.7-macosx-10.9-x86_64.egg-tmp/cvxopt/base.so`?

Here you go:

```
el-capitan:SageMath.moved cn$ otool -L /Users/cn/.sage//.python-eggs/cvxopt-1.1.7-py2.7-macosx-10.9-x86_64.egg-tmp/cvxopt/base.so 
/Users/cn/.sage//.python-eggs/cvxopt-1.1.7-py2.7-macosx-10.9-x86_64.egg-tmp/cvxopt/base.so:
	/System/Library/Frameworks/Accelerate.framework/Versions/A/Frameworks/vecLib.framework/Versions/A/libLAPACK.dylib (compatibility version 1.0.0, current version 1.0.0)
	/System/Library/Frameworks/Accelerate.framework/Versions/A/Frameworks/vecLib.framework/Versions/A/libBLAS.dylib (compatibility version 1.0.0, current version 1.0.0)
	/Users/vbraun/Code/binary-pkg/source/SageMath/jc4b6yulaujayb9sr94ia88eourzeqip0oidmas391yaj24ng0bmdu/local/lib/libgfortran.3.dylib (compatibility version 4.0.0, current version 4.0.0)
	/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1225.1.1)
	/Users/vbraun/Code/binary-pkg/source/SageMath/jc4b6yulaujayb9sr94ia88eourzeqip0oidmas391yaj24ng0bmdu/local/lib/libgcc_s.1.dylib (compatibility version 1.0.0, current version 1.0.0)
```



---

Comment by vbraun created at 2015-11-24 09:04:05

You need to force-rebuild cvxopt so that it isn't installed in an egg; You shouldn't have a `/.sage/.python-eggs/cvxopt


---

Comment by vbraun created at 2015-11-24 09:06:06

PS: The binary tarball built from this branch does pass all tests on OSX 10.11, but I don't want to distribute it as "official" since it is unreleased code.


---

Comment by jdemeyer created at 2015-11-26 16:09:30

Can you explain what the hardlink issue is?


---

Comment by vbraun created at 2015-11-26 16:16:21

Its mostly an unnecessary pita; You have to patch the file only once, but with hardlinks it turns into a non-local problem of whether there the same file is linked elsewhere. Its also an unnecessary portability problem. And there is little to no benefit of using hard links in the first place.


---

Comment by jdemeyer created at 2015-11-26 16:24:24

I don't like this so much:

```
Note: install.py deletes itself upon successful completion
```


I don't think that `install.py` should do that (on some operating systems, it might even not work). If you really want `install.py` to be deleted, I would put the following in `$SAGE_ROOT/sage`:

```
if [ -x "$SAGE_ROOT/install.py" ]; then
    "$SAGE_ROOT/install.py" && rm -f "$SAGE_ROOT/install.py"
fi
```



---

Comment by vbraun created at 2015-11-26 16:29:34

Though unlike bash, python loads scripts into memory and then closes the file. Also the user might run install.py manually...


---

Comment by jdemeyer created at 2015-11-26 16:32:03

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-11-26 16:32:03

To support upgrading, you need to delete the old eggs when installing a non-egg version. I just checked and the egg version gets priority when doing `import cvxopt` from Python.


---

Comment by jdemeyer created at 2015-11-26 16:35:27

Replying to [comment:26 vbraun]:
> Its mostly an unnecessary pita; You have to patch the file only once

Is it a problem if it's patched twice? If it's not a problem, I would remove the change to `git/spkg-install` because it's not needed.


---

Comment by vbraun created at 2015-11-26 17:05:39

Right now the binary-pkg script will break up hardlinks so its not a problem besides waste of disk space (about 200M). Preserving hardlinks would be tricky for no good reason.

Really upstream already agrees that hardlinks are such a common portability issue that they have a setting for that, we just have to switch it on. E.g. many file systems don't support it. Its not like its an intrusive change.


---

Comment by git created at 2015-11-26 18:02:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2015-11-26 18:22:37

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-11-27 06:43:01

It seems that `git` use symlinks with your branch, which is good enough I guess. I certainly wouldn't like it if there would be over 100 _copies_ of the same file, that's just inefficient.


---

Comment by vbraun created at 2015-11-27 22:51:05

Yes, of course.

Anything else?


---

Comment by jdemeyer created at 2015-11-29 22:05:06

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-11-29 22:05:06

Can you use a more descriptive name instead of `install.py`? Like `relocate-once.py` or something?


---

Comment by git created at 2015-11-29 22:12:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2015-11-29 22:13:52

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-11-29 22:18:15

I haven't checked the actual script to rewrite the install directory, but at least this branch here makes sense.


---

Comment by jdemeyer created at 2015-11-29 22:18:15

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-11-30 23:09:36

Resolution: fixed
