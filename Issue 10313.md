# Issue 10313: speed up comparison of Integers and native Python numeric types

archive/issues_010313.json:
```json
{
    "body": "Assignee: @aghitza\n\nFollowing the discussion at http://groups.google.com/group/sage-devel/browse_thread/thread/631cd4e0a927d793?pli=1, it seemed like a good idea to speed up comparisons of integers with ints, because this often arises when using the preparser.  I also added shortcuts for python longs and floats because it seemed like a good idea.\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/10314\n\n",
    "created_at": "2010-11-23T19:24:54Z",
    "labels": [
        "basic arithmetic",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.6.2",
    "title": "speed up comparison of Integers and native Python numeric types",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10313",
    "user": "@roed314"
}
```
Assignee: @aghitza

Following the discussion at http://groups.google.com/group/sage-devel/browse_thread/thread/631cd4e0a927d793?pli=1, it seemed like a good idea to speed up comparisons of integers with ints, because this often arises when using the preparser.  I also added shortcuts for python longs and floats because it seemed like a good idea.



Issue created by migration from https://trac.sagemath.org/ticket/10314





---

archive/issue_comments_105635.json:
```json
{
    "body": "Attachment [10314.patch](tarball://root/attachments/some-uuid/ticket10314/10314.patch) by @roed314 created at 2010-11-23 19:26:21",
    "created_at": "2010-11-23T19:26:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10313#issuecomment-105635",
    "user": "@roed314"
}
```

Attachment [10314.patch](tarball://root/attachments/some-uuid/ticket10314/10314.patch) by @roed314 created at 2010-11-23 19:26:21



---

archive/issue_comments_105636.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2010-11-23T19:28:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10313#issuecomment-105636",
    "user": "@roed314"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_105637.json:
```json
{
    "body": "Here's a major bug this introduces:\n\n```\n        822\t            elif PyFloat_CheckExact(left): \n \t823\t                c = -mpz_cmp_d((<Integer>right).value, PyFloat_AsDouble(right))\n```\n\n\nNote that you're comparing right to itself.\n\nAnother thought I had is that the tmp mpz could be put at the module scope and never mpz_clear'd.  This means a tiny leak, but it removes the mpz_init and mpz_clear completely, and replaces them with a single mpz_set, which could be a big savings in time, since memory allocation is so expensive. \n\nIn fact, looking in integer.pyx I see this near the top:\n\n```\ncdef mpz_t mpz_tmp\nmpz_init(mpz_tmp)\n```\n\nso just use that mpz_tmp that is sitting there, instead of making another one.",
    "created_at": "2010-11-23T19:53:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10313#issuecomment-105637",
    "user": "@williamstein"
}
```

Here's a major bug this introduces:

```
        822	            elif PyFloat_CheckExact(left): 
 	823	                c = -mpz_cmp_d((<Integer>right).value, PyFloat_AsDouble(right))
```


Note that you're comparing right to itself.

Another thought I had is that the tmp mpz could be put at the module scope and never mpz_clear'd.  This means a tiny leak, but it removes the mpz_init and mpz_clear completely, and replaces them with a single mpz_set, which could be a big savings in time, since memory allocation is so expensive. 

In fact, looking in integer.pyx I see this near the top:

```
cdef mpz_t mpz_tmp
mpz_init(mpz_tmp)
```

so just use that mpz_tmp that is sitting there, instead of making another one.



---

archive/issue_comments_105638.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2010-11-23T19:53:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10313#issuecomment-105638",
    "user": "@williamstein"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_105639.json:
```json
{
    "body": "Thanks for catching that.  I don't know why my test -1.5r < 3 didn't crash horribly...\n\nI've switched to using the mpz_tmp as you suggested.\n\nOn adding some more tests, I've discovered that this patch changes the behavior of comparison of large floats to sage integers.  Now we have\n\n```\nsage: 1000000000000000000000000000000000000000000000000000.0r==1000000000000000000000000000000000000000000000000000\nFalse\n```\n\nwhereas it was True before.  Of course, before\n\n```\nsage: 1000000000000000000000000000000000000000000000000000.1r==1000000000000000000000000000000000000000000000000000\nTrue\n```\n\n\nI think it's still worth using `mpz_cmp_d` because of the speed benefit; users should know to be careful with these kinds of floating point comparisons.  Do you agree?",
    "created_at": "2010-11-23T20:20:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10313#issuecomment-105639",
    "user": "@roed314"
}
```

Thanks for catching that.  I don't know why my test -1.5r < 3 didn't crash horribly...

I've switched to using the mpz_tmp as you suggested.

On adding some more tests, I've discovered that this patch changes the behavior of comparison of large floats to sage integers.  Now we have

```
sage: 1000000000000000000000000000000000000000000000000000.0r==1000000000000000000000000000000000000000000000000000
False
```

whereas it was True before.  Of course, before

```
sage: 1000000000000000000000000000000000000000000000000000.1r==1000000000000000000000000000000000000000000000000000
True
```


I think it's still worth using `mpz_cmp_d` because of the speed benefit; users should know to be careful with these kinds of floating point comparisons.  Do you agree?



---

archive/issue_comments_105640.json:
```json
{
    "body": "Attachment [10314.2.patch](tarball://root/attachments/some-uuid/ticket10314/10314.2.patch) by @roed314 created at 2010-11-23 20:36:33\n\nupdated based on referee comments; apply instead of previous patch",
    "created_at": "2010-11-23T20:36:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10313#issuecomment-105640",
    "user": "@roed314"
}
```

Attachment [10314.2.patch](tarball://root/attachments/some-uuid/ticket10314/10314.2.patch) by @roed314 created at 2010-11-23 20:36:33

updated based on referee comments; apply instead of previous patch



---

archive/issue_comments_105641.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2010-11-23T20:37:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10313#issuecomment-105641",
    "user": "@roed314"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_105642.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-01-07T22:22:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10313#issuecomment-105642",
    "user": "@adeines"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_105643.json:
```json
{
    "body": "When checking the doc tests I got the following failure:\n\n\nsage -t  \"devel/sage/sage/rings/integer.pyx\"                \n**********************************************************************\nFile \"/Applications/sage/sage-4.5.3/devel/sage/sage/rings/integer.pyx\", line 410:\n    sage: TestSuite(n).run()\nExpected:\n    Failure in _test_pickling:\n    Traceback (most recent call last):\n    ...\n    AssertionError: 3 != 3\n    ------------------------------------------------------------\n    The following tests failed: _test_pickling\nGot nothing\n**********************************************************************\n1 items had failures:\n   1 of  10 in __main__.example_7\n***Test Failed*** 1 failures.\nFor whitespace errors, see the file /Users/aly/.sage//tmp/.doctest_integer.py\n\t [6.0 s]\n \n----------------------------------------------------------------------\nThe following tests failed:\n\n\n\tsage -t  \"devel/sage/sage/rings/integer.pyx\"\nTotal time for all tests: 6.0 seconds",
    "created_at": "2011-01-07T22:22:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10313#issuecomment-105643",
    "user": "@adeines"
}
```

When checking the doc tests I got the following failure:


sage -t  "devel/sage/sage/rings/integer.pyx"                
**********************************************************************
File "/Applications/sage/sage-4.5.3/devel/sage/sage/rings/integer.pyx", line 410:
    sage: TestSuite(n).run()
Expected:
    Failure in _test_pickling:
    Traceback (most recent call last):
    ...
    AssertionError: 3 != 3
    ------------------------------------------------------------
    The following tests failed: _test_pickling
Got nothing
**********************************************************************
1 items had failures:
   1 of  10 in __main__.example_7
***Test Failed*** 1 failures.
For whitespace errors, see the file /Users/aly/.sage//tmp/.doctest_integer.py
	 [6.0 s]
 
----------------------------------------------------------------------
The following tests failed:


	sage -t  "devel/sage/sage/rings/integer.pyx"
Total time for all tests: 6.0 seconds



---

archive/issue_comments_105644.json:
```json
{
    "body": "Apply instead of previous patches: fixes doctest",
    "created_at": "2011-01-12T00:42:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10313#issuecomment-105644",
    "user": "@roed314"
}
```

Apply instead of previous patches: fixes doctest



---

archive/issue_comments_105645.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-01-12T00:45:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10313#issuecomment-105645",
    "user": "@roed314"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_105646.json:
```json
{
    "body": "Attachment [10314.3.patch](tarball://root/attachments/some-uuid/ticket10314/10314.3.patch) by @roed314 created at 2011-01-12 00:45:28\n\nApply 10314.3.patch\n\nThis fixes the doctest, which shows that pickling integers works better now.  :-)",
    "created_at": "2011-01-12T00:45:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10313#issuecomment-105646",
    "user": "@roed314"
}
```

Attachment [10314.3.patch](tarball://root/attachments/some-uuid/ticket10314/10314.3.patch) by @roed314 created at 2011-01-12 00:45:28

Apply 10314.3.patch

This fixes the doctest, which shows that pickling integers works better now.  :-)



---

archive/issue_comments_105647.json:
```json
{
    "body": "Great!  Looks good.",
    "created_at": "2011-01-12T01:23:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10313#issuecomment-105647",
    "user": "@adeines"
}
```

Great!  Looks good.



---

archive/issue_comments_105648.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-01-12T01:23:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10313#issuecomment-105648",
    "user": "@adeines"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_105649.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-01-19T22:22:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10313#issuecomment-105649",
    "user": "@jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_105650.json:
```json
{
    "body": "It turns out that the line I flagged above as introducing a major bug, which roed fixed, in fact introduces an easy 1-liner way to segfault Sage:\n\n```\nsage: float('nan') > 1\nProgram received signal SIGFPE, Arithmetic exception.\nBOOM\n```\n\n\nSee #12149.",
    "created_at": "2011-12-13T05:08:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10313",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10313#issuecomment-105650",
    "user": "@williamstein"
}
```

It turns out that the line I flagged above as introducing a major bug, which roed fixed, in fact introduces an easy 1-liner way to segfault Sage:

```
sage: float('nan') > 1
Program received signal SIGFPE, Arithmetic exception.
BOOM
```


See #12149.
