# Issue 22746: polynomial quotient rings are unique parents

Issue created by migration from https://trac.sagemath.org/ticket/22983

Original creator: saraedum

Original creation time: 2017-05-11 18:28:17

Currently quotient rings are not unique parents which sometimes causes trouble with 
```
sage: R.<x> = QQ[]
sage: R.quo(x) is R.quo(x)
False
sage: R.quo(x) == R.quo(x)
True
```

The changes proposed here make the creation go through a factory which makes sure that the parents are unique.


---

Comment by nbruin created at 2017-05-11 22:09:31

Does this fully solve the problem, though? One could give different generators for the same ideal. Should we be getting identical results for those, e.g., `R.quo(x-1)` and `R.quo(2*x-2)` (provided `2` is invertible in `R` ...). It might be worth documenting the choice made.

I suspect that for higher rank polynomial rings, normalizing the ideal representation might be too expensive (although computing in those rings would be expensive anyway).
----
New commits:


---

Comment by saraedum created at 2017-05-11 23:00:11

nbruin: You are right. It should be documented. I'll fix that.
I believe that your example should produce two different rings (at least for the time being.) These could be `==` equal but not `is` equal. However, getting `==` to work for them would require a change of the hash function which is (hard and) not the scope of this ticket.


---

Comment by caruso created at 2017-05-12 05:53:13

Currently `R.quo(x-1)` and `R.quo(2*x-2)` prints in the same way.

```
sage: R.<x>= QQ[]
sage: R.quo(x+1)
Univariate Quotient Polynomial Ring in xbar over Rational Field with modulus x + 1
sage: R.quo(2*x+2)
Univariate Quotient Polynomial Ring in xbar over Rational Field with modulus x + 1
```

So I would say rather that the two constructions should return the same ring; it should be easy, it suffices to make the defining polynomial monic because creating the key.


---

Comment by saraedum created at 2017-05-16 11:32:29

Replying to [comment:5 caruso]:
> Currently `R.quo(x-1)` and `R.quo(2*x-2)` prints in the same way.
> {{{
> sage: R.<x>= QQ[]
> sage: R.quo(x+1)
> Univariate Quotient Polynomial Ring in xbar over Rational Field with modulus x + 1
> sage: R.quo(2*x+2)
> Univariate Quotient Polynomial Ring in xbar over Rational Field with modulus x + 1
> }}}
> So I would say rather that the two constructions should return the same ring; it should be easy, it suffices to make the defining polynomial monic because creating the key.

I agree. However, this is already happening automagically: `quo` creates a (principal) ideal and takes its generator as the modulus which is the same `x+1` in both of your examples.
At the same time, if someone insists to create a quotient with the modulus `x + 1` and one with the modulus `2*x + 2` by calling `PolynomialQuotientRing` directly, then these should be distinct because `.modulus()` is going to have a different value for the two, i.e., they are distinguishable. I'll add a doctest to clarify this.


---

Comment by git created at 2017-05-16 11:56:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2017-05-17 22:49:55

Changing status from new to needs_review.


---

Comment by saraedum created at 2017-05-17 22:50:16

Doctests in `rings/polynomial` pass for me. Let's see what the patchbot thinks about everything else.


---

Comment by caruso created at 2017-05-18 04:00:20

Ok.
It's a bit weird and confusing that the function `PolynomialQuotientRing` does not have the same behaviour than the method `quo` (and even `QuotientRing`), isn't it? 


```
    sage: R.<x> = QQ[]
    sage: QuotientRing(R, 2*x+2)
    Univariate Quotient Polynomial Ring in xbar over Rational Field with modulus x + 1
    sage: PolynomialQuotientRing(R, 2*x+2)
    Univariate Quotient Polynomial Ring in xbar over Rational Field with modulus 2*x + 2
```


I would be in favour of uniformizing this... but it's definitely for another ticket.

I'll try to review your ticket soon.


---

Comment by caruso created at 2017-05-24 16:56:43

Why did you remove "in one variable" in the doctest.


```
    sage: R.<x,y> = QQ[]
    sage: PolynomialQuotientRing(R, x^2+y+1)
    ...
    TypeError: ring must be a polynomial ring
```



---

Comment by saraedum created at 2017-06-06 05:39:50

Replying to [comment:11 caruso]:
> Why did you remove "in one variable" in the doctest.
> 
> {{{
>     sage: R.<x,y> = QQ[]
>     sage: PolynomialQuotientRing(R, x^2+y+1)
>     ...
>     TypeError: ring must be a polynomial ring
> }}}
Because it already says "univariate" there.


---

Comment by saraedum created at 2017-06-07 15:45:43

Changing keywords from "" to "sd86.5".


---

Comment by roed created at 2017-06-08 07:10:24

Changing status from needs_review to positive_review.


---

Comment by roed created at 2017-06-08 07:10:24

Tests all pass for me, and it looks good.


---

Comment by vbraun created at 2017-06-09 18:39:17

Merge conflict


---

Comment by vbraun created at 2017-06-09 18:39:17

Changing status from positive_review to needs_work.


---

Comment by roed created at 2017-06-09 20:22:06

Replying to [comment:15 vbraun]:
> Merge conflict

For me, trac is showing it as still merging cleanly.  Is there a new beta against which the merge is failing, or a ticket?


---

Comment by saraedum created at 2017-06-10 17:34:35

We do not get a merge conflict for that one.


---

Comment by saraedum created at 2017-06-10 17:34:35

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2017-06-10 17:47:03

Wait for the next beta


---

Comment by vbraun created at 2017-06-10 17:47:03

Changing status from positive_review to needs_work.


---

Comment by git created at 2017-06-12 01:21:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2017-06-12 01:22:12

Changing status from needs_work to positive_review.


---

Comment by saraedum created at 2017-06-12 01:22:12

Still no conflicts. What are we doing wrong?


---

Comment by vbraun created at 2017-06-12 22:47:28

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2017-06-12 22:47:28

Random failures on some of the build bots:

```
sage -t --long src/sage/rings/polynomial/polynomial_quotient_ring.py
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1355, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units
Failed example:
    L.S_units([])
Expected:
    [(1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
Got:
    [(-1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1359, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units
Failed example:
    L.S_units([K.ideal(1/2*a - 3/2)])
Expected:
    [((-1/6*a - 1/2)*b^2 + (1/3*a - 1)*b + 4/3*a, +Infinity),
     (1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
Got:
    [((-1/6*a - 1/2)*b^2 + (1/3*a - 1)*b + 4/3*a, +Infinity),
     (-1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1364, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units
Failed example:
    L.S_units([K.ideal(2)])
Expected:
    [((1/2*a - 1/2)*b^2 + (a + 1)*b + 3, +Infinity),
     ((1/6*a + 1/2)*b^2 + (-1/3*a + 1)*b - 5/6*a + 1/2, +Infinity),
     ((1/6*a + 1/2)*b^2 + (-1/3*a + 1)*b - 5/6*a - 1/2, +Infinity),
     (1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
Got:
    [((1/2*a - 1/2)*b^2 + (a + 1)*b + 3, +Infinity),
     ((1/6*a + 1/2)*b^2 + (-1/3*a + 1)*b - 5/6*a + 1/2, +Infinity),
     ((1/6*a + 1/2)*b^2 + (-1/3*a + 1)*b - 5/6*a - 1/2, +Infinity),
     (-1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1445, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units
Failed example:
    L.units()
Expected:
    [(1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
Got:
    [(-1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
**********************************************************************
2 items had failures:
   3 of  18 in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units
   1 of  23 in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units
    [385 tests, 4 failures, 1.59 s]
```



---

Comment by git created at 2017-06-16 06:55:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2017-07-17 21:45:36

Changing keywords from "sd86.5" to "sd86.5, sd87".


---

Comment by git created at 2018-01-08 03:48:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-01-08 03:55:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2018-01-08 04:09:36

Let's see what the patchbots think now. I expect some of the `S_units` tests to disagree. I don't understand why they are not stable as I don't see anything happening in the implementation that would be random after my changes.


---

Comment by saraedum created at 2018-01-08 04:09:36

Changing status from needs_work to needs_review.


---

Comment by saraedum created at 2018-01-08 15:41:37

Changing status from needs_review to needs_work.


---

Comment by saraedum created at 2018-01-08 15:41:37

Some `S_units` fail. Let's make the tests less strict and add a `_test_S_units` instead.


---

Comment by git created at 2018-03-08 23:01:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2018-03-08 23:01:54

Changing status from needs_work to needs_review.


---

Comment by saraedum created at 2018-03-08 23:01:54

I thought for a while that the behaviour of these doctests was random. Actually
    it is not. It is consistent over all patchbot runs with the same base version
    of Sage. Caching the polynomial rings flips some signs, I am not sure why.
    Anyway, the result is still correct and it is not random, so there is no need
    for a `_test_S_units()` which would be hard to write anyway.


---

Comment by git created at 2018-03-08 23:04:20

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by roed created at 2018-03-29 20:23:15

Looks good to me.


---

Comment by roed created at 2018-03-29 20:23:15

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-05-08 17:23:15

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2018-05-08 17:23:15

I still get failing tests. Random failures during high load. It looks like the tests depend on whether a garbage collection is forced due to low memory.

```
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1445, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units
Failed example:
    L.S_units([])
Expected:
    [(1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
Got:
    [(-1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1449, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units
Failed example:
    L.S_units([K.ideal(1/2*a - 3/2)])
Expected:
    [((-1/6*a - 1/2)*b^2 + (1/3*a - 1)*b + 4/3*a, +Infinity),
     (1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
Got:
    [((-1/6*a - 1/2)*b^2 + (1/3*a - 1)*b + 4/3*a, +Infinity),
     (-1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1454, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units
Failed example:
    L.S_units([K.ideal(2)])
Expected:
    [((1/2*a - 1/2)*b^2 + (a + 1)*b + 3, +Infinity),
     ((1/6*a + 1/2)*b^2 + (-1/3*a + 1)*b - 5/6*a + 1/2, +Infinity),
     ((1/6*a + 1/2)*b^2 + (-1/3*a + 1)*b - 5/6*a - 1/2, +Infinity),
     (1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
Got:
    [((1/2*a - 1/2)*b^2 + (a + 1)*b + 3, +Infinity),
     ((1/6*a + 1/2)*b^2 + (-1/3*a + 1)*b - 5/6*a + 1/2, +Infinity),
     ((1/6*a + 1/2)*b^2 + (-1/3*a + 1)*b - 5/6*a - 1/2, +Infinity),
     (-1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1535, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units
Failed example:
    L.units()
Expected:
    [(1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
Got:
    [(-1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1544, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units
Failed example:
    L.unit_group().gens_values()
Expected:
    [-1/2*a + 1/2, (-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, 2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2]
Got:
    [1/2*a + 1/2, (-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, 2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2]
**********************************************************************
2 items had failures:
   3 of  18 in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units
   2 of  23 in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units
    [451 tests, 5 failures, 2.92 s]
----------------------------------------------------------------------
sage -t --long src/sage/rings/polynomial/polynomial_quotient_ring.py  # 5 doctests failed
----------------------------------------------------------------------
```



---

Comment by git created at 2018-07-04 16:54:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2018-07-04 16:58:25

Not the first time, something like this has happened: #23851#comment:5
----
New commits:


---

Comment by saraedum created at 2018-07-04 17:03:30

Changing status from needs_work to positive_review.


---

Comment by saraedum created at 2018-07-04 17:03:30

The issue has been fixed in #23851. Since I did not change anything, I am setting this back to positive review.


---

Comment by vbraun created at 2018-07-08 13:05:36

Resolution: fixed
