# Issue 24231: Fix comparison of matrices that live in equivalent matrix spaces

archive/issues_024231.json:
```json
{
    "body": "CC:  @jplab @tscrim @videlec\n\nBecause of 23706, comparison of matrices got broken.\n\nReason: Comparison of matrices takes into account equality of the corresponding matrix spaces, but that's broken if one of the matrices has been manually created using a special implementation in a matrix space that doesn't know this special implementation.\n\nExample:\n\n```\nsage: from sage.matrix.matrix_gfpn_dense import Matrix_gfpn_dense\nsage: MS = MatrixSpace(GF(2), 1, 2)\nsage: M = Matrix_gfpn_dense(MS, [1,1])\nsage: MS2 = MatrixSpace(GF(2), 2, 2)\nsage: M2 = Matrix_gfpn_dense(MS2, [1,1,1,1])\nsage: M == M[0:1]\nTrue\nsage: M == M2[0:1]\nFalse\nsage: M.parent()\nFull MatrixSpace of 1 by 2 dense matrices over Finite Field of size 2\nsage: M2[0:1].parent()\nFull MatrixSpace of 1 by 2 dense matrices over Finite Field of size 2 (using Matrix_gfpn_dense)\nsage: _ == __\nFalse\n```\n\n\nPotential ways to proceed:\n- One could argue that it is a wrong usage, and close this ticket as invalid.\n- If the parent of a matrix has no special implementation, then matrix slices won't have a special implementation either.\n- If a matrix space MS has a matrix class doesn't match the class of a matrix M, then during initialisation of M the parent of M won't be MS but a matrix space that uses `M.__class__`\n\nIssue created by migration from https://trac.sagemath.org/ticket/24468\n\n",
    "created_at": "2018-01-03T21:56:14Z",
    "labels": [
        "linear algebra",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Fix comparison of matrices that live in equivalent matrix spaces",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24231",
    "user": "@simon-king-jena"
}
```
CC:  @jplab @tscrim @videlec

Because of 23706, comparison of matrices got broken.

Reason: Comparison of matrices takes into account equality of the corresponding matrix spaces, but that's broken if one of the matrices has been manually created using a special implementation in a matrix space that doesn't know this special implementation.

Example:

```
sage: from sage.matrix.matrix_gfpn_dense import Matrix_gfpn_dense
sage: MS = MatrixSpace(GF(2), 1, 2)
sage: M = Matrix_gfpn_dense(MS, [1,1])
sage: MS2 = MatrixSpace(GF(2), 2, 2)
sage: M2 = Matrix_gfpn_dense(MS2, [1,1,1,1])
sage: M == M[0:1]
True
sage: M == M2[0:1]
False
sage: M.parent()
Full MatrixSpace of 1 by 2 dense matrices over Finite Field of size 2
sage: M2[0:1].parent()
Full MatrixSpace of 1 by 2 dense matrices over Finite Field of size 2 (using Matrix_gfpn_dense)
sage: _ == __
False
```


Potential ways to proceed:
- One could argue that it is a wrong usage, and close this ticket as invalid.
- If the parent of a matrix has no special implementation, then matrix slices won't have a special implementation either.
- If a matrix space MS has a matrix class doesn't match the class of a matrix M, then during initialisation of M the parent of M won't be MS but a matrix space that uses `M.__class__`

Issue created by migration from https://trac.sagemath.org/ticket/24468





---

archive/issue_comments_339359.json:
```json
{
    "body": "Related problem: `mtx_unpickle` hard-codes the usage of a matrix space with default implementation, even when the matrix-to-be-unpickled has a non-default implementation.",
    "created_at": "2018-01-04T00:37:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24231",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24231#issuecomment-339359",
    "user": "@simon-king-jena"
}
```

Related problem: `mtx_unpickle` hard-codes the usage of a matrix space with default implementation, even when the matrix-to-be-unpickled has a non-default implementation.



---

archive/issue_comments_339360.json:
```json
{
    "body": "I guess the `matrix` constructor should be provided with an `implementation` keyword, too.\n\nTwo matrix spaces with the same base ring, number of rows and number of columns are clearly canonically isomorphic, even if they have different implementations. Thus, there should be a coercion in at least one direction. That's the same in other parts of Sage, e.g., polynomials:\n\n```\nsage: R1 = PolynomialRing(ZZ,'x',implementation='NTL')\nsage: R2 = PolynomialRing(ZZ,'x',implementation='FLINT')\nsage: R3 = PolynomialRing(ZZ,'x',implementation='singular')\nsage: R3\nMultivariate Polynomial Ring in x over Integer Ring\nsage: R1\nUnivariate Polynomial Ring in x over Integer Ring (using NTL)\nsage: R1.has_coerce_map_from(R2)\nFalse\nsage: R2.has_coerce_map_from(R1)\nTrue\nsage: R3.has_coerce_map_from(R1)\nTrue\nsage: R3.has_coerce_map_from(R2)\nTrue\nsage: R1.has_coerce_map_from(R3)\nFalse\nsage: R2.has_coerce_map_from(R3)\nFalse\n```\n",
    "created_at": "2018-01-04T00:48:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24231",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24231#issuecomment-339360",
    "user": "@simon-king-jena"
}
```

I guess the `matrix` constructor should be provided with an `implementation` keyword, too.

Two matrix spaces with the same base ring, number of rows and number of columns are clearly canonically isomorphic, even if they have different implementations. Thus, there should be a coercion in at least one direction. That's the same in other parts of Sage, e.g., polynomials:

```
sage: R1 = PolynomialRing(ZZ,'x',implementation='NTL')
sage: R2 = PolynomialRing(ZZ,'x',implementation='FLINT')
sage: R3 = PolynomialRing(ZZ,'x',implementation='singular')
sage: R3
Multivariate Polynomial Ring in x over Integer Ring
sage: R1
Univariate Polynomial Ring in x over Integer Ring (using NTL)
sage: R1.has_coerce_map_from(R2)
False
sage: R2.has_coerce_map_from(R1)
True
sage: R3.has_coerce_map_from(R1)
True
sage: R3.has_coerce_map_from(R2)
True
sage: R1.has_coerce_map_from(R3)
False
sage: R2.has_coerce_map_from(R3)
False
```




---

archive/issue_comments_339361.json:
```json
{
    "body": "Replying to [comment:1 SimonKing]:\n> Related problem: `mtx_unpickle` hard-codes the usage of a matrix space with default implementation, even when the matrix-to-be-unpickled has a non-default implementation.\n\nTo be fair, that statement only holds for matrices that have been created with an old version of my group cohomology spkg (that's why I care...).\n\nSo, I suggest one should deal with this ticket as follows:\n\n- modify mtx_unpickle(), so that very old pickles are automatically unpickled with a matrix space that matches the implementation.\n- For newer Matrix_gfpn_dense pickles (those which store the matrix space, rather than only the field size and the row/column numbers), nothing needs to change in mtx_unpickle.\n- The creation of matrices as demonstrated in the ticket description shouldn't be supported: Matrices are to be constructed via the matrix space or some constructor.",
    "created_at": "2018-01-04T00:58:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24231",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24231#issuecomment-339361",
    "user": "@simon-king-jena"
}
```

Replying to [comment:1 SimonKing]:
> Related problem: `mtx_unpickle` hard-codes the usage of a matrix space with default implementation, even when the matrix-to-be-unpickled has a non-default implementation.

To be fair, that statement only holds for matrices that have been created with an old version of my group cohomology spkg (that's why I care...).

So, I suggest one should deal with this ticket as follows:

- modify mtx_unpickle(), so that very old pickles are automatically unpickled with a matrix space that matches the implementation.
- For newer Matrix_gfpn_dense pickles (those which store the matrix space, rather than only the field size and the row/column numbers), nothing needs to change in mtx_unpickle.
- The creation of matrices as demonstrated in the ticket description shouldn't be supported: Matrices are to be constructed via the matrix space or some constructor.



---

archive/issue_comments_339362.json:
```json
{
    "body": "I added #24359 as a dependency, because it affects some tests happening in the file that I modified.\n\nThe new test passes, and I suppose it is ready for review!\n----\nLast 10 new commits:",
    "created_at": "2018-01-04T01:34:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24231",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24231#issuecomment-339362",
    "user": "@simon-king-jena"
}
```

I added #24359 as a dependency, because it affects some tests happening in the file that I modified.

The new test passes, and I suppose it is ready for review!
----
Last 10 new commits:



---

archive/issue_comments_339363.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-01-04T01:34:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24231",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24231#issuecomment-339363",
    "user": "@simon-king-jena"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_339364.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-01-04T01:36:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24231",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24231#issuecomment-339364",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_339365.json:
```json
{
    "body": "Oops, I forgot to commit the actual changes for this ticket.\n\nDone now.\n----\nNew commits:",
    "created_at": "2018-01-04T01:37:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24231",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24231#issuecomment-339365",
    "user": "@simon-king-jena"
}
```

Oops, I forgot to commit the actual changes for this ticket.

Done now.
----
New commits:



---

archive/issue_comments_339366.json:
```json
{
    "body": "You should never initialize by yourself `M = Matrix_gfpn_dense(MS, [1,1])`. This might lead to crash. Each parent has its own element class. Your third point \"If a matrix space MS has a matrix class doesn't match the class of a matrix M, ...\" should never happen.\n\nAs you noticed, the comparison problem is due to the fact that I forbade coercions (it was simpler that way).\n\n```\nsage: M1 = MatrixSpace(GF(2), 1, implementation='generic')\nsage: M2 = MatrixSpace(GF(2), 1, implementation='m4ri')\nsage: M1 == M2\nFalse\nsage: M1.one() == M2.one()\nFalse\n```\n\nA reasonable possibility is to allow coercions from matrix space with alternative implementation to the one with the default implementation. But this will not help for comparing matrices with two alternative implementations.",
    "created_at": "2018-01-04T10:09:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24231",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24231#issuecomment-339366",
    "user": "@videlec"
}
```

You should never initialize by yourself `M = Matrix_gfpn_dense(MS, [1,1])`. This might lead to crash. Each parent has its own element class. Your third point "If a matrix space MS has a matrix class doesn't match the class of a matrix M, ..." should never happen.

As you noticed, the comparison problem is due to the fact that I forbade coercions (it was simpler that way).

```
sage: M1 = MatrixSpace(GF(2), 1, implementation='generic')
sage: M2 = MatrixSpace(GF(2), 1, implementation='m4ri')
sage: M1 == M2
False
sage: M1.one() == M2.one()
False
```

A reasonable possibility is to allow coercions from matrix space with alternative implementation to the one with the default implementation. But this will not help for comparing matrices with two alternative implementations.



---

archive/issue_comments_339367.json:
```json
{
    "body": "Replying to [comment:9 vdelecroix]:\n> You should never initialize by yourself `M = Matrix_gfpn_dense(MS, [1,1])`. This might lead to crash. Each parent has its own element class. Your third point \"If a matrix space MS has a matrix class doesn't match the class of a matrix M, ...\" should never happen.\n\nFair enough. But I think we should at least make sure (because it is easy!) that old pickles unpickle according to the new standard. And that's what commit:f910d1c does.",
    "created_at": "2018-01-04T10:14:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24231",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24231#issuecomment-339367",
    "user": "@simon-king-jena"
}
```

Replying to [comment:9 vdelecroix]:
> You should never initialize by yourself `M = Matrix_gfpn_dense(MS, [1,1])`. This might lead to crash. Each parent has its own element class. Your third point "If a matrix space MS has a matrix class doesn't match the class of a matrix M, ..." should never happen.

Fair enough. But I think we should at least make sure (because it is easy!) that old pickles unpickle according to the new standard. And that's what commit:f910d1c does.



---

archive/issue_comments_339368.json:
```json
{
    "body": "Replying to [comment:10 SimonKing]:\n> Replying to [comment:9 vdelecroix]:\n> > You should never initialize by yourself `M = Matrix_gfpn_dense(MS, [1,1])`. This might lead to crash. Each parent has its own element class. Your third point \"If a matrix space MS has a matrix class doesn't match the class of a matrix M, ...\" should never happen.\n> \n> Fair enough. But I think we should at least make sure (because it is easy!) that old pickles unpickle according to the new standard. And that's what commit:f910d1c does.\n\nDefinitely!\n\nWhat do you think about coercion? (certainly for later ticket)",
    "created_at": "2018-01-04T10:19:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24231",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24231#issuecomment-339368",
    "user": "@videlec"
}
```

Replying to [comment:10 SimonKing]:
> Replying to [comment:9 vdelecroix]:
> > You should never initialize by yourself `M = Matrix_gfpn_dense(MS, [1,1])`. This might lead to crash. Each parent has its own element class. Your third point "If a matrix space MS has a matrix class doesn't match the class of a matrix M, ..." should never happen.
> 
> Fair enough. But I think we should at least make sure (because it is easy!) that old pickles unpickle according to the new standard. And that's what commit:f910d1c does.

Definitely!

What do you think about coercion? (certainly for later ticket)



---

archive/issue_comments_339369.json:
```json
{
    "body": "Replying to [comment:9 vdelecroix]:\n> A reasonable possibility is to allow coercions from matrix space with alternative implementation to the one with the default implementation. But this will not help for comparing matrices with two alternative implementations.\n\nIt would, if we were including the `implementation` in the matrix space construction functor, and would let `merge()` always return the default implementation, unless the two to-be-merged matrix space construction functors have both *the same* non-default implementation.",
    "created_at": "2018-01-04T10:29:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24231",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24231#issuecomment-339369",
    "user": "@simon-king-jena"
}
```

Replying to [comment:9 vdelecroix]:
> A reasonable possibility is to allow coercions from matrix space with alternative implementation to the one with the default implementation. But this will not help for comparing matrices with two alternative implementations.

It would, if we were including the `implementation` in the matrix space construction functor, and would let `merge()` always return the default implementation, unless the two to-be-merged matrix space construction functors have both *the same* non-default implementation.



---

archive/issue_comments_339370.json:
```json
{
    "body": "Replying to [comment:12 SimonKing]:\n> Replying to [comment:9 vdelecroix]:\n> > A reasonable possibility is to allow coercions from matrix space with alternative implementation to the one with the default implementation. But this will not help for comparing matrices with two alternative implementations.\n> \n> It would, if we were including the `implementation` in the matrix space construction functor, and would let `merge()` always return the default implementation, unless the two to-be-merged matrix space construction functors have both *the same* non-default implementation.\n\nNice. I like it. I believe it is this way for polynomial rings. Though, for matrix spaces the default implementation is subtle as it depends on the presence of optional packages (i.e. `meataxe`).",
    "created_at": "2018-01-04T10:35:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24231",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24231#issuecomment-339370",
    "user": "@videlec"
}
```

Replying to [comment:12 SimonKing]:
> Replying to [comment:9 vdelecroix]:
> > A reasonable possibility is to allow coercions from matrix space with alternative implementation to the one with the default implementation. But this will not help for comparing matrices with two alternative implementations.
> 
> It would, if we were including the `implementation` in the matrix space construction functor, and would let `merge()` always return the default implementation, unless the two to-be-merged matrix space construction functors have both *the same* non-default implementation.

Nice. I like it. I believe it is this way for polynomial rings. Though, for matrix spaces the default implementation is subtle as it depends on the presence of optional packages (i.e. `meataxe`).



---

archive/issue_comments_339371.json:
```json
{
    "body": "Removed the dependencies, mainly to deal with the fact that #24359 was force-pushed. Feel free to put back whatever dependency you need, although the current branch doesn't have any dependencies as far as I can tell.\n----\nNew commits:",
    "created_at": "2018-01-04T21:43:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24231",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24231#issuecomment-339371",
    "user": "@jdemeyer"
}
```

Removed the dependencies, mainly to deal with the fact that #24359 was force-pushed. Feel free to put back whatever dependency you need, although the current branch doesn't have any dependencies as far as I can tell.
----
New commits:



---

archive/issue_comments_339372.json:
```json
{
    "body": "This branch doesn't really correspond to the topic of the ticket. What am I missing?",
    "created_at": "2018-01-05T12:55:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24231",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24231#issuecomment-339372",
    "user": "@jdemeyer"
}
```

This branch doesn't really correspond to the topic of the ticket. What am I missing?



---

archive/issue_comments_339373.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2018-01-05T12:55:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24231",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24231#issuecomment-339373",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_339374.json:
```json
{
    "body": "Replying to [comment:16 jdemeyer]:\n> This branch doesn't really correspond to the topic of the ticket. What am I missing?\n\nWhen I created the ticket, I thought that comparison of matrices was broken. Then I realised that the example from the ticket description is a user error. But I also realised that there is a backward incompatibility, in the sense of \"old pickles of meataxe matrices won't unpickle in the right matrix space\". And that's what is being fixed.\n\nI'll change the ticket title and description accordingly.",
    "created_at": "2018-01-05T13:01:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24231",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24231#issuecomment-339374",
    "user": "@simon-king-jena"
}
```

Replying to [comment:16 jdemeyer]:
> This branch doesn't really correspond to the topic of the ticket. What am I missing?

When I created the ticket, I thought that comparison of matrices was broken. Then I realised that the example from the ticket description is a user error. But I also realised that there is a backward incompatibility, in the sense of "old pickles of meataxe matrices won't unpickle in the right matrix space". And that's what is being fixed.

I'll change the ticket title and description accordingly.



---

archive/issue_comments_339375.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2018-01-05T13:05:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24231",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24231#issuecomment-339375",
    "user": "@simon-king-jena"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_339376.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-01-08T14:22:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24231",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24231#issuecomment-339376",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_339377.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-01-14T10:14:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24231",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24231#issuecomment-339377",
    "user": "@vbraun"
}
```

Resolution: fixed
