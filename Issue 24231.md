# Issue 24231: Fix comparison of matrices that live in equivalent matrix spaces

Issue created by migration from https://trac.sagemath.org/ticket/24468

Original creator: SimonKing

Original creation time: 2018-01-03 21:56:14

CC:  jipilab tscrim vdelecroix

Because of 23706, comparison of matrices got broken.

Reason: Comparison of matrices takes into account equality of the corresponding matrix spaces, but that's broken if one of the matrices has been manually created using a special implementation in a matrix space that doesn't know this special implementation.

Example:

```
sage: from sage.matrix.matrix_gfpn_dense import Matrix_gfpn_dense
sage: MS = MatrixSpace(GF(2), 1, 2)
sage: M = Matrix_gfpn_dense(MS, [1,1])
sage: MS2 = MatrixSpace(GF(2), 2, 2)
sage: M2 = Matrix_gfpn_dense(MS2, [1,1,1,1])
sage: M == M[0:1]
True
sage: M == M2[0:1]
False
sage: M.parent()
Full MatrixSpace of 1 by 2 dense matrices over Finite Field of size 2
sage: M2[0:1].parent()
Full MatrixSpace of 1 by 2 dense matrices over Finite Field of size 2 (using Matrix_gfpn_dense)
sage: _ == __
False
```


Potential ways to proceed:
- One could argue that it is a wrong usage, and close this ticket as invalid.
- If the parent of a matrix has no special implementation, then matrix slices won't have a special implementation either.
- If a matrix space MS has a matrix class doesn't match the class of a matrix M, then during initialisation of M the parent of M won't be MS but a matrix space that uses `M.__class__`


---

Comment by SimonKing created at 2018-01-04 00:37:12

Related problem: `mtx_unpickle` hard-codes the usage of a matrix space with default implementation, even when the matrix-to-be-unpickled has a non-default implementation.


---

Comment by SimonKing created at 2018-01-04 00:48:58

I guess the `matrix` constructor should be provided with an `implementation` keyword, too.

Two matrix spaces with the same base ring, number of rows and number of columns are clearly canonically isomorphic, even if they have different implementations. Thus, there should be a coercion in at least one direction. That's the same in other parts of Sage, e.g., polynomials:

```
sage: R1 = PolynomialRing(ZZ,'x',implementation='NTL')
sage: R2 = PolynomialRing(ZZ,'x',implementation='FLINT')
sage: R3 = PolynomialRing(ZZ,'x',implementation='singular')
sage: R3
Multivariate Polynomial Ring in x over Integer Ring
sage: R1
Univariate Polynomial Ring in x over Integer Ring (using NTL)
sage: R1.has_coerce_map_from(R2)
False
sage: R2.has_coerce_map_from(R1)
True
sage: R3.has_coerce_map_from(R1)
True
sage: R3.has_coerce_map_from(R2)
True
sage: R1.has_coerce_map_from(R3)
False
sage: R2.has_coerce_map_from(R3)
False
```



---

Comment by SimonKing created at 2018-01-04 00:58:03

Replying to [comment:1 SimonKing]:
> Related problem: `mtx_unpickle` hard-codes the usage of a matrix space with default implementation, even when the matrix-to-be-unpickled has a non-default implementation.

To be fair, that statement only holds for matrices that have been created with an old version of my group cohomology spkg (that's why I care...).

So, I suggest one should deal with this ticket as follows:

- modify mtx_unpickle(), so that very old pickles are automatically unpickled with a matrix space that matches the implementation.
- For newer Matrix_gfpn_dense pickles (those which store the matrix space, rather than only the field size and the row/column numbers), nothing needs to change in mtx_unpickle.
- The creation of matrices as demonstrated in the ticket description shouldn't be supported: Matrices are to be constructed via the matrix space or some constructor.


---

Comment by SimonKing created at 2018-01-04 01:34:44

I added #24359 as a dependency, because it affects some tests happening in the file that I modified.

The new test passes, and I suppose it is ready for review!
----
Last 10 new commits:


---

Comment by SimonKing created at 2018-01-04 01:34:44

Changing status from new to needs_review.


---

Comment by git created at 2018-01-04 01:36:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2018-01-04 01:37:13

Oops, I forgot to commit the actual changes for this ticket.

Done now.
----
New commits:


---

Comment by vdelecroix created at 2018-01-04 10:09:20

You should never initialize by yourself `M = Matrix_gfpn_dense(MS, [1,1])`. This might lead to crash. Each parent has its own element class. Your third point "If a matrix space MS has a matrix class doesn't match the class of a matrix M, ..." should never happen.

As you noticed, the comparison problem is due to the fact that I forbade coercions (it was simpler that way).

```
sage: M1 = MatrixSpace(GF(2), 1, implementation='generic')
sage: M2 = MatrixSpace(GF(2), 1, implementation='m4ri')
sage: M1 == M2
False
sage: M1.one() == M2.one()
False
```

A reasonable possibility is to allow coercions from matrix space with alternative implementation to the one with the default implementation. But this will not help for comparing matrices with two alternative implementations.


---

Comment by SimonKing created at 2018-01-04 10:14:56

Replying to [comment:9 vdelecroix]:
> You should never initialize by yourself `M = Matrix_gfpn_dense(MS, [1,1])`. This might lead to crash. Each parent has its own element class. Your third point "If a matrix space MS has a matrix class doesn't match the class of a matrix M, ..." should never happen.

Fair enough. But I think we should at least make sure (because it is easy!) that old pickles unpickle according to the new standard. And that's what commit:f910d1c does.


---

Comment by vdelecroix created at 2018-01-04 10:19:49

Replying to [comment:10 SimonKing]:
> Replying to [comment:9 vdelecroix]:
> > You should never initialize by yourself `M = Matrix_gfpn_dense(MS, [1,1])`. This might lead to crash. Each parent has its own element class. Your third point "If a matrix space MS has a matrix class doesn't match the class of a matrix M, ..." should never happen.
> 
> Fair enough. But I think we should at least make sure (because it is easy!) that old pickles unpickle according to the new standard. And that's what commit:f910d1c does.

Definitely!

What do you think about coercion? (certainly for later ticket)


---

Comment by SimonKing created at 2018-01-04 10:29:31

Replying to [comment:9 vdelecroix]:
> A reasonable possibility is to allow coercions from matrix space with alternative implementation to the one with the default implementation. But this will not help for comparing matrices with two alternative implementations.

It would, if we were including the `implementation` in the matrix space construction functor, and would let `merge()` always return the default implementation, unless the two to-be-merged matrix space construction functors have both _the same_ non-default implementation.


---

Comment by vdelecroix created at 2018-01-04 10:35:39

Replying to [comment:12 SimonKing]:
> Replying to [comment:9 vdelecroix]:
> > A reasonable possibility is to allow coercions from matrix space with alternative implementation to the one with the default implementation. But this will not help for comparing matrices with two alternative implementations.
> 
> It would, if we were including the `implementation` in the matrix space construction functor, and would let `merge()` always return the default implementation, unless the two to-be-merged matrix space construction functors have both _the same_ non-default implementation.

Nice. I like it. I believe it is this way for polynomial rings. Though, for matrix spaces the default implementation is subtle as it depends on the presence of optional packages (i.e. `meataxe`).


---

Comment by jdemeyer created at 2018-01-04 21:43:14

Removed the dependencies, mainly to deal with the fact that #24359 was force-pushed. Feel free to put back whatever dependency you need, although the current branch doesn't have any dependencies as far as I can tell.
----
New commits:


---

Comment by jdemeyer created at 2018-01-05 12:55:47

This branch doesn't really correspond to the topic of the ticket. What am I missing?


---

Comment by jdemeyer created at 2018-01-05 12:55:47

Changing status from needs_review to needs_info.


---

Comment by SimonKing created at 2018-01-05 13:01:01

Replying to [comment:16 jdemeyer]:
> This branch doesn't really correspond to the topic of the ticket. What am I missing?

When I created the ticket, I thought that comparison of matrices was broken. Then I realised that the example from the ticket description is a user error. But I also realised that there is a backward incompatibility, in the sense of "old pickles of meataxe matrices won't unpickle in the right matrix space". And that's what is being fixed.

I'll change the ticket title and description accordingly.


---

Comment by SimonKing created at 2018-01-05 13:05:49

Changing status from needs_info to needs_review.


---

Comment by jdemeyer created at 2018-01-08 14:22:36

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-01-14 10:14:20

Resolution: fixed
