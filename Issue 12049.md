# Issue 12049: Failures in gp interface with long $HOME

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2011-12-22 13:27:47

Assignee: was

CC:  cremona

Keywords: gp pexpect

When the home directory $HOME is unusually long, failures happen in the gp interface:

```
( export HOME="/tmp/123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789/"; mkdir -p $HOME; ./sage -t --long devel/sage/sage/ )
[...]
sage -t  "devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py"
  ***   Warning: new stack size = 1003360 (0.957 Mbytes).
  ***   Warning: new stack size = 1003360 (0.957 Mbytes).
**********************************************************************
File "/usr/local/src/sage-4.8.alpha4/devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py", line 526:
    sage: E.conductor(algorithm="gp")
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/src/sage-4.8.alpha4/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/usr/local/src/sage-4.8.alpha4/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/usr/local/src/sage-4.8.alpha4/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_12[5]>", line 1, in <module>
        E.conductor(algorithm="gp")###line 526:
    sage: E.conductor(algorithm="gp")
      File "/usr/local/src/sage-4.8.alpha4/local/lib/python/site-packages/sage/schemes/elliptic_curves/ell_rational_field.py", line 552, in conductor
        self.__conductor_gp = Integer(gp.eval('ellglobalred(ellinit(%s,0))[1]'%list(self.a_invariants())))
      File "integer.pyx", line 681, in sage.rings.integer.Integer.__init__ (sage/rings/integer.c:6786)
    TypeError: unable to convert x (=read("/tmp/123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789/.sage/temp/arcanis/5630//interface//tmp5647") ) to an integer
**********************************************************************
File "/usr/local/src/sage-4.8.alpha4/devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py", line 1430:
    sage: E.simon_two_descent()
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/src/sage-4.8.alpha4/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/usr/local/src/sage-4.8.alpha4/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/usr/local/src/sage-4.8.alpha4/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_28[4]>", line 1, in <module>
        E.simon_two_descent()###line 1430:
    sage: E.simon_two_descent()
      File "/usr/local/src/sage-4.8.alpha4/local/lib/python/site-packages/sage/schemes/elliptic_curves/ell_rational_field.py", line 1493, in simon_two_descent
        maxprob=maxprob, limbigprime=limbigprime)
      File "/usr/local/src/sage-4.8.alpha4/local/lib/python/site-packages/sage/schemes/elliptic_curves/gp_simon.py", line 117, in simon_two_descent
        ans = sage_eval(v, {'Mod': _gp_mod, 'y': K.gen(0)})
      File "/usr/local/src/sage-4.8.alpha4/local/lib/python/site-packages/sage/misc/sage_eval.py", line 199, in sage_eval
        return eval(source, sage.all.__dict__, locals)
      File "<string>", line 0

        ^
     SyntaxError: unexpected EOF while parsing
**********************************************************************
[...]
The following tests failed:


        sage -t  "devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py"
        sage -t  "devel/sage/sage/schemes/elliptic_curves/gp_simon.py"
        sage -t  "devel/sage/sage/schemes/elliptic_curves/lseries_ell.py"
        sage -t  "devel/sage/sage/schemes/elliptic_curves/sha_tate.py"
        sage -t  "devel/sage/sage/schemes/elliptic_curves/ell_number_field.py"
        sage -t  "devel/sage/sage/schemes/elliptic_curves/period_lattice.py"
        sage -t  "devel/sage/sage/schemes/elliptic_curves/BSD.py"
```



---

Comment by jdemeyer created at 2011-12-22 13:28:28

Changing type from PLEASE CHANGE to defect.


---

Comment by jhpalmieri created at 2011-12-22 16:37:03

I can't reproduce this, either on sage.math or an OS X box.  What platform were you using?


---

Comment by jdemeyer created at 2011-12-22 16:55:33

It might really be caused by #11704 then.  Need to do some more tests.


---

Comment by jhpalmieri created at 2011-12-22 17:19:44

I should clarify: I couldn't reproduce this, either before applying the patch from #11704 or after.


---

Comment by jdemeyer created at 2011-12-23 16:32:03

It might really be caused by #11704 + #11073 then. Need to do some more tests.


---

Comment by jhpalmieri created at 2011-12-23 18:07:23

Replying to [comment:7 jdemeyer]:
> It might really be caused by #11704 + #11073 then. Need to do some more tests. 

That combination doesn't cause me problems on sage.math: I have a copy of sage in `/scratch/palmieri/11073/sage-4.8.a4-11073` which has the patches from #11073 and its dependencies, including #11704.  Tests pass when I use the command in the ticket description.  (I produced this version of Sage with the file [http://sage.math.washington.edu/home/palmieri/misc/11073/sage-4.8.a4-11073.tar](http://sage.math.washington.edu/home/palmieri/misc/11073/sage-4.8.a4-11073.tar).)


---

Comment by jdemeyer created at 2011-12-24 01:25:37

Now I also have problems reproducing it.  It must be some strange interaction between several tickets.


---

Comment by jdemeyer created at 2011-12-24 01:34:12

Maybe it's a race condition of some sort being triggered by #11704?


---

Comment by jdemeyer created at 2011-12-28 22:32:36

I can't seem to reproduce this anymore...


---

Comment by jdemeyer created at 2012-01-04 19:00:37

Reproducing it again sometimes when merging #11073...  must be some race condition, which makes it an even more annoying bug.


---

Comment by jdemeyer created at 2012-01-10 07:22:00

These errors happen much less frequently (but they still do happen) with python-2.7.  At least that's my feeling.


---

Comment by jdemeyer created at 2012-01-10 23:03:04

Important data point: the failures seem to happen only (or at least mostly) during the first test run.  Running "make ptest" from a fresh install causes a lot of failures.  Running "make ptest" a second time gives no (or much less) failures.


---

Comment by jdemeyer created at 2012-01-10 23:06:25

This observation about the "first run" could be because of a cold disk cache causing some race condition.


---

Attachment


---

Comment by jdemeyer created at 2012-01-12 13:51:07

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2012-01-12 13:51:07

Very experimental fix seems to work on first sight, certainly needs more testing.


---

Comment by jdemeyer created at 2012-01-12 13:51:20

Changing keywords from "gp pexpect" to "gp pexpect spkg".


---

Comment by vbraun created at 2012-01-12 15:35:49

For the record, I still can't reproduce it on Fedora 16:

```

[vbraun`@`volker-laptop-two hg]$ hg qapplied
12221_debug.patch
[vbraun`@`volker-laptop-two hg]$ export TERM=screen
[vbraun`@`volker-laptop-two hg]$ sage /tmp/test12221.sage 
TERM = screen
18 char filename: ok
19 char filename: ok
[...
117 char filename: ok
```



---

Comment by wjp created at 2012-01-12 15:55:16

I haven't looked at this at all, but it's probably safer to set TERM to `dumb' than unsetting it. (As also evidenced by the termcap crash in #12282)


---

Comment by jdemeyer created at 2012-01-12 15:56:59

Volker: you need to actually use "screen", not just set TERM=screen.

And then the obvious: is your `sage` executable the same as `./sage` and did you run `./sage -b`?


---

Comment by jdemeyer created at 2012-01-12 15:57:51

Replying to [comment:30 wjp]:
> I haven't looked at this at all, but it's probably safer to set TERM to `dumb' than unsetting it. (As also evidenced by the termcap crash in #12282)
I already tried this and unfortunately the error still remains with TERM=dumb.


---

Attachment


---

Comment by vbraun created at 2012-01-12 16:30:22

I tried it under `screen` as well without problems. I also tried running the loop longer and this works until I hit the 255 byte filename limit in ext4:

```
269 char filename: ok
270 char filename: ok
Traceback (most recent call last):
  File "/tmp/test12221.py", line 11, in <module>
    f = open(gpfilename, "w")
IOError: [Errno 36] File name too long: '/tmp/tmppzCAbE/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.gp'
```



---

Comment by wjp created at 2012-01-12 19:36:18

I can reproduce the failing test12221.sage at home in a screen session, but it goes away with TERM=dumb.

On sage.math the test doesn't fail for me, but I do get a lot of escape sequences (1b 4d, followed by a lot of 1b 5b 43, followed by a 1b 5b 4b) when the length hits 70.


---

Comment by wjp created at 2012-01-12 20:47:46

With some terminal capabilities, gp is using escape sequences to "redraw" the current line once you send a newline after exactly the right (or wrong) input line length. This redrawing of the current line includes the prompt characters, and that triggers pexpect to output the next command prematurely, getting things out of sync.


---

Comment by jdemeyer created at 2012-01-13 10:04:31

Diff for the pexpect spkg, for review only


---

Attachment


---

Comment by GeorgSWeber created at 2012-01-20 13:26:31

Well,
I'm not too fond of mixing up the change of "eval_using_file_cutoff" value from 50 to 1024 (in "12221_pexpect_unset_TERM.patch") on the one hand, and the safer handling of the "TERM" envorinment variable on the other hand --- these seem orthogonal action items to me, being worth independent tickets.

However, none of these changes makes the situation worse than before, and the cleaning up of the pexpect spkg alone is worth to have this getting in the main tree as soon as possible.


Cheers,
Georg


---

Comment by GeorgSWeber created at 2012-01-20 13:26:31

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-01-20 13:40:27

Replying to [comment:38 GeorgSWeber]:
> Well,
> I'm not too fond of mixing up the change of "eval_using_file_cutoff" value from 50 to 1024 (in "12221_pexpect_unset_TERM.patch") on the one hand, and the safer handling of the "TERM" envorinment variable on the other hand --- these seem orthogonal action items to me, being worth independent tickets.
Fair enough, see #12330.


---

Comment by jdemeyer created at 2012-01-20 13:43:16

Resolution: fixed


---

Attachment


---

Comment by jdemeyer created at 2012-01-20 13:43:43

Georg, would you mind reviewing #12330 then?
