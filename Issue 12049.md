# Issue 12049: Failures in gp interface with long $HOME

archive/issues_012049.json:
```json
{
    "body": "Assignee: @williamstein\n\nCC:  @JohnCremona\n\nKeywords: gp pexpect\n\nWhen the home directory $HOME is unusually long, failures happen in the gp interface:\n\n```\n( export HOME=\"/tmp/123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789/\"; mkdir -p $HOME; ./sage -t --long devel/sage/sage/ )\n[...]\nsage -t  \"devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py\"\n  ***   Warning: new stack size = 1003360 (0.957 Mbytes).\n  ***   Warning: new stack size = 1003360 (0.957 Mbytes).\n**********************************************************************\nFile \"/usr/local/src/sage-4.8.alpha4/devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py\", line 526:\n    sage: E.conductor(algorithm=\"gp\")\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/local/src/sage-4.8.alpha4/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/usr/local/src/sage-4.8.alpha4/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/usr/local/src/sage-4.8.alpha4/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_12[5]>\", line 1, in <module>\n        E.conductor(algorithm=\"gp\")###line 526:\n    sage: E.conductor(algorithm=\"gp\")\n      File \"/usr/local/src/sage-4.8.alpha4/local/lib/python/site-packages/sage/schemes/elliptic_curves/ell_rational_field.py\", line 552, in conductor\n        self.__conductor_gp = Integer(gp.eval('ellglobalred(ellinit(%s,0))[1]'%list(self.a_invariants())))\n      File \"integer.pyx\", line 681, in sage.rings.integer.Integer.__init__ (sage/rings/integer.c:6786)\n    TypeError: unable to convert x (=read(\"/tmp/123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789/.sage/temp/arcanis/5630//interface//tmp5647\") ) to an integer\n**********************************************************************\nFile \"/usr/local/src/sage-4.8.alpha4/devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py\", line 1430:\n    sage: E.simon_two_descent()\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/local/src/sage-4.8.alpha4/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/usr/local/src/sage-4.8.alpha4/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/usr/local/src/sage-4.8.alpha4/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_28[4]>\", line 1, in <module>\n        E.simon_two_descent()###line 1430:\n    sage: E.simon_two_descent()\n      File \"/usr/local/src/sage-4.8.alpha4/local/lib/python/site-packages/sage/schemes/elliptic_curves/ell_rational_field.py\", line 1493, in simon_two_descent\n        maxprob=maxprob, limbigprime=limbigprime)\n      File \"/usr/local/src/sage-4.8.alpha4/local/lib/python/site-packages/sage/schemes/elliptic_curves/gp_simon.py\", line 117, in simon_two_descent\n        ans = sage_eval(v, {'Mod': _gp_mod, 'y': K.gen(0)})\n      File \"/usr/local/src/sage-4.8.alpha4/local/lib/python/site-packages/sage/misc/sage_eval.py\", line 199, in sage_eval\n        return eval(source, sage.all.__dict__, locals)\n      File \"<string>\", line 0\n\n        ^\n     SyntaxError: unexpected EOF while parsing\n**********************************************************************\n[...]\nThe following tests failed:\n\n\n        sage -t  \"devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py\"\n        sage -t  \"devel/sage/sage/schemes/elliptic_curves/gp_simon.py\"\n        sage -t  \"devel/sage/sage/schemes/elliptic_curves/lseries_ell.py\"\n        sage -t  \"devel/sage/sage/schemes/elliptic_curves/sha_tate.py\"\n        sage -t  \"devel/sage/sage/schemes/elliptic_curves/ell_number_field.py\"\n        sage -t  \"devel/sage/sage/schemes/elliptic_curves/period_lattice.py\"\n        sage -t  \"devel/sage/sage/schemes/elliptic_curves/BSD.py\"\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/12221\n\n",
    "created_at": "2011-12-22T13:27:47Z",
    "labels": [
        "component: interfaces",
        "blocker"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.0",
    "title": "Failures in gp interface with long $HOME",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12049",
    "user": "https://github.com/jdemeyer"
}
```
Assignee: @williamstein

CC:  @JohnCremona

Keywords: gp pexpect

When the home directory $HOME is unusually long, failures happen in the gp interface:

```
( export HOME="/tmp/123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789/"; mkdir -p $HOME; ./sage -t --long devel/sage/sage/ )
[...]
sage -t  "devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py"
  ***   Warning: new stack size = 1003360 (0.957 Mbytes).
  ***   Warning: new stack size = 1003360 (0.957 Mbytes).
**********************************************************************
File "/usr/local/src/sage-4.8.alpha4/devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py", line 526:
    sage: E.conductor(algorithm="gp")
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/src/sage-4.8.alpha4/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/usr/local/src/sage-4.8.alpha4/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/usr/local/src/sage-4.8.alpha4/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_12[5]>", line 1, in <module>
        E.conductor(algorithm="gp")###line 526:
    sage: E.conductor(algorithm="gp")
      File "/usr/local/src/sage-4.8.alpha4/local/lib/python/site-packages/sage/schemes/elliptic_curves/ell_rational_field.py", line 552, in conductor
        self.__conductor_gp = Integer(gp.eval('ellglobalred(ellinit(%s,0))[1]'%list(self.a_invariants())))
      File "integer.pyx", line 681, in sage.rings.integer.Integer.__init__ (sage/rings/integer.c:6786)
    TypeError: unable to convert x (=read("/tmp/123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789/.sage/temp/arcanis/5630//interface//tmp5647") ) to an integer
**********************************************************************
File "/usr/local/src/sage-4.8.alpha4/devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py", line 1430:
    sage: E.simon_two_descent()
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/src/sage-4.8.alpha4/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/usr/local/src/sage-4.8.alpha4/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/usr/local/src/sage-4.8.alpha4/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_28[4]>", line 1, in <module>
        E.simon_two_descent()###line 1430:
    sage: E.simon_two_descent()
      File "/usr/local/src/sage-4.8.alpha4/local/lib/python/site-packages/sage/schemes/elliptic_curves/ell_rational_field.py", line 1493, in simon_two_descent
        maxprob=maxprob, limbigprime=limbigprime)
      File "/usr/local/src/sage-4.8.alpha4/local/lib/python/site-packages/sage/schemes/elliptic_curves/gp_simon.py", line 117, in simon_two_descent
        ans = sage_eval(v, {'Mod': _gp_mod, 'y': K.gen(0)})
      File "/usr/local/src/sage-4.8.alpha4/local/lib/python/site-packages/sage/misc/sage_eval.py", line 199, in sage_eval
        return eval(source, sage.all.__dict__, locals)
      File "<string>", line 0

        ^
     SyntaxError: unexpected EOF while parsing
**********************************************************************
[...]
The following tests failed:


        sage -t  "devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py"
        sage -t  "devel/sage/sage/schemes/elliptic_curves/gp_simon.py"
        sage -t  "devel/sage/sage/schemes/elliptic_curves/lseries_ell.py"
        sage -t  "devel/sage/sage/schemes/elliptic_curves/sha_tate.py"
        sage -t  "devel/sage/sage/schemes/elliptic_curves/ell_number_field.py"
        sage -t  "devel/sage/sage/schemes/elliptic_curves/period_lattice.py"
        sage -t  "devel/sage/sage/schemes/elliptic_curves/BSD.py"
```


Issue created by migration from https://trac.sagemath.org/ticket/12221





---

archive/issue_comments_139483.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2011-12-22T13:28:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12049#issuecomment-139483",
    "user": "https://github.com/jdemeyer"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_139484.json:
```json
{
    "body": "I can't reproduce this, either on sage.math or an OS X box.  What platform were you using?",
    "created_at": "2011-12-22T16:37:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12049#issuecomment-139484",
    "user": "https://github.com/jhpalmieri"
}
```

I can't reproduce this, either on sage.math or an OS X box.  What platform were you using?



---

archive/issue_comments_139485.json:
```json
{
    "body": "It might really be caused by #11704 then.  Need to do some more tests.",
    "created_at": "2011-12-22T16:55:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12049#issuecomment-139485",
    "user": "https://github.com/jdemeyer"
}
```

It might really be caused by #11704 then.  Need to do some more tests.



---

archive/issue_comments_139486.json:
```json
{
    "body": "I should clarify: I couldn't reproduce this, either before applying the patch from #11704 or after.",
    "created_at": "2011-12-22T17:19:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12049#issuecomment-139486",
    "user": "https://github.com/jhpalmieri"
}
```

I should clarify: I couldn't reproduce this, either before applying the patch from #11704 or after.



---

archive/issue_comments_139487.json:
```json
{
    "body": "It might really be caused by #11704 + #11073 then. Need to do some more tests.",
    "created_at": "2011-12-23T16:32:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12049#issuecomment-139487",
    "user": "https://github.com/jdemeyer"
}
```

It might really be caused by #11704 + #11073 then. Need to do some more tests.



---

archive/issue_comments_139488.json:
```json
{
    "body": "Replying to [comment:7 jdemeyer]:\n> It might really be caused by #11704 + #11073 then. Need to do some more tests. \n\nThat combination doesn't cause me problems on sage.math: I have a copy of sage in `/scratch/palmieri/11073/sage-4.8.a4-11073` which has the patches from #11073 and its dependencies, including #11704.  Tests pass when I use the command in the ticket description.  (I produced this version of Sage with the file [http://sage.math.washington.edu/home/palmieri/misc/11073/sage-4.8.a4-11073.tar](http://sage.math.washington.edu/home/palmieri/misc/11073/sage-4.8.a4-11073.tar).)",
    "created_at": "2011-12-23T18:07:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12049#issuecomment-139488",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:7 jdemeyer]:
> It might really be caused by #11704 + #11073 then. Need to do some more tests. 

That combination doesn't cause me problems on sage.math: I have a copy of sage in `/scratch/palmieri/11073/sage-4.8.a4-11073` which has the patches from #11073 and its dependencies, including #11704.  Tests pass when I use the command in the ticket description.  (I produced this version of Sage with the file [http://sage.math.washington.edu/home/palmieri/misc/11073/sage-4.8.a4-11073.tar](http://sage.math.washington.edu/home/palmieri/misc/11073/sage-4.8.a4-11073.tar).)



---

archive/issue_comments_139489.json:
```json
{
    "body": "Now I also have problems reproducing it.  It must be some strange interaction between several tickets.",
    "created_at": "2011-12-24T01:25:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12049#issuecomment-139489",
    "user": "https://github.com/jdemeyer"
}
```

Now I also have problems reproducing it.  It must be some strange interaction between several tickets.



---

archive/issue_comments_139490.json:
```json
{
    "body": "Maybe it's a race condition of some sort being triggered by #11704?",
    "created_at": "2011-12-24T01:34:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12049#issuecomment-139490",
    "user": "https://github.com/jdemeyer"
}
```

Maybe it's a race condition of some sort being triggered by #11704?



---

archive/issue_comments_139491.json:
```json
{
    "body": "I can't seem to reproduce this anymore...",
    "created_at": "2011-12-28T22:32:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12049#issuecomment-139491",
    "user": "https://github.com/jdemeyer"
}
```

I can't seem to reproduce this anymore...



---

archive/issue_comments_139492.json:
```json
{
    "body": "Reproducing it again sometimes when merging #11073...  must be some race condition, which makes it an even more annoying bug.",
    "created_at": "2012-01-04T19:00:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12049#issuecomment-139492",
    "user": "https://github.com/jdemeyer"
}
```

Reproducing it again sometimes when merging #11073...  must be some race condition, which makes it an even more annoying bug.



---

archive/issue_comments_139493.json:
```json
{
    "body": "These errors happen much less frequently (but they still do happen) with python-2.7.  At least that's my feeling.",
    "created_at": "2012-01-10T07:22:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12049#issuecomment-139493",
    "user": "https://github.com/jdemeyer"
}
```

These errors happen much less frequently (but they still do happen) with python-2.7.  At least that's my feeling.



---

archive/issue_comments_139494.json:
```json
{
    "body": "Important data point: the failures seem to happen only (or at least mostly) during the first test run.  Running \"make ptest\" from a fresh install causes a lot of failures.  Running \"make ptest\" a second time gives no (or much less) failures.",
    "created_at": "2012-01-10T23:03:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12049#issuecomment-139494",
    "user": "https://github.com/jdemeyer"
}
```

Important data point: the failures seem to happen only (or at least mostly) during the first test run.  Running "make ptest" from a fresh install causes a lot of failures.  Running "make ptest" a second time gives no (or much less) failures.



---

archive/issue_comments_139495.json:
```json
{
    "body": "This observation about the \"first run\" could be because of a cold disk cache causing some race condition.",
    "created_at": "2012-01-10T23:06:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12049#issuecomment-139495",
    "user": "https://github.com/jdemeyer"
}
```

This observation about the "first run" could be because of a cold disk cache causing some race condition.



---

archive/issue_comments_139496.json:
```json
{
    "body": "Attachment [12221_debug.patch](tarball://root/attachments/some-uuid/ticket12221/12221_debug.patch) by @jdemeyer created at 2012-01-12 11:01:12",
    "created_at": "2012-01-12T11:01:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12049#issuecomment-139496",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [12221_debug.patch](tarball://root/attachments/some-uuid/ticket12221/12221_debug.patch) by @jdemeyer created at 2012-01-12 11:01:12



---

archive/issue_comments_139497.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-01-12T13:51:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12049#issuecomment-139497",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_139498.json:
```json
{
    "body": "Very experimental fix seems to work on first sight, certainly needs more testing.",
    "created_at": "2012-01-12T13:51:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12049#issuecomment-139498",
    "user": "https://github.com/jdemeyer"
}
```

Very experimental fix seems to work on first sight, certainly needs more testing.



---

archive/issue_comments_139499.json:
```json
{
    "body": "Changing keywords from \"gp pexpect\" to \"gp pexpect spkg\".",
    "created_at": "2012-01-12T13:51:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12049#issuecomment-139499",
    "user": "https://github.com/jdemeyer"
}
```

Changing keywords from "gp pexpect" to "gp pexpect spkg".



---

archive/issue_comments_139500.json:
```json
{
    "body": "For the record, I still can't reproduce it on Fedora 16:\n\n```\n\n[vbraun@volker-laptop-two hg]$ hg qapplied\n12221_debug.patch\n[vbraun@volker-laptop-two hg]$ export TERM=screen\n[vbraun@volker-laptop-two hg]$ sage /tmp/test12221.sage \nTERM = screen\n18 char filename: ok\n19 char filename: ok\n[...\n117 char filename: ok\n```\n",
    "created_at": "2012-01-12T15:35:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12049#issuecomment-139500",
    "user": "https://github.com/vbraun"
}
```

For the record, I still can't reproduce it on Fedora 16:

```

[vbraun@volker-laptop-two hg]$ hg qapplied
12221_debug.patch
[vbraun@volker-laptop-two hg]$ export TERM=screen
[vbraun@volker-laptop-two hg]$ sage /tmp/test12221.sage 
TERM = screen
18 char filename: ok
19 char filename: ok
[...
117 char filename: ok
```




---

archive/issue_comments_139501.json:
```json
{
    "body": "I haven't looked at this at all, but it's probably safer to set TERM to `dumb' than unsetting it. (As also evidenced by the termcap crash in #12282)",
    "created_at": "2012-01-12T15:55:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12049#issuecomment-139501",
    "user": "https://github.com/wjp"
}
```

I haven't looked at this at all, but it's probably safer to set TERM to `dumb' than unsetting it. (As also evidenced by the termcap crash in #12282)



---

archive/issue_comments_139502.json:
```json
{
    "body": "Volker: you need to actually use \"screen\", not just set TERM=screen.\n\nAnd then the obvious: is your `sage` executable the same as `./sage` and did you run `./sage -b`?",
    "created_at": "2012-01-12T15:56:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12049#issuecomment-139502",
    "user": "https://github.com/jdemeyer"
}
```

Volker: you need to actually use "screen", not just set TERM=screen.

And then the obvious: is your `sage` executable the same as `./sage` and did you run `./sage -b`?



---

archive/issue_comments_139503.json:
```json
{
    "body": "Replying to [comment:30 wjp]:\n> I haven't looked at this at all, but it's probably safer to set TERM to `dumb' than unsetting it. (As also evidenced by the termcap crash in #12282)\nI already tried this and unfortunately the error still remains with TERM=dumb.",
    "created_at": "2012-01-12T15:57:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12049#issuecomment-139503",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:30 wjp]:
> I haven't looked at this at all, but it's probably safer to set TERM to `dumb' than unsetting it. (As also evidenced by the termcap crash in #12282)
I already tried this and unfortunately the error still remains with TERM=dumb.



---

archive/issue_comments_139504.json:
```json
{
    "body": "Attachment [test12221.sage](tarball://root/attachments/some-uuid/ticket12221/test12221.sage) by @jdemeyer created at 2012-01-12 15:59:31",
    "created_at": "2012-01-12T15:59:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12049#issuecomment-139504",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [test12221.sage](tarball://root/attachments/some-uuid/ticket12221/test12221.sage) by @jdemeyer created at 2012-01-12 15:59:31



---

archive/issue_comments_139505.json:
```json
{
    "body": "I tried it under `screen` as well without problems. I also tried running the loop longer and this works until I hit the 255 byte filename limit in ext4:\n\n```\n269 char filename: ok\n270 char filename: ok\nTraceback (most recent call last):\n  File \"/tmp/test12221.py\", line 11, in <module>\n    f = open(gpfilename, \"w\")\nIOError: [Errno 36] File name too long: '/tmp/tmppzCAbE/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.gp'\n```\n",
    "created_at": "2012-01-12T16:30:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12049#issuecomment-139505",
    "user": "https://github.com/vbraun"
}
```

I tried it under `screen` as well without problems. I also tried running the loop longer and this works until I hit the 255 byte filename limit in ext4:

```
269 char filename: ok
270 char filename: ok
Traceback (most recent call last):
  File "/tmp/test12221.py", line 11, in <module>
    f = open(gpfilename, "w")
IOError: [Errno 36] File name too long: '/tmp/tmppzCAbE/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.gp'
```




---

archive/issue_comments_139506.json:
```json
{
    "body": "I can reproduce the failing test12221.sage at home in a screen session, but it goes away with TERM=dumb.\n\nOn sage.math the test doesn't fail for me, but I do get a lot of escape sequences (1b 4d, followed by a lot of 1b 5b 43, followed by a 1b 5b 4b) when the length hits 70.",
    "created_at": "2012-01-12T19:36:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12049#issuecomment-139506",
    "user": "https://github.com/wjp"
}
```

I can reproduce the failing test12221.sage at home in a screen session, but it goes away with TERM=dumb.

On sage.math the test doesn't fail for me, but I do get a lot of escape sequences (1b 4d, followed by a lot of 1b 5b 43, followed by a 1b 5b 4b) when the length hits 70.



---

archive/issue_comments_139507.json:
```json
{
    "body": "With some terminal capabilities, gp is using escape sequences to \"redraw\" the current line once you send a newline after exactly the right (or wrong) input line length. This redrawing of the current line includes the prompt characters, and that triggers pexpect to output the next command prematurely, getting things out of sync.",
    "created_at": "2012-01-12T20:47:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12049#issuecomment-139507",
    "user": "https://github.com/wjp"
}
```

With some terminal capabilities, gp is using escape sequences to "redraw" the current line once you send a newline after exactly the right (or wrong) input line length. This redrawing of the current line includes the prompt characters, and that triggers pexpect to output the next command prematurely, getting things out of sync.



---

archive/issue_comments_139508.json:
```json
{
    "body": "Diff for the pexpect spkg, for review only",
    "created_at": "2012-01-13T10:04:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12049#issuecomment-139508",
    "user": "https://github.com/jdemeyer"
}
```

Diff for the pexpect spkg, for review only



---

archive/issue_comments_139509.json:
```json
{
    "body": "Attachment [pexpect-2.0.p4-p5.diff](tarball://root/attachments/some-uuid/ticket12221/pexpect-2.0.p4-p5.diff) by @jdemeyer created at 2012-01-15 21:58:57",
    "created_at": "2012-01-15T21:58:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12049#issuecomment-139509",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [pexpect-2.0.p4-p5.diff](tarball://root/attachments/some-uuid/ticket12221/pexpect-2.0.p4-p5.diff) by @jdemeyer created at 2012-01-15 21:58:57



---

archive/issue_comments_139510.json:
```json
{
    "body": "Well,\nI'm not too fond of mixing up the change of \"eval_using_file_cutoff\" value from 50 to 1024 (in \"12221_pexpect_unset_TERM.patch\") on the one hand, and the safer handling of the \"TERM\" envorinment variable on the other hand --- these seem orthogonal action items to me, being worth independent tickets.\n\nHowever, none of these changes makes the situation worse than before, and the cleaning up of the pexpect spkg alone is worth to have this getting in the main tree as soon as possible.\n\n\nCheers,\nGeorg",
    "created_at": "2012-01-20T13:26:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12049#issuecomment-139510",
    "user": "https://trac.sagemath.org/admin/accounts/users/GeorgSWeber"
}
```

Well,
I'm not too fond of mixing up the change of "eval_using_file_cutoff" value from 50 to 1024 (in "12221_pexpect_unset_TERM.patch") on the one hand, and the safer handling of the "TERM" envorinment variable on the other hand --- these seem orthogonal action items to me, being worth independent tickets.

However, none of these changes makes the situation worse than before, and the cleaning up of the pexpect spkg alone is worth to have this getting in the main tree as soon as possible.


Cheers,
Georg



---

archive/issue_comments_139511.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-01-20T13:26:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12049#issuecomment-139511",
    "user": "https://trac.sagemath.org/admin/accounts/users/GeorgSWeber"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_139512.json:
```json
{
    "body": "Replying to [comment:38 GeorgSWeber]:\n> Well,\n> I'm not too fond of mixing up the change of \"eval_using_file_cutoff\" value from 50 to 1024 (in \"12221_pexpect_unset_TERM.patch\") on the one hand, and the safer handling of the \"TERM\" envorinment variable on the other hand --- these seem orthogonal action items to me, being worth independent tickets.\nFair enough, see #12330.",
    "created_at": "2012-01-20T13:40:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12049#issuecomment-139512",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:38 GeorgSWeber]:
> Well,
> I'm not too fond of mixing up the change of "eval_using_file_cutoff" value from 50 to 1024 (in "12221_pexpect_unset_TERM.patch") on the one hand, and the safer handling of the "TERM" envorinment variable on the other hand --- these seem orthogonal action items to me, being worth independent tickets.
Fair enough, see #12330.



---

archive/issue_events_012079.json:
```json
{
    "actor": "@jdemeyer",
    "created_at": "2012-01-20T13:43:16Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/12049",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12049#event-12079"
}
```



---

archive/issue_comments_139513.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-01-20T13:43:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12049#issuecomment-139513",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_139514.json:
```json
{
    "body": "Attachment [12221_pexpect_unset_TERM.patch](tarball://root/attachments/some-uuid/ticket12221/12221_pexpect_unset_TERM.patch) by @jdemeyer created at 2012-01-20 13:43:16",
    "created_at": "2012-01-20T13:43:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12049#issuecomment-139514",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [12221_pexpect_unset_TERM.patch](tarball://root/attachments/some-uuid/ticket12221/12221_pexpect_unset_TERM.patch) by @jdemeyer created at 2012-01-20 13:43:16



---

archive/issue_comments_139515.json:
```json
{
    "body": "Georg, would you mind reviewing #12330 then?",
    "created_at": "2012-01-20T13:43:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12049",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12049#issuecomment-139515",
    "user": "https://github.com/jdemeyer"
}
```

Georg, would you mind reviewing #12330 then?
