# Issue 15385: Immutable graphs must not be relabeled

Issue created by migration from https://trac.sagemath.org/ticket/15622

Original creator: ncohen

Original creation time: 2014-01-02 21:20:19

CC:  simonking

Now 

```
sage: Graph(graphs.PetersenGraph(), immutable=True).relabel({})
...
ValueError: Thou shalt not relabel an immutable graph
```


Before, the following happened 

```
sage: Graph(graphs.PetersenGraph(), data_structure="static_sparse").relabel({})
...
AttributeError: 'StaticSparseBackend' object has no attribute 'vertex_ints'
```


This is actually another bug, as there should be a `vertex_ints` variable in static sparse graphs. But that's another problem to be addressed in another ticket `:-P`

Nathann


---

Comment by ncohen created at 2014-01-02 21:20:37

Changing status from new to needs_review.


---

Comment by git created at 2014-01-02 21:23:55

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by SimonKing created at 2014-01-02 22:56:55

The code looks good. Perhaps the error message should hint at how to create a mutable copy?


---

Comment by ncohen created at 2014-01-03 08:13:14

OKayyyyyyyy.. What about this ?

Nathann


---

Comment by git created at 2014-01-03 08:13:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2014-01-03 13:07:25

Changing status from needs_review to needs_work.


---

Comment by SimonKing created at 2014-01-03 13:07:25

Oops:

```
sage -t --long src/sage/graphs/base/static_sparse_backend.pyx
**********************************************************************
File "src/sage/graphs/base/static_sparse_backend.pyx", line 422, in sage.graphs.base.static_sparse_backend.StaticSparseBackend.relabel
Failed example:
    g.relabel([],True)
Expected:
    Traceback (most recent call last):
    ...
    ValueError: Thou shalt not remove a vertex from an immutable graph
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 480, in _run
        self.execute(example, compiled, test.globs)
      File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 839, in execute
        exec compiled in globs
      File "<doctest sage.graphs.base.static_sparse_backend.StaticSparseBackend.relabel[2]>", line 1, in <module>
        g.relabel([],True)
    AttributeError: 'sage.graphs.base.static_sparse_backend.StaticSpars' object has no attribute 'relabel'
```

That is the only error, and I'll probably fix it in a review commit.


---

Comment by SimonKing created at 2014-01-03 13:10:52

WTF??????

When I do the obvious and change `StaticSparseCGraph` into `StaticSparseBackend`, I get

```
Failed example:
    g.relabel([],True)
Expected:
    Traceback (most recent call last):
    ...
    ValueError: Thou shalt not remove a vertex from an immutable graph
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 480, in _run
        self.execute(example, compiled, test.globs)
      File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 839, in execute
        exec compiled in globs
      File "<doctest sage.graphs.base.static_sparse_backend.StaticSparseBackend.relabel[2]>", line 1, in <module>
        g.relabel([],True)
      File "static_sparse_backend.pyx", line 428, in sage.graphs.base.static_sparse_backend.StaticSparseBackend.relabel (sage/graphs/base/static_sparse_backend.c:4740)
    ValueError: Thou shalt not relabel an immutable graph
```

Where does the blankline come from? And why is there no blankline when doing the test interactively?


---

Comment by SimonKing created at 2014-01-03 13:11:57

Ahaaa! You had a wrong class _and_ a wrong error message in your test ("remove a vertex" versus "relabel").


---

Comment by ncohen created at 2014-01-03 13:18:21

I don't get what the "obvious change from `StaticSparseCGraph` into `StaticSparseBackend`" could be `O_o`

Nathann


---

Comment by SimonKing created at 2014-01-03 13:19:59

Replying to [comment:10 ncohen]:
> I don't get what the "obvious change from `StaticSparseCGraph` into `StaticSparseBackend`" could be `O_o`


```diff
diff --git a/src/sage/graphs/base/static_sparse_backend.pyx b/src/sage/graphs/base/static_sparse_backend.pyx
index 9b5a8fe..e5b889e 100644
--- a/src/sage/graphs/base/static_sparse_backend.pyx
+++ b/src/sage/graphs/base/static_sparse_backend.pyx
@@ -417,12 +417,12 @@ class StaticSparseBackend(CGraphBackend):
 
         TEST::
 
-            sage: from sage.graphs.base.static_sparse_backend import StaticSparseCGraph
-            sage: g = StaticSparseCGraph(graphs.PetersenGraph())
+            sage: from sage.graphs.base.static_sparse_backend import StaticSparseBackend
+            sage: g = StaticSparseBackend(graphs.PetersenGraph())
             sage: g.relabel([],True)
             Traceback (most recent call last):
             ...
-            ValueError: Thou shalt not remove a vertex from an immutable graph
+            ValueError: Thou shalt not relabel an immutable graph
 
         """
         raise ValueError("Thou shalt not relabel an immutable graph")
```

`StaticSparceCGraph` simply is the wrong class.


---

Comment by SimonKing created at 2014-01-03 13:20:36

For the record: It already takes 5 minutes to push my review commit.


---

Comment by ncohen created at 2014-01-03 13:24:18

Oh. Ahem. Right `O_O;;;;;;`

Sorryyyyyyyyyyyyyyyyyyyyyyyyyyy `O_O;;;;;`

Nathann

Review commit : I often Ctrl+C it before it ends. Trac sends the mails almost instantaneously, the trac ticket is updated at the same time. I just have no idea what it does afterwards.


---

Comment by SimonKing created at 2014-01-03 13:25:49

It seems that once more I have to manually upload the commit.


---

Comment by SimonKing created at 2014-01-03 13:25:49

Changing status from needs_work to positive_review.


---

Comment by ncohen created at 2014-01-03 13:26:43

I think it's because you should set the branch name *before* pushing the commit. Otherwise nothing is triggered on the trac server's side.

Nathann


---

Comment by ncohen created at 2014-01-03 13:27:33

Okay. We are now in the Volker-Feared situation of a ticket which has a positive review, with a dependency which is still in `needs_review` `:-P`

Thanks for this commit !

Nathann


---

Comment by ncohen created at 2014-01-03 13:28:53

By the way, isn't the trac server 99999x times faster than yesterday ? Andrew said he would do something about it and it looks like he did `O_O`

Nathann


---

Comment by vbraun created at 2014-01-05 08:21:11

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2014-01-05 08:21:11

Various doctests fail (see also patchbot)


---

Comment by ncohen created at 2014-01-05 08:24:07

Gloops. Right.


---

Comment by ncohen created at 2014-01-05 09:24:15

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2014-01-05 09:24:15

That's the only way I found to make this work before #15623 is merged `T_T`

Nathann


---

Comment by ncohen created at 2014-01-05 09:25:55

Okay, it looks like the automatic message does not work, but the branch is updated !

Nathann


---

Comment by SimonKing created at 2014-01-05 09:48:45

Replying to [comment:22 vbraun]:
> Various doctests fail (see also patchbot)

WTF? When I reviewed it, things worked. Or did I accidentally merge other tickets that aren't dependencies for this?


---

Comment by SimonKing created at 2014-01-06 15:57:28

Changing status from needs_review to positive_review.


---

Comment by SimonKing created at 2014-01-06 15:57:28

Hooray. After pulling from the ticket branch and merging with the current develop branch, `make ptest` results in

```
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 3791.7 seconds
    cpu time: 6340.1 seconds
    cumulative wall time: 7304.6 seconds
```

Nathann's last commit looks like the right thing to do. Hence, I hope this time my positive review will persist...


---

Comment by vbraun created at 2014-01-07 04:55:39

Resolution: fixed
