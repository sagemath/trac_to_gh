# Issue 27720: Add AG codes and decoders

archive/issues_027720.json:
```json
{
    "body": "Evaluation and differential AG codes are added. \n\nUnique decoders for AG codes are addded.\n----\nThe author was supported by NRF of Korea 2018, 2019\n\nIssue created by migration from https://trac.sagemath.org/ticket/27957\n\n",
    "created_at": "2019-06-08T23:41:34Z",
    "labels": [
        "coding theory",
        "major",
        "enhancement"
    ],
    "title": "Add AG codes and decoders",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27720",
    "user": "klee"
}
```
Evaluation and differential AG codes are added. 

Unique decoders for AG codes are addded.
----
The author was supported by NRF of Korea 2018, 2019

Issue created by migration from https://trac.sagemath.org/ticket/27957





---

archive/issue_comments_391475.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-06-08T23:43:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391475",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_391476.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-06-09T03:27:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391476",
    "user": "klee"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_391477.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-06-09T03:27:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391477",
    "user": "klee"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_391478.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2019-06-11T06:10:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391478",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_391479.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-06-11T06:11:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391479",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_391480.json:
```json
{
    "body": "Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).",
    "created_at": "2019-06-14T14:50:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391480",
    "user": "embray"
}
```

Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).



---

archive/issue_comments_391481.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-06-17T02:44:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391481",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_391482.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-06-25T07:44:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391482",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_391483.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-06-27T05:24:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391483",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_391484.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-07-03T09:40:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391484",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_391485.json:
```json
{
    "body": "Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).",
    "created_at": "2019-07-03T11:37:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391485",
    "user": "embray"
}
```

Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).



---

archive/issue_comments_391486.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-07-04T13:16:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391486",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_391487.json:
```json
{
    "body": "Codes on affine line",
    "created_at": "2019-07-12T06:06:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391487",
    "user": "klee"
}
```

Codes on affine line



---

archive/issue_comments_391488.json:
```json
{
    "body": "Attachment [Reed Solomon codes.ipynb](tarball://root/attachments/some-uuid/ticket27957/Reed Solomon codes.ipynb) by klee created at 2019-07-12 06:06:36\n\nCodes on projective line",
    "created_at": "2019-07-12T06:06:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391488",
    "user": "klee"
}
```

Attachment [Reed Solomon codes.ipynb](tarball://root/attachments/some-uuid/ticket27957/Reed Solomon codes.ipynb) by klee created at 2019-07-12 06:06:36

Codes on projective line



---

archive/issue_comments_391489.json:
```json
{
    "body": "Attachment [Goppa codes.ipynb](tarball://root/attachments/some-uuid/ticket27957/Goppa codes.ipynb) by klee created at 2019-07-12 06:07:07\n\nCodes on affine plane curve",
    "created_at": "2019-07-12T06:07:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391489",
    "user": "klee"
}
```

Attachment [Goppa codes.ipynb](tarball://root/attachments/some-uuid/ticket27957/Goppa codes.ipynb) by klee created at 2019-07-12 06:07:07

Codes on affine plane curve



---

archive/issue_comments_391490.json:
```json
{
    "body": "Attachment [Codes on Klein quartic.ipynb](tarball://root/attachments/some-uuid/ticket27957/Codes on Klein quartic.ipynb) by klee created at 2019-07-12 06:07:29\n\nCodes on projective plane curve",
    "created_at": "2019-07-12T06:07:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391490",
    "user": "klee"
}
```

Attachment [Codes on Klein quartic.ipynb](tarball://root/attachments/some-uuid/ticket27957/Codes on Klein quartic.ipynb) by klee created at 2019-07-12 06:07:29

Codes on projective plane curve



---

archive/issue_comments_391491.json:
```json
{
    "body": "Codes on space curve",
    "created_at": "2019-07-12T06:08:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391491",
    "user": "klee"
}
```

Codes on space curve



---

archive/issue_comments_391492.json:
```json
{
    "body": "Attachment [Codes on GK curves I.ipynb](tarball://root/attachments/some-uuid/ticket27957/Codes on GK curves I.ipynb) by klee created at 2019-07-12 06:09:22\n\nCodes on space curve",
    "created_at": "2019-07-12T06:09:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391492",
    "user": "klee"
}
```

Attachment [Codes on GK curves I.ipynb](tarball://root/attachments/some-uuid/ticket27957/Codes on GK curves I.ipynb) by klee created at 2019-07-12 06:09:22

Codes on space curve



---

archive/issue_comments_391493.json:
```json
{
    "body": "Attachment [Codes on GK curves II.ipynb](tarball://root/attachments/some-uuid/ticket27957/Codes on GK curves II.ipynb) by klee created at 2019-07-12 06:22:03",
    "created_at": "2019-07-12T06:22:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391493",
    "user": "klee"
}
```

Attachment [Codes on GK curves II.ipynb](tarball://root/attachments/some-uuid/ticket27957/Codes on GK curves II.ipynb) by klee created at 2019-07-12 06:22:03



---

archive/issue_comments_391494.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-12-20T04:05:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391494",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_391495.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-03-12T00:38:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391495",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_391496.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-03-12T00:40:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391496",
    "user": "klee"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_391497.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-31T06:08:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391497",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_391498.json:
```json
{
    "body": "Looks good overall. I just have a few comments.\n\nI think it is better to be more specific about where you are importing stuff\n\n```diff\n-from sage.modules.all import vector\n-from sage.matrix.all import matrix, MatrixSpace\n+from sage.modules.free_module_element import vector\n+from sage.matrix.constructor import matrix\n+from sage.matrix.matrix_space import MatrixSpace\n```\n\nThis can help limit circular imports.\n\nI don't understand why you have the function `cartier_fixed` in `CartierCode.__init__`. It is only called once and just has one return statement at the bottom.\n\nI don't think it is a good idea to assume the doctests will be run in order. (In fact, I think there is a ticket looking to run them in any order.) I wouldn't rely on a saved object. I would instead suggest having a pickle in the file (or a separate test file) as a string (or a pickle stored somewhere) that you can load.\n\n\n```diff\n-As well known, the two kinds of AG codes are dual to each other. ::\n+As is well known, the two kinds of AG codes are dual to each other. ::\n```\n\n\nSomething else you can do for `__eq__` is first test ``if self is other:`` to short-circuit when comparing against the same object.\n\nIn `DifferentialAGCodeUniqueDecoder._encode` and `_decode`, you have `TESTS:` with one colon.\n\nDo you want `_Decoder_K` to be hidden from the documentation? Since it is a key component, it might be good to include it.\n\nSince `_Decoder_K` and `_Decoder_K_extension` and their subclasses seem like the key workhorses, would it make sense to include them as a separate Cython file and make them `cdef` classes?\n\nI am not sure about variable scope here:\n\n```python\n        # compute xR\n        for xR in Q.divisor(gamma).basis_function_space():\n            if xR.valuation(Q) == -gamma:\n                break\n```\n\nI think it would be better to do\n\n```python\n        def compute_xR():\n            for xR in Q.divisor(gamma).basis_function_space():\n                if xR.valuation(Q) == -gamma:\n                    return xR\n        xR = compute_xR()\n```\n\nI thought Python3 didn't allow variables to leak out of scope like that anymore? Well, I find this to be a little safer. Another option would be\n\n```python\n        for b in Q.divisor(gamma).basis_function_space():\n            if b.valuation(Q) == -gamma:\n                xR = b\n                break\n```\n",
    "created_at": "2021-04-16T01:06:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391498",
    "user": "tscrim"
}
```

Looks good overall. I just have a few comments.

I think it is better to be more specific about where you are importing stuff

```diff
-from sage.modules.all import vector
-from sage.matrix.all import matrix, MatrixSpace
+from sage.modules.free_module_element import vector
+from sage.matrix.constructor import matrix
+from sage.matrix.matrix_space import MatrixSpace
```

This can help limit circular imports.

I don't understand why you have the function `cartier_fixed` in `CartierCode.__init__`. It is only called once and just has one return statement at the bottom.

I don't think it is a good idea to assume the doctests will be run in order. (In fact, I think there is a ticket looking to run them in any order.) I wouldn't rely on a saved object. I would instead suggest having a pickle in the file (or a separate test file) as a string (or a pickle stored somewhere) that you can load.


```diff
-As well known, the two kinds of AG codes are dual to each other. ::
+As is well known, the two kinds of AG codes are dual to each other. ::
```


Something else you can do for `__eq__` is first test ``if self is other:`` to short-circuit when comparing against the same object.

In `DifferentialAGCodeUniqueDecoder._encode` and `_decode`, you have `TESTS:` with one colon.

Do you want `_Decoder_K` to be hidden from the documentation? Since it is a key component, it might be good to include it.

Since `_Decoder_K` and `_Decoder_K_extension` and their subclasses seem like the key workhorses, would it make sense to include them as a separate Cython file and make them `cdef` classes?

I am not sure about variable scope here:

```python
        # compute xR
        for xR in Q.divisor(gamma).basis_function_space():
            if xR.valuation(Q) == -gamma:
                break
```

I think it would be better to do

```python
        def compute_xR():
            for xR in Q.divisor(gamma).basis_function_space():
                if xR.valuation(Q) == -gamma:
                    return xR
        xR = compute_xR()
```

I thought Python3 didn't allow variables to leak out of scope like that anymore? Well, I find this to be a little safer. Another option would be

```python
        for b in Q.divisor(gamma).basis_function_space():
            if b.valuation(Q) == -gamma:
                xR = b
                break
```




---

archive/issue_comments_391499.json:
```json
{
    "body": "Replying to [comment:32 tscrim]:\n> Looks good overall. I just have a few comments.\n\nI appreciate your comments. Thank you.\n\n> I think it is better to be more specific about where you are importing stuff\n> {{{#!diff\n> -from sage.modules.all import vector\n> -from sage.matrix.all import matrix, MatrixSpace\n> +from sage.modules.free_module_element import vector\n> +from sage.matrix.constructor import matrix\n> +from sage.matrix.matrix_space import MatrixSpace\n> }}}\n> This can help limit circular imports.\n\nOkay.\n\n> \n> I don't understand why you have the function `cartier_fixed` in `CartierCode.__init__`. It is only called once and just has one return statement at the bottom.\n\nTo encapsulate the code in `cartier_fixed`. I didn't want the variables defined inside to affect the code outside. Moreover the code is natural for a general divisor `E`, but is applied to the specific divisor `G-D`.\n\n> I don't think it is a good idea to assume the doctests will be run in order. (In fact, I think there is a ticket looking to run them in any order.) I wouldn't rely on a saved object. I would instead suggest having a pickle in the file (or a separate test file) as a string (or a pickle stored somewhere) that you can load.\n\nBut then the pickle is not updated, and hence the tests would be for old objects. Isn't it against the purpose of the testing?\n\n> \n> {{{#!diff\n> -As well known, the two kinds of AG codes are dual to each other. ::\n> +As is well known, the two kinds of AG codes are dual to each other. ::\n> }}}\n> \n> Something else you can do for `__eq__` is first test ``if self is other:`` to short-circuit when comparing against the same object.\n> \n> In `DifferentialAGCodeUniqueDecoder._encode` and `_decode`, you have `TESTS:` with one colon.\n\nOkay.\n\n> Do you want `_Decoder_K` to be hidden from the documentation? Since it is a key component, it might be good to include it.\n\nIt is a key component. But the user does not need to interact with it. So the class name starts with an underline. It works in the background. The classes before it define the interface for the user. So I think it should be hidden.\n> \n> Since `_Decoder_K` and `_Decoder_K_extension` and their subclasses seem like the key workhorses, would it make sense to include them as a separate Cython file and make them `cdef` classes?\n\nRight they are the key workhorses. Maybe a good idea. Though I don't have much experiences with Cython files, I will try.\n\n> \n> I am not sure about variable scope here:\n> {{{#!python\n>         # compute xR\n>         for xR in Q.divisor(gamma).basis_function_space():\n>             if xR.valuation(Q) == -gamma:\n>                 break\n> }}}\n> I think it would be better to do\n> {{{#!python\n>         def compute_xR():\n>             for xR in Q.divisor(gamma).basis_function_space():\n>                 if xR.valuation(Q) == -gamma:\n>                     return xR\n>         xR = compute_xR()\n> }}}\n> I thought Python3 didn't allow variables to leak out of scope like that anymore? Well, I find this to be a little safer. Another option would be\n> {{{#!python\n>         for b in Q.divisor(gamma).basis_function_space():\n>             if b.valuation(Q) == -gamma:\n>                 xR = b\n>                 break\n> }}}\n\nI will use the last version. Thanks. By the way, the second version is in the same vein with the function `cartier_fixed`.",
    "created_at": "2021-04-16T08:46:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391499",
    "user": "klee"
}
```

Replying to [comment:32 tscrim]:
> Looks good overall. I just have a few comments.

I appreciate your comments. Thank you.

> I think it is better to be more specific about where you are importing stuff
> {{{#!diff
> -from sage.modules.all import vector
> -from sage.matrix.all import matrix, MatrixSpace
> +from sage.modules.free_module_element import vector
> +from sage.matrix.constructor import matrix
> +from sage.matrix.matrix_space import MatrixSpace
> }}}
> This can help limit circular imports.

Okay.

> 
> I don't understand why you have the function `cartier_fixed` in `CartierCode.__init__`. It is only called once and just has one return statement at the bottom.

To encapsulate the code in `cartier_fixed`. I didn't want the variables defined inside to affect the code outside. Moreover the code is natural for a general divisor `E`, but is applied to the specific divisor `G-D`.

> I don't think it is a good idea to assume the doctests will be run in order. (In fact, I think there is a ticket looking to run them in any order.) I wouldn't rely on a saved object. I would instead suggest having a pickle in the file (or a separate test file) as a string (or a pickle stored somewhere) that you can load.

But then the pickle is not updated, and hence the tests would be for old objects. Isn't it against the purpose of the testing?

> 
> {{{#!diff
> -As well known, the two kinds of AG codes are dual to each other. ::
> +As is well known, the two kinds of AG codes are dual to each other. ::
> }}}
> 
> Something else you can do for `__eq__` is first test ``if self is other:`` to short-circuit when comparing against the same object.
> 
> In `DifferentialAGCodeUniqueDecoder._encode` and `_decode`, you have `TESTS:` with one colon.

Okay.

> Do you want `_Decoder_K` to be hidden from the documentation? Since it is a key component, it might be good to include it.

It is a key component. But the user does not need to interact with it. So the class name starts with an underline. It works in the background. The classes before it define the interface for the user. So I think it should be hidden.
> 
> Since `_Decoder_K` and `_Decoder_K_extension` and their subclasses seem like the key workhorses, would it make sense to include them as a separate Cython file and make them `cdef` classes?

Right they are the key workhorses. Maybe a good idea. Though I don't have much experiences with Cython files, I will try.

> 
> I am not sure about variable scope here:
> {{{#!python
>         # compute xR
>         for xR in Q.divisor(gamma).basis_function_space():
>             if xR.valuation(Q) == -gamma:
>                 break
> }}}
> I think it would be better to do
> {{{#!python
>         def compute_xR():
>             for xR in Q.divisor(gamma).basis_function_space():
>                 if xR.valuation(Q) == -gamma:
>                     return xR
>         xR = compute_xR()
> }}}
> I thought Python3 didn't allow variables to leak out of scope like that anymore? Well, I find this to be a little safer. Another option would be
> {{{#!python
>         for b in Q.divisor(gamma).basis_function_space():
>             if b.valuation(Q) == -gamma:
>                 xR = b
>                 break
> }}}

I will use the last version. Thanks. By the way, the second version is in the same vein with the function `cartier_fixed`.



---

archive/issue_comments_391500.json:
```json
{
    "body": "Replying to [comment:33 klee]:\n> Replying to [comment:32 tscrim]:\n> > I don't understand why you have the function `cartier_fixed` in `CartierCode.__init__`. It is only called once and just has one return statement at the bottom.\n> \n> To encapsulate the code in `cartier_fixed`. I didn't want the variables defined inside to affect the code outside. Moreover the code is natural for a general divisor `E`, but is applied to the specific divisor `G-D`.\n\nIf it is natural, then I would suggest separating it out as a separate function. As long as the variables you use have distinct names, there should be no difference inside a function than outside.\n\n> > I don't think it is a good idea to assume the doctests will be run in order. (In fact, I think there is a ticket looking to run them in any order.) I wouldn't rely on a saved object. I would instead suggest having a pickle in the file (or a separate test file) as a string (or a pickle stored somewhere) that you can load.\n> \n> But then the pickle is not updated, and hence the tests would be for old objects. Isn't it against the purpose of the testing?\n\nIt would use the current object (assuming it isn't pickled in some non-standard way) when it is reconstructed. I would have to double-check with the pickling protocols, but the pickle data should only need to be updated in limited circumstances.\n\n> > Do you want `_Decoder_K` to be hidden from the documentation? Since it is a key component, it might be good to include it.\n> \n> It is a key component. But the user does not need to interact with it. So the class name starts with an underline. It works in the background. The classes before it define the interface for the user. So I think it should be hidden.\n\nI don't see why it needs to be hidden in the documentation. The documentation is also there for the maintainer as well as the user. Although if this is in a separate file, then you could have the \"main\" class documentation isolated from this.\n\n> > Since `_Decoder_K` and `_Decoder_K_extension` and their subclasses seem like the key workhorses, would it make sense to include them as a separate Cython file and make them `cdef` classes?\n> \n> Right they are the key workhorses. Maybe a good idea. Though I don't have much experiences with Cython files, I will try.\n\nTo Cythonize it, you just need to move your code into a `.pyx`. To make it a bit better, you add `cdef` before each class and create `.pxd` file (the `.pxd` is like a `.h` header file in C) with those class declarations. There should be a number of easily accessible examples for this; e.g., `groups/group.pxd`.\n\n> > I am not sure about variable scope here:\n> I will use the last version. Thanks. By the way, the second version is in the same vein with the function `cartier_fixed`.\n\nThe key difference is the `return` statement aborting the run part of the way through the loop that should set a variable.",
    "created_at": "2021-04-17T05:24:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391500",
    "user": "tscrim"
}
```

Replying to [comment:33 klee]:
> Replying to [comment:32 tscrim]:
> > I don't understand why you have the function `cartier_fixed` in `CartierCode.__init__`. It is only called once and just has one return statement at the bottom.
> 
> To encapsulate the code in `cartier_fixed`. I didn't want the variables defined inside to affect the code outside. Moreover the code is natural for a general divisor `E`, but is applied to the specific divisor `G-D`.

If it is natural, then I would suggest separating it out as a separate function. As long as the variables you use have distinct names, there should be no difference inside a function than outside.

> > I don't think it is a good idea to assume the doctests will be run in order. (In fact, I think there is a ticket looking to run them in any order.) I wouldn't rely on a saved object. I would instead suggest having a pickle in the file (or a separate test file) as a string (or a pickle stored somewhere) that you can load.
> 
> But then the pickle is not updated, and hence the tests would be for old objects. Isn't it against the purpose of the testing?

It would use the current object (assuming it isn't pickled in some non-standard way) when it is reconstructed. I would have to double-check with the pickling protocols, but the pickle data should only need to be updated in limited circumstances.

> > Do you want `_Decoder_K` to be hidden from the documentation? Since it is a key component, it might be good to include it.
> 
> It is a key component. But the user does not need to interact with it. So the class name starts with an underline. It works in the background. The classes before it define the interface for the user. So I think it should be hidden.

I don't see why it needs to be hidden in the documentation. The documentation is also there for the maintainer as well as the user. Although if this is in a separate file, then you could have the "main" class documentation isolated from this.

> > Since `_Decoder_K` and `_Decoder_K_extension` and their subclasses seem like the key workhorses, would it make sense to include them as a separate Cython file and make them `cdef` classes?
> 
> Right they are the key workhorses. Maybe a good idea. Though I don't have much experiences with Cython files, I will try.

To Cythonize it, you just need to move your code into a `.pyx`. To make it a bit better, you add `cdef` before each class and create `.pxd` file (the `.pxd` is like a `.h` header file in C) with those class declarations. There should be a number of easily accessible examples for this; e.g., `groups/group.pxd`.

> > I am not sure about variable scope here:
> I will use the last version. Thanks. By the way, the second version is in the same vein with the function `cartier_fixed`.

The key difference is the `return` statement aborting the run part of the way through the loop that should set a variable.



---

archive/issue_comments_391501.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-20T01:57:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391501",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_391502.json:
```json
{
    "body": "Replying to [comment:34 tscrim]:\n> > To encapsulate the code in `cartier_fixed`. I didn't want the variables defined inside to affect the code outside. Moreover the code is natural for a general divisor `E`, but is applied to the specific divisor `G-D`.\n> \n> If it is natural, then I would suggest separating it out as a separate function. As long as the variables you use have distinct names, there should be no difference inside a function than outside.\n\nI inlined the code removing `cartier_fixed` encapsulation. I am okay with this, but it seems to me that the code lost a little bit of readibility.\n\n> > But then the pickle is not updated, and hence the tests would be for old objects. Isn't it against the purpose of the testing?\n> \n> It would use the current object (assuming it isn't pickled in some non-standard way) when it is reconstructed. I would have to double-check with the pickling protocols, but the pickle data should only need to be updated in limited circumstances.\n\nOkay. Done. \n \n> > It is a key component. But the user does not need to interact with it. So the class name starts with an underline. It works in the background. The classes before it define the interface for the user. So I think it should be hidden.\n> \n> I don't see why it needs to be hidden in the documentation. The documentation is also there for the maintainer as well as the user. Although if this is in a separate file, then you could have the \"main\" class documentation isolated from this.\n\nI still don't get your idea. If `_Decoder_K` is included in the documentation (by removing the leading underline), then the methods (`substitution`, `exponents`, ...) of the class will be exposed. Those methods happened to be there just for implementation efficiency, and never intended to be used by a user. I think implementation details should not be exposed in the documentation.\n\n> > Right they are the key workhorses. Maybe a good idea. Though I don't have much experiences with Cython files, I will try.\n> \n> To Cythonize it, you just need to move your code into a `.pyx`. To make it a bit better, you add `cdef` before each class and create `.pxd` file (the `.pxd` is like a `.h` header file in C) with those class declarations. There should be a number of easily accessible examples for this; e.g., `groups/group.pxd`.\n\nDone. I see 10% speed increase in doctesting by cythonization. Thanks.",
    "created_at": "2021-04-20T02:23:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391502",
    "user": "klee"
}
```

Replying to [comment:34 tscrim]:
> > To encapsulate the code in `cartier_fixed`. I didn't want the variables defined inside to affect the code outside. Moreover the code is natural for a general divisor `E`, but is applied to the specific divisor `G-D`.
> 
> If it is natural, then I would suggest separating it out as a separate function. As long as the variables you use have distinct names, there should be no difference inside a function than outside.

I inlined the code removing `cartier_fixed` encapsulation. I am okay with this, but it seems to me that the code lost a little bit of readibility.

> > But then the pickle is not updated, and hence the tests would be for old objects. Isn't it against the purpose of the testing?
> 
> It would use the current object (assuming it isn't pickled in some non-standard way) when it is reconstructed. I would have to double-check with the pickling protocols, but the pickle data should only need to be updated in limited circumstances.

Okay. Done. 
 
> > It is a key component. But the user does not need to interact with it. So the class name starts with an underline. It works in the background. The classes before it define the interface for the user. So I think it should be hidden.
> 
> I don't see why it needs to be hidden in the documentation. The documentation is also there for the maintainer as well as the user. Although if this is in a separate file, then you could have the "main" class documentation isolated from this.

I still don't get your idea. If `_Decoder_K` is included in the documentation (by removing the leading underline), then the methods (`substitution`, `exponents`, ...) of the class will be exposed. Those methods happened to be there just for implementation efficiency, and never intended to be used by a user. I think implementation details should not be exposed in the documentation.

> > Right they are the key workhorses. Maybe a good idea. Though I don't have much experiences with Cython files, I will try.
> 
> To Cythonize it, you just need to move your code into a `.pyx`. To make it a bit better, you add `cdef` before each class and create `.pxd` file (the `.pxd` is like a `.h` header file in C) with those class declarations. There should be a number of easily accessible examples for this; e.g., `groups/group.pxd`.

Done. I see 10% speed increase in doctesting by cythonization. Thanks.



---

archive/issue_comments_391503.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-20T08:28:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391503",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_391504.json:
```json
{
    "body": "So I have done a bit of refactoring to improve readability and to try and improve the speed. The biggest thing I did is increase the amount of things that know what type they are. I also refactored out some common code and did some improvements where I could. Without knowing more about what could be be taking time, I cannot suggest how to further improve the speed. Hopefully this has given things a noticeable speedup.\n\nHowever, one thing that does need to be addressed is the length of the doctests. For `# long time`, everything is fine. So one option is to mark a lot of the doctests that way. Would it be possible to include some smaller examples in order to increase the doctesting speed?\n\nWith regards to the documentation, it is not just there for users. It is also useful for developers/maintainers who will be looking at this code. While it is an implementation detail, it is a fairly macro detail. Including it just makes it less opaque for someone who is trying to figure out how things are working. Sage has many similar implementation detail classes included in its documentation (e.g., [polydict](https://doc.sagemath.org/html/en/reference/polynomial_rings/sage/rings/polynomial/polydict.html)).\n----\nedit - Forgot to squash my commits...",
    "created_at": "2021-04-21T02:49:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391504",
    "user": "tscrim"
}
```

So I have done a bit of refactoring to improve readability and to try and improve the speed. The biggest thing I did is increase the amount of things that know what type they are. I also refactored out some common code and did some improvements where I could. Without knowing more about what could be be taking time, I cannot suggest how to further improve the speed. Hopefully this has given things a noticeable speedup.

However, one thing that does need to be addressed is the length of the doctests. For `# long time`, everything is fine. So one option is to mark a lot of the doctests that way. Would it be possible to include some smaller examples in order to increase the doctesting speed?

With regards to the documentation, it is not just there for users. It is also useful for developers/maintainers who will be looking at this code. While it is an implementation detail, it is a fairly macro detail. Including it just makes it less opaque for someone who is trying to figure out how things are working. Sage has many similar implementation detail classes included in its documentation (e.g., [polydict](https://doc.sagemath.org/html/en/reference/polynomial_rings/sage/rings/polynomial/polydict.html)).
----
edit - Forgot to squash my commits...



---

archive/issue_comments_391505.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-04-21T02:49:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391505",
    "user": "tscrim"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_391506.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-04-21T02:50:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391506",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_391507.json:
```json
{
    "body": "As far as I understand, `Py_ssize_t` is the type for index variables. Is there a reason that you used that type for non-index variables?",
    "created_at": "2021-04-21T06:10:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391507",
    "user": "klee"
}
```

As far as I understand, `Py_ssize_t` is the type for index variables. Is there a reason that you used that type for non-index variables?



---

archive/issue_comments_391508.json:
```json
{
    "body": "It is like an `int` but it uses the compiler sized version. So it works for things that would be too big for an `int` on computers that can handle that at the CPU level. Granted, I doubt anyone will ever need that big, but it is better to support it IMO (and we have to worry less about what things should be an `int` and what shouldn't).",
    "created_at": "2021-04-21T06:22:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391508",
    "user": "tscrim"
}
```

It is like an `int` but it uses the compiler sized version. So it works for things that would be too big for an `int` on computers that can handle that at the CPU level. Granted, I doubt anyone will ever need that big, but it is better to support it IMO (and we have to worry less about what things should be an `int` and what shouldn't).



---

archive/issue_comments_391509.json:
```json
{
    "body": "Replying to [comment:41 tscrim]:\n> It is like an `int` but it uses the compiler sized version. So it works for things that would be too big for an `int` on computers that can handle that at the CPU level. Granted, I doubt anyone will ever need that big, but it is better to support it IMO (and we have to worry less about what things should be an `int` and what shouldn't).\n\nThen I would use `int` type since (much) readibility is lost by using unclearly-named type `Py_ssize_t` just for common integer variables that never would contain that big integers. \n\nMy general feeling for your changes is similar and such that readibility of the code is decreased while gaining speed improvement. A simple test showed that you gained another 10% speed improvement. \n\nI will try to recover readibility while not losing much of the speed improvement that you already gained.",
    "created_at": "2021-04-21T06:47:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391509",
    "user": "klee"
}
```

Replying to [comment:41 tscrim]:
> It is like an `int` but it uses the compiler sized version. So it works for things that would be too big for an `int` on computers that can handle that at the CPU level. Granted, I doubt anyone will ever need that big, but it is better to support it IMO (and we have to worry less about what things should be an `int` and what shouldn't).

Then I would use `int` type since (much) readibility is lost by using unclearly-named type `Py_ssize_t` just for common integer variables that never would contain that big integers. 

My general feeling for your changes is similar and such that readibility of the code is decreased while gaining speed improvement. A simple test showed that you gained another 10% speed improvement. 

I will try to recover readibility while not losing much of the speed improvement that you already gained.



---

archive/issue_comments_391510.json:
```json
{
    "body": "Replying to [comment:38 tscrim]:\n\n> However, one thing that does need to be addressed is the length of the doctests. For `# long time`, everything is fine. So one option is to mark a lot of the doctests that way. Would it be possible to include some smaller examples in order to increase the doctesting speed?\n\nThe examples are already smallest without being trivial. I would use `# long time`.\n\n> With regards to the documentation, it is not just there for users. It is also useful for developers/maintainers who will be looking at this code. While it is an implementation detail, it is a fairly macro detail. Including it just makes it less opaque for someone who is trying to figure out how things are working. Sage has many similar implementation detail classes included in its documentation (e.g., [polydict](https://doc.sagemath.org/html/en/reference/polynomial_rings/sage/rings/polynomial/polydict.html)).\n\n`PolyDict` is not a comparable example. `PolyDict` is a tool to be used by developers. `_Decoder_K` is not such one. Anyway, I think we can compromise. I can remove the leading underline so that the class (and `_Decoder_K_extension` as well) is included in the documentation, but instead would hide some methods that are not worth to be included in the documentation.",
    "created_at": "2021-04-21T07:04:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391510",
    "user": "klee"
}
```

Replying to [comment:38 tscrim]:

> However, one thing that does need to be addressed is the length of the doctests. For `# long time`, everything is fine. So one option is to mark a lot of the doctests that way. Would it be possible to include some smaller examples in order to increase the doctesting speed?

The examples are already smallest without being trivial. I would use `# long time`.

> With regards to the documentation, it is not just there for users. It is also useful for developers/maintainers who will be looking at this code. While it is an implementation detail, it is a fairly macro detail. Including it just makes it less opaque for someone who is trying to figure out how things are working. Sage has many similar implementation detail classes included in its documentation (e.g., [polydict](https://doc.sagemath.org/html/en/reference/polynomial_rings/sage/rings/polynomial/polydict.html)).

`PolyDict` is not a comparable example. `PolyDict` is a tool to be used by developers. `_Decoder_K` is not such one. Anyway, I think we can compromise. I can remove the leading underline so that the class (and `_Decoder_K_extension` as well) is included in the documentation, but instead would hide some methods that are not worth to be included in the documentation.



---

archive/issue_comments_391511.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-22T14:32:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391511",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_391512.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-04-22T14:35:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391512",
    "user": "klee"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_391513.json:
```json
{
    "body": "I restored the structure of the code close to the original while keeping the most of your speed improvements. A little bit of speed was lost, which I guess is due to converting inline functions to methods. I removed some castings which I think unnecessary, to improve readibility.",
    "created_at": "2021-04-22T14:49:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391513",
    "user": "klee"
}
```

I restored the structure of the code close to the original while keeping the most of your speed improvements. A little bit of speed was lost, which I guess is due to converting inline functions to methods. I removed some castings which I think unnecessary, to improve readibility.



---

archive/issue_comments_391514.json:
```json
{
    "body": "So I mostly agree. You can still make the methods inline IIRC. Yet, I don't think there isn't any reason to remove a casting as it decreases the readability of the code since now we don't know what type of object it should be. This also has an effect on speed because the C code becomes more complicated.\n\nThose decorators on the helper functions are also important for speed as they remove a number of safety checks that performed to prevent crashes that we are guaranteeing are not happening. They have no effect on readability IMO.\n\nAlso, these are useful because it simplifies how Cython translates it into C code:\n\n```\n-                    wlt = gamma * dlt + <Py_ssize_t> (dR[i])\n+                    wlt = gamma * dlt + dR[i]\n```\n\n(Ideally, I would want things like `dR` to be C arrays, but then we have to manually deal with pickling.)\n\nOne other thing that might be useful would be having the `degree` return an actual `int` object.\n\nIf you want to look at the compiled C code, you can find it at\n\n```\n$SAGE_ROOT/build/pkgs/sagelib/src/build/cythonized/sage/coding/ag_code_decoders.c\n```\n\nJust search for a line number of line of code in the pyx file (e.g., 1135 but not 1092 or 1124). You don't necessarily have to understand it, but you can get a feel of the complexity, which roughly corresponds to time needed.",
    "created_at": "2021-04-23T00:37:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391514",
    "user": "tscrim"
}
```

So I mostly agree. You can still make the methods inline IIRC. Yet, I don't think there isn't any reason to remove a casting as it decreases the readability of the code since now we don't know what type of object it should be. This also has an effect on speed because the C code becomes more complicated.

Those decorators on the helper functions are also important for speed as they remove a number of safety checks that performed to prevent crashes that we are guaranteeing are not happening. They have no effect on readability IMO.

Also, these are useful because it simplifies how Cython translates it into C code:

```
-                    wlt = gamma * dlt + <Py_ssize_t> (dR[i])
+                    wlt = gamma * dlt + dR[i]
```

(Ideally, I would want things like `dR` to be C arrays, but then we have to manually deal with pickling.)

One other thing that might be useful would be having the `degree` return an actual `int` object.

If you want to look at the compiled C code, you can find it at

```
$SAGE_ROOT/build/pkgs/sagelib/src/build/cythonized/sage/coding/ag_code_decoders.c
```

Just search for a line number of line of code in the pyx file (e.g., 1135 but not 1092 or 1124). You don't necessarily have to understand it, but you can get a feel of the complexity, which roughly corresponds to time needed.



---

archive/issue_comments_391515.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-23T01:06:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391515",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_391516.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-23T06:34:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391516",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_391517.json:
```json
{
    "body": "Replying to [comment:48 tscrim]:\n> So I mostly agree. You can still make the methods inline IIRC. \n\nI didn't know that. Thanks.\n\n> I don't think there is any reason to remove a casting as it decreases the readability of the code since now we don't know what type of object it should be. This also has an effect on speed because the C code becomes more complicated.\n\nI am thinking of the readability for someone who looks at the code to understand the algorithm. Castings in the middle of code does not help reading the code. I want to balance speed and readability. In particular I want to make the code look more like Python than C. \n\nBut I was careful not to remove necessary castings. I tested before I remove a casting to see the effect. I may have missed some, though I restored a few in the last commit. \n\n> Those decorators on the helper functions are also important for speed as they remove a number of safety checks that performed to prevent crashes that we are guaranteeing are not happening. They have no effect on readability IMO.\n\nI didn't know that. Restored. Thanks.\n\n> Also, these are useful because it simplifies how Cython translates it into C code:\n> {{{\n> -                    wlt = gamma * dlt + <Py_ssize_t> (dR[i])\n> +                    wlt = gamma * dlt + dR[i]\n> }}}\n\nOkay. Restored.\n> \n> One other thing that might be useful would be having the `degree` return an actual `int` object.\n\nDone.\n\n> If you want to look at the compiled C code, you can find it at\n> {{{\n> $SAGE_ROOT/build/pkgs/sagelib/src/build/cythonized/sage/coding/ag_code_decoders.c\n> }}}\n> Just search for a line number of line of code in the pyx file (e.g., 1135 but not 1092 or 1124). You don't necessarily have to understand it, but you can get a feel of the complexity, which roughly corresponds to time needed.\n\nThanks. I am testing with short examples with `%%cython --annotate`.\n----\nNew commits:",
    "created_at": "2021-04-23T06:34:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391517",
    "user": "klee"
}
```

Replying to [comment:48 tscrim]:
> So I mostly agree. You can still make the methods inline IIRC. 

I didn't know that. Thanks.

> I don't think there is any reason to remove a casting as it decreases the readability of the code since now we don't know what type of object it should be. This also has an effect on speed because the C code becomes more complicated.

I am thinking of the readability for someone who looks at the code to understand the algorithm. Castings in the middle of code does not help reading the code. I want to balance speed and readability. In particular I want to make the code look more like Python than C. 

But I was careful not to remove necessary castings. I tested before I remove a casting to see the effect. I may have missed some, though I restored a few in the last commit. 

> Those decorators on the helper functions are also important for speed as they remove a number of safety checks that performed to prevent crashes that we are guaranteeing are not happening. They have no effect on readability IMO.

I didn't know that. Restored. Thanks.

> Also, these are useful because it simplifies how Cython translates it into C code:
> {{{
> -                    wlt = gamma * dlt + <Py_ssize_t> (dR[i])
> +                    wlt = gamma * dlt + dR[i]
> }}}

Okay. Restored.
> 
> One other thing that might be useful would be having the `degree` return an actual `int` object.

Done.

> If you want to look at the compiled C code, you can find it at
> {{{
> $SAGE_ROOT/build/pkgs/sagelib/src/build/cythonized/sage/coding/ag_code_decoders.c
> }}}
> Just search for a line number of line of code in the pyx file (e.g., 1135 but not 1092 or 1124). You don't necessarily have to understand it, but you can get a feel of the complexity, which roughly corresponds to time needed.

Thanks. I am testing with short examples with `%%cython --annotate`.
----
New commits:



---

archive/issue_comments_391518.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-27T02:18:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391518",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_391519.json:
```json
{
    "body": "A profiling showed that the most time consuming part of the decoder is `_substitution` method. So I tried to optimize the code for speed in the last commit.\n\nAccording to simple tests, the performance of the decoder has improved after each revision after cythonization.",
    "created_at": "2021-04-27T02:26:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391519",
    "user": "klee"
}
```

A profiling showed that the most time consuming part of the decoder is `_substitution` method. So I tried to optimize the code for speed in the last commit.

According to simple tests, the performance of the decoder has improved after each revision after cythonization.



---

archive/issue_comments_391520.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-28T02:16:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391520",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_391521.json:
```json
{
    "body": "Thank you for the further changes and testing for the timing. I tried to really optimize the `_substitute` as much as I could by not creating as many transient objects by again modifying the input. Likewise, I just changes `gbmat` into `mat` as the list of (row) vectors is what you really wanted to manipulate.\n\nFrom looking at the C code, there was no different with the extra `<Polynomial>` casts in `_substitute()`. So I just removed them for readability.\n\nSome of the other changes I made in accordance with the change to `mat` might affect readability for trivial speed improvements; so feel free to revert.",
    "created_at": "2021-04-28T02:23:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391521",
    "user": "tscrim"
}
```

Thank you for the further changes and testing for the timing. I tried to really optimize the `_substitute` as much as I could by not creating as many transient objects by again modifying the input. Likewise, I just changes `gbmat` into `mat` as the list of (row) vectors is what you really wanted to manipulate.

From looking at the C code, there was no different with the extra `<Polynomial>` casts in `_substitute()`. So I just removed them for readability.

Some of the other changes I made in accordance with the change to `mat` might affect readability for trivial speed improvements; so feel free to revert.



---

archive/issue_comments_391522.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-28T02:56:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391522",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_391523.json:
```json
{
    "body": "Replying to [comment:55 tscrim]:\n> I tried to really optimize the `_substitute` as much as I could by not creating as many transient objects by again modifying the input. Likewise, I just changes `gbmat` into `mat` as the list of (row) vectors is what you really wanted to manipulate.\n\nThis is the timings for a simple test:\n\n    || pure python || rev1 || rev2 ||rev3 || rev4 || this revision ||\n    || 25.9ms || 25.1ms || 24.8ms || 24.5ms || 24.1ms ||15.9ms ||\n\nSo you achieved a lot with the last patch. Thank you!\n\n> From looking at the C code, there was no different with the extra `<Polynomial>` casts in `_substitute()`. So I just removed them for readability.\n\nOkay. I am getting intoxicated with what cythonization brings and caring readibility less :-)\n\nStill I removed, for instance, `<FreeModuleElement>` from\n\n```\ntemp = <FreeModuleElement> (<list> mul_mat[j])[i]\n```\n\nsince `temp` is already declared  as `<FreeModuleElement>` type before, and hence I think casting is unnecessary. I wonder if you would agree.",
    "created_at": "2021-04-28T04:05:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391523",
    "user": "klee"
}
```

Replying to [comment:55 tscrim]:
> I tried to really optimize the `_substitute` as much as I could by not creating as many transient objects by again modifying the input. Likewise, I just changes `gbmat` into `mat` as the list of (row) vectors is what you really wanted to manipulate.

This is the timings for a simple test:

    || pure python || rev1 || rev2 ||rev3 || rev4 || this revision ||
    || 25.9ms || 25.1ms || 24.8ms || 24.5ms || 24.1ms ||15.9ms ||

So you achieved a lot with the last patch. Thank you!

> From looking at the C code, there was no different with the extra `<Polynomial>` casts in `_substitute()`. So I just removed them for readability.

Okay. I am getting intoxicated with what cythonization brings and caring readibility less :-)

Still I removed, for instance, `<FreeModuleElement>` from

```
temp = <FreeModuleElement> (<list> mul_mat[j])[i]
```

since `temp` is already declared  as `<FreeModuleElement>` type before, and hence I think casting is unnecessary. I wonder if you would agree.



---

archive/issue_comments_391524.json:
```json
{
    "body": "When you do `<Foo> bar` in Cython, it doesn't explicitly do a cast, but it tells Cython that I (the programmer) guarantee that this object is an instance of `Foo`. So when used improperly, it can cause a crash. However, when you simply do `temp = bar`, Cython does a check of the type to make sure it is correct and errors out. While this check is fast, it can matter in a tighter loop. So in `_substitute()`, because it is the key part, I would suggest leaving it in. However, that is up to you.\n\nSomething else that might be done to optimize things is to have `message` be backwards in the `else` branch of the code to avoid doing `message.insert(0, foo)`. This is really bad as it has to move everything along in memory since it is stored as a C `vector` (which is basically an array). So just make these changes:\n\n```diff\n-message.insert(0, winner)\n+message.append(winner)\n```\n\n\n```diff\n-message.insert(0, value)\n+message.append(value)\n```\n\nand then add a `message.reverse()` at the end of the `else:` block.",
    "created_at": "2021-04-28T04:29:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391524",
    "user": "tscrim"
}
```

When you do `<Foo> bar` in Cython, it doesn't explicitly do a cast, but it tells Cython that I (the programmer) guarantee that this object is an instance of `Foo`. So when used improperly, it can cause a crash. However, when you simply do `temp = bar`, Cython does a check of the type to make sure it is correct and errors out. While this check is fast, it can matter in a tighter loop. So in `_substitute()`, because it is the key part, I would suggest leaving it in. However, that is up to you.

Something else that might be done to optimize things is to have `message` be backwards in the `else` branch of the code to avoid doing `message.insert(0, foo)`. This is really bad as it has to move everything along in memory since it is stored as a C `vector` (which is basically an array). So just make these changes:

```diff
-message.insert(0, winner)
+message.append(winner)
```


```diff
-message.insert(0, value)
+message.append(value)
```

and then add a `message.reverse()` at the end of the `else:` block.



---

archive/issue_comments_391525.json:
```json
{
    "body": "Replying to [comment:58 tscrim]:\n> When you do `<Foo> bar` in Cython, it doesn't explicitly do a cast, but it tells Cython that I (the programmer) guarantee that this object is an instance of `Foo`. So when used improperly, it can cause a crash. However, when you simply do `temp = bar`, Cython does a check of the type to make sure it is correct and errors out. While this check is fast, it can matter in a tighter loop. So in `_substitute()`, because it is the key part, I would suggest leaving it in. \n\nI see. Perhaps I misunderstood it when I experimented with a primitive type like `<int>`, rather than an extension type.\n\nI would put them back then.\n\n> Something else that might be done to optimize things is to have `message` be backwards in the `else` branch of the code to avoid doing `message.insert(0, foo)`. This is really bad as it has to move everything along in memory since it is stored as a C `vector` (which is basically an array). So just make these changes:\n> {{{#!diff\n> -message.insert(0, winner)\n> +message.append(winner)\n> }}}\n> {{{#!diff\n> -message.insert(0, value)\n> +message.append(value)\n> }}}\n> and then add a `message.reverse()` at the end of the `else:` block.\n\nOkay. I will do it.",
    "created_at": "2021-04-28T04:58:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391525",
    "user": "klee"
}
```

Replying to [comment:58 tscrim]:
> When you do `<Foo> bar` in Cython, it doesn't explicitly do a cast, but it tells Cython that I (the programmer) guarantee that this object is an instance of `Foo`. So when used improperly, it can cause a crash. However, when you simply do `temp = bar`, Cython does a check of the type to make sure it is correct and errors out. While this check is fast, it can matter in a tighter loop. So in `_substitute()`, because it is the key part, I would suggest leaving it in. 

I see. Perhaps I misunderstood it when I experimented with a primitive type like `<int>`, rather than an extension type.

I would put them back then.

> Something else that might be done to optimize things is to have `message` be backwards in the `else` branch of the code to avoid doing `message.insert(0, foo)`. This is really bad as it has to move everything along in memory since it is stored as a C `vector` (which is basically an array). So just make these changes:
> {{{#!diff
> -message.insert(0, winner)
> +message.append(winner)
> }}}
> {{{#!diff
> -message.insert(0, value)
> +message.append(value)
> }}}
> and then add a `message.reverse()` at the end of the `else:` block.

Okay. I will do it.



---

archive/issue_comments_391526.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-28T07:12:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391526",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_391527.json:
```json
{
    "body": "The new timing is \n",
    "created_at": "2021-04-28T07:14:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391527",
    "user": "klee"
}
```

The new timing is 




---

archive/issue_comments_391528.json:
```json
{
    "body": "Is there anything else to do?",
    "created_at": "2021-04-29T05:50:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391528",
    "user": "klee"
}
```

Is there anything else to do?



---

archive/issue_comments_391529.json:
```json
{
    "body": "I think it is good. Although I am just a little nervous about the pickling solution. I think it is a good solution, but I am not entirely sure. I think we should ask on sage-devel about it.",
    "created_at": "2021-04-29T14:02:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391529",
    "user": "tscrim"
}
```

I think it is good. Although I am just a little nervous about the pickling solution. I think it is a good solution, but I am not entirely sure. I think we should ask on sage-devel about it.



---

archive/issue_comments_391530.json:
```json
{
    "body": "Replying to [comment:63 tscrim]:\n> I think it is good. Although I am just a little nervous about the pickling solution. I think it is a good solution, but I am not entirely sure. I think we should ask on sage-devel about it.\n\nAs far as I understand, an object is constructed from the pickled data and uses the current code. I think it is possible in principle that a change in a different part of Sage may affect the constructor of the object and hence a newly constructed object may behave differently from an unpickled object. However, in our case, the decoder's data is all of basic types such as finite field elements, polynomials, matrices , vectors, etc. Hence it is unlikely that the data of a newly constructed object is different from an unpickled data. Moreover even if it happens, it would be detected everywhere in Sage.\n\nDo you still want to discuss this matter in sage-devel?",
    "created_at": "2021-04-30T00:53:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391530",
    "user": "klee"
}
```

Replying to [comment:63 tscrim]:
> I think it is good. Although I am just a little nervous about the pickling solution. I think it is a good solution, but I am not entirely sure. I think we should ask on sage-devel about it.

As far as I understand, an object is constructed from the pickled data and uses the current code. I think it is possible in principle that a change in a different part of Sage may affect the constructor of the object and hence a newly constructed object may behave differently from an unpickled object. However, in our case, the decoder's data is all of basic types such as finite field elements, polynomials, matrices , vectors, etc. Hence it is unlikely that the data of a newly constructed object is different from an unpickled data. Moreover even if it happens, it would be detected everywhere in Sage.

Do you still want to discuss this matter in sage-devel?



---

archive/issue_comments_391531.json:
```json
{
    "body": "I think we should because what if the pickles get replaced that has something evil included (say, some extra method that is monkey-patched into `__init__` that deletes everything on the system). We also haven't done anything like this in Sage (at least since we removed the pickle jar). So I just want to be a bit cautious here before proceeding.",
    "created_at": "2021-04-30T06:14:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391531",
    "user": "tscrim"
}
```

I think we should because what if the pickles get replaced that has something evil included (say, some extra method that is monkey-patched into `__init__` that deletes everything on the system). We also haven't done anything like this in Sage (at least since we removed the pickle jar). So I just want to be a bit cautious here before proceeding.



---

archive/issue_comments_391532.json:
```json
{
    "body": "Replying to [comment:65 tscrim]:\n> I think we should \n\nOkay.\n\n> what if the pickles get replaced that has something evil included. \n\nThe pickles would be part of the Sage lib. Why pickles are more vulnerable than other code? Do you imagine that some evil author and reviewer cooperate to slip in the evil code passing the release manager's eyes? \n\n> say, some extra method that is monkey-patched into `__init__` that deletes everything on the system\n\nIs this possible with a pickle? As far as I know, a pickle does not contain code.\n\n> We also haven't done anything like this in Sage (at least since we removed the pickle jar). So I just want to be a bit cautious here before proceeding.\n\nI agree. I also wondered if there should be a central place to hold the pickles for this doctesting purpose. Note that I added `.../coding/tests` directory for this purpose.",
    "created_at": "2021-04-30T07:27:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391532",
    "user": "klee"
}
```

Replying to [comment:65 tscrim]:
> I think we should 

Okay.

> what if the pickles get replaced that has something evil included. 

The pickles would be part of the Sage lib. Why pickles are more vulnerable than other code? Do you imagine that some evil author and reviewer cooperate to slip in the evil code passing the release manager's eyes? 

> say, some extra method that is monkey-patched into `__init__` that deletes everything on the system

Is this possible with a pickle? As far as I know, a pickle does not contain code.

> We also haven't done anything like this in Sage (at least since we removed the pickle jar). So I just want to be a bit cautious here before proceeding.

I agree. I also wondered if there should be a central place to hold the pickles for this doctesting purpose. Note that I added `.../coding/tests` directory for this purpose.



---

archive/issue_comments_391533.json:
```json
{
    "body": "Replying to [comment:66 klee]:\n> Replying to [comment:65 tscrim]:\n> > I think we should \n> \n> Okay.\n> \n> > what if the pickles get replaced that has something evil included. \n> \n> The pickles would be part of the Sage lib. Why pickles are more vulnerable than other code? Do you imagine that some evil author and reviewer cooperate to slip in the evil code passing the release manager's eyes? \n\nYou end up reading a file on the system and (blindly) executing it in the doctest.\n\n> > say, some extra method that is monkey-patched into `__init__` that deletes everything on the system\n> \n> Is this possible with a pickle? As far as I know, a pickle does not contain code.\n\nA pickle can (and IIRC usually) contain an objects `__dict__`, which can contain functions that can be bound to the object I believe. I am not really an expert on this, so it is possible I am just being paranoid (or there are other more likely security breaches to occur).\n\n> > We also haven't done anything like this in Sage (at least since we removed the pickle jar). So I just want to be a bit cautious here before proceeding.\n> \n> I agree. I also wondered if there should be a central place to hold the pickles for this doctesting purpose. Note that I added `.../coding/tests` directory for this purpose.\n\nI saw that and thought that was good. The only place that was natural to me is in the `$SAGE_SRC/tests` folder (possibly as a `coding` subfolder).",
    "created_at": "2021-04-30T07:38:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391533",
    "user": "tscrim"
}
```

Replying to [comment:66 klee]:
> Replying to [comment:65 tscrim]:
> > I think we should 
> 
> Okay.
> 
> > what if the pickles get replaced that has something evil included. 
> 
> The pickles would be part of the Sage lib. Why pickles are more vulnerable than other code? Do you imagine that some evil author and reviewer cooperate to slip in the evil code passing the release manager's eyes? 

You end up reading a file on the system and (blindly) executing it in the doctest.

> > say, some extra method that is monkey-patched into `__init__` that deletes everything on the system
> 
> Is this possible with a pickle? As far as I know, a pickle does not contain code.

A pickle can (and IIRC usually) contain an objects `__dict__`, which can contain functions that can be bound to the object I believe. I am not really an expert on this, so it is possible I am just being paranoid (or there are other more likely security breaches to occur).

> > We also haven't done anything like this in Sage (at least since we removed the pickle jar). So I just want to be a bit cautious here before proceeding.
> 
> I agree. I also wondered if there should be a central place to hold the pickles for this doctesting purpose. Note that I added `.../coding/tests` directory for this purpose.

I saw that and thought that was good. The only place that was natural to me is in the `$SAGE_SRC/tests` folder (possibly as a `coding` subfolder).



---

archive/issue_comments_391534.json:
```json
{
    "body": "too many colons here:\n\n```\n+    TESTS::\n+\n+    We save the decoder for later tests::\n```\n",
    "created_at": "2021-04-30T12:57:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391534",
    "user": "chapoton"
}
```

too many colons here:

```
+    TESTS::
+
+    We save the decoder for later tests::
```




---

archive/issue_comments_391535.json:
```json
{
    "body": "I guess Apery should be \"Ap\u00e9ry\"",
    "created_at": "2021-04-30T12:58:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391535",
    "user": "chapoton"
}
```

I guess Apery should be "Apéry"



---

archive/issue_comments_391536.json:
```json
{
    "body": "Can these pickles be replaced by text data? I really struggle to imagine a smallish Sage object that cannot be quickly built from text data or json.",
    "created_at": "2021-04-30T13:43:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391536",
    "user": "dimpase"
}
```

Can these pickles be replaced by text data? I really struggle to imagine a smallish Sage object that cannot be quickly built from text data or json.



---

archive/issue_comments_391537.json:
```json
{
    "body": "in any event, code to build these .sobj or otherwise pickled objects should be easy to run (I don't know how to run tests which are tagged `# not tested`).",
    "created_at": "2021-05-01T09:40:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391537",
    "user": "dimpase"
}
```

in any event, code to build these .sobj or otherwise pickled objects should be easy to run (I don't know how to run tests which are tagged `# not tested`).



---

archive/issue_comments_391538.json:
```json
{
    "body": "Replying to [comment:71 dimpase]:\n> in any event, code to build these .sobj or otherwise pickled objects should be easy to run (I don't know how to run tests which are tagged `# not tested`).\n\nObviously you run the code in the example just above the test tagged with `# not tested` to construct the object to save.\n\nDo I misunderstand you?",
    "created_at": "2021-05-01T11:26:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391538",
    "user": "klee"
}
```

Replying to [comment:71 dimpase]:
> in any event, code to build these .sobj or otherwise pickled objects should be easy to run (I don't know how to run tests which are tagged `# not tested`).

Obviously you run the code in the example just above the test tagged with `# not tested` to construct the object to save.

Do I misunderstand you?



---

archive/issue_comments_391539.json:
```json
{
    "body": "Replying to [comment:70 dimpase]:\n> Can these pickles be replaced by text data? I really struggle to imagine a smallish Sage object that cannot be quickly built from text data or json.\n\nIt takes no time, relatively, to load and save the pickles. To construct an object(in our case, decoder) to save takes time.\n\nDo you mean that dumping an object to a string and saving the string somewhere is better than a pickle in binary format? Would you explain how and in what respect it is better?",
    "created_at": "2021-05-01T11:36:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391539",
    "user": "klee"
}
```

Replying to [comment:70 dimpase]:
> Can these pickles be replaced by text data? I really struggle to imagine a smallish Sage object that cannot be quickly built from text data or json.

It takes no time, relatively, to load and save the pickles. To construct an object(in our case, decoder) to save takes time.

Do you mean that dumping an object to a string and saving the string somewhere is better than a pickle in binary format? Would you explain how and in what respect it is better?



---

archive/issue_comments_391540.json:
```json
{
    "body": "Replying to [comment:69 chapoton]:\n> I guess Apery should be \"Ap\u00e9ry\"\n\nRight. I didn't try to input an accented character on my keyboard. I will.",
    "created_at": "2021-05-01T11:40:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391540",
    "user": "klee"
}
```

Replying to [comment:69 chapoton]:
> I guess Apery should be "Apéry"

Right. I didn't try to input an accented character on my keyboard. I will.



---

archive/issue_comments_391541.json:
```json
{
    "body": "json is recommended. I have no experience with serializing objects in json. Is it practically doable with any Sage object?",
    "created_at": "2021-05-01T12:12:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391541",
    "user": "klee"
}
```

json is recommended. I have no experience with serializing objects in json. Is it practically doable with any Sage object?



---

archive/issue_comments_391542.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-05-03T07:32:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391542",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_391543.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-05-04T05:11:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391543",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_391544.json:
```json
{
    "body": "As a few people expressed concerns using pickles for doctesting and there is no alternative practical way to store sage objects, I decided to abandon saved objects for speed up doctesting. \n\nNow most doctests are tagged `# long time` except the class level examples.",
    "created_at": "2021-05-04T05:15:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391544",
    "user": "klee"
}
```

As a few people expressed concerns using pickles for doctesting and there is no alternative practical way to store sage objects, I decided to abandon saved objects for speed up doctesting. 

Now most doctests are tagged `# long time` except the class level examples.



---

archive/issue_comments_391545.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-05-05T05:24:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391545",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_391546.json:
```json
{
    "body": "I feel it is better to mark any long test as long rather than separate out the class-level tests. This also led to a test that took 8s to run on my machine not marked as long. I also removed the long marked things that weren't needed for me as per `--warn-long`.\n\nSomething that we could consider doing is having a hidden ``@`cached_function` that just creates all of the necessary objects and returns them as a tuple. Since testing in Sage does not reset the session after each block, the result is cached as we only need to pay the penalty once when running the file. We would only use this in the hidden attributes; especially for the ones that have trivial output such as `_latex_`. Although perhaps there is a more trivial example that could be done for those?",
    "created_at": "2021-05-05T05:29:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391546",
    "user": "tscrim"
}
```

I feel it is better to mark any long test as long rather than separate out the class-level tests. This also led to a test that took 8s to run on my machine not marked as long. I also removed the long marked things that weren't needed for me as per `--warn-long`.

Something that we could consider doing is having a hidden ``@`cached_function` that just creates all of the necessary objects and returns them as a tuple. Since testing in Sage does not reset the session after each block, the result is cached as we only need to pay the penalty once when running the file. We would only use this in the hidden attributes; especially for the ones that have trivial output such as `_latex_`. Although perhaps there is a more trivial example that could be done for those?



---

archive/issue_comments_391547.json:
```json
{
    "body": "Replying to [comment:80 tscrim]:\n> I feel it is better to mark any long test as long rather than separate out the class-level tests. This also led to a test that took 8s to run on my machine not marked as long. I also removed the long marked things that weren't needed for me as per `--warn-long`.\n\nOkay.\n\n> Something that we could consider doing is having a hidden ``@`cached_function` that just creates all of the necessary objects and returns them as a tuple. Since testing in Sage does not reset the session after each block, the result is cached as we only need to pay the penalty once when running the file. We would only use this in the hidden attributes; especially for the ones that have trivial output such as `_latex_`. Although perhaps there is a more trivial example that could be done for those?\n\nThis sounds not much different from what I did originally. Moreover I don't want to clutter the code only for testing things. I think we did enough for this ticket regarding doctesting.",
    "created_at": "2021-05-05T06:09:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391547",
    "user": "klee"
}
```

Replying to [comment:80 tscrim]:
> I feel it is better to mark any long test as long rather than separate out the class-level tests. This also led to a test that took 8s to run on my machine not marked as long. I also removed the long marked things that weren't needed for me as per `--warn-long`.

Okay.

> Something that we could consider doing is having a hidden ``@`cached_function` that just creates all of the necessary objects and returns them as a tuple. Since testing in Sage does not reset the session after each block, the result is cached as we only need to pay the penalty once when running the file. We would only use this in the hidden attributes; especially for the ones that have trivial output such as `_latex_`. Although perhaps there is a more trivial example that could be done for those?

This sounds not much different from what I did originally. Moreover I don't want to clutter the code only for testing things. I think we did enough for this ticket regarding doctesting.



---

archive/issue_comments_391548.json:
```json
{
    "body": "Replying to [comment:81 klee]:\n> Replying to [comment:80 tscrim]:\n> > Something that we could consider doing is having a hidden ``@`cached_function` that just creates all of the necessary objects and returns them as a tuple. Since testing in Sage does not reset the session after each block, the result is cached as we only need to pay the penalty once when running the file. We would only use this in the hidden attributes; especially for the ones that have trivial output such as `_latex_`. Although perhaps there is a more trivial example that could be done for those?\n> \n> This sounds not much different from what I did originally. Moreover I don't want to clutter the code only for testing things. I think we did enough for this ticket regarding doctesting.\n\nThe difference would be that it is created as part of the Sage session that is easily modified. However, I agree that the current state is sufficient (despite lacking a good solution). So we can set this to a positive review once the patchbot comes back green.",
    "created_at": "2021-05-05T06:21:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391548",
    "user": "tscrim"
}
```

Replying to [comment:81 klee]:
> Replying to [comment:80 tscrim]:
> > Something that we could consider doing is having a hidden ``@`cached_function` that just creates all of the necessary objects and returns them as a tuple. Since testing in Sage does not reset the session after each block, the result is cached as we only need to pay the penalty once when running the file. We would only use this in the hidden attributes; especially for the ones that have trivial output such as `_latex_`. Although perhaps there is a more trivial example that could be done for those?
> 
> This sounds not much different from what I did originally. Moreover I don't want to clutter the code only for testing things. I think we did enough for this ticket regarding doctesting.

The difference would be that it is created as part of the Sage session that is easily modified. However, I agree that the current state is sufficient (despite lacking a good solution). So we can set this to a positive review once the patchbot comes back green.



---

archive/issue_comments_391549.json:
```json
{
    "body": "Replying to [comment:82 tscrim]:\n> The difference would be that it is created as part of the Sage session that is easily modified. \n\nI now see your point. It is a clever idea. \n\n> However, I agree that the current state is sufficient (despite lacking a good solution). \n\nI do too.\n\n> So we can set this to a positive review once the patchbot comes back green.\n\nOkay. Thank you.",
    "created_at": "2021-05-05T12:45:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391549",
    "user": "klee"
}
```

Replying to [comment:82 tscrim]:
> The difference would be that it is created as part of the Sage session that is easily modified. 

I now see your point. It is a clever idea. 

> However, I agree that the current state is sufficient (despite lacking a good solution). 

I do too.

> So we can set this to a positive review once the patchbot comes back green.

Okay. Thank you.



---

archive/issue_comments_391550.json:
```json
{
    "body": "Replying to [comment:83 klee]:\n> Replying to [comment:82 tscrim]:\n> > The difference would be that it is created as part of the Sage session that is easily modified. \n> I now see your point. It is a clever idea. \n> > However, I agree that the current state is sufficient (despite lacking a good solution). \n> I do too.\n> > So we can set this to a positive review once the patchbot comes back green.\n> Okay. Thank you.\n\nGreen bot. I am guessing you don't want to switch, correct?",
    "created_at": "2021-05-06T04:05:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391550",
    "user": "tscrim"
}
```

Replying to [comment:83 klee]:
> Replying to [comment:82 tscrim]:
> > The difference would be that it is created as part of the Sage session that is easily modified. 
> I now see your point. It is a clever idea. 
> > However, I agree that the current state is sufficient (despite lacking a good solution). 
> I do too.
> > So we can set this to a positive review once the patchbot comes back green.
> Okay. Thank you.

Green bot. I am guessing you don't want to switch, correct?



---

archive/issue_comments_391551.json:
```json
{
    "body": "Replying to [comment:84 tscrim]:\n> Replying to [comment:83 klee]:\n> > Replying to [comment:82 tscrim]:\n> > > The difference would be that it is created as part of the Sage session that is easily modified. \n> > I now see your point. It is a clever idea. \n> > > However, I agree that the current state is sufficient (despite lacking a good solution). \n> > I do too.\n> > > So we can set this to a positive review once the patchbot comes back green.\n> > Okay. Thank you.\n> \n> Green bot. I am guessing you don't want to switch, correct?\n\nCorrect. No.",
    "created_at": "2021-05-06T05:09:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391551",
    "user": "klee"
}
```

Replying to [comment:84 tscrim]:
> Replying to [comment:83 klee]:
> > Replying to [comment:82 tscrim]:
> > > The difference would be that it is created as part of the Sage session that is easily modified. 
> > I now see your point. It is a clever idea. 
> > > However, I agree that the current state is sufficient (despite lacking a good solution). 
> > I do too.
> > > So we can set this to a positive review once the patchbot comes back green.
> > Okay. Thank you.
> 
> Green bot. I am guessing you don't want to switch, correct?

Correct. No.



---

archive/issue_comments_391552.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-05-06T05:15:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391552",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_391553.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-05-27T20:30:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27720",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27720#issuecomment-391553",
    "user": "vbraun"
}
```

Resolution: fixed
