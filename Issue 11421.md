# Issue 11421: `quo_rem` for divisor of leading unit coefficient

Issue created by migration from https://trac.sagemath.org/ticket/11593

Original creator: klee

Original creation time: 2011-07-13 09:14:08

Assignee: AlexGhitza

`quo_rem` does not work for divisors of unit leading coefficients, though the quotient and the remainder are defined mathematically. 

```
sage: R.<y> = QQ[x][]
sage: f = R.random_element(200)
sage: g = y^100+R.random_element(99)
sage: q, r = f.quo_rem(g)
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
...
AttributeError: 'sage.rings.polynomial.polynomial_element.Polynomial_generic_dense' object has no attribute 'quo_rem'
```




---

Comment by klee created at 2011-07-13 09:21:13

Changing status from new to needs_review.


---

Comment by klee created at 2011-07-13 09:26:13

The patch allows one to compute the quotient and the remainder for divisors of unit leading coefficient. The `quo_rem` added to `Polynomial_generic_dense` is slightly faster than `quo_rem` defined in `Polynomial_generic_field`.


---

Comment by cremona created at 2011-12-16 20:49:19

Changing status from needs_review to needs_info.


---

Comment by cremona created at 2011-12-16 20:49:19

In the  case where self is 0 should it not be self, other returned?  Not self, self?


---

Comment by klee created at 2011-12-18 02:23:35

The quotient and the remainder of 0(=self) divided by other is 0 and 0. So self, self is correct.

By the way, I did not care for this patch for a while. It needs to be rebased for the current Sage beta. I can't do it right away. I would appreciate if you do it.


---

Comment by cremona created at 2011-12-18 09:27:25

Changing status from needs_info to needs_review.


---

Comment by cremona created at 2011-12-18 09:27:25

Replying to [comment:5 klee]:
> The quotient and the remainder of 0(=self) divided by other is 0 and 0. So self, self is correct.

OK, I was being stupid.

> 
> By the way, I did not care for this patch for a while. It needs to be rebased for the current Sage beta. I can't do it right away. I would appreciate if you do it.   

Well, I have many other things to do -- especially as at present I am running Sage Days 35.


---

Comment by klee created at 2011-12-18 11:02:18

Replying to [comment:6 cremona]:
  
> Well, I have many other things to do -- especially as at present I am running Sage Days 35.

Sorry for the suggestion. You are now the busiest man in the Sage community. :-) Good wish for Sage Days 35.


---

Comment by klee created at 2012-01-14 01:07:09

I see no doctest failures on my own Ubuntu 11.10 and Mac. I don't know what to do with the patchbot results.


---

Comment by klee created at 2012-01-20 01:49:30

Removing spaces does not help. :-(


---

Comment by aapitzsch created at 2012-02-09 21:28:26

Looking forward to Python3,
use the "new" syntax to raise errors, i.e.

```
raise ZeroDivisionError("division by zero polynomial")
```



---

Comment by klee created at 2012-02-13 00:07:34

Replying to [comment:10 aapitzsch]:
> Looking forward to Python3,
> use the "new" syntax to raise errors, i.e.
> {{{
> raise ZeroDivisionError("division by zero polynomial")
> }}}

Done.


---

Comment by davidloeffler created at 2012-03-17 13:14:01

Changing status from needs_review to needs_work.


---

Comment by davidloeffler created at 2012-03-17 13:14:01

According to the patchbot, some doctests are fail with this patch on the current beta (5.0.beta8):

```
sage -t  -force_lib devel/sage-11593/sage/rings/function_field/function_field_element.pyx
**********************************************************************
File "/storage/masiao/sage-5.0.beta8-patchbot/devel/sage-11593/sage/rings/function_field/function_field_element.pyx", line 423:
    sage: a = ~(2*y + 1/x); a                           # indirect doctest
Expected:
    (-x^2/(8*x^5 + x^2 + 1/2))*y + (2*x^3 + x)/(16*x^5 + 2*x^2 + 1)
Got:
    (-1/2*x^2/(4*x^5 + 1/2*x^2 + 1/4))*y + (1/2*x^3 + 1/4*x)/(4*x^5 + 1/2*x^2 + 1/4)
**********************************************************************
File "/storage/masiao/sage-5.0.beta8-patchbot/devel/sage-11593/sage/rings/function_field/function_field_element.pyx", line 443:
    sage: a = ~(2*y + 1/x); a
Expected:
    (-x^2/(8*x^5 + x^2 + 1/2))*y + (2*x^3 + x)/(16*x^5 + 2*x^2 + 1)
Got:
    (-1/2*x^2/(4*x^5 + 1/2*x^2 + 1/4))*y + (1/2*x^3 + 1/4*x)/(4*x^5 + 1/2*x^2 + 1/4)
**********************************************************************
File "/storage/masiao/sage-5.0.beta8-patchbot/devel/sage-11593/sage/rings/function_field/function_field_element.pyx", line 445:
    sage: a.list()
Expected:
    [(2*x^3 + x)/(16*x^5 + 2*x^2 + 1), -x^2/(8*x^5 + x^2 + 1/2)]
Got:
    [(1/2*x^3 + 1/4*x)/(4*x^5 + 1/2*x^2 + 1/4), -1/2*x^2/(4*x^5 + 1/2*x^2 + 1/4)]
**********************************************************************
```



---

Comment by klee created at 2012-07-11 07:32:20

Changing status from needs_work to needs_review.


---

Comment by klee created at 2012-07-11 07:32:20

The new code also speeds up things. See below

Before the patch,

```
sage: sage: S.<x>=QQ[]
sage: sage: fS=FractionField(S)
sage: sage: R.<y>=fS[]
sage: sage: f=y^20
sage: sage: g=y^5+1/x*y^4
sage: sage: timeit("f.quo_rem(g)") 
125 loops, best of 3: 3.25 ms per loop
```

After the patch,

```
sage: sage: S.<x>=QQ[]
sage: sage: fS=FractionField(S)
sage: sage: R.<y>=fS[]
sage: sage: f=y^20
sage: sage: g=y^5+1/x*y^4
sage: sage: timeit("f.quo_rem(g)") 
125 loops, best of 3: 1.75 ms per loop
```



---

Comment by klee created at 2012-07-11 07:35:32

Fixed the doctest failure issues.


---

Comment by chapoton created at 2012-09-27 13:06:42

Maybe one could consider adding documentation for the procedure cdef _inplace_truncate ? 

You are changing something inside this procedure, so the correct behaviour should be tested.


---

Comment by klee created at 2012-09-28 00:58:34

Replying to [comment:15 chapoton]:
> Maybe one could consider adding documentation for the procedure cdef _inplace_truncate ? 
> 
> You are changing something inside this procedure, so the correct behaviour should be tested.

I corrected a bug in _inplace_truncate, which is of only internal use, unlike the truncate method defined just above it. It's correct behaviour is indirectly checked by other methods that use it in various places.
 
On the other hand, the procedure is quite self-explanatory by its name and the short code, and I doubt the value of a documentation for it.


---

Comment by chapoton created at 2012-09-28 07:32:09

Well, I understand. But it would have been one little step towards the official goal of 100% doctesting. The question is not so much the value of the documentation, that its mere existence, even if it is not very useful..


---

Comment by klee created at 2012-10-05 14:00:09

Replying to [comment:17 chapoton]:
> Well, I understand. But it would have been one little step towards the official goal of 100% doctesting. The question is not so much the value of the documentation, that its mere existence, even if it is not very useful..

I found out that as `_inplace_truncate` is only a `cdef` method, that is not even counted for the doctest coverage. See the result of


```
sage -coverage sage/rings/polynomial/polynomial_element.pyx 
```



---

Comment by chapoton created at 2012-10-26 14:06:01

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2012-10-26 14:06:01

ok for me, positive review


---

Comment by jdemeyer created at 2012-11-01 12:01:02

Resolution: fixed


---

Comment by jdemeyer created at 2012-11-05 07:52:33

sage-5.5.beta0 + #11593 gives

```
sage -t --long "devel/sage/sage/schemes/elliptic_curves/ell_number_field.py"
The doctested process was killed by signal 11
         [166.4 s]
```

on OS X 10.4 PPC (not on other systems as far as I know).

I think the real issue is with #715+#11521, not this ticket.


---

Comment by jdemeyer created at 2012-11-05 07:55:35

Besides, why `TypeError` when dividing by a non-unit?  It seems to me that `TypeError` is not the right exception for this, I believe `ArithmeticError` suits better.


---

Comment by jdemeyer created at 2012-11-05 07:56:33

Resolution changed from fixed to 


---

Comment by jdemeyer created at 2012-11-05 07:56:33

Changing status from closed to new.


---

Comment by jdemeyer created at 2012-11-05 07:56:33

And exceptions should be doctested too.


---

Comment by jdemeyer created at 2012-11-05 07:56:45

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2012-11-05 07:56:57

Changing keywords from "" to "fix and doctest exceptions".


---

Comment by jdemeyer created at 2012-11-05 07:56:57

Changing status from needs_review to needs_work.


---

Comment by klee created at 2012-11-05 08:10:12

Replying to [comment:23 jdemeyer]:
> Besides, why `TypeError` when dividing by a non-unit?  It seems to me that `TypeError` is not the right exception for this, I believe `ArithmeticError` suits better.

`TypeError` was my inevitable choice to avoid triggering doctest failures in other parts of Sage, which depend on `TypeError` exception for normal operation. I need to remind myself of the details how and where that happens.


---

Comment by klee created at 2012-11-05 09:16:04

The new patch raises `ArithmeticError` for nonunit divisor


---

Comment by klee created at 2012-11-05 15:55:39

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2012-11-07 10:49:08

maybe the second and third tests at the beginning should rather be swapped ? What do we expect when we divide 0 by something which does not have an invertible leading coefficient ?


---

Comment by klee created at 2012-11-07 14:07:34

Replying to [comment:30 chapoton]:
> maybe the second and third tests at the beginning should rather be swapped ? What do we expect when we divide 0 by something which does not have an invertible leading coefficient ?

Good point! The tests are swapped in a new patch.


---

Comment by chapoton created at 2012-11-08 21:04:39

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2012-11-08 21:04:39

well, let me give again a positive review. Maybe the long-test problem is still there, but it does not appear on 5.4rc3.


---

Comment by jdemeyer created at 2012-12-17 12:57:54

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2012-12-17 12:57:54

With #8992, I get

```
**********************************************************************
File "/release/merger/sage-5.6.beta0/devel/sage-main/sage/rings/polynomial/polynomial_quotient_ring.py", line 407:
    sage: Q3(Q1.gen())
Exception raised:
    Traceback (most recent call last):
      File "/release/merger/sage-5.6.beta0/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/release/merger/sage-5.6.beta0/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/release/merger/sage-5.6.beta0/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_5[28]>", line 1, in <module>
        Q3(Q1.gen())###line 407:
    sage: Q3(Q1.gen())
      File "parent.pyx", line 800, in sage.structure.parent.Parent.__call__ (sage/structure/parent.c:7268)
      File "parent.pyx", line 2153, in sage.structure.parent.Parent.convert_map_from (sage/structure/parent.c:15082)
      File "parent.pyx", line 2165, in sage.structure.parent.Parent.discover_convert_map_from (sage/structure/parent.c:15301)
      File "parent.pyx", line 1903, in sage.structure.parent.Parent.coerce_map_from (sage/structure/parent.c:14051)
      File "parent.pyx", line 1974, in sage.structure.parent.Parent.coerce_map_from (sage/structure/parent.c:13804)
      File "parent.pyx", line 2068, in sage.structure.parent.Parent.discover_coerce_map_from (sage/structure/parent.c:14231)
      File "parent_old.pyx", line 507, in sage.structure.parent_old.Parent._coerce_map_from_ (sage/structure/parent_old.c:6428)
      File "/release/merger/sage-5.6.beta0/local/lib/python/site-packages/sage/rings/polynomial/polynomial_quotient_ring.py", line 485, in _coerce_map_from_
        if not self.__polynomial.divides(R.modulus()):
      File "element.pyx", line 2027, in sage.structure.element.CommutativeRingElement.divides (sage/structure/element.c:16725)
      File "element.pyx", line 2021, in sage.structure.element.CommutativeRingElement.divides (sage/structure/element.c:16636)
      File "polynomial_element.pyx", line 1724, in sage.rings.polynomial.polynomial_element.Polynomial.__mod__ (sage/rings/polynomial/polynomial_element.c:16751)
        _, R = self.quo_rem(other)
      File "element.pyx", line 3223, in sage.structure.element.NamedBinopMethod.__call__ (sage/structure/element.c:24763)
      File "polynomial_element.pyx", line 6478, in sage.rings.polynomial.polynomial_element.Polynomial_generic_dense.quo_rem (sage/rings/polynomial/polynomial_element.c:47106)
        raise ArithmeticError("Nonunit leading coefficient")
    ArithmeticError: Nonunit leading coefficient
**********************************************************************
```



---

Comment by chapoton created at 2012-12-30 19:46:45

Well, this failing test does not make sense to me. Why on earth should we be able to convert


```
x as element of the ring Q[x]/(x^6 - x^4 - 5*x^2 - 3)

to

x as element of the ring Q[x][y]/(y^2+1)
```


I propose to remove this test. Anybody else has an opinion ?


---

Comment by jdemeyer created at 2012-12-31 09:48:09

I think the doctest explains it pretty well: it is a conversion from `Q[x]/(x^6 - x^4 - 5*x^2 - 3)` to `Q[x]` which matters.

You can ask questions at #8992, where this test was introduced.


---

Attachment

rebased for Sage 5.6


---

Comment by klee created at 2013-02-07 04:44:17

Actually the fault was with #8992. There is now no need to take off the problematic doctest of #8992.


---

Comment by klee created at 2013-02-07 04:45:15

The faulty part of #8992 is now remedied and included in the current patch for this ticket.


---

Comment by klee created at 2013-02-20 00:50:59

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2013-02-26 19:42:38

ok for me, positive review


---

Comment by chapoton created at 2013-02-26 19:42:38

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-02-28 10:30:53

Resolution: fixed
