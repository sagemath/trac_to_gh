# Issue 13180: Running time improvement of the bitset_len method

Issue created by migration from https://trac.sagemath.org/ticket/13352

Original creator: dcoudert

Original creation time: 2012-08-08 23:19:17

Assignee: jason

CC:  ncohen leif

This patch improves the running time of the `bitset_len` method by using fast methods for counting bits in 32 and 64 bits integers (popcount). It
- adds file `bitcount.pxi` to `sage/misc/`. This file contains the functions for counting bits in 32 or 64 bits integers
- adds corresponding tests to file `misc_c.pyx`
- modifies the `bitset_len` function accordingly

Before:

```
sage: x = FrozenBitset('10'*1003002); len(x)
1003002
sage: %timeit len(x)
125 loops, best of 3: 5.27 ms per loop
sage: x = FrozenBitset('10'*10705); len(x)
10705
sage: %timeit len(x)
625 loops, best of 3: 56.3 µs per loop
```


After:

```
sage: x = FrozenBitset('10'*1003002); len(x)
1003002
sage: %timeit len(x)
625 loops, best of 3: 865 µs per loop
sage: x = FrozenBitset('10'*10705); len(x)
10705
sage: %timeit len(x)
625 loops, best of 3: 9.39 µs per loop
```


The ``popcount_32`` method is the same than the function used in patch #12371. 

The alternative would be to use functions `__builtin_popcount()` and `__builtin_popcountll()`. They are extremely fast but they required to add flag ``-mpopcnt`` or ``-msse4.2`` to the gcc compiler. Can we do that? how?


---

Comment by dcoudert created at 2012-08-08 23:56:20

Changing status from new to needs_review.


---

Comment by leif created at 2012-08-09 14:10:11

I'd rather "implement" the functions in C (where you can use the C preprocessor and `__builtin_popcount()` if available) and write a thin Cython wrapper.

GCC e.g. chooses efficient machine implementations (probably a single instruction), depending on the (configured or specified) target and perhaps also further compiler flags.

Note that GMP has functions like `mpz_popcount()` for `mpz_t`s as well.


----

Not sure what the `parallel` refers to ... ;-)


---

Comment by dcoudert created at 2012-08-09 14:47:19

trials not working


---

Attachment

Replying to [comment:2 leif]:
> I'd rather "implement" the functions in C (where you can use the C preprocessor and `__builtin_popcount()` if available) and write a thin Cython wrapper.
> 
> GCC e.g. chooses efficient machine implementations (probably a single instruction), depending on the (configured or specified) target and perhaps also further compiler flags.

As reported in https://groups.google.com/forum/#!topic/sage-devel/GnudTUwbGG4, I tried to implement the function in C with `__builtin_popcount()`. I was able to compile successfully, but then sage was not working anymore.
See attached patch [attachment:trac_13352-bitcount-in-c.patch].


> Note that GMP has functions like `mpz_popcount()` for `mpz_t`s as well.

It could be another solution, but I have not been able yet to find how to access the functions used for int behind? 


> Not sure what the `parallel` refers to ... ;-)
In fact, the 4 lines ` n = __COUNT32__(n, 0) ` can be executed in parallel and gcc is sometimes able to optimize the sequence of instructions. For instance, all methods have similar running times on my macbook air, but parallel methods are slower on my old PC (system still in 32-bits...).


---

Comment by leif created at 2012-08-09 18:23:38

Replying to [comment:3 dcoudert]:
> Replying to [comment:2 leif]:
> > Not sure what the `parallel` refers to ... ;-)
> In fact, the 4 lines ` n = __COUNT32__(n, 0) ` can be executed in parallel

Well, obviously not, since you have the data dependence on `n`. ;-)





Btw., you should use `UINT32_C(1)` instead of `0x1u` etc., and e.g. `UINT32_MAX` instead of `(<uint32_t>-1)` (Cython code) etc.

The types of the shift parameters (of `__TWO??__()`) are slightly overdim'ed...


---

Comment by dcoudert created at 2012-08-09 20:22:15

I'm able to import UINT32_MAX, but not UINT32_C.
- with `from libc.stdint cimport UINT32_C`: it is apparently not imported
- with `from libc.stdint import UINT32_C`: it compiles, but sage crashes with weird messages

Any special trick?


---

Attachment


---

Attachment


---

Comment by dcoudert created at 2013-08-18 15:08:25

Hello,

Since I have now understood how to use `__builtin_popcountl` (not obvious when you don't know), I have uploaded a new version of the patch.

before:

```
sage: B = Bitset('00'*10000+'1')
sage: len(B)
1
sage: %timeit len(B)
1000000 loops, best of 3: 268 ns per loop
sage: B = Bitset('10'*10000)
sage: len(B)
10000
sage: %timeit len(B)
1000 loops, best of 3: 245 us per loop
sage: B = Bitset('10'*1000000)
sage: len(B)
1000000
sage: %timeit len(B)
10 loops, best of 3: 24.1 ms per loop
```


after:

```
sage: B = Bitset('00'*10000+'1')
sage: len(B)
1
sage: %timeit len(B)
1000000 loops, best of 3: 275 ns per loop
sage: B = Bitset('10'*10000)
sage: len(B)
10000
sage: %timeit len(B)
100000 loops, best of 3: 2.52 us per loop
sage: B = Bitset('10'*1000000)
sage: len(B)
1000000
sage: %timeit len(B)
1000 loops, best of 3: 236 us per loop
```



I'm wondering if I should add a wrapper in case the `__builtin_popcountl` method is not available. This is not difficult, but I don't know which environnement variables should be tested.

Thanks.


---

Comment by dcoudert created at 2013-08-26 13:23:57

I have now implemented the function in C in file `popcount.h` with a small wrapper. The result is a bit slower than without wrapper, but still way faster than previous method.


```
sage: B = Bitset('00'*10000+'1')
sage: len(B)
1
sage: %timeit len(B)
1000000 loops, best of 3: 361 ns per loop
sage: B = Bitset('10'*10000)
sage: %timeit len(B)
100000 loops, best of 3: 3.03 us per loop
sage: B = Bitset('10'*1000000)
sage: len(B)
1000000
sage: %timeit len(B)
1000 loops, best of 3: 287 us per loop
```


I have used the `_WIN32` flag, but I'm not sure it's the good one. So if one knows the best flag to use to detect when the `__builtin_popcount` method is not available, please let me know.


---

Comment by dcoudert created at 2013-09-16 21:38:52

Hello,

after browsing the web, I came up with this new version. The current version tests is the cpu has builtin support. If yes, we use builtin version. Else, we use hakmem methods.
* http://gcc.gnu.org/onlinedocs/gcc/X86-Built_002din-Functions.html
* http://gcc.gnu.org/gcc-4.8/changes.html
* http://www.spinics.net/lists/linux-ext4/msg35827.html

We don't need all the methods for `bitset_len` but it could be useful for other usage.

Let me know if it is OK.


---

Comment by ncohen created at 2013-09-17 09:22:14

HMmmmmmmmm.... I'm trying to understand the code and it's much more complicated than what I actually read. Funny, looks like you can have as much fun with GCC than with Python, and decide how stuff is to be run at run time instead of compile time `:-P`

This being said, if I understand well what "ifunc" does I do not see how the popcount instruction will be used when available. To me it looks like you should make sure that the file is compiled with the `-mpopcnt` GCC flag (so that `__builtin_popcnt` is always replaced by the popcount instruction even if it does not exist), and that this ifunc trick means to avoid using this instruction if it is detected that, at runtime, it is not available.

This being said, it is a very nice trick `O_o`

Nathann


---

Comment by ncohen created at 2013-09-17 09:32:18

I would also say that those 2 blocks 

```
__attribute__ ((__target__ ("popcnt"))) 
 static unsigned int builtin_popcount(unsigned int w){ 
 return (sizeof(unsigned int)==4? __builtin_popcount(w) : __builtin_popcountl(w)); 
 } 
```


are mistakes. Whatever happens, regardless of the architecture, `__builtin_popcount` works on int type, and `__builtin_popcountl` works on long types.

Also, perhaps you should credit Cristian Rodríguez somewhere `:-P`

Nathann


---

Attachment

Right. I have simplified the code and add credits to Cristian Rodriguez.


---

Comment by ncohen created at 2013-09-19 15:20:56

Here's a slightly cleaner version which does not use ifunc but only G++'s multiversionning. C's looking very much like Python these days `:-PPPP`

Nice links :
    * http://gcc.gnu.org/wiki/FunctionMultiVersioning
    * http://gcc.gnu.org/onlinedocs/gcc/Function-Multiversioning.html

Nathann


---

Attachment


---

Comment by dcoudert created at 2013-09-19 21:33:32

Unfortunately, I'm unable to use this for the patch because the "default" keyword is not recognized.


---

Comment by ncohen created at 2013-09-20 07:35:31

Hmmmmmm... Well, it seems that this feature is only available in gcc 4.8+. I asked Volker for his advice on this ticket (or rather on the .c file I uploaded), and he told me that we should check for both gcc 4.8+ and x86 (ifdef `__i386__`).

Besides, he saw on that link (http://gcc.gnu.org/bugzilla/show_bug.cgi?id=36041, though I can't find out where on the page) that GCC was about to patch that, and improve the generic version of `__builtin_gcc`. If that's the case, perhaps we should just use theirs, waiting for the patch to be merged with a future gcc release. Otherwise we can use the MIT HAKMEM version indeed.

I'll try to send a version with both codes today. And we'll remove the old one in a couple of years `:-P`

Nathann


---

Comment by ncohen created at 2013-09-20 07:45:52

Hey I don't get it... In your patch you also use a attribute/target with popcount. You can't compile my code yet you can compile yours ? And that means that they added this attribute/target feature before adding the "default" keyword ? `O_o`

Nathann


---

Comment by dcoudert created at 2013-09-20 07:51:31

Apparently yes. Have you tried to modify the patch and compile on your own computer?


---

Comment by ncohen created at 2013-09-20 07:57:01

I'm trying, but it takes forever to compile. What happens if you replace "default" with ""  in the .c file ?

Nathann


---

Comment by ncohen created at 2013-09-20 07:57:54

Arg. This "" fails `:-/`

Nathann


---

Comment by ncohen created at 2013-09-20 08:05:20

HMmmmmmm `O_o`

What I get when running tests is :


```
Traceback (most recent call last):
  File "/home/ncohen/.Sage/local/bin/sage-runtests", line 79, in <module>
    from sage.doctest.control import DocTestController
  File "/home/ncohen/.Sage/local/lib/python2.7/site-packages/sage/doctest/control.py", line 27, in <module>
    from sources import FileDocTestSource, DictAsObject
  File "/home/ncohen/.Sage/local/lib/python2.7/site-packages/sage/doctest/sources.py", line 27, in <module>
    from util import NestedName
  File "/home/ncohen/.Sage/local/lib/python2.7/site-packages/sage/doctest/util.py", line 23, in <module>
    from sage.misc.misc import walltime, cputime
  File "/home/ncohen/.Sage/local/lib/python2.7/site-packages/sage/misc/misc.py", line 565, in <module>
    from sage.misc.misc_c import prod, running_total, balanced_sum, is_64_bit, is_32_bit
ImportError: /home/ncohen/.Sage/local/lib/python2.7/site-packages/sage/misc/misc_c.so: undefined symbol: __builtin_popcount
```


Nathann


---

Comment by ncohen created at 2013-09-20 09:33:11

(that was with your patch applied)


---

Comment by dcoudert created at 2013-09-20 09:38:44

so you mean with patch http://trac.sagemath.org/raw-attachment/ticket/13352/trac_13352_bitset_len_v3.patch as it is or a modified version ?


When I try to replace my patch with what you have put in a.c file, I get:

```
In file included from sage/coding/binary_code.c:319:0:
./sage/misc/popcount.h:107:3: error: attribute(target("default")) is unknown
./sage/misc/popcount.h:123:3: error: attribute(target("default")) is unknown
./sage/misc/popcount.h:128:14: error: redefinition of ‘popcount’
./sage/misc/popcount.h:123:14: note: previous definition of ‘popcount’ was here
./sage/misc/popcount.h:132:14: error: redefinition of ‘popcountl’
./sage/misc/popcount.h:107:14: note: previous definition of ‘popcountl’ was here
error: command 'gcc' failed with exit status 1
Error installing modified sage library code.
```



---

Comment by ncohen created at 2013-09-20 09:43:15

I meant your patch, without modifications. As for the errors you get, I think it's because the file gets compiled with gcc instead of g++. Volker said that it should be sufficient to make it a .cc file, and that GCC would take the hint and use the right compiler instead. It does work when outside of Sage :


```
~$ cp a.cc a.c
~$ gcc a.c -o a
a.c:31:12: error: redefinition of ‘popcount’
 inline int popcount(unsigned int i){
            ^
a.c:26:12: note: previous definition of ‘popcount’ was here
 inline int popcount(unsigned int i){
            ^
a.c:35:12: error: redefinition of ‘popcountl’
 inline int popcountl(unsigned long i){
            ^
a.c:10:12: note: previous definition of ‘popcountl’ was here
 inline int popcountl(unsigned long i){
            ^
~$ gcc a.cc -o a
~$ 
```


Though there does not seem to be anything wrong with "default" on my computer. Which version of gcc are you using ? It's probably < 4.8.

Nathann


---

Comment by dcoudert created at 2013-09-20 09:47:13

gcc (GCC) 4.6.3 20120306.


---

Comment by ncohen created at 2013-09-21 08:08:23

Helloooooooo ! Just to mention that I have been fighting with multiversionning in Sage+GCC for two days now, and that I can't seem to make it work. It works outside of Sage, it segfaults inside of Sage and I have no idea why.

Oh, and there is a `#DEFINE NO_INLINE` among the default preprocessor variables for anything that gets compiled by Sage it seems.

Nathann


---

Comment by dcoudert created at 2013-09-21 15:38:49

So unless someone has a good solution, we can make a patch containing only the hakmem methods, and if one is later able to make `__builtin_popcount` running, then we may switch to it.
Do you agree?


---

Comment by ncohen created at 2013-09-22 08:38:00

Yep, it makes sense but it is a pity `:-/`

I wrote to sage-devel, just in case ... 

https://groups.google.com/d/topic/sage-devel/FIxzZv0L_lo/discussion

Nathann


---

Comment by jdemeyer created at 2013-12-10 09:31:35

I think a great suggestion implied by #14704 is to use `mpn_popcount()` for this. That's essentially one line of code to call that function :-)


---

Comment by jdemeyer created at 2013-12-10 09:51:50

I'm working on a patch which does this...


---

Comment by dcoudert created at 2013-12-10 10:21:53

That would be great if you have the good trick to use that method. I tried some time ago to use `mpz_popcount` and failed.


---

Comment by jdemeyer created at 2013-12-10 10:39:18

I'm also merging `bitset_pxd.pxi` and `bitset.pxd` (I see no reason why these would be two separate files) and moving the doctests to `bitset.pyx`.


---

Comment by ncohen created at 2013-12-10 10:41:52

Hmmmmmmmmmm `O_O`

You are on a dangerous road, Jeroen. The road to many broken dependencies in the graph/ folder `:-PPPPPP`

Nathann


---

Comment by jdemeyer created at 2013-12-10 10:54:29

Replying to [comment:33 ncohen]:
> Hmmmmmmmmmm `O_O`
> 
> You are on a dangerous road, Jeroen. The road to many broken dependencies in the graph/ folder `:-PPPPPP`

You mean because of `bitset_pxd.pxi`? I could simply leave that file with a one-liner

```
from sage.misc.bitset cimport *
```

if you prefer.


---

Comment by jdemeyer created at 2013-12-10 11:06:42

Replying to [comment:31 dcoudert]:
> That would be great if you have the good trick to use that method. I tried some time ago to use `mpz_popcount` and failed. 
The trick is to use `mpn_popcount` instead of `mpz_popcount`.


---

Comment by jdemeyer created at 2013-12-10 11:12:08

Speed is much better too.

With [attachment:trac_13352_bitset_len_v3.patch​]:

```
sage: B = Bitset('10'*10000)
sage: timeit('len(B)',repeat=100,number=10000)
10000 loops, best of 100: 1.24 µs per loop
sage: B = Bitset('00'*10000)
sage: timeit('len(B)',repeat=100,number=10000)
10000 loops, best of 100: 254 ns per loop
```


With [attachment:trac_13352_bitset_len_v4.patch​]:

```
sage: B = Bitset('10'*10000)
sage: timeit('len(B)',repeat=100,number=10000)
10000 loops, best of 100: 168 ns per loop
sage: B = Bitset('00'*10000)
sage:  timeit('len(B)',repeat=100,number=10000)
10000 loops, best of 100: 168 ns per loop
```



---

Comment by jdemeyer created at 2013-12-10 12:30:15

Similar improvements could be made to other bitset functions (in particular to `bitset_next()` and the like). But that would be for a new ticket...


---

Comment by jdemeyer created at 2013-12-10 12:52:24

Strangely, many places were importing `bitset` without actually using bitsets... so I removed those redundant imports.

Even stranger were two files `sage/combinat/debruijn_sequence.pxd` and `sage/matroids/unpickling.pxd` containing just one line

```
include 'sage/misc/bitset_pxd.pxi' 
```

which was in both cases unused.


---

Attachment


---

Comment by dcoudert created at 2013-12-10 13:59:12

Excellent! The patch is working perfectly (install, doctests on sage/ , etc.). The simplification of the hamming weight method is also very good.

Thank you very much.

Should we let Nathann conclude on the status of this ticket?


---

Comment by jdemeyer created at 2013-12-10 14:00:44

See also #10093 for another bitset-related ticket ready for review.


---

Comment by ncohen created at 2013-12-10 14:27:35

> Should we let Nathann conclude on the status of this ticket?

No sorry, please deal with this without me, I'm already juggling with 1000 patches right now `O_o`

Nathann


---

Comment by dcoudert created at 2013-12-10 14:33:16

For me the patch proposed by Jeroen is OK (and I can install #10093 on top of it), so I set its status to positive.


---

Comment by dcoudert created at 2013-12-10 14:33:16

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-12-10 17:43:08

This is ridiculous and shows how fast `mpn_popcount()` is:

```
sage: B = FrozenBitset(capacity=10^5)
sage: timeit('B.isempty()', repeat=100, number=10000)
10000 loops, best of 100: 980 ns per loop
sage: timeit('len(B)', repeat=100, number=10000)
10000 loops, best of 100: 573 ns per loop
```



---

Comment by ncohen created at 2013-12-10 20:25:12

Hmmmmmm... Would you happen to have the popcount instruction on the computer on which you try this ?

Nathann


---

Comment by jdemeyer created at 2013-12-10 20:55:42

Replying to [comment:46 ncohen]:
> Hmmmmmm... Would you happen to have the popcount instruction on the computer on which you try this ?

I think so, yes.


---

Comment by jdemeyer created at 2013-12-11 11:02:53

Resolution: fixed


---

Comment by dcoudert created at 2014-01-20 14:32:44

I changed the description since we use `mpn_popcount` and not `___builtin_popcount`


---

Comment by jdemeyer created at 2014-09-05 13:37:22

Follow-up: #16937
