# Issue 15405: Use mirrors for tarballs

archive/issues_015405.json:
```json
{
    "body": "CC:  ohanar tmonteil schilly\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/15642\n\n",
    "created_at": "2014-01-07T08:44:19Z",
    "labels": [
        "PLEASE CHANGE",
        "major"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.7",
    "title": "Use mirrors for tarballs",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15405",
    "user": "vbraun"
}
```
CC:  ohanar tmonteil schilly



Issue created by migration from https://trac.sagemath.org/ticket/15642





---

archive/issue_comments_198825.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-01-13T06:14:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198825",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_198826.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2014-01-13T06:15:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198826",
    "user": "vbraun"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_198827.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-01-13T06:15:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198827",
    "user": "vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_198828.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to build.",
    "created_at": "2014-01-13T06:15:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198828",
    "user": "vbraun"
}
```

Changing component from PLEASE CHANGE to build.



---

archive/issue_comments_198829.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-01-13T19:17:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198829",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_198830.json:
```json
{
    "body": "I would replace the regex in `_parse_name` with something like\n\n```\n(?P<base>(?:[^-]|-(?!\\d))*)-(?P<version>.*)\\.(?P<ext>tar.*|zip|tgz)\n```\n\n(We may as well support more general package names, even if our restrictive naming convention doesn't allow it at the moment.)",
    "created_at": "2014-01-14T09:52:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198830",
    "user": "ohanar"
}
```

I would replace the regex in `_parse_name` with something like

```
(?P<base>(?:[^-]|-(?!\d))*)-(?P<version>.*)\.(?P<ext>tar.*|zip|tgz)
```

(We may as well support more general package names, even if our restrictive naming convention doesn't allow it at the moment.)



---

archive/issue_comments_198831.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-01-15T16:37:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198831",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_198832.json:
```json
{
    "body": "I added a few extra commits to resolve a couple of small bugs I noticed. Pending someone signing off on those, and testing on various versions of python, this looks good to me.\n----\nNew commits:",
    "created_at": "2014-01-21T09:05:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198832",
    "user": "ohanar"
}
```

I added a few extra commits to resolve a couple of small bugs I noticed. Pending someone signing off on those, and testing on various versions of python, this looks good to me.
----
New commits:



---

archive/issue_comments_198833.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2014-02-04T08:03:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198833",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_198834.json:
```json
{
    "body": "Why remove the possibility to use the system `curl` or `wget` programs? That seems like an unneeded regression to me.",
    "created_at": "2014-02-04T08:03:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198834",
    "user": "jdemeyer"
}
```

Why remove the possibility to use the system `curl` or `wget` programs? That seems like an unneeded regression to me.



---

archive/issue_comments_198835.json:
```json
{
    "body": "We only need **one** way to download files. There is no point in having untested (hence broken) code laying around \"just in case\". There is no use case, just clutter laying around.",
    "created_at": "2014-02-04T22:36:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198835",
    "user": "vbraun"
}
```

We only need **one** way to download files. There is no point in having untested (hence broken) code laying around "just in case". There is no use case, just clutter laying around.



---

archive/issue_comments_198836.json:
```json
{
    "body": "Replying to [comment:11 vbraun]:\n> There is no use case\nThe use case is building from git on systems without Python installed.",
    "created_at": "2014-02-05T15:33:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198836",
    "user": "jdemeyer"
}
```

Replying to [comment:11 vbraun]:
> There is no use case
The use case is building from git on systems without Python installed.



---

archive/issue_comments_198837.json:
```json
{
    "body": "Per the discussion on sage-devel, Python is a requirement. Sooner or later Sage won't build without Python with or without this ticket.",
    "created_at": "2014-02-05T15:55:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198837",
    "user": "vbraun"
}
```

Per the discussion on sage-devel, Python is a requirement. Sooner or later Sage won't build without Python with or without this ticket.



---

archive/issue_comments_198838.json:
```json
{
    "body": "Replying to [comment:13 vbraun]:\n> Per the discussion on sage-devel, Python is a requirement.\nThat would require at least a change to the documentation.",
    "created_at": "2014-02-06T10:19:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198838",
    "user": "jdemeyer"
}
```

Replying to [comment:13 vbraun]:
> Per the discussion on sage-devel, Python is a requirement.
That would require at least a change to the documentation.



---

archive/issue_comments_198839.json:
```json
{
    "body": "Replying to [comment:13 vbraun]:\n> Sooner or later Sage won't build without Python with or without this ticket.\nSure, but why break building on systems without Python on this ticket? It is absolutely trivial to keep supporting without Python for now (just keep the shell part of the script). It seems you're breaking stuff for no reason.",
    "created_at": "2014-02-06T10:22:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198839",
    "user": "jdemeyer"
}
```

Replying to [comment:13 vbraun]:
> Sooner or later Sage won't build without Python with or without this ticket.
Sure, but why break building on systems without Python on this ticket? It is absolutely trivial to keep supporting without Python for now (just keep the shell part of the script). It seems you're breaking stuff for no reason.



---

archive/issue_comments_198840.json:
```json
{
    "body": "So would it make you feel better if we wait with this ticket and merge it only after another change broke building without Python?",
    "created_at": "2014-02-06T10:34:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198840",
    "user": "vbraun"
}
```

So would it make you feel better if we wait with this ticket and merge it only after another change broke building without Python?



---

archive/issue_comments_198841.json:
```json
{
    "body": "Replying to [comment:16 vbraun]:\n> So would it make you feel better if we wait with this ticket and merge it only after another change broke building without Python?\nEssentially yes. I agree with breaking building without Python, but not breaking just for the sake of it.",
    "created_at": "2014-02-06T16:44:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198841",
    "user": "jdemeyer"
}
```

Replying to [comment:16 vbraun]:
> So would it make you feel better if we wait with this ticket and merge it only after another change broke building without Python?
Essentially yes. I agree with breaking building without Python, but not breaking just for the sake of it.



---

archive/issue_comments_198842.json:
```json
{
    "body": "I would say this is not breaking building without Python for the sake of breaking, but for the sake of moving the build system to a language that all Sage developers understand (and therefore can make further improvements).",
    "created_at": "2014-11-05T23:38:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198842",
    "user": "novoselt"
}
```

I would say this is not breaking building without Python for the sake of breaking, but for the sake of moving the build system to a language that all Sage developers understand (and therefore can make further improvements).



---

archive/issue_comments_198843.json:
```json
{
    "body": "Currently in Sage, we have a Python script to download stuff with a shell-script wrapper to handle the case where Python in Sage is not yet installed. I would rather keep the shell-script wrapper and only modify the Python script.",
    "created_at": "2014-11-06T07:21:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198843",
    "user": "jdemeyer"
}
```

Currently in Sage, we have a Python script to download stuff with a shell-script wrapper to handle the case where Python in Sage is not yet installed. I would rather keep the shell-script wrapper and only modify the Python script.



---

archive/issue_comments_198844.json:
```json
{
    "body": "Why have a shell script here-document a fortran program which runs a python script? Just so that we can build Sage without Python for a few more months? The decision is made, Python is a built-time requirement.",
    "created_at": "2014-11-06T09:45:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198844",
    "user": "vbraun"
}
```

Why have a shell script here-document a fortran program which runs a python script? Just so that we can build Sage without Python for a few more months? The decision is made, Python is a built-time requirement.



---

archive/issue_comments_198845.json:
```json
{
    "body": "Replying to [comment:23 vbraun]:\n> The decision is made\nI don't recall that discussion...\n\nLet me repeat what I said above:\n\nWhy break building on systems without Python on this ticket? It is absolutely trivial to keep support for building without Python for now (just keep the shell part of the script). It seems you're breaking stuff for no reason. I don't mind breaking building without Python if there is a good reason, but not breaking just for the sake of it.",
    "created_at": "2014-11-06T10:21:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198845",
    "user": "jdemeyer"
}
```

Replying to [comment:23 vbraun]:
> The decision is made
I don't recall that discussion...

Let me repeat what I said above:

Why break building on systems without Python on this ticket? It is absolutely trivial to keep support for building without Python for now (just keep the shell part of the script). It seems you're breaking stuff for no reason. I don't mind breaking building without Python if there is a good reason, but not breaking just for the sake of it.



---

archive/issue_comments_198846.json:
```json
{
    "body": "You are going to say the same thing all the time, why rely on a Python script here when you could just as well have an additional shell script to provide a fall back. The answer is: fewer moving parts = less bugs.",
    "created_at": "2014-11-06T11:15:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198846",
    "user": "vbraun"
}
```

You are going to say the same thing all the time, why rely on a Python script here when you could just as well have an additional shell script to provide a fall back. The answer is: fewer moving parts = less bugs.



---

archive/issue_comments_198847.json:
```json
{
    "body": "This is not about python as a requirement nor the curl and wget fallbacks, but i see the benefit of being able to set a `URL_GRABBER` variable that calls some fetcher with more robust options, as discussed on [this sage-devel thread](http://comments.gmane.org/gmane.comp.mathematics.sage.devel/75369).",
    "created_at": "2014-11-06T15:02:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198847",
    "user": "tmonteil"
}
```

This is not about python as a requirement nor the curl and wget fallbacks, but i see the benefit of being able to set a `URL_GRABBER` variable that calls some fetcher with more robust options, as discussed on [this sage-devel thread](http://comments.gmane.org/gmane.comp.mathematics.sage.devel/75369).



---

archive/issue_comments_198848.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2015-05-04T14:38:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198848",
    "user": "vbraun"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_198849.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2015-05-04T14:38:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198849",
    "user": "vbraun"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_comments_198850.json:
```json
{
    "body": "We must use the mirrors very soon, the centrally-hosted packages will go away.\n\nThe downloading script still needs to be called from sage-spkg, when that is finished we must merge this ticket asap.\n----\nNew commits:",
    "created_at": "2015-05-04T14:38:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198850",
    "user": "vbraun"
}
```

We must use the mirrors very soon, the centrally-hosted packages will go away.

The downloading script still needs to be called from sage-spkg, when that is finished we must merge this ticket asap.
----
New commits:



---

archive/issue_comments_198851.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-05-09T00:49:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198851",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_198852.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-05-09T08:24:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198852",
    "user": "vbraun"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_198853.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-05-09T09:45:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198853",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_198854.json:
```json
{
    "body": "The buildbot will set `SAGE_MIRROR` to its own so it doesn't have to wait for the mirrors to catch up.",
    "created_at": "2015-05-09T10:12:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198854",
    "user": "vbraun"
}
```

The buildbot will set `SAGE_MIRROR` to its own so it doesn't have to wait for the mirrors to catch up.



---

archive/issue_comments_198855.json:
```json
{
    "body": "\"Usage\" doesn't match implementation: `--fastest-mirror` vs. `--print-fastest-mirror`.",
    "created_at": "2015-05-09T12:25:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198855",
    "user": "leif"
}
```

"Usage" doesn't match implementation: `--fastest-mirror` vs. `--print-fastest-mirror`.



---

archive/issue_comments_198856.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-05-09T12:25:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198856",
    "user": "leif"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_198857.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-05-09T12:30:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198857",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_198858.json:
```json
{
    "body": "Thanks, fixed",
    "created_at": "2015-05-09T12:30:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198858",
    "user": "vbraun"
}
```

Thanks, fixed



---

archive/issue_comments_198859.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-05-09T12:30:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198859",
    "user": "vbraun"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_198860.json:
```json
{
    "body": "Not entirely clear to me why you use `.startswith()` though... ;-)\n\n(Ok, it does support `--print-fastest-mirror-and-drop-me-a-beer`, but I'm still waiting...)",
    "created_at": "2015-05-09T12:34:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198860",
    "user": "leif"
}
```

Not entirely clear to me why you use `.startswith()` though... ;-)

(Ok, it does support `--print-fastest-mirror-and-drop-me-a-beer`, but I'm still waiting...)



---

archive/issue_comments_198861.json:
```json
{
    "body": "Could we please suppress the tracebacks on errors like 404?",
    "created_at": "2015-05-09T12:37:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198861",
    "user": "leif"
}
```

Could we please suppress the tracebacks on errors like 404?



---

archive/issue_comments_198862.json:
```json
{
    "body": "As you said, using startswith() is a cheap emulation of argparse so `--quiet=...` works. The point is to be compatible with Python 2.6, of course, so we can't use argparse.",
    "created_at": "2015-05-09T12:43:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198862",
    "user": "vbraun"
}
```

As you said, using startswith() is a cheap emulation of argparse so `--quiet=...` works. The point is to be compatible with Python 2.6, of course, so we can't use argparse.



---

archive/issue_comments_198863.json:
```json
{
    "body": "Mirror layout fixes, part I:\n\n```diff\ndiff --git a/src/bin/sage-spkg b/src/bin/sage-spkg\nindex d25542c..0eb2f8a 100755\n--- a/src/bin/sage-spkg\n+++ b/src/bin/sage-spkg\n@@ -367,9 +367,9 @@ if [ ! -f \"$PKG_SRC\" ]; then\n                 echo \">>> Checking online list of $repo packages.\"\n                 # File inside DOT_SAGE should be writable\n                 repolist=\"${DOT_SAGE}/${repo}.list\"\n-                sage-download-file \"$MIRROR/$repo/list\" $repolist\n+                sage-download-file \"$MIRROR/spkg/$repo/list\" $repolist\n                 if [ $? -ne 0 ]; then\n-                    echo >&2 \"Error: failed to download $MIRROR/$repo/list, aborting\"\n+                    echo >&2 \"Error: failed to download $MIRROR/spkg/$repo/list, aborting\"\n                     rm -f $repolist\n                     exit 1\n                 fi\n@@ -386,7 +386,7 @@ if [ ! -f \"$PKG_SRC\" ]; then\n \n                     # If INFO is set, try downloading only the .txt file\n                     if [ $INFO -eq 1 ]; then\n-                        PKG_URL=\"$MIRROR/$repo/$pkg.txt\"\n+                        PKG_URL=\"$MIRROR/spkg/$repo/$pkg.txt\"\n                         sage-download-file \"$PKG_URL\" && exit 0\n                         # If the download failed (for whatever reason),\n                         # fall through and use the .spkg file.\n@@ -416,7 +416,7 @@ if [ ! -f \"$PKG_SRC\" ]; then\n                             esac\n                         fi\n                     fi\n-                    PKG_URL=\"$MIRROR/$repo/$pkg.spkg\"\n+                    PKG_URL=\"$MIRROR/spkg/$repo/$pkg.spkg\"\n                     break\n                 fi\n             done\n```\n\n(Try e.g. `./sage -i foobar`.)",
    "created_at": "2015-05-09T13:01:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198863",
    "user": "leif"
}
```

Mirror layout fixes, part I:

```diff
diff --git a/src/bin/sage-spkg b/src/bin/sage-spkg
index d25542c..0eb2f8a 100755
--- a/src/bin/sage-spkg
+++ b/src/bin/sage-spkg
@@ -367,9 +367,9 @@ if [ ! -f "$PKG_SRC" ]; then
                 echo ">>> Checking online list of $repo packages."
                 # File inside DOT_SAGE should be writable
                 repolist="${DOT_SAGE}/${repo}.list"
-                sage-download-file "$MIRROR/$repo/list" $repolist
+                sage-download-file "$MIRROR/spkg/$repo/list" $repolist
                 if [ $? -ne 0 ]; then
-                    echo >&2 "Error: failed to download $MIRROR/$repo/list, aborting"
+                    echo >&2 "Error: failed to download $MIRROR/spkg/$repo/list, aborting"
                     rm -f $repolist
                     exit 1
                 fi
@@ -386,7 +386,7 @@ if [ ! -f "$PKG_SRC" ]; then
 
                     # If INFO is set, try downloading only the .txt file
                     if [ $INFO -eq 1 ]; then
-                        PKG_URL="$MIRROR/$repo/$pkg.txt"
+                        PKG_URL="$MIRROR/spkg/$repo/$pkg.txt"
                         sage-download-file "$PKG_URL" && exit 0
                         # If the download failed (for whatever reason),
                         # fall through and use the .spkg file.
@@ -416,7 +416,7 @@ if [ ! -f "$PKG_SRC" ]; then
                             esac
                         fi
                     fi
-                    PKG_URL="$MIRROR/$repo/$pkg.spkg"
+                    PKG_URL="$MIRROR/spkg/$repo/$pkg.spkg"
                     break
                 fi
             done
```

(Try e.g. `./sage -i foobar`.)



---

archive/issue_comments_198864.json:
```json
{
    "body": "... we'd better use a variable like `MIRROR_PACKAGE_FOLDER` or whatever there.",
    "created_at": "2015-05-09T13:03:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198864",
    "user": "leif"
}
```

... we'd better use a variable like `MIRROR_PACKAGE_FOLDER` or whatever there.



---

archive/issue_comments_198865.json:
```json
{
    "body": "how about you just push that to trac, I'm not going to type that in for you",
    "created_at": "2015-05-09T13:04:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198865",
    "user": "vbraun"
}
```

how about you just push that to trac, I'm not going to type that in for you



---

archive/issue_comments_198866.json:
```json
{
    "body": "There are still issues we have to fix w.r.t. `MIRROR` vs. `SAGE_SERVER`.",
    "created_at": "2015-05-09T13:05:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198866",
    "user": "leif"
}
```

There are still issues we have to fix w.r.t. `MIRROR` vs. `SAGE_SERVER`.



---

archive/issue_comments_198867.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-05-09T13:08:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198867",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_198868.json:
```json
{
    "body": "SAGE_SERVER is used elsewhere, its where the docs are hosted etc.",
    "created_at": "2015-05-09T13:09:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198868",
    "user": "vbraun"
}
```

SAGE_SERVER is used elsewhere, its where the docs are hosted etc.



---

archive/issue_comments_198869.json:
```json
{
    "body": "Replying to [comment:42 vbraun]:\n> how about you just push that to trac, I'm not going to type that in for you\n\nThat's not something I expect you to merge; it just shows errors in the current code.  As said, we should IMHO use a variable for that.  (I'm not doing your work either... ;-) )",
    "created_at": "2015-05-09T13:09:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198869",
    "user": "leif"
}
```

Replying to [comment:42 vbraun]:
> how about you just push that to trac, I'm not going to type that in for you

That's not something I expect you to merge; it just shows errors in the current code.  As said, we should IMHO use a variable for that.  (I'm not doing your work either... ;-) )



---

archive/issue_comments_198870.json:
```json
{
    "body": "Replying to [comment:45 vbraun]:\n> SAGE_SERVER is used elsewhere, its where the docs are hosted etc.\n\nIt's still in an error message in `sage-spkg`, although `MIRROR` was used.",
    "created_at": "2015-05-09T13:13:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198870",
    "user": "leif"
}
```

Replying to [comment:45 vbraun]:
> SAGE_SERVER is used elsewhere, its where the docs are hosted etc.

It's still in an error message in `sage-spkg`, although `MIRROR` was used.



---

archive/issue_comments_198871.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-05-09T13:14:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198871",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_198872.json:
```json
{
    "body": "Fixed",
    "created_at": "2015-05-09T13:15:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198872",
    "user": "vbraun"
}
```

Fixed



---

archive/issue_comments_198873.json:
```json
{
    "body": "Replying to [comment:49 vbraun]:\n> Fixed\n\nOk, but there's an extra slash (`MIRROR` already has a trailing one).",
    "created_at": "2015-05-09T13:33:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198873",
    "user": "leif"
}
```

Replying to [comment:49 vbraun]:
> Fixed

Ok, but there's an extra slash (`MIRROR` already has a trailing one).



---

archive/issue_comments_198874.json:
```json
{
    "body": "the official mirror list may or may not have a slash at the end",
    "created_at": "2015-05-09T13:40:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198874",
    "user": "vbraun"
}
```

the official mirror list may or may not have a slash at the end



---

archive/issue_comments_198875.json:
```json
{
    "body": "FTP doesn't seem to work (hangs after receiving the file).\n\nTry for example\n\n```sh\n./sage --sh -c 'sage-download-file ftp://ftp.fu-berlin.de/unix/misc/sage/spkg/optional/list'\n```\n",
    "created_at": "2015-05-09T13:41:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198875",
    "user": "leif"
}
```

FTP doesn't seem to work (hangs after receiving the file).

Try for example

```sh
./sage --sh -c 'sage-download-file ftp://ftp.fu-berlin.de/unix/misc/sage/spkg/optional/list'
```




---

archive/issue_comments_198876.json:
```json
{
    "body": "Correct, FTP is not allowed",
    "created_at": "2015-05-09T13:48:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198876",
    "user": "vbraun"
}
```

Correct, FTP is not allowed



---

archive/issue_comments_198877.json:
```json
{
    "body": "Replying to [comment:51 vbraun]:\n> the official mirror list may or may not have a slash at the end\n\nA matter of what your script outputs...\n\n\n\n\nSo, what about `SAGE_SERVER` to specify a mirror?  While `$SOMEBODY` partially broke that anyway by hardcoding the incompatible `packages/` subfolder, we should IMHO still (or again) support that.  (At least `sage-list-packages` also needs to get fixed, preferably on a separate ticket I'd say.)",
    "created_at": "2015-05-09T13:55:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198877",
    "user": "leif"
}
```

Replying to [comment:51 vbraun]:
> the official mirror list may or may not have a slash at the end

A matter of what your script outputs...




So, what about `SAGE_SERVER` to specify a mirror?  While `$SOMEBODY` partially broke that anyway by hardcoding the incompatible `packages/` subfolder, we should IMHO still (or again) support that.  (At least `sage-list-packages` also needs to get fixed, preferably on a separate ticket I'd say.)



---

archive/issue_comments_198878.json:
```json
{
    "body": "Replying to [comment:53 vbraun]:\n> Correct, FTP is not allowed\n\n```\nThe single mandatory argument can be a http:// or ftp:// url or a\ntarball filename.\n```\n\n\n```python\n    if url.startswith('http://') or url.startswith('https://') or url.startswith('ftp://'):\n        http_download(url, destination, progress=progress, ignore_errors=True)\n```\n",
    "created_at": "2015-05-09T13:58:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198878",
    "user": "leif"
}
```

Replying to [comment:53 vbraun]:
> Correct, FTP is not allowed

```
The single mandatory argument can be a http:// or ftp:// url or a
tarball filename.
```


```python
    if url.startswith('http://') or url.startswith('https://') or url.startswith('ftp://'):
        http_download(url, destination, progress=progress, ignore_errors=True)
```




---

archive/issue_comments_198879.json:
```json
{
    "body": "I don't really like the SAGE_SERVER name (could refer anything, sage cell server), but historically that was where the official mirror list was and thats what I wanted to keep",
    "created_at": "2015-05-09T14:08:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198879",
    "user": "vbraun"
}
```

I don't really like the SAGE_SERVER name (could refer anything, sage cell server), but historically that was where the official mirror list was and thats what I wanted to keep



---

archive/issue_comments_198880.json:
```json
{
    "body": "Also, IMHO we should just phase out old-style spkgs. As long as we have to drag along that technical debt its very hard to clean up scripts.",
    "created_at": "2015-05-09T14:10:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198880",
    "user": "vbraun"
}
```

Also, IMHO we should just phase out old-style spkgs. As long as we have to drag along that technical debt its very hard to clean up scripts.



---

archive/issue_comments_198881.json:
```json
{
    "body": "Replying to [comment:56 vbraun]:\n> I don't really like the SAGE_SERVER name (could refer anything, sage cell server), but historically that was where the official mirror list was and thats what I wanted to keep\n\n?  Before the breakage, setting `SAGE_SERVER` to e.g. `http://mirror.switch.ch/mirror/sagemath/` worked, for example with `sage --optional` and -- long time ago -- with `sage --upgrade`.\n\n\nDeprecate it, later use `SAGE_MIRROR` for package download purposes?",
    "created_at": "2015-05-09T14:16:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198881",
    "user": "leif"
}
```

Replying to [comment:56 vbraun]:
> I don't really like the SAGE_SERVER name (could refer anything, sage cell server), but historically that was where the official mirror list was and thats what I wanted to keep

?  Before the breakage, setting `SAGE_SERVER` to e.g. `http://mirror.switch.ch/mirror/sagemath/` worked, for example with `sage --optional` and -- long time ago -- with `sage --upgrade`.


Deprecate it, later use `SAGE_MIRROR` for package download purposes?



---

archive/issue_comments_198882.json:
```json
{
    "body": "Replying to [comment:57 vbraun]:\n> Also, IMHO we should just phase out old-style spkgs.\n\nI'm all against that.  The worst decision was to hardcode package metadata (solely!) into specific Sage releases, while that data doesn't even show whether a package is optional, experimental, or whatever.  (It's pretty easy to *create* \"old-style\" packages from that though... ;-) )\n\nIn my opinion the main reason we should (still) support real spkgs is that anybody can easily create and offer such self-contained packages to others, and installing and using them doesn't artificially depend on the Sage version.  (Whether they'll work of course depends on a couple of things.)\n\nThey're also often much more convenient for testing.\n \n\n\n\n> As long as we have to drag along that technical debt its very hard to clean up scripts.\n\nPerhaps with the exception of left-over old-style standard packages, I don't see a problem.",
    "created_at": "2015-05-09T14:37:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198882",
    "user": "leif"
}
```

Replying to [comment:57 vbraun]:
> Also, IMHO we should just phase out old-style spkgs.

I'm all against that.  The worst decision was to hardcode package metadata (solely!) into specific Sage releases, while that data doesn't even show whether a package is optional, experimental, or whatever.  (It's pretty easy to *create* "old-style" packages from that though... ;-) )

In my opinion the main reason we should (still) support real spkgs is that anybody can easily create and offer such self-contained packages to others, and installing and using them doesn't artificially depend on the Sage version.  (Whether they'll work of course depends on a couple of things.)

They're also often much more convenient for testing.
 



> As long as we have to drag along that technical debt its very hard to clean up scripts.

Perhaps with the exception of left-over old-style standard packages, I don't see a problem.



---

archive/issue_comments_198883.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-05-09T14:39:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198883",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_198884.json:
```json
{
    "body": "Replying to [comment:59 leif]:\n> Whether they'll work of course depends on a couple of things.\n\nEven if they work in principle you can't do that much with them as there is no dependency management. Its just an all-out shitty solution for everyone.",
    "created_at": "2015-05-09T14:42:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198884",
    "user": "vbraun"
}
```

Replying to [comment:59 leif]:
> Whether they'll work of course depends on a couple of things.

Even if they work in principle you can't do that much with them as there is no dependency management. Its just an all-out shitty solution for everyone.



---

archive/issue_comments_198885.json:
```json
{
    "body": "SAGE_SERVER must of course then not be set by default...",
    "created_at": "2015-05-09T14:43:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198885",
    "user": "vbraun"
}
```

SAGE_SERVER must of course then not be set by default...



---

archive/issue_comments_198886.json:
```json
{
    "body": "Does any mirror have `packages/`?  Will they at some point?\n\nOtherwise `s|SAGE_SERVER/packages/|SAGE_SERVER/spkg/|` in the docs.",
    "created_at": "2015-05-09T15:03:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198886",
    "user": "leif"
}
```

Does any mirror have `packages/`?  Will they at some point?

Otherwise `s|SAGE_SERVER/packages/|SAGE_SERVER/spkg/|` in the docs.



---

archive/issue_comments_198887.json:
```json
{
    "body": "AFAIK there will only ever be /spkg/ on the mirrors",
    "created_at": "2015-05-09T15:14:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198887",
    "user": "vbraun"
}
```

AFAIK there will only ever be /spkg/ on the mirrors



---

archive/issue_comments_198888.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-05-09T15:16:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198888",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_198889.json:
```json
{
    "body": "Replying to [comment:63 leif]:\n> Does any mirror have `packages/`?  Will they at some point?\n> \n> Otherwise `s|SAGE_SERVER/packages/|SAGE_SERVER/spkg/|` in the docs.\n\nShould we fix this here, since we now touch `sage-list-packages` anyway?\n\n```\nSAGE_SERVER=\"http://mirror.switch.ch/mirror/sagemath/\" ./sage --optional\nUsing Sage Server http://mirror.switch.ch/mirror/sagemath/packages\nHTTP Error 404: Not Found\n\n\n\n********************************************************************************\n\n\n\nError contacting http://mirror.switch.ch/mirror/sagemath/packages/optional/list. Try using an alternative server.\nFor example, from the bash prompt try typing\n\n   export SAGE_SERVER=http://sage.scipy.org/sage/\n\nthen try again.\n\n\n\n********************************************************************************\n```\n\n\n([http://sage.scipy.org/sage/](http://sage.scipy.org/sage/) is btw. a joke...)",
    "created_at": "2015-05-09T15:17:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198889",
    "user": "leif"
}
```

Replying to [comment:63 leif]:
> Does any mirror have `packages/`?  Will they at some point?
> 
> Otherwise `s|SAGE_SERVER/packages/|SAGE_SERVER/spkg/|` in the docs.

Should we fix this here, since we now touch `sage-list-packages` anyway?

```
SAGE_SERVER="http://mirror.switch.ch/mirror/sagemath/" ./sage --optional
Using Sage Server http://mirror.switch.ch/mirror/sagemath/packages
HTTP Error 404: Not Found



********************************************************************************



Error contacting http://mirror.switch.ch/mirror/sagemath/packages/optional/list. Try using an alternative server.
For example, from the bash prompt try typing

   export SAGE_SERVER=http://sage.scipy.org/sage/

then try again.



********************************************************************************
```


([http://sage.scipy.org/sage/](http://sage.scipy.org/sage/) is btw. a joke...)



---

archive/issue_comments_198890.json:
```json
{
    "body": "Concurrent posting (luckily not pushing)...",
    "created_at": "2015-05-09T15:18:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198890",
    "user": "leif"
}
```

Concurrent posting (luckily not pushing)...



---

archive/issue_comments_198891.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-05-09T15:24:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198891",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_198892.json:
```json
{
    "body": "The whole listing of packages is also made hideously complicated by mashing old and new style packages together...",
    "created_at": "2015-05-09T15:26:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198892",
    "user": "vbraun"
}
```

The whole listing of packages is also made hideously complicated by mashing old and new style packages together...



---

archive/issue_comments_198893.json:
```json
{
    "body": "I thought of just adding a further `try: ... except HTTPError: ...`, in case `sagemath.org/packages/` remains for a while.  (IIRC it had *both* for a while.)\n\n`PKG_SERVER` is superfluous anyway; I'd simply use `os.environ['SAGE_SERVER']` there.",
    "created_at": "2015-05-09T15:29:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198893",
    "user": "leif"
}
```

I thought of just adding a further `try: ... except HTTPError: ...`, in case `sagemath.org/packages/` remains for a while.  (IIRC it had *both* for a while.)

`PKG_SERVER` is superfluous anyway; I'd simply use `os.environ['SAGE_SERVER']` there.



---

archive/issue_comments_198894.json:
```json
{
    "body": "Replying to [comment:69 vbraun]:\n> The whole listing of packages is also made hideously complicated by mashing old and new style packages together...\n\nAs I said, in principle only the old standard packages disturb a bit; otherwise it's just a matter of syncing.\n\nI was actually working on that a few days ago (#16759).",
    "created_at": "2015-05-09T15:33:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198894",
    "user": "leif"
}
```

Replying to [comment:69 vbraun]:
> The whole listing of packages is also made hideously complicated by mashing old and new style packages together...

As I said, in principle only the old standard packages disturb a bit; otherwise it's just a matter of syncing.

I was actually working on that a few days ago (#16759).



---

archive/issue_comments_198895.json:
```json
{
    "body": "Quoting [ticket:16759#comment:2 jdemeyer]:\n> Replying to [ticket:16759#comment:1 jhpalmieri]:\n> > It also looks like `sage --standard` is broken: it is using old package information.\n> I would say that `sage --standard` is doing the right thing, but somehow `http://www.sagemath.org/packages/standard/` is no longer updated. The right solution is updating the website script to take into account the new git-style packages (which is certainly a different issue than the one this ticket is about).",
    "created_at": "2015-05-09T15:42:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198895",
    "user": "leif"
}
```

Quoting [ticket:16759#comment:2 jdemeyer]:
> Replying to [ticket:16759#comment:1 jhpalmieri]:
> > It also looks like `sage --standard` is broken: it is using old package information.
> I would say that `sage --standard` is doing the right thing, but somehow `http://www.sagemath.org/packages/standard/` is no longer updated. The right solution is updating the website script to take into account the new git-style packages (which is certainly a different issue than the one this ticket is about).



---

archive/issue_comments_198896.json:
```json
{
    "body": "Since I'm CCed: There is currently a move of the whole infrastructure going on. Before that I tried to keep everything compatible with the original system from a long time ago. That's no longer possible. Long story short: the website and the binary-files need to be untangled and that means there are no longer chains of symlink-aliases. Hence, don't use the `/mirror` subdirectory of the website and I hope the essence of this ticket is to get rid of this old dependence. The only mirror related aspect is the `mirror_list` file for the base URLs.",
    "created_at": "2015-05-09T16:06:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198896",
    "user": "schilly"
}
```

Since I'm CCed: There is currently a move of the whole infrastructure going on. Before that I tried to keep everything compatible with the original system from a long time ago. That's no longer possible. Long story short: the website and the binary-files need to be untangled and that means there are no longer chains of symlink-aliases. Hence, don't use the `/mirror` subdirectory of the website and I hope the essence of this ticket is to get rid of this old dependence. The only mirror related aspect is the `mirror_list` file for the base URLs.



---

archive/issue_comments_198897.json:
```json
{
    "body": "Replying to [comment:73 schilly]:\n> Since I'm CCed: There is currently a move of the whole infrastructure going on. Before that I tried to keep everything compatible with the original system from a long time ago. That's no longer possible. Long story short: the website and the binary-files need to be untangled and that means there are no longer chains of symlink-aliases. Hence, don't use the `/mirror` subdirectory of the website and I hope the essence of this ticket is to get rid of this old dependence. The only mirror related aspect is the `mirror_list` file for the base URLs.\n\nWell, the Sage scripts never used the `mirror/` folder.  The problematic part here is the structure below the base URL; `spkg/` was changed to `packages` on sagemath.org, but the mirrors all have the classical structure (plus `upstream/` below `spkg/`).\n\nThe new thing on this ticket is also that we now use [http://www.sagemath.org/mirror_list](http://www.sagemath.org/mirror_list) (currently hardcoded) again, which is periodically generated by a script on the server (or at least used to be).",
    "created_at": "2015-05-09T16:39:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198897",
    "user": "leif"
}
```

Replying to [comment:73 schilly]:
> Since I'm CCed: There is currently a move of the whole infrastructure going on. Before that I tried to keep everything compatible with the original system from a long time ago. That's no longer possible. Long story short: the website and the binary-files need to be untangled and that means there are no longer chains of symlink-aliases. Hence, don't use the `/mirror` subdirectory of the website and I hope the essence of this ticket is to get rid of this old dependence. The only mirror related aspect is the `mirror_list` file for the base URLs.

Well, the Sage scripts never used the `mirror/` folder.  The problematic part here is the structure below the base URL; `spkg/` was changed to `packages` on sagemath.org, but the mirrors all have the classical structure (plus `upstream/` below `spkg/`).

The new thing on this ticket is also that we now use [http://www.sagemath.org/mirror_list](http://www.sagemath.org/mirror_list) (currently hardcoded) again, which is periodically generated by a script on the server (or at least used to be).



---

archive/issue_comments_198898.json:
```json
{
    "body": "Harald, also note Jeroen's comment I quoted [comment:72 above].\n\nMeanwhile, it's not just standard packages, but also optional packages, of which (only) some now have the \"new style\", i.e., the data of newer ones is hardcoded into the Sage releases, while obsolete \"old-style\" packages remain in `spkg/optional/list` (and `spkg/optional/`).\n\n`./sage --optional` shows some examples of optional packages which became standard:\n\n```\nOptional packages:\n\n...\ngit-1.7.12.2.p0 ........................ installed version: 2.3.0\n...\npyzmq-2.1.11.p1 ........................ installed version: 14.3.0\n...\nzeromq-3.2.0.p0 ........................ installed version: 4.0.5\n```\n\n\nThere are other still optional packages where `sage -i ...` would install newer versions than listed by `sage --optional` because the \"local metadata\" (`$SAGE_ROOT/build/pkgs/<package>/package-version.txt`) differs from what `spkg/optional/list` gives.  (Same issue as with our current standard packages.)\n\nA more funny one is TOPCOM:\n\n`./sage -i TOPCOM` installs the \"legacy\" spkg, while `./sage -i topcom` installs the \"new-style\" spkg.  (The package versions are currently still the same though, modulo a `.p0` for the \"new-style\" one.)",
    "created_at": "2015-05-09T17:14:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198898",
    "user": "leif"
}
```

Harald, also note Jeroen's comment I quoted [comment:72 above].

Meanwhile, it's not just standard packages, but also optional packages, of which (only) some now have the "new style", i.e., the data of newer ones is hardcoded into the Sage releases, while obsolete "old-style" packages remain in `spkg/optional/list` (and `spkg/optional/`).

`./sage --optional` shows some examples of optional packages which became standard:

```
Optional packages:

...
git-1.7.12.2.p0 ........................ installed version: 2.3.0
...
pyzmq-2.1.11.p1 ........................ installed version: 14.3.0
...
zeromq-3.2.0.p0 ........................ installed version: 4.0.5
```


There are other still optional packages where `sage -i ...` would install newer versions than listed by `sage --optional` because the "local metadata" (`$SAGE_ROOT/build/pkgs/<package>/package-version.txt`) differs from what `spkg/optional/list` gives.  (Same issue as with our current standard packages.)

A more funny one is TOPCOM:

`./sage -i TOPCOM` installs the "legacy" spkg, while `./sage -i topcom` installs the "new-style" spkg.  (The package versions are currently still the same though, modulo a `.p0` for the "new-style" one.)



---

archive/issue_comments_198899.json:
```json
{
    "body": "We definitely should not check sagemath.org/packages any more, I've already changed the release management scripts to no longer put the tarballs there.",
    "created_at": "2015-05-09T18:08:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198899",
    "user": "vbraun"
}
```

We definitely should not check sagemath.org/packages any more, I've already changed the release management scripts to no longer put the tarballs there.



---

archive/issue_comments_198900.json:
```json
{
    "body": "Replying to [comment:76 vbraun]:\n> We definitely should not check sagemath.org/packages any more, I've already changed the release management scripts to no longer put the tarballs there.\n\nOk, `sagemath.org/spkg/`* gave a 404 for a while, but apparently works again.",
    "created_at": "2015-05-09T18:30:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198900",
    "user": "leif"
}
```

Replying to [comment:76 vbraun]:
> We definitely should not check sagemath.org/packages any more, I've already changed the release management scripts to no longer put the tarballs there.

Ok, `sagemath.org/spkg/`* gave a 404 for a while, but apparently works again.



---

archive/issue_comments_198901.json:
```json
{
    "body": "**Note for other reviewers:**  So far I'm ok with the changes/corrections made, but haven't yet tested thoroughly enough (I think).\n\nWhile I don't like completely changing the previously *generic* character of `sage-download-file` (nor removing the \"shell fallback\" with e.g. `wget` or `curl` if Python isn't available or functional), I strongly doubt we could convince the author or the RM to change that back to how it was.\n\nFTP support (probably with Python3) and e.g. usage of a static mirror list (perhaps to be shipped with Sage) is something for follow-up tickets; the broken behaviour of `sage-list-packages` is (or will be) dealt with at #16759, which depends on *this* ticket.\n\n\n\n\nW.r.t. the threat of losing sagemath.org for downloads:  [According to William](http://article.gmane.org/gmane.comp.mathematics.sage.devel/79645), *\"soon\" is not **that** soon*.",
    "created_at": "2015-05-10T15:03:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198901",
    "user": "leif"
}
```

**Note for other reviewers:**  So far I'm ok with the changes/corrections made, but haven't yet tested thoroughly enough (I think).

While I don't like completely changing the previously *generic* character of `sage-download-file` (nor removing the "shell fallback" with e.g. `wget` or `curl` if Python isn't available or functional), I strongly doubt we could convince the author or the RM to change that back to how it was.

FTP support (probably with Python3) and e.g. usage of a static mirror list (perhaps to be shipped with Sage) is something for follow-up tickets; the broken behaviour of `sage-list-packages` is (or will be) dealt with at #16759, which depends on *this* ticket.




W.r.t. the threat of losing sagemath.org for downloads:  [According to William](http://article.gmane.org/gmane.comp.mathematics.sage.devel/79645), *"soon" is not **that** soon*.



---

archive/issue_comments_198902.json:
```json
{
    "body": "I don't mind if you rewrite the functionality in bash fwiw. I would consider it utterly retarded and backward, but as long as it works and you are committed to maintaining that solution then that would be fine with me.",
    "created_at": "2015-05-10T15:06:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198902",
    "user": "vbraun"
}
```

I don't mind if you rewrite the functionality in bash fwiw. I would consider it utterly retarded and backward, but as long as it works and you are committed to maintaining that solution then that would be fine with me.



---

archive/issue_comments_198903.json:
```json
{
    "body": "Replying to [comment:77 leif]:\n> Ok, `sagemath.org/spkg/`* gave a 404 for a while, but apparently works again.\n\nUhm, to reduce that confusion a little bit: The source of this inconsistency is that right now most of the old infrastructure is still running, including the currently \"old\" website. I would suggest to wait until the \"new\" website is operational. Then, any bugs in scripts relying on the website will be obvious (and fixes to the new website visible immediately).\n\nThe reason why this is a bit slow is, because there are many links assuming certain subdirectories (for documentation and e.g. /mirror/) and my time is limited. I could report back once the DNS entry has switched to the new page.\n\nPS: \"new\" just means, that there are minor changes like an additional mirror, publications etc. The current \"old\" website is an older fork of the website with some other patches. Hence this diverged and there is no need to support the old one any more.",
    "created_at": "2015-05-10T15:14:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198903",
    "user": "schilly"
}
```

Replying to [comment:77 leif]:
> Ok, `sagemath.org/spkg/`* gave a 404 for a while, but apparently works again.

Uhm, to reduce that confusion a little bit: The source of this inconsistency is that right now most of the old infrastructure is still running, including the currently "old" website. I would suggest to wait until the "new" website is operational. Then, any bugs in scripts relying on the website will be obvious (and fixes to the new website visible immediately).

The reason why this is a bit slow is, because there are many links assuming certain subdirectories (for documentation and e.g. /mirror/) and my time is limited. I could report back once the DNS entry has switched to the new page.

PS: "new" just means, that there are minor changes like an additional mirror, publications etc. The current "old" website is an older fork of the website with some other patches. Hence this diverged and there is no need to support the old one any more.



---

archive/issue_comments_198904.json:
```json
{
    "body": "Replying to [comment:80 schilly]:\n> I could report back once the DNS entry has switched to the new page.\n\nETA Hausnummer?\n\n\n> PS: \"new\" just means, that there are minor changes like an additional mirror, publications etc. The current \"old\" website is an older fork of the website with some other patches. Hence this diverged and there is no need to support the old one any more.\n\nCould we already test the new one (using its unofficial address) w.r.t. download stuff / package (and mirror) lists?",
    "created_at": "2015-05-10T15:26:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198904",
    "user": "leif"
}
```

Replying to [comment:80 schilly]:
> I could report back once the DNS entry has switched to the new page.

ETA Hausnummer?


> PS: "new" just means, that there are minor changes like an additional mirror, publications etc. The current "old" website is an older fork of the website with some other patches. Hence this diverged and there is no need to support the old one any more.

Could we already test the new one (using its unofficial address) w.r.t. download stuff / package (and mirror) lists?



---

archive/issue_comments_198905.json:
```json
{
    "body": "The attached branch will only use www.sagemath.org to download the mirror list, so once we have merged it there are a lot fewer things that could break.",
    "created_at": "2015-05-10T15:32:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198905",
    "user": "vbraun"
}
```

The attached branch will only use www.sagemath.org to download the mirror list, so once we have merged it there are a lot fewer things that could break.



---

archive/issue_comments_198906.json:
```json
{
    "body": "Replying to [comment:81 leif]:\n> ETA Hausnummer?\n\nFriday. It's tedious stupid work, so maybe I'm already whining more about it than it will actually take to work on.\n\n> Could we already test the new one (using its unofficial address) w.r.t. download stuff / package (and mirror) lists?\n\nNo, Github resolves the inofficial URL to the official one and I don't want to mess with this around even more.",
    "created_at": "2015-05-10T15:33:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198906",
    "user": "schilly"
}
```

Replying to [comment:81 leif]:
> ETA Hausnummer?

Friday. It's tedious stupid work, so maybe I'm already whining more about it than it will actually take to work on.

> Could we already test the new one (using its unofficial address) w.r.t. download stuff / package (and mirror) lists?

No, Github resolves the inofficial URL to the official one and I don't want to mess with this around even more.



---

archive/issue_comments_198907.json:
```json
{
    "body": "Replying to [comment:82 vbraun]:\n> The attached branch will only use www.sagemath.org to download the mirror list ...\n\nYes, it's just one file, and as already mentioned: the full list could easily be hardcoded as a backup into Sage to remove that SPOF. Ticket for later please :-)",
    "created_at": "2015-05-10T15:35:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198907",
    "user": "schilly"
}
```

Replying to [comment:82 vbraun]:
> The attached branch will only use www.sagemath.org to download the mirror list ...

Yes, it's just one file, and as already mentioned: the full list could easily be hardcoded as a backup into Sage to remove that SPOF. Ticket for later please :-)



---

archive/issue_comments_198908.json:
```json
{
    "body": "Replying to [comment:82 vbraun]:\n> once we have merged it there are a lot fewer things that could break.\n\nProvided the mirrors can still sync...\n\n\n\n\nIn principle we could already include a snapshot of `mirror_list` into the git tree (in `$SAGE_ROOT/`?  in more human-readable form?).  The dynamic one should rather be located in `$SAGE_ROOT/local/var/{lib,tmp}/sage/`, say, not `$SAGE_DIST_FILES/` (defaults to `$SAGE_ROOT/upstream/`).",
    "created_at": "2015-05-10T16:25:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198908",
    "user": "leif"
}
```

Replying to [comment:82 vbraun]:
> once we have merged it there are a lot fewer things that could break.

Provided the mirrors can still sync...




In principle we could already include a snapshot of `mirror_list` into the git tree (in `$SAGE_ROOT/`?  in more human-readable form?).  The dynamic one should rather be located in `$SAGE_ROOT/local/var/{lib,tmp}/sage/`, say, not `$SAGE_DIST_FILES/` (defaults to `$SAGE_ROOT/upstream/`).



---

archive/issue_comments_198909.json:
```json
{
    "body": "Nothing else needs the mirror list so why put it in a separate file? In any case, this question should be dealt with in a separate ticket.",
    "created_at": "2015-05-10T20:12:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198909",
    "user": "vbraun"
}
```

Nothing else needs the mirror list so why put it in a separate file? In any case, this question should be dealt with in a separate ticket.



---

archive/issue_comments_198910.json:
```json
{
    "body": "Replying to [comment:86 vbraun]:\n> Nothing else needs the mirror list\n\nHuman users perhaps?\n\n> so why put it in a separate file?\n\nYou're right, all package metadata should be moved into `sage-spkg` as well.",
    "created_at": "2015-05-10T20:26:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198910",
    "user": "leif"
}
```

Replying to [comment:86 vbraun]:
> Nothing else needs the mirror list

Human users perhaps?

> so why put it in a separate file?

You're right, all package metadata should be moved into `sage-spkg` as well.



---

archive/issue_comments_198911.json:
```json
{
    "body": "There are many packages but only one mirror list. Your argument is invalid.\n\nNot to mention the question of what file format, custom = crap, json = not exactly human-readable, yaml = not necessarily available in the System python, is it supposed to be readable from a shell script, ...",
    "created_at": "2015-05-11T08:05:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198911",
    "user": "vbraun"
}
```

There are many packages but only one mirror list. Your argument is invalid.

Not to mention the question of what file format, custom = crap, json = not exactly human-readable, yaml = not necessarily available in the System python, is it supposed to be readable from a shell script, ...



---

archive/issue_comments_198912.json:
```json
{
    "body": "Plain text, one URL per line, preferably in the top-level folder.  What's the problem?\n\nAny human and any kind of script can easily read such.  (If you want to add further data such as organization, location etc., just put that after each URL, seperated by whitespace, but I wouldn't even do that.  We don't have to process that.  Blank lines and comment lines starting with `#` at the first position would IMHO be ok, too, but that's not really needed.  Order of the mirrors doesn't matter for our purposes either, although we could keep them sorted by continent, say.) \n\nI thought we had postponed that to a follow-up ticket.",
    "created_at": "2015-05-11T08:48:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198912",
    "user": "leif"
}
```

Plain text, one URL per line, preferably in the top-level folder.  What's the problem?

Any human and any kind of script can easily read such.  (If you want to add further data such as organization, location etc., just put that after each URL, seperated by whitespace, but I wouldn't even do that.  We don't have to process that.  Blank lines and comment lines starting with `#` at the first position would IMHO be ok, too, but that's not really needed.  Order of the mirrors doesn't matter for our purposes either, although we could keep them sorted by continent, say.) 

I thought we had postponed that to a follow-up ticket.



---

archive/issue_comments_198913.json:
```json
{
    "body": "Replying to [comment:89 leif]:\n> I thought we had postponed that to a follow-up ticket.\n\nWe have, but you keep bringing it up.",
    "created_at": "2015-05-11T09:06:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198913",
    "user": "vbraun"
}
```

Replying to [comment:89 leif]:
> I thought we had postponed that to a follow-up ticket.

We have, but you keep bringing it up.



---

archive/issue_comments_198914.json:
```json
{
    "body": "Replying to [comment:90 vbraun]:\n> you keep bringing it up.\n\nNot me, [comment:84 Harald] did.",
    "created_at": "2015-05-11T09:22:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198914",
    "user": "leif"
}
```

Replying to [comment:90 vbraun]:
> you keep bringing it up.

Not me, [comment:84 Harald] did.



---

archive/issue_comments_198915.json:
```json
{
    "body": "Replying to [comment:81 leif]:\n> Replying to [comment:80 schilly]:\n> > I could report back once the DNS entry has switched to the new page.\n> \n> ETA Hausnummer?\n\nYay! 2 days ahead of schedule! I fixed all the obviously broken links and there are just two minor details left.",
    "created_at": "2015-05-13T19:16:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198915",
    "user": "schilly"
}
```

Replying to [comment:81 leif]:
> Replying to [comment:80 schilly]:
> > I could report back once the DNS entry has switched to the new page.
> 
> ETA Hausnummer?

Yay! 2 days ahead of schedule! I fixed all the obviously broken links and there are just two minor details left.



---

archive/issue_comments_198916.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-05-13T19:17:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198916",
    "user": "vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_198917.json:
```json
{
    "body": "Replying to [comment:92 schilly]:\n> Replying to [comment:81 leif]:\n> > Replying to [comment:80 schilly]:\n> > > I could report back once the DNS entry has switched to the new page.\n> > \n> > ETA Hausnummer?\n> \n> Yay! 2 days ahead of schedule! I fixed all the obviously broken links and there are just two minor details left.\n\nsagemath.org no longer serves packages (especially not the upstream tarballs); is that intentional, or will it again?  (Cf. [sage-release](http://thread.gmane.org/gmane.comp.mathematics.sage.release/2834).)",
    "created_at": "2015-05-13T19:32:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198917",
    "user": "leif"
}
```

Replying to [comment:92 schilly]:
> Replying to [comment:81 leif]:
> > Replying to [comment:80 schilly]:
> > > I could report back once the DNS entry has switched to the new page.
> > 
> > ETA Hausnummer?
> 
> Yay! 2 days ahead of schedule! I fixed all the obviously broken links and there are just two minor details left.

sagemath.org no longer serves packages (especially not the upstream tarballs); is that intentional, or will it again?  (Cf. [sage-release](http://thread.gmane.org/gmane.comp.mathematics.sage.release/2834).)



---

archive/issue_comments_198918.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-05-13T20:11:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15405",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15405#issuecomment-198918",
    "user": "vbraun"
}
```

Resolution: fixed
