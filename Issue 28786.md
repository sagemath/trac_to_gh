# Issue 28786: In a python 3 build, use system Python packages

Issue created by migration from https://trac.sagemath.org/ticket/29023

Original creator: mkoeppe

Original creation time: 2020-01-15 23:48:55

CC:  thansen tmonteil mjo @timokau fbissey isuruf mmezzarobba embray dimpase @thierry-freebsd @dkwo

This is a followup on 
- #29013: In a python3 build, install all Python packages into a venv
- #27824: `spkg-configure.m4` for python3

In the next step, we enable use of system site packages.


---

Comment by @Volker-Weissmann created at 2020-04-05 18:21:36

I think there should be an option to disable the use of system packages. Sage's installation is already compilcated enough and I don't want a faulty package to mess up sage.


---

Comment by jhpalmieri created at 2020-04-05 18:27:49

You can already do `./configure --with-system-python3=no` to avoid using the system's Python. Are you asking for something which allows the use of the system Python but not the system Python packages? Is it likely that there will be a good system Python installation which has faulty Python packages?


---

Comment by @Volker-Weissmann created at 2020-04-05 18:32:29

I just found out about the ./configure --help option. --with-system-python3 is actually exactly what I meant.


---

Comment by mkoeppe created at 2020-04-05 20:10:17

Replying to [comment:1 gh-Volker-Weissmann]:
> I think there should be an option to disable the use of system packages. Sage's installation is already compilcated enough and I don't want a faulty package to mess up sage.
Thanks for the input. I've updated the ticket description.


---

Comment by thansen created at 2020-04-17 06:46:46

I think once python system packages are detected, the spkg-configure mechanism becomes interesting for packagers. Looking forward to this change.


---

Comment by mkoeppe created at 2020-04-17 18:49:46

I don't think python packages would be handled through spkg-configure. 
I think it's better to turn sagelib into a pip-installable package and provide standard prereq information -- see #29041 (at ./bootstrap time, generate src/requirements.txt, src/constraints.txt, src/setup.cfg [install_requires] from build/pkgs)


---

Comment by @thierry-FreeBSD created at 2020-05-08 14:48:35

I tried to create an experimental `spkg-configure.m4` for cvxopt in #29665, and it seems OK for me. Any comments?


---

Comment by @Volker-Weissmann created at 2020-05-08 14:57:14

If you take look at sage-env you see the line 

PYTHONUSERBASE="$DOT_SAGE/local"

but I think it should be

PYTHONUSERBASE="$SAGE_ROOT/local"

, because (at least on my machine) the folder $DOT_SAGE/local does not exist.


---

Comment by mkoeppe created at 2020-05-08 14:59:04

The way to enable system site packages is to use `--system-site-packages` when creating the venv.

Using PYTHONUSERBASE is not a suitable way forward.


---

Comment by mkoeppe created at 2020-05-08 14:59:59

(And neither is an ad-hoc modification of PYTHONPATH proposed in #29665.)


---

Comment by mkoeppe created at 2020-05-08 15:06:31

Replying to [comment:10 gh-Volker-Weissmann]:
> the folder $DOT_SAGE/local does not exist.

Users create this folder if they want to install user packages, for example using `sage -pip install --user ...`


---

Comment by @Volker-Weissmann created at 2020-05-08 15:14:21

Ok. Thank you. I thought it was a bug. But this means that if you run

sudo pip uninstall cython
pip install cython

cou can't build sage.


---

Comment by mkoeppe created at 2020-05-08 15:26:09

Well, isolating the Sage user installation scheme from the Python user installation scheme was done deliberately in the past to avoid possible breakage by incompatible installations.

This decision may have to be revisited at some point, but I don't think it's necessary for this ticket. 

Sage's install scripts will continue to make sure that the Sage venv has all necessary packages - whether user of system site packages is enabled or not.


---

Comment by mkoeppe created at 2020-05-08 15:33:41

Just a quick note that I plan to work on this for Sage 9.3, not earlier.


---

Comment by @Volker-Weissmann created at 2020-05-08 16:13:16

Replying to [comment:15 mkoeppe]:
> Well, isolating the Sage user installation scheme from the Python user installation scheme was done deliberately in the past to avoid possible breakage by incompatible installations.

It's not always easy to know what the programmers thought. What is the best source to learn things like this? Reading the tickets?


---

Comment by mkoeppe created at 2020-05-08 16:19:06

That, and asking questions on the sage-devel list, I suppose.


---

Comment by mkoeppe created at 2020-05-08 16:20:49

In the case of PYTHONUSERBASE, comments in sage-env point to some relevant tickets.


---

Comment by @Volker-Weissmann created at 2020-05-08 16:28:03

Thank you.


---

Comment by mkoeppe created at 2020-06-05 18:12:13

Before it makes sense to work on this, we should update all Python packages (#29141); in particular, `setuptools`, `pip`, ... (#29803)


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.
