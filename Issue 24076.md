# Issue 24076: py3: fixes to sage.misc.temporary_file

Issue created by migration from https://trac.sagemath.org/ticket/24313

Original creator: embray

Original creation time: 2017-12-01 15:37:26

This updates the `atomic_write` context manager to work in both "text" and "binary" modes on Python 3, and fixes a few of the module's tests so that they pass on Python 3.


---

Comment by embray created at 2017-12-01 15:37:51

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2017-12-04 10:14:27

Could you cook up doctests for
 - usage of `binary`
 - usage of `encoding`
 - checking that `binary=True` is ignored when an encoding is provided


---

Comment by jdemeyer created at 2017-12-04 10:35:41

Instead of the `encoding` argument, I would rather allow arbitrary `**kwds`.


---

Comment by jdemeyer created at 2017-12-04 10:35:41

Changing status from needs_review to needs_work.


---

Comment by embray created at 2017-12-04 13:31:08

Replying to [comment:3 jdemeyer]:
> Instead of the `encoding` argument, I would rather allow arbitrary `**kwds`.

Could you clarify that?  I don't see how that's useful.  It should be noted that this function passes some arguments to both `TemporaryFile` and `open()`, and the former does _not_ accept all the same arguments as the latter (it should, which I think is a defect, but it doesn't).  It also requires special handling depending on whether on Python 2 or 3 anyways.

+1 to adding more tests though.


---

Comment by jdemeyer created at 2017-12-04 13:43:52

Replying to [comment:4 embray]:
> Replying to [comment:3 jdemeyer]:
> > Instead of the `encoding` argument, I would rather allow arbitrary `**kwds`.
> 
> Could you clarify that?  I don't see how that's useful.  It should be noted that this function passes some arguments to both `TemporaryFile` and `open()`, and the former does _not_ accept all the same arguments as the latter.

1. There are several keywords which are accepted by both `open()` and `TemporaryFile()`. If you allow customizing `encoding`, I don't see why you shouldn't allow customize `newline` for example.

2. Python already `encoding=locale.getpreferredencoding()` as default, there is no reason to reimplement handling that as default.

3. I find it conceptually simpler to simply pass `**kwds` unmodified instead of explicitly handling a specific `encoding` keyword.


---

Comment by embray created at 2017-12-04 14:19:17

Replying to [comment:5 jdemeyer]:
> Replying to [comment:4 embray]:
> > Replying to [comment:3 jdemeyer]:
> > > Instead of the `encoding` argument, I would rather allow arbitrary `**kwds`.
> > 
> > Could you clarify that?  I don't see how that's useful.  It should be noted that this function passes some arguments to both `TemporaryFile` and `open()`, and the former does _not_ accept all the same arguments as the latter.
> 
> 1. There are several keywords which are accepted by both `open()` and `TemporaryFile()`. If you allow customizing `encoding`, I don't see why you shouldn't allow customize `newline` for example.

Can you suggest some need for anything besides universal newline handling in text mode?

> 2. Python already `encoding=locale.getpreferredencoding()` as default, there is no reason to reimplement handling that as default.

_only_ in text mode.  If you want to be able to support text and binary modes that needs to be done explicitly.  With normal `io.open` this would be done with a mode string, but that's not really applicable for `atomic_write`.

I do agree there's no reason to supply the `locale.getpreferredencoding()`.  I thought that made the code and the intent clearer by explicitly stating what the default is rather than relying on the underlying implementation, but I could remove this if this is the only sticking point.

> 3. I find it conceptually simpler to simply pass `**kwds` unmodified instead of explicitly handling a specific `encoding` keyword.

It really doesn't make sense in this case.  `open` and `TemporaryFile` take different arguments and their use is an implementation detail irrelevant to the API provided by `atomic_write` (which I'm trying to still trying to keep as restricted as possible to meet its narrow use case).


---

Comment by jdemeyer created at 2017-12-04 15:57:45

Replying to [comment:6 embray]:
> Can you suggest some need for anything besides universal newline handling in text mode?

There is no need currently. But I think it is nice design to allow arbitrary arguments. It is narrow-minded to disallow something just because there is currently no use case.

> > 2. Python already `encoding=locale.getpreferredencoding()` as default, there is no reason to reimplement handling that as default.
> 
> _only_ in text mode.

Of course... what's your point? How would you use `encoding` in binary mode? I don't get what you are trying to say...

> It really doesn't make sense in this case.  `open` and `TemporaryFile` take different arguments and their use is an implementation detail irrelevant to the API provided by `atomic_write`

I don't really agree with that. If you are providing an API dealing with files, it makes sense to have an API which is close to what `open()` provides. And explicitly passing `**kwds` does exactly that. It makes it explicit that you're just providing a wrapper around `open()` and `TemporaryFile()`.


---

Comment by embray created at 2017-12-04 16:45:14

>  If you are providing an API dealing with files, it makes sense to have an API which is close to what open() provides.

Not necessarily.  `atomic_write` is not a generic file opening function.  It has only one purpose which is to write files in a narrow context.  Many of the arguments you might pass `open()` don't make sense.  If it did one might have written it that way in the first place, but you (I think?) didn't and for good reason.

Right now this is only adding the bare minimum necessary to achieve the required goals--not exploding the API footprint.


---

Comment by embray created at 2017-12-04 16:46:08

Also again, I'll note, that `TemporaryFile` does not accept all the arguments that `open` does in the first place (in particular it does not accept an argument for encoding error handling--which I would consider an upstream defect).


---

Comment by git created at 2018-01-17 09:38:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-01-17 09:41:10

Part of the problem here was the use of `tempfile.TemporaryFile`, which is incompatible with Jeroen's request (and in thinking about this I think the stdlib is buggy here--`TemporaryFile` should accept arbitrary kwargs to pass to `io.open`, in fact, it doesn't accept an _errors_ argument which is just annoying).

I reworked this a bit to just use `mkstemp` and `io.open` directly.  I think this should make Jeroen happy.


---

Comment by embray created at 2018-01-17 09:41:10

Changing status from needs_work to needs_review.


---

Comment by git created at 2018-01-17 09:43:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-01-22 16:15:29

Looks good to me. Jeroen, your opinion ?


---

Comment by jdemeyer created at 2018-01-22 20:42:35

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-01-22 20:42:35

Replying to [comment:11 embray]:
> I reworked this a bit to just use `mkstemp` and `io.open` directly.  I think this should make Jeroen happy.

That's not actually what the patch does... I see `tmp_filename()` which is Sage-specific thing.

And it's crucial that the temporary file is created in the same directory as the destination file, otherwise the move is not guaranteed to be atomic. In fact it would be good to add the doctests which shows that the file in indeed created in the right directory.


---

Comment by embray created at 2018-01-23 11:20:30

I see what you're saying--originally I did use `mkstemp` directly but then saw `tmp_filename` and thought to use that, neglecting the point about the directory.  I don't think I'll add a test for that though because as long as it's implemented correctly then that's tautological (but it would be helpful if that were documented).


---

Comment by git created at 2018-01-23 11:27:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-01-23 11:28:13

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-01-23 15:54:24

OK, I am essentially happy with this now. Just a few minor points:

1. in the docs, use ```**kwargs``` instead of ```kwargs```.

2. add a test for `**kwargs`

2. add a test for _invalid_ `**kwargs`


---

Comment by chapoton created at 2018-01-24 13:09:50

Changing status from needs_review to needs_work.


---

Comment by embray created at 2018-01-26 16:28:00

Sounds good--will do.


---

Comment by git created at 2018-01-31 17:29:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-01-31 17:37:32

Changing status from needs_work to needs_review.


---

Comment by embray created at 2018-01-31 17:37:32

I think this should do it.


---

Comment by chapoton created at 2018-02-04 19:09:35

the import of locale seems no longer needed


---

Comment by git created at 2018-02-05 09:43:39

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-02-05 09:47:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2018-02-05 09:48:31

I added 2 tiny fixes. If you agree, you (Erik or Frédéric) can set it to positive_review.


---

Comment by embray created at 2018-02-05 13:02:53

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-02-09 08:03:59

Resolution: fixed
