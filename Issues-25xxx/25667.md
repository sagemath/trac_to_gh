# Issue 25667: Keep twisted reference in all.py

archive/issues_025430.json:
```json
{
    "body": "Currently (as of Sage 8.3.beta6), for some reason #25548 keeps the various Sage notebooks from behaving as needed.  We should revert the `src/sage/all.py` part until we get that figured out.\n\nDetails: `sage -n` or other launch of Sage notebook currently brings up the \"SageNBExport\" notebook, which allows conversion of sagenb worksheets to Jupyter.  One option on that page is to simply go to the old sagenb notebook; however, with #25548, that fails to actually open a browser window with the sagenb home page.  I'm not sure whether it is an authentication/token error or something else, but in any case it does not work even though the terminal indicates things are working normally behind the scenes.\n\nGiven that even if/when we switch to Jupyter for all notebook default people will still want the export functionality available, this should definitely be fixed.\n\n**CC:**  @dimpase @fchapoton @vbraun @jdemeyer\n\n**Reviewer:** Dima Pasechnik\n\nIssue created by migration from https://trac.sagemath.org/ticket/25667\n\n",
    "closed_at": "2020-07-02T13:17:52Z",
    "created_at": "2018-06-26T20:55:20Z",
    "labels": [
        "component: notebook",
        "critical",
        "bug",
        "invalid"
    ],
    "title": "Keep twisted reference in all.py",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25667",
    "user": "https://github.com/kcrisman"
}
```
Currently (as of Sage 8.3.beta6), for some reason #25548 keeps the various Sage notebooks from behaving as needed.  We should revert the `src/sage/all.py` part until we get that figured out.

Details: `sage -n` or other launch of Sage notebook currently brings up the "SageNBExport" notebook, which allows conversion of sagenb worksheets to Jupyter.  One option on that page is to simply go to the old sagenb notebook; however, with #25548, that fails to actually open a browser window with the sagenb home page.  I'm not sure whether it is an authentication/token error or something else, but in any case it does not work even though the terminal indicates things are working normally behind the scenes.

Given that even if/when we switch to Jupyter for all notebook default people will still want the export functionality available, this should definitely be fixed.

**CC:**  @dimpase @fchapoton @vbraun @jdemeyer

**Reviewer:** Dima Pasechnik

Issue created by migration from https://trac.sagemath.org/ticket/25667





---

archive/issue_comments_398301.json:
```json
{
    "body": "<a id='comment:2'></a>\nHow about just removing that `option on that page is to simply go to the old sagenb notebook`? An explanation how one should instead explicitly start `sagenb` is already there.",
    "created_at": "2018-06-26T21:15:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25667#issuecomment-398301",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:2'></a>
How about just removing that `option on that page is to simply go to the old sagenb notebook`? An explanation how one should instead explicitly start `sagenb` is already there.



---

archive/issue_comments_398302.json:
```json
{
    "body": "<a id='comment:3'></a>\nI cannot reproduce this. Can you state more precisely what the problem is? What happens on the console and what happens in the browser?",
    "created_at": "2018-06-27T12:16:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25667#issuecomment-398302",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'></a>
I cannot reproduce this. Can you state more precisely what the problem is? What happens on the console and what happens in the browser?



---

archive/issue_comments_398303.json:
```json
{
    "body": "<a id='comment:4'></a>\n\n```\n$ ./sage -n\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 8.3.beta6, Release Date: 2018-06-17               \u2502\n\u2502 Type \"notebook()\" for the browser-based notebook interface.        \u2502\n\u2502 Type \"help()\" for help.                                            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250f\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2513\n\u2503 Warning: this is a prerelease version, and it may be unstable.     \u2503\n\u2517\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u251b\nPlease wait while the SageNB export server starts...\n[I 22:20:36.409 NotebookApp] Using MathJax: nbextensions/mathjax/MathJax.js\n[I 22:20:51.609 NotebookApp] Serving notebooks from local directory: /Users/karl.crisman/Downloads/sage\n[I 22:20:51.609 NotebookApp] 0 active kernels\n[I 22:20:51.609 NotebookApp] The Jupyter Notebook is running at:\n[I 22:20:51.609 NotebookApp] http://localhost:8888/?token=3c0b141dc2e03e462e6a4f1ee14820805e946ecd36eea489\n[I 22:20:51.610 NotebookApp] Use Control-C to stop this server and shut down all kernels (twice to skip confirmation).\n[C 22:20:51.613 NotebookApp] \n    \n    Copy/paste this URL into your browser when you connect for the first time,\n    to login with a token:\n        http://localhost:8888/?token=3c0b141dc2e03e462e6a4f1ee14820805e946ecd36eea489\n[I 22:20:52.449 NotebookApp] Accepting one-time-token-authenticated connection from ::1\n```\nAt this point\n\n```\nhttp://localhost:8888/sagenb?token=50867943df437ff4c97ae71d01bfed7a9f67450553b1f2f3\n```\nopens up in the browser, which is the exporter.  Clicking \"Run the old Sage notebook\" goes to\n\n```\nhttp://localhost:8888/sagenb/www/run-sagenb.html\n```\nin the same window, and runs in terminal\n\n```\n('The notebook files are stored in:', 'sage_notebook.sagenb')\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                                                \u2502\n\u2502 Open your web browser to http://localhost:8080 \u2502\n\u2502                                                \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\nExecuting twistd  --pidfile=\"sage_notebook.sagenb/sagenb.pid\" -ny \"sage_notebook.sagenb/twistedconf.tac\"\n/Users/.../sage/local/lib/python2.7/site-packages/Crypto/Util/number.py:57: PowmInsecureWarning: Not using mpz_powm_sec.  You should rebuild using libgmp >= 5 to avoid timing attack vulnerability.\n  _warn(\"Not using mpz_powm_sec.  You should rebuild using libgmp >= 5 to avoid timing attack vulnerability.\", PowmInsecureWarning)\n2018-06-27T22:22:16-0400 [-] Loading sage_notebook.sagenb/twistedconf.tac...\n2018-06-27T22:22:23-0400 [-] Loaded.\n2018-06-27T22:22:23-0400 [twisted.scripts._twistd_unix.UnixAppLogger#info] twistd 16.3.0 (/Users/.../sage/local/bin/python2 2.7.15) starting up.\n2018-06-27T22:22:23-0400 [twisted.scripts._twistd_unix.UnixAppLogger#info] reactor class: twisted.internet.selectreactor.SelectReactor.\n2018-06-27T22:22:23-0400 [-] QuietSite starting on 8080\n2018-06-27T22:22:23-0400 [__builtin__.QuietSite#info] Starting factory <__builtin__.QuietSite instance at 0x1be307a70>\n```\nNote that \n\n```\nhttp://localhost:8080\n```\ndoes show the login screen if one opens a new tab and types it in.  But ... there is no sign of the auto-login for sagenb despite the message \"Please wait a few seconds...\"  But there should be such auto-login, and there was, and reverting that part of #25548 brings back this (correct) behavior.\n\n---\n\nFor the sake of argument, if one did remove that option as suggested in [comment:2](#comment%3A2) one could give very explicit instructions as currently at http://localhost:8888/sagenb/www/run-sagenb.html but I don't know that I would recommend that yet because it is the only way to access sagenb \"for dummies\" at this point outside the Mac app.",
    "created_at": "2018-06-28T02:27:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25667#issuecomment-398303",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:4'></a>

```
$ ./sage -n
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 8.3.beta6, Release Date: 2018-06-17               │
│ Type "notebook()" for the browser-based notebook interface.        │
│ Type "help()" for help.                                            │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
Please wait while the SageNB export server starts...
[I 22:20:36.409 NotebookApp] Using MathJax: nbextensions/mathjax/MathJax.js
[I 22:20:51.609 NotebookApp] Serving notebooks from local directory: /Users/karl.crisman/Downloads/sage
[I 22:20:51.609 NotebookApp] 0 active kernels
[I 22:20:51.609 NotebookApp] The Jupyter Notebook is running at:
[I 22:20:51.609 NotebookApp] http://localhost:8888/?token=3c0b141dc2e03e462e6a4f1ee14820805e946ecd36eea489
[I 22:20:51.610 NotebookApp] Use Control-C to stop this server and shut down all kernels (twice to skip confirmation).
[C 22:20:51.613 NotebookApp] 
    
    Copy/paste this URL into your browser when you connect for the first time,
    to login with a token:
        http://localhost:8888/?token=3c0b141dc2e03e462e6a4f1ee14820805e946ecd36eea489
[I 22:20:52.449 NotebookApp] Accepting one-time-token-authenticated connection from ::1
```
At this point

```
http://localhost:8888/sagenb?token=50867943df437ff4c97ae71d01bfed7a9f67450553b1f2f3
```
opens up in the browser, which is the exporter.  Clicking "Run the old Sage notebook" goes to

```
http://localhost:8888/sagenb/www/run-sagenb.html
```
in the same window, and runs in terminal

```
('The notebook files are stored in:', 'sage_notebook.sagenb')
┌────────────────────────────────────────────────┐
│                                                │
│ Open your web browser to http://localhost:8080 │
│                                                │
└────────────────────────────────────────────────┘
Executing twistd  --pidfile="sage_notebook.sagenb/sagenb.pid" -ny "sage_notebook.sagenb/twistedconf.tac"
/Users/.../sage/local/lib/python2.7/site-packages/Crypto/Util/number.py:57: PowmInsecureWarning: Not using mpz_powm_sec.  You should rebuild using libgmp >= 5 to avoid timing attack vulnerability.
  _warn("Not using mpz_powm_sec.  You should rebuild using libgmp >= 5 to avoid timing attack vulnerability.", PowmInsecureWarning)
2018-06-27T22:22:16-0400 [-] Loading sage_notebook.sagenb/twistedconf.tac...
2018-06-27T22:22:23-0400 [-] Loaded.
2018-06-27T22:22:23-0400 [twisted.scripts._twistd_unix.UnixAppLogger#info] twistd 16.3.0 (/Users/.../sage/local/bin/python2 2.7.15) starting up.
2018-06-27T22:22:23-0400 [twisted.scripts._twistd_unix.UnixAppLogger#info] reactor class: twisted.internet.selectreactor.SelectReactor.
2018-06-27T22:22:23-0400 [-] QuietSite starting on 8080
2018-06-27T22:22:23-0400 [__builtin__.QuietSite#info] Starting factory <__builtin__.QuietSite instance at 0x1be307a70>
```
Note that 

```
http://localhost:8080
```
does show the login screen if one opens a new tab and types it in.  But ... there is no sign of the auto-login for sagenb despite the message "Please wait a few seconds..."  But there should be such auto-login, and there was, and reverting that part of #25548 brings back this (correct) behavior.

---

For the sake of argument, if one did remove that option as suggested in [comment:2](#comment%3A2) one could give very explicit instructions as currently at http://localhost:8888/sagenb/www/run-sagenb.html but I don't know that I would recommend that yet because it is the only way to access sagenb "for dummies" at this point outside the Mac app.



---

archive/issue_comments_398304.json:
```json
{
    "body": "<a id='comment:5'></a>\nAgain to clarify things, can you post the branch which fixes that problem for you? And please double-check that it doesn't work without your patch and that it works with your patch (making sure to give sagenb enough time to actually start up, the \"few seconds\" may be optimistic).",
    "created_at": "2018-06-28T03:58:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25667#issuecomment-398304",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>
Again to clarify things, can you post the branch which fixes that problem for you? And please double-check that it doesn't work without your patch and that it works with your patch (making sure to give sagenb enough time to actually start up, the "few seconds" may be optimistic).



---

archive/issue_comments_398305.json:
```json
{
    "body": "<a id='comment:6'></a>\nThis seems to work again for me with 8.3.beta8, at least on one machine.\n\nPlease double check the failure with 8.3.beta8.",
    "created_at": "2018-07-01T07:52:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25667#issuecomment-398305",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:6'></a>
This seems to work again for me with 8.3.beta8, at least on one machine.

Please double check the failure with 8.3.beta8.



---

archive/issue_events_231957.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-07-01T08:01:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "label": "needs info",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25667#event-231957"
}
```



---

archive/issue_comments_398306.json:
```json
{
    "body": "<a id='comment:8'></a>\nbeta8 did not work either.  Reverting \n\n```\n-    # stop the twisted reactor\n-    try:\n-       from twisted.internet import reactor\n-       if reactor.running:\n-          reactor.callFromThread(reactor.stop)\n-    except ImportError:\n-       pass\n-\n   ```\nonce again fixes this, with almost instantaneous launching of sagenb once it gets going in the terminal.   Based off of beta8.  Yes, a few seconds is very optimistic normally, but five minutes is a bit excessive even by my patience standards :-) \n\nNow what is particularly weird is that when I cleaned things up by reverting the reverting (i.e. going back to develop), I can no longer recreate this.   So for now I propose we leave it as \"needs info\", because it could be even weirder than this.  chapoton, any ideas on why/why not beta8 would make a difference?\n\nI will endeavor to check this with each new beta now, though my Sage development time has been very limited for a couple years now, regrettably.",
    "created_at": "2018-07-02T14:13:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25667#issuecomment-398306",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:8'></a>
beta8 did not work either.  Reverting 

```
-    # stop the twisted reactor
-    try:
-       from twisted.internet import reactor
-       if reactor.running:
-          reactor.callFromThread(reactor.stop)
-    except ImportError:
-       pass
-
   ```
once again fixes this, with almost instantaneous launching of sagenb once it gets going in the terminal.   Based off of beta8.  Yes, a few seconds is very optimistic normally, but five minutes is a bit excessive even by my patience standards :-) 

Now what is particularly weird is that when I cleaned things up by reverting the reverting (i.e. going back to develop), I can no longer recreate this.   So for now I propose we leave it as "needs info", because it could be even weirder than this.  chapoton, any ideas on why/why not beta8 would make a difference?

I will endeavor to check this with each new beta now, though my Sage development time has been very limited for a couple years now, regrettably.



---

archive/issue_comments_398307.json:
```json
{
    "body": "<a id='comment:9'></a>\nI am pretty sure that whatever problem you are seeing is unrelated to `twisted`. Especially since you cannot reproduce it after reverting.",
    "created_at": "2018-07-02T14:21:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25667#issuecomment-398307",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>
I am pretty sure that whatever problem you are seeing is unrelated to `twisted`. Especially since you cannot reproduce it after reverting.



---

archive/issue_comments_398308.json:
```json
{
    "body": "<a id='comment:10'></a>\nI still meet the issue with my latest beta (on another machine).\n\nCould be a pickle problem:\n\n```\nTraceback (most recent call last):\n  File \"<string>\", line 1, in <module>\n  File \"/home/chapoton/sage/local/lib/python2.7/site-packages/sagenb/notebook/notebook_object.py\", line 243, in __call__\n    return self.notebook(*args, **kwds)\n  File \"/home/chapoton/sage/local/lib/python2.7/site-packages/sagenb/notebook/run_notebook.py\", line 535, in notebook_run\n    nb = notebook.load_notebook(directory)\n  File \"/home/chapoton/sage/local/lib/python2.7/site-packages/sagenb/notebook/notebook.py\", line 1839, in load_notebook\n    nb = Notebook(dir)\n  File \"/home/chapoton/sage/local/lib/python2.7/site-packages/sagenb/notebook/notebook.py\", line 151, in __init__\n    self.__conf = S.load_server_conf()\n  File \"/home/chapoton/sage/local/lib/python2.7/site-packages/sagenb/storage/filesystem_storage.py\", line 265, in load_server_conf\n    return self._basic_to_server_conf(self._load('conf.pickle'))\n  File \"/home/chapoton/sage/local/lib/python2.7/site-packages/sagenb/storage/filesystem_storage.py\", line 187, in _load\n    result = pickle.load(f)\nValueError: unsupported pickle protocol: 3\n[E 16:22:14.760 NotebookApp] {\n      \"Accept-Language\": \"fr-FR,fr;q=0.9,en-US;q=0.8,en;q=0.7\", \n      \"Accept-Encoding\": \"gzip, deflate, br\", \n      \"Host\": \"localhost:8888\", \n      \"Accept\": \"*/*\", \n      \"User-Agent\": \"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.94 Safari/537.36\", \n      \"Connection\": \"keep-alive\", \n      \"Referer\": \"http://localhost:8888/sagenb/www/run-sagenb.html\", \n      \"Cookie\": \"_xsrf=2|0bf3e54e|28cdb4e20016c6f043f8849cfe61c13b|1530264556; username-localhost-8888=\\\"2|1:0|10:1530541329|23:username-localhost-8888|44:ZWMyNWJhOTE0YmVkNDgwM2JkMzczOWMzMDZlZGM0OWI=|90c5ea569b6ba437b5dcea7b21ad80bb83380a15fd3ebbfeec6408f6347a62ce\\\"\"\n    }\n[E 16:22:14.761 NotebookApp] 500 GET /sagenb/start (127.0.0.1) 2227.82ms referer=http://localhost:8888/sagenb/www/run-sagenb.html\n```",
    "created_at": "2018-07-02T14:23:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25667#issuecomment-398308",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:10'></a>
I still meet the issue with my latest beta (on another machine).

Could be a pickle problem:

```
Traceback (most recent call last):
  File "<string>", line 1, in <module>
  File "/home/chapoton/sage/local/lib/python2.7/site-packages/sagenb/notebook/notebook_object.py", line 243, in __call__
    return self.notebook(*args, **kwds)
  File "/home/chapoton/sage/local/lib/python2.7/site-packages/sagenb/notebook/run_notebook.py", line 535, in notebook_run
    nb = notebook.load_notebook(directory)
  File "/home/chapoton/sage/local/lib/python2.7/site-packages/sagenb/notebook/notebook.py", line 1839, in load_notebook
    nb = Notebook(dir)
  File "/home/chapoton/sage/local/lib/python2.7/site-packages/sagenb/notebook/notebook.py", line 151, in __init__
    self.__conf = S.load_server_conf()
  File "/home/chapoton/sage/local/lib/python2.7/site-packages/sagenb/storage/filesystem_storage.py", line 265, in load_server_conf
    return self._basic_to_server_conf(self._load('conf.pickle'))
  File "/home/chapoton/sage/local/lib/python2.7/site-packages/sagenb/storage/filesystem_storage.py", line 187, in _load
    result = pickle.load(f)
ValueError: unsupported pickle protocol: 3
[E 16:22:14.760 NotebookApp] {
      "Accept-Language": "fr-FR,fr;q=0.9,en-US;q=0.8,en;q=0.7", 
      "Accept-Encoding": "gzip, deflate, br", 
      "Host": "localhost:8888", 
      "Accept": "*/*", 
      "User-Agent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.94 Safari/537.36", 
      "Connection": "keep-alive", 
      "Referer": "http://localhost:8888/sagenb/www/run-sagenb.html", 
      "Cookie": "_xsrf=2|0bf3e54e|28cdb4e20016c6f043f8849cfe61c13b|1530264556; username-localhost-8888=\"2|1:0|10:1530541329|23:username-localhost-8888|44:ZWMyNWJhOTE0YmVkNDgwM2JkMzczOWMzMDZlZGM0OWI=|90c5ea569b6ba437b5dcea7b21ad80bb83380a15fd3ebbfeec6408f6347a62ce\""
    }
[E 16:22:14.761 NotebookApp] 500 GET /sagenb/start (127.0.0.1) 2227.82ms referer=http://localhost:8888/sagenb/www/run-sagenb.html
```



---

archive/issue_comments_398309.json:
```json
{
    "body": "<a id='comment:11'></a>\nDid you by chance run sagenb under Python 3? That might explain that.",
    "created_at": "2018-07-02T14:26:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25667#issuecomment-398309",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>
Did you by chance run sagenb under Python 3? That might explain that.



---

archive/issue_comments_398310.json:
```json
{
    "body": "<a id='comment:12'></a>\nNo, I am using my python2 install. And now\n\n```\n./sage -n=sagenb\n```\nfails with the same pickle problem.\n\nBUT I have tried to use sagenb with my other sage3 install on the same machine. Could they interfere ?",
    "created_at": "2018-07-02T14:28:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25667#issuecomment-398310",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:12'></a>
No, I am using my python2 install. And now

```
./sage -n=sagenb
```
fails with the same pickle problem.

BUT I have tried to use sagenb with my other sage3 install on the same machine. Could they interfere ?



---

archive/issue_comments_398311.json:
```json
{
    "body": "<a id='comment:13'></a>\nReplying to [chapoton](#comment%3A12):\n> Could they interfere ?\n\n\nYes.",
    "created_at": "2018-07-02T14:30:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25667#issuecomment-398311",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>
Replying to [chapoton](#comment%3A12):
> Could they interfere ?


Yes.



---

archive/issue_events_231958.json:
```json
{
    "actor": "https://github.com/kcrisman",
    "created_at": "2018-07-02T16:25:32Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "label": "blocker",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25667#event-231958"
}
```



---

archive/issue_events_231959.json:
```json
{
    "actor": "https://github.com/kcrisman",
    "created_at": "2018-07-02T16:25:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "label": "critical",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25667#event-231959"
}
```



---

archive/issue_comments_398312.json:
```json
{
    "body": "<a id='comment:14'></a>\nI don't see a pickling message, so I would say that least is unrelated.\n\n> I am pretty sure that whatever problem you are seeing is unrelated to twisted\n\n\nYet this is the first time that changing that particular stretch of code didn't reliably go back and forth on this issue.  So I'm still not totally convinced - let's leave this open with \"needs info\" for now, though I will downgrade to \"critical\" for the time being.",
    "created_at": "2018-07-02T16:25:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25667#issuecomment-398312",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:14'></a>
I don't see a pickling message, so I would say that least is unrelated.

> I am pretty sure that whatever problem you are seeing is unrelated to twisted


Yet this is the first time that changing that particular stretch of code didn't reliably go back and forth on this issue.  So I'm still not totally convinced - let's leave this open with "needs info" for now, though I will downgrade to "critical" for the time being.



---

archive/issue_comments_398313.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [jdemeyer](#comment%3A13):\n> Replying to [chapoton](#comment%3A12):\n> > Could they interfere ?\n\n> \n> Yes.\n\n\nI imagine stuff in ~/.sage/ might not be compatible, py2/3-wise.",
    "created_at": "2018-07-02T16:39:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25667#issuecomment-398313",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:15'></a>
Replying to [jdemeyer](#comment%3A13):
> Replying to [chapoton](#comment%3A12):
> > Could they interfere ?

> 
> Yes.


I imagine stuff in ~/.sage/ might not be compatible, py2/3-wise.



---

archive/issue_comments_398314.json:
```json
{
    "body": "<a id='comment:16'></a>\nAfter upgrading to 8.3.rc0 I had this same problem; running `sage --notebook=sagenb` once caused it to disappear.  I wonder if anyone can try to confirm that - maybe there is something going on there, race condition? Weird.",
    "created_at": "2018-07-10T02:08:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25667#issuecomment-398314",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:16'></a>
After upgrading to 8.3.rc0 I had this same problem; running `sage --notebook=sagenb` once caused it to disappear.  I wonder if anyone can try to confirm that - maybe there is something going on there, race condition? Weird.



---

archive/issue_comments_398315.json:
```json
{
    "body": "<a id='comment:17'></a>\nDid you try to move your `.sage` out of the way ?",
    "created_at": "2018-07-10T06:24:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25667#issuecomment-398315",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:17'></a>
Did you try to move your `.sage` out of the way ?



---

archive/issue_comments_398316.json:
```json
{
    "body": "<a id='comment:18'></a>\nNo, though I guess I should for the next release candidate.  I don't know that this would make a big difference since I don't really have a lot of custom stuff; I'm not using py3.",
    "created_at": "2018-07-10T12:10:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25667#issuecomment-398316",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:18'></a>
No, though I guess I should for the next release candidate.  I don't know that this would make a big difference since I don't really have a lot of custom stuff; I'm not using py3.



---

archive/issue_comments_398317.json:
```json
{
    "body": "<a id='comment:19'></a>\nOnce again I have the behavior with rc0:\n\n1. Start with `sage -n`\n2. Click to get old notebook from the export page\n3. Goes to waiting page but never loads despite the sagenb server functioning normally\n4. Quit\n5. Do first two steps again\n6. All is well\n\nWith rc1, assuming there is one before I have worse internet for several weeks, I may try to move the `.sage` directory.  This is weird.",
    "created_at": "2018-07-12T15:24:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25667#issuecomment-398317",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:19'></a>
Once again I have the behavior with rc0:

1. Start with `sage -n`
2. Click to get old notebook from the export page
3. Goes to waiting page but never loads despite the sagenb server functioning normally
4. Quit
5. Do first two steps again
6. All is well

With rc1, assuming there is one before I have worse internet for several weeks, I may try to move the `.sage` directory.  This is weird.



---

archive/issue_comments_398318.json:
```json
{
    "body": "<a id='comment:20'></a>\nReplying to [kcrisman](#comment%3A19):\n> Once again I have the behavior with rc0:\n> \n> 1. Start with `sage -n`\n> 2. Click to get old notebook from the export page\n> 3. Goes to waiting page but never loads despite the sagenb server functioning normally\n> 4. Quit\n> 5. Do first two steps again\n> 6. All is well\n> \n\n\nSorry, I don't know why I wrote this.  The last item does NOT happen.  Now I will try moving `.sage`.  Now I get the following - still no loading, and when I do `Ctrl-C`:\n\n```\n^C2018-07-12T11:32:21-0400 [stdout#info] Quitting all running worksheets...\n2018-07-12T11:32:21-0400 [stdout#info] Saving notebook...\n[I 11:32:21.731 NotebookApp] interrupted\nServing notebooks from local directory: /Users/karl.crisman/Downloads/binary-pkg\n0 active kernels\nThe Jupyter Notebook is running at:\nhttp://localhost:8888/?token=b221b7e836980e807316ab78230331224f4273ad8cc6e9ea\nShutdown this notebook server (y/[n])? 2018-07-12T11:32:21-0400 [stdout#info] Notebook cleanly saved.\n2018-07-12T11:32:21-0400 [-] (TCP Port 8080 Closed)\n2018-07-12T11:32:21-0400 [__builtin__.QuietSite#info] Stopping factory <__builtin__.QuietSite instance at 0x1c6ff86c8>\n2018-07-12T11:32:21-0400 [-] Main loop terminated.\n2018-07-12T11:32:21-0400 [twisted.scripts._twistd_unix.UnixAppLogger#info] Server Shut Down.\nNo answer for 5s: resuming operation...\n^C[I 11:32:39.728 NotebookApp] interrupted\nServing notebooks from local directory: /Users/karl.crisman/Downloads/binary-pkg\n0 active kernels\nThe Jupyter Notebook is running at:\nhttp://localhost:8888/?token=b221b7e836980e807316ab78230331224f4273ad8cc6e9ea\nShutdown this notebook server (y/[n])? No answer for 5s: resuming operation...\n^C[I 11:32:51.523 NotebookApp] interrupted\nServing notebooks from local directory: /Users/karl.crisman/Downloads/binary-pkg\n0 active kernels\nThe Jupyter Notebook is running at:\nhttp://localhost:8888/?token=b221b7e836980e807316ab78230331224f4273ad8cc6e9ea\nShutdown this notebook server (y/[n])? y\n[C 11:32:53.871 NotebookApp] Shutdown confirmed\n[I 11:32:53.874 NotebookApp] Shutting down 0 kernels\n```\n\nNote that one has to explicitly shut down the NotebookApp server by pressing `y`!!!  What on earth?  Has anyone else ever seen that?",
    "created_at": "2018-07-12T15:34:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25667#issuecomment-398318",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:20'></a>
Replying to [kcrisman](#comment%3A19):
> Once again I have the behavior with rc0:
> 
> 1. Start with `sage -n`
> 2. Click to get old notebook from the export page
> 3. Goes to waiting page but never loads despite the sagenb server functioning normally
> 4. Quit
> 5. Do first two steps again
> 6. All is well
> 


Sorry, I don't know why I wrote this.  The last item does NOT happen.  Now I will try moving `.sage`.  Now I get the following - still no loading, and when I do `Ctrl-C`:

```
^C2018-07-12T11:32:21-0400 [stdout#info] Quitting all running worksheets...
2018-07-12T11:32:21-0400 [stdout#info] Saving notebook...
[I 11:32:21.731 NotebookApp] interrupted
Serving notebooks from local directory: /Users/karl.crisman/Downloads/binary-pkg
0 active kernels
The Jupyter Notebook is running at:
http://localhost:8888/?token=b221b7e836980e807316ab78230331224f4273ad8cc6e9ea
Shutdown this notebook server (y/[n])? 2018-07-12T11:32:21-0400 [stdout#info] Notebook cleanly saved.
2018-07-12T11:32:21-0400 [-] (TCP Port 8080 Closed)
2018-07-12T11:32:21-0400 [__builtin__.QuietSite#info] Stopping factory <__builtin__.QuietSite instance at 0x1c6ff86c8>
2018-07-12T11:32:21-0400 [-] Main loop terminated.
2018-07-12T11:32:21-0400 [twisted.scripts._twistd_unix.UnixAppLogger#info] Server Shut Down.
No answer for 5s: resuming operation...
^C[I 11:32:39.728 NotebookApp] interrupted
Serving notebooks from local directory: /Users/karl.crisman/Downloads/binary-pkg
0 active kernels
The Jupyter Notebook is running at:
http://localhost:8888/?token=b221b7e836980e807316ab78230331224f4273ad8cc6e9ea
Shutdown this notebook server (y/[n])? No answer for 5s: resuming operation...
^C[I 11:32:51.523 NotebookApp] interrupted
Serving notebooks from local directory: /Users/karl.crisman/Downloads/binary-pkg
0 active kernels
The Jupyter Notebook is running at:
http://localhost:8888/?token=b221b7e836980e807316ab78230331224f4273ad8cc6e9ea
Shutdown this notebook server (y/[n])? y
[C 11:32:53.871 NotebookApp] Shutdown confirmed
[I 11:32:53.874 NotebookApp] Shutting down 0 kernels
```

Note that one has to explicitly shut down the NotebookApp server by pressing `y`!!!  What on earth?  Has anyone else ever seen that?



---

archive/issue_comments_398319.json:
```json
{
    "body": "<a id='comment:21'></a>\nAnd once again, using `sagenb` directly and *then* going through the steps above ends with success.  So this is irrespective of `.sage`.",
    "created_at": "2018-07-12T15:36:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25667#issuecomment-398319",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:21'></a>
And once again, using `sagenb` directly and *then* going through the steps above ends with success.  So this is irrespective of `.sage`.



---

archive/issue_comments_398320.json:
```json
{
    "body": "<a id='comment:22'></a>\nInterestingly, when I moved `.sage` back to its original location, the same behavior 1.-6. came again, so there is something weird going on.",
    "created_at": "2018-07-12T15:47:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25667#issuecomment-398320",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:22'></a>
Interestingly, when I moved `.sage` back to its original location, the same behavior 1.-6. came again, so there is something weird going on.



---

archive/issue_comments_398321.json:
```json
{
    "body": "<a id='comment:23'></a>\nmilestone update 8.3 -> 8.4",
    "created_at": "2018-08-03T19:18:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25667#issuecomment-398321",
    "user": "https://github.com/videlec"
}
```

<a id='comment:23'></a>
milestone update 8.3 -> 8.4



---

archive/issue_events_231960.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-08-03T19:18:42Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "milestone": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25667#event-231960"
}
```



---

archive/issue_events_231961.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-08-03T19:18:42Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "milestone": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25667#event-231961"
}
```



---

archive/issue_comments_398322.json:
```json
{
    "body": "<a id='comment:24'></a>\nCan this problem be reproduced? If not, we should close this ticket. If yes, the description and title should be updated.",
    "created_at": "2018-08-28T14:44:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25667#issuecomment-398322",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'></a>
Can this problem be reproduced? If not, we should close this ticket. If yes, the description and title should be updated.



---

archive/issue_comments_398323.json:
```json
{
    "body": "<a id='comment:25'></a>\nI reproduced it most of the time, but I am only one person.  I think we can keep the ticket open, and if more reports surface with 8.4 now released without this fix, we can do it quite easily.  \"Needs Info\" for more reports, then.",
    "created_at": "2018-08-28T16:08:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25667#issuecomment-398323",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:25'></a>
I reproduced it most of the time, but I am only one person.  I think we can keep the ticket open, and if more reports surface with 8.4 now released without this fix, we can do it quite easily.  "Needs Info" for more reports, then.



---

archive/issue_events_231962.json:
```json
{
    "actor": "https://github.com/kcrisman",
    "created_at": "2018-08-28T16:08:14Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "rename": {
        "from": "Revert full removal of twisted",
        "to": "Keep twisted reference in all.py"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25667#event-231962"
}
```



---

archive/issue_comments_398324.json:
```json
{
    "body": "<a id='comment:26'></a>\nI'm not sure, but this ticket may now be outdated - do we still have twisted?",
    "created_at": "2020-07-02T01:28:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25667#issuecomment-398324",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:26'></a>
I'm not sure, but this ticket may now be outdated - do we still have twisted?



---

archive/issue_events_231963.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2020-07-02T02:56:26Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "label": "needs info",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25667#event-231963"
}
```



---

archive/issue_events_231964.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2020-07-02T02:56:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25667#event-231964"
}
```



---

archive/issue_comments_398325.json:
```json
{
    "body": "<a id='comment:27'></a>\nNo, it's removed in #29754. Marking as invalid.",
    "created_at": "2020-07-02T02:56:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25667#issuecomment-398325",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:27'></a>
No, it's removed in #29754. Marking as invalid.



---

archive/issue_events_231965.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2020-07-02T02:56:26Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "milestone": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25667#event-231965"
}
```



---

archive/issue_events_231966.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2020-07-02T02:56:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "label": "duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25667#event-231966"
}
```



---

archive/issue_comments_398326.json:
```json
{
    "body": "**Reviewer:** Dima Pasechnik",
    "created_at": "2020-07-02T07:55:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25667#issuecomment-398326",
    "user": "https://github.com/dimpase"
}
```

**Reviewer:** Dima Pasechnik



---

archive/issue_events_231967.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-07-02T07:55:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25667#event-231967"
}
```



---

archive/issue_events_231968.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-07-02T07:55:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25667#event-231968"
}
```



---

archive/issue_events_231969.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2020-07-02T13:17:52Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25667#event-231969"
}
```



---

archive/issue_events_231970.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2020-07-02T13:17:52Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/25667",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25667#event-231970"
}
```
