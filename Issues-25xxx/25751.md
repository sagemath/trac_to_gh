# Issue 25751: Improve PARI finite field iterator

archive/issues_025514.json:
```json
{
    "body": "Note the difference between these implementations:\n\n```\nsage: k.<a> = GF(3^10, impl=\"givaro\"); timeit('list(k)')\n125 loops, best of 3: 6.2 ms per loop\nsage: k.<a> = GF(3^10, impl=\"pari\"); timeit('list(k)')\n5 loops, best of 3: 3.02 s per loop\n```\nThere is clearly room for improvement in the latter, which is basically implemented as iterating over `k.vector_space()` and then converting those elements to `k`.\n\nThe attached branch improves that a lot:\n\n```\nsage: k.<a> = GF(3^10, impl=\"pari\"); timeit('list(k)')\n5 loops, best of 3: 44.2 ms per loop\n```\n(still slower than Givaro but much faster than before)\n\nFinally, some minor unrelated refactoring is done to the conversion PARI -> `FiniteFieldElement_pari_ffelt`.\n\nCC:  @pjbruin\n\nKeywords: days94\n\nBranch/Commit: db7e4303e77b6f6d5a552ac23d3038bf4cae3b4b\n\nReviewer: Travis Scrimshaw\n\nAuthor: Jeroen Demeyer\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/25751\n\n",
    "closed_at": "2018-08-05T08:17:13Z",
    "created_at": "2018-07-02T21:01:47Z",
    "labels": [
        "component: finite rings"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.3",
    "title": "Improve PARI finite field iterator",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25751",
    "user": "https://github.com/jdemeyer"
}
```
Note the difference between these implementations:

```
sage: k.<a> = GF(3^10, impl="givaro"); timeit('list(k)')
125 loops, best of 3: 6.2 ms per loop
sage: k.<a> = GF(3^10, impl="pari"); timeit('list(k)')
5 loops, best of 3: 3.02 s per loop
```
There is clearly room for improvement in the latter, which is basically implemented as iterating over `k.vector_space()` and then converting those elements to `k`.

The attached branch improves that a lot:

```
sage: k.<a> = GF(3^10, impl="pari"); timeit('list(k)')
5 loops, best of 3: 44.2 ms per loop
```
(still slower than Givaro but much faster than before)

Finally, some minor unrelated refactoring is done to the conversion PARI -> `FiniteFieldElement_pari_ffelt`.

CC:  @pjbruin

Keywords: days94

Branch/Commit: db7e4303e77b6f6d5a552ac23d3038bf4cae3b4b

Reviewer: Travis Scrimshaw

Author: Jeroen Demeyer

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/25751





---

archive/issue_comments_382994.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,7 +1,7 @@\n Note the difference between\n \n \\`\\`\\`\n-sage: k.<a> = GF(3^10, impl=\"givaro\");\n+sage: k.<a> = GF(3^10, impl=\"givaro\")\n sage: %time L = list(k)\n CPU times: user 100 ms, sys: 2 ms, total: 102 ms\n Wall time: 102 ms\n```\n",
    "created_at": "2018-07-02T21:02:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25751",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25751#issuecomment-382994",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,7 +1,7 @@
 Note the difference between
 
 \`\`\`
-sage: k.<a> = GF(3^10, impl="givaro");
+sage: k.<a> = GF(3^10, impl="givaro")
 sage: %time L = list(k)
 CPU times: user 100 ms, sys: 2 ms, total: 102 ms
 Wall time: 102 ms
```




---

archive/issue_comments_382995.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-07-05T08:40:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25751",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25751#issuecomment-382995",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_382996.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-07-05T08:47:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25751",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25751#issuecomment-382996",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_382997.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,22 @@\n+Note the difference between these implementations:\n \n+\\`\\`\\`\n+sage: k.<a> = GF(3^10, impl=\"givaro\"); timeit('list(k)')\n+125 loops, best of 3: 6.2 ms per loop\n+sage: k.<a> = GF(3^10, impl=\"pari\"); timeit('list(k)')\n+5 loops, best of 3: 3.02 s per loop\n+\\`\\`\\`\n+There is clearly room for improvement in the latter. The attached branch improves the last one to\n+\n+\\`\\`\\`\n+sage: k.<a> = GF(3^10, impl=\"pari\"); timeit('list(k)')\n+5 loops, best of 3: 135 ms per loop\n+\\`\\`\\`\n+(still a lot slower than Givaro but much faster than before)\n+\n+It also simplifies the generic iterator in the \\`FiniteField\\` base class.\n+\n+Finally, some minor unrelated refactoring is done to the conversion PARI -> \\`FiniteFieldElement_pari_ffelt\\`.\n \n Author: Jeroen Demeyer\n \n```\n",
    "created_at": "2018-07-05T08:47:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25751",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25751#issuecomment-382997",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,22 @@
+Note the difference between these implementations:
 
+\`\`\`
+sage: k.<a> = GF(3^10, impl="givaro"); timeit('list(k)')
+125 loops, best of 3: 6.2 ms per loop
+sage: k.<a> = GF(3^10, impl="pari"); timeit('list(k)')
+5 loops, best of 3: 3.02 s per loop
+\`\`\`
+There is clearly room for improvement in the latter. The attached branch improves the last one to
+
+\`\`\`
+sage: k.<a> = GF(3^10, impl="pari"); timeit('list(k)')
+5 loops, best of 3: 135 ms per loop
+\`\`\`
+(still a lot slower than Givaro but much faster than before)
+
+It also simplifies the generic iterator in the \`FiniteField\` base class.
+
+Finally, some minor unrelated refactoring is done to the conversion PARI -> \`FiniteFieldElement_pari_ffelt\`.
 
 Author: Jeroen Demeyer
 
```




---

archive/issue_comments_382998.json:
```json
{
    "body": "<a id='comment:6'></a>Do all of those returns in `element_pari_ffelt.pyx` need a `sig_off`, or is that handled by the calling function?\n\nWould it be worth cythonizing the iterator (by making it a function in `element_pari_ffelt.pyx`)?",
    "created_at": "2018-07-05T23:41:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25751",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25751#issuecomment-382998",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:6'></a>Do all of those returns in `element_pari_ffelt.pyx` need a `sig_off`, or is that handled by the calling function?

Would it be worth cythonizing the iterator (by making it a function in `element_pari_ffelt.pyx`)?



---

archive/issue_comments_382999.json:
```json
{
    "body": "<a id='comment:7'></a>I just realized that my \"PARI finite field\" iterator is in fact completely generic and doesn't use any PARI features. So I'll move that to the base class.",
    "created_at": "2018-07-06T07:17:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25751",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25751#issuecomment-382999",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>I just realized that my "PARI finite field" iterator is in fact completely generic and doesn't use any PARI features. So I'll move that to the base class.



---

archive/issue_comments_383000.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:6 tscrim]:\n> Do all of those returns in `element_pari_ffelt.pyx` need a `sig_off`, or is that handled by the calling function?\n\n\nIt's handled by `construct`.\n\n> Would it be worth cythonizing the iterator (by making it a function in `element_pari_ffelt.pyx`)?\n\n\nMaybe, but I'd rather do that another time :-)",
    "created_at": "2018-07-06T07:17:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25751",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25751#issuecomment-383000",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>Replying to [comment:6 tscrim]:
> Do all of those returns in `element_pari_ffelt.pyx` need a `sig_off`, or is that handled by the calling function?


It's handled by `construct`.

> Would it be worth cythonizing the iterator (by making it a function in `element_pari_ffelt.pyx`)?


Maybe, but I'd rather do that another time :-)



---

archive/issue_comments_383001.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,22 @@\n+Note the difference between these implementations:\n \n+\\`\\`\\`\n+sage: k.<a> = GF(3^10, impl=\"givaro\"); timeit('list(k)')\n+125 loops, best of 3: 6.2 ms per loop\n+sage: k.<a> = GF(3^10, impl=\"pari\"); timeit('list(k)')\n+5 loops, best of 3: 3.02 s per loop\n+\\`\\`\\`\n+There is clearly room for improvement in the latter. which is basically implemented as iterating over \\`k.vector_space()\\` and then converting those elements to \\`k\\`.\n+\n+The attached branch improves that a lot:\n+\n+\\`\\`\\`\n+sage: k.<a> = GF(3^10, impl=\"pari\"); timeit('list(k)')\n+5 loops, best of 3: 51 ms per loop\n+\\`\\`\\`\n+(still a lot slower than Givaro but much faster than before)\n+\n+Finally, some minor unrelated refactoring is done to the conversion PARI -> \\`FiniteFieldElement_pari_ffelt\\`.\n \n Author: Jeroen Demeyer\n \n```\n",
    "created_at": "2018-07-06T08:22:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25751",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25751#issuecomment-383001",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,22 @@
+Note the difference between these implementations:
 
+\`\`\`
+sage: k.<a> = GF(3^10, impl="givaro"); timeit('list(k)')
+125 loops, best of 3: 6.2 ms per loop
+sage: k.<a> = GF(3^10, impl="pari"); timeit('list(k)')
+5 loops, best of 3: 3.02 s per loop
+\`\`\`
+There is clearly room for improvement in the latter. which is basically implemented as iterating over \`k.vector_space()\` and then converting those elements to \`k\`.
+
+The attached branch improves that a lot:
+
+\`\`\`
+sage: k.<a> = GF(3^10, impl="pari"); timeit('list(k)')
+5 loops, best of 3: 51 ms per loop
+\`\`\`
+(still a lot slower than Givaro but much faster than before)
+
+Finally, some minor unrelated refactoring is done to the conversion PARI -> \`FiniteFieldElement_pari_ffelt\`.
 
 Author: Jeroen Demeyer
 
```




---

archive/issue_comments_383002.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-07-06T08:22:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25751",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25751#issuecomment-383002",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_383003.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,22 @@\n+Note the difference between these implementations:\n \n+\\`\\`\\`\n+sage: k.<a> = GF(3^10, impl=\"givaro\"); timeit('list(k)')\n+125 loops, best of 3: 6.2 ms per loop\n+sage: k.<a> = GF(3^10, impl=\"pari\"); timeit('list(k)')\n+5 loops, best of 3: 3.02 s per loop\n+\\`\\`\\`\n+There is clearly room for improvement in the latter. which is basically implemented as iterating over \\`k.vector_space()\\` and then converting those elements to \\`k\\`.\n+\n+The attached branch improves that a lot:\n+\n+\\`\\`\\`\n+sage: k.<a> = GF(3^10, impl=\"pari\"); timeit('list(k)')\n+5 loops, best of 3: 44.2 ms per loop\n+\\`\\`\\`\n+(still slower than Givaro but much faster than before)\n+\n+Finally, some minor unrelated refactoring is done to the conversion PARI -> \\`FiniteFieldElement_pari_ffelt\\`.\n \n Author: Jeroen Demeyer\n \n```\n",
    "created_at": "2018-07-06T08:38:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25751",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25751#issuecomment-383003",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,22 @@
+Note the difference between these implementations:
 
+\`\`\`
+sage: k.<a> = GF(3^10, impl="givaro"); timeit('list(k)')
+125 loops, best of 3: 6.2 ms per loop
+sage: k.<a> = GF(3^10, impl="pari"); timeit('list(k)')
+5 loops, best of 3: 3.02 s per loop
+\`\`\`
+There is clearly room for improvement in the latter. which is basically implemented as iterating over \`k.vector_space()\` and then converting those elements to \`k\`.
+
+The attached branch improves that a lot:
+
+\`\`\`
+sage: k.<a> = GF(3^10, impl="pari"); timeit('list(k)')
+5 loops, best of 3: 44.2 ms per loop
+\`\`\`
+(still slower than Givaro but much faster than before)
+
+Finally, some minor unrelated refactoring is done to the conversion PARI -> \`FiniteFieldElement_pari_ffelt\`.
 
 Author: Jeroen Demeyer
 
```




---

archive/issue_comments_383004.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-07-06T08:47:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25751",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25751#issuecomment-383004",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_383005.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-07-06T08:47:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25751",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25751#issuecomment-383005",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_383006.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-07-06T08:49:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25751",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25751#issuecomment-383006",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_383007.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,22 @@\n+Note the difference between these implementations:\n \n+\\`\\`\\`\n+sage: k.<a> = GF(3^10, impl=\"givaro\"); timeit('list(k)')\n+125 loops, best of 3: 6.2 ms per loop\n+sage: k.<a> = GF(3^10, impl=\"pari\"); timeit('list(k)')\n+5 loops, best of 3: 3.02 s per loop\n+\\`\\`\\`\n+There is clearly room for improvement in the latter, which is basically implemented as iterating over \\`k.vector_space()\\` and then converting those elements to \\`k\\`.\n+\n+The attached branch improves that a lot:\n+\n+\\`\\`\\`\n+sage: k.<a> = GF(3^10, impl=\"pari\"); timeit('list(k)')\n+5 loops, best of 3: 44.2 ms per loop\n+\\`\\`\\`\n+(still slower than Givaro but much faster than before)\n+\n+Finally, some minor unrelated refactoring is done to the conversion PARI -> \\`FiniteFieldElement_pari_ffelt\\`.\n \n Author: Jeroen Demeyer\n \n```\n",
    "created_at": "2018-07-06T08:50:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25751",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25751#issuecomment-383007",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,22 @@
+Note the difference between these implementations:
 
+\`\`\`
+sage: k.<a> = GF(3^10, impl="givaro"); timeit('list(k)')
+125 loops, best of 3: 6.2 ms per loop
+sage: k.<a> = GF(3^10, impl="pari"); timeit('list(k)')
+5 loops, best of 3: 3.02 s per loop
+\`\`\`
+There is clearly room for improvement in the latter, which is basically implemented as iterating over \`k.vector_space()\` and then converting those elements to \`k\`.
+
+The attached branch improves that a lot:
+
+\`\`\`
+sage: k.<a> = GF(3^10, impl="pari"); timeit('list(k)')
+5 loops, best of 3: 44.2 ms per loop
+\`\`\`
+(still slower than Givaro but much faster than before)
+
+Finally, some minor unrelated refactoring is done to the conversion PARI -> \`FiniteFieldElement_pari_ffelt\`.
 
 Author: Jeroen Demeyer
 
```




---

archive/issue_comments_383008.json:
```json
{
    "body": "<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-07-06T09:13:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25751",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25751#issuecomment-383008",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_383009.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:7 jdemeyer]:\n> I just realized that my \"PARI finite field\" iterator is in fact completely generic and doesn't use any PARI features. So I'll move that to the base class.\n\n\n...which happens to be implemented in Cython. So I got another x2.5 speedup!\n\nI think that the current code is as good as it can get for a generic implementation.",
    "created_at": "2018-07-06T10:28:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25751",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25751#issuecomment-383009",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:16'></a>Replying to [comment:7 jdemeyer]:
> I just realized that my "PARI finite field" iterator is in fact completely generic and doesn't use any PARI features. So I'll move that to the base class.


...which happens to be implemented in Cython. So I got another x2.5 speedup!

I think that the current code is as good as it can get for a generic implementation.



---

archive/issue_comments_383010.json:
```json
{
    "body": "<a id='comment:17'></a>Thank you. LGTM.",
    "created_at": "2018-07-06T15:03:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25751",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25751#issuecomment-383010",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:17'></a>Thank you. LGTM.



---

archive/issue_comments_383011.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-07-06T15:03:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25751",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25751#issuecomment-383011",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_064415.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-08-05T08:17:13Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/25751",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25751#event-64415"
}
```



---

archive/issue_comments_383012.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-08-05T08:17:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25751",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25751#issuecomment-383012",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
