# Issue 25328: Respect jupyter path priority

archive/issues_025091.json:
```json
{
    "body": "Jupyter provides a `jupyter_path` function that gives back a list of paths in the right priority. Sage currently uses the apparently undocumented `ENV_JUPYTER_PATH` which is [taken into consideration in the `jupyter_path` function](https://github.com/jupyter/jupyter_core/blob/616447137a99f2437f7270dd3d8382091fb3df97/jupyter_core/paths.py#L128).\n\n`ENV_JUPYTER_PATH` is always `[os.path.join(sys.prefix, 'share', 'jupyter')]` and not overridable by the user. `jupyter_path` prefers the `JUPYTER_PATH` environment variable when it is set. When it is not set, it first checks `jupyter_data_dir`, which apparently defaults to a user-dir (`~/.local`) and then falls back to the current behaviour (`ENV_JUPYTER_PATH`).\n\nSo in summary, this patch changes the default behaviour from using a system directory to using a user directory. It allows the user to override that directory.\n\n**Branch:** [u/gh-timokau/respect-jupyter-path](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-timokau/respect-jupyter-path)\n\n**Commit:** [029123097d79f2c67bca2d725c470ef667a88ca2](https://github.com/sagemath/sagetrac-mirror/commit/029123097d79f2c67bca2d725c470ef667a88ca2)\n\n**Author:** Timo Kaufmann\n\nIssue created by migration from https://trac.sagemath.org/ticket/25328\n\n",
    "closed_at": "2018-07-01T06:55:01Z",
    "created_at": "2018-05-10T11:10:40Z",
    "labels": [
        "component: distribution",
        "enhancement",
        "duplicate"
    ],
    "title": "Respect jupyter path priority",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/25328",
    "user": "https://github.com/timokau"
}
```
Jupyter provides a `jupyter_path` function that gives back a list of paths in the right priority. Sage currently uses the apparently undocumented `ENV_JUPYTER_PATH` which is [taken into consideration in the `jupyter_path` function](https://github.com/jupyter/jupyter_core/blob/616447137a99f2437f7270dd3d8382091fb3df97/jupyter_core/paths.py#L128).

`ENV_JUPYTER_PATH` is always `[os.path.join(sys.prefix, 'share', 'jupyter')]` and not overridable by the user. `jupyter_path` prefers the `JUPYTER_PATH` environment variable when it is set. When it is not set, it first checks `jupyter_data_dir`, which apparently defaults to a user-dir (`~/.local`) and then falls back to the current behaviour (`ENV_JUPYTER_PATH`).

So in summary, this patch changes the default behaviour from using a system directory to using a user directory. It allows the user to override that directory.

**Branch:** [u/gh-timokau/respect-jupyter-path](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-timokau/respect-jupyter-path)

**Commit:** [029123097d79f2c67bca2d725c470ef667a88ca2](https://github.com/sagemath/sagetrac-mirror/commit/029123097d79f2c67bca2d725c470ef667a88ca2)

**Author:** Timo Kaufmann

Issue created by migration from https://trac.sagemath.org/ticket/25328





---

archive/issue_events_224744.json:
```json
{
    "actor": "https://github.com/timokau",
    "created_at": "2018-05-10T11:21:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25328",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25328#event-224744"
}
```



---

archive/issue_comments_389980.json:
```json
{
    "body": "Replying to [ticket:25328 gh-timokau]:\n> this patch changes the default behaviour from using a system directory to using a user directory\n\n\nThis is not acceptable. What is wrong with the current Sage behaviour? In other words, which bug is this supposed to fix?",
    "created_at": "2018-06-06T15:19:30Z",
    "issue": "https://github.com/sagemath/sage/issues/25328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25328#issuecomment-389980",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [ticket:25328 gh-timokau]:
> this patch changes the default behaviour from using a system directory to using a user directory


This is not acceptable. What is wrong with the current Sage behaviour? In other words, which bug is this supposed to fix?



---

archive/issue_events_224745.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-06-06T15:19:39Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25328",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25328#event-224745"
}
```



---

archive/issue_events_224746.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-06-06T15:19:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25328",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25328#event-224746"
}
```



---

archive/issue_comments_389981.json:
```json
{
    "body": "<a id='comment:4'></a>\nReplying to [jdemeyer](#comment%3A2):\n> This is not acceptable.\n\n\nI don't have any experience with jupyter, but wouldn't it be the correct and expected behaviour to use the user's jupyter instead of the system one?\n\n> What is wrong with the current Sage behaviour? In other words, which bug is this supposed to fix?\n\n\nFor one relying on the undocumented `ENV_JUPYTER_PATH` could be regarded as a problem in itself. Specifically what I'm trying to fix is that in nixos jupyter is *not* in `sys.path/share/jupyter`.",
    "created_at": "2018-06-06T15:48:16Z",
    "issue": "https://github.com/sagemath/sage/issues/25328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25328#issuecomment-389981",
    "user": "https://github.com/timokau"
}
```

<a id='comment:4'></a>
Replying to [jdemeyer](#comment%3A2):
> This is not acceptable.


I don't have any experience with jupyter, but wouldn't it be the correct and expected behaviour to use the user's jupyter instead of the system one?

> What is wrong with the current Sage behaviour? In other words, which bug is this supposed to fix?


For one relying on the undocumented `ENV_JUPYTER_PATH` could be regarded as a problem in itself. Specifically what I'm trying to fix is that in nixos jupyter is *not* in `sys.path/share/jupyter`.



---

archive/issue_comments_389982.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [gh-timokau](#comment%3A4):\n> I don't have any experience with jupyter, but wouldn't it be the correct and expected behaviour to use the user's jupyter instead of the system one?\n\n\nNo. Installing a Jupyter kernel is not much different from installing a Python package: Sage doesn't install Python packages in the user's directory either.\n\n> For one relying on the undocumented `ENV_JUPYTER_PATH` could be regarded as a problem in itself.\n\n\nFair enough. I don't mind changing that.\n\n> Specifically what I'm trying to fix is that in nixos jupyter is *not* in `sys.path/share/jupyter`.\n\n\nDo you mean `sys.prefix` instead of `sys.path`? So where is Jupyter installed then?\n\nDoes nixos even have a concept like `sys.prefix` in the first place? Probably I don't know nixos well enough to understand the problem.\n\nI should add that this problem is not Sage-specific. Many Jupyter packages install files in `sys.prefix/share/jupyter`. So I wonder how nixos deals with those.",
    "created_at": "2018-06-06T19:32:17Z",
    "issue": "https://github.com/sagemath/sage/issues/25328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25328#issuecomment-389982",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>
Replying to [gh-timokau](#comment%3A4):
> I don't have any experience with jupyter, but wouldn't it be the correct and expected behaviour to use the user's jupyter instead of the system one?


No. Installing a Jupyter kernel is not much different from installing a Python package: Sage doesn't install Python packages in the user's directory either.

> For one relying on the undocumented `ENV_JUPYTER_PATH` could be regarded as a problem in itself.


Fair enough. I don't mind changing that.

> Specifically what I'm trying to fix is that in nixos jupyter is *not* in `sys.path/share/jupyter`.


Do you mean `sys.prefix` instead of `sys.path`? So where is Jupyter installed then?

Does nixos even have a concept like `sys.prefix` in the first place? Probably I don't know nixos well enough to understand the problem.

I should add that this problem is not Sage-specific. Many Jupyter packages install files in `sys.prefix/share/jupyter`. So I wonder how nixos deals with those.



---

archive/issue_comments_389983.json:
```json
{
    "body": "<a id='comment:6'></a>\nReplying to [jdemeyer](#comment%3A5):\n> Replying to [gh-timokau](#comment%3A4):\n> > I don't have any experience with jupyter, but wouldn't it be the correct and expected behaviour to use the user's jupyter instead of the system one?\n\n> \n> No. Installing a Jupyter kernel is not much different from installing a Python package: Sage doesn't install Python packages in the user's directory either.\n\n\nOkay I guess `jupyter_path()` is meant to be used to *discover* jupyter files, not install them. That's why it gives back a list and why the user directory has highest precedence (which is correct for discovery).\n\nIt looks like jupyter doesn't provide a standard way to find the correct directory to install to. Since `ENV_JUPYTER_PATH` is hardcoded as `sys.prefix/share/jupyter` (yes I meant prefix), what do you think about adding a configuration variable to env.py that defaults  to `sys.prefix/share/jupyter`? Maybe `JUPYTER_TARGET_DIR`?\n\n> > Specifically what I'm trying to fix is that in nixos jupyter is *not* in `sys.path/share/jupyter`.\n\n> \n> Do you mean `sys.prefix` instead of `sys.path`? So where is Jupyter installed then?\n> \n> Does nixos even have a concept like `sys.prefix` in the first place? Probably I don't know nixos well enough to understand the problem.\n\n\nThe basic idea of nix is that every package gets installed under `/nix/store/<unique-package-hash>-pkg-name` (allowing mulitple versions of a package to be installed side-by-side, guaranteeing immutability etc.).\n\nThe current jupyter version for example is in `/nix/store/siicvck75m8qw0rvs303m8svgdrp3rz1-python2.7-jupyter_core-4.4.0`. So no, there is no `sys.prefix`.\n\n> I should add that this problem is not Sage-specific. Many Jupyter packages install files in `sys.prefix/share/jupyter`. So I wonder how nixos deals with those.\n\n\nI don't know about other software with that problem. In fact jupyter support for nix is currently worked on[1] so there is not much jupyter software around yet.\n\n[1] https://github.com/NixOS/nixpkgs/pull/33673#issuecomment-394610280",
    "created_at": "2018-06-06T20:03:54Z",
    "issue": "https://github.com/sagemath/sage/issues/25328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25328#issuecomment-389983",
    "user": "https://github.com/timokau"
}
```

<a id='comment:6'></a>
Replying to [jdemeyer](#comment%3A5):
> Replying to [gh-timokau](#comment%3A4):
> > I don't have any experience with jupyter, but wouldn't it be the correct and expected behaviour to use the user's jupyter instead of the system one?

> 
> No. Installing a Jupyter kernel is not much different from installing a Python package: Sage doesn't install Python packages in the user's directory either.


Okay I guess `jupyter_path()` is meant to be used to *discover* jupyter files, not install them. That's why it gives back a list and why the user directory has highest precedence (which is correct for discovery).

It looks like jupyter doesn't provide a standard way to find the correct directory to install to. Since `ENV_JUPYTER_PATH` is hardcoded as `sys.prefix/share/jupyter` (yes I meant prefix), what do you think about adding a configuration variable to env.py that defaults  to `sys.prefix/share/jupyter`? Maybe `JUPYTER_TARGET_DIR`?

> > Specifically what I'm trying to fix is that in nixos jupyter is *not* in `sys.path/share/jupyter`.

> 
> Do you mean `sys.prefix` instead of `sys.path`? So where is Jupyter installed then?
> 
> Does nixos even have a concept like `sys.prefix` in the first place? Probably I don't know nixos well enough to understand the problem.


The basic idea of nix is that every package gets installed under `/nix/store/<unique-package-hash>-pkg-name` (allowing mulitple versions of a package to be installed side-by-side, guaranteeing immutability etc.).

The current jupyter version for example is in `/nix/store/siicvck75m8qw0rvs303m8svgdrp3rz1-python2.7-jupyter_core-4.4.0`. So no, there is no `sys.prefix`.

> I should add that this problem is not Sage-specific. Many Jupyter packages install files in `sys.prefix/share/jupyter`. So I wonder how nixos deals with those.


I don't know about other software with that problem. In fact jupyter support for nix is currently worked on[1] so there is not much jupyter software around yet.

[1] https://github.com/NixOS/nixpkgs/pull/33673#issuecomment-394610280



---

archive/issue_comments_389984.json:
```json
{
    "body": "<a id='comment:7'></a>\nReplying to [gh-timokau](#comment%3A6):\n> It looks like jupyter doesn't provide a standard way to find the correct directory to install to.\n\n\nI would say that this is really a distutils issue rather than a Jupyter issue because it's distutils which should figure out installation directories.",
    "created_at": "2018-06-06T20:23:47Z",
    "issue": "https://github.com/sagemath/sage/issues/25328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25328#issuecomment-389984",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>
Replying to [gh-timokau](#comment%3A6):
> It looks like jupyter doesn't provide a standard way to find the correct directory to install to.


I would say that this is really a distutils issue rather than a Jupyter issue because it's distutils which should figure out installation directories.



---

archive/issue_comments_389985.json:
```json
{
    "body": "<a id='comment:8'></a>\nReplying to [jdemeyer](#comment%3A7):\n> Replying to [gh-timokau](#comment%3A6):\n> > It looks like jupyter doesn't provide a standard way to find the correct directory to install to.\n\n> \n> I would say that this is really a distutils issue rather than a Jupyter issue because it's distutils which should figure out installation directories.\n\n\nBut this is jupyter specific, not a standard python package.\n\nWhatever is at fault, what do you think about the `JUPYTER_TARGET_DIR` approach? Should I implement that?",
    "created_at": "2018-06-06T21:19:22Z",
    "issue": "https://github.com/sagemath/sage/issues/25328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25328#issuecomment-389985",
    "user": "https://github.com/timokau"
}
```

<a id='comment:8'></a>
Replying to [jdemeyer](#comment%3A7):
> Replying to [gh-timokau](#comment%3A6):
> > It looks like jupyter doesn't provide a standard way to find the correct directory to install to.

> 
> I would say that this is really a distutils issue rather than a Jupyter issue because it's distutils which should figure out installation directories.


But this is jupyter specific, not a standard python package.

Whatever is at fault, what do you think about the `JUPYTER_TARGET_DIR` approach? Should I implement that?



---

archive/issue_comments_389986.json:
```json
{
    "body": "<a id='comment:9'></a>\nFrom the point of view of regular distribution which build sage with the intent of installing things system wide this patch would be awful. It would result in the kernel being installed in a place not considered for installation. We definitely want a `sys.prefix` location. Using `ENV_JUPYTER_PATH` is admittedly problematic, I am not sure about a `JUPYTER_TARGET_DIR` approach.",
    "created_at": "2018-06-06T23:39:44Z",
    "issue": "https://github.com/sagemath/sage/issues/25328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25328#issuecomment-389986",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:9'></a>
From the point of view of regular distribution which build sage with the intent of installing things system wide this patch would be awful. It would result in the kernel being installed in a place not considered for installation. We definitely want a `sys.prefix` location. Using `ENV_JUPYTER_PATH` is admittedly problematic, I am not sure about a `JUPYTER_TARGET_DIR` approach.



---

archive/issue_comments_389987.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [gh-timokau](#comment%3A8):\n> Whatever is at fault, what do you think about the `JUPYTER_TARGET_DIR` approach? Should I implement that?\n\n\nAs I said, this has nothing to do with Jupyter, so you might as well call it `PYTHON_TARGET_PREFIX` or whatever.",
    "created_at": "2018-06-07T05:23:21Z",
    "issue": "https://github.com/sagemath/sage/issues/25328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25328#issuecomment-389987",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>
Replying to [gh-timokau](#comment%3A8):
> Whatever is at fault, what do you think about the `JUPYTER_TARGET_DIR` approach? Should I implement that?


As I said, this has nothing to do with Jupyter, so you might as well call it `PYTHON_TARGET_PREFIX` or whatever.



---

archive/issue_comments_389988.json:
```json
{
    "body": "<a id='comment:11'></a>\nDoes nixos patch distutils to install stuff in non-standard locations?",
    "created_at": "2018-06-07T05:27:31Z",
    "issue": "https://github.com/sagemath/sage/issues/25328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25328#issuecomment-389988",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>
Does nixos patch distutils to install stuff in non-standard locations?



---

archive/issue_comments_389989.json:
```json
{
    "body": "<a id='comment:12'></a>\nI asked the question about patching distutils because most Jupyter kernels simply use `setup.py` to install those files. \n\nSage has hand-written code for that (I guess mainly because some files are generated, not copied). The *default* install location (using distutils) is `sys.prefix/share/jupyter` so Sage assumes that. Of course, if you patch distutils, then this might no longer be correct.\n\nSo I think the best solution might be to install the Jupyter kernel of Sage using a `setup.py` script. Maybe we should even make it a separate package.\n\n(Note that when I said \"distutils\" it applies to setuptools and pip too because those just extensions of distutils)",
    "created_at": "2018-06-07T07:38:05Z",
    "issue": "https://github.com/sagemath/sage/issues/25328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25328#issuecomment-389989",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>
I asked the question about patching distutils because most Jupyter kernels simply use `setup.py` to install those files. 

Sage has hand-written code for that (I guess mainly because some files are generated, not copied). The *default* install location (using distutils) is `sys.prefix/share/jupyter` so Sage assumes that. Of course, if you patch distutils, then this might no longer be correct.

So I think the best solution might be to install the Jupyter kernel of Sage using a `setup.py` script. Maybe we should even make it a separate package.

(Note that when I said "distutils" it applies to setuptools and pip too because those just extensions of distutils)



---

archive/issue_comments_389990.json:
```json
{
    "body": "<a id='comment:13'></a>\nReplying to [fbissey](#comment%3A9):\n> From the point of view of regular distribution which build sage with the intent of installing things system wide this patch would be awful.\n> It would result in the kernel being installed in a place not considered for installation. We definitely want a sys.prefix location. Using ENV_JUPYTER_PATH is admittedly problematic, I am not sure about a JUPYTER_TARGET_DIR approach. \n\n\nYeah the `paths.jupyter_path()[0]` solution isn't viable. The `JUPYTER_TARGET_DIR` approach would remain the default unchanged but make it configurable.\n\nReplying to [jdemeyer](#comment%3A10):\n> Replying to [gh-timokau](#comment%3A8):\n> > Whatever is at fault, what do you think about the `JUPYTER_TARGET_DIR` approach? Should I implement that?\n\n> \n> As I said, this has nothing to do with Jupyter, so you might as well call it `PYTHON_TARGET_PREFIX` or whatever.\n\n\nWhy doesn't it have anything to do with Jupyter? It is the installation location for a Jupyter package after all. Although I don't really have any strong opionion about the variable name.\n\nReplying to [jdemeyer](#comment%3A11):\n> Does nixos patch distutils to install stuff in non-standard locations?\n\n\nI don't think it does, but I'd have to ask our python maintainer/expert. Grepping through nixpkgs, it seems like the standard python install is basically:\n\n```\npip install *.whl --no-index --prefix=$out --no-cache ${toString installFlags} --build tmpbuild\n```\n\nSo `--prefix` has that purpose. For nixos the jupyter kernel should be installed in\n\n/nix/store/<hash>-sage-8.2/share/jupyter\n\nor even into a sage-jupyter directory. But sage tries to instead install it to\n\n/nix/store/<hash>-python-2.7.14/share/jupyter\n\nReplying to [jdemeyer](#comment%3A12):\n> So I think the best solution might be to install the Jupyter kernel of Sage using a `setup.py` script. Maybe we should even make it a separate package.\n\n\nSeperating the jupyter kernel sounds like the best option to me. At least archlinux (didn't check other distros) seperates it already. I don't know enough about jupyter and sage to do that myself though.",
    "created_at": "2018-06-07T18:01:08Z",
    "issue": "https://github.com/sagemath/sage/issues/25328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25328#issuecomment-389990",
    "user": "https://github.com/timokau"
}
```

<a id='comment:13'></a>
Replying to [fbissey](#comment%3A9):
> From the point of view of regular distribution which build sage with the intent of installing things system wide this patch would be awful.
> It would result in the kernel being installed in a place not considered for installation. We definitely want a sys.prefix location. Using ENV_JUPYTER_PATH is admittedly problematic, I am not sure about a JUPYTER_TARGET_DIR approach. 


Yeah the `paths.jupyter_path()[0]` solution isn't viable. The `JUPYTER_TARGET_DIR` approach would remain the default unchanged but make it configurable.

Replying to [jdemeyer](#comment%3A10):
> Replying to [gh-timokau](#comment%3A8):
> > Whatever is at fault, what do you think about the `JUPYTER_TARGET_DIR` approach? Should I implement that?

> 
> As I said, this has nothing to do with Jupyter, so you might as well call it `PYTHON_TARGET_PREFIX` or whatever.


Why doesn't it have anything to do with Jupyter? It is the installation location for a Jupyter package after all. Although I don't really have any strong opionion about the variable name.

Replying to [jdemeyer](#comment%3A11):
> Does nixos patch distutils to install stuff in non-standard locations?


I don't think it does, but I'd have to ask our python maintainer/expert. Grepping through nixpkgs, it seems like the standard python install is basically:

```
pip install *.whl --no-index --prefix=$out --no-cache ${toString installFlags} --build tmpbuild
```

So `--prefix` has that purpose. For nixos the jupyter kernel should be installed in

/nix/store/<hash>-sage-8.2/share/jupyter

or even into a sage-jupyter directory. But sage tries to instead install it to

/nix/store/<hash>-python-2.7.14/share/jupyter

Replying to [jdemeyer](#comment%3A12):
> So I think the best solution might be to install the Jupyter kernel of Sage using a `setup.py` script. Maybe we should even make it a separate package.


Seperating the jupyter kernel sounds like the best option to me. At least archlinux (didn't check other distros) seperates it already. I don't know enough about jupyter and sage to do that myself though.



---

archive/issue_comments_389991.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [gh-timokau](#comment%3A13):\n> ```\n> pip install *.whl --no-index --prefix=$out --no-cache ${toString installFlags} --build tmpbuild\n> ```\n\n\nAnd this is used for building Sage? I very doubt that Sage can be installed using `pip`.",
    "created_at": "2018-06-07T19:14:05Z",
    "issue": "https://github.com/sagemath/sage/issues/25328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25328#issuecomment-389991",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>
Replying to [gh-timokau](#comment%3A13):
> ```
> pip install *.whl --no-index --prefix=$out --no-cache ${toString installFlags} --build tmpbuild
> ```


And this is used for building Sage? I very doubt that Sage can be installed using `pip`.



---

archive/issue_comments_389992.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [jdemeyer](#comment%3A14):\n> Replying to [gh-timokau](#comment%3A13):\n> > ```\n> > pip install *.whl --no-index --prefix=$out --no-cache ${toString installFlags} --build tmpbuild\n> > ```\n\n> \n> And this is used for building Sage? I very doubt that Sage can be installed using `pip`.\n\n\nNo, that is the python default. For sage I overrode the buildPhase with `python -u setup.py --no-user-cfg build`.",
    "created_at": "2018-06-07T20:17:19Z",
    "issue": "https://github.com/sagemath/sage/issues/25328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25328#issuecomment-389992",
    "user": "https://github.com/timokau"
}
```

<a id='comment:15'></a>
Replying to [jdemeyer](#comment%3A14):
> Replying to [gh-timokau](#comment%3A13):
> > ```
> > pip install *.whl --no-index --prefix=$out --no-cache ${toString installFlags} --build tmpbuild
> > ```

> 
> And this is used for building Sage? I very doubt that Sage can be installed using `pip`.


No, that is the python default. For sage I overrode the buildPhase with `python -u setup.py --no-user-cfg build`.



---

archive/issue_comments_389993.json:
```json
{
    "body": "<a id='comment:16'></a>\nReplying to [gh-timokau](#comment%3A15):\n> For sage I overrode the buildPhase with `python -u setup.py --no-user-cfg build`.\n\n\nBut then you're not setting the installation prefix, so it's not surprising that it fails.",
    "created_at": "2018-06-08T08:17:05Z",
    "issue": "https://github.com/sagemath/sage/issues/25328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25328#issuecomment-389993",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:16'></a>
Replying to [gh-timokau](#comment%3A15):
> For sage I overrode the buildPhase with `python -u setup.py --no-user-cfg build`.


But then you're not setting the installation prefix, so it's not surprising that it fails.



---

archive/issue_comments_389994.json:
```json
{
    "body": "<a id='comment:17'></a>\nReplying to [jdemeyer](#comment%3A16):\n> Replying to [gh-timokau](#comment%3A15):\n> > For sage I overrode the buildPhase with `python -u setup.py --no-user-cfg build`.\n\n> \n> But then you're not setting the installation prefix, so it's not surprising that it fails.\n\n\nI do set it in the installPhase:\n\n```\npython2 -u setup.py --no-user-cfg install --prefix=$out\n```\n\nI don't think it is possible to pass `--prefix` to build, right? At least it wouldn't make much sense. So apparently the kernel is installed in the `build` phase of `setup.py`?",
    "created_at": "2018-06-08T13:21:50Z",
    "issue": "https://github.com/sagemath/sage/issues/25328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25328#issuecomment-389994",
    "user": "https://github.com/timokau"
}
```

<a id='comment:17'></a>
Replying to [jdemeyer](#comment%3A16):
> Replying to [gh-timokau](#comment%3A15):
> > For sage I overrode the buildPhase with `python -u setup.py --no-user-cfg build`.

> 
> But then you're not setting the installation prefix, so it's not surprising that it fails.


I do set it in the installPhase:

```
python2 -u setup.py --no-user-cfg install --prefix=$out
```

I don't think it is possible to pass `--prefix` to build, right? At least it wouldn't make much sense. So apparently the kernel is installed in the `build` phase of `setup.py`?



---

archive/issue_comments_389995.json:
```json
{
    "body": "<a id='comment:18'></a>\nI wouldn't assume that Sage really has a clean separation between `build` and `install`. I think it's safer to run only `install`, not `build`.",
    "created_at": "2018-06-08T14:53:43Z",
    "issue": "https://github.com/sagemath/sage/issues/25328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25328#issuecomment-389995",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>
I wouldn't assume that Sage really has a clean separation between `build` and `install`. I think it's safer to run only `install`, not `build`.



---

archive/issue_comments_389996.json:
```json
{
    "body": "<a id='comment:19'></a>\nSee also #21507",
    "created_at": "2018-06-08T14:56:22Z",
    "issue": "https://github.com/sagemath/sage/issues/25328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25328#issuecomment-389996",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:19'></a>
See also #21507



---

archive/issue_comments_389997.json:
```json
{
    "body": "<a id='comment:20'></a>\nReplying to [jdemeyer](#comment%3A18):\n> I wouldn't assume that Sage really has a clean separation between `build` and `install`. I think it's safer to run only `install`, not `build`.\n\n\nI didn't know that was possible, interesting. However it currently works except for this jupyter issue. Splitting the two has various advantages, for example the build can happen in a tmpfs.\n\nReading the `setup.py` does suggest that the kernel spec is installed in `install` though. The function is called in `sage_install`.",
    "created_at": "2018-06-08T15:02:37Z",
    "issue": "https://github.com/sagemath/sage/issues/25328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25328#issuecomment-389997",
    "user": "https://github.com/timokau"
}
```

<a id='comment:20'></a>
Replying to [jdemeyer](#comment%3A18):
> I wouldn't assume that Sage really has a clean separation between `build` and `install`. I think it's safer to run only `install`, not `build`.


I didn't know that was possible, interesting. However it currently works except for this jupyter issue. Splitting the two has various advantages, for example the build can happen in a tmpfs.

Reading the `setup.py` does suggest that the kernel spec is installed in `install` though. The function is called in `sage_install`.



---

archive/issue_comments_389998.json:
```json
{
    "body": "<a id='comment:21'></a>\nReplying to [jdemeyer](#comment%3A19):\n> See also #21507\n\n\nThats very interesting. Apparently fbissey already mentioned pretty much this exact problem in [#21507 comment:31](https://github.com/sagemath/sage/issues/21507#comment:31) and it was discussed a bit, but then apparently dropped.",
    "created_at": "2018-06-08T15:10:57Z",
    "issue": "https://github.com/sagemath/sage/issues/25328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25328#issuecomment-389998",
    "user": "https://github.com/timokau"
}
```

<a id='comment:21'></a>
Replying to [jdemeyer](#comment%3A19):
> See also #21507


Thats very interesting. Apparently fbissey already mentioned pretty much this exact problem in [#21507 comment:31](https://github.com/sagemath/sage/issues/21507#comment:31) and it was discussed a bit, but then apparently dropped.



---

archive/issue_comments_389999.json:
```json
{
    "body": "<a id='comment:22'></a>\nReplying to [gh-timokau](#comment%3A20):\n> Reading the `setup.py` does suggest that the kernel spec is installed in `install` though. The function is called in `sage_install`.\n\n\nYes, you are right.\n\nI think the issue might be confusion between the \"installation prefix\" and `sys.prefix` which may not be the same thing.",
    "created_at": "2018-06-08T15:12:00Z",
    "issue": "https://github.com/sagemath/sage/issues/25328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25328#issuecomment-389999",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'></a>
Replying to [gh-timokau](#comment%3A20):
> Reading the `setup.py` does suggest that the kernel spec is installed in `install` though. The function is called in `sage_install`.


Yes, you are right.

I think the issue might be confusion between the "installation prefix" and `sys.prefix` which may not be the same thing.



---

archive/issue_comments_390000.json:
```json
{
    "body": "<a id='comment:23'></a>\nI have an idea for solving this, hang on...",
    "created_at": "2018-06-08T15:22:52Z",
    "issue": "https://github.com/sagemath/sage/issues/25328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25328#issuecomment-390000",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:23'></a>
I have an idea for solving this, hang on...



---

archive/issue_comments_390001.json:
```json
{
    "body": "<a id='comment:24'></a>\nSee #25546",
    "created_at": "2018-06-08T17:52:09Z",
    "issue": "https://github.com/sagemath/sage/issues/25328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25328#issuecomment-390001",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'></a>
See #25546



---

archive/issue_comments_390002.json:
```json
{
    "body": "<a id='comment:25'></a>\nSo does #25546 fix your issue?",
    "created_at": "2018-06-14T14:13:26Z",
    "issue": "https://github.com/sagemath/sage/issues/25328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25328#issuecomment-390002",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:25'></a>
So does #25546 fix your issue?



---

archive/issue_comments_390003.json:
```json
{
    "body": "<a id='comment:26'></a>\nIf I just replace my JUPYTER_PATH patch with #25546 I get a few errors:\n\n```\nFailed example:\n    spec.use_local_mathjax()\nException raised:\n    Traceback (most recent call last):\n      File \"/nix/store/3s097s5b25czl1sz747h2dl6szf0ckz3-python-2.7.15-env/lib/python2.7/site-packages/sage/doctest/forker.py\", line 551, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/nix/store/3s097s5b25czl1sz747h2dl6szf0ckz3-python-2.7.15-env/lib/python2.7/site-packages/sage/doctest/forker.py\", line 961, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.repl.ipython_kernel.install.SageKernelSpec.use_local_mathjax[2]>\", line 1, in <module>\n        spec.use_local_mathjax()\n      File \"/nix/store/3s097s5b25czl1sz747h2dl6szf0ckz3-python-2.7.15-env/lib/python2.7/site-packages/sage/repl/ipython_kernel/install.py\", line 123, in use_local_mathjax\n        self.symlink(src, dst)\n      File \"/nix/store/3s097s5b25czl1sz747h2dl6szf0ckz3-python-2.7.15-env/lib/python2.7/site-packages/sage/repl/ipython_kernel/install.py\", line 106, in symlink\n        os.symlink(src, dst)\n    OSError: [Errno 17] File exists\n**********************************************************************\nFile \"/nix/store/flwvb6s36sp7slwbrwsahg29jw0i3nha-sage-src-8.2/src/sage/repl/ipython_kernel/install.py\", line 118, in sage.repl.ipython_kernel.install.SageKernelSpec.use_local_mathjax\nFailed example:\n    os.path.isdir(mathjax)\nExpected:\n    True\nGot:\n    False\n**********************************************************************\nFile \"/nix/store/flwvb6s36sp7slwbrwsahg29jw0i3nha-sage-src-8.2/src/sage/repl/ipython_kernel/install.py\", line 133, in sage.repl.ipython_kernel.install.SageKernelSpec.use_local_jsmol\nFailed example:\n    spec.use_local_jsmol()\nException raised:\n    Traceback (most recent call last):\n      File \"/nix/store/3s097s5b25czl1sz747h2dl6szf0ckz3-python-2.7.15-env/lib/python2.7/site-packages/sage/doctest/forker.py\", line 551, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/nix/store/3s097s5b25czl1sz747h2dl6szf0ckz3-python-2.7.15-env/lib/python2.7/site-packages/sage/doctest/forker.py\", line 961, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.repl.ipython_kernel.install.SageKernelSpec.use_local_jsmol[2]>\", line 1, in <module>\n        spec.use_local_jsmol()\n      File \"/nix/store/3s097s5b25czl1sz747h2dl6szf0ckz3-python-2.7.15-env/lib/python2.7/site-packages/sage/repl/ipython_kernel/install.py\", line 140, in use_local_jsmol\n        self.symlink(src, dst)\n      File \"/nix/store/3s097s5b25czl1sz747h2dl6szf0ckz3-python-2.7.15-env/lib/python2.7/site-packages/sage/repl/ipython_kernel/install.py\", line 106, in symlink\n        os.symlink(src, dst)\n    OSError: [Errno 17] File exists\n**********************************************************************\nFile \"/nix/store/flwvb6s36sp7slwbrwsahg29jw0i3nha-sage-src-8.2/src/sage/repl/ipython_kernel/install.py\", line 135, in sage.repl.ipython_kernel.install.SageKernelSpec.use_local_jsmol\nFailed example:\n    os.path.isdir(jsmol)\nExpected:\n    True\nGot:\n    False\n**********************************************************************\nFile \"/nix/store/flwvb6s36sp7slwbrwsahg29jw0i3nha-sage-src-8.2/src/sage/repl/ipython_kernel/install.py\", line 150, in sage.repl.ipython_kernel.install.SageKernelSpec.use_local_threejs\nFailed example:\n    spec.use_local_threejs()\nException raised:\n    Traceback (most recent call last):\n      File \"/nix/store/3s097s5b25czl1sz747h2dl6szf0ckz3-python-2.7.15-env/lib/python2.7/site-packages/sage/doctest/forker.py\", line 551, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/nix/store/3s097s5b25czl1sz747h2dl6szf0ckz3-python-2.7.15-env/lib/python2.7/site-packages/sage/doctest/forker.py\", line 961, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.repl.ipython_kernel.install.SageKernelSpec.use_local_threejs[2]>\", line 1, in <module>\n        spec.use_local_threejs()\n      File \"/nix/store/3s097s5b25czl1sz747h2dl6szf0ckz3-python-2.7.15-env/lib/python2.7/site-packages/sage/repl/ipython_kernel/install.py\", line 157, in use_local_threejs\n        self.symlink(src, dst)\n      File \"/nix/store/3s097s5b25czl1sz747h2dl6szf0ckz3-python-2.7.15-env/lib/python2.7/site-packages/sage/repl/ipython_kernel/install.py\", line 106, in symlink\n        os.symlink(src, dst)\n    OSError: [Errno 17] File exists\n**********************************************************************\nFile \"/nix/store/flwvb6s36sp7slwbrwsahg29jw0i3nha-sage-src-8.2/src/sage/repl/ipython_kernel/install.py\", line 152, in sage.repl.ipython_kernel.install.SageKernelSpec.use_local_threejs\nFailed example:\n    os.path.isdir(threejs)\nExpected:\n    True\nGot:\n    False\n```\n\nI don't have any time to investigate right now and I probably won't get to it until at least the 25.06.",
    "created_at": "2018-06-14T20:00:47Z",
    "issue": "https://github.com/sagemath/sage/issues/25328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25328#issuecomment-390003",
    "user": "https://github.com/timokau"
}
```

<a id='comment:26'></a>
If I just replace my JUPYTER_PATH patch with #25546 I get a few errors:

```
Failed example:
    spec.use_local_mathjax()
Exception raised:
    Traceback (most recent call last):
      File "/nix/store/3s097s5b25czl1sz747h2dl6szf0ckz3-python-2.7.15-env/lib/python2.7/site-packages/sage/doctest/forker.py", line 551, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/nix/store/3s097s5b25czl1sz747h2dl6szf0ckz3-python-2.7.15-env/lib/python2.7/site-packages/sage/doctest/forker.py", line 961, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.repl.ipython_kernel.install.SageKernelSpec.use_local_mathjax[2]>", line 1, in <module>
        spec.use_local_mathjax()
      File "/nix/store/3s097s5b25czl1sz747h2dl6szf0ckz3-python-2.7.15-env/lib/python2.7/site-packages/sage/repl/ipython_kernel/install.py", line 123, in use_local_mathjax
        self.symlink(src, dst)
      File "/nix/store/3s097s5b25czl1sz747h2dl6szf0ckz3-python-2.7.15-env/lib/python2.7/site-packages/sage/repl/ipython_kernel/install.py", line 106, in symlink
        os.symlink(src, dst)
    OSError: [Errno 17] File exists
**********************************************************************
File "/nix/store/flwvb6s36sp7slwbrwsahg29jw0i3nha-sage-src-8.2/src/sage/repl/ipython_kernel/install.py", line 118, in sage.repl.ipython_kernel.install.SageKernelSpec.use_local_mathjax
Failed example:
    os.path.isdir(mathjax)
Expected:
    True
Got:
    False
**********************************************************************
File "/nix/store/flwvb6s36sp7slwbrwsahg29jw0i3nha-sage-src-8.2/src/sage/repl/ipython_kernel/install.py", line 133, in sage.repl.ipython_kernel.install.SageKernelSpec.use_local_jsmol
Failed example:
    spec.use_local_jsmol()
Exception raised:
    Traceback (most recent call last):
      File "/nix/store/3s097s5b25czl1sz747h2dl6szf0ckz3-python-2.7.15-env/lib/python2.7/site-packages/sage/doctest/forker.py", line 551, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/nix/store/3s097s5b25czl1sz747h2dl6szf0ckz3-python-2.7.15-env/lib/python2.7/site-packages/sage/doctest/forker.py", line 961, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.repl.ipython_kernel.install.SageKernelSpec.use_local_jsmol[2]>", line 1, in <module>
        spec.use_local_jsmol()
      File "/nix/store/3s097s5b25czl1sz747h2dl6szf0ckz3-python-2.7.15-env/lib/python2.7/site-packages/sage/repl/ipython_kernel/install.py", line 140, in use_local_jsmol
        self.symlink(src, dst)
      File "/nix/store/3s097s5b25czl1sz747h2dl6szf0ckz3-python-2.7.15-env/lib/python2.7/site-packages/sage/repl/ipython_kernel/install.py", line 106, in symlink
        os.symlink(src, dst)
    OSError: [Errno 17] File exists
**********************************************************************
File "/nix/store/flwvb6s36sp7slwbrwsahg29jw0i3nha-sage-src-8.2/src/sage/repl/ipython_kernel/install.py", line 135, in sage.repl.ipython_kernel.install.SageKernelSpec.use_local_jsmol
Failed example:
    os.path.isdir(jsmol)
Expected:
    True
Got:
    False
**********************************************************************
File "/nix/store/flwvb6s36sp7slwbrwsahg29jw0i3nha-sage-src-8.2/src/sage/repl/ipython_kernel/install.py", line 150, in sage.repl.ipython_kernel.install.SageKernelSpec.use_local_threejs
Failed example:
    spec.use_local_threejs()
Exception raised:
    Traceback (most recent call last):
      File "/nix/store/3s097s5b25czl1sz747h2dl6szf0ckz3-python-2.7.15-env/lib/python2.7/site-packages/sage/doctest/forker.py", line 551, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/nix/store/3s097s5b25czl1sz747h2dl6szf0ckz3-python-2.7.15-env/lib/python2.7/site-packages/sage/doctest/forker.py", line 961, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.repl.ipython_kernel.install.SageKernelSpec.use_local_threejs[2]>", line 1, in <module>
        spec.use_local_threejs()
      File "/nix/store/3s097s5b25czl1sz747h2dl6szf0ckz3-python-2.7.15-env/lib/python2.7/site-packages/sage/repl/ipython_kernel/install.py", line 157, in use_local_threejs
        self.symlink(src, dst)
      File "/nix/store/3s097s5b25czl1sz747h2dl6szf0ckz3-python-2.7.15-env/lib/python2.7/site-packages/sage/repl/ipython_kernel/install.py", line 106, in symlink
        os.symlink(src, dst)
    OSError: [Errno 17] File exists
**********************************************************************
File "/nix/store/flwvb6s36sp7slwbrwsahg29jw0i3nha-sage-src-8.2/src/sage/repl/ipython_kernel/install.py", line 152, in sage.repl.ipython_kernel.install.SageKernelSpec.use_local_threejs
Failed example:
    os.path.isdir(threejs)
Expected:
    True
Got:
    False
```

I don't have any time to investigate right now and I probably won't get to it until at least the 25.06.



---

archive/issue_comments_390004.json:
```json
{
    "body": "<a id='comment:27'></a>\nFor the record I move the kernel spec install to `sage_setup` which I neither install or doctest. Most the doctest in that files will fail on a system wide install because they try to touch files that don't belong to users. Those doctests would probably fail just the same for me.",
    "created_at": "2018-06-14T21:18:54Z",
    "issue": "https://github.com/sagemath/sage/issues/25328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25328#issuecomment-390004",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:27'></a>
For the record I move the kernel spec install to `sage_setup` which I neither install or doctest. Most the doctest in that files will fail on a system wide install because they try to touch files that don't belong to users. Those doctests would probably fail just the same for me.



---

archive/issue_comments_390005.json:
```json
{
    "body": "<a id='comment:28'></a>\n@jdemeyer I opened a new ticket (#25722) to fix those issues by simply moving the test to a tmpdir. That in combination with your prefix-fix solves the problem for me (in a much better way than I did in this ticket). Thanks!\n\n@kiwifb I'm not having any issues with tests trying to write where they shouldn't (anymore). I've recently upstreamed a few changes like #25357. Maybe you wouldn't have any problems anymore either if you'd try again now (or after the next sage release).",
    "created_at": "2018-06-30T20:22:45Z",
    "issue": "https://github.com/sagemath/sage/issues/25328",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25328#issuecomment-390005",
    "user": "https://github.com/timokau"
}
```

<a id='comment:28'></a>
@jdemeyer I opened a new ticket (#25722) to fix those issues by simply moving the test to a tmpdir. That in combination with your prefix-fix solves the problem for me (in a much better way than I did in this ticket). Thanks!

@kiwifb I'm not having any issues with tests trying to write where they shouldn't (anymore). I've recently upstreamed a few changes like #25357. Maybe you wouldn't have any problems anymore either if you'd try again now (or after the next sage release).



---

archive/issue_events_224747.json:
```json
{
    "actor": "https://github.com/timokau",
    "created_at": "2018-06-30T20:23:07Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/25328",
    "milestone": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25328#event-224747"
}
```



---

archive/issue_events_224748.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-07-01T06:55:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25328",
    "label": "duplicate",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25328#event-224748"
}
```



---

archive/issue_events_224749.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-07-01T06:55:01Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25328",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25328#event-224749"
}
```



---

archive/issue_events_224750.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-07-01T06:55:01Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/25328",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25328#event-224750"
}
```
