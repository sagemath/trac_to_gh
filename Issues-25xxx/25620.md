# Issue 25620: Toolchain dependencies that have circular self-dependencies should not be uninstalled before reinstalling/upgrading them

archive/issues_025620.json:
```json
{
    "body": "On Cygwin I tried doing `./sage -f mpir` and everything broke.\n\nThis is because my C compiler uses mpc and mpfr, and on Cygwin (see #25816) at least, it ends up using Sage's mpc and mpfr DLLs.  This may be less of a problem on other platforms but I haven't given much thought to it yet.\n\nThe mpc and mpfr DLLs in Sage break when Sage's mpir gets uninstalled, so it's necessary *at a minimum* to also uninstall mpc and mpfr.  But at that point it might also make sense to recursively uninstall *anything* that depends on mpir.  This seems reasonable given that they'll have to be re-built anyways.\n\nIssue created by migration from https://trac.sagemath.org/ticket/25857\n\n",
    "closed_at": "2018-10-20T11:59:15Z",
    "created_at": "2018-07-13T11:54:27Z",
    "labels": [
        "component: build",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.5",
    "title": "Toolchain dependencies that have circular self-dependencies should not be uninstalled before reinstalling/upgrading them",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25620",
    "user": "https://github.com/embray"
}
```
On Cygwin I tried doing `./sage -f mpir` and everything broke.

This is because my C compiler uses mpc and mpfr, and on Cygwin (see #25816) at least, it ends up using Sage's mpc and mpfr DLLs.  This may be less of a problem on other platforms but I haven't given much thought to it yet.

The mpc and mpfr DLLs in Sage break when Sage's mpir gets uninstalled, so it's necessary *at a minimum* to also uninstall mpc and mpfr.  But at that point it might also make sense to recursively uninstall *anything* that depends on mpir.  This seems reasonable given that they'll have to be re-built anyways.

Issue created by migration from https://trac.sagemath.org/ticket/25857





---

archive/issue_comments_360853.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2018-07-13T13:07:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360853",
    "user": "https://github.com/jdemeyer"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_360854.json:
```json
{
    "body": "Replying to [ticket:25857 embray]:\n> On Cygwin I tried doing `./sage -f mpir` and everything broke.\n\n\nCan you give more details :-)\n\nI disagree with your solution: it just needs to reorder the operations from\n\n1. Uninstall\n2. Build\n3. Install\n\nto\n\n1. Build\n2. Uninstall\n3. Install\n\nThat shouldn't break anything.\n\nIf this is not easy to fix, maybe we should just disable the uninstall feature for now?",
    "created_at": "2018-07-13T13:07:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360854",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [ticket:25857 embray]:
> On Cygwin I tried doing `./sage -f mpir` and everything broke.


Can you give more details :-)

I disagree with your solution: it just needs to reorder the operations from

1. Uninstall
2. Build
3. Install

to

1. Build
2. Uninstall
3. Install

That shouldn't break anything.

If this is not easy to fix, maybe we should just disable the uninstall feature for now?



---

archive/issue_comments_360855.json:
```json
{
    "body": "Replying to [comment:1 jdemeyer]:\n> Replying to [ticket:25857 embray]:\n> > On Cygwin I tried doing `./sage -f mpir` and everything broke.\n\n> \n> Can you give more details :-)\n\n\nI think I did in the description.  By \"everything\" I mean that as soon as mpir's configure tries to detect a C compiler, gcc breaks because it's loading DLLs from `$SAGE_LOCAL` (ugh), and those DLLs are in turn compiled against the mpir from Sage, and are incompatible with my system's GMP.\n\nThe problem here is my system's gcc using libraries from Sage, when it really shouldn't.  But this is a little difficult to avoid, unless I can patch things somewhere so that executables from the system such as gcc or git are explicitly *not* run with Sage's environment modifications (e.g. to `$PATH`).  I believe this is less of a problem on Linux.\n\n> I disagree with your solution: it just needs to reorder the operations from\n\n\nWhy?  I think it's a rather sensible solution.\n\n> 1. Uninstall\n> 2. Build\n> 3. Install\n> \n> to\n> \n> 1. Build\n> 2. Uninstall\n> 3. Install\n\n\nIt sort of depends on what you mean by \"order of operations\".  Currently, `sage-spkg` does the second process, which is certainly my preference.  (This process has its own problems, e.g. when building Python--this is partly Python's fault, and partly our fault for not providing better isolation between build and runtime environments.)\n\nHowever, when you run `./sage -f` like I did, it manually calls `make <pkg>-clean` before calling `make <pkg>`.  Perhaps it shouldn't.  \n\nI don't consider this a blocker though, unless the problem can be reproduced other than on Cygwin, since I'm pretty much the only person who does development on Cygwin, and this isn't a normal use case.",
    "created_at": "2018-07-13T13:41:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360855",
    "user": "https://github.com/embray"
}
```

Replying to [comment:1 jdemeyer]:
> Replying to [ticket:25857 embray]:
> > On Cygwin I tried doing `./sage -f mpir` and everything broke.

> 
> Can you give more details :-)


I think I did in the description.  By "everything" I mean that as soon as mpir's configure tries to detect a C compiler, gcc breaks because it's loading DLLs from `$SAGE_LOCAL` (ugh), and those DLLs are in turn compiled against the mpir from Sage, and are incompatible with my system's GMP.

The problem here is my system's gcc using libraries from Sage, when it really shouldn't.  But this is a little difficult to avoid, unless I can patch things somewhere so that executables from the system such as gcc or git are explicitly *not* run with Sage's environment modifications (e.g. to `$PATH`).  I believe this is less of a problem on Linux.

> I disagree with your solution: it just needs to reorder the operations from


Why?  I think it's a rather sensible solution.

> 1. Uninstall
> 2. Build
> 3. Install
> 
> to
> 
> 1. Build
> 2. Uninstall
> 3. Install


It sort of depends on what you mean by "order of operations".  Currently, `sage-spkg` does the second process, which is certainly my preference.  (This process has its own problems, e.g. when building Python--this is partly Python's fault, and partly our fault for not providing better isolation between build and runtime environments.)

However, when you run `./sage -f` like I did, it manually calls `make <pkg>-clean` before calling `make <pkg>`.  Perhaps it shouldn't.  

I don't consider this a blocker though, unless the problem can be reproduced other than on Cygwin, since I'm pretty much the only person who does development on Cygwin, and this isn't a normal use case.



---

archive/issue_comments_360856.json:
```json
{
    "body": "FWIW I did lots of testing of the uninstaller on Linux, including doing odd things like `./sage -f mpir` (and I did specifically focus on mpir due to its involvement in tricky dependency cycles). Never saw any problem like this.",
    "created_at": "2018-07-13T13:42:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360856",
    "user": "https://github.com/embray"
}
```

FWIW I did lots of testing of the uninstaller on Linux, including doing odd things like `./sage -f mpir` (and I did specifically focus on mpir due to its involvement in tricky dependency cycles). Never saw any problem like this.



---

archive/issue_comments_360857.json:
```json
{
    "body": "Anyways, a lot more packages have problems if you *don't* remove their previous versions before building new versions of those packages, than the other way around.  In this case, it's because mpir has dependents that are in turn dependencies of the compiler.  In that case I would just uninstall all of mpir's dependents as well, hence my suggestion of recursive uninstall.\n\nI don't like uninstalling things before their replacements are built, but it seems that's pretty necessary a lot of the time.  For that reason I think I'll place a higher priority on #25202.",
    "created_at": "2018-07-13T13:45:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360857",
    "user": "https://github.com/embray"
}
```

Anyways, a lot more packages have problems if you *don't* remove their previous versions before building new versions of those packages, than the other way around.  In this case, it's because mpir has dependents that are in turn dependencies of the compiler.  In that case I would just uninstall all of mpir's dependents as well, hence my suggestion of recursive uninstall.

I don't like uninstalling things before their replacements are built, but it seems that's pretty necessary a lot of the time.  For that reason I think I'll place a higher priority on #25202.



---

archive/issue_comments_360858.json:
```json
{
    "body": "This reminds me--did you ever get anywhere with creating a separate build-time package for mpir?  Something like that might also help.  Same for the other \"toolchain-deps\" (zlib, mpfr, mpc).  They all share the problem that breaking them can break the C compiler which, in turn, needs them to build.",
    "created_at": "2018-07-13T13:58:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360858",
    "user": "https://github.com/embray"
}
```

This reminds me--did you ever get anywhere with creating a separate build-time package for mpir?  Something like that might also help.  Same for the other "toolchain-deps" (zlib, mpfr, mpc).  They all share the problem that breaking them can break the C compiler which, in turn, needs them to build.



---

archive/issue_comments_360859.json:
```json
{
    "body": "Replying to [comment:4 embray]:\n> In that case I would just uninstall all of mpir's dependents as well, hence my suggestion of recursive uninstall.\n\n\nHow would you deal with a Sage-built GCC? That will obviously depend on Sage's MPIR too.",
    "created_at": "2018-07-13T14:13:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360859",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:4 embray]:
> In that case I would just uninstall all of mpir's dependents as well, hence my suggestion of recursive uninstall.


How would you deal with a Sage-built GCC? That will obviously depend on Sage's MPIR too.



---

archive/issue_comments_360860.json:
```json
{
    "body": "Replying to [comment:5 embray]:\n> This reminds me--did you ever get anywhere with creating a separate build-time package for mpir?\n\n\nCreating a separate package might simplify the build system, but it wouldn't fix the uninstall problem.",
    "created_at": "2018-07-13T14:14:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360860",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:5 embray]:
> This reminds me--did you ever get anywhere with creating a separate build-time package for mpir?


Creating a separate package might simplify the build system, but it wouldn't fix the uninstall problem.



---

archive/issue_comments_360861.json:
```json
{
    "body": "Replying to [comment:3 embray]:\n> FWIW I did lots of testing of the uninstaller on Linux, including doing odd things like `./sage -f mpir` (and I did specifically focus on mpir due to its involvement in tricky dependency cycles). Never saw any problem like this.\n\n\nDid you do that with a Sage-built GCC? That's where things get tricky.",
    "created_at": "2018-07-13T14:15:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360861",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:3 embray]:
> FWIW I did lots of testing of the uninstaller on Linux, including doing odd things like `./sage -f mpir` (and I did specifically focus on mpir due to its involvement in tricky dependency cycles). Never saw any problem like this.


Did you do that with a Sage-built GCC? That's where things get tricky.



---

archive/issue_comments_360862.json:
```json
{
    "body": "A few additional thoughts:\n\na) As for sage-gcc, recursively uninstalling all dependents doubly makes sense.  If you rebuild mpir you have to rebuild gcc anyways.\n\nb) I'm thinking at the very least recursive uninstall should happen for all the \"toolchain-deps\"\n\nc) Something I think would make all of this work better (either instead of, or parallel to separate packages), would be to have a separate install prefix, either under `$SAGE_LOCAL` or parallel to `$SAGE_LOCAL` or all toolchain dependencies.  This prefix would be superseded by the usual SAGE_LOCAL paths, so the bootstrap toolchain never entirely goes away, but packages that are otherwise dependents of the toolchain can still be upgraded without breaking the existing toolchain.",
    "created_at": "2018-07-13T14:22:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360862",
    "user": "https://github.com/embray"
}
```

A few additional thoughts:

a) As for sage-gcc, recursively uninstalling all dependents doubly makes sense.  If you rebuild mpir you have to rebuild gcc anyways.

b) I'm thinking at the very least recursive uninstall should happen for all the "toolchain-deps"

c) Something I think would make all of this work better (either instead of, or parallel to separate packages), would be to have a separate install prefix, either under `$SAGE_LOCAL` or parallel to `$SAGE_LOCAL` or all toolchain dependencies.  This prefix would be superseded by the usual SAGE_LOCAL paths, so the bootstrap toolchain never entirely goes away, but packages that are otherwise dependents of the toolchain can still be upgraded without breaking the existing toolchain.



---

archive/issue_comments_360863.json:
```json
{
    "body": "Replying to [comment:8 jdemeyer]:\n> Replying to [comment:3 embray]:\n> > FWIW I did lots of testing of the uninstaller on Linux, including doing odd things like `./sage -f mpir` (and I did specifically focus on mpir due to its involvement in tricky dependency cycles). Never saw any problem like this.\n\n> \n> Did you do that with a Sage-built GCC? That's where things get tricky.\n\n\nI did, and I don't remember having any problems (again, on Linux), but that was a long time ago now so my memory is hazy.",
    "created_at": "2018-07-13T14:23:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360863",
    "user": "https://github.com/embray"
}
```

Replying to [comment:8 jdemeyer]:
> Replying to [comment:3 embray]:
> > FWIW I did lots of testing of the uninstaller on Linux, including doing odd things like `./sage -f mpir` (and I did specifically focus on mpir due to its involvement in tricky dependency cycles). Never saw any problem like this.

> 
> Did you do that with a Sage-built GCC? That's where things get tricky.


I did, and I don't remember having any problems (again, on Linux), but that was a long time ago now so my memory is hazy.



---

archive/issue_comments_360864.json:
```json
{
    "body": "Replying to [comment:10 embray]:\n> I did, and I don't remember having any problems (again, on Linux)\n\n\nMaybe your system GMP libraries were compatible with the Sage MPIR libraries, so the GCC-in-Sage used your system GMP library while MPIR was being rebuilt? Just guessing...",
    "created_at": "2018-07-13T14:28:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360864",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:10 embray]:
> I did, and I don't remember having any problems (again, on Linux)


Maybe your system GMP libraries were compatible with the Sage MPIR libraries, so the GCC-in-Sage used your system GMP library while MPIR was being rebuilt? Just guessing...



---

archive/issue_comments_360865.json:
```json
{
    "body": "I'd think it would almost have to.  I don't see how else it could work.\n\nAll the more reason to have separate copies as \"toolchain dependencies\", and even then only needed when doing silly things like building gcc.  Then, a developer wanting to do things (such as I was doing) like experiment with patching and reconfiguring mpir can do so on top of that without breaking the toolchain.",
    "created_at": "2018-07-13T14:36:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360865",
    "user": "https://github.com/embray"
}
```

I'd think it would almost have to.  I don't see how else it could work.

All the more reason to have separate copies as "toolchain dependencies", and even then only needed when doing silly things like building gcc.  Then, a developer wanting to do things (such as I was doing) like experiment with patching and reconfiguring mpir can do so on top of that without breaking the toolchain.



---

archive/issue_comments_360866.json:
```json
{
    "body": "The question is what can we do *right now* to fix this serious bug?",
    "created_at": "2018-07-13T14:53:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360866",
    "user": "https://github.com/jdemeyer"
}
```

The question is what can we do *right now* to fix this serious bug?



---

archive/issue_comments_360867.json:
```json
{
    "body": "Unless someone can reproduce this outside of Cygwin, I don't think it's that serious.  I just installed sage-gcc on a Linux build and am trying all manner of `./sage -f mpir/gcc/etc` without any problems.\n\nI'm going to keep thinking about it though.  If I can find a simple solution that works for Cygwin I believe it would work on Linux as well.  Perhaps one very localized solution would be that if one of the `toolchain-deps` gets uninstalled they should all be uninstalled and rebuilt.",
    "created_at": "2018-07-13T15:19:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360867",
    "user": "https://github.com/embray"
}
```

Unless someone can reproduce this outside of Cygwin, I don't think it's that serious.  I just installed sage-gcc on a Linux build and am trying all manner of `./sage -f mpir/gcc/etc` without any problems.

I'm going to keep thinking about it though.  If I can find a simple solution that works for Cygwin I believe it would work on Linux as well.  Perhaps one very localized solution would be that if one of the `toolchain-deps` gets uninstalled they should all be uninstalled and rebuilt.



---

archive/issue_comments_360868.json:
```json
{
    "body": "Replying to [comment:14 embray]:\n> Unless someone can reproduce this outside of Cygwin, I don't think it's that serious.\n\n\nGiven the analysis, I don't see any reason why this would be limited to Cygwin.",
    "created_at": "2018-07-16T10:49:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360868",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:14 embray]:
> Unless someone can reproduce this outside of Cygwin, I don't think it's that serious.


Given the analysis, I don't see any reason why this would be limited to Cygwin.



---

archive/issue_comments_360869.json:
```json
{
    "body": "Just reproduced it on Ubuntu 16.04.1 LTS (CPU architecture ppc64le) with system compiler\n\n```\ngcc (Ubuntu/IBM 5.4.0-6ubuntu1~16.04.10) 5.4.0 20160609\nCopyright (C) 2015 Free Software Foundation, Inc.\nThis is free software; see the source for copying conditions.  There is NO\nwarranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n```\n\nWhen running `./sage -f mpir` on Sage 8.3.rc1, the problem is as I predicted:\n\n```\n$ ldd local/libexec/gcc/powerpc64le-unknown-linux-gnu/7.2.0/cc1\n        linux-vdso64.so.1 =>  (0x00003fffa2290000)\n        libmpc.so.3 => /home/jdemeyer/sage-test/local/lib/libmpc.so.3 (0x00003fffa2260000)\n        libmpfr.so.6 => /home/jdemeyer/sage-test/local/lib/libmpfr.so.6 (0x00003fffa21c0000)\n        libgmp.so.23 => not found\n        libdl.so.2 => /lib/powerpc64le-linux-gnu/libdl.so.2 (0x00003fffa2180000)\n        libz.so.1 => /home/jdemeyer/sage-test/local/lib/libz.so.1 (0x00003fffa2140000)\n        libm.so.6 => /lib/powerpc64le-linux-gnu/libm.so.6 (0x00003fffa2050000)\n        libc.so.6 => /lib/powerpc64le-linux-gnu/libc.so.6 (0x00003fffa1e80000)\n        /lib64/ld64.so.2 (0x00003fffa22b0000)\n        libgmp.so.23 => not found\n        libgmp.so.23 => not found\n```\ncausing obvious build failures.",
    "created_at": "2018-07-16T11:16:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360869",
    "user": "https://github.com/jdemeyer"
}
```

Just reproduced it on Ubuntu 16.04.1 LTS (CPU architecture ppc64le) with system compiler

```
gcc (Ubuntu/IBM 5.4.0-6ubuntu1~16.04.10) 5.4.0 20160609
Copyright (C) 2015 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
```

When running `./sage -f mpir` on Sage 8.3.rc1, the problem is as I predicted:

```
$ ldd local/libexec/gcc/powerpc64le-unknown-linux-gnu/7.2.0/cc1
        linux-vdso64.so.1 =>  (0x00003fffa2290000)
        libmpc.so.3 => /home/jdemeyer/sage-test/local/lib/libmpc.so.3 (0x00003fffa2260000)
        libmpfr.so.6 => /home/jdemeyer/sage-test/local/lib/libmpfr.so.6 (0x00003fffa21c0000)
        libgmp.so.23 => not found
        libdl.so.2 => /lib/powerpc64le-linux-gnu/libdl.so.2 (0x00003fffa2180000)
        libz.so.1 => /home/jdemeyer/sage-test/local/lib/libz.so.1 (0x00003fffa2140000)
        libm.so.6 => /lib/powerpc64le-linux-gnu/libm.so.6 (0x00003fffa2050000)
        libc.so.6 => /lib/powerpc64le-linux-gnu/libc.so.6 (0x00003fffa1e80000)
        /lib64/ld64.so.2 (0x00003fffa22b0000)
        libgmp.so.23 => not found
        libgmp.so.23 => not found
```
causing obvious build failures.



---

archive/issue_comments_360870.json:
```json
{
    "body": "I'll try to reproduce that on x86_64, as I don't have access to that architecture.  But I see what you're saying in general.\n\nThere are two cases here:\n\n* without sage-gcc\n* with sage-gcc\n\nThe reason I focused here on Cygwin is that this a problem for Cygwin even *without* sage-gcc due to problems with the DLL search path on Windows.  It non-sage-gcc should not have any problem on Linux.\n\nBut it is a problem certainly for sage-gcc if it's built against a sage-mpir that is not compatible somehow or other with the system's libgmp.\n\n\nThis all goes back to (one of) Sage's original sins, which is that you're building software packages in a build environment that is also the installation target.  For most packages this is not a big problem, but for your build toolchain itself it certainly is.  This is why I think that for bootstrapping purposes the build toochain and its dependencies should have some level of isolation from the rest of the install target.\n\nAs for a solution, I'd certainly be willing to disable the new-style uninstallation as the default behavior for now. Honestly, I would have preferred to wait until more/all of DESTDIR-related updates were in, as well as #25140, though be design it's supposed to be able to work without that (and does in most cases).  But I'm hesitant because for the majority of packages it does work well now, and I'm not entirely sure what the impact would be of fully disabling it now (but maybe it would be small).\n\nSo I think for now it still might be best to find a middle-ground.  What if, for now, for toolchain dependencies only, we ensure that their files are not removed before reinstalling them?  This could work in part with cooperation from `sage-spkg` by adding a flag similar to pip's `--ignore-installed` which causes it to ignore dependencies that are already satisfied and just install on top of them, rather than uninstalling conflicting/existing dependencies first.",
    "created_at": "2018-07-16T16:42:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360870",
    "user": "https://github.com/embray"
}
```

I'll try to reproduce that on x86_64, as I don't have access to that architecture.  But I see what you're saying in general.

There are two cases here:

* without sage-gcc
* with sage-gcc

The reason I focused here on Cygwin is that this a problem for Cygwin even *without* sage-gcc due to problems with the DLL search path on Windows.  It non-sage-gcc should not have any problem on Linux.

But it is a problem certainly for sage-gcc if it's built against a sage-mpir that is not compatible somehow or other with the system's libgmp.


This all goes back to (one of) Sage's original sins, which is that you're building software packages in a build environment that is also the installation target.  For most packages this is not a big problem, but for your build toolchain itself it certainly is.  This is why I think that for bootstrapping purposes the build toochain and its dependencies should have some level of isolation from the rest of the install target.

As for a solution, I'd certainly be willing to disable the new-style uninstallation as the default behavior for now. Honestly, I would have preferred to wait until more/all of DESTDIR-related updates were in, as well as #25140, though be design it's supposed to be able to work without that (and does in most cases).  But I'm hesitant because for the majority of packages it does work well now, and I'm not entirely sure what the impact would be of fully disabling it now (but maybe it would be small).

So I think for now it still might be best to find a middle-ground.  What if, for now, for toolchain dependencies only, we ensure that their files are not removed before reinstalling them?  This could work in part with cooperation from `sage-spkg` by adding a flag similar to pip's `--ignore-installed` which causes it to ignore dependencies that are already satisfied and just install on top of them, rather than uninstalling conflicting/existing dependencies first.



---

archive/issue_events_064679.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-07-17T06:37:06Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "milestone": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25620#event-64679"
}
```



---

archive/issue_comments_360871.json:
```json
{
    "body": "Personally, I would prefer to revert uninstall completely because that's the safest operation. But if you have a different solution which is reasonably simple, that might be OK for me too.",
    "created_at": "2018-07-17T06:37:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360871",
    "user": "https://github.com/jdemeyer"
}
```

Personally, I would prefer to revert uninstall completely because that's the safest operation. But if you have a different solution which is reasonably simple, that might be OK for me too.



---

archive/issue_comments_360872.json:
```json
{
    "body": "I mean, this issue needs to be resolved somehow anyways--the new package uninstallation is not going away long-term.",
    "created_at": "2018-07-17T10:47:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360872",
    "user": "https://github.com/embray"
}
```

I mean, this issue needs to be resolved somehow anyways--the new package uninstallation is not going away long-term.



---

archive/issue_comments_360873.json:
```json
{
    "body": "I'm currently testing a fix that I think is pretty uninvasive.  I would still consider it a work-around but it's reasonable.",
    "created_at": "2018-07-17T14:54:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360873",
    "user": "https://github.com/embray"
}
```

I'm currently testing a fix that I think is pretty uninvasive.  I would still consider it a work-around but it's reasonable.



---

archive/issue_comments_360874.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-07-17T16:07:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360874",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_360875.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-07-17T16:07:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360875",
    "user": "https://github.com/embray"
}
```

New commits:



---

archive/issue_comments_360876.json:
```json
{
    "body": "[f1411c5](https://git.sagemath.org/sage.git/commit?id=f1411c5ee7e3aad4a11e2eeab767e980a0d65abb) works for toolchain packages, but can actually break other packages that rely on the new-style uninstaller to remove files should should be removed in order to reinstall that package.  This came up for me in the case of elliptic_curves.  Simply deleting the stamp file can be a problem, because it means erasing the file manifest for that package (perhaps an argument that they should not be one in the same, but that's another issue).\n\nThis can be fixed by further narrowing things so that `<spkg>-clean` works the old way only for packages in TOOLCHAIN_DEPS.",
    "created_at": "2018-07-17T16:53:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360876",
    "user": "https://github.com/embray"
}
```

[f1411c5](https://git.sagemath.org/sage.git/commit?id=f1411c5ee7e3aad4a11e2eeab767e980a0d65abb) works for toolchain packages, but can actually break other packages that rely on the new-style uninstaller to remove files should should be removed in order to reinstall that package.  This came up for me in the case of elliptic_curves.  Simply deleting the stamp file can be a problem, because it means erasing the file manifest for that package (perhaps an argument that they should not be one in the same, but that's another issue).

This can be fixed by further narrowing things so that `<spkg>-clean` works the old way only for packages in TOOLCHAIN_DEPS.



---

archive/issue_comments_360877.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-07-17T16:53:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360877",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_360878.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-17T17:23:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360878",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_360879.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-07-17T17:24:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360879",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_360880.json:
```json
{
    "body": "IMHO this would be a mistake to merge at the last minute; This does not fix any bug that generates wrong answers, has no testsuite coverage, etc. Its much safer to merge it at the beginnig of the next beta phase...",
    "created_at": "2018-07-17T22:27:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360880",
    "user": "https://github.com/vbraun"
}
```

IMHO this would be a mistake to merge at the last minute; This does not fix any bug that generates wrong answers, has no testsuite coverage, etc. Its much safer to merge it at the beginnig of the next beta phase...



---

archive/issue_comments_360881.json:
```json
{
    "body": "I don't like the change `$(inst_zlib)` -> `zlib`. It will prevent using a system `zlib` if we ever want that.",
    "created_at": "2018-07-18T06:55:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360881",
    "user": "https://github.com/jdemeyer"
}
```

I don't like the change `$(inst_zlib)` -> `zlib`. It will prevent using a system `zlib` if we ever want that.



---

archive/issue_comments_360882.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2018-07-18T07:00:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360882",
    "user": "https://github.com/jdemeyer"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_360883.json:
```json
{
    "body": "This fixes a very serious bug when building from source. You may not like the solution, but the bug is real.",
    "created_at": "2018-07-18T07:00:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360883",
    "user": "https://github.com/jdemeyer"
}
```

This fixes a very serious bug when building from source. You may not like the solution, but the bug is real.



---

archive/issue_comments_360884.json:
```json
{
    "body": "It doesn't break configure && make as far as I can tell. Basically there is an obscure makefile target that requires a full rebuild to recover. How is that a release blocker, just don't do it until its fixed.\n\nIn a similar vein, `make doc` frequently breaks incremental builds and nobody thinks thats a release blocker.",
    "created_at": "2018-07-18T07:05:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360884",
    "user": "https://github.com/vbraun"
}
```

It doesn't break configure && make as far as I can tell. Basically there is an obscure makefile target that requires a full rebuild to recover. How is that a release blocker, just don't do it until its fixed.

In a similar vein, `make doc` frequently breaks incremental builds and nobody thinks thats a release blocker.



---

archive/issue_comments_360885.json:
```json
{
    "body": "Replying to [comment:26 jdemeyer]:\n> I don't like the change `$(inst_zlib)` -> `zlib`. It will prevent using a system `zlib` if we ever want that.\n\n\nI'm not sure that's true.  My system for enabling use of more system packages wouldn't be impacted by that, I don't think.  But if that's your only review comment I'll fix it; it's not a big deal (I think it's still useful to have a variable listing the bare package names, but I can add a separate one).",
    "created_at": "2018-07-18T07:42:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360885",
    "user": "https://github.com/embray"
}
```

Replying to [comment:26 jdemeyer]:
> I don't like the change `$(inst_zlib)` -> `zlib`. It will prevent using a system `zlib` if we ever want that.


I'm not sure that's true.  My system for enabling use of more system packages wouldn't be impacted by that, I don't think.  But if that's your only review comment I'll fix it; it's not a big deal (I think it's still useful to have a variable listing the bare package names, but I can add a separate one).



---

archive/issue_comments_360886.json:
```json
{
    "body": "Replying to [comment:29 vbraun]:\n> It doesn't break configure && make as far as I can tell. Basically there is an obscure makefile target that requires a full rebuild to recover. How is that a release blocker, just don't do it until its fixed.\n> \n> In a similar vein, `make doc` frequently breaks incremental builds and nobody thinks thats a release blocker.\n\n\nI actually kind of agree with Volker on this one :)  But I'm also sympathetic to it since:\n\na) I broke it.\n\nb) I was bitten by this issue myself, and on Cygwin it can rather badly break patchbots since it affects Cygwin even without installing sage-gcc.\n\nc) The fix is simple (IMO) and if it helps Jeroen sleep at night I don't see the problem.",
    "created_at": "2018-07-18T07:45:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360886",
    "user": "https://github.com/embray"
}
```

Replying to [comment:29 vbraun]:
> It doesn't break configure && make as far as I can tell. Basically there is an obscure makefile target that requires a full rebuild to recover. How is that a release blocker, just don't do it until its fixed.
> 
> In a similar vein, `make doc` frequently breaks incremental builds and nobody thinks thats a release blocker.


I actually kind of agree with Volker on this one :)  But I'm also sympathetic to it since:

a) I broke it.

b) I was bitten by this issue myself, and on Cygwin it can rather badly break patchbots since it affects Cygwin even without installing sage-gcc.

c) The fix is simple (IMO) and if it helps Jeroen sleep at night I don't see the problem.



---

archive/issue_comments_360887.json:
```json
{
    "body": "Replying to [comment:25 vbraun]:\n> IMHO this would be a mistake to merge at the last minute; This does not fix any bug that generates wrong answers, has no testsuite coverage, etc. Its much safer to merge it at the beginnig of the next beta phase...\n\n\nAlso it wouldn't be \"last minute\" it if we had a release schedule that created fewer artificial \"panic windows\".",
    "created_at": "2018-07-18T07:47:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360887",
    "user": "https://github.com/embray"
}
```

Replying to [comment:25 vbraun]:
> IMHO this would be a mistake to merge at the last minute; This does not fix any bug that generates wrong answers, has no testsuite coverage, etc. Its much safer to merge it at the beginnig of the next beta phase...


Also it wouldn't be "last minute" it if we had a release schedule that created fewer artificial "panic windows".



---

archive/issue_comments_360888.json:
```json
{
    "body": "I'm not very comfortable with code like\n\n```\n\t+$(AM_V_at)sage-logger -p '$$(SAGE_SPKG) \\\n\t\t$(if $(filter $(1),$(TOOLCHAIN_DEPS)),--keep-existing) \\\n\t\t$(1)-$(2)' '$$(SAGE_LOGS)/$(1)-$(2).log'\n```\nI never liked your idea about defining these kind of rules in `Makefile` syntax. How am I supposed to understand what is going on here?",
    "created_at": "2018-07-19T07:04:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360888",
    "user": "https://github.com/jdemeyer"
}
```

I'm not very comfortable with code like

```
	+$(AM_V_at)sage-logger -p '$$(SAGE_SPKG) \
		$(if $(filter $(1),$(TOOLCHAIN_DEPS)),--keep-existing) \
		$(1)-$(2)' '$$(SAGE_LOGS)/$(1)-$(2).log'
```
I never liked your idea about defining these kind of rules in `Makefile` syntax. How am I supposed to understand what is going on here?



---

archive/issue_comments_360889.json:
```json
{
    "body": "This comment\n\n```\n# Note: This list is determined from the dependencies of the TOOLCHAIN\n# packages which include gcc, and optionally ccache; in principle this\n# list is redundant.\n```\nis not completely accurate since it should also include the dependencies of the system toolchain, which may use Sage libraries (or did we fix that?)",
    "created_at": "2018-07-19T07:06:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360889",
    "user": "https://github.com/jdemeyer"
}
```

This comment

```
# Note: This list is determined from the dependencies of the TOOLCHAIN
# packages which include gcc, and optionally ccache; in principle this
# list is redundant.
```
is not completely accurate since it should also include the dependencies of the system toolchain, which may use Sage libraries (or did we fix that?)



---

archive/issue_comments_360890.json:
```json
{
    "body": "Also, `TOOLCHAIN_DEPS` should only contain the runtime dependencies of the toolchain (I mean the runtime of the toolchain, when building packages), so not `xz`.",
    "created_at": "2018-07-19T07:07:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360890",
    "user": "https://github.com/jdemeyer"
}
```

Also, `TOOLCHAIN_DEPS` should only contain the runtime dependencies of the toolchain (I mean the runtime of the toolchain, when building packages), so not `xz`.



---

archive/issue_comments_360891.json:
```json
{
    "body": "Setting this to needs_work for me because of [comment:26] and [comment:34] and [comment:35] but I haven't finished testing.",
    "created_at": "2018-07-19T07:20:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360891",
    "user": "https://github.com/jdemeyer"
}
```

Setting this to needs_work for me because of [comment:26] and [comment:34] and [comment:35] but I haven't finished testing.



---

archive/issue_comments_360892.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-07-19T07:20:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360892",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_360893.json:
```json
{
    "body": "Replying to [comment:33 jdemeyer]:\n> I'm not very comfortable with code like\n> \n> ```\n> \t+$(AM_V_at)sage-logger -p '$$(SAGE_SPKG) \\\n> \t\t$(if $(filter $(1),$(TOOLCHAIN_DEPS)),--keep-existing) \\\n> \t\t$(1)-$(2)' '$$(SAGE_LOGS)/$(1)-$(2).log'\n> ```\n> I never liked your idea about defining these kind of rules in `Makefile` syntax. How am I supposed to understand what is going on here?\n\n\nI'm sorry but you'll have to live with that.  Read the docs?  With GNU make functions, if you ignore the `$` (or at least, understand that the function call is treated the same as any other variable expansion), and the commas, then it reads more or less like LISP:\n\n`(if (filter <the-dependency> TOOLCHAIN_DEPS) --keep-existing)`\n\nwhere `filter` expands to `<the-dependency>` if it is found in `TOOLCHAIN_DEPS`, and `if` expands to its second argument if its first argument is non-empty (or to its optional third argument if the first argument is empty).",
    "created_at": "2018-07-19T07:37:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360893",
    "user": "https://github.com/embray"
}
```

Replying to [comment:33 jdemeyer]:
> I'm not very comfortable with code like
> 
> ```
> 	+$(AM_V_at)sage-logger -p '$$(SAGE_SPKG) \
> 		$(if $(filter $(1),$(TOOLCHAIN_DEPS)),--keep-existing) \
> 		$(1)-$(2)' '$$(SAGE_LOGS)/$(1)-$(2).log'
> ```
> I never liked your idea about defining these kind of rules in `Makefile` syntax. How am I supposed to understand what is going on here?


I'm sorry but you'll have to live with that.  Read the docs?  With GNU make functions, if you ignore the `$` (or at least, understand that the function call is treated the same as any other variable expansion), and the commas, then it reads more or less like LISP:

`(if (filter <the-dependency> TOOLCHAIN_DEPS) --keep-existing)`

where `filter` expands to `<the-dependency>` if it is found in `TOOLCHAIN_DEPS`, and `if` expands to its second argument if its first argument is non-empty (or to its optional third argument if the first argument is empty).



---

archive/issue_comments_360894.json:
```json
{
    "body": "Replying to [comment:34 jdemeyer]:\n> This comment\n> \n> ```\n> # Note: This list is determined from the dependencies of the TOOLCHAIN\n> # packages which include gcc, and optionally ccache; in principle this\n> # list is redundant.\n> ```\n> is not completely accurate since it should also include the dependencies of the system toolchain, which may use Sage libraries (or did we fix that?)\n\n\nWhy would the system toolchain ever use Sage libraries unless the user were doing something like setting `LD_LIBRARY_PATH`?",
    "created_at": "2018-07-19T07:39:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360894",
    "user": "https://github.com/embray"
}
```

Replying to [comment:34 jdemeyer]:
> This comment
> 
> ```
> # Note: This list is determined from the dependencies of the TOOLCHAIN
> # packages which include gcc, and optionally ccache; in principle this
> # list is redundant.
> ```
> is not completely accurate since it should also include the dependencies of the system toolchain, which may use Sage libraries (or did we fix that?)


Why would the system toolchain ever use Sage libraries unless the user were doing something like setting `LD_LIBRARY_PATH`?



---

archive/issue_comments_360895.json:
```json
{
    "body": "Replying to [comment:35 jdemeyer]:\n> Also, `TOOLCHAIN_DEPS` should only contain the runtime dependencies of the toolchain (I mean the runtime of the toolchain, when building packages), so not `xz`.\n\n\nI'm not really clear on where xz fits into this.  Why is it listed as a dependency of gcc in the first place?",
    "created_at": "2018-07-19T07:40:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360895",
    "user": "https://github.com/embray"
}
```

Replying to [comment:35 jdemeyer]:
> Also, `TOOLCHAIN_DEPS` should only contain the runtime dependencies of the toolchain (I mean the runtime of the toolchain, when building packages), so not `xz`.


I'm not really clear on where xz fits into this.  Why is it listed as a dependency of gcc in the first place?



---

archive/issue_comments_360896.json:
```json
{
    "body": "Replying to [comment:40 embray]:\n> Why is it listed as a dependency of gcc in the first place?\n\n\nOnly because the GCC tarball is xz-compressed.",
    "created_at": "2018-07-19T07:45:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360896",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:40 embray]:
> Why is it listed as a dependency of gcc in the first place?


Only because the GCC tarball is xz-compressed.



---

archive/issue_comments_360897.json:
```json
{
    "body": "Replying to [comment:39 embray]:\n> Why would the system toolchain ever use Sage libraries unless the user were doing something like setting `LD_LIBRARY_PATH`?\n\n\nWe certainly did that in the past but maybe not anymore.",
    "created_at": "2018-07-19T07:46:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360897",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:39 embray]:
> Why would the system toolchain ever use Sage libraries unless the user were doing something like setting `LD_LIBRARY_PATH`?


We certainly did that in the past but maybe not anymore.



---

archive/issue_comments_360898.json:
```json
{
    "body": "Replying to [comment:42 jdemeyer]:\n> Replying to [comment:39 embray]:\n> > Why would the system toolchain ever use Sage libraries unless the user were doing something like setting `LD_LIBRARY_PATH`?\n\n> \n> We certainly did that in the past but maybe not anymore.\n\n\nOnly on Cygwin, where it's required for `dlopen` to work, but it has no other effect on Cygwin.  There's no reason otherwise to set `LD_LIBRARY_PATH` in the Sage environment in general since we mostly rely on RPATH.  There are just a few individual special cases where it's set (but not for running the compiler).",
    "created_at": "2018-07-19T07:54:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360898",
    "user": "https://github.com/embray"
}
```

Replying to [comment:42 jdemeyer]:
> Replying to [comment:39 embray]:
> > Why would the system toolchain ever use Sage libraries unless the user were doing something like setting `LD_LIBRARY_PATH`?

> 
> We certainly did that in the past but maybe not anymore.


Only on Cygwin, where it's required for `dlopen` to work, but it has no other effect on Cygwin.  There's no reason otherwise to set `LD_LIBRARY_PATH` in the Sage environment in general since we mostly rely on RPATH.  There are just a few individual special cases where it's set (but not for running the compiler).



---

archive/issue_comments_360899.json:
```json
{
    "body": "Replying to [comment:41 jdemeyer]:\n> Replying to [comment:40 embray]:\n> > Why is it listed as a dependency of gcc in the first place?\n\n> \n> Only because the GCC tarball is xz-compressed.\n\n\nWow, ok...\n\nI'll just, drop the commit that added it then.",
    "created_at": "2018-07-19T07:55:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360899",
    "user": "https://github.com/embray"
}
```

Replying to [comment:41 jdemeyer]:
> Replying to [comment:40 embray]:
> > Why is it listed as a dependency of gcc in the first place?

> 
> Only because the GCC tarball is xz-compressed.


Wow, ok...

I'll just, drop the commit that added it then.



---

archive/issue_comments_360900.json:
```json
{
    "body": "Replying to [comment:29 vbraun]:\n> It doesn't break configure && make as far as I can tell.\n\n\nIt doesn't break a build from scratch but I don't understand why. It should break since mpir is built twice (once before GCC and once after GCC).",
    "created_at": "2018-07-19T09:13:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360900",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:29 vbraun]:
> It doesn't break configure && make as far as I can tell.


It doesn't break a build from scratch but I don't understand why. It should break since mpir is built twice (once before GCC and once after GCC).



---

archive/issue_comments_360901.json:
```json
{
    "body": "When building mpir the second time (after GCC) I get\n\n```\nNo record that 'mpir' was ever installed; skipping uninstall\n```\n\nCan anybody explain this?",
    "created_at": "2018-07-19T09:17:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360901",
    "user": "https://github.com/jdemeyer"
}
```

When building mpir the second time (after GCC) I get

```
No record that 'mpir' was ever installed; skipping uninstall
```

Can anybody explain this?



---

archive/issue_comments_360902.json:
```json
{
    "body": "Replying to [comment:45 jdemeyer]:\n> Replying to [comment:29 vbraun]:\n> > It doesn't break configure && make as far as I can tell.\n\n> \n> It doesn't break a build from scratch but I don't understand why. It should break since mpir is built twice (once before GCC and once after GCC).\n\n\nHow exactly are you reproducing the issue?  I can reproduce it by running `./sage -f mpir`.  The reason for this is very specific to `./sage -f`, because it *explicitly* calls `make clean-mpir` before trying to rebuild mpir.  During a normal build from scratch that does not happen.",
    "created_at": "2018-07-19T09:24:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360902",
    "user": "https://github.com/embray"
}
```

Replying to [comment:45 jdemeyer]:
> Replying to [comment:29 vbraun]:
> > It doesn't break configure && make as far as I can tell.

> 
> It doesn't break a build from scratch but I don't understand why. It should break since mpir is built twice (once before GCC and once after GCC).


How exactly are you reproducing the issue?  I can reproduce it by running `./sage -f mpir`.  The reason for this is very specific to `./sage -f`, because it *explicitly* calls `make clean-mpir` before trying to rebuild mpir.  During a normal build from scratch that does not happen.



---

archive/issue_comments_360903.json:
```json
{
    "body": "Replying to [comment:46 jdemeyer]:\n> When building mpir the second time (after GCC) I get\n> \n> ```\n> No record that 'mpir' was ever installed; skipping uninstall\n> ```\n> \n> Can anybody explain this?\n\n\nAre you getting that *with* this patch, or on bare 8.3.rc1.\n\nEither way that's normal.  That's just what `sage-spkg-uninstall` says if it can't find `local/var/lib/sage/installed/mpir-<whatever>`.  As far is it knows there's nothing to uninstall.",
    "created_at": "2018-07-19T09:26:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360903",
    "user": "https://github.com/embray"
}
```

Replying to [comment:46 jdemeyer]:
> When building mpir the second time (after GCC) I get
> 
> ```
> No record that 'mpir' was ever installed; skipping uninstall
> ```
> 
> Can anybody explain this?


Are you getting that *with* this patch, or on bare 8.3.rc1.

Either way that's normal.  That's just what `sage-spkg-uninstall` says if it can't find `local/var/lib/sage/installed/mpir-<whatever>`.  As far is it knows there's nothing to uninstall.



---

archive/issue_comments_360904.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-07-19T11:49:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360904",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_360905.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-19T11:52:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360905",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_360906.json:
```json
{
    "body": "Replying to [comment:36 jdemeyer]:\n> Setting this to needs_work for me because of [comment:26] and [comment:34] and [comment:35] but I haven't finished testing.\n\n\nI think I've addressed all of these:\n\n[x] removed `xz` from `TOOLCHAIN_DEPS`\n\n[x] used `$(MAKE) $(inst_pkg)` for each package in `TOOLCHAIN_DEPS` (serially)\n\n[x] updated the comment; though I don't know if what it says now is really any better (I think it is though)\n\n\nSorry for my flippancy about make syntax constructs but I really think it makes things simpler; there's nothing out of the ordinary about it.",
    "created_at": "2018-07-19T11:54:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360906",
    "user": "https://github.com/embray"
}
```

Replying to [comment:36 jdemeyer]:
> Setting this to needs_work for me because of [comment:26] and [comment:34] and [comment:35] but I haven't finished testing.


I think I've addressed all of these:

[x] removed `xz` from `TOOLCHAIN_DEPS`

[x] used `$(MAKE) $(inst_pkg)` for each package in `TOOLCHAIN_DEPS` (serially)

[x] updated the comment; though I don't know if what it says now is really any better (I think it is though)


Sorry for my flippancy about make syntax constructs but I really think it makes things simpler; there's nothing out of the ordinary about it.



---

archive/issue_comments_360907.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-07-19T11:54:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360907",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_events_064680.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-07-24T20:52:42Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "milestone": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25620#event-64680"
}
```



---

archive/issue_events_064681.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-07-24T20:52:42Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "milestone": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25620#event-64681"
}
```



---

archive/issue_comments_360908.json:
```json
{
    "body": "I changed my mind about the urgency if it only happens on force rebuilds (`sage -f ...`)",
    "created_at": "2018-07-24T20:52:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360908",
    "user": "https://github.com/jdemeyer"
}
```

I changed my mind about the urgency if it only happens on force rebuilds (`sage -f ...`)



---

archive/issue_comments_360909.json:
```json
{
    "body": "Changing priority from blocker to critical.",
    "created_at": "2018-07-24T20:52:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360909",
    "user": "https://github.com/jdemeyer"
}
```

Changing priority from blocker to critical.



---

archive/issue_comments_360910.json:
```json
{
    "body": "FWIW it can also screw up patchbots since they're regularly jumping back and forth between branches (which might end up requiring a rebuild of mpir and/or dependencies).\n\nBut if that's still fixed by the next beta release I don't see it as that big a deal.",
    "created_at": "2018-07-25T13:39:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360910",
    "user": "https://github.com/embray"
}
```

FWIW it can also screw up patchbots since they're regularly jumping back and forth between branches (which might end up requiring a rebuild of mpir and/or dependencies).

But if that's still fixed by the next beta release I don't see it as that big a deal.



---

archive/issue_comments_360911.json:
```json
{
    "body": "Replying to [comment:38 embray]:\n> I'm sorry but you'll have to live with that.  Read the docs?\n\n\nUnderstanding this syntactically is not the same as actually understanding it semantically. Whenever I try to review this ticket, I also end up realizing that there is no way to be sure that this `Makefile` syntax does what it is supposed to do.\n\nAnd your suggestion to run `make -f build/make/Makefile -n DEBUG_RULES=1` would be useful if it would actually do what it said: the `toolchain-deps` rules that you change on this ticket do not appear there.\n\nI'm not making this comment just to be annoying or pedantic. I really do think that it's a serious problem with #21524.",
    "created_at": "2018-07-30T14:56:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360911",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:38 embray]:
> I'm sorry but you'll have to live with that.  Read the docs?


Understanding this syntactically is not the same as actually understanding it semantically. Whenever I try to review this ticket, I also end up realizing that there is no way to be sure that this `Makefile` syntax does what it is supposed to do.

And your suggestion to run `make -f build/make/Makefile -n DEBUG_RULES=1` would be useful if it would actually do what it said: the `toolchain-deps` rules that you change on this ticket do not appear there.

I'm not making this comment just to be annoying or pedantic. I really do think that it's a serious problem with #21524.



---

archive/issue_comments_360912.json:
```json
{
    "body": "Some other comments:\n\n1. the flags `SAGE_INSTALL_FETCH_ONLY`, `SAGE_CHECK` and `SAGE_KEEP_BUILT_SPKGS` are meant to be usable as environment variables. So I would do the same for `KEEP_EXISTING` (rename it to `SAGE_KEEP_EXISTING` and remove `KEEP_EXISTING=0`).\n\n2. keep the whitespace line in the `-clean` rule.",
    "created_at": "2018-07-30T15:01:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360912",
    "user": "https://github.com/jdemeyer"
}
```

Some other comments:

1. the flags `SAGE_INSTALL_FETCH_ONLY`, `SAGE_CHECK` and `SAGE_KEEP_BUILT_SPKGS` are meant to be usable as environment variables. So I would do the same for `KEEP_EXISTING` (rename it to `SAGE_KEEP_EXISTING` and remove `KEEP_EXISTING=0`).

2. keep the whitespace line in the `-clean` rule.



---

archive/issue_comments_360913.json:
```json
{
    "body": "Replying to [comment:55 jdemeyer]:\n> Some other comments:\n> \n> 1. the flags `SAGE_INSTALL_FETCH_ONLY`, `SAGE_CHECK` and `SAGE_KEEP_BUILT_SPKGS` are meant to be usable as environment variables. So I would do the same for `KEEP_EXISTING` (rename it to `SAGE_KEEP_EXISTING` and remove `KEEP_EXISTING=0`).\n\n\nOk.\n\n> 2. keep the whitespace line in the `-clean` rule.\n\n\nYes, weirdly I thought I already fixed that.  I don't know why the fix went away again.",
    "created_at": "2018-07-30T15:56:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360913",
    "user": "https://github.com/embray"
}
```

Replying to [comment:55 jdemeyer]:
> Some other comments:
> 
> 1. the flags `SAGE_INSTALL_FETCH_ONLY`, `SAGE_CHECK` and `SAGE_KEEP_BUILT_SPKGS` are meant to be usable as environment variables. So I would do the same for `KEEP_EXISTING` (rename it to `SAGE_KEEP_EXISTING` and remove `KEEP_EXISTING=0`).


Ok.

> 2. keep the whitespace line in the `-clean` rule.


Yes, weirdly I thought I already fixed that.  I don't know why the fix went away again.



---

archive/issue_comments_360914.json:
```json
{
    "body": "Replying to [comment:54 jdemeyer]:\n> Replying to [comment:38 embray]:\n> > I'm sorry but you'll have to live with that.  Read the docs?\n\n> \n> Understanding this syntactically is not the same as actually understanding it semantically. Whenever I try to review this ticket, I also end up realizing that there is no way to be sure that this `Makefile` syntax does what it is supposed to do.\n> \n> And your suggestion to run `make -f build/make/Makefile -n DEBUG_RULES=1` would be useful if it would actually do what it said: the `toolchain-deps` rules that you change on this ticket do not appear there.\n\n\nThat's just for printing the automatically generated rules, not for printing every rule in the makefile, not statically-defined targets, like `toolchain-deps`.\n\nI'm not sure what's unclear about that target.\n\n> I'm not making this comment just to be annoying or pedantic. I really do think that it's a serious problem with #21524.\n\n\nI believe your intentions are sincere, but I still find this objection very confusing.  I feel like you're just stubbornly refusing to learn for some reason, because I find it easy to understand, and to check; maybe just not as easy as, say, a Python script.  I don't know if that's what's going on; that's just what it feels like to me.  Maybe a tutorial on make would help; I don't know.\n\nAnyways, I think that discussion is outside the scope of this ticket.",
    "created_at": "2018-07-30T16:03:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360914",
    "user": "https://github.com/embray"
}
```

Replying to [comment:54 jdemeyer]:
> Replying to [comment:38 embray]:
> > I'm sorry but you'll have to live with that.  Read the docs?

> 
> Understanding this syntactically is not the same as actually understanding it semantically. Whenever I try to review this ticket, I also end up realizing that there is no way to be sure that this `Makefile` syntax does what it is supposed to do.
> 
> And your suggestion to run `make -f build/make/Makefile -n DEBUG_RULES=1` would be useful if it would actually do what it said: the `toolchain-deps` rules that you change on this ticket do not appear there.


That's just for printing the automatically generated rules, not for printing every rule in the makefile, not statically-defined targets, like `toolchain-deps`.

I'm not sure what's unclear about that target.

> I'm not making this comment just to be annoying or pedantic. I really do think that it's a serious problem with #21524.


I believe your intentions are sincere, but I still find this objection very confusing.  I feel like you're just stubbornly refusing to learn for some reason, because I find it easy to understand, and to check; maybe just not as easy as, say, a Python script.  I don't know if that's what's going on; that's just what it feels like to me.  Maybe a tutorial on make would help; I don't know.

Anyways, I think that discussion is outside the scope of this ticket.



---

archive/issue_comments_360915.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-07-30T16:04:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360915",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_360916.json:
```json
{
    "body": "Replying to [comment:56 embray]:\n> Replying to [comment:55 jdemeyer]:\n> > Some other comments:\n> > \n> > 1. the flags `SAGE_INSTALL_FETCH_ONLY`, `SAGE_CHECK` and `SAGE_KEEP_BUILT_SPKGS` are meant to be usable as environment variables. So I would do the same for `KEEP_EXISTING` (rename it to `SAGE_KEEP_EXISTING` and remove `KEEP_EXISTING=0`).\n  \n> \n> Ok.\n\n\nActually, the more I think about it, I think we should avoid adding yet another environment variable for now.  Is this something we actually need?  If there's not an obvious use case for setting this flag for all packages I think it should be avoided.  The name `SAGE_KEEP_EXISTING` is also very unclear as to what it does.  Keep existing what?  In the context of the `sage-spkg` script it makes sense, but it's very unobvious otherwise.",
    "created_at": "2018-07-30T16:07:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360916",
    "user": "https://github.com/embray"
}
```

Replying to [comment:56 embray]:
> Replying to [comment:55 jdemeyer]:
> > Some other comments:
> > 
> > 1. the flags `SAGE_INSTALL_FETCH_ONLY`, `SAGE_CHECK` and `SAGE_KEEP_BUILT_SPKGS` are meant to be usable as environment variables. So I would do the same for `KEEP_EXISTING` (rename it to `SAGE_KEEP_EXISTING` and remove `KEEP_EXISTING=0`).
  
> 
> Ok.


Actually, the more I think about it, I think we should avoid adding yet another environment variable for now.  Is this something we actually need?  If there's not an obvious use case for setting this flag for all packages I think it should be avoided.  The name `SAGE_KEEP_EXISTING` is also very unclear as to what it does.  Keep existing what?  In the context of the `sage-spkg` script it makes sense, but it's very unobvious otherwise.



---

archive/issue_comments_360917.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-30T16:11:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360917",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_360918.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-07-30T16:11:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360918",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_360919.json:
```json
{
    "body": "Replying to [comment:57 embray]:\n> Replying to [comment:54 jdemeyer]:\n> > Replying to [comment:38 embray]:\n> > > I'm sorry but you'll have to live with that.  Read the docs?\n\n> > \n> > Understanding this syntactically is not the same as actually understanding it semantically. Whenever I try to review this ticket, I also end up realizing that there is no way to be sure that this `Makefile` syntax does what it is supposed to do.\n\n\nWhich syntax specifically?  What are you trying to check?",
    "created_at": "2018-07-30T16:14:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360919",
    "user": "https://github.com/embray"
}
```

Replying to [comment:57 embray]:
> Replying to [comment:54 jdemeyer]:
> > Replying to [comment:38 embray]:
> > > I'm sorry but you'll have to live with that.  Read the docs?

> > 
> > Understanding this syntactically is not the same as actually understanding it semantically. Whenever I try to review this ticket, I also end up realizing that there is no way to be sure that this `Makefile` syntax does what it is supposed to do.


Which syntax specifically?  What are you trying to check?



---

archive/issue_comments_360920.json:
```json
{
    "body": "Replying to [comment:59 embray]:\n> If there's not an obvious use case for setting this flag for all packages I think it should be avoided.\n\n\nWhy? I would argue the opposite: it doesn't harm to support it as an environment variable, so why should we not do that?\n\n> The name `SAGE_KEEP_EXISTING` is also very unclear as to what it does.\n\n\nThen call it `SAGE_SKIP_UNINSTALL` or whatever.",
    "created_at": "2018-08-07T12:08:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360920",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:59 embray]:
> If there's not an obvious use case for setting this flag for all packages I think it should be avoided.


Why? I would argue the opposite: it doesn't harm to support it as an environment variable, so why should we not do that?

> The name `SAGE_KEEP_EXISTING` is also very unclear as to what it does.


Then call it `SAGE_SKIP_UNINSTALL` or whatever.



---

archive/issue_comments_360921.json:
```json
{
    "body": "Replying to [comment:62 embray]:\n> Which syntax specifically?  What are you trying to check?\n\n\nI'm just trying to check that this branch does what it seems to be doing. It *looks* like it does the right thing (skipping uninstall for toolchain packages) but how I can be sure?\n\nBy now, I've looked at this ticket a few times and I guess it's OK. I'll wait for your reply on the environment variable issue before doing a final review.",
    "created_at": "2018-08-07T12:16:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360921",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:62 embray]:
> Which syntax specifically?  What are you trying to check?


I'm just trying to check that this branch does what it seems to be doing. It *looks* like it does the right thing (skipping uninstall for toolchain packages) but how I can be sure?

By now, I've looked at this ticket a few times and I guess it's OK. I'll wait for your reply on the environment variable issue before doing a final review.



---

archive/issue_comments_360922.json:
```json
{
    "body": "Replying to [comment:64 jdemeyer]:\n> Replying to [comment:62 embray]:\n> > Which syntax specifically?  What are you trying to check?\n\n> \n> I'm just trying to check that this branch does what it seems to be doing. It *looks* like it does the right thing (skipping uninstall for toolchain packages) but how I can be sure?\n\n\nI'm still not sure what you're asking here.  Are you just asking how to test code in a makefile?  How can you be sure any code does what you think it looks like it does?  I'm not trying to be facetious--I'm just trying to get to the bottom of what your concern is.",
    "created_at": "2018-08-08T13:27:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360922",
    "user": "https://github.com/embray"
}
```

Replying to [comment:64 jdemeyer]:
> Replying to [comment:62 embray]:
> > Which syntax specifically?  What are you trying to check?

> 
> I'm just trying to check that this branch does what it seems to be doing. It *looks* like it does the right thing (skipping uninstall for toolchain packages) but how I can be sure?


I'm still not sure what you're asking here.  Are you just asking how to test code in a makefile?  How can you be sure any code does what you think it looks like it does?  I'm not trying to be facetious--I'm just trying to get to the bottom of what your concern is.



---

archive/issue_comments_360923.json:
```json
{
    "body": "Replying to [comment:63 jdemeyer]:\n> Replying to [comment:59 embray]:\n> > If there's not an obvious use case for setting this flag for all packages I think it should be avoided.\n\n> \n> Why? I would argue the opposite: it doesn't harm to support it as an environment variable, so why should we not do that?\n\n\nI don't agree.  Adding any new \"feature\" means you have to support it. The main purpose of this change (although it *does* add new features in the form of new command-line flags to some scripts) was not really to add new features so much as to workaround a specific problem.  So better to keep the feature surface area of the change minimal.  I also believe the YAGNI principle applies here.\n\nBut if you *really* want it for some reason a compromise might be to change the name but not document it anywhere.  I'm also a little unsure about this in that it's really a behavior of the uninstallation that this is changing, not the installation.  ~~If anything it should be an environment variable read by the uninstaller, but there again it adds needless complication...~~ (That last sentence didn't make sense; I misremembered what my own patch does :)",
    "created_at": "2018-08-08T13:31:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360923",
    "user": "https://github.com/embray"
}
```

Replying to [comment:63 jdemeyer]:
> Replying to [comment:59 embray]:
> > If there's not an obvious use case for setting this flag for all packages I think it should be avoided.

> 
> Why? I would argue the opposite: it doesn't harm to support it as an environment variable, so why should we not do that?


I don't agree.  Adding any new "feature" means you have to support it. The main purpose of this change (although it *does* add new features in the form of new command-line flags to some scripts) was not really to add new features so much as to workaround a specific problem.  So better to keep the feature surface area of the change minimal.  I also believe the YAGNI principle applies here.

But if you *really* want it for some reason a compromise might be to change the name but not document it anywhere.  I'm also a little unsure about this in that it's really a behavior of the uninstallation that this is changing, not the installation.  ~~If anything it should be an environment variable read by the uninstaller, but there again it adds needless complication...~~ (That last sentence didn't make sense; I misremembered what my own patch does :)



---

archive/issue_comments_360924.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-10T11:08:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360924",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_360925.json:
```json
{
    "body": "How about this?  I called it `SAGE_SPKG_SKIP_UNINSTALL` and noted it in the documentation at the top of `sage-spkg`, but not elsewhere, at least for now.\n\nI'd like to get this done already; I think this fix is too important to be held up any longer by bikeshedding.",
    "created_at": "2018-08-10T11:10:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360925",
    "user": "https://github.com/embray"
}
```

How about this?  I called it `SAGE_SPKG_SKIP_UNINSTALL` and noted it in the documentation at the top of `sage-spkg`, but not elsewhere, at least for now.

I'd like to get this done already; I think this fix is too important to be held up any longer by bikeshedding.



---

archive/issue_comments_360926.json:
```json
{
    "body": "Perhaps this should get #25188 as a dependence, so that the latter and this are merged together, with just one new configure tarball instead of two...",
    "created_at": "2018-09-07T08:50:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360926",
    "user": "https://github.com/dimpase"
}
```

Perhaps this should get #25188 as a dependence, so that the latter and this are merged together, with just one new configure tarball instead of two...



---

archive/issue_comments_360927.json:
```json
{
    "body": "Looks like the latest patchbot build failed due to #18438.\n\nDima, that's not a bad idea, but I'd like to see a positive review on both first.",
    "created_at": "2018-09-07T09:14:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360927",
    "user": "https://github.com/embray"
}
```

Looks like the latest patchbot build failed due to #18438.

Dima, that's not a bad idea, but I'd like to see a positive review on both first.



---

archive/issue_comments_360928.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-10-15T09:55:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360928",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_064682.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-10-20T11:59:15Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25620#event-64682"
}
```



---

archive/issue_comments_360929.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-10-20T11:59:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360929",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_360930.json:
```json
{
    "body": "This should be re-targeted for 8.5.",
    "created_at": "2018-10-28T14:52:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25620#issuecomment-360930",
    "user": "https://github.com/embray"
}
```

This should be re-targeted for 8.5.



---

archive/issue_events_064683.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-10-28T14:52:23Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "milestone": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25620#event-64683"
}
```



---

archive/issue_events_064684.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-10-28T14:52:23Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25620",
    "milestone": "sage-8.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25620#event-64684"
}
```
