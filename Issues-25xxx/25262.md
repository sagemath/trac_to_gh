# Issue 25262: Track performance regressions in CI

archive/issues_025025.json:
```json
{
    "assignees": [],
    "body": "I am currently playing with airspeed velocity to track speed regressions in Sage. I would like to benchmark every doctest that has a `long time` or `benchmark` marker in it and also benchmark every method that has a `time_` prefix (probably only in some benchmark module.)\n\nWe have something similar set up for https://github.com/MCLF/mclf/tree/master/mclf/benchmarks now. There are only two benchmarks but it works nicely.\n\nI ran the above proposal for all the tags from 8.3.beta0 to 8.3. There's a lot of noise (because there was other activity on the machine) but you get the idea: https://saraedum.github.io/sage/\n\nAnother interesting demo of airspeedvelocity that is not related to Sage is here: https://pv.github.io/numpy-bench/#/regressions\n\nDepends on #24655\n\nCC:  @roed314 @embray @nthiery @koffie @videlec\n\nKeywords: **ContinuousIntegration**\n\nBranch/Commit: **[public/airspeed_velo](https://github.com/sagemath/sagetrac-mirror/tree/public/airspeed_velo) @ [68869ae](https://github.com/sagemath/sagetrac-mirror/commit/68869aea9a6814ed6c2d1e701885d369939ba4c7)**\n\nWork Issues: **documentation, doctests, CI**\n\nAuthor: **Julian R\u00fcth**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/25262_\n\n",
    "closed_at": "2018-04-29T17:24:12Z",
    "created_at": "2018-04-29T14:02:05Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20doctest%20framework",
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Track performance regressions in CI",
    "type": "issue",
    "updated_at": "2022-12-29T01:42:26Z",
    "url": "https://github.com/sagemath/sage/issues/25262",
    "user": "https://github.com/saraedum"
}
```
I am currently playing with airspeed velocity to track speed regressions in Sage. I would like to benchmark every doctest that has a `long time` or `benchmark` marker in it and also benchmark every method that has a `time_` prefix (probably only in some benchmark module.)

We have something similar set up for https://github.com/MCLF/mclf/tree/master/mclf/benchmarks now. There are only two benchmarks but it works nicely.

I ran the above proposal for all the tags from 8.3.beta0 to 8.3. There's a lot of noise (because there was other activity on the machine) but you get the idea: https://saraedum.github.io/sage/

Another interesting demo of airspeedvelocity that is not related to Sage is here: https://pv.github.io/numpy-bench/#/regressions

Depends on #24655

CC:  @roed314 @embray @nthiery @koffie @videlec

Keywords: **ContinuousIntegration**

Branch/Commit: **[public/airspeed_velo](https://github.com/sagemath/sagetrac-mirror/tree/public/airspeed_velo) @ [68869ae](https://github.com/sagemath/sagetrac-mirror/commit/68869aea9a6814ed6c2d1e701885d369939ba4c7)**

Work Issues: **documentation, doctests, CI**

Author: **Julian Rüth**

_Issue created by migration from https://trac.sagemath.org/ticket/25262_





---

archive/issue_events_331560.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-04-29T14:02:05Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "milestone_number": null,
    "milestone_title": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25262#event-331560"
}
```



---

archive/issue_events_331561.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-04-29T14:02:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20doctest%20framework",
    "label_color": "000080",
    "label_name": "component: doctest framework",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25262#event-331561"
}
```



---

archive/issue_events_331562.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-04-29T14:02:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25262#event-331562"
}
```



---

archive/issue_events_331563.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-04-29T14:02:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25262#event-331563"
}
```



---

archive/issue_comments_388986.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">Comment 1</div>\n\nI think we have to work with the Advanced API (https://docs.python.org/2/library/doctest.html#advanced-api) and hook into `DocTestRunner.run()` to track timings and export them into an artitfical `benchmark/` directory that just prints these timings for asv.",
    "created_at": "2018-04-29T14:42:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-388986",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:1" align="right">Comment 1</div>

I think we have to work with the Advanced API (https://docs.python.org/2/library/doctest.html#advanced-api) and hook into `DocTestRunner.run()` to track timings and export them into an artitfical `benchmark/` directory that just prints these timings for asv.



---

archive/issue_comments_388987.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">Comment 2</div>\n\nThis is great, and I'm happy to help!\n\nWe're already using the advanced API.  See `sage/doctest/forker.py`, lines 425 to 786 (maybe it would make sense to do the exporting in summarize).",
    "created_at": "2018-04-29T14:54:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-388987",
    "user": "https://github.com/roed314"
}
```

<div id="comment:2" align="right">Comment 2</div>

This is great, and I'm happy to help!

We're already using the advanced API.  See `sage/doctest/forker.py`, lines 425 to 786 (maybe it would make sense to do the exporting in summarize).



---

archive/issue_comments_388988.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">Comment 3</div>\n\nJust to say something which I have always said before: measuring timings is the easy part. The hard part is doing something useful with those timings.",
    "created_at": "2018-04-29T17:23:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-388988",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:3" align="right">Comment 3</div>

Just to say something which I have always said before: measuring timings is the easy part. The hard part is doing something useful with those timings.



---

archive/issue_events_331564.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-04-29T17:24:12Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25262#event-331564"
}
```



---

archive/issue_comments_388989.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">Comment 4</div>\n\nDuplicate of #12720.",
    "created_at": "2018-04-29T17:24:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-388989",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:4" align="right">Comment 4</div>

Duplicate of #12720.



---

archive/issue_events_331565.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-04-29T17:24:12Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25262#event-331565"
}
```



---

archive/issue_events_331566.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-04-29T17:24:12Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "label": "https://github.com/sagemath/sage/labels/duplicate",
    "label_color": "a6a6a6",
    "label_name": "duplicate",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25262#event-331566"
}
```



---

archive/issue_events_331567.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-04-29T17:24:12Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "milestone_number": null,
    "milestone_title": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25262#event-331567"
}
```



---

archive/issue_comments_388990.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">Comment 5</div>\n\nI don't think this is a duplicate. This is about integrating speed regression checks into CI (GitLab CI, CircleCI.) Please reopen.",
    "created_at": "2018-04-29T17:26:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-388990",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:5" align="right">Comment 5</div>

I don't think this is a duplicate. This is about integrating speed regression checks into CI (GitLab CI, CircleCI.) Please reopen.



---

archive/issue_events_331568.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-04-29T17:27:06Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "milestone_number": null,
    "milestone_title": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25262#event-331568"
}
```



---

archive/issue_comments_388991.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">Comment 7</div>\n\nReplying to [@jdemeyer](#comment%3A3):\n> Just to say something which I have always said before: measuring timings is the easy part. The hard part is doing something useful with those timings.\n\nThat's what airspeed velocity is good for.",
    "created_at": "2018-04-29T17:29:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-388991",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:7" align="right">Comment 7</div>

Replying to [@jdemeyer](#comment%3A3):
> Just to say something which I have always said before: measuring timings is the easy part. The hard part is doing something useful with those timings.

That's what airspeed velocity is good for.



---

archive/issue_comments_388992.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">Comment 8</div>\n\n> I am currently playing with airspeed velocity to track speed regressions in Sage\n\nGreat! It's an excellent tool and I've wanted to see it used for Sage for a long time, but wasn't sure where to begin.  In case it helps I know and have worked with its creator personally.",
    "created_at": "2018-04-29T21:12:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-388992",
    "user": "https://github.com/embray"
}
```

<div id="comment:8" align="right">Comment 8</div>

> I am currently playing with airspeed velocity to track speed regressions in Sage

Great! It's an excellent tool and I've wanted to see it used for Sage for a long time, but wasn't sure where to begin.  In case it helps I know and have worked with its creator personally.



---

archive/issue_events_331569.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-29T21:14:55Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "label": "https://github.com/sagemath/sage/labels/duplicate",
    "label_color": "a6a6a6",
    "label_name": "duplicate",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25262#event-331569"
}
```



---

archive/issue_comments_388993.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">Comment 9</div>\n\nEven if #12720 was addressing a similar problem, it's an orthogonal approach, and if Julian can get ASV working this could supersede #12720.",
    "created_at": "2018-04-29T21:14:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-388993",
    "user": "https://github.com/embray"
}
```

<div id="comment:9" align="right">Comment 9</div>

Even if #12720 was addressing a similar problem, it's an orthogonal approach, and if Julian can get ASV working this could supersede #12720.



---

archive/issue_comments_388994.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">Comment 10</div>\n\nReplying to [@saraedum](#comment%3A7):\n> Replying to [@jdemeyer](#comment%3A3):\n> > Just to say something which I have always said before: measuring timings is the easy part. The hard part is doing something useful with those timings.\n\n> \n> That's what airspeed velocity is good for.\n\nWell, I'd love to be proven wrong. I thought it was just a tool to benchmark a given set of commands across versions and display fancy graphs.",
    "created_at": "2018-04-30T05:08:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-388994",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:10" align="right">Comment 10</div>

Replying to [@saraedum](#comment%3A7):
> Replying to [@jdemeyer](#comment%3A3):
> > Just to say something which I have always said before: measuring timings is the easy part. The hard part is doing something useful with those timings.

> 
> That's what airspeed velocity is good for.

Well, I'd love to be proven wrong. I thought it was just a tool to benchmark a given set of commands across versions and display fancy graphs.



---

archive/issue_comments_388995.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">Comment 12</div>\n\nNot just across versions but across commits, even (though I think you can change the granularity).  Here are Astropy's ASV benchmarks:  http://www.astropy.org/astropy-benchmarks/\n\nThere are numerous benchmark tests for various common and/or time-critical operations.  For example, we can track how coordinate transformations perform over time (which is one example of complex code that can fairly easily be thrown into bad performance by just a few small changes somewhere).",
    "created_at": "2018-04-30T09:52:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-388995",
    "user": "https://github.com/embray"
}
```

<div id="comment:12" align="right">Comment 12</div>

Not just across versions but across commits, even (though I think you can change the granularity).  Here are Astropy's ASV benchmarks:  http://www.astropy.org/astropy-benchmarks/

There are numerous benchmark tests for various common and/or time-critical operations.  For example, we can track how coordinate transformations perform over time (which is one example of complex code that can fairly easily be thrown into bad performance by just a few small changes somewhere).



---

archive/issue_events_331570.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-08-03T19:20:18Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "milestone_number": null,
    "milestone_title": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25262#event-331570"
}
```



---

archive/issue_events_331571.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-08-03T19:20:18Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "milestone_number": null,
    "milestone_title": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25262#event-331571"
}
```



---

archive/issue_comments_388996.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">Comment 14</div>\n\nupdate milestone 8.3 -> 8.4",
    "created_at": "2018-08-03T19:20:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-388996",
    "user": "https://github.com/videlec"
}
```

<div id="comment:14" align="right">Comment 14</div>

update milestone 8.3 -> 8.4



---

archive/issue_comments_388997.json:
```json
{
    "body": "Author: **Julian R\u00fcth**",
    "created_at": "2018-08-09T00:44:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-388997",
    "user": "https://github.com/saraedum"
}
```

Author: **Julian Rüth**



---

archive/issue_comments_388998.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">Comment 15</div>\n\nAdding this to all doctests is probably hard and would require too much hacking on asv. It's probably best to use the tool as it was intended to be used. Once #24655 is in, I would like to setup a prototype within Sage. Any area that you would like to have benchmarked from the start?",
    "created_at": "2018-08-09T00:44:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-388998",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:15" align="right">Comment 15</div>

Adding this to all doctests is probably hard and would require too much hacking on asv. It's probably best to use the tool as it was intended to be used. Once #24655 is in, I would like to setup a prototype within Sage. Any area that you would like to have benchmarked from the start?



---

archive/issue_comments_388999.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,5 @@\n-I am currently playing with airspeed velocity to track speed regressions in Sage. For a start I would like to track the runtime of our doctests per method and see if that is already useful information.\n+I am currently playing with airspeed velocity to track speed regressions in Sage. ~~For a start I would like to track the runtime of our doctests per method and see if that is already useful information.~~ We could have specially named methods, say starting in `_benchmark_time_\u2026` that are automatically tracked by CI on the develop branch.\n \n-A demo is here: https://pv.github.io/numpy-bench/#/regressions\n+We have this set up for https://github.com/MCLF/mclf/tree/master/mclf/benchmarks now. There are only two benchmarks but it works nicely.\n+\n+A more interesting demo that is not related to Sage is here: https://pv.github.io/numpy-bench/#/regressions\n``````\n",
    "created_at": "2018-08-09T00:44:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-388999",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,5 @@
-I am currently playing with airspeed velocity to track speed regressions in Sage. For a start I would like to track the runtime of our doctests per method and see if that is already useful information.
+I am currently playing with airspeed velocity to track speed regressions in Sage. ~~For a start I would like to track the runtime of our doctests per method and see if that is already useful information.~~ We could have specially named methods, say starting in `_benchmark_time_…` that are automatically tracked by CI on the develop branch.
 
-A demo is here: https://pv.github.io/numpy-bench/#/regressions
+We have this set up for https://github.com/MCLF/mclf/tree/master/mclf/benchmarks now. There are only two benchmarks but it works nicely.
+
+A more interesting demo that is not related to Sage is here: https://pv.github.io/numpy-bench/#/regressions
``````




---

archive/issue_comments_389000.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">Comment 16</div>\n\nReplying to [@saraedum](#comment%3A15):\n> Any area that you would like to have benchmarked from the start?\n\nThis is the \"hard part\" that I mentioned in [comment:3]. Ideally, we shouldn't have to guess where regressions might occur, the tool would do that for us. I believe that the intention of #12720 was to integrate this in the doctest framework such that all(?) doctests would also be regression tests.\n\nBut that's probably not feasible, so here is a more productive answer:\n\n1. All `# long time` tests should definitely be regression tests.\n\n2. For each `Parent` (more precisely: every time that a `TestSuite` appears in a doctest): test creating a parent, test creating elements, test some basic arithmetic (also with elements of different such that we check the coercion model too).",
    "created_at": "2018-08-09T05:35:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389000",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:16" align="right">Comment 16</div>

Replying to [@saraedum](#comment%3A15):
> Any area that you would like to have benchmarked from the start?

This is the "hard part" that I mentioned in [comment:3]. Ideally, we shouldn't have to guess where regressions might occur, the tool would do that for us. I believe that the intention of #12720 was to integrate this in the doctest framework such that all(?) doctests would also be regression tests.

But that's probably not feasible, so here is a more productive answer:

1. All `# long time` tests should definitely be regression tests.

2. For each `Parent` (more precisely: every time that a `TestSuite` appears in a doctest): test creating a parent, test creating elements, test some basic arithmetic (also with elements of different such that we check the coercion model too).



---

archive/issue_comments_389001.json:
```json
{
    "body": "Replying to [ticket:25262 saraedum]:\n> We could have specially named methods, say starting in `_benchmark_time_\u2026`\n\nAdding a new method for each regression tests sounds quite heavy. Could it be possible to integrate this in doctests instead? I would love to do\n\n```\nEXAMPLES::\n\n    sage: some_sage_code()  # airspeed\n```",
    "created_at": "2018-08-09T05:38:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389001",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [ticket:25262 saraedum]:
> We could have specially named methods, say starting in `_benchmark_time_…`

Adding a new method for each regression tests sounds quite heavy. Could it be possible to integrate this in doctests instead? I would love to do

```
EXAMPLES::

    sage: some_sage_code()  # airspeed
```



---

archive/issue_comments_389002.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">Comment 18</div>\n\nReplying to [@saraedum](#comment%3A15):\n> Adding this to all doctests is probably hard and would require too much hacking on asv. It's probably best to use the tool as it was intended to be used. Once #24655 is in, I would like to setup a prototype within Sage. Any area that you would like to have benchmarked from the start?\n\nI didn't realize you were trying to do that.  And yeah, I think benchmarking *every* test would be overkill and would produce too much noise to be useful.  Better to write specific benchmark tests, and also add new ones as regression tests whenever some major performance regression is noticed.",
    "created_at": "2018-08-09T10:40:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389002",
    "user": "https://github.com/embray"
}
```

<div id="comment:18" align="right">Comment 18</div>

Replying to [@saraedum](#comment%3A15):
> Adding this to all doctests is probably hard and would require too much hacking on asv. It's probably best to use the tool as it was intended to be used. Once #24655 is in, I would like to setup a prototype within Sage. Any area that you would like to have benchmarked from the start?

I didn't realize you were trying to do that.  And yeah, I think benchmarking *every* test would be overkill and would produce too much noise to be useful.  Better to write specific benchmark tests, and also add new ones as regression tests whenever some major performance regression is noticed.



---

archive/issue_comments_389003.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">Comment 19</div>\n\nReplying to [@saraedum](#comment%3A15):\n> Adding this to all doctests is probably hard and would require too much hacking on asv. It's probably best to use the tool as it was intended to be used. Once #24655 is in, I would like to setup a prototype within Sage. Any area that you would like to have benchmarked from the start?\n\nI can't imagine why you would like to start in on place, but if it really makes your life easier I would start with linear algebra. This is so abundant in other parts of sage that any regression there will very likely show up in other places.",
    "created_at": "2018-08-10T09:20:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389003",
    "user": "https://github.com/koffie"
}
```

<div id="comment:19" align="right">Comment 19</div>

Replying to [@saraedum](#comment%3A15):
> Adding this to all doctests is probably hard and would require too much hacking on asv. It's probably best to use the tool as it was intended to be used. Once #24655 is in, I would like to setup a prototype within Sage. Any area that you would like to have benchmarked from the start?

I can't imagine why you would like to start in on place, but if it really makes your life easier I would start with linear algebra. This is so abundant in other parts of sage that any regression there will very likely show up in other places.



---

archive/issue_comments_389004.json:
```json
{
    "body": "Branch: **[u/saraedum/25262](https://github.com/sagemath/sagetrac-mirror/tree/u/saraedum/25262)**",
    "created_at": "2018-08-11T02:02:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389004",
    "user": "https://github.com/saraedum"
}
```

Branch: **[u/saraedum/25262](https://github.com/sagemath/sagetrac-mirror/tree/u/saraedum/25262)**



---

archive/issue_comments_389005.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">Comment 21</div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f7f3847b26048b3b5f437731230d8dd2ade93eae\">f7f3847</a></td><td><code>Faster benchmark discovery during run</code></td></tr></table>\n",
    "created_at": "2018-08-11T02:37:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389005",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:21" align="right">Comment 21</div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f7f3847b26048b3b5f437731230d8dd2ade93eae">f7f3847</a></td><td><code>Faster benchmark discovery during run</code></td></tr></table>




---

archive/issue_comments_389006.json:
```json
{
    "body": "Commit: **[f7f3847](https://github.com/sagemath/sagetrac-mirror/commit/f7f3847b26048b3b5f437731230d8dd2ade93eae)**",
    "created_at": "2018-08-11T02:37:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389006",
    "user": "https://github.com/sagetrac-git"
}
```

Commit: **[f7f3847](https://github.com/sagemath/sagetrac-mirror/commit/f7f3847b26048b3b5f437731230d8dd2ade93eae)**



---

archive/issue_comments_389007.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">Comment 22</div>\n\n> And yeah, I think benchmarking *every* test would be overkill and would produce too much noise to be useful.\n\nI could imagine situation where I would be curious to know how the speed of a given doctest (granularity to be discussed) has evolved over time. Or where I would like to investigate how this or that (collection of) doctest was impacted by this or that ticket.\n\nSo even though having info about all doctests would indeed pollute the main \"speed regression\" report it could till be interesting to harvest it, and make it available with some search mechanism.\n\nOf course this is just \"good to have\", if not too costly to implement/produce/store/serve.",
    "created_at": "2018-08-12T00:03:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389007",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:22" align="right">Comment 22</div>

> And yeah, I think benchmarking *every* test would be overkill and would produce too much noise to be useful.

I could imagine situation where I would be curious to know how the speed of a given doctest (granularity to be discussed) has evolved over time. Or where I would like to investigate how this or that (collection of) doctest was impacted by this or that ticket.

So even though having info about all doctests would indeed pollute the main "speed regression" report it could till be interesting to harvest it, and make it available with some search mechanism.

Of course this is just "good to have", if not too costly to implement/produce/store/serve.



---

archive/issue_comments_389008.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">Comment 23</div>\n\nSo, I now ran benchmarks for all doctests that contain a \"long time\" marker. I tried to run it for all the tags between 8.2 and 8.3 which took about 48h on my laptop. Somehow it failed for 8.2 itself which makes the results not terribly useful and also there's a lot of noise which is likely because well I was using my computer to do other stuff as well.\n\nAnyway, you can see the result here: https://saraedum.github.io/sage/\n\nSo, what do you think? Should we try to run `time_*` methods (the default behaviour of airspeedvelocity) and also all doctests that say `long time`?",
    "created_at": "2018-08-17T14:22:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389008",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:23" align="right">Comment 23</div>

So, I now ran benchmarks for all doctests that contain a "long time" marker. I tried to run it for all the tags between 8.2 and 8.3 which took about 48h on my laptop. Somehow it failed for 8.2 itself which makes the results not terribly useful and also there's a lot of noise which is likely because well I was using my computer to do other stuff as well.

Anyway, you can see the result here: https://saraedum.github.io/sage/

So, what do you think? Should we try to run `time_*` methods (the default behaviour of airspeedvelocity) and also all doctests that say `long time`?



---

archive/issue_comments_389009.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">Comment 24</div>\n\nBtw., the naming of the benchmarks is a bit unfortunate currently as you can only see the module and the method name but not the class which makes it a bit hard to track down which `__init__` exactly saw a regression.",
    "created_at": "2018-08-17T14:26:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389009",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:24" align="right">Comment 24</div>

Btw., the naming of the benchmarks is a bit unfortunate currently as you can only see the module and the method name but not the class which makes it a bit hard to track down which `__init__` exactly saw a regression.



---

archive/issue_comments_389010.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,5 +1,7 @@\n-I am currently playing with airspeed velocity to track speed regressions in Sage. ~~For a start I would like to track the runtime of our doctests per method and see if that is already useful information.~~ We could have specially named methods, say starting in `_benchmark_time_\u2026` that are automatically tracked by CI on the develop branch.\n+I am currently playing with airspeed velocity to track speed regressions in Sage. I would like to benchmark every doctest that has a \"long time\" marker in it and also benchmark every method that has a `time_` prefix (probably only in some benchmark module.)\n \n-We have this set up for https://github.com/MCLF/mclf/tree/master/mclf/benchmarks now. There are only two benchmarks but it works nicely.\n+We have something similar set up for https://github.com/MCLF/mclf/tree/master/mclf/benchmarks now. There are only two benchmarks but it works nicely.\n \n-A more interesting demo that is not related to Sage is here: https://pv.github.io/numpy-bench/#/regressions\n+I ran the above proposal for all the tags from 8.3.beta0 to 8.3. There's a lot of noise (because there was other activity on the machine) but you get the idea: https://saraedum.github.io/sage/\n+\n+Another interesting demo of airspeedvelocity that is not related to Sage is here: https://pv.github.io/numpy-bench/#/regressions\n``````\n",
    "created_at": "2018-08-17T14:26:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389010",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,5 +1,7 @@
-I am currently playing with airspeed velocity to track speed regressions in Sage. ~~For a start I would like to track the runtime of our doctests per method and see if that is already useful information.~~ We could have specially named methods, say starting in `_benchmark_time_…` that are automatically tracked by CI on the develop branch.
+I am currently playing with airspeed velocity to track speed regressions in Sage. I would like to benchmark every doctest that has a "long time" marker in it and also benchmark every method that has a `time_` prefix (probably only in some benchmark module.)
 
-We have this set up for https://github.com/MCLF/mclf/tree/master/mclf/benchmarks now. There are only two benchmarks but it works nicely.
+We have something similar set up for https://github.com/MCLF/mclf/tree/master/mclf/benchmarks now. There are only two benchmarks but it works nicely.
 
-A more interesting demo that is not related to Sage is here: https://pv.github.io/numpy-bench/#/regressions
+I ran the above proposal for all the tags from 8.3.beta0 to 8.3. There's a lot of noise (because there was other activity on the machine) but you get the idea: https://saraedum.github.io/sage/
+
+Another interesting demo of airspeedvelocity that is not related to Sage is here: https://pv.github.io/numpy-bench/#/regressions
``````




---

archive/issue_comments_389011.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">Comment 25</div>\n\nWhy did it take 48 hours do you think?  That seems a bit excessive.",
    "created_at": "2018-08-17T14:30:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389011",
    "user": "https://github.com/embray"
}
```

<div id="comment:25" align="right">Comment 25</div>

Why did it take 48 hours do you think?  That seems a bit excessive.



---

archive/issue_comments_389012.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">Comment 26</div>\n\nReplying to [@saraedum](#comment%3A24):\n> Btw., the naming of the benchmarks is a bit unfortunate currently as you can only see the module and the method name but not the class which makes it a bit hard to track down which `__init__` exactly saw a regression.\n\nThat seems fixable.  Is that an ASV bug or something on our end?  Also, I see a few tests with `?` in the name for which there's no graph shown.  Could that be from nested classes or something?",
    "created_at": "2018-08-17T14:33:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389012",
    "user": "https://github.com/embray"
}
```

<div id="comment:26" align="right">Comment 26</div>

Replying to [@saraedum](#comment%3A24):
> Btw., the naming of the benchmarks is a bit unfortunate currently as you can only see the module and the method name but not the class which makes it a bit hard to track down which `__init__` exactly saw a regression.

That seems fixable.  Is that an ASV bug or something on our end?  Also, I see a few tests with `?` in the name for which there's no graph shown.  Could that be from nested classes or something?



---

archive/issue_comments_389013.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">Comment 27</div>\n\nReplying to [@saraedum](#comment%3A23):\n> also there's a lot of noise which is likely because well I was using my computer to do other stuff as well.\n\nIf we can get several machines (even just 2) providing benchmark results this sort of problem will be mitigated.  For example, here's a benchmark from Astropy for which we have results from 2 machines: http://www.astropy.org/astropy-benchmarks/#coordinates.FrameBenchmarks.time_init_array  You can clearly see when major deviations are correlated.",
    "created_at": "2018-08-17T14:40:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389013",
    "user": "https://github.com/embray"
}
```

<div id="comment:27" align="right">Comment 27</div>

Replying to [@saraedum](#comment%3A23):
> also there's a lot of noise which is likely because well I was using my computer to do other stuff as well.

If we can get several machines (even just 2) providing benchmark results this sort of problem will be mitigated.  For example, here's a benchmark from Astropy for which we have results from 2 machines: http://www.astropy.org/astropy-benchmarks/#coordinates.FrameBenchmarks.time_init_array  You can clearly see when major deviations are correlated.



---

archive/issue_comments_389014.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">Comment 28</div>\n\nReplying to [@embray](#comment%3A25):\n> Why did it take 48 hours do you think?  That seems a bit excessive.\n\nI did a `make build && sage -ba` for I think 10 tags (as `sage -b` sometimes missed some files.) Then asv runs the doctests single-threaded and there is a few seconds of overhead for every benchmark.\n\nActually \"about 48h\" is incorrect. It's probably more than 24h and less than 48h. But I did not really check the times.",
    "created_at": "2018-08-17T14:40:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389014",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:28" align="right">Comment 28</div>

Replying to [@embray](#comment%3A25):
> Why did it take 48 hours do you think?  That seems a bit excessive.

I did a `make build && sage -ba` for I think 10 tags (as `sage -b` sometimes missed some files.) Then asv runs the doctests single-threaded and there is a few seconds of overhead for every benchmark.

Actually "about 48h" is incorrect. It's probably more than 24h and less than 48h. But I did not really check the times.



---

archive/issue_comments_389015.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">Comment 29</div>\n\nReplying to [@embray](#comment%3A26):\n> Replying to [@saraedum](#comment%3A24):\n> > Btw., the naming of the benchmarks is a bit unfortunate currently as you can only see the module and the method name but not the class which makes it a bit hard to track down which `__init__` exactly saw a regression.\n\n> \n> That seems fixable.  Is that an ASV bug or something on our end?\n\nMy fault.\n\n> Also, I see a few tests with `?` in the name for which there's no graph shown.  Could that be from nested classes or something?\n\nI have not looked into these. Some of the empty graphs are because the benchmark timed out after 60s. That could be changed of course.",
    "created_at": "2018-08-17T14:41:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389015",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:29" align="right">Comment 29</div>

Replying to [@embray](#comment%3A26):
> Replying to [@saraedum](#comment%3A24):
> > Btw., the naming of the benchmarks is a bit unfortunate currently as you can only see the module and the method name but not the class which makes it a bit hard to track down which `__init__` exactly saw a regression.

> 
> That seems fixable.  Is that an ASV bug or something on our end?

My fault.

> Also, I see a few tests with `?` in the name for which there's no graph shown.  Could that be from nested classes or something?

I have not looked into these. Some of the empty graphs are because the benchmark timed out after 60s. That could be changed of course.



---

archive/issue_comments_389016.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">Comment 30</div>\n\nReplying to [@saraedum](#comment%3A29):\n> Replying to [@embray](#comment%3A26):\n> > Replying to [@saraedum](#comment%3A24):\n> > Also, I see a few tests with `?` in the name for which there's no graph shown.  Could that be from nested classes or something?\n\n> I have not looked into these. Some of the empty graphs are because the benchmark timed out after 60s. That could be changed of course.\n\nNo, actually the `?` failed because that's not a valid method name anymore. So, also my fault ;)",
    "created_at": "2018-08-17T14:42:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389016",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:30" align="right">Comment 30</div>

Replying to [@saraedum](#comment%3A29):
> Replying to [@embray](#comment%3A26):
> > Replying to [@saraedum](#comment%3A24):
> > Also, I see a few tests with `?` in the name for which there's no graph shown.  Could that be from nested classes or something?

> I have not looked into these. Some of the empty graphs are because the benchmark timed out after 60s. That could be changed of course.

No, actually the `?` failed because that's not a valid method name anymore. So, also my fault ;)



---

archive/issue_comments_389017.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">Comment 31</div>\n\nReplying to [@embray](#comment%3A25):\n> Why did it take 48 hours do you think?  That seems a bit excessive.\n\nI guess, now that I think about it, if you were doing each release between 8.2 and 8.3 you also had to do incremental builds of each of those, which could take some time as well, especially if it was just on your laptop, which you were also doing other work on.\n\nNormally this wouldn't be a problem for machines generating new benchmark results between each release.",
    "created_at": "2018-08-17T14:42:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389017",
    "user": "https://github.com/embray"
}
```

<div id="comment:31" align="right">Comment 31</div>

Replying to [@embray](#comment%3A25):
> Why did it take 48 hours do you think?  That seems a bit excessive.

I guess, now that I think about it, if you were doing each release between 8.2 and 8.3 you also had to do incremental builds of each of those, which could take some time as well, especially if it was just on your laptop, which you were also doing other work on.

Normally this wouldn't be a problem for machines generating new benchmark results between each release.



---

archive/issue_comments_389018.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">Comment 32</div>\n\nMy other comments aside, this looks great!\n\nI don't think it's too much noise.  In general, most people will only be looking at benchmarks for areas of the code that they're particularly concerned about, though it would also be good to occasionally scan for any major regressions.  It will also be good if we can get better looking display names on each of the benchmarks.  If there's something we need to patch upstream in ASV to improve that I'm sure we could.  It will also obviously be more useful if there are multiple machines providing benchmarks.  Perhaps we could integrate this into the buildbot builds.",
    "created_at": "2018-08-17T14:46:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389018",
    "user": "https://github.com/embray"
}
```

<div id="comment:32" align="right">Comment 32</div>

My other comments aside, this looks great!

I don't think it's too much noise.  In general, most people will only be looking at benchmarks for areas of the code that they're particularly concerned about, though it would also be good to occasionally scan for any major regressions.  It will also be good if we can get better looking display names on each of the benchmarks.  If there's something we need to patch upstream in ASV to improve that I'm sure we could.  It will also obviously be more useful if there are multiple machines providing benchmarks.  Perhaps we could integrate this into the buildbot builds.



---

archive/issue_comments_389019.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">Comment 33</div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d7ff532b3519c2904b9c61dfd07ad542c639017b\">d7ff532</a></td><td><code>A proof of concept of airspeed velocity integration</code></td></tr></table>\n",
    "created_at": "2018-08-17T14:48:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389019",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:33" align="right">Comment 33</div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d7ff532b3519c2904b9c61dfd07ad542c639017b">d7ff532</a></td><td><code>A proof of concept of airspeed velocity integration</code></td></tr></table>




---

archive/issue_comments_389020.json:
```json
{
    "body": "Changed commit from **[f7f3847](https://github.com/sagemath/sagetrac-mirror/commit/f7f3847b26048b3b5f437731230d8dd2ade93eae)** to **[d7ff532](https://github.com/sagemath/sagetrac-mirror/commit/d7ff532b3519c2904b9c61dfd07ad542c639017b)**",
    "created_at": "2018-08-17T14:48:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389020",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[f7f3847](https://github.com/sagemath/sagetrac-mirror/commit/f7f3847b26048b3b5f437731230d8dd2ade93eae)** to **[d7ff532](https://github.com/sagemath/sagetrac-mirror/commit/d7ff532b3519c2904b9c61dfd07ad542c639017b)**



---

archive/issue_comments_389021.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">Comment 34</div>\n\nAlso, we could group benchmarks by package like this: http://www.astropy.org/astropy-benchmarks/#/\n\nI bet with a bit of hacking we could even get the mouseover that shows the test to actually display the relevant doctest instead.  If nothing else, this could be done by generating functions that have the relevant doctest in its docstring :)",
    "created_at": "2018-08-17T14:49:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389021",
    "user": "https://github.com/embray"
}
```

<div id="comment:34" align="right">Comment 34</div>

Also, we could group benchmarks by package like this: http://www.astropy.org/astropy-benchmarks/#/

I bet with a bit of hacking we could even get the mouseover that shows the test to actually display the relevant doctest instead.  If nothing else, this could be done by generating functions that have the relevant doctest in its docstring :)



---

archive/issue_comments_389022.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">Comment 35</div>\n\nReplying to [@embray](#comment%3A32):\n> It will also be good if we can get better looking display names on each of the benchmarks.  If there's something we need to patch upstream in ASV to improve that I'm sure we could.\n\nWe could improve it somewhat but I would like to have a hash in there somewhere and it also has to be a valid Python2 method name.\n\nThis is really some black metaclass magic to have asv detect one benchmark method for every doctest we have. Let me try to explain how this goes roughly.\n\nASV first runs a \"discovery\" where it collects all the benchmarks (by looking for methods that start with certain prefixes such as `time_`.) Then it invokes itself once for each such method to run the actual benchmark.\n\nTo trick the discovery into finding a method for every doctest, I implement `__dir__` on the `BenchmarkMetaclass` to run all doctests in the Sage library but without actually running the code. Instead I just print the expected output to have them all pass as quickly as possible and track their existence. Here, I create a hash of the doctest so I can find it again in the second pass of ASV.\n\nThen when ASV actually tries to run, say `__init__.Benchmarks.track__families__RingedTree__62b2284259a21f85bd8db00b8522ad3b`, I inject that method in `__getattr__` and have it run all the doctests in `**/families*.pyx?` but again I actually skip all the doctests except for the first one that produces 62b2284259a21f85bd8db00b8522ad3b as its hash. I time every line of that doctest and return these timings as the result to ASV.",
    "created_at": "2018-08-17T15:02:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389022",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:35" align="right">Comment 35</div>

Replying to [@embray](#comment%3A32):
> It will also be good if we can get better looking display names on each of the benchmarks.  If there's something we need to patch upstream in ASV to improve that I'm sure we could.

We could improve it somewhat but I would like to have a hash in there somewhere and it also has to be a valid Python2 method name.

This is really some black metaclass magic to have asv detect one benchmark method for every doctest we have. Let me try to explain how this goes roughly.

ASV first runs a "discovery" where it collects all the benchmarks (by looking for methods that start with certain prefixes such as `time_`.) Then it invokes itself once for each such method to run the actual benchmark.

To trick the discovery into finding a method for every doctest, I implement `__dir__` on the `BenchmarkMetaclass` to run all doctests in the Sage library but without actually running the code. Instead I just print the expected output to have them all pass as quickly as possible and track their existence. Here, I create a hash of the doctest so I can find it again in the second pass of ASV.

Then when ASV actually tries to run, say `__init__.Benchmarks.track__families__RingedTree__62b2284259a21f85bd8db00b8522ad3b`, I inject that method in `__getattr__` and have it run all the doctests in `**/families*.pyx?` but again I actually skip all the doctests except for the first one that produces 62b2284259a21f85bd8db00b8522ad3b as its hash. I time every line of that doctest and return these timings as the result to ASV.



---

archive/issue_comments_389023.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">Comment 36</div>\n\nReplying to [@embray](#comment%3A34):\n> Also, we could group benchmarks by package like this: http://www.astropy.org/astropy-benchmarks/#/\n> \n> I bet with a bit of hacking we could even get the mouseover that shows the test to actually display the relevant doctest instead.  If nothing else, this could be done by generating functions that have the relevant doctest in its docstring :)\n\nMaybe nothing even that complicated.  ISTM we can subclass the `Benchmark` base class (or more specifically ones like `TimeBenchmark` and assign the `code` attribute to whatever we want, which could include the relevant doctest snippet.",
    "created_at": "2018-08-17T15:03:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389023",
    "user": "https://github.com/embray"
}
```

<div id="comment:36" align="right">Comment 36</div>

Replying to [@embray](#comment%3A34):
> Also, we could group benchmarks by package like this: http://www.astropy.org/astropy-benchmarks/#/
> 
> I bet with a bit of hacking we could even get the mouseover that shows the test to actually display the relevant doctest instead.  If nothing else, this could be done by generating functions that have the relevant doctest in its docstring :)

Maybe nothing even that complicated.  ISTM we can subclass the `Benchmark` base class (or more specifically ones like `TimeBenchmark` and assign the `code` attribute to whatever we want, which could include the relevant doctest snippet.



---

archive/issue_comments_389024.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">Comment 37</div>\n\nReplying to [@embray](#comment%3A34):\n> Also, we could group benchmarks by package like this: http://www.astropy.org/astropy-benchmarks/#/\n\nThat one is a bit tricky to do dynamically. ASV detects packages by looking at the filesystem so you would actually need `.py` files there. And I would like to have something that works not only on the benchmark machines but also if you invoke asv yourself.\n\n> I bet with a bit of hacking we could even get the mouseover that shows the test to actually display the relevant doctest instead.  If nothing else, this could be done by generating functions that have the relevant doctest in its docstring :)\n\nSure, you would just have to set the docstring of the generated methods.",
    "created_at": "2018-08-17T15:06:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389024",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:37" align="right">Comment 37</div>

Replying to [@embray](#comment%3A34):
> Also, we could group benchmarks by package like this: http://www.astropy.org/astropy-benchmarks/#/

That one is a bit tricky to do dynamically. ASV detects packages by looking at the filesystem so you would actually need `.py` files there. And I would like to have something that works not only on the benchmark machines but also if you invoke asv yourself.

> I bet with a bit of hacking we could even get the mouseover that shows the test to actually display the relevant doctest instead.  If nothing else, this could be done by generating functions that have the relevant doctest in its docstring :)

Sure, you would just have to set the docstring of the generated methods.



---

archive/issue_comments_389025.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">Comment 38</div>\n\nReplying to [@saraedum](#comment%3A37):\n> Replying to [@embray](#comment%3A34):\n> > Also, we could group benchmarks by package like this: http://www.astropy.org/astropy-benchmarks/#/\n\n> That one is a bit tricky to do dynamically. ASV detects packages by looking at the filesystem so you would actually need `.py` files there. And I would like to have something that works not only on the benchmark machines but also if you invoke asv yourself.\n\nI think all of that can, and should be customizable.  I also don't believe we should jump through hoops just to generate benchmark instances.  \n\nASV does have the underlying infrastructure for a plugin interface, though unfortunately not much of it is actually implemented yet so as to be useful (much less documented).  But I think if there's anything we need to customize in ASV we should do that.  There are some things we can do through the API, and we can already do some things through the plugin system via monkey-patching but that's obviously not ideal.  Anything else we might need, I think I can get upstream easily enough.\n\nTL;DR this hack is great for demonstration purposes.  But let's think about we need/want to generate benchmarks directly from Sage's doctest collector and go from there, rather than assume we need to be constrained by ASV's existing design.",
    "created_at": "2018-08-17T15:21:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389025",
    "user": "https://github.com/embray"
}
```

<div id="comment:38" align="right">Comment 38</div>

Replying to [@saraedum](#comment%3A37):
> Replying to [@embray](#comment%3A34):
> > Also, we could group benchmarks by package like this: http://www.astropy.org/astropy-benchmarks/#/

> That one is a bit tricky to do dynamically. ASV detects packages by looking at the filesystem so you would actually need `.py` files there. And I would like to have something that works not only on the benchmark machines but also if you invoke asv yourself.

I think all of that can, and should be customizable.  I also don't believe we should jump through hoops just to generate benchmark instances.  

ASV does have the underlying infrastructure for a plugin interface, though unfortunately not much of it is actually implemented yet so as to be useful (much less documented).  But I think if there's anything we need to customize in ASV we should do that.  There are some things we can do through the API, and we can already do some things through the plugin system via monkey-patching but that's obviously not ideal.  Anything else we might need, I think I can get upstream easily enough.

TL;DR this hack is great for demonstration purposes.  But let's think about we need/want to generate benchmarks directly from Sage's doctest collector and go from there, rather than assume we need to be constrained by ASV's existing design.



---

archive/issue_comments_389026.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">Comment 39</div>\n\nBy the way I just looked around a bit and it doesn't always render as nice on my laptop. See the partially hidden version numbers at https://www.dropbox.com/s/fio5b4ndj0jh2oz/view.jpeg?dl=0 . It happens both on Chrome and in Safari on OS X.",
    "created_at": "2018-08-17T15:26:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389026",
    "user": "https://github.com/koffie"
}
```

<div id="comment:39" align="right">Comment 39</div>

By the way I just looked around a bit and it doesn't always render as nice on my laptop. See the partially hidden version numbers at https://www.dropbox.com/s/fio5b4ndj0jh2oz/view.jpeg?dl=0 . It happens both on Chrome and in Safari on OS X.



---

archive/issue_comments_389027.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">Comment 40</div>\n\nOk, I just found out it can be solved by making my browser window wide enough so that the text `_init__.Benchmarks.track__abvar____add____a96f4ce23e82a785e765cee87e42e623` on the same line as `Benchmark grid\nBenchmark list Regressions`. So I guess it is not that important so sorry for the noise.",
    "created_at": "2018-08-17T15:28:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389027",
    "user": "https://github.com/koffie"
}
```

<div id="comment:40" align="right">Comment 40</div>

Ok, I just found out it can be solved by making my browser window wide enough so that the text `_init__.Benchmarks.track__abvar____add____a96f4ce23e82a785e765cee87e42e623` on the same line as `Benchmark grid
Benchmark list Regressions`. So I guess it is not that important so sorry for the noise.



---

archive/issue_comments_389028.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">Comment 41</div>\n\nI've been poking around a bit more in the ASV source, and am going to see what I can come up with.\n\n1. There is a base `Benchmark` class that I believe we can customize just a little bit for our purposes, and the rest of the code is flexible enough that we should be able to add our custom Benchmark class to the list of known benchmark types (`asv.benchmark.benchmark_types`).  Ideally a plugin would be able to do this without modifying any internal data structures.  (In fact, now I'm thinking we may not even need any Benchmark subclasses if our custom discovery code is clever enough...)\n\n2. The main thing, then, that we need to customize is benchmark discovery.  Currently there's no great way to do this and this is where another plugin interface is needed.  The current plugin discovery process ultimately yields `Benchmark` instances which contain all the information needed for a single benchmark test (it also wraps the benchmark function itself--in this case we can either generate a function from the doctest, or use a standard function for running a single doctest).  What we need then is a way to extend the benchmark discovery process to allow discovery from arbitrary sources (rather than just searching the file system for .py files and importing them).\n\n3. Relatedly, there is a function `asv.benchmark.get_benchmark_from_name` which resolves a unique benchmark name to the relevant test.  A plugin needs to be able to extend how benchmarks are searched for by name.",
    "created_at": "2018-08-17T16:05:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389028",
    "user": "https://github.com/embray"
}
```

<div id="comment:41" align="right">Comment 41</div>

I've been poking around a bit more in the ASV source, and am going to see what I can come up with.

1. There is a base `Benchmark` class that I believe we can customize just a little bit for our purposes, and the rest of the code is flexible enough that we should be able to add our custom Benchmark class to the list of known benchmark types (`asv.benchmark.benchmark_types`).  Ideally a plugin would be able to do this without modifying any internal data structures.  (In fact, now I'm thinking we may not even need any Benchmark subclasses if our custom discovery code is clever enough...)

2. The main thing, then, that we need to customize is benchmark discovery.  Currently there's no great way to do this and this is where another plugin interface is needed.  The current plugin discovery process ultimately yields `Benchmark` instances which contain all the information needed for a single benchmark test (it also wraps the benchmark function itself--in this case we can either generate a function from the doctest, or use a standard function for running a single doctest).  What we need then is a way to extend the benchmark discovery process to allow discovery from arbitrary sources (rather than just searching the file system for .py files and importing them).

3. Relatedly, there is a function `asv.benchmark.get_benchmark_from_name` which resolves a unique benchmark name to the relevant test.  A plugin needs to be able to extend how benchmarks are searched for by name.



---

archive/issue_comments_389029.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">Comment 42</div>\n\nReplying to [@embray](#comment%3A41):\n> I've been poking around a bit more in the ASV source, and am going to see what I can come up with.\n> \n> 1. There is a base `Benchmark` class that I believe we can customize just a little bit for our purposes, and the rest of the code is flexible enough that we should be able to add our custom Benchmark class to the list of known benchmark types (`asv.benchmark.benchmark_types`).  Ideally a plugin would be able to do this without modifying any internal data structures.  (In fact, now I'm thinking we may not even need any Benchmark subclasses if our custom discovery code is clever enough...)\n> \n> 2. The main thing, then, that we need to customize is benchmark discovery.  Currently there's no great way to do this and this is where another plugin interface is needed.  The current plugin discovery process ultimately yields `Benchmark` instances which contain all the information needed for a single benchmark test (it also wraps the benchmark function itself--in this case we can either generate a function from the doctest, or use a standard function for running a single doctest).  What we need then is a way to extend the benchmark discovery process to allow discovery from arbitrary sources (rather than just searching the file system for .py files and importing them).\n> \n> 3. Relatedly, there is a function `asv.benchmark.get_benchmark_from_name` which resolves a unique benchmark name to the relevant test.  A plugin needs to be able to extend how benchmarks are searched for by name.\n\nSure, if you want to change that in ASV that would be quite nice. I don't want to hack on ASV itself, so I'd rather try to get the current version into a slightly more reasonable state and start benchmarking automatically through one of the CIs. This doesn't need to be merged into Sage for that necessarily. Once the modified ASV is ready, we can change the benchmarks to be less of a hack.",
    "created_at": "2018-08-17T19:39:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389029",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:42" align="right">Comment 42</div>

Replying to [@embray](#comment%3A41):
> I've been poking around a bit more in the ASV source, and am going to see what I can come up with.
> 
> 1. There is a base `Benchmark` class that I believe we can customize just a little bit for our purposes, and the rest of the code is flexible enough that we should be able to add our custom Benchmark class to the list of known benchmark types (`asv.benchmark.benchmark_types`).  Ideally a plugin would be able to do this without modifying any internal data structures.  (In fact, now I'm thinking we may not even need any Benchmark subclasses if our custom discovery code is clever enough...)
> 
> 2. The main thing, then, that we need to customize is benchmark discovery.  Currently there's no great way to do this and this is where another plugin interface is needed.  The current plugin discovery process ultimately yields `Benchmark` instances which contain all the information needed for a single benchmark test (it also wraps the benchmark function itself--in this case we can either generate a function from the doctest, or use a standard function for running a single doctest).  What we need then is a way to extend the benchmark discovery process to allow discovery from arbitrary sources (rather than just searching the file system for .py files and importing them).
> 
> 3. Relatedly, there is a function `asv.benchmark.get_benchmark_from_name` which resolves a unique benchmark name to the relevant test.  A plugin needs to be able to extend how benchmarks are searched for by name.

Sure, if you want to change that in ASV that would be quite nice. I don't want to hack on ASV itself, so I'd rather try to get the current version into a slightly more reasonable state and start benchmarking automatically through one of the CIs. This doesn't need to be merged into Sage for that necessarily. Once the modified ASV is ready, we can change the benchmarks to be less of a hack.



---

archive/issue_comments_389030.json:
```json
{
    "body": "<div id=\"comment:43\" align=\"right\">Comment 43</div>\n\nReplying to [@saraedum](#comment%3A23):\n> So, what do you think? Should we try to run `time_*` methods\n\nI don't like this part because it doesn't mix well with doctests. I would really want to write a doctest like\n\n```\nsage: a = something\nsage: b = otherthing\nsage: c = computation(a, b)  # benchmark this\n```\nand being forced to wrap this in a `time_` method is just ugly.",
    "created_at": "2018-08-18T08:31:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389030",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:43" align="right">Comment 43</div>

Replying to [@saraedum](#comment%3A23):
> So, what do you think? Should we try to run `time_*` methods

I don't like this part because it doesn't mix well with doctests. I would really want to write a doctest like

```
sage: a = something
sage: b = otherthing
sage: c = computation(a, b)  # benchmark this
```
and being forced to wrap this in a `time_` method is just ugly.



---

archive/issue_comments_389031.json:
```json
{
    "body": "<div id=\"comment:44\" align=\"right\">Comment 44</div>\n\nembray: https://github.com/airspeed-velocity/asv/issues/481 might be related (though more limited in scope) which talks about customizing benchmark discovery.",
    "created_at": "2018-08-20T06:32:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389031",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:44" align="right">Comment 44</div>

embray: https://github.com/airspeed-velocity/asv/issues/481 might be related (though more limited in scope) which talks about customizing benchmark discovery.



---

archive/issue_comments_389032.json:
```json
{
    "body": "<div id=\"comment:45\" align=\"right\">Comment 45</div>\n\nReplying to [@jdemeyer](#comment%3A43):\n> Replying to [@saraedum](#comment%3A23):\n> > So, what do you think? Should we try to run `time_*` methods\n\n> \n> I don't like this part because it doesn't mix well with doctests. I would really want to write a doctest like\n> \n> ```\n> sage: a = something\n> sage: b = otherthing\n> sage: c = computation(a, b)  # benchmark this\n> ```\n> and being forced to wrap this in a `time_` method is just ugly.\n\nI see. I think it would be easy to track lines that say, e.g., `# benchmark time` separately. I am not sure if it's a good idea to add more magic comments to our doctesting. I've nothing against them in general, I am just worried that these features are relatively obscure so not many people are going to use them?\n\nLet me try to start with the benchmarking of blocks that say `# long time` and add more features later.",
    "created_at": "2018-08-20T06:37:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389032",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:45" align="right">Comment 45</div>

Replying to [@jdemeyer](#comment%3A43):
> Replying to [@saraedum](#comment%3A23):
> > So, what do you think? Should we try to run `time_*` methods

> 
> I don't like this part because it doesn't mix well with doctests. I would really want to write a doctest like
> 
> ```
> sage: a = something
> sage: b = otherthing
> sage: c = computation(a, b)  # benchmark this
> ```
> and being forced to wrap this in a `time_` method is just ugly.

I see. I think it would be easy to track lines that say, e.g., `# benchmark time` separately. I am not sure if it's a good idea to add more magic comments to our doctesting. I've nothing against them in general, I am just worried that these features are relatively obscure so not many people are going to use them?

Let me try to start with the benchmarking of blocks that say `# long time` and add more features later.



---

archive/issue_comments_389033.json:
```json
{
    "body": "<div id=\"comment:46\" align=\"right\">Comment 46</div>\n\nJust two cents without having though two much about it.\n\nI like the `# benchmark` approach too. It mixes well with how we write doctests and makes it trivial to create new benchmarks / annotate things as useful to benchmark.\n\nI'd rather have a different annotation than `# long time`; otherwise devs will have to take a decision between benchmarking and running the tests always, not just with `--long`.\n\nOf course, at this stage using `# long time` is a good way for experimenting. And it may be reasonable to keep benchmarking `# long time` lines later on.\n\nThanks!",
    "created_at": "2018-08-20T07:55:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389033",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:46" align="right">Comment 46</div>

Just two cents without having though two much about it.

I like the `# benchmark` approach too. It mixes well with how we write doctests and makes it trivial to create new benchmarks / annotate things as useful to benchmark.

I'd rather have a different annotation than `# long time`; otherwise devs will have to take a decision between benchmarking and running the tests always, not just with `--long`.

Of course, at this stage using `# long time` is a good way for experimenting. And it may be reasonable to keep benchmarking `# long time` lines later on.

Thanks!



---

archive/issue_comments_389034.json:
```json
{
    "body": "<div id=\"comment:47\" align=\"right\">Comment 47</div>\n\nReplying to [@jdemeyer](#comment%3A43):\n> Replying to [@saraedum](#comment%3A23):\n> > So, what do you think? Should we try to run `time_*` methods\n\n> \n> I don't like this part because it doesn't mix well with doctests. I would really want to write a doctest like\n> \n> ```\n> sage: a = something\n> sage: b = otherthing\n> sage: c = computation(a, b)  # benchmark this\n> ```\n> and being forced to wrap this in a `time_` method is just ugly.\n\nYes, something like that could be done.  Again, it all comes down to providing a different benchmark discovery plugin for ASV.  For discovering benchmarks in our doctest, all lines leading up to a `# benchmark` line could be considered setup code, with the `# benchmark` line being the one actually benchmarked (obviously).\n\nMultiple `# benchmark` tests in the same file would work fine too, with every line prior to it (including other previously benchmarked lines) considered the setup for it.\n\nIt might be trickier to do this in such a way that avoids duplication but I'll think about that.  I think it could still be done.",
    "created_at": "2018-08-20T10:00:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389034",
    "user": "https://github.com/embray"
}
```

<div id="comment:47" align="right">Comment 47</div>

Replying to [@jdemeyer](#comment%3A43):
> Replying to [@saraedum](#comment%3A23):
> > So, what do you think? Should we try to run `time_*` methods

> 
> I don't like this part because it doesn't mix well with doctests. I would really want to write a doctest like
> 
> ```
> sage: a = something
> sage: b = otherthing
> sage: c = computation(a, b)  # benchmark this
> ```
> and being forced to wrap this in a `time_` method is just ugly.

Yes, something like that could be done.  Again, it all comes down to providing a different benchmark discovery plugin for ASV.  For discovering benchmarks in our doctest, all lines leading up to a `# benchmark` line could be considered setup code, with the `# benchmark` line being the one actually benchmarked (obviously).

Multiple `# benchmark` tests in the same file would work fine too, with every line prior to it (including other previously benchmarked lines) considered the setup for it.

It might be trickier to do this in such a way that avoids duplication but I'll think about that.  I think it could still be done.



---

archive/issue_comments_389035.json:
```json
{
    "body": "<div id=\"comment:48\" align=\"right\">Comment 48</div>\n\nI think that this is wonderful.\n\nSince I tried to improve performance of certain things recently, and will likely continue to do so, I would like to add doctests for speed regression already now.  Should I use `long` or `benchmark` or something else?",
    "created_at": "2018-08-23T05:00:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389035",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:48" align="right">Comment 48</div>

I think that this is wonderful.

Since I tried to improve performance of certain things recently, and will likely continue to do so, I would like to add doctests for speed regression already now.  Should I use `long` or `benchmark` or something else?



---

archive/issue_comments_389036.json:
```json
{
    "body": "<div id=\"comment:49\" align=\"right\">Comment 49</div>\n\nThanks for the feedback.\n\nReplying to [@mantepse](#comment%3A48):\n> Since I tried to improve performance of certain things recently, and will likely continue to do so, I would like to add doctests for speed regression already now.  Should I use `long` or `benchmark` or something else?\n\nNothing has been decided upon yet. I could imagine something like `# benchmark time` or `# benchmark runtime` so that we can add `# benchmark memory` later. What do you think?",
    "created_at": "2018-08-23T17:02:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389036",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:49" align="right">Comment 49</div>

Thanks for the feedback.

Replying to [@mantepse](#comment%3A48):
> Since I tried to improve performance of certain things recently, and will likely continue to do so, I would like to add doctests for speed regression already now.  Should I use `long` or `benchmark` or something else?

Nothing has been decided upon yet. I could imagine something like `# benchmark time` or `# benchmark runtime` so that we can add `# benchmark memory` later. What do you think?



---

archive/issue_comments_389037.json:
```json
{
    "body": "<div id=\"comment:50\" align=\"right\">Comment 50</div>\n\nPresumably time benchmarking is more usual than memory benchmarking, so I would tend to\nhave \"benchmark\" be a short hand for \"benchmark time\", but that may be just me.\n\nFor memory usage, do you foresee using fine grained tools that instrument the code and actually slow down the execution? Otherwise, could \"benchmark\" just do both always?",
    "created_at": "2018-08-24T09:22:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389037",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:50" align="right">Comment 50</div>

Presumably time benchmarking is more usual than memory benchmarking, so I would tend to
have "benchmark" be a short hand for "benchmark time", but that may be just me.

For memory usage, do you foresee using fine grained tools that instrument the code and actually slow down the execution? Otherwise, could "benchmark" just do both always?



---

archive/issue_comments_389038.json:
```json
{
    "body": "<div id=\"comment:51\" align=\"right\">Comment 51</div>\n\nI would actually like `# benchmark - time`, `# benchmark - memory`, etc. (syntax similar to `# optional -`) because this would fit very nicely with the existing model for ASV, which implements different benchmark types as subclasses of `Benchmark`, which are selected from by doing a string match--currently on function and class names--but the same string match could also be performed on a parameter to `# benchmark`.  This would be the most extensible choice--the parameters allowed following `# benchmark` need not be hard-coded.\n\nOf course, I agree time benchmarks are going to be the most common, so we could still have `# benchmark` without a parameter default to \"time\".",
    "created_at": "2018-08-24T09:35:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389038",
    "user": "https://github.com/embray"
}
```

<div id="comment:51" align="right">Comment 51</div>

I would actually like `# benchmark - time`, `# benchmark - memory`, etc. (syntax similar to `# optional -`) because this would fit very nicely with the existing model for ASV, which implements different benchmark types as subclasses of `Benchmark`, which are selected from by doing a string match--currently on function and class names--but the same string match could also be performed on a parameter to `# benchmark`.  This would be the most extensible choice--the parameters allowed following `# benchmark` need not be hard-coded.

Of course, I agree time benchmarks are going to be the most common, so we could still have `# benchmark` without a parameter default to "time".



---

archive/issue_comments_389039.json:
```json
{
    "body": "<div id=\"comment:52\" align=\"right\">Comment 52</div>\n\nOnce we're past this deliverable due date I'll spend some more time poking at ASV to get the features we would need in it to make it easier to extend how benchmark collection is performed, and also to integrate it more directly into our existing test runner.",
    "created_at": "2018-08-24T09:36:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389039",
    "user": "https://github.com/embray"
}
```

<div id="comment:52" align="right">Comment 52</div>

Once we're past this deliverable due date I'll spend some more time poking at ASV to get the features we would need in it to make it easier to extend how benchmark collection is performed, and also to integrate it more directly into our existing test runner.



---

archive/issue_comments_389040.json:
```json
{
    "body": "<div id=\"comment:53\" align=\"right\">Comment 53</div>\n\nReplying to [@embray](#comment%3A51):\n> I would actually like `# benchmark - time`, `# benchmark - memory`, ...\n\nI very much like this (well informed!) proposal.",
    "created_at": "2018-08-24T10:06:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389040",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:53" align="right">Comment 53</div>

Replying to [@embray](#comment%3A51):
> I would actually like `# benchmark - time`, `# benchmark - memory`, ...

I very much like this (well informed!) proposal.



---

archive/issue_comments_389041.json:
```json
{
    "body": "<div id=\"comment:54\" align=\"right\">Comment 54</div>\n\nWhat is the status of this ticket? There is a branch attached. So, is it really new? Are people working on it?\n\nFor the record, I too think that having `# benchmark - time` and `# benchmark - memory` would be nice and very useful.",
    "created_at": "2019-01-13T12:18:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389041",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:54" align="right">Comment 54</div>

What is the status of this ticket? There is a branch attached. So, is it really new? Are people working on it?

For the record, I too think that having `# benchmark - time` and `# benchmark - memory` would be nice and very useful.



---

archive/issue_comments_389042.json:
```json
{
    "body": "<div id=\"comment:55\" align=\"right\">Comment 55</div>\n\nRight now we need to get the GitLab CI pipeline going again.  I need to about getting some more build runners up and running; it's been on my task list for ages.  That, or if we can get more time from GCE (if anyone knows anyone at Google or other cloud computing providers who can help getting CPU time donated to the project it would be very helpful).",
    "created_at": "2019-01-14T10:40:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389042",
    "user": "https://github.com/embray"
}
```

<div id="comment:55" align="right">Comment 55</div>

Right now we need to get the GitLab CI pipeline going again.  I need to about getting some more build runners up and running; it's been on my task list for ages.  That, or if we can get more time from GCE (if anyone knows anyone at Google or other cloud computing providers who can help getting CPU time donated to the project it would be very helpful).



---

archive/issue_comments_389043.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-I am currently playing with airspeed velocity to track speed regressions in Sage. I would like to benchmark every doctest that has a \"long time\" marker in it and also benchmark every method that has a `time_` prefix (probably only in some benchmark module.)\n+I am currently playing with airspeed velocity to track speed regressions in Sage. I would like to benchmark every doctest that has a `long time` or `benchmark` marker in it and also benchmark every method that has a `time_` prefix (probably only in some benchmark module.)\n \n We have something similar set up for https://github.com/MCLF/mclf/tree/master/mclf/benchmarks now. There are only two benchmarks but it works nicely.\n \n``````\n",
    "created_at": "2019-09-12T15:53:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389043",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-I am currently playing with airspeed velocity to track speed regressions in Sage. I would like to benchmark every doctest that has a "long time" marker in it and also benchmark every method that has a `time_` prefix (probably only in some benchmark module.)
+I am currently playing with airspeed velocity to track speed regressions in Sage. I would like to benchmark every doctest that has a `long time` or `benchmark` marker in it and also benchmark every method that has a `time_` prefix (probably only in some benchmark module.)
 
 We have something similar set up for https://github.com/MCLF/mclf/tree/master/mclf/benchmarks now. There are only two benchmarks but it works nicely.
 
``````




---

archive/issue_comments_389044.json:
```json
{
    "body": "Changed commit from **[d7ff532](https://github.com/sagemath/sagetrac-mirror/commit/d7ff532b3519c2904b9c61dfd07ad542c639017b)** to **[89d4afb](https://github.com/sagemath/sagetrac-mirror/commit/89d4afb230c85094c3629b3b82a0220eceb6207c)**",
    "created_at": "2019-09-12T15:57:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389044",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[d7ff532](https://github.com/sagemath/sagetrac-mirror/commit/d7ff532b3519c2904b9c61dfd07ad542c639017b)** to **[89d4afb](https://github.com/sagemath/sagetrac-mirror/commit/89d4afb230c85094c3629b3b82a0220eceb6207c)**



---

archive/issue_comments_389045.json:
```json
{
    "body": "<div id=\"comment:57\" align=\"right\">Comment 57</div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/89d4afb230c85094c3629b3b82a0220eceb6207c\">89d4afb</a></td><td><code>Merge remote-tracking branch 'trac/develop' into HEAD</code></td></tr></table>\n",
    "created_at": "2019-09-12T15:57:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389045",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:57" align="right">Comment 57</div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/89d4afb230c85094c3629b3b82a0220eceb6207c">89d4afb</a></td><td><code>Merge remote-tracking branch 'trac/develop' into HEAD</code></td></tr></table>




---

archive/issue_comments_389046.json:
```json
{
    "body": "<div id=\"comment:58\" align=\"right\">Comment 58</div>\n\nNow that the CI seems to be mostly stable (except for the docbuild timing out for `test-dev`) we should probably look into this again?\n\nI would like to get a minimal version of this working somehow. We should probably not attempt to get the perfect solution in the first run. The outputs this created are actually quite useful already imho. If our contributors actually end up looking at the results, we can add more features (more keywords, more iterations, memory benchmarking, comparisons to other CAS,\u2026)\n\nSo, my proposal would be to go with this version (modulo cleanup & documentation & CI integration.) If somebody wants to improve/reimplement this in a good way, I am very happy to review that later.\n\nI am not sure how much time I will have to work on this so if anybody wants to get more involved, please let me know :)",
    "created_at": "2019-09-12T16:07:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389046",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:58" align="right">Comment 58</div>

Now that the CI seems to be mostly stable (except for the docbuild timing out for `test-dev`) we should probably look into this again?

I would like to get a minimal version of this working somehow. We should probably not attempt to get the perfect solution in the first run. The outputs this created are actually quite useful already imho. If our contributors actually end up looking at the results, we can add more features (more keywords, more iterations, memory benchmarking, comparisons to other CAS,…)

So, my proposal would be to go with this version (modulo cleanup & documentation & CI integration.) If somebody wants to improve/reimplement this in a good way, I am very happy to review that later.

I am not sure how much time I will have to work on this so if anybody wants to get more involved, please let me know :)



---

archive/issue_comments_389047.json:
```json
{
    "body": "Work Issues: **documentation, doctests, CI**",
    "created_at": "2019-09-12T16:08:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389047",
    "user": "https://github.com/saraedum"
}
```

Work Issues: **documentation, doctests, CI**



---

archive/issue_comments_389048.json:
```json
{
    "body": "Changed keywords from none to **ContinuousIntegration**",
    "created_at": "2020-01-21T16:05:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389048",
    "user": "https://github.com/saraedum"
}
```

Changed keywords from none to **ContinuousIntegration**



---

archive/issue_comments_389049.json:
```json
{
    "body": "<div id=\"comment:61\" align=\"right\">Comment 61</div>\n\nrebased\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/68869aea9a6814ed6c2d1e701885d369939ba4c7\">68869ae</a></td><td><code>Merge branch 'u/saraedum/25262' in 9.5.b1</code></td></tr></table>\n",
    "created_at": "2021-09-17T12:51:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389049",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:61" align="right">Comment 61</div>

rebased

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/68869aea9a6814ed6c2d1e701885d369939ba4c7">68869ae</a></td><td><code>Merge branch 'u/saraedum/25262' in 9.5.b1</code></td></tr></table>




---

archive/issue_comments_389050.json:
```json
{
    "body": "Changed branch from **[u/saraedum/25262](https://github.com/sagemath/sagetrac-mirror/tree/u/saraedum/25262)** to **[public/airspeed_velo](https://github.com/sagemath/sagetrac-mirror/tree/public/airspeed_velo)**",
    "created_at": "2021-09-17T12:51:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389050",
    "user": "https://github.com/fchapoton"
}
```

Changed branch from **[u/saraedum/25262](https://github.com/sagemath/sagetrac-mirror/tree/u/saraedum/25262)** to **[public/airspeed_velo](https://github.com/sagemath/sagetrac-mirror/tree/public/airspeed_velo)**



---

archive/issue_comments_389051.json:
```json
{
    "body": "Changed commit from **[89d4afb](https://github.com/sagemath/sagetrac-mirror/commit/89d4afb230c85094c3629b3b82a0220eceb6207c)** to **[68869ae](https://github.com/sagemath/sagetrac-mirror/commit/68869aea9a6814ed6c2d1e701885d369939ba4c7)**",
    "created_at": "2021-09-17T12:51:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389051",
    "user": "https://github.com/fchapoton"
}
```

Changed commit from **[89d4afb](https://github.com/sagemath/sagetrac-mirror/commit/89d4afb230c85094c3629b3b82a0220eceb6207c)** to **[68869ae](https://github.com/sagemath/sagetrac-mirror/commit/68869aea9a6814ed6c2d1e701885d369939ba4c7)**



---

archive/issue_comments_389052.json:
```json
{
    "body": "<div id=\"comment:62\" align=\"right\">Comment 62</div>\n\nthis needs adaptation to python3, apparently",
    "created_at": "2021-09-17T14:43:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389052",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:62" align="right">Comment 62</div>

this needs adaptation to python3, apparently



---

archive/issue_comments_389053.json:
```json
{
    "body": "<div id=\"comment:63\" align=\"right\">Comment 63</div>\n\nI am thinking about reviving this issue with a different application in mind that is a bit easier than regression testing. Namely, to have a better understanding how different values for the `algorithm` keyword affect runtime.\n\nI find that we rarely update the default algorithms. However, this could be quite beneficial say when we upgrade a dependency such as PARI or FLINT. It would be very nice to easily see how the different algorithms perform after an update and also a way to document the instances that have been used to determine the cutoffs that we are using.\n\nCurrently, we are using some homegrown solutions for this, e.g., `matrix/benchmark.py` or `misc/benchmark.py`.",
    "created_at": "2022-02-02T02:12:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389053",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:63" align="right">Comment 63</div>

I am thinking about reviving this issue with a different application in mind that is a bit easier than regression testing. Namely, to have a better understanding how different values for the `algorithm` keyword affect runtime.

I find that we rarely update the default algorithms. However, this could be quite beneficial say when we upgrade a dependency such as PARI or FLINT. It would be very nice to easily see how the different algorithms perform after an update and also a way to document the instances that have been used to determine the cutoffs that we are using.

Currently, we are using some homegrown solutions for this, e.g., `matrix/benchmark.py` or `misc/benchmark.py`.



---

archive/issue_comments_389054.json:
```json
{
    "body": "<div id=\"comment:64\" align=\"right\">Comment 64</div>\n\nWhat is actually the problem with the original goal?",
    "created_at": "2022-02-02T09:22:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389054",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:64" align="right">Comment 64</div>

What is actually the problem with the original goal?



---

archive/issue_comments_389055.json:
```json
{
    "body": "<div id=\"comment:65\" align=\"right\">Comment 65</div>\n\nReplying to [@mantepse](#comment%3A64):\n> What is actually the problem with the original goal?\n\nThere's no fundamental problem. But doing the CI setup is quite a bit of work.",
    "created_at": "2022-02-02T17:47:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25262#issuecomment-389055",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:65" align="right">Comment 65</div>

Replying to [@mantepse](#comment%3A64):
> What is actually the problem with the original goal?

There's no fundamental problem. But doing the CI setup is quite a bit of work.



---

archive/issue_events_331572.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-12-29T01:42:26Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/25262",
    "milestone_number": null,
    "milestone_title": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25262#event-331572"
}
```
