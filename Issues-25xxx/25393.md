# Issue 25393: Removed unused and potentially misleading Morphism.__hash__

archive/issues_025156.json:
```json
{
    "body": "As far as I can tell there is no code using the ability to hash `Morphisms`, and having this in the base class is misleading since there are subclasses which are not immutable and should not be hashable anyways.  It would be better to implement `__hash__` on an as-needed basis for those classes that can guarantee immutability.\n\n### Original description\n`ContinuousMap` is impacted by #24551 in that it defines an `__eq__`, so its default hash is not inherited from its base class, `Morphism` (which does define `__hash__`).\n\nThis is one of the classes impacted by the issue raised [in this comment](https://trac.sagemath.org/ticket/25387#comment:3).\n\nI'm not sure what the best solution is.  Right now I feel like it's somewhat ill-defined, because it's possible to have two `ContinuousMaps` that compare as equal, but have different hashes.  That's not necessarily wrong, but it isn't obviously right either.  If `x == y`, then `hash(x) == hash(y)` for a correct implementation.  Technically I believe you can get away with the inverse--having `hash(x) == hash(y)` but `x != y`--but it is advisable for performance to avoid this.\n\nAssignee: @egourgoulhon\n\nCC:  @fchapoton @egourgoulhon\n\nKeywords: python3\n\nAuthor: Erik Bray\n\nBranch: u/embray/misc/ticket-25393\n\nStatus: needs_info\n\nCommit: 1a990578b1b8f0826fa0408aaac424b205f5dffb\n\nIssue created by migration from https://trac.sagemath.org/ticket/25393\n\n",
    "created_at": "2018-05-18T09:29:05Z",
    "labels": [
        "component: geometry",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Removed unused and potentially misleading Morphism.__hash__",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25393",
    "user": "https://github.com/embray"
}
```
As far as I can tell there is no code using the ability to hash `Morphisms`, and having this in the base class is misleading since there are subclasses which are not immutable and should not be hashable anyways.  It would be better to implement `__hash__` on an as-needed basis for those classes that can guarantee immutability.

### Original description
`ContinuousMap` is impacted by #24551 in that it defines an `__eq__`, so its default hash is not inherited from its base class, `Morphism` (which does define `__hash__`).

This is one of the classes impacted by the issue raised [in this comment](https://trac.sagemath.org/ticket/25387#comment:3).

I'm not sure what the best solution is.  Right now I feel like it's somewhat ill-defined, because it's possible to have two `ContinuousMaps` that compare as equal, but have different hashes.  That's not necessarily wrong, but it isn't obviously right either.  If `x == y`, then `hash(x) == hash(y)` for a correct implementation.  Technically I believe you can get away with the inverse--having `hash(x) == hash(y)` but `x != y`--but it is advisable for performance to avoid this.

Assignee: @egourgoulhon

CC:  @fchapoton @egourgoulhon

Keywords: python3

Author: Erik Bray

Branch: u/embray/misc/ticket-25393

Status: needs_info

Commit: 1a990578b1b8f0826fa0408aaac424b205f5dffb

Issue created by migration from https://trac.sagemath.org/ticket/25393





---

archive/issue_comments_377113.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -2,7 +2,7 @@\n \n This is one of the classes impacted by the issue raised [in this comment](https://trac.sagemath.org/ticket/25387#comment:3).\n \n-I'm not sure what the best solution is.  Right now I feel like it's somewhat ill-defined, because it's possible to have two \\`ContinuousMaps\\` that compare as equal, but have different hashes.  That's not necessarily wrong, but it isn't obviously right either.\n+I'm not sure what the best solution is.  Right now I feel like it's somewhat ill-defined, because it's possible to have two \\`ContinuousMaps\\` that compare as equal, but have different hashes.  That's not necessarily wrong, but it isn't obviously right either.  If two instances of the same class have the same hash, they must also be equal to each other with \\`==\\`.  Technically I believe you can get away with the inverse--having different hashes but equivalent via \\`==\\`--but it's not advisable and is a bad smell.\n \n Comment: 1\n \n```\n",
    "created_at": "2018-05-18T09:38:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377113",
    "user": "https://github.com/embray"
}
```

Description changed:
```diff
--- 
+++ 
@@ -2,7 +2,7 @@
 
 This is one of the classes impacted by the issue raised [in this comment](https://trac.sagemath.org/ticket/25387#comment:3).
 
-I'm not sure what the best solution is.  Right now I feel like it's somewhat ill-defined, because it's possible to have two \`ContinuousMaps\` that compare as equal, but have different hashes.  That's not necessarily wrong, but it isn't obviously right either.
+I'm not sure what the best solution is.  Right now I feel like it's somewhat ill-defined, because it's possible to have two \`ContinuousMaps\` that compare as equal, but have different hashes.  That's not necessarily wrong, but it isn't obviously right either.  If two instances of the same class have the same hash, they must also be equal to each other with \`==\`.  Technically I believe you can get away with the inverse--having different hashes but equivalent via \`==\`--but it's not advisable and is a bad smell.
 
 Comment: 1
 
```




---

archive/issue_comments_377114.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2018-05-18T09:48:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377114",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_377115.json:
```json
{
    "body": "<a id='comment:3'></a>> If two instances of the same class have the same hash, they must also be equal to each other with `==`\n\n\nThat is true iff a perfect hash function exists, which it generally does not. In fact, that is *not* mandated by Python. For example, a valid hash function is 0 for all objects, but you loose performance benefits from `dict` because it becomes a list search.\n\nThe converse is really what you want: `==` implies same hash. (Also to be hashable, the hash should be immutable.) You can get away with it, but it causes problems when you try to put it into a set/dictionary as you get multiple instances of equal objects.\n\nThe issue with this class is that we have essentially a mutable element class. So I think the proper thing to do is just disable hashing. We do something similar for vectors and matrices.",
    "created_at": "2018-05-18T16:05:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377115",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:3'></a>> If two instances of the same class have the same hash, they must also be equal to each other with `==`


That is true iff a perfect hash function exists, which it generally does not. In fact, that is *not* mandated by Python. For example, a valid hash function is 0 for all objects, but you loose performance benefits from `dict` because it becomes a list search.

The converse is really what you want: `==` implies same hash. (Also to be hashable, the hash should be immutable.) You can get away with it, but it causes problems when you try to put it into a set/dictionary as you get multiple instances of equal objects.

The issue with this class is that we have essentially a mutable element class. So I think the proper thing to do is just disable hashing. We do something similar for vectors and matrices.



---

archive/issue_comments_377116.json:
```json
{
    "body": "<a id='comment:4'></a>I think you must have misread me or something.  I didn't mean that if two instances have the same hash it implies they are `==`.  I mean that in order for hashing to be implemented correctly, then as you said if they are `==` they must have the same hash. \n\nIt actually wasn't immediately obvious to me that this class is not immutable.  Where can it be mutated?  All I noticed is that you define two `ContinuousMaps` that are the same except that one is constructed with `is_isomorphism=True` and the other with `is_isomorphism=False`.  In this case they are `==` but have different hashes.",
    "created_at": "2018-05-18T16:33:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377116",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>I think you must have misread me or something.  I didn't mean that if two instances have the same hash it implies they are `==`.  I mean that in order for hashing to be implemented correctly, then as you said if they are `==` they must have the same hash. 

It actually wasn't immediately obvious to me that this class is not immutable.  Where can it be mutated?  All I noticed is that you define two `ContinuousMaps` that are the same except that one is constructed with `is_isomorphism=True` and the other with `is_isomorphism=False`.  In this case they are `==` but have different hashes.



---

archive/issue_comments_377117.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:4 embray]:\n> I think you must have misread me or something.  I didn't mean that if two instances have the same hash it implies they are `==`.  I mean that in order for hashing to be implemented correctly, then as you said if they are `==` they must have the same hash. \n\n\nParaphrasing what you wrote: if `x.__class__ == y.__class__` and `hash(x) == hash(y)`, then `x == y`. It is a bad smell for `x == y` with `hash(x) == hash(y)`. We're on the same page with what needs to be done, but I just saying the ticket description needed an update, which I have just done.\n\nIMO, it is not a code smell to have `hash(x) == hash(y)` but `x != y`. However, I do agree that it is better to have a more perfect hash function, but there are only so many hash values since hashes are limited to 64 bit integers (unless I am misunderstanding something in Python).\n\n> It actually wasn't immediately obvious to me that this class is not immutable.  Where can it be mutated?  All I noticed is that you define two `ContinuousMaps` that are the same except that one is constructed with `is_isomorphism=True` and the other with `is_isomorphism=False`.  In this case they are `==` but have different hashes.\n\n\nSee `add_expr` and `set_expr`.",
    "created_at": "2018-05-18T16:48:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377117",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:5'></a>Replying to [comment:4 embray]:
> I think you must have misread me or something.  I didn't mean that if two instances have the same hash it implies they are `==`.  I mean that in order for hashing to be implemented correctly, then as you said if they are `==` they must have the same hash. 


Paraphrasing what you wrote: if `x.__class__ == y.__class__` and `hash(x) == hash(y)`, then `x == y`. It is a bad smell for `x == y` with `hash(x) == hash(y)`. We're on the same page with what needs to be done, but I just saying the ticket description needed an update, which I have just done.

IMO, it is not a code smell to have `hash(x) == hash(y)` but `x != y`. However, I do agree that it is better to have a more perfect hash function, but there are only so many hash values since hashes are limited to 64 bit integers (unless I am misunderstanding something in Python).

> It actually wasn't immediately obvious to me that this class is not immutable.  Where can it be mutated?  All I noticed is that you define two `ContinuousMaps` that are the same except that one is constructed with `is_isomorphism=True` and the other with `is_isomorphism=False`.  In this case they are `==` but have different hashes.


See `add_expr` and `set_expr`.



---

archive/issue_comments_377118.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,8 @@\n+\\`ContinuousMap\\` is impacted by #24551 in that it defines an \\`__eq__\\`, so its default hash is not inherited from its base class, \\`Morphism\\` (which does define \\`__hash__\\`).\n \n+This is one of the classes impacted by the issue raised [in this comment](https://trac.sagemath.org/ticket/25387#comment:3).\n+\n+I'm not sure what the best solution is.  Right now I feel like it's somewhat ill-defined, because it's possible to have two \\`ContinuousMaps\\` that compare as equal, but have different hashes.  That's not necessarily wrong, but it isn't obviously right either.  If \\`x == y\\`, then \\`hash(x) == hash(y)\\` for a correct implementation.  Technically I believe you can get away with the inverse--having \\`hash(x) == hash(y)\\` but \\`x != y\\`--but it is advisable for performance to avoid this.\n \n Comment: 1\n \n```\n",
    "created_at": "2018-05-18T16:48:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377118",
    "user": "https://github.com/tscrim"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,8 @@
+\`ContinuousMap\` is impacted by #24551 in that it defines an \`__eq__\`, so its default hash is not inherited from its base class, \`Morphism\` (which does define \`__hash__\`).
 
+This is one of the classes impacted by the issue raised [in this comment](https://trac.sagemath.org/ticket/25387#comment:3).
+
+I'm not sure what the best solution is.  Right now I feel like it's somewhat ill-defined, because it's possible to have two \`ContinuousMaps\` that compare as equal, but have different hashes.  That's not necessarily wrong, but it isn't obviously right either.  If \`x == y\`, then \`hash(x) == hash(y)\` for a correct implementation.  Technically I believe you can get away with the inverse--having \`hash(x) == hash(y)\` but \`x != y\`--but it is advisable for performance to avoid this.
 
 Comment: 1
 
```




---

archive/issue_comments_377119.json:
```json
{
    "body": "<a id='comment:6'></a>Well in that case this is already fixed for free on Python 3 since it sets `__hash__ = None` automatically for any class that defines `__eq__` but not `__hash__`, and this should just be done explicitly for this class.  \n\nIn general should `Morphism` even have a default hash?  It doesn't seem that immediately useful to me.",
    "created_at": "2018-05-21T11:24:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377119",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>Well in that case this is already fixed for free on Python 3 since it sets `__hash__ = None` automatically for any class that defines `__eq__` but not `__hash__`, and this should just be done explicitly for this class.  

In general should `Morphism` even have a default hash?  It doesn't seem that immediately useful to me.



---

archive/issue_comments_377120.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:6 embray]:\n> Well in that case this is already fixed for free on Python 3 since it sets `__hash__ = None` automatically for any class that defines `__eq__` but not `__hash__`, and this should just be done explicitly for this class.  \n\n\nI agree. That is probably the correct thing to for this class.\n\n> In general should `Morphism` even have a default hash?  It doesn't seem that immediately useful to me.\n\n\nI cannot think of a general mechanism that would require morphisms to be keys to a cache. Ideally matrices should be a subclass of `Morphism`, which would break the implicit `Morphism` is meant to be immutable. Although the fact that a `Morphism` can be stored via a coercion might lead to subtle bugs when it is mutable.",
    "created_at": "2018-05-21T13:30:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377120",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:7'></a>Replying to [comment:6 embray]:
> Well in that case this is already fixed for free on Python 3 since it sets `__hash__ = None` automatically for any class that defines `__eq__` but not `__hash__`, and this should just be done explicitly for this class.  


I agree. That is probably the correct thing to for this class.

> In general should `Morphism` even have a default hash?  It doesn't seem that immediately useful to me.


I cannot think of a general mechanism that would require morphisms to be keys to a cache. Ideally matrices should be a subclass of `Morphism`, which would break the implicit `Morphism` is meant to be immutable. Although the fact that a `Morphism` can be stored via a coercion might lead to subtle bugs when it is mutable.



---

archive/issue_comments_377121.json:
```json
{
    "body": "<a id='comment:8'></a>Okay then, I think I'll just try removing `Morphism.__hash__`.  Neither the commit that added it, nor the associated ticket (#13214) provide any explanation for *why* it was added.  It just was.\n\nI don't think we should be adding `__hash__` implementations anywhere that it isn't explicitly needed (or at least a specific use case is being imagined).  Especially not for base classes that could have mutable subclasses (one could make exceptions of course but in that case it would also be good to have an explicit mechanism for marking whether or not instances of some class are expected to be immutable).",
    "created_at": "2018-05-21T13:51:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377121",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>Okay then, I think I'll just try removing `Morphism.__hash__`.  Neither the commit that added it, nor the associated ticket (#13214) provide any explanation for *why* it was added.  It just was.

I don't think we should be adding `__hash__` implementations anywhere that it isn't explicitly needed (or at least a specific use case is being imagined).  Especially not for base classes that could have mutable subclasses (one could make exceptions of course but in that case it would also be good to have an explicit mechanism for marking whether or not instances of some class are expected to be immutable).



---

archive/issue_comments_377122.json:
```json
{
    "body": "<a id='comment:9'></a>~~Oh fun.  Deleting `Morphism.__hash__` causes segfaults :)~~ No, I was just misreading the test output.  It wasn't segfaults, just timeouts (the stack traces threw me off).  Still I wonder if that was a regression...",
    "created_at": "2018-05-21T15:44:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377122",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>~~Oh fun.  Deleting `Morphism.__hash__` causes segfaults :)~~ No, I was just misreading the test output.  It wasn't segfaults, just timeouts (the stack traces threw me off).  Still I wonder if that was a regression...



---

archive/issue_comments_377123.json:
```json
{
    "body": "<a id='comment:10'></a>New commits:",
    "created_at": "2018-05-21T16:51:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377123",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'></a>New commits:



---

archive/issue_comments_377124.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,11 @@\n+As far as I can tell there is no code using the ability to hash \\`Morphisms\\`, and having this in the base class is misleading since there are subclasses which are not immutable and should not be hashable anyways.  It would be better to implement \\`__hash__\\` on an as-needed basis for those classes that can guarantee immutability.\n \n+### Original description\n+\\`ContinuousMap\\` is impacted by #24551 in that it defines an \\`__eq__\\`, so its default hash is not inherited from its base class, \\`Morphism\\` (which does define \\`__hash__\\`).\n+\n+This is one of the classes impacted by the issue raised [in this comment](https://trac.sagemath.org/ticket/25387#comment:3).\n+\n+I'm not sure what the best solution is.  Right now I feel like it's somewhat ill-defined, because it's possible to have two \\`ContinuousMaps\\` that compare as equal, but have different hashes.  That's not necessarily wrong, but it isn't obviously right either.  If \\`x == y\\`, then \\`hash(x) == hash(y)\\` for a correct implementation.  Technically I believe you can get away with the inverse--having \\`hash(x) == hash(y)\\` but \\`x != y\\`--but it is advisable for performance to avoid this.\n \n Comment: 1\n \n```\n",
    "created_at": "2018-05-21T16:51:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377124",
    "user": "https://github.com/embray"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,11 @@
+As far as I can tell there is no code using the ability to hash \`Morphisms\`, and having this in the base class is misleading since there are subclasses which are not immutable and should not be hashable anyways.  It would be better to implement \`__hash__\` on an as-needed basis for those classes that can guarantee immutability.
 
+### Original description
+\`ContinuousMap\` is impacted by #24551 in that it defines an \`__eq__\`, so its default hash is not inherited from its base class, \`Morphism\` (which does define \`__hash__\`).
+
+This is one of the classes impacted by the issue raised [in this comment](https://trac.sagemath.org/ticket/25387#comment:3).
+
+I'm not sure what the best solution is.  Right now I feel like it's somewhat ill-defined, because it's possible to have two \`ContinuousMaps\` that compare as equal, but have different hashes.  That's not necessarily wrong, but it isn't obviously right either.  If \`x == y\`, then \`hash(x) == hash(y)\` for a correct implementation.  Technically I believe you can get away with the inverse--having \`hash(x) == hash(y)\` but \`x != y\`--but it is advisable for performance to avoid this.
 
 Comment: 1
 
```




---

archive/issue_comments_377125.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2018-05-21T16:51:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377125",
    "user": "https://github.com/embray"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_377126.json:
```json
{
    "body": "<a id='comment:11'></a>Looks like this has some test failures.  It's possible that in some of these cases the real problem is they shouldn't use `UniqueRepresentation` in the first place, but I'm not sure.",
    "created_at": "2018-05-21T16:59:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377126",
    "user": "https://github.com/embray"
}
```

<a id='comment:11'></a>Looks like this has some test failures.  It's possible that in some of these cases the real problem is they shouldn't use `UniqueRepresentation` in the first place, but I'm not sure.



---

archive/issue_comments_377127.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-05-21T16:59:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377127",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_377128.json:
```json
{
    "body": "<a id='comment:12'></a>bot says \"no failing doctest\"..",
    "created_at": "2018-05-22T14:30:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377128",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:12'></a>bot says "no failing doctest"..



---

archive/issue_comments_377129.json:
```json
{
    "body": "<a id='comment:13'></a>I'll have to try again. I got some failures when I ran it, but it might have been a matter of running the tests out of their \"normal\" order, and hence weird things happening with the coercion framework or something...",
    "created_at": "2018-05-22T14:38:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377129",
    "user": "https://github.com/embray"
}
```

<a id='comment:13'></a>I'll have to try again. I got some failures when I ran it, but it might have been a matter of running the tests out of their "normal" order, and hence weird things happening with the coercion framework or something...



---

archive/issue_comments_377130.json:
```json
{
    "body": "<a id='comment:14'></a>Sorry for showing up late in the discussion, but for some reason, I did not received the Trac notification that I've been put in the Cc list of this ticket; I actually discovered the existence of the ticket only today, while reading the \"python3 status\" post on sage-devel...\n\nLet me summarize a few things about `ContinuousMap`:\n\n- `ContinousMap` objects are \"in spirit\" immutable: they represent continuous maps between topological manifolds and once such a map is defined, there is no meaning in modifying it. However, in practice, such maps cannot be fully defined at their creation by the user, because some new charts may be introduced on the fly on the manifold and a given map should be able to have coordinate expressions in terms of these charts, hence the methods `add_expr` and `set_expr`. \n\n- `ContinousMap` (more precisely the derived class `DiffMap`) needs to be hashable because `DiffMap` objects serve as keys in the dictionary of vector field modules on a manifold (see [here](http://doc.sagemath.org/html/en/reference/manifolds/sage/manifolds/differentiable/vectorfield_module.html) for details).\n\n- I understand that the `__hash__` method inherited from `Morphism` relies on the `repr` of the continuous map and in some cases (maps `f` and `g` having the same domain, codomain, but different names given by the user), one may have `f == g` with `hash(f) != hash(g)`, which is very bad!\n\nI propose to implement a `__hash__` method in `ContinuousMap` that ensures that maps that compare equal have the same hash. It would make sense that I do this atop commit 1a9907 (i.e. the commit in the branch currently attached to this ticket), since the latter is suppressing `Morphism.__hash__`. Do you agree?",
    "created_at": "2018-05-30T16:14:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377130",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:14'></a>Sorry for showing up late in the discussion, but for some reason, I did not received the Trac notification that I've been put in the Cc list of this ticket; I actually discovered the existence of the ticket only today, while reading the "python3 status" post on sage-devel...

Let me summarize a few things about `ContinuousMap`:

- `ContinousMap` objects are "in spirit" immutable: they represent continuous maps between topological manifolds and once such a map is defined, there is no meaning in modifying it. However, in practice, such maps cannot be fully defined at their creation by the user, because some new charts may be introduced on the fly on the manifold and a given map should be able to have coordinate expressions in terms of these charts, hence the methods `add_expr` and `set_expr`. 

- `ContinousMap` (more precisely the derived class `DiffMap`) needs to be hashable because `DiffMap` objects serve as keys in the dictionary of vector field modules on a manifold (see [here](http://doc.sagemath.org/html/en/reference/manifolds/sage/manifolds/differentiable/vectorfield_module.html) for details).

- I understand that the `__hash__` method inherited from `Morphism` relies on the `repr` of the continuous map and in some cases (maps `f` and `g` having the same domain, codomain, but different names given by the user), one may have `f == g` with `hash(f) != hash(g)`, which is very bad!

I propose to implement a `__hash__` method in `ContinuousMap` that ensures that maps that compare equal have the same hash. It would make sense that I do this atop commit 1a9907 (i.e. the commit in the branch currently attached to this ticket), since the latter is suppressing `Morphism.__hash__`. Do you agree?



---

archive/issue_comments_377131.json:
```json
{
    "body": "Set assignee to @egourgoulhon.",
    "created_at": "2018-05-31T10:22:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377131",
    "user": "https://github.com/embray"
}
```

Set assignee to @egourgoulhon.



---

archive/issue_comments_377132.json:
```json
{
    "body": "<a id='comment:15'></a>Thanks Eric for the explanation.  I'm a bit iffy on the first point--it's a bit unfortunate, but also an implementation detail--I don't feel qualified to fuss about it right now.\n\nBased on your explanation though, maybe I should back off a bit on my argument that `Morphism.__hash__` should be removed (unless someone can point out other subclasses of it that are definitely *not* in any sense immutable).  Instead, I might just change the implementation a bit to do away with its use of `repr()`.  If the domain doesn't have generators we can just ignore that and use `None` or something.  IMO it's the `repr()` that's the real problem because that's just flakey and surprising.  So maybe I'll just change that for now and see what that affects.\n\nMeanwhile, yes, if you think you know the best way to implement a `ContinuousMap.__hash__` please do. Please also make sure there is a test demonstrating not only that the hash works, but *why* it should work, since my experiment in removing it didn't appear to break any test after all...",
    "created_at": "2018-05-31T10:22:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377132",
    "user": "https://github.com/embray"
}
```

<a id='comment:15'></a>Thanks Eric for the explanation.  I'm a bit iffy on the first point--it's a bit unfortunate, but also an implementation detail--I don't feel qualified to fuss about it right now.

Based on your explanation though, maybe I should back off a bit on my argument that `Morphism.__hash__` should be removed (unless someone can point out other subclasses of it that are definitely *not* in any sense immutable).  Instead, I might just change the implementation a bit to do away with its use of `repr()`.  If the domain doesn't have generators we can just ignore that and use `None` or something.  IMO it's the `repr()` that's the real problem because that's just flakey and surprising.  So maybe I'll just change that for now and see what that affects.

Meanwhile, yes, if you think you know the best way to implement a `ContinuousMap.__hash__` please do. Please also make sure there is a test demonstrating not only that the hash works, but *why* it should work, since my experiment in removing it didn't appear to break any test after all...



---

archive/issue_comments_377133.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:15 embray]:\n> Thanks Eric for the explanation.  I'm a bit iffy on the first point--it's a bit unfortunate, but also an implementation detail--I don't feel qualified to fuss about it right now.\n> \n\n\nActually the type of immutatibility involved for `ContinuousMap` is that defined by Simon King in this [sage-devel post](https://groups.google.com/d/msg/sage-devel/d8-r3uEewFU/Jb02875ACgAJ): methods, like `add_expr`, may change (enhance) the internal representation of the object, but in any case they must preserve the equivalence class with respect to `==` to which the object belongs at its creation. \n\n> Based on your explanation though, maybe I should back off a bit on my argument that `Morphism.__hash__` should be removed (unless someone can point out other subclasses of it that are definitely *not* in any sense immutable).  Instead, I might just change the implementation a bit to do away with its use of `repr()`.  If the domain doesn't have generators we can just ignore that and use `None` or something.  IMO it's the `repr()` that's the real problem because that's just flakey and surprising.  So maybe I'll just change that for now and see what that affects.\n\n\n\nIndeed, for `ContinousMap`, which don't have any \"generator\", the issue is the default back to the hash of `repr()`. \n\n> \n> Meanwhile, yes, if you think you know the best way to implement a `ContinuousMap.__hash__` please do. \n\n\nOK I will do it. \n\n>Please also make sure there is a test demonstrating not only that the hash works, but *why* it should work, since my experiment in removing it didn't appear to break any test after all...\n\n\nI am quite surprised about this: how could `ContinuousMap` objects be used as dictionary keys without any `__hash__` method?",
    "created_at": "2018-05-31T11:54:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377133",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:16'></a>Replying to [comment:15 embray]:
> Thanks Eric for the explanation.  I'm a bit iffy on the first point--it's a bit unfortunate, but also an implementation detail--I don't feel qualified to fuss about it right now.
> 


Actually the type of immutatibility involved for `ContinuousMap` is that defined by Simon King in this [sage-devel post](https://groups.google.com/d/msg/sage-devel/d8-r3uEewFU/Jb02875ACgAJ): methods, like `add_expr`, may change (enhance) the internal representation of the object, but in any case they must preserve the equivalence class with respect to `==` to which the object belongs at its creation. 

> Based on your explanation though, maybe I should back off a bit on my argument that `Morphism.__hash__` should be removed (unless someone can point out other subclasses of it that are definitely *not* in any sense immutable).  Instead, I might just change the implementation a bit to do away with its use of `repr()`.  If the domain doesn't have generators we can just ignore that and use `None` or something.  IMO it's the `repr()` that's the real problem because that's just flakey and surprising.  So maybe I'll just change that for now and see what that affects.



Indeed, for `ContinousMap`, which don't have any "generator", the issue is the default back to the hash of `repr()`. 

> 
> Meanwhile, yes, if you think you know the best way to implement a `ContinuousMap.__hash__` please do. 


OK I will do it. 

>Please also make sure there is a test demonstrating not only that the hash works, but *why* it should work, since my experiment in removing it didn't appear to break any test after all...


I am quite surprised about this: how could `ContinuousMap` objects be used as dictionary keys without any `__hash__` method?



---

archive/issue_comments_377134.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [comment:16 egourgoulhon]:\n> Replying to [comment:15 embray]:\n> >Please also make sure there is a test demonstrating not only that the hash works, but *why* it should work, since my experiment in removing it didn't appear to break any test after all...\n\n> \n> I am quite surprised about this: how could `ContinuousMap` objects be used as dictionary keys without any `__hash__` method? \n\n\nI don't know. Are there definitely examples of this in the tests?  I *did* get some test failures when I tried this the first time, but the patchbot shows tests passing.  May it's just in some `--long` tests?",
    "created_at": "2018-05-31T12:05:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377134",
    "user": "https://github.com/embray"
}
```

<a id='comment:17'></a>Replying to [comment:16 egourgoulhon]:
> Replying to [comment:15 embray]:
> >Please also make sure there is a test demonstrating not only that the hash works, but *why* it should work, since my experiment in removing it didn't appear to break any test after all...

> 
> I am quite surprised about this: how could `ContinuousMap` objects be used as dictionary keys without any `__hash__` method? 


I don't know. Are there definitely examples of this in the tests?  I *did* get some test failures when I tried this the first time, but the patchbot shows tests passing.  May it's just in some `--long` tests?



---

archive/issue_comments_377135.json:
```json
{
    "body": "<a id='comment:18'></a>Replying to [comment:16 egourgoulhon]:\n> \n> >Please also make sure there is a test demonstrating not only that the hash works, but *why* it should work, since my experiment in removing it didn't appear to break any test after all...\n\n> \n> I am quite surprised about this: how could `ContinuousMap` objects be used as dictionary keys without any `__hash__` method? \n\n\nI did the experiment, i.e. remove `Morphism.__hash__`, and discovered that the hash of `ContinousMap` is then inherited from `Map.__hash__`, which does (cf. line 1292 o f `src/sage/categories/map.pyx`):\n\n```\nreturn hash((self.domain(), self._codomain))\n```\nThis simple hash seems very satisfactory to me, except maybe for `self._codomain` that may be replaced by `self.codomain()`. Actually this is what I had in mind when proposing to implement `ContinousMap.__hash__`. So if you remove `Morphism.__hash__`, there is no need to write a proper `ContinousMap.__hash__`: that of `Map` is sufficient.",
    "created_at": "2018-05-31T12:27:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377135",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:18'></a>Replying to [comment:16 egourgoulhon]:
> 
> >Please also make sure there is a test demonstrating not only that the hash works, but *why* it should work, since my experiment in removing it didn't appear to break any test after all...

> 
> I am quite surprised about this: how could `ContinuousMap` objects be used as dictionary keys without any `__hash__` method? 


I did the experiment, i.e. remove `Morphism.__hash__`, and discovered that the hash of `ContinousMap` is then inherited from `Map.__hash__`, which does (cf. line 1292 o f `src/sage/categories/map.pyx`):

```
return hash((self.domain(), self._codomain))
```
This simple hash seems very satisfactory to me, except maybe for `self._codomain` that may be replaced by `self.codomain()`. Actually this is what I had in mind when proposing to implement `ContinousMap.__hash__`. So if you remove `Morphism.__hash__`, there is no need to write a proper `ContinousMap.__hash__`: that of `Map` is sufficient.



---

archive/issue_comments_377136.json:
```json
{
    "body": "<a id='comment:19'></a>I would probably also consider removing `Map.__hash__` (and reimplementing that in `ContinuousMap`) for the same reasons as removing `Morphism.__hash__`.",
    "created_at": "2018-05-31T13:50:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377136",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:19'></a>I would probably also consider removing `Map.__hash__` (and reimplementing that in `ContinuousMap`) for the same reasons as removing `Morphism.__hash__`.



---

archive/issue_comments_377137.json:
```json
{
    "body": "<a id='comment:20'></a>Replying to [comment:19 tscrim]:\n> I would probably also consider removing `Map.__hash__` (and reimplementing that in `ContinuousMap`) for the same reasons as removing `Morphism.__hash__`.\n\n\nYes. Anyway, if I understand correctly, for Python3, one needs to implement `ContinuousMap.__hash__` because there is a `ContinuousMap.__eq__`, so that `__hash__` cannot be inherited. Correct?\n\nBtw, other manifolds classes that have to be hashable because they serve as dictionary keys are `TopologicalManifold`, `Chart` and `VectorFrame`. However, they all inherit from `UniqueRepresentation`, from which they get `__hash__` and `__eq__`. So it should be OK for Python3 with them, shouldn't it?",
    "created_at": "2018-05-31T21:38:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377137",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:20'></a>Replying to [comment:19 tscrim]:
> I would probably also consider removing `Map.__hash__` (and reimplementing that in `ContinuousMap`) for the same reasons as removing `Morphism.__hash__`.


Yes. Anyway, if I understand correctly, for Python3, one needs to implement `ContinuousMap.__hash__` because there is a `ContinuousMap.__eq__`, so that `__hash__` cannot be inherited. Correct?

Btw, other manifolds classes that have to be hashable because they serve as dictionary keys are `TopologicalManifold`, `Chart` and `VectorFrame`. However, they all inherit from `UniqueRepresentation`, from which they get `__hash__` and `__eq__`. So it should be OK for Python3 with them, shouldn't it?



---

archive/issue_comments_377138.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [comment:19 tscrim]:\n> I would probably also consider removing `Map.__hash__` (and reimplementing that in `ContinuousMap`) for the same reasons as removing `Morphism.__hash__`.\n\n\nRemoving `Map.__hash__`, `FormalCompositeMap.__hash__` (to be coherent with the removal of `Map.__hash__`) and `Morphism.__hash__`, while implementing `ContinuousMap.__hash__`, leads to (only) two doctest errors in all Sage 8.3.beta3, as reported by `make ptestlong`:\n\n```\nsage -t --long --warn-long 53.5 src/sage/combinat/root_system/hecke_algebra_representation.py\n**********************************************************************\nFile \"src/sage/combinat/root_system/hecke_algebra_representation.py\", line 683, in sage.combinat.root_system.hecke_algebra_representation.HeckeAlgebraRepresentation._test_Y\nFailed example:\n    rho._test_Y()   # long time (4s)\n...\nTypeError: <class 'sage.modules.with_basis.morphism.ModuleMorphismByLinearity_with_category'> is not hashable\n```\nand\n\n```\nsage -t --long --warn-long 53.5 src/sage/groups/semimonomial_transformations/semimonomial_transformation.pyx\n**********************************************************************\nFile \"src/sage/groups/semimonomial_transformations/semimonomial_transformation.pyx\", line 170, in sage.groups.semimonomial_transformations.semimonomial_transformation.SemimonomialTransformation.__hash__\nFailed example:\n    hash( SemimonomialTransformationGroup(F, 4).an_element() )  #random #indirect doctest\n...\nTypeError: <type 'sage.rings.finite_rings.hom_finite_field.FiniteFieldHomomorphism_generic'> is not hashable\n```",
    "created_at": "2018-06-01T12:18:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377138",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:21'></a>Replying to [comment:19 tscrim]:
> I would probably also consider removing `Map.__hash__` (and reimplementing that in `ContinuousMap`) for the same reasons as removing `Morphism.__hash__`.


Removing `Map.__hash__`, `FormalCompositeMap.__hash__` (to be coherent with the removal of `Map.__hash__`) and `Morphism.__hash__`, while implementing `ContinuousMap.__hash__`, leads to (only) two doctest errors in all Sage 8.3.beta3, as reported by `make ptestlong`:

```
sage -t --long --warn-long 53.5 src/sage/combinat/root_system/hecke_algebra_representation.py
**********************************************************************
File "src/sage/combinat/root_system/hecke_algebra_representation.py", line 683, in sage.combinat.root_system.hecke_algebra_representation.HeckeAlgebraRepresentation._test_Y
Failed example:
    rho._test_Y()   # long time (4s)
...
TypeError: <class 'sage.modules.with_basis.morphism.ModuleMorphismByLinearity_with_category'> is not hashable
```
and

```
sage -t --long --warn-long 53.5 src/sage/groups/semimonomial_transformations/semimonomial_transformation.pyx
**********************************************************************
File "src/sage/groups/semimonomial_transformations/semimonomial_transformation.pyx", line 170, in sage.groups.semimonomial_transformations.semimonomial_transformation.SemimonomialTransformation.__hash__
Failed example:
    hash( SemimonomialTransformationGroup(F, 4).an_element() )  #random #indirect doctest
...
TypeError: <type 'sage.rings.finite_rings.hom_finite_field.FiniteFieldHomomorphism_generic'> is not hashable
```



---

archive/issue_comments_377139.json:
```json
{
    "body": "<a id='comment:22'></a>Those tests would just have to be removed I guess.  Though I'm still not 100% sure now that we even want to outright remove `Map.__hash__`.  But maybe you actually agree with my initial thought to remove it.",
    "created_at": "2018-06-01T22:19:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377139",
    "user": "https://github.com/embray"
}
```

<a id='comment:22'></a>Those tests would just have to be removed I guess.  Though I'm still not 100% sure now that we even want to outright remove `Map.__hash__`.  But maybe you actually agree with my initial thought to remove it.



---

archive/issue_comments_377140.json:
```json
{
    "body": "<a id='comment:23'></a>Slightly more elegant than removing tests might be by installing a reasonable hash. For:\n'sage.rings.finite_rings.hom_finite_field.FiniteFieldHomomorphism_generic'\nI would think that\n` hash((f.domain(),f.codomain())+tuple(f.im_gens()))`\nmight be a reasonable option.\n\nand for the second one\n`hash((phi.domain(),phi.codomain(),tuple(phi(x) for x in X.basis())))`\n\nis probably OK. These are both homomorphisms on finitely generated structures, so equality and hashing are relatively straightforward (if they are implemented for elements of the codomain).",
    "created_at": "2018-06-01T23:29:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377140",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:23'></a>Slightly more elegant than removing tests might be by installing a reasonable hash. For:
'sage.rings.finite_rings.hom_finite_field.FiniteFieldHomomorphism_generic'
I would think that
` hash((f.domain(),f.codomain())+tuple(f.im_gens()))`
might be a reasonable option.

and for the second one
`hash((phi.domain(),phi.codomain(),tuple(phi(x) for x in X.basis())))`

is probably OK. These are both homomorphisms on finitely generated structures, so equality and hashing are relatively straightforward (if they are implemented for elements of the codomain).



---

archive/issue_comments_377141.json:
```json
{
    "body": "<a id='comment:24'></a>Finally, I've implemented `ContinousMap.__hash__` in a separate ticket: #25502, in order to have a quick fix for the Python3 issue.",
    "created_at": "2018-06-03T20:17:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377141",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:24'></a>Finally, I've implemented `ContinousMap.__hash__` in a separate ticket: #25502, in order to have a quick fix for the Python3 issue.



---

archive/issue_comments_377142.json:
```json
{
    "body": "<a id='comment:25'></a>I believe this issue can reasonably be addressed for Sage 8.4.",
    "created_at": "2018-07-18T11:47:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377142",
    "user": "https://github.com/embray"
}
```

<a id='comment:25'></a>I believe this issue can reasonably be addressed for Sage 8.4.



---

archive/issue_events_063759.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-07-18T11:47:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "milestone": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25393#event-63759"
}
```



---

archive/issue_comments_377143.json:
```json
{
    "body": "<a id='comment:26'></a>Looking back at #25502, and looking the comments in this ticket again, was the hash added in #25502 really necessary?  If we still go with removing the existing `Morphism.__hash__` (should we?) then `ContinuousMap` inherits `Map.__hash__` which is identical to the `ContinuousMap.__hash__` added in #25502.  Should `Map.__hash__` also be removed?",
    "created_at": "2018-09-06T13:51:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377143",
    "user": "https://github.com/embray"
}
```

<a id='comment:26'></a>Looking back at #25502, and looking the comments in this ticket again, was the hash added in #25502 really necessary?  If we still go with removing the existing `Morphism.__hash__` (should we?) then `ContinuousMap` inherits `Map.__hash__` which is identical to the `ContinuousMap.__hash__` added in #25502.  Should `Map.__hash__` also be removed?



---

archive/issue_comments_377144.json:
```json
{
    "body": "Changing status from needs_work to needs_info.",
    "created_at": "2018-09-06T13:51:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377144",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_info.



---

archive/issue_comments_377145.json:
```json
{
    "body": "<a id='comment:27'></a>Replying to [comment:26 embray]:\n> Looking back at #25502, and looking the comments in this ticket again, was the hash added in #25502 really necessary?  If we still go with removing the existing `Morphism.__hash__` (should we?) then `ContinuousMap` inherits `Map.__hash__` which is identical to the `ContinuousMap.__hash__` added in #25502.  Should `Map.__hash__` also be removed?\n\n\nIndeed `ContinuousMap.__hash__` and `Map.__hash__` are essentially identical, but I guess the logic of removing `Morphism.__hash__` applies to `Map.__hash__` as well. From the ticket description: *As far as I can tell there is no code using the ability to hash Morphisms, and having this in the base class is misleading since there are subclasses which are not immutable and should not be hashable anyways. It would be better to implement __hash__ on an as-needed basis for those classes that can guarantee immutability.* If only `Morphism.__hash__` is removed and `Map.__hash__` is kept, then all subclasses will still have some `__hash__` inherited from their base class (`Map`) and therefore will look hashable to Python3, even if they are not immutable, which is truly dangerous...\n\nPS: I realize that the removing of `Map.__hash__` was already advocated by Travis for the very same reasons in comment:19. See also comment:21 for the consequences of the removal of `Map.__hash__` (only 2 failed doctests).",
    "created_at": "2018-09-09T15:42:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377145",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:27'></a>Replying to [comment:26 embray]:
> Looking back at #25502, and looking the comments in this ticket again, was the hash added in #25502 really necessary?  If we still go with removing the existing `Morphism.__hash__` (should we?) then `ContinuousMap` inherits `Map.__hash__` which is identical to the `ContinuousMap.__hash__` added in #25502.  Should `Map.__hash__` also be removed?


Indeed `ContinuousMap.__hash__` and `Map.__hash__` are essentially identical, but I guess the logic of removing `Morphism.__hash__` applies to `Map.__hash__` as well. From the ticket description: *As far as I can tell there is no code using the ability to hash Morphisms, and having this in the base class is misleading since there are subclasses which are not immutable and should not be hashable anyways. It would be better to implement __hash__ on an as-needed basis for those classes that can guarantee immutability.* If only `Morphism.__hash__` is removed and `Map.__hash__` is kept, then all subclasses will still have some `__hash__` inherited from their base class (`Map`) and therefore will look hashable to Python3, even if they are not immutable, which is truly dangerous...

PS: I realize that the removing of `Map.__hash__` was already advocated by Travis for the very same reasons in comment:19. See also comment:21 for the consequences of the removal of `Map.__hash__` (only 2 failed doctests).



---

archive/issue_comments_377146.json:
```json
{
    "body": "<a id='comment:28'></a>Replying to [comment:27 egourgoulhon]:\n>If only `Morphism.__hash__` is removed and `Map.__hash__` is kept, then all subclasses will still have some `__hash__` inherited from their base class (`Map`) and therefore will look hashable to Python3, even if they are not immutable, which is truly dangerous...\n> \n\nActually I was wrong: there is no danger since in Python3, a class that defines some `__eq__` does no longer inherit `__hash__` from any base class. From [this part of Python 3 reference](https://docs.python.org/3/reference/datamodel.html#object.__hash__): *If a class that overrides `__eq__()` needs to retain the implementation of `__hash__()` from a parent class, the interpreter must be told this explicitly by setting `__hash__ = <ParentClass>.__hash__`.* In our case, this means that if one does not write explicitly \n\n```\n   __hash__ = Map.__hash__\n```\n(and of course does not reimplement `__hash__`), then the subclass is not hashable.\n\nProbably things will be more clear if `Map.__hash__` is removed.",
    "created_at": "2018-09-09T16:22:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377146",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:28'></a>Replying to [comment:27 egourgoulhon]:
>If only `Morphism.__hash__` is removed and `Map.__hash__` is kept, then all subclasses will still have some `__hash__` inherited from their base class (`Map`) and therefore will look hashable to Python3, even if they are not immutable, which is truly dangerous...
> 

Actually I was wrong: there is no danger since in Python3, a class that defines some `__eq__` does no longer inherit `__hash__` from any base class. From [this part of Python 3 reference](https://docs.python.org/3/reference/datamodel.html#object.__hash__): *If a class that overrides `__eq__()` needs to retain the implementation of `__hash__()` from a parent class, the interpreter must be told this explicitly by setting `__hash__ = <ParentClass>.__hash__`.* In our case, this means that if one does not write explicitly 

```
   __hash__ = Map.__hash__
```
(and of course does not reimplement `__hash__`), then the subclass is not hashable.

Probably things will be more clear if `Map.__hash__` is removed.



---

archive/issue_events_063760.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-10-28T11:41:42Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "milestone": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25393#event-63760"
}
```



---

archive/issue_events_063761.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-10-28T11:41:42Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "milestone": "sage-8.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25393#event-63761"
}
```



---

archive/issue_comments_377147.json:
```json
{
    "body": "<a id='comment:30'></a>Retargeting some of my tickets (somewhat optimistically for now).",
    "created_at": "2018-12-28T14:10:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377147",
    "user": "https://github.com/embray"
}
```

<a id='comment:30'></a>Retargeting some of my tickets (somewhat optimistically for now).



---

archive/issue_events_063762.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-12-28T14:10:15Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "milestone": "sage-8.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25393#event-63762"
}
```



---

archive/issue_events_063763.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-12-28T14:10:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "milestone": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25393#event-63763"
}
```



---

archive/issue_comments_377148.json:
```json
{
    "body": "<a id='comment:31'></a>Moving all my in-progress tickets to 8.8 milestone.",
    "created_at": "2019-03-25T10:43:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377148",
    "user": "https://github.com/embray"
}
```

<a id='comment:31'></a>Moving all my in-progress tickets to 8.8 milestone.



---

archive/issue_events_063764.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-03-25T10:43:18Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "milestone": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25393#event-63764"
}
```



---

archive/issue_events_063765.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-03-25T10:43:18Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "milestone": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25393#event-63765"
}
```



---

archive/issue_comments_377149.json:
```json
{
    "body": "<a id='comment:32'></a>Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).",
    "created_at": "2019-06-14T14:50:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377149",
    "user": "https://github.com/embray"
}
```

<a id='comment:32'></a>Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).



---

archive/issue_events_063766.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-06-14T14:50:27Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "milestone": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25393#event-63766"
}
```



---

archive/issue_events_063767.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-06-14T14:50:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "milestone": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25393#event-63767"
}
```



---

archive/issue_comments_377150.json:
```json
{
    "body": "<a id='comment:33'></a>Ticket retargeted after milestone closed",
    "created_at": "2019-12-30T14:48:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377150",
    "user": "https://github.com/embray"
}
```

<a id='comment:33'></a>Ticket retargeted after milestone closed



---

archive/issue_events_063768.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-12-30T14:48:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "milestone": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25393#event-63768"
}
```



---

archive/issue_events_063769.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-12-30T14:48:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25393#event-63769"
}
```



---

archive/issue_events_063770.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-05-01T04:28:42Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25393#event-63770"
}
```



---

archive/issue_events_063771.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-05-01T04:28:42Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25393#event-63771"
}
```



---

archive/issue_comments_377151.json:
```json
{
    "body": "<a id='comment:34'></a>Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.",
    "created_at": "2020-05-01T04:28:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377151",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:34'></a>Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.



---

archive/issue_events_063772.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25393#event-63772"
}
```



---

archive/issue_events_063773.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25393#event-63773"
}
```



---

archive/issue_comments_377152.json:
```json
{
    "body": "<a id='comment:36'></a>Moving to 9.4, as 9.3 has been released.",
    "created_at": "2021-05-10T17:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377152",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:36'></a>Moving to 9.4, as 9.3 has been released.



---

archive/issue_events_063774.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-05-10T17:42:09Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25393#event-63774"
}
```



---

archive/issue_events_063775.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-05-10T17:42:09Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25393#event-63775"
}
```



---

archive/issue_events_063776.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25393#event-63776"
}
```



---

archive/issue_events_063777.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25393#event-63777"
}
```



---

archive/issue_comments_377153.json:
```json
{
    "body": "<a id='comment:37'></a>Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377153",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:37'></a>Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_comments_377154.json:
```json
{
    "body": "<a id='comment:38'></a>Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.",
    "created_at": "2021-12-18T19:53:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25393#issuecomment-377154",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:38'></a>Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.



---

archive/issue_events_063778.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:53:12Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25393#event-63778"
}
```



---

archive/issue_events_063779.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:53:12Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25393#event-63779"
}
```



---

archive/issue_events_063780.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-02T17:54:54Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25393#event-63780"
}
```



---

archive/issue_events_063781.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-02T17:54:54Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25393#event-63781"
}
```



---

archive/issue_events_063782.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T05:25:02Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25393#event-63782"
}
```



---

archive/issue_events_063783.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T05:25:02Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25393",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25393#event-63783"
}
```
