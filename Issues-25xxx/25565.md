# Issue 25565: Efficient k-WL implementation

archive/issues_025565.json:
```json
{
    "body": "CC:  @dimpase\n\nKeywords: gsoc18 k-wl weisfeiler lehman automorphism isomorphism color refinement\n\nScope of this ticket is implementing in an efficient manner a parametric version of the Weisfeiler Lehman procedure.\\\\\\\\\n\nThe Weisfeiler Lehman method is a way of generating a partition of the nodes (or edges) of a graph G such that the orbits of the automorphism group on G\u2019s vertices (respectively edges) refine said partition. \\\\This method was first described in https://www.iti.zcu.cz/wl2018/pdf/wl_paper_translation.pdf (translated from russian) and is also better and succintly described in https://www.lii.rwth-aachen.de/images/Mitarbeiter/pub/grohe/cr.pdf. \\\\The idea can be summarised as doing multiple rounds of vertex (resp. edge) coloring, where each round\u2019s color is determined by the colors of the (hyper)edges in the previous round, until the coloring is stable, that is the color classes stay the same between two subsequent rounds of coloring. Higher values of k (or higher orders of the WL method) base the choice of color for each round on interactions between a higher number of vertices, and thus correctly return the orbits of strictly more graphs than lower values of k.\\\\\\\\\n\nThis method can be used as a negative oracle for isomorphism between two graphs G and H by running it on their disjoint union: if the two components have different coloring, the graphs are surely not isomorphic; nothing can be said if their coloring is the same instead, since WL doesn\u2019t give any guarantee of returning the correct orbits instead of just a set of sets of vertices that is by them refined.\\\\\n\nI developed two different implementations for this method, the first following the description in the second paper linked above, distinguish k-tuples of vertices by multisets of colorings of suitably constructed ulterior k-tuples.\\\\\nThis implementation, while being decently fast soon after completion, needed O(n<sup>k+1</sup>) memory and also, for k > 2, an additional last pass over all the tuples to compute the color classes over vertices or edges (this last part was never implemented).\\\\\nThe branch with this implementation can be found in the branch u/Vaush/weisfeiler_lehman_first_implementation, at https://git.sagemath.org/sage.git/log/?h=u/Vaush/weisfeiler_lehman_first_implementation \\\\\\\\\nFollowing some consulting with dimpase, a new implementation (the current one for this ticket) has been developed that distinguishes (and colors) edges of a graph G by constructing the isomorphism classes of all possible subgraphs of G that have order k+1 and whose vertex set includes the extremes of the currently considered edge, and counting how many subgraphs each edge has for any given class; the counters are then used as a fingerprint that uniquely identifies the color class an edge belongs to during a certain refinement round.\\\\\nThis implementation, after some needed pruning of the search space evident from the number of commits, is now faster than the first one while consuming less memory in every case but extreme ones, and also has the advantage of producing the orbitals of G without any other post-processing.\\\\\nNOTE: at the moment, this second implementation is not as powerful as the first one, since it fails to recognise a Cai-Furer-Immerman graph with ```k=3``` as it should, needing ```k=4```, and the same can be said for the Paley digraph with ```n=4```. Cause is currently unknown, either a bug in the implementation or the algorithm might not actually be equivalent to k-WL.\n\nNext steps in the development would be adding more test cases (or examples) and adding specialised versions of the method for k=1 and k=2, cases that have peculiar characteristics which allow a specific implementation to have a much lower running time and memory usage than the generic one.\n\nA third, parallelised, implementation has been developed too, and can be found at https://git.sagemath.org/sage.git/log/?h=u/Vaush/Weisfeiler_Lehman_Second_Parallel. It shares the same issue reported above with the sequential second implementation, but due to multithreading it is a lot faster on large graphs, though it consumes more memory. It is also slower on very small graphs, for small values of k, due to the synchronisation overhead.\n\nIssue created by migration from https://trac.sagemath.org/ticket/25802\n\n",
    "created_at": "2018-07-08T18:48:04Z",
    "labels": [
        "component: graph theory"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.4",
    "title": "Efficient k-WL implementation",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25565",
    "user": "https://trac.sagemath.org/admin/accounts/users/Vaush"
}
```
CC:  @dimpase

Keywords: gsoc18 k-wl weisfeiler lehman automorphism isomorphism color refinement

Scope of this ticket is implementing in an efficient manner a parametric version of the Weisfeiler Lehman procedure.\\\\

The Weisfeiler Lehman method is a way of generating a partition of the nodes (or edges) of a graph G such that the orbits of the automorphism group on G’s vertices (respectively edges) refine said partition. \\This method was first described in https://www.iti.zcu.cz/wl2018/pdf/wl_paper_translation.pdf (translated from russian) and is also better and succintly described in https://www.lii.rwth-aachen.de/images/Mitarbeiter/pub/grohe/cr.pdf. \\The idea can be summarised as doing multiple rounds of vertex (resp. edge) coloring, where each round’s color is determined by the colors of the (hyper)edges in the previous round, until the coloring is stable, that is the color classes stay the same between two subsequent rounds of coloring. Higher values of k (or higher orders of the WL method) base the choice of color for each round on interactions between a higher number of vertices, and thus correctly return the orbits of strictly more graphs than lower values of k.\\\\

This method can be used as a negative oracle for isomorphism between two graphs G and H by running it on their disjoint union: if the two components have different coloring, the graphs are surely not isomorphic; nothing can be said if their coloring is the same instead, since WL doesn’t give any guarantee of returning the correct orbits instead of just a set of sets of vertices that is by them refined.\\

I developed two different implementations for this method, the first following the description in the second paper linked above, distinguish k-tuples of vertices by multisets of colorings of suitably constructed ulterior k-tuples.\\
This implementation, while being decently fast soon after completion, needed O(n<sup>k+1</sup>) memory and also, for k > 2, an additional last pass over all the tuples to compute the color classes over vertices or edges (this last part was never implemented).\\
The branch with this implementation can be found in the branch u/Vaush/weisfeiler_lehman_first_implementation, at https://git.sagemath.org/sage.git/log/?h=u/Vaush/weisfeiler_lehman_first_implementation \\\\
Following some consulting with dimpase, a new implementation (the current one for this ticket) has been developed that distinguishes (and colors) edges of a graph G by constructing the isomorphism classes of all possible subgraphs of G that have order k+1 and whose vertex set includes the extremes of the currently considered edge, and counting how many subgraphs each edge has for any given class; the counters are then used as a fingerprint that uniquely identifies the color class an edge belongs to during a certain refinement round.\\
This implementation, after some needed pruning of the search space evident from the number of commits, is now faster than the first one while consuming less memory in every case but extreme ones, and also has the advantage of producing the orbitals of G without any other post-processing.\\
NOTE: at the moment, this second implementation is not as powerful as the first one, since it fails to recognise a Cai-Furer-Immerman graph with ```k=3``` as it should, needing ```k=4```, and the same can be said for the Paley digraph with ```n=4```. Cause is currently unknown, either a bug in the implementation or the algorithm might not actually be equivalent to k-WL.

Next steps in the development would be adding more test cases (or examples) and adding specialised versions of the method for k=1 and k=2, cases that have peculiar characteristics which allow a specific implementation to have a much lower running time and memory usage than the generic one.

A third, parallelised, implementation has been developed too, and can be found at https://git.sagemath.org/sage.git/log/?h=u/Vaush/Weisfeiler_Lehman_Second_Parallel. It shares the same issue reported above with the sequential second implementation, but due to multithreading it is a lot faster on large graphs, though it consumes more memory. It is also slower on very small graphs, for small values of k, due to the synchronisation overhead.

Issue created by migration from https://trac.sagemath.org/ticket/25802





---

archive/issue_comments_360050.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-09T15:52:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25565#issuecomment-360050",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_360051.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-14T15:16:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25565#issuecomment-360051",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_360052.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-18T17:35:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25565#issuecomment-360052",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_360053.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-22T15:13:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25565#issuecomment-360053",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_360054.json:
```json
{
    "body": "Changed the branch to refer to the new, improved in time and space efficiency, implementation\n\n---\nLast 10 new commits:",
    "created_at": "2018-07-30T14:58:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25565#issuecomment-360054",
    "user": "https://trac.sagemath.org/admin/accounts/users/Vaush"
}
```

Changed the branch to refer to the new, improved in time and space efficiency, implementation

---
Last 10 new commits:



---

archive/issue_comments_360055.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-31T09:04:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25565#issuecomment-360055",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_360056.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-31T23:23:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25565#issuecomment-360056",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_360057.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-01T00:48:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25565#issuecomment-360057",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_360058.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-01T10:47:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25565#issuecomment-360058",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_360059.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-01T17:01:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25565#issuecomment-360059",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_360060.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-02T17:24:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25565#issuecomment-360060",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_360061.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-02T19:50:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25565#issuecomment-360061",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_360062.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-03T10:07:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25565#issuecomment-360062",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_360063.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-03T17:24:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25565#issuecomment-360063",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_360064.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-04T12:38:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25565#issuecomment-360064",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_events_064523.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2018-08-06T06:47:59Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25565",
    "milestone": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25565#event-64523"
}
```



---

archive/issue_comments_360065.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-09T15:44:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25565#issuecomment-360065",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_360066.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-09T19:15:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25565#issuecomment-360066",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_360067.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-12T18:52:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25565#issuecomment-360067",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_360068.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-23T17:45:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25565#issuecomment-360068",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:
