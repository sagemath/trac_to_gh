# Issue 25111: In the built documentation, replace duplicate files by symlinks

archive/issues_024874.json:
```json
{
    "assignees": [],
    "body": "Until Sage 8.2, the `_static` directories in the generated HTML documentation of the reference manual were symlinks to a single master `_static` directory. Now all the files are copied, leading to a huge explosion in size of the built documentation (from 1.8GB in Sage 8.2 to about 20GB in Sage 8.3).\n\nCC:  @timokau\n\nComponent: **documentation**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/25111_\n\n",
    "created_at": "2018-04-06T18:50:51Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20documentation",
        "https://github.com/sagemath/sage/labels/p%3A%202%20%E2%80%93%20critical",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "In the built documentation, replace duplicate files by symlinks",
    "type": "issue",
    "updated_at": "2022-12-29T01:42:26Z",
    "url": "https://github.com/sagemath/sage/issues/25111",
    "user": "https://github.com/jhpalmieri"
}
```
Until Sage 8.2, the `_static` directories in the generated HTML documentation of the reference manual were symlinks to a single master `_static` directory. Now all the files are copied, leading to a huge explosion in size of the built documentation (from 1.8GB in Sage 8.2 to about 20GB in Sage 8.3).

CC:  @timokau

Component: **documentation**

_Issue created by migration from https://trac.sagemath.org/ticket/25111_





---

archive/issue_events_347410.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2018-04-06T18:50:51Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "milestone_number": null,
    "milestone_title": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25111#event-347410"
}
```



---

archive/issue_events_347411.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2018-04-06T18:50:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20documentation",
    "label_color": "0075ca",
    "label_name": "c: documentation",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25111#event-347411"
}
```



---

archive/issue_events_347412.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2018-04-06T18:50:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25111#event-347412"
}
```



---

archive/issue_events_347413.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2018-04-06T18:50:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25111#event-347413"
}
```



---

archive/issue_comments_383160.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nI actually do this in sage-on-gentoo, but I do it at the packaging level rather than the building level.",
    "created_at": "2018-04-06T19:46:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25111#issuecomment-383160",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:1" align="right">comment:1</div>

I actually do this in sage-on-gentoo, but I do it at the packaging level rather than the building level.



---

archive/issue_comments_383161.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nHere is some Python code which works for me. Is this the sort of thing you use?\n\n```python\nfrom filecmp import dircmp\nimport os, shutil\n\ndef directories_equal(left, right, ignore=None):\n    \"\"\"\n    True if and only if the directories ``left`` and ``right`` have\n    the same contents, file by file. Ignore any files listed in\n    ``ignore``.\n    \"\"\"\n    dcmp = dircmp(left, right, ignore=ignore)\n    return (not dcmp.left_only and not dcmp.right_only \n            and not dcmp.common_funny and not dcmp.funny_files\n            and not dcmp.diff_files and \n            all(directories_equal(os.path.join(left, a), os.path.join(right, a), ignore=ignore) \n                for a in dcmp.common_dirs))\n\n\ndef replace_duplicates_with_symlinks(source, target):\n    \"\"\"\n    INPUTS:\n\n    - ``source``, ``target``: directories.\n\n    If the two directories are identical, replace ``target`` with a\n    symlink pointing to ``source``. Otherwise, for each file in\n    ``target``, if a copy of it exists in ``source``, replace the copy\n    in ``target`` with a symlink pointing to ``source``.  \n    \"\"\"\n    if directories_equal(source, target, ignore=['pdf.png']):\n        if not os.path.islink(target):\n            shutil.rmtree(target)\n            os.symlink(source, target)\n    else:\n        # compare file by file, doing the replacement\n        dcmp = dircmp(source, target)\n        for d in dcmp.common_dirs:\n            replace_duplicates_with_symlinks(os.path.join(source, d),\n                                             os.path.join(target, d))\n        for f in dcmp.common_files:\n            os.remove(os.path.join(target, f))\n            os.symlink(os.path.join(source, f),\n                       os.path.join(target, f))\n    \n\ndef replace_with_master_directory(top_dir):\n    \"\"\"\n    top_dir: top of html doc directory (so typically \n    top_dir = local/share/doc/sage/html)\n    \"\"\"\n    master = os.path.join(top_dir, 'en', '_static')\n    for lang in os.listdir(top_dir):\n        for d in os.listdir(os.path.join(top_dir, lang)):\n            target = os.path.join(top_dir, lang, d, '_static')\n            if (os.path.isdir(target) \n                and not os.path.islink(target) \n                and not os.path.samefile(master, target)):\n                replace_duplicates_with_symlinks(master, target)\n\n```",
    "created_at": "2018-04-06T20:25:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25111#issuecomment-383161",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:2" align="right">comment:2</div>

Here is some Python code which works for me. Is this the sort of thing you use?

```python
from filecmp import dircmp
import os, shutil

def directories_equal(left, right, ignore=None):
    """
    True if and only if the directories ``left`` and ``right`` have
    the same contents, file by file. Ignore any files listed in
    ``ignore``.
    """
    dcmp = dircmp(left, right, ignore=ignore)
    return (not dcmp.left_only and not dcmp.right_only 
            and not dcmp.common_funny and not dcmp.funny_files
            and not dcmp.diff_files and 
            all(directories_equal(os.path.join(left, a), os.path.join(right, a), ignore=ignore) 
                for a in dcmp.common_dirs))


def replace_duplicates_with_symlinks(source, target):
    """
    INPUTS:

    - ``source``, ``target``: directories.

    If the two directories are identical, replace ``target`` with a
    symlink pointing to ``source``. Otherwise, for each file in
    ``target``, if a copy of it exists in ``source``, replace the copy
    in ``target`` with a symlink pointing to ``source``.  
    """
    if directories_equal(source, target, ignore=['pdf.png']):
        if not os.path.islink(target):
            shutil.rmtree(target)
            os.symlink(source, target)
    else:
        # compare file by file, doing the replacement
        dcmp = dircmp(source, target)
        for d in dcmp.common_dirs:
            replace_duplicates_with_symlinks(os.path.join(source, d),
                                             os.path.join(target, d))
        for f in dcmp.common_files:
            os.remove(os.path.join(target, f))
            os.symlink(os.path.join(source, f),
                       os.path.join(target, f))
    

def replace_with_master_directory(top_dir):
    """
    top_dir: top of html doc directory (so typically 
    top_dir = local/share/doc/sage/html)
    """
    master = os.path.join(top_dir, 'en', '_static')
    for lang in os.listdir(top_dir):
        for d in os.listdir(os.path.join(top_dir, lang)):
            target = os.path.join(top_dir, lang, d, '_static')
            if (os.path.isdir(target) 
                and not os.path.islink(target) 
                and not os.path.samefile(master, target)):
                replace_duplicates_with_symlinks(master, target)

```



---

archive/issue_comments_383162.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nThis saves me almost 400 MB, by the way. (\"This\" = `replace_with_master_directory(os.path.join(SAGE_LOCAL, 'share', 'doc', 'sage', 'html'))`.)",
    "created_at": "2018-04-06T20:32:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25111#issuecomment-383162",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:3" align="right">comment:3</div>

This saves me almost 400 MB, by the way. ("This" = `replace_with_master_directory(os.path.join(SAGE_LOCAL, 'share', 'doc', 'sage', 'html'))`.)



---

archive/issue_comments_383163.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nNo I don't use python code because I do it within the packaging script in bash\n\n```\n\t\t\t# Prune _static folders\n\t\t\tcp -r build_doc/html/en/_static build_doc/html/ || die \"failed to copy _static folder\"\n\t\t\tfor sdir in `find build_doc/html -name _static` ; do\n\t\t\t\tif [ $sdir != \"build_doc/html/_static\" ] ; then\n\t\t\t\t\trm -rf $sdir || die \"failed to remove $sdir\"\n\t\t\t\t\tln -rst ${sdir%_static} build_doc/html/_static\n\t\t\t\tfi\n\t\t\tdone\n```\nbecause I have the mathjax fonts by default and they are copied in all `_static` directories, the saving is in GB.\n\nThe last touch is replacing most of the mathjax stuff by symlink in the master _static folder\n\n```\n\t\t\t# Linking to local copy of mathjax folders rather than copying them\n\t\t\tlocal mathjax_folders=\"config extensions fonts jax localization unpacked\"\n\t\t\tfor sdir in ${mathjax_folders} ; do\n\t\t\t\trm -rf build_doc/html/_static/${sdir} \\\n\t\t\t\t\t|| die \"failed to remove mathjax folder $sdir\"\n\t\t\t\tln -st build_doc/html/_static/ ../../../../mathjax/$sdir\n\t\t\tdone\n```",
    "created_at": "2018-04-06T20:48:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25111#issuecomment-383163",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:4" align="right">comment:4</div>

No I don't use python code because I do it within the packaging script in bash

```
			# Prune _static folders
			cp -r build_doc/html/en/_static build_doc/html/ || die "failed to copy _static folder"
			for sdir in `find build_doc/html -name _static` ; do
				if [ $sdir != "build_doc/html/_static" ] ; then
					rm -rf $sdir || die "failed to remove $sdir"
					ln -rst ${sdir%_static} build_doc/html/_static
				fi
			done
```
because I have the mathjax fonts by default and they are copied in all `_static` directories, the saving is in GB.

The last touch is replacing most of the mathjax stuff by symlink in the master _static folder

```
			# Linking to local copy of mathjax folders rather than copying them
			local mathjax_folders="config extensions fonts jax localization unpacked"
			for sdir in ${mathjax_folders} ; do
				rm -rf build_doc/html/_static/${sdir} \
					|| die "failed to remove mathjax folder $sdir"
				ln -st build_doc/html/_static/ ../../../../mathjax/$sdir
			done
```



---

archive/issue_comments_383164.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nSee possibly related discussion at #25089.",
    "created_at": "2018-04-07T14:18:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25111#issuecomment-383164",
    "user": "https://github.com/slel"
}
```

<div id="comment:5" align="right">comment:5</div>

See possibly related discussion at #25089.



---

archive/issue_comments_383165.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nI'm confused by this ticket, because it already does that, per #25089...",
    "created_at": "2018-04-09T09:19:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25111#issuecomment-383165",
    "user": "https://github.com/embray"
}
```

<div id="comment:6" align="right">comment:6</div>

I'm confused by this ticket, because it already does that, per #25089...



---

archive/issue_comments_383166.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nI see the difference--it does already do this within the `en/reference` docs, where each \"reference\" section is treated as a sub-document of the reference \"master document\", and in that case the `_static` directories get symlinked up to the master document.  My assumption was that all of the Sage docs (including \"reference\") were in turn treated as sub-documents of a higher-level master document but apparently that's not the case.\n\nIMO treating the entire tree of Sage docs as such a hierarchy with shared static resources would be the best approach.",
    "created_at": "2018-04-09T09:23:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25111#issuecomment-383166",
    "user": "https://github.com/embray"
}
```

<div id="comment:7" align="right">comment:7</div>

I see the difference--it does already do this within the `en/reference` docs, where each "reference" section is treated as a sub-document of the reference "master document", and in that case the `_static` directories get symlinked up to the master document.  My assumption was that all of the Sage docs (including "reference") were in turn treated as sub-documents of a higher-level master document but apparently that's not the case.

IMO treating the entire tree of Sage docs as such a hierarchy with shared static resources would be the best approach.



---

archive/issue_comments_383167.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nSome parts of the documentation tree have slightly different `_static` directories, which is where the approach in comment 2 comes from: compare each `_static` directory to the top-level one, replacing files (and directories) with symlinks when possible.",
    "created_at": "2018-05-22T23:21:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25111#issuecomment-383167",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:8" align="right">comment:8</div>

Some parts of the documentation tree have slightly different `_static` directories, which is where the approach in comment 2 comes from: compare each `_static` directory to the top-level one, replacing files (and directories) with symlinks when possible.



---

archive/issue_comments_383168.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nIs it worth pursuing this? It could be part of the docbuild process, or it could be done only when you use `make` to build all of the Sage docs. I'm leaning toward the latter approach. In either case, all of the `_static` directories will be produced and then cleaned up later, so disk usage will increase during the build process before dropping at the end, although this happens throughout the build process. (I don't know how to deal with the symlinks on the fly. I also don't know if there is a way to tell Sphinx to look mainly in one place for shared static resources. Since documentation in different languages have different `_static/translations.js` files, we can't rely solely on a single `_static` folder.)\n\nI also don't know what to do about Windows/cygwin and symbolic links.",
    "created_at": "2018-05-23T21:28:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25111#issuecomment-383168",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:9" align="right">comment:9</div>

Is it worth pursuing this? It could be part of the docbuild process, or it could be done only when you use `make` to build all of the Sage docs. I'm leaning toward the latter approach. In either case, all of the `_static` directories will be produced and then cleaned up later, so disk usage will increase during the build process before dropping at the end, although this happens throughout the build process. (I don't know how to deal with the symlinks on the fly. I also don't know if there is a way to tell Sphinx to look mainly in one place for shared static resources. Since documentation in different languages have different `_static/translations.js` files, we can't rely solely on a single `_static` folder.)

I also don't know what to do about Windows/cygwin and symbolic links.



---

archive/issue_comments_383169.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nSphinx has a configuration option [html_static_path](http://www.sphinx-doc.org/en/master/usage/configuration.html#confval-html_static_path) which might do what we want. I'll look into it.\n\nEdit: or maybe not: the documentation says that the files \"are copied to the output\u2019s _static directory after the theme\u2019s static files\". We don't want files copied, we want a single `_static` directory.",
    "created_at": "2018-05-23T21:30:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25111#issuecomment-383169",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:10" align="right">comment:10</div>

Sphinx has a configuration option [html_static_path](http://www.sphinx-doc.org/en/master/usage/configuration.html#confval-html_static_path) which might do what we want. I'll look into it.

Edit: or maybe not: the documentation says that the files "are copied to the output’s _static directory after the theme’s static files". We don't want files copied, we want a single `_static` directory.



---

archive/issue_comments_383170.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nCouldn't a different `_static/translations.js` be used per language?  That is, somehow namespace that file by the language in the first place.  That or at least have an alternate location for it. `html_static_path` can be a list.",
    "created_at": "2018-05-31T14:40:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25111#issuecomment-383170",
    "user": "https://github.com/embray"
}
```

<div id="comment:11" align="right">comment:11</div>

Couldn't a different `_static/translations.js` be used per language?  That is, somehow namespace that file by the language in the first place.  That or at least have an alternate location for it. `html_static_path` can be a list.



---

archive/issue_comments_383171.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nI don't think that `html_static_path` will help: it provides a list from which the output `_static` directories are produced \u2013 it does not provide a list of directories to use instead of the output `_static` directories. In fact, we already set `html_static_path` in `src/doc/common/conf.py`.",
    "created_at": "2018-05-31T14:57:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25111#issuecomment-383171",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:12" align="right">comment:12</div>

I don't think that `html_static_path` will help: it provides a list from which the output `_static` directories are produced – it does not provide a list of directories to use instead of the output `_static` directories. In fact, we already set `html_static_path` in `src/doc/common/conf.py`.



---

archive/issue_events_347414.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-08-24T06:09:46Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "milestone_number": null,
    "milestone_title": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25111#event-347414"
}
```



---

archive/issue_events_347415.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-08-24T06:09:46Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "milestone_number": null,
    "milestone_title": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25111#event-347415"
}
```



---

archive/issue_comments_383172.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1 @@\n-The build documentation contains many directories called `_static`, which are almost all identical. Replacing them with symlinks to a master copy would save disk space.\n+At some point in the past, the `_static` directories in the generated HTML documentation were symlinks to a single master `_static` directory. Now it seems that the files are copied, leading to a huge explosion in size of the built documentation (about 20GB).\n``````\n",
    "created_at": "2018-08-24T06:09:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25111#issuecomment-383172",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1 @@
-The build documentation contains many directories called `_static`, which are almost all identical. Replacing them with symlinks to a master copy would save disk space.
+At some point in the past, the `_static` directories in the generated HTML documentation were symlinks to a single master `_static` directory. Now it seems that the files are copied, leading to a huge explosion in size of the built documentation (about 20GB).
``````




---

archive/issue_events_347416.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-08-24T06:09:46Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25111#event-347416"
}
```



---

archive/issue_events_347417.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-08-24T06:09:46Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "label": "https://github.com/sagemath/sage/labels/p%3A%202%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p: 2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25111#event-347417"
}
```



---

archive/issue_comments_383173.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1 @@\n-At some point in the past, the `_static` directories in the generated HTML documentation were symlinks to a single master `_static` directory. Now it seems that the files are copied, leading to a huge explosion in size of the built documentation (about 20GB).\n+Until Sage 8.2, the `_static` directories in the generated HTML documentation of the reference manual were symlinks to a single master `_static` directory. Now all the files are copied, leading to a huge explosion in size of the built documentation (from 1.8GB in Sage 8.2 to about 20GB in Sage 8.3).\n``````\n",
    "created_at": "2018-08-24T08:35:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25111#issuecomment-383173",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1 @@
-At some point in the past, the `_static` directories in the generated HTML documentation were symlinks to a single master `_static` directory. Now it seems that the files are copied, leading to a huge explosion in size of the built documentation (about 20GB).
+Until Sage 8.2, the `_static` directories in the generated HTML documentation of the reference manual were symlinks to a single master `_static` directory. Now all the files are copied, leading to a huge explosion in size of the built documentation (from 1.8GB in Sage 8.2 to about 20GB in Sage 8.3).
``````




---

archive/issue_comments_383174.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nToo bad that I missed this ticket earlier. This should have been an 8.3 blocker.",
    "created_at": "2018-08-24T08:35:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25111#issuecomment-383174",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:14" align="right">comment:14</div>

Too bad that I missed this ticket earlier. This should have been an 8.3 blocker.



---

archive/issue_comments_383175.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nAs a workaround to #25089, for the Windows build I run a script that deletes all the duplicate `_static` directories and instead modifies links in the HTML to reference a single `_static` directory.  My script just runs over the docs after they've been built, but it would probably be better to figure out how to do this directly in the Sphinx build.",
    "created_at": "2018-08-24T09:41:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25111#issuecomment-383175",
    "user": "https://github.com/embray"
}
```

<div id="comment:15" align="right">comment:15</div>

As a workaround to #25089, for the Windows build I run a script that deletes all the duplicate `_static` directories and instead modifies links in the HTML to reference a single `_static` directory.  My script just runs over the docs after they've been built, but it would probably be better to figure out how to do this directly in the Sphinx build.



---

archive/issue_comments_383176.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@embray](#comment:15):\n> As a workaround to #25089, for the Windows build I run a script that deletes all the duplicate `_static` directories and instead modifies links in the HTML to reference a single `_static` directory.  My script just runs over the docs after they've been built, but it would probably be better to figure out how to do this directly in the Sphinx build.\n\nI do exactly that in sage-on-gentoo as well. Would be great to know how to tell sphinx to create symlinks instead of copying.",
    "created_at": "2018-08-24T09:44:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25111#issuecomment-383176",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@embray](#comment:15):
> As a workaround to #25089, for the Windows build I run a script that deletes all the duplicate `_static` directories and instead modifies links in the HTML to reference a single `_static` directory.  My script just runs over the docs after they've been built, but it would probably be better to figure out how to do this directly in the Sphinx build.

I do exactly that in sage-on-gentoo as well. Would be great to know how to tell sphinx to create symlinks instead of copying.



---

archive/issue_comments_383177.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1 @@\n-Until Sage 8.2, the `_static` directories in the generated HTML documentation of the reference manual were symlinks to a single master `_static` directory. Now all the files are copied, leading to a huge explosion in size of the built documentation (from 1.8GB in Sage 8.2 to about 20GB in Sage 8.3).\n+Until Sage 8.2, the `_static` directories in the generated HTML documentation of the reference manual were symlinks to a single master `_static` directory. Now all the files are copied, leading to a huge explosion in size of the built documentation (from 1.8GB in Sage 8.2 to about 20GB in Sage 8.3). This probably got broken by the Sphinx upgrade #24935.\n``````\n",
    "created_at": "2018-08-24T10:02:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25111#issuecomment-383177",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1 @@
-Until Sage 8.2, the `_static` directories in the generated HTML documentation of the reference manual were symlinks to a single master `_static` directory. Now all the files are copied, leading to a huge explosion in size of the built documentation (from 1.8GB in Sage 8.2 to about 20GB in Sage 8.3).
+Until Sage 8.2, the `_static` directories in the generated HTML documentation of the reference manual were symlinks to a single master `_static` directory. Now all the files are copied, leading to a huge explosion in size of the built documentation (from 1.8GB in Sage 8.2 to about 20GB in Sage 8.3). This probably got broken by the Sphinx upgrade #24935.
``````




---

archive/issue_comments_383178.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nReplying to [@jdemeyer](#comment:14):\n> Too bad that I missed this ticket earlier. This should have been an 8.3 blocker.\n\nBy the way, that 20GB figure is not really how much disk space is being taken up.  There is a bug (I have no idea where this comes from) that puts a \"mathjax\" directory in each `_static`, which is a hard link to the mathjax sources (i.e. under `$SAGE_LOCAL/share/mathjax`).  This inexplicably contains a symlink to itself as `$SAGE_LOCAL/share/mathjax/mathjax`.  In the `_static` directories, however, this symlink is being dereferenced and converted to a hard link as well, so you end up with an infinite loop of hardlinks, which tools like `du` don't handle well when counting (the size it's reporting is probably just being limited by some max depth parameter).\n\nIf I delete all those nonsense `mathjax` hardlinks I then get:\n\n```\n$ du -sh local/share/doc/sage/html/\n779M    local/share/doc/sage/html/\n```\n\nand\n\n```\n$ du -sh local/share/doc/sage/\n2.0G    local/share/doc/sage/\n```\n\nso I think it's not all as bad as it seems.",
    "created_at": "2018-08-24T10:05:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25111#issuecomment-383178",
    "user": "https://github.com/embray"
}
```

<div id="comment:18" align="right">comment:18</div>

Replying to [@jdemeyer](#comment:14):
> Too bad that I missed this ticket earlier. This should have been an 8.3 blocker.

By the way, that 20GB figure is not really how much disk space is being taken up.  There is a bug (I have no idea where this comes from) that puts a "mathjax" directory in each `_static`, which is a hard link to the mathjax sources (i.e. under `$SAGE_LOCAL/share/mathjax`).  This inexplicably contains a symlink to itself as `$SAGE_LOCAL/share/mathjax/mathjax`.  In the `_static` directories, however, this symlink is being dereferenced and converted to a hard link as well, so you end up with an infinite loop of hardlinks, which tools like `du` don't handle well when counting (the size it's reporting is probably just being limited by some max depth parameter).

If I delete all those nonsense `mathjax` hardlinks I then get:

```
$ du -sh local/share/doc/sage/html/
779M    local/share/doc/sage/html/
```

and

```
$ du -sh local/share/doc/sage/
2.0G    local/share/doc/sage/
```

so I think it's not all as bad as it seems.



---

archive/issue_comments_383179.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1 @@\n-Until Sage 8.2, the `_static` directories in the generated HTML documentation of the reference manual were symlinks to a single master `_static` directory. Now all the files are copied, leading to a huge explosion in size of the built documentation (from 1.8GB in Sage 8.2 to about 20GB in Sage 8.3). This probably got broken by the Sphinx upgrade #24935.\n+Until Sage 8.2, the `_static` directories in the generated HTML documentation of the reference manual were symlinks to a single master `_static` directory. Now all the files are copied, leading to a huge explosion in size of the built documentation (from 1.8GB in Sage 8.2 to about 20GB in Sage 8.3).\n``````\n",
    "created_at": "2018-08-24T10:05:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25111#issuecomment-383179",
    "user": "https://github.com/embray"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1 @@
-Until Sage 8.2, the `_static` directories in the generated HTML documentation of the reference manual were symlinks to a single master `_static` directory. Now all the files are copied, leading to a huge explosion in size of the built documentation (from 1.8GB in Sage 8.2 to about 20GB in Sage 8.3). This probably got broken by the Sphinx upgrade #24935.
+Until Sage 8.2, the `_static` directories in the generated HTML documentation of the reference manual were symlinks to a single master `_static` directory. Now all the files are copied, leading to a huge explosion in size of the built documentation (from 1.8GB in Sage 8.2 to about 20GB in Sage 8.3).
``````




---

archive/issue_comments_383180.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nI see now your sage-devel post where you reported the same.",
    "created_at": "2018-08-24T12:50:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25111#issuecomment-383180",
    "user": "https://github.com/embray"
}
```

<div id="comment:20" align="right">comment:20</div>

I see now your sage-devel post where you reported the same.



---

archive/issue_comments_383181.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nIt seems to be more subtle: sometimes the symlinks are correctly generated and sometimes not.",
    "created_at": "2018-08-27T07:01:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25111#issuecomment-383181",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:21" align="right">comment:21</div>

It seems to be more subtle: sometimes the symlinks are correctly generated and sometimes not.



---

archive/issue_comments_383182.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nReplying to [@embray](#comment:18):\n\n> If I delete all those nonsense `mathjax` hardlinks I then get:\n> \n> ```\n> $ du -sh local/share/doc/sage/html/\n> 779M    local/share/doc/sage/html/\n> ```\n\nBy the way, after using the script in [comment:2](#comment:2), I get\n\n```\n$ du -s -h local/share/doc/sage/html/\n315M\tlocal/share/doc/sage/html/\n```\nThere are lots of symlinks, though.",
    "created_at": "2018-08-27T17:22:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25111#issuecomment-383182",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:22" align="right">comment:22</div>

Replying to [@embray](#comment:18):

> If I delete all those nonsense `mathjax` hardlinks I then get:
> 
> ```
> $ du -sh local/share/doc/sage/html/
> 779M    local/share/doc/sage/html/
> ```

By the way, after using the script in [comment:2](#comment:2), I get

```
$ du -s -h local/share/doc/sage/html/
315M	local/share/doc/sage/html/
```
There are lots of symlinks, though.



---

archive/issue_comments_383183.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nI'm getting really confused here. Initially I thought that the problem was the `_static` directories in the reference manual were no longer symlinked, but that's not the problem.\n\nThe problem seems to be the few copies of `_static` for the various documents (one for each document). This was never a problem before, as long as `_static` remained small. But because of the `mathjax` issue, every `_static` directory contains a million copies of `mathjax`.",
    "created_at": "2018-08-28T14:24:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25111#issuecomment-383183",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:23" align="right">comment:23</div>

I'm getting really confused here. Initially I thought that the problem was the `_static` directories in the reference manual were no longer symlinked, but that's not the problem.

The problem seems to be the few copies of `_static` for the various documents (one for each document). This was never a problem before, as long as `_static` remained small. But because of the `mathjax` issue, every `_static` directory contains a million copies of `mathjax`.



---

archive/issue_comments_383184.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nReplying to [@embray](#comment:18):\n> There is a bug (I have no idea where this comes from) that puts a \"mathjax\" directory in each `_static`, which is a hard link to the mathjax sources (i.e. under `$SAGE_LOCAL/share/mathjax`).\n\nI'm not sure why you think that it's a hard link. On my system (and probably most Unix-like systems), creating a hardlink to a directory is not even allowed. See https://askubuntu.com/questions/210741/why-are-hard-links-not-allowed-for-directories/525129",
    "created_at": "2018-08-28T14:47:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25111#issuecomment-383184",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:24" align="right">comment:24</div>

Replying to [@embray](#comment:18):
> There is a bug (I have no idea where this comes from) that puts a "mathjax" directory in each `_static`, which is a hard link to the mathjax sources (i.e. under `$SAGE_LOCAL/share/mathjax`).

I'm not sure why you think that it's a hard link. On my system (and probably most Unix-like systems), creating a hardlink to a directory is not even allowed. See https://askubuntu.com/questions/210741/why-are-hard-links-not-allowed-for-directories/525129



---

archive/issue_comments_383185.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nI created a new ticket #26152 specifically for the mathjax symlink issue.",
    "created_at": "2018-08-28T14:47:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25111#issuecomment-383185",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:25" align="right">comment:25</div>

I created a new ticket #26152 specifically for the mathjax symlink issue.



---

archive/issue_comments_383186.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nReplying to [@jdemeyer](#comment:24):\n> Replying to [@embray](#comment:18):\n> > There is a bug (I have no idea where this comes from) that puts a \"mathjax\" directory in each `_static`, which is a hard link to the mathjax sources (i.e. under `$SAGE_LOCAL/share/mathjax`).\n\n> \n> I'm not sure why you think that it's a hard link. On my system (and probably most Unix-like systems), creating a hardlink to a directory is not even allowed. See https://askubuntu.com/questions/210741/why-are-hard-links-not-allowed-for-directories/525129\n\nTo clarify: The *directory* is not a hard link but the files under it are, and there were deeply nested directories (I didn't confirm how deep) each containing what I presume were hard links to the files (since deleting them did not actually release much usage of my disk).",
    "created_at": "2018-08-28T14:57:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25111#issuecomment-383186",
    "user": "https://github.com/embray"
}
```

<div id="comment:26" align="right">comment:26</div>

Replying to [@jdemeyer](#comment:24):
> Replying to [@embray](#comment:18):
> > There is a bug (I have no idea where this comes from) that puts a "mathjax" directory in each `_static`, which is a hard link to the mathjax sources (i.e. under `$SAGE_LOCAL/share/mathjax`).

> 
> I'm not sure why you think that it's a hard link. On my system (and probably most Unix-like systems), creating a hardlink to a directory is not even allowed. See https://askubuntu.com/questions/210741/why-are-hard-links-not-allowed-for-directories/525129

To clarify: The *directory* is not a hard link but the files under it are, and there were deeply nested directories (I didn't confirm how deep) each containing what I presume were hard links to the files (since deleting them did not actually release much usage of my disk).



---

archive/issue_comments_383187.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nReplying to [@jdemeyer](#comment:23):\n> I'm getting really confused here. Initially I thought that the problem was the `_static` directories in the reference manual were no longer symlinked, but that's not the problem.\n> \n> The problem seems to be the few copies of `_static` for the various documents (one for each document). This was never a problem before, as long as `_static` remained small. But because of the `mathjax` issue, every `_static` directory contains a million copies of `mathjax`.\n\nAnd as noted above, the `_static` directories for the different documents can actually differ, so we can't (I think) have a single one. But we can symlink the `mathjax` parts in each one. They take up the bulk of the disk space.",
    "created_at": "2018-08-28T20:59:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25111#issuecomment-383187",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:27" align="right">comment:27</div>

Replying to [@jdemeyer](#comment:23):
> I'm getting really confused here. Initially I thought that the problem was the `_static` directories in the reference manual were no longer symlinked, but that's not the problem.
> 
> The problem seems to be the few copies of `_static` for the various documents (one for each document). This was never a problem before, as long as `_static` remained small. But because of the `mathjax` issue, every `_static` directory contains a million copies of `mathjax`.

And as noted above, the `_static` directories for the different documents can actually differ, so we can't (I think) have a single one. But we can symlink the `mathjax` parts in each one. They take up the bulk of the disk space.



---

archive/issue_comments_383188.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nIn a recently built copy of the Sage documentation, there seem to be 27 copies of MathJax installed in various `_static` directories, which translates into about 430 MB of disk space on my computer.",
    "created_at": "2019-02-02T00:39:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25111#issuecomment-383188",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:28" align="right">comment:28</div>

In a recently built copy of the Sage documentation, there seem to be 27 copies of MathJax installed in various `_static` directories, which translates into about 430 MB of disk space on my computer.



---

archive/issue_events_347418.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-12-29T01:42:26Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/25111",
    "milestone_number": null,
    "milestone_title": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25111#event-347418"
}
```
