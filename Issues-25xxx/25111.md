# Issue 25111: In the built documentation, replace duplicate files by symlinks

archive/issues_024874.json:
```json
{
    "body": "Until Sage 8.2, the `_static` directories in the generated HTML documentation of the reference manual were symlinks to a single master `_static` directory. Now all the files are copied, leading to a huge explosion in size of the built documentation (from 1.8GB in Sage 8.2 to about 20GB in Sage 8.3).\n\nCC:  @timokau\n\nIssue created by migration from https://trac.sagemath.org/ticket/25111\n\n",
    "created_at": "2018-04-06T18:50:51Z",
    "labels": [
        "component: documentation",
        "critical"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.4",
    "title": "In the built documentation, replace duplicate files by symlinks",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25111",
    "user": "https://github.com/jhpalmieri"
}
```
Until Sage 8.2, the `_static` directories in the generated HTML documentation of the reference manual were symlinks to a single master `_static` directory. Now all the files are copied, leading to a huge explosion in size of the built documentation (from 1.8GB in Sage 8.2 to about 20GB in Sage 8.3).

CC:  @timokau

Issue created by migration from https://trac.sagemath.org/ticket/25111





---

archive/issue_comments_349162.json:
```json
{
    "body": "<a id='comment:1'></a>I actually do this in sage-on-gentoo, but I do it at the packaging level rather than the building level.",
    "created_at": "2018-04-06T19:46:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25111#issuecomment-349162",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:1'></a>I actually do this in sage-on-gentoo, but I do it at the packaging level rather than the building level.



---

archive/issue_comments_349163.json:
```json
{
    "body": "<a id='comment:2'></a>Here is some Python code which works for me. Is this the sort of thing you use?\n\n```python\nfrom filecmp import dircmp\nimport os, shutil\n\ndef directories_equal(left, right, ignore=None):\n    \"\"\"\n    True if and only if the directories ``left`` and ``right`` have\n    the same contents, file by file. Ignore any files listed in\n    ``ignore``.\n    \"\"\"\n    dcmp = dircmp(left, right, ignore=ignore)\n    return (not dcmp.left_only and not dcmp.right_only \n            and not dcmp.common_funny and not dcmp.funny_files\n            and not dcmp.diff_files and \n            all(directories_equal(os.path.join(left, a), os.path.join(right, a), ignore=ignore) \n                for a in dcmp.common_dirs))\n\n\ndef replace_duplicates_with_symlinks(source, target):\n    \"\"\"\n    INPUTS:\n\n    - ``source``, ``target``: directories.\n\n    If the two directories are identical, replace ``target`` with a\n    symlink pointing to ``source``. Otherwise, for each file in\n    ``target``, if a copy of it exists in ``source``, replace the copy\n    in ``target`` with a symlink pointing to ``source``.  \n    \"\"\"\n    if directories_equal(source, target, ignore=['pdf.png']):\n        if not os.path.islink(target):\n            shutil.rmtree(target)\n            os.symlink(source, target)\n    else:\n        # compare file by file, doing the replacement\n        dcmp = dircmp(source, target)\n        for d in dcmp.common_dirs:\n            replace_duplicates_with_symlinks(os.path.join(source, d),\n                                             os.path.join(target, d))\n        for f in dcmp.common_files:\n            os.remove(os.path.join(target, f))\n            os.symlink(os.path.join(source, f),\n                       os.path.join(target, f))\n    \n\ndef replace_with_master_directory(top_dir):\n    \"\"\"\n    top_dir: top of html doc directory (so typically \n    top_dir = local/share/doc/sage/html)\n    \"\"\"\n    master = os.path.join(top_dir, 'en', '_static')\n    for lang in os.listdir(top_dir):\n        for d in os.listdir(os.path.join(top_dir, lang)):\n            target = os.path.join(top_dir, lang, d, '_static')\n            if (os.path.isdir(target) \n                and not os.path.islink(target) \n                and not os.path.samefile(master, target)):\n                replace_duplicates_with_symlinks(master, target)\n\n```",
    "created_at": "2018-04-06T20:25:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25111#issuecomment-349163",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:2'></a>Here is some Python code which works for me. Is this the sort of thing you use?

```python
from filecmp import dircmp
import os, shutil

def directories_equal(left, right, ignore=None):
    """
    True if and only if the directories ``left`` and ``right`` have
    the same contents, file by file. Ignore any files listed in
    ``ignore``.
    """
    dcmp = dircmp(left, right, ignore=ignore)
    return (not dcmp.left_only and not dcmp.right_only 
            and not dcmp.common_funny and not dcmp.funny_files
            and not dcmp.diff_files and 
            all(directories_equal(os.path.join(left, a), os.path.join(right, a), ignore=ignore) 
                for a in dcmp.common_dirs))


def replace_duplicates_with_symlinks(source, target):
    """
    INPUTS:

    - ``source``, ``target``: directories.

    If the two directories are identical, replace ``target`` with a
    symlink pointing to ``source``. Otherwise, for each file in
    ``target``, if a copy of it exists in ``source``, replace the copy
    in ``target`` with a symlink pointing to ``source``.  
    """
    if directories_equal(source, target, ignore=['pdf.png']):
        if not os.path.islink(target):
            shutil.rmtree(target)
            os.symlink(source, target)
    else:
        # compare file by file, doing the replacement
        dcmp = dircmp(source, target)
        for d in dcmp.common_dirs:
            replace_duplicates_with_symlinks(os.path.join(source, d),
                                             os.path.join(target, d))
        for f in dcmp.common_files:
            os.remove(os.path.join(target, f))
            os.symlink(os.path.join(source, f),
                       os.path.join(target, f))
    

def replace_with_master_directory(top_dir):
    """
    top_dir: top of html doc directory (so typically 
    top_dir = local/share/doc/sage/html)
    """
    master = os.path.join(top_dir, 'en', '_static')
    for lang in os.listdir(top_dir):
        for d in os.listdir(os.path.join(top_dir, lang)):
            target = os.path.join(top_dir, lang, d, '_static')
            if (os.path.isdir(target) 
                and not os.path.islink(target) 
                and not os.path.samefile(master, target)):
                replace_duplicates_with_symlinks(master, target)

```



---

archive/issue_comments_349164.json:
```json
{
    "body": "<a id='comment:3'></a>This saves me almost 400 MB, by the way. (\"This\" = `replace_with_master_directory(os.path.join(SAGE_LOCAL, 'share', 'doc', 'sage', 'html'))`.)",
    "created_at": "2018-04-06T20:32:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25111#issuecomment-349164",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:3'></a>This saves me almost 400 MB, by the way. ("This" = `replace_with_master_directory(os.path.join(SAGE_LOCAL, 'share', 'doc', 'sage', 'html'))`.)



---

archive/issue_comments_349165.json:
```json
{
    "body": "<a id='comment:4'></a>No I don't use python code because I do it within the packaging script in bash\n\n```\n\t\t\t# Prune _static folders\n\t\t\tcp -r build_doc/html/en/_static build_doc/html/ || die \"failed to copy _static folder\"\n\t\t\tfor sdir in `find build_doc/html -name _static` ; do\n\t\t\t\tif [ $sdir != \"build_doc/html/_static\" ] ; then\n\t\t\t\t\trm -rf $sdir || die \"failed to remove $sdir\"\n\t\t\t\t\tln -rst ${sdir%_static} build_doc/html/_static\n\t\t\t\tfi\n\t\t\tdone\n```\nbecause I have the mathjax fonts by default and they are copied in all `_static` directories, the saving is in GB.\n\nThe last touch is replacing most of the mathjax stuff by symlink in the master _static folder\n\n```\n\t\t\t# Linking to local copy of mathjax folders rather than copying them\n\t\t\tlocal mathjax_folders=\"config extensions fonts jax localization unpacked\"\n\t\t\tfor sdir in ${mathjax_folders} ; do\n\t\t\t\trm -rf build_doc/html/_static/${sdir} \\\n\t\t\t\t\t|| die \"failed to remove mathjax folder $sdir\"\n\t\t\t\tln -st build_doc/html/_static/ ../../../../mathjax/$sdir\n\t\t\tdone\n```",
    "created_at": "2018-04-06T20:48:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25111#issuecomment-349165",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:4'></a>No I don't use python code because I do it within the packaging script in bash

```
			# Prune _static folders
			cp -r build_doc/html/en/_static build_doc/html/ || die "failed to copy _static folder"
			for sdir in `find build_doc/html -name _static` ; do
				if [ $sdir != "build_doc/html/_static" ] ; then
					rm -rf $sdir || die "failed to remove $sdir"
					ln -rst ${sdir%_static} build_doc/html/_static
				fi
			done
```
because I have the mathjax fonts by default and they are copied in all `_static` directories, the saving is in GB.

The last touch is replacing most of the mathjax stuff by symlink in the master _static folder

```
			# Linking to local copy of mathjax folders rather than copying them
			local mathjax_folders="config extensions fonts jax localization unpacked"
			for sdir in ${mathjax_folders} ; do
				rm -rf build_doc/html/_static/${sdir} \
					|| die "failed to remove mathjax folder $sdir"
				ln -st build_doc/html/_static/ ../../../../mathjax/$sdir
			done
```



---

archive/issue_comments_349166.json:
```json
{
    "body": "<a id='comment:5'></a>See possibly related discussion at #25089.",
    "created_at": "2018-04-07T14:18:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25111#issuecomment-349166",
    "user": "https://github.com/slel"
}
```

<a id='comment:5'></a>See possibly related discussion at #25089.



---

archive/issue_comments_349167.json:
```json
{
    "body": "<a id='comment:6'></a>I'm confused by this ticket, because it already does that, per #25089...",
    "created_at": "2018-04-09T09:19:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25111#issuecomment-349167",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>I'm confused by this ticket, because it already does that, per #25089...



---

archive/issue_comments_349168.json:
```json
{
    "body": "<a id='comment:7'></a>I see the difference--it does already do this within the `en/reference` docs, where each \"reference\" section is treated as a sub-document of the reference \"master document\", and in that case the `_static` directories get symlinked up to the master document.  My assumption was that all of the Sage docs (including \"reference\") were in turn treated as sub-documents of a higher-level master document but apparently that's not the case.\n\nIMO treating the entire tree of Sage docs as such a hierarchy with shared static resources would be the best approach.",
    "created_at": "2018-04-09T09:23:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25111#issuecomment-349168",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>I see the difference--it does already do this within the `en/reference` docs, where each "reference" section is treated as a sub-document of the reference "master document", and in that case the `_static` directories get symlinked up to the master document.  My assumption was that all of the Sage docs (including "reference") were in turn treated as sub-documents of a higher-level master document but apparently that's not the case.

IMO treating the entire tree of Sage docs as such a hierarchy with shared static resources would be the best approach.



---

archive/issue_comments_349169.json:
```json
{
    "body": "<a id='comment:8'></a>Some parts of the documentation tree have slightly different `_static` directories, which is where the approach in comment 2 comes from: compare each `_static` directory to the top-level one, replacing files (and directories) with symlinks when possible.",
    "created_at": "2018-05-22T23:21:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25111#issuecomment-349169",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:8'></a>Some parts of the documentation tree have slightly different `_static` directories, which is where the approach in comment 2 comes from: compare each `_static` directory to the top-level one, replacing files (and directories) with symlinks when possible.



---

archive/issue_comments_349170.json:
```json
{
    "body": "<a id='comment:9'></a>Is it worth pursuing this? It could be part of the docbuild process, or it could be done only when you use `make` to build all of the Sage docs. I'm leaning toward the latter approach. In either case, all of the `_static` directories will be produced and then cleaned up later, so disk usage will increase during the build process before dropping at the end, although this happens throughout the build process. (I don't know how to deal with the symlinks on the fly. I also don't know if there is a way to tell Sphinx to look mainly in one place for shared static resources. Since documentation in different languages have different `_static/translations.js` files, we can't rely solely on a single `_static` folder.)\n\nI also don't know what to do about Windows/cygwin and symbolic links.",
    "created_at": "2018-05-23T21:28:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25111#issuecomment-349170",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:9'></a>Is it worth pursuing this? It could be part of the docbuild process, or it could be done only when you use `make` to build all of the Sage docs. I'm leaning toward the latter approach. In either case, all of the `_static` directories will be produced and then cleaned up later, so disk usage will increase during the build process before dropping at the end, although this happens throughout the build process. (I don't know how to deal with the symlinks on the fly. I also don't know if there is a way to tell Sphinx to look mainly in one place for shared static resources. Since documentation in different languages have different `_static/translations.js` files, we can't rely solely on a single `_static` folder.)

I also don't know what to do about Windows/cygwin and symbolic links.



---

archive/issue_comments_349171.json:
```json
{
    "body": "<a id='comment:10'></a>Sphinx has a configuration option [html_static_path](http://www.sphinx-doc.org/en/master/usage/configuration.html#confval-html_static_path) which might do what we want. I'll look into it.\n\nEdit: or maybe not: the documentation says that the files \"are copied to the output\u2019s _static directory after the theme\u2019s static files\". We don't want files copied, we want a single `_static` directory.",
    "created_at": "2018-05-23T21:30:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25111#issuecomment-349171",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:10'></a>Sphinx has a configuration option [html_static_path](http://www.sphinx-doc.org/en/master/usage/configuration.html#confval-html_static_path) which might do what we want. I'll look into it.

Edit: or maybe not: the documentation says that the files "are copied to the output’s _static directory after the theme’s static files". We don't want files copied, we want a single `_static` directory.



---

archive/issue_comments_349172.json:
```json
{
    "body": "<a id='comment:11'></a>Couldn't a different `_static/translations.js` be used per language?  That is, somehow namespace that file by the language in the first place.  That or at least have an alternate location for it. `html_static_path` can be a list.",
    "created_at": "2018-05-31T14:40:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25111#issuecomment-349172",
    "user": "https://github.com/embray"
}
```

<a id='comment:11'></a>Couldn't a different `_static/translations.js` be used per language?  That is, somehow namespace that file by the language in the first place.  That or at least have an alternate location for it. `html_static_path` can be a list.



---

archive/issue_comments_349173.json:
```json
{
    "body": "<a id='comment:12'></a>I don't think that `html_static_path` will help: it provides a list from which the output `_static` directories are produced \u2013 it does not provide a list of directories to use instead of the output `_static` directories. In fact, we already set `html_static_path` in `src/doc/common/conf.py`.",
    "created_at": "2018-05-31T14:57:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25111#issuecomment-349173",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:12'></a>I don't think that `html_static_path` will help: it provides a list from which the output `_static` directories are produced – it does not provide a list of directories to use instead of the output `_static` directories. In fact, we already set `html_static_path` in `src/doc/common/conf.py`.



---

archive/issue_events_062988.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-08-24T06:09:46Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25111",
    "milestone": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25111#event-62988"
}
```



---

archive/issue_comments_349174.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2018-08-24T06:09:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25111#issuecomment-349174",
    "user": "https://github.com/jdemeyer"
}
```

Changing priority from major to critical.



---

archive/issue_comments_349175.json:
```json
{
    "body": "<a id='comment:14'></a>Too bad that I missed this ticket earlier. This should have been an 8.3 blocker.",
    "created_at": "2018-08-24T08:35:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25111#issuecomment-349175",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>Too bad that I missed this ticket earlier. This should have been an 8.3 blocker.



---

archive/issue_comments_349176.json:
```json
{
    "body": "<a id='comment:15'></a>As a workaround to #25089, for the Windows build I run a script that deletes all the duplicate `_static` directories and instead modifies links in the HTML to reference a single `_static` directory.  My script just runs over the docs after they've been built, but it would probably be better to figure out how to do this directly in the Sphinx build.",
    "created_at": "2018-08-24T09:41:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25111#issuecomment-349176",
    "user": "https://github.com/embray"
}
```

<a id='comment:15'></a>As a workaround to #25089, for the Windows build I run a script that deletes all the duplicate `_static` directories and instead modifies links in the HTML to reference a single `_static` directory.  My script just runs over the docs after they've been built, but it would probably be better to figure out how to do this directly in the Sphinx build.



---

archive/issue_comments_349177.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:15 embray]:\n> As a workaround to #25089, for the Windows build I run a script that deletes all the duplicate `_static` directories and instead modifies links in the HTML to reference a single `_static` directory.  My script just runs over the docs after they've been built, but it would probably be better to figure out how to do this directly in the Sphinx build.\n\n\nI do exactly that in sage-on-gentoo as well. Would be great to know how to tell sphinx to create symlinks instead of copying.",
    "created_at": "2018-08-24T09:44:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25111#issuecomment-349177",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:16'></a>Replying to [comment:15 embray]:
> As a workaround to #25089, for the Windows build I run a script that deletes all the duplicate `_static` directories and instead modifies links in the HTML to reference a single `_static` directory.  My script just runs over the docs after they've been built, but it would probably be better to figure out how to do this directly in the Sphinx build.


I do exactly that in sage-on-gentoo as well. Would be great to know how to tell sphinx to create symlinks instead of copying.



---

archive/issue_comments_349178.json:
```json
{
    "body": "<a id='comment:18'></a>Replying to [comment:14 jdemeyer]:\n> Too bad that I missed this ticket earlier. This should have been an 8.3 blocker.\n\n\nBy the way, that 20GB figure is not really how much disk space is being taken up.  There is a bug (I have no idea where this comes from) that puts a \"mathjax\" directory in each `_static`, which is a hard link to the mathjax sources (i.e. under `$SAGE_LOCAL/share/mathjax`).  This inexplicably contains a symlink to itself as `$SAGE_LOCAL/share/mathjax/mathjax`.  In the `_static` directories, however, this symlink is being dereferenced and converted to a hard link as well, so you end up with an infinite loop of hardlinks, which tools like `du` don't handle well when counting (the size it's reporting is probably just being limited by some max depth parameter).\n\nIf I delete all those nonsense `mathjax` hardlinks I then get:\n\n```\n$ du -sh local/share/doc/sage/html/\n779M    local/share/doc/sage/html/\n```\n\nand\n\n```\n$ du -sh local/share/doc/sage/\n2.0G    local/share/doc/sage/\n```\n\nso I think it's not all as bad as it seems.",
    "created_at": "2018-08-24T10:05:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25111#issuecomment-349178",
    "user": "https://github.com/embray"
}
```

<a id='comment:18'></a>Replying to [comment:14 jdemeyer]:
> Too bad that I missed this ticket earlier. This should have been an 8.3 blocker.


By the way, that 20GB figure is not really how much disk space is being taken up.  There is a bug (I have no idea where this comes from) that puts a "mathjax" directory in each `_static`, which is a hard link to the mathjax sources (i.e. under `$SAGE_LOCAL/share/mathjax`).  This inexplicably contains a symlink to itself as `$SAGE_LOCAL/share/mathjax/mathjax`.  In the `_static` directories, however, this symlink is being dereferenced and converted to a hard link as well, so you end up with an infinite loop of hardlinks, which tools like `du` don't handle well when counting (the size it's reporting is probably just being limited by some max depth parameter).

If I delete all those nonsense `mathjax` hardlinks I then get:

```
$ du -sh local/share/doc/sage/html/
779M    local/share/doc/sage/html/
```

and

```
$ du -sh local/share/doc/sage/
2.0G    local/share/doc/sage/
```

so I think it's not all as bad as it seems.



---

archive/issue_comments_349179.json:
```json
{
    "body": "<a id='comment:20'></a>I see now your sage-devel post where you reported the same.",
    "created_at": "2018-08-24T12:50:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25111#issuecomment-349179",
    "user": "https://github.com/embray"
}
```

<a id='comment:20'></a>I see now your sage-devel post where you reported the same.



---

archive/issue_comments_349180.json:
```json
{
    "body": "<a id='comment:21'></a>It seems to be more subtle: sometimes the symlinks are correctly generated and sometimes not.",
    "created_at": "2018-08-27T07:01:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25111#issuecomment-349180",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'></a>It seems to be more subtle: sometimes the symlinks are correctly generated and sometimes not.



---

archive/issue_comments_349181.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [comment:18 embray]:\n\n> If I delete all those nonsense `mathjax` hardlinks I then get:\n> \n> \n> ```\n> $ du -sh local/share/doc/sage/html/\n> 779M    local/share/doc/sage/html/\n> ```\n\n\nBy the way, after using the script in comment:2, I get\n\n```\n$ du -s -h local/share/doc/sage/html/\n315M\tlocal/share/doc/sage/html/\n```\nThere are lots of symlinks, though.",
    "created_at": "2018-08-27T17:22:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25111#issuecomment-349181",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:22'></a>Replying to [comment:18 embray]:

> If I delete all those nonsense `mathjax` hardlinks I then get:
> 
> 
> ```
> $ du -sh local/share/doc/sage/html/
> 779M    local/share/doc/sage/html/
> ```


By the way, after using the script in comment:2, I get

```
$ du -s -h local/share/doc/sage/html/
315M	local/share/doc/sage/html/
```
There are lots of symlinks, though.



---

archive/issue_comments_349182.json:
```json
{
    "body": "<a id='comment:23'></a>I'm getting really confused here. Initially I thought that the problem was the `_static` directories in the reference manual were no longer symlinked, but that's not the problem.\n\nThe problem seems to be the few copies of `_static` for the various documents (one for each document). This was never a problem before, as long as `_static` remained small. But because of the `mathjax` issue, every `_static` directory contains a million copies of `mathjax`.",
    "created_at": "2018-08-28T14:24:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25111#issuecomment-349182",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:23'></a>I'm getting really confused here. Initially I thought that the problem was the `_static` directories in the reference manual were no longer symlinked, but that's not the problem.

The problem seems to be the few copies of `_static` for the various documents (one for each document). This was never a problem before, as long as `_static` remained small. But because of the `mathjax` issue, every `_static` directory contains a million copies of `mathjax`.



---

archive/issue_comments_349183.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [comment:18 embray]:\n> There is a bug (I have no idea where this comes from) that puts a \"mathjax\" directory in each `_static`, which is a hard link to the mathjax sources (i.e. under `$SAGE_LOCAL/share/mathjax`).\n\n\nI'm not sure why you think that it's a hard link. On my system (and probably most Unix-like systems), creating a hardlink to a directory is not even allowed. See https://askubuntu.com/questions/210741/why-are-hard-links-not-allowed-for-directories/525129",
    "created_at": "2018-08-28T14:47:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25111#issuecomment-349183",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'></a>Replying to [comment:18 embray]:
> There is a bug (I have no idea where this comes from) that puts a "mathjax" directory in each `_static`, which is a hard link to the mathjax sources (i.e. under `$SAGE_LOCAL/share/mathjax`).


I'm not sure why you think that it's a hard link. On my system (and probably most Unix-like systems), creating a hardlink to a directory is not even allowed. See https://askubuntu.com/questions/210741/why-are-hard-links-not-allowed-for-directories/525129



---

archive/issue_comments_349184.json:
```json
{
    "body": "<a id='comment:25'></a>I created a new ticket #26152 specifically for the mathjax symlink issue.",
    "created_at": "2018-08-28T14:47:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25111#issuecomment-349184",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:25'></a>I created a new ticket #26152 specifically for the mathjax symlink issue.



---

archive/issue_comments_349185.json:
```json
{
    "body": "<a id='comment:26'></a>Replying to [comment:24 jdemeyer]:\n> Replying to [comment:18 embray]:\n> > There is a bug (I have no idea where this comes from) that puts a \"mathjax\" directory in each `_static`, which is a hard link to the mathjax sources (i.e. under `$SAGE_LOCAL/share/mathjax`).\n\n> \n> I'm not sure why you think that it's a hard link. On my system (and probably most Unix-like systems), creating a hardlink to a directory is not even allowed. See https://askubuntu.com/questions/210741/why-are-hard-links-not-allowed-for-directories/525129\n\n\nTo clarify: The *directory* is not a hard link but the files under it are, and there were deeply nested directories (I didn't confirm how deep) each containing what I presume were hard links to the files (since deleting them did not actually release much usage of my disk).",
    "created_at": "2018-08-28T14:57:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25111#issuecomment-349185",
    "user": "https://github.com/embray"
}
```

<a id='comment:26'></a>Replying to [comment:24 jdemeyer]:
> Replying to [comment:18 embray]:
> > There is a bug (I have no idea where this comes from) that puts a "mathjax" directory in each `_static`, which is a hard link to the mathjax sources (i.e. under `$SAGE_LOCAL/share/mathjax`).

> 
> I'm not sure why you think that it's a hard link. On my system (and probably most Unix-like systems), creating a hardlink to a directory is not even allowed. See https://askubuntu.com/questions/210741/why-are-hard-links-not-allowed-for-directories/525129


To clarify: The *directory* is not a hard link but the files under it are, and there were deeply nested directories (I didn't confirm how deep) each containing what I presume were hard links to the files (since deleting them did not actually release much usage of my disk).



---

archive/issue_comments_349186.json:
```json
{
    "body": "<a id='comment:27'></a>Replying to [comment:23 jdemeyer]:\n> I'm getting really confused here. Initially I thought that the problem was the `_static` directories in the reference manual were no longer symlinked, but that's not the problem.\n> \n> The problem seems to be the few copies of `_static` for the various documents (one for each document). This was never a problem before, as long as `_static` remained small. But because of the `mathjax` issue, every `_static` directory contains a million copies of `mathjax`.\n\n\nAnd as noted above, the `_static` directories for the different documents can actually differ, so we can't (I think) have a single one. But we can symlink the `mathjax` parts in each one. They take up the bulk of the disk space.",
    "created_at": "2018-08-28T20:59:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25111#issuecomment-349186",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:27'></a>Replying to [comment:23 jdemeyer]:
> I'm getting really confused here. Initially I thought that the problem was the `_static` directories in the reference manual were no longer symlinked, but that's not the problem.
> 
> The problem seems to be the few copies of `_static` for the various documents (one for each document). This was never a problem before, as long as `_static` remained small. But because of the `mathjax` issue, every `_static` directory contains a million copies of `mathjax`.


And as noted above, the `_static` directories for the different documents can actually differ, so we can't (I think) have a single one. But we can symlink the `mathjax` parts in each one. They take up the bulk of the disk space.



---

archive/issue_comments_349187.json:
```json
{
    "body": "<a id='comment:28'></a>In a recently built copy of the Sage documentation, there seem to be 27 copies of MathJax installed in various `_static` directories, which translates into about 430 MB of disk space on my computer.",
    "created_at": "2019-02-02T00:39:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25111",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25111#issuecomment-349187",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:28'></a>In a recently built copy of the Sage documentation, there seem to be 27 copies of MathJax installed in various `_static` directories, which translates into about 430 MB of disk space on my computer.
