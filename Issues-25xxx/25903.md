# Issue 25903: fix Macaulay2 output when reading input from a file

archive/issues_025666.json:
```json
{
    "body": "This ticket solves the discrepancy between evaluating Macaulay2 input using a file vs directly as follows:\n\nIt is solved by using the Macaulay2 function `input` instead of `load` to read in files. With `input`, the results are echoed as desired. However, `input` also echoes the input lines. These echoed input lines need to be stripped from the output \u2013 this is accomplished by setting a custom input prompt while reading from a file. The input lines are then stripped in `_post_process_from_file`.\n\n---\n\nIf I run \n\n```python\nmacaulay2.eval(';'.join([\n'R = ZZ/101[x000, x001, x010, x011, x100, x101, x110, x111, DegreeRank=>8]', \n'idl77 = module ideal(x000*x010*x100*x110, x000*x010*x101*x111, x000*x011*x100*x111, x000*x011*x101*x111, x001*x010*x101*x110, x001*x010*x101*x111, x001*x011*x100*x110, x001*x011*x100*x111, x001*x011*x101*x110, x001*x011*x101*x111)', \n'res77 = res idl77']))\n```\nI get back the correct answer in sage.\n\n```\n 10      16      8      1\nR   <-- R   <-- R  <-- R  <-- 0\n                               \n0       1       2      3      4\n\nChainComplex\n```\n\nHowever if I try a larger ring and ideal,\n\n```python\nmacaulay2.eval(';'.join([\n'R = ZZ/101[x0000, x0001, x0010, x0011, x0100, x0101, x0110, x0111, x1000, x1001, x1010, x1011, x1100, x1101, x1110, x1111, DegreeRank=>16]',\n'idl111 = module ideal(x0000*x0010*x0100*x0110*x1000*x1010*x1100*x1110, x0000*x0010*x0100*x0110*x1001*x1011*x1101*x1111, x0000*x0010*x0101*x0111*x1000*x1010*x1101*x1111, x0000*x0010*x0101*x0111*x1001*x1011*x1101*x1111, x0000*x0011*x0100*x0111*x1000*x1011*x1100*x1111, x0000*x0011*x0100*x0111*x1001*x1011*x1101*x1111, x0000*x0011*x0101*x0111*x1000*x1011*x1101*x1111, x0000*x0011*x0101*x0111*x1001*x1011*x1101*x1111, x0001*x0010*x0101*x0110*x1001*x1010*x1101*x1110, x0001*x0010*x0101*x0110*x1001*x1011*x1101*x1111, x0001*x0010*x0101*x0111*x1001*x1010*x1101*x1111, x0001*x0010*x0101*x0111*x1001*x1011*x1101*x1111, x0001*x0011*x0100*x0110*x1001*x1011*x1100*x1110, x0001*x0011*x0100*x0110*x1001*x1011*x1101*x1111, x0001*x0011*x0100*x0111*x1001*x1011*x1100*x1111, x0001*x0011*x0100*x0111*x1001*x1011*x1101*x1111, x0001*x0011*x0101*x0110*x1001*x1011*x1101*x1110, x0001*x0011*x0101*x0110*x1001*x1011*x1101*x1111, x0001*x0011*x0101*x0111*x1000*x1010*x1100*x1110, x0001*x0011*x0101*x0111*x1000*x1010*x1101*x1111, x0001*x0011*x0101*x0111*x1000*x1011*x1100*x1111, x0001*x0011*x0101*x0111*x1000*x1011*x1101*x1111, x0001*x0011*x0101*x0111*x1001*x1010*x1101*x1110, x0001*x0011*x0101*x0111*x1001*x1010*x1101*x1111, x0001*x0011*x0101*x0111*x1001*x1011*x1100*x1110, x0001*x0011*x0101*x0111*x1001*x1011*x1100*x1111, x0001*x0011*x0101*x0111*x1001*x1011*x1101*x1110, x0001*x0011*x0101*x0111*x1001*x1011*x1101*x1111)',\n'res111 = res idl111'\n]\n))\n```\nthen I get back an empty string.\nHowever, if I rerun\n\n```python\nmacaulay2.eval('res111 = res idl111')\n```\nin the second case I'll get back the right answer.\n\nI checked that both commands give the correct answers inside macaulay2, so it must be a bug in the bridge.\n\n**CC:**  @mwageringel @slel @dimpase @saliola @antonleykin\n\n**Keywords:** Macaulay2, interface, IMA Coding Sprint\n\n**Branch/Commit:** [496ea55bc63dd6e58e7245245965dd161b212a47](https://github.com/sagemath/sagetrac-mirror/commit/496ea55bc63dd6e58e7245245965dd161b212a47)\n\n**Reviewer:** Dima Pasechnik\n\n**Author:** Markus Wageringel\n\nIssue created by migration from https://trac.sagemath.org/ticket/25903\n\n",
    "closed_at": "2020-01-09T23:44:38Z",
    "created_at": "2018-07-23T03:29:13Z",
    "labels": [
        "component: interfaces: optional",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "fix Macaulay2 output when reading input from a file",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25903",
    "user": "https://github.com/eulerreich"
}
```
This ticket solves the discrepancy between evaluating Macaulay2 input using a file vs directly as follows:

It is solved by using the Macaulay2 function `input` instead of `load` to read in files. With `input`, the results are echoed as desired. However, `input` also echoes the input lines. These echoed input lines need to be stripped from the output – this is accomplished by setting a custom input prompt while reading from a file. The input lines are then stripped in `_post_process_from_file`.

---

If I run 

```python
macaulay2.eval(';'.join([
'R = ZZ/101[x000, x001, x010, x011, x100, x101, x110, x111, DegreeRank=>8]', 
'idl77 = module ideal(x000*x010*x100*x110, x000*x010*x101*x111, x000*x011*x100*x111, x000*x011*x101*x111, x001*x010*x101*x110, x001*x010*x101*x111, x001*x011*x100*x110, x001*x011*x100*x111, x001*x011*x101*x110, x001*x011*x101*x111)', 
'res77 = res idl77']))
```
I get back the correct answer in sage.

```
 10      16      8      1
R   <-- R   <-- R  <-- R  <-- 0
                               
0       1       2      3      4

ChainComplex
```

However if I try a larger ring and ideal,

```python
macaulay2.eval(';'.join([
'R = ZZ/101[x0000, x0001, x0010, x0011, x0100, x0101, x0110, x0111, x1000, x1001, x1010, x1011, x1100, x1101, x1110, x1111, DegreeRank=>16]',
'idl111 = module ideal(x0000*x0010*x0100*x0110*x1000*x1010*x1100*x1110, x0000*x0010*x0100*x0110*x1001*x1011*x1101*x1111, x0000*x0010*x0101*x0111*x1000*x1010*x1101*x1111, x0000*x0010*x0101*x0111*x1001*x1011*x1101*x1111, x0000*x0011*x0100*x0111*x1000*x1011*x1100*x1111, x0000*x0011*x0100*x0111*x1001*x1011*x1101*x1111, x0000*x0011*x0101*x0111*x1000*x1011*x1101*x1111, x0000*x0011*x0101*x0111*x1001*x1011*x1101*x1111, x0001*x0010*x0101*x0110*x1001*x1010*x1101*x1110, x0001*x0010*x0101*x0110*x1001*x1011*x1101*x1111, x0001*x0010*x0101*x0111*x1001*x1010*x1101*x1111, x0001*x0010*x0101*x0111*x1001*x1011*x1101*x1111, x0001*x0011*x0100*x0110*x1001*x1011*x1100*x1110, x0001*x0011*x0100*x0110*x1001*x1011*x1101*x1111, x0001*x0011*x0100*x0111*x1001*x1011*x1100*x1111, x0001*x0011*x0100*x0111*x1001*x1011*x1101*x1111, x0001*x0011*x0101*x0110*x1001*x1011*x1101*x1110, x0001*x0011*x0101*x0110*x1001*x1011*x1101*x1111, x0001*x0011*x0101*x0111*x1000*x1010*x1100*x1110, x0001*x0011*x0101*x0111*x1000*x1010*x1101*x1111, x0001*x0011*x0101*x0111*x1000*x1011*x1100*x1111, x0001*x0011*x0101*x0111*x1000*x1011*x1101*x1111, x0001*x0011*x0101*x0111*x1001*x1010*x1101*x1110, x0001*x0011*x0101*x0111*x1001*x1010*x1101*x1111, x0001*x0011*x0101*x0111*x1001*x1011*x1100*x1110, x0001*x0011*x0101*x0111*x1001*x1011*x1100*x1111, x0001*x0011*x0101*x0111*x1001*x1011*x1101*x1110, x0001*x0011*x0101*x0111*x1001*x1011*x1101*x1111)',
'res111 = res idl111'
]
))
```
then I get back an empty string.
However, if I rerun

```python
macaulay2.eval('res111 = res idl111')
```
in the second case I'll get back the right answer.

I checked that both commands give the correct answers inside macaulay2, so it must be a bug in the bridge.

**CC:**  @mwageringel @slel @dimpase @saliola @antonleykin

**Keywords:** Macaulay2, interface, IMA Coding Sprint

**Branch/Commit:** [496ea55bc63dd6e58e7245245965dd161b212a47](https://github.com/sagemath/sagetrac-mirror/commit/496ea55bc63dd6e58e7245245965dd161b212a47)

**Reviewer:** Dima Pasechnik

**Author:** Markus Wageringel

Issue created by migration from https://trac.sagemath.org/ticket/25903





---

archive/issue_comments_475024.json:
```json
{
    "body": "**Changing keywords** from \"\" to \"Macaulay2, interface\".",
    "created_at": "2018-07-24T11:44:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25903",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25903#issuecomment-475024",
    "user": "https://github.com/slel"
}
```

**Changing keywords** from "" to "Macaulay2, interface".



---

archive/issue_comments_475025.json:
```json
{
    "body": "<a id='comment:1'></a>\nSee also:\n- #25885 Fixes for outdated Macaulay2 interface",
    "created_at": "2018-07-24T11:44:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25903",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25903#issuecomment-475025",
    "user": "https://github.com/slel"
}
```

<a id='comment:1'></a>
See also:
- #25885 Fixes for outdated Macaulay2 interface



---

archive/issue_comments_475026.json:
```json
{
    "body": "<a id='comment:2'></a>\nThis happens when the input string sent to eval is longer than 500 characters, as the Macaulay2-Expect interface is configured with the option `eval_using_file_cutoff=500`. This option determines whether the input is pasted into the Macaulay2 REPL directly for short input, or whether it is first written to a file and then loaded into Macaulay2. Loading the file is implemented using the `load` command, which exectues the code, but does not echo the output values in Macaulay2, so this results in an empty string returned by eval.\n\nI tried to replace the `load` command by the `input` command which does echo the output values \u2013 however, it also echoes the input on additional input lines. This makes it rather difficult to handle using the Expect interface as parsing the output stops once it reaches the first input prompt. I could not figure out how to solve this.\n\nThe only way to fix this I can think of would be to add a function to Macaulay2 that just echoes the output of a file.\n\nAs a workaround, you can call `macaulay2(\"res111\")` or call print at the end of your Macaulay2 code like `print res idl111`.",
    "created_at": "2018-07-24T20:12:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25903",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25903#issuecomment-475026",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:2'></a>
This happens when the input string sent to eval is longer than 500 characters, as the Macaulay2-Expect interface is configured with the option `eval_using_file_cutoff=500`. This option determines whether the input is pasted into the Macaulay2 REPL directly for short input, or whether it is first written to a file and then loaded into Macaulay2. Loading the file is implemented using the `load` command, which exectues the code, but does not echo the output values in Macaulay2, so this results in an empty string returned by eval.

I tried to replace the `load` command by the `input` command which does echo the output values – however, it also echoes the input on additional input lines. This makes it rather difficult to handle using the Expect interface as parsing the output stops once it reaches the first input prompt. I could not figure out how to solve this.

The only way to fix this I can think of would be to add a function to Macaulay2 that just echoes the output of a file.

As a workaround, you can call `macaulay2("res111")` or call print at the end of your Macaulay2 code like `print res idl111`.



---

archive/issue_events_073933.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2019-10-07T03:45:19Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25903",
    "milestone": "sage-9.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25903#event-73933"
}
```



---

archive/issue_events_073934.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/25903",
    "rename": {
        "from": "strange behavior in macaulay2 bridge",
        "to": "fix Macaulay2 output when reading input from a file"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25903#event-73934"
}
```



---

archive/issue_comments_475027.json:
```json
{
    "body": "**Branch:** [u/gh-mwageringel/25903](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-mwageringel/25903)",
    "created_at": "2019-10-07T03:45:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25903",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25903#issuecomment-475027",
    "user": "https://github.com/mwageringel"
}
```

**Branch:** [u/gh-mwageringel/25903](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-mwageringel/25903)



---

archive/issue_comments_475028.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2019-10-07T03:45:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25903",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25903#issuecomment-475028",
    "user": "https://github.com/mwageringel"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_475029.json:
```json
{
    "body": "**Changing keywords** from \"Macaulay2, interface\" to \"Macaulay2, interface, IMA Coding Sprint\".",
    "created_at": "2019-10-07T03:45:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25903",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25903#issuecomment-475029",
    "user": "https://github.com/mwageringel"
}
```

**Changing keywords** from "Macaulay2, interface" to "Macaulay2, interface, IMA Coding Sprint".



---

archive/issue_comments_475030.json:
```json
{
    "body": "**Commit:** [496ea55bc63dd6e58e7245245965dd161b212a47](https://github.com/sagemath/sagetrac-mirror/commit/496ea55bc63dd6e58e7245245965dd161b212a47)",
    "created_at": "2019-10-07T03:45:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25903",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25903#issuecomment-475030",
    "user": "https://github.com/mwageringel"
}
```

**Commit:** [496ea55bc63dd6e58e7245245965dd161b212a47](https://github.com/sagemath/sagetrac-mirror/commit/496ea55bc63dd6e58e7245245965dd161b212a47)



---

archive/issue_comments_475031.json:
```json
{
    "body": "**Author:** Markus Wageringel",
    "created_at": "2019-10-07T03:45:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25903",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25903#issuecomment-475031",
    "user": "https://github.com/mwageringel"
}
```

**Author:** Markus Wageringel



---

archive/issue_comments_475032.json:
```json
{
    "body": "<a id='comment:3'></a>\nHere is a branch solving this by using the Macaulay2 function `input` instead of `load` to read in files. With `input`, the results are echoed as desired. However, `input` also echoes the input lines. These echoed input lines need to be stripped from the output \u2013 this is accomplished by setting a custom input prompt while reading from a file. The input lines are then stripped in `_post_process_from_file`.\n\nNote that this is only necessary because the Macaulay2 interface in Sage overwrites the prompts, in the first place. In a usual Macaulay2 session, echoed input lines start with `ii` rather than a single `i`:\n\n```\ni1 : input \"testfile.m2\"\n\nii2 : a = 7\n\noo2 = 7\n\nii3 :\n\ni4 :\n```\nHowever, in the current interface, the prompt is overwritten to `_EGAS_` in either case, so it confuses echoed input lines and actual input lines. With this branch, the echoed input lines start with `_EGAS_LOAD_` and get stripped.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/496ea55bc63dd6e58e7245245965dd161b212a47\">496ea55</a></td><td><code>25903: make macaulay2 echo output when evaluating using file</code></td></tr></table>\n",
    "created_at": "2019-10-07T03:45:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25903",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25903#issuecomment-475032",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:3'></a>
Here is a branch solving this by using the Macaulay2 function `input` instead of `load` to read in files. With `input`, the results are echoed as desired. However, `input` also echoes the input lines. These echoed input lines need to be stripped from the output – this is accomplished by setting a custom input prompt while reading from a file. The input lines are then stripped in `_post_process_from_file`.

Note that this is only necessary because the Macaulay2 interface in Sage overwrites the prompts, in the first place. In a usual Macaulay2 session, echoed input lines start with `ii` rather than a single `i`:

```
i1 : input "testfile.m2"

ii2 : a = 7

oo2 = 7

ii3 :

i4 :
```
However, in the current interface, the prompt is overwritten to `_EGAS_` in either case, so it confuses echoed input lines and actual input lines. With this branch, the echoed input lines start with `_EGAS_LOAD_` and get stripped.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/496ea55bc63dd6e58e7245245965dd161b212a47">496ea55</a></td><td><code>25903: make macaulay2 echo output when evaluating using file</code></td></tr></table>




---

archive/issue_events_073935.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2020-01-01T12:27:53Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25903",
    "milestone": "sage-9.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25903#event-73935"
}
```



---

archive/issue_events_073936.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2020-01-01T12:27:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25903",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25903#event-73936"
}
```



---

archive/issue_comments_475033.json:
```json
{
    "body": "<a id='comment:5'></a>\nlooks good. Sorry for sitting on it for such a long time.",
    "created_at": "2020-01-05T04:59:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25903",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25903#issuecomment-475033",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:5'></a>
looks good. Sorry for sitting on it for such a long time.



---

archive/issue_comments_475034.json:
```json
{
    "body": "**Reviewer:** Dima Pasechnik",
    "created_at": "2020-01-05T04:59:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25903",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25903#issuecomment-475034",
    "user": "https://github.com/dimpase"
}
```

**Reviewer:** Dima Pasechnik



---

archive/issue_comments_475035.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2020-01-05T04:59:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25903",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25903#issuecomment-475035",
    "user": "https://github.com/dimpase"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_475036.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,3 +1,9 @@\n+This ticket solves the discrepancy between evaluating Macaulay2 input using a file vs directly as follows:\n+\n+It is solved by using the Macaulay2 function `input` instead of `load` to read in files. With `input`, the results are echoed as desired. However, `input` also echoes the input lines. These echoed input lines need to be stripped from the output \u2013 this is accomplished by setting a custom input prompt while reading from a file. The input lines are then stripped in `_post_process_from_file`.\n+\n+---\n+\n If I run \n \n ```python\n``````\n",
    "created_at": "2020-01-05T10:10:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25903",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25903#issuecomment-475036",
    "user": "https://github.com/mwageringel"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,3 +1,9 @@
+This ticket solves the discrepancy between evaluating Macaulay2 input using a file vs directly as follows:
+
+It is solved by using the Macaulay2 function `input` instead of `load` to read in files. With `input`, the results are echoed as desired. However, `input` also echoes the input lines. These echoed input lines need to be stripped from the output – this is accomplished by setting a custom input prompt while reading from a file. The input lines are then stripped in `_post_process_from_file`.
+
+---
+
 If I run 
 
 ```python
``````




---

archive/issue_comments_475037.json:
```json
{
    "body": "<a id='comment:6'></a>\nNo problem. Thank you.",
    "created_at": "2020-01-05T10:10:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25903",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25903#issuecomment-475037",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:6'></a>
No problem. Thank you.



---

archive/issue_comments_475038.json:
```json
{
    "body": "**Changing branch** from \"[u/gh-mwageringel/25903](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-mwageringel/25903)\" to \"[496ea55bc63dd6e58e7245245965dd161b212a47](https://github.com/sagemath/sagetrac-mirror/commit/496ea55bc63dd6e58e7245245965dd161b212a47)\".",
    "created_at": "2020-01-09T23:44:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25903",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25903#issuecomment-475038",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/gh-mwageringel/25903](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-mwageringel/25903)" to "[496ea55bc63dd6e58e7245245965dd161b212a47](https://github.com/sagemath/sagetrac-mirror/commit/496ea55bc63dd6e58e7245245965dd161b212a47)".



---

archive/issue_events_073937.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-01-09T23:44:38Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/25903",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25903#event-73937"
}
```
