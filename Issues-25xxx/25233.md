# Issue 25233: gcd() broken over stacked polynomial rings with repeated variable names

archive/issues_024996.json:
```json
{
    "assignees": [],
    "body": "\n```\nsage: p = QQ['x']['x'].one()\nsage: p.gcd(p)\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n<ipython-input-10-dc64a434c240> in <module>()\n----> 1 p.gcd(p)\n\nsage/structure/element.pyx in sage.structure.element.coerce_binop.new_method (build/cythonized/sage/structure/element.c:27055)()\n\nsage/rings/polynomial/polynomial_element.pyx in sage.rings.polynomial.polynomial_element.Polynomial.gcd (build/cythonized/sage/rings/polynomial/polynomial_element.c:43278)()\n\n/usr/lib/python2.7/dist-packages/sage/rings/polynomial/polynomial_ring_constructor.pyc in PolynomialRing(base_ring, *args, **kwds)\n    566             raise TypeError(\"you must specify the names of the variables\")\n    567 \n--> 568     names = normalize_names(n, names)\n    569 \n    570     # At this point, we have only handled the \"names\" keyword if it was\n\nsage/structure/category_object.pyx in sage.structure.category_object.normalize_names (build/cythonized/sage/structure/category_object.c:9519)()\n\nsage/structure/category_object.pyx in sage.structure.category_object.normalize_names (build/cythonized/sage/structure/category_object.c:9368)()\n\nsage/structure/category_object.pyx in sage.structure.category_object.certify_names (build/cythonized/sage/structure/category_object.c:10035)()\n\nValueError: variable name 'x' appears more than once\n```\n\nSame issue with multivariate polynomials (separate code, with some duplication).\n\nBranch/Commit: **[`68e6e9e`](https://github.com/sagemath/sagetrac-mirror/commit/68e6e9e394878faa820d4ef6654d79cc3faab775)**\n\nReviewer: **Vincent Delecroix**\n\nAuthor: **Marc Mezzarobba**\n\nComponent: **algebra**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/25233_\n\n",
    "closed_at": "2018-05-30T19:19:37Z",
    "created_at": "2018-04-23T16:03:41Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20algebra",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.3",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "gcd() broken over stacked polynomial rings with repeated variable names",
    "type": "issue",
    "updated_at": "2018-05-30T19:19:37Z",
    "url": "https://github.com/sagemath/sage/issues/25233",
    "user": "https://github.com/mezzarobba"
}
```

```
sage: p = QQ['x']['x'].one()
sage: p.gcd(p)
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-10-dc64a434c240> in <module>()
----> 1 p.gcd(p)

sage/structure/element.pyx in sage.structure.element.coerce_binop.new_method (build/cythonized/sage/structure/element.c:27055)()

sage/rings/polynomial/polynomial_element.pyx in sage.rings.polynomial.polynomial_element.Polynomial.gcd (build/cythonized/sage/rings/polynomial/polynomial_element.c:43278)()

/usr/lib/python2.7/dist-packages/sage/rings/polynomial/polynomial_ring_constructor.pyc in PolynomialRing(base_ring, *args, **kwds)
    566             raise TypeError("you must specify the names of the variables")
    567 
--> 568     names = normalize_names(n, names)
    569 
    570     # At this point, we have only handled the "names" keyword if it was

sage/structure/category_object.pyx in sage.structure.category_object.normalize_names (build/cythonized/sage/structure/category_object.c:9519)()

sage/structure/category_object.pyx in sage.structure.category_object.normalize_names (build/cythonized/sage/structure/category_object.c:9368)()

sage/structure/category_object.pyx in sage.structure.category_object.certify_names (build/cythonized/sage/structure/category_object.c:10035)()

ValueError: variable name 'x' appears more than once
```

Same issue with multivariate polynomials (separate code, with some duplication).

Branch/Commit: **[`68e6e9e`](https://github.com/sagemath/sagetrac-mirror/commit/68e6e9e394878faa820d4ef6654d79cc3faab775)**

Reviewer: **Vincent Delecroix**

Author: **Marc Mezzarobba**

Component: **algebra**

_Issue created by migration from https://trac.sagemath.org/ticket/25233_





---

archive/issue_events_350817.json:
```json
{
    "actor": "https://github.com/mezzarobba",
    "created_at": "2018-04-23T16:03:41Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "milestone_number": null,
    "milestone_title": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25233#event-350817"
}
```



---

archive/issue_events_350818.json:
```json
{
    "actor": "https://github.com/mezzarobba",
    "created_at": "2018-04-23T16:03:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20algebra",
    "label_color": "0000ff",
    "label_name": "c: algebra",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25233#event-350818"
}
```



---

archive/issue_events_350819.json:
```json
{
    "actor": "https://github.com/mezzarobba",
    "created_at": "2018-04-23T16:03:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "label": "https://github.com/sagemath/sage/labels/p%3A%204%20%E2%80%93%20minor",
    "label_color": "ffe799",
    "label_name": "p: 4 \u2013 minor",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25233#event-350819"
}
```



---

archive/issue_events_350820.json:
```json
{
    "actor": "https://github.com/mezzarobba",
    "created_at": "2018-04-23T16:03:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25233#event-350820"
}
```



---

archive/issue_comments_385670.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nI guess the natural fix would be to add support for repeated variables (renaming some automatically if necessary) in `FlatteningMorphism`, and use that in `Polynomial.gcd()` and `MPolynomial.gcd())`.",
    "created_at": "2018-04-23T16:07:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25233#issuecomment-385670",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:1" align="right">comment:1</div>

I guess the natural fix would be to add support for repeated variables (renaming some automatically if necessary) in `FlatteningMorphism`, and use that in `Polynomial.gcd()` and `MPolynomial.gcd())`.



---

archive/issue_comments_385671.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -26,3 +26,5 @@\n \n ValueError: variable name 'x' appears more than once\n ```\n+\n+Same issue with multivariate polynomials (separate code, with some duplication).\n``````\n",
    "created_at": "2018-04-23T16:07:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25233#issuecomment-385671",
    "user": "https://github.com/mezzarobba"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -26,3 +26,5 @@
 
 ValueError: variable name 'x' appears more than once
 ```
+
+Same issue with multivariate polynomials (separate code, with some duplication).
``````




---

archive/issue_comments_385672.json:
```json
{
    "body": "Author: **Marc Mezzarobba**",
    "created_at": "2018-04-23T19:25:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25233#issuecomment-385672",
    "user": "https://github.com/mezzarobba"
}
```

Author: **Marc Mezzarobba**



---

archive/issue_comments_385673.json:
```json
{
    "body": "Branch: **[u/mmezzarobba/25233-flatten](https://github.com/sagemath/sagetrac-mirror/tree/u/mmezzarobba/25233-flatten)**",
    "created_at": "2018-04-23T19:25:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25233#issuecomment-385673",
    "user": "https://github.com/mezzarobba"
}
```

Branch: **[u/mmezzarobba/25233-flatten](https://github.com/sagemath/sagetrac-mirror/tree/u/mmezzarobba/25233-flatten)**



---

archive/issue_comments_385674.json:
```json
{
    "body": "Commit: **[`4ac14cc`](https://github.com/sagemath/sagetrac-mirror/commit/4ac14ccb2601f89ba465d1e2dcbba40bdda693ec)**",
    "created_at": "2018-04-23T19:25:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25233#issuecomment-385674",
    "user": "https://github.com/mezzarobba"
}
```

Commit: **[`4ac14cc`](https://github.com/sagemath/sagetrac-mirror/commit/4ac14ccb2601f89ba465d1e2dcbba40bdda693ec)**



---

archive/issue_comments_385675.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nnot finished yet\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4ac14ccb2601f89ba465d1e2dcbba40bdda693ec\"><code>4ac14cc</code></a></td><td><code>Support repeated variable names in FlatteningMorphism</code></td></tr></table>\n",
    "created_at": "2018-04-23T19:25:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25233#issuecomment-385675",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:2" align="right">comment:2</div>

not finished yet

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4ac14ccb2601f89ba465d1e2dcbba40bdda693ec"><code>4ac14cc</code></a></td><td><code>Support repeated variable names in FlatteningMorphism</code></td></tr></table>




---

archive/issue_comments_385676.json:
```json
{
    "body": "Changed commit from **[`4ac14cc`](https://github.com/sagemath/sagetrac-mirror/commit/4ac14ccb2601f89ba465d1e2dcbba40bdda693ec)** to **[`045baf6`](https://github.com/sagemath/sagetrac-mirror/commit/045baf6ba750a5d5a5b3c0589d78124f5da21205)**",
    "created_at": "2018-04-24T07:38:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25233#issuecomment-385676",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`4ac14cc`](https://github.com/sagemath/sagetrac-mirror/commit/4ac14ccb2601f89ba465d1e2dcbba40bdda693ec)** to **[`045baf6`](https://github.com/sagemath/sagetrac-mirror/commit/045baf6ba750a5d5a5b3c0589d78124f5da21205)**



---

archive/issue_comments_385677.json:
```json
{
    "body": "<div id=\"comment:3\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e26d75a48db0c3540200ffaf841ffc7c44ce733b\"><code>e26d75a</code></a></td><td><code>cached flattening_morphism() method for univariate polynomial rings</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/045baf6ba750a5d5a5b3c0589d78124f5da21205\"><code>045baf6</code></a></td><td><code>use FlatteningMorphism in gcd over stacked polynomial rings</code></td></tr></table>\n",
    "created_at": "2018-04-24T07:38:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25233#issuecomment-385677",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:3"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e26d75a48db0c3540200ffaf841ffc7c44ce733b"><code>e26d75a</code></a></td><td><code>cached flattening_morphism() method for univariate polynomial rings</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/045baf6ba750a5d5a5b3c0589d78124f5da21205"><code>045baf6</code></a></td><td><code>use FlatteningMorphism in gcd over stacked polynomial rings</code></td></tr></table>




---

archive/issue_comments_385678.json:
```json
{
    "body": "<div id=\"comment:4\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/54a826264d7b39156e3ce16045857313dd25396b\"><code>54a8262</code></a></td><td><code>use FlatteningMorphism in gcd over stacked polynomial rings</code></td></tr></table>\n",
    "created_at": "2018-04-24T08:57:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25233#issuecomment-385678",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:4"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/54a826264d7b39156e3ce16045857313dd25396b"><code>54a8262</code></a></td><td><code>use FlatteningMorphism in gcd over stacked polynomial rings</code></td></tr></table>




---

archive/issue_comments_385679.json:
```json
{
    "body": "Changed commit from **[`045baf6`](https://github.com/sagemath/sagetrac-mirror/commit/045baf6ba750a5d5a5b3c0589d78124f5da21205)** to **[`54a8262`](https://github.com/sagemath/sagetrac-mirror/commit/54a826264d7b39156e3ce16045857313dd25396b)**",
    "created_at": "2018-04-24T08:57:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25233#issuecomment-385679",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`045baf6`](https://github.com/sagemath/sagetrac-mirror/commit/045baf6ba750a5d5a5b3c0589d78124f5da21205)** to **[`54a8262`](https://github.com/sagemath/sagetrac-mirror/commit/54a826264d7b39156e3ce16045857313dd25396b)**



---

archive/issue_events_350821.json:
```json
{
    "actor": "https://github.com/mezzarobba",
    "created_at": "2018-04-24T08:57:45Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "label": "https://github.com/sagemath/sage/labels/p%3A%204%20%E2%80%93%20minor",
    "label_color": "ffe799",
    "label_name": "p: 4 \u2013 minor",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25233#event-350821"
}
```



---

archive/issue_events_350822.json:
```json
{
    "actor": "https://github.com/mezzarobba",
    "created_at": "2018-04-24T08:57:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25233#event-350822"
}
```



---

archive/issue_events_350823.json:
```json
{
    "actor": "https://github.com/mezzarobba",
    "created_at": "2018-04-24T08:57:45Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "title_is": "gcd() broken over stacked polynomial rings with repeated variable names",
    "title_was": "gcd() of stacked polynomial rings broken with repeated variable names",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25233#event-350823"
}
```



---

archive/issue_comments_385680.json:
```json
{
    "body": "<div id=\"comment:5\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e26d75a48db0c3540200ffaf841ffc7c44ce733b\"><code>e26d75a</code></a></td><td><code>cached flattening_morphism() method for univariate polynomial rings</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/54a826264d7b39156e3ce16045857313dd25396b\"><code>54a8262</code></a></td><td><code>use FlatteningMorphism in gcd over stacked polynomial rings</code></td></tr></table>\n",
    "created_at": "2018-04-24T08:57:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25233#issuecomment-385680",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:5"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e26d75a48db0c3540200ffaf841ffc7c44ce733b"><code>e26d75a</code></a></td><td><code>cached flattening_morphism() method for univariate polynomial rings</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/54a826264d7b39156e3ce16045857313dd25396b"><code>54a8262</code></a></td><td><code>use FlatteningMorphism in gcd over stacked polynomial rings</code></td></tr></table>




---

archive/issue_events_350824.json:
```json
{
    "actor": "https://github.com/mezzarobba",
    "created_at": "2018-04-24T08:57:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25233#event-350824"
}
```



---

archive/issue_comments_385681.json:
```json
{
    "body": "Changed commit from **[`54a8262`](https://github.com/sagemath/sagetrac-mirror/commit/54a826264d7b39156e3ce16045857313dd25396b)** to **[`26a3ed1`](https://github.com/sagemath/sagetrac-mirror/commit/26a3ed1b77ef8479100d0e70cd6d6d0b84a1fc07)**",
    "created_at": "2018-04-24T09:10:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25233#issuecomment-385681",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`54a8262`](https://github.com/sagemath/sagetrac-mirror/commit/54a826264d7b39156e3ce16045857313dd25396b)** to **[`26a3ed1`](https://github.com/sagemath/sagetrac-mirror/commit/26a3ed1b77ef8479100d0e70cd6d6d0b84a1fc07)**



---

archive/issue_comments_385682.json:
```json
{
    "body": "<div id=\"comment:6\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/26a3ed1b77ef8479100d0e70cd6d6d0b84a1fc07\"><code>26a3ed1</code></a></td><td><code>use FlatteningMorphism in gcd over stacked polynomial rings</code></td></tr></table>\n",
    "created_at": "2018-04-24T09:10:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25233#issuecomment-385682",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:6"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/26a3ed1b77ef8479100d0e70cd6d6d0b84a1fc07"><code>26a3ed1</code></a></td><td><code>use FlatteningMorphism in gcd over stacked polynomial rings</code></td></tr></table>




---

archive/issue_comments_385683.json:
```json
{
    "body": "<div id=\"comment:7\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bd9abad276e68db393f9f4f55ea3f0c531541988\"><code>bd9abad</code></a></td><td><code>typo</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/22a6173016543f24c2ca1ac798069c2712b8e710\"><code>22a6173</code></a></td><td><code>small optimization in flattening_morphism()</code></td></tr></table>\n",
    "created_at": "2018-04-24T09:41:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25233#issuecomment-385683",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:7"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bd9abad276e68db393f9f4f55ea3f0c531541988"><code>bd9abad</code></a></td><td><code>typo</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/22a6173016543f24c2ca1ac798069c2712b8e710"><code>22a6173</code></a></td><td><code>small optimization in flattening_morphism()</code></td></tr></table>




---

archive/issue_comments_385684.json:
```json
{
    "body": "Changed commit from **[`26a3ed1`](https://github.com/sagemath/sagetrac-mirror/commit/26a3ed1b77ef8479100d0e70cd6d6d0b84a1fc07)** to **[`22a6173`](https://github.com/sagemath/sagetrac-mirror/commit/22a6173016543f24c2ca1ac798069c2712b8e710)**",
    "created_at": "2018-04-24T09:41:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25233#issuecomment-385684",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`26a3ed1`](https://github.com/sagemath/sagetrac-mirror/commit/26a3ed1b77ef8479100d0e70cd6d6d0b84a1fc07)** to **[`22a6173`](https://github.com/sagemath/sagetrac-mirror/commit/22a6173016543f24c2ca1ac798069c2712b8e710)**



---

archive/issue_comments_385685.json:
```json
{
    "body": "Changed commit from **[`22a6173`](https://github.com/sagemath/sagetrac-mirror/commit/22a6173016543f24c2ca1ac798069c2712b8e710)** to **[`8de9bbf`](https://github.com/sagemath/sagetrac-mirror/commit/8de9bbfad926e89eef4ff0f0ed84fc7b37bee741)**",
    "created_at": "2018-05-11T18:21:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25233#issuecomment-385685",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`22a6173`](https://github.com/sagemath/sagetrac-mirror/commit/22a6173016543f24c2ca1ac798069c2712b8e710)** to **[`8de9bbf`](https://github.com/sagemath/sagetrac-mirror/commit/8de9bbfad926e89eef4ff0f0ed84fc7b37bee741)**



---

archive/issue_comments_385686.json:
```json
{
    "body": "<div id=\"comment:8\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0d56c5f309704f42c255a7d8976a73a70d7b3579\"><code>0d56c5f</code></a></td><td><code>Support repeated variable names in FlatteningMorphism</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/751fe8934b48ff6f7e14cdf03b8f923dc8cb3ebe\"><code>751fe89</code></a></td><td><code>cached flattening_morphism() method for univariate polynomial rings</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8de9bbfad926e89eef4ff0f0ed84fc7b37bee741\"><code>8de9bbf</code></a></td><td><code>use FlatteningMorphism in gcd over stacked polynomial rings</code></td></tr></table>\n",
    "created_at": "2018-05-11T18:21:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25233#issuecomment-385686",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:8"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0d56c5f309704f42c255a7d8976a73a70d7b3579"><code>0d56c5f</code></a></td><td><code>Support repeated variable names in FlatteningMorphism</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/751fe8934b48ff6f7e14cdf03b8f923dc8cb3ebe"><code>751fe89</code></a></td><td><code>cached flattening_morphism() method for univariate polynomial rings</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8de9bbfad926e89eef4ff0f0ed84fc7b37bee741"><code>8de9bbf</code></a></td><td><code>use FlatteningMorphism in gcd over stacked polynomial rings</code></td></tr></table>




---

archive/issue_comments_385687.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nMoving the last two commits (plus further improvements) to a separate ticket #25346.",
    "created_at": "2018-05-11T18:23:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25233#issuecomment-385687",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:9" align="right">comment:9</div>

Moving the last two commits (plus further improvements) to a separate ticket #25346.



---

archive/issue_comments_385688.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nA small performance notice: `hasattr` should be avoided as much as possible (it costs a dictionary lookup). It is better to replace\n\n```\nif hasattr(a, 'f'):\n    return a.f()\nelse:\n    raise NotImplementedError\n```\nby\n\n```\ntry:\n    return a.f()\nexcept AttributeError:\n    raise NotImplementedError\n```",
    "created_at": "2018-05-12T19:24:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25233#issuecomment-385688",
    "user": "https://github.com/videlec"
}
```

<div id="comment:10" align="right">comment:10</div>

A small performance notice: `hasattr` should be avoided as much as possible (it costs a dictionary lookup). It is better to replace

```
if hasattr(a, 'f'):
    return a.f()
else:
    raise NotImplementedError
```
by

```
try:
    return a.f()
except AttributeError:
    raise NotImplementedError
```



---

archive/issue_comments_385689.json:
```json
{
    "body": "Reviewer: **Vincent Delecroix**",
    "created_at": "2018-05-12T19:25:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25233#issuecomment-385689",
    "user": "https://github.com/videlec"
}
```

Reviewer: **Vincent Delecroix**



---

archive/issue_events_350825.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-05-12T19:25:10Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "milestone_number": null,
    "milestone_title": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25233#event-350825"
}
```



---

archive/issue_events_350826.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-05-12T19:25:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "milestone_number": null,
    "milestone_title": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25233#event-350826"
}
```



---

archive/issue_comments_385690.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\n(rest looks good)",
    "created_at": "2018-05-12T19:25:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25233#issuecomment-385690",
    "user": "https://github.com/videlec"
}
```

<div id="comment:11" align="right">comment:11</div>

(rest looks good)



---

archive/issue_comments_385691.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@videlec](#comment:10):\n> A small performance notice: `hasattr` should be avoided as much as possible\n\nNot in Cython, in think, but I would need to double check.",
    "created_at": "2018-05-12T19:28:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25233#issuecomment-385691",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@videlec](#comment:10):
> A small performance notice: `hasattr` should be avoided as much as possible

Not in Cython, in think, but I would need to double check.



---

archive/issue_comments_385692.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nadding my comment on #25346 here as this is where that error was added.\n\n\n\nI've run a few tests on this and haven't come up with anything that does not work correctly.\n\nHowever, I'd like to know what prompted the addition of ArithmeticError? to the gcd check in dehomomgenize for affine morphisms.\n\nIt is likely that whatever this is will also occur in normalize_coordinates for projective morphisms.",
    "created_at": "2018-05-12T20:25:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25233#issuecomment-385692",
    "user": "https://github.com/bhutz"
}
```

<div id="comment:13" align="right">comment:13</div>

adding my comment on #25346 here as this is where that error was added.



I've run a few tests on this and haven't come up with anything that does not work correctly.

However, I'd like to know what prompted the addition of ArithmeticError? to the gcd check in dehomomgenize for affine morphisms.

It is likely that whatever this is will also occur in normalize_coordinates for projective morphisms.



---

archive/issue_comments_385693.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@mezzarobba](#comment:12):\n> Replying to [@videlec](#comment:10):\n> > A small performance notice: `hasattr` should be avoided as much as possible\n\n> \n> Not in Cython, in think, but I would need to double check.\n\nActually it looks like you are right, Cython doesn't seem to be able to optimize these two lines as well as I'd thought.",
    "created_at": "2018-05-13T08:29:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25233#issuecomment-385693",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@mezzarobba](#comment:12):
> Replying to [@videlec](#comment:10):
> > A small performance notice: `hasattr` should be avoided as much as possible

> 
> Not in Cython, in think, but I would need to double check.

Actually it looks like you are right, Cython doesn't seem to be able to optimize these two lines as well as I'd thought.



---

archive/issue_comments_385694.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nReplying to [@bhutz](#comment:13):\n> However, I'd like to know what prompted the addition of ArithmeticError? to the gcd check in dehomomgenize for affine morphisms.\n\nI don't really remember. Here's what I'm getting without it:\n\n```\nFile \"src/sage/schemes/affine/affine_morphism.py\", line 519, in sage.schemes.affine.affine_morphism.SchemeMorphism_polynomial_affine_space.homogenize\nFailed example:\n    F.homogenize(1)\nException raised:\n    Traceback (most recent call last):\n      File \"/home/marc/co/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 562, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/marc/co/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 972, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.schemes.affine.affine_morphism.SchemeMorphism_polynomial_affine_space.homogenize[47]>\", line 1, in <module>\n        F.homogenize(Integer(1))\n      File \"/home/marc/co/sage/local/lib/python2.7/site-packages/sage/schemes/affine/affine_morphism.py\", line 561, in homogenize\n        g = gcd(F)\n      File \"/home/marc/co/sage/local/lib/python2.7/site-packages/sage/arith/misc.py\", line 1604, in gcd\n        return __GCD_sequence(seq, **kwargs)\n      File \"/home/marc/co/sage/local/lib/python2.7/site-packages/sage/arith/misc.py\", line 1652, in __GCD_sequence\n        g = vi.gcd(g, **kwargs)\n      File \"sage/rings/polynomial/multi_polynomial.pyx\", line 1872, in sage.rings.polynomial.multi_polynomial.MPolynomial.gcd (build/cythonized/sage/rings/polynomial/multi_polynomial.c:20533)\n        return self._parent(unibase._gcd_univariate_polynomial(uniself, other.polynomial(x)))\n      File \"/home/marc/co/sage/local/lib/python2.7/site-packages/sage/categories/unique_factorization_domains.py\", line 185, in _gcd_univariate_polynomial\n        B = B // b\n      File \"sage/rings/polynomial/polynomial_element.pyx\", line 10566, in sage.rings.polynomial.polynomial_element.Polynomial_generic_dense.__floordiv__ (build/cythonized/sage/rings/polynomial/polynomial_element.c:97097)\n        cdef Polynomial_generic_dense res = (<Polynomial_generic_dense>self)._new_c([c // d for c in (<Polynomial_generic_dense>self).__coeffs], P)\n      File \"sage/rings/polynomial/polynomial_element.pyx\", line 10563, in sage.rings.polynomial.polynomial_element.Polynomial_generic_dense.__floordiv__ (build/cythonized/sage/rings/polynomial/polynomial_element.c:96973)\n        return (<Polynomial_generic_dense>self)._floordiv_(<Polynomial_generic_dense>right)\n      File \"sage/rings/polynomial/polynomial_element.pyx\", line 2700, in sage.rings.polynomial.polynomial_element.Polynomial._floordiv_ (build/cythonized/sage/rings/polynomial/polynomial_element.c:29855)\n        Q, _ = self.quo_rem(right)\n      File \"sage/structure/element.pyx\", line 4260, in sage.structure.element.coerce_binop.new_method (build/cythonized/sage/structure/element.c:28282)\n        return method(self, other, *args, **kwargs)\n      File \"sage/rings/polynomial/polynomial_element.pyx\", line 10812, in sage.rings.polynomial.polynomial_element.Polynomial_generic_dense.quo_rem (build/cythonized/sage/rings/polynomial/polynomial_element.c:100180)\n        raise ArithmeticError(\"Division non exact (consider coercing to polynomials over the fraction field)\")\n    ArithmeticError: Division non exact (consider coercing to polynomials over the fraction field)\n```\nI guess that, since this was the only failure of this kind, I thought it would be best to catch the `ArithmeticError` there (instead of keeping a `try/catch` block in `gcd()`). But if you're saying the same issue will occur elsewhere, I'm not sure what to do. Opinions anyone?",
    "created_at": "2018-05-13T09:07:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25233#issuecomment-385694",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:15" align="right">comment:15</div>

Replying to [@bhutz](#comment:13):
> However, I'd like to know what prompted the addition of ArithmeticError? to the gcd check in dehomomgenize for affine morphisms.

I don't really remember. Here's what I'm getting without it:

```
File "src/sage/schemes/affine/affine_morphism.py", line 519, in sage.schemes.affine.affine_morphism.SchemeMorphism_polynomial_affine_space.homogenize
Failed example:
    F.homogenize(1)
Exception raised:
    Traceback (most recent call last):
      File "/home/marc/co/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 562, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/marc/co/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 972, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.schemes.affine.affine_morphism.SchemeMorphism_polynomial_affine_space.homogenize[47]>", line 1, in <module>
        F.homogenize(Integer(1))
      File "/home/marc/co/sage/local/lib/python2.7/site-packages/sage/schemes/affine/affine_morphism.py", line 561, in homogenize
        g = gcd(F)
      File "/home/marc/co/sage/local/lib/python2.7/site-packages/sage/arith/misc.py", line 1604, in gcd
        return __GCD_sequence(seq, **kwargs)
      File "/home/marc/co/sage/local/lib/python2.7/site-packages/sage/arith/misc.py", line 1652, in __GCD_sequence
        g = vi.gcd(g, **kwargs)
      File "sage/rings/polynomial/multi_polynomial.pyx", line 1872, in sage.rings.polynomial.multi_polynomial.MPolynomial.gcd (build/cythonized/sage/rings/polynomial/multi_polynomial.c:20533)
        return self._parent(unibase._gcd_univariate_polynomial(uniself, other.polynomial(x)))
      File "/home/marc/co/sage/local/lib/python2.7/site-packages/sage/categories/unique_factorization_domains.py", line 185, in _gcd_univariate_polynomial
        B = B // b
      File "sage/rings/polynomial/polynomial_element.pyx", line 10566, in sage.rings.polynomial.polynomial_element.Polynomial_generic_dense.__floordiv__ (build/cythonized/sage/rings/polynomial/polynomial_element.c:97097)
        cdef Polynomial_generic_dense res = (<Polynomial_generic_dense>self)._new_c([c // d for c in (<Polynomial_generic_dense>self).__coeffs], P)
      File "sage/rings/polynomial/polynomial_element.pyx", line 10563, in sage.rings.polynomial.polynomial_element.Polynomial_generic_dense.__floordiv__ (build/cythonized/sage/rings/polynomial/polynomial_element.c:96973)
        return (<Polynomial_generic_dense>self)._floordiv_(<Polynomial_generic_dense>right)
      File "sage/rings/polynomial/polynomial_element.pyx", line 2700, in sage.rings.polynomial.polynomial_element.Polynomial._floordiv_ (build/cythonized/sage/rings/polynomial/polynomial_element.c:29855)
        Q, _ = self.quo_rem(right)
      File "sage/structure/element.pyx", line 4260, in sage.structure.element.coerce_binop.new_method (build/cythonized/sage/structure/element.c:28282)
        return method(self, other, *args, **kwargs)
      File "sage/rings/polynomial/polynomial_element.pyx", line 10812, in sage.rings.polynomial.polynomial_element.Polynomial_generic_dense.quo_rem (build/cythonized/sage/rings/polynomial/polynomial_element.c:100180)
        raise ArithmeticError("Division non exact (consider coercing to polynomials over the fraction field)")
    ArithmeticError: Division non exact (consider coercing to polynomials over the fraction field)
```
I guess that, since this was the only failure of this kind, I thought it would be best to catch the `ArithmeticError` there (instead of keeping a `try/catch` block in `gcd()`). But if you're saying the same issue will occur elsewhere, I'm not sure what to do. Opinions anyone?



---

archive/issue_comments_385695.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nLooking at that example failure, here is what is boils down to: the following gets the ArithmeticError\n\n```\nR.<d,c>=QQbar[]\nS.<x0,x1>=R[]\nf=d*x0^2+x0;g=S(x0^2)\ngcd(f,g)\n```\n\nIt used to return\n\n```\n  File \"/home/ben/sage/sage-release/local/lib/python2.7/site-packages/sage/arith/misc.py\", line 1584, in gcd\n    raise TypeError(\"unable to find gcd\")\nTypeError: unable to find gcd\n```\n\nSo if this is just a case of gcd returning an error in an uncomputable case, then adding to the try/except in homogenize is the right thing to do. Homogenize is still perfectly valid without removing the gcd and that try/except is exactly to catch the failures from gcd.\n\nnormalize_coordinates for projective morphisms and points must have the gcd removed (that is their whole point) so they don't do a try/except and just throw the error from gcd. But similar examples should fail here as well (and this one does).\n\n\nLooking at little further into the example, it is interesting that if you make either R or S a univariate polynomial ring, then the gcd computes\n\n```\nR.<d,c>=QQbar[]\nS.<x0>=R[]\nf=d*x0^2+d*x0;g=S(c*d*x0^2)\ngcd(f,g)\n```\nThat seems to say to me that there may still be an underlying issue with gcd here since if you are using Flattening to take the gcd, I don't see how this change should affect anything.",
    "created_at": "2018-05-13T11:57:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25233#issuecomment-385695",
    "user": "https://github.com/bhutz"
}
```

<div id="comment:16" align="right">comment:16</div>

Looking at that example failure, here is what is boils down to: the following gets the ArithmeticError

```
R.<d,c>=QQbar[]
S.<x0,x1>=R[]
f=d*x0^2+x0;g=S(x0^2)
gcd(f,g)
```

It used to return

```
  File "/home/ben/sage/sage-release/local/lib/python2.7/site-packages/sage/arith/misc.py", line 1584, in gcd
    raise TypeError("unable to find gcd")
TypeError: unable to find gcd
```

So if this is just a case of gcd returning an error in an uncomputable case, then adding to the try/except in homogenize is the right thing to do. Homogenize is still perfectly valid without removing the gcd and that try/except is exactly to catch the failures from gcd.

normalize_coordinates for projective morphisms and points must have the gcd removed (that is their whole point) so they don't do a try/except and just throw the error from gcd. But similar examples should fail here as well (and this one does).


Looking at little further into the example, it is interesting that if you make either R or S a univariate polynomial ring, then the gcd computes

```
R.<d,c>=QQbar[]
S.<x0>=R[]
f=d*x0^2+d*x0;g=S(c*d*x0^2)
gcd(f,g)
```
That seems to say to me that there may still be an underlying issue with gcd here since if you are using Flattening to take the gcd, I don't see how this change should affect anything.



---

archive/issue_comments_385696.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@videlec](#comment:10):\n> A small performance notice: `hasattr` should be avoided as much as possible (it costs a dictionary lookup). It is better to replace\n> \n> ```\n> if hasattr(a, 'f'):\n>     return a.f()\n> else:\n>     raise NotImplementedError\n> ```\n> by\n> \n> ```\n> try:\n>     return a.f()\n> except AttributeError:\n>     raise NotImplementedError\n> ```\n\nYes and no in Python, it depends on what you expect to happen more often:\n\n```sage\nsage: class Foo(object):\n....:     def bar(self):\n....:         return\n....:\nsage: def test1(F):\n....:     if hasattr(F, 'bar'):\n....:         return F.bar()\n....:     return\nsage: def test2(F):\n....:     try:\n....:         return F.bar()\n....:     except AttributeError:\n....:         return\nsage: class Baz(object):\n....:     pass\n```\n\n```\nsage: F = Foo()\nsage: B = Baz()\nsage: %timeit test1(F)\nThe slowest run took 15.48 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000000 loops, best of 3: 323 ns per loop\nsage: %timeit test2(F)\nThe slowest run took 9.63 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000000 loops, best of 3: 198 ns per loop\n\nsage: %timeit test1(B)\nThe slowest run took 8.00 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000000 loops, best of 3: 506 ns per loop\nsage: %timeit test2(B)\nThe slowest run took 6.16 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000000 loops, best of 3: 1.28 \u00b5s per loop\n```\nIt is clearly faster to do the `try-except` when the object has the method by about 50%, but when it does not, it is 2x slower and needs over a microsecond on my laptop to do said test. Considering the slowdown for doing the `hasattr` check is modest compared to the raising and catching of an exception, unless you expect the method to typically be there, I think the `hasattr` is a better way to go. Plus, it usually makes the logic easier to follow.",
    "created_at": "2018-05-13T12:53:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25233#issuecomment-385696",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@videlec](#comment:10):
> A small performance notice: `hasattr` should be avoided as much as possible (it costs a dictionary lookup). It is better to replace
> 
> ```
> if hasattr(a, 'f'):
>     return a.f()
> else:
>     raise NotImplementedError
> ```
> by
> 
> ```
> try:
>     return a.f()
> except AttributeError:
>     raise NotImplementedError
> ```

Yes and no in Python, it depends on what you expect to happen more often:

```sage
sage: class Foo(object):
....:     def bar(self):
....:         return
....:
sage: def test1(F):
....:     if hasattr(F, 'bar'):
....:         return F.bar()
....:     return
sage: def test2(F):
....:     try:
....:         return F.bar()
....:     except AttributeError:
....:         return
sage: class Baz(object):
....:     pass
```

```
sage: F = Foo()
sage: B = Baz()
sage: %timeit test1(F)
The slowest run took 15.48 times longer than the fastest. This could mean that an intermediate result is being cached.
1000000 loops, best of 3: 323 ns per loop
sage: %timeit test2(F)
The slowest run took 9.63 times longer than the fastest. This could mean that an intermediate result is being cached.
1000000 loops, best of 3: 198 ns per loop

sage: %timeit test1(B)
The slowest run took 8.00 times longer than the fastest. This could mean that an intermediate result is being cached.
1000000 loops, best of 3: 506 ns per loop
sage: %timeit test2(B)
The slowest run took 6.16 times longer than the fastest. This could mean that an intermediate result is being cached.
1000000 loops, best of 3: 1.28 µs per loop
```
It is clearly faster to do the `try-except` when the object has the method by about 50%, but when it does not, it is 2x slower and needs over a microsecond on my laptop to do said test. Considering the slowdown for doing the `hasattr` check is modest compared to the raising and catching of an exception, unless you expect the method to typically be there, I think the `hasattr` is a better way to go. Plus, it usually makes the logic easier to follow.



---

archive/issue_comments_385697.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nReplying to [@tscrim](#comment:17):\n> Replying to [@videlec](#comment:10):\n> > A small performance notice: `hasattr` should be avoided as much as possible (it costs a dictionary lookup). It is better to replace\n> > \n> > ```\n> > if hasattr(a, 'f'):\n> >     return a.f()\n> > else:\n> >     raise NotImplementedError\n> > ```\n> > by\n> > \n> > ```\n> > try:\n> >     return a.f()\n> > except AttributeError:\n> >     raise NotImplementedError\n> > ```\n\n> \n> <SNIP>\n> It is clearly faster to do the `try-except` when the object has the method by about 50%\n> <SNIP>\n\nThis is precisely the point here. When the method is not there an error is triggered anyway.",
    "created_at": "2018-05-13T21:12:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25233#issuecomment-385697",
    "user": "https://github.com/videlec"
}
```

<div id="comment:18" align="right">comment:18</div>

Replying to [@tscrim](#comment:17):
> Replying to [@videlec](#comment:10):
> > A small performance notice: `hasattr` should be avoided as much as possible (it costs a dictionary lookup). It is better to replace
> > 
> > ```
> > if hasattr(a, 'f'):
> >     return a.f()
> > else:
> >     raise NotImplementedError
> > ```
> > by
> > 
> > ```
> > try:
> >     return a.f()
> > except AttributeError:
> >     raise NotImplementedError
> > ```

> 
> <SNIP>
> It is clearly faster to do the `try-except` when the object has the method by about 50%
> <SNIP>

This is precisely the point here. When the method is not there an error is triggered anyway.



---

archive/issue_comments_385698.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nReplying to [@videlec](#comment:18):\n> Replying to [@tscrim](#comment:17):\n> > Replying to [@videlec](#comment:10):\n> > > A small performance notice: `hasattr` should be avoided as much as possible (it costs a dictionary lookup). It is better to replace\n> > > \n> > > ```\n> > > if hasattr(a, 'f'):\n> > >     return a.f()\n> > > else:\n> > >     raise NotImplementedError\n> > > ```\n> > > by\n> > > \n> > > ```\n> > > try:\n> > >     return a.f()\n> > > except AttributeError:\n> > >     raise NotImplementedError\n> > > ```\n\n> > \n> > <SNIP>\n> > It is clearly faster to do the `try-except` when the object has the method by about 50%\n> > <SNIP>\n\n> \n> This is precisely the point here. When the method is not there an error is triggered anyway.\n\nYou're missing my point about a rebuttal against your comment about avoiding `hasattr` as much as possible. In this case it is less important because the other code is to raise an error. In general where there can be two genuine code paths, there are other factors to consider.",
    "created_at": "2018-05-13T21:38:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25233#issuecomment-385698",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:19" align="right">comment:19</div>

Replying to [@videlec](#comment:18):
> Replying to [@tscrim](#comment:17):
> > Replying to [@videlec](#comment:10):
> > > A small performance notice: `hasattr` should be avoided as much as possible (it costs a dictionary lookup). It is better to replace
> > > 
> > > ```
> > > if hasattr(a, 'f'):
> > >     return a.f()
> > > else:
> > >     raise NotImplementedError
> > > ```
> > > by
> > > 
> > > ```
> > > try:
> > >     return a.f()
> > > except AttributeError:
> > >     raise NotImplementedError
> > > ```

> > 
> > <SNIP>
> > It is clearly faster to do the `try-except` when the object has the method by about 50%
> > <SNIP>

> 
> This is precisely the point here. When the method is not there an error is triggered anyway.

You're missing my point about a rebuttal against your comment about avoiding `hasattr` as much as possible. In this case it is less important because the other code is to raise an error. In general where there can be two genuine code paths, there are other factors to consider.



---

archive/issue_comments_385699.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nReplying to [@bhutz](#comment:16):\n> Looking at little further into the example, it is interesting that if you make either R or S a univariate polynomial ring, then the gcd computes\n> \n> ```\n> R.<d,c>=QQbar[]\n> S.<x0>=R[]\n> f=d*x0^2+d*x0;g=S(c*d*x0^2)\n> gcd(f,g)\n> ```\n> That seems to say to me that there may still be an underlying issue with gcd here since if you are using Flattening to take the gcd, I don't see how this change should affect anything.\n\nThe difference\u2014I think\u2014is that the new code for multivariate polynomials checks whether the flattened polynomial ring \u201c`_has_singular`\u201d before trying to call `gcd` on the flattened polynomials. In you example, this is not the case, and hence it continues with the original polynomial and ends up doing\n\n```\n        x = self._parent.gens()[-1]\n        uniself = self.polynomial(x)\n        unibase = uniself.base_ring()\n        if hasattr(unibase, \"_gcd_univariate_polynomial\"):\n            return self._parent(unibase._gcd_univariate_polynomial(uniself, other.polynomial(x)))\n```\nwith `uniself` in QQbar[c,d][x\u2080][x\u2081], which fails with an `ArithmeticError`. In contrast, the previous version would call itself recursively on a polynomial in QQbar[c,d,x\u2080,x\u2081], which would then be turned into an element of QQbar[c,d,x\u2080][x\u2081] during the recursive call, and fail with a different error.",
    "created_at": "2018-05-14T09:25:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25233#issuecomment-385699",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:20" align="right">comment:20</div>

Replying to [@bhutz](#comment:16):
> Looking at little further into the example, it is interesting that if you make either R or S a univariate polynomial ring, then the gcd computes
> 
> ```
> R.<d,c>=QQbar[]
> S.<x0>=R[]
> f=d*x0^2+d*x0;g=S(c*d*x0^2)
> gcd(f,g)
> ```
> That seems to say to me that there may still be an underlying issue with gcd here since if you are using Flattening to take the gcd, I don't see how this change should affect anything.

The difference—I think—is that the new code for multivariate polynomials checks whether the flattened polynomial ring “`_has_singular`” before trying to call `gcd` on the flattened polynomials. In you example, this is not the case, and hence it continues with the original polynomial and ends up doing

```
        x = self._parent.gens()[-1]
        uniself = self.polynomial(x)
        unibase = uniself.base_ring()
        if hasattr(unibase, "_gcd_univariate_polynomial"):
            return self._parent(unibase._gcd_univariate_polynomial(uniself, other.polynomial(x)))
```
with `uniself` in QQbar[c,d][x₀][x₁], which fails with an `ArithmeticError`. In contrast, the previous version would call itself recursively on a polynomial in QQbar[c,d,x₀,x₁], which would then be turned into an element of QQbar[c,d,x₀][x₁] during the recursive call, and fail with a different error.



---

archive/issue_comments_385700.json:
```json
{
    "body": "Changed commit from **[`8de9bbf`](https://github.com/sagemath/sagetrac-mirror/commit/8de9bbfad926e89eef4ff0f0ed84fc7b37bee741)** to **[`68e6e9e`](https://github.com/sagemath/sagetrac-mirror/commit/68e6e9e394878faa820d4ef6654d79cc3faab775)**",
    "created_at": "2018-05-14T10:07:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25233#issuecomment-385700",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`8de9bbf`](https://github.com/sagemath/sagetrac-mirror/commit/8de9bbfad926e89eef4ff0f0ed84fc7b37bee741)** to **[`68e6e9e`](https://github.com/sagemath/sagetrac-mirror/commit/68e6e9e394878faa820d4ef6654d79cc3faab775)**



---

archive/issue_comments_385701.json:
```json
{
    "body": "<div id=\"comment:21\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8b3d8b2db03aacdc5bfb68120e838b9e530626a3\"><code>8b3d8b2</code></a></td><td><code>micro-optimization</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/68e6e9e394878faa820d4ef6654d79cc3faab775\"><code>68e6e9e</code></a></td><td><code>small fix in multivariate polynomial gcd()</code></td></tr></table>\n",
    "created_at": "2018-05-14T10:07:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25233#issuecomment-385701",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:21"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8b3d8b2db03aacdc5bfb68120e838b9e530626a3"><code>8b3d8b2</code></a></td><td><code>micro-optimization</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/68e6e9e394878faa820d4ef6654d79cc3faab775"><code>68e6e9e</code></a></td><td><code>small fix in multivariate polynomial gcd()</code></td></tr></table>




---

archive/issue_comments_385702.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nReplying to [@bhutz](#comment:16):\n> it is interesting that if you make either R or S a univariate polynomial ring, then the gcd computes\n\nOf course, this also means that it should be possible to make gcds over QQbar[c,d][x\u2080,x\u2081] work too... But I'd prefer to keep that for another ticket.\n\nOn a related note, I doubt that the code path of MPolynomial.gcd() that reduces to a univariate gcd is actually used in any successful computation. It may be possible to simplify the method to something like\n\n```\nflatten = self._parent.flattening_morphism()\ntgt = flatten.codomain()\nif not tgt._has_singular:\n    raise NotImplementedError(\"GCD is not implemented for multivariate polynomials over {}\".format(self._parent._mpoly_base_ring()))\nself, other = flatten(self), flatten(other)\ntgt._singular_().set_ring()\ng = self._singular_().gcd(other._singular_())\nreturn flatten.section()(tgt(g))\n```\nwithout losing any functionality...",
    "created_at": "2018-05-14T10:20:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25233#issuecomment-385702",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:22" align="right">comment:22</div>

Replying to [@bhutz](#comment:16):
> it is interesting that if you make either R or S a univariate polynomial ring, then the gcd computes

Of course, this also means that it should be possible to make gcds over QQbar[c,d][x₀,x₁] work too... But I'd prefer to keep that for another ticket.

On a related note, I doubt that the code path of MPolynomial.gcd() that reduces to a univariate gcd is actually used in any successful computation. It may be possible to simplify the method to something like

```
flatten = self._parent.flattening_morphism()
tgt = flatten.codomain()
if not tgt._has_singular:
    raise NotImplementedError("GCD is not implemented for multivariate polynomials over {}".format(self._parent._mpoly_base_ring()))
self, other = flatten(self), flatten(other)
tgt._singular_().set_ring()
g = self._singular_().gcd(other._singular_())
return flatten.section()(tgt(g))
```
without losing any functionality...



---

archive/issue_comments_385703.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nReplying to [@videlec](#comment:11):\n> (rest looks good)\n\nDoes it mean that we can set this ticket to positive_review now that this issue is solved?",
    "created_at": "2018-05-19T08:57:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25233#issuecomment-385703",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:23" align="right">comment:23</div>

Replying to [@videlec](#comment:11):
> (rest looks good)

Does it mean that we can set this ticket to positive_review now that this issue is solved?



---

archive/issue_events_350827.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-05-29T06:10:15Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25233#event-350827"
}
```



---

archive/issue_events_350828.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-05-29T06:10:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25233#event-350828"
}
```



---

archive/issue_comments_385704.json:
```json
{
    "body": "Changed branch from **[u/mmezzarobba/25233-flatten](https://github.com/sagemath/sagetrac-mirror/tree/u/mmezzarobba/25233-flatten)** to **[`68e6e9e`](https://github.com/sagemath/sagetrac-mirror/commit/68e6e9e394878faa820d4ef6654d79cc3faab775)**",
    "created_at": "2018-05-30T19:19:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25233#issuecomment-385704",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/mmezzarobba/25233-flatten](https://github.com/sagemath/sagetrac-mirror/tree/u/mmezzarobba/25233-flatten)** to **[`68e6e9e`](https://github.com/sagemath/sagetrac-mirror/commit/68e6e9e394878faa820d4ef6654d79cc3faab775)**



---

archive/issue_events_350829.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-05-30T19:19:37Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25233#event-350829"
}
```



---

archive/issue_events_350830.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "f04f22bb7869239d54c10cd9c690dc4f6daf665e",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2018-05-30T19:19:37Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/25233",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25233#event-350830"
}
```
