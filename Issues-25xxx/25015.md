# Issue 25015: Improve introspection capabilities of Sage Jupyter Kernel

archive/issues_024778.json:
```json
{
    "body": "Originally from https://groups.google.com/d/msg/sage-devel/8qr20g0EM5c/U9Kug99SBQAJ\n\nCurrently introspecting Sage objects in Jupyter (either the IPython console or the Notebook) with the `obj?` syntax is little different from the standard Python `help(obj)` output.\n\nIn particular on the Notebook this is not great because it means equations are not rendered--this is a major deficiency compared to SageNB.\n\nThe interface for Jupyter kernels does allow customizing [what is sent back to the client](http://jupyter-client.readthedocs.io/en/stable/messaging.html#introspection) upon object introspection.  My understanding is that this can send back a multi-part MIME message in multiple formats (e.g. plain text and HTML) and the client will pick the most appropriate format to display. So on the Notebook, for example, it will prefer HTML-formatted help if any.\n\nIn this case the thing to do might be to look up the appropriate page for an object in Sage's reference docs, and return the HTML for that object, taking care to make sure that MathJax rendering is applied, and any images returned as well.  I'm not exactly sure about the details of making this work yet (images, for example, might have to be embedded as base64).\n\nRelevant upstream issues:\n\n* https://github.com/jupyter/notebook/issues/4808\n\nPart of #29889.\n\nAssignee: @embray\n\nCC:  @egourgoulhon zerline\n\nAuthor: Erik Bray\n\nBranch: u/embray/ticket-25015\n\nStatus: new\n\nCommit: ec1e13a75695c0e1f1e0c9161cfc6b4cf3b4c687\n\nIssue created by migration from https://trac.sagemath.org/ticket/25015\n\n",
    "created_at": "2018-03-20T11:15:16Z",
    "labels": [
        "component: documentation"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-pending",
    "title": "Improve introspection capabilities of Sage Jupyter Kernel",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25015",
    "user": "https://github.com/embray"
}
```
Originally from https://groups.google.com/d/msg/sage-devel/8qr20g0EM5c/U9Kug99SBQAJ

Currently introspecting Sage objects in Jupyter (either the IPython console or the Notebook) with the `obj?` syntax is little different from the standard Python `help(obj)` output.

In particular on the Notebook this is not great because it means equations are not rendered--this is a major deficiency compared to SageNB.

The interface for Jupyter kernels does allow customizing [what is sent back to the client](http://jupyter-client.readthedocs.io/en/stable/messaging.html#introspection) upon object introspection.  My understanding is that this can send back a multi-part MIME message in multiple formats (e.g. plain text and HTML) and the client will pick the most appropriate format to display. So on the Notebook, for example, it will prefer HTML-formatted help if any.

In this case the thing to do might be to look up the appropriate page for an object in Sage's reference docs, and return the HTML for that object, taking care to make sure that MathJax rendering is applied, and any images returned as well.  I'm not exactly sure about the details of making this work yet (images, for example, might have to be embedded as base64).

Relevant upstream issues:

* https://github.com/jupyter/notebook/issues/4808

Part of #29889.

Assignee: @embray

CC:  @egourgoulhon zerline

Author: Erik Bray

Branch: u/embray/ticket-25015

Status: new

Commit: ec1e13a75695c0e1f1e0c9161cfc6b4cf3b4c687

Issue created by migration from https://trac.sagemath.org/ticket/25015





---

archive/issue_comments_347497.json:
```json
{
    "body": "Set assignee to @embray.",
    "created_at": "2018-03-20T11:15:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25015#issuecomment-347497",
    "user": "https://github.com/embray"
}
```

Set assignee to @embray.



---

archive/issue_comments_347498.json:
```json
{
    "body": "<a id='comment:2'></a>Related issue for CoCalc: https://github.com/sagemathinc/cocalc/issues/2764\n\nI'll implement something compatible with what you do here...",
    "created_at": "2018-03-20T17:30:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25015#issuecomment-347498",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:2'></a>Related issue for CoCalc: https://github.com/sagemathinc/cocalc/issues/2764

I'll implement something compatible with what you do here...



---

archive/issue_comments_347499.json:
```json
{
    "body": "<a id='comment:4'></a>I should add, that while I assigned myself this task OpenDreamKit is currently hiring for a [position](http://opendreamkit.org/2018/02/21/position-paris-sud/) (we're actually interviewing candidates today) under which this work could very likely fall as well.  So depending on how things go I might point someone else in the right direction to work on this...",
    "created_at": "2018-03-21T09:39:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25015#issuecomment-347499",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>I should add, that while I assigned myself this task OpenDreamKit is currently hiring for a [position](http://opendreamkit.org/2018/02/21/position-paris-sud/) (we're actually interviewing candidates today) under which this work could very likely fall as well.  So depending on how things go I might point someone else in the right direction to work on this...



---

archive/issue_events_062741.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-26T12:13:55Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25015",
    "milestone": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25015#event-62741"
}
```



---

archive/issue_events_062742.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-07-18T11:56:06Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25015",
    "milestone": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25015#event-62742"
}
```



---

archive/issue_events_062743.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-07-18T11:56:06Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25015",
    "milestone": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25015#event-62743"
}
```



---

archive/issue_events_062744.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-10-28T11:40:56Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25015",
    "milestone": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25015#event-62744"
}
```



---

archive/issue_events_062745.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-10-28T11:40:56Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25015",
    "milestone": "sage-8.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25015#event-62745"
}
```



---

archive/issue_comments_347500.json:
```json
{
    "body": "<a id='comment:9'></a>Really mostly what this has to do with is ensuring that `help(obj)` and `obj?` where `obj` is some object in the `sage` package displays the corresponding *HTML* documentation for that object if possible.\n\nSo we would need a way to find which page in the HTML docs contains the API documentation for that object, and return the HTML for that page (and specifically the section for that object) to Jupyter.\n\nThis would involve modifying what the Sage Jupyter kernel returns in response to [inspect_request](http://jupyter-client.readthedocs.io/en/stable/messaging.html#introspection) messages.  Right now we just return a `text/plain` response containing the same text that would be displayed on the console.  What we really want is to return a \"MIME bundle\": a dict of \"text/plain\" and \"text/html\".\n\nThe one thing I'm less sure about is the best way to format the HTML.  Would it make sense to *extract* HTML from Sage's HTML docs (but in this case we also need to ensure that all the relevant stylesheets, javascript, etc. are loaded).  Or do we do something like an `<iframe>` and just embed the URL to the appropriate doc page in that?  The `<iframe>` approach might be simpler, but I don't know how well it will work.  This might also be something worth asking on the Jupyter mailing list in case anyone has any advice or experience they could share...",
    "created_at": "2018-11-16T10:57:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25015#issuecomment-347500",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>Really mostly what this has to do with is ensuring that `help(obj)` and `obj?` where `obj` is some object in the `sage` package displays the corresponding *HTML* documentation for that object if possible.

So we would need a way to find which page in the HTML docs contains the API documentation for that object, and return the HTML for that page (and specifically the section for that object) to Jupyter.

This would involve modifying what the Sage Jupyter kernel returns in response to [inspect_request](http://jupyter-client.readthedocs.io/en/stable/messaging.html#introspection) messages.  Right now we just return a `text/plain` response containing the same text that would be displayed on the console.  What we really want is to return a "MIME bundle": a dict of "text/plain" and "text/html".

The one thing I'm less sure about is the best way to format the HTML.  Would it make sense to *extract* HTML from Sage's HTML docs (but in this case we also need to ensure that all the relevant stylesheets, javascript, etc. are loaded).  Or do we do something like an `<iframe>` and just embed the URL to the appropriate doc page in that?  The `<iframe>` approach might be simpler, but I don't know how well it will work.  This might also be something worth asking on the Jupyter mailing list in case anyone has any advice or experience they could share...



---

archive/issue_comments_347501.json:
```json
{
    "body": "<a id='comment:10'></a>The system with the legacy Sage notebook is to run `sphinxify` on the docstring to produce html documentation. Rather than try to extract from the built documentation, shouldn't you just keep doing this? The issue may be making sure that mathjax is loaded.",
    "created_at": "2018-11-16T17:09:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25015#issuecomment-347501",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:10'></a>The system with the legacy Sage notebook is to run `sphinxify` on the docstring to produce html documentation. Rather than try to extract from the built documentation, shouldn't you just keep doing this? The issue may be making sure that mathjax is loaded.



---

archive/issue_comments_347502.json:
```json
{
    "body": "<a id='comment:11'></a>I don't have an informed opinion for how to proceed. \nBut either way, it's useful to recover the URL of the relevant chunk of Sage documentation, to at least include a \"Jump to full/online documentation\" link, enabling the user to browse the whole documentation from that entry point.\n\nThank you for pushing this forward!",
    "created_at": "2018-11-17T10:30:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25015#issuecomment-347502",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:11'></a>I don't have an informed opinion for how to proceed. 
But either way, it's useful to recover the URL of the relevant chunk of Sage documentation, to at least include a "Jump to full/online documentation" link, enabling the user to browse the whole documentation from that entry point.

Thank you for pushing this forward!



---

archive/issue_comments_347503.json:
```json
{
    "body": "<a id='comment:12'></a>Retargeting some of my tickets.",
    "created_at": "2018-12-28T14:09:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25015#issuecomment-347503",
    "user": "https://github.com/embray"
}
```

<a id='comment:12'></a>Retargeting some of my tickets.



---

archive/issue_events_062746.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-12-28T14:09:23Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25015",
    "milestone": "sage-8.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25015#event-62746"
}
```



---

archive/issue_events_062747.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-12-28T14:09:23Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25015",
    "milestone": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25015#event-62747"
}
```



---

archive/issue_events_062748.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-03-25T10:44:36Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25015",
    "milestone": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25015#event-62748"
}
```



---

archive/issue_events_062749.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-03-25T10:44:36Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25015",
    "milestone": "sage-pending",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25015#event-62749"
}
```



---

archive/issue_comments_347504.json:
```json
{
    "body": "<a id='comment:13'></a>Removing most of the rest of my open tickets out of the 8.7 milestone, which should be closed.",
    "created_at": "2019-03-25T10:44:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25015#issuecomment-347504",
    "user": "https://github.com/embray"
}
```

<a id='comment:13'></a>Removing most of the rest of my open tickets out of the 8.7 milestone, which should be closed.



---

archive/issue_comments_347505.json:
```json
{
    "body": "<a id='comment:14'></a>Finally have some progress on a working prototype of this (something I just felt compelled to work on today).\n\nIt turns out to be much more challenging that I originally expected :(\n\nIt turns out that the `inspect_request` message mentioned in the ticket description is only used, in the case of the IPython/Sage kernels, when pressing Shift-Tab to show a tooltip for the object under the cursor.  It has nothing to do, in this case, with what happens when run `obj?`.  That is handled entirely deep within the IPython input transformers, which converts this to a call to:\n\n```\nget_ipython().magic('pinfo obj')\n```\n\nIn other words, `obj?` is equivalent to running the magic `%pinfo obj`.  The implementation of the `pinfo` magic, then, is a complex affair which generates the help output as a string and passes that string to the IPython pager.\n\nSo the trick is the actually override how the `pinfo` magic works (which Sage already does a little bit) to have it pass the pager a \"mime-bundle\" containing both plain text and HTML, where the HTML has been generated by Sage's `sphinxify()` function.\n\nOn top of all that it requires a little more hacking to get the math displayed right.  My prototype mostly works now, save for also loading the necessary CSS for the HTML docs to be displayed better.\n\nHere's a screenshot showing an example of the in-progress work:\n\n<img src=\"ticket-25015.png\" width=100%>\n\nAs you can see, one of the main problems is a lack of margins between paragraphs.  Not shown in the screenshot, but code highlighting in the examples is broken.  This is all due to not having the standard CSS load.  Some non-standard LaTeX macros probably won't render either, though this is a more general problem with have right now in the Jupyter notebook.",
    "created_at": "2019-08-05T15:19:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25015#issuecomment-347505",
    "user": "https://github.com/embray"
}
```

<a id='comment:14'></a>Finally have some progress on a working prototype of this (something I just felt compelled to work on today).

It turns out to be much more challenging that I originally expected :(

It turns out that the `inspect_request` message mentioned in the ticket description is only used, in the case of the IPython/Sage kernels, when pressing Shift-Tab to show a tooltip for the object under the cursor.  It has nothing to do, in this case, with what happens when run `obj?`.  That is handled entirely deep within the IPython input transformers, which converts this to a call to:

```
get_ipython().magic('pinfo obj')
```

In other words, `obj?` is equivalent to running the magic `%pinfo obj`.  The implementation of the `pinfo` magic, then, is a complex affair which generates the help output as a string and passes that string to the IPython pager.

So the trick is the actually override how the `pinfo` magic works (which Sage already does a little bit) to have it pass the pager a "mime-bundle" containing both plain text and HTML, where the HTML has been generated by Sage's `sphinxify()` function.

On top of all that it requires a little more hacking to get the math displayed right.  My prototype mostly works now, save for also loading the necessary CSS for the HTML docs to be displayed better.

Here's a screenshot showing an example of the in-progress work:

<img src="ticket-25015.png" width=100%>

As you can see, one of the main problems is a lack of margins between paragraphs.  Not shown in the screenshot, but code highlighting in the examples is broken.  This is all due to not having the standard CSS load.  Some non-standard LaTeX macros probably won't render either, though this is a more general problem with have right now in the Jupyter notebook.



---

archive/issue_comments_347506.json:
```json
{
    "body": "<a id='comment:15'></a>Attachment [ticket-25015.png](tarball://root/attachments/some-uuid/ticket25015/ticket-25015.png) by @embray created at 2019-08-05 16:00:07\n\nHere's the in-progress version if anyone wants to try it out.\n\n---\nNew commits:",
    "created_at": "2019-08-05T16:00:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25015#issuecomment-347506",
    "user": "https://github.com/embray"
}
```

<a id='comment:15'></a>Attachment [ticket-25015.png](tarball://root/attachments/some-uuid/ticket25015/ticket-25015.png) by @embray created at 2019-08-05 16:00:07

Here's the in-progress version if anyone wants to try it out.

---
New commits:



---

archive/issue_comments_347507.json:
```json
{
    "body": "<a id='comment:16'></a>Another shortcoming I noticed is that `sphinxify()` makes no effort to resolve references, so if one docstring refers to another function or something, that reference won't be linked.\n\nIt would be nice if this could instead produce an actual link.  Perhaps that should be tackled as a separate issue though.",
    "created_at": "2019-08-05T16:03:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25015#issuecomment-347507",
    "user": "https://github.com/embray"
}
```

<a id='comment:16'></a>Another shortcoming I noticed is that `sphinxify()` makes no effort to resolve references, so if one docstring refers to another function or something, that reference won't be linked.

It would be nice if this could instead produce an actual link.  Perhaps that should be tackled as a separate issue though.



---

archive/issue_comments_347508.json:
```json
{
    "body": "<a id='comment:17'></a>Waouh! I've just checked it and it looks already very nice, even without the code highlighting in the doctests. Other shortcomings one might notice:\n- the LaTeX macros `\\RR`, `\\CC`, etc. don't render\n- the plots produced with `sphinx_plot` don't show up\n- if one clicks on the button \"Ouvrir le paginateur dans une fen\u00eatre externe\" (\"Open the pager in external window\" I guess --- sorry, my Jupyter is in French) in the top right of the help page, then the aspect change and the maths are printed twice, with standard LaTeX fonts and with some ugly fonts.\n\nAnyway, all the above seem very minor inconveniences in perspective of the current state, which is ASCII-only documentation. So IMHO we could adopt your \"prototype\" as is and leave further improvements for other tickets.",
    "created_at": "2019-08-14T21:20:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25015#issuecomment-347508",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:17'></a>Waouh! I've just checked it and it looks already very nice, even without the code highlighting in the doctests. Other shortcomings one might notice:
- the LaTeX macros `\RR`, `\CC`, etc. don't render
- the plots produced with `sphinx_plot` don't show up
- if one clicks on the button "Ouvrir le paginateur dans une fenÃªtre externe" ("Open the pager in external window" I guess --- sorry, my Jupyter is in French) in the top right of the help page, then the aspect change and the maths are printed twice, with standard LaTeX fonts and with some ugly fonts.

Anyway, all the above seem very minor inconveniences in perspective of the current state, which is ASCII-only documentation. So IMHO we could adopt your "prototype" as is and leave further improvements for other tickets.



---

archive/issue_comments_347509.json:
```json
{
    "body": "<a id='comment:18'></a>Thank you for testing it out!\n\nI think fixing some of these issues is going to require new features in a Jupyter extension, in particular to load the JavaScript and CSS necessary fo fix some of those issues.\n\nThe double math-rendering thing is odd.  It might be related also this [upstream issue](https://github.com/jupyter/notebook/issues/4808) I opened.  It hasn't gotten any notice yet though.  Maybe it will get more if I go ahead and make a PR to propose a fix...",
    "created_at": "2019-08-15T07:53:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25015#issuecomment-347509",
    "user": "https://github.com/embray"
}
```

<a id='comment:18'></a>Thank you for testing it out!

I think fixing some of these issues is going to require new features in a Jupyter extension, in particular to load the JavaScript and CSS necessary fo fix some of those issues.

The double math-rendering thing is odd.  It might be related also this [upstream issue](https://github.com/jupyter/notebook/issues/4808) I opened.  It hasn't gotten any notice yet though.  Maybe it will get more if I go ahead and make a PR to propose a fix...



---

archive/issue_comments_347510.json:
```json
{
    "body": "<a id='comment:19'></a>Replying to [comment:17 egourgoulhon]:\n> - the LaTeX macros `\\RR`, `\\CC`, etc. don't render\n\n\nBy the way: This is a problem in the Jupyter notebook in general.  Try making a text cell including them--they won't render properly there either, at least in my experience.\n\nIn SageNB, as well as in the Sphinx docs, we manually define these macros from:\n\n```python\ndef latex_extra_preamble():\n    r\"\"\"\n    Return the string containing the user-configured preamble,\n    ``sage_latex_macros``, and any user-configured macros.  This is\n    used in the :meth:`~Latex.eval` method for the :class:`Latex`\n    class, and in :func:`_latex_file_`; it follows either\n    ``LATEX_HEADER`` or ``SLIDE_HEADER`` (defined at the top of this\n    file) which is a string containing the documentclass and standard\n    usepackage commands.\n\n    EXAMPLES::\n\n        sage: from sage.misc.latex import latex_extra_preamble\n        sage: print(latex_extra_preamble())\n        <BLANKLINE>\n        \\newcommand{\\ZZ}{\\Bold{Z}}\n        \\newcommand{\\NN}{\\Bold{N}}\n        \\newcommand{\\RR}{\\Bold{R}}\n        \\newcommand{\\CC}{\\Bold{C}}\n        \\newcommand{\\QQ}{\\Bold{Q}}\n        \\newcommand{\\QQbar}{\\overline{\\QQ}}\n        \\newcommand{\\GF}[1]{\\Bold{F}_{#1}}\n        \\newcommand{\\Zp}[1]{\\Bold{Z}_{#1}}\n        \\newcommand{\\Qp}[1]{\\Bold{Q}_{#1}}\n        \\newcommand{\\Zmod}[1]{\\ZZ/#1\\ZZ}\n        \\newcommand{\\CDF}{\\Bold{C}}\n        \\newcommand{\\CIF}{\\Bold{C}}\n        \\newcommand{\\CLF}{\\Bold{C}}\n        \\newcommand{\\RDF}{\\Bold{R}}\n        \\newcommand{\\RIF}{\\Bold{I} \\Bold{R}}\n        \\newcommand{\\RLF}{\\Bold{R}}\n        \\newcommand{\\Bold}[1]{\\mathbf{#1}}\n        <BLANKLINE>\n    \"\"\"\n    from sage.misc.latex_macros import sage_latex_macros\n    return \"\\n\".join([_Latex_prefs._option['preamble'],\n                     \"\\n\".join(sage_latex_macros()),\n                     _Latex_prefs._option['macros']])\n```\n\nSomehow we need to have the Sage Jupyter Notebook extension output some JavaScript to define these in MathJax.  I'm not really sure how that works though.  Someone with more experience with both Juypter Extensions and MathJax should chime in on that...",
    "created_at": "2019-08-15T08:02:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25015#issuecomment-347510",
    "user": "https://github.com/embray"
}
```

<a id='comment:19'></a>Replying to [comment:17 egourgoulhon]:
> - the LaTeX macros `\RR`, `\CC`, etc. don't render


By the way: This is a problem in the Jupyter notebook in general.  Try making a text cell including them--they won't render properly there either, at least in my experience.

In SageNB, as well as in the Sphinx docs, we manually define these macros from:

```python
def latex_extra_preamble():
    r"""
    Return the string containing the user-configured preamble,
    ``sage_latex_macros``, and any user-configured macros.  This is
    used in the :meth:`~Latex.eval` method for the :class:`Latex`
    class, and in :func:`_latex_file_`; it follows either
    ``LATEX_HEADER`` or ``SLIDE_HEADER`` (defined at the top of this
    file) which is a string containing the documentclass and standard
    usepackage commands.

    EXAMPLES::

        sage: from sage.misc.latex import latex_extra_preamble
        sage: print(latex_extra_preamble())
        <BLANKLINE>
        \newcommand{\ZZ}{\Bold{Z}}
        \newcommand{\NN}{\Bold{N}}
        \newcommand{\RR}{\Bold{R}}
        \newcommand{\CC}{\Bold{C}}
        \newcommand{\QQ}{\Bold{Q}}
        \newcommand{\QQbar}{\overline{\QQ}}
        \newcommand{\GF}[1]{\Bold{F}_{#1}}
        \newcommand{\Zp}[1]{\Bold{Z}_{#1}}
        \newcommand{\Qp}[1]{\Bold{Q}_{#1}}
        \newcommand{\Zmod}[1]{\ZZ/#1\ZZ}
        \newcommand{\CDF}{\Bold{C}}
        \newcommand{\CIF}{\Bold{C}}
        \newcommand{\CLF}{\Bold{C}}
        \newcommand{\RDF}{\Bold{R}}
        \newcommand{\RIF}{\Bold{I} \Bold{R}}
        \newcommand{\RLF}{\Bold{R}}
        \newcommand{\Bold}[1]{\mathbf{#1}}
        <BLANKLINE>
    """
    from sage.misc.latex_macros import sage_latex_macros
    return "\n".join([_Latex_prefs._option['preamble'],
                     "\n".join(sage_latex_macros()),
                     _Latex_prefs._option['macros']])
```

Somehow we need to have the Sage Jupyter Notebook extension output some JavaScript to define these in MathJax.  I'm not really sure how that works though.  Someone with more experience with both Juypter Extensions and MathJax should chime in on that...



---

archive/issue_comments_347511.json:
```json
{
    "body": "<a id='comment:20'></a>Tiny side note:\n\n> This is a problem in the Jupyter notebook in general.\n\n\nFor what it is worth, these macros work in our implementation of Jupyter (for CoCalc), with any kernel.   Also, we use KaTeX by default, which is faster for math rendering.  In addition, we cache rendering, so if you render the same formula again, it's much faster.   \n\nIt might be easier just to get a PR into Jupyter that predefines some useful latex macros.  You would also want to support nbconvert.",
    "created_at": "2019-08-15T17:18:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25015#issuecomment-347511",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:20'></a>Tiny side note:

> This is a problem in the Jupyter notebook in general.


For what it is worth, these macros work in our implementation of Jupyter (for CoCalc), with any kernel.   Also, we use KaTeX by default, which is faster for math rendering.  In addition, we cache rendering, so if you render the same formula again, it's much faster.   

It might be easier just to get a PR into Jupyter that predefines some useful latex macros.  You would also want to support nbconvert.



---

archive/issue_comments_347512.json:
```json
{
    "body": "<a id='comment:21'></a>These macros are defined in `src/sage/misc/latex_macros.py`. That file has a function `sage_mathjax_macros`, which contains versions of these suitable for use with MathJax, and that is what gets used in the legacy Sage notebook. I would hope there is a way to get the Jupyter notebook to use them.",
    "created_at": "2019-08-15T17:25:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25015#issuecomment-347512",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:21'></a>These macros are defined in `src/sage/misc/latex_macros.py`. That file has a function `sage_mathjax_macros`, which contains versions of these suitable for use with MathJax, and that is what gets used in the legacy Sage notebook. I would hope there is a way to get the Jupyter notebook to use them.



---

archive/issue_comments_347513.json:
```json
{
    "body": "<a id='comment:22'></a>A few elements about Sphinx code highlighting:\n\n1) Sphinx uses pygments \"friendly\" style, with some very small changes.\n\n2) At documentation build stage, Sphinx creates a CSS file called pygments.css:\n\nfrom builders/html.py\n\n```\n    def copy_static_files(self):\n        # type: () -> None\n        try:\n            # copy static files\n            logger.info(bold(__('copying static files... ')), nonl=True)\n            ensuredir(path.join(self.outdir, '_static'))\n            # first, create pygments style file\n            with open(path.join(self.outdir, '_static', 'pygments.css'), 'w') as f:\n                f.write(self.highlighter.get_stylesheet())  # type: ignore\n```\n\n3) You can find the resulting CSS file in the HTML documentation tree, ie on\n\n  http://doc.sagemath.org/html/en/reference/_static/pygments.css",
    "created_at": "2019-09-23T12:31:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25015#issuecomment-347513",
    "user": "https://trac.sagemath.org/admin/accounts/users/zerline"
}
```

<a id='comment:22'></a>A few elements about Sphinx code highlighting:

1) Sphinx uses pygments "friendly" style, with some very small changes.

2) At documentation build stage, Sphinx creates a CSS file called pygments.css:

from builders/html.py

```
    def copy_static_files(self):
        # type: () -> None
        try:
            # copy static files
            logger.info(bold(__('copying static files... ')), nonl=True)
            ensuredir(path.join(self.outdir, '_static'))
            # first, create pygments style file
            with open(path.join(self.outdir, '_static', 'pygments.css'), 'w') as f:
                f.write(self.highlighter.get_stylesheet())  # type: ignore
```

3) You can find the resulting CSS file in the HTML documentation tree, ie on

  http://doc.sagemath.org/html/en/reference/_static/pygments.css



---

archive/issue_comments_347514.json:
```json
{
    "body": "<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-09-23T14:33:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25015#issuecomment-347514",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_347515.json:
```json
{
    "body": "<a id='comment:24'></a>I see; we probably don't want to rely on the full HTML docs being built/installed in order to load this stylesheet in the Jupyter kernel though; I'll look at that `copy_static_files` function and see if we can easily replicated its functionality, e.g., when installing the kernel.\n\n---\nNew commits:",
    "created_at": "2019-09-23T15:31:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25015#issuecomment-347515",
    "user": "https://github.com/embray"
}
```

<a id='comment:24'></a>I see; we probably don't want to rely on the full HTML docs being built/installed in order to load this stylesheet in the Jupyter kernel though; I'll look at that `copy_static_files` function and see if we can easily replicated its functionality, e.g., when installing the kernel.

---
New commits:



---

archive/issue_comments_347516.json:
```json
{
    "body": "<a id='comment:25'></a>May I ask about the status of this? It would be so nice to have it in the Sage 9.0 release. Even if it is not fully perfect, it is much much better than having the pure ASCII documentation in Jupyter notebooks...",
    "created_at": "2019-11-06T13:28:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25015#issuecomment-347516",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:25'></a>May I ask about the status of this? It would be so nice to have it in the Sage 9.0 release. Even if it is not fully perfect, it is much much better than having the pure ASCII documentation in Jupyter notebooks...



---

archive/issue_comments_347517.json:
```json
{
    "body": "<a id='comment:26'></a>I haven't had time to work on it so if someone would like to take it over they are welcome to.  I think improving some of the CSS stuff should still be done.\n\nSince this might render *some* documentation *less* legible (e.g. due to the CSS or latex issues) it might be good to have a global function in Sage to enable/disable this (but it could be enabled by default in most cases I think...)",
    "created_at": "2019-12-13T14:01:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25015#issuecomment-347517",
    "user": "https://github.com/embray"
}
```

<a id='comment:26'></a>I haven't had time to work on it so if someone would like to take it over they are welcome to.  I think improving some of the CSS stuff should still be done.

Since this might render *some* documentation *less* legible (e.g. due to the CSS or latex issues) it might be good to have a global function in Sage to enable/disable this (but it could be enabled by default in most cases I think...)
