# Issue 25874: Conversions between S unit group and number field are not each others inverse

archive/issues_025637.json:
```json
{
    "body": "When working in a number field, converting back and forth between elements of the (S) unit group and their values in the number fields does not necessarily give the same element back. Here is a toy example\n\n```\nsage: K = QuadraticField(-3).composite_fields(QuadraticField(2))[0]\nsage: U = K.unit_group()\nsage: [(u, U(K(u))) for u in U.gens()]\n[(u0, u0^5), (u1, u1)]\nsage: US = K.S_unit_group(3)\nsage: [(u, U(K(u))) for u in U.gens()]\n[(u0, u0^5), (u1, u1)]\n```\n\nThis problem does not seem to occur for simple number fields and only causes a problem on the torsion part of the unit group.\n\nLooking into the code it seems that the cause of this problem is that the conversion from the number field to the unit group uses the  pari conversion, which considers a (possibly) different torsion generator then the one picked by sage when the unit group is initialized.\n\nLooking into the pari documentation, pari seems to use bnf.tu (an element stored in the pari number field data object) to convert to the unit group, whilst sage uses the pari function nfrootsof1 to initialize the value of the fundamental unit.\n\nKeywords: number field unit group conversion\n\nBranch/Commit: 42c9f458d1eeb4df03420e03b9dd67e8ec4d62e1\n\nReviewer: Peter Bruin\n\nAuthor: Joey van Langen\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/25874\n\n",
    "closed_at": "2018-11-09T17:16:11Z",
    "created_at": "2018-07-18T09:54:21Z",
    "labels": [
        "component: number fields",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.5",
    "title": "Conversions between S unit group and number field are not each others inverse",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25874",
    "user": "https://trac.sagemath.org/admin/accounts/users/jvlangen"
}
```
When working in a number field, converting back and forth between elements of the (S) unit group and their values in the number fields does not necessarily give the same element back. Here is a toy example

```
sage: K = QuadraticField(-3).composite_fields(QuadraticField(2))[0]
sage: U = K.unit_group()
sage: [(u, U(K(u))) for u in U.gens()]
[(u0, u0^5), (u1, u1)]
sage: US = K.S_unit_group(3)
sage: [(u, U(K(u))) for u in U.gens()]
[(u0, u0^5), (u1, u1)]
```

This problem does not seem to occur for simple number fields and only causes a problem on the torsion part of the unit group.

Looking into the code it seems that the cause of this problem is that the conversion from the number field to the unit group uses the  pari conversion, which considers a (possibly) different torsion generator then the one picked by sage when the unit group is initialized.

Looking into the pari documentation, pari seems to use bnf.tu (an element stored in the pari number field data object) to convert to the unit group, whilst sage uses the pari function nfrootsof1 to initialize the value of the fundamental unit.

Keywords: number field unit group conversion

Branch/Commit: 42c9f458d1eeb4df03420e03b9dd67e8ec4d62e1

Reviewer: Peter Bruin

Author: Joey van Langen

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/25874





---

archive/issue_comments_496425.json:
```json
{
    "body": "<a id='comment:1'></a>\nI am doing some more experimenting and the output of pari's function nfrootsof1 seems to be random, in the sense that calling it successively can give different answers. Of course the root of unity is not unique, but having a different torsion generator each time the unit group is initialized is guaranteed to cause some problems, especially in testing.",
    "created_at": "2018-07-18T10:14:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-496425",
    "user": "https://trac.sagemath.org/admin/accounts/users/jvlangen"
}
```

<a id='comment:1'></a>
I am doing some more experimenting and the output of pari's function nfrootsof1 seems to be random, in the sense that calling it successively can give different answers. Of course the root of unity is not unique, but having a different torsion generator each time the unit group is initialized is guaranteed to cause some problems, especially in testing.



---

archive/issue_comments_496426.json:
```json
{
    "body": "Changing branch from \"\" to \"u/jvlangen/conversions_between_s_unit_group_and_number_field_are_not_each_others_inverse\"",
    "created_at": "2018-07-18T13:03:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-496426",
    "user": "https://trac.sagemath.org/admin/accounts/users/jvlangen"
}
```

Changing branch from "" to "u/jvlangen/conversions_between_s_unit_group_and_number_field_are_not_each_others_inverse"



---

archive/issue_comments_496427.json:
```json
{
    "body": "<a id='comment:3'></a>\nNew commits:\n|                                                                                                                                          |                                              |\n|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------|\n|[72f7ddf](https://git.sagemath.org/sage.git/commit?id=72f7ddffed706ddd58620d4b41688ab8d57b6d3d)|`Changed pK.nfrootsof1 into pK[7][3] (bnf.tu)`|",
    "created_at": "2018-07-18T13:05:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-496427",
    "user": "https://trac.sagemath.org/admin/accounts/users/jvlangen"
}
```

<a id='comment:3'></a>
New commits:
|                                                                                                                                          |                                              |
|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------|
|[72f7ddf](https://git.sagemath.org/sage.git/commit?id=72f7ddffed706ddd58620d4b41688ab8d57b6d3d)|`Changed pK.nfrootsof1 into pK[7][3] (bnf.tu)`|



---

archive/issue_comments_496428.json:
```json
{
    "body": "Changing commit from \"\" to \"72f7ddffed706ddd58620d4b41688ab8d57b6d3d\"",
    "created_at": "2018-07-18T13:05:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-496428",
    "user": "https://trac.sagemath.org/admin/accounts/users/jvlangen"
}
```

Changing commit from "" to "72f7ddffed706ddd58620d4b41688ab8d57b6d3d"



---

archive/issue_comments_496429.json:
```json
{
    "body": "Changing author from \"\" to \"Joey van Langen\"",
    "created_at": "2018-07-18T13:05:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-496429",
    "user": "https://trac.sagemath.org/admin/accounts/users/jvlangen"
}
```

Changing author from "" to "Joey van Langen"



---

archive/issue_comments_496430.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-07-20T12:54:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-496430",
    "user": "https://trac.sagemath.org/admin/accounts/users/jvlangen"
}
```

Changing status from new to needs_review.



---

archive/issue_events_064717.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/jvlangen",
    "created_at": "2018-09-19T09:43:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "milestone": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25874#event-64717"
}
```



---

archive/issue_comments_496431.json:
```json
{
    "body": "<a id='comment:6'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                              |\n|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------|\n|[a95b1d0](https://git.sagemath.org/sage.git/commit/?id=a95b1d02e39166ae38c0a845a03180b02fedebe0)|`Changed pK.nfrootsof1 into pK[7][3] (bnf.tu)`|\n|[9f0e42b](https://git.sagemath.org/sage.git/commit/?id=9f0e42b97674ec9a6e000db4eb9bfd8f0c26f555)|`Merge branch 'u/jvlangen/conversions_between_s_unit_group_and_number_field_are_not_each_others_inverse' of git://trac.sagemath.org/sage into t/25874/conversions_between_s_unit_group_and_number_field_are_not_each_others_inverse`|",
    "created_at": "2018-09-19T10:15:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-496431",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                              |
|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------|
|[a95b1d0](https://git.sagemath.org/sage.git/commit/?id=a95b1d02e39166ae38c0a845a03180b02fedebe0)|`Changed pK.nfrootsof1 into pK[7][3] (bnf.tu)`|
|[9f0e42b](https://git.sagemath.org/sage.git/commit/?id=9f0e42b97674ec9a6e000db4eb9bfd8f0c26f555)|`Merge branch 'u/jvlangen/conversions_between_s_unit_group_and_number_field_are_not_each_others_inverse' of git://trac.sagemath.org/sage into t/25874/conversions_between_s_unit_group_and_number_field_are_not_each_others_inverse`|



---

archive/issue_comments_496432.json:
```json
{
    "body": "Changing commit from \"72f7ddffed706ddd58620d4b41688ab8d57b6d3d\" to \"9f0e42b97674ec9a6e000db4eb9bfd8f0c26f555\"",
    "created_at": "2018-09-19T10:15:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-496432",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "72f7ddffed706ddd58620d4b41688ab8d57b6d3d" to "9f0e42b97674ec9a6e000db4eb9bfd8f0c26f555"



---

archive/issue_comments_496433.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-11-06T20:21:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-496433",
    "user": "https://github.com/pjbruin"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_496434.json:
```json
{
    "body": "<a id='comment:7'></a>\nThere are some failing doctests, see e.g. [this patchbot report](https://patchbot.sagemath.org/log/25874/debian/stretch/sid/x86_64/4.4.0-45-generic/fermat/2018-11-01%2022:54:27?short).",
    "created_at": "2018-11-06T20:21:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-496434",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:7'></a>
There are some failing doctests, see e.g. [this patchbot report](https://patchbot.sagemath.org/log/25874/debian/stretch/sid/x86_64/4.4.0-45-generic/fermat/2018-11-01%2022:54:27?short).



---

archive/issue_comments_496435.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Peter Bruin\"",
    "created_at": "2018-11-06T20:21:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-496435",
    "user": "https://github.com/pjbruin"
}
```

Changing reviewer from "" to "Peter Bruin"



---

archive/issue_comments_496436.json:
```json
{
    "body": "Changing commit from \"9f0e42b97674ec9a6e000db4eb9bfd8f0c26f555\" to \"42c9f458d1eeb4df03420e03b9dd67e8ec4d62e1\"",
    "created_at": "2018-11-07T10:35:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-496436",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "9f0e42b97674ec9a6e000db4eb9bfd8f0c26f555" to "42c9f458d1eeb4df03420e03b9dd67e8ec4d62e1"



---

archive/issue_comments_496437.json:
```json
{
    "body": "<a id='comment:8'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                     |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------|\n|[74b16b7](https://git.sagemath.org/sage.git/commit/?id=74b16b735ff79934fc0c13a5473c4211bfcc1cf5)|`Fixed example case.`|\n|[42c9f45](https://git.sagemath.org/sage.git/commit/?id=42c9f458d1eeb4df03420e03b9dd67e8ec4d62e1)|`Doctest uses tuples instead of lists and now works.`|",
    "created_at": "2018-11-07T10:35:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-496437",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                     |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------|
|[74b16b7](https://git.sagemath.org/sage.git/commit/?id=74b16b735ff79934fc0c13a5473c4211bfcc1cf5)|`Fixed example case.`|
|[42c9f45](https://git.sagemath.org/sage.git/commit/?id=42c9f458d1eeb4df03420e03b9dd67e8ec4d62e1)|`Doctest uses tuples instead of lists and now works.`|



---

archive/issue_comments_496438.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-11-07T10:38:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-496438",
    "user": "https://trac.sagemath.org/admin/accounts/users/jvlangen"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_496439.json:
```json
{
    "body": "<a id='comment:10'></a>\nAs far as I can see this is indeed the right solution, and tests pass.",
    "created_at": "2018-11-07T12:37:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-496439",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:10'></a>
As far as I can see this is indeed the right solution, and tests pass.



---

archive/issue_comments_496440.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-11-07T12:37:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-496440",
    "user": "https://github.com/pjbruin"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_064718.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-11-08T16:12:32Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "milestone": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25874#event-64718"
}
```



---

archive/issue_events_064719.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-11-08T16:12:32Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "milestone": "sage-8.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25874#event-64719"
}
```



---

archive/issue_comments_496441.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-11-09T17:16:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-496441",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_064720.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-11-09T17:16:11Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25874#event-64720"
}
```



---

archive/issue_comments_496442.json:
```json
{
    "body": "Changing branch from \"u/jvlangen/conversions_between_s_unit_group_and_number_field_are_not_each_others_inverse\" to \"42c9f458d1eeb4df03420e03b9dd67e8ec4d62e1\"",
    "created_at": "2018-11-09T17:16:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-496442",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/jvlangen/conversions_between_s_unit_group_and_number_field_are_not_each_others_inverse" to "42c9f458d1eeb4df03420e03b9dd67e8ec4d62e1"
