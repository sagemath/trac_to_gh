# Issue 25301: sparse_2term_quotient_only_pm1 gives different results depending on set iteration order

archive/issues_025064.json:
```json
{
    "body": "This function in the `sage.modular.modsym.relation_matrix_pyx` takes a set as input, and gives different results depending on the iteration order of the set (which is arbitrary, and often different on Python 2 vs Python 3).\n\nWhile this in itself is not at all a bug, but a feature of the algorithm, this has far reaching effect on the results of other computations, resulting in tests that fail on Python 3 since the set ordering is definitely not the same (but the same tests could just as easily fail on Python 2 in principle).\n\nNot sure yet what the best approach is to this.\n\nCC:  @JohnCremona @williamstein @loefflerd @kevinywlui @koffie @pjbruin\n\nBranch/Commit: 19af6889ef08455e4c560d56e382d8921f9ed3f4\n\nReviewer: John Cremona, Erik Bray, Fr\u00e9d\u00e9ric Chapoton\n\nAuthor: John Cremona, Fr\u00e9d\u00e9ric Chapoton\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/25301\n\n",
    "closed_at": "2019-01-24T18:18:04Z",
    "created_at": "2018-05-07T14:00:21Z",
    "labels": [
        "component: python3",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.7",
    "title": "sparse_2term_quotient_only_pm1 gives different results depending on set iteration order",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25301",
    "user": "https://github.com/embray"
}
```
This function in the `sage.modular.modsym.relation_matrix_pyx` takes a set as input, and gives different results depending on the iteration order of the set (which is arbitrary, and often different on Python 2 vs Python 3).

While this in itself is not at all a bug, but a feature of the algorithm, this has far reaching effect on the results of other computations, resulting in tests that fail on Python 3 since the set ordering is definitely not the same (but the same tests could just as easily fail on Python 2 in principle).

Not sure yet what the best approach is to this.

CC:  @JohnCremona @williamstein @loefflerd @kevinywlui @koffie @pjbruin

Branch/Commit: 19af6889ef08455e4c560d56e382d8921f9ed3f4

Reviewer: John Cremona, Erik Bray, Frédéric Chapoton

Author: John Cremona, Frédéric Chapoton

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/25301





---

archive/issue_events_063413.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-07-18T11:57:00Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "milestone": "sage-wishlist",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25301#event-63413"
}
```



---

archive/issue_comments_375346.json:
```json
{
    "body": "<a id='comment:2'></a>New commits:",
    "created_at": "2018-10-05T09:42:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375346",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:2'></a>New commits:



---

archive/issue_comments_375347.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-10-05T09:51:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375347",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_375348.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-10-05T15:33:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375348",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_375349.json:
```json
{
    "body": "<a id='comment:5'></a>So the question is : \n\nshould we just change the doctests or try to make them more robust ?\n\nThe opinion of some experts in modular symbols and Hecke operators is required..",
    "created_at": "2018-10-05T15:35:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375349",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:5'></a>So the question is : 

should we just change the doctests or try to make them more robust ?

The opinion of some experts in modular symbols and Hecke operators is required..



---

archive/issue_comments_375350.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-10-05T15:37:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375350",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_375351.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-10-14T07:23:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375351",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_375352.json:
```json
{
    "body": "<a id='comment:8'></a>a branch making some doctests more robust was moved to #26673",
    "created_at": "2018-11-10T13:11:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375352",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:8'></a>a branch making some doctests more robust was moved to #26673



---

archive/issue_comments_375353.json:
```json
{
    "body": "<a id='comment:9'></a>---\nNew commits:",
    "created_at": "2018-12-20T18:01:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375353",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:9'></a>---
New commits:



---

archive/issue_comments_375354.json:
```json
{
    "body": "<a id='comment:10'></a>**PLEASE**, opinion from experts of modular symbols is required on the failing doctests!\n\nTell us if either\n\n(1) the current change only modifies the bases of modular symbols and is harmless. We just need to change the doctests.\n\nor\n\n(2) at least some of the failing doctests are real failures, with bad and wrong answers",
    "created_at": "2018-12-20T20:32:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375354",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:10'></a>**PLEASE**, opinion from experts of modular symbols is required on the failing doctests!

Tell us if either

(1) the current change only modifies the bases of modular symbols and is harmless. We just need to change the doctests.

or

(2) at least some of the failing doctests are real failures, with bad and wrong answers



---

archive/issue_comments_375355.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2018-12-20T20:32:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375355",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_info.



---

archive/issue_events_063414.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-12-20T20:32:41Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "milestone": "sage-wishlist",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25301#event-63414"
}
```



---

archive/issue_events_063415.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-12-20T20:32:41Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "milestone": "sage-8.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25301#event-63415"
}
```



---

archive/issue_comments_375356.json:
```json
{
    "body": "<a id='comment:12'></a>I'll look at it.   (http://homepages.warwick.ac.uk/staff/J.E.Cremona/theses/index.html should qualify me)",
    "created_at": "2018-12-21T09:44:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375356",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:12'></a>I'll look at it.   (http://homepages.warwick.ac.uk/staff/J.E.Cremona/theses/index.html should qualify me)



---

archive/issue_comments_375357.json:
```json
{
    "body": "<a id='comment:13'></a>I have started working through these, so far have done 3 out of 5 files in sage/modular and all are OK (i.e. the new output is equally valid).  It will take a while to do the rest and I may not get back to it before the middle of next week for obvious reasons.",
    "created_at": "2018-12-21T15:38:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375357",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:13'></a>I have started working through these, so far have done 3 out of 5 files in sage/modular and all are OK (i.e. the new output is equally valid).  It will take a while to do the rest and I may not get back to it before the middle of next week for obvious reasons.



---

archive/issue_comments_375358.json:
```json
{
    "body": "<a id='comment:14'></a>In several places the difference is that a different basis is being used for some vector space, so the matrices of Hecke operators look different.  One plan might be to tag the matrix display as #random but to include the characteristic polynomial in the output.  I am not currently doing this.",
    "created_at": "2018-12-21T17:08:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375358",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:14'></a>In several places the difference is that a different basis is being used for some vector space, so the matrices of Hecke operators look different.  One plan might be to tag the matrix display as #random but to include the characteristic polynomial in the output.  I am not currently doing this.



---

archive/issue_comments_375359.json:
```json
{
    "body": "<a id='comment:15'></a>I'm having trouble with the test in line 217 of modular/modform/modular added for #8018 in 2010, authored by R Beezer and reviewed by AlexGhitza.",
    "created_at": "2018-12-21T17:59:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375359",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:15'></a>I'm having trouble with the test in line 217 of modular/modform/modular added for #8018 in 2010, authored by R Beezer and reviewed by AlexGhitza.



---

archive/issue_comments_375360.json:
```json
{
    "body": "<a id='comment:16'></a>Concerning the idea of tagging with `# random`, this should not be necessary: instead one will change the doctests to their new values. The new values will hopefuly work in both python2 and python3 without problem. The only issue is to be sure that nothing got broken by all these changes of bases. This is exactly what you have started to do, thanks a lot.\n\nIn comment:15, you mean line 217 of `modular/modform/numerical`, right ?",
    "created_at": "2018-12-30T15:11:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375360",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:16'></a>Concerning the idea of tagging with `# random`, this should not be necessary: instead one will change the doctests to their new values. The new values will hopefuly work in both python2 and python3 without problem. The only issue is to be sure that nothing got broken by all these changes of bases. This is exactly what you have started to do, thanks a lot.

In comment:15, you mean line 217 of `modular/modform/numerical`, right ?



---

archive/issue_comments_375361.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [comment:16 chapoton]:\n> Concerning the idea of tagging with `# random`, this should not be necessary: instead one will change the doctests to their new values. The new values will hopefuly work in both python2 and python3 without problem. The only issue is to be sure that nothing got broken by all these changes of bases. This is exactly what you have started to do, thanks a lot.\n\n\n\nOK \n\n> \n> In comment:15, you mean line 217 of `modular/modform/numerical`, right ?\n> \n\n\nyes\n\nI am getting back to this now.",
    "created_at": "2019-01-02T09:18:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375361",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:17'></a>Replying to [comment:16 chapoton]:
> Concerning the idea of tagging with `# random`, this should not be necessary: instead one will change the doctests to their new values. The new values will hopefuly work in both python2 and python3 without problem. The only issue is to be sure that nothing got broken by all these changes of bases. This is exactly what you have started to do, thanks a lot.



OK 

> 
> In comment:15, you mean line 217 of `modular/modform/numerical`, right ?
> 


yes

I am getting back to this now.



---

archive/issue_comments_375362.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-01-02T17:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375362",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_375363.json:
```json
{
    "body": "<a id='comment:19'></a>The latest commit fixes all but one doctest in sage/modular, the last one being the one I mentioned above in the numerical section.  It is hard to get a new example which works since the code finds a random linear combination of a few Tp for small p, which is different every time -- yet one needs to find one such which has eigenvalues quite close together.  I will come back to this.\n\nI mostly just replaced the expected output with what the actual output now is, after doing some tests to check that the new output is reasonable.  In a few places I adapted the doctest to be just as useful but more canonical.  In one place I reworded a docstring (when the output of some modular symbol operation is not literally a monomial modular symbol but a linear combination of these).\n\nI'm adding David Loeffler to the notification list since some of the files I touched are (I think) written and/or worked on by him.  Meanwhile I am looking to see if there are any failing doctests outside sage/modular.",
    "created_at": "2019-01-02T17:08:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375363",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:19'></a>The latest commit fixes all but one doctest in sage/modular, the last one being the one I mentioned above in the numerical section.  It is hard to get a new example which works since the code finds a random linear combination of a few Tp for small p, which is different every time -- yet one needs to find one such which has eigenvalues quite close together.  I will come back to this.

I mostly just replaced the expected output with what the actual output now is, after doing some tests to check that the new output is reasonable.  In a few places I adapted the doctest to be just as useful but more canonical.  In one place I reworded a docstring (when the output of some modular symbol operation is not literally a monomial modular symbol but a linear combination of these).

I'm adding David Loeffler to the notification list since some of the files I touched are (I think) written and/or worked on by him.  Meanwhile I am looking to see if there are any failing doctests outside sage/modular.



---

archive/issue_comments_375364.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2019-01-02T17:10:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375364",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_375365.json:
```json
{
    "body": "<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-01-03T10:01:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375365",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_375366.json:
```json
{
    "body": "<a id='comment:22'></a>There were 6 files outside sage/modular with doctests which needed changing: done.\n\nThat just leaves the numerical one which I will look at again now.",
    "created_at": "2019-01-03T10:02:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375366",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:22'></a>There were 6 files outside sage/modular with doctests which needed changing: done.

That just leaves the numerical one which I will look at again now.



---

archive/issue_comments_375367.json:
```json
{
    "body": "<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-01-03T10:27:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375367",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_375368.json:
```json
{
    "body": "<a id='comment:24'></a>OK all done.\n\nI put myself down as a reviewer but we need further review: I only tested with default python, and also it would be good for another pair of eyes to look at all the doctests I changed.",
    "created_at": "2019-01-03T10:29:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375368",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:24'></a>OK all done.

I put myself down as a reviewer but we need further review: I only tested with default python, and also it would be good for another pair of eyes to look at all the doctests I changed.



---

archive/issue_comments_375369.json:
```json
{
    "body": "<a id='comment:25'></a>Thanks John for your hard work on this ticket, which is of major importance in our progress towards python3.",
    "created_at": "2019-01-03T10:45:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375369",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:25'></a>Thanks John for your hard work on this ticket, which is of major importance in our progress towards python3.



---

archive/issue_comments_375370.json:
```json
{
    "body": "<a id='comment:26'></a>Good, the bot is fully green.",
    "created_at": "2019-01-03T13:46:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375370",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:26'></a>Good, the bot is fully green.



---

archive/issue_comments_375371.json:
```json
{
    "body": "<a id='comment:27'></a>And this fixes all doctests in 14 files in python3.\n\nSo I am extremely tempted to give it a positive review...",
    "created_at": "2019-01-07T13:39:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375371",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:27'></a>And this fixes all doctests in 14 files in python3.

So I am extremely tempted to give it a positive review...



---

archive/issue_comments_375372.json:
```json
{
    "body": "<a id='comment:28'></a>\n```diff\ndiff --git a/src/sage/modular/modsym/relation_matrix.py b/src/sage/modular/modsym/relation_matrix.py\nindex 5e968c3..8e92a7c 100644\n--- a/src/sage/modular/modsym/relation_matrix.py\n+++ b/src/sage/modular/modsym/relation_matrix.py\n@@ -496,7 +496,7 @@ def relation_matrix_wtk_g0(syms, sign, field, sparse):\n         # Let rels = rels union I relations.\n         rels.update(modI_relations(syms, sign))\n \n-    rels = list(rels)\n+    rels = sorted(rels)\n     # should be sorted(rels), but this breaks many doctests\n \n     if syms._apply_S_only_0pm1() and is_RationalField(field):\n```\n\nThere's a still a comment saying \"should be sorted(rels)\" when now it *is* that.\n\n+1 from me unless there's any good reason not to sort (is this a major performance regression anywhere?  We haven't really gotten anywhere with performance testing so who knows...)",
    "created_at": "2019-01-07T13:50:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375372",
    "user": "https://github.com/embray"
}
```

<a id='comment:28'></a>
```diff
diff --git a/src/sage/modular/modsym/relation_matrix.py b/src/sage/modular/modsym/relation_matrix.py
index 5e968c3..8e92a7c 100644
--- a/src/sage/modular/modsym/relation_matrix.py
+++ b/src/sage/modular/modsym/relation_matrix.py
@@ -496,7 +496,7 @@ def relation_matrix_wtk_g0(syms, sign, field, sparse):
         # Let rels = rels union I relations.
         rels.update(modI_relations(syms, sign))
 
-    rels = list(rels)
+    rels = sorted(rels)
     # should be sorted(rels), but this breaks many doctests
 
     if syms._apply_S_only_0pm1() and is_RationalField(field):
```

There's a still a comment saying "should be sorted(rels)" when now it *is* that.

+1 from me unless there's any good reason not to sort (is this a major performance regression anywhere?  We haven't really gotten anywhere with performance testing so who knows...)



---

archive/issue_comments_375373.json:
```json
{
    "body": "<a id='comment:29'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-01-07T13:55:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375373",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:29'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_375374.json:
```json
{
    "body": "<a id='comment:30'></a>In my idea, this change should not impact the performance at all. We are just sorting a bunch of pairs of integers, no big deal.\n\n`@`cremona: do you have some worries on this question of performance regression, John ? What would be a good test to run to make sure that no speed is lost ?",
    "created_at": "2019-01-07T20:58:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375374",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:30'></a>In my idea, this change should not impact the performance at all. We are just sorting a bunch of pairs of integers, no big deal.

`@`cremona: do you have some worries on this question of performance regression, John ? What would be a good test to run to make sure that no speed is lost ?



---

archive/issue_comments_375375.json:
```json
{
    "body": "<a id='comment:31'></a>Before\n\n```\nsage: %timeit ModularSymbols(4691).basis()\n1 loop, best of 3: 1.28 s per loop\n```\nAfter\n\n```\nsage: %timeit ModularSymbols(4691).basis()\n1 loop, best of 3: 1.27 s per loop\n```\nSo I do not see any significant difference here.",
    "created_at": "2019-01-08T09:20:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375375",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:31'></a>Before

```
sage: %timeit ModularSymbols(4691).basis()
1 loop, best of 3: 1.28 s per loop
```
After

```
sage: %timeit ModularSymbols(4691).basis()
1 loop, best of 3: 1.27 s per loop
```
So I do not see any significant difference here.



---

archive/issue_comments_375376.json:
```json
{
    "body": "<a id='comment:32'></a>Replying to [comment:31 chapoton]:\n> Before\n> \n> ```\n> sage: %timeit ModularSymbols(4691).basis()\n> 1 loop, best of 3: 1.28 s per loop\n> ```\n> After\n> \n> ```\n> sage: %timeit ModularSymbols(4691).basis()\n> 1 loop, best of 3: 1.27 s per loop\n> ```\n> So I do not see any significant difference here.\n\n\nThat is just the sort of test I was going to suggest, but 4691 is prime and that is a very special case, so I suggest (as you have the new and old code up and running I think it is easier for you than for me right now) that you also try the following levels:  N with several prime factors (e.g. 2310), larger prime powers, and a combination of the above such as 1680.",
    "created_at": "2019-01-08T09:45:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375376",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:32'></a>Replying to [comment:31 chapoton]:
> Before
> 
> ```
> sage: %timeit ModularSymbols(4691).basis()
> 1 loop, best of 3: 1.28 s per loop
> ```
> After
> 
> ```
> sage: %timeit ModularSymbols(4691).basis()
> 1 loop, best of 3: 1.27 s per loop
> ```
> So I do not see any significant difference here.


That is just the sort of test I was going to suggest, but 4691 is prime and that is a very special case, so I suggest (as you have the new and old code up and running I think it is easier for you than for me right now) that you also try the following levels:  N with several prime factors (e.g. 2310), larger prime powers, and a combination of the above such as 1680.



---

archive/issue_comments_375377.json:
```json
{
    "body": "<a id='comment:33'></a>before:\n\n```\nsage: %timeit ModularSymbols(2310).basis()\n1 loop, best of 3: 6.53 s per loop\nsage: %timeit ModularSymbols(1680).basis()\n1 loop, best of 3: 2.06 s per loop\nsage: %timeit ModularSymbols(5**5).basis()\n1 loop, best of 3: 8.59 s per loop    (fluctuates between 8.59 and 8.65)\n```\nafter:\n\n```\nsage: %timeit ModularSymbols(2310).basis()\n1 loop, best of 3: 6.52 s per loop         (or 6.53)\nsage: %timeit ModularSymbols(1680).basis()\n1 loop, best of 3: 2.07 s per loop\nsage: %timeit ModularSymbols(5**5).basis()\n1 loop, best of 3: 8.68 s per loop    (fluctuates between 8.66 and 8.73)\n```\nSo there is no meaningful difference in the first two cases, I think. The last one for `5**5` fluctuates more than the others, but seems to be consistently slightly slower.",
    "created_at": "2019-01-08T10:08:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375377",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:33'></a>before:

```
sage: %timeit ModularSymbols(2310).basis()
1 loop, best of 3: 6.53 s per loop
sage: %timeit ModularSymbols(1680).basis()
1 loop, best of 3: 2.06 s per loop
sage: %timeit ModularSymbols(5**5).basis()
1 loop, best of 3: 8.59 s per loop    (fluctuates between 8.59 and 8.65)
```
after:

```
sage: %timeit ModularSymbols(2310).basis()
1 loop, best of 3: 6.52 s per loop         (or 6.53)
sage: %timeit ModularSymbols(1680).basis()
1 loop, best of 3: 2.07 s per loop
sage: %timeit ModularSymbols(5**5).basis()
1 loop, best of 3: 8.68 s per loop    (fluctuates between 8.66 and 8.73)
```
So there is no meaningful difference in the first two cases, I think. The last one for `5**5` fluctuates more than the others, but seems to be consistently slightly slower.



---

archive/issue_comments_375378.json:
```json
{
    "body": "<a id='comment:34'></a>Okay, thank you for checking.  I did not think it would likely make a significant difference, but I wasn't exactly sure how best to benchmark that.",
    "created_at": "2019-01-08T13:44:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375378",
    "user": "https://github.com/embray"
}
```

<a id='comment:34'></a>Okay, thank you for checking.  I did not think it would likely make a significant difference, but I wasn't exactly sure how best to benchmark that.



---

archive/issue_comments_375379.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-01-08T13:44:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375379",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_375380.json:
```json
{
    "body": "<a id='comment:36'></a>Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.",
    "created_at": "2019-01-15T18:16:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375380",
    "user": "https://github.com/embray"
}
```

<a id='comment:36'></a>Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.



---

archive/issue_events_063416.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-01-15T18:16:10Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "milestone": "sage-8.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25301#event-63416"
}
```



---

archive/issue_events_063417.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-01-15T18:16:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "milestone": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25301#event-63417"
}
```



---

archive/issue_comments_375381.json:
```json
{
    "body": "<a id='comment:37'></a>On 32-bit:\n\n```\n**********************************************************************\nFile \"src/sage/modular/modform/numerical.py\", line 75, in sage.modular.modform.numerical.NumericalEigenforms\nFailed example:\n    n.ap(2)  # rel tol 2e-15\nExpected:\n    [3.0, -1.6180339887498947, 0.6180339887498968]\nGot:\n    [3.0, -1.6180339887498965, 0.6180339887498943]\nTolerance exceeded in 1 of 3:\n    0.6180339887498968 vs 0.6180339887498943, tolerance 4e-15 > 2e-15\n**********************************************************************\nFile \"src/sage/modular/modform/numerical.py\", line 77, in sage.modular.modform.numerical.NumericalEigenforms\nFailed example:\n    n.systems_of_eigenvalues(7)  # rel tol 2e-15\nExpected:\n    [\n    [-1.6180339887498947, 2.2360679774997894, -3.2360679774997894],\n    [0.6180339887498968, -2.236067977499788, 1.2360679774997936],\n    [3.0, 4.0, 6.0]\n    ]\nGot:\n    [\n    [-1.6180339887498965, 2.2360679774997894, -3.236067977499793],\n    [0.6180339887498943, -2.2360679774997894, 1.2360679774997887],\n    [3.0, 4.0, 6.0]\n    ]\nTolerance exceeded in 2 of 9:\n    0.6180339887498968 vs 0.6180339887498943, tolerance 4e-15 > 2e-15\n    1.2360679774997936 vs 1.2360679774997887, tolerance 4e-15 > 2e-15\n**********************************************************************\nFile \"src/sage/modular/modform/numerical.py\", line 89, in sage.modular.modform.numerical.NumericalEigenforms\nFailed example:\n    n.eigenvalues([2,3,5])  # rel tol 2e-15\nExpected:\n    [[3.0, -1.6180339887498947, 0.6180339887498968],\n     [4.0, 2.2360679774997894, -2.236067977499788],\n     [6.0, -3.2360679774997894, 1.2360679774997936]]\nGot:\n    [[3.0, -1.6180339887498965, 0.6180339887498943],\n     [4.0, 2.2360679774997894, -2.2360679774997894],\n     [6.0, -3.236067977499793, 1.2360679774997887]]\nTolerance exceeded in 2 of 9:\n    0.6180339887498968 vs 0.6180339887498943, tolerance 4e-15 > 2e-15\n    1.2360679774997936 vs 1.2360679774997887, tolerance 4e-15 > 2e-15\n**********************************************************************\n1 item had failures:\n   3 of   7 in sage.modular.modform.numerical.NumericalEigenforms\n    [46 tests, 3 failures, 0.46 s]\n```",
    "created_at": "2019-01-20T00:10:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375381",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:37'></a>On 32-bit:

```
**********************************************************************
File "src/sage/modular/modform/numerical.py", line 75, in sage.modular.modform.numerical.NumericalEigenforms
Failed example:
    n.ap(2)  # rel tol 2e-15
Expected:
    [3.0, -1.6180339887498947, 0.6180339887498968]
Got:
    [3.0, -1.6180339887498965, 0.6180339887498943]
Tolerance exceeded in 1 of 3:
    0.6180339887498968 vs 0.6180339887498943, tolerance 4e-15 > 2e-15
**********************************************************************
File "src/sage/modular/modform/numerical.py", line 77, in sage.modular.modform.numerical.NumericalEigenforms
Failed example:
    n.systems_of_eigenvalues(7)  # rel tol 2e-15
Expected:
    [
    [-1.6180339887498947, 2.2360679774997894, -3.2360679774997894],
    [0.6180339887498968, -2.236067977499788, 1.2360679774997936],
    [3.0, 4.0, 6.0]
    ]
Got:
    [
    [-1.6180339887498965, 2.2360679774997894, -3.236067977499793],
    [0.6180339887498943, -2.2360679774997894, 1.2360679774997887],
    [3.0, 4.0, 6.0]
    ]
Tolerance exceeded in 2 of 9:
    0.6180339887498968 vs 0.6180339887498943, tolerance 4e-15 > 2e-15
    1.2360679774997936 vs 1.2360679774997887, tolerance 4e-15 > 2e-15
**********************************************************************
File "src/sage/modular/modform/numerical.py", line 89, in sage.modular.modform.numerical.NumericalEigenforms
Failed example:
    n.eigenvalues([2,3,5])  # rel tol 2e-15
Expected:
    [[3.0, -1.6180339887498947, 0.6180339887498968],
     [4.0, 2.2360679774997894, -2.236067977499788],
     [6.0, -3.2360679774997894, 1.2360679774997936]]
Got:
    [[3.0, -1.6180339887498965, 0.6180339887498943],
     [4.0, 2.2360679774997894, -2.2360679774997894],
     [6.0, -3.236067977499793, 1.2360679774997887]]
Tolerance exceeded in 2 of 9:
    0.6180339887498968 vs 0.6180339887498943, tolerance 4e-15 > 2e-15
    1.2360679774997936 vs 1.2360679774997887, tolerance 4e-15 > 2e-15
**********************************************************************
1 item had failures:
   3 of   7 in sage.modular.modform.numerical.NumericalEigenforms
    [46 tests, 3 failures, 0.46 s]
```



---

archive/issue_comments_375382.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-01-20T00:10:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375382",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_375383.json:
```json
{
    "body": "<a id='comment:38'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-01-20T10:17:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375383",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:38'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_375384.json:
```json
{
    "body": "<a id='comment:39'></a>I have lowered slightly the precision",
    "created_at": "2019-01-20T10:17:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375384",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:39'></a>I have lowered slightly the precision



---

archive/issue_comments_375385.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-01-20T10:17:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375385",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_375386.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-01-20T10:59:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375386",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_063418.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-01-24T18:18:04Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25301#event-63418"
}
```



---

archive/issue_comments_375387.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-01-24T18:18:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25301#issuecomment-375387",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
