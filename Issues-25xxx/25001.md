# Issue 25001: gfortran breaks parallel build

archive/issues_024764.json:
```json
{
    "body": "gfortran overwrites compiler parts non-atomically; This breaks parallel compilation:\n\n```\n[gfortran-7.2.0] /bin/sh ../../src/gcc/../mkinstalldirs /Users/buildslave-sage/slave/sage_git/build/local/libexec/gcc/x86_64-apple-darwin17.4.0/7.2.0/plugin\n[gfortran-7.2.0] mkdir /Users/buildslave-sage/slave/sage_git/build/local/libexec/gcc/x86_64-apple-darwin17.4.0/7.2.0/plugin\n[gfortran-7.2.0] /usr/bin/install -c gengtype /Users/buildslave-sage/slave/sage_git/build/local/libexec/gcc/x86_64-apple-darwin17.4.0/7.2.0/plugin/gengtype\n[gfortran-7.2.0] for file in gnat1 brig1 cc1 cc1plus f951 go1  lto1 cc1obj cc1objplus; do \\\n[gfortran-7.2.0]          if [ -f $file ] ; then \\\n[gfortran-7.2.0]            rm -f /Users/buildslave-sage/slave/sage_git/build/local/libexec/gcc/x86_64-apple-darwin17.4.0/7.2.0/$file; \\\n[gfortran-7.2.0]            /usr/bin/install -c $file /Users/buildslave-sage/slave/sage_git/build/local/libexec/gcc/x86_64-apple-darwin17.4.0/7.2.0/$file; \\\n[gfortran-7.2.0]          else true; \\\n[gfortran-7.2.0]          fi; \\\n[gfortran-7.2.0]        done\n[flint-2.5.2.p2] gcc: error trying to exec 'cc1': execvp: No such file or directory\n[flint-2.5.2.p2] make[4]: *** [../build/fmpq_poly/test/t-scalar_mul_si] Error 1\n[flint-2.5.2.p2] gcc -fno-common -ansi -pedantic -Wall -O2 -funroll-loops -g -mpopcnt  -I/Users/buildslave-sage/slave/sage_git/build/local/var/tmp/sage/build/flint-2.5.2.p2/src -I/Users/buildslave-sage/slave/sage_git/build/local/include -I/Users/buildslave-sage/slave/sage_git/build/local/include -I/Users/buildslave-sage/slave/sage_git/build/local/include test/t-scalar_mul_ui.c ../build/fmpq_poly/../../test_helpers.o -o ../build/fmpq_poly/test/t-scalar_mul_ui -L/Users/buildslave-sage/slave/sage_git/build/local/var/tmp/sage/build/flint-2.5.2.p2/src -L/Users/buildslave-sage/slave/sage_git/build/local/lib -L/Users/buildslave-sage/slave/sage_git/build/local/lib -L/Users/buildslave-sage/slave/sage_git/build/local/lib -lflint -lmpfr -lgmp -lm -lntl -lpthread  -MMD -MP -MF ../build/fmpq_poly/test/t-scalar_mul_ui.d -MT \"../build/fmpq_poly/test/t-scalar_mul_ui\" -MT \"../build/fmpq_poly/test/t-scalar_mul_ui.d\"\n```\n\nCC:  @embray\n\nKeywords: random_fail\n\nBranch/Commit: [9d149723f008af6eed4a7182da88678bf9fb898d](https://github.com/sagemath/sagetrac-mirror/commit/9d149723f008af6eed4a7182da88678bf9fb898d)\n\nReviewer: Erik Bray\n\nAuthor: Jeroen Demeyer\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/25001\n\n",
    "closed_at": "2018-03-21T06:19:11Z",
    "created_at": "2018-03-18T10:37:20Z",
    "labels": [
        "component: build",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "gfortran breaks parallel build",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25001",
    "user": "https://github.com/vbraun"
}
```
gfortran overwrites compiler parts non-atomically; This breaks parallel compilation:

```
[gfortran-7.2.0] /bin/sh ../../src/gcc/../mkinstalldirs /Users/buildslave-sage/slave/sage_git/build/local/libexec/gcc/x86_64-apple-darwin17.4.0/7.2.0/plugin
[gfortran-7.2.0] mkdir /Users/buildslave-sage/slave/sage_git/build/local/libexec/gcc/x86_64-apple-darwin17.4.0/7.2.0/plugin
[gfortran-7.2.0] /usr/bin/install -c gengtype /Users/buildslave-sage/slave/sage_git/build/local/libexec/gcc/x86_64-apple-darwin17.4.0/7.2.0/plugin/gengtype
[gfortran-7.2.0] for file in gnat1 brig1 cc1 cc1plus f951 go1  lto1 cc1obj cc1objplus; do \
[gfortran-7.2.0]          if [ -f $file ] ; then \
[gfortran-7.2.0]            rm -f /Users/buildslave-sage/slave/sage_git/build/local/libexec/gcc/x86_64-apple-darwin17.4.0/7.2.0/$file; \
[gfortran-7.2.0]            /usr/bin/install -c $file /Users/buildslave-sage/slave/sage_git/build/local/libexec/gcc/x86_64-apple-darwin17.4.0/7.2.0/$file; \
[gfortran-7.2.0]          else true; \
[gfortran-7.2.0]          fi; \
[gfortran-7.2.0]        done
[flint-2.5.2.p2] gcc: error trying to exec 'cc1': execvp: No such file or directory
[flint-2.5.2.p2] make[4]: *** [../build/fmpq_poly/test/t-scalar_mul_si] Error 1
[flint-2.5.2.p2] gcc -fno-common -ansi -pedantic -Wall -O2 -funroll-loops -g -mpopcnt  -I/Users/buildslave-sage/slave/sage_git/build/local/var/tmp/sage/build/flint-2.5.2.p2/src -I/Users/buildslave-sage/slave/sage_git/build/local/include -I/Users/buildslave-sage/slave/sage_git/build/local/include -I/Users/buildslave-sage/slave/sage_git/build/local/include test/t-scalar_mul_ui.c ../build/fmpq_poly/../../test_helpers.o -o ../build/fmpq_poly/test/t-scalar_mul_ui -L/Users/buildslave-sage/slave/sage_git/build/local/var/tmp/sage/build/flint-2.5.2.p2/src -L/Users/buildslave-sage/slave/sage_git/build/local/lib -L/Users/buildslave-sage/slave/sage_git/build/local/lib -L/Users/buildslave-sage/slave/sage_git/build/local/lib -lflint -lmpfr -lgmp -lm -lntl -lpthread  -MMD -MP -MF ../build/fmpq_poly/test/t-scalar_mul_ui.d -MT "../build/fmpq_poly/test/t-scalar_mul_ui" -MT "../build/fmpq_poly/test/t-scalar_mul_ui.d"
```

CC:  @embray

Keywords: random_fail

Branch/Commit: [9d149723f008af6eed4a7182da88678bf9fb898d](https://github.com/sagemath/sagetrac-mirror/commit/9d149723f008af6eed4a7182da88678bf9fb898d)

Reviewer: Erik Bray

Author: Jeroen Demeyer

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/25001





---

archive/issue_comments_477739.json:
```json
{
    "body": "<a id='comment:1'></a>\nWhy is gfortran installing `gcc` in the first place?",
    "created_at": "2018-03-18T15:37:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25001#issuecomment-477739",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:1'></a>
Why is gfortran installing `gcc` in the first place?



---

archive/issue_comments_477740.json:
```json
{
    "body": "<a id='comment:2'></a>\nBecause you cannot build gfortran without a minimal gcc at this stage. There is a section at the end of spkg-install that renames it so it is not in the way. Patching to avoid install is hard.",
    "created_at": "2018-03-18T17:37:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25001#issuecomment-477740",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:2'></a>
Because you cannot build gfortran without a minimal gcc at this stage. There is a section at the end of spkg-install that renames it so it is not in the way. Patching to avoid install is hard.



---

archive/issue_comments_477741.json:
```json
{
    "body": "<a id='comment:3'></a>\nReplying to [fbissey](#comment%3A2):\n> Because you cannot build gfortran without a minimal gcc at this stage.\n\n\nBuilding, I understand. But *installing*?",
    "created_at": "2018-03-18T19:36:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25001#issuecomment-477741",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'></a>
Replying to [fbissey](#comment%3A2):
> Because you cannot build gfortran without a minimal gcc at this stage.


Building, I understand. But *installing*?



---

archive/issue_comments_477742.json:
```json
{
    "body": "<a id='comment:4'></a>\nReplying to [jdemeyer](#comment%3A3):\n> Replying to [fbissey](#comment%3A2):\n> > Because you cannot build gfortran without a minimal gcc at this stage.\n\n> \n> Building, I understand. But *installing*?\n\n\nI know what you mean but as far as I know you cannot build it without it being an install target. If you know some more configure/install options feel free to enlighten me. Otherwise this is a perfect scenario for Erik's work on staging the install rather than installing directly on the system. You could fix something like that in the staging area before merging the install on the system.",
    "created_at": "2018-03-18T19:43:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25001#issuecomment-477742",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:4'></a>
Replying to [jdemeyer](#comment%3A3):
> Replying to [fbissey](#comment%3A2):
> > Because you cannot build gfortran without a minimal gcc at this stage.

> 
> Building, I understand. But *installing*?


I know what you mean but as far as I know you cannot build it without it being an install target. If you know some more configure/install options feel free to enlighten me. Otherwise this is a perfect scenario for Erik's work on staging the install rather than installing directly on the system. You could fix something like that in the staging area before merging the install on the system.



---

archive/issue_comments_477743.json:
```json
{
    "body": "<a id='comment:5'></a>\nThere is a hack we could use, configure with one of `--program-prefix` or `--program-suffix` and then link the resulting `gfortran` binary to the expected name. Says we pass `--program-prefix=sage` and then we will have `sage-gcc`, `sage-gfortran` and so on installed. As the last step we create a link `gfortran` to `sage-gfortran` and since `sage-{gcc,g++}` is not an expected name for other configure scripts, we should be safe.",
    "created_at": "2018-03-18T23:14:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25001#issuecomment-477743",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:5'></a>
There is a hack we could use, configure with one of `--program-prefix` or `--program-suffix` and then link the resulting `gfortran` binary to the expected name. Says we pass `--program-prefix=sage` and then we will have `sage-gcc`, `sage-gfortran` and so on installed. As the last step we create a link `gfortran` to `sage-gfortran` and since `sage-{gcc,g++}` is not an expected name for other configure scripts, we should be safe.



---

archive/issue_comments_477744.json:
```json
{
    "body": "<a id='comment:6'></a>\nOr maybe just not compile other stuff until gfortran is complete, like gcc",
    "created_at": "2018-03-19T07:59:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25001#issuecomment-477744",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:6'></a>
Or maybe just not compile other stuff until gfortran is complete, like gcc



---

archive/issue_comments_477745.json:
```json
{
    "body": "<a id='comment:7'></a>\nReplying to [fbissey](#comment%3A4):\n> Otherwise this is a perfect scenario for Erik's work on staging the install rather than installing directly on the system.\n\n\n+1",
    "created_at": "2018-03-19T08:06:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25001#issuecomment-477745",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>
Replying to [fbissey](#comment%3A4):
> Otherwise this is a perfect scenario for Erik's work on staging the install rather than installing directly on the system.


+1



---

archive/issue_comments_477746.json:
```json
{
    "body": "<a id='comment:8'></a>\nI'll try the staged install, just to see whether it might work.",
    "created_at": "2018-03-19T08:07:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25001#issuecomment-477746",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>
I'll try the staged install, just to see whether it might work.



---

archive/issue_comments_477747.json:
```json
{
    "body": "Branch: [u/jdemeyer/gfortran_breaks_parallel_build](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/gfortran_breaks_parallel_build)",
    "created_at": "2018-03-19T08:13:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25001#issuecomment-477747",
    "user": "https://github.com/jdemeyer"
}
```

Branch: [u/jdemeyer/gfortran_breaks_parallel_build](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/gfortran_breaks_parallel_build)



---

archive/issue_comments_477748.json:
```json
{
    "body": "<a id='comment:10'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n|                                                                                                                                           |                                       |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------|\n|[330e618](https://github.com/sagemath/sagetrac-mirror/commit/330e618a402500a7abd4907f13a8d99e42f35191)|`Introduce SAGE_DESTDIR_LOCAL variable`|\n|[04f992c](https://github.com/sagemath/sagetrac-mirror/commit/04f992c9e176f4645d5c6b72624587dfa6357a9b)|`Don't install gcc as part of gfortran`|",
    "created_at": "2018-03-19T08:32:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25001#issuecomment-477748",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
|                                                                                                                                           |                                       |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------|
|[330e618](https://github.com/sagemath/sagetrac-mirror/commit/330e618a402500a7abd4907f13a8d99e42f35191)|`Introduce SAGE_DESTDIR_LOCAL variable`|
|[04f992c](https://github.com/sagemath/sagetrac-mirror/commit/04f992c9e176f4645d5c6b72624587dfa6357a9b)|`Don't install gcc as part of gfortran`|



---

archive/issue_comments_477749.json:
```json
{
    "body": "Commit: [04f992c9e176f4645d5c6b72624587dfa6357a9b](https://github.com/sagemath/sagetrac-mirror/commit/04f992c9e176f4645d5c6b72624587dfa6357a9b)",
    "created_at": "2018-03-19T08:32:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25001#issuecomment-477749",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Commit: [04f992c9e176f4645d5c6b72624587dfa6357a9b](https://github.com/sagemath/sagetrac-mirror/commit/04f992c9e176f4645d5c6b72624587dfa6357a9b)



---

archive/issue_comments_477750.json:
```json
{
    "body": "<a id='comment:11'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n|                                                                                                                                           |                                       |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------|\n|[9d14972](https://github.com/sagemath/sagetrac-mirror/commit/9d149723f008af6eed4a7182da88678bf9fb898d)|`Don't install gcc as part of gfortran`|",
    "created_at": "2018-03-19T08:52:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25001#issuecomment-477750",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
|                                                                                                                                           |                                       |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------|
|[9d14972](https://github.com/sagemath/sagetrac-mirror/commit/9d149723f008af6eed4a7182da88678bf9fb898d)|`Don't install gcc as part of gfortran`|



---

archive/issue_comments_477751.json:
```json
{
    "body": "Changing commit from \"[04f992c9e176f4645d5c6b72624587dfa6357a9b](https://github.com/sagemath/sagetrac-mirror/commit/04f992c9e176f4645d5c6b72624587dfa6357a9b)\" to \"[9d149723f008af6eed4a7182da88678bf9fb898d](https://github.com/sagemath/sagetrac-mirror/commit/9d149723f008af6eed4a7182da88678bf9fb898d)\"",
    "created_at": "2018-03-19T08:52:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25001#issuecomment-477751",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "[04f992c9e176f4645d5c6b72624587dfa6357a9b](https://github.com/sagemath/sagetrac-mirror/commit/04f992c9e176f4645d5c6b72624587dfa6357a9b)" to "[9d149723f008af6eed4a7182da88678bf9fb898d](https://github.com/sagemath/sagetrac-mirror/commit/9d149723f008af6eed4a7182da88678bf9fb898d)"



---

archive/issue_comments_477752.json:
```json
{
    "body": "Author: Jeroen Demeyer",
    "created_at": "2018-03-19T09:03:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25001#issuecomment-477752",
    "user": "https://github.com/jdemeyer"
}
```

Author: Jeroen Demeyer



---

archive/issue_comments_477753.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-03-19T09:03:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25001#issuecomment-477753",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_477754.json:
```json
{
    "body": "<a id='comment:13'></a>\nIf the bits in `sage-spkg` do their jobs as expected then it looks good to me.",
    "created_at": "2018-03-19T09:08:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25001#issuecomment-477754",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:13'></a>
If the bits in `sage-spkg` do their jobs as expected then it looks good to me.



---

archive/issue_comments_477755.json:
```json
{
    "body": "Reviewer: Erik Bray",
    "created_at": "2018-03-19T11:13:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25001#issuecomment-477755",
    "user": "https://github.com/embray"
}
```

Reviewer: Erik Bray



---

archive/issue_comments_477756.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-03-19T11:13:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25001#issuecomment-477756",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_477757.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-03-21T06:19:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25001#issuecomment-477757",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_477758.json:
```json
{
    "body": "Changing branch from \"[u/jdemeyer/gfortran_breaks_parallel_build](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/gfortran_breaks_parallel_build)\" to \"[9d149723f008af6eed4a7182da88678bf9fb898d](https://github.com/sagemath/sagetrac-mirror/commit/9d149723f008af6eed4a7182da88678bf9fb898d)\"",
    "created_at": "2018-03-21T06:19:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25001#issuecomment-477758",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "[u/jdemeyer/gfortran_breaks_parallel_build](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/gfortran_breaks_parallel_build)" to "[9d149723f008af6eed4a7182da88678bf9fb898d](https://github.com/sagemath/sagetrac-mirror/commit/9d149723f008af6eed4a7182da88678bf9fb898d)"



---

archive/issue_events_071336.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-03-21T06:19:11Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/25001",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25001#event-71336"
}
```
