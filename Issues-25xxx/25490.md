# Issue 25490: Fix Matrix_gfpn_dense.rescale_row_c

archive/issues_025253.json:
```json
{
    "body": "There are two problems with `Matrix_gfpn_dense.rescale_row_c`:\n1. The optional argument `start_col` is not supported - see also #25476.\n2. It is assumed that the field and the row size (which are global variables in MeatAxe) are correctly assigned to, but this assumption is easily violated:\n\n```\nsage: K.<x> = GF(25)\nsage: L.<y> = GF(81)\nsage: M = MatrixSpace(K,1,25)(sorted(list(K)))\nsage: N = MatrixSpace(L,5,5)(sorted(list(L))[:25])\nsage: M.rescale_row(0,2)\nsage: M\n[      0       2       1   x + 1   x + 3       x   x + 1   x + 2   x + 3   x + 4     2*x 2*x + 1 2*x + 2 2*x + 3 2*x + 4     3*x 3*x + 1 3*x + 2 3*x + 3 3*x + 4     4*x 4*x + 1 4*x + 2 4*x + 3 4*x + 4]\nsage: M = MatrixSpace(K,1,25)(sorted(list(K)))\nsage: M.rescale_row(0,2)\nsage: M\n[      0       2       4       1       3     2*x 2*x + 2 2*x + 4 2*x + 1 2*x + 3     4*x 4*x + 2 4*x + 4 4*x + 1 4*x + 3       x   x + 2   x + 4   x + 1   x + 3     3*x 3*x + 2 3*x + 4 3*x + 1 3*x + 3]\n```\nSo, in the first part of the example, creation of `N` makes MeatAxe believe that the current row size is 5 and the field has 81 elements, and therefore rescaling `M` is doomed.\n\n**CC:**  @tscrim\n\n**Keywords:** MeatAxe rescale row, days94\n\n**Branch/Commit:** [1a97f39ec01d45fb9a59fe9512689e3e35245d52](https://github.com/sagemath/sagetrac-mirror/commit/1a97f39ec01d45fb9a59fe9512689e3e35245d52)\n\n**Reviewer:** Travis Scrimshaw\n\n**Author:** Simon King\n\n**Dependencies:** #25518\n\nIssue created by migration from https://trac.sagemath.org/ticket/25490\n\n",
    "closed_at": "2018-06-30T15:21:16Z",
    "created_at": "2018-06-01T10:22:05Z",
    "labels": [
        "component: packages: optional",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.3",
    "title": "Fix Matrix_gfpn_dense.rescale_row_c",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/25490",
    "user": "https://github.com/simon-king-jena"
}
```
There are two problems with `Matrix_gfpn_dense.rescale_row_c`:
1. The optional argument `start_col` is not supported - see also #25476.
2. It is assumed that the field and the row size (which are global variables in MeatAxe) are correctly assigned to, but this assumption is easily violated:

```
sage: K.<x> = GF(25)
sage: L.<y> = GF(81)
sage: M = MatrixSpace(K,1,25)(sorted(list(K)))
sage: N = MatrixSpace(L,5,5)(sorted(list(L))[:25])
sage: M.rescale_row(0,2)
sage: M
[      0       2       1   x + 1   x + 3       x   x + 1   x + 2   x + 3   x + 4     2*x 2*x + 1 2*x + 2 2*x + 3 2*x + 4     3*x 3*x + 1 3*x + 2 3*x + 3 3*x + 4     4*x 4*x + 1 4*x + 2 4*x + 3 4*x + 4]
sage: M = MatrixSpace(K,1,25)(sorted(list(K)))
sage: M.rescale_row(0,2)
sage: M
[      0       2       4       1       3     2*x 2*x + 2 2*x + 4 2*x + 1 2*x + 3     4*x 4*x + 2 4*x + 4 4*x + 1 4*x + 3       x   x + 2   x + 4   x + 1   x + 3     3*x 3*x + 2 3*x + 4 3*x + 1 3*x + 3]
```
So, in the first part of the example, creation of `N` makes MeatAxe believe that the current row size is 5 and the field has 81 elements, and therefore rescaling `M` is doomed.

**CC:**  @tscrim

**Keywords:** MeatAxe rescale row, days94

**Branch/Commit:** [1a97f39ec01d45fb9a59fe9512689e3e35245d52](https://github.com/sagemath/sagetrac-mirror/commit/1a97f39ec01d45fb9a59fe9512689e3e35245d52)

**Reviewer:** Travis Scrimshaw

**Author:** Simon King

**Dependencies:** #25518

Issue created by migration from https://trac.sagemath.org/ticket/25490





---

archive/issue_comments_393446.json:
```json
{
    "body": "**Dependencies:** #25476",
    "created_at": "2018-06-01T10:33:16Z",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25490#issuecomment-393446",
    "user": "https://github.com/simon-king-jena"
}
```

**Dependencies:** #25476



---

archive/issue_comments_393447.json:
```json
{
    "body": "<a id='comment:2'></a>\nAs it turns out, there are several places in which I forgot to assign the field and/or row size before calling a `Ff*` function from MeatAxe. So, I am fixing these as well. Note that it is fine to call an `Ff*` function for a matrix after calling a `Mat*` function from MeatAxe, because the `Mat*` functions all assign the correct field and row size.",
    "created_at": "2018-06-01T10:53:36Z",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25490#issuecomment-393447",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:2'></a>
As it turns out, there are several places in which I forgot to assign the field and/or row size before calling a `Ff*` function from MeatAxe. So, I am fixing these as well. Note that it is fine to call an `Ff*` function for a matrix after calling a `Mat*` function from MeatAxe, because the `Mat*` functions all assign the correct field and row size.



---

archive/issue_comments_393448.json:
```json
{
    "body": "<a id='comment:3'></a>\nSounds good.",
    "created_at": "2018-06-01T10:54:32Z",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25490#issuecomment-393448",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:3'></a>
Sounds good.



---

archive/issue_comments_393449.json:
```json
{
    "body": "**Branch:** [u/SimonKing/fix_matrix_gfpn_dense_rescale_row_c](https://github.com/sagemath/sagetrac-mirror/tree/u/SimonKing/fix_matrix_gfpn_dense_rescale_row_c)",
    "created_at": "2018-06-01T17:24:03Z",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25490#issuecomment-393449",
    "user": "https://github.com/simon-king-jena"
}
```

**Branch:** [u/SimonKing/fix_matrix_gfpn_dense_rescale_row_c](https://github.com/sagemath/sagetrac-mirror/tree/u/SimonKing/fix_matrix_gfpn_dense_rescale_row_c)



---

archive/issue_comments_393450.json:
```json
{
    "body": "<a id='comment:5'></a>\nI fixed a couple of places where field and row size are not assigned, and I enabled the use of the optional `start_col` argument of `add_multiple_of_row_c` and `rescale_row_c`. Tests in sage/matrix/ pass.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4eae803913d67d3f46f58e56d3524c9b4f73b002\">4eae803</a></td><td><code>Making matrices use the new _echelon_in_place method.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9792b5377bd5fa19b11eb797cd0bb2fd4035dcee\">9792b53</a></td><td><code>Matrix_gfpn_dense: Fix field and row size assignments; use start_col argument</code></td></tr></table>\n",
    "created_at": "2018-06-01T17:26:03Z",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25490#issuecomment-393450",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:5'></a>
I fixed a couple of places where field and row size are not assigned, and I enabled the use of the optional `start_col` argument of `add_multiple_of_row_c` and `rescale_row_c`. Tests in sage/matrix/ pass.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4eae803913d67d3f46f58e56d3524c9b4f73b002">4eae803</a></td><td><code>Making matrices use the new _echelon_in_place method.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9792b5377bd5fa19b11eb797cd0bb2fd4035dcee">9792b53</a></td><td><code>Matrix_gfpn_dense: Fix field and row size assignments; use start_col argument</code></td></tr></table>




---

archive/issue_events_226373.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2018-06-01T17:26:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25490#event-226373"
}
```



---

archive/issue_comments_393451.json:
```json
{
    "body": "**Author:** Simon King",
    "created_at": "2018-06-01T17:26:03Z",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25490#issuecomment-393451",
    "user": "https://github.com/simon-king-jena"
}
```

**Author:** Simon King



---

archive/issue_comments_393452.json:
```json
{
    "body": "**Commit:** [9792b5377bd5fa19b11eb797cd0bb2fd4035dcee](https://github.com/sagemath/sagetrac-mirror/commit/9792b5377bd5fa19b11eb797cd0bb2fd4035dcee)",
    "created_at": "2018-06-01T17:26:03Z",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25490#issuecomment-393452",
    "user": "https://github.com/simon-king-jena"
}
```

**Commit:** [9792b5377bd5fa19b11eb797cd0bb2fd4035dcee](https://github.com/sagemath/sagetrac-mirror/commit/9792b5377bd5fa19b11eb797cd0bb2fd4035dcee)



---

archive/issue_comments_393453.json:
```json
{
    "body": "<a id='comment:6'></a>\nPS: I needed to import some additional stuff from SharedMeatAxe, which means that I needed to change sage/libs/meataxe.pxd as well.",
    "created_at": "2018-06-01T17:27:04Z",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25490#issuecomment-393453",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:6'></a>
PS: I needed to import some additional stuff from SharedMeatAxe, which means that I needed to change sage/libs/meataxe.pxd as well.



---

archive/issue_events_226374.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-06-06T12:41:26Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25490#event-226374"
}
```



---

archive/issue_events_226375.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-06-06T12:41:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25490#event-226375"
}
```



---

archive/issue_comments_393454.json:
```json
{
    "body": "**Changing dependencies** from \"#25476\" to \"#25518\".",
    "created_at": "2018-06-06T12:41:26Z",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25490#issuecomment-393454",
    "user": "https://github.com/jdemeyer"
}
```

**Changing dependencies** from "#25476" to "#25518".



---

archive/issue_comments_393455.json:
```json
{
    "body": "**Changing branch** from \"[u/SimonKing/fix_matrix_gfpn_dense_rescale_row_c](https://github.com/sagemath/sagetrac-mirror/tree/u/SimonKing/fix_matrix_gfpn_dense_rescale_row_c)\" to \"[u/jdemeyer/fix_matrix_gfpn_dense_rescale_row_c](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/fix_matrix_gfpn_dense_rescale_row_c)\".",
    "created_at": "2018-06-06T13:09:59Z",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25490#issuecomment-393455",
    "user": "https://github.com/jdemeyer"
}
```

**Changing branch** from "[u/SimonKing/fix_matrix_gfpn_dense_rescale_row_c](https://github.com/sagemath/sagetrac-mirror/tree/u/SimonKing/fix_matrix_gfpn_dense_rescale_row_c)" to "[u/jdemeyer/fix_matrix_gfpn_dense_rescale_row_c](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/fix_matrix_gfpn_dense_rescale_row_c)".



---

archive/issue_comments_393456.json:
```json
{
    "body": "<a id='comment:9'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e2f0550696a5dbc9e0cd595d1eda7d9b9048d06d\">e2f0550</a></td><td><code>Specify that _echelon_in_place shall return the pivots</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3c4a06d3080dd8528053be95b86154822d4d2b79\">3c4a06d</a></td><td><code>Enable _mul_long for matrices</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1eaed37b0176c911a8d1a7ce36814db13c9b4b8b\">1eaed37</a></td><td><code>More stuff in the meataxe interface, and a meataxe helper function</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8a06c0f42b937e697e7585332383c69fbf7625cc\">8a06c0f</a></td><td><code>Fix docstring formatting</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/cef13b8f2aece9c723dfa10f221fc14ac67c22af\">cef13b8</a></td><td><code>Matrix_gfpn_dense: Fix field and row size assignments; use start_col argument</code></td></tr></table>\n",
    "created_at": "2018-06-06T13:12:25Z",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25490#issuecomment-393456",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e2f0550696a5dbc9e0cd595d1eda7d9b9048d06d">e2f0550</a></td><td><code>Specify that _echelon_in_place shall return the pivots</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3c4a06d3080dd8528053be95b86154822d4d2b79">3c4a06d</a></td><td><code>Enable _mul_long for matrices</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1eaed37b0176c911a8d1a7ce36814db13c9b4b8b">1eaed37</a></td><td><code>More stuff in the meataxe interface, and a meataxe helper function</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8a06c0f42b937e697e7585332383c69fbf7625cc">8a06c0f</a></td><td><code>Fix docstring formatting</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/cef13b8f2aece9c723dfa10f221fc14ac67c22af">cef13b8</a></td><td><code>Matrix_gfpn_dense: Fix field and row size assignments; use start_col argument</code></td></tr></table>




---

archive/issue_events_226376.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-06-06T13:12:25Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25490#event-226376"
}
```



---

archive/issue_events_226377.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-06-06T13:12:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25490#event-226377"
}
```



---

archive/issue_comments_393457.json:
```json
{
    "body": "**Changing commit** from \"[9792b5377bd5fa19b11eb797cd0bb2fd4035dcee](https://github.com/sagemath/sagetrac-mirror/commit/9792b5377bd5fa19b11eb797cd0bb2fd4035dcee)\" to \"[cef13b8f2aece9c723dfa10f221fc14ac67c22af](https://github.com/sagemath/sagetrac-mirror/commit/cef13b8f2aece9c723dfa10f221fc14ac67c22af)\".",
    "created_at": "2018-06-06T13:12:25Z",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25490#issuecomment-393457",
    "user": "https://github.com/jdemeyer"
}
```

**Changing commit** from "[9792b5377bd5fa19b11eb797cd0bb2fd4035dcee](https://github.com/sagemath/sagetrac-mirror/commit/9792b5377bd5fa19b11eb797cd0bb2fd4035dcee)" to "[cef13b8f2aece9c723dfa10f221fc14ac67c22af](https://github.com/sagemath/sagetrac-mirror/commit/cef13b8f2aece9c723dfa10f221fc14ac67c22af)".



---

archive/issue_comments_393458.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [SimonKing](#comment%3A6):\n> PS: I needed to import some additional stuff from SharedMeatAxe, which means that I needed to change sage/libs/meataxe.pxd as well.\n\n\nThis part has been moved to #25518.",
    "created_at": "2018-06-06T13:13:10Z",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25490#issuecomment-393458",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>
Replying to [SimonKing](#comment%3A6):
> PS: I needed to import some additional stuff from SharedMeatAxe, which means that I needed to change sage/libs/meataxe.pxd as well.


This part has been moved to #25518.



---

archive/issue_comments_393459.json:
```json
{
    "body": "<a id='comment:11'></a>\nThis looks like a mistake:\n\n```diff\n@@ -1231,6 +1317,7 @@ cdef class Matrix_gfpn_dense(Matrix_dense):\n         \"\"\"\n         if self.Data == NULL:\n             raise ValueError(\"The matrix must not be empty\")\n+        FfSetField(self.Data.Field)\n         cdef Matrix_gfpn_dense left\n         FfSetField(self.Data.Field)\n         cdef FEL r\n```\n\nAlso, have you noticed a speed regression by not doing it purely in MeatAxe? In particular, I am wondering if it might be worthwhile to patch MeatAxe instead of implementing it in Sage.",
    "created_at": "2018-06-07T06:06:24Z",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25490#issuecomment-393459",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:11'></a>
This looks like a mistake:

```diff
@@ -1231,6 +1317,7 @@ cdef class Matrix_gfpn_dense(Matrix_dense):
         """
         if self.Data == NULL:
             raise ValueError("The matrix must not be empty")
+        FfSetField(self.Data.Field)
         cdef Matrix_gfpn_dense left
         FfSetField(self.Data.Field)
         cdef FEL r
```

Also, have you noticed a speed regression by not doing it purely in MeatAxe? In particular, I am wondering if it might be worthwhile to patch MeatAxe instead of implementing it in Sage.



---

archive/issue_events_226378.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-06-07T07:38:57Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25490#event-226378"
}
```



---

archive/issue_events_226379.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-06-07T07:38:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25490#event-226379"
}
```



---

archive/issue_comments_393460.json:
```json
{
    "body": "<a id='comment:12'></a>\nReplying to [tscrim](#comment%3A11):\n> This looks like a mistake\n\n\nYes, I guess the same patch was added on two different tickets (#25079 and #25490).",
    "created_at": "2018-06-07T07:38:57Z",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25490#issuecomment-393460",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>
Replying to [tscrim](#comment%3A11):
> This looks like a mistake


Yes, I guess the same patch was added on two different tickets (#25079 and #25490).



---

archive/issue_comments_393461.json:
```json
{
    "body": "<a id='comment:13'></a>\nReplying to [tscrim](#comment%3A11):\n> This looks like a mistake:\n> \n> ```diff\n> @@ -1231,6 +1317,7 @@ cdef class Matrix_gfpn_dense(Matrix_dense):\n>          \"\"\"\n>          if self.Data == NULL:\n>              raise ValueError(\"The matrix must not be empty\")\n> +        FfSetField(self.Data.Field)\n>          cdef Matrix_gfpn_dense left\n>          FfSetField(self.Data.Field)\n>          cdef FEL r\n> ```\n\n\nRight, setting the field twice is a mistake.\n\n> Also, have you noticed a speed regression by not doing it purely in MeatAxe? In particular, I am wondering if it might be worthwhile to patch MeatAxe instead of implementing it in Sage.\n\n\nPatching wouldn't be needed, as I am upstream for SharedMeatAxe. But I don't expect that it would be really worth-while in terms of speed. In the end, both approaches yield more or less the same C code.",
    "created_at": "2018-06-07T07:43:04Z",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25490#issuecomment-393461",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:13'></a>
Replying to [tscrim](#comment%3A11):
> This looks like a mistake:
> 
> ```diff
> @@ -1231,6 +1317,7 @@ cdef class Matrix_gfpn_dense(Matrix_dense):
>          """
>          if self.Data == NULL:
>              raise ValueError("The matrix must not be empty")
> +        FfSetField(self.Data.Field)
>          cdef Matrix_gfpn_dense left
>          FfSetField(self.Data.Field)
>          cdef FEL r
> ```


Right, setting the field twice is a mistake.

> Also, have you noticed a speed regression by not doing it purely in MeatAxe? In particular, I am wondering if it might be worthwhile to patch MeatAxe instead of implementing it in Sage.


Patching wouldn't be needed, as I am upstream for SharedMeatAxe. But I don't expect that it would be really worth-while in terms of speed. In the end, both approaches yield more or less the same C code.



---

archive/issue_comments_393462.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [SimonKing](#comment%3A13):\n> Replying to [tscrim](#comment%3A11):\n> > Also, have you noticed a speed regression by not doing it purely in MeatAxe? In particular, I am wondering if it might be worthwhile to patch MeatAxe instead of implementing it in Sage.\n\n> \n> Patching wouldn't be needed, as I am upstream for SharedMeatAxe. But I don't expect that it would be really worth-while in terms of speed. In the end, both approaches yield more or less the same C code.\n\n\nIt just seems to me everything I look into the Cython generated C code, it seems like there could be a bit of overhead (and this might be something the library might benefit from having internally). However, I am content with the current state here (modulo the double set).",
    "created_at": "2018-06-07T09:15:00Z",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25490#issuecomment-393462",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:14'></a>
Replying to [SimonKing](#comment%3A13):
> Replying to [tscrim](#comment%3A11):
> > Also, have you noticed a speed regression by not doing it purely in MeatAxe? In particular, I am wondering if it might be worthwhile to patch MeatAxe instead of implementing it in Sage.

> 
> Patching wouldn't be needed, as I am upstream for SharedMeatAxe. But I don't expect that it would be really worth-while in terms of speed. In the end, both approaches yield more or less the same C code.


It just seems to me everything I look into the Cython generated C code, it seems like there could be a bit of overhead (and this might be something the library might benefit from having internally). However, I am content with the current state here (modulo the double set).



---

archive/issue_comments_393463.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [tscrim](#comment%3A14):\n> It just seems to me everything I look into the Cython generated C code, it seems like there could be a bit of overhead\n\n\nIf you have concrete examples of this, I'm sure that Cython upstream would be interested in fixing that.",
    "created_at": "2018-06-07T09:17:44Z",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25490#issuecomment-393463",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:15'></a>
Replying to [tscrim](#comment%3A14):
> It just seems to me everything I look into the Cython generated C code, it seems like there could be a bit of overhead


If you have concrete examples of this, I'm sure that Cython upstream would be interested in fixing that.



---

archive/issue_comments_393464.json:
```json
{
    "body": "<a id='comment:16'></a>\nReplying to [jdemeyer](#comment%3A15):\n> Replying to [tscrim](#comment%3A14):\n> > It just seems to me everything I look into the Cython generated C code, it seems like there could be a bit of overhead\n\n> \n> If you have concrete examples of this, I'm sure that Cython upstream would be interested in fixing that.\n\n\nI am just referring to some of the unnecessary extra variables that are used or extra error checks. For instance, things like\n\n```c\n  /* \"sage/groups/perm_gps/permgroup_element.pyx\":244\n *     if isinstance(g, Permutation):\n *         return g.cycle_tuples()\n *     if isinstance(g, PermutationGroupElement):             # <<<<<<<<<<<<<<\n *         g = g.cycle_tuples()\n *     if isinstance(g, str):\n */\n  __pyx_t_3 = __Pyx_TypeCheck(__pyx_v_g, __pyx_ptype_4sage_6groups_8perm_gps_17permgroup_element_PermutationGroupElement); \n  __pyx_t_4 = (__pyx_t_3 != 0);\n  if (__pyx_t_4) {\n```\nGranted, I suspect the compiler will optimize `__pyx_t_3` and `__pyx_t_4` away, but I still wonder if takes up a few extra CPU cycles, which multiplied by times they occur could result in faster code.",
    "created_at": "2018-06-07T09:52:57Z",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25490#issuecomment-393464",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:16'></a>
Replying to [jdemeyer](#comment%3A15):
> Replying to [tscrim](#comment%3A14):
> > It just seems to me everything I look into the Cython generated C code, it seems like there could be a bit of overhead

> 
> If you have concrete examples of this, I'm sure that Cython upstream would be interested in fixing that.


I am just referring to some of the unnecessary extra variables that are used or extra error checks. For instance, things like

```c
  /* "sage/groups/perm_gps/permgroup_element.pyx":244
 *     if isinstance(g, Permutation):
 *         return g.cycle_tuples()
 *     if isinstance(g, PermutationGroupElement):             # <<<<<<<<<<<<<<
 *         g = g.cycle_tuples()
 *     if isinstance(g, str):
 */
  __pyx_t_3 = __Pyx_TypeCheck(__pyx_v_g, __pyx_ptype_4sage_6groups_8perm_gps_17permgroup_element_PermutationGroupElement); 
  __pyx_t_4 = (__pyx_t_3 != 0);
  if (__pyx_t_4) {
```
Granted, I suspect the compiler will optimize `__pyx_t_3` and `__pyx_t_4` away, but I still wonder if takes up a few extra CPU cycles, which multiplied by times they occur could result in faster code.



---

archive/issue_comments_393465.json:
```json
{
    "body": "<a id='comment:17'></a>\nI should make it clear I do not have any concrete example where I could write C code that would be definitely faster than Cython's version. Although I have not currently tried such a comparison.",
    "created_at": "2018-06-07T09:54:01Z",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25490#issuecomment-393465",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:17'></a>
I should make it clear I do not have any concrete example where I could write C code that would be definitely faster than Cython's version. Although I have not currently tried such a comparison.



---

archive/issue_events_226380.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2018-06-07T10:16:17Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25490#event-226380"
}
```



---

archive/issue_events_226381.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2018-06-07T10:16:17Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25490#event-226381"
}
```



---

archive/issue_comments_393466.json:
```json
{
    "body": "**Changing branch** from \"[u/jdemeyer/fix_matrix_gfpn_dense_rescale_row_c](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/fix_matrix_gfpn_dense_rescale_row_c)\" to \"[u/tscrim/fix_matrix_gfpn_dense_rescale_row_c-25490](https://github.com/sagemath/sagetrac-mirror/tree/u/tscrim/fix_matrix_gfpn_dense_rescale_row_c-25490)\".",
    "created_at": "2018-06-07T10:16:17Z",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25490#issuecomment-393466",
    "user": "https://github.com/tscrim"
}
```

**Changing branch** from "[u/jdemeyer/fix_matrix_gfpn_dense_rescale_row_c](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/fix_matrix_gfpn_dense_rescale_row_c)" to "[u/tscrim/fix_matrix_gfpn_dense_rescale_row_c-25490](https://github.com/sagemath/sagetrac-mirror/tree/u/tscrim/fix_matrix_gfpn_dense_rescale_row_c-25490)".



---

archive/issue_comments_393467.json:
```json
{
    "body": "**Changing commit** from \"[cef13b8f2aece9c723dfa10f221fc14ac67c22af](https://github.com/sagemath/sagetrac-mirror/commit/cef13b8f2aece9c723dfa10f221fc14ac67c22af)\" to \"[1a97f39ec01d45fb9a59fe9512689e3e35245d52](https://github.com/sagemath/sagetrac-mirror/commit/1a97f39ec01d45fb9a59fe9512689e3e35245d52)\".",
    "created_at": "2018-06-07T10:16:17Z",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25490#issuecomment-393467",
    "user": "https://github.com/tscrim"
}
```

**Changing commit** from "[cef13b8f2aece9c723dfa10f221fc14ac67c22af](https://github.com/sagemath/sagetrac-mirror/commit/cef13b8f2aece9c723dfa10f221fc14ac67c22af)" to "[1a97f39ec01d45fb9a59fe9512689e3e35245d52](https://github.com/sagemath/sagetrac-mirror/commit/1a97f39ec01d45fb9a59fe9512689e3e35245d52)".



---

archive/issue_comments_393468.json:
```json
{
    "body": "**Reviewer:** Travis Scrimshaw",
    "created_at": "2018-06-07T10:16:17Z",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25490#issuecomment-393468",
    "user": "https://github.com/tscrim"
}
```

**Reviewer:** Travis Scrimshaw



---

archive/issue_comments_393469.json:
```json
{
    "body": "<a id='comment:18'></a>\nFrom looking at the C code of the added here, the Cython really should not have any real overhead.\n\nI just removed the duplicate mentioned above. I suppose the proper thing is to have someone else check this rather than simply setting it to a positive review.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b59c597e1a271fecc782bce52906503263fbe9d5\">b59c597</a></td><td><code>Merge branch 'u/jdemeyer/fix_matrix_gfpn_dense_rescale_row_c' of git://trac.sagemath.org/sage into u/jdemeyer/fix_matrix_gfpn_dense_rescale_row_c</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1a97f39ec01d45fb9a59fe9512689e3e35245d52\">1a97f39</a></td><td><code>Removing duplicate FfSetField.</code></td></tr></table>\n",
    "created_at": "2018-06-07T10:16:17Z",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25490#issuecomment-393469",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:18'></a>
From looking at the C code of the added here, the Cython really should not have any real overhead.

I just removed the duplicate mentioned above. I suppose the proper thing is to have someone else check this rather than simply setting it to a positive review.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b59c597e1a271fecc782bce52906503263fbe9d5">b59c597</a></td><td><code>Merge branch 'u/jdemeyer/fix_matrix_gfpn_dense_rescale_row_c' of git://trac.sagemath.org/sage into u/jdemeyer/fix_matrix_gfpn_dense_rescale_row_c</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1a97f39ec01d45fb9a59fe9512689e3e35245d52">1a97f39</a></td><td><code>Removing duplicate FfSetField.</code></td></tr></table>




---

archive/issue_comments_393470.json:
```json
{
    "body": "<a id='comment:19'></a>\nReplying to [tscrim](#comment%3A16):\n> Granted, I suspect the compiler will optimize `__pyx_t_3` and `__pyx_t_4` away\n\n\nI'm pretty sure that this is the case indeed. Recent compilers are very good at this.\n\nAnyway, I thought that you were referring to \"pure C\" code in Cython. When Python objects are involved, there is always some overhead because of refcounting for example.",
    "created_at": "2018-06-07T11:46:40Z",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25490#issuecomment-393470",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:19'></a>
Replying to [tscrim](#comment%3A16):
> Granted, I suspect the compiler will optimize `__pyx_t_3` and `__pyx_t_4` away


I'm pretty sure that this is the case indeed. Recent compilers are very good at this.

Anyway, I thought that you were referring to "pure C" code in Cython. When Python objects are involved, there is always some overhead because of refcounting for example.



---

archive/issue_comments_393471.json:
```json
{
    "body": "<a id='comment:20'></a>\nReplying to [jdemeyer](#comment%3A19):\n> Anyway, I thought that you were referring to \"pure C\" code in Cython. When Python objects are involved, there is always some overhead because of refcounting for example.\n\n\nOnly in a very small part. Although it is nice to see with proper typing for everything that it basically is a straight translation to C.",
    "created_at": "2018-06-08T02:30:25Z",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25490#issuecomment-393471",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:20'></a>
Replying to [jdemeyer](#comment%3A19):
> Anyway, I thought that you were referring to "pure C" code in Cython. When Python objects are involved, there is always some overhead because of refcounting for example.


Only in a very small part. Although it is nice to see with proper typing for everything that it basically is a straight translation to C.



---

archive/issue_comments_393472.json:
```json
{
    "body": "<a id='comment:21'></a>\nCan someone verify my change? That is the only thing missing from a positive review here.",
    "created_at": "2018-06-29T09:49:40Z",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25490#issuecomment-393472",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:21'></a>
Can someone verify my change? That is the only thing missing from a positive review here.



---

archive/issue_comments_393473.json:
```json
{
    "body": "<a id='comment:22'></a>\nReplying to [tscrim](#comment%3A21):\n> Can someone verify my change? That is the only thing missing from a positive review here.\n\n\nAre you only talking about commit:1a97f39? That's of course totally fine, FfSetField was called twice where it should only be called once.\n\nSo, if that's the only issue, it is \"positive review\".",
    "created_at": "2018-06-29T12:42:15Z",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25490#issuecomment-393473",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:22'></a>
Replying to [tscrim](#comment%3A21):
> Can someone verify my change? That is the only thing missing from a positive review here.


Are you only talking about commit:1a97f39? That's of course totally fine, FfSetField was called twice where it should only be called once.

So, if that's the only issue, it is "positive review".



---

archive/issue_comments_393474.json:
```json
{
    "body": "<a id='comment:23'></a>\nYep, that was it.",
    "created_at": "2018-06-29T13:08:09Z",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25490#issuecomment-393474",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:23'></a>
Yep, that was it.



---

archive/issue_events_226382.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2018-06-29T13:08:09Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25490#event-226382"
}
```



---

archive/issue_events_226383.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2018-06-29T13:08:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25490#event-226383"
}
```



---

archive/issue_comments_393475.json:
```json
{
    "body": "**Changing keywords** from \"MeatAxe rescale row\" to \"MeatAxe rescale row, days94\".",
    "created_at": "2018-06-29T13:08:20Z",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25490#issuecomment-393475",
    "user": "https://github.com/tscrim"
}
```

**Changing keywords** from "MeatAxe rescale row" to "MeatAxe rescale row, days94".



---

archive/issue_comments_393476.json:
```json
{
    "body": "**Changing branch** from \"[u/tscrim/fix_matrix_gfpn_dense_rescale_row_c-25490](https://github.com/sagemath/sagetrac-mirror/tree/u/tscrim/fix_matrix_gfpn_dense_rescale_row_c-25490)\" to \"[1a97f39ec01d45fb9a59fe9512689e3e35245d52](https://github.com/sagemath/sagetrac-mirror/commit/1a97f39ec01d45fb9a59fe9512689e3e35245d52)\".",
    "created_at": "2018-06-30T15:21:16Z",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25490#issuecomment-393476",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/tscrim/fix_matrix_gfpn_dense_rescale_row_c-25490](https://github.com/sagemath/sagetrac-mirror/tree/u/tscrim/fix_matrix_gfpn_dense_rescale_row_c-25490)" to "[1a97f39ec01d45fb9a59fe9512689e3e35245d52](https://github.com/sagemath/sagetrac-mirror/commit/1a97f39ec01d45fb9a59fe9512689e3e35245d52)".



---

archive/issue_events_226384.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-06-30T15:21:16Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25490#event-226384"
}
```



---

archive/issue_events_226385.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-06-30T15:21:16Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/25490",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25490#event-226385"
}
```
