# Issue 25317: Special-case pol*term, term*pol for generic polynomials

archive/issues_025080.json:
```json
{
    "body": "\n```\nsage: Pol0.<t> = ZZ[]\n....: Pol1.<x> = Pol0[]\n....: p = ((t^2 - 3*t)*x^10 + (-3*t^2 - 1)*x^9 + (-t^2 - t + 1)*x^8 + (-t^2 - 1)*x^7 + (-4*t^2 + 14*t - 4)*x^6 + (2*t^2 + 2)*x^5 + (-t^2 + 2*t + 2)*x^4 + (3*t^2 - t + 3)*x^3 + (t^2 - t + 156)*x^2 + (7*t - 3)*x - t^2 + 2*t)\n....: q = 2*x\n```\n8.3.beta0:\n\n```\nsage: %timeit p*q\nThe slowest run took 2129.02 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 8.02 \u00b5s per loop\n```\nThis ticket:\n\n```\nThe slowest run took 8.63 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 2.21 \u00b5s per loop\n```\n\n\n**Branch/Commit:** [d37db8da4c69d6d7fc8982e653b9c412c1d0b77f](https://github.com/sagemath/sagetrac-mirror/commit/d37db8da4c69d6d7fc8982e653b9c412c1d0b77f)\n\n**Reviewer:** Travis Scrimshaw, Marc Mezzarobba\n\n**Author:** Marc Mezzarobba, Travis Scrimshaw\n\nIssue created by migration from https://trac.sagemath.org/ticket/25317\n\n",
    "closed_at": "2018-05-15T22:33:23Z",
    "created_at": "2018-05-09T12:46:58Z",
    "labels": [
        "component: basic arithmetic",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.3",
    "title": "Special-case pol*term, term*pol for generic polynomials",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25317",
    "user": "https://github.com/mezzarobba"
}
```

```
sage: Pol0.<t> = ZZ[]
....: Pol1.<x> = Pol0[]
....: p = ((t^2 - 3*t)*x^10 + (-3*t^2 - 1)*x^9 + (-t^2 - t + 1)*x^8 + (-t^2 - 1)*x^7 + (-4*t^2 + 14*t - 4)*x^6 + (2*t^2 + 2)*x^5 + (-t^2 + 2*t + 2)*x^4 + (3*t^2 - t + 3)*x^3 + (t^2 - t + 156)*x^2 + (7*t - 3)*x - t^2 + 2*t)
....: q = 2*x
```
8.3.beta0:

```
sage: %timeit p*q
The slowest run took 2129.02 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 8.02 µs per loop
```
This ticket:

```
The slowest run took 8.63 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 2.21 µs per loop
```


**Branch/Commit:** [d37db8da4c69d6d7fc8982e653b9c412c1d0b77f](https://github.com/sagemath/sagetrac-mirror/commit/d37db8da4c69d6d7fc8982e653b9c412c1d0b77f)

**Reviewer:** Travis Scrimshaw, Marc Mezzarobba

**Author:** Marc Mezzarobba, Travis Scrimshaw

Issue created by migration from https://trac.sagemath.org/ticket/25317





---

archive/issue_comments_462638.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2018-05-09T12:47:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25317#issuecomment-462638",
    "user": "https://github.com/mezzarobba"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_462639.json:
```json
{
    "body": "<a id='comment:3'></a>\nPerhaps it would be better to have a specialized `cdef scale_and_shift` method that can be overwritten by the specific data structures in order to avoid creating an intermediate object? In fact, the generic `_lmul_` and `_rmul_` just lift the coefficient to the polynomial ring and multiply. I would also rewrite `_mul_` and `_rmul_` to use this `scale_and_shift` with a shift of 0 to avoid code duplication.",
    "created_at": "2018-05-10T10:42:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25317#issuecomment-462639",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:3'></a>
Perhaps it would be better to have a specialized `cdef scale_and_shift` method that can be overwritten by the specific data structures in order to avoid creating an intermediate object? In fact, the generic `_lmul_` and `_rmul_` just lift the coefficient to the polynomial ring and multiply. I would also rewrite `_mul_` and `_rmul_` to use this `scale_and_shift` with a shift of 0 to avoid code duplication.



---

archive/issue_comments_462640.json:
```json
{
    "body": "<a id='comment:4'></a>\nReplying to [tscrim](#comment%3A3):\n> Perhaps it would be better to have a specialized `cdef scale_and_shift` method that can be overwritten by the specific data structures in order to avoid creating an intermediate object? In fact, the generic `_lmul_` and `_rmul_` just lift the coefficient to the polynomial ring and multiply. I would also rewrite `_mul_` and `_rmul_` to use this `scale_and_shift` with a shift of 0 to avoid code duplication.\n\n\nYes, why not... I'm not sure it is worth the pain now\u2014I'm not really trying to make this operation as fast as possible, just to avoid the worst of the overhead (especially in the Karatsuba range). So I'm not going to implement your suggestion now, but perhaps later, and in any case I can review the implementation if you want to do it yourself.\n\nThanks for you comments in any case!",
    "created_at": "2018-05-10T18:01:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25317#issuecomment-462640",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:4'></a>
Replying to [tscrim](#comment%3A3):
> Perhaps it would be better to have a specialized `cdef scale_and_shift` method that can be overwritten by the specific data structures in order to avoid creating an intermediate object? In fact, the generic `_lmul_` and `_rmul_` just lift the coefficient to the polynomial ring and multiply. I would also rewrite `_mul_` and `_rmul_` to use this `scale_and_shift` with a shift of 0 to avoid code duplication.


Yes, why not... I'm not sure it is worth the pain now—I'm not really trying to make this operation as fast as possible, just to avoid the worst of the overhead (especially in the Karatsuba range). So I'm not going to implement your suggestion now, but perhaps later, and in any case I can review the implementation if you want to do it yourself.

Thanks for you comments in any case!



---

archive/issue_comments_462641.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [mmezzarobba](#comment%3A4):\n> Replying to [tscrim](#comment%3A3):\n> > Perhaps it would be better to have a specialized `cdef scale_and_shift` method that can be overwritten by the specific data structures in order to avoid creating an intermediate object? In fact, the generic `_lmul_` and `_rmul_` just lift the coefficient to the polynomial ring and multiply. I would also rewrite `_mul_` and `_rmul_` to use this `scale_and_shift` with a shift of 0 to avoid code duplication.\n\n> \n> Yes, why not... I'm not sure it is worth the pain now\u2014I'm not really trying to make this operation as fast as possible, just to avoid the worst of the overhead (especially in the Karatsuba range). So I'm not going to implement your suggestion now, but perhaps later, and in any case I can review the implementation if you want to do it yourself.\n\n\nI will do it today then.",
    "created_at": "2018-05-10T22:22:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25317#issuecomment-462641",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:5'></a>
Replying to [mmezzarobba](#comment%3A4):
> Replying to [tscrim](#comment%3A3):
> > Perhaps it would be better to have a specialized `cdef scale_and_shift` method that can be overwritten by the specific data structures in order to avoid creating an intermediate object? In fact, the generic `_lmul_` and `_rmul_` just lift the coefficient to the polynomial ring and multiply. I would also rewrite `_mul_` and `_rmul_` to use this `scale_and_shift` with a shift of 0 to avoid code duplication.

> 
> Yes, why not... I'm not sure it is worth the pain now—I'm not really trying to make this operation as fast as possible, just to avoid the worst of the overhead (especially in the Karatsuba range). So I'm not going to implement your suggestion now, but perhaps later, and in any case I can review the implementation if you want to do it yourself.


I will do it today then.



---

archive/issue_comments_462642.json:
```json
{
    "body": "**Reviewer:** Travis Scrimshaw",
    "created_at": "2018-05-11T02:50:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25317#issuecomment-462642",
    "user": "https://github.com/tscrim"
}
```

**Reviewer:** Travis Scrimshaw



---

archive/issue_comments_462643.json:
```json
{
    "body": "<a id='comment:6'></a>\nRunning the same test as in the description.\n\n8.3.beta0:\n\n```\nsage: %timeit p*q\nThe slowest run took 2129.02 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 8.02 \u00b5s per loop\n```\nYour branch:\n\n```\nsage: %timeit p*q\nThe slowest run took 9.36 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 2.78 \u00b5s per loop\n```\nMy branch:\n\n```\nThe slowest run took 8.63 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 2.21 \u00b5s per loop\n```\nSo my changes get us an extra ~20%.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4a9c96629b8cec7c396b7e193ce3a7e92fd26fa5\">4a9c966</a></td><td><code>Merge branch 'u/mmezzarobba/generic_pol_times_term' of git://trac.sagemath.org/sage into u/tscrim/generic_pol_times_term</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d37db8da4c69d6d7fc8982e653b9c412c1d0b77f\">d37db8d</a></td><td><code>Improving the speed of single term multiplication.</code></td></tr></table>\n",
    "created_at": "2018-05-11T02:50:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25317#issuecomment-462643",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:6'></a>
Running the same test as in the description.

8.3.beta0:

```
sage: %timeit p*q
The slowest run took 2129.02 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 8.02 µs per loop
```
Your branch:

```
sage: %timeit p*q
The slowest run took 9.36 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 2.78 µs per loop
```
My branch:

```
The slowest run took 8.63 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 2.21 µs per loop
```
So my changes get us an extra ~20%.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4a9c96629b8cec7c396b7e193ce3a7e92fd26fa5">4a9c966</a></td><td><code>Merge branch 'u/mmezzarobba/generic_pol_times_term' of git://trac.sagemath.org/sage into u/tscrim/generic_pol_times_term</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d37db8da4c69d6d7fc8982e653b9c412c1d0b77f">d37db8d</a></td><td><code>Improving the speed of single term multiplication.</code></td></tr></table>




---

archive/issue_comments_462644.json:
```json
{
    "body": "**Changing branch** from \"[u/mmezzarobba/generic_pol_times_term](https://github.com/sagemath/sagetrac-mirror/tree/u/mmezzarobba/generic_pol_times_term)\" to \"[u/tscrim/generic_pol_times_term-25317](https://github.com/sagemath/sagetrac-mirror/tree/u/tscrim/generic_pol_times_term-25317)\".",
    "created_at": "2018-05-11T02:50:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25317#issuecomment-462644",
    "user": "https://github.com/tscrim"
}
```

**Changing branch** from "[u/mmezzarobba/generic_pol_times_term](https://github.com/sagemath/sagetrac-mirror/tree/u/mmezzarobba/generic_pol_times_term)" to "[u/tscrim/generic_pol_times_term-25317](https://github.com/sagemath/sagetrac-mirror/tree/u/tscrim/generic_pol_times_term-25317)".



---

archive/issue_comments_462645.json:
```json
{
    "body": "**Changing commit** from \"[42034410ada1eb5e8667f8821cae489a4f0a1659](https://github.com/sagemath/sagetrac-mirror/commit/42034410ada1eb5e8667f8821cae489a4f0a1659)\" to \"[d37db8da4c69d6d7fc8982e653b9c412c1d0b77f](https://github.com/sagemath/sagetrac-mirror/commit/d37db8da4c69d6d7fc8982e653b9c412c1d0b77f)\".",
    "created_at": "2018-05-11T02:50:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25317#issuecomment-462645",
    "user": "https://github.com/tscrim"
}
```

**Changing commit** from "[42034410ada1eb5e8667f8821cae489a4f0a1659](https://github.com/sagemath/sagetrac-mirror/commit/42034410ada1eb5e8667f8821cae489a4f0a1659)" to "[d37db8da4c69d6d7fc8982e653b9c412c1d0b77f](https://github.com/sagemath/sagetrac-mirror/commit/d37db8da4c69d6d7fc8982e653b9c412c1d0b77f)".



---

archive/issue_comments_462646.json:
```json
{
    "body": "**Changing reviewer** from \"Travis Scrimshaw\" to \"Travis Scrimshaw, Marc Mezzarobba\".",
    "created_at": "2018-05-11T10:48:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25317#issuecomment-462646",
    "user": "https://github.com/mezzarobba"
}
```

**Changing reviewer** from "Travis Scrimshaw" to "Travis Scrimshaw, Marc Mezzarobba".



---

archive/issue_comments_462647.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,17 +1,21 @@\n-Before:\n \n ```\n sage: Pol0.<t> = ZZ[]\n ....: Pol1.<x> = Pol0[]\n ....: p = ((t^2 - 3*t)*x^10 + (-3*t^2 - 1)*x^9 + (-t^2 - t + 1)*x^8 + (-t^2 - 1)*x^7 + (-4*t^2 + 14*t - 4)*x^6 + (2*t^2 + 2)*x^5 + (-t^2 + 2*t + 2)*x^4 + (3*t^2 - t + 3)*x^3 + (t^2 - t + 156)*x^2 + (7*t - 3)*x - t^2 + 2*t)\n ....: q = 2*x\n-....: %timeit p*q\n-The slowest run took 4.91 times longer than the fastest. This could mean that an intermediate result is being cached.\n-100000 loops, best of 3: 10.1 \u00b5s per loop\n ```\n-After:\n+8.3.beta0:\n \n ```\n-The slowest run took 6.00 times longer than the fastest. This could mean that an intermediate result is being cached.\n-100000 loops, best of 3: 4.49 \u00b5s per loop\n+sage: %timeit p*q\n+The slowest run took 2129.02 times longer than the fastest. This could mean that an intermediate result is being cached.\n+100000 loops, best of 3: 8.02 \u00b5s per loop\n ```\n+This ticket:\n+\n+```\n+The slowest run took 8.63 times longer than the fastest. This could mean that an intermediate result is being cached.\n+100000 loops, best of 3: 2.21 \u00b5s per loop\n+```\n+\n``````\n",
    "created_at": "2018-05-11T10:48:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25317#issuecomment-462647",
    "user": "https://github.com/mezzarobba"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,17 +1,21 @@
-Before:
 
 ```
 sage: Pol0.<t> = ZZ[]
 ....: Pol1.<x> = Pol0[]
 ....: p = ((t^2 - 3*t)*x^10 + (-3*t^2 - 1)*x^9 + (-t^2 - t + 1)*x^8 + (-t^2 - 1)*x^7 + (-4*t^2 + 14*t - 4)*x^6 + (2*t^2 + 2)*x^5 + (-t^2 + 2*t + 2)*x^4 + (3*t^2 - t + 3)*x^3 + (t^2 - t + 156)*x^2 + (7*t - 3)*x - t^2 + 2*t)
 ....: q = 2*x
-....: %timeit p*q
-The slowest run took 4.91 times longer than the fastest. This could mean that an intermediate result is being cached.
-100000 loops, best of 3: 10.1 µs per loop
 ```
-After:
+8.3.beta0:
 
 ```
-The slowest run took 6.00 times longer than the fastest. This could mean that an intermediate result is being cached.
-100000 loops, best of 3: 4.49 µs per loop
+sage: %timeit p*q
+The slowest run took 2129.02 times longer than the fastest. This could mean that an intermediate result is being cached.
+100000 loops, best of 3: 8.02 µs per loop
 ```
+This ticket:
+
+```
+The slowest run took 8.63 times longer than the fastest. This could mean that an intermediate result is being cached.
+100000 loops, best of 3: 2.21 µs per loop
+```
+
``````




---

archive/issue_comments_462648.json:
```json
{
    "body": "**Changing author** from \"Marc Mezzarobba\" to \"Marc Mezzarobba, Travis Scrimshaw\".",
    "created_at": "2018-05-11T10:48:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25317#issuecomment-462648",
    "user": "https://github.com/mezzarobba"
}
```

**Changing author** from "Marc Mezzarobba" to "Marc Mezzarobba, Travis Scrimshaw".



---

archive/issue_comments_462649.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2018-05-11T10:48:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25317#issuecomment-462649",
    "user": "https://github.com/mezzarobba"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_462650.json:
```json
{
    "body": "<a id='comment:7'></a>\nGreat, thanks!",
    "created_at": "2018-05-11T10:48:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25317#issuecomment-462650",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:7'></a>
Great, thanks!



---

archive/issue_events_071807.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-05-15T22:33:23Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/25317",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25317#event-71807"
}
```



---

archive/issue_comments_462651.json:
```json
{
    "body": "**Changing branch** from \"[u/tscrim/generic_pol_times_term-25317](https://github.com/sagemath/sagetrac-mirror/tree/u/tscrim/generic_pol_times_term-25317)\" to \"[d37db8da4c69d6d7fc8982e653b9c412c1d0b77f](https://github.com/sagemath/sagetrac-mirror/commit/d37db8da4c69d6d7fc8982e653b9c412c1d0b77f)\".",
    "created_at": "2018-05-15T22:33:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25317#issuecomment-462651",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/tscrim/generic_pol_times_term-25317](https://github.com/sagemath/sagetrac-mirror/tree/u/tscrim/generic_pol_times_term-25317)" to "[d37db8da4c69d6d7fc8982e653b9c412c1d0b77f](https://github.com/sagemath/sagetrac-mirror/commit/d37db8da4c69d6d7fc8982e653b9c412c1d0b77f)".
