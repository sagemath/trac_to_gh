# Issue 25076: Fix Matrix_gfpn_dense * int

archive/issues_024839.json:
```json
{
    "body": "The following previous bug was fixed by #24742:\n\n```\nsage: M = matrix(GF(9,'x'), 2,3)\nsage: type(M)\n<type 'sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense'>\nsage: M*1\n[0 0 0]\n[0 0 0]\nsage: M*int(1)\n...\nValueError: Cannot initialise non-square matrix from 1\n```\n\nThis ticket adds a test that makes sure that the issue remains fixed.\n\nCC:  @tscrim\n\nReviewer: Jeroen Demeyer\n\nAuthor: Simon King\n\nBranch: f0e97af5a3dbffec014829eb2341abdaecb78e9f\n\nDependencies: #24742\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/25076\n\n",
    "closed_at": "2018-05-09T09:49:44Z",
    "created_at": "2018-04-01T22:31:23Z",
    "labels": [
        "component: coercion",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Fix Matrix_gfpn_dense * int",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25076",
    "user": "https://github.com/simon-king-jena"
}
```
The following previous bug was fixed by #24742:

```
sage: M = matrix(GF(9,'x'), 2,3)
sage: type(M)
<type 'sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense'>
sage: M*1
[0 0 0]
[0 0 0]
sage: M*int(1)
...
ValueError: Cannot initialise non-square matrix from 1
```

This ticket adds a test that makes sure that the issue remains fixed.

CC:  @tscrim

Reviewer: Jeroen Demeyer

Author: Simon King

Branch: f0e97af5a3dbffec014829eb2341abdaecb78e9f

Dependencies: #24742

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/25076





---

archive/issue_comments_371307.json:
```json
{
    "body": "<a id='comment:1'></a>While we are at it: How is one supposed to run optional tests? It seems that \"sage -t --optional=meataxe\" will ONLY run the tests marked as optional, hence, it will skip all compulsory tests, and thus will fail in most tests as definitions given in the compulsory tests are missing when running the optional tests.",
    "created_at": "2018-04-01T22:33:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371307",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:1'></a>While we are at it: How is one supposed to run optional tests? It seems that "sage -t --optional=meataxe" will ONLY run the tests marked as optional, hence, it will skip all compulsory tests, and thus will fail in most tests as definitions given in the compulsory tests are missing when running the optional tests.



---

archive/issue_comments_371308.json:
```json
{
    "body": "<a id='comment:2'></a>Replying to [comment:1 SimonKing]:\n> While we are at it: How is one supposed to run optional tests? It seems that \"sage -t --optional=meataxe\" will ONLY run the tests marked as optional, hence, it will skip all compulsory tests, and thus will fail in most tests as definitions given in the compulsory tests are missing when running the optional tests.\n\n\n`sage -t --optional=meataxe,sage` will do.",
    "created_at": "2018-04-02T00:19:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371308",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:2'></a>Replying to [comment:1 SimonKing]:
> While we are at it: How is one supposed to run optional tests? It seems that "sage -t --optional=meataxe" will ONLY run the tests marked as optional, hence, it will skip all compulsory tests, and thus will fail in most tests as definitions given in the compulsory tests are missing when running the optional tests.


`sage -t --optional=meataxe,sage` will do.



---

archive/issue_comments_371309.json:
```json
{
    "body": "<a id='comment:4'></a>Works for me:\n\n```\nSageMath version 8.2.rc0, Release Date: 2018-03-28\nsage: M = matrix(GF(9,'x'), 2,3); type(M)\n<type 'sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense'>\nsage: M * int(1)\n[0 0 0]\n[0 0 0]\n```",
    "created_at": "2018-04-02T06:44:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371309",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>Works for me:

```
SageMath version 8.2.rc0, Release Date: 2018-03-28
sage: M = matrix(GF(9,'x'), 2,3); type(M)
<type 'sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense'>
sage: M * int(1)
[0 0 0]
[0 0 0]
```



---

archive/issue_comments_371310.json:
```json
{
    "body": "Replying to [ticket:25076 SimonKing]:\n> {{{\n> Crashboom\n> ...\n> ValueError: Cannot initialise non-square matrix from 1\n> }}}\n\n\nPlease read https://groups.google.com/forum/#!topic/sage-devel/H0t9l6XdfPI",
    "created_at": "2018-04-02T06:46:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371310",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [ticket:25076 SimonKing]:
> {{{
> Crashboom
> ...
> ValueError: Cannot initialise non-square matrix from 1
> }}}


Please read https://groups.google.com/forum/#!topic/sage-devel/H0t9l6XdfPI



---

archive/issue_comments_371311.json:
```json
{
    "body": "<a id='comment:6'></a>Simon: can you specify which version of Sage you using and whether any patches are applied?",
    "created_at": "2018-04-02T06:56:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371311",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>Simon: can you specify which version of Sage you using and whether any patches are applied?



---

archive/issue_comments_371312.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:6 jdemeyer]:\n> Simon: can you specify which version of Sage you using and whether any patches are applied?\n\n\nSorry. It's the branch from #18514, which means Sage 8.5.beta2. Another change: I recently installed tkinter. And something seems to be broken anyway: \"git status\" gives me untracked files `bin/`, `share/` etc. Likely reason: When I manually installed something, I gave the wrong prefix (SAGE_ROOT instead of SAGE_LOCAL) during configuration.\n\nAfter removing the misplaced directories, re-installing the packages and sage -br, I get\n\n```\nsage: M = MatrixSpace(GF(9,'x'), 2,3)()\nsage: type(M)\n<type 'sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense'>\nsage: M*int(1)\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n<ipython-input-3-1a2faedb318b> in <module>()\n----> 1 M*int(Integer(1))\n\n/home/king/Sage/git/sage/src/sage/structure/element.pyx in sage.structure.element.Matrix.__mul__ (build/cythonized/sage/structure/element.c:23460)()\n   3671         if have_same_parent(left, right):\n   3672             return (<Matrix>left)._matrix_times_matrix_(<Matrix>right)\n-> 3673         return coercion_model.bin_op(left, right, mul)\n   3674 \n   3675     def __truediv__(left, right):\n\n/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.bin_op (build/cythonized/sage/structure/coerce.c:9671)()\n   1111             if xp is yp:\n   1112                 return op(x,y)\n-> 1113             action = self.get_action(xp, yp, op, x, y)\n   1114             if action is not None:\n   1115                 return (<Action>action)._call_(x, y)\n\n/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.get_action (build/cythonized/sage/structure/coerce.c:16889)()\n   1654         except KeyError:\n   1655             pass\n-> 1656         action = self.discover_action(R, S, op, r, s)\n   1657         action = self.verify_action(action, R, S, op)\n   1658         self._action_maps.set(R, S, op, action)\n\n/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.discover_action (build/cythonized/sage/structure/coerce.c:18411)()\n   1804 \n   1805         if isinstance(R, Parent):\n-> 1806             action = (<Parent>R).get_action(S, op, True, r, s)\n   1807             if action is not None:\n   1808                 return action\n\n/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.get_action (build/cythonized/sage/structure/parent.c:21664)()\n   2493         action = self._get_action_(S, op, self_on_left)\n   2494         if action is None:\n-> 2495             action = self.discover_action(S, op, self_on_left, self_el, S_el)\n   2496 \n   2497         if action is not None:\n\n/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.discover_action (build/cythonized/sage/structure/parent.c:23017)()\n   2604                     return action\n   2605 \n-> 2606                 if parent_is_integers(S) and not self.has_coerce_map_from(S):\n   2607                     from sage.structure.coerce_actions import IntegerMulAction\n   2608                     try:\n\n/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.has_coerce_map_from (build/cythonized/sage/structure/parent.c:17925)()\n   2022                 print(\"Warning: non-unique parents %s\" % (type(S)))\n   2023             return True\n-> 2024         return self._internal_coerce_map_from(S) is not None\n   2025 \n   2026     cpdef _coerce_map_from_(self, S):\n\n/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent._internal_coerce_map_from (build/cythonized/sage/structure/parent.c:18944)()\n   2164         try:\n   2165             _register_pair(self, S, \"coerce\")\n-> 2166             mor = self.discover_coerce_map_from(S)\n   2167             #if mor is not None:\n   2168             #    # Need to check that this morphism doesn't connect previously unconnected parts of the coercion diagram\n\n/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.discover_coerce_map_from (build/cythonized/sage/structure/parent.c:19396)()\n   2301                 return (<Parent>S)._embedding\n   2302 \n-> 2303         user_provided_mor = self._coerce_map_from_(S)\n   2304 \n   2305         if user_provided_mor is None or user_provided_mor is False:\n\n/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent._coerce_map_from_ (build/cythonized/sage/structure/parent_old.c:7549)()\n    339     cpdef _coerce_map_from_(self, S):\n    340         if self._element_constructor is None:\n--> 341             return self.coerce_map_from_c(S)\n    342         else:\n    343             return parent.Parent._coerce_map_from_(self, S)\n\n/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.coerce_map_from_c (build/cythonized/sage/structure/parent_old.c:4044)()\n    157                 self._coerce_from_hash[S] = None\n    158                 return None\n--> 159             mor = self.coerce_map_from_c(sage_type)\n    160             if mor is not None:\n    161                 mor = mor * sage_type._internal_coerce_map_from(S)\n\n/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.coerce_map_from_c (build/cythonized/sage/structure/parent_old.c:3768)()\n    141             pass\n    142 \n--> 143         mor = self.coerce_map_from_c_impl(S)\n    144         import sage.categories.morphism\n    145         import sage.categories.map\n\n/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.coerce_map_from_c_impl (build/cythonized/sage/structure/parent_old.c:4710)()\n    189         # Piggyback off the old code for now\n    190         # WARNING: when working on this, make sure circular dependencies aren't introduced!\n--> 191         if self.has_coerce_map_from_c(S):\n    192             if isinstance(S, type):\n    193                 S = Set_PythonType(S)\n\n/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.has_coerce_map_from_c (build/cythonized/sage/structure/parent_old.c:6312)()\n    275             except KeyError:\n    276                 pass\n--> 277         x = self.has_coerce_map_from_c_impl(S)\n    278         self._has_coerce_map_from.set(S, x)\n    279         return x\n\n/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.has_coerce_map_from_c_impl (build/cythonized/sage/structure/parent_old.c:6489)()\n    284             return False\n    285         try:\n--> 286             self._coerce_c((<parent.Parent>S).an_element())\n    287         except TypeError:\n    288             return False\n\n/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent._coerce_c (build/cythonized/sage/structure/parent_old.c:5382)()\n    217             pass\n    218         if HAS_DICTIONARY(self):\n--> 219             return self._coerce_impl(x)\n    220         else:\n    221             return self._coerce_c_impl(x)\n\n/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in _coerce_impl(self, x)\n   1100             and self.base_ring().has_coerce_map_from(x.base_ring())):\n   1101             return self(x)\n-> 1102         return self._coerce_try(x, self.base_ring())\n   1103 \n   1104     def _repr_(self):\n\n/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent._coerce_try (build/cythonized/sage/structure/parent_old.c:5902)()\n    255             try:\n    256                 y = R._coerce_(x)\n--> 257                 return self(y)\n    258             except (TypeError, AttributeError) as msg:\n    259                 pass\n\n/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in __call__(self, entries, coerce, copy, sparse)\n    873             [t]\n    874         \"\"\"\n--> 875         return self.matrix(entries, coerce, copy)\n    876 \n    877     def change_ring(self, R):\n\n/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in matrix(self, x, coerce, copy)\n   1886                 x = list_to_dict(x, m, n)\n   1887                 copy = False\n-> 1888         return MC(self, x, copy=copy, coerce=coerce)\n   1889 \n   1890     def matrix_space(self, nrows=None, ncols=None, sparse=False):\n\n/home/king/Sage/git/sage/src/sage/matrix/matrix_gfpn_dense.pyx in sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense.__init__ (build/cythonized/sage/matrix/matrix_gfpn_dense.c:5278)()\n    423                 return\n    424             if self._nrows != self._ncols:\n--> 425                 raise ValueError(\"Cannot initialise non-square matrix from {}\".format(data))\n    426             f = FfFromInt(self._converter.field_to_int(self._coerce_element(data)))\n    427             x = self.Data.Data\n\nValueError: Cannot initialise non-square matrix from 1\n```\n\nSo, perhaps I should retry with #18514 rebased on top of the latest develop branch?",
    "created_at": "2018-04-02T07:21:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371312",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:7'></a>Replying to [comment:6 jdemeyer]:
> Simon: can you specify which version of Sage you using and whether any patches are applied?


Sorry. It's the branch from #18514, which means Sage 8.5.beta2. Another change: I recently installed tkinter. And something seems to be broken anyway: "git status" gives me untracked files `bin/`, `share/` etc. Likely reason: When I manually installed something, I gave the wrong prefix (SAGE_ROOT instead of SAGE_LOCAL) during configuration.

After removing the misplaced directories, re-installing the packages and sage -br, I get

```
sage: M = MatrixSpace(GF(9,'x'), 2,3)()
sage: type(M)
<type 'sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense'>
sage: M*int(1)
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-3-1a2faedb318b> in <module>()
----> 1 M*int(Integer(1))

/home/king/Sage/git/sage/src/sage/structure/element.pyx in sage.structure.element.Matrix.__mul__ (build/cythonized/sage/structure/element.c:23460)()
   3671         if have_same_parent(left, right):
   3672             return (<Matrix>left)._matrix_times_matrix_(<Matrix>right)
-> 3673         return coercion_model.bin_op(left, right, mul)
   3674 
   3675     def __truediv__(left, right):

/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.bin_op (build/cythonized/sage/structure/coerce.c:9671)()
   1111             if xp is yp:
   1112                 return op(x,y)
-> 1113             action = self.get_action(xp, yp, op, x, y)
   1114             if action is not None:
   1115                 return (<Action>action)._call_(x, y)

/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.get_action (build/cythonized/sage/structure/coerce.c:16889)()
   1654         except KeyError:
   1655             pass
-> 1656         action = self.discover_action(R, S, op, r, s)
   1657         action = self.verify_action(action, R, S, op)
   1658         self._action_maps.set(R, S, op, action)

/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.discover_action (build/cythonized/sage/structure/coerce.c:18411)()
   1804 
   1805         if isinstance(R, Parent):
-> 1806             action = (<Parent>R).get_action(S, op, True, r, s)
   1807             if action is not None:
   1808                 return action

/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.get_action (build/cythonized/sage/structure/parent.c:21664)()
   2493         action = self._get_action_(S, op, self_on_left)
   2494         if action is None:
-> 2495             action = self.discover_action(S, op, self_on_left, self_el, S_el)
   2496 
   2497         if action is not None:

/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.discover_action (build/cythonized/sage/structure/parent.c:23017)()
   2604                     return action
   2605 
-> 2606                 if parent_is_integers(S) and not self.has_coerce_map_from(S):
   2607                     from sage.structure.coerce_actions import IntegerMulAction
   2608                     try:

/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.has_coerce_map_from (build/cythonized/sage/structure/parent.c:17925)()
   2022                 print("Warning: non-unique parents %s" % (type(S)))
   2023             return True
-> 2024         return self._internal_coerce_map_from(S) is not None
   2025 
   2026     cpdef _coerce_map_from_(self, S):

/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent._internal_coerce_map_from (build/cythonized/sage/structure/parent.c:18944)()
   2164         try:
   2165             _register_pair(self, S, "coerce")
-> 2166             mor = self.discover_coerce_map_from(S)
   2167             #if mor is not None:
   2168             #    # Need to check that this morphism doesn't connect previously unconnected parts of the coercion diagram

/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.discover_coerce_map_from (build/cythonized/sage/structure/parent.c:19396)()
   2301                 return (<Parent>S)._embedding
   2302 
-> 2303         user_provided_mor = self._coerce_map_from_(S)
   2304 
   2305         if user_provided_mor is None or user_provided_mor is False:

/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent._coerce_map_from_ (build/cythonized/sage/structure/parent_old.c:7549)()
    339     cpdef _coerce_map_from_(self, S):
    340         if self._element_constructor is None:
--> 341             return self.coerce_map_from_c(S)
    342         else:
    343             return parent.Parent._coerce_map_from_(self, S)

/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.coerce_map_from_c (build/cythonized/sage/structure/parent_old.c:4044)()
    157                 self._coerce_from_hash[S] = None
    158                 return None
--> 159             mor = self.coerce_map_from_c(sage_type)
    160             if mor is not None:
    161                 mor = mor * sage_type._internal_coerce_map_from(S)

/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.coerce_map_from_c (build/cythonized/sage/structure/parent_old.c:3768)()
    141             pass
    142 
--> 143         mor = self.coerce_map_from_c_impl(S)
    144         import sage.categories.morphism
    145         import sage.categories.map

/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.coerce_map_from_c_impl (build/cythonized/sage/structure/parent_old.c:4710)()
    189         # Piggyback off the old code for now
    190         # WARNING: when working on this, make sure circular dependencies aren't introduced!
--> 191         if self.has_coerce_map_from_c(S):
    192             if isinstance(S, type):
    193                 S = Set_PythonType(S)

/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.has_coerce_map_from_c (build/cythonized/sage/structure/parent_old.c:6312)()
    275             except KeyError:
    276                 pass
--> 277         x = self.has_coerce_map_from_c_impl(S)
    278         self._has_coerce_map_from.set(S, x)
    279         return x

/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.has_coerce_map_from_c_impl (build/cythonized/sage/structure/parent_old.c:6489)()
    284             return False
    285         try:
--> 286             self._coerce_c((<parent.Parent>S).an_element())
    287         except TypeError:
    288             return False

/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent._coerce_c (build/cythonized/sage/structure/parent_old.c:5382)()
    217             pass
    218         if HAS_DICTIONARY(self):
--> 219             return self._coerce_impl(x)
    220         else:
    221             return self._coerce_c_impl(x)

/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in _coerce_impl(self, x)
   1100             and self.base_ring().has_coerce_map_from(x.base_ring())):
   1101             return self(x)
-> 1102         return self._coerce_try(x, self.base_ring())
   1103 
   1104     def _repr_(self):

/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent._coerce_try (build/cythonized/sage/structure/parent_old.c:5902)()
    255             try:
    256                 y = R._coerce_(x)
--> 257                 return self(y)
    258             except (TypeError, AttributeError) as msg:
    259                 pass

/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in __call__(self, entries, coerce, copy, sparse)
    873             [t]
    874         """
--> 875         return self.matrix(entries, coerce, copy)
    876 
    877     def change_ring(self, R):

/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in matrix(self, x, coerce, copy)
   1886                 x = list_to_dict(x, m, n)
   1887                 copy = False
-> 1888         return MC(self, x, copy=copy, coerce=coerce)
   1889 
   1890     def matrix_space(self, nrows=None, ncols=None, sparse=False):

/home/king/Sage/git/sage/src/sage/matrix/matrix_gfpn_dense.pyx in sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense.__init__ (build/cythonized/sage/matrix/matrix_gfpn_dense.c:5278)()
    423                 return
    424             if self._nrows != self._ncols:
--> 425                 raise ValueError("Cannot initialise non-square matrix from {}".format(data))
    426             f = FfFromInt(self._converter.field_to_int(self._coerce_element(data)))
    427             x = self.Data.Data

ValueError: Cannot initialise non-square matrix from 1
```

So, perhaps I should retry with #18514 rebased on top of the latest develop branch?



---

archive/issue_comments_371313.json:
```json
{
    "body": "<a id='comment:8'></a>PS: The same error was observed by other people as well, on #18514. So, I have to see what went wrong there.",
    "created_at": "2018-04-02T07:22:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371313",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:8'></a>PS: The same error was observed by other people as well, on #18514. So, I have to see what went wrong there.



---

archive/issue_comments_371314.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:7 SimonKing]:\n> So, perhaps I should retry with #18514 rebased on top of the latest develop branch?\n\n\nYes and let me know if that fixes it.",
    "created_at": "2018-04-02T07:56:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371314",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>Replying to [comment:7 SimonKing]:
> So, perhaps I should retry with #18514 rebased on top of the latest develop branch?


Yes and let me know if that fixes it.



---

archive/issue_comments_371315.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -8,8 +8,158 @@\n [0 0 0]\n [0 0 0]\n sage: M*int(1)\n-Crashboom\n-...\n+---------------------------------------------------------------------------\n+ValueError                                Traceback (most recent call last)\n+<ipython-input-3-1a2faedb318b> in <module>()\n+----> 1 M*int(Integer(1))\n+\n+/home/king/Sage/git/sage/src/sage/structure/element.pyx in sage.structure.element.Matrix.__mul__ (build/cythonized/sage/structure/element.c:23460)()\n+   3671         if have_same_parent(left, right):\n+   3672             return (<Matrix>left)._matrix_times_matrix_(<Matrix>right)\n+-> 3673         return coercion_model.bin_op(left, right, mul)\n+   3674 \n+   3675     def __truediv__(left, right):\n+\n+/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.bin_op (build/cythonized/sage/structure/coerce.c:9671)()\n+   1111             if xp is yp:\n+   1112                 return op(x,y)\n+-> 1113             action = self.get_action(xp, yp, op, x, y)\n+   1114             if action is not None:\n+   1115                 return (<Action>action)._call_(x, y)\n+\n+/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.get_action (build/cythonized/sage/structure/coerce.c:16889)()\n+   1654         except KeyError:\n+   1655             pass\n+-> 1656         action = self.discover_action(R, S, op, r, s)\n+   1657         action = self.verify_action(action, R, S, op)\n+   1658         self._action_maps.set(R, S, op, action)\n+\n+/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.discover_action (build/cythonized/sage/structure/coerce.c:18411)()\n+   1804 \n+   1805         if isinstance(R, Parent):\n+-> 1806             action = (<Parent>R).get_action(S, op, True, r, s)\n+   1807             if action is not None:\n+   1808                 return action\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.get_action (build/cythonized/sage/structure/parent.c:21664)()\n+   2493         action = self._get_action_(S, op, self_on_left)\n+   2494         if action is None:\n+-> 2495             action = self.discover_action(S, op, self_on_left, self_el, S_el)\n+   2496 \n+   2497         if action is not None:\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.discover_action (build/cythonized/sage/structure/parent.c:23017)()\n+   2604                     return action\n+   2605 \n+-> 2606                 if parent_is_integers(S) and not self.has_coerce_map_from(S):\n+   2607                     from sage.structure.coerce_actions import IntegerMulAction\n+   2608                     try:\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.has_coerce_map_from (build/cythonized/sage/structure/parent.c:17925)()\n+   2022                 print(\"Warning: non-unique parents %s\" % (type(S)))\n+   2023             return True\n+-> 2024         return self._internal_coerce_map_from(S) is not None\n+   2025 \n+   2026     cpdef _coerce_map_from_(self, S):\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent._internal_coerce_map_from (build/cythonized/sage/structure/parent.c:18944)()\n+   2164         try:\n+   2165             _register_pair(self, S, \"coerce\")\n+-> 2166             mor = self.discover_coerce_map_from(S)\n+   2167             #if mor is not None:\n+   2168             #    # Need to check that this morphism doesn't connect previously unconnected parts of the coercion diagram\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.discover_coerce_map_from (build/cythonized/sage/structure/parent.c:19396)()\n+   2301                 return (<Parent>S)._embedding\n+   2302 \n+-> 2303         user_provided_mor = self._coerce_map_from_(S)\n+   2304 \n+   2305         if user_provided_mor is None or user_provided_mor is False:\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent._coerce_map_from_ (build/cythonized/sage/structure/parent_old.c:7549)()\n+    339     cpdef _coerce_map_from_(self, S):\n+    340         if self._element_constructor is None:\n+--> 341             return self.coerce_map_from_c(S)\n+    342         else:\n+    343             return parent.Parent._coerce_map_from_(self, S)\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.coerce_map_from_c (build/cythonized/sage/structure/parent_old.c:4044)()\n+    157                 self._coerce_from_hash[S] = None\n+    158                 return None\n+--> 159             mor = self.coerce_map_from_c(sage_type)\n+    160             if mor is not None:\n+    161                 mor = mor * sage_type._internal_coerce_map_from(S)\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.coerce_map_from_c (build/cythonized/sage/structure/parent_old.c:3768)()\n+    141             pass\n+    142 \n+--> 143         mor = self.coerce_map_from_c_impl(S)\n+    144         import sage.categories.morphism\n+    145         import sage.categories.map\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.coerce_map_from_c_impl (build/cythonized/sage/structure/parent_old.c:4710)()\n+    189         # Piggyback off the old code for now\n+    190         # WARNING: when working on this, make sure circular dependencies aren't introduced!\n+--> 191         if self.has_coerce_map_from_c(S):\n+    192             if isinstance(S, type):\n+    193                 S = Set_PythonType(S)\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.has_coerce_map_from_c (build/cythonized/sage/structure/parent_old.c:6312)()\n+    275             except KeyError:\n+    276                 pass\n+--> 277         x = self.has_coerce_map_from_c_impl(S)\n+    278         self._has_coerce_map_from.set(S, x)\n+    279         return x\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.has_coerce_map_from_c_impl (build/cythonized/sage/structure/parent_old.c:6489)()\n+    284             return False\n+    285         try:\n+--> 286             self._coerce_c((<parent.Parent>S).an_element())\n+    287         except TypeError:\n+    288             return False\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent._coerce_c (build/cythonized/sage/structure/parent_old.c:5382)()\n+    217             pass\n+    218         if HAS_DICTIONARY(self):\n+--> 219             return self._coerce_impl(x)\n+    220         else:\n+    221             return self._coerce_c_impl(x)\n+\n+/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in _coerce_impl(self, x)\n+   1100             and self.base_ring().has_coerce_map_from(x.base_ring())):\n+   1101             return self(x)\n+-> 1102         return self._coerce_try(x, self.base_ring())\n+   1103 \n+   1104     def _repr_(self):\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent._coerce_try (build/cythonized/sage/structure/parent_old.c:5902)()\n+    255             try:\n+    256                 y = R._coerce_(x)\n+--> 257                 return self(y)\n+    258             except (TypeError, AttributeError) as msg:\n+    259                 pass\n+\n+/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in __call__(self, entries, coerce, copy, sparse)\n+    873             [t]\n+    874         \"\"\"\n+--> 875         return self.matrix(entries, coerce, copy)\n+    876 \n+    877     def change_ring(self, R):\n+\n+/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in matrix(self, x, coerce, copy)\n+   1886                 x = list_to_dict(x, m, n)\n+   1887                 copy = False\n+-> 1888         return MC(self, x, copy=copy, coerce=coerce)\n+   1889 \n+   1890     def matrix_space(self, nrows=None, ncols=None, sparse=False):\n+\n+/home/king/Sage/git/sage/src/sage/matrix/matrix_gfpn_dense.pyx in sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense.__init__ (build/cythonized/sage/matrix/matrix_gfpn_dense.c:5278)()\n+    423                 return\n+    424             if self._nrows != self._ncols:\n+--> 425                 raise ValueError(\"Cannot initialise non-square matrix from {}\".format(data))\n+    426             f = FfFromInt(self._converter.field_to_int(self._coerce_element(data)))\n+    427             x = self.Data.Data\n+\n ValueError: Cannot initialise non-square matrix from 1\n ```\n \n@@ -24,7 +174,6 @@\n [0 0 0]\n ```\n \n-Keywords: meataxe coercion\n \n Comment: 1\n \n``````\n",
    "created_at": "2018-04-02T07:57:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371315",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -8,8 +8,158 @@
 [0 0 0]
 [0 0 0]
 sage: M*int(1)
-Crashboom
-...
+---------------------------------------------------------------------------
+ValueError                                Traceback (most recent call last)
+<ipython-input-3-1a2faedb318b> in <module>()
+----> 1 M*int(Integer(1))
+
+/home/king/Sage/git/sage/src/sage/structure/element.pyx in sage.structure.element.Matrix.__mul__ (build/cythonized/sage/structure/element.c:23460)()
+   3671         if have_same_parent(left, right):
+   3672             return (<Matrix>left)._matrix_times_matrix_(<Matrix>right)
+-> 3673         return coercion_model.bin_op(left, right, mul)
+   3674 
+   3675     def __truediv__(left, right):
+
+/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.bin_op (build/cythonized/sage/structure/coerce.c:9671)()
+   1111             if xp is yp:
+   1112                 return op(x,y)
+-> 1113             action = self.get_action(xp, yp, op, x, y)
+   1114             if action is not None:
+   1115                 return (<Action>action)._call_(x, y)
+
+/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.get_action (build/cythonized/sage/structure/coerce.c:16889)()
+   1654         except KeyError:
+   1655             pass
+-> 1656         action = self.discover_action(R, S, op, r, s)
+   1657         action = self.verify_action(action, R, S, op)
+   1658         self._action_maps.set(R, S, op, action)
+
+/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.discover_action (build/cythonized/sage/structure/coerce.c:18411)()
+   1804 
+   1805         if isinstance(R, Parent):
+-> 1806             action = (<Parent>R).get_action(S, op, True, r, s)
+   1807             if action is not None:
+   1808                 return action
+
+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.get_action (build/cythonized/sage/structure/parent.c:21664)()
+   2493         action = self._get_action_(S, op, self_on_left)
+   2494         if action is None:
+-> 2495             action = self.discover_action(S, op, self_on_left, self_el, S_el)
+   2496 
+   2497         if action is not None:
+
+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.discover_action (build/cythonized/sage/structure/parent.c:23017)()
+   2604                     return action
+   2605 
+-> 2606                 if parent_is_integers(S) and not self.has_coerce_map_from(S):
+   2607                     from sage.structure.coerce_actions import IntegerMulAction
+   2608                     try:
+
+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.has_coerce_map_from (build/cythonized/sage/structure/parent.c:17925)()
+   2022                 print("Warning: non-unique parents %s" % (type(S)))
+   2023             return True
+-> 2024         return self._internal_coerce_map_from(S) is not None
+   2025 
+   2026     cpdef _coerce_map_from_(self, S):
+
+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent._internal_coerce_map_from (build/cythonized/sage/structure/parent.c:18944)()
+   2164         try:
+   2165             _register_pair(self, S, "coerce")
+-> 2166             mor = self.discover_coerce_map_from(S)
+   2167             #if mor is not None:
+   2168             #    # Need to check that this morphism doesn't connect previously unconnected parts of the coercion diagram
+
+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.discover_coerce_map_from (build/cythonized/sage/structure/parent.c:19396)()
+   2301                 return (<Parent>S)._embedding
+   2302 
+-> 2303         user_provided_mor = self._coerce_map_from_(S)
+   2304 
+   2305         if user_provided_mor is None or user_provided_mor is False:
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent._coerce_map_from_ (build/cythonized/sage/structure/parent_old.c:7549)()
+    339     cpdef _coerce_map_from_(self, S):
+    340         if self._element_constructor is None:
+--> 341             return self.coerce_map_from_c(S)
+    342         else:
+    343             return parent.Parent._coerce_map_from_(self, S)
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.coerce_map_from_c (build/cythonized/sage/structure/parent_old.c:4044)()
+    157                 self._coerce_from_hash[S] = None
+    158                 return None
+--> 159             mor = self.coerce_map_from_c(sage_type)
+    160             if mor is not None:
+    161                 mor = mor * sage_type._internal_coerce_map_from(S)
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.coerce_map_from_c (build/cythonized/sage/structure/parent_old.c:3768)()
+    141             pass
+    142 
+--> 143         mor = self.coerce_map_from_c_impl(S)
+    144         import sage.categories.morphism
+    145         import sage.categories.map
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.coerce_map_from_c_impl (build/cythonized/sage/structure/parent_old.c:4710)()
+    189         # Piggyback off the old code for now
+    190         # WARNING: when working on this, make sure circular dependencies aren't introduced!
+--> 191         if self.has_coerce_map_from_c(S):
+    192             if isinstance(S, type):
+    193                 S = Set_PythonType(S)
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.has_coerce_map_from_c (build/cythonized/sage/structure/parent_old.c:6312)()
+    275             except KeyError:
+    276                 pass
+--> 277         x = self.has_coerce_map_from_c_impl(S)
+    278         self._has_coerce_map_from.set(S, x)
+    279         return x
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.has_coerce_map_from_c_impl (build/cythonized/sage/structure/parent_old.c:6489)()
+    284             return False
+    285         try:
+--> 286             self._coerce_c((<parent.Parent>S).an_element())
+    287         except TypeError:
+    288             return False
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent._coerce_c (build/cythonized/sage/structure/parent_old.c:5382)()
+    217             pass
+    218         if HAS_DICTIONARY(self):
+--> 219             return self._coerce_impl(x)
+    220         else:
+    221             return self._coerce_c_impl(x)
+
+/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in _coerce_impl(self, x)
+   1100             and self.base_ring().has_coerce_map_from(x.base_ring())):
+   1101             return self(x)
+-> 1102         return self._coerce_try(x, self.base_ring())
+   1103 
+   1104     def _repr_(self):
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent._coerce_try (build/cythonized/sage/structure/parent_old.c:5902)()
+    255             try:
+    256                 y = R._coerce_(x)
+--> 257                 return self(y)
+    258             except (TypeError, AttributeError) as msg:
+    259                 pass
+
+/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in __call__(self, entries, coerce, copy, sparse)
+    873             [t]
+    874         """
+--> 875         return self.matrix(entries, coerce, copy)
+    876 
+    877     def change_ring(self, R):
+
+/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in matrix(self, x, coerce, copy)
+   1886                 x = list_to_dict(x, m, n)
+   1887                 copy = False
+-> 1888         return MC(self, x, copy=copy, coerce=coerce)
+   1889 
+   1890     def matrix_space(self, nrows=None, ncols=None, sparse=False):
+
+/home/king/Sage/git/sage/src/sage/matrix/matrix_gfpn_dense.pyx in sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense.__init__ (build/cythonized/sage/matrix/matrix_gfpn_dense.c:5278)()
+    423                 return
+    424             if self._nrows != self._ncols:
+--> 425                 raise ValueError("Cannot initialise non-square matrix from {}".format(data))
+    426             f = FfFromInt(self._converter.field_to_int(self._coerce_element(data)))
+    427             x = self.Data.Data
+
 ValueError: Cannot initialise non-square matrix from 1
 ```
 
@@ -24,7 +174,6 @@
 [0 0 0]
 ```
 
-Keywords: meataxe coercion
 
 Comment: 1
 
``````




---

archive/issue_comments_371316.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,180 @@\n+The following happens when MeatAxe is used as a matrix backend:\n+\n+```\n+sage: M = matrix(GF(9,'x'), 2,3)\n+sage: type(M)\n+<type 'sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense'>\n+sage: M*1\n+[0 0 0]\n+[0 0 0]\n+sage: M*int(1)\n+---------------------------------------------------------------------------\n+ValueError                                Traceback (most recent call last)\n+<ipython-input-3-1a2faedb318b> in <module>()\n+----> 1 M*int(Integer(1))\n+\n+/home/king/Sage/git/sage/src/sage/structure/element.pyx in sage.structure.element.Matrix.__mul__ (build/cythonized/sage/structure/element.c:23460)()\n+   3671         if have_same_parent(left, right):\n+   3672             return (<Matrix>left)._matrix_times_matrix_(<Matrix>right)\n+-> 3673         return coercion_model.bin_op(left, right, mul)\n+   3674 \n+   3675     def __truediv__(left, right):\n+\n+/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.bin_op (build/cythonized/sage/structure/coerce.c:9671)()\n+   1111             if xp is yp:\n+   1112                 return op(x,y)\n+-> 1113             action = self.get_action(xp, yp, op, x, y)\n+   1114             if action is not None:\n+   1115                 return (<Action>action)._call_(x, y)\n+\n+/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.get_action (build/cythonized/sage/structure/coerce.c:16889)()\n+   1654         except KeyError:\n+   1655             pass\n+-> 1656         action = self.discover_action(R, S, op, r, s)\n+   1657         action = self.verify_action(action, R, S, op)\n+   1658         self._action_maps.set(R, S, op, action)\n+\n+/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.discover_action (build/cythonized/sage/structure/coerce.c:18411)()\n+   1804 \n+   1805         if isinstance(R, Parent):\n+-> 1806             action = (<Parent>R).get_action(S, op, True, r, s)\n+   1807             if action is not None:\n+   1808                 return action\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.get_action (build/cythonized/sage/structure/parent.c:21664)()\n+   2493         action = self._get_action_(S, op, self_on_left)\n+   2494         if action is None:\n+-> 2495             action = self.discover_action(S, op, self_on_left, self_el, S_el)\n+   2496 \n+   2497         if action is not None:\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.discover_action (build/cythonized/sage/structure/parent.c:23017)()\n+   2604                     return action\n+   2605 \n+-> 2606                 if parent_is_integers(S) and not self.has_coerce_map_from(S):\n+   2607                     from sage.structure.coerce_actions import IntegerMulAction\n+   2608                     try:\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.has_coerce_map_from (build/cythonized/sage/structure/parent.c:17925)()\n+   2022                 print(\"Warning: non-unique parents %s\" % (type(S)))\n+   2023             return True\n+-> 2024         return self._internal_coerce_map_from(S) is not None\n+   2025 \n+   2026     cpdef _coerce_map_from_(self, S):\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent._internal_coerce_map_from (build/cythonized/sage/structure/parent.c:18944)()\n+   2164         try:\n+   2165             _register_pair(self, S, \"coerce\")\n+-> 2166             mor = self.discover_coerce_map_from(S)\n+   2167             #if mor is not None:\n+   2168             #    # Need to check that this morphism doesn't connect previously unconnected parts of the coercion diagram\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.discover_coerce_map_from (build/cythonized/sage/structure/parent.c:19396)()\n+   2301                 return (<Parent>S)._embedding\n+   2302 \n+-> 2303         user_provided_mor = self._coerce_map_from_(S)\n+   2304 \n+   2305         if user_provided_mor is None or user_provided_mor is False:\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent._coerce_map_from_ (build/cythonized/sage/structure/parent_old.c:7549)()\n+    339     cpdef _coerce_map_from_(self, S):\n+    340         if self._element_constructor is None:\n+--> 341             return self.coerce_map_from_c(S)\n+    342         else:\n+    343             return parent.Parent._coerce_map_from_(self, S)\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.coerce_map_from_c (build/cythonized/sage/structure/parent_old.c:4044)()\n+    157                 self._coerce_from_hash[S] = None\n+    158                 return None\n+--> 159             mor = self.coerce_map_from_c(sage_type)\n+    160             if mor is not None:\n+    161                 mor = mor * sage_type._internal_coerce_map_from(S)\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.coerce_map_from_c (build/cythonized/sage/structure/parent_old.c:3768)()\n+    141             pass\n+    142 \n+--> 143         mor = self.coerce_map_from_c_impl(S)\n+    144         import sage.categories.morphism\n+    145         import sage.categories.map\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.coerce_map_from_c_impl (build/cythonized/sage/structure/parent_old.c:4710)()\n+    189         # Piggyback off the old code for now\n+    190         # WARNING: when working on this, make sure circular dependencies aren't introduced!\n+--> 191         if self.has_coerce_map_from_c(S):\n+    192             if isinstance(S, type):\n+    193                 S = Set_PythonType(S)\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.has_coerce_map_from_c (build/cythonized/sage/structure/parent_old.c:6312)()\n+    275             except KeyError:\n+    276                 pass\n+--> 277         x = self.has_coerce_map_from_c_impl(S)\n+    278         self._has_coerce_map_from.set(S, x)\n+    279         return x\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.has_coerce_map_from_c_impl (build/cythonized/sage/structure/parent_old.c:6489)()\n+    284             return False\n+    285         try:\n+--> 286             self._coerce_c((<parent.Parent>S).an_element())\n+    287         except TypeError:\n+    288             return False\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent._coerce_c (build/cythonized/sage/structure/parent_old.c:5382)()\n+    217             pass\n+    218         if HAS_DICTIONARY(self):\n+--> 219             return self._coerce_impl(x)\n+    220         else:\n+    221             return self._coerce_c_impl(x)\n+\n+/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in _coerce_impl(self, x)\n+   1100             and self.base_ring().has_coerce_map_from(x.base_ring())):\n+   1101             return self(x)\n+-> 1102         return self._coerce_try(x, self.base_ring())\n+   1103 \n+   1104     def _repr_(self):\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent._coerce_try (build/cythonized/sage/structure/parent_old.c:5902)()\n+    255             try:\n+    256                 y = R._coerce_(x)\n+--> 257                 return self(y)\n+    258             except (TypeError, AttributeError) as msg:\n+    259                 pass\n+\n+/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in __call__(self, entries, coerce, copy, sparse)\n+    873             [t]\n+    874         \"\"\"\n+--> 875         return self.matrix(entries, coerce, copy)\n+    876 \n+    877     def change_ring(self, R):\n+\n+/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in matrix(self, x, coerce, copy)\n+   1886                 x = list_to_dict(x, m, n)\n+   1887                 copy = False\n+-> 1888         return MC(self, x, copy=copy, coerce=coerce)\n+   1889 \n+   1890     def matrix_space(self, nrows=None, ncols=None, sparse=False):\n+\n+/home/king/Sage/git/sage/src/sage/matrix/matrix_gfpn_dense.pyx in sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense.__init__ (build/cythonized/sage/matrix/matrix_gfpn_dense.c:5278)()\n+    423                 return\n+    424             if self._nrows != self._ncols:\n+--> 425                 raise ValueError(\"Cannot initialise non-square matrix from {}\".format(data))\n+    426             f = FfFromInt(self._converter.field_to_int(self._coerce_element(data)))\n+    427             x = self.Data.Data\n+\n+ValueError: Cannot initialise non-square matrix from 1\n+```\n+\n+The Python int 1 should or course not be converted into the matrix space (simply because that matrix space is not an algebra), but instead should be converted into the matrix' basering, so that _lmul_ can be called.\n+\n+Or even better: The shortcut _mul_long() should be used, which is supported by sage.structure.element but isn't used anywhere in sage.matrix except in sage.matrix.matrix_gfpn_dense.\n+\n+It could be that the actual error is in the coercion system, although it seems to occur only with the MeatAxe backend:\n+\n+```\n+sage: M = MatrixSpace(GF(9,'x'), 2,3, implementation=\"generic\")()\n+sage: M*int(1)\n+[0 0 0]\n+[0 0 0]\n+```\n \n \n Comment: 1\n``````\n",
    "created_at": "2018-04-02T07:59:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371316",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,180 @@
+The following happens when MeatAxe is used as a matrix backend:
+
+```
+sage: M = matrix(GF(9,'x'), 2,3)
+sage: type(M)
+<type 'sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense'>
+sage: M*1
+[0 0 0]
+[0 0 0]
+sage: M*int(1)
+---------------------------------------------------------------------------
+ValueError                                Traceback (most recent call last)
+<ipython-input-3-1a2faedb318b> in <module>()
+----> 1 M*int(Integer(1))
+
+/home/king/Sage/git/sage/src/sage/structure/element.pyx in sage.structure.element.Matrix.__mul__ (build/cythonized/sage/structure/element.c:23460)()
+   3671         if have_same_parent(left, right):
+   3672             return (<Matrix>left)._matrix_times_matrix_(<Matrix>right)
+-> 3673         return coercion_model.bin_op(left, right, mul)
+   3674 
+   3675     def __truediv__(left, right):
+
+/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.bin_op (build/cythonized/sage/structure/coerce.c:9671)()
+   1111             if xp is yp:
+   1112                 return op(x,y)
+-> 1113             action = self.get_action(xp, yp, op, x, y)
+   1114             if action is not None:
+   1115                 return (<Action>action)._call_(x, y)
+
+/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.get_action (build/cythonized/sage/structure/coerce.c:16889)()
+   1654         except KeyError:
+   1655             pass
+-> 1656         action = self.discover_action(R, S, op, r, s)
+   1657         action = self.verify_action(action, R, S, op)
+   1658         self._action_maps.set(R, S, op, action)
+
+/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.discover_action (build/cythonized/sage/structure/coerce.c:18411)()
+   1804 
+   1805         if isinstance(R, Parent):
+-> 1806             action = (<Parent>R).get_action(S, op, True, r, s)
+   1807             if action is not None:
+   1808                 return action
+
+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.get_action (build/cythonized/sage/structure/parent.c:21664)()
+   2493         action = self._get_action_(S, op, self_on_left)
+   2494         if action is None:
+-> 2495             action = self.discover_action(S, op, self_on_left, self_el, S_el)
+   2496 
+   2497         if action is not None:
+
+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.discover_action (build/cythonized/sage/structure/parent.c:23017)()
+   2604                     return action
+   2605 
+-> 2606                 if parent_is_integers(S) and not self.has_coerce_map_from(S):
+   2607                     from sage.structure.coerce_actions import IntegerMulAction
+   2608                     try:
+
+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.has_coerce_map_from (build/cythonized/sage/structure/parent.c:17925)()
+   2022                 print("Warning: non-unique parents %s" % (type(S)))
+   2023             return True
+-> 2024         return self._internal_coerce_map_from(S) is not None
+   2025 
+   2026     cpdef _coerce_map_from_(self, S):
+
+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent._internal_coerce_map_from (build/cythonized/sage/structure/parent.c:18944)()
+   2164         try:
+   2165             _register_pair(self, S, "coerce")
+-> 2166             mor = self.discover_coerce_map_from(S)
+   2167             #if mor is not None:
+   2168             #    # Need to check that this morphism doesn't connect previously unconnected parts of the coercion diagram
+
+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.discover_coerce_map_from (build/cythonized/sage/structure/parent.c:19396)()
+   2301                 return (<Parent>S)._embedding
+   2302 
+-> 2303         user_provided_mor = self._coerce_map_from_(S)
+   2304 
+   2305         if user_provided_mor is None or user_provided_mor is False:
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent._coerce_map_from_ (build/cythonized/sage/structure/parent_old.c:7549)()
+    339     cpdef _coerce_map_from_(self, S):
+    340         if self._element_constructor is None:
+--> 341             return self.coerce_map_from_c(S)
+    342         else:
+    343             return parent.Parent._coerce_map_from_(self, S)
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.coerce_map_from_c (build/cythonized/sage/structure/parent_old.c:4044)()
+    157                 self._coerce_from_hash[S] = None
+    158                 return None
+--> 159             mor = self.coerce_map_from_c(sage_type)
+    160             if mor is not None:
+    161                 mor = mor * sage_type._internal_coerce_map_from(S)
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.coerce_map_from_c (build/cythonized/sage/structure/parent_old.c:3768)()
+    141             pass
+    142 
+--> 143         mor = self.coerce_map_from_c_impl(S)
+    144         import sage.categories.morphism
+    145         import sage.categories.map
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.coerce_map_from_c_impl (build/cythonized/sage/structure/parent_old.c:4710)()
+    189         # Piggyback off the old code for now
+    190         # WARNING: when working on this, make sure circular dependencies aren't introduced!
+--> 191         if self.has_coerce_map_from_c(S):
+    192             if isinstance(S, type):
+    193                 S = Set_PythonType(S)
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.has_coerce_map_from_c (build/cythonized/sage/structure/parent_old.c:6312)()
+    275             except KeyError:
+    276                 pass
+--> 277         x = self.has_coerce_map_from_c_impl(S)
+    278         self._has_coerce_map_from.set(S, x)
+    279         return x
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.has_coerce_map_from_c_impl (build/cythonized/sage/structure/parent_old.c:6489)()
+    284             return False
+    285         try:
+--> 286             self._coerce_c((<parent.Parent>S).an_element())
+    287         except TypeError:
+    288             return False
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent._coerce_c (build/cythonized/sage/structure/parent_old.c:5382)()
+    217             pass
+    218         if HAS_DICTIONARY(self):
+--> 219             return self._coerce_impl(x)
+    220         else:
+    221             return self._coerce_c_impl(x)
+
+/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in _coerce_impl(self, x)
+   1100             and self.base_ring().has_coerce_map_from(x.base_ring())):
+   1101             return self(x)
+-> 1102         return self._coerce_try(x, self.base_ring())
+   1103 
+   1104     def _repr_(self):
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent._coerce_try (build/cythonized/sage/structure/parent_old.c:5902)()
+    255             try:
+    256                 y = R._coerce_(x)
+--> 257                 return self(y)
+    258             except (TypeError, AttributeError) as msg:
+    259                 pass
+
+/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in __call__(self, entries, coerce, copy, sparse)
+    873             [t]
+    874         """
+--> 875         return self.matrix(entries, coerce, copy)
+    876 
+    877     def change_ring(self, R):
+
+/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in matrix(self, x, coerce, copy)
+   1886                 x = list_to_dict(x, m, n)
+   1887                 copy = False
+-> 1888         return MC(self, x, copy=copy, coerce=coerce)
+   1889 
+   1890     def matrix_space(self, nrows=None, ncols=None, sparse=False):
+
+/home/king/Sage/git/sage/src/sage/matrix/matrix_gfpn_dense.pyx in sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense.__init__ (build/cythonized/sage/matrix/matrix_gfpn_dense.c:5278)()
+    423                 return
+    424             if self._nrows != self._ncols:
+--> 425                 raise ValueError("Cannot initialise non-square matrix from {}".format(data))
+    426             f = FfFromInt(self._converter.field_to_int(self._coerce_element(data)))
+    427             x = self.Data.Data
+
+ValueError: Cannot initialise non-square matrix from 1
+```
+
+The Python int 1 should or course not be converted into the matrix space (simply because that matrix space is not an algebra), but instead should be converted into the matrix' basering, so that _lmul_ can be called.
+
+Or even better: The shortcut _mul_long() should be used, which is supported by sage.structure.element but isn't used anywhere in sage.matrix except in sage.matrix.matrix_gfpn_dense.
+
+It could be that the actual error is in the coercion system, although it seems to occur only with the MeatAxe backend:
+
+```
+sage: M = MatrixSpace(GF(9,'x'), 2,3, implementation="generic")()
+sage: M*int(1)
+[0 0 0]
+[0 0 0]
+```
 
 
 Comment: 1
``````




---

archive/issue_comments_371317.json:
```json
{
    "body": "Attachment [giac-1.4.9.45.p2.log](tarball://root/attachments/some-uuid/ticket25076/giac-1.4.9.45.p2.log) by @simon-king-jena created at 2018-04-02 08:30:33\n\nFailing giac on Linux 4.4.0-116-generic #140-Ubuntu x86_64",
    "created_at": "2018-04-02T08:30:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371317",
    "user": "https://github.com/simon-king-jena"
}
```

Attachment [giac-1.4.9.45.p2.log](tarball://root/attachments/some-uuid/ticket25076/giac-1.4.9.45.p2.log) by @simon-king-jena created at 2018-04-02 08:30:33

Failing giac on Linux 4.4.0-116-generic #140-Ubuntu x86_64



---

archive/issue_comments_371318.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:9 jdemeyer]:\n> Replying to [comment:7 SimonKing]:\n> > So, perhaps I should retry with #18514 rebased on top of the latest develop branch?\n\n> \n> Yes and let me know if that fixes it.\n\n\nGiac fails to build (see attached log). Known problem?",
    "created_at": "2018-04-02T08:31:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371318",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:12'></a>Replying to [comment:9 jdemeyer]:
> Replying to [comment:7 SimonKing]:
> > So, perhaps I should retry with #18514 rebased on top of the latest develop branch?

> 
> Yes and let me know if that fixes it.


Giac fails to build (see attached log). Known problem?



---

archive/issue_comments_371319.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:12 SimonKing]:\n> Giac fails to build (see attached log). Known problem?\n\n\nPeople have reported it but nobody knows how to reproduce it.",
    "created_at": "2018-04-02T08:49:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371319",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>Replying to [comment:12 SimonKing]:
> Giac fails to build (see attached log). Known problem?


People have reported it but nobody knows how to reproduce it.



---

archive/issue_comments_371320.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [comment:13 jdemeyer]:\n> Replying to [comment:12 SimonKing]:\n> > Giac fails to build (see attached log). Known problem?\n\n> \n> People have reported it but nobody knows how to reproduce it.\n\n\nOuch. Any work-around (such as rebuilding from scratch)?\n\nCould it be related with tkinter being installed (which used to not be the case when I last built Sage)?",
    "created_at": "2018-04-02T08:51:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371320",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:14'></a>Replying to [comment:13 jdemeyer]:
> Replying to [comment:12 SimonKing]:
> > Giac fails to build (see attached log). Known problem?

> 
> People have reported it but nobody knows how to reproduce it.


Ouch. Any work-around (such as rebuilding from scratch)?

Could it be related with tkinter being installed (which used to not be the case when I last built Sage)?



---

archive/issue_comments_371321.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:14 SimonKing]:\n> such as rebuilding from scratch\n\n\nIt's certainly something to try. Please let us know whether that fixes your giac problem.",
    "created_at": "2018-04-02T08:53:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371321",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:15'></a>Replying to [comment:14 SimonKing]:
> such as rebuilding from scratch


It's certainly something to try. Please let us know whether that fixes your giac problem.



---

archive/issue_comments_371322.json:
```json
{
    "body": "<a id='comment:16'></a>I don't know why, but the two messages I was trying to send to sage-release via slrn didn't come through.\n\nTrying now make distclean; make on a clean develop branch.",
    "created_at": "2018-04-02T09:41:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371322",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:16'></a>I don't know why, but the two messages I was trying to send to sage-release via slrn didn't come through.

Trying now make distclean; make on a clean develop branch.



---

archive/issue_comments_371323.json:
```json
{
    "body": "<a id='comment:17'></a>OK, rebuilding from scratch did work. And with clean develop branch, I still get the error.\n\nSo, what is special about matrix_gfpn_dense? What is special about multiplying it with an int? And why the heck is _mul_long not called (why has it been removed from sage.matrix in the first place)?",
    "created_at": "2018-04-02T13:03:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371323",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:17'></a>OK, rebuilding from scratch did work. And with clean develop branch, I still get the error.

So, what is special about matrix_gfpn_dense? What is special about multiplying it with an int? And why the heck is _mul_long not called (why has it been removed from sage.matrix in the first place)?



---

archive/issue_comments_371324.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,180 @@\n+The following happens on some systems (why only some?) when MeatAxe is used as a matrix backend:\n+\n+```\n+sage: M = matrix(GF(9,'x'), 2,3)\n+sage: type(M)\n+<type 'sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense'>\n+sage: M*1\n+[0 0 0]\n+[0 0 0]\n+sage: M*int(1)\n+---------------------------------------------------------------------------\n+ValueError                                Traceback (most recent call last)\n+<ipython-input-3-1a2faedb318b> in <module>()\n+----> 1 M*int(Integer(1))\n+\n+/home/king/Sage/git/sage/src/sage/structure/element.pyx in sage.structure.element.Matrix.__mul__ (build/cythonized/sage/structure/element.c:23460)()\n+   3671         if have_same_parent(left, right):\n+   3672             return (<Matrix>left)._matrix_times_matrix_(<Matrix>right)\n+-> 3673         return coercion_model.bin_op(left, right, mul)\n+   3674 \n+   3675     def __truediv__(left, right):\n+\n+/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.bin_op (build/cythonized/sage/structure/coerce.c:9671)()\n+   1111             if xp is yp:\n+   1112                 return op(x,y)\n+-> 1113             action = self.get_action(xp, yp, op, x, y)\n+   1114             if action is not None:\n+   1115                 return (<Action>action)._call_(x, y)\n+\n+/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.get_action (build/cythonized/sage/structure/coerce.c:16889)()\n+   1654         except KeyError:\n+   1655             pass\n+-> 1656         action = self.discover_action(R, S, op, r, s)\n+   1657         action = self.verify_action(action, R, S, op)\n+   1658         self._action_maps.set(R, S, op, action)\n+\n+/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.discover_action (build/cythonized/sage/structure/coerce.c:18411)()\n+   1804 \n+   1805         if isinstance(R, Parent):\n+-> 1806             action = (<Parent>R).get_action(S, op, True, r, s)\n+   1807             if action is not None:\n+   1808                 return action\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.get_action (build/cythonized/sage/structure/parent.c:21664)()\n+   2493         action = self._get_action_(S, op, self_on_left)\n+   2494         if action is None:\n+-> 2495             action = self.discover_action(S, op, self_on_left, self_el, S_el)\n+   2496 \n+   2497         if action is not None:\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.discover_action (build/cythonized/sage/structure/parent.c:23017)()\n+   2604                     return action\n+   2605 \n+-> 2606                 if parent_is_integers(S) and not self.has_coerce_map_from(S):\n+   2607                     from sage.structure.coerce_actions import IntegerMulAction\n+   2608                     try:\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.has_coerce_map_from (build/cythonized/sage/structure/parent.c:17925)()\n+   2022                 print(\"Warning: non-unique parents %s\" % (type(S)))\n+   2023             return True\n+-> 2024         return self._internal_coerce_map_from(S) is not None\n+   2025 \n+   2026     cpdef _coerce_map_from_(self, S):\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent._internal_coerce_map_from (build/cythonized/sage/structure/parent.c:18944)()\n+   2164         try:\n+   2165             _register_pair(self, S, \"coerce\")\n+-> 2166             mor = self.discover_coerce_map_from(S)\n+   2167             #if mor is not None:\n+   2168             #    # Need to check that this morphism doesn't connect previously unconnected parts of the coercion diagram\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.discover_coerce_map_from (build/cythonized/sage/structure/parent.c:19396)()\n+   2301                 return (<Parent>S)._embedding\n+   2302 \n+-> 2303         user_provided_mor = self._coerce_map_from_(S)\n+   2304 \n+   2305         if user_provided_mor is None or user_provided_mor is False:\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent._coerce_map_from_ (build/cythonized/sage/structure/parent_old.c:7549)()\n+    339     cpdef _coerce_map_from_(self, S):\n+    340         if self._element_constructor is None:\n+--> 341             return self.coerce_map_from_c(S)\n+    342         else:\n+    343             return parent.Parent._coerce_map_from_(self, S)\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.coerce_map_from_c (build/cythonized/sage/structure/parent_old.c:4044)()\n+    157                 self._coerce_from_hash[S] = None\n+    158                 return None\n+--> 159             mor = self.coerce_map_from_c(sage_type)\n+    160             if mor is not None:\n+    161                 mor = mor * sage_type._internal_coerce_map_from(S)\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.coerce_map_from_c (build/cythonized/sage/structure/parent_old.c:3768)()\n+    141             pass\n+    142 \n+--> 143         mor = self.coerce_map_from_c_impl(S)\n+    144         import sage.categories.morphism\n+    145         import sage.categories.map\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.coerce_map_from_c_impl (build/cythonized/sage/structure/parent_old.c:4710)()\n+    189         # Piggyback off the old code for now\n+    190         # WARNING: when working on this, make sure circular dependencies aren't introduced!\n+--> 191         if self.has_coerce_map_from_c(S):\n+    192             if isinstance(S, type):\n+    193                 S = Set_PythonType(S)\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.has_coerce_map_from_c (build/cythonized/sage/structure/parent_old.c:6312)()\n+    275             except KeyError:\n+    276                 pass\n+--> 277         x = self.has_coerce_map_from_c_impl(S)\n+    278         self._has_coerce_map_from.set(S, x)\n+    279         return x\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.has_coerce_map_from_c_impl (build/cythonized/sage/structure/parent_old.c:6489)()\n+    284             return False\n+    285         try:\n+--> 286             self._coerce_c((<parent.Parent>S).an_element())\n+    287         except TypeError:\n+    288             return False\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent._coerce_c (build/cythonized/sage/structure/parent_old.c:5382)()\n+    217             pass\n+    218         if HAS_DICTIONARY(self):\n+--> 219             return self._coerce_impl(x)\n+    220         else:\n+    221             return self._coerce_c_impl(x)\n+\n+/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in _coerce_impl(self, x)\n+   1100             and self.base_ring().has_coerce_map_from(x.base_ring())):\n+   1101             return self(x)\n+-> 1102         return self._coerce_try(x, self.base_ring())\n+   1103 \n+   1104     def _repr_(self):\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent._coerce_try (build/cythonized/sage/structure/parent_old.c:5902)()\n+    255             try:\n+    256                 y = R._coerce_(x)\n+--> 257                 return self(y)\n+    258             except (TypeError, AttributeError) as msg:\n+    259                 pass\n+\n+/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in __call__(self, entries, coerce, copy, sparse)\n+    873             [t]\n+    874         \"\"\"\n+--> 875         return self.matrix(entries, coerce, copy)\n+    876 \n+    877     def change_ring(self, R):\n+\n+/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in matrix(self, x, coerce, copy)\n+   1886                 x = list_to_dict(x, m, n)\n+   1887                 copy = False\n+-> 1888         return MC(self, x, copy=copy, coerce=coerce)\n+   1889 \n+   1890     def matrix_space(self, nrows=None, ncols=None, sparse=False):\n+\n+/home/king/Sage/git/sage/src/sage/matrix/matrix_gfpn_dense.pyx in sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense.__init__ (build/cythonized/sage/matrix/matrix_gfpn_dense.c:5278)()\n+    423                 return\n+    424             if self._nrows != self._ncols:\n+--> 425                 raise ValueError(\"Cannot initialise non-square matrix from {}\".format(data))\n+    426             f = FfFromInt(self._converter.field_to_int(self._coerce_element(data)))\n+    427             x = self.Data.Data\n+\n+ValueError: Cannot initialise non-square matrix from 1\n+```\n+\n+The Python int 1 should or course not be converted into the matrix space (simply because that matrix space is not an algebra), but instead should be converted into the matrix' basering, so that _lmul_ can be called.\n+\n+Or even better: The shortcut _mul_long() should be used, which is supported by sage.structure.element but isn't used anywhere in sage.matrix except in sage.matrix.matrix_gfpn_dense.\n+\n+It could be that the actual error is in the coercion system, although it seems to occur only with the MeatAxe backend:\n+\n+```\n+sage: M = MatrixSpace(GF(9,'x'), 2,3, implementation=\"generic\")()\n+sage: M*int(1)\n+[0 0 0]\n+[0 0 0]\n+```\n \n \n Comment: 1\n``````\n",
    "created_at": "2018-04-02T13:27:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371324",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,180 @@
+The following happens on some systems (why only some?) when MeatAxe is used as a matrix backend:
+
+```
+sage: M = matrix(GF(9,'x'), 2,3)
+sage: type(M)
+<type 'sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense'>
+sage: M*1
+[0 0 0]
+[0 0 0]
+sage: M*int(1)
+---------------------------------------------------------------------------
+ValueError                                Traceback (most recent call last)
+<ipython-input-3-1a2faedb318b> in <module>()
+----> 1 M*int(Integer(1))
+
+/home/king/Sage/git/sage/src/sage/structure/element.pyx in sage.structure.element.Matrix.__mul__ (build/cythonized/sage/structure/element.c:23460)()
+   3671         if have_same_parent(left, right):
+   3672             return (<Matrix>left)._matrix_times_matrix_(<Matrix>right)
+-> 3673         return coercion_model.bin_op(left, right, mul)
+   3674 
+   3675     def __truediv__(left, right):
+
+/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.bin_op (build/cythonized/sage/structure/coerce.c:9671)()
+   1111             if xp is yp:
+   1112                 return op(x,y)
+-> 1113             action = self.get_action(xp, yp, op, x, y)
+   1114             if action is not None:
+   1115                 return (<Action>action)._call_(x, y)
+
+/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.get_action (build/cythonized/sage/structure/coerce.c:16889)()
+   1654         except KeyError:
+   1655             pass
+-> 1656         action = self.discover_action(R, S, op, r, s)
+   1657         action = self.verify_action(action, R, S, op)
+   1658         self._action_maps.set(R, S, op, action)
+
+/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.discover_action (build/cythonized/sage/structure/coerce.c:18411)()
+   1804 
+   1805         if isinstance(R, Parent):
+-> 1806             action = (<Parent>R).get_action(S, op, True, r, s)
+   1807             if action is not None:
+   1808                 return action
+
+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.get_action (build/cythonized/sage/structure/parent.c:21664)()
+   2493         action = self._get_action_(S, op, self_on_left)
+   2494         if action is None:
+-> 2495             action = self.discover_action(S, op, self_on_left, self_el, S_el)
+   2496 
+   2497         if action is not None:
+
+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.discover_action (build/cythonized/sage/structure/parent.c:23017)()
+   2604                     return action
+   2605 
+-> 2606                 if parent_is_integers(S) and not self.has_coerce_map_from(S):
+   2607                     from sage.structure.coerce_actions import IntegerMulAction
+   2608                     try:
+
+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.has_coerce_map_from (build/cythonized/sage/structure/parent.c:17925)()
+   2022                 print("Warning: non-unique parents %s" % (type(S)))
+   2023             return True
+-> 2024         return self._internal_coerce_map_from(S) is not None
+   2025 
+   2026     cpdef _coerce_map_from_(self, S):
+
+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent._internal_coerce_map_from (build/cythonized/sage/structure/parent.c:18944)()
+   2164         try:
+   2165             _register_pair(self, S, "coerce")
+-> 2166             mor = self.discover_coerce_map_from(S)
+   2167             #if mor is not None:
+   2168             #    # Need to check that this morphism doesn't connect previously unconnected parts of the coercion diagram
+
+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.discover_coerce_map_from (build/cythonized/sage/structure/parent.c:19396)()
+   2301                 return (<Parent>S)._embedding
+   2302 
+-> 2303         user_provided_mor = self._coerce_map_from_(S)
+   2304 
+   2305         if user_provided_mor is None or user_provided_mor is False:
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent._coerce_map_from_ (build/cythonized/sage/structure/parent_old.c:7549)()
+    339     cpdef _coerce_map_from_(self, S):
+    340         if self._element_constructor is None:
+--> 341             return self.coerce_map_from_c(S)
+    342         else:
+    343             return parent.Parent._coerce_map_from_(self, S)
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.coerce_map_from_c (build/cythonized/sage/structure/parent_old.c:4044)()
+    157                 self._coerce_from_hash[S] = None
+    158                 return None
+--> 159             mor = self.coerce_map_from_c(sage_type)
+    160             if mor is not None:
+    161                 mor = mor * sage_type._internal_coerce_map_from(S)
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.coerce_map_from_c (build/cythonized/sage/structure/parent_old.c:3768)()
+    141             pass
+    142 
+--> 143         mor = self.coerce_map_from_c_impl(S)
+    144         import sage.categories.morphism
+    145         import sage.categories.map
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.coerce_map_from_c_impl (build/cythonized/sage/structure/parent_old.c:4710)()
+    189         # Piggyback off the old code for now
+    190         # WARNING: when working on this, make sure circular dependencies aren't introduced!
+--> 191         if self.has_coerce_map_from_c(S):
+    192             if isinstance(S, type):
+    193                 S = Set_PythonType(S)
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.has_coerce_map_from_c (build/cythonized/sage/structure/parent_old.c:6312)()
+    275             except KeyError:
+    276                 pass
+--> 277         x = self.has_coerce_map_from_c_impl(S)
+    278         self._has_coerce_map_from.set(S, x)
+    279         return x
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.has_coerce_map_from_c_impl (build/cythonized/sage/structure/parent_old.c:6489)()
+    284             return False
+    285         try:
+--> 286             self._coerce_c((<parent.Parent>S).an_element())
+    287         except TypeError:
+    288             return False
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent._coerce_c (build/cythonized/sage/structure/parent_old.c:5382)()
+    217             pass
+    218         if HAS_DICTIONARY(self):
+--> 219             return self._coerce_impl(x)
+    220         else:
+    221             return self._coerce_c_impl(x)
+
+/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in _coerce_impl(self, x)
+   1100             and self.base_ring().has_coerce_map_from(x.base_ring())):
+   1101             return self(x)
+-> 1102         return self._coerce_try(x, self.base_ring())
+   1103 
+   1104     def _repr_(self):
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent._coerce_try (build/cythonized/sage/structure/parent_old.c:5902)()
+    255             try:
+    256                 y = R._coerce_(x)
+--> 257                 return self(y)
+    258             except (TypeError, AttributeError) as msg:
+    259                 pass
+
+/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in __call__(self, entries, coerce, copy, sparse)
+    873             [t]
+    874         """
+--> 875         return self.matrix(entries, coerce, copy)
+    876 
+    877     def change_ring(self, R):
+
+/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in matrix(self, x, coerce, copy)
+   1886                 x = list_to_dict(x, m, n)
+   1887                 copy = False
+-> 1888         return MC(self, x, copy=copy, coerce=coerce)
+   1889 
+   1890     def matrix_space(self, nrows=None, ncols=None, sparse=False):
+
+/home/king/Sage/git/sage/src/sage/matrix/matrix_gfpn_dense.pyx in sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense.__init__ (build/cythonized/sage/matrix/matrix_gfpn_dense.c:5278)()
+    423                 return
+    424             if self._nrows != self._ncols:
+--> 425                 raise ValueError("Cannot initialise non-square matrix from {}".format(data))
+    426             f = FfFromInt(self._converter.field_to_int(self._coerce_element(data)))
+    427             x = self.Data.Data
+
+ValueError: Cannot initialise non-square matrix from 1
+```
+
+The Python int 1 should or course not be converted into the matrix space (simply because that matrix space is not an algebra), but instead should be converted into the matrix' basering, so that _lmul_ can be called.
+
+Or even better: The shortcut _mul_long() should be used, which is supported by sage.structure.element but isn't used anywhere in sage.matrix except in sage.matrix.matrix_gfpn_dense.
+
+It could be that the actual error is in the coercion system, although it seems to occur only with the MeatAxe backend:
+
+```
+sage: M = MatrixSpace(GF(9,'x'), 2,3, implementation="generic")()
+sage: M*int(1)
+[0 0 0]
+[0 0 0]
+```
 
 
 Comment: 1
``````




---

archive/issue_comments_371325.json:
```json
{
    "body": "Changing component from packages: optional to coercion.",
    "created_at": "2018-04-02T13:27:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371325",
    "user": "https://github.com/jdemeyer"
}
```

Changing component from packages: optional to coercion.



---

archive/issue_comments_371326.json:
```json
{
    "body": "<a id='comment:19'></a>Now that's really frustrating. It is supposed to be related with coercion. Coercion is supposed to be machine independent. So, why (as Jeroen clarifies in the new ticket description) is the bug only present on some machines?\n\nBy the way, on #18514, at least one other person has seen that error. So, it is not restricted to my own laptop.",
    "created_at": "2018-04-02T13:33:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371326",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:19'></a>Now that's really frustrating. It is supposed to be related with coercion. Coercion is supposed to be machine independent. So, why (as Jeroen clarifies in the new ticket description) is the bug only present on some machines?

By the way, on #18514, at least one other person has seen that error. So, it is not restricted to my own laptop.



---

archive/issue_comments_371327.json:
```json
{
    "body": "<a id='comment:20'></a>If it makes you feel better, I managed to reproduce it on a different machine.",
    "created_at": "2018-04-02T13:35:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371327",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:20'></a>If it makes you feel better, I managed to reproduce it on a different machine.



---

archive/issue_comments_371328.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [comment:17 SimonKing]:\n> OK, rebuilding from scratch did work. And with clean develop branch, I still get the error.\n> \n> So, what is special about matrix_gfpn_dense? What is special about multiplying it with an int? And why the heck is _mul_long not called (why has it been removed from sage.matrix in the first place)?\n\n\ndid you try other native python types, e.g. float?",
    "created_at": "2018-04-02T13:36:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371328",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:21'></a>Replying to [comment:17 SimonKing]:
> OK, rebuilding from scratch did work. And with clean develop branch, I still get the error.
> 
> So, what is special about matrix_gfpn_dense? What is special about multiplying it with an int? And why the heck is _mul_long not called (why has it been removed from sage.matrix in the first place)?


did you try other native python types, e.g. float?



---

archive/issue_comments_371329.json:
```json
{
    "body": "<a id='comment:22'></a>it might be gmp vs mpir difference, by the way.",
    "created_at": "2018-04-02T13:38:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371329",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:22'></a>it might be gmp vs mpir difference, by the way.



---

archive/issue_comments_371330.json:
```json
{
    "body": "<a id='comment:23'></a>Replying to [comment:21 dimpase]:\n> Replying to [comment:17 SimonKing]:\n> > OK, rebuilding from scratch did work. And with clean develop branch, I still get the error.\n> > \n> > So, what is special about matrix_gfpn_dense? What is special about multiplying it with an int? And why the heck is _mul_long not called (why has it been removed from sage.matrix in the first place)?\n\n> \n> did you try other native python types, e.g. float?\n\n\nDoesn't make sense, as a float doesn't coerce into GF(3).\n\nBy inserting print statements into the bin_op method of the coercion model, I found that it isn't even called, although it should be.",
    "created_at": "2018-04-02T13:38:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371330",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:23'></a>Replying to [comment:21 dimpase]:
> Replying to [comment:17 SimonKing]:
> > OK, rebuilding from scratch did work. And with clean develop branch, I still get the error.
> > 
> > So, what is special about matrix_gfpn_dense? What is special about multiplying it with an int? And why the heck is _mul_long not called (why has it been removed from sage.matrix in the first place)?

> 
> did you try other native python types, e.g. float?


Doesn't make sense, as a float doesn't coerce into GF(3).

By inserting print statements into the bin_op method of the coercion model, I found that it isn't even called, although it should be.



---

archive/issue_comments_371331.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [comment:22 dimpase]:\n> it might be gmp vs mpir difference, by the way.\n\n\nDoes it even come that far?",
    "created_at": "2018-04-02T13:38:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371331",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:24'></a>Replying to [comment:22 dimpase]:
> it might be gmp vs mpir difference, by the way.


Does it even come that far?



---

archive/issue_comments_371332.json:
```json
{
    "body": "<a id='comment:25'></a>Or to be precise: The bin_op method *is* called, but it doesn't come to the line \"if op is mul or op is imul:...\"",
    "created_at": "2018-04-02T13:41:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371332",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:25'></a>Or to be precise: The bin_op method *is* called, but it doesn't come to the line "if op is mul or op is imul:..."



---

archive/issue_comments_371333.json:
```json
{
    "body": "<a id='comment:26'></a>This seems to be fixed (accidentally) by #24742.\n\nProposal: consider this issue a duplicate, just add a doctest to prevent regressions.",
    "created_at": "2018-04-02T13:42:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371333",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:26'></a>This seems to be fixed (accidentally) by #24742.

Proposal: consider this issue a duplicate, just add a doctest to prevent regressions.



---

archive/issue_comments_371334.json:
```json
{
    "body": "<a id='comment:27'></a>Replying to [comment:22 dimpase]:\n> it might be gmp vs mpir difference, by the way.\n\n\nI just noticed something that supports your guess. When doing \"sage -br\", I noticed these lines:\n\n```\nUpdating Cython code....\nsage/rings/complex_double.pyx: cannot find cimported module 'gmpy2'\nsage/rings/complex_number.pyx: cannot find cimported module 'gmpy2'\nsage/rings/integer.pyx: cannot find cimported module 'gmpy2'\nsage/rings/complex_mpc.pyx: cannot find cimported module 'gmpy2'\nsage/rings/rational.pyx: cannot find cimported module 'gmpy2'\nsage/rings/real_double.pyx: cannot find cimported module 'gmpy2'\nsage/rings/real_mpfr.pyx: cannot find cimported module 'gmpy2'\n```",
    "created_at": "2018-04-02T13:44:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371334",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:27'></a>Replying to [comment:22 dimpase]:
> it might be gmp vs mpir difference, by the way.


I just noticed something that supports your guess. When doing "sage -br", I noticed these lines:

```
Updating Cython code....
sage/rings/complex_double.pyx: cannot find cimported module 'gmpy2'
sage/rings/complex_number.pyx: cannot find cimported module 'gmpy2'
sage/rings/integer.pyx: cannot find cimported module 'gmpy2'
sage/rings/complex_mpc.pyx: cannot find cimported module 'gmpy2'
sage/rings/rational.pyx: cannot find cimported module 'gmpy2'
sage/rings/real_double.pyx: cannot find cimported module 'gmpy2'
sage/rings/real_mpfr.pyx: cannot find cimported module 'gmpy2'
```



---

archive/issue_comments_371335.json:
```json
{
    "body": "<a id='comment:29'></a>Replying to [comment:27 SimonKing]:\n> {{{\n> sage/rings/complex_double.pyx: cannot find cimported module 'gmpy2'\n> sage/rings/complex_number.pyx: cannot find cimported module 'gmpy2'\n> sage/rings/integer.pyx: cannot find cimported module 'gmpy2'\n> sage/rings/complex_mpc.pyx: cannot find cimported module 'gmpy2'\n> sage/rings/rational.pyx: cannot find cimported module 'gmpy2'\n> sage/rings/real_double.pyx: cannot find cimported module 'gmpy2'\n> sage/rings/real_mpfr.pyx: cannot find cimported module 'gmpy2'\n> }}}\n\n\nRed herring. Those warnings only mean that the Python package `gmpy2` was not installed.",
    "created_at": "2018-04-02T13:46:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371335",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:29'></a>Replying to [comment:27 SimonKing]:
> {{{
> sage/rings/complex_double.pyx: cannot find cimported module 'gmpy2'
> sage/rings/complex_number.pyx: cannot find cimported module 'gmpy2'
> sage/rings/integer.pyx: cannot find cimported module 'gmpy2'
> sage/rings/complex_mpc.pyx: cannot find cimported module 'gmpy2'
> sage/rings/rational.pyx: cannot find cimported module 'gmpy2'
> sage/rings/real_double.pyx: cannot find cimported module 'gmpy2'
> sage/rings/real_mpfr.pyx: cannot find cimported module 'gmpy2'
> }}}


Red herring. Those warnings only mean that the Python package `gmpy2` was not installed.



---

archive/issue_comments_371336.json:
```json
{
    "body": "<a id='comment:31'></a>New commits:",
    "created_at": "2018-04-02T13:48:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371336",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:31'></a>New commits:



---

archive/issue_comments_371337.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-04-02T13:48:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371337",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_371338.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-04-02T14:02:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371338",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_371339.json:
```json
{
    "body": "<a id='comment:32'></a>It isn't fixed. I inserted a print statement in the _mul_long method of matrix_gfpn_dense, but apparently the method is not called.\n\nBy consequence, the Python int is converted to an element of the base ring and then multiplied using _lmul_. I should run some timings, but I am sure that this is slower than using _mul_long.",
    "created_at": "2018-04-02T14:02:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371339",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:32'></a>It isn't fixed. I inserted a print statement in the _mul_long method of matrix_gfpn_dense, but apparently the method is not called.

By consequence, the Python int is converted to an element of the base ring and then multiplied using _lmul_. I should run some timings, but I am sure that this is slower than using _mul_long.



---

archive/issue_comments_371340.json:
```json
{
    "body": "<a id='comment:33'></a>Replying to [comment:32 SimonKing]:\n> It isn't fixed. I inserted a print statement in the _mul_long method of matrix_gfpn_dense, but apparently the method is not called.\n> \n> By consequence, the Python int is converted to an element of the base ring and then multiplied using _lmul_. I should run some timings, but I am sure that this is slower than using _mul_long.\n\n\nActually it is a lot worse than I thought:\n\n```\nsage: M = random_matrix(GF(9,'x'), 64,51)\nsage: type(M)\n<type 'sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense'>\nsage: cython(\"\"\"\n....: from sage.matrix.matrix_gfpn_dense cimport Matrix_gfpn_dense as MTX\n....: def test1(MTX M):\n....:     cdef size_t i\n....:     cdef MTX N\n....:     for i in range(100000):\n....:         N = M*i\n....: def test2(MTX M):\n....:     cdef size_t i\n....:     cdef MTX N\n....:     for i in range(100000):\n....:         N = M._mul_long(i)\n....: \"\"\")\nsage: %timeit test1(M)\n1 loop, best of 3: 11.7 s per loop\nsage: %timeit test2(M)\n1 loop, best of 3: 366 ms per loop\nsage: 11.7/0.366\n31.9672131147541\n```\nSo, the current code is almost 32 times slower than what used to happen, in a scenario that I do care about.\n\nHence, adding a doctest isn't enough.",
    "created_at": "2018-04-02T14:11:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371340",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:33'></a>Replying to [comment:32 SimonKing]:
> It isn't fixed. I inserted a print statement in the _mul_long method of matrix_gfpn_dense, but apparently the method is not called.
> 
> By consequence, the Python int is converted to an element of the base ring and then multiplied using _lmul_. I should run some timings, but I am sure that this is slower than using _mul_long.


Actually it is a lot worse than I thought:

```
sage: M = random_matrix(GF(9,'x'), 64,51)
sage: type(M)
<type 'sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense'>
sage: cython("""
....: from sage.matrix.matrix_gfpn_dense cimport Matrix_gfpn_dense as MTX
....: def test1(MTX M):
....:     cdef size_t i
....:     cdef MTX N
....:     for i in range(100000):
....:         N = M*i
....: def test2(MTX M):
....:     cdef size_t i
....:     cdef MTX N
....:     for i in range(100000):
....:         N = M._mul_long(i)
....: """)
sage: %timeit test1(M)
1 loop, best of 3: 11.7 s per loop
sage: %timeit test2(M)
1 loop, best of 3: 366 ms per loop
sage: 11.7/0.366
31.9672131147541
```
So, the current code is almost 32 times slower than what used to happen, in a scenario that I do care about.

Hence, adding a doctest isn't enough.



---

archive/issue_comments_371341.json:
```json
{
    "body": "<a id='comment:34'></a>Replying to [comment:32 SimonKing]:\n> It isn't fixed.\n\n\nI just pushed a branch fixing exactly the problem that you described and you're not happy because it doesn't also fix *another* issue? Good luck fixing it your way then.",
    "created_at": "2018-04-02T14:19:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371341",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:34'></a>Replying to [comment:32 SimonKing]:
> It isn't fixed.


I just pushed a branch fixing exactly the problem that you described and you're not happy because it doesn't also fix *another* issue? Good luck fixing it your way then.



---

archive/issue_comments_371342.json:
```json
{
    "body": "Changing keywords from \"meataxe coercion\" to \"_mul_long\".",
    "created_at": "2018-04-02T14:47:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371342",
    "user": "https://github.com/simon-king-jena"
}
```

Changing keywords from "meataxe coercion" to "_mul_long".



---

archive/issue_comments_371343.json:
```json
{
    "body": "<a id='comment:35'></a>Replying to [comment:34 jdemeyer]:\n> Replying to [comment:32 SimonKing]:\n> > It isn't fixed.\n\n> \n> I just pushed a branch fixing exactly the problem that you described and you're not happy because it doesn't also fix *another* issue? Good luck fixing it your way then.\n\n\nYour behaviour makes me speechless. Almost.\n\nThe ticket description is about using the short-cut _mul_long as a solution to the problem that Matrix*int didn't work. As it turns out #24742 allows Matrix*int, but it doesn't do it by enabling _mul_long (although _mul_long is supported in sage.structure.element).\n\nSo, given the poor performance I demonstrated, there is an issue here that goes beyond what was fixed in #24742, and it is related with what the ticket description of this ticket says.\n\nIn addition, I notice that the current implementation of _mul_long for Matrix_gfpn_dense doesn't convert an integer into `GF(p^n,'x')` by reduction modulo p, but by some conversion used by MeatAxe. For instance, 4 would be converted to the number x+1 in GF(9,'x'). I didn't notice it before since in my cohomology applications I work with matrices over prime fields, where the different conversions happen to coincide.\n\nHence, if this ticket is about to \"Fix Matrix_gfpn_dense*int\", then here one should\n1. re-enable the usage of _mul_long for matrix times int, because of the performance issue\n2. fix _mul_long of Matrix_gfpn_dense for non-prime fields.\n\nI changed the ticket description accordingly.\n\nConsequently, this ticket is by no means just a duplicate of #24742.\n\nAnd even when you insist that it is a duplicate: What would be the point of closing this ticket as a duplicate (or maybe just adding a test) and then opening yet another ticket that deals with the two remaining issues?\n\nAlternatively, I could just leave the issues alone and use ._mul_long directly in my cohomology code, to be independent of whatever implementation of coercion is currently used.",
    "created_at": "2018-04-02T14:47:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371343",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:35'></a>Replying to [comment:34 jdemeyer]:
> Replying to [comment:32 SimonKing]:
> > It isn't fixed.

> 
> I just pushed a branch fixing exactly the problem that you described and you're not happy because it doesn't also fix *another* issue? Good luck fixing it your way then.


Your behaviour makes me speechless. Almost.

The ticket description is about using the short-cut _mul_long as a solution to the problem that Matrix*int didn't work. As it turns out #24742 allows Matrix*int, but it doesn't do it by enabling _mul_long (although _mul_long is supported in sage.structure.element).

So, given the poor performance I demonstrated, there is an issue here that goes beyond what was fixed in #24742, and it is related with what the ticket description of this ticket says.

In addition, I notice that the current implementation of _mul_long for Matrix_gfpn_dense doesn't convert an integer into `GF(p^n,'x')` by reduction modulo p, but by some conversion used by MeatAxe. For instance, 4 would be converted to the number x+1 in GF(9,'x'). I didn't notice it before since in my cohomology applications I work with matrices over prime fields, where the different conversions happen to coincide.

Hence, if this ticket is about to "Fix Matrix_gfpn_dense*int", then here one should
1. re-enable the usage of _mul_long for matrix times int, because of the performance issue
2. fix _mul_long of Matrix_gfpn_dense for non-prime fields.

I changed the ticket description accordingly.

Consequently, this ticket is by no means just a duplicate of #24742.

And even when you insist that it is a duplicate: What would be the point of closing this ticket as a duplicate (or maybe just adding a test) and then opening yet another ticket that deals with the two remaining issues?

Alternatively, I could just leave the issues alone and use ._mul_long directly in my cohomology code, to be independent of whatever implementation of coercion is currently used.



---

archive/issue_comments_371344.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,171 @@\n+The following previous bug was fixed by #24742:\n+\n+```\n+sage: M = matrix(GF(9,'x'), 2,3)\n+sage: type(M)\n+<type 'sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense'>\n+sage: M*1\n+[0 0 0]\n+[0 0 0]\n+sage: M*int(1)\n+---------------------------------------------------------------------------\n+ValueError                                Traceback (most recent call last)\n+<ipython-input-3-1a2faedb318b> in <module>()\n+----> 1 M*int(Integer(1))\n+\n+/home/king/Sage/git/sage/src/sage/structure/element.pyx in sage.structure.element.Matrix.__mul__ (build/cythonized/sage/structure/element.c:23460)()\n+   3671         if have_same_parent(left, right):\n+   3672             return (<Matrix>left)._matrix_times_matrix_(<Matrix>right)\n+-> 3673         return coercion_model.bin_op(left, right, mul)\n+   3674 \n+   3675     def __truediv__(left, right):\n+\n+/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.bin_op (build/cythonized/sage/structure/coerce.c:9671)()\n+   1111             if xp is yp:\n+   1112                 return op(x,y)\n+-> 1113             action = self.get_action(xp, yp, op, x, y)\n+   1114             if action is not None:\n+   1115                 return (<Action>action)._call_(x, y)\n+\n+/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.get_action (build/cythonized/sage/structure/coerce.c:16889)()\n+   1654         except KeyError:\n+   1655             pass\n+-> 1656         action = self.discover_action(R, S, op, r, s)\n+   1657         action = self.verify_action(action, R, S, op)\n+   1658         self._action_maps.set(R, S, op, action)\n+\n+/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.discover_action (build/cythonized/sage/structure/coerce.c:18411)()\n+   1804 \n+   1805         if isinstance(R, Parent):\n+-> 1806             action = (<Parent>R).get_action(S, op, True, r, s)\n+   1807             if action is not None:\n+   1808                 return action\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.get_action (build/cythonized/sage/structure/parent.c:21664)()\n+   2493         action = self._get_action_(S, op, self_on_left)\n+   2494         if action is None:\n+-> 2495             action = self.discover_action(S, op, self_on_left, self_el, S_el)\n+   2496 \n+   2497         if action is not None:\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.discover_action (build/cythonized/sage/structure/parent.c:23017)()\n+   2604                     return action\n+   2605 \n+-> 2606                 if parent_is_integers(S) and not self.has_coerce_map_from(S):\n+   2607                     from sage.structure.coerce_actions import IntegerMulAction\n+   2608                     try:\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.has_coerce_map_from (build/cythonized/sage/structure/parent.c:17925)()\n+   2022                 print(\"Warning: non-unique parents %s\" % (type(S)))\n+   2023             return True\n+-> 2024         return self._internal_coerce_map_from(S) is not None\n+   2025 \n+   2026     cpdef _coerce_map_from_(self, S):\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent._internal_coerce_map_from (build/cythonized/sage/structure/parent.c:18944)()\n+   2164         try:\n+   2165             _register_pair(self, S, \"coerce\")\n+-> 2166             mor = self.discover_coerce_map_from(S)\n+   2167             #if mor is not None:\n+   2168             #    # Need to check that this morphism doesn't connect previously unconnected parts of the coercion diagram\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.discover_coerce_map_from (build/cythonized/sage/structure/parent.c:19396)()\n+   2301                 return (<Parent>S)._embedding\n+   2302 \n+-> 2303         user_provided_mor = self._coerce_map_from_(S)\n+   2304 \n+   2305         if user_provided_mor is None or user_provided_mor is False:\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent._coerce_map_from_ (build/cythonized/sage/structure/parent_old.c:7549)()\n+    339     cpdef _coerce_map_from_(self, S):\n+    340         if self._element_constructor is None:\n+--> 341             return self.coerce_map_from_c(S)\n+    342         else:\n+    343             return parent.Parent._coerce_map_from_(self, S)\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.coerce_map_from_c (build/cythonized/sage/structure/parent_old.c:4044)()\n+    157                 self._coerce_from_hash[S] = None\n+    158                 return None\n+--> 159             mor = self.coerce_map_from_c(sage_type)\n+    160             if mor is not None:\n+    161                 mor = mor * sage_type._internal_coerce_map_from(S)\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.coerce_map_from_c (build/cythonized/sage/structure/parent_old.c:3768)()\n+    141             pass\n+    142 \n+--> 143         mor = self.coerce_map_from_c_impl(S)\n+    144         import sage.categories.morphism\n+    145         import sage.categories.map\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.coerce_map_from_c_impl (build/cythonized/sage/structure/parent_old.c:4710)()\n+    189         # Piggyback off the old code for now\n+    190         # WARNING: when working on this, make sure circular dependencies aren't introduced!\n+--> 191         if self.has_coerce_map_from_c(S):\n+    192             if isinstance(S, type):\n+    193                 S = Set_PythonType(S)\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.has_coerce_map_from_c (build/cythonized/sage/structure/parent_old.c:6312)()\n+    275             except KeyError:\n+    276                 pass\n+--> 277         x = self.has_coerce_map_from_c_impl(S)\n+    278         self._has_coerce_map_from.set(S, x)\n+    279         return x\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.has_coerce_map_from_c_impl (build/cythonized/sage/structure/parent_old.c:6489)()\n+    284             return False\n+    285         try:\n+--> 286             self._coerce_c((<parent.Parent>S).an_element())\n+    287         except TypeError:\n+    288             return False\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent._coerce_c (build/cythonized/sage/structure/parent_old.c:5382)()\n+    217             pass\n+    218         if HAS_DICTIONARY(self):\n+--> 219             return self._coerce_impl(x)\n+    220         else:\n+    221             return self._coerce_c_impl(x)\n+\n+/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in _coerce_impl(self, x)\n+   1100             and self.base_ring().has_coerce_map_from(x.base_ring())):\n+   1101             return self(x)\n+-> 1102         return self._coerce_try(x, self.base_ring())\n+   1103 \n+   1104     def _repr_(self):\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent._coerce_try (build/cythonized/sage/structure/parent_old.c:5902)()\n+    255             try:\n+    256                 y = R._coerce_(x)\n+--> 257                 return self(y)\n+    258             except (TypeError, AttributeError) as msg:\n+    259                 pass\n+\n+/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in __call__(self, entries, coerce, copy, sparse)\n+    873             [t]\n+    874         \"\"\"\n+--> 875         return self.matrix(entries, coerce, copy)\n+    876 \n+    877     def change_ring(self, R):\n+\n+/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in matrix(self, x, coerce, copy)\n+   1886                 x = list_to_dict(x, m, n)\n+   1887                 copy = False\n+-> 1888         return MC(self, x, copy=copy, coerce=coerce)\n+   1889 \n+   1890     def matrix_space(self, nrows=None, ncols=None, sparse=False):\n+\n+/home/king/Sage/git/sage/src/sage/matrix/matrix_gfpn_dense.pyx in sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense.__init__ (build/cythonized/sage/matrix/matrix_gfpn_dense.c:5278)()\n+    423                 return\n+    424             if self._nrows != self._ncols:\n+--> 425                 raise ValueError(\"Cannot initialise non-square matrix from {}\".format(data))\n+    426             f = FfFromInt(self._converter.field_to_int(self._coerce_element(data)))\n+    427             x = self.Data.Data\n+\n+ValueError: Cannot initialise non-square matrix from 1\n+```\n+\n+What #24742 doesn't fix:\n+1. Multiplication of a matrix with a scalar that is given as an integer doesn't use _mul_long() should be used, which is supported by sage.structure.element but isn't used anywhere in sage.matrix except in sage.matrix.matrix_gfpn_dense.\n+2. The _mul_long implementation of Matrix_gfpn_dense is flawed, as it *should* do a coercion of the given integer into the underlying base ring (which is by computing the remainder modulo the modulus of the base ring), but currently uses a different way of conversion.\n \n \n Comment: 1\n``````\n",
    "created_at": "2018-04-02T14:47:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371344",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,171 @@
+The following previous bug was fixed by #24742:
+
+```
+sage: M = matrix(GF(9,'x'), 2,3)
+sage: type(M)
+<type 'sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense'>
+sage: M*1
+[0 0 0]
+[0 0 0]
+sage: M*int(1)
+---------------------------------------------------------------------------
+ValueError                                Traceback (most recent call last)
+<ipython-input-3-1a2faedb318b> in <module>()
+----> 1 M*int(Integer(1))
+
+/home/king/Sage/git/sage/src/sage/structure/element.pyx in sage.structure.element.Matrix.__mul__ (build/cythonized/sage/structure/element.c:23460)()
+   3671         if have_same_parent(left, right):
+   3672             return (<Matrix>left)._matrix_times_matrix_(<Matrix>right)
+-> 3673         return coercion_model.bin_op(left, right, mul)
+   3674 
+   3675     def __truediv__(left, right):
+
+/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.bin_op (build/cythonized/sage/structure/coerce.c:9671)()
+   1111             if xp is yp:
+   1112                 return op(x,y)
+-> 1113             action = self.get_action(xp, yp, op, x, y)
+   1114             if action is not None:
+   1115                 return (<Action>action)._call_(x, y)
+
+/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.get_action (build/cythonized/sage/structure/coerce.c:16889)()
+   1654         except KeyError:
+   1655             pass
+-> 1656         action = self.discover_action(R, S, op, r, s)
+   1657         action = self.verify_action(action, R, S, op)
+   1658         self._action_maps.set(R, S, op, action)
+
+/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.discover_action (build/cythonized/sage/structure/coerce.c:18411)()
+   1804 
+   1805         if isinstance(R, Parent):
+-> 1806             action = (<Parent>R).get_action(S, op, True, r, s)
+   1807             if action is not None:
+   1808                 return action
+
+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.get_action (build/cythonized/sage/structure/parent.c:21664)()
+   2493         action = self._get_action_(S, op, self_on_left)
+   2494         if action is None:
+-> 2495             action = self.discover_action(S, op, self_on_left, self_el, S_el)
+   2496 
+   2497         if action is not None:
+
+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.discover_action (build/cythonized/sage/structure/parent.c:23017)()
+   2604                     return action
+   2605 
+-> 2606                 if parent_is_integers(S) and not self.has_coerce_map_from(S):
+   2607                     from sage.structure.coerce_actions import IntegerMulAction
+   2608                     try:
+
+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.has_coerce_map_from (build/cythonized/sage/structure/parent.c:17925)()
+   2022                 print("Warning: non-unique parents %s" % (type(S)))
+   2023             return True
+-> 2024         return self._internal_coerce_map_from(S) is not None
+   2025 
+   2026     cpdef _coerce_map_from_(self, S):
+
+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent._internal_coerce_map_from (build/cythonized/sage/structure/parent.c:18944)()
+   2164         try:
+   2165             _register_pair(self, S, "coerce")
+-> 2166             mor = self.discover_coerce_map_from(S)
+   2167             #if mor is not None:
+   2168             #    # Need to check that this morphism doesn't connect previously unconnected parts of the coercion diagram
+
+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.discover_coerce_map_from (build/cythonized/sage/structure/parent.c:19396)()
+   2301                 return (<Parent>S)._embedding
+   2302 
+-> 2303         user_provided_mor = self._coerce_map_from_(S)
+   2304 
+   2305         if user_provided_mor is None or user_provided_mor is False:
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent._coerce_map_from_ (build/cythonized/sage/structure/parent_old.c:7549)()
+    339     cpdef _coerce_map_from_(self, S):
+    340         if self._element_constructor is None:
+--> 341             return self.coerce_map_from_c(S)
+    342         else:
+    343             return parent.Parent._coerce_map_from_(self, S)
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.coerce_map_from_c (build/cythonized/sage/structure/parent_old.c:4044)()
+    157                 self._coerce_from_hash[S] = None
+    158                 return None
+--> 159             mor = self.coerce_map_from_c(sage_type)
+    160             if mor is not None:
+    161                 mor = mor * sage_type._internal_coerce_map_from(S)
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.coerce_map_from_c (build/cythonized/sage/structure/parent_old.c:3768)()
+    141             pass
+    142 
+--> 143         mor = self.coerce_map_from_c_impl(S)
+    144         import sage.categories.morphism
+    145         import sage.categories.map
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.coerce_map_from_c_impl (build/cythonized/sage/structure/parent_old.c:4710)()
+    189         # Piggyback off the old code for now
+    190         # WARNING: when working on this, make sure circular dependencies aren't introduced!
+--> 191         if self.has_coerce_map_from_c(S):
+    192             if isinstance(S, type):
+    193                 S = Set_PythonType(S)
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.has_coerce_map_from_c (build/cythonized/sage/structure/parent_old.c:6312)()
+    275             except KeyError:
+    276                 pass
+--> 277         x = self.has_coerce_map_from_c_impl(S)
+    278         self._has_coerce_map_from.set(S, x)
+    279         return x
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.has_coerce_map_from_c_impl (build/cythonized/sage/structure/parent_old.c:6489)()
+    284             return False
+    285         try:
+--> 286             self._coerce_c((<parent.Parent>S).an_element())
+    287         except TypeError:
+    288             return False
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent._coerce_c (build/cythonized/sage/structure/parent_old.c:5382)()
+    217             pass
+    218         if HAS_DICTIONARY(self):
+--> 219             return self._coerce_impl(x)
+    220         else:
+    221             return self._coerce_c_impl(x)
+
+/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in _coerce_impl(self, x)
+   1100             and self.base_ring().has_coerce_map_from(x.base_ring())):
+   1101             return self(x)
+-> 1102         return self._coerce_try(x, self.base_ring())
+   1103 
+   1104     def _repr_(self):
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent._coerce_try (build/cythonized/sage/structure/parent_old.c:5902)()
+    255             try:
+    256                 y = R._coerce_(x)
+--> 257                 return self(y)
+    258             except (TypeError, AttributeError) as msg:
+    259                 pass
+
+/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in __call__(self, entries, coerce, copy, sparse)
+    873             [t]
+    874         """
+--> 875         return self.matrix(entries, coerce, copy)
+    876 
+    877     def change_ring(self, R):
+
+/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in matrix(self, x, coerce, copy)
+   1886                 x = list_to_dict(x, m, n)
+   1887                 copy = False
+-> 1888         return MC(self, x, copy=copy, coerce=coerce)
+   1889 
+   1890     def matrix_space(self, nrows=None, ncols=None, sparse=False):
+
+/home/king/Sage/git/sage/src/sage/matrix/matrix_gfpn_dense.pyx in sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense.__init__ (build/cythonized/sage/matrix/matrix_gfpn_dense.c:5278)()
+    423                 return
+    424             if self._nrows != self._ncols:
+--> 425                 raise ValueError("Cannot initialise non-square matrix from {}".format(data))
+    426             f = FfFromInt(self._converter.field_to_int(self._coerce_element(data)))
+    427             x = self.Data.Data
+
+ValueError: Cannot initialise non-square matrix from 1
+```
+
+What #24742 doesn't fix:
+1. Multiplication of a matrix with a scalar that is given as an integer doesn't use _mul_long() should be used, which is supported by sage.structure.element but isn't used anywhere in sage.matrix except in sage.matrix.matrix_gfpn_dense.
+2. The _mul_long implementation of Matrix_gfpn_dense is flawed, as it *should* do a coercion of the given integer into the underlying base ring (which is by computing the remainder modulo the modulus of the base ring), but currently uses a different way of conversion.
 
 
 Comment: 1
``````




---

archive/issue_comments_371345.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,171 @@\n+The following previous bug was fixed by #24742:\n+\n+```\n+sage: M = matrix(GF(9,'x'), 2,3)\n+sage: type(M)\n+<type 'sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense'>\n+sage: M*1\n+[0 0 0]\n+[0 0 0]\n+sage: M*int(1)\n+---------------------------------------------------------------------------\n+ValueError                                Traceback (most recent call last)\n+<ipython-input-3-1a2faedb318b> in <module>()\n+----> 1 M*int(Integer(1))\n+\n+/home/king/Sage/git/sage/src/sage/structure/element.pyx in sage.structure.element.Matrix.__mul__ (build/cythonized/sage/structure/element.c:23460)()\n+   3671         if have_same_parent(left, right):\n+   3672             return (<Matrix>left)._matrix_times_matrix_(<Matrix>right)\n+-> 3673         return coercion_model.bin_op(left, right, mul)\n+   3674 \n+   3675     def __truediv__(left, right):\n+\n+/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.bin_op (build/cythonized/sage/structure/coerce.c:9671)()\n+   1111             if xp is yp:\n+   1112                 return op(x,y)\n+-> 1113             action = self.get_action(xp, yp, op, x, y)\n+   1114             if action is not None:\n+   1115                 return (<Action>action)._call_(x, y)\n+\n+/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.get_action (build/cythonized/sage/structure/coerce.c:16889)()\n+   1654         except KeyError:\n+   1655             pass\n+-> 1656         action = self.discover_action(R, S, op, r, s)\n+   1657         action = self.verify_action(action, R, S, op)\n+   1658         self._action_maps.set(R, S, op, action)\n+\n+/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.discover_action (build/cythonized/sage/structure/coerce.c:18411)()\n+   1804 \n+   1805         if isinstance(R, Parent):\n+-> 1806             action = (<Parent>R).get_action(S, op, True, r, s)\n+   1807             if action is not None:\n+   1808                 return action\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.get_action (build/cythonized/sage/structure/parent.c:21664)()\n+   2493         action = self._get_action_(S, op, self_on_left)\n+   2494         if action is None:\n+-> 2495             action = self.discover_action(S, op, self_on_left, self_el, S_el)\n+   2496 \n+   2497         if action is not None:\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.discover_action (build/cythonized/sage/structure/parent.c:23017)()\n+   2604                     return action\n+   2605 \n+-> 2606                 if parent_is_integers(S) and not self.has_coerce_map_from(S):\n+   2607                     from sage.structure.coerce_actions import IntegerMulAction\n+   2608                     try:\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.has_coerce_map_from (build/cythonized/sage/structure/parent.c:17925)()\n+   2022                 print(\"Warning: non-unique parents %s\" % (type(S)))\n+   2023             return True\n+-> 2024         return self._internal_coerce_map_from(S) is not None\n+   2025 \n+   2026     cpdef _coerce_map_from_(self, S):\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent._internal_coerce_map_from (build/cythonized/sage/structure/parent.c:18944)()\n+   2164         try:\n+   2165             _register_pair(self, S, \"coerce\")\n+-> 2166             mor = self.discover_coerce_map_from(S)\n+   2167             #if mor is not None:\n+   2168             #    # Need to check that this morphism doesn't connect previously unconnected parts of the coercion diagram\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.discover_coerce_map_from (build/cythonized/sage/structure/parent.c:19396)()\n+   2301                 return (<Parent>S)._embedding\n+   2302 \n+-> 2303         user_provided_mor = self._coerce_map_from_(S)\n+   2304 \n+   2305         if user_provided_mor is None or user_provided_mor is False:\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent._coerce_map_from_ (build/cythonized/sage/structure/parent_old.c:7549)()\n+    339     cpdef _coerce_map_from_(self, S):\n+    340         if self._element_constructor is None:\n+--> 341             return self.coerce_map_from_c(S)\n+    342         else:\n+    343             return parent.Parent._coerce_map_from_(self, S)\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.coerce_map_from_c (build/cythonized/sage/structure/parent_old.c:4044)()\n+    157                 self._coerce_from_hash[S] = None\n+    158                 return None\n+--> 159             mor = self.coerce_map_from_c(sage_type)\n+    160             if mor is not None:\n+    161                 mor = mor * sage_type._internal_coerce_map_from(S)\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.coerce_map_from_c (build/cythonized/sage/structure/parent_old.c:3768)()\n+    141             pass\n+    142 \n+--> 143         mor = self.coerce_map_from_c_impl(S)\n+    144         import sage.categories.morphism\n+    145         import sage.categories.map\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.coerce_map_from_c_impl (build/cythonized/sage/structure/parent_old.c:4710)()\n+    189         # Piggyback off the old code for now\n+    190         # WARNING: when working on this, make sure circular dependencies aren't introduced!\n+--> 191         if self.has_coerce_map_from_c(S):\n+    192             if isinstance(S, type):\n+    193                 S = Set_PythonType(S)\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.has_coerce_map_from_c (build/cythonized/sage/structure/parent_old.c:6312)()\n+    275             except KeyError:\n+    276                 pass\n+--> 277         x = self.has_coerce_map_from_c_impl(S)\n+    278         self._has_coerce_map_from.set(S, x)\n+    279         return x\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.has_coerce_map_from_c_impl (build/cythonized/sage/structure/parent_old.c:6489)()\n+    284             return False\n+    285         try:\n+--> 286             self._coerce_c((<parent.Parent>S).an_element())\n+    287         except TypeError:\n+    288             return False\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent._coerce_c (build/cythonized/sage/structure/parent_old.c:5382)()\n+    217             pass\n+    218         if HAS_DICTIONARY(self):\n+--> 219             return self._coerce_impl(x)\n+    220         else:\n+    221             return self._coerce_c_impl(x)\n+\n+/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in _coerce_impl(self, x)\n+   1100             and self.base_ring().has_coerce_map_from(x.base_ring())):\n+   1101             return self(x)\n+-> 1102         return self._coerce_try(x, self.base_ring())\n+   1103 \n+   1104     def _repr_(self):\n+\n+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent._coerce_try (build/cythonized/sage/structure/parent_old.c:5902)()\n+    255             try:\n+    256                 y = R._coerce_(x)\n+--> 257                 return self(y)\n+    258             except (TypeError, AttributeError) as msg:\n+    259                 pass\n+\n+/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in __call__(self, entries, coerce, copy, sparse)\n+    873             [t]\n+    874         \"\"\"\n+--> 875         return self.matrix(entries, coerce, copy)\n+    876 \n+    877     def change_ring(self, R):\n+\n+/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in matrix(self, x, coerce, copy)\n+   1886                 x = list_to_dict(x, m, n)\n+   1887                 copy = False\n+-> 1888         return MC(self, x, copy=copy, coerce=coerce)\n+   1889 \n+   1890     def matrix_space(self, nrows=None, ncols=None, sparse=False):\n+\n+/home/king/Sage/git/sage/src/sage/matrix/matrix_gfpn_dense.pyx in sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense.__init__ (build/cythonized/sage/matrix/matrix_gfpn_dense.c:5278)()\n+    423                 return\n+    424             if self._nrows != self._ncols:\n+--> 425                 raise ValueError(\"Cannot initialise non-square matrix from {}\".format(data))\n+    426             f = FfFromInt(self._converter.field_to_int(self._coerce_element(data)))\n+    427             x = self.Data.Data\n+\n+ValueError: Cannot initialise non-square matrix from 1\n+```\n+\n+What #24742 doesn't fix:\n+1. Multiplication of a matrix with a scalar that is given as a Python int fails to use _mul_long(), which is supported by sage.structure.element but isn't used anywhere in sage.matrix except in sage.matrix.matrix_gfpn_dense.\n+2. The _mul_long implementation of Matrix_gfpn_dense is flawed, as it *should* do a coercion of the given integer into the underlying base ring (which is by computing the remainder modulo the modulus of the base ring), but currently uses a different way of conversion.\n \n \n Comment: 1\n``````\n",
    "created_at": "2018-04-02T14:55:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371345",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,171 @@
+The following previous bug was fixed by #24742:
+
+```
+sage: M = matrix(GF(9,'x'), 2,3)
+sage: type(M)
+<type 'sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense'>
+sage: M*1
+[0 0 0]
+[0 0 0]
+sage: M*int(1)
+---------------------------------------------------------------------------
+ValueError                                Traceback (most recent call last)
+<ipython-input-3-1a2faedb318b> in <module>()
+----> 1 M*int(Integer(1))
+
+/home/king/Sage/git/sage/src/sage/structure/element.pyx in sage.structure.element.Matrix.__mul__ (build/cythonized/sage/structure/element.c:23460)()
+   3671         if have_same_parent(left, right):
+   3672             return (<Matrix>left)._matrix_times_matrix_(<Matrix>right)
+-> 3673         return coercion_model.bin_op(left, right, mul)
+   3674 
+   3675     def __truediv__(left, right):
+
+/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.bin_op (build/cythonized/sage/structure/coerce.c:9671)()
+   1111             if xp is yp:
+   1112                 return op(x,y)
+-> 1113             action = self.get_action(xp, yp, op, x, y)
+   1114             if action is not None:
+   1115                 return (<Action>action)._call_(x, y)
+
+/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.get_action (build/cythonized/sage/structure/coerce.c:16889)()
+   1654         except KeyError:
+   1655             pass
+-> 1656         action = self.discover_action(R, S, op, r, s)
+   1657         action = self.verify_action(action, R, S, op)
+   1658         self._action_maps.set(R, S, op, action)
+
+/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.discover_action (build/cythonized/sage/structure/coerce.c:18411)()
+   1804 
+   1805         if isinstance(R, Parent):
+-> 1806             action = (<Parent>R).get_action(S, op, True, r, s)
+   1807             if action is not None:
+   1808                 return action
+
+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.get_action (build/cythonized/sage/structure/parent.c:21664)()
+   2493         action = self._get_action_(S, op, self_on_left)
+   2494         if action is None:
+-> 2495             action = self.discover_action(S, op, self_on_left, self_el, S_el)
+   2496 
+   2497         if action is not None:
+
+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.discover_action (build/cythonized/sage/structure/parent.c:23017)()
+   2604                     return action
+   2605 
+-> 2606                 if parent_is_integers(S) and not self.has_coerce_map_from(S):
+   2607                     from sage.structure.coerce_actions import IntegerMulAction
+   2608                     try:
+
+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.has_coerce_map_from (build/cythonized/sage/structure/parent.c:17925)()
+   2022                 print("Warning: non-unique parents %s" % (type(S)))
+   2023             return True
+-> 2024         return self._internal_coerce_map_from(S) is not None
+   2025 
+   2026     cpdef _coerce_map_from_(self, S):
+
+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent._internal_coerce_map_from (build/cythonized/sage/structure/parent.c:18944)()
+   2164         try:
+   2165             _register_pair(self, S, "coerce")
+-> 2166             mor = self.discover_coerce_map_from(S)
+   2167             #if mor is not None:
+   2168             #    # Need to check that this morphism doesn't connect previously unconnected parts of the coercion diagram
+
+/home/king/Sage/git/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.discover_coerce_map_from (build/cythonized/sage/structure/parent.c:19396)()
+   2301                 return (<Parent>S)._embedding
+   2302 
+-> 2303         user_provided_mor = self._coerce_map_from_(S)
+   2304 
+   2305         if user_provided_mor is None or user_provided_mor is False:
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent._coerce_map_from_ (build/cythonized/sage/structure/parent_old.c:7549)()
+    339     cpdef _coerce_map_from_(self, S):
+    340         if self._element_constructor is None:
+--> 341             return self.coerce_map_from_c(S)
+    342         else:
+    343             return parent.Parent._coerce_map_from_(self, S)
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.coerce_map_from_c (build/cythonized/sage/structure/parent_old.c:4044)()
+    157                 self._coerce_from_hash[S] = None
+    158                 return None
+--> 159             mor = self.coerce_map_from_c(sage_type)
+    160             if mor is not None:
+    161                 mor = mor * sage_type._internal_coerce_map_from(S)
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.coerce_map_from_c (build/cythonized/sage/structure/parent_old.c:3768)()
+    141             pass
+    142 
+--> 143         mor = self.coerce_map_from_c_impl(S)
+    144         import sage.categories.morphism
+    145         import sage.categories.map
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.coerce_map_from_c_impl (build/cythonized/sage/structure/parent_old.c:4710)()
+    189         # Piggyback off the old code for now
+    190         # WARNING: when working on this, make sure circular dependencies aren't introduced!
+--> 191         if self.has_coerce_map_from_c(S):
+    192             if isinstance(S, type):
+    193                 S = Set_PythonType(S)
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.has_coerce_map_from_c (build/cythonized/sage/structure/parent_old.c:6312)()
+    275             except KeyError:
+    276                 pass
+--> 277         x = self.has_coerce_map_from_c_impl(S)
+    278         self._has_coerce_map_from.set(S, x)
+    279         return x
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent.has_coerce_map_from_c_impl (build/cythonized/sage/structure/parent_old.c:6489)()
+    284             return False
+    285         try:
+--> 286             self._coerce_c((<parent.Parent>S).an_element())
+    287         except TypeError:
+    288             return False
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent._coerce_c (build/cythonized/sage/structure/parent_old.c:5382)()
+    217             pass
+    218         if HAS_DICTIONARY(self):
+--> 219             return self._coerce_impl(x)
+    220         else:
+    221             return self._coerce_c_impl(x)
+
+/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in _coerce_impl(self, x)
+   1100             and self.base_ring().has_coerce_map_from(x.base_ring())):
+   1101             return self(x)
+-> 1102         return self._coerce_try(x, self.base_ring())
+   1103 
+   1104     def _repr_(self):
+
+/home/king/Sage/git/sage/src/sage/structure/parent_old.pyx in sage.structure.parent_old.Parent._coerce_try (build/cythonized/sage/structure/parent_old.c:5902)()
+    255             try:
+    256                 y = R._coerce_(x)
+--> 257                 return self(y)
+    258             except (TypeError, AttributeError) as msg:
+    259                 pass
+
+/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in __call__(self, entries, coerce, copy, sparse)
+    873             [t]
+    874         """
+--> 875         return self.matrix(entries, coerce, copy)
+    876 
+    877     def change_ring(self, R):
+
+/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.pyc in matrix(self, x, coerce, copy)
+   1886                 x = list_to_dict(x, m, n)
+   1887                 copy = False
+-> 1888         return MC(self, x, copy=copy, coerce=coerce)
+   1889 
+   1890     def matrix_space(self, nrows=None, ncols=None, sparse=False):
+
+/home/king/Sage/git/sage/src/sage/matrix/matrix_gfpn_dense.pyx in sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense.__init__ (build/cythonized/sage/matrix/matrix_gfpn_dense.c:5278)()
+    423                 return
+    424             if self._nrows != self._ncols:
+--> 425                 raise ValueError("Cannot initialise non-square matrix from {}".format(data))
+    426             f = FfFromInt(self._converter.field_to_int(self._coerce_element(data)))
+    427             x = self.Data.Data
+
+ValueError: Cannot initialise non-square matrix from 1
+```
+
+What #24742 doesn't fix:
+1. Multiplication of a matrix with a scalar that is given as a Python int fails to use _mul_long(), which is supported by sage.structure.element but isn't used anywhere in sage.matrix except in sage.matrix.matrix_gfpn_dense.
+2. The _mul_long implementation of Matrix_gfpn_dense is flawed, as it *should* do a coercion of the given integer into the underlying base ring (which is by computing the remainder modulo the modulus of the base ring), but currently uses a different way of conversion.
 
 
 Comment: 1
``````




---

archive/issue_comments_371346.json:
```json
{
    "body": "<a id='comment:37'></a>Replying to [comment:35 SimonKing]:\n> What would be the point of closing this ticket as a duplicate (or maybe just adding a test) and then opening yet another ticket that deals with the two remaining issues?\n\n\n1. It fixes the issue that `Matrix * int` didn't work.\n\n2. It adds a doctest to show that 1. will remain fixed.",
    "created_at": "2018-04-02T15:00:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371346",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:37'></a>Replying to [comment:35 SimonKing]:
> What would be the point of closing this ticket as a duplicate (or maybe just adding a test) and then opening yet another ticket that deals with the two remaining issues?


1. It fixes the issue that `Matrix * int` didn't work.

2. It adds a doctest to show that 1. will remain fixed.



---

archive/issue_comments_371347.json:
```json
{
    "body": "<a id='comment:38'></a>Replying to [comment:37 jdemeyer]:\n> Replying to [comment:35 SimonKing]:\n> > What would be the point of closing this ticket as a duplicate (or maybe just adding a test) and then opening yet another ticket that deals with the two remaining issues?\n\n> \n> 1. It fixes the issue that `Matrix * int` didn't work.\n> \n> 2. It adds a doctest to show that 1. will remain fixed.\n\n\nIssue 1 is fixed in the dependency and moreover these are not the only issues related with the original ticket description. And what would be the point of opening yet another ticket when the remaining issue can be dealt with here?\n\nIt is, by the way, not without precedence that a ticket description was changed because of issues that came up while working on the original ticket description.",
    "created_at": "2018-04-02T15:03:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371347",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:38'></a>Replying to [comment:37 jdemeyer]:
> Replying to [comment:35 SimonKing]:
> > What would be the point of closing this ticket as a duplicate (or maybe just adding a test) and then opening yet another ticket that deals with the two remaining issues?

> 
> 1. It fixes the issue that `Matrix * int` didn't work.
> 
> 2. It adds a doctest to show that 1. will remain fixed.


Issue 1 is fixed in the dependency and moreover these are not the only issues related with the original ticket description. And what would be the point of opening yet another ticket when the remaining issue can be dealt with here?

It is, by the way, not without precedence that a ticket description was changed because of issues that came up while working on the original ticket description.



---

archive/issue_comments_371348.json:
```json
{
    "body": "<a id='comment:39'></a>Replying to [comment:38 SimonKing]:\n> And what would be the point of opening yet another ticket when the remaining issue can be dealt with here?\n\n\nBecause this ticket already does something useful.\n\nTo turn your question around: what would be the point of **not** opening yet another ticket given that there are really two issues here (one about coercing scalars to the base ring and one about using `_mul_long`)?",
    "created_at": "2018-04-02T15:07:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371348",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:39'></a>Replying to [comment:38 SimonKing]:
> And what would be the point of opening yet another ticket when the remaining issue can be dealt with here?


Because this ticket already does something useful.

To turn your question around: what would be the point of **not** opening yet another ticket given that there are really two issues here (one about coercing scalars to the base ring and one about using `_mul_long`)?



---

archive/issue_comments_371349.json:
```json
{
    "body": "Changing keywords from \"_mul_long\" to \"\".",
    "created_at": "2018-04-02T15:15:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371349",
    "user": "https://github.com/simon-king-jena"
}
```

Changing keywords from "_mul_long" to "".



---

archive/issue_comments_371350.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,18 @@\n+The following previous bug was fixed by #24742:\n \n+```\n+sage: M = matrix(GF(9,'x'), 2,3)\n+sage: type(M)\n+<type 'sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense'>\n+sage: M*1\n+[0 0 0]\n+[0 0 0]\n+sage: M*int(1)\n+...\n+ValueError: Cannot initialise non-square matrix from 1\n+```\n+\n+This ticket adds a test that makes sure that the issue remains fixed.\n \n Comment: 1\n \n``````\n",
    "created_at": "2018-04-02T15:15:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371350",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,18 @@
+The following previous bug was fixed by #24742:
 
+```
+sage: M = matrix(GF(9,'x'), 2,3)
+sage: type(M)
+<type 'sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense'>
+sage: M*1
+[0 0 0]
+[0 0 0]
+sage: M*int(1)
+...
+ValueError: Cannot initialise non-square matrix from 1
+```
+
+This ticket adds a test that makes sure that the issue remains fixed.
 
 Comment: 1
 
``````




---

archive/issue_comments_371351.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-04-02T15:15:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371351",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_371352.json:
```json
{
    "body": "<a id='comment:41'></a>OK, just adding a test here, and then opening another ticket for the two remaining issues (that do belong together).\n\n---\nNew commits:",
    "created_at": "2018-04-02T15:15:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371352",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:41'></a>OK, just adding a test here, and then opening another ticket for the two remaining issues (that do belong together).

---
New commits:



---

archive/issue_comments_371353.json:
```json
{
    "body": "<a id='comment:42'></a>Note that I constructed the test in such a way that blindly using the current implementation of _mul_long would give the wrong result, which means it also makes sure that the follow-up ticket will use the right conversion.",
    "created_at": "2018-04-02T15:16:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371353",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:42'></a>Note that I constructed the test in such a way that blindly using the current implementation of _mul_long would give the wrong result, which means it also makes sure that the follow-up ticket will use the right conversion.



---

archive/issue_comments_371354.json:
```json
{
    "body": "<a id='comment:43'></a>Replying to [comment:41 SimonKing]:\n> opening another ticket for the two remaining issues (that do belong together).\n\n\nThose still look like different issues to me. One is about the coercion model and one is about the meataxe interface.",
    "created_at": "2018-04-02T15:21:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371354",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:43'></a>Replying to [comment:41 SimonKing]:
> opening another ticket for the two remaining issues (that do belong together).


Those still look like different issues to me. One is about the coercion model and one is about the meataxe interface.



---

archive/issue_comments_371355.json:
```json
{
    "body": "<a id='comment:44'></a>Replying to [comment:42 SimonKing]:\n> Note that I constructed the test in such a way that blindly using the current implementation of _mul_long would give the wrong result, which means it also makes sure that the follow-up ticket will use the right conversion.\n\n\nSee #25079",
    "created_at": "2018-04-02T15:21:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371355",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:44'></a>Replying to [comment:42 SimonKing]:
> Note that I constructed the test in such a way that blindly using the current implementation of _mul_long would give the wrong result, which means it also makes sure that the follow-up ticket will use the right conversion.


See #25079



---

archive/issue_comments_371356.json:
```json
{
    "body": "<a id='comment:45'></a>I think it would be good to refer to this ticket instead of #24742 and to add a test for `int * Matrix` too.",
    "created_at": "2018-04-02T15:22:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371356",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:45'></a>I think it would be good to refer to this ticket instead of #24742 and to add a test for `int * Matrix` too.



---

archive/issue_comments_371357.json:
```json
{
    "body": "<a id='comment:46'></a>Replying to [comment:43 jdemeyer]:\n> Replying to [comment:41 SimonKing]:\n> > opening another ticket for the two remaining issues (that do belong together).\n\n> \n> Those still look like different issues to me. One is about the coercion model and one is about the meataxe interface.\n\n\nYes, they are two different issues, but it is totally natural to deal with them on a single ticket: When one only fixes the coercion model, one would actually *introduce* a bug (namely: The flawed _mul_long of Matrix_gfpn_dense would be used). When one only fixes the meataxe interface, one wouldn't be able to demonstrate that it is fixed without using cython in doctests.\n\nYes, using cython in doctests is possible, but why should one, if the existing test \"M*int(4)==M\" is good enough?",
    "created_at": "2018-04-02T15:25:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371357",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:46'></a>Replying to [comment:43 jdemeyer]:
> Replying to [comment:41 SimonKing]:
> > opening another ticket for the two remaining issues (that do belong together).

> 
> Those still look like different issues to me. One is about the coercion model and one is about the meataxe interface.


Yes, they are two different issues, but it is totally natural to deal with them on a single ticket: When one only fixes the coercion model, one would actually *introduce* a bug (namely: The flawed _mul_long of Matrix_gfpn_dense would be used). When one only fixes the meataxe interface, one wouldn't be able to demonstrate that it is fixed without using cython in doctests.

Yes, using cython in doctests is possible, but why should one, if the existing test "M*int(4)==M" is good enough?



---

archive/issue_comments_371358.json:
```json
{
    "body": "<a id='comment:47'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-04-02T15:26:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371358",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:47'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_371359.json:
```json
{
    "body": "<a id='comment:48'></a>Replying to [comment:45 jdemeyer]:\n> I think it would be good to refer to this ticket instead of #24742 and to add a test for `int * Matrix` too.\n\n\nDone.",
    "created_at": "2018-04-02T15:27:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371359",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:48'></a>Replying to [comment:45 jdemeyer]:
> I think it would be good to refer to this ticket instead of #24742 and to add a test for `int * Matrix` too.


Done.



---

archive/issue_comments_371360.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-04-05T08:58:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371360",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_371361.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-05-09T09:49:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25076#issuecomment-371361",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_062894.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-05-09T09:49:44Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/25076",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25076#event-62894"
}
```
