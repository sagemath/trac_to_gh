# Issue 25921: aborted tests on macOS 10.13.6

archive/issues_025684.json:
```json
{
    "body": "With 8.3rc2, testing of sage.doctest.external and sage.combinat.designs.ext_rep fail with similar messages. \n\nFrom googling, I found this comment which  https://github.com/ansible/ansible/issues/34056#issuecomment-352862252 but I do not have the knowledge to tell whether this is the same issue. Excerpts from output below; full logs attached.\n\n```\nsage -t --long src/sage/doctest/external.py\nRunning doctests with ID 2018-07-24-23-58-33-c07cfdbe.\nGit branch: develop\nUsing --optional=mpir,python2,sage\nDoctesting 1 file.\nsage -t --long --warn-long 183.2 src/sage/doctest/external.py\n    Killed due to abort\n**********************************************************************\nTests run before process (pid=69718) failed:\n\n[ snip ]\n\nsage: sage.doctest.external._lookup('internet') # random ## line 302 ##\nobjc[69718]: +[__NSPlaceholderDate initialize] may have been in progress in another thread when fork() was called.\nobjc[69718]: +[__NSPlaceholderDate initialize] may have been in progress in another thread when fork() was called. We cannot safely call it or ignore it in the fork() child process. Crashing instead. Set a breakpoint on objc_initializeAfterForkError to debug.\n------------------------------------------------------------------------\n0   signals.so                          0x000000010e5956e8 print_backtrace + 40\n1   ???                                 0x6974757469747362 0x0 + 7598827614126764898\n------------------------------------------------------------------------\nUnhandled SIGABRT: An abort() occurred.\nThis probably occurred because a *compiled* module has a bug\nin it and is not properly wrapped with sig_on(), sig_off().\nPython will now terminate.\n------------------------------------------------------------------------\n\n**********************************************************************\n----------------------------------------------------------------------\nsage -t --long --warn-long 183.2 src/sage/doctest/external.py  # Killed due to abort\n----------------------------------------------------------------------\nTotal time for all tests: 1.6 seconds\n    cpu time: 0.0 seconds\n    cumulative wall time: 0.0 seconds\n```\n\n```\nsage -t --long src/sage/combinat/designs/ext_rep.py\nRunning doctests with ID 2018-07-24-23-58-47-07be9643.\nGit branch: develop\nUsing --optional=mpir,python2,sage\nDoctesting 1 file.\nsage -t --long --warn-long 183.2 src/sage/combinat/designs/ext_rep.py\n    Killed due to abort\n**********************************************************************\nTests run before process (pid=69771) failed:\n\n[ snip ]\n\nsage: from sage.combinat.designs import ext_rep ## line 549 ##\nsage: file_loc = ext_rep.dump_to_tmpfile(ext_rep.v2_b2_k2_icgsa) ## line 550 ##\nsage: proc = ext_rep.XTreeProcessor() ## line 551 ##\nsage: s = ext_rep.open_extrep_url(\"file://\" + file_loc) ## line 552 ##\nobjc[69771]: +[__NSPlaceholderDate initialize] may have been in progress in another thread when fork() was called.\nobjc[69771]: +[__NSPlaceholderDate initialize] may have been in progress in another thread when fork() was called. We cannot safely call it or ignore it in the fork() child process. Crashing instead. Set a breakpoint on objc_initializeAfterForkError to debug.\n------------------------------------------------------------------------\n0   signals.so                          0x0000000107ab66e8 print_backtrace + 40\n1   ???                                 0x6974757469747362 0x0 + 7598827614126764898\n------------------------------------------------------------------------\nUnhandled SIGABRT: An abort() occurred.\nThis probably occurred because a *compiled* module has a bug\nin it and is not properly wrapped with sig_on(), sig_off().\nPython will now terminate.\n------------------------------------------------------------------------\n\n**********************************************************************\n----------------------------------------------------------------------\nsage -t --long --warn-long 183.2 src/sage/combinat/designs/ext_rep.py  # Killed due to abort\n----------------------------------------------------------------------\nTotal time for all tests: 0.9 seconds\n    cpu time: 0.0 seconds\n    cumulative wall time: 0.0 seconds\n```\n\nBranch/Commit: 688a288e16663fe2c4a881baa510ed797a46efa1\n\nReviewer: John Palmieri\n\nAuthor: Jeroen Demeyer\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/25921\n\n",
    "closed_at": "2018-12-23T23:41:06Z",
    "created_at": "2018-07-24T23:37:10Z",
    "labels": [
        "component: interfaces: optional",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.6",
    "title": "aborted tests on macOS 10.13.6",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25921",
    "user": "https://github.com/bryangingechen"
}
```
With 8.3rc2, testing of sage.doctest.external and sage.combinat.designs.ext_rep fail with similar messages. 

From googling, I found this comment which  https://github.com/ansible/ansible/issues/34056#issuecomment-352862252 but I do not have the knowledge to tell whether this is the same issue. Excerpts from output below; full logs attached.

```
sage -t --long src/sage/doctest/external.py
Running doctests with ID 2018-07-24-23-58-33-c07cfdbe.
Git branch: develop
Using --optional=mpir,python2,sage
Doctesting 1 file.
sage -t --long --warn-long 183.2 src/sage/doctest/external.py
    Killed due to abort
**********************************************************************
Tests run before process (pid=69718) failed:

[ snip ]

sage: sage.doctest.external._lookup('internet') # random ## line 302 ##
objc[69718]: +[__NSPlaceholderDate initialize] may have been in progress in another thread when fork() was called.
objc[69718]: +[__NSPlaceholderDate initialize] may have been in progress in another thread when fork() was called. We cannot safely call it or ignore it in the fork() child process. Crashing instead. Set a breakpoint on objc_initializeAfterForkError to debug.
------------------------------------------------------------------------
0   signals.so                          0x000000010e5956e8 print_backtrace + 40
1   ???                                 0x6974757469747362 0x0 + 7598827614126764898
------------------------------------------------------------------------
Unhandled SIGABRT: An abort() occurred.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
------------------------------------------------------------------------

**********************************************************************
----------------------------------------------------------------------
sage -t --long --warn-long 183.2 src/sage/doctest/external.py  # Killed due to abort
----------------------------------------------------------------------
Total time for all tests: 1.6 seconds
    cpu time: 0.0 seconds
    cumulative wall time: 0.0 seconds
```

```
sage -t --long src/sage/combinat/designs/ext_rep.py
Running doctests with ID 2018-07-24-23-58-47-07be9643.
Git branch: develop
Using --optional=mpir,python2,sage
Doctesting 1 file.
sage -t --long --warn-long 183.2 src/sage/combinat/designs/ext_rep.py
    Killed due to abort
**********************************************************************
Tests run before process (pid=69771) failed:

[ snip ]

sage: from sage.combinat.designs import ext_rep ## line 549 ##
sage: file_loc = ext_rep.dump_to_tmpfile(ext_rep.v2_b2_k2_icgsa) ## line 550 ##
sage: proc = ext_rep.XTreeProcessor() ## line 551 ##
sage: s = ext_rep.open_extrep_url("file://" + file_loc) ## line 552 ##
objc[69771]: +[__NSPlaceholderDate initialize] may have been in progress in another thread when fork() was called.
objc[69771]: +[__NSPlaceholderDate initialize] may have been in progress in another thread when fork() was called. We cannot safely call it or ignore it in the fork() child process. Crashing instead. Set a breakpoint on objc_initializeAfterForkError to debug.
------------------------------------------------------------------------
0   signals.so                          0x0000000107ab66e8 print_backtrace + 40
1   ???                                 0x6974757469747362 0x0 + 7598827614126764898
------------------------------------------------------------------------
Unhandled SIGABRT: An abort() occurred.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
------------------------------------------------------------------------

**********************************************************************
----------------------------------------------------------------------
sage -t --long --warn-long 183.2 src/sage/combinat/designs/ext_rep.py  # Killed due to abort
----------------------------------------------------------------------
Total time for all tests: 0.9 seconds
    cpu time: 0.0 seconds
    cumulative wall time: 0.0 seconds
```

Branch/Commit: 688a288e16663fe2c4a881baa510ed797a46efa1

Reviewer: John Palmieri

Author: Jeroen Demeyer

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/25921





---

archive/issue_comments_497773.json:
```json
{
    "body": "Attachment [crash_sage.doctest.external.log](tarball://root/attachments/some-uuid/ticket25921/crash_sage.doctest.external.log) by @bryangingechen created at 2018-07-24 23:37:31",
    "created_at": "2018-07-24T23:37:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497773",
    "user": "https://github.com/bryangingechen"
}
```

Attachment [crash_sage.doctest.external.log](tarball://root/attachments/some-uuid/ticket25921/crash_sage.doctest.external.log) by @bryangingechen created at 2018-07-24 23:37:31



---

archive/issue_comments_497774.json:
```json
{
    "body": "<a id='comment:1'></a>I think this was caused by #25092. See [comment 11](https://trac.sagemath.org/ticket/25092#comment:11) there. Setting the environment variable `OBJC_DISABLE_INITIALIZE_FORK_SAFETY` to `YES` works for me \u2013\u00a0that is, if I do this before running doctests, I don't get these failures.",
    "created_at": "2018-07-25T00:11:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497774",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:1'></a>I think this was caused by #25092. See [comment 11](https://trac.sagemath.org/ticket/25092#comment:11) there. Setting the environment variable `OBJC_DISABLE_INITIALIZE_FORK_SAFETY` to `YES` works for me – that is, if I do this before running doctests, I don't get these failures.



---

archive/issue_comments_497775.json:
```json
{
    "body": "<a id='comment:2'></a>Oh, also see https://groups.google.com/d/msg/sage-release/pU08gXEhpYU/3i5rlcj5CAAJ and the ensuing discussion.",
    "created_at": "2018-07-25T00:12:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497775",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:2'></a>Oh, also see https://groups.google.com/d/msg/sage-release/pU08gXEhpYU/3i5rlcj5CAAJ and the ensuing discussion.



---

archive/issue_comments_497776.json:
```json
{
    "body": "<a id='comment:3'></a>Thanks! I missed those comments when I searched. I can confirm that setting the environment variable fixes these tests. Should I close this ticket as a duplicate then?",
    "created_at": "2018-07-25T00:22:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497776",
    "user": "https://github.com/bryangingechen"
}
```

<a id='comment:3'></a>Thanks! I missed those comments when I searched. I can confirm that setting the environment variable fixes these tests. Should I close this ticket as a duplicate then?



---

archive/issue_comments_497777.json:
```json
{
    "body": "<a id='comment:4'></a>Well, is setting an environment variable a good enough solution? I don't know what the underlying problem is, and whether it's worth pursuing, so I think we should keep this open to see if anyone can make any progress on it.",
    "created_at": "2018-07-25T01:35:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497777",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:4'></a>Well, is setting an environment variable a good enough solution? I don't know what the underlying problem is, and whether it's worth pursuing, so I think we should keep this open to see if anyone can make any progress on it.



---

archive/issue_comments_497778.json:
```json
{
    "body": "<a id='comment:5'></a>There is also an open issue about this in Python: https://bugs.python.org/issue33725",
    "created_at": "2018-07-26T13:23:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497778",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'></a>There is also an open issue about this in Python: https://bugs.python.org/issue33725



---

archive/issue_comments_497779.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [jhpalmieri](#comment%3A4):\n> I don't know what the underlying problem is\n\n\nI'd love to read a good explanation. All over the web you'll find different partial explanations about the problem and what the environment variable does but never with a lot of technical detail.\n\nFor example, there is talk about \"multi-threaded applications\" but what **exactly** is a multi-threaded application?",
    "created_at": "2018-07-26T13:37:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497779",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>Replying to [jhpalmieri](#comment%3A4):
> I don't know what the underlying problem is


I'd love to read a good explanation. All over the web you'll find different partial explanations about the problem and what the environment variable does but never with a lot of technical detail.

For example, there is talk about "multi-threaded applications" but what **exactly** is a multi-threaded application?



---

archive/issue_comments_497780.json:
```json
{
    "body": "<a id='comment:7'></a>I think the talk about \"multi-threaded applications\" is perhaps mostly a red-herring.\n\nThe issue is that Objective-C runtime functions are not allowed to be called between the `fork()` and `exec()` in a child process--if you do the runtime calls `abort()`.  The `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` environment variable disables this, but then you really better be sure that you've registered a pre-fork handler (e.g. with `pthread_atfork`) that ensures the C runtime is in a safe state (e.g. no locks are held, etc.) since it won't guarantee this on its own.",
    "created_at": "2018-07-26T13:52:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497780",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>I think the talk about "multi-threaded applications" is perhaps mostly a red-herring.

The issue is that Objective-C runtime functions are not allowed to be called between the `fork()` and `exec()` in a child process--if you do the runtime calls `abort()`.  The `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` environment variable disables this, but then you really better be sure that you've registered a pre-fork handler (e.g. with `pthread_atfork`) that ensures the C runtime is in a safe state (e.g. no locks are held, etc.) since it won't guarantee this on its own.



---

archive/issue_comments_497781.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [embray](#comment%3A7):\n> I think the talk about \"multi-threaded applications\" is perhaps mostly a red-herring.\n> \n> The issue is that Objective-C runtime functions are not allowed to be called between the `fork()` and `exec()` in a child process\n\n\nSo they basically broke `fork()`?",
    "created_at": "2018-07-26T14:34:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497781",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>Replying to [embray](#comment%3A7):
> I think the talk about "multi-threaded applications" is perhaps mostly a red-herring.
> 
> The issue is that Objective-C runtime functions are not allowed to be called between the `fork()` and `exec()` in a child process


So they basically broke `fork()`?



---

archive/issue_comments_497782.json:
```json
{
    "body": "<a id='comment:9'></a>That's basically my understanding, though upon rereading the linked article, it does pertain to multi-threaded applications insofar as this is *only* a problem when forking from a multi-threaded process.  If there's just a single process I think it doesn't matter.\n\nIt may not be entirely wrong:\n\n> A process shall be created with a single thread. If a multi-threaded process calls fork(), the new process shall contain a replica of the calling thread and its entire address space, possibly including the states of mutexes and other resources. Consequently, to avoid errors, the child process may only execute async-signal-safe operations until such time as one of the exec functions is called. [THR] [Option Start]  Fork handlers may be established by means of the pthread_atfork() function in order to maintain application invariants across fork() calls.\n\n\nIf the runtime itself can't guarantee that \"the child process [will] only execute async-signal-safe operations until such time as one of the exec functions is called\" then it's safer for it to blow up immediately than maybe work, or maybe result in even harder to debug errors.\n\nI'm not saying it doesn't suck, but it seems to make some sense...",
    "created_at": "2018-07-26T15:00:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497782",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>That's basically my understanding, though upon rereading the linked article, it does pertain to multi-threaded applications insofar as this is *only* a problem when forking from a multi-threaded process.  If there's just a single process I think it doesn't matter.

It may not be entirely wrong:

> A process shall be created with a single thread. If a multi-threaded process calls fork(), the new process shall contain a replica of the calling thread and its entire address space, possibly including the states of mutexes and other resources. Consequently, to avoid errors, the child process may only execute async-signal-safe operations until such time as one of the exec functions is called. [THR] [Option Start]  Fork handlers may be established by means of the pthread_atfork() function in order to maintain application invariants across fork() calls.


If the runtime itself can't guarantee that "the child process [will] only execute async-signal-safe operations until such time as one of the exec functions is called" then it's safer for it to blow up immediately than maybe work, or maybe result in even harder to debug errors.

I'm not saying it doesn't suck, but it seems to make some sense...



---

archive/issue_comments_497783.json:
```json
{
    "body": "<a id='comment:10'></a>To put another way, because Objective-C doesn't have an equivalent of a GIL, forking a multi-threaded application is dangerous and tricky, because rather than make sure that their library actually ensures it's in a sane state before forking, the Apple developers seem to have thrown their hands up and made it everyone else's problem (glibc sometimes has bugs like this as well, but actually tries to fix them...)",
    "created_at": "2018-07-26T15:09:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497783",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'></a>To put another way, because Objective-C doesn't have an equivalent of a GIL, forking a multi-threaded application is dangerous and tricky, because rather than make sure that their library actually ensures it's in a sane state before forking, the Apple developers seem to have thrown their hands up and made it everyone else's problem (glibc sometimes has bugs like this as well, but actually tries to fix them...)



---

archive/issue_comments_497784.json:
```json
{
    "body": "<a id='comment:11'></a>I'd still like to know under exactly which circumstances the objc error occurs (and none of the articles I saw answers that question).",
    "created_at": "2018-07-26T15:28:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497784",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>I'd still like to know under exactly which circumstances the objc error occurs (and none of the articles I saw answers that question).



---

archive/issue_comments_497785.json:
```json
{
    "body": "<a id='comment:12'></a>When I first saw this, I thought that I had traced it to #25092. Can you deduce anything from that? (What changed in cysignals 1.7.0 that could have led to this?) Is there anything I can do to provide more information about Sage's situation in particular, since my computers give me these errors?",
    "created_at": "2018-07-26T15:39:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497785",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:12'></a>When I first saw this, I thought that I had traced it to #25092. Can you deduce anything from that? (What changed in cysignals 1.7.0 that could have led to this?) Is there anything I can do to provide more information about Sage's situation in particular, since my computers give me these errors?



---

archive/issue_comments_497786.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [jdemeyer](#comment%3A11):\n> I'd still like to know under exactly which circumstances the objc error occurs (and none of the articles I saw answers that question).\n\n\nI think the reason for that is that there are probably too many to list, and it's impossible to say exactly since it's all closed source.",
    "created_at": "2018-07-26T15:46:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497786",
    "user": "https://github.com/embray"
}
```

<a id='comment:13'></a>Replying to [jdemeyer](#comment%3A11):
> I'd still like to know under exactly which circumstances the objc error occurs (and none of the articles I saw answers that question).


I think the reason for that is that there are probably too many to list, and it's impossible to say exactly since it's all closed source.



---

archive/issue_comments_497787.json:
```json
{
    "body": "<a id='comment:14'></a>In these examples it's happening because something calls `__NSPlaceholderDate.initialize` whatever that is.  So we'd want to go into GDB and find out why that's being called, because it seems to be a common thread (no pun intended) in this specific case.",
    "created_at": "2018-07-26T15:47:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497787",
    "user": "https://github.com/embray"
}
```

<a id='comment:14'></a>In these examples it's happening because something calls `__NSPlaceholderDate.initialize` whatever that is.  So we'd want to go into GDB and find out why that's being called, because it seems to be a common thread (no pun intended) in this specific case.



---

archive/issue_comments_497788.json:
```json
{
    "body": "<a id='comment:15'></a>Looks like it probably stems from somewhere in `urlopen`.\n\nIs it only these tests that fail?",
    "created_at": "2018-07-26T15:55:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497788",
    "user": "https://github.com/embray"
}
```

<a id='comment:15'></a>Looks like it probably stems from somewhere in `urlopen`.

Is it only these tests that fail?



---

archive/issue_comments_497789.json:
```json
{
    "body": "<a id='comment:16'></a>Yes, only these.",
    "created_at": "2018-07-26T16:16:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497789",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:16'></a>Yes, only these.



---

archive/issue_comments_497790.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [embray](#comment%3A13):\n> I think the reason for that is that there are probably too many to list, and it's impossible to say exactly since it's all closed source.\n\n\nYes and that's really bad. How can we fix a problem if nobody is able to say exactly what the problem is?",
    "created_at": "2018-07-26T17:35:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497790",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>Replying to [embray](#comment%3A13):
> I think the reason for that is that there are probably too many to list, and it's impossible to say exactly since it's all closed source.


Yes and that's really bad. How can we fix a problem if nobody is able to say exactly what the problem is?



---

archive/issue_comments_497791.json:
```json
{
    "body": "<a id='comment:18'></a>If setting `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` fixes this, then we at least have an easy workaround.\n\nShould we do that (at least as a temporary solution) in Sage 8.3?",
    "created_at": "2018-07-26T17:40:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497791",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>If setting `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` fixes this, then we at least have an easy workaround.

Should we do that (at least as a temporary solution) in Sage 8.3?



---

archive/issue_comments_497792.json:
```json
{
    "body": "<a id='comment:19'></a>Replying to [jdemeyer](#comment%3A18):\n> If setting `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` fixes this, then we at least have an easy workaround.\n\n\nThis only needs to be done when running doctests, by the way. I can't get the same commands to fail when run in Sage interactively.",
    "created_at": "2018-07-26T17:54:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497792",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:19'></a>Replying to [jdemeyer](#comment%3A18):
> If setting `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` fixes this, then we at least have an easy workaround.


This only needs to be done when running doctests, by the way. I can't get the same commands to fail when run in Sage interactively.



---

archive/issue_comments_497793.json:
```json
{
    "body": "<a id='comment:20'></a>From this point of view, we could just change the doctests:\n\n```diff\ndiff --git a/src/sage/doctest/external.py b/src/sage/doctest/external.py\nindex 9cbc42b178..de0b0e1e2f 100644\n--- a/src/sage/doctest/external.py\n+++ b/src/sage/doctest/external.py\n@@ -299,7 +299,7 @@ def _lookup(software):\n     \n     EXAMPLES::\n \n-        sage: sage.doctest.external._lookup('internet') # random\n+        sage: sage.doctest.external._lookup('latex') # random\n         True\n     \"\"\"\n     if software in external_software:\n@@ -332,9 +332,9 @@ class AvailableSoftware(object):\n          'octave',\n          'pandoc',\n          'scilab']\n-        sage: 'internet' in available_software # random\n+        sage: 'latex' in available_software # random\n         True\n-        sage: available_software.issuperset(set(['internet','latex'])) # random\n+        sage: available_software.issuperset(set(['maple','latex'])) # random\n         True\n     \"\"\"\n     def __init__(self):\n@@ -360,7 +360,7 @@ class AvailableSoftware(object):\n         EXAMPLES::\n \n             sage: from sage.doctest.external import available_software\n-            sage: 'internet' in available_software # random\n+            sage: 'macaulay2' in available_software # random\n             True\n         \"\"\"\n         try:\n@@ -386,7 +386,7 @@ class AvailableSoftware(object):\n         EXAMPLES::\n \n             sage: from sage.doctest.external import available_software\n-            sage: available_software.issuperset(set(['internet','latex','magma'])) # random\n+            sage: available_software.issuperset(set(['gurobi','latex','magma'])) # random\n             True\n         \"\"\"\n         for item in other:\n```\nTreating the symptom rather than the disease, but if this only manifests itself in doctests, maybe that's okay.",
    "created_at": "2018-07-26T17:56:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497793",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:20'></a>From this point of view, we could just change the doctests:

```diff
diff --git a/src/sage/doctest/external.py b/src/sage/doctest/external.py
index 9cbc42b178..de0b0e1e2f 100644
--- a/src/sage/doctest/external.py
+++ b/src/sage/doctest/external.py
@@ -299,7 +299,7 @@ def _lookup(software):
     
     EXAMPLES::
 
-        sage: sage.doctest.external._lookup('internet') # random
+        sage: sage.doctest.external._lookup('latex') # random
         True
     """
     if software in external_software:
@@ -332,9 +332,9 @@ class AvailableSoftware(object):
          'octave',
          'pandoc',
          'scilab']
-        sage: 'internet' in available_software # random
+        sage: 'latex' in available_software # random
         True
-        sage: available_software.issuperset(set(['internet','latex'])) # random
+        sage: available_software.issuperset(set(['maple','latex'])) # random
         True
     """
     def __init__(self):
@@ -360,7 +360,7 @@ class AvailableSoftware(object):
         EXAMPLES::
 
             sage: from sage.doctest.external import available_software
-            sage: 'internet' in available_software # random
+            sage: 'macaulay2' in available_software # random
             True
         """
         try:
@@ -386,7 +386,7 @@ class AvailableSoftware(object):
         EXAMPLES::
 
             sage: from sage.doctest.external import available_software
-            sage: available_software.issuperset(set(['internet','latex','magma'])) # random
+            sage: available_software.issuperset(set(['gurobi','latex','magma'])) # random
             True
         """
         for item in other:
```
Treating the symptom rather than the disease, but if this only manifests itself in doctests, maybe that's okay.



---

archive/issue_comments_497794.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [jhpalmieri](#comment%3A19):\n> I can't get the same commands to fail when run in Sage interactively.\n\n\nWell, it seems that you need to `fork()` which would be the case when using `multiprocessing` for example.",
    "created_at": "2018-07-26T18:08:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497794",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'></a>Replying to [jhpalmieri](#comment%3A19):
> I can't get the same commands to fail when run in Sage interactively.


Well, it seems that you need to `fork()` which would be the case when using `multiprocessing` for example.



---

archive/issue_comments_497795.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [jhpalmieri](#comment%3A20):\n> From this point of view, we could just change the doctests:\n\n\nI'm -1 to this. As far as I know, there is nothing wrong with those doctests, so why should we change them?",
    "created_at": "2018-07-26T18:09:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497795",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'></a>Replying to [jhpalmieri](#comment%3A20):
> From this point of view, we could just change the doctests:


I'm -1 to this. As far as I know, there is nothing wrong with those doctests, so why should we change them?



---

archive/issue_comments_497796.json:
```json
{
    "body": "<a id='comment:23'></a>Replying to [jdemeyer](#comment%3A21):\n> Replying to [jhpalmieri](#comment%3A19):\n> > I can't get the same commands to fail when run in Sage interactively.\n\n> \n> Well, it seems that you need to `fork()` which would be the case when using `multiprocessing` for example.\n\n\nIn combination with `urlopen`, as embray points out.\n\nReplying to [jdemeyer](#comment%3A22):\n> Replying to [jhpalmieri](#comment%3A20):\n> > From this point of view, we could just change the doctests:\n\n> \n> I'm -1 to this. As far as I know, there is nothing wrong with those doctests, so why should we change them?\n\n\nIf someone can figure out a way to fix what's wrong, that's great. On the other hand, I don't think they test anything particularly compelling, since the same commands work fine interactively. So if it turns out to be easy to fix, I am happy to fix it, but if it is complicated, perhaps we could spend our efforts fixing more important things. Or maybe I'm underestimating somehow the importance of these failures.\n\nPut another way, how is changing the doctests different, qualitatively, from doing `export OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` before running doctests? Both bypass the problem without solving it.",
    "created_at": "2018-07-26T18:16:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497796",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:23'></a>Replying to [jdemeyer](#comment%3A21):
> Replying to [jhpalmieri](#comment%3A19):
> > I can't get the same commands to fail when run in Sage interactively.

> 
> Well, it seems that you need to `fork()` which would be the case when using `multiprocessing` for example.


In combination with `urlopen`, as embray points out.

Replying to [jdemeyer](#comment%3A22):
> Replying to [jhpalmieri](#comment%3A20):
> > From this point of view, we could just change the doctests:

> 
> I'm -1 to this. As far as I know, there is nothing wrong with those doctests, so why should we change them?


If someone can figure out a way to fix what's wrong, that's great. On the other hand, I don't think they test anything particularly compelling, since the same commands work fine interactively. So if it turns out to be easy to fix, I am happy to fix it, but if it is complicated, perhaps we could spend our efforts fixing more important things. Or maybe I'm underestimating somehow the importance of these failures.

Put another way, how is changing the doctests different, qualitatively, from doing `export OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` before running doctests? Both bypass the problem without solving it.



---

archive/issue_comments_497797.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [jhpalmieri](#comment%3A23):\n> Put another way, how is changing the doctests different, qualitatively, from doing `export OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` before running doctests? Both bypass the problem without solving it.\n\n\nYour proposal only works around those specific doctest failures. There could easily be tests added in the future with the same problem. And I believe that the problem can also occur interactively when using `multiprocessing`.\n\nNote that I didn't mean to set `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` only before running doctests, I meant doing that always (in `sage-env` for example). So that should work around all cases of the problem, not just the one specific test failure.",
    "created_at": "2018-07-26T18:26:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497797",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'></a>Replying to [jhpalmieri](#comment%3A23):
> Put another way, how is changing the doctests different, qualitatively, from doing `export OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` before running doctests? Both bypass the problem without solving it.


Your proposal only works around those specific doctest failures. There could easily be tests added in the future with the same problem. And I believe that the problem can also occur interactively when using `multiprocessing`.

Note that I didn't mean to set `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` only before running doctests, I meant doing that always (in `sage-env` for example). So that should work around all cases of the problem, not just the one specific test failure.



---

archive/issue_comments_497798.json:
```json
{
    "body": "<a id='comment:25'></a>Okay, I can see that. Are there dangers to setting `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` always? (It would be good for me to know, since I am currently setting this in my .bashrc file to avoid these doctest failures.)",
    "created_at": "2018-07-26T18:57:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497798",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:25'></a>Okay, I can see that. Are there dangers to setting `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` always? (It would be good for me to know, since I am currently setting this in my .bashrc file to avoid these doctest failures.)



---

archive/issue_comments_497799.json:
```json
{
    "body": "<a id='comment:26'></a>Thanks for following up on this everyone.\n\nReplying to [jhpalmieri](#comment%3A25):\n> Okay, I can see that. Are there dangers to setting `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` always? (It would be good for me to know, since I am currently setting this in my .bashrc file to avoid these doctest failures.)\n\n\nI just wanted to point out that according to your previous commentticket: ticket:25092#comment:20#comment:25092 `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES` is required (note the caps).",
    "created_at": "2018-07-26T19:48:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497799",
    "user": "https://github.com/bryangingechen"
}
```

<a id='comment:26'></a>Thanks for following up on this everyone.

Replying to [jhpalmieri](#comment%3A25):
> Okay, I can see that. Are there dangers to setting `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` always? (It would be good for me to know, since I am currently setting this in my .bashrc file to avoid these doctest failures.)


I just wanted to point out that according to your previous commentticket: ticket:25092#comment:20#comment:25092 `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES` is required (note the caps).



---

archive/issue_comments_497800.json:
```json
{
    "body": "<a id='comment:27'></a>Replying to [gh-bryangingechen](#comment%3A26):\n> Thanks for following up on this everyone.\n> \n> Replying to [jhpalmieri](#comment%3A25):\n> > Okay, I can see that. Are there dangers to setting `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` always? (It would be good for me to know, since I am currently setting this in my .bashrc file to avoid these doctest failures.)\n\n> \n> I just wanted to point out that according to your previous commentticket: ticket:25092#comment:20#comment:25092 `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES` is required (note the caps).\n\n\nYes, you're right, it has to be `YES`, not `yes`.",
    "created_at": "2018-07-26T20:53:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497800",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:27'></a>Replying to [gh-bryangingechen](#comment%3A26):
> Thanks for following up on this everyone.
> 
> Replying to [jhpalmieri](#comment%3A25):
> > Okay, I can see that. Are there dangers to setting `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` always? (It would be good for me to know, since I am currently setting this in my .bashrc file to avoid these doctest failures.)

> 
> I just wanted to point out that according to your previous commentticket: ticket:25092#comment:20#comment:25092 `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES` is required (note the caps).


Yes, you're right, it has to be `YES`, not `yes`.



---

archive/issue_comments_497801.json:
```json
{
    "body": "<a id='comment:28'></a>Replying to [jhpalmieri](#comment%3A25):\n> Okay, I can see that. Are there dangers to setting `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` always?\n\n\n\"dangers\" in which sense? It's removing a safety check, so it could be considered a bad idea. On the other hand, my impression is that this safety check is not very good so maybe it deserves to be disabled.\n\nOne remaining question to be answered: should we do this in Sage 8.3? My feeling says yes, because other people using the same OS X version might be affected by it.",
    "created_at": "2018-07-26T22:17:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497801",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:28'></a>Replying to [jhpalmieri](#comment%3A25):
> Okay, I can see that. Are there dangers to setting `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` always?


"dangers" in which sense? It's removing a safety check, so it could be considered a bad idea. On the other hand, my impression is that this safety check is not very good so maybe it deserves to be disabled.

One remaining question to be answered: should we do this in Sage 8.3? My feeling says yes, because other people using the same OS X version might be affected by it.



---

archive/issue_comments_497802.json:
```json
{
    "body": "<a id='comment:29'></a>Replying to [jdemeyer](#comment%3A28):\n> Replying to [jhpalmieri](#comment%3A25):\n> > Okay, I can see that. Are there dangers to setting `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` always?\n\n> \n> \"dangers\" in which sense? It's removing a safety check, so it could be considered a bad idea. On the other hand, my impression is that this safety check is not very good so maybe it deserves to be disabled.\n> \n> One remaining question to be answered: should we do this in Sage 8.3? My feeling says yes, because other people using the same OS X version might be affected by it.\n\n\nI wouldn't, in general.  Maybe just for running the test suite at the most, but even then it's iffy.\n\nI'll investigate a bit more what's going on with urlopen.  Perhaps there are some pre-fork or post-fork cleanups we can do to mitigate that specific case.  I might need to get my hands on a machine with OSX 10.13, but not necessarily either...",
    "created_at": "2018-07-27T12:03:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497802",
    "user": "https://github.com/embray"
}
```

<a id='comment:29'></a>Replying to [jdemeyer](#comment%3A28):
> Replying to [jhpalmieri](#comment%3A25):
> > Okay, I can see that. Are there dangers to setting `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` always?

> 
> "dangers" in which sense? It's removing a safety check, so it could be considered a bad idea. On the other hand, my impression is that this safety check is not very good so maybe it deserves to be disabled.
> 
> One remaining question to be answered: should we do this in Sage 8.3? My feeling says yes, because other people using the same OS X version might be affected by it.


I wouldn't, in general.  Maybe just for running the test suite at the most, but even then it's iffy.

I'll investigate a bit more what's going on with urlopen.  Perhaps there are some pre-fork or post-fork cleanups we can do to mitigate that specific case.  I might need to get my hands on a machine with OSX 10.13, but not necessarily either...



---

archive/issue_comments_497803.json:
```json
{
    "body": "<a id='comment:30'></a>Replying to [embray](#comment%3A29):\n> just for running the test suite\n\n\nIn general, I am against testsuite-specific fixes. So I think that this is the worst possible option.\n\n> I'll investigate a bit more what's going on with urlopen. Perhaps there are some pre-fork or post-fork cleanups we can do to mitigate that specific case.\n\n\nI wonder how you'll do that without information from Apple. It reminds me how annoying closed-source software is.",
    "created_at": "2018-07-27T14:10:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497803",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:30'></a>Replying to [embray](#comment%3A29):
> just for running the test suite


In general, I am against testsuite-specific fixes. So I think that this is the worst possible option.

> I'll investigate a bit more what's going on with urlopen. Perhaps there are some pre-fork or post-fork cleanups we can do to mitigate that specific case.


I wonder how you'll do that without information from Apple. It reminds me how annoying closed-source software is.



---

archive/issue_comments_497804.json:
```json
{
    "body": "<a id='comment:31'></a>> I wonder how you'll do that without information from Apple. It reminds me how annoying closed-source software is.\n\n\nI don't know, we'll see.  It would not be my first time reverse engineering Apple code.  You do know what my old job was right...",
    "created_at": "2018-07-27T14:36:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497804",
    "user": "https://github.com/embray"
}
```

<a id='comment:31'></a>> I wonder how you'll do that without information from Apple. It reminds me how annoying closed-source software is.


I don't know, we'll see.  It would not be my first time reverse engineering Apple code.  You do know what my old job was right...



---

archive/issue_comments_497805.json:
```json
{
    "body": "<a id='comment:32'></a>ping? We are still seeing reports of people saying that they need to set `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES`. I recall my suggestion to set that (always and unconditionally) in `sage-env`.\n\nBut before doing that, I'd like some advice from the OS X experts.",
    "created_at": "2018-12-19T10:21:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497805",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:32'></a>ping? We are still seeing reports of people saying that they need to set `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES`. I recall my suggestion to set that (always and unconditionally) in `sage-env`.

But before doing that, I'd like some advice from the OS X experts.



---

archive/issue_comments_497806.json:
```json
{
    "body": "<a id='comment:33'></a>Seems like the thing to do, unfortunately.  Should probably also set it in `sage.env`.  I wonder what the status is of dealing with this issue in Python itself.",
    "created_at": "2018-12-19T12:54:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497806",
    "user": "https://github.com/embray"
}
```

<a id='comment:33'></a>Seems like the thing to do, unfortunately.  Should probably also set it in `sage.env`.  I wonder what the status is of dealing with this issue in Python itself.



---

archive/issue_comments_497807.json:
```json
{
    "body": "<a id='comment:34'></a>Replying to [embray](#comment%3A33):\n> I wonder what the status is of dealing with this issue in Python itself.\n\n\nThey recently merged a PR to disable a failing test: https://github.com/python/cpython/pull/11043\n\nApart from that, nothing seems to be happening in CPython.",
    "created_at": "2018-12-19T13:03:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497807",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:34'></a>Replying to [embray](#comment%3A33):
> I wonder what the status is of dealing with this issue in Python itself.


They recently merged a PR to disable a failing test: https://github.com/python/cpython/pull/11043

Apart from that, nothing seems to be happening in CPython.



---

archive/issue_comments_497808.json:
```json
{
    "body": "<a id='comment:35'></a>What bothers me is that the error message from Apple `may have been in progress in another thread when fork() was called` is in most cases a false positive.\n\nThe way I understand things (I certainly may be wrong), that error message protects against a crash that may happen if one thread of an application is calling `fork()` while another thread is executing objective-C code. Those are very precise conditions which are highly unlikely to occur in Sage (and probably Python in general): multi-threading is used in Sage, but only in low-level C libraries which wouldn't run objective-C code. Moreover, I don't think we are ever running multiple threads of Python code (typically, the C code creates threads and joins them before passing control back to Python). So any time that `os.fork()` is called, only a single thread is running.\n\nBut the error message triggers any time that objective-C code is called after `fork()`, regardless of whether threads are involved, let alone that those threads are executing objective-C code.\n\nSo it seems to me that disabling the error message is the right thing to do.",
    "created_at": "2018-12-19T13:16:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497808",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:35'></a>What bothers me is that the error message from Apple `may have been in progress in another thread when fork() was called` is in most cases a false positive.

The way I understand things (I certainly may be wrong), that error message protects against a crash that may happen if one thread of an application is calling `fork()` while another thread is executing objective-C code. Those are very precise conditions which are highly unlikely to occur in Sage (and probably Python in general): multi-threading is used in Sage, but only in low-level C libraries which wouldn't run objective-C code. Moreover, I don't think we are ever running multiple threads of Python code (typically, the C code creates threads and joins them before passing control back to Python). So any time that `os.fork()` is called, only a single thread is running.

But the error message triggers any time that objective-C code is called after `fork()`, regardless of whether threads are involved, let alone that those threads are executing objective-C code.

So it seems to me that disabling the error message is the right thing to do.



---

archive/issue_comments_497809.json:
```json
{
    "body": "<a id='comment:36'></a>You can't necessarily say that for sure, because I think a number of standard posix interfaces on macOS are implemented on top of lower-level Objective-C code, as one can often see in stack traces.  I remember at one point I traced exactly what function was causing this error in Sage, when checking for internet access. I don't remember exactly but I think it was something standard like `gethostbyname()`.\n\nBut I agree, it's especially annoying that the message is printed unconditionally, and worse that the `abort()` happens even in the case of false positives, which as you write are going to be far more common.  So setting this environment variable is the only logical choice.\n\nIn the odd case where some bizarre crash is happening on macOS, it should be understood that the case this is trying to prevent is a possibility.  This is just Apple aggressively making us aware of their bug (rather than just fixing the damn bug which you'd think with nearly a trillion dollars in their pocket they could do--this isn't rocket science).",
    "created_at": "2018-12-19T14:46:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497809",
    "user": "https://github.com/embray"
}
```

<a id='comment:36'></a>You can't necessarily say that for sure, because I think a number of standard posix interfaces on macOS are implemented on top of lower-level Objective-C code, as one can often see in stack traces.  I remember at one point I traced exactly what function was causing this error in Sage, when checking for internet access. I don't remember exactly but I think it was something standard like `gethostbyname()`.

But I agree, it's especially annoying that the message is printed unconditionally, and worse that the `abort()` happens even in the case of false positives, which as you write are going to be far more common.  So setting this environment variable is the only logical choice.

In the odd case where some bizarre crash is happening on macOS, it should be understood that the case this is trying to prevent is a possibility.  This is just Apple aggressively making us aware of their bug (rather than just fixing the damn bug which you'd think with nearly a trillion dollars in their pocket they could do--this isn't rocket science).



---

archive/issue_comments_497810.json:
```json
{
    "body": "Changing branch from \"\" to \"u/jdemeyer/aborted_tests_on_macos_10_13_6\"",
    "created_at": "2018-12-19T16:11:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497810",
    "user": "https://github.com/jdemeyer"
}
```

Changing branch from "" to "u/jdemeyer/aborted_tests_on_macos_10_13_6"



---

archive/issue_comments_497811.json:
```json
{
    "body": "Changing commit from \"\" to \"688a288e16663fe2c4a881baa510ed797a46efa1\"",
    "created_at": "2018-12-19T16:12:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497811",
    "user": "https://github.com/jdemeyer"
}
```

Changing commit from "" to "688a288e16663fe2c4a881baa510ed797a46efa1"



---

archive/issue_comments_497812.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-12-19T16:12:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497812",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_497813.json:
```json
{
    "body": "<a id='comment:38'></a>New commits:",
    "created_at": "2018-12-19T16:12:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497813",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:38'></a>New commits:



---

archive/issue_comments_497814.json:
```json
{
    "body": "Changing author from \"\" to \"Jeroen Demeyer\"",
    "created_at": "2018-12-19T16:12:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497814",
    "user": "https://github.com/jdemeyer"
}
```

Changing author from "" to "Jeroen Demeyer"



---

archive/issue_comments_497815.json:
```json
{
    "body": "<a id='comment:39'></a>This works for me.\n\nReplying to [embray](#comment%3A33):\n> Should probably also set it in `sage.env`.\n\n\nCan you explain why?",
    "created_at": "2018-12-19T19:08:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497815",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:39'></a>This works for me.

Replying to [embray](#comment%3A33):
> Should probably also set it in `sage.env`.


Can you explain why?



---

archive/issue_comments_497816.json:
```json
{
    "body": "<a id='comment:40'></a>Although not yet fully operative I want the sage package to eventually be able to work correctly with some sensible defaults without having to source `sage-env`, so the package itself should also put this in the environment if it's needed for some of its functionality to work properly.",
    "created_at": "2018-12-20T13:51:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497816",
    "user": "https://github.com/embray"
}
```

<a id='comment:40'></a>Although not yet fully operative I want the sage package to eventually be able to work correctly with some sensible defaults without having to source `sage-env`, so the package itself should also put this in the environment if it's needed for some of its functionality to work properly.



---

archive/issue_comments_497817.json:
```json
{
    "body": "<a id='comment:41'></a>That makes sense to me. Jeroen, any comments?",
    "created_at": "2018-12-20T16:22:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497817",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:41'></a>That makes sense to me. Jeroen, any comments?



---

archive/issue_comments_497818.json:
```json
{
    "body": "<a id='comment:42'></a>Replying to [embray](#comment%3A40):\n> Although not yet fully operative I want the sage package to eventually be able to work correctly with some sensible defaults without having to source `sage-env`, so the package itself should also put this in the environment if it's needed for some of its functionality to work properly.\n\n\nMaybe, but not in this ticket. What you propose should fit in a larger discussion about how to handle environment variables. It doesn't make sense to me to special-case this one environment variable `OBJC_DISABLE_INITIALIZE_FORK_SAFETY`.",
    "created_at": "2018-12-20T17:53:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497818",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:42'></a>Replying to [embray](#comment%3A40):
> Although not yet fully operative I want the sage package to eventually be able to work correctly with some sensible defaults without having to source `sage-env`, so the package itself should also put this in the environment if it's needed for some of its functionality to work properly.


Maybe, but not in this ticket. What you propose should fit in a larger discussion about how to handle environment variables. It doesn't make sense to me to special-case this one environment variable `OBJC_DISABLE_INITIALIZE_FORK_SAFETY`.



---

archive/issue_comments_497819.json:
```json
{
    "body": "<a id='comment:43'></a>This fixes the problem and I think it should be merged quickly; enhancements to `sage.env` should be on another ticket. Separate topics should be on separate tickets unless they are inextricably entwined, and I don't think that's the case for `sage.env`.",
    "created_at": "2018-12-20T19:20:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497819",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:43'></a>This fixes the problem and I think it should be merged quickly; enhancements to `sage.env` should be on another ticket. Separate topics should be on separate tickets unless they are inextricably entwined, and I don't think that's the case for `sage.env`.



---

archive/issue_comments_497820.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-12-20T19:20:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497820",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_497821.json:
```json
{
    "body": "Changing reviewer from \"\" to \"John Palmieri\"",
    "created_at": "2018-12-20T19:20:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497821",
    "user": "https://github.com/jhpalmieri"
}
```

Changing reviewer from "" to "John Palmieri"



---

archive/issue_comments_497822.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-12-23T23:41:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497822",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_064814.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-12-23T23:41:06Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25921#event-64814"
}
```



---

archive/issue_comments_497823.json:
```json
{
    "body": "Changing branch from \"u/jdemeyer/aborted_tests_on_macos_10_13_6\" to \"688a288e16663fe2c4a881baa510ed797a46efa1\"",
    "created_at": "2018-12-23T23:41:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497823",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/jdemeyer/aborted_tests_on_macos_10_13_6" to "688a288e16663fe2c4a881baa510ed797a46efa1"



---

archive/issue_events_064815.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-12-28T14:06:38Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "milestone": "sage-8.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25921#event-64815"
}
```



---

archive/issue_comments_497824.json:
```json
{
    "body": "<a id='comment:45'></a>This tickets were closed as fixed after the Sage 8.5 release.",
    "created_at": "2018-12-28T14:06:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25921#issuecomment-497824",
    "user": "https://github.com/embray"
}
```

<a id='comment:45'></a>This tickets were closed as fixed after the Sage 8.5 release.
