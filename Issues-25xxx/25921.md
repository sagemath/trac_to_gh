# Issue 25921: aborted tests on macOS 10.13.6

archive/issues_025684.json:
```json
{
    "assignees": [],
    "body": "With 8.3rc2, testing of sage.doctest.external and sage.combinat.designs.ext_rep fail with similar messages. \n\nFrom googling, I found this comment which  https://github.com/ansible/ansible/issues/34056#issuecomment-352862252 but I do not have the knowledge to tell whether this is the same issue. Excerpts from output below; full logs attached.\n\n```\nsage -t --long src/sage/doctest/external.py\nRunning doctests with ID 2018-07-24-23-58-33-c07cfdbe.\nGit branch: develop\nUsing --optional=mpir,python2,sage\nDoctesting 1 file.\nsage -t --long --warn-long 183.2 src/sage/doctest/external.py\n    Killed due to abort\n**********************************************************************\nTests run before process (pid=69718) failed:\n\n[ snip ]\n\nsage: sage.doctest.external._lookup('internet') # random ## line 302 ##\nobjc[69718]: +[__NSPlaceholderDate initialize] may have been in progress in another thread when fork() was called.\nobjc[69718]: +[__NSPlaceholderDate initialize] may have been in progress in another thread when fork() was called. We cannot safely call it or ignore it in the fork() child process. Crashing instead. Set a breakpoint on objc_initializeAfterForkError to debug.\n------------------------------------------------------------------------\n0   signals.so                          0x000000010e5956e8 print_backtrace + 40\n1   ???                                 0x6974757469747362 0x0 + 7598827614126764898\n------------------------------------------------------------------------\nUnhandled SIGABRT: An abort() occurred.\nThis probably occurred because a *compiled* module has a bug\nin it and is not properly wrapped with sig_on(), sig_off().\nPython will now terminate.\n------------------------------------------------------------------------\n\n**********************************************************************\n----------------------------------------------------------------------\nsage -t --long --warn-long 183.2 src/sage/doctest/external.py  # Killed due to abort\n----------------------------------------------------------------------\nTotal time for all tests: 1.6 seconds\n    cpu time: 0.0 seconds\n    cumulative wall time: 0.0 seconds\n```\n\n```\nsage -t --long src/sage/combinat/designs/ext_rep.py\nRunning doctests with ID 2018-07-24-23-58-47-07be9643.\nGit branch: develop\nUsing --optional=mpir,python2,sage\nDoctesting 1 file.\nsage -t --long --warn-long 183.2 src/sage/combinat/designs/ext_rep.py\n    Killed due to abort\n**********************************************************************\nTests run before process (pid=69771) failed:\n\n[ snip ]\n\nsage: from sage.combinat.designs import ext_rep ## line 549 ##\nsage: file_loc = ext_rep.dump_to_tmpfile(ext_rep.v2_b2_k2_icgsa) ## line 550 ##\nsage: proc = ext_rep.XTreeProcessor() ## line 551 ##\nsage: s = ext_rep.open_extrep_url(\"file://\" + file_loc) ## line 552 ##\nobjc[69771]: +[__NSPlaceholderDate initialize] may have been in progress in another thread when fork() was called.\nobjc[69771]: +[__NSPlaceholderDate initialize] may have been in progress in another thread when fork() was called. We cannot safely call it or ignore it in the fork() child process. Crashing instead. Set a breakpoint on objc_initializeAfterForkError to debug.\n------------------------------------------------------------------------\n0   signals.so                          0x0000000107ab66e8 print_backtrace + 40\n1   ???                                 0x6974757469747362 0x0 + 7598827614126764898\n------------------------------------------------------------------------\nUnhandled SIGABRT: An abort() occurred.\nThis probably occurred because a *compiled* module has a bug\nin it and is not properly wrapped with sig_on(), sig_off().\nPython will now terminate.\n------------------------------------------------------------------------\n\n**********************************************************************\n----------------------------------------------------------------------\nsage -t --long --warn-long 183.2 src/sage/combinat/designs/ext_rep.py  # Killed due to abort\n----------------------------------------------------------------------\nTotal time for all tests: 0.9 seconds\n    cpu time: 0.0 seconds\n    cumulative wall time: 0.0 seconds\n```\n\nBranch/Commit: **[688a288](https://github.com/sagemath/sagetrac-mirror/commit/688a288e16663fe2c4a881baa510ed797a46efa1)**\n\nReviewer: **John Palmieri**\n\nAuthor: **Jeroen Demeyer**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/25921_\n\n",
    "closed_at": "2018-12-23T23:41:06Z",
    "created_at": "2018-07-24T23:37:10Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20interfaces%3A%20optional",
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.6",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "aborted tests on macOS 10.13.6",
    "type": "issue",
    "updated_at": "2018-12-28T14:06:38Z",
    "url": "https://github.com/sagemath/sage/issues/25921",
    "user": "https://github.com/bryangingechen"
}
```
With 8.3rc2, testing of sage.doctest.external and sage.combinat.designs.ext_rep fail with similar messages. 

From googling, I found this comment which  https://github.com/ansible/ansible/issues/34056#issuecomment-352862252 but I do not have the knowledge to tell whether this is the same issue. Excerpts from output below; full logs attached.

```
sage -t --long src/sage/doctest/external.py
Running doctests with ID 2018-07-24-23-58-33-c07cfdbe.
Git branch: develop
Using --optional=mpir,python2,sage
Doctesting 1 file.
sage -t --long --warn-long 183.2 src/sage/doctest/external.py
    Killed due to abort
**********************************************************************
Tests run before process (pid=69718) failed:

[ snip ]

sage: sage.doctest.external._lookup('internet') # random ## line 302 ##
objc[69718]: +[__NSPlaceholderDate initialize] may have been in progress in another thread when fork() was called.
objc[69718]: +[__NSPlaceholderDate initialize] may have been in progress in another thread when fork() was called. We cannot safely call it or ignore it in the fork() child process. Crashing instead. Set a breakpoint on objc_initializeAfterForkError to debug.
------------------------------------------------------------------------
0   signals.so                          0x000000010e5956e8 print_backtrace + 40
1   ???                                 0x6974757469747362 0x0 + 7598827614126764898
------------------------------------------------------------------------
Unhandled SIGABRT: An abort() occurred.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
------------------------------------------------------------------------

**********************************************************************
----------------------------------------------------------------------
sage -t --long --warn-long 183.2 src/sage/doctest/external.py  # Killed due to abort
----------------------------------------------------------------------
Total time for all tests: 1.6 seconds
    cpu time: 0.0 seconds
    cumulative wall time: 0.0 seconds
```

```
sage -t --long src/sage/combinat/designs/ext_rep.py
Running doctests with ID 2018-07-24-23-58-47-07be9643.
Git branch: develop
Using --optional=mpir,python2,sage
Doctesting 1 file.
sage -t --long --warn-long 183.2 src/sage/combinat/designs/ext_rep.py
    Killed due to abort
**********************************************************************
Tests run before process (pid=69771) failed:

[ snip ]

sage: from sage.combinat.designs import ext_rep ## line 549 ##
sage: file_loc = ext_rep.dump_to_tmpfile(ext_rep.v2_b2_k2_icgsa) ## line 550 ##
sage: proc = ext_rep.XTreeProcessor() ## line 551 ##
sage: s = ext_rep.open_extrep_url("file://" + file_loc) ## line 552 ##
objc[69771]: +[__NSPlaceholderDate initialize] may have been in progress in another thread when fork() was called.
objc[69771]: +[__NSPlaceholderDate initialize] may have been in progress in another thread when fork() was called. We cannot safely call it or ignore it in the fork() child process. Crashing instead. Set a breakpoint on objc_initializeAfterForkError to debug.
------------------------------------------------------------------------
0   signals.so                          0x0000000107ab66e8 print_backtrace + 40
1   ???                                 0x6974757469747362 0x0 + 7598827614126764898
------------------------------------------------------------------------
Unhandled SIGABRT: An abort() occurred.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
------------------------------------------------------------------------

**********************************************************************
----------------------------------------------------------------------
sage -t --long --warn-long 183.2 src/sage/combinat/designs/ext_rep.py  # Killed due to abort
----------------------------------------------------------------------
Total time for all tests: 0.9 seconds
    cpu time: 0.0 seconds
    cumulative wall time: 0.0 seconds
```

Branch/Commit: **[688a288](https://github.com/sagemath/sagetrac-mirror/commit/688a288e16663fe2c4a881baa510ed797a46efa1)**

Reviewer: **John Palmieri**

Author: **Jeroen Demeyer**

_Issue created by migration from https://trac.sagemath.org/ticket/25921_





---

archive/issue_events_327952.json:
```json
{
    "actor": "https://github.com/bryangingechen",
    "created_at": "2018-07-24T23:37:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "milestone_number": null,
    "milestone_title": "sage-8.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25921#event-327952"
}
```



---

archive/issue_events_327953.json:
```json
{
    "actor": "https://github.com/bryangingechen",
    "created_at": "2018-07-24T23:37:10Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20interfaces%3A%20optional",
    "label_color": "0000ff",
    "label_name": "component: interfaces: optional",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25921#event-327953"
}
```



---

archive/issue_events_327954.json:
```json
{
    "actor": "https://github.com/bryangingechen",
    "created_at": "2018-07-24T23:37:10Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25921#event-327954"
}
```



---

archive/issue_events_327955.json:
```json
{
    "actor": "https://github.com/bryangingechen",
    "created_at": "2018-07-24T23:37:10Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25921#event-327955"
}
```



---

archive/issue_comments_401716.json:
```json
{
    "body": "Attachment: **[crash_sage.combinat.designs.ext_rep.log](https://github.com/sagemath/sage/files/ticket25921/crash_sage.combinat.designs.ext_rep.log)**\n\nAttachment: **[crash_sage.doctest.external.log](https://github.com/sagemath/sage/files/ticket25921/crash_sage.doctest.external.log)**",
    "created_at": "2018-07-24T23:37:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401716",
    "user": "https://github.com/bryangingechen"
}
```

Attachment: **[crash_sage.combinat.designs.ext_rep.log](https://github.com/sagemath/sage/files/ticket25921/crash_sage.combinat.designs.ext_rep.log)**

Attachment: **[crash_sage.doctest.external.log](https://github.com/sagemath/sage/files/ticket25921/crash_sage.doctest.external.log)**



---

archive/issue_comments_401717.json:
```json
{
    "body": "<a id='comment:1'>Comment 1:</a>\nI think this was caused by #25092. See [comment 11](https://github.com/sagemath/sage/issues/25092#comment:11) there. Setting the environment variable `OBJC_DISABLE_INITIALIZE_FORK_SAFETY` to `YES` works for me \u2013\u00a0that is, if I do this before running doctests, I don't get these failures.",
    "created_at": "2018-07-25T00:11:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401717",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:1'>Comment 1:</a>
I think this was caused by #25092. See [comment 11](https://github.com/sagemath/sage/issues/25092#comment:11) there. Setting the environment variable `OBJC_DISABLE_INITIALIZE_FORK_SAFETY` to `YES` works for me – that is, if I do this before running doctests, I don't get these failures.



---

archive/issue_comments_401718.json:
```json
{
    "body": "<a id='comment:2'>Comment 2:</a>\nOh, also see https://groups.google.com/d/msg/sage-release/pU08gXEhpYU/3i5rlcj5CAAJ and the ensuing discussion.",
    "created_at": "2018-07-25T00:12:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401718",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:2'>Comment 2:</a>
Oh, also see https://groups.google.com/d/msg/sage-release/pU08gXEhpYU/3i5rlcj5CAAJ and the ensuing discussion.



---

archive/issue_comments_401719.json:
```json
{
    "body": "<a id='comment:3'>Comment 3:</a>\nThanks! I missed those comments when I searched. I can confirm that setting the environment variable fixes these tests. Should I close this ticket as a duplicate then?",
    "created_at": "2018-07-25T00:22:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401719",
    "user": "https://github.com/bryangingechen"
}
```

<a id='comment:3'>Comment 3:</a>
Thanks! I missed those comments when I searched. I can confirm that setting the environment variable fixes these tests. Should I close this ticket as a duplicate then?



---

archive/issue_comments_401720.json:
```json
{
    "body": "<a id='comment:4'>Comment 4:</a>\nWell, is setting an environment variable a good enough solution? I don't know what the underlying problem is, and whether it's worth pursuing, so I think we should keep this open to see if anyone can make any progress on it.",
    "created_at": "2018-07-25T01:35:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401720",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:4'>Comment 4:</a>
Well, is setting an environment variable a good enough solution? I don't know what the underlying problem is, and whether it's worth pursuing, so I think we should keep this open to see if anyone can make any progress on it.



---

archive/issue_comments_401721.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\nThere is also an open issue about this in Python: https://bugs.python.org/issue33725",
    "created_at": "2018-07-26T13:23:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401721",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'>Comment 5:</a>
There is also an open issue about this in Python: https://bugs.python.org/issue33725



---

archive/issue_comments_401722.json:
```json
{
    "body": "<a id='comment:6'>Comment 6:</a>\nReplying to [@jhpalmieri](#comment%3A4):\n> I don't know what the underlying problem is\n\nI'd love to read a good explanation. All over the web you'll find different partial explanations about the problem and what the environment variable does but never with a lot of technical detail.\n\nFor example, there is talk about \"multi-threaded applications\" but what **exactly** is a multi-threaded application?",
    "created_at": "2018-07-26T13:37:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401722",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'>Comment 6:</a>
Replying to [@jhpalmieri](#comment%3A4):
> I don't know what the underlying problem is

I'd love to read a good explanation. All over the web you'll find different partial explanations about the problem and what the environment variable does but never with a lot of technical detail.

For example, there is talk about "multi-threaded applications" but what **exactly** is a multi-threaded application?



---

archive/issue_comments_401723.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\nI think the talk about \"multi-threaded applications\" is perhaps mostly a red-herring.\n\nThe issue is that Objective-C runtime functions are not allowed to be called between the `fork()` and `exec()` in a child process--if you do the runtime calls `abort()`.  The `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` environment variable disables this, but then you really better be sure that you've registered a pre-fork handler (e.g. with `pthread_atfork`) that ensures the C runtime is in a safe state (e.g. no locks are held, etc.) since it won't guarantee this on its own.",
    "created_at": "2018-07-26T13:52:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401723",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'>Comment 7:</a>
I think the talk about "multi-threaded applications" is perhaps mostly a red-herring.

The issue is that Objective-C runtime functions are not allowed to be called between the `fork()` and `exec()` in a child process--if you do the runtime calls `abort()`.  The `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` environment variable disables this, but then you really better be sure that you've registered a pre-fork handler (e.g. with `pthread_atfork`) that ensures the C runtime is in a safe state (e.g. no locks are held, etc.) since it won't guarantee this on its own.



---

archive/issue_comments_401724.json:
```json
{
    "body": "<a id='comment:8'>Comment 8:</a>\nReplying to [@embray](#comment%3A7):\n> I think the talk about \"multi-threaded applications\" is perhaps mostly a red-herring.\n> \n> The issue is that Objective-C runtime functions are not allowed to be called between the `fork()` and `exec()` in a child process\n\nSo they basically broke `fork()`?",
    "created_at": "2018-07-26T14:34:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401724",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'>Comment 8:</a>
Replying to [@embray](#comment%3A7):
> I think the talk about "multi-threaded applications" is perhaps mostly a red-herring.
> 
> The issue is that Objective-C runtime functions are not allowed to be called between the `fork()` and `exec()` in a child process

So they basically broke `fork()`?



---

archive/issue_comments_401725.json:
```json
{
    "body": "<a id='comment:9'>Comment 9:</a>\nThat's basically my understanding, though upon rereading the linked article, it does pertain to multi-threaded applications insofar as this is *only* a problem when forking from a multi-threaded process.  If there's just a single process I think it doesn't matter.\n\nIt may not be entirely wrong:\n\n> A process shall be created with a single thread. If a multi-threaded process calls fork(), the new process shall contain a replica of the calling thread and its entire address space, possibly including the states of mutexes and other resources. Consequently, to avoid errors, the child process may only execute async-signal-safe operations until such time as one of the exec functions is called. [THR] [Option Start]  Fork handlers may be established by means of the pthread_atfork() function in order to maintain application invariants across fork() calls.\n\nIf the runtime itself can't guarantee that \"the child process [will] only execute async-signal-safe operations until such time as one of the exec functions is called\" then it's safer for it to blow up immediately than maybe work, or maybe result in even harder to debug errors.\n\nI'm not saying it doesn't suck, but it seems to make some sense...",
    "created_at": "2018-07-26T15:00:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401725",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'>Comment 9:</a>
That's basically my understanding, though upon rereading the linked article, it does pertain to multi-threaded applications insofar as this is *only* a problem when forking from a multi-threaded process.  If there's just a single process I think it doesn't matter.

It may not be entirely wrong:

> A process shall be created with a single thread. If a multi-threaded process calls fork(), the new process shall contain a replica of the calling thread and its entire address space, possibly including the states of mutexes and other resources. Consequently, to avoid errors, the child process may only execute async-signal-safe operations until such time as one of the exec functions is called. [THR] [Option Start]  Fork handlers may be established by means of the pthread_atfork() function in order to maintain application invariants across fork() calls.

If the runtime itself can't guarantee that "the child process [will] only execute async-signal-safe operations until such time as one of the exec functions is called" then it's safer for it to blow up immediately than maybe work, or maybe result in even harder to debug errors.

I'm not saying it doesn't suck, but it seems to make some sense...



---

archive/issue_comments_401726.json:
```json
{
    "body": "<a id='comment:10'>Comment 10:</a>\nTo put another way, because Objective-C doesn't have an equivalent of a GIL, forking a multi-threaded application is dangerous and tricky, because rather than make sure that their library actually ensures it's in a sane state before forking, the Apple developers seem to have thrown their hands up and made it everyone else's problem (glibc sometimes has bugs like this as well, but actually tries to fix them...)",
    "created_at": "2018-07-26T15:09:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401726",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'>Comment 10:</a>
To put another way, because Objective-C doesn't have an equivalent of a GIL, forking a multi-threaded application is dangerous and tricky, because rather than make sure that their library actually ensures it's in a sane state before forking, the Apple developers seem to have thrown their hands up and made it everyone else's problem (glibc sometimes has bugs like this as well, but actually tries to fix them...)



---

archive/issue_comments_401727.json:
```json
{
    "body": "<a id='comment:11'>Comment 11:</a>\nI'd still like to know under exactly which circumstances the objc error occurs (and none of the articles I saw answers that question).",
    "created_at": "2018-07-26T15:28:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401727",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'>Comment 11:</a>
I'd still like to know under exactly which circumstances the objc error occurs (and none of the articles I saw answers that question).



---

archive/issue_comments_401728.json:
```json
{
    "body": "<a id='comment:12'>Comment 12:</a>\nWhen I first saw this, I thought that I had traced it to #25092. Can you deduce anything from that? (What changed in cysignals 1.7.0 that could have led to this?) Is there anything I can do to provide more information about Sage's situation in particular, since my computers give me these errors?",
    "created_at": "2018-07-26T15:39:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401728",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:12'>Comment 12:</a>
When I first saw this, I thought that I had traced it to #25092. Can you deduce anything from that? (What changed in cysignals 1.7.0 that could have led to this?) Is there anything I can do to provide more information about Sage's situation in particular, since my computers give me these errors?



---

archive/issue_comments_401729.json:
```json
{
    "body": "<a id='comment:13'>Comment 13:</a>\nReplying to [@jdemeyer](#comment%3A11):\n> I'd still like to know under exactly which circumstances the objc error occurs (and none of the articles I saw answers that question).\n\nI think the reason for that is that there are probably too many to list, and it's impossible to say exactly since it's all closed source.",
    "created_at": "2018-07-26T15:46:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401729",
    "user": "https://github.com/embray"
}
```

<a id='comment:13'>Comment 13:</a>
Replying to [@jdemeyer](#comment%3A11):
> I'd still like to know under exactly which circumstances the objc error occurs (and none of the articles I saw answers that question).

I think the reason for that is that there are probably too many to list, and it's impossible to say exactly since it's all closed source.



---

archive/issue_comments_401730.json:
```json
{
    "body": "<a id='comment:14'>Comment 14:</a>\nIn these examples it's happening because something calls `__NSPlaceholderDate.initialize` whatever that is.  So we'd want to go into GDB and find out why that's being called, because it seems to be a common thread (no pun intended) in this specific case.",
    "created_at": "2018-07-26T15:47:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401730",
    "user": "https://github.com/embray"
}
```

<a id='comment:14'>Comment 14:</a>
In these examples it's happening because something calls `__NSPlaceholderDate.initialize` whatever that is.  So we'd want to go into GDB and find out why that's being called, because it seems to be a common thread (no pun intended) in this specific case.



---

archive/issue_comments_401731.json:
```json
{
    "body": "<a id='comment:15'>Comment 15:</a>\nLooks like it probably stems from somewhere in `urlopen`.\n\nIs it only these tests that fail?",
    "created_at": "2018-07-26T15:55:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401731",
    "user": "https://github.com/embray"
}
```

<a id='comment:15'>Comment 15:</a>
Looks like it probably stems from somewhere in `urlopen`.

Is it only these tests that fail?



---

archive/issue_comments_401732.json:
```json
{
    "body": "<a id='comment:16'>Comment 16:</a>\nYes, only these.",
    "created_at": "2018-07-26T16:16:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401732",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:16'>Comment 16:</a>
Yes, only these.



---

archive/issue_comments_401733.json:
```json
{
    "body": "<a id='comment:17'>Comment 17:</a>\nReplying to [@embray](#comment%3A13):\n> I think the reason for that is that there are probably too many to list, and it's impossible to say exactly since it's all closed source.\n\nYes and that's really bad. How can we fix a problem if nobody is able to say exactly what the problem is?",
    "created_at": "2018-07-26T17:35:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401733",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'>Comment 17:</a>
Replying to [@embray](#comment%3A13):
> I think the reason for that is that there are probably too many to list, and it's impossible to say exactly since it's all closed source.

Yes and that's really bad. How can we fix a problem if nobody is able to say exactly what the problem is?



---

archive/issue_comments_401734.json:
```json
{
    "body": "<a id='comment:18'>Comment 18:</a>\nIf setting `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` fixes this, then we at least have an easy workaround.\n\nShould we do that (at least as a temporary solution) in Sage 8.3?",
    "created_at": "2018-07-26T17:40:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401734",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'>Comment 18:</a>
If setting `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` fixes this, then we at least have an easy workaround.

Should we do that (at least as a temporary solution) in Sage 8.3?



---

archive/issue_comments_401735.json:
```json
{
    "body": "<a id='comment:19'>Comment 19:</a>\nReplying to [@jdemeyer](#comment%3A18):\n> If setting `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` fixes this, then we at least have an easy workaround.\n\nThis only needs to be done when running doctests, by the way. I can't get the same commands to fail when run in Sage interactively.",
    "created_at": "2018-07-26T17:54:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401735",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:19'>Comment 19:</a>
Replying to [@jdemeyer](#comment%3A18):
> If setting `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` fixes this, then we at least have an easy workaround.

This only needs to be done when running doctests, by the way. I can't get the same commands to fail when run in Sage interactively.



---

archive/issue_comments_401736.json:
```json
{
    "body": "<a id='comment:20'>Comment 20:</a>\nFrom this point of view, we could just change the doctests:\n\n```diff\ndiff --git a/src/sage/doctest/external.py b/src/sage/doctest/external.py\nindex 9cbc42b178..de0b0e1e2f 100644\n--- a/src/sage/doctest/external.py\n+++ b/src/sage/doctest/external.py\n@@ -299,7 +299,7 @@ def _lookup(software):\n     \n     EXAMPLES::\n \n-        sage: sage.doctest.external._lookup('internet') # random\n+        sage: sage.doctest.external._lookup('latex') # random\n         True\n     \"\"\"\n     if software in external_software:\n@@ -332,9 +332,9 @@ class AvailableSoftware(object):\n          'octave',\n          'pandoc',\n          'scilab']\n-        sage: 'internet' in available_software # random\n+        sage: 'latex' in available_software # random\n         True\n-        sage: available_software.issuperset(set(['internet','latex'])) # random\n+        sage: available_software.issuperset(set(['maple','latex'])) # random\n         True\n     \"\"\"\n     def __init__(self):\n@@ -360,7 +360,7 @@ class AvailableSoftware(object):\n         EXAMPLES::\n \n             sage: from sage.doctest.external import available_software\n-            sage: 'internet' in available_software # random\n+            sage: 'macaulay2' in available_software # random\n             True\n         \"\"\"\n         try:\n@@ -386,7 +386,7 @@ class AvailableSoftware(object):\n         EXAMPLES::\n \n             sage: from sage.doctest.external import available_software\n-            sage: available_software.issuperset(set(['internet','latex','magma'])) # random\n+            sage: available_software.issuperset(set(['gurobi','latex','magma'])) # random\n             True\n         \"\"\"\n         for item in other:\n```\nTreating the symptom rather than the disease, but if this only manifests itself in doctests, maybe that's okay.",
    "created_at": "2018-07-26T17:56:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401736",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:20'>Comment 20:</a>
From this point of view, we could just change the doctests:

```diff
diff --git a/src/sage/doctest/external.py b/src/sage/doctest/external.py
index 9cbc42b178..de0b0e1e2f 100644
--- a/src/sage/doctest/external.py
+++ b/src/sage/doctest/external.py
@@ -299,7 +299,7 @@ def _lookup(software):
     
     EXAMPLES::
 
-        sage: sage.doctest.external._lookup('internet') # random
+        sage: sage.doctest.external._lookup('latex') # random
         True
     """
     if software in external_software:
@@ -332,9 +332,9 @@ class AvailableSoftware(object):
          'octave',
          'pandoc',
          'scilab']
-        sage: 'internet' in available_software # random
+        sage: 'latex' in available_software # random
         True
-        sage: available_software.issuperset(set(['internet','latex'])) # random
+        sage: available_software.issuperset(set(['maple','latex'])) # random
         True
     """
     def __init__(self):
@@ -360,7 +360,7 @@ class AvailableSoftware(object):
         EXAMPLES::
 
             sage: from sage.doctest.external import available_software
-            sage: 'internet' in available_software # random
+            sage: 'macaulay2' in available_software # random
             True
         """
         try:
@@ -386,7 +386,7 @@ class AvailableSoftware(object):
         EXAMPLES::
 
             sage: from sage.doctest.external import available_software
-            sage: available_software.issuperset(set(['internet','latex','magma'])) # random
+            sage: available_software.issuperset(set(['gurobi','latex','magma'])) # random
             True
         """
         for item in other:
```
Treating the symptom rather than the disease, but if this only manifests itself in doctests, maybe that's okay.



---

archive/issue_comments_401737.json:
```json
{
    "body": "<a id='comment:21'>Comment 21:</a>\nReplying to [@jhpalmieri](#comment%3A19):\n> I can't get the same commands to fail when run in Sage interactively.\n\nWell, it seems that you need to `fork()` which would be the case when using `multiprocessing` for example.",
    "created_at": "2018-07-26T18:08:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401737",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'>Comment 21:</a>
Replying to [@jhpalmieri](#comment%3A19):
> I can't get the same commands to fail when run in Sage interactively.

Well, it seems that you need to `fork()` which would be the case when using `multiprocessing` for example.



---

archive/issue_comments_401738.json:
```json
{
    "body": "<a id='comment:22'>Comment 22:</a>\nReplying to [@jhpalmieri](#comment%3A20):\n> From this point of view, we could just change the doctests:\n\nI'm -1 to this. As far as I know, there is nothing wrong with those doctests, so why should we change them?",
    "created_at": "2018-07-26T18:09:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401738",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'>Comment 22:</a>
Replying to [@jhpalmieri](#comment%3A20):
> From this point of view, we could just change the doctests:

I'm -1 to this. As far as I know, there is nothing wrong with those doctests, so why should we change them?



---

archive/issue_comments_401739.json:
```json
{
    "body": "<a id='comment:23'>Comment 23:</a>\nReplying to [@jdemeyer](#comment%3A21):\n> Replying to [@jhpalmieri](#comment%3A19):\n> > I can't get the same commands to fail when run in Sage interactively.\n\n> \n> Well, it seems that you need to `fork()` which would be the case when using `multiprocessing` for example.\n\nIn combination with `urlopen`, as embray points out.\n\nReplying to [@jdemeyer](#comment%3A22):\n> Replying to [@jhpalmieri](#comment%3A20):\n> > From this point of view, we could just change the doctests:\n\n> \n> I'm -1 to this. As far as I know, there is nothing wrong with those doctests, so why should we change them?\n\nIf someone can figure out a way to fix what's wrong, that's great. On the other hand, I don't think they test anything particularly compelling, since the same commands work fine interactively. So if it turns out to be easy to fix, I am happy to fix it, but if it is complicated, perhaps we could spend our efforts fixing more important things. Or maybe I'm underestimating somehow the importance of these failures.\n\nPut another way, how is changing the doctests different, qualitatively, from doing `export OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` before running doctests? Both bypass the problem without solving it.",
    "created_at": "2018-07-26T18:16:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401739",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:23'>Comment 23:</a>
Replying to [@jdemeyer](#comment%3A21):
> Replying to [@jhpalmieri](#comment%3A19):
> > I can't get the same commands to fail when run in Sage interactively.

> 
> Well, it seems that you need to `fork()` which would be the case when using `multiprocessing` for example.

In combination with `urlopen`, as embray points out.

Replying to [@jdemeyer](#comment%3A22):
> Replying to [@jhpalmieri](#comment%3A20):
> > From this point of view, we could just change the doctests:

> 
> I'm -1 to this. As far as I know, there is nothing wrong with those doctests, so why should we change them?

If someone can figure out a way to fix what's wrong, that's great. On the other hand, I don't think they test anything particularly compelling, since the same commands work fine interactively. So if it turns out to be easy to fix, I am happy to fix it, but if it is complicated, perhaps we could spend our efforts fixing more important things. Or maybe I'm underestimating somehow the importance of these failures.

Put another way, how is changing the doctests different, qualitatively, from doing `export OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` before running doctests? Both bypass the problem without solving it.



---

archive/issue_comments_401740.json:
```json
{
    "body": "<a id='comment:24'>Comment 24:</a>\nReplying to [@jhpalmieri](#comment%3A23):\n> Put another way, how is changing the doctests different, qualitatively, from doing `export OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` before running doctests? Both bypass the problem without solving it.\n\nYour proposal only works around those specific doctest failures. There could easily be tests added in the future with the same problem. And I believe that the problem can also occur interactively when using `multiprocessing`.\n\nNote that I didn't mean to set `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` only before running doctests, I meant doing that always (in `sage-env` for example). So that should work around all cases of the problem, not just the one specific test failure.",
    "created_at": "2018-07-26T18:26:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401740",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'>Comment 24:</a>
Replying to [@jhpalmieri](#comment%3A23):
> Put another way, how is changing the doctests different, qualitatively, from doing `export OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` before running doctests? Both bypass the problem without solving it.

Your proposal only works around those specific doctest failures. There could easily be tests added in the future with the same problem. And I believe that the problem can also occur interactively when using `multiprocessing`.

Note that I didn't mean to set `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` only before running doctests, I meant doing that always (in `sage-env` for example). So that should work around all cases of the problem, not just the one specific test failure.



---

archive/issue_comments_401741.json:
```json
{
    "body": "<a id='comment:25'>Comment 25:</a>\nOkay, I can see that. Are there dangers to setting `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` always? (It would be good for me to know, since I am currently setting this in my .bashrc file to avoid these doctest failures.)",
    "created_at": "2018-07-26T18:57:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401741",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:25'>Comment 25:</a>
Okay, I can see that. Are there dangers to setting `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` always? (It would be good for me to know, since I am currently setting this in my .bashrc file to avoid these doctest failures.)



---

archive/issue_comments_401742.json:
```json
{
    "body": "<a id='comment:26'>Comment 26:</a>\nThanks for following up on this everyone.\n\nReplying to [@jhpalmieri](#comment%3A25):\n> Okay, I can see that. Are there dangers to setting `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` always? (It would be good for me to know, since I am currently setting this in my .bashrc file to avoid these doctest failures.)\n\nI just wanted to point out that according to your previous comment [#25092 comment:20](https://github.com/sagemath/sage/issues/25092#comment:20) `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES` is required (note the caps).",
    "created_at": "2018-07-26T19:48:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401742",
    "user": "https://github.com/bryangingechen"
}
```

<a id='comment:26'>Comment 26:</a>
Thanks for following up on this everyone.

Replying to [@jhpalmieri](#comment%3A25):
> Okay, I can see that. Are there dangers to setting `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` always? (It would be good for me to know, since I am currently setting this in my .bashrc file to avoid these doctest failures.)

I just wanted to point out that according to your previous comment [#25092 comment:20](https://github.com/sagemath/sage/issues/25092#comment:20) `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES` is required (note the caps).



---

archive/issue_comments_401743.json:
```json
{
    "body": "<a id='comment:27'>Comment 27:</a>\nReplying to [@bryangingechen](#comment%3A26):\n> Thanks for following up on this everyone.\n> \n> Replying to [@jhpalmieri](#comment%3A25):\n> > Okay, I can see that. Are there dangers to setting `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` always? (It would be good for me to know, since I am currently setting this in my .bashrc file to avoid these doctest failures.)\n\n> \n> I just wanted to point out that according to your previous comment [#25092 comment:20](https://github.com/sagemath/sage/issues/25092#comment:20) `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES` is required (note the caps).\n\nYes, you're right, it has to be `YES`, not `yes`.",
    "created_at": "2018-07-26T20:53:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401743",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:27'>Comment 27:</a>
Replying to [@bryangingechen](#comment%3A26):
> Thanks for following up on this everyone.
> 
> Replying to [@jhpalmieri](#comment%3A25):
> > Okay, I can see that. Are there dangers to setting `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` always? (It would be good for me to know, since I am currently setting this in my .bashrc file to avoid these doctest failures.)

> 
> I just wanted to point out that according to your previous comment [#25092 comment:20](https://github.com/sagemath/sage/issues/25092#comment:20) `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES` is required (note the caps).

Yes, you're right, it has to be `YES`, not `yes`.



---

archive/issue_comments_401744.json:
```json
{
    "body": "<a id='comment:28'>Comment 28:</a>\nReplying to [@jhpalmieri](#comment%3A25):\n> Okay, I can see that. Are there dangers to setting `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` always?\n\n\"dangers\" in which sense? It's removing a safety check, so it could be considered a bad idea. On the other hand, my impression is that this safety check is not very good so maybe it deserves to be disabled.\n\nOne remaining question to be answered: should we do this in Sage 8.3? My feeling says yes, because other people using the same OS X version might be affected by it.",
    "created_at": "2018-07-26T22:17:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401744",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:28'>Comment 28:</a>
Replying to [@jhpalmieri](#comment%3A25):
> Okay, I can see that. Are there dangers to setting `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` always?

"dangers" in which sense? It's removing a safety check, so it could be considered a bad idea. On the other hand, my impression is that this safety check is not very good so maybe it deserves to be disabled.

One remaining question to be answered: should we do this in Sage 8.3? My feeling says yes, because other people using the same OS X version might be affected by it.



---

archive/issue_comments_401745.json:
```json
{
    "body": "<a id='comment:29'>Comment 29:</a>\nReplying to [@jdemeyer](#comment%3A28):\n> Replying to [@jhpalmieri](#comment%3A25):\n> > Okay, I can see that. Are there dangers to setting `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` always?\n\n> \n> \"dangers\" in which sense? It's removing a safety check, so it could be considered a bad idea. On the other hand, my impression is that this safety check is not very good so maybe it deserves to be disabled.\n> \n> One remaining question to be answered: should we do this in Sage 8.3? My feeling says yes, because other people using the same OS X version might be affected by it.\n\nI wouldn't, in general.  Maybe just for running the test suite at the most, but even then it's iffy.\n\nI'll investigate a bit more what's going on with urlopen.  Perhaps there are some pre-fork or post-fork cleanups we can do to mitigate that specific case.  I might need to get my hands on a machine with OSX 10.13, but not necessarily either...",
    "created_at": "2018-07-27T12:03:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401745",
    "user": "https://github.com/embray"
}
```

<a id='comment:29'>Comment 29:</a>
Replying to [@jdemeyer](#comment%3A28):
> Replying to [@jhpalmieri](#comment%3A25):
> > Okay, I can see that. Are there dangers to setting `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=yes` always?

> 
> "dangers" in which sense? It's removing a safety check, so it could be considered a bad idea. On the other hand, my impression is that this safety check is not very good so maybe it deserves to be disabled.
> 
> One remaining question to be answered: should we do this in Sage 8.3? My feeling says yes, because other people using the same OS X version might be affected by it.

I wouldn't, in general.  Maybe just for running the test suite at the most, but even then it's iffy.

I'll investigate a bit more what's going on with urlopen.  Perhaps there are some pre-fork or post-fork cleanups we can do to mitigate that specific case.  I might need to get my hands on a machine with OSX 10.13, but not necessarily either...



---

archive/issue_comments_401746.json:
```json
{
    "body": "<a id='comment:30'>Comment 30:</a>\nReplying to [@embray](#comment%3A29):\n> just for running the test suite\n\nIn general, I am against testsuite-specific fixes. So I think that this is the worst possible option.\n\n> I'll investigate a bit more what's going on with urlopen. Perhaps there are some pre-fork or post-fork cleanups we can do to mitigate that specific case.\n\nI wonder how you'll do that without information from Apple. It reminds me how annoying closed-source software is.",
    "created_at": "2018-07-27T14:10:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401746",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:30'>Comment 30:</a>
Replying to [@embray](#comment%3A29):
> just for running the test suite

In general, I am against testsuite-specific fixes. So I think that this is the worst possible option.

> I'll investigate a bit more what's going on with urlopen. Perhaps there are some pre-fork or post-fork cleanups we can do to mitigate that specific case.

I wonder how you'll do that without information from Apple. It reminds me how annoying closed-source software is.



---

archive/issue_comments_401747.json:
```json
{
    "body": "<a id='comment:31'>Comment 31:</a>\n> I wonder how you'll do that without information from Apple. It reminds me how annoying closed-source software is.\n\nI don't know, we'll see.  It would not be my first time reverse engineering Apple code.  You do know what my old job was right...",
    "created_at": "2018-07-27T14:36:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401747",
    "user": "https://github.com/embray"
}
```

<a id='comment:31'>Comment 31:</a>
> I wonder how you'll do that without information from Apple. It reminds me how annoying closed-source software is.

I don't know, we'll see.  It would not be my first time reverse engineering Apple code.  You do know what my old job was right...



---

archive/issue_comments_401748.json:
```json
{
    "body": "<a id='comment:32'>Comment 32:</a>\nping? We are still seeing reports of people saying that they need to set `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES`. I recall my suggestion to set that (always and unconditionally) in `sage-env`.\n\nBut before doing that, I'd like some advice from the OS X experts.",
    "created_at": "2018-12-19T10:21:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401748",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:32'>Comment 32:</a>
ping? We are still seeing reports of people saying that they need to set `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES`. I recall my suggestion to set that (always and unconditionally) in `sage-env`.

But before doing that, I'd like some advice from the OS X experts.



---

archive/issue_comments_401749.json:
```json
{
    "body": "<a id='comment:33'>Comment 33:</a>\nSeems like the thing to do, unfortunately.  Should probably also set it in `sage.env`.  I wonder what the status is of dealing with this issue in Python itself.",
    "created_at": "2018-12-19T12:54:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401749",
    "user": "https://github.com/embray"
}
```

<a id='comment:33'>Comment 33:</a>
Seems like the thing to do, unfortunately.  Should probably also set it in `sage.env`.  I wonder what the status is of dealing with this issue in Python itself.



---

archive/issue_comments_401750.json:
```json
{
    "body": "<a id='comment:34'>Comment 34:</a>\nReplying to [@embray](#comment%3A33):\n> I wonder what the status is of dealing with this issue in Python itself.\n\nThey recently merged a PR to disable a failing test: https://github.com/python/cpython/pull/11043\n\nApart from that, nothing seems to be happening in CPython.",
    "created_at": "2018-12-19T13:03:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401750",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:34'>Comment 34:</a>
Replying to [@embray](#comment%3A33):
> I wonder what the status is of dealing with this issue in Python itself.

They recently merged a PR to disable a failing test: https://github.com/python/cpython/pull/11043

Apart from that, nothing seems to be happening in CPython.



---

archive/issue_comments_401751.json:
```json
{
    "body": "<a id='comment:35'>Comment 35:</a>\nWhat bothers me is that the error message from Apple `may have been in progress in another thread when fork() was called` is in most cases a false positive.\n\nThe way I understand things (I certainly may be wrong), that error message protects against a crash that may happen if one thread of an application is calling `fork()` while another thread is executing objective-C code. Those are very precise conditions which are highly unlikely to occur in Sage (and probably Python in general): multi-threading is used in Sage, but only in low-level C libraries which wouldn't run objective-C code. Moreover, I don't think we are ever running multiple threads of Python code (typically, the C code creates threads and joins them before passing control back to Python). So any time that `os.fork()` is called, only a single thread is running.\n\nBut the error message triggers any time that objective-C code is called after `fork()`, regardless of whether threads are involved, let alone that those threads are executing objective-C code.\n\nSo it seems to me that disabling the error message is the right thing to do.",
    "created_at": "2018-12-19T13:16:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401751",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:35'>Comment 35:</a>
What bothers me is that the error message from Apple `may have been in progress in another thread when fork() was called` is in most cases a false positive.

The way I understand things (I certainly may be wrong), that error message protects against a crash that may happen if one thread of an application is calling `fork()` while another thread is executing objective-C code. Those are very precise conditions which are highly unlikely to occur in Sage (and probably Python in general): multi-threading is used in Sage, but only in low-level C libraries which wouldn't run objective-C code. Moreover, I don't think we are ever running multiple threads of Python code (typically, the C code creates threads and joins them before passing control back to Python). So any time that `os.fork()` is called, only a single thread is running.

But the error message triggers any time that objective-C code is called after `fork()`, regardless of whether threads are involved, let alone that those threads are executing objective-C code.

So it seems to me that disabling the error message is the right thing to do.



---

archive/issue_comments_401752.json:
```json
{
    "body": "<a id='comment:36'>Comment 36:</a>\nYou can't necessarily say that for sure, because I think a number of standard posix interfaces on macOS are implemented on top of lower-level Objective-C code, as one can often see in stack traces.  I remember at one point I traced exactly what function was causing this error in Sage, when checking for internet access. I don't remember exactly but I think it was something standard like `gethostbyname()`.\n\nBut I agree, it's especially annoying that the message is printed unconditionally, and worse that the `abort()` happens even in the case of false positives, which as you write are going to be far more common.  So setting this environment variable is the only logical choice.\n\nIn the odd case where some bizarre crash is happening on macOS, it should be understood that the case this is trying to prevent is a possibility.  This is just Apple aggressively making us aware of their bug (rather than just fixing the damn bug which you'd think with nearly a trillion dollars in their pocket they could do--this isn't rocket science).",
    "created_at": "2018-12-19T14:46:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401752",
    "user": "https://github.com/embray"
}
```

<a id='comment:36'>Comment 36:</a>
You can't necessarily say that for sure, because I think a number of standard posix interfaces on macOS are implemented on top of lower-level Objective-C code, as one can often see in stack traces.  I remember at one point I traced exactly what function was causing this error in Sage, when checking for internet access. I don't remember exactly but I think it was something standard like `gethostbyname()`.

But I agree, it's especially annoying that the message is printed unconditionally, and worse that the `abort()` happens even in the case of false positives, which as you write are going to be far more common.  So setting this environment variable is the only logical choice.

In the odd case where some bizarre crash is happening on macOS, it should be understood that the case this is trying to prevent is a possibility.  This is just Apple aggressively making us aware of their bug (rather than just fixing the damn bug which you'd think with nearly a trillion dollars in their pocket they could do--this isn't rocket science).



---

archive/issue_comments_401753.json:
```json
{
    "body": "Branch: **[u/jdemeyer/aborted_tests_on_macos_10_13_6](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/aborted_tests_on_macos_10_13_6)**",
    "created_at": "2018-12-19T16:11:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401753",
    "user": "https://github.com/jdemeyer"
}
```

Branch: **[u/jdemeyer/aborted_tests_on_macos_10_13_6](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/aborted_tests_on_macos_10_13_6)**



---

archive/issue_comments_401754.json:
```json
{
    "body": "Commit: **[688a288](https://github.com/sagemath/sagetrac-mirror/commit/688a288e16663fe2c4a881baa510ed797a46efa1)**",
    "created_at": "2018-12-19T16:12:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401754",
    "user": "https://github.com/jdemeyer"
}
```

Commit: **[688a288](https://github.com/sagemath/sagetrac-mirror/commit/688a288e16663fe2c4a881baa510ed797a46efa1)**



---

archive/issue_events_327956.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-12-19T16:12:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25921#event-327956"
}
```



---

archive/issue_comments_401755.json:
```json
{
    "body": "<a id='comment:38'>Comment 38:</a>\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/688a288e16663fe2c4a881baa510ed797a46efa1\">688a288</a></td><td><code>Set OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES</code></td></tr></table>\n",
    "created_at": "2018-12-19T16:12:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401755",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:38'>Comment 38:</a>
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/688a288e16663fe2c4a881baa510ed797a46efa1">688a288</a></td><td><code>Set OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES</code></td></tr></table>




---

archive/issue_comments_401756.json:
```json
{
    "body": "Author: **Jeroen Demeyer**",
    "created_at": "2018-12-19T16:12:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401756",
    "user": "https://github.com/jdemeyer"
}
```

Author: **Jeroen Demeyer**



---

archive/issue_comments_401757.json:
```json
{
    "body": "<a id='comment:39'>Comment 39:</a>\nThis works for me.\n\nReplying to [@embray](#comment%3A33):\n> Should probably also set it in `sage.env`.\n\nCan you explain why?",
    "created_at": "2018-12-19T19:08:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401757",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:39'>Comment 39:</a>
This works for me.

Replying to [@embray](#comment%3A33):
> Should probably also set it in `sage.env`.

Can you explain why?



---

archive/issue_comments_401758.json:
```json
{
    "body": "<a id='comment:40'>Comment 40:</a>\nAlthough not yet fully operative I want the sage package to eventually be able to work correctly with some sensible defaults without having to source `sage-env`, so the package itself should also put this in the environment if it's needed for some of its functionality to work properly.",
    "created_at": "2018-12-20T13:51:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401758",
    "user": "https://github.com/embray"
}
```

<a id='comment:40'>Comment 40:</a>
Although not yet fully operative I want the sage package to eventually be able to work correctly with some sensible defaults without having to source `sage-env`, so the package itself should also put this in the environment if it's needed for some of its functionality to work properly.



---

archive/issue_comments_401759.json:
```json
{
    "body": "<a id='comment:41'>Comment 41:</a>\nThat makes sense to me. Jeroen, any comments?",
    "created_at": "2018-12-20T16:22:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401759",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:41'>Comment 41:</a>
That makes sense to me. Jeroen, any comments?



---

archive/issue_comments_401760.json:
```json
{
    "body": "<a id='comment:42'>Comment 42:</a>\nReplying to [@embray](#comment%3A40):\n> Although not yet fully operative I want the sage package to eventually be able to work correctly with some sensible defaults without having to source `sage-env`, so the package itself should also put this in the environment if it's needed for some of its functionality to work properly.\n\nMaybe, but not in this ticket. What you propose should fit in a larger discussion about how to handle environment variables. It doesn't make sense to me to special-case this one environment variable `OBJC_DISABLE_INITIALIZE_FORK_SAFETY`.",
    "created_at": "2018-12-20T17:53:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401760",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:42'>Comment 42:</a>
Replying to [@embray](#comment%3A40):
> Although not yet fully operative I want the sage package to eventually be able to work correctly with some sensible defaults without having to source `sage-env`, so the package itself should also put this in the environment if it's needed for some of its functionality to work properly.

Maybe, but not in this ticket. What you propose should fit in a larger discussion about how to handle environment variables. It doesn't make sense to me to special-case this one environment variable `OBJC_DISABLE_INITIALIZE_FORK_SAFETY`.



---

archive/issue_comments_401761.json:
```json
{
    "body": "<a id='comment:43'>Comment 43:</a>\nThis fixes the problem and I think it should be merged quickly; enhancements to `sage.env` should be on another ticket. Separate topics should be on separate tickets unless they are inextricably entwined, and I don't think that's the case for `sage.env`.",
    "created_at": "2018-12-20T19:20:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401761",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:43'>Comment 43:</a>
This fixes the problem and I think it should be merged quickly; enhancements to `sage.env` should be on another ticket. Separate topics should be on separate tickets unless they are inextricably entwined, and I don't think that's the case for `sage.env`.



---

archive/issue_events_327957.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2018-12-20T19:20:34Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25921#event-327957"
}
```



---

archive/issue_events_327958.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2018-12-20T19:20:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25921#event-327958"
}
```



---

archive/issue_comments_401762.json:
```json
{
    "body": "Reviewer: **John Palmieri**",
    "created_at": "2018-12-20T19:20:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401762",
    "user": "https://github.com/jhpalmieri"
}
```

Reviewer: **John Palmieri**



---

archive/issue_events_327959.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-12-23T23:41:06Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25921#event-327959"
}
```



---

archive/issue_events_327960.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "695e737fe67ed01d8425e6c907a6b1a714825607",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2018-12-23T23:41:06Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25921#event-327960"
}
```



---

archive/issue_comments_401763.json:
```json
{
    "body": "Changed branch from **[u/jdemeyer/aborted_tests_on_macos_10_13_6](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/aborted_tests_on_macos_10_13_6)** to **[688a288](https://github.com/sagemath/sagetrac-mirror/commit/688a288e16663fe2c4a881baa510ed797a46efa1)**",
    "created_at": "2018-12-23T23:41:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401763",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/jdemeyer/aborted_tests_on_macos_10_13_6](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/aborted_tests_on_macos_10_13_6)** to **[688a288](https://github.com/sagemath/sagetrac-mirror/commit/688a288e16663fe2c4a881baa510ed797a46efa1)**



---

archive/issue_events_327961.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-12-28T14:06:38Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "milestone_number": null,
    "milestone_title": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25921#event-327961"
}
```



---

archive/issue_events_327962.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-12-28T14:06:38Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "milestone_number": null,
    "milestone_title": "sage-8.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25921#event-327962"
}
```



---

archive/issue_comments_401764.json:
```json
{
    "body": "<a id='comment:45'>Comment 45:</a>\nThis tickets were closed as fixed after the Sage 8.5 release.",
    "created_at": "2018-12-28T14:06:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25921",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25921#issuecomment-401764",
    "user": "https://github.com/embray"
}
```

<a id='comment:45'>Comment 45:</a>
This tickets were closed as fixed after the Sage 8.5 release.
