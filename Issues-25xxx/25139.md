# Issue 25139: Add sage-spkg-uninstall script and use it when possible to remove packages

archive/issues_024902.json:
```json
{
    "body": "This is a cleaned up an simplified version of a *portion* of the work originally done in #22510.  This ticket adds a few new features that I felt were fundamentally inseparable (in part due to peculiarities of specific packages meaning that uninstallation could not be supported without some additional work).\n\n1. Adds a new script `sage-spkg-uninstall` which is invoked like `sage-spkg-uninstall <pkgname>` to uninstall a single package from `$SAGE_LOCAL` (this also allows uninstalling standard packages, though we might prefer to prevent that by default).  This script handles all matters of package uninstallation, including the final step of removing the package stamp file from  under `$SAGE_SPKG_INST`.  There are two different ways a package can be uninstalled:\n\n\n   a. \"Modern\" uninstallation: if a package has staged-installation support (i.e. has been updated to support #22509), this means that its stamp file contains a manifest of *all* files installed by that package (minus any files created by the package's `spkg-postinst` script). Therefore \"modern\" uninstallation consists mainly of looping over those files and removing them from `$SAGE_LOCAL`.  Any directories left empty by this process are also removed.\n\n\n   b. \"Legacy\" uinstallation: many (though not all) packages have in their `spkg-install` script some code to perform an ad-hoc uninstallation of any previous versions of the package before installing the new version (this was sometimes necessary in particular for old versions of libraries).  Support for this functionality is retained in order to properly support upgrades from older versions of Sage, where most packages may not support \"modern\" uninstallation.\n\n      However, in order to support this properly, the legacy uninstall code for those packages should be moved out of their `spkg-install` scripts and into a new `spkg-legacy-uninstall` script which is called by `sage-spkg-uninstall` for these packages.  This ticket includes one such example for demonstration purposes, adding an `spkg-legacy-uninstall` for `brial`.\n\n      In the future we may be able to deprecate, and ultimately remove these scripts.  In the meantime all existing packages with uninstall code in their `spkg-install` should be updated (see followup ticket #25140).\n\n2. Another feature this adds which is handled by `sage-spkg-uninstall`, but with some required support from the `sage-spkg` script, are per-package `spkg-prerm` and `spkg-postrm` scripts that are run just before and just after a package is uninstalled.\n\n   This is needed in particular for some packages (namely `pkgconf` and `widgetsnbextension`) which really can't be removed properly without some pre/post-removal steps.  Other packages will need this as well, but less crucially.  I haven't found a specific use case yet for `spkg-postrm`, but it's included for symmetry.\n\n   Because these scripts are run during package uninstallation--of packages that are already installed--the scripts themselves need to be installed *somewhere* (e.g. Debian supports a similar feature, and keeps the scripts under `/var/lib/dpkg` somewhere).  In this case a new path `SAGE_SPKG_SCRIPTS` is added under `$SAGE_LOCAL/var/lib/sage/scripts` by default.  Any package-specific `prerm` and `postrm` scripts are stored there.  After the package is uninstalled the scripts are removed as well.\n\n3. The Makefile is updated so that the `<pkgname>-clean` rules for most packages call `sage-spkg-uninstall`, so that the packages are really thoroughly cleaned (rather than just removing their stamp files). \n\nKeywords: uninstall\n\nBranch/Commit: 7a81e70eaebb7ec27f48614ab5232d7fccff4b74\n\nReviewer: Julian R\u00fcth\n\nAuthor: Erik Bray\n\nDependencies: #24645 #25039\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/25139\n\n",
    "closed_at": "2018-05-24T07:10:46Z",
    "created_at": "2018-04-10T17:11:12Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.3",
    "title": "Add sage-spkg-uninstall script and use it when possible to remove packages",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25139",
    "user": "https://github.com/embray"
}
```
This is a cleaned up an simplified version of a *portion* of the work originally done in #22510.  This ticket adds a few new features that I felt were fundamentally inseparable (in part due to peculiarities of specific packages meaning that uninstallation could not be supported without some additional work).

1. Adds a new script `sage-spkg-uninstall` which is invoked like `sage-spkg-uninstall <pkgname>` to uninstall a single package from `$SAGE_LOCAL` (this also allows uninstalling standard packages, though we might prefer to prevent that by default).  This script handles all matters of package uninstallation, including the final step of removing the package stamp file from  under `$SAGE_SPKG_INST`.  There are two different ways a package can be uninstalled:


   a. "Modern" uninstallation: if a package has staged-installation support (i.e. has been updated to support #22509), this means that its stamp file contains a manifest of *all* files installed by that package (minus any files created by the package's `spkg-postinst` script). Therefore "modern" uninstallation consists mainly of looping over those files and removing them from `$SAGE_LOCAL`.  Any directories left empty by this process are also removed.


   b. "Legacy" uinstallation: many (though not all) packages have in their `spkg-install` script some code to perform an ad-hoc uninstallation of any previous versions of the package before installing the new version (this was sometimes necessary in particular for old versions of libraries).  Support for this functionality is retained in order to properly support upgrades from older versions of Sage, where most packages may not support "modern" uninstallation.

      However, in order to support this properly, the legacy uninstall code for those packages should be moved out of their `spkg-install` scripts and into a new `spkg-legacy-uninstall` script which is called by `sage-spkg-uninstall` for these packages.  This ticket includes one such example for demonstration purposes, adding an `spkg-legacy-uninstall` for `brial`.

      In the future we may be able to deprecate, and ultimately remove these scripts.  In the meantime all existing packages with uninstall code in their `spkg-install` should be updated (see followup ticket #25140).

2. Another feature this adds which is handled by `sage-spkg-uninstall`, but with some required support from the `sage-spkg` script, are per-package `spkg-prerm` and `spkg-postrm` scripts that are run just before and just after a package is uninstalled.

   This is needed in particular for some packages (namely `pkgconf` and `widgetsnbextension`) which really can't be removed properly without some pre/post-removal steps.  Other packages will need this as well, but less crucially.  I haven't found a specific use case yet for `spkg-postrm`, but it's included for symmetry.

   Because these scripts are run during package uninstallation--of packages that are already installed--the scripts themselves need to be installed *somewhere* (e.g. Debian supports a similar feature, and keeps the scripts under `/var/lib/dpkg` somewhere).  In this case a new path `SAGE_SPKG_SCRIPTS` is added under `$SAGE_LOCAL/var/lib/sage/scripts` by default.  Any package-specific `prerm` and `postrm` scripts are stored there.  After the package is uninstalled the scripts are removed as well.

3. The Makefile is updated so that the `<pkgname>-clean` rules for most packages call `sage-spkg-uninstall`, so that the packages are really thoroughly cleaned (rather than just removing their stamp files). 

Keywords: uninstall

Branch/Commit: 7a81e70eaebb7ec27f48614ab5232d7fccff4b74

Reviewer: Julian RÃ¼th

Author: Erik Bray

Dependencies: #24645 #25039

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/25139





---

archive/issue_comments_479303.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-04-10T17:43:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479303",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_479304.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -10,7 +10,7 @@\n \n       However, in order to support this properly, the legacy uninstall code for those packages should be moved out of their `spkg-install` scripts and into a new `spkg-legacy-uninstall` script which is called by `sage-spkg-uninstall` for these packages.  This ticket includes one such example for demonstration purposes, adding an `spkg-legacy-uninstall` for `brial`.\n \n-      In the future we may be able to deprecate, and ultimately remove these scripts.  In the meantime all existing packages with uninstall code in their `spkg-install` should be updated (see followup ticket #?????).\n+      In the future we may be able to deprecate, and ultimately remove these scripts.  In the meantime all existing packages with uninstall code in their `spkg-install` should be updated (see followup ticket #25140).\n \n 2. Another feature this adds which is handled by `sage-spkg-uninstall`, but with some required support from the `sage-spkg` script, are per-package `spkg-prerm` and `spkg-postrm` scripts that are run just before and just after a package is uninstalled.\n \n@@ -18,7 +18,7 @@\n \n    Because these scripts are run during package uninstallation--of packages that are already installed--the scripts themselves need to be installed *somewhere* (e.g. Debian supports a similar feature, and keeps the scripts under `/var/lib/dpkg` somewhere).  In this case a new path `SAGE_SPKG_SCRIPTS` is added under `$SAGE_LOCAL/var/lib/sage/scripts` by default.  Any package-specific `prerm` and `postrm` scripts are stored there.  After the package is uninstalled the scripts are removed as well.\n \n-3. The Makefile is updated so that the `<pkgname>-clean` rules for most packages call `sage-spkg-uninstall`, so that the packages are really thoroughly cleaned (rather than just removing their stamp files).\n+3. The Makefile is updated so that the `<pkgname>-clean` rules for most packages call `sage-spkg-uninstall`, so that the packages are really thoroughly cleaned (rather than just removing their stamp files). \n \n Author: Erik Bray\n \n``````\n",
    "created_at": "2018-04-10T17:48:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479304",
    "user": "https://github.com/embray"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -10,7 +10,7 @@
 
       However, in order to support this properly, the legacy uninstall code for those packages should be moved out of their `spkg-install` scripts and into a new `spkg-legacy-uninstall` script which is called by `sage-spkg-uninstall` for these packages.  This ticket includes one such example for demonstration purposes, adding an `spkg-legacy-uninstall` for `brial`.
 
-      In the future we may be able to deprecate, and ultimately remove these scripts.  In the meantime all existing packages with uninstall code in their `spkg-install` should be updated (see followup ticket #?????).
+      In the future we may be able to deprecate, and ultimately remove these scripts.  In the meantime all existing packages with uninstall code in their `spkg-install` should be updated (see followup ticket #25140).
 
 2. Another feature this adds which is handled by `sage-spkg-uninstall`, but with some required support from the `sage-spkg` script, are per-package `spkg-prerm` and `spkg-postrm` scripts that are run just before and just after a package is uninstalled.
 
@@ -18,7 +18,7 @@
 
    Because these scripts are run during package uninstallation--of packages that are already installed--the scripts themselves need to be installed *somewhere* (e.g. Debian supports a similar feature, and keeps the scripts under `/var/lib/dpkg` somewhere).  In this case a new path `SAGE_SPKG_SCRIPTS` is added under `$SAGE_LOCAL/var/lib/sage/scripts` by default.  Any package-specific `prerm` and `postrm` scripts are stored there.  After the package is uninstalled the scripts are removed as well.
 
-3. The Makefile is updated so that the `<pkgname>-clean` rules for most packages call `sage-spkg-uninstall`, so that the packages are really thoroughly cleaned (rather than just removing their stamp files).
+3. The Makefile is updated so that the `<pkgname>-clean` rules for most packages call `sage-spkg-uninstall`, so that the packages are really thoroughly cleaned (rather than just removing their stamp files). 
 
 Author: Erik Bray
 
``````




---

archive/issue_comments_479305.json:
```json
{
    "body": "<a id='comment:3'></a>* There is a `TODO:` in your changeset. Should that be resolved now?\n* I know you just copied code over in `build/pkgs/pkgconf/spkg-postinst` but shouldn't all return values be checked (or a `set -e` be set?)\n* Should we check the return value in `build/pkgs/widgetsnbextension/spkg-prerm`?\n* Why did you push the patch level in `build/pkgs/widgetsnbextension/package-version.txt`\n* Why did you create a \"docstring\" here and not just a comment?\n\n```\n+PKGS = pth.join(SAGE_ROOT, 'build', 'pkgs')\n+\"\"\"Directory where all spkg sources are found.\"\"\"\n```\n* `SAGE_SPKG_INST` is always set, isn't it? Maybe it should then just be an error here if it isn't instead of copying the default from somewhere else?\n\n```\n+    spkg_inst = pth.join(sage_local, 'var', 'lib', 'sage', 'installed')\n+    spkg_inst = os.environ.get('SAGE_SPKG_INST', spkg_inst)\n```\n  and similarly for `SAGE_SPKG_SCRIPTS`.\n* `postrm` should read `prerm` here I guess?\n\n```\n+    # Run the package's postrm script, if it exists\n+    # If an error occurs here we abort the uninstallation for now\n+    run_spkg_script(spkg_name, spkg_scripts, 'prerm', 'pre-uninstall')\n```",
    "created_at": "2018-04-10T23:16:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479305",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:3'></a>* There is a `TODO:` in your changeset. Should that be resolved now?
* I know you just copied code over in `build/pkgs/pkgconf/spkg-postinst` but shouldn't all return values be checked (or a `set -e` be set?)
* Should we check the return value in `build/pkgs/widgetsnbextension/spkg-prerm`?
* Why did you push the patch level in `build/pkgs/widgetsnbextension/package-version.txt`
* Why did you create a "docstring" here and not just a comment?

```
+PKGS = pth.join(SAGE_ROOT, 'build', 'pkgs')
+"""Directory where all spkg sources are found."""
```
* `SAGE_SPKG_INST` is always set, isn't it? Maybe it should then just be an error here if it isn't instead of copying the default from somewhere else?

```
+    spkg_inst = pth.join(sage_local, 'var', 'lib', 'sage', 'installed')
+    spkg_inst = os.environ.get('SAGE_SPKG_INST', spkg_inst)
```
  and similarly for `SAGE_SPKG_SCRIPTS`.
* `postrm` should read `prerm` here I guess?

```
+    # Run the package's postrm script, if it exists
+    # If an error occurs here we abort the uninstallation for now
+    run_spkg_script(spkg_name, spkg_scripts, 'prerm', 'pre-uninstall')
```



---

archive/issue_comments_479306.json:
```json
{
    "body": "<a id='comment:4'></a>Overall this looks good to me. It's great that we finally get a feature like that in Sage :)",
    "created_at": "2018-04-10T23:16:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479306",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:4'></a>Overall this looks good to me. It's great that we finally get a feature like that in Sage :)



---

archive/issue_comments_479307.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-04-10T23:17:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479307",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_479308.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Julian R\u00fcth\"",
    "created_at": "2018-04-10T23:17:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479308",
    "user": "https://github.com/saraedum"
}
```

Changing reviewer from "" to "Julian RÃ¼th"



---

archive/issue_comments_479309.json:
```json
{
    "body": "<a id='comment:6'></a>Thanks for having a look!\n\nReplying to [comment:3 saraedum]:\n> * There is a `TODO:` in your changeset. Should that be resolved now?\n\n\nI don't think that should be resolved now--the comment was just a note that it would be the correct spot, most likely, to start implementing such functionality.  Thanks for reminding me about that though.  There should be a follow-up ticket for it.\n\n\n\n> * I know you just copied code over in `build/pkgs/pkgconf/spkg-postinst` but shouldn't all return values be checked (or a `set -e` be set?)\n\n\nI agree, there should be some error checking there.  It could also use `sdh_install` from #25039 for the copy, which would take care of error checking.\n\n\n\n\n> * Should we check the return value in `build/pkgs/widgetsnbextension/spkg-prerm`?\n\n\nI'm not really sure it's necessary or desirable.  There are various reasons it *could* fail, such as if that action had already (whether or not for good reasons) been performed by the user, or if the installation was otherwise broken somehow.  In this case other things *might* break too, but at the very least you want to still allow the rest of the package uninstallation to proceed.\n\n\n\n\n> * Why did you push the patch level in `build/pkgs/widgetsnbextension/package-version.txt`\n \nThe `pre/postrm` scripts have to be *installed*, so that means a version bump is needed here to make sure the package is upgraded in order to install them.\n\n\n\n\n> * Why did you create a \"docstring\" here and not just a comment?\n> \n> ```\n> +PKGS = pth.join(SAGE_ROOT, 'build', 'pkgs')\n> +\"\"\"Directory where all spkg sources are found.\"\"\"\n> ```\n\nIt's standard syntax understood by Sphinx for documenting module-level variables and class attributes.  [Some people don't like it](https://trac.sagemath.org/ticket/24559#comment:24), apparently, but I'm personally quite partial to it for documenting variables, even in code that won't necessarily be processed by Sphinx.\n\n\n\n\n> * `SAGE_SPKG_INST` is always set, isn't it? Maybe it should then just be an error here if it isn't instead of copying the default from somewhere else?\n> \n> ```\n> +    spkg_inst = pth.join(sage_local, 'var', 'lib', 'sage', 'installed')\n> +    spkg_inst = os.environ.get('SAGE_SPKG_INST', spkg_inst)\n> ```\n>   and similarly for `SAGE_SPKG_SCRIPTS`.\n\nMaybe it's not necessary, but I wrote `sage-spkg-uninstall` such that it works without necessarily instantiating the full \"Sage environment\" (I don't like how many programs in Sage do rely on this).  In fact you can pass it the path to `$SAGE_LOCAL` as an optional argument (which is otherwise read out of the environment).  One thing I don't like about this is that we don't exactly have an easy-to-parse file providing the default values for various environment variables used by Sage and its tooling.  But that's something to resolve elsewhere...\n\n\n\n\n> * `postrm` should read `prerm` here I guess?\n> \n> ```\n> +    # Run the package's postrm script, if it exists\n> +    # If an error occurs here we abort the uninstallation for now\n> +    run_spkg_script(spkg_name, spkg_scripts, 'prerm', 'pre-uninstall')\n> ```\n\n\nYep. And since you pointed that out I also noticed some other fishy business going on at the bottom of the `modern_uninstall` function that it looks like I might have been sloppy about.",
    "created_at": "2018-04-11T13:04:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479309",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>Thanks for having a look!

Replying to [comment:3 saraedum]:
> * There is a `TODO:` in your changeset. Should that be resolved now?


I don't think that should be resolved now--the comment was just a note that it would be the correct spot, most likely, to start implementing such functionality.  Thanks for reminding me about that though.  There should be a follow-up ticket for it.



> * I know you just copied code over in `build/pkgs/pkgconf/spkg-postinst` but shouldn't all return values be checked (or a `set -e` be set?)


I agree, there should be some error checking there.  It could also use `sdh_install` from #25039 for the copy, which would take care of error checking.




> * Should we check the return value in `build/pkgs/widgetsnbextension/spkg-prerm`?


I'm not really sure it's necessary or desirable.  There are various reasons it *could* fail, such as if that action had already (whether or not for good reasons) been performed by the user, or if the installation was otherwise broken somehow.  In this case other things *might* break too, but at the very least you want to still allow the rest of the package uninstallation to proceed.




> * Why did you push the patch level in `build/pkgs/widgetsnbextension/package-version.txt`
 
The `pre/postrm` scripts have to be *installed*, so that means a version bump is needed here to make sure the package is upgraded in order to install them.




> * Why did you create a "docstring" here and not just a comment?
> 
> ```
> +PKGS = pth.join(SAGE_ROOT, 'build', 'pkgs')
> +"""Directory where all spkg sources are found."""
> ```

It's standard syntax understood by Sphinx for documenting module-level variables and class attributes.  [Some people don't like it](https://trac.sagemath.org/ticket/24559#comment:24), apparently, but I'm personally quite partial to it for documenting variables, even in code that won't necessarily be processed by Sphinx.




> * `SAGE_SPKG_INST` is always set, isn't it? Maybe it should then just be an error here if it isn't instead of copying the default from somewhere else?
> 
> ```
> +    spkg_inst = pth.join(sage_local, 'var', 'lib', 'sage', 'installed')
> +    spkg_inst = os.environ.get('SAGE_SPKG_INST', spkg_inst)
> ```
>   and similarly for `SAGE_SPKG_SCRIPTS`.

Maybe it's not necessary, but I wrote `sage-spkg-uninstall` such that it works without necessarily instantiating the full "Sage environment" (I don't like how many programs in Sage do rely on this).  In fact you can pass it the path to `$SAGE_LOCAL` as an optional argument (which is otherwise read out of the environment).  One thing I don't like about this is that we don't exactly have an easy-to-parse file providing the default values for various environment variables used by Sage and its tooling.  But that's something to resolve elsewhere...




> * `postrm` should read `prerm` here I guess?
> 
> ```
> +    # Run the package's postrm script, if it exists
> +    # If an error occurs here we abort the uninstallation for now
> +    run_spkg_script(spkg_name, spkg_scripts, 'prerm', 'pre-uninstall')
> ```


Yep. And since you pointed that out I also noticed some other fishy business going on at the bottom of the `modern_uninstall` function that it looks like I might have been sloppy about.



---

archive/issue_comments_479310.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,24 @@\n+This is a cleaned up an simplified version of a *portion* of the work originally done in #22510.  This ticket adds a few new features that I felt were fundamentally inseparable (in part due to peculiarities of specific packages meaning that uninstallation could not be supported without some additional work).\n \n+1. Adds a new script `sage-spkg-uninstall` which is invoked like `sage-spkg-uninstall <pkgname>` to uninstall a single package from `$SAGE_LOCAL` (this also allows uninstalling standard packages, though we might prefer to prevent that by default).  This script handles all matters of package uninstallation, including the final step of removing the package stamp file from  under `$SAGE_SPKG_INST`.  There are two different ways a package can be uninstalled:\n+\n+\n+   a. \"Modern\" uninstallation: if a package has staged-installation support (i.e. has been updated to support #22509), this means that its stamp file contains a manifest of *all* files installed by that package (minus any files created by the package's `spkg-postinst` script). Therefore \"modern\" uninstallation consists mainly of looping over those files and removing them from `$SAGE_LOCAL`.  Any directories left empty by this process are also removed.\n+\n+\n+   b. \"Legacy\" uinstallation: many (though not all) packages have in their `spkg-install` script some code to perform an ad-hoc uninstallation of any previous versions of the package before installing the new version (this was sometimes necessary in particular for old versions of libraries).  Support for this functionality is retained in order to properly support upgrades from older versions of Sage, where most packages may not support \"modern\" uninstallation.\n+\n+      However, in order to support this properly, the legacy uninstall code for those packages should be moved out of their `spkg-install` scripts and into a new `spkg-legacy-uninstall` script which is called by `sage-spkg-uninstall` for these packages.  This ticket includes one such example for demonstration purposes, adding an `spkg-legacy-uninstall` for `brial`.\n+\n+      In the future we may be able to deprecate, and ultimately remove these scripts.  In the meantime all existing packages with uninstall code in their `spkg-install` should be updated (see followup ticket #25140).\n+\n+2. Another feature this adds which is handled by `sage-spkg-uninstall`, but with some required support from the `sage-spkg` script, are per-package `spkg-prerm` and `spkg-postrm` scripts that are run just before and just after a package is uninstalled.\n+\n+   This is needed in particular for some packages (namely `pkgconf` and `widgetsnbextension`) which really can't be removed properly without some pre/post-removal steps.  Other packages will need this as well, but less crucially.  I haven't found a specific use case yet for `spkg-postrm`, but it's included for symmetry.\n+\n+   Because these scripts are run during package uninstallation--of packages that are already installed--the scripts themselves need to be installed *somewhere* (e.g. Debian supports a similar feature, and keeps the scripts under `/var/lib/dpkg` somewhere).  In this case a new path `SAGE_SPKG_SCRIPTS` is added under `$SAGE_LOCAL/var/lib/sage/scripts` by default.  Any package-specific `prerm` and `postrm` scripts are stored there.  After the package is uninstalled the scripts are removed as well.\n+\n+3. The Makefile is updated so that the `<pkgname>-clean` rules for most packages call `sage-spkg-uninstall`, so that the packages are really thoroughly cleaned (rather than just removing their stamp files). \n \n Author: Erik Bray\n \n``````\n",
    "created_at": "2018-04-11T13:04:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479310",
    "user": "https://github.com/embray"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,24 @@
+This is a cleaned up an simplified version of a *portion* of the work originally done in #22510.  This ticket adds a few new features that I felt were fundamentally inseparable (in part due to peculiarities of specific packages meaning that uninstallation could not be supported without some additional work).
 
+1. Adds a new script `sage-spkg-uninstall` which is invoked like `sage-spkg-uninstall <pkgname>` to uninstall a single package from `$SAGE_LOCAL` (this also allows uninstalling standard packages, though we might prefer to prevent that by default).  This script handles all matters of package uninstallation, including the final step of removing the package stamp file from  under `$SAGE_SPKG_INST`.  There are two different ways a package can be uninstalled:
+
+
+   a. "Modern" uninstallation: if a package has staged-installation support (i.e. has been updated to support #22509), this means that its stamp file contains a manifest of *all* files installed by that package (minus any files created by the package's `spkg-postinst` script). Therefore "modern" uninstallation consists mainly of looping over those files and removing them from `$SAGE_LOCAL`.  Any directories left empty by this process are also removed.
+
+
+   b. "Legacy" uinstallation: many (though not all) packages have in their `spkg-install` script some code to perform an ad-hoc uninstallation of any previous versions of the package before installing the new version (this was sometimes necessary in particular for old versions of libraries).  Support for this functionality is retained in order to properly support upgrades from older versions of Sage, where most packages may not support "modern" uninstallation.
+
+      However, in order to support this properly, the legacy uninstall code for those packages should be moved out of their `spkg-install` scripts and into a new `spkg-legacy-uninstall` script which is called by `sage-spkg-uninstall` for these packages.  This ticket includes one such example for demonstration purposes, adding an `spkg-legacy-uninstall` for `brial`.
+
+      In the future we may be able to deprecate, and ultimately remove these scripts.  In the meantime all existing packages with uninstall code in their `spkg-install` should be updated (see followup ticket #25140).
+
+2. Another feature this adds which is handled by `sage-spkg-uninstall`, but with some required support from the `sage-spkg` script, are per-package `spkg-prerm` and `spkg-postrm` scripts that are run just before and just after a package is uninstalled.
+
+   This is needed in particular for some packages (namely `pkgconf` and `widgetsnbextension`) which really can't be removed properly without some pre/post-removal steps.  Other packages will need this as well, but less crucially.  I haven't found a specific use case yet for `spkg-postrm`, but it's included for symmetry.
+
+   Because these scripts are run during package uninstallation--of packages that are already installed--the scripts themselves need to be installed *somewhere* (e.g. Debian supports a similar feature, and keeps the scripts under `/var/lib/dpkg` somewhere).  In this case a new path `SAGE_SPKG_SCRIPTS` is added under `$SAGE_LOCAL/var/lib/sage/scripts` by default.  Any package-specific `prerm` and `postrm` scripts are stored there.  After the package is uninstalled the scripts are removed as well.
+
+3. The Makefile is updated so that the `<pkgname>-clean` rules for most packages call `sage-spkg-uninstall`, so that the packages are really thoroughly cleaned (rather than just removing their stamp files). 
 
 Author: Erik Bray
 
``````




---

archive/issue_comments_479311.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2018-04-18T09:00:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479311",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_479312.json:
```json
{
    "body": "Changing commit from \"6184243794db7392581b602d120e8c060d7adf9a\" to \"20a57d430fd8bb9591dc47d4f8a317d95b23abf1\"",
    "created_at": "2018-04-18T09:00:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479312",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "6184243794db7392581b602d120e8c060d7adf9a" to "20a57d430fd8bb9591dc47d4f8a317d95b23abf1"



---

archive/issue_comments_479313.json:
```json
{
    "body": "<a id='comment:8'></a>Last 10 new commits:",
    "created_at": "2018-04-18T09:08:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479313",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>Last 10 new commits:



---

archive/issue_comments_479314.json:
```json
{
    "body": "Changing dependencies from \"#24645\" to \"#24645 #25039\"",
    "created_at": "2018-04-18T09:08:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479314",
    "user": "https://github.com/embray"
}
```

Changing dependencies from "#24645" to "#24645 #25039"



---

archive/issue_comments_479315.json:
```json
{
    "body": "Changing commit from \"20a57d430fd8bb9591dc47d4f8a317d95b23abf1\" to \"8470ebafa1b8a8e00b34409b2d14ec57843792e7\"",
    "created_at": "2018-04-18T09:37:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479315",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "20a57d430fd8bb9591dc47d4f8a317d95b23abf1" to "8470ebafa1b8a8e00b34409b2d14ec57843792e7"



---

archive/issue_comments_479316.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2018-04-18T09:37:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479316",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_479317.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-04-18T09:39:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479317",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_479318.json:
```json
{
    "body": "Changing commit from \"8470ebafa1b8a8e00b34409b2d14ec57843792e7\" to \"95ed45ec061424d4708e724c425565e48faa479e\"",
    "created_at": "2018-04-18T09:39:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479318",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "8470ebafa1b8a8e00b34409b2d14ec57843792e7" to "95ed45ec061424d4708e724c425565e48faa479e"



---

archive/issue_comments_479319.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-04-18T09:41:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479319",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_479320.json:
```json
{
    "body": "<a id='comment:11'></a>I believe I addressed all your comments, and made all the code updates I agreed were needed (especially cleaning up `sage_bootstrap.uninstall` a bit).  If you don't agree with any of my responses above we can still discuss that though.  I'm not too hard-set on any of the details of this.",
    "created_at": "2018-04-18T09:41:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479320",
    "user": "https://github.com/embray"
}
```

<a id='comment:11'></a>I believe I addressed all your comments, and made all the code updates I agreed were needed (especially cleaning up `sage_bootstrap.uninstall` a bit).  If you don't agree with any of my responses above we can still discuss that though.  I'm not too hard-set on any of the details of this.



---

archive/issue_comments_479321.json:
```json
{
    "body": "<a id='comment:12'></a>Though before anyone reviews this further they should probably look at #24645 first.",
    "created_at": "2018-04-18T09:42:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479321",
    "user": "https://github.com/embray"
}
```

<a id='comment:12'></a>Though before anyone reviews this further they should probably look at #24645 first.



---

archive/issue_comments_479322.json:
```json
{
    "body": "Changing commit from \"95ed45ec061424d4708e724c425565e48faa479e\" to \"d364c6c1bcb9d21778917337e2f71cd0baeb7f3e\"",
    "created_at": "2018-04-26T09:13:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479322",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "95ed45ec061424d4708e724c425565e48faa479e" to "d364c6c1bcb9d21778917337e2f71cd0baeb7f3e"



---

archive/issue_comments_479323.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2018-04-26T09:13:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479323",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_479324.json:
```json
{
    "body": "<a id='comment:14'></a>Something in the last patchbot build went awry with brial.  I'm not sure I understand the issue yet.",
    "created_at": "2018-04-26T09:16:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479324",
    "user": "https://github.com/embray"
}
```

<a id='comment:14'></a>Something in the last patchbot build went awry with brial.  I'm not sure I understand the issue yet.



---

archive/issue_comments_479325.json:
```json
{
    "body": "Changing commit from \"d364c6c1bcb9d21778917337e2f71cd0baeb7f3e\" to \"1c8fca3598b4978b0e5a28a391d7f5b4e39fbead\"",
    "created_at": "2018-04-26T10:05:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479325",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "d364c6c1bcb9d21778917337e2f71cd0baeb7f3e" to "1c8fca3598b4978b0e5a28a391d7f5b4e39fbead"



---

archive/issue_comments_479326.json:
```json
{
    "body": "<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2018-04-26T10:05:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479326",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_479327.json:
```json
{
    "body": "<a id='comment:16'></a>Ok, the issue is fixed in #24645.  The next patchbot build *should* be good but we'll see.",
    "created_at": "2018-04-26T10:07:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479327",
    "user": "https://github.com/embray"
}
```

<a id='comment:16'></a>Ok, the issue is fixed in #24645.  The next patchbot build *should* be good but we'll see.



---

archive/issue_events_063061.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-26T12:13:55Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "milestone": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25139#event-63061"
}
```



---

archive/issue_comments_479328.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-05-19T00:34:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479328",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_479329.json:
```json
{
    "body": "<a id='comment:18'></a>The patchbot still seems to be unhappy. I do not understand what's going on there\u2026",
    "created_at": "2018-05-19T00:34:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479329",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:18'></a>The patchbot still seems to be unhappy. I do not understand what's going on thereâ¦



---

archive/issue_comments_479330.json:
```json
{
    "body": "<a id='comment:19'></a>Looks like just a merge conflict, yet again.",
    "created_at": "2018-05-21T11:37:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479330",
    "user": "https://github.com/embray"
}
```

<a id='comment:19'></a>Looks like just a merge conflict, yet again.



---

archive/issue_comments_479331.json:
```json
{
    "body": "Changing commit from \"1c8fca3598b4978b0e5a28a391d7f5b4e39fbead\" to \"7a81e70eaebb7ec27f48614ab5232d7fccff4b74\"",
    "created_at": "2018-05-21T11:55:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479331",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "1c8fca3598b4978b0e5a28a391d7f5b4e39fbead" to "7a81e70eaebb7ec27f48614ab5232d7fccff4b74"



---

archive/issue_comments_479332.json:
```json
{
    "body": "<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2018-05-21T11:55:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479332",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_479333.json:
```json
{
    "body": "<a id='comment:21'></a>Rebased, and removed the stuff related with `widgetsnbextension` which as jdemeyer pointed out in #24646 should no longer be relevant.",
    "created_at": "2018-05-21T11:58:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479333",
    "user": "https://github.com/embray"
}
```

<a id='comment:21'></a>Rebased, and removed the stuff related with `widgetsnbextension` which as jdemeyer pointed out in #24646 should no longer be relevant.



---

archive/issue_comments_479334.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-05-21T13:10:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479334",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_479335.json:
```json
{
    "body": "<a id='comment:23'></a>Looks good to me. I have not tested this though. If you are confident that this works, feel free to set it to positive review.",
    "created_at": "2018-05-21T16:21:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479335",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:23'></a>Looks good to me. I have not tested this though. If you are confident that this works, feel free to set it to positive review.



---

archive/issue_comments_479336.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-05-21T17:37:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479336",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_479337.json:
```json
{
    "body": "<a id='comment:24'></a>Will be interesting to see what the buildbots do with it, especially OSX.  I expect it will be fine.",
    "created_at": "2018-05-21T17:37:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479337",
    "user": "https://github.com/embray"
}
```

<a id='comment:24'></a>Will be interesting to see what the buildbots do with it, especially OSX.  I expect it will be fine.



---

archive/issue_comments_479338.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-05-24T07:10:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479338",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_479339.json:
```json
{
    "body": "Changing branch from \"u/embray/build/spkg-uninstall/script\" to \"7a81e70eaebb7ec27f48614ab5232d7fccff4b74\"",
    "created_at": "2018-05-24T07:10:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25139#issuecomment-479339",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/embray/build/spkg-uninstall/script" to "7a81e70eaebb7ec27f48614ab5232d7fccff4b74"



---

archive/issue_events_063062.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-05-24T07:10:46Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/25139",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25139#event-63062"
}
```
