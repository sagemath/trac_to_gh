# Issue 25549: .pxd files should not use PY_MAJOR_VERSION compile-time variable

archive/issues_025312.json:
```json
{
    "body": "CC:  simonking @embray\n\n```\nsage: cython('''from sage.cpython.string cimport str_to_bytes''')\n---------------------------------------------------------------------------\nRuntimeError                              Traceback (most recent call last)\n<ipython-input-1-217de50fbb18> in <module>()\n----> 1 cython('''from sage.cpython.string cimport str_to_bytes''')\n\n/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/misc/lazy_import.pyx in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:3756)()\n    352             True\n    353         \"\"\"\n--> 354         return self.get_object()(*args, **kwds)\n    355 \n    356     def __repr__(self):\n\n/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/misc/cython.pyc in cython_compile(code, **kwds)\n   1009     with open(tmpfile,'w') as f:\n   1010         f.write(code)\n-> 1011     return cython_import_all(tmpfile, get_globals(), **kwds)\n\n/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/misc/cython.pyc in cython_import_all(filename, globals, **kwds)\n    899       code\n    900     \"\"\"\n--> 901     m = cython_import(filename, **kwds)\n    902     for k, x in iteritems(m.__dict__):\n    903         if k[0] != '_':\n\n/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/misc/cython.pyc in cython_import(filename, **kwds)\n    874     - the module that contains the compiled Cython code.\n    875     \"\"\"\n--> 876     name, build_dir = cython(filename, **kwds)\n    877 \n    878     oldpath = sys.path\n\n/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/misc/cython.pyc in cython(filename, verbose, compile_message, use_cache, create_local_c_file, annotate, sage_namespace, create_local_so_file)                                                                                                                                        \n    636                         You can fix your code by adding \"from {} cimport {}\".\n    637                         \"\"\".format(pxd, name))\n--> 638         raise RuntimeError(cython_messages.strip())\n    639 \n    640     if verbose >= 0:\n\nRuntimeError: Error compiling Cython file:\n------------------------------------------------------------\n...\n    # Missing from cpython.unicode in Cython 0.27.3\n    char* PyUnicode_AsUTF8(object s)\n\n\ncdef inline str char_to_str(const char* c, encoding=None, errors=None):\n    IF PY_MAJOR_VERSION <= 2:\n      ^\n------------------------------------------------------------\n\n/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/cpython/string.pxd:25:7: Compile-time name 'PY_MAJOR_VERSION' not defined\n\nError compiling Cython file:\n------------------------------------------------------------\n...\n        TypeError: expected bytes, list found\n    \"\"\"\n    if not isinstance(b, bytes):\n        raise TypeError(f\"expected bytes, {type(b).__name__} found\")\n\n    IF PY_MAJOR_VERSION <= 2:\n      ^\n------------------------------------------------------------\n\n/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/cpython/string.pxd:70:7: Compile-time name 'PY_MAJOR_VERSION' not defined\n\nError compiling Cython file:\n------------------------------------------------------------\n...\n        TypeError: expected str ... list found\n    \"\"\"\n    cdef const char* err\n    cdef const char* enc\n\n    IF PY_MAJOR_VERSION <= 2:\n      ^\n------------------------------------------------------------\n\n/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/cpython/string.pxd:106:7: Compile-time name 'PY_MAJOR_VERSION' not defined\n\n\nError compiling Cython file:\n------------------------------------------------------------\n...\nfrom sage.cpython.string cimport str_to_bytes^\n------------------------------------------------------------\n\n_home_jdemeyer__sage_temp_sage4_21832_tmp_mx5xCy_pyx_0.pyx:1:0: 'sage/cpython/string/str_to_bytes.pxd' not found\n```\n\nSince the Cython code is almost C anyway, the easiest solution is probably to implement it actually in C (replacing the `IF` by `#if`).\n\nIssue created by migration from https://trac.sagemath.org/ticket/25549\n\n",
    "closed_at": "2018-06-17T22:15:16Z",
    "created_at": "2018-06-09T12:54:28Z",
    "labels": [
        "component: cython",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.3",
    "title": ".pxd files should not use PY_MAJOR_VERSION compile-time variable",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25549",
    "user": "https://github.com/jdemeyer"
}
```
CC:  simonking @embray

```
sage: cython('''from sage.cpython.string cimport str_to_bytes''')
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
<ipython-input-1-217de50fbb18> in <module>()
----> 1 cython('''from sage.cpython.string cimport str_to_bytes''')

/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/misc/lazy_import.pyx in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:3756)()
    352             True
    353         """
--> 354         return self.get_object()(*args, **kwds)
    355 
    356     def __repr__(self):

/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/misc/cython.pyc in cython_compile(code, **kwds)
   1009     with open(tmpfile,'w') as f:
   1010         f.write(code)
-> 1011     return cython_import_all(tmpfile, get_globals(), **kwds)

/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/misc/cython.pyc in cython_import_all(filename, globals, **kwds)
    899       code
    900     """
--> 901     m = cython_import(filename, **kwds)
    902     for k, x in iteritems(m.__dict__):
    903         if k[0] != '_':

/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/misc/cython.pyc in cython_import(filename, **kwds)
    874     - the module that contains the compiled Cython code.
    875     """
--> 876     name, build_dir = cython(filename, **kwds)
    877 
    878     oldpath = sys.path

/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/misc/cython.pyc in cython(filename, verbose, compile_message, use_cache, create_local_c_file, annotate, sage_namespace, create_local_so_file)                                                                                                                                        
    636                         You can fix your code by adding "from {} cimport {}".
    637                         """.format(pxd, name))
--> 638         raise RuntimeError(cython_messages.strip())
    639 
    640     if verbose >= 0:

RuntimeError: Error compiling Cython file:
------------------------------------------------------------
...
    # Missing from cpython.unicode in Cython 0.27.3
    char* PyUnicode_AsUTF8(object s)


cdef inline str char_to_str(const char* c, encoding=None, errors=None):
    IF PY_MAJOR_VERSION <= 2:
      ^
------------------------------------------------------------

/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/cpython/string.pxd:25:7: Compile-time name 'PY_MAJOR_VERSION' not defined

Error compiling Cython file:
------------------------------------------------------------
...
        TypeError: expected bytes, list found
    """
    if not isinstance(b, bytes):
        raise TypeError(f"expected bytes, {type(b).__name__} found")

    IF PY_MAJOR_VERSION <= 2:
      ^
------------------------------------------------------------

/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/cpython/string.pxd:70:7: Compile-time name 'PY_MAJOR_VERSION' not defined

Error compiling Cython file:
------------------------------------------------------------
...
        TypeError: expected str ... list found
    """
    cdef const char* err
    cdef const char* enc

    IF PY_MAJOR_VERSION <= 2:
      ^
------------------------------------------------------------

/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/cpython/string.pxd:106:7: Compile-time name 'PY_MAJOR_VERSION' not defined


Error compiling Cython file:
------------------------------------------------------------
...
from sage.cpython.string cimport str_to_bytes^
------------------------------------------------------------

_home_jdemeyer__sage_temp_sage4_21832_tmp_mx5xCy_pyx_0.pyx:1:0: 'sage/cpython/string/str_to_bytes.pxd' not found
```

Since the Cython code is almost C anyway, the easiest solution is probably to implement it actually in C (replacing the `IF` by `#if`).

Issue created by migration from https://trac.sagemath.org/ticket/25549





---

archive/issue_comments_356461.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-06-11T09:39:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25549#issuecomment-356461",
    "user": "https://github.com/jdemeyer"
}
```

New commits:



---

archive/issue_comments_356462.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-06-11T09:39:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25549#issuecomment-356462",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_356463.json:
```json
{
    "body": "What is the rationale for this:\n\n```diff\n cpdef inline str bytes_to_str(b, encoding=None, errors=None):\n@@ -64,14 +51,13 @@ cpdef inline str bytes_to_str(b, encoding=None, errors=None):\n         ...\n         TypeError: expected bytes, list found\n     \"\"\"\n-    if not isinstance(b, bytes):\n+    if type(b) is not bytes:\n         raise TypeError(f\"expected bytes, {type(b).__name__} found\")\n }}}\nThat's to say, why don't you allow sub-types of `bytes`?",
    "created_at": "2018-06-15T15:06:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25549#issuecomment-356463",
    "user": "https://github.com/simon-king-jena"
}
```

What is the rationale for this:

```diff
 cpdef inline str bytes_to_str(b, encoding=None, errors=None):
@@ -64,14 +51,13 @@ cpdef inline str bytes_to_str(b, encoding=None, errors=None):
         ...
         TypeError: expected bytes, list found
     """
-    if not isinstance(b, bytes):
+    if type(b) is not bytes:
         raise TypeError(f"expected bytes, {type(b).__name__} found")
 }}}
That's to say, why don't you allow sub-types of `bytes`?



---

archive/issue_comments_356464.json:
```json
{
    "body": "Replying to [comment:4 SimonKing]:\n> That's to say, why don't you allow sub-types of `bytes`?\n\n\nMainly to be on the safe side. I have no idea what the C API does with subclasses of `bytes`.\n\nWhenever a real use case for `bytes` subclasses comes up, we can always revisit this.",
    "created_at": "2018-06-15T15:18:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25549#issuecomment-356464",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:4 SimonKing]:
> That's to say, why don't you allow sub-types of `bytes`?


Mainly to be on the safe side. I have no idea what the C API does with subclasses of `bytes`.

Whenever a real use case for `bytes` subclasses comes up, we can always revisit this.



---

archive/issue_comments_356465.json:
```json
{
    "body": "Replying to [comment:5 jdemeyer]:\n> Replying to [comment:4 SimonKing]:\n> > That's to say, why don't you allow sub-types of `bytes`?\n\n> \n> Mainly to be on the safe side. I have no idea what the C API does with subclasses of `bytes`.\n> \n> Whenever a real use case for `bytes` subclasses comes up, we can always revisit this.\n\n\nOK.\n\nApart from that, the code looks fine to me, all tests pass, and you added a test that shows that the bug is fixed.",
    "created_at": "2018-06-15T15:22:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25549#issuecomment-356465",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:5 jdemeyer]:
> Replying to [comment:4 SimonKing]:
> > That's to say, why don't you allow sub-types of `bytes`?

> 
> Mainly to be on the safe side. I have no idea what the C API does with subclasses of `bytes`.
> 
> Whenever a real use case for `bytes` subclasses comes up, we can always revisit this.


OK.

Apart from that, the code looks fine to me, all tests pass, and you added a test that shows that the bug is fixed.



---

archive/issue_comments_356466.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-06-15T15:22:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25549#issuecomment-356466",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_064047.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-06-17T22:15:16Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/25549",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25549#event-64047"
}
```



---

archive/issue_comments_356467.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-06-17T22:15:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25549#issuecomment-356467",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_356468.json:
```json
{
    "body": "I guess I don't mind, but what even is the use case for this:\n\n```\ncython('''from sage.cpython.string cimport str_to_bytes''')\n```\n\n?\n\nIMO `str_to_bytes()` is just a convenience utility for use within Sage, and not otherwise.  It's very easy to implement similar wrappers for one's own purposes.",
    "created_at": "2018-06-20T09:43:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25549#issuecomment-356468",
    "user": "https://github.com/embray"
}
```

I guess I don't mind, but what even is the use case for this:

```
cython('''from sage.cpython.string cimport str_to_bytes''')
```

?

IMO `str_to_bytes()` is just a convenience utility for use within Sage, and not otherwise.  It's very easy to implement similar wrappers for one's own purposes.



---

archive/issue_comments_356469.json:
```json
{
    "body": "Or for that matter, what's wrong with just documenting \"so and so requires the following compile-time variables to be defined\"?",
    "created_at": "2018-06-20T09:44:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25549#issuecomment-356469",
    "user": "https://github.com/embray"
}
```

Or for that matter, what's wrong with just documenting "so and so requires the following compile-time variables to be defined"?



---

archive/issue_comments_356470.json:
```json
{
    "body": "On the third hand, I think it's common enough, especially writing code that is Python 2/3-compatible, to want to have the Python version as a compile-time variable, so maybe Cython really ought to provide this by default...",
    "created_at": "2018-06-20T09:45:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25549#issuecomment-356470",
    "user": "https://github.com/embray"
}
```

On the third hand, I think it's common enough, especially writing code that is Python 2/3-compatible, to want to have the Python version as a compile-time variable, so maybe Cython really ought to provide this by default...



---

archive/issue_comments_356471.json:
```json
{
    "body": "Replying to [comment:8 embray]:\n> I guess I don't mind, but what even is the use case for this:\n> \n> \n> ```\n> cython('''from sage.cpython.string cimport str_to_bytes''')\n> ```\n\n\nThird-party code already using Sage that wants to be Python 2/3 compatible.",
    "created_at": "2018-06-20T09:57:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25549#issuecomment-356471",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:8 embray]:
> I guess I don't mind, but what even is the use case for this:
> 
> 
> ```
> cython('''from sage.cpython.string cimport str_to_bytes''')
> ```


Third-party code already using Sage that wants to be Python 2/3 compatible.



---

archive/issue_comments_356472.json:
```json
{
    "body": "Replying to [comment:10 embray]:\n> On the third hand, I think it's common enough, especially writing code that is Python 2/3-compatible, to want to have the Python version as a compile-time variable, so maybe Cython really ought to provide this by default...\n\n\nThis may be. However, Cython currently doesn't provide it.\n\nIn fact I did try to use `from sage.cpython.string cimport str_to_bytes` in a third-party package for Sage. So, the reason for this ticket was an actual use case.",
    "created_at": "2018-06-20T10:07:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25549#issuecomment-356472",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:10 embray]:
> On the third hand, I think it's common enough, especially writing code that is Python 2/3-compatible, to want to have the Python version as a compile-time variable, so maybe Cython really ought to provide this by default...


This may be. However, Cython currently doesn't provide it.

In fact I did try to use `from sage.cpython.string cimport str_to_bytes` in a third-party package for Sage. So, the reason for this ticket was an actual use case.



---

archive/issue_comments_356473.json:
```json
{
    "body": "That's fine.  It just sucks that in order to write such code in a pxd file it's...basically impossible unless you move it into a pure C file.\n\nWild-haired idea: allow some directives in Cython files to provide compile-time variables, with short `eval`-able expressions providing their values, perhaps with a few default imports provided.  So one can write `# cython: <something something> PY_MAJOR_VERSION=sys.version_info[0]` and have that variable provided to the Cython compiler automatically.\n\nNot sure how that would work when compiling modules with functions imported from .pxd files, if it should even work at all.",
    "created_at": "2018-06-20T10:18:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25549#issuecomment-356473",
    "user": "https://github.com/embray"
}
```

That's fine.  It just sucks that in order to write such code in a pxd file it's...basically impossible unless you move it into a pure C file.

Wild-haired idea: allow some directives in Cython files to provide compile-time variables, with short `eval`-able expressions providing their values, perhaps with a few default imports provided.  So one can write `# cython: <something something> PY_MAJOR_VERSION=sys.version_info[0]` and have that variable provided to the Cython compiler automatically.

Not sure how that would work when compiling modules with functions imported from .pxd files, if it should even work at all.



---

archive/issue_comments_356474.json:
```json
{
    "body": "Replying to [comment:10 embray]:\n> On the third hand, I think it's common enough, especially writing code that is Python 2/3-compatible, to want to have the Python version as a compile-time variable\n\n\nI'm not entirely convinced here. In most cases, you can write Python 2/3 compatible Cython code *without* needing the `PY_MAJOR_VERSION` compile-time variable.",
    "created_at": "2018-06-20T10:23:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25549#issuecomment-356474",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:10 embray]:
> On the third hand, I think it's common enough, especially writing code that is Python 2/3-compatible, to want to have the Python version as a compile-time variable


I'm not entirely convinced here. In most cases, you can write Python 2/3 compatible Cython code *without* needing the `PY_MAJOR_VERSION` compile-time variable.



---

archive/issue_comments_356475.json:
```json
{
    "body": "True, but I think this demonstrates that there's a case for it.  You can also write such code with normal `if` statements as well, but I think it goes without saying that it's better to compile away such branches if possible.",
    "created_at": "2018-06-20T12:22:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25549#issuecomment-356475",
    "user": "https://github.com/embray"
}
```

True, but I think this demonstrates that there's a case for it.  You can also write such code with normal `if` statements as well, but I think it goes without saying that it's better to compile away such branches if possible.
