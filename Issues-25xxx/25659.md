# Issue 25659: make BrauerAlgebra faster

archive/issues_025422.json:
```json
{
    "body": "Using the fast iterator from perfect matchings, we get a nice speedup for the Brauer algebra:\n\n```\nsage: %timeit len([SetPartition(p) for p in da.brauer_diagrams(6)])\n1 loop, best of 3: 6.69 s per loop\n```\n\n```\nsage: %timeit len([SetPartition(p) for p in da.brauer_diagrams(6)])\n1 loop, best of 3: 180 ms per loop\n```\n\nCC:  @alauve @tscrim @zabrocki\n\nReviewer: Travis Scrimshaw, Martin Rubey\n\nAuthor: Martin Rubey, Travis Scrimshaw\n\nBranch: ef607379694c9394a7d4b90b95aadc6db3782830\n\nDependencies: #25462 #26111\n\nCommit: ef607379694c9394a7d4b90b95aadc6db3782830\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/25659\n\n",
    "closed_at": "2018-09-02T09:37:01Z",
    "created_at": "2018-06-25T09:34:30Z",
    "labels": [
        "component: combinatorics"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.4",
    "title": "make BrauerAlgebra faster",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25659",
    "user": "https://github.com/mantepse"
}
```
Using the fast iterator from perfect matchings, we get a nice speedup for the Brauer algebra:

```
sage: %timeit len([SetPartition(p) for p in da.brauer_diagrams(6)])
1 loop, best of 3: 6.69 s per loop
```

```
sage: %timeit len([SetPartition(p) for p in da.brauer_diagrams(6)])
1 loop, best of 3: 180 ms per loop
```

CC:  @alauve @tscrim @zabrocki

Reviewer: Travis Scrimshaw, Martin Rubey

Author: Martin Rubey, Travis Scrimshaw

Branch: ef607379694c9394a7d4b90b95aadc6db3782830

Dependencies: #25462 #26111

Commit: ef607379694c9394a7d4b90b95aadc6db3782830

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/25659





---

archive/issue_comments_357967.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to combinatorics.",
    "created_at": "2018-06-25T11:12:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-357967",
    "user": "https://github.com/mantepse"
}
```

Changing component from PLEASE CHANGE to combinatorics.



---

archive/issue_comments_357968.json:
```json
{
    "body": "<a id='comment:2'></a>Last 10 new commits:",
    "created_at": "2018-06-25T11:12:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-357968",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:2'></a>Last 10 new commits:



---

archive/issue_comments_357969.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-06-25T11:12:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-357969",
    "user": "https://github.com/mantepse"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_357970.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2018-06-25T11:12:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-357970",
    "user": "https://github.com/mantepse"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_357971.json:
```json
{
    "body": "<a id='comment:4'></a>Quick comments (I will comment on #25462 either later this week or next week since I am at FPSAC this week):\n\n- It seems like the `iter_aux` should be pulled out as a separate method (maybe even function?) of `PerfectMatchings` and called directly by the Brauer diagrams iterator (it makes no sense to create the temporary element object).\n\n- When checking going to the orbit basis, if you are not going to use `an_element` (which I still recommend using as it should not be machine dependent), then at least use a sum of 2 or more basis elements with at least one coefficient as that is a better test.\n\n- Bikeshedding again on the condensed output (as before, you can ignore, but I still will mention it):\n  {{{#!diff\n         sage: [SetPartition(p) for p in da.brauer_diagrams(5/2)]\n-        [{{-3, 3}, {-2, 1}, {-1, 2}}, {{-3, 3}, {-2, 2}, {-1, 1}}, {{-3, 3}, {-2, -1}, {1, 2}}]\n+        [{{-3, 3}, {-2, -1}, {1, 2}},\n+         {{-3, 3}, {-2, 2}, {-1, 1}},\n+         {{-3, 3}, {-2, 1}, {-1, 2}}]\n  }}}\n\nOtherwise LGTM (modulo #25462) and is quite a speedup. I do wonder if `_iterator_part` did not return `Set` objects, what the speed difference would be, but we can address that on a later ticket.",
    "created_at": "2018-07-17T12:06:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-357971",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:4'></a>Quick comments (I will comment on #25462 either later this week or next week since I am at FPSAC this week):

- It seems like the `iter_aux` should be pulled out as a separate method (maybe even function?) of `PerfectMatchings` and called directly by the Brauer diagrams iterator (it makes no sense to create the temporary element object).

- When checking going to the orbit basis, if you are not going to use `an_element` (which I still recommend using as it should not be machine dependent), then at least use a sum of 2 or more basis elements with at least one coefficient as that is a better test.

- Bikeshedding again on the condensed output (as before, you can ignore, but I still will mention it):
  {{{#!diff
         sage: [SetPartition(p) for p in da.brauer_diagrams(5/2)]
-        [{{-3, 3}, {-2, 1}, {-1, 2}}, {{-3, 3}, {-2, 2}, {-1, 1}}, {{-3, 3}, {-2, -1}, {1, 2}}]
+        [{{-3, 3}, {-2, -1}, {1, 2}},
+         {{-3, 3}, {-2, 2}, {-1, 1}},
+         {{-3, 3}, {-2, 1}, {-1, 2}}]
  }}}

Otherwise LGTM (modulo #25462) and is quite a speedup. I do wonder if `_iterator_part` did not return `Set` objects, what the speed difference would be, but we can address that on a later ticket.



---

archive/issue_comments_357972.json:
```json
{
    "body": "<a id='comment:5'></a>> - It seems like the `iter_aux` should be pulled out as a separate method (maybe even function?) of `PerfectMatchings` and called directly by the Brauer diagrams iterator (it makes no sense to create the temporary element object).\n\n\nas for #25462: please provide a name, so there is at least some uniformity across sage.  And again, since it is not unlikely that one does several computations in the same (Brauer) algebra, it might make more sense to use `.list()`, which caches the result.",
    "created_at": "2018-07-17T14:46:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-357972",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:5'></a>> - It seems like the `iter_aux` should be pulled out as a separate method (maybe even function?) of `PerfectMatchings` and called directly by the Brauer diagrams iterator (it makes no sense to create the temporary element object).


as for #25462: please provide a name, so there is at least some uniformity across sage.  And again, since it is not unlikely that one does several computations in the same (Brauer) algebra, it might make more sense to use `.list()`, which caches the result.



---

archive/issue_comments_357973.json:
```json
{
    "body": "<a id='comment:6'></a>I would probably call it `_iterator`, but its hidden. So as long as it locally makes sense, I think it is fine. Currently, we don't really have many such functions/methods, so there is not really a danger of non-uniformity.",
    "created_at": "2018-07-18T03:22:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-357973",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:6'></a>I would probably call it `_iterator`, but its hidden. So as long as it locally makes sense, I think it is fine. Currently, we don't really have many such functions/methods, so there is not really a danger of non-uniformity.



---

archive/issue_comments_357974.json:
```json
{
    "body": "<a id='comment:7'></a>If they are using the same Brauer algebra, you should cache the result of `basis()`. I don't see what the iterator returning the raw Python objects (i.e., not an instance of the `Element` class) has to do with caching via `.list()`.",
    "created_at": "2018-07-18T03:24:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-357974",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:7'></a>If they are using the same Brauer algebra, you should cache the result of `basis()`. I don't see what the iterator returning the raw Python objects (i.e., not an instance of the `Element` class) has to do with caching via `.list()`.



---

archive/issue_comments_357975.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2018-08-13T12:19:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-357975",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_357976.json:
```json
{
    "body": "<a id='comment:9'></a>I merged and rebased, ready for review! (after this ticket, I'll do #25662)",
    "created_at": "2018-08-13T12:31:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-357976",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:9'></a>I merged and rebased, ready for review! (after this ticket, I'll do #25662)



---

archive/issue_comments_357977.json:
```json
{
    "body": "<a id='comment:10'></a>You should compare this against #25462. Another comparison should be done potentially replacing iteration over `SetPartitions(X)` with the dedicated iterator that does not create full elements of `SetPartitions(X)` (I probably should have done this swap on #25462...).\n\nFrom looking at the `PerfectMatchings.__iter__`, that looks like it could be make into a simple backtracking algorithm and be really ameable to cythonization as an iterator object (so a pure `cdef` implementation).",
    "created_at": "2018-08-13T12:40:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-357977",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:10'></a>You should compare this against #25462. Another comparison should be done potentially replacing iteration over `SetPartitions(X)` with the dedicated iterator that does not create full elements of `SetPartitions(X)` (I probably should have done this swap on #25462...).

From looking at the `PerfectMatchings.__iter__`, that looks like it could be make into a simple backtracking algorithm and be really ameable to cythonization as an iterator object (so a pure `cdef` implementation).



---

archive/issue_comments_357978.json:
```json
{
    "body": "<a id='comment:11'></a>The iterator for perfect matchings is almost certainly not best possible (given python's aversion against recursion).  Do you need a better one?  It might be good to compare a cythonized version with https://stackoverflow.com/a/13020502/4680581",
    "created_at": "2018-08-13T12:59:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-357978",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:11'></a>The iterator for perfect matchings is almost certainly not best possible (given python's aversion against recursion).  Do you need a better one?  It might be good to compare a cythonized version with https://stackoverflow.com/a/13020502/4680581



---

archive/issue_comments_357979.json:
```json
{
    "body": "<a id='comment:12'></a>I don't have a personal use for it, but I do like making things in Sage fast so it can (continue to) be the dominate software in combinatorics. So I tried the algorithm in that SO post, and it is basically the same time (both in Python). Those `pop` calls take up somewhere between 1/3 to 1/2 of the time.\n\nSo we come to a small crossroads. Do we implement it as a `SearchForest` and use the recursive-but-embarrassingly-parallelizable algorithm or do we make the current one in serial but fully cythonized?",
    "created_at": "2018-08-14T02:13:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-357979",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:12'></a>I don't have a personal use for it, but I do like making things in Sage fast so it can (continue to) be the dominate software in combinatorics. So I tried the algorithm in that SO post, and it is basically the same time (both in Python). Those `pop` calls take up somewhere between 1/3 to 1/2 of the time.

So we come to a small crossroads. Do we implement it as a `SearchForest` and use the recursive-but-embarrassingly-parallelizable algorithm or do we make the current one in serial but fully cythonized?



---

archive/issue_comments_357980.json:
```json
{
    "body": "<a id='comment:13'></a>Actually, probably the latter as for the former, that would only be useful if we wanted to do something on all such objects (and output order didn't matter).",
    "created_at": "2018-08-14T02:17:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-357980",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:13'></a>Actually, probably the latter as for the former, that would only be useful if we wanted to do something on all such objects (and output order didn't matter).



---

archive/issue_comments_357981.json:
```json
{
    "body": "<a id='comment:14'></a>Here is where I am currently at:\n\n```\nsage: %time for x in PerfectMatchings(10): pass\nCPU times: user 4 ms, sys: 0 ns, total: 4 ms\nWall time: 964 \u00b5s\nsage: %time for x in PerfectMatchings(16): pass\nCPU times: user 796 ms, sys: 28 ms, total: 824 ms\nWall time: 794 ms\nsage: %time for x in PerfectMatchings(20): pass\nCPU times: user 3min 49s, sys: 8 ms, total: 3min 49s\nWall time: 3min 49s\n```\nversus with your branch:\n\n```\nsage: %time for x in PerfectMatchings(10): pass\nCPU times: user 8 ms, sys: 4 ms, total: 12 ms\nWall time: 7.14 ms\nsage: %time for x in PerfectMatchings(16): pass\nCPU times: user 14.4 s, sys: 0 ns, total: 14.4 s\nWall time: 14.4 s\n```\nThe timing for 20 would take far too long (extrapolating, somewhere between 30-90 minutes).\nI am pretty sure I can make this faster by better controlling what integers to look at.\n\nBTW:\n\n```\nsage: PerfectMatchings(20).cardinality()\n654729075\n```\n\n---\nNew commits:",
    "created_at": "2018-08-14T04:13:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-357981",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:14'></a>Here is where I am currently at:

```
sage: %time for x in PerfectMatchings(10): pass
CPU times: user 4 ms, sys: 0 ns, total: 4 ms
Wall time: 964 Âµs
sage: %time for x in PerfectMatchings(16): pass
CPU times: user 796 ms, sys: 28 ms, total: 824 ms
Wall time: 794 ms
sage: %time for x in PerfectMatchings(20): pass
CPU times: user 3min 49s, sys: 8 ms, total: 3min 49s
Wall time: 3min 49s
```
versus with your branch:

```
sage: %time for x in PerfectMatchings(10): pass
CPU times: user 8 ms, sys: 4 ms, total: 12 ms
Wall time: 7.14 ms
sage: %time for x in PerfectMatchings(16): pass
CPU times: user 14.4 s, sys: 0 ns, total: 14.4 s
Wall time: 14.4 s
```
The timing for 20 would take far too long (extrapolating, somewhere between 30-90 minutes).
I am pretty sure I can make this faster by better controlling what integers to look at.

BTW:

```
sage: PerfectMatchings(20).cardinality()
654729075
```

---
New commits:



---

archive/issue_comments_357982.json:
```json
{
    "body": "<a id='comment:15'></a>Impressive!  Is this (essentially) the same algorithm?\n\nI was thinking about calling all these iterators `iterator_raw` (or `raw_iterator`), with the specification that calling the parent on them \"works\".\n\nHowever, now they actually only work for the base set `0,1,...`, which makes even more sense, but doesn't fit this specification :-)",
    "created_at": "2018-08-14T06:27:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-357982",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:15'></a>Impressive!  Is this (essentially) the same algorithm?

I was thinking about calling all these iterators `iterator_raw` (or `raw_iterator`), with the specification that calling the parent on them "works".

However, now they actually only work for the base set `0,1,...`, which makes even more sense, but doesn't fit this specification :-)



---

archive/issue_comments_357983.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:15 mantepse]:\n> Impressive!  Is this (essentially) the same algorithm?\n\n\nYes, although how I find the \"next\" available entry I can add is dumb (search through a list). What I want to do is make it more linked-list like so I can quickly add and remove entires. However, this requires me to be a little more smart about how I do things.\n\n> I was thinking about calling all these iterators `iterator_raw` (or `raw_iterator`), with the specification that calling the parent on them \"works\".\n> \n> However, now they actually only work for the base set `0,1,...`, which makes even more sense, but doesn't fit this specification :-)\n\n\nThis is purely something for speed. If you want to call the parent on them, well, that's why we have the parents. ;)",
    "created_at": "2018-08-14T06:33:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-357983",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:16'></a>Replying to [comment:15 mantepse]:
> Impressive!  Is this (essentially) the same algorithm?


Yes, although how I find the "next" available entry I can add is dumb (search through a list). What I want to do is make it more linked-list like so I can quickly add and remove entires. However, this requires me to be a little more smart about how I do things.

> I was thinking about calling all these iterators `iterator_raw` (or `raw_iterator`), with the specification that calling the parent on them "works".
> 
> However, now they actually only work for the base set `0,1,...`, which makes even more sense, but doesn't fit this specification :-)


This is purely something for speed. If you want to call the parent on them, well, that's why we have the parents. ;)



---

archive/issue_comments_357984.json:
```json
{
    "body": "<a id='comment:17'></a>It just occurred to me that the key word is \"fixed-point-free involution\" :-)\n\nAlgorithm 3 on page 23 of\n\nhttp://www.info2.uqam.ca/~walsh_t/papers/Involutions%20paper.pdf\n\nshould be yet faster...",
    "created_at": "2018-08-14T08:05:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-357984",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:17'></a>It just occurred to me that the key word is "fixed-point-free involution" :-)

Algorithm 3 on page 23 of

http://www.info2.uqam.ca/~walsh_t/papers/Involutions%20paper.pdf

should be yet faster...



---

archive/issue_comments_357985.json:
```json
{
    "body": "<a id='comment:18'></a>Here is a naive implementation of Walsh's algorithm.  Warning: `generate(n)` generates the matchings on `2n` points.  Could you please compare?  To avoid work, I did not switch the index set to `0,..,n-1`.\n\n```\ndef generate(n):\n    e = list(range(1,2*n+1))\n    f = [i+1 if i % 2 == 1 else i-1 for i in e]\n    odd = up = done = False\n\n    yield f[:]\n    while True:\n        i = e[0]\n        if i == n:\n            return\n        if odd:\n            x = 2*i-1\n            y = f[x-1]\n            g = y-2*i\n            up = (g % 2 == 1)\n        else:\n            x = i\n            y = f[x-1]\n            g = y - (i+1)\n            up = (g % 2 == 0)\n        if up:\n            g += 1\n            j = y+1\n        else:\n            g -= 1\n            j = y-1\n        J = f[j-1]\n        f[y-1],f[j-1],f[x-1],f[J-1] = J, x, j, y\n        odd = not odd\n        e[0] = 1\n        if g == 0 or g == 2*(n-i):\n            e[i-1], e[i+1-1] = e[i+1-1], i+1\n\n        yield f[:]\n```",
    "created_at": "2018-08-14T10:59:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-357985",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:18'></a>Here is a naive implementation of Walsh's algorithm.  Warning: `generate(n)` generates the matchings on `2n` points.  Could you please compare?  To avoid work, I did not switch the index set to `0,..,n-1`.

```
def generate(n):
    e = list(range(1,2*n+1))
    f = [i+1 if i % 2 == 1 else i-1 for i in e]
    odd = up = done = False

    yield f[:]
    while True:
        i = e[0]
        if i == n:
            return
        if odd:
            x = 2*i-1
            y = f[x-1]
            g = y-2*i
            up = (g % 2 == 1)
        else:
            x = i
            y = f[x-1]
            g = y - (i+1)
            up = (g % 2 == 0)
        if up:
            g += 1
            j = y+1
        else:
            g -= 1
            j = y-1
        J = f[j-1]
        f[y-1],f[j-1],f[x-1],f[J-1] = J, x, j, y
        odd = not odd
        e[0] = 1
        if g == 0 or g == 2*(n-i):
            e[i-1], e[i+1-1] = e[i+1-1], i+1

        yield f[:]
```



---

archive/issue_comments_357986.json:
```json
{
    "body": "<a id='comment:19'></a>Here is the same thing with indices adapted and some trivial optimizations.  I don't know enough cython to optimize that further.  The main question is probably how to adapt it to directly produce the perfect matchings in the data structure we want (whatever that is).\n\n```\ndef generate(int n):\n    cdef int i, x, y, g, j, J\n    e = list(range(2*n))\n    f = [i+1 if i % 2 == 0 else i-1 for i in e]\n    odd = False\n\n    yield f[:]\n    while True:\n\ti = e[0]\n\tif i == n-1:\n            return\n\tif odd:\n            x = 2*i\n\telse:\n            x = i\n\ty = f[x]\n\tg = y-x-1\n        if (g % 2 == odd):\n            g += 1\n            j = y+1\n        else:\n            g -= 1\n            j = y-1\n        J = f[j]\n        f[y] = J; f[J] = y; f[x] = j; f[j] = x;\n        odd = not odd\n        e[0] = 0\n        if g == 0 or g == 2*(n-i-1):\n            e[i] = e[i+1]; e[i+1] = i+1\n\n        yield f[:]\n```",
    "created_at": "2018-08-14T11:29:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-357986",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:19'></a>Here is the same thing with indices adapted and some trivial optimizations.  I don't know enough cython to optimize that further.  The main question is probably how to adapt it to directly produce the perfect matchings in the data structure we want (whatever that is).

```
def generate(int n):
    cdef int i, x, y, g, j, J
    e = list(range(2*n))
    f = [i+1 if i % 2 == 0 else i-1 for i in e]
    odd = False

    yield f[:]
    while True:
	i = e[0]
	if i == n-1:
            return
	if odd:
            x = 2*i
	else:
            x = i
	y = f[x]
	g = y-x-1
        if (g % 2 == odd):
            g += 1
            j = y+1
        else:
            g -= 1
            j = y-1
        J = f[j]
        f[y] = J; f[J] = y; f[x] = j; f[j] = x;
        odd = not odd
        e[0] = 0
        if g == 0 or g == 2*(n-i-1):
            e[i] = e[i+1]; e[i+1] = i+1

        yield f[:]
```



---

archive/issue_comments_357987.json:
```json
{
    "body": "<a id='comment:20'></a>OK, I just checked: it should be fairly easy to produce restricted growth functions instead, which is nice, because then we use them consistently.",
    "created_at": "2018-08-14T15:05:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-357987",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:20'></a>OK, I just checked: it should be fairly easy to produce restricted growth functions instead, which is nice, because then we use them consistently.



---

archive/issue_comments_357988.json:
```json
{
    "body": "<a id='comment:21'></a>First, bad news is my iterator had a bug, so the timings of comment:14 are invalid. The good news it was easy to fix. Now I took your algorithm and added a simple conversion function. Now from testing, both algorithms are comparable in speed with the optimizations I have currently added. I am going to do some more work before pushing to see what I can do to optimize both.",
    "created_at": "2018-08-15T02:10:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-357988",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:21'></a>First, bad news is my iterator had a bug, so the timings of comment:14 are invalid. The good news it was easy to fix. Now I took your algorithm and added a simple conversion function. Now from testing, both algorithms are comparable in speed with the optimizations I have currently added. I am going to do some more work before pushing to see what I can do to optimize both.



---

archive/issue_comments_357989.json:
```json
{
    "body": "<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-15T02:56:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-357989",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_357990.json:
```json
{
    "body": "<a id='comment:23'></a>So I opted to use the fixed-point-free involution generator as I could guarantee that the result of converting to a set partition is ordered (by minimal element). Since I was getting comparable timings (most of which was actually coming from the creation of the actual elements), I figured this would give us the most speed. It also seemed easier to maintain in the long run (less low-level tricks). Here are my timings:\n\n```\nsage: %time for x in PerfectMatchings(10): pass\nCPU times: user 4 ms, sys: 0 ns, total: 4 ms\nWall time: 5.84 ms\nsage: %time for x in PerfectMatchings(12): pass\nCPU times: user 60 ms, sys: 8 ms, total: 68 ms\nWall time: 52.7 ms\nsage: %time for x in PerfectMatchings(14): pass\nCPU times: user 604 ms, sys: 32 ms, total: 636 ms\nWall time: 574 ms\nsage: %time for x in PerfectMatchings(16): pass\nCPU times: user 8.86 s, sys: 76 ms, total: 8.94 s\nWall time: 8.79 s\nsage: %time for x in PerfectMatchings(18): pass\nCPU times: user 2min 39s, sys: 32 ms, total: 2min 39s\nWall time: 2min 39s\nsage: PerfectMatchings(18).cardinality()\n34459425\n```",
    "created_at": "2018-08-15T03:00:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-357990",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:23'></a>So I opted to use the fixed-point-free involution generator as I could guarantee that the result of converting to a set partition is ordered (by minimal element). Since I was getting comparable timings (most of which was actually coming from the creation of the actual elements), I figured this would give us the most speed. It also seemed easier to maintain in the long run (less low-level tricks). Here are my timings:

```
sage: %time for x in PerfectMatchings(10): pass
CPU times: user 4 ms, sys: 0 ns, total: 4 ms
Wall time: 5.84 ms
sage: %time for x in PerfectMatchings(12): pass
CPU times: user 60 ms, sys: 8 ms, total: 68 ms
Wall time: 52.7 ms
sage: %time for x in PerfectMatchings(14): pass
CPU times: user 604 ms, sys: 32 ms, total: 636 ms
Wall time: 574 ms
sage: %time for x in PerfectMatchings(16): pass
CPU times: user 8.86 s, sys: 76 ms, total: 8.94 s
Wall time: 8.79 s
sage: %time for x in PerfectMatchings(18): pass
CPU times: user 2min 39s, sys: 32 ms, total: 2min 39s
Wall time: 2min 39s
sage: PerfectMatchings(18).cardinality()
34459425
```



---

archive/issue_comments_357991.json:
```json
{
    "body": "<a id='comment:24'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-15T03:41:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-357991",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:24'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_357992.json:
```json
{
    "body": "<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-08-15T03:42:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-357992",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_357993.json:
```json
{
    "body": "<a id='comment:26'></a>I am now using the backend iterators for all of the diagram algebras. So with this, if my changes are good, then positive review.",
    "created_at": "2018-08-15T03:44:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-357993",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:26'></a>I am now using the backend iterators for all of the diagram algebras. So with this, if my changes are good, then positive review.



---

archive/issue_events_064249.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2018-08-15T03:45:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "milestone": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25659#event-64249"
}
```



---

archive/issue_comments_357994.json:
```json
{
    "body": "<a id='comment:28'></a>Great!\n\nI created #26065 - it would almost certainly be better to create restricted growth functions directly with Walsh's Gray code.  Just in case someone is bored :-) \n\nFrom your last two commits, it seems that the order of generation for the set partition iterator changed again - I don't care much, but it does seem strange.\n\nWalsh's paper has actually appeared, here is a citation:\n\n```\n@article {MR1821628,\n    AUTHOR = {Walsh, Timothy},\n     TITLE = {Gray codes for involutions},\n   JOURNAL = {J. Combin. Math. Combin. Comput.},\n  FJOURNAL = {Journal of Combinatorial Mathematics and Combinatorial\n              Computing},\n    VOLUME = {36},\n      YEAR = {2001},\n     PAGES = {95--118},\n      ISSN = {0835-3026},\n   MRCLASS = {05A05 (68R05)},\n  MRNUMBER = {1821628},\nMRREVIEWER = {Theodore C. Enns},\n}\n```",
    "created_at": "2018-08-15T04:22:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-357994",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:28'></a>Great!

I created #26065 - it would almost certainly be better to create restricted growth functions directly with Walsh's Gray code.  Just in case someone is bored :-) 

From your last two commits, it seems that the order of generation for the set partition iterator changed again - I don't care much, but it does seem strange.

Walsh's paper has actually appeared, here is a citation:

```
@article {MR1821628,
    AUTHOR = {Walsh, Timothy},
     TITLE = {Gray codes for involutions},
   JOURNAL = {J. Combin. Math. Combin. Comput.},
  FJOURNAL = {Journal of Combinatorial Mathematics and Combinatorial
              Computing},
    VOLUME = {36},
      YEAR = {2001},
     PAGES = {95--118},
      ISSN = {0835-3026},
   MRCLASS = {05A05 (68R05)},
  MRNUMBER = {1821628},
MRREVIEWER = {Theodore C. Enns},
}
```



---

archive/issue_comments_357995.json:
```json
{
    "body": "<a id='comment:29'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-15T06:34:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-357995",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:29'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_357996.json:
```json
{
    "body": "<a id='comment:30'></a>I found that the different order comes from an additional `sorted` in `SetPartitions_set.__iter__`, so there is nothing to worry about.\n\nI added a reference, I'm happy with positive review.\n\n---\nNew commits:",
    "created_at": "2018-08-15T06:34:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-357996",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:30'></a>I found that the different order comes from an additional `sorted` in `SetPartitions_set.__iter__`, so there is nothing to worry about.

I added a reference, I'm happy with positive review.

---
New commits:



---

archive/issue_comments_357997.json:
```json
{
    "body": "<a id='comment:31'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-15T06:38:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-357997",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:31'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_357998.json:
```json
{
    "body": "<a id='comment:32'></a>Thank you. I made a few small tweaks to the reference. If my tweaks are good with you, then positive review.",
    "created_at": "2018-08-15T06:38:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-357998",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:32'></a>Thank you. I made a few small tweaks to the reference. If my tweaks are good with you, then positive review.



---

archive/issue_comments_357999.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-08-15T07:20:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-357999",
    "user": "https://github.com/mantepse"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_358000.json:
```json
{
    "body": "<a id='comment:34'></a>Merge conflict",
    "created_at": "2018-08-15T22:05:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-358000",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:34'></a>Merge conflict



---

archive/issue_comments_358001.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-08-15T22:05:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-358001",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_358002.json:
```json
{
    "body": "<a id='comment:35'></a>`@`vbraun: dear Volker, I cannot see the merge conflict...",
    "created_at": "2018-08-16T07:20:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-358002",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:35'></a>`@`vbraun: dear Volker, I cannot see the merge conflict...



---

archive/issue_comments_358003.json:
```json
{
    "body": "<a id='comment:36'></a>It will be with the (hopefully soon) forthcoming 8.4.beta2.",
    "created_at": "2018-08-16T07:38:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-358003",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:36'></a>It will be with the (hopefully soon) forthcoming 8.4.beta2.



---

archive/issue_comments_358004.json:
```json
{
    "body": "<a id='comment:37'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2018-08-25T21:32:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-358004",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:37'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_358005.json:
```json
{
    "body": "<a id='comment:38'></a>Hmm...I got a strange merge conflict when I rebased this over #26111. Well, still better to wait for 8.4.beta2.",
    "created_at": "2018-08-25T21:33:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-358005",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:38'></a>Hmm...I got a strange merge conflict when I rebased this over #26111. Well, still better to wait for 8.4.beta2.



---

archive/issue_comments_358006.json:
```json
{
    "body": "<a id='comment:39'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-26T17:56:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-358006",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:39'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_358007.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-08-26T17:56:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-358007",
    "user": "https://github.com/mantepse"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_358008.json:
```json
{
    "body": "<a id='comment:40'></a>almost trivial rebase",
    "created_at": "2018-08-26T17:56:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-358008",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:40'></a>almost trivial rebase



---

archive/issue_comments_358009.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-08-26T22:11:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-358009",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_358010.json:
```json
{
    "body": "<a id='comment:42'></a>See patchbot",
    "created_at": "2018-08-30T17:16:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-358010",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:42'></a>See patchbot



---

archive/issue_comments_358011.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-08-30T17:16:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-358011",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_358012.json:
```json
{
    "body": "<a id='comment:43'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-30T22:42:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-358012",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:43'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_358013.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-08-30T22:43:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-358013",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_358014.json:
```json
{
    "body": "<a id='comment:44'></a>Martin, can you check that you are getting the doctest order I am (which matches the patchbot)?",
    "created_at": "2018-08-30T22:43:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-358014",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:44'></a>Martin, can you check that you are getting the doctest order I am (which matches the patchbot)?



---

archive/issue_comments_358015.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-08-31T05:12:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-358015",
    "user": "https://github.com/mantepse"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_358016.json:
```json
{
    "body": "<a id='comment:45'></a>all tests pass here (on Ubuntu 16.04, Intel(R) Core(TM) i5-4570 CPU).  Thanks for fixing the tests and taking initiative!",
    "created_at": "2018-08-31T05:12:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-358016",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:45'></a>all tests pass here (on Ubuntu 16.04, Intel(R) Core(TM) i5-4570 CPU).  Thanks for fixing the tests and taking initiative!



---

archive/issue_events_064250.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-09-02T09:37:01Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25659#event-64250"
}
```



---

archive/issue_comments_358017.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-09-02T09:37:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25659#issuecomment-358017",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
