# Issue 25601: Minor code cleanup

archive/issues_025364.json:
```json
{
    "body": "\n\nCC:  @tscrim\n\nBranch/Commit: 93542aab6546d2253c8e1bff832dec24280b4498\n\nReviewer: Jeroen Demeyer\n\nAuthor: Fr\u00e9d\u00e9ric Chapoton\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/25601\n\n",
    "closed_at": "2018-06-20T18:06:21Z",
    "created_at": "2018-06-18T12:22:20Z",
    "labels": [
        "component: misc"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.3",
    "title": "Minor code cleanup",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25601",
    "user": "https://github.com/fchapoton"
}
```


CC:  @tscrim

Branch/Commit: 93542aab6546d2253c8e1bff832dec24280b4498

Reviewer: Jeroen Demeyer

Author: Frédéric Chapoton

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/25601





---

archive/issue_comments_357221.json:
```json
{
    "body": "<a id='comment:1'></a>New commits:",
    "created_at": "2018-06-18T12:22:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25601#issuecomment-357221",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:1'></a>New commits:



---

archive/issue_comments_357222.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-06-18T12:22:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25601#issuecomment-357222",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_357223.json:
```json
{
    "body": "<a id='comment:2'></a>That the negative roots does not work for affine types is something I would probably say is a bug. So this change makes it worse:\n\n```diff\ndiff --git a/src/sage/combinat/root_system/root_lattice_realizations.py b/src/sage/combinat/root_system/root_lattice_realizations.py\nindex 78d3cd7..c1b89e6 100644\n--- a/src/sage/combinat/root_system/root_lattice_realizations.py\n+++ b/src/sage/combinat/root_system/root_lattice_realizations.py\n@@ -1196,7 +1196,7 @@ class RootLatticeRealizations(Category_over_base_ring):\n             \"\"\"\n             if not self.cartan_type().is_finite():\n                 raise ValueError(\"%s is not a finite Cartan type\" % self.cartan_type())\n-            return self.positive_roots().map(attrcall('__neg__'))\n+            return [r.__neg__() for r in self.positive_roots()]\n \n         ##########################################################################\n         # coroots\n```",
    "created_at": "2018-06-19T03:00:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25601#issuecomment-357223",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:2'></a>That the negative roots does not work for affine types is something I would probably say is a bug. So this change makes it worse:

```diff
diff --git a/src/sage/combinat/root_system/root_lattice_realizations.py b/src/sage/combinat/root_system/root_lattice_realizations.py
index 78d3cd7..c1b89e6 100644
--- a/src/sage/combinat/root_system/root_lattice_realizations.py
+++ b/src/sage/combinat/root_system/root_lattice_realizations.py
@@ -1196,7 +1196,7 @@ class RootLatticeRealizations(Category_over_base_ring):
             """
             if not self.cartan_type().is_finite():
                 raise ValueError("%s is not a finite Cartan type" % self.cartan_type())
-            return self.positive_roots().map(attrcall('__neg__'))
+            return [r.__neg__() for r in self.positive_roots()]
 
         ##########################################################################
         # coroots
```



---

archive/issue_comments_357224.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2018-06-19T05:32:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25601#issuecomment-357224",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_357225.json:
```json
{
    "body": "<a id='comment:3'></a>What's wrong with\n\n```\na = 1/n\n```",
    "created_at": "2018-06-19T05:32:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25601#issuecomment-357225",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'></a>What's wrong with

```
a = 1/n
```



---

archive/issue_comments_357226.json:
```json
{
    "body": "<a id='comment:4'></a>And why `r.__neg__()` instead of `-r`?\n\nIt is almost never needed to call such double-underscore methods (main exceptions: `__new__` and when using `super`)",
    "created_at": "2018-06-19T05:35:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25601#issuecomment-357226",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>And why `r.__neg__()` instead of `-r`?

It is almost never needed to call such double-underscore methods (main exceptions: `__new__` and when using `super`)



---

archive/issue_comments_357227.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-06-19T06:38:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25601#issuecomment-357227",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_357228.json:
```json
{
    "body": "<a id='comment:6'></a>Here is the issue, in case one of you has a better idea for a fix:\n\n```\nsage: R=RootSystem(['A',2])\nsage: RS=R.root_lattice()\nsage: po=RS.positive_roots()\nsage: neg=RS.negative_roots()\nsage: po\nA recursively enumerated set with a graded structure (breadth first search)\nsage: neg\nImage of A recursively enumerated set with a graded structure (breadth first search) by <function RootLatticeRealizations.ParentMethods.negative_roots.<locals>.<lambda> at 0x7fa6b17f6620>\nsage: next(iter(po))\nalpha[1]\nsage: next(iter(neg))\n-alpha[1]\nsage: list(po)\n[alpha[1], alpha[2], alpha[1] + alpha[2]]\nsage: list(neg)\n---------------------------------------------------------------------------\nAttributeError                            Traceback (most recent call last)\n<ipython-input-10-41be9b87c947> in <module>()\n----> 1 list(neg)\n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/combinat/combinat.py in __len__(self)\n   1350             AttributeError: __len__ has been removed; use .cardinality() instead\n   1351         \"\"\"\n-> 1352         raise AttributeError(\"__len__ has been removed; use .cardinality() instead\")\n   1353 \n   1354     def is_finite(self):\n\nAttributeError: __len__ has been removed; use .cardinality() instead\n```",
    "created_at": "2018-06-19T06:50:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25601#issuecomment-357228",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:6'></a>Here is the issue, in case one of you has a better idea for a fix:

```
sage: R=RootSystem(['A',2])
sage: RS=R.root_lattice()
sage: po=RS.positive_roots()
sage: neg=RS.negative_roots()
sage: po
A recursively enumerated set with a graded structure (breadth first search)
sage: neg
Image of A recursively enumerated set with a graded structure (breadth first search) by <function RootLatticeRealizations.ParentMethods.negative_roots.<locals>.<lambda> at 0x7fa6b17f6620>
sage: next(iter(po))
alpha[1]
sage: next(iter(neg))
-alpha[1]
sage: list(po)
[alpha[1], alpha[2], alpha[1] + alpha[2]]
sage: list(neg)
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
<ipython-input-10-41be9b87c947> in <module>()
----> 1 list(neg)

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/combinat/combinat.py in __len__(self)
   1350             AttributeError: __len__ has been removed; use .cardinality() instead
   1351         """
-> 1352         raise AttributeError("__len__ has been removed; use .cardinality() instead")
   1353 
   1354     def is_finite(self):

AttributeError: __len__ has been removed; use .cardinality() instead
```



---

archive/issue_comments_357229.json:
```json
{
    "body": "<a id='comment:7'></a>That looks like a Sage safety check to avoid infinite iteration, but I am not sure it is really an effective one. Actually, I am somewhat curious as to why this behavior changed from 2 to 3.\nInterestingly, I get the same behavior on 2 and 3 with this:\n\n```\n>>> class Foo(object):\n...     def __len__(self):\n...         print(\"len\")\n...         return 5\n...     def __iter__(self):\n...         return iter(range(5))\n... \n>>> F = Foo()\n>>> list(F)\nlen\n[0, 1, 2, 3, 4]\n```\nHowever, in Python2, the error is caught and things are allowed to proceed as normal for `__iter__`. In Python3, it is not caught and aborts the computation.\n\nI would think the best solution would be to simply have `__len__` call `int(self.cardinality())` and let that error make its way up. Or remove it altogether and let the base class handle it.",
    "created_at": "2018-06-19T07:26:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25601#issuecomment-357229",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:7'></a>That looks like a Sage safety check to avoid infinite iteration, but I am not sure it is really an effective one. Actually, I am somewhat curious as to why this behavior changed from 2 to 3.
Interestingly, I get the same behavior on 2 and 3 with this:

```
>>> class Foo(object):
...     def __len__(self):
...         print("len")
...         return 5
...     def __iter__(self):
...         return iter(range(5))
... 
>>> F = Foo()
>>> list(F)
len
[0, 1, 2, 3, 4]
```
However, in Python2, the error is caught and things are allowed to proceed as normal for `__iter__`. In Python3, it is not caught and aborts the computation.

I would think the best solution would be to simply have `__len__` call `int(self.cardinality())` and let that error make its way up. Or remove it altogether and let the base class handle it.



---

archive/issue_comments_357230.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:7 tscrim]:\n> I would think the best solution would be to simply have `__len__` call `int(self.cardinality())` and let that error make its way up. Or remove it altogether and let the base class handle it.\n\n\nI'm guessing that `__len__` was \"removed\" because of a technical restriction that `__len__` must return a C `long`. So the answer cannot be an arbitrarily large integer nor infinity. I agree that implementing `__len__` as `self.cardinality()` makes sense. We should just check which what Cython does if this answer is either a large integer or infinity and add doctests.",
    "created_at": "2018-06-19T07:36:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25601#issuecomment-357230",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>Replying to [comment:7 tscrim]:
> I would think the best solution would be to simply have `__len__` call `int(self.cardinality())` and let that error make its way up. Or remove it altogether and let the base class handle it.


I'm guessing that `__len__` was "removed" because of a technical restriction that `__len__` must return a C `long`. So the answer cannot be an arbitrarily large integer nor infinity. I agree that implementing `__len__` as `self.cardinality()` makes sense. We should just check which what Cython does if this answer is either a large integer or infinity and add doctests.



---

archive/issue_comments_357231.json:
```json
{
    "body": "<a id='comment:9'></a>Seriously, what is wrong with `1/n`?",
    "created_at": "2018-06-19T07:37:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25601#issuecomment-357231",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>Seriously, what is wrong with `1/n`?



---

archive/issue_comments_357232.json:
```json
{
    "body": "<a id='comment:10'></a>:)\n\noh, well. In fact my branch can just be dropped..",
    "created_at": "2018-06-19T07:38:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25601#issuecomment-357232",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:10'></a>:)

oh, well. In fact my branch can just be dropped..



---

archive/issue_comments_357233.json:
```json
{
    "body": "<a id='comment:11'></a>I am advocating `1/n` in favour of other alternatives because it's not Sage-specific (unlike `~n` which is really a hack IMHO) and it's quite fast.",
    "created_at": "2018-06-19T07:40:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25601#issuecomment-357233",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>I am advocating `1/n` in favour of other alternatives because it's not Sage-specific (unlike `~n` which is really a hack IMHO) and it's quite fast.



---

archive/issue_comments_357234.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:8 jdemeyer]:\n> I agree that implementing `__len__` as `self.cardinality()` makes sense.\n\n\nActually, the default implementation of `cardinality()` is\n\n```\n    def cardinality(self):\n        c = 0\n        for _ in self:\n            c += 1\n        return c\n```\nand you don't want `__len__` (which is supposed to be fast) to call that.\n\nSo maybe we should just remove `__len__` completely instead of having it raise an `AttributeError`. I created #25605 for that.",
    "created_at": "2018-06-19T08:16:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25601#issuecomment-357234",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>Replying to [comment:8 jdemeyer]:
> I agree that implementing `__len__` as `self.cardinality()` makes sense.


Actually, the default implementation of `cardinality()` is

```
    def cardinality(self):
        c = 0
        for _ in self:
            c += 1
        return c
```
and you don't want `__len__` (which is supposed to be fast) to call that.

So maybe we should just remove `__len__` completely instead of having it raise an `AttributeError`. I created #25605 for that.



---

archive/issue_comments_357235.json:
```json
{
    "body": "<a id='comment:13'></a>so maybe we can now close this one as duplicate/invalid ?",
    "created_at": "2018-06-19T11:45:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25601#issuecomment-357235",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:13'></a>so maybe we can now close this one as duplicate/invalid ?



---

archive/issue_comments_357236.json:
```json
{
    "body": "Changing component from python3 to misc.",
    "created_at": "2018-06-19T12:03:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25601#issuecomment-357236",
    "user": "https://github.com/jdemeyer"
}
```

Changing component from python3 to misc.



---

archive/issue_comments_357237.json:
```json
{
    "body": "<a id='comment:16'></a>no, I think Travis said that the change in negative roots is bad, as it explicitly makes the list, instead of being a Familly (kind of lazy object).\n\n---\nNew commits:",
    "created_at": "2018-06-19T12:08:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25601#issuecomment-357237",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:16'></a>no, I think Travis said that the change in negative roots is bad, as it explicitly makes the list, instead of being a Familly (kind of lazy object).

---
New commits:



---

archive/issue_comments_357238.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-06-19T12:12:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25601#issuecomment-357238",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_357239.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-06-19T12:14:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25601#issuecomment-357239",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_357240.json:
```json
{
    "body": "<a id='comment:19'></a>New commits:",
    "created_at": "2018-06-19T12:14:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25601#issuecomment-357240",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:19'></a>New commits:



---

archive/issue_comments_357241.json:
```json
{
    "body": "Changing status from needs_info to positive_review.",
    "created_at": "2018-06-19T12:14:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25601#issuecomment-357241",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_info to positive_review.



---

archive/issue_events_064135.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-06-20T18:06:21Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/25601",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25601#event-64135"
}
```



---

archive/issue_comments_357242.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-06-20T18:06:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25601#issuecomment-357242",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
