# Issue 25161: Sphinx build hangs when a BaseException occurs

archive/issues_024924.json:
```json
{
    "body": "Python's `multiprocessing.Pool` hangs when a `BaseException` that is not an `Excepion` happens in the function it runs; we need to wrap these in \"normal\" Exception's so they get thrown correctly by the pool's `get`.\n\nHere's a minimal Python session to showcase this problem:\n\n```\nPython 2.7.14 (default, Jan  5 2018, 10:41:29) \n[GCC 7.2.1 20171224] on linux2\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> def work(x):\n...     raise BaseException(x)\n... \n>>> from multiprocessing import Pool\n>>> pool = Pool(2)\n>>> pool.map_async(work, [\"error\", \"error\"]).get()\nProcess PoolWorker-1:\nProcess PoolWorker-2:\nTraceback (most recent call last):\nTraceback (most recent call last):\n  File \"/usr/lib/python2.7/multiprocessing/process.py\", line 267, in _bootstrap\n  File \"/usr/lib/python2.7/multiprocessing/process.py\", line 267, in _bootstrap\n    self.run()\n  File \"/usr/lib/python2.7/multiprocessing/process.py\", line 114, in run\n    self.run()\n  File \"/usr/lib/python2.7/multiprocessing/process.py\", line 114, in run\n    self._target(*self._args, **self._kwargs)\n    self._target(*self._args, **self._kwargs)\n  File \"/usr/lib/python2.7/multiprocessing/pool.py\", line 113, in worker\n  File \"/usr/lib/python2.7/multiprocessing/pool.py\", line 113, in worker\n    result = (True, func(*args, **kwds))\n  File \"/usr/lib/python2.7/multiprocessing/pool.py\", line 65, in mapstar\n    result = (True, func(*args, **kwds))\n    return map(*args)\n  File \"/usr/lib/python2.7/multiprocessing/pool.py\", line 65, in mapstar\n  File \"<stdin>\", line 2, in work\n    return map(*args)\n  File \"<stdin>\", line 2, in work\nBaseException: error\nBaseException: error\n[hangs]\n```\n\nThis upstreams part of Debian's `u2-better-sphinx-failure-modes.patch`.\n\n**CC:**  @infinity0\n\n**Branch/Commit:** [319849adf7ea1d1695f2ac67d3df00e72cc962dd](https://github.com/sagemath/sagetrac-mirror/commit/319849adf7ea1d1695f2ac67d3df00e72cc962dd)\n\n**Reviewer:** Erik Bray\n\n**Author:** Julian R\u00fcth\n\nIssue created by migration from https://trac.sagemath.org/ticket/25161\n\n",
    "closed_at": "2018-05-14T17:35:59Z",
    "created_at": "2018-04-13T12:44:40Z",
    "labels": [
        "component: doctest framework",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.3",
    "title": "Sphinx build hangs when a BaseException occurs",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/25161",
    "user": "https://github.com/saraedum"
}
```
Python's `multiprocessing.Pool` hangs when a `BaseException` that is not an `Excepion` happens in the function it runs; we need to wrap these in "normal" Exception's so they get thrown correctly by the pool's `get`.

Here's a minimal Python session to showcase this problem:

```
Python 2.7.14 (default, Jan  5 2018, 10:41:29) 
[GCC 7.2.1 20171224] on linux2
Type "help", "copyright", "credits" or "license" for more information.
>>> def work(x):
...     raise BaseException(x)
... 
>>> from multiprocessing import Pool
>>> pool = Pool(2)
>>> pool.map_async(work, ["error", "error"]).get()
Process PoolWorker-1:
Process PoolWorker-2:
Traceback (most recent call last):
Traceback (most recent call last):
  File "/usr/lib/python2.7/multiprocessing/process.py", line 267, in _bootstrap
  File "/usr/lib/python2.7/multiprocessing/process.py", line 267, in _bootstrap
    self.run()
  File "/usr/lib/python2.7/multiprocessing/process.py", line 114, in run
    self.run()
  File "/usr/lib/python2.7/multiprocessing/process.py", line 114, in run
    self._target(*self._args, **self._kwargs)
    self._target(*self._args, **self._kwargs)
  File "/usr/lib/python2.7/multiprocessing/pool.py", line 113, in worker
  File "/usr/lib/python2.7/multiprocessing/pool.py", line 113, in worker
    result = (True, func(*args, **kwds))
  File "/usr/lib/python2.7/multiprocessing/pool.py", line 65, in mapstar
    result = (True, func(*args, **kwds))
    return map(*args)
  File "/usr/lib/python2.7/multiprocessing/pool.py", line 65, in mapstar
  File "<stdin>", line 2, in work
    return map(*args)
  File "<stdin>", line 2, in work
BaseException: error
BaseException: error
[hangs]
```

This upstreams part of Debian's `u2-better-sphinx-failure-modes.patch`.

**CC:**  @infinity0

**Branch/Commit:** [319849adf7ea1d1695f2ac67d3df00e72cc962dd](https://github.com/sagemath/sagetrac-mirror/commit/319849adf7ea1d1695f2ac67d3df00e72cc962dd)

**Reviewer:** Erik Bray

**Author:** Julian Rüth

Issue created by migration from https://trac.sagemath.org/ticket/25161





---

archive/issue_comments_387140.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,4 +1,6 @@\n Python's `multiprocessing.Pool` hangs when a `BaseException` that is not an `Excepion` happens in the function it runs; we need to wrap these in \"normal\" Exception's so they get thrown correctly by the pool's `get`.\n+\n+Here's a minimal Python session to showcase this problem:\n \n ```\n Python 2.7.14 (default, Jan  5 2018, 10:41:29) \n``````\n",
    "created_at": "2018-04-13T12:45:11Z",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-387140",
    "user": "https://github.com/saraedum"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,4 +1,6 @@
 Python's `multiprocessing.Pool` hangs when a `BaseException` that is not an `Excepion` happens in the function it runs; we need to wrap these in "normal" Exception's so they get thrown correctly by the pool's `get`.
+
+Here's a minimal Python session to showcase this problem:
 
 ```
 Python 2.7.14 (default, Jan  5 2018, 10:41:29) 
``````




---

archive/issue_comments_387141.json:
```json
{
    "body": "**Branch:** [u/saraedum/docbuild-base-exception](https://github.com/sagemath/sagetrac-mirror/tree/u/saraedum/docbuild-base-exception)",
    "created_at": "2018-04-13T13:00:36Z",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-387141",
    "user": "https://github.com/saraedum"
}
```

**Branch:** [u/saraedum/docbuild-base-exception](https://github.com/sagemath/sagetrac-mirror/tree/u/saraedum/docbuild-base-exception)



---

archive/issue_comments_387142.json:
```json
{
    "body": "<a id='comment:3'></a>\nNow, how could I possibly doctest this?\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6a02f359428139894908746c18d6967deaef7fae\">6a02f35</a></td><td><code>Wrap BaseException so Pool.get() aborts</code></td></tr></table>\n",
    "created_at": "2018-04-13T13:08:11Z",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-387142",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:3'></a>
Now, how could I possibly doctest this?

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6a02f359428139894908746c18d6967deaef7fae">6a02f35</a></td><td><code>Wrap BaseException so Pool.get() aborts</code></td></tr></table>




---

archive/issue_comments_387143.json:
```json
{
    "body": "**Commit:** [6a02f359428139894908746c18d6967deaef7fae](https://github.com/sagemath/sagetrac-mirror/commit/6a02f359428139894908746c18d6967deaef7fae)",
    "created_at": "2018-04-13T13:08:11Z",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-387143",
    "user": "https://github.com/saraedum"
}
```

**Commit:** [6a02f359428139894908746c18d6967deaef7fae](https://github.com/sagemath/sagetrac-mirror/commit/6a02f359428139894908746c18d6967deaef7fae)



---

archive/issue_comments_387144.json:
```json
{
    "body": "**Work Issues:** write doctests",
    "created_at": "2018-04-13T13:08:29Z",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-387144",
    "user": "https://github.com/saraedum"
}
```

**Work Issues:** write doctests



---

archive/issue_events_223307.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-04-13T13:09:23Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25161#event-223307"
}
```



---

archive/issue_comments_387145.json:
```json
{
    "body": "<a id='comment:6'></a>\nSetting this to needs review as I'd like to get some feedback on this.",
    "created_at": "2018-04-13T13:10:57Z",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-387145",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:6'></a>
Setting this to needs review as I'd like to get some feedback on this.



---

archive/issue_events_223308.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-04-13T13:10:57Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25161#event-223308"
}
```



---

archive/issue_events_223309.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-04-13T13:10:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25161#event-223309"
}
```



---

archive/issue_comments_387146.json:
```json
{
    "body": "<a id='comment:7'></a>\nI think I've seen a similar issue before, albeit rarely.  Last year I started working on a generalized version of the parallel doctest runner from `sage.doctest.forker` that could also be used in docbuilds (and provided better exception handling for free).  \n\nHowever, I had some minor bugs in my implementation that I never quite finished working out, and then got distracted and never finished it.  I'd really like that get that project up and running again...",
    "created_at": "2018-04-13T13:58:38Z",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-387146",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>
I think I've seen a similar issue before, albeit rarely.  Last year I started working on a generalized version of the parallel doctest runner from `sage.doctest.forker` that could also be used in docbuilds (and provided better exception handling for free).  

However, I had some minor bugs in my implementation that I never quite finished working out, and then got distracted and never finished it.  I'd really like that get that project up and running again...



---

archive/issue_comments_387147.json:
```json
{
    "body": "<a id='comment:8'></a>\nDo you have any idea what's causing a non-`Exception` exception to be raised from the docbuild?\n\nThe only thing I can think of is if it's an exception coming from Cysignals, and even then it's not clear what the exception would be in that case (an alarm, maybe?)\n\nOtherwise the fix certainly makes sense.",
    "created_at": "2018-04-13T14:02:35Z",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-387147",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>
Do you have any idea what's causing a non-`Exception` exception to be raised from the docbuild?

The only thing I can think of is if it's an exception coming from Cysignals, and even then it's not clear what the exception would be in that case (an alarm, maybe?)

Otherwise the fix certainly makes sense.



---

archive/issue_events_223310.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-13T14:03:00Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25161#event-223310"
}
```



---

archive/issue_events_223311.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-13T14:03:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "label": "needs info",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25161#event-223311"
}
```



---

archive/issue_comments_387148.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [embray](#comment%3A7):\n> Last year I started working on a generalized version of the parallel doctest runner from `sage.doctest.forker` that could also be used in docbuilds (and provided better exception handling for free).\n\n\nHuge +1 (disclaimer: I wrote that doctest forker).\n\n`multiprocessing` is broken in many ways. For this ticket, wouldn't it be possible to patch `multiprocessing` instead? That way, all users of `multiprocessing` would benefit, not only the docbuilder.",
    "created_at": "2018-04-13T15:06:43Z",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-387148",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>
Replying to [embray](#comment%3A7):
> Last year I started working on a generalized version of the parallel doctest runner from `sage.doctest.forker` that could also be used in docbuilds (and provided better exception handling for free).


Huge +1 (disclaimer: I wrote that doctest forker).

`multiprocessing` is broken in many ways. For this ticket, wouldn't it be possible to patch `multiprocessing` instead? That way, all users of `multiprocessing` would benefit, not only the docbuilder.



---

archive/issue_comments_387149.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [embray](#comment%3A8):\n> Do you have any idea what's causing a non-`Exception` exception to be raised from the docbuild?\n\n\n`KeyboardInterrupt` is a likely candidate. This probably explains why interrupting the docbuilder is unreliable.",
    "created_at": "2018-04-13T15:09:44Z",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-387149",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>
Replying to [embray](#comment%3A8):
> Do you have any idea what's causing a non-`Exception` exception to be raised from the docbuild?


`KeyboardInterrupt` is a likely candidate. This probably explains why interrupting the docbuilder is unreliable.



---

archive/issue_comments_387150.json:
```json
{
    "body": "<a id='comment:12'></a>\nReplying to [jdemeyer](#comment%3A11):\n> Replying to [embray](#comment%3A8):\n> > Do you have any idea what's causing a non-`Exception` exception to be raised from the docbuild?\n\nMaybe something coming out of cysignals. But I have no clue really.\n\n> `KeyboardInterrupt` is a likely candidate. This probably explains why interrupting the docbuilder is unreliable.\n\nI observed this problem in a CI run, so I don't think it's a KeyboardInterrupt. But you're right, the above example can not be killed with Ctrl-c. It just prints the KeyboardInterrupt on Python 2.7. (Works on Python 3.6.)",
    "created_at": "2018-04-13T16:28:40Z",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-387150",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:12'></a>
Replying to [jdemeyer](#comment%3A11):
> Replying to [embray](#comment%3A8):
> > Do you have any idea what's causing a non-`Exception` exception to be raised from the docbuild?

Maybe something coming out of cysignals. But I have no clue really.

> `KeyboardInterrupt` is a likely candidate. This probably explains why interrupting the docbuilder is unreliable.

I observed this problem in a CI run, so I don't think it's a KeyboardInterrupt. But you're right, the above example can not be killed with Ctrl-c. It just prints the KeyboardInterrupt on Python 2.7. (Works on Python 3.6.)



---

archive/issue_comments_387151.json:
```json
{
    "body": "<a id='comment:13'></a>\nReplying to [jdemeyer](#comment%3A10):\n> Replying to [embray](#comment%3A7):\n> > Last year I started working on a generalized version of the parallel doctest runner from `sage.doctest.forker` that could also be used in docbuilds (and provided better exception handling for free).\n\n> \n> Huge +1 (disclaimer: I wrote that doctest forker).\n> \n> `multiprocessing` is broken in many ways. For this ticket, wouldn't it be possible to patch `multiprocessing` instead? That way, all users of `multiprocessing` would benefit, not only the docbuilder.\n\n\nWhat do you mean? Patch our Python SPKG or monkey-patch the multiprocessing module?",
    "created_at": "2018-04-13T16:29:47Z",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-387151",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:13'></a>
Replying to [jdemeyer](#comment%3A10):
> Replying to [embray](#comment%3A7):
> > Last year I started working on a generalized version of the parallel doctest runner from `sage.doctest.forker` that could also be used in docbuilds (and provided better exception handling for free).

> 
> Huge +1 (disclaimer: I wrote that doctest forker).
> 
> `multiprocessing` is broken in many ways. For this ticket, wouldn't it be possible to patch `multiprocessing` instead? That way, all users of `multiprocessing` would benefit, not only the docbuilder.


What do you mean? Patch our Python SPKG or monkey-patch the multiprocessing module?



---

archive/issue_comments_387152.json:
```json
{
    "body": "**Changing work issues** from \"write doctests\" to \"\".",
    "created_at": "2018-04-13T16:43:55Z",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-387152",
    "user": "https://github.com/saraedum"
}
```

**Changing work issues** from "write doctests" to "".



---

archive/issue_events_223312.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-04-13T16:43:55Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "label": "needs info",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25161#event-223312"
}
```



---

archive/issue_events_223313.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-04-13T16:43:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25161#event-223313"
}
```



---

archive/issue_comments_387153.json:
```json
{
    "body": "<a id='comment:15'></a>\n(Without the `catch BaseException:`, the added doctest just hangs btw.)",
    "created_at": "2018-04-13T16:45:51Z",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-387153",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:15'></a>
(Without the `catch BaseException:`, the added doctest just hangs btw.)



---

archive/issue_comments_387154.json:
```json
{
    "body": "<a id='comment:16'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6a7640de10856a5f111237b789c965e5e0242fda\">6a7640d</a></td><td><code>Add doctest for #25161</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/fcbfe1c7b83d2784186445651647c0a9fe408781\">fcbfe1c</a></td><td><code>More standard logging usage</code></td></tr></table>\n",
    "created_at": "2018-04-13T18:07:12Z",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-387154",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6a7640de10856a5f111237b789c965e5e0242fda">6a7640d</a></td><td><code>Add doctest for #25161</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/fcbfe1c7b83d2784186445651647c0a9fe408781">fcbfe1c</a></td><td><code>More standard logging usage</code></td></tr></table>




---

archive/issue_comments_387155.json:
```json
{
    "body": "**Changing commit** from \"[6a02f359428139894908746c18d6967deaef7fae](https://github.com/sagemath/sagetrac-mirror/commit/6a02f359428139894908746c18d6967deaef7fae)\" to \"[fcbfe1c7b83d2784186445651647c0a9fe408781](https://github.com/sagemath/sagetrac-mirror/commit/fcbfe1c7b83d2784186445651647c0a9fe408781)\".",
    "created_at": "2018-04-13T18:07:12Z",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-387155",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[6a02f359428139894908746c18d6967deaef7fae](https://github.com/sagemath/sagetrac-mirror/commit/6a02f359428139894908746c18d6967deaef7fae)" to "[fcbfe1c7b83d2784186445651647c0a9fe408781](https://github.com/sagemath/sagetrac-mirror/commit/fcbfe1c7b83d2784186445651647c0a9fe408781)".



---

archive/issue_comments_387156.json:
```json
{
    "body": "<a id='comment:17'></a>\nOk, here's what's been happening in #24655:\n\n```\n[dochtml] Exception in thread Thread-7:\n[dochtml] Traceback (most recent call last):\n[dochtml]   File \"/home/sage/sage/local/lib/python2.7/threading.py\", line 801, in __bootstrap_inner\n[dochtml]     self.run()\n[dochtml]   File \"/home/sage/sage/local/lib/python2.7/threading.py\", line 754, in run\n[dochtml]     self.__target(*self.__args, **self.__kwargs)\n[dochtml]   File \"/home/sage/sage/local/lib/python2.7/multiprocessing/pool.py\", line 328, in _handle_workers\n[dochtml]     pool._maintain_pool()\n[dochtml]   File \"/home/sage/sage/local/lib/python2.7/multiprocessing/pool.py\", line 232, in _maintain_pool\n[dochtml]     self._repopulate_pool()\n[dochtml]   File \"/home/sage/sage/local/lib/python2.7/multiprocessing/pool.py\", line 225, in _repopulate_pool\n[dochtml]     w.start()\n[dochtml]   File \"/home/sage/sage/local/lib/python2.7/multiprocessing/process.py\", line 130, in start\n[dochtml]     self._popen = Popen(self)\n[dochtml]   File \"/home/sage/sage/local/lib/python2.7/multiprocessing/forking.py\", line 121, in __init__\n[dochtml]     self.pid = os.fork()\n[dochtml] OSError: [Errno 12] Cannot allocate memory\n```\n\nThat seems to make the docbuild hang. But that's an Exception, so the problem there seems to be something else.",
    "created_at": "2018-04-13T22:14:40Z",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-387156",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:17'></a>
Ok, here's what's been happening in #24655:

```
[dochtml] Exception in thread Thread-7:
[dochtml] Traceback (most recent call last):
[dochtml]   File "/home/sage/sage/local/lib/python2.7/threading.py", line 801, in __bootstrap_inner
[dochtml]     self.run()
[dochtml]   File "/home/sage/sage/local/lib/python2.7/threading.py", line 754, in run
[dochtml]     self.__target(*self.__args, **self.__kwargs)
[dochtml]   File "/home/sage/sage/local/lib/python2.7/multiprocessing/pool.py", line 328, in _handle_workers
[dochtml]     pool._maintain_pool()
[dochtml]   File "/home/sage/sage/local/lib/python2.7/multiprocessing/pool.py", line 232, in _maintain_pool
[dochtml]     self._repopulate_pool()
[dochtml]   File "/home/sage/sage/local/lib/python2.7/multiprocessing/pool.py", line 225, in _repopulate_pool
[dochtml]     w.start()
[dochtml]   File "/home/sage/sage/local/lib/python2.7/multiprocessing/process.py", line 130, in start
[dochtml]     self._popen = Popen(self)
[dochtml]   File "/home/sage/sage/local/lib/python2.7/multiprocessing/forking.py", line 121, in __init__
[dochtml]     self.pid = os.fork()
[dochtml] OSError: [Errno 12] Cannot allocate memory
```

That seems to make the docbuild hang. But that's an Exception, so the problem there seems to be something else.



---

archive/issue_comments_387157.json:
```json
{
    "body": "<a id='comment:18'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/319849adf7ea1d1695f2ac67d3df00e72cc962dd\">319849a</a></td><td><code>Added UTF-8 header to silence python warnings</code></td></tr></table>\n",
    "created_at": "2018-04-14T00:49:10Z",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-387157",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/319849adf7ea1d1695f2ac67d3df00e72cc962dd">319849a</a></td><td><code>Added UTF-8 header to silence python warnings</code></td></tr></table>




---

archive/issue_comments_387158.json:
```json
{
    "body": "**Changing commit** from \"[fcbfe1c7b83d2784186445651647c0a9fe408781](https://github.com/sagemath/sagetrac-mirror/commit/fcbfe1c7b83d2784186445651647c0a9fe408781)\" to \"[319849adf7ea1d1695f2ac67d3df00e72cc962dd](https://github.com/sagemath/sagetrac-mirror/commit/319849adf7ea1d1695f2ac67d3df00e72cc962dd)\".",
    "created_at": "2018-04-14T00:49:10Z",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-387158",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[fcbfe1c7b83d2784186445651647c0a9fe408781](https://github.com/sagemath/sagetrac-mirror/commit/fcbfe1c7b83d2784186445651647c0a9fe408781)" to "[319849adf7ea1d1695f2ac67d3df00e72cc962dd](https://github.com/sagemath/sagetrac-mirror/commit/319849adf7ea1d1695f2ac67d3df00e72cc962dd)".



---

archive/issue_comments_387159.json:
```json
{
    "body": "<a id='comment:19'></a>\nThis is only slightly related, but I wanted to bring this other patch to your attention:\n\nhttps://salsa.debian.org/science-team/sagemath/blob/master/debian/patches/df-subprocess-sphinx.patch\n\nIf that is adopted, a side-effect (I think) would be to avoid the need for this patch, since all errors would instead become CalledProcessErrors.",
    "created_at": "2018-04-14T15:48:49Z",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-387159",
    "user": "https://github.com/infinity0"
}
```

<a id='comment:19'></a>
This is only slightly related, but I wanted to bring this other patch to your attention:

https://salsa.debian.org/science-team/sagemath/blob/master/debian/patches/df-subprocess-sphinx.patch

If that is adopted, a side-effect (I think) would be to avoid the need for this patch, since all errors would instead become CalledProcessErrors.



---

archive/issue_comments_387160.json:
```json
{
    "body": "<a id='comment:20'></a>\nAh, thanks for pointing that out. I'm working through all the Debian patches at the moment so I might create a ticket for that one as well. (But I think it's maybe more controversial.)\n\nApart from that multiprocessing seems to work much better in Python 3, so maybe the problem goes away there\u2026",
    "created_at": "2018-04-17T17:52:30Z",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-387160",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:20'></a>
Ah, thanks for pointing that out. I'm working through all the Debian patches at the moment so I might create a ticket for that one as well. (But I think it's maybe more controversial.)

Apart from that multiprocessing seems to work much better in Python 3, so maybe the problem goes away there…



---

archive/issue_comments_387161.json:
```json
{
    "body": "<a id='comment:21'></a>\nReplying to [saraedum](#comment%3A13):\n> Replying to [jdemeyer](#comment%3A10):\n> > Replying to [embray](#comment%3A7):\n> > > Last year I started working on a generalized version of the parallel doctest runner from `sage.doctest.forker` that could also be used in docbuilds (and provided better exception handling for free).\n\n> > \n> > Huge +1 (disclaimer: I wrote that doctest forker).\n> > \n> > `multiprocessing` is broken in many ways. For this ticket, wouldn't it be possible to patch `multiprocessing` instead? That way, all users of `multiprocessing` would benefit, not only the docbuilder.\n\n> \n> What do you mean? Patch our Python SPKG or monkey-patch the multiprocessing module?\n\n\nI think what Jeroen means is as a more robust alternative to using `multiprocessing.Pool.map` and the like, as is currently used by the docbuilder.\n\nMy prototype implementation was compatible with (and this is why it was a bit difficult to get right) [concurrent.futures](https://docs.python.org/3/library/concurrent.futures.html) API, albeit extended to cover the additional features that the doctest runner has, such as capturing standard I/O from the worker processes.",
    "created_at": "2018-04-18T13:08:31Z",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-387161",
    "user": "https://github.com/embray"
}
```

<a id='comment:21'></a>
Replying to [saraedum](#comment%3A13):
> Replying to [jdemeyer](#comment%3A10):
> > Replying to [embray](#comment%3A7):
> > > Last year I started working on a generalized version of the parallel doctest runner from `sage.doctest.forker` that could also be used in docbuilds (and provided better exception handling for free).

> > 
> > Huge +1 (disclaimer: I wrote that doctest forker).
> > 
> > `multiprocessing` is broken in many ways. For this ticket, wouldn't it be possible to patch `multiprocessing` instead? That way, all users of `multiprocessing` would benefit, not only the docbuilder.

> 
> What do you mean? Patch our Python SPKG or monkey-patch the multiprocessing module?


I think what Jeroen means is as a more robust alternative to using `multiprocessing.Pool.map` and the like, as is currently used by the docbuilder.

My prototype implementation was compatible with (and this is why it was a bit difficult to get right) [concurrent.futures](https://docs.python.org/3/library/concurrent.futures.html) API, albeit extended to cover the additional features that the doctest runner has, such as capturing standard I/O from the worker processes.



---

archive/issue_comments_387162.json:
```json
{
    "body": "<a id='comment:22'></a>\nReplying to [saraedum](#comment%3A12):\n> Replying to [jdemeyer](#comment%3A11):\n> > Replying to [embray](#comment%3A8):\n> > > Do you have any idea what's causing a non-`Exception` exception to be raised from the docbuild?\n\n> Maybe something coming out of cysignals. But I have no clue really.\n> \n> > `KeyboardInterrupt` is a likely candidate. This probably explains why interrupting the docbuilder is unreliable.\n\n> I observed this problem in a CI run, so I don't think it's a KeyboardInterrupt. But you're right, the above example can not be killed with Ctrl-c. It just prints the KeyboardInterrupt on Python 2.7. (Works on Python 3.6.)\n\nIt's possible that if a process is taking too long, or otherwise going beyond its allowed resource usage the CI runner tries to stop it, and it might start out \"nice\" and just send Ctrl-Cs, though it also might move on to SIGTERM and/or SIGKILL.\n\nIt sounds to me like the enormous memory usage of the docbuild might still be a problem for #24655.  We may need to try to do more work on fixing that...",
    "created_at": "2018-04-18T13:11:56Z",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-387162",
    "user": "https://github.com/embray"
}
```

<a id='comment:22'></a>
Replying to [saraedum](#comment%3A12):
> Replying to [jdemeyer](#comment%3A11):
> > Replying to [embray](#comment%3A8):
> > > Do you have any idea what's causing a non-`Exception` exception to be raised from the docbuild?

> Maybe something coming out of cysignals. But I have no clue really.
> 
> > `KeyboardInterrupt` is a likely candidate. This probably explains why interrupting the docbuilder is unreliable.

> I observed this problem in a CI run, so I don't think it's a KeyboardInterrupt. But you're right, the above example can not be killed with Ctrl-c. It just prints the KeyboardInterrupt on Python 2.7. (Works on Python 3.6.)

It's possible that if a process is taking too long, or otherwise going beyond its allowed resource usage the CI runner tries to stop it, and it might start out "nice" and just send Ctrl-Cs, though it also might move on to SIGTERM and/or SIGKILL.

It sounds to me like the enormous memory usage of the docbuild might still be a problem for #24655.  We may need to try to do more work on fixing that...



---

archive/issue_comments_387163.json:
```json
{
    "body": "<a id='comment:23'></a>\nSo, the underlying problem here was really the memory usage of the sequential docbuild, see #24655. Anyway, I think the change proposed here still makes sense.",
    "created_at": "2018-04-21T19:17:34Z",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-387163",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:23'></a>
So, the underlying problem here was really the memory usage of the sequential docbuild, see #24655. Anyway, I think the change proposed here still makes sense.



---

archive/issue_events_223314.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-23T14:10:21Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25161#event-223314"
}
```



---

archive/issue_events_223315.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-23T14:10:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25161#event-223315"
}
```



---

archive/issue_comments_387164.json:
```json
{
    "body": "<a id='comment:24'></a>\nAgreed.",
    "created_at": "2018-04-23T14:10:21Z",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-387164",
    "user": "https://github.com/embray"
}
```

<a id='comment:24'></a>
Agreed.



---

archive/issue_comments_387165.json:
```json
{
    "body": "**Reviewer:** Erik Bray",
    "created_at": "2018-04-23T14:10:21Z",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-387165",
    "user": "https://github.com/embray"
}
```

**Reviewer:** Erik Bray



---

archive/issue_events_223316.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-23T14:10:28Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "milestone": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25161#event-223316"
}
```



---

archive/issue_events_223317.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-23T14:10:28Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "milestone": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25161#event-223317"
}
```



---

archive/issue_events_223318.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-05-14T17:35:59Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25161#event-223318"
}
```



---

archive/issue_events_223319.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "80d4a17edc485f0a50ee55968dd78b8d6f8c1a73",
    "created_at": "2018-05-14T17:35:59Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25161#event-223319"
}
```



---

archive/issue_comments_387166.json:
```json
{
    "body": "**Changing branch** from \"[u/saraedum/docbuild-base-exception](https://github.com/sagemath/sagetrac-mirror/tree/u/saraedum/docbuild-base-exception)\" to \"[319849adf7ea1d1695f2ac67d3df00e72cc962dd](https://github.com/sagemath/sagetrac-mirror/commit/319849adf7ea1d1695f2ac67d3df00e72cc962dd)\".",
    "created_at": "2018-05-14T17:35:59Z",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-387166",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/saraedum/docbuild-base-exception](https://github.com/sagemath/sagetrac-mirror/tree/u/saraedum/docbuild-base-exception)" to "[319849adf7ea1d1695f2ac67d3df00e72cc962dd](https://github.com/sagemath/sagetrac-mirror/commit/319849adf7ea1d1695f2ac67d3df00e72cc962dd)".
