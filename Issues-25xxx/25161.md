# Issue 25161: Sphinx build hangs when a BaseException occurs

archive/issues_024924.json:
```json
{
    "assignees": [],
    "body": "Python's `multiprocessing.Pool` hangs when a `BaseException` that is not an `Excepion` happens in the function it runs; we need to wrap these in \"normal\" Exception's so they get thrown correctly by the pool's `get`.\n\nHere's a minimal Python session to showcase this problem:\n\n```\nPython 2.7.14 (default, Jan  5 2018, 10:41:29) \n[GCC 7.2.1 20171224] on linux2\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> def work(x):\n...     raise BaseException(x)\n... \n>>> from multiprocessing import Pool\n>>> pool = Pool(2)\n>>> pool.map_async(work, [\"error\", \"error\"]).get()\nProcess PoolWorker-1:\nProcess PoolWorker-2:\nTraceback (most recent call last):\nTraceback (most recent call last):\n  File \"/usr/lib/python2.7/multiprocessing/process.py\", line 267, in _bootstrap\n  File \"/usr/lib/python2.7/multiprocessing/process.py\", line 267, in _bootstrap\n    self.run()\n  File \"/usr/lib/python2.7/multiprocessing/process.py\", line 114, in run\n    self.run()\n  File \"/usr/lib/python2.7/multiprocessing/process.py\", line 114, in run\n    self._target(*self._args, **self._kwargs)\n    self._target(*self._args, **self._kwargs)\n  File \"/usr/lib/python2.7/multiprocessing/pool.py\", line 113, in worker\n  File \"/usr/lib/python2.7/multiprocessing/pool.py\", line 113, in worker\n    result = (True, func(*args, **kwds))\n  File \"/usr/lib/python2.7/multiprocessing/pool.py\", line 65, in mapstar\n    result = (True, func(*args, **kwds))\n    return map(*args)\n  File \"/usr/lib/python2.7/multiprocessing/pool.py\", line 65, in mapstar\n  File \"<stdin>\", line 2, in work\n    return map(*args)\n  File \"<stdin>\", line 2, in work\nBaseException: error\nBaseException: error\n[hangs]\n```\n\nThis upstreams part of Debian's `u2-better-sphinx-failure-modes.patch`.\n\nCC:  @infinity0\n\nBranch/Commit: **[`319849a`](https://github.com/sagemath/sagetrac-mirror/commit/319849adf7ea1d1695f2ac67d3df00e72cc962dd)**\n\nReviewer: **Erik Bray**\n\nAuthor: **Julian R\u00fcth**\n\nComponent: **doctest framework**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/25161_\n\n",
    "closed_at": "2018-05-14T17:35:59Z",
    "created_at": "2018-04-13T12:44:40Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20doctest%20framework",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.3",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Sphinx build hangs when a BaseException occurs",
    "type": "issue",
    "updated_at": "2018-05-14T17:35:59Z",
    "url": "https://github.com/sagemath/sage/issues/25161",
    "user": "https://github.com/saraedum"
}
```
Python's `multiprocessing.Pool` hangs when a `BaseException` that is not an `Excepion` happens in the function it runs; we need to wrap these in "normal" Exception's so they get thrown correctly by the pool's `get`.

Here's a minimal Python session to showcase this problem:

```
Python 2.7.14 (default, Jan  5 2018, 10:41:29) 
[GCC 7.2.1 20171224] on linux2
Type "help", "copyright", "credits" or "license" for more information.
>>> def work(x):
...     raise BaseException(x)
... 
>>> from multiprocessing import Pool
>>> pool = Pool(2)
>>> pool.map_async(work, ["error", "error"]).get()
Process PoolWorker-1:
Process PoolWorker-2:
Traceback (most recent call last):
Traceback (most recent call last):
  File "/usr/lib/python2.7/multiprocessing/process.py", line 267, in _bootstrap
  File "/usr/lib/python2.7/multiprocessing/process.py", line 267, in _bootstrap
    self.run()
  File "/usr/lib/python2.7/multiprocessing/process.py", line 114, in run
    self.run()
  File "/usr/lib/python2.7/multiprocessing/process.py", line 114, in run
    self._target(*self._args, **self._kwargs)
    self._target(*self._args, **self._kwargs)
  File "/usr/lib/python2.7/multiprocessing/pool.py", line 113, in worker
  File "/usr/lib/python2.7/multiprocessing/pool.py", line 113, in worker
    result = (True, func(*args, **kwds))
  File "/usr/lib/python2.7/multiprocessing/pool.py", line 65, in mapstar
    result = (True, func(*args, **kwds))
    return map(*args)
  File "/usr/lib/python2.7/multiprocessing/pool.py", line 65, in mapstar
  File "<stdin>", line 2, in work
    return map(*args)
  File "<stdin>", line 2, in work
BaseException: error
BaseException: error
[hangs]
```

This upstreams part of Debian's `u2-better-sphinx-failure-modes.patch`.

CC:  @infinity0

Branch/Commit: **[`319849a`](https://github.com/sagemath/sagetrac-mirror/commit/319849adf7ea1d1695f2ac67d3df00e72cc962dd)**

Reviewer: **Erik Bray**

Author: **Julian RÃ¼th**

Component: **doctest framework**

_Issue created by migration from https://trac.sagemath.org/ticket/25161_





---

archive/issue_events_348298.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-04-13T12:44:40Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "milestone_number": null,
    "milestone_title": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25161#event-348298"
}
```



---

archive/issue_events_348299.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-04-13T12:44:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20doctest%20framework",
    "label_color": "000080",
    "label_name": "c: doctest framework",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25161#event-348299"
}
```



---

archive/issue_events_348300.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-04-13T12:44:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25161#event-348300"
}
```



---

archive/issue_events_348301.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-04-13T12:44:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25161#event-348301"
}
```



---

archive/issue_comments_384601.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,6 @@\n Python's `multiprocessing.Pool` hangs when a `BaseException` that is not an `Excepion` happens in the function it runs; we need to wrap these in \"normal\" Exception's so they get thrown correctly by the pool's `get`.\n+\n+Here's a minimal Python session to showcase this problem:\n \n ```\n Python 2.7.14 (default, Jan  5 2018, 10:41:29) \n``````\n",
    "created_at": "2018-04-13T12:45:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-384601",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,6 @@
 Python's `multiprocessing.Pool` hangs when a `BaseException` that is not an `Excepion` happens in the function it runs; we need to wrap these in "normal" Exception's so they get thrown correctly by the pool's `get`.
+
+Here's a minimal Python session to showcase this problem:
 
 ```
 Python 2.7.14 (default, Jan  5 2018, 10:41:29) 
``````




---

archive/issue_comments_384602.json:
```json
{
    "body": "Branch: **[u/saraedum/docbuild-base-exception](https://github.com/sagemath/sagetrac-mirror/tree/u/saraedum/docbuild-base-exception)**",
    "created_at": "2018-04-13T13:00:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-384602",
    "user": "https://github.com/saraedum"
}
```

Branch: **[u/saraedum/docbuild-base-exception](https://github.com/sagemath/sagetrac-mirror/tree/u/saraedum/docbuild-base-exception)**



---

archive/issue_comments_384603.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nNow, how could I possibly doctest this?\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6a02f359428139894908746c18d6967deaef7fae\">6a02f35</a></td><td><code>Wrap BaseException so Pool.get() aborts</code></td></tr></table>\n",
    "created_at": "2018-04-13T13:08:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-384603",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:3" align="right">comment:3</div>

Now, how could I possibly doctest this?

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6a02f359428139894908746c18d6967deaef7fae">6a02f35</a></td><td><code>Wrap BaseException so Pool.get() aborts</code></td></tr></table>




---

archive/issue_comments_384604.json:
```json
{
    "body": "Commit: **[`6a02f35`](https://github.com/sagemath/sagetrac-mirror/commit/6a02f359428139894908746c18d6967deaef7fae)**",
    "created_at": "2018-04-13T13:08:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-384604",
    "user": "https://github.com/saraedum"
}
```

Commit: **[`6a02f35`](https://github.com/sagemath/sagetrac-mirror/commit/6a02f359428139894908746c18d6967deaef7fae)**



---

archive/issue_comments_384605.json:
```json
{
    "body": "Work Issues: **write doctests**",
    "created_at": "2018-04-13T13:08:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-384605",
    "user": "https://github.com/saraedum"
}
```

Work Issues: **write doctests**



---

archive/issue_events_348302.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-04-13T13:09:23Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25161#event-348302"
}
```



---

archive/issue_comments_384606.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nSetting this to needs review as I'd like to get some feedback on this.",
    "created_at": "2018-04-13T13:10:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-384606",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:6" align="right">comment:6</div>

Setting this to needs review as I'd like to get some feedback on this.



---

archive/issue_events_348303.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-04-13T13:10:57Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25161#event-348303"
}
```



---

archive/issue_events_348304.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-04-13T13:10:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25161#event-348304"
}
```



---

archive/issue_comments_384607.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nI think I've seen a similar issue before, albeit rarely.  Last year I started working on a generalized version of the parallel doctest runner from `sage.doctest.forker` that could also be used in docbuilds (and provided better exception handling for free).  \n\nHowever, I had some minor bugs in my implementation that I never quite finished working out, and then got distracted and never finished it.  I'd really like that get that project up and running again...",
    "created_at": "2018-04-13T13:58:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-384607",
    "user": "https://github.com/embray"
}
```

<div id="comment:7" align="right">comment:7</div>

I think I've seen a similar issue before, albeit rarely.  Last year I started working on a generalized version of the parallel doctest runner from `sage.doctest.forker` that could also be used in docbuilds (and provided better exception handling for free).  

However, I had some minor bugs in my implementation that I never quite finished working out, and then got distracted and never finished it.  I'd really like that get that project up and running again...



---

archive/issue_comments_384608.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nDo you have any idea what's causing a non-`Exception` exception to be raised from the docbuild?\n\nThe only thing I can think of is if it's an exception coming from Cysignals, and even then it's not clear what the exception would be in that case (an alarm, maybe?)\n\nOtherwise the fix certainly makes sense.",
    "created_at": "2018-04-13T14:02:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-384608",
    "user": "https://github.com/embray"
}
```

<div id="comment:8" align="right">comment:8</div>

Do you have any idea what's causing a non-`Exception` exception to be raised from the docbuild?

The only thing I can think of is if it's an exception coming from Cysignals, and even then it's not clear what the exception would be in that case (an alarm, maybe?)

Otherwise the fix certainly makes sense.



---

archive/issue_events_348305.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-13T14:03:00Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25161#event-348305"
}
```



---

archive/issue_events_348306.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-13T14:03:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25161#event-348306"
}
```



---

archive/issue_comments_384609.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@embray](#comment:7):\n> Last year I started working on a generalized version of the parallel doctest runner from `sage.doctest.forker` that could also be used in docbuilds (and provided better exception handling for free).\n\nHuge +1 (disclaimer: I wrote that doctest forker).\n\n`multiprocessing` is broken in many ways. For this ticket, wouldn't it be possible to patch `multiprocessing` instead? That way, all users of `multiprocessing` would benefit, not only the docbuilder.",
    "created_at": "2018-04-13T15:06:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-384609",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@embray](#comment:7):
> Last year I started working on a generalized version of the parallel doctest runner from `sage.doctest.forker` that could also be used in docbuilds (and provided better exception handling for free).

Huge +1 (disclaimer: I wrote that doctest forker).

`multiprocessing` is broken in many ways. For this ticket, wouldn't it be possible to patch `multiprocessing` instead? That way, all users of `multiprocessing` would benefit, not only the docbuilder.



---

archive/issue_comments_384610.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nReplying to [@embray](#comment:8):\n> Do you have any idea what's causing a non-`Exception` exception to be raised from the docbuild?\n\n`KeyboardInterrupt` is a likely candidate. This probably explains why interrupting the docbuilder is unreliable.",
    "created_at": "2018-04-13T15:09:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-384610",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:11" align="right">comment:11</div>

Replying to [@embray](#comment:8):
> Do you have any idea what's causing a non-`Exception` exception to be raised from the docbuild?

`KeyboardInterrupt` is a likely candidate. This probably explains why interrupting the docbuilder is unreliable.



---

archive/issue_comments_384611.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@jdemeyer](#comment:11):\n> Replying to [@embray](#comment:8):\n> > Do you have any idea what's causing a non-`Exception` exception to be raised from the docbuild?\n\nMaybe something coming out of cysignals. But I have no clue really.\n\n> `KeyboardInterrupt` is a likely candidate. This probably explains why interrupting the docbuilder is unreliable.\n\nI observed this problem in a CI run, so I don't think it's a KeyboardInterrupt. But you're right, the above example can not be killed with Ctrl-c. It just prints the KeyboardInterrupt on Python 2.7. (Works on Python 3.6.)",
    "created_at": "2018-04-13T16:28:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-384611",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@jdemeyer](#comment:11):
> Replying to [@embray](#comment:8):
> > Do you have any idea what's causing a non-`Exception` exception to be raised from the docbuild?

Maybe something coming out of cysignals. But I have no clue really.

> `KeyboardInterrupt` is a likely candidate. This probably explains why interrupting the docbuilder is unreliable.

I observed this problem in a CI run, so I don't think it's a KeyboardInterrupt. But you're right, the above example can not be killed with Ctrl-c. It just prints the KeyboardInterrupt on Python 2.7. (Works on Python 3.6.)



---

archive/issue_comments_384612.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nReplying to [@jdemeyer](#comment:10):\n> Replying to [@embray](#comment:7):\n> > Last year I started working on a generalized version of the parallel doctest runner from `sage.doctest.forker` that could also be used in docbuilds (and provided better exception handling for free).\n\n> \n> Huge +1 (disclaimer: I wrote that doctest forker).\n> \n> `multiprocessing` is broken in many ways. For this ticket, wouldn't it be possible to patch `multiprocessing` instead? That way, all users of `multiprocessing` would benefit, not only the docbuilder.\n\nWhat do you mean? Patch our Python SPKG or monkey-patch the multiprocessing module?",
    "created_at": "2018-04-13T16:29:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-384612",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:13" align="right">comment:13</div>

Replying to [@jdemeyer](#comment:10):
> Replying to [@embray](#comment:7):
> > Last year I started working on a generalized version of the parallel doctest runner from `sage.doctest.forker` that could also be used in docbuilds (and provided better exception handling for free).

> 
> Huge +1 (disclaimer: I wrote that doctest forker).
> 
> `multiprocessing` is broken in many ways. For this ticket, wouldn't it be possible to patch `multiprocessing` instead? That way, all users of `multiprocessing` would benefit, not only the docbuilder.

What do you mean? Patch our Python SPKG or monkey-patch the multiprocessing module?



---

archive/issue_comments_384613.json:
```json
{
    "body": "Changed work issues from **write doctests** to none",
    "created_at": "2018-04-13T16:43:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-384613",
    "user": "https://github.com/saraedum"
}
```

Changed work issues from **write doctests** to none



---

archive/issue_events_348307.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-04-13T16:43:55Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25161#event-348307"
}
```



---

archive/issue_events_348308.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-04-13T16:43:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25161#event-348308"
}
```



---

archive/issue_comments_384614.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\n(Without the `catch BaseException:`, the added doctest just hangs btw.)",
    "created_at": "2018-04-13T16:45:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-384614",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:15" align="right">comment:15</div>

(Without the `catch BaseException:`, the added doctest just hangs btw.)



---

archive/issue_comments_384615.json:
```json
{
    "body": "<div id=\"comment:16\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6a7640de10856a5f111237b789c965e5e0242fda\">6a7640d</a></td><td><code>Add doctest for #25161</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/fcbfe1c7b83d2784186445651647c0a9fe408781\">fcbfe1c</a></td><td><code>More standard logging usage</code></td></tr></table>\n",
    "created_at": "2018-04-13T18:07:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-384615",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:16"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6a7640de10856a5f111237b789c965e5e0242fda">6a7640d</a></td><td><code>Add doctest for #25161</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/fcbfe1c7b83d2784186445651647c0a9fe408781">fcbfe1c</a></td><td><code>More standard logging usage</code></td></tr></table>




---

archive/issue_comments_384616.json:
```json
{
    "body": "Changed commit from **[`6a02f35`](https://github.com/sagemath/sagetrac-mirror/commit/6a02f359428139894908746c18d6967deaef7fae)** to **[`fcbfe1c`](https://github.com/sagemath/sagetrac-mirror/commit/fcbfe1c7b83d2784186445651647c0a9fe408781)**",
    "created_at": "2018-04-13T18:07:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-384616",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`6a02f35`](https://github.com/sagemath/sagetrac-mirror/commit/6a02f359428139894908746c18d6967deaef7fae)** to **[`fcbfe1c`](https://github.com/sagemath/sagetrac-mirror/commit/fcbfe1c7b83d2784186445651647c0a9fe408781)**



---

archive/issue_comments_384617.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nOk, here's what's been happening in #24655:\n\n```\n[dochtml] Exception in thread Thread-7:\n[dochtml] Traceback (most recent call last):\n[dochtml]   File \"/home/sage/sage/local/lib/python2.7/threading.py\", line 801, in __bootstrap_inner\n[dochtml]     self.run()\n[dochtml]   File \"/home/sage/sage/local/lib/python2.7/threading.py\", line 754, in run\n[dochtml]     self.__target(*self.__args, **self.__kwargs)\n[dochtml]   File \"/home/sage/sage/local/lib/python2.7/multiprocessing/pool.py\", line 328, in _handle_workers\n[dochtml]     pool._maintain_pool()\n[dochtml]   File \"/home/sage/sage/local/lib/python2.7/multiprocessing/pool.py\", line 232, in _maintain_pool\n[dochtml]     self._repopulate_pool()\n[dochtml]   File \"/home/sage/sage/local/lib/python2.7/multiprocessing/pool.py\", line 225, in _repopulate_pool\n[dochtml]     w.start()\n[dochtml]   File \"/home/sage/sage/local/lib/python2.7/multiprocessing/process.py\", line 130, in start\n[dochtml]     self._popen = Popen(self)\n[dochtml]   File \"/home/sage/sage/local/lib/python2.7/multiprocessing/forking.py\", line 121, in __init__\n[dochtml]     self.pid = os.fork()\n[dochtml] OSError: [Errno 12] Cannot allocate memory\n```\n\nThat seems to make the docbuild hang. But that's an Exception, so the problem there seems to be something else.",
    "created_at": "2018-04-13T22:14:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-384617",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:17" align="right">comment:17</div>

Ok, here's what's been happening in #24655:

```
[dochtml] Exception in thread Thread-7:
[dochtml] Traceback (most recent call last):
[dochtml]   File "/home/sage/sage/local/lib/python2.7/threading.py", line 801, in __bootstrap_inner
[dochtml]     self.run()
[dochtml]   File "/home/sage/sage/local/lib/python2.7/threading.py", line 754, in run
[dochtml]     self.__target(*self.__args, **self.__kwargs)
[dochtml]   File "/home/sage/sage/local/lib/python2.7/multiprocessing/pool.py", line 328, in _handle_workers
[dochtml]     pool._maintain_pool()
[dochtml]   File "/home/sage/sage/local/lib/python2.7/multiprocessing/pool.py", line 232, in _maintain_pool
[dochtml]     self._repopulate_pool()
[dochtml]   File "/home/sage/sage/local/lib/python2.7/multiprocessing/pool.py", line 225, in _repopulate_pool
[dochtml]     w.start()
[dochtml]   File "/home/sage/sage/local/lib/python2.7/multiprocessing/process.py", line 130, in start
[dochtml]     self._popen = Popen(self)
[dochtml]   File "/home/sage/sage/local/lib/python2.7/multiprocessing/forking.py", line 121, in __init__
[dochtml]     self.pid = os.fork()
[dochtml] OSError: [Errno 12] Cannot allocate memory
```

That seems to make the docbuild hang. But that's an Exception, so the problem there seems to be something else.



---

archive/issue_comments_384618.json:
```json
{
    "body": "<div id=\"comment:18\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/319849adf7ea1d1695f2ac67d3df00e72cc962dd\">319849a</a></td><td><code>Added UTF-8 header to silence python warnings</code></td></tr></table>\n",
    "created_at": "2018-04-14T00:49:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-384618",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:18"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/319849adf7ea1d1695f2ac67d3df00e72cc962dd">319849a</a></td><td><code>Added UTF-8 header to silence python warnings</code></td></tr></table>




---

archive/issue_comments_384619.json:
```json
{
    "body": "Changed commit from **[`fcbfe1c`](https://github.com/sagemath/sagetrac-mirror/commit/fcbfe1c7b83d2784186445651647c0a9fe408781)** to **[`319849a`](https://github.com/sagemath/sagetrac-mirror/commit/319849adf7ea1d1695f2ac67d3df00e72cc962dd)**",
    "created_at": "2018-04-14T00:49:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-384619",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`fcbfe1c`](https://github.com/sagemath/sagetrac-mirror/commit/fcbfe1c7b83d2784186445651647c0a9fe408781)** to **[`319849a`](https://github.com/sagemath/sagetrac-mirror/commit/319849adf7ea1d1695f2ac67d3df00e72cc962dd)**



---

archive/issue_comments_384620.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nThis is only slightly related, but I wanted to bring this other patch to your attention:\n\nhttps://salsa.debian.org/science-team/sagemath/blob/master/debian/patches/df-subprocess-sphinx.patch\n\nIf that is adopted, a side-effect (I think) would be to avoid the need for this patch, since all errors would instead become CalledProcessErrors.",
    "created_at": "2018-04-14T15:48:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-384620",
    "user": "https://github.com/infinity0"
}
```

<div id="comment:19" align="right">comment:19</div>

This is only slightly related, but I wanted to bring this other patch to your attention:

https://salsa.debian.org/science-team/sagemath/blob/master/debian/patches/df-subprocess-sphinx.patch

If that is adopted, a side-effect (I think) would be to avoid the need for this patch, since all errors would instead become CalledProcessErrors.



---

archive/issue_comments_384621.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nAh, thanks for pointing that out. I'm working through all the Debian patches at the moment so I might create a ticket for that one as well. (But I think it's maybe more controversial.)\n\nApart from that multiprocessing seems to work much better in Python 3, so maybe the problem goes away there\u2026",
    "created_at": "2018-04-17T17:52:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-384621",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:20" align="right">comment:20</div>

Ah, thanks for pointing that out. I'm working through all the Debian patches at the moment so I might create a ticket for that one as well. (But I think it's maybe more controversial.)

Apart from that multiprocessing seems to work much better in Python 3, so maybe the problem goes away thereâ¦



---

archive/issue_comments_384622.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nReplying to [@saraedum](#comment:13):\n> Replying to [@jdemeyer](#comment:10):\n> > Replying to [@embray](#comment:7):\n> > > Last year I started working on a generalized version of the parallel doctest runner from `sage.doctest.forker` that could also be used in docbuilds (and provided better exception handling for free).\n\n> > \n> > Huge +1 (disclaimer: I wrote that doctest forker).\n> > \n> > `multiprocessing` is broken in many ways. For this ticket, wouldn't it be possible to patch `multiprocessing` instead? That way, all users of `multiprocessing` would benefit, not only the docbuilder.\n\n> \n> What do you mean? Patch our Python SPKG or monkey-patch the multiprocessing module?\n\nI think what Jeroen means is as a more robust alternative to using `multiprocessing.Pool.map` and the like, as is currently used by the docbuilder.\n\nMy prototype implementation was compatible with (and this is why it was a bit difficult to get right) [concurrent.futures](https://docs.python.org/3/library/concurrent.futures.html) API, albeit extended to cover the additional features that the doctest runner has, such as capturing standard I/O from the worker processes.",
    "created_at": "2018-04-18T13:08:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-384622",
    "user": "https://github.com/embray"
}
```

<div id="comment:21" align="right">comment:21</div>

Replying to [@saraedum](#comment:13):
> Replying to [@jdemeyer](#comment:10):
> > Replying to [@embray](#comment:7):
> > > Last year I started working on a generalized version of the parallel doctest runner from `sage.doctest.forker` that could also be used in docbuilds (and provided better exception handling for free).

> > 
> > Huge +1 (disclaimer: I wrote that doctest forker).
> > 
> > `multiprocessing` is broken in many ways. For this ticket, wouldn't it be possible to patch `multiprocessing` instead? That way, all users of `multiprocessing` would benefit, not only the docbuilder.

> 
> What do you mean? Patch our Python SPKG or monkey-patch the multiprocessing module?

I think what Jeroen means is as a more robust alternative to using `multiprocessing.Pool.map` and the like, as is currently used by the docbuilder.

My prototype implementation was compatible with (and this is why it was a bit difficult to get right) [concurrent.futures](https://docs.python.org/3/library/concurrent.futures.html) API, albeit extended to cover the additional features that the doctest runner has, such as capturing standard I/O from the worker processes.



---

archive/issue_comments_384623.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nReplying to [@saraedum](#comment:12):\n> Replying to [@jdemeyer](#comment:11):\n> > Replying to [@embray](#comment:8):\n> > > Do you have any idea what's causing a non-`Exception` exception to be raised from the docbuild?\n\n> Maybe something coming out of cysignals. But I have no clue really.\n> \n> > `KeyboardInterrupt` is a likely candidate. This probably explains why interrupting the docbuilder is unreliable.\n\n> I observed this problem in a CI run, so I don't think it's a KeyboardInterrupt. But you're right, the above example can not be killed with Ctrl-c. It just prints the KeyboardInterrupt on Python 2.7. (Works on Python 3.6.)\n\nIt's possible that if a process is taking too long, or otherwise going beyond its allowed resource usage the CI runner tries to stop it, and it might start out \"nice\" and just send Ctrl-Cs, though it also might move on to SIGTERM and/or SIGKILL.\n\nIt sounds to me like the enormous memory usage of the docbuild might still be a problem for #24655.  We may need to try to do more work on fixing that...",
    "created_at": "2018-04-18T13:11:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-384623",
    "user": "https://github.com/embray"
}
```

<div id="comment:22" align="right">comment:22</div>

Replying to [@saraedum](#comment:12):
> Replying to [@jdemeyer](#comment:11):
> > Replying to [@embray](#comment:8):
> > > Do you have any idea what's causing a non-`Exception` exception to be raised from the docbuild?

> Maybe something coming out of cysignals. But I have no clue really.
> 
> > `KeyboardInterrupt` is a likely candidate. This probably explains why interrupting the docbuilder is unreliable.

> I observed this problem in a CI run, so I don't think it's a KeyboardInterrupt. But you're right, the above example can not be killed with Ctrl-c. It just prints the KeyboardInterrupt on Python 2.7. (Works on Python 3.6.)

It's possible that if a process is taking too long, or otherwise going beyond its allowed resource usage the CI runner tries to stop it, and it might start out "nice" and just send Ctrl-Cs, though it also might move on to SIGTERM and/or SIGKILL.

It sounds to me like the enormous memory usage of the docbuild might still be a problem for #24655.  We may need to try to do more work on fixing that...



---

archive/issue_comments_384624.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nSo, the underlying problem here was really the memory usage of the sequential docbuild, see #24655. Anyway, I think the change proposed here still makes sense.",
    "created_at": "2018-04-21T19:17:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-384624",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:23" align="right">comment:23</div>

So, the underlying problem here was really the memory usage of the sequential docbuild, see #24655. Anyway, I think the change proposed here still makes sense.



---

archive/issue_events_348309.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-23T14:10:21Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25161#event-348309"
}
```



---

archive/issue_events_348310.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-23T14:10:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25161#event-348310"
}
```



---

archive/issue_comments_384625.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nAgreed.",
    "created_at": "2018-04-23T14:10:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-384625",
    "user": "https://github.com/embray"
}
```

<div id="comment:24" align="right">comment:24</div>

Agreed.



---

archive/issue_comments_384626.json:
```json
{
    "body": "Reviewer: **Erik Bray**",
    "created_at": "2018-04-23T14:10:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-384626",
    "user": "https://github.com/embray"
}
```

Reviewer: **Erik Bray**



---

archive/issue_events_348311.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-23T14:10:28Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "milestone_number": null,
    "milestone_title": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25161#event-348311"
}
```



---

archive/issue_events_348312.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-04-23T14:10:28Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "milestone_number": null,
    "milestone_title": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25161#event-348312"
}
```



---

archive/issue_events_348313.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-05-14T17:35:59Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25161#event-348313"
}
```



---

archive/issue_events_348314.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "80d4a17edc485f0a50ee55968dd78b8d6f8c1a73",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2018-05-14T17:35:59Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25161#event-348314"
}
```



---

archive/issue_comments_384627.json:
```json
{
    "body": "Changed branch from **[u/saraedum/docbuild-base-exception](https://github.com/sagemath/sagetrac-mirror/tree/u/saraedum/docbuild-base-exception)** to **[`319849a`](https://github.com/sagemath/sagetrac-mirror/commit/319849adf7ea1d1695f2ac67d3df00e72cc962dd)**",
    "created_at": "2018-05-14T17:35:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25161",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25161#issuecomment-384627",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/saraedum/docbuild-base-exception](https://github.com/sagemath/sagetrac-mirror/tree/u/saraedum/docbuild-base-exception)** to **[`319849a`](https://github.com/sagemath/sagetrac-mirror/commit/319849adf7ea1d1695f2ac67d3df00e72cc962dd)**
