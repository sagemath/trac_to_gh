# Issue 25486: Discover SAGE_SCRIPTS_DIR to make $SAGE_LOCAL/bin/sage work from any directory, in an environment without SAGE_* variables

archive/issues_025249.json:
```json
{
    "body": "This ticket makes `$SAGE_LOCAL/bin/sage` work without environment variables set, or the current working directory to be something particular. \n\nIt does that by \n- adding `SAGE_ROOT` to  `$SAGE_LOCAL/bin/sage-env-config` (via `src/bin/sage-env-config.in`).\n- adding code to the top of `sage-env` that determines `SAGE_SCRIPTS_DIR` from the directory of itself.\n\n\n\n---\nPrevious discussion in https://groups.google.com/d/msg/sage-devel/oODph9-yjaI/FVeBsCk_CgAJ:\n\nOn Wednesday, May 30, 2018 at 9:01:59 AM UTC-7, Nils Bruin wrote:\n\n Currently, if I run the script $SAGE_LOCAL/bin/sage in my normal environment (where SAGE_ROOT is not set) then I get:\n\n Error: You must set the SAGE_ROOT environment variable or run this\n script from the SAGE_ROOT or SAGE_ROOT/local/bin/ directory.\n Error setting environment variables by sourcing '/usr/local/sage/sage-git/local/bin/sage-env';\n possibly contact sage-devel (see http://groups.google.com/group/sage-devel).\n\n If instead I run the script $SAGE_ROOT/sage a value for SAGE_ROOT is figured out and everything works \n fine when called from my normal environment.\n\n\n\n\n\nCC:  @jdemeyer @nbruin @embray @kiwifb @EmmanuelCharpentier @tobihan @saraedum @slel @timokau @dimpase\n\nKeywords: SAGE_LOCAL, SAGE_ROOT\n\nReviewer: Dima Pasechnik\n\nAuthor: Matthias Koeppe\n\nBranch: 4415da592193863627a835ebf7f44d8a8e1347fd\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/25486\n\n",
    "closed_at": "2020-06-27T09:26:50Z",
    "created_at": "2018-05-31T17:36:50Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Discover SAGE_SCRIPTS_DIR to make $SAGE_LOCAL/bin/sage work from any directory, in an environment without SAGE_* variables",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25486",
    "user": "https://github.com/mkoeppe"
}
```
This ticket makes `$SAGE_LOCAL/bin/sage` work without environment variables set, or the current working directory to be something particular. 

It does that by 
- adding `SAGE_ROOT` to  `$SAGE_LOCAL/bin/sage-env-config` (via `src/bin/sage-env-config.in`).
- adding code to the top of `sage-env` that determines `SAGE_SCRIPTS_DIR` from the directory of itself.



---
Previous discussion in https://groups.google.com/d/msg/sage-devel/oODph9-yjaI/FVeBsCk_CgAJ:

On Wednesday, May 30, 2018 at 9:01:59 AM UTC-7, Nils Bruin wrote:

 Currently, if I run the script $SAGE_LOCAL/bin/sage in my normal environment (where SAGE_ROOT is not set) then I get:

 Error: You must set the SAGE_ROOT environment variable or run this
 script from the SAGE_ROOT or SAGE_ROOT/local/bin/ directory.
 Error setting environment variables by sourcing '/usr/local/sage/sage-git/local/bin/sage-env';
 possibly contact sage-devel (see http://groups.google.com/group/sage-devel).

 If instead I run the script $SAGE_ROOT/sage a value for SAGE_ROOT is figured out and everything works 
 fine when called from my normal environment.





CC:  @jdemeyer @nbruin @embray @kiwifb @EmmanuelCharpentier @tobihan @saraedum @slel @timokau @dimpase

Keywords: SAGE_LOCAL, SAGE_ROOT

Reviewer: Dima Pasechnik

Author: Matthias Koeppe

Branch: 4415da592193863627a835ebf7f44d8a8e1347fd

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/25486





---

archive/issue_comments_378813.json:
```json
{
    "body": "<a id='comment:1'></a>Likewise, a naive trial to start the GAP shipped by Sage fails:\n\n```\n$ /path/to/sagedir/local/bin/gap\nSet the environment variable SAGE_LOCAL.\n```\nand one instead has to run:\n\n```\n$ /path/to/sagedir/sage --gap\n```\nor\n\n```\n$ SAGE_LOCAL='/path/to/sagedir' /path/to/sagedir/local/bin/gap\n```\n(where `/path/to/sagedir` should be replaced by the actual path to\nthe Sage installation directory).\n\nThis makes it hard to use\n[Gap.app](https://sourceforge.net/projects/cocoagap), the macOS\ninterface to GAP by Russ Woodroofe, with the GAP shipped by Sage.",
    "created_at": "2018-06-01T21:12:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378813",
    "user": "https://github.com/slel"
}
```

<a id='comment:1'></a>Likewise, a naive trial to start the GAP shipped by Sage fails:

```
$ /path/to/sagedir/local/bin/gap
Set the environment variable SAGE_LOCAL.
```
and one instead has to run:

```
$ /path/to/sagedir/sage --gap
```
or

```
$ SAGE_LOCAL='/path/to/sagedir' /path/to/sagedir/local/bin/gap
```
(where `/path/to/sagedir` should be replaced by the actual path to
the Sage installation directory).

This makes it hard to use
[Gap.app](https://sourceforge.net/projects/cocoagap), the macOS
interface to GAP by Russ Woodroofe, with the GAP shipped by Sage.



---

archive/issue_comments_378814.json:
```json
{
    "body": "Changing keywords from \"\" to \"SAGE_LOCAL, SAGE_ROOT\".",
    "created_at": "2018-06-01T21:12:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378814",
    "user": "https://github.com/slel"
}
```

Changing keywords from "" to "SAGE_LOCAL, SAGE_ROOT".



---

archive/issue_comments_378815.json:
```json
{
    "body": "<a id='comment:2'></a>One comment: the new version of GAP deprecates the gap.sh as the right way to start GAP.  (The gap binary detects the directory that it lives in, and uses that as the default library directory.)  Relying on the shell script to check for SAGE_LOCAL probably isn't a great idea for GAP 4.9.1 or later.  That might make this more pressing.\n\nIf you do need to check for the SAGE_LOCAL variable, it seems to me like a better place to check would be in GAP code.  (The `IO_environ()` function from the IO package will read the environment, which you could do on package load.)  But I'm coming from outside, and might not be aware of all issues.\n\nAlso, I'm the Gap.app author.  If it still looks necessary when I next make updates, I'll consider adding logic to set SAGE_LOCAL to a sensible guess on startup.  I ran out of time for this release (as I wanted to get something out at the same time as GAP 4.9.1).  I'd love for it to no longer be necessary!",
    "created_at": "2018-06-06T10:04:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378815",
    "user": "https://github.com/RussWoodroofe"
}
```

<a id='comment:2'></a>One comment: the new version of GAP deprecates the gap.sh as the right way to start GAP.  (The gap binary detects the directory that it lives in, and uses that as the default library directory.)  Relying on the shell script to check for SAGE_LOCAL probably isn't a great idea for GAP 4.9.1 or later.  That might make this more pressing.

If you do need to check for the SAGE_LOCAL variable, it seems to me like a better place to check would be in GAP code.  (The `IO_environ()` function from the IO package will read the environment, which you could do on package load.)  But I'm coming from outside, and might not be aware of all issues.

Also, I'm the Gap.app author.  If it still looks necessary when I next make updates, I'll consider adding logic to set SAGE_LOCAL to a sensible guess on startup.  I ran out of time for this release (as I wanted to get something out at the same time as GAP 4.9.1).  I'd love for it to no longer be necessary!



---

archive/issue_comments_378816.json:
```json
{
    "body": "<a id='comment:3'></a>I don't think there should be *anything* in GAP that cares about `$SAGE_LOCAL`.  If anything Sage's `bin/gap` should just be a wrapper script that sets the necessary environment variables, rather than patching `gap.sh` which it currently does =_=",
    "created_at": "2018-07-10T14:32:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378816",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>I don't think there should be *anything* in GAP that cares about `$SAGE_LOCAL`.  If anything Sage's `bin/gap` should just be a wrapper script that sets the necessary environment variables, rather than patching `gap.sh` which it currently does =_=



---

archive/issue_comments_378817.json:
```json
{
    "body": "<a id='comment:5'></a>A step into this direction: #29022 \"Create module `src/sage/env_config.py` from `src/sage/env_config.py.in`, defining variables for use in `sage.env`.",
    "created_at": "2020-01-15T23:30:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378817",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>A step into this direction: #29022 "Create module `src/sage/env_config.py` from `src/sage/env_config.py.in`, defining variables for use in `sage.env`.



---

archive/issue_events_063936.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-01-15T23:40:44Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25486#event-63936"
}
```



---

archive/issue_comments_378818.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,11 @@\n-From https://groups.google.com/d/msg/sage-devel/oODph9-yjaI/FVeBsCk_CgAJ:\n+This ticket makes \\`$SAGE_LOCAL/bin/sage\\` work without environment variables set, or the current working directory to be something particular. \n+\n+It does that by \n+- adding \\`SAGE_ROOT\\` to  \\`$SAGE_LOCAL/bin/sage-env-config\\` (via \\`src/bin/sage-env-config.in\\`).\n+- adding code to the top of \\`sage-env\\` that determines \\`SAGE_SCRIPTS_DIR\\` from the directory of itself.\n+\n+---\n+Previous discussion in https://groups.google.com/d/msg/sage-devel/oODph9-yjaI/FVeBsCk_CgAJ:\n \n On Wednesday, May 30, 2018 at 9:01:59 AM UTC-7, Nils Bruin wrote:\n \n@@ -12,10 +19,9 @@\n  If instead I run the script $SAGE_ROOT/sage a value for SAGE_ROOT is figured out and everything works \n  fine when called from my normal environment.\n \n-We should make \\`$SAGE_LOCAL/bin/sage\\` work without environment variables set.\n-We discussed this in #21479 (\\`./configure --prefix=SAGE_LOCAL\\`), when \\`$SAGE_LOCAL/bin/sage-env-config\\` was introduced; but then a less ambitious solution was implemented for that ticket.\n \n-We could add a line setting \\`$SAGE_ROOT\\` in \\`$SAGE_LOCAL/bin/sage-env-config\\` (via \\`src/bin/sage-env-config.in\\`).\n+\n+\n \n Comment: 1\n \n```\n",
    "created_at": "2020-01-17T20:27:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378818",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,11 @@
-From https://groups.google.com/d/msg/sage-devel/oODph9-yjaI/FVeBsCk_CgAJ:
+This ticket makes \`$SAGE_LOCAL/bin/sage\` work without environment variables set, or the current working directory to be something particular. 
+
+It does that by 
+- adding \`SAGE_ROOT\` to  \`$SAGE_LOCAL/bin/sage-env-config\` (via \`src/bin/sage-env-config.in\`).
+- adding code to the top of \`sage-env\` that determines \`SAGE_SCRIPTS_DIR\` from the directory of itself.
+
+---
+Previous discussion in https://groups.google.com/d/msg/sage-devel/oODph9-yjaI/FVeBsCk_CgAJ:
 
 On Wednesday, May 30, 2018 at 9:01:59 AM UTC-7, Nils Bruin wrote:
 
@@ -12,10 +19,9 @@
  If instead I run the script $SAGE_ROOT/sage a value for SAGE_ROOT is figured out and everything works 
  fine when called from my normal environment.
 
-We should make \`$SAGE_LOCAL/bin/sage\` work without environment variables set.
-We discussed this in #21479 (\`./configure --prefix=SAGE_LOCAL\`), when \`$SAGE_LOCAL/bin/sage-env-config\` was introduced; but then a less ambitious solution was implemented for that ticket.
 
-We could add a line setting \`$SAGE_ROOT\` in \`$SAGE_LOCAL/bin/sage-env-config\` (via \`src/bin/sage-env-config.in\`).
+
+
 
 Comment: 1
 
```




---

archive/issue_comments_378819.json:
```json
{
    "body": "<a id='comment:9'></a>This is adapted from an old branch of #21479 (`./configure --prefix=SAGE_LOCAL`), when `$SAGE_LOCAL/bin/sage-env-config` was introduced; but then a less ambitious solution was implemented for that ticket.\n\n---\nNew commits:",
    "created_at": "2020-01-17T20:27:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378819",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'></a>This is adapted from an old branch of #21479 (`./configure --prefix=SAGE_LOCAL`), when `$SAGE_LOCAL/bin/sage-env-config` was introduced; but then a less ambitious solution was implemented for that ticket.

---
New commits:



---

archive/issue_comments_378820.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-01-17T20:27:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378820",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_378821.json:
```json
{
    "body": "<a id='comment:10'></a>Removed a dependency that is not needed.",
    "created_at": "2020-01-18T19:12:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378821",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:10'></a>Removed a dependency that is not needed.



---

archive/issue_comments_378822.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,28 @@\n+This ticket makes \\`$SAGE_LOCAL/bin/sage\\` work without environment variables set, or the current working directory to be something particular. \n+\n+It does that by \n+- adding \\`SAGE_ROOT\\` to  \\`$SAGE_LOCAL/bin/sage-env-config\\` (via \\`src/bin/sage-env-config.in\\`).\n+- adding code to the top of \\`sage-env\\` that determines \\`SAGE_SCRIPTS_DIR\\` from the directory of itself.\n+\n+\n+\n+---\n+Previous discussion in https://groups.google.com/d/msg/sage-devel/oODph9-yjaI/FVeBsCk_CgAJ:\n+\n+On Wednesday, May 30, 2018 at 9:01:59 AM UTC-7, Nils Bruin wrote:\n+\n+ Currently, if I run the script $SAGE_LOCAL/bin/sage in my normal environment (where SAGE_ROOT is not set) then I get:\n+\n+ Error: You must set the SAGE_ROOT environment variable or run this\n+ script from the SAGE_ROOT or SAGE_ROOT/local/bin/ directory.\n+ Error setting environment variables by sourcing '/usr/local/sage/sage-git/local/bin/sage-env';\n+ possibly contact sage-devel (see http://groups.google.com/group/sage-devel).\n+\n+ If instead I run the script $SAGE_ROOT/sage a value for SAGE_ROOT is figured out and everything works \n+ fine when called from my normal environment.\n+\n+\n+\n \n \n Comment: 1\n```\n",
    "created_at": "2020-01-18T19:12:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378822",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,28 @@
+This ticket makes \`$SAGE_LOCAL/bin/sage\` work without environment variables set, or the current working directory to be something particular. 
+
+It does that by 
+- adding \`SAGE_ROOT\` to  \`$SAGE_LOCAL/bin/sage-env-config\` (via \`src/bin/sage-env-config.in\`).
+- adding code to the top of \`sage-env\` that determines \`SAGE_SCRIPTS_DIR\` from the directory of itself.
+
+
+
+---
+Previous discussion in https://groups.google.com/d/msg/sage-devel/oODph9-yjaI/FVeBsCk_CgAJ:
+
+On Wednesday, May 30, 2018 at 9:01:59 AM UTC-7, Nils Bruin wrote:
+
+ Currently, if I run the script $SAGE_LOCAL/bin/sage in my normal environment (where SAGE_ROOT is not set) then I get:
+
+ Error: You must set the SAGE_ROOT environment variable or run this
+ script from the SAGE_ROOT or SAGE_ROOT/local/bin/ directory.
+ Error setting environment variables by sourcing '/usr/local/sage/sage-git/local/bin/sage-env';
+ possibly contact sage-devel (see http://groups.google.com/group/sage-devel).
+
+ If instead I run the script $SAGE_ROOT/sage a value for SAGE_ROOT is figured out and everything works 
+ fine when called from my normal environment.
+
+
+
 
 
 Comment: 1
```




---

archive/issue_comments_378823.json:
```json
{
    "body": "<a id='comment:12'></a>A few suggestions:\n\nrename `SOURCED_SAGE_ENV_CONFIG` to `SAGE_ENV_CONFIG_SOURCED` (we already have a `SAGE_ENV_SOURCED`) variable as well.\n\nMake `sage-env-config` itself responsible for setting `SAGE_ENV_CONFIG_SOURCED`, rather than setting it in `sage-env`.\n\n```\n+# SAGE_ROOT is the location of the Sage source/build tree.\n+export SAGE_ROOT=\"@abs_top_srcdir@\"\n```\n\nWouldn't this permanently encode the directory in which Sage happens to be built in any Sage installation, including for binary builds?  E.g. if Volker does a binary build and publishes it, then it will contain in `local/bin/sage-env-config` something like `SAGE_ROOT=/home/vbraun/src/sage/` and won't work when moved.  So I'm not sure this make sense to me...\n\nHow do distros currently handle `$SAGE_ROOT`, a path that doesn't have significant meaning in standard installs?  Perhaps what we need is to do away with any dependency on `$SAGE_ROOT` at runtime.",
    "created_at": "2020-01-22T11:42:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378823",
    "user": "https://github.com/embray"
}
```

<a id='comment:12'></a>A few suggestions:

rename `SOURCED_SAGE_ENV_CONFIG` to `SAGE_ENV_CONFIG_SOURCED` (we already have a `SAGE_ENV_SOURCED`) variable as well.

Make `sage-env-config` itself responsible for setting `SAGE_ENV_CONFIG_SOURCED`, rather than setting it in `sage-env`.

```
+# SAGE_ROOT is the location of the Sage source/build tree.
+export SAGE_ROOT="@abs_top_srcdir@"
```

Wouldn't this permanently encode the directory in which Sage happens to be built in any Sage installation, including for binary builds?  E.g. if Volker does a binary build and publishes it, then it will contain in `local/bin/sage-env-config` something like `SAGE_ROOT=/home/vbraun/src/sage/` and won't work when moved.  So I'm not sure this make sense to me...

How do distros currently handle `$SAGE_ROOT`, a path that doesn't have significant meaning in standard installs?  Perhaps what we need is to do away with any dependency on `$SAGE_ROOT` at runtime.



---

archive/issue_comments_378824.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-01-22T11:42:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378824",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_378825.json:
```json
{
    "body": "<a id='comment:13'></a>I think otherwise in principle I'm +1 to this but I don't see how it resolves that last question...",
    "created_at": "2020-01-22T11:42:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378825",
    "user": "https://github.com/embray"
}
```

<a id='comment:13'></a>I think otherwise in principle I'm +1 to this but I don't see how it resolves that last question...



---

archive/issue_comments_378826.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-22T15:57:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378826",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_378827.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:12 embray]:\n> A few suggestions:\n> \n> rename `SOURCED_SAGE_ENV_CONFIG` to `SAGE_ENV_CONFIG_SOURCED` (we already have a `SAGE_ENV_SOURCED`) variable as well.\n> \n> Make `sage-env-config` itself responsible for setting `SAGE_ENV_CONFIG_SOURCED`, rather than setting it in `sage-env`.\n\n\nThanks! Done.",
    "created_at": "2020-01-22T15:57:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378827",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:15'></a>Replying to [comment:12 embray]:
> A few suggestions:
> 
> rename `SOURCED_SAGE_ENV_CONFIG` to `SAGE_ENV_CONFIG_SOURCED` (we already have a `SAGE_ENV_SOURCED`) variable as well.
> 
> Make `sage-env-config` itself responsible for setting `SAGE_ENV_CONFIG_SOURCED`, rather than setting it in `sage-env`.


Thanks! Done.



---

archive/issue_comments_378828.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:12 embray]:\n> {{{\n> +# SAGE_ROOT is the location of the Sage source/build tree.\n> +export SAGE_ROOT=\"`@`abs_top_srcdir`@`\"\n> }}}\n> \n> Wouldn't this permanently encode the directory in which Sage happens to be built in any Sage installation,  \n\n\nYes, that's what it does. Sage installations (`SAGE_LOCAL`) and non-`distclean` source trees (`SAGE_ROOT`) are not relocatable with or without this ticket.\n\n> including for binary builds? E.g. if Volker does a binary build and publishes it, then it will contain in `local/bin/sage-env-config` something like `SAGE_ROOT=/home/vbraun/src/sage/` and won't work when moved.  \n\n\nThe binary build uses `SAGE_ROOT` = a long pseudorandom path and then rewrites all paths, including this one, using https://github.com/sagemath/binary-pkg/blob/master/binary_pkg/templates/relocate-once.py the first time that `SAGE_ROOT/sage` is used.\n\n> How do distros currently handle `$SAGE_ROOT`, a path that doesn't have significant meaning in standard installs?  \n\n\nDistributions tend to replace all of `sage-env` by their own tooling anyway.\n\n> Perhaps what we need is to do away with any dependency on `$SAGE_ROOT` at runtime.\n\n\nYes, in fact, there's very little left (see #25828/#28815). In any case, that's orthogonal to the present ticket.",
    "created_at": "2020-01-22T16:15:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378828",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:16'></a>Replying to [comment:12 embray]:
> {{{
> +# SAGE_ROOT is the location of the Sage source/build tree.
> +export SAGE_ROOT="`@`abs_top_srcdir`@`"
> }}}
> 
> Wouldn't this permanently encode the directory in which Sage happens to be built in any Sage installation,  


Yes, that's what it does. Sage installations (`SAGE_LOCAL`) and non-`distclean` source trees (`SAGE_ROOT`) are not relocatable with or without this ticket.

> including for binary builds? E.g. if Volker does a binary build and publishes it, then it will contain in `local/bin/sage-env-config` something like `SAGE_ROOT=/home/vbraun/src/sage/` and won't work when moved.  


The binary build uses `SAGE_ROOT` = a long pseudorandom path and then rewrites all paths, including this one, using https://github.com/sagemath/binary-pkg/blob/master/binary_pkg/templates/relocate-once.py the first time that `SAGE_ROOT/sage` is used.

> How do distros currently handle `$SAGE_ROOT`, a path that doesn't have significant meaning in standard installs?  


Distributions tend to replace all of `sage-env` by their own tooling anyway.

> Perhaps what we need is to do away with any dependency on `$SAGE_ROOT` at runtime.


Yes, in fact, there's very little left (see #25828/#28815). In any case, that's orthogonal to the present ticket.



---

archive/issue_comments_378829.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-01-22T16:15:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378829",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_378830.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-02-01T14:08:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378830",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_378831.json:
```json
{
    "body": "<a id='comment:19'></a>Rebased on 9.1.beta2, needs review",
    "created_at": "2020-02-01T14:09:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378831",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:19'></a>Rebased on 9.1.beta2, needs review



---

archive/issue_comments_378832.json:
```json
{
    "body": "<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-02-16T20:29:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378832",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_378833.json:
```json
{
    "body": "<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-02T01:44:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378833",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_378834.json:
```json
{
    "body": "<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-09T21:26:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378834",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_378835.json:
```json
{
    "body": "<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-03-19T13:46:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378835",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_378836.json:
```json
{
    "body": "<a id='comment:24'></a>Rebased on 9.1.beta8, needs review",
    "created_at": "2020-03-19T13:46:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378836",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:24'></a>Rebased on 9.1.beta8, needs review



---

archive/issue_comments_378837.json:
```json
{
    "body": "<a id='comment:25'></a>pushing these forward to 9.2",
    "created_at": "2020-04-14T06:38:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378837",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:25'></a>pushing these forward to 9.2



---

archive/issue_events_063937.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-14T06:38:06Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25486#event-63937"
}
```



---

archive/issue_events_063938.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-14T06:38:06Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25486#event-63938"
}
```



---

archive/issue_comments_378838.json:
```json
{
    "body": "<a id='comment:26'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-06-07T21:56:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378838",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:26'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_378839.json:
```json
{
    "body": "<a id='comment:27'></a>Rebased on 9.2.beta0",
    "created_at": "2020-06-07T21:57:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378839",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:27'></a>Rebased on 9.2.beta0



---

archive/issue_comments_378840.json:
```json
{
    "body": "<a id='comment:28'></a>lgtm",
    "created_at": "2020-06-11T12:57:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378840",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:28'></a>lgtm



---

archive/issue_comments_378841.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-06-11T12:57:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378841",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_378842.json:
```json
{
    "body": "Changing status from positive_review to needs_info.",
    "created_at": "2020-06-11T13:01:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378842",
    "user": "https://github.com/dimpase"
}
```

Changing status from positive_review to needs_info.



---

archive/issue_comments_378843.json:
```json
{
    "body": "<a id='comment:29'></a>oops, sorry, doesn't it need a shebang to make sure it is running in bash?",
    "created_at": "2020-06-11T13:01:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378843",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:29'></a>oops, sorry, doesn't it need a shebang to make sure it is running in bash?



---

archive/issue_comments_378844.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2020-06-12T11:08:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378844",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_comments_378845.json:
```json
{
    "body": "<a id='comment:30'></a>Well, I guess this ticket conflicts somehow with #29345",
    "created_at": "2020-06-12T11:08:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378845",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:30'></a>Well, I guess this ticket conflicts somehow with #29345



---

archive/issue_comments_378846.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-06-24T05:12:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378846",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_378847.json:
```json
{
    "body": "<a id='comment:31'></a>Actually it is already documented that `sage-env` \"uses bash features, so it cannot be used with other shells.\" It is sourced by other scripts, so it does not need a #! line.",
    "created_at": "2020-06-24T05:12:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378847",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:31'></a>Actually it is already documented that `sage-env` "uses bash features, so it cannot be used with other shells." It is sourced by other scripts, so it does not need a #! line.



---

archive/issue_comments_378848.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-06-25T23:27:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378848",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_378849.json:
```json
{
    "body": "<a id='comment:32'></a>lgtm",
    "created_at": "2020-06-25T23:27:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378849",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:32'></a>lgtm



---

archive/issue_comments_378850.json:
```json
{
    "body": "<a id='comment:33'></a>Thanks!",
    "created_at": "2020-06-26T00:22:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378850",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:33'></a>Thanks!



---

archive/issue_events_063939.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-06-27T09:26:50Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25486#event-63939"
}
```



---

archive/issue_comments_378851.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-06-27T09:26:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378851",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_378852.json:
```json
{
    "body": "<a id='comment:35'></a>Follow up: #29446",
    "created_at": "2020-07-05T19:47:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378852",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:35'></a>Follow up: #29446



---

archive/issue_comments_378853.json:
```json
{
    "body": "<a id='comment:36'></a>Replying to [comment:31 mkoeppe]:\n> Actually it is already documented that `sage-env` \"uses bash features, so it cannot be used with other shells.\" It is sourced by other scripts, so it does not need a #! line.\n\n\nI fixed all of the bashisms in #29345, but missed that comment. The sage build now fails again with any other `/bin/sh`:\n\n```\ncd '/home/mjo/src/sage.git/build/pkgs/sage_conf' && . '/home/mjo/src/sage.git/src/bin/sage-env' && . '/home/mjo/src/sage.git/build/bin/sage-build-env-config' && sage-logger -p '/home/mjo/src/sage.git/build/pkgs/sage_conf/spkg-install' '/home/mjo/src/sage.git/logs/pkgs/sage_conf-none.log'\n/bin/sh: 123: /home/mjo/src/sage.git/src/bin/sage-env: Bad substitution\nError: SAGE_SCRIPTS_DIR is set to a bad value:\nSAGE_SCRIPTS_DIR=/home/mjo/src/sage.git/build/pkgs/sage_conf\nYou must correct it or erase it and rerun this script\nmake[3]: *** [Makefile:2022: /home/mjo/src/sage.git/local/var/lib/sage/installed/sage_conf-none] Error 1\n```\n\nDebian's dash shell is crippled, but would it be possible to symlink `/bin/sh` to dash on e.g. Arch linux, or maybe to ksh on some other distro that we have CI for? (To prevent regressions in the future?)",
    "created_at": "2020-07-13T04:04:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378853",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:36'></a>Replying to [comment:31 mkoeppe]:
> Actually it is already documented that `sage-env` "uses bash features, so it cannot be used with other shells." It is sourced by other scripts, so it does not need a #! line.


I fixed all of the bashisms in #29345, but missed that comment. The sage build now fails again with any other `/bin/sh`:

```
cd '/home/mjo/src/sage.git/build/pkgs/sage_conf' && . '/home/mjo/src/sage.git/src/bin/sage-env' && . '/home/mjo/src/sage.git/build/bin/sage-build-env-config' && sage-logger -p '/home/mjo/src/sage.git/build/pkgs/sage_conf/spkg-install' '/home/mjo/src/sage.git/logs/pkgs/sage_conf-none.log'
/bin/sh: 123: /home/mjo/src/sage.git/src/bin/sage-env: Bad substitution
Error: SAGE_SCRIPTS_DIR is set to a bad value:
SAGE_SCRIPTS_DIR=/home/mjo/src/sage.git/build/pkgs/sage_conf
You must correct it or erase it and rerun this script
make[3]: *** [Makefile:2022: /home/mjo/src/sage.git/local/var/lib/sage/installed/sage_conf-none] Error 1
```

Debian's dash shell is crippled, but would it be possible to symlink `/bin/sh` to dash on e.g. Arch linux, or maybe to ksh on some other distro that we have CI for? (To prevent regressions in the future?)



---

archive/issue_comments_378854.json:
```json
{
    "body": "<a id='comment:37'></a>Follow-up on #30128",
    "created_at": "2020-07-13T04:12:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25486",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25486#issuecomment-378854",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:37'></a>Follow-up on #30128
