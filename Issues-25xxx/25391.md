# Issue 25391: SageMath fails to build on on Fedora 28 with gcc 8.1

archive/issues_025154.json:
```json
{
    "assignees": [],
    "body": "SageMath 8.3.beta1 building produced 3 different errors when run on Fedora 28 64bit with  gcc 8.1, specifically when building the packages:\n- python 3.6.1 (fixed in #25771)\n- python 2.7.14 (fixed in #25204)\n- linbox 1.5.2  (fixed in #25353)\n\nThe 1st error manifests itself as a failure to import the crypt module during the build of Python 3.\nIt is due to an unspecified issue with Fedora 28 implementation of `crypt()`, which as reported in https://fedoraproject.org/wiki/Changes/Replace_glibc_libcrypt_with_libxcrypt is not the standard glibc implementation.\n\nThis was fixed in https://bugs.python.org/issue32635\n\n**CC:**  @dimpase\n\n**Keywords:** gcc8.1 python3 fedora28 compilation build\n\n**Branch:** [u/Vaush/sagemath_fails_to_build_on_on_fedora_28_with_gcc_8_1](https://github.com/sagemath/sagetrac-mirror/tree/u/Vaush/sagemath_fails_to_build_on_on_fedora_28_with_gcc_8_1)\n\n**Commit:** [35c3c33f42df5da1b00351205c1d984c06019eba](https://github.com/sagemath/sagetrac-mirror/commit/35c3c33f42df5da1b00351205c1d984c06019eba)\n\n**Upstream:** Fixed upstream, in a later stable release.\n\n**Reviewer:** Dima Pasechnik\n\n**Author:** Dario Asprone\n\nIssue created by migration from https://trac.sagemath.org/ticket/25391\n\n",
    "closed_at": "2018-06-22T07:57:34Z",
    "created_at": "2018-05-18T05:06:44Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20build",
        "https://github.com/sagemath/sage/labels/bug",
        "https://github.com/sagemath/sage/labels/duplicate"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "SageMath fails to build on on Fedora 28 with gcc 8.1",
    "type": "issue",
    "updated_at": "2018-08-10T23:28:44Z",
    "url": "https://github.com/sagemath/sage/issues/25391",
    "user": "https://github.com/sagetrac-Vaush"
}
```
SageMath 8.3.beta1 building produced 3 different errors when run on Fedora 28 64bit with  gcc 8.1, specifically when building the packages:
- python 3.6.1 (fixed in #25771)
- python 2.7.14 (fixed in #25204)
- linbox 1.5.2  (fixed in #25353)

The 1st error manifests itself as a failure to import the crypt module during the build of Python 3.
It is due to an unspecified issue with Fedora 28 implementation of `crypt()`, which as reported in https://fedoraproject.org/wiki/Changes/Replace_glibc_libcrypt_with_libxcrypt is not the standard glibc implementation.

This was fixed in https://bugs.python.org/issue32635

**CC:**  @dimpase

**Keywords:** gcc8.1 python3 fedora28 compilation build

**Branch:** [u/Vaush/sagemath_fails_to_build_on_on_fedora_28_with_gcc_8_1](https://github.com/sagemath/sagetrac-mirror/tree/u/Vaush/sagemath_fails_to_build_on_on_fedora_28_with_gcc_8_1)

**Commit:** [35c3c33f42df5da1b00351205c1d984c06019eba](https://github.com/sagemath/sagetrac-mirror/commit/35c3c33f42df5da1b00351205c1d984c06019eba)

**Upstream:** Fixed upstream, in a later stable release.

**Reviewer:** Dima Pasechnik

**Author:** Dario Asprone

Issue created by migration from https://trac.sagemath.org/ticket/25391





---

archive/issue_events_306342.json:
```json
{
    "actor": "https://github.com/sagetrac-Vaush",
    "created_at": "2018-05-18T05:06:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20build",
    "label_color": "08517b",
    "label_name": "component: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25391#event-306342"
}
```



---

archive/issue_events_306343.json:
```json
{
    "actor": "https://github.com/sagetrac-Vaush",
    "created_at": "2018-05-18T05:06:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "008080",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25391#event-306343"
}
```



---

archive/issue_events_306344.json:
```json
{
    "actor": "https://github.com/sagetrac-Vaush",
    "created_at": "2018-05-18T05:06:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "label": "https://github.com/sagemath/sage/labels/invalid",
    "label_color": "008080",
    "label_name": "invalid",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25391#event-306344"
}
```



---

archive/issue_comments_391292.json:
```json
{
    "body": "Linbox patch",
    "created_at": "2018-05-18T05:07:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391292",
    "user": "https://github.com/sagetrac-Vaush"
}
```

Linbox patch



---

archive/issue_comments_391293.json:
```json
{
    "body": "**Attachment:** [multiple_templates.patch.gz](https://github.com/sagemath/sage/files/ticket25391/multiple_templates.patch.gz)\n\nPython2 patch",
    "created_at": "2018-05-18T05:09:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391293",
    "user": "https://github.com/sagetrac-Vaush"
}
```

**Attachment:** [multiple_templates.patch.gz](https://github.com/sagemath/sage/files/ticket25391/multiple_templates.patch.gz)

Python2 patch



---

archive/issue_comments_391294.json:
```json
{
    "body": "**Attachment:** [packing.patch.gz](https://github.com/sagemath/sage/files/ticket25391/packing.patch.gz)\n\n**Attachment:** [crypt.patch.gz](https://github.com/sagemath/sage/files/ticket25391/crypt.patch.gz)\n\nPython3 patch - 1 of 2",
    "created_at": "2018-05-18T05:09:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391294",
    "user": "https://github.com/sagetrac-Vaush"
}
```

**Attachment:** [packing.patch.gz](https://github.com/sagemath/sage/files/ticket25391/packing.patch.gz)

**Attachment:** [crypt.patch.gz](https://github.com/sagemath/sage/files/ticket25391/crypt.patch.gz)

Python3 patch - 1 of 2



---

archive/issue_comments_391295.json:
```json
{
    "body": "Python3 patch - 2 of 2",
    "created_at": "2018-05-18T05:09:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391295",
    "user": "https://github.com/sagetrac-Vaush"
}
```

Python3 patch - 2 of 2



---

archive/issue_comments_391296.json:
```json
{
    "body": "**Dependencies:** #25204,#25353",
    "created_at": "2018-05-18T15:05:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391296",
    "user": "https://github.com/sagetrac-Vaush"
}
```

**Dependencies:** #25204,#25353



---

archive/issue_comments_391297.json:
```json
{
    "body": "<a id='comment:1'></a>\n**Attachment:** [zzz_conf.patch.gz](https://github.com/sagemath/sage/files/ticket25391/zzz_conf.patch.gz)",
    "created_at": "2018-05-18T15:05:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391297",
    "user": "https://github.com/sagetrac-Vaush"
}
```

<a id='comment:1'></a>
**Attachment:** [zzz_conf.patch.gz](https://github.com/sagemath/sage/files/ticket25391/zzz_conf.patch.gz)



---

archive/issue_comments_391298.json:
```json
{
    "body": "<a id='comment:2'></a>\nI added dependencies to #25204,#25353 which respectively fix the python 2 issue and the linbox (and fflas, which is not described here) issue.\nThe commit to be made will be based on them, and will only modify the python 3 package",
    "created_at": "2018-05-18T15:06:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391298",
    "user": "https://github.com/sagetrac-Vaush"
}
```

<a id='comment:2'></a>
I added dependencies to #25204,#25353 which respectively fix the python 2 issue and the linbox (and fflas, which is not described here) issue.
The commit to be made will be based on them, and will only modify the python 3 package



---

archive/issue_comments_391299.json:
```json
{
    "body": "**Branch:** [u/Vaush/sagemath_fails_to_build_on_on_fedora_28_with_gcc_8_1](https://github.com/sagemath/sagetrac-mirror/tree/u/Vaush/sagemath_fails_to_build_on_on_fedora_28_with_gcc_8_1)",
    "created_at": "2018-05-18T15:24:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391299",
    "user": "https://github.com/sagetrac-Vaush"
}
```

**Branch:** [u/Vaush/sagemath_fails_to_build_on_on_fedora_28_with_gcc_8_1](https://github.com/sagemath/sagetrac-mirror/tree/u/Vaush/sagemath_fails_to_build_on_on_fedora_28_with_gcc_8_1)



---

archive/issue_comments_391300.json:
```json
{
    "body": "<a id='comment:4'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4c1223e9d18995425be25fe02b527d4354666e0f\">4c1223e</a></td><td><code>Fixed python 3.6.1 crypt issue on Fedora 28</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/cb566ea35dc8e494ca3a8f0720b0a7f76c1386c1\">cb566ea</a></td><td><code>fixing gcc-8.1 compilation errors.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b20fd484bc89053e3153d492432ad56e0c7bc4c6\">b20fd48</a></td><td><code>Merge remote-tracking branch 'trac/u/cpernet/fflas_and_linbox_broken_with_gcc_8_1_0' into t/25391/sagemath_fails_to_build_on_on_fedora_28_with_gcc_8_1</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d14acae4222d507b1097cf2f875e7816bc5432b0\">d14acae</a></td><td><code>Upgrade to Python 2.7.15</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/473f2149a035a87b0941ecab426f3b32bcd20472\">473f214</a></td><td><code>Merge remote-tracking branch 'trac/u/jdemeyer/upgrade_to_python_2_7_15' into t/25391/sagemath_fails_to_build_on_on_fedora_28_with_gcc_8_1</code></td></tr></table>\n",
    "created_at": "2018-05-18T15:47:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391300",
    "user": "https://github.com/sagetrac-Vaush"
}
```

<a id='comment:4'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4c1223e9d18995425be25fe02b527d4354666e0f">4c1223e</a></td><td><code>Fixed python 3.6.1 crypt issue on Fedora 28</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/cb566ea35dc8e494ca3a8f0720b0a7f76c1386c1">cb566ea</a></td><td><code>fixing gcc-8.1 compilation errors.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b20fd484bc89053e3153d492432ad56e0c7bc4c6">b20fd48</a></td><td><code>Merge remote-tracking branch 'trac/u/cpernet/fflas_and_linbox_broken_with_gcc_8_1_0' into t/25391/sagemath_fails_to_build_on_on_fedora_28_with_gcc_8_1</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d14acae4222d507b1097cf2f875e7816bc5432b0">d14acae</a></td><td><code>Upgrade to Python 2.7.15</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/473f2149a035a87b0941ecab426f3b32bcd20472">473f214</a></td><td><code>Merge remote-tracking branch 'trac/u/jdemeyer/upgrade_to_python_2_7_15' into t/25391/sagemath_fails_to_build_on_on_fedora_28_with_gcc_8_1</code></td></tr></table>




---

archive/issue_events_306345.json:
```json
{
    "actor": "https://github.com/sagetrac-Vaush",
    "created_at": "2018-05-18T15:47:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25391#event-306345"
}
```



---

archive/issue_comments_391301.json:
```json
{
    "body": "**Commit:** [473f2149a035a87b0941ecab426f3b32bcd20472](https://github.com/sagemath/sagetrac-mirror/commit/473f2149a035a87b0941ecab426f3b32bcd20472)",
    "created_at": "2018-05-18T15:47:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391301",
    "user": "https://github.com/sagetrac-Vaush"
}
```

**Commit:** [473f2149a035a87b0941ecab426f3b32bcd20472](https://github.com/sagemath/sagetrac-mirror/commit/473f2149a035a87b0941ecab426f3b32bcd20472)



---

archive/issue_comments_391302.json:
```json
{
    "body": "<a id='comment:6'></a>\nI'll be checking that this does not break on other systems.",
    "created_at": "2018-05-19T09:01:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391302",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:6'></a>
I'll be checking that this does not break on other systems.



---

archive/issue_comments_391303.json:
```json
{
    "body": "<a id='comment:7'></a>\nHave you run tests on your branch?: `make ptest`\n(or `make ptestlong` for more tests)\n\nThis is something the ticket's author should do in such cases.\n(It would not be surprising if something unrelated to your changes fails, as gcc 8 is pretty much untested, but good to know anyway).",
    "created_at": "2018-05-19T09:44:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391303",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:7'></a>
Have you run tests on your branch?: `make ptest`
(or `make ptestlong` for more tests)

This is something the ticket's author should do in such cases.
(It would not be surprising if something unrelated to your changes fails, as gcc 8 is pretty much untested, but good to know anyway).



---

archive/issue_comments_391304.json:
```json
{
    "body": "<a id='comment:8'></a>\nI haven't, but will do",
    "created_at": "2018-05-19T12:53:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391304",
    "user": "https://github.com/sagetrac-Vaush"
}
```

<a id='comment:8'></a>
I haven't, but will do



---

archive/issue_comments_391305.json:
```json
{
    "body": "**Changing commit** from \"[473f2149a035a87b0941ecab426f3b32bcd20472](https://github.com/sagemath/sagetrac-mirror/commit/473f2149a035a87b0941ecab426f3b32bcd20472)\" to \"[5be7adc8c90d54d53c77fa8a20a8df1a223ea577](https://github.com/sagemath/sagetrac-mirror/commit/5be7adc8c90d54d53c77fa8a20a8df1a223ea577)\".",
    "created_at": "2018-05-25T13:01:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391305",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[473f2149a035a87b0941ecab426f3b32bcd20472](https://github.com/sagemath/sagetrac-mirror/commit/473f2149a035a87b0941ecab426f3b32bcd20472)" to "[5be7adc8c90d54d53c77fa8a20a8df1a223ea577](https://github.com/sagemath/sagetrac-mirror/commit/5be7adc8c90d54d53c77fa8a20a8df1a223ea577)".



---

archive/issue_comments_391306.json:
```json
{
    "body": "<a id='comment:9'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5be7adc8c90d54d53c77fa8a20a8df1a223ea577\">5be7adc</a></td><td><code>Merge branch 'master' into t/25391/sagemath_fails_to_build_on_on_fedora_28_with_gcc_8_1</code></td></tr></table>\n",
    "created_at": "2018-05-25T13:01:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391306",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:9'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5be7adc8c90d54d53c77fa8a20a8df1a223ea577">5be7adc</a></td><td><code>Merge branch 'master' into t/25391/sagemath_fails_to_build_on_on_fedora_28_with_gcc_8_1</code></td></tr></table>




---

archive/issue_comments_391307.json:
```json
{
    "body": "<a id='comment:10'></a>\nWhat is happening with this on the current 8.3.beta6?\nNote that python2 has been updated.",
    "created_at": "2018-06-20T10:22:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391307",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:10'></a>
What is happening with this on the current 8.3.beta6?
Note that python2 has been updated.



---

archive/issue_comments_391308.json:
```json
{
    "body": "<a id='comment:11'></a>\nFor Python3, it's apparently https://github.com/python/cpython/pull/4691 which is still under review.",
    "created_at": "2018-06-20T10:31:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391308",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:11'></a>
For Python3, it's apparently https://github.com/python/cpython/pull/4691 which is still under review.



---

archive/issue_comments_391309.json:
```json
{
    "body": "<a id='comment:12'></a>\nI am missing some context and documentation. The current branch only fixes Python 3. That is not consistent with the ticket description which mentions several packages and doesn't even mention the actual failure that the Python 3 patch is trying to fix.",
    "created_at": "2018-06-20T11:19:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391309",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>
I am missing some context and documentation. The current branch only fixes Python 3. That is not consistent with the ticket description which mentions several packages and doesn't even mention the actual failure that the Python 3 patch is trying to fix.



---

archive/issue_events_306346.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-06-20T11:19:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25391#event-306346"
}
```



---

archive/issue_events_306347.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-06-20T11:19:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "008080",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25391#event-306347"
}
```



---

archive/issue_comments_391310.json:
```json
{
    "body": "<a id='comment:13'></a>\nThe patch files should also contain some description, at a minimum a link to the upstream issue.\n\nAnd if you add a patch to a package, you should bump the package version.",
    "created_at": "2018-06-20T11:20:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391310",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>
The patch files should also contain some description, at a minimum a link to the upstream issue.

And if you add a patch to a package, you should bump the package version.



---

archive/issue_comments_391311.json:
```json
{
    "body": "<a id='comment:14'></a>\nOk, I'm sorry if the description or the execution aren't up to par, this is my first ticket, so I'm getting used to it.\\\\\nThe ticket was originally opened to describe the bug. After that, I succeeded in manually fixing all the bugs listed in the description, but it was brought to my attention that two of my bugs were solved in separate tickets at the same time (see the dependencies field), so I merged those tickets and added my own fix for python3, thus fixing all the issues and solving the problem stated in the ticket title, that is [SageMath](../wiki/SageMath) not compiling on Fedora 28 with gcc 8.1.\\\\\nSince the commits include the fixes for the other 2 bugs, even if by merging, I thought this counted as having a fix for all 3 of them in the branch, is this wrong?\\\\\nThere is a description for the python 3 bug, since the bug is literally \"Python tries to call crypt instead of crypt_r on Fedora, and this for some reason breaks things, so let's allow it to call crypt_r\", and the reason why it breaks things is, as pointed out by dimpase, apparently that fedora has a completely different crypt implementation, as can be seen here https://fedoraproject.org/wiki/Changes/Replace_glibc_libcrypt_with_libxcrypt.\\\\\nI'll expand on the description a bit, anyway, to make this clearer, and also to reflect the fact that this ticket only directly fixes the python3 bug, since it's only reported in the comments.\nI'll also quickly add a description and a link to the patch",
    "created_at": "2018-06-20T11:43:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391311",
    "user": "https://github.com/sagetrac-Vaush"
}
```

<a id='comment:14'></a>
Ok, I'm sorry if the description or the execution aren't up to par, this is my first ticket, so I'm getting used to it.\\
The ticket was originally opened to describe the bug. After that, I succeeded in manually fixing all the bugs listed in the description, but it was brought to my attention that two of my bugs were solved in separate tickets at the same time (see the dependencies field), so I merged those tickets and added my own fix for python3, thus fixing all the issues and solving the problem stated in the ticket title, that is [SageMath](../wiki/SageMath) not compiling on Fedora 28 with gcc 8.1.\\
Since the commits include the fixes for the other 2 bugs, even if by merging, I thought this counted as having a fix for all 3 of them in the branch, is this wrong?\\
There is a description for the python 3 bug, since the bug is literally "Python tries to call crypt instead of crypt_r on Fedora, and this for some reason breaks things, so let's allow it to call crypt_r", and the reason why it breaks things is, as pointed out by dimpase, apparently that fedora has a completely different crypt implementation, as can be seen here https://fedoraproject.org/wiki/Changes/Replace_glibc_libcrypt_with_libxcrypt.\\
I'll expand on the description a bit, anyway, to make this clearer, and also to reflect the fact that this ticket only directly fixes the python3 bug, since it's only reported in the comments.
I'll also quickly add a description and a link to the patch



---

archive/issue_comments_391312.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -14,7 +14,7 @@\n       ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n ```\n \n-The first error is due to an unspecified issue with Fedora 28 implementation of *crypt()* or its usage in pyhton 3.6.1.\n+The first error is due to an unspecified issue with Fedora 28 implementation of *crypt()*, which as reported in https://fedoraproject.org/wiki/Changes/Replace_glibc_libcrypt_with_libxcrypt is not the standard glibc implementation. Since I couldn't find a way to fix the crypt implementation in a reliable manner, I opted to implement the patch reported here https://bugs.python.org/issue28503 to allow python to use *r_crypt()*, which works.\n \n The errors in the last two packages, instead, are due to more general issues with the new 8.1 version of gcc.\n Python 2.7.14 fails to build because the way structs are aligned in C was changed in gcc 8.1, as described in https://bugs.python.org/issue33374#msg315857 .\n@@ -30,12 +30,6 @@\n }\n ```\n \n-For specifics on how the errors are solved by the attached patches, see the sage-devel discussion at https://groups.google.com/forum/#!msg/sage-devel/NgzlZknrizg/o-_Exw8jCAAJ\n+For specifics on how the errors are solved, see the sage-devel discussion at https://groups.google.com/forum/#!msg/sage-devel/NgzlZknrizg/o-_Exw8jCAAJ\n \n-**crypt.patch** is to be added to python3 package\n-**zzz_conf.patch** is to be added to python3 package\n-\n-**packing.patch** is to be added to python2 package\n-\n-**multiple_templates.patch** is to be added to linbox package   \n-\n+N.B: while originally this ticket fixed all 3 bugs, since the last two were solved separately in two different tickets, now the current ticket only fixes the python 3 bug, while mergin the tickets listed as dependencies to fix the others.\n``````\n",
    "created_at": "2018-06-20T11:50:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391312",
    "user": "https://github.com/sagetrac-Vaush"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -14,7 +14,7 @@
       ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 ```
 
-The first error is due to an unspecified issue with Fedora 28 implementation of *crypt()* or its usage in pyhton 3.6.1.
+The first error is due to an unspecified issue with Fedora 28 implementation of *crypt()*, which as reported in https://fedoraproject.org/wiki/Changes/Replace_glibc_libcrypt_with_libxcrypt is not the standard glibc implementation. Since I couldn't find a way to fix the crypt implementation in a reliable manner, I opted to implement the patch reported here https://bugs.python.org/issue28503 to allow python to use *r_crypt()*, which works.
 
 The errors in the last two packages, instead, are due to more general issues with the new 8.1 version of gcc.
 Python 2.7.14 fails to build because the way structs are aligned in C was changed in gcc 8.1, as described in https://bugs.python.org/issue33374#msg315857 .
@@ -30,12 +30,6 @@
 }
 ```
 
-For specifics on how the errors are solved by the attached patches, see the sage-devel discussion at https://groups.google.com/forum/#!msg/sage-devel/NgzlZknrizg/o-_Exw8jCAAJ
+For specifics on how the errors are solved, see the sage-devel discussion at https://groups.google.com/forum/#!msg/sage-devel/NgzlZknrizg/o-_Exw8jCAAJ
 
-**crypt.patch** is to be added to python3 package
-**zzz_conf.patch** is to be added to python3 package
-
-**packing.patch** is to be added to python2 package
-
-**multiple_templates.patch** is to be added to linbox package   
-
+N.B: while originally this ticket fixed all 3 bugs, since the last two were solved separately in two different tickets, now the current ticket only fixes the python 3 bug, while mergin the tickets listed as dependencies to fix the others.
``````




---

archive/issue_comments_391313.json:
```json
{
    "body": "**Changing commit** from \"[5be7adc8c90d54d53c77fa8a20a8df1a223ea577](https://github.com/sagemath/sagetrac-mirror/commit/5be7adc8c90d54d53c77fa8a20a8df1a223ea577)\" to \"[35c3c33f42df5da1b00351205c1d984c06019eba](https://github.com/sagemath/sagetrac-mirror/commit/35c3c33f42df5da1b00351205c1d984c06019eba)\".",
    "created_at": "2018-06-20T12:08:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391313",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[5be7adc8c90d54d53c77fa8a20a8df1a223ea577](https://github.com/sagemath/sagetrac-mirror/commit/5be7adc8c90d54d53c77fa8a20a8df1a223ea577)" to "[35c3c33f42df5da1b00351205c1d984c06019eba](https://github.com/sagemath/sagetrac-mirror/commit/35c3c33f42df5da1b00351205c1d984c06019eba)".



---

archive/issue_comments_391314.json:
```json
{
    "body": "<a id='comment:16'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/35c3c33f42df5da1b00351205c1d984c06019eba\">35c3c33</a></td><td><code>Added comments to the patches, and modified the package version</code></td></tr></table>\n",
    "created_at": "2018-06-20T12:08:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391314",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:16'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/35c3c33f42df5da1b00351205c1d984c06019eba">35c3c33</a></td><td><code>Added comments to the patches, and modified the package version</code></td></tr></table>




---

archive/issue_comments_391315.json:
```json
{
    "body": "**Reviewer:** Dima Pasechnik",
    "created_at": "2018-06-20T13:08:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391315",
    "user": "https://github.com/dimpase"
}
```

**Reviewer:** Dima Pasechnik



---

archive/issue_events_306348.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2018-06-20T13:08:10Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "008080",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25391#event-306348"
}
```



---

archive/issue_events_306349.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2018-06-20T13:08:10Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25391#event-306349"
}
```



---

archive/issue_comments_391316.json:
```json
{
    "body": "**Changing keywords** from \"gcc8.1 python3 python2 linbox fedora28 compilation build\" to \"gcc8.1 python3 fedora28 compilation build\".",
    "created_at": "2018-06-20T13:08:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391316",
    "user": "https://github.com/dimpase"
}
```

**Changing keywords** from "gcc8.1 python3 python2 linbox fedora28 compilation build" to "gcc8.1 python3 fedora28 compilation build".



---

archive/issue_comments_391317.json:
```json
{
    "body": "<a id='comment:17'></a>\nJeroen, how do you feel about merging Python 3 patch which is still being out for reviewing by Python people?",
    "created_at": "2018-06-20T13:08:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391317",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:17'></a>
Jeroen, how do you feel about merging Python 3 patch which is still being out for reviewing by Python people?



---

archive/issue_comments_391318.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,35 +1,11 @@\n-SageMath building produces 3 different errors when run on Fedora 28 64bit with  gcc 8.1, specifically when building the packages:\n+SageMath 8.3.beta1 building produced 3 different errors when run on Fedora 28 64bit with  gcc 8.1, specifically when building the packages:\n - python 3.6.1\n-- python 2.7.14\n-- linbox 1.5.2\n+- python 2.7.14 (fixed in #25204)\n+- linbox 1.5.2  (fixed in #25353)\n \n-The following errors are respectively reported:\n-- Failure to import the crypt module\n-- Failure to generate posix vars\n-- \n-\n-```\n-../../linbox/matrix/densematrix/blas-transposed-matrix.h:74:8: error: too many template-parameter-lists\n-  class TransposedBlasMatrix< TransposedBlasMatrix< Matrix > > : public Matrix{\n-      ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n-```\n-\n-The first error is due to an unspecified issue with Fedora 28 implementation of *crypt()*, which as reported in https://fedoraproject.org/wiki/Changes/Replace_glibc_libcrypt_with_libxcrypt is not the standard glibc implementation. Since I couldn't find a way to fix the crypt implementation in a reliable manner, I opted to implement the patch reported here https://bugs.python.org/issue28503 to allow python to use *r_crypt()*, which works.\n-\n-The errors in the last two packages, instead, are due to more general issues with the new 8.1 version of gcc.\n-Python 2.7.14 fails to build because the way structs are aligned in C was changed in gcc 8.1, as described in https://bugs.python.org/issue33374#msg315857 .\n+The 1st error manifests itself as a failure to import the crypt module during the build of Python 3.\n+It is due to an unspecified issue with Fedora 28 implementation of *crypt()*, which as reported in https://fedoraproject.org/wiki/Changes/Replace_glibc_libcrypt_with_libxcrypt is not the standard glibc implementation. Since I couldn't find a way to fix the crypt implementation in a reliable manner, I opted to implement the patch reported here https://bugs.python.org/issue28503 to allow python to use *r_crypt()*, which works.\n \n \n-Linbox fails to build because it uses a construct previously accepted in gcc 7 that instead produces an error in gcc 8, specifically a templated template specialization done in the following way:\n+For specifics on how the latter two errors are solved, see the sage-devel discussion at https://groups.google.com/forum/#!msg/sage-devel/NgzlZknrizg/o-_Exw8jCAAJ\n \n-```\n-template<>\n-template<typename T>\n-class Class1<Type1<T>>{\n-...\n-}\n-```\n-\n-For specifics on how the errors are solved, see the sage-devel discussion at https://groups.google.com/forum/#!msg/sage-devel/NgzlZknrizg/o-_Exw8jCAAJ\n-\n-N.B: while originally this ticket fixed all 3 bugs, since the last two were solved separately in two different tickets, now the current ticket only fixes the python 3 bug, while mergin the tickets listed as dependencies to fix the others.\n``````\n",
    "created_at": "2018-06-20T13:08:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391318",
    "user": "https://github.com/dimpase"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,35 +1,11 @@
-SageMath building produces 3 different errors when run on Fedora 28 64bit with  gcc 8.1, specifically when building the packages:
+SageMath 8.3.beta1 building produced 3 different errors when run on Fedora 28 64bit with  gcc 8.1, specifically when building the packages:
 - python 3.6.1
-- python 2.7.14
-- linbox 1.5.2
+- python 2.7.14 (fixed in #25204)
+- linbox 1.5.2  (fixed in #25353)
 
-The following errors are respectively reported:
-- Failure to import the crypt module
-- Failure to generate posix vars
-- 
-
-```
-../../linbox/matrix/densematrix/blas-transposed-matrix.h:74:8: error: too many template-parameter-lists
-  class TransposedBlasMatrix< TransposedBlasMatrix< Matrix > > : public Matrix{
-      ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
-```
-
-The first error is due to an unspecified issue with Fedora 28 implementation of *crypt()*, which as reported in https://fedoraproject.org/wiki/Changes/Replace_glibc_libcrypt_with_libxcrypt is not the standard glibc implementation. Since I couldn't find a way to fix the crypt implementation in a reliable manner, I opted to implement the patch reported here https://bugs.python.org/issue28503 to allow python to use *r_crypt()*, which works.
-
-The errors in the last two packages, instead, are due to more general issues with the new 8.1 version of gcc.
-Python 2.7.14 fails to build because the way structs are aligned in C was changed in gcc 8.1, as described in https://bugs.python.org/issue33374#msg315857 .
+The 1st error manifests itself as a failure to import the crypt module during the build of Python 3.
+It is due to an unspecified issue with Fedora 28 implementation of *crypt()*, which as reported in https://fedoraproject.org/wiki/Changes/Replace_glibc_libcrypt_with_libxcrypt is not the standard glibc implementation. Since I couldn't find a way to fix the crypt implementation in a reliable manner, I opted to implement the patch reported here https://bugs.python.org/issue28503 to allow python to use *r_crypt()*, which works.
 
 
-Linbox fails to build because it uses a construct previously accepted in gcc 7 that instead produces an error in gcc 8, specifically a templated template specialization done in the following way:
+For specifics on how the latter two errors are solved, see the sage-devel discussion at https://groups.google.com/forum/#!msg/sage-devel/NgzlZknrizg/o-_Exw8jCAAJ
 
-```
-template<>
-template<typename T>
-class Class1<Type1<T>>{
-...
-}
-```
-
-For specifics on how the errors are solved, see the sage-devel discussion at https://groups.google.com/forum/#!msg/sage-devel/NgzlZknrizg/o-_Exw8jCAAJ
-
-N.B: while originally this ticket fixed all 3 bugs, since the last two were solved separately in two different tickets, now the current ticket only fixes the python 3 bug, while mergin the tickets listed as dependencies to fix the others.
``````




---

archive/issue_comments_391319.json:
```json
{
    "body": "**Changing dependencies** from \"#25204,#25353\" to \"\".",
    "created_at": "2018-06-20T13:11:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391319",
    "user": "https://github.com/dimpase"
}
```

**Changing dependencies** from "#25204,#25353" to "".



---

archive/issue_comments_391320.json:
```json
{
    "body": "<a id='comment:19'></a>\nReplying to [Vaush](#comment%3A14):\n> Ok, I'm sorry if the description or the execution aren't up to par, this is my first ticket, so I'm getting used to it.\n\nAs a general tip: when you fix a bug, it's always important to mention what the bug is. You're certainly not the first one to post a fix for something without even mentioning what that fix is supposed to fix.",
    "created_at": "2018-06-20T14:35:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391320",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:19'></a>
Replying to [Vaush](#comment%3A14):
> Ok, I'm sorry if the description or the execution aren't up to par, this is my first ticket, so I'm getting used to it.

As a general tip: when you fix a bug, it's always important to mention what the bug is. You're certainly not the first one to post a fix for something without even mentioning what that fix is supposed to fix.



---

archive/issue_comments_391321.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -4,8 +4,4 @@\n - linbox 1.5.2  (fixed in #25353)\n \n The 1st error manifests itself as a failure to import the crypt module during the build of Python 3.\n-It is due to an unspecified issue with Fedora 28 implementation of *crypt()*, which as reported in https://fedoraproject.org/wiki/Changes/Replace_glibc_libcrypt_with_libxcrypt is not the standard glibc implementation. Since I couldn't find a way to fix the crypt implementation in a reliable manner, I opted to implement the patch reported here https://bugs.python.org/issue28503 to allow python to use *r_crypt()*, which works.\n-\n-\n-For specifics on how the latter two errors are solved, see the sage-devel discussion at https://groups.google.com/forum/#!msg/sage-devel/NgzlZknrizg/o-_Exw8jCAAJ\n-\n+It is due to an unspecified issue with Fedora 28 implementation of `crypt()`, which as reported in https://fedoraproject.org/wiki/Changes/Replace_glibc_libcrypt_with_libxcrypt is not the standard glibc implementation. Since I couldn't find a way to fix the crypt implementation in a reliable manner, I opted to implement the patch reported here https://bugs.python.org/issue28503 to allow python to use `crypt_r()`, which works.\n``````\n",
    "created_at": "2018-06-20T14:38:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391321",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -4,8 +4,4 @@
 - linbox 1.5.2  (fixed in #25353)
 
 The 1st error manifests itself as a failure to import the crypt module during the build of Python 3.
-It is due to an unspecified issue with Fedora 28 implementation of *crypt()*, which as reported in https://fedoraproject.org/wiki/Changes/Replace_glibc_libcrypt_with_libxcrypt is not the standard glibc implementation. Since I couldn't find a way to fix the crypt implementation in a reliable manner, I opted to implement the patch reported here https://bugs.python.org/issue28503 to allow python to use *r_crypt()*, which works.
-
-
-For specifics on how the latter two errors are solved, see the sage-devel discussion at https://groups.google.com/forum/#!msg/sage-devel/NgzlZknrizg/o-_Exw8jCAAJ
-
+It is due to an unspecified issue with Fedora 28 implementation of `crypt()`, which as reported in https://fedoraproject.org/wiki/Changes/Replace_glibc_libcrypt_with_libxcrypt is not the standard glibc implementation. Since I couldn't find a way to fix the crypt implementation in a reliable manner, I opted to implement the patch reported here https://bugs.python.org/issue28503 to allow python to use `crypt_r()`, which works.
``````




---

archive/issue_comments_391322.json:
```json
{
    "body": "**Upstream:** Reported upstream. Developers acknowledge bug.",
    "created_at": "2018-06-20T14:38:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391322",
    "user": "https://github.com/jdemeyer"
}
```

**Upstream:** Reported upstream. Developers acknowledge bug.



---

archive/issue_comments_391323.json:
```json
{
    "body": "Do you have a build log of the failed Python 3 build?",
    "created_at": "2018-06-20T14:38:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391323",
    "user": "https://github.com/jdemeyer"
}
```

Do you have a build log of the failed Python 3 build?



---

archive/issue_events_306350.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-06-20T14:38:43Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25391#event-306350"
}
```



---

archive/issue_events_306351.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-06-20T14:38:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "008080",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25391#event-306351"
}
```



---

archive/issue_comments_391324.json:
```json
{
    "body": "<a id='comment:21'></a>\nReplying to [@dimpase](#comment%3A17):\n> Jeroen, how do you feel about merging Python 3 patch which is still being out for reviewing by Python people?\n\nI don't mind in principle. However, I'd very much like to know what the actual bug is that this ticket is supposed to fix.",
    "created_at": "2018-06-20T14:39:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391324",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'></a>
Replying to [@dimpase](#comment%3A17):
> Jeroen, how do you feel about merging Python 3 patch which is still being out for reviewing by Python people?

I don't mind in principle. However, I'd very much like to know what the actual bug is that this ticket is supposed to fix.



---

archive/issue_comments_391325.json:
```json
{
    "body": "<a id='comment:22'></a>\nI'm attaching the log file of the failed build for python 3, when the patches are not applied.",
    "created_at": "2018-06-20T16:16:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391325",
    "user": "https://github.com/sagetrac-Vaush"
}
```

<a id='comment:22'></a>
I'm attaching the log file of the failed build for python 3, when the patches are not applied.



---

archive/issue_comments_391326.json:
```json
{
    "body": "Log of the failed python3 build",
    "created_at": "2018-06-20T16:18:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391326",
    "user": "https://github.com/sagetrac-Vaush"
}
```

Log of the failed python3 build



---

archive/issue_comments_391327.json:
```json
{
    "body": "<a id='comment:23'></a>\n**Attachment:** [python3-3.6.1.p1.log](https://github.com/sagemath/sage/files/ticket25391/python3-3.6.1.p1.log)\n\nThe log has a number of tries to build python3, only the one at the bottom of the log has this error, see line 32452:\n\n```\nTesting importing of various modules...\nctypes module imported OK\nmath module imported OK\nhashlib module imported OK\n./spkg-build: line 157: 21845 Segmentation fault      (core dumped) $PYTHON -c \"import $module\"\ncrypt module failed to import\nreadline module imported OK\nsocket module imported OK\nError: One or more modules failed to import.\n```\n\nand this is due to\n\n```\nsage/build/python3-3.6.1.p1/src/Modules/_cryptmodule.c: In function 'crypt_crypt_impl':\nsage/build/python3-3.6.1.p1/src/Modules/_cryptmodule.c:39:31: warning: implicit declaration of function 'crypt' [-Wimplicit-function-declaration]\n     return Py_BuildValue(\"s\", crypt(word, salt));\n                               ^~~~~\n```\n\nBasically, there is no `crypt` implementation available in the libraries used, one needs to use another library, and this is done in the branch of this ticket.",
    "created_at": "2018-06-20T16:26:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391327",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:23'></a>
**Attachment:** [python3-3.6.1.p1.log](https://github.com/sagemath/sage/files/ticket25391/python3-3.6.1.p1.log)

The log has a number of tries to build python3, only the one at the bottom of the log has this error, see line 32452:

```
Testing importing of various modules...
ctypes module imported OK
math module imported OK
hashlib module imported OK
./spkg-build: line 157: 21845 Segmentation fault      (core dumped) $PYTHON -c "import $module"
crypt module failed to import
readline module imported OK
socket module imported OK
Error: One or more modules failed to import.
```

and this is due to

```
sage/build/python3-3.6.1.p1/src/Modules/_cryptmodule.c: In function 'crypt_crypt_impl':
sage/build/python3-3.6.1.p1/src/Modules/_cryptmodule.c:39:31: warning: implicit declaration of function 'crypt' [-Wimplicit-function-declaration]
     return Py_BuildValue("s", crypt(word, salt));
                               ^~~~~
```

Basically, there is no `crypt` implementation available in the libraries used, one needs to use another library, and this is done in the branch of this ticket.



---

archive/issue_comments_391328.json:
```json
{
    "body": "<a id='comment:24'></a>\nsee also https://bugzilla.redhat.com/show_bug.cgi?id=1576671 (!Redhat/Fedora bug tracker)",
    "created_at": "2018-06-20T16:45:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391328",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:24'></a>
see also https://bugzilla.redhat.com/show_bug.cgi?id=1576671 (!Redhat/Fedora bug tracker)



---

archive/issue_events_306352.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2018-06-20T16:46:09Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "008080",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25391#event-306352"
}
```



---

archive/issue_events_306353.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2018-06-20T16:46:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25391#event-306353"
}
```



---

archive/issue_events_306354.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-06-21T05:32:44Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25391#event-306354"
}
```



---

archive/issue_events_306355.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-06-21T05:32:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "008080",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25391#event-306355"
}
```



---

archive/issue_comments_391329.json:
```json
{
    "body": "<a id='comment:26'></a>\nThanks for the info. It's clear to me now that the bug that we're fixing is a different one from the upstream pull request https://github.com/python/cpython/pull/4691\n\nCan you try if Python 3.7.0 (currently in rc: https://www.python.org/downloads/release/python-370rc1/) by chance fixes it?",
    "created_at": "2018-06-21T05:32:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391329",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:26'></a>
Thanks for the info. It's clear to me now that the bug that we're fixing is a different one from the upstream pull request https://github.com/python/cpython/pull/4691

Can you try if Python 3.7.0 (currently in rc: https://www.python.org/downloads/release/python-370rc1/) by chance fixes it?



---

archive/issue_comments_391330.json:
```json
{
    "body": "<a id='comment:27'></a>\nSomething else to try is compiling Python 3 without optimization (`-O0`). Can you do that for Python 3.7.0 and post the log file?",
    "created_at": "2018-06-21T05:35:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391330",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:27'></a>
Something else to try is compiling Python 3 without optimization (`-O0`). Can you do that for Python 3.7.0 and post the log file?



---

archive/issue_comments_391331.json:
```json
{
    "body": "<a id='comment:28'></a>\nTo clarify: the upstream's \u200bhttps://github.com/python/cpython/pull/4691 does not fix a bug, it provides for using `crypt_r` if available. \n\nIt also does a proper handling (introduces `HAVE_CRYPT_H`) of `crypt` and `crypt_r` at the configuration stage---without it there is a reliance on `glibc` providing `crypt` and a header different from `crypt.h` providing a prototype.",
    "created_at": "2018-06-21T06:53:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391331",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:28'></a>
To clarify: the upstream's ​https://github.com/python/cpython/pull/4691 does not fix a bug, it provides for using `crypt_r` if available. 

It also does a proper handling (introduces `HAVE_CRYPT_H`) of `crypt` and `crypt_r` at the configuration stage---without it there is a reliance on `glibc` providing `crypt` and a header different from `crypt.h` providing a prototype.



---

archive/issue_comments_391332.json:
```json
{
    "body": "**Attachment:** [crypt_debug.patch.gz](https://github.com/sagemath/sage/files/ticket25391/crypt_debug.patch.gz)",
    "created_at": "2018-06-21T08:31:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391332",
    "user": "https://github.com/jdemeyer"
}
```

**Attachment:** [crypt_debug.patch.gz](https://github.com/sagemath/sage/files/ticket25391/crypt_debug.patch.gz)



---

archive/issue_comments_391333.json:
```json
{
    "body": "<a id='comment:29'></a>\nOne final thing to try: put the file [attachment:crypt_debug.patch](https://github.com/sagemath/sage/files/ticket25391/crypt_debug.patch) in `build/pkgs/python3/patches`, rebuild Python 3.6.1 with it and report back what happens.",
    "created_at": "2018-06-21T08:33:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391333",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:29'></a>
One final thing to try: put the file [attachment:crypt_debug.patch](https://github.com/sagemath/sage/files/ticket25391/crypt_debug.patch) in `build/pkgs/python3/patches`, rebuild Python 3.6.1 with it and report back what happens.



---

archive/issue_comments_391334.json:
```json
{
    "body": "<a id='comment:30'></a>\nReplying to [@dimpase](#comment%3A23):\n> and this is due to\n> \n> ```\n> sage/build/python3-3.6.1.p1/src/Modules/_cryptmodule.c: In function 'crypt_crypt_impl':\n> sage/build/python3-3.6.1.p1/src/Modules/_cryptmodule.c:39:31: warning: implicit declaration of function 'crypt' [-Wimplicit-function-declaration]\n>      return Py_BuildValue(\"s\", crypt(word, salt));\n>                                ^~~~~\n> ```\n> \n> Basically, there is no `crypt` implementation available in the libraries used, one needs to use another library, and this is done in the branch of this ticket.\n\nI'm not convinced by this argument. If there would no `crypt` implementation, then we would get a linking error (either at compile time or runtime). But in the log file, there is a segmentation fault. So my impression is that `crypt()` is called but that it's causing a crash somehow.",
    "created_at": "2018-06-21T08:43:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391334",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:30'></a>
Replying to [@dimpase](#comment%3A23):
> and this is due to
> 
> ```
> sage/build/python3-3.6.1.p1/src/Modules/_cryptmodule.c: In function 'crypt_crypt_impl':
> sage/build/python3-3.6.1.p1/src/Modules/_cryptmodule.c:39:31: warning: implicit declaration of function 'crypt' [-Wimplicit-function-declaration]
>      return Py_BuildValue("s", crypt(word, salt));
>                                ^~~~~
> ```
> 
> Basically, there is no `crypt` implementation available in the libraries used, one needs to use another library, and this is done in the branch of this ticket.

I'm not convinced by this argument. If there would no `crypt` implementation, then we would get a linking error (either at compile time or runtime). But in the log file, there is a segmentation fault. So my impression is that `crypt()` is called but that it's causing a crash somehow.



---

archive/issue_comments_391335.json:
```json
{
    "body": "<a id='comment:31'></a>\nReplying to [@jdemeyer](#comment%3A30):\n> Replying to [@dimpase](#comment%3A23):\n> > and this is due to\n> > \n> > ```\n> > sage/build/python3-3.6.1.p1/src/Modules/_cryptmodule.c: In function 'crypt_crypt_impl':\n> > sage/build/python3-3.6.1.p1/src/Modules/_cryptmodule.c:39:31: warning: implicit declaration of function 'crypt' [-Wimplicit-function-declaration]\n> >      return Py_BuildValue(\"s\", crypt(word, salt));\n> >                                ^~~~~\n> > ```\n> > \n> > Basically, there is no `crypt` implementation available in the libraries used, one needs to use another library, and this is done in the branch of this ticket.\n\n> \n> I'm not convinced by this argument. If there would no `crypt` implementation, then we would get a linking error (either at compile time or runtime). But in the log file, there is a segmentation fault. So my impression is that `crypt()` is called but that it's causing a crash somehow.\n\nyou are right, my bad here. Anyhow, `crypt` is called without a prototype.\nOne can in fact make sure that it is called with a prototype, by removing the chunk \nabout using `crypt_r` from the branch on this ticket, i.e. the lines\n\n```\n+@@ -36,7 +41,13 @@\n+ {\n+     /* On some platforms (AtheOS) crypt returns NULL for an invalid\n+        salt. Return None in that case. XXX Maybe raise an exception?  */\n++#ifdef HAVE_CRYPT_R\n++    struct crypt_data data;\n++    data.initialized = 0;\n++    return Py_BuildValue(\"s\", crypt_r(word, salt, &data));\n++#else\n+     return Py_BuildValue(\"s\", crypt(word, salt));\n++#endif\n+ }\n+ \n+ \n```\nperhaps there would be more messages from the compiler then...",
    "created_at": "2018-06-21T08:53:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391335",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:31'></a>
Replying to [@jdemeyer](#comment%3A30):
> Replying to [@dimpase](#comment%3A23):
> > and this is due to
> > 
> > ```
> > sage/build/python3-3.6.1.p1/src/Modules/_cryptmodule.c: In function 'crypt_crypt_impl':
> > sage/build/python3-3.6.1.p1/src/Modules/_cryptmodule.c:39:31: warning: implicit declaration of function 'crypt' [-Wimplicit-function-declaration]
> >      return Py_BuildValue("s", crypt(word, salt));
> >                                ^~~~~
> > ```
> > 
> > Basically, there is no `crypt` implementation available in the libraries used, one needs to use another library, and this is done in the branch of this ticket.

> 
> I'm not convinced by this argument. If there would no `crypt` implementation, then we would get a linking error (either at compile time or runtime). But in the log file, there is a segmentation fault. So my impression is that `crypt()` is called but that it's causing a crash somehow.

you are right, my bad here. Anyhow, `crypt` is called without a prototype.
One can in fact make sure that it is called with a prototype, by removing the chunk 
about using `crypt_r` from the branch on this ticket, i.e. the lines

```
+@@ -36,7 +41,13 @@
+ {
+     /* On some platforms (AtheOS) crypt returns NULL for an invalid
+        salt. Return None in that case. XXX Maybe raise an exception?  */
++#ifdef HAVE_CRYPT_R
++    struct crypt_data data;
++    data.initialized = 0;
++    return Py_BuildValue("s", crypt_r(word, salt, &data));
++#else
+     return Py_BuildValue("s", crypt(word, salt));
++#endif
+ }
+ 
+ 
```
perhaps there would be more messages from the compiler then...



---

archive/issue_comments_391336.json:
```json
{
    "body": "<a id='comment:32'></a>\nI'm sorry for the confusion, I think I can explain what happens (not why, but at least what).\\\\\nThe *crypt()* call goes through perfectly, without issues, and returns a seemingly correct value. This value is then passed to Py_BuildValue and retrieved through varargs, but if one checks the two char* in question, that is the return value of crypt and the one Py_BuildValue retrieves, the latter is almost identical, but with the first 3-4 digits zeroed out. As an example, if crypt returns a pointer to 0xfe5ab234 (I completely made up this address), Py_BuildValue will get a pointer to 0x000ab234, and get illegal memory access when it tries to use it.\\\\\nThe missing prototype is not really a problem, at least it wasn't when I tried, because I tried adding the needed header without success.\\\\\nI want to try python 3.7.0, but are there any major differences one would have to account for, or can I just put the source code in the upstream folder and modify checksum.ini?",
    "created_at": "2018-06-21T09:42:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391336",
    "user": "https://github.com/sagetrac-Vaush"
}
```

<a id='comment:32'></a>
I'm sorry for the confusion, I think I can explain what happens (not why, but at least what).\\
The *crypt()* call goes through perfectly, without issues, and returns a seemingly correct value. This value is then passed to Py_BuildValue and retrieved through varargs, but if one checks the two char* in question, that is the return value of crypt and the one Py_BuildValue retrieves, the latter is almost identical, but with the first 3-4 digits zeroed out. As an example, if crypt returns a pointer to 0xfe5ab234 (I completely made up this address), Py_BuildValue will get a pointer to 0x000ab234, and get illegal memory access when it tries to use it.\\
The missing prototype is not really a problem, at least it wasn't when I tried, because I tried adding the needed header without success.\\
I want to try python 3.7.0, but are there any major differences one would have to account for, or can I just put the source code in the upstream folder and modify checksum.ini?



---

archive/issue_comments_391337.json:
```json
{
    "body": "<a id='comment:33'></a>\nReplying to [Vaush](#comment%3A32):\n> I'm sorry for the confusion, I think I can explain what happens (not why, but at least what).\\\\\n> The *crypt()* call goes through perfectly, without issues, and returns a seemingly correct value. This value is then passed to Py_BuildValue and retrieved through varargs, but if one checks the two char* in question, that is the return value of crypt and the one Py_BuildValue retrieves, the latter is almost identical, but with the first 3-4 digits zeroed out. As an example, if crypt returns a pointer to 0xfe5ab234 (I completely made up this address), Py_BuildValue will get a pointer to 0x000ab234, and get illegal memory access when it tries to use it.\n\nIf that's true, then the error has nothing to with `crypt()` at all and I would expect much more breakage. Can you post the code that you used to come to the conclusion above and the exact results (no \"completely made up\" address!).",
    "created_at": "2018-06-21T09:49:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391337",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:33'></a>
Replying to [Vaush](#comment%3A32):
> I'm sorry for the confusion, I think I can explain what happens (not why, but at least what).\\
> The *crypt()* call goes through perfectly, without issues, and returns a seemingly correct value. This value is then passed to Py_BuildValue and retrieved through varargs, but if one checks the two char* in question, that is the return value of crypt and the one Py_BuildValue retrieves, the latter is almost identical, but with the first 3-4 digits zeroed out. As an example, if crypt returns a pointer to 0xfe5ab234 (I completely made up this address), Py_BuildValue will get a pointer to 0x000ab234, and get illegal memory access when it tries to use it.

If that's true, then the error has nothing to with `crypt()` at all and I would expect much more breakage. Can you post the code that you used to come to the conclusion above and the exact results (no "completely made up" address!).



---

archive/issue_comments_391338.json:
```json
{
    "body": "<a id='comment:34'></a>\nReplying to [Vaush](#comment%3A32):\n> I want to try python 3.7.0, but are there any major differences one would have to account for, or can I just put the source code in the upstream folder and modify checksum.ini?\n\nI don't think anybody has tried. I guess what you said should just work.",
    "created_at": "2018-06-21T09:50:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391338",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:34'></a>
Replying to [Vaush](#comment%3A32):
> I want to try python 3.7.0, but are there any major differences one would have to account for, or can I just put the source code in the upstream folder and modify checksum.ini?

I don't think anybody has tried. I guess what you said should just work.



---

archive/issue_comments_391339.json:
```json
{
    "body": "<a id='comment:35'></a>\nI can't post the code because I didn't use any, I just stepped through the code with gdb. I checked the stack trace for the segfault, set a breakpoint to the line that called the function which calls crypt, and then stepped through manually to understand what was happening.\\\\\nI can try and get some proof from gdb later in the day, but there's not much more I can do.",
    "created_at": "2018-06-21T09:54:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391339",
    "user": "https://github.com/sagetrac-Vaush"
}
```

<a id='comment:35'></a>
I can't post the code because I didn't use any, I just stepped through the code with gdb. I checked the stack trace for the segfault, set a breakpoint to the line that called the function which calls crypt, and then stepped through manually to understand what was happening.\\
I can try and get some proof from gdb later in the day, but there's not much more I can do.



---

archive/issue_comments_391340.json:
```json
{
    "body": "<a id='comment:36'></a>\nReplying to [Vaush](#comment%3A35):\n> I can't post the code because I didn't use any, I just stepped through the code with gdb. I checked the stack trace for the segfault, set a breakpoint to the line that called the function which calls crypt, and then stepped through manually to understand what was happening.\\\\\n> I can try and get some proof from gdb later in the day, but there's not much more I can do. \n\nMy understanding is that `crypt` returns a pointer to a statically allocated location. Indeed, its man page says: `return value points to static data whose content is overwritten by each call`.\nWhereas `crypt_r` does something else, as such design as for `crypt` is not thread-safe.\n\nPerhaps this unusual design of `crypt` is the reason the breakage is not bigger?",
    "created_at": "2018-06-21T10:26:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391340",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:36'></a>
Replying to [Vaush](#comment%3A35):
> I can't post the code because I didn't use any, I just stepped through the code with gdb. I checked the stack trace for the segfault, set a breakpoint to the line that called the function which calls crypt, and then stepped through manually to understand what was happening.\\
> I can try and get some proof from gdb later in the day, but there's not much more I can do. 

My understanding is that `crypt` returns a pointer to a statically allocated location. Indeed, its man page says: `return value points to static data whose content is overwritten by each call`.
Whereas `crypt_r` does something else, as such design as for `crypt` is not thread-safe.

Perhaps this unusual design of `crypt` is the reason the breakage is not bigger?



---

archive/issue_comments_391341.json:
```json
{
    "body": "<a id='comment:37'></a>\nIn fact,  the call to `Py_BuildValue`  is\n\n```\nreturn Py_BuildValue(\"s\", crypt(word, salt));\n```\n(where we see a warning in the logs).\n\nHere `\"s\"` stands for [string](https://docs.python.org/3/c-api/arg.html) \nIt would be very interesting to see what values of `word` and `salt` are used.\nOtherwise what length it assumes by default is anyone's guess (perhaps that's why you see some bits chopped off). Indeed, it does\n\n```\nConvert a null-terminated C string to a Python str object using 'utf-8' encoding. \n```\n\nNote that Python 2 does not do `utf-8` here, so this might be a problem.\n \nHow about you try modifying the patch as I suggest in comment 31 (removing `crypt_r`-related  chunk)? This would call `crypt`, but supply a correct prototype.",
    "created_at": "2018-06-21T10:57:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391341",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:37'></a>
In fact,  the call to `Py_BuildValue`  is

```
return Py_BuildValue("s", crypt(word, salt));
```
(where we see a warning in the logs).

Here `"s"` stands for [string](https://docs.python.org/3/c-api/arg.html) 
It would be very interesting to see what values of `word` and `salt` are used.
Otherwise what length it assumes by default is anyone's guess (perhaps that's why you see some bits chopped off). Indeed, it does

```
Convert a null-terminated C string to a Python str object using 'utf-8' encoding. 
```

Note that Python 2 does not do `utf-8` here, so this might be a problem.
 
How about you try modifying the patch as I suggest in comment 31 (removing `crypt_r`-related  chunk)? This would call `crypt`, but supply a correct prototype.



---

archive/issue_comments_391342.json:
```json
{
    "body": "<a id='comment:38'></a>\nI can do that later if you want, but it's not the string that gets chopped, it's the string's address.",
    "created_at": "2018-06-21T10:59:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391342",
    "user": "https://github.com/sagetrac-Vaush"
}
```

<a id='comment:38'></a>
I can do that later if you want, but it's not the string that gets chopped, it's the string's address.



---

archive/issue_comments_391343.json:
```json
{
    "body": "<a id='comment:39'></a>\nWhat I don't know is what is supposed to happen on the import attempt. Does `crypt` get called at all? This does not seem to be necessary, as the import is about setting up a structure to call `crypt` from Python, not about calling it with any values.\n\nDid you see crypt actually being called? And with what values of `word` and `salt`?\nThis is something that is totally unclear. If they are set to bad values, or just left uninitialised, stuff can happen...",
    "created_at": "2018-06-21T11:16:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391343",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:39'></a>
What I don't know is what is supposed to happen on the import attempt. Does `crypt` get called at all? This does not seem to be necessary, as the import is about setting up a structure to call `crypt` from Python, not about calling it with any values.

Did you see crypt actually being called? And with what values of `word` and `salt`?
This is something that is totally unclear. If they are set to bad values, or just left uninitialised, stuff can happen...



---

archive/issue_comments_391344.json:
```json
{
    "body": "<a id='comment:40'></a>\nI remember them being set up correctly, and the call worked. Still, I am recompiling the whole of sage with debug symbols, I'll step through it again and report when I have news",
    "created_at": "2018-06-21T11:26:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391344",
    "user": "https://github.com/sagetrac-Vaush"
}
```

<a id='comment:40'></a>
I remember them being set up correctly, and the call worked. Still, I am recompiling the whole of sage with debug symbols, I'll step through it again and report when I have news



---

archive/issue_comments_391345.json:
```json
{
    "body": "<a id='comment:41'></a>\nReplying to [Vaush](#comment%3A35):\n> and then stepped through manually to understand what was happening.\n\nPosting the actual output from gdb would have been useful here...",
    "created_at": "2018-06-21T11:33:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391345",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:41'></a>
Replying to [Vaush](#comment%3A35):
> and then stepped through manually to understand what was happening.

Posting the actual output from gdb would have been useful here...



---

archive/issue_comments_391346.json:
```json
{
    "body": "<a id='comment:42'></a>\nReplying to [@dimpase](#comment%3A37):\n> Here `\"s\"` stands for [string](https://docs.python.org/3/c-api/arg.html) \n> It would be very interesting to see what values of `word` and `salt` are used.\n\nThat's what my debugging patch [attachment:crypt_debug.patch](https://github.com/sagemath/sage/files/ticket25391/crypt_debug.patch) does.",
    "created_at": "2018-06-21T11:34:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391346",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:42'></a>
Replying to [@dimpase](#comment%3A37):
> Here `"s"` stands for [string](https://docs.python.org/3/c-api/arg.html) 
> It would be very interesting to see what values of `word` and `salt` are used.

That's what my debugging patch [attachment:crypt_debug.patch](https://github.com/sagemath/sage/files/ticket25391/crypt_debug.patch) does.



---

archive/issue_comments_391347.json:
```json
{
    "body": "<a id='comment:43'></a>\nReplying to [@jdemeyer](#comment%3A41):\n> Replying to [Vaush](#comment%3A35):\n> > and then stepped through manually to understand what was happening.\n\n> \n> Posting the actual output from gdb would have been useful here...\n\nYes, the point is that I don't have it anymore, since I did that 2 or 3 weeks ago. As I said, I am now recompiling sage with debug symbols to redo it and post the output.",
    "created_at": "2018-06-21T11:35:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391347",
    "user": "https://github.com/sagetrac-Vaush"
}
```

<a id='comment:43'></a>
Replying to [@jdemeyer](#comment%3A41):
> Replying to [Vaush](#comment%3A35):
> > and then stepped through manually to understand what was happening.

> 
> Posting the actual output from gdb would have been useful here...

Yes, the point is that I don't have it anymore, since I did that 2 or 3 weeks ago. As I said, I am now recompiling sage with debug symbols to redo it and post the output.



---

archive/issue_comments_391348.json:
```json
{
    "body": "**Attachment:** [gdb_screenshot.png.gz](https://github.com/sagemath/sage/files/ticket25391/gdb_screenshot.png.gz)\n\nScreenshot of gdb's output",
    "created_at": "2018-06-21T13:45:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391348",
    "user": "https://github.com/sagetrac-Vaush"
}
```

**Attachment:** [gdb_screenshot.png.gz](https://github.com/sagemath/sage/files/ticket25391/gdb_screenshot.png.gz)

Screenshot of gdb's output



---

archive/issue_comments_391349.json:
```json
{
    "body": "<a id='comment:44'></a>\nOk, for some reason I can't seem to step into crypt anymore, while earlier I could see the fact that crypt on my system was a wrap around crypt_r.\\\\\nAnyway, I used jdemeyer's patch, and I'm attaching gdb's output.\\\\\nWhat happens is that Python now segfaults on the printing attempt.\nI don't have any way of confirming what I said earlier about the value being returned by crypt being fine, but causing segfaults when accessed outside of it.\\\\",
    "created_at": "2018-06-21T13:45:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391349",
    "user": "https://github.com/sagetrac-Vaush"
}
```

<a id='comment:44'></a>
Ok, for some reason I can't seem to step into crypt anymore, while earlier I could see the fact that crypt on my system was a wrap around crypt_r.\\
Anyway, I used jdemeyer's patch, and I'm attaching gdb's output.\\
What happens is that Python now segfaults on the printing attempt.
I don't have any way of confirming what I said earlier about the value being returned by crypt being fine, but causing segfaults when accessed outside of it.\\



---

archive/issue_comments_391350.json:
```json
{
    "body": "<a id='comment:45'></a>\nCould you post the output of ldd called on the corresponding *.so file?\n\nDid you use a custom-built crypt library at your 1st attempt?\n\nAnd, finally, could you add a print to show the value of the pointer `res`\nbefore the print that causes the crash? (E.g. it could return NULL, or some\nobviously invalid value...)",
    "created_at": "2018-06-21T14:13:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391350",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:45'></a>
Could you post the output of ldd called on the corresponding *.so file?

Did you use a custom-built crypt library at your 1st attempt?

And, finally, could you add a print to show the value of the pointer `res`
before the print that causes the crash? (E.g. it could return NULL, or some
obviously invalid value...)



---

archive/issue_comments_391351.json:
```json
{
    "body": "<a id='comment:46'></a>\nI don't remember using any custom-built library, so the answer would be no.\\\\\nThis is the output of ldd on the built python executable and on libcrypt:\n\n```\n[vaush@jesu-c290 src]$ ldd /lib64/libcrypt.so.1\n\tlinux-vdso.so.1 (0x00007ffe913d6000)\n\tlibc.so.6 => /lib64/libc.so.6 (0x00007f32ada5e000)\n\t/lib64/ld-linux-x86-64.so.2 (0x00007f32ae046000)\n[vaush@jesu-c290 src]$ ldd ./python\n\tlinux-vdso.so.1 (0x00007ffd247ec000)\n\tlibpython3.6dm.so.1.0 => not found\n\tlibpthread.so.0 => /lib64/libpthread.so.0 (0x00007fd8b8512000)\n\tlibdl.so.2 => /lib64/libdl.so.2 (0x00007fd8b830e000)\n\tlibutil.so.1 => /lib64/libutil.so.1 (0x00007fd8b810b000)\n\tlibm.so.6 => /lib64/libm.so.6 (0x00007fd8b7d77000)\n\tlibc.so.6 => /lib64/libc.so.6 (0x00007fd8b79b8000)\n\t/lib64/ld-linux-x86-64.so.2 (0x00007fd8b8731000)\n\n```\nFinally, no, I can't print anything about it, unless you mean before the return value of crypt is assigned to it, since we introduced it with jdemeyer's patch.",
    "created_at": "2018-06-21T14:32:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391351",
    "user": "https://github.com/sagetrac-Vaush"
}
```

<a id='comment:46'></a>
I don't remember using any custom-built library, so the answer would be no.\\
This is the output of ldd on the built python executable and on libcrypt:

```
[vaush@jesu-c290 src]$ ldd /lib64/libcrypt.so.1
	linux-vdso.so.1 (0x00007ffe913d6000)
	libc.so.6 => /lib64/libc.so.6 (0x00007f32ada5e000)
	/lib64/ld-linux-x86-64.so.2 (0x00007f32ae046000)
[vaush@jesu-c290 src]$ ldd ./python
	linux-vdso.so.1 (0x00007ffd247ec000)
	libpython3.6dm.so.1.0 => not found
	libpthread.so.0 => /lib64/libpthread.so.0 (0x00007fd8b8512000)
	libdl.so.2 => /lib64/libdl.so.2 (0x00007fd8b830e000)
	libutil.so.1 => /lib64/libutil.so.1 (0x00007fd8b810b000)
	libm.so.6 => /lib64/libm.so.6 (0x00007fd8b7d77000)
	libc.so.6 => /lib64/libc.so.6 (0x00007fd8b79b8000)
	/lib64/ld-linux-x86-64.so.2 (0x00007fd8b8731000)

```
Finally, no, I can't print anything about it, unless you mean before the return value of crypt is assigned to it, since we introduced it with jdemeyer's patch.



---

archive/issue_comments_391352.json:
```json
{
    "body": "<a id='comment:47'></a>\nReplying to [Vaush](#comment%3A46):\n> I don't remember using any custom-built library, so the answer would be no.\\\\\n> This is the output of ldd on the built python executable and on libcrypt:\n\nno, I mean the crypt.*.so or _crypt.*.so or whatever it is called; on one system I have it's here:\n\n```\n$ ldd local/lib/python3.6/lib-dynload/_crypt.cpython-36m-x86_64-linux-gnu.so\n        linux-vdso.so.1 =>  (0x00007fffdff5e000)\n        libcrypt.so.1 => /lib/x86_64-linux-gnu/libcrypt.so.1 (0x00007da738262000)\n        libpython3.6m.so.1.0 => /home/dima/sagetrac-mirror/local/lib/libpython3.6m.so.1.0 (0x00007da737d32000)\n        libpthread.so.0 => /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007da737b15000)\n        libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007da73774b000)\n        libdl.so.2 => /lib/x86_64-linux-gnu/libdl.so.2 (0x00007da737547000)\n        libutil.so.1 => /lib/x86_64-linux-gnu/libutil.so.1 (0x00007da737344000)\n        libm.so.6 => /lib/x86_64-linux-gnu/libm.so.6 (0x00007da73703b000)\n        /lib64/ld-linux-x86-64.so.2 (0x00007da73869c000)\n```\n\n\n> Finally, no, I can't print anything about it, unless you mean before the return value of crypt is assigned to it, since we introduced it with jdemeyer's patch.\n\nI meant, certainly, that you modify Jeroen's patch so that you print the **value** of the\npointer `res` (i.e. the address) after the call to crypt(), before printing the \nstring it points to (the latter print crashes).",
    "created_at": "2018-06-21T14:54:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391352",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:47'></a>
Replying to [Vaush](#comment%3A46):
> I don't remember using any custom-built library, so the answer would be no.\\
> This is the output of ldd on the built python executable and on libcrypt:

no, I mean the crypt.*.so or _crypt.*.so or whatever it is called; on one system I have it's here:

```
$ ldd local/lib/python3.6/lib-dynload/_crypt.cpython-36m-x86_64-linux-gnu.so
        linux-vdso.so.1 =>  (0x00007fffdff5e000)
        libcrypt.so.1 => /lib/x86_64-linux-gnu/libcrypt.so.1 (0x00007da738262000)
        libpython3.6m.so.1.0 => /home/dima/sagetrac-mirror/local/lib/libpython3.6m.so.1.0 (0x00007da737d32000)
        libpthread.so.0 => /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007da737b15000)
        libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007da73774b000)
        libdl.so.2 => /lib/x86_64-linux-gnu/libdl.so.2 (0x00007da737547000)
        libutil.so.1 => /lib/x86_64-linux-gnu/libutil.so.1 (0x00007da737344000)
        libm.so.6 => /lib/x86_64-linux-gnu/libm.so.6 (0x00007da73703b000)
        /lib64/ld-linux-x86-64.so.2 (0x00007da73869c000)
```


> Finally, no, I can't print anything about it, unless you mean before the return value of crypt is assigned to it, since we introduced it with jdemeyer's patch.

I meant, certainly, that you modify Jeroen's patch so that you print the **value** of the
pointer `res` (i.e. the address) after the call to crypt(), before printing the 
string it points to (the latter print crashes).



---

archive/issue_comments_391353.json:
```json
{
    "body": "<a id='comment:48'></a>\nOk, sorry for the misunderstandings.\\\\\nHere is the output of ldd:\n\n```\nvaush@jesu-c290:src$ ldd build/lib.linux-x86_64-3.6-pydebug/_crypt.cpython-36dm-x86_64-linux-gnu.so\n\tlinux-vdso.so.1 (0x00007ffeca7f6000)\n\tlibcrypt.so.1 => /lib64/libcrypt.so.1 (0x00007fe30d625000)\n\tlibpython3.6dm.so.1.0 => /run/media/vaush/SageMath/SageMath/local/var/tmp/sage/build/python3-3.6.1.p1/src/libpython3.6dm.so.1.0 (0x00007fe30d0c4000)\n\tlibpthread.so.0 => /lib64/libpthread.so.0 (0x00007fe30cea5000)\n\tlibc.so.6 => /lib64/libc.so.6 (0x00007fe30cae6000)\n\tlibdl.so.2 => /lib64/libdl.so.2 (0x00007fe30c8e2000)\n\tlibutil.so.1 => /lib64/libutil.so.1 (0x00007fe30c6df000)\n\tlibm.so.6 => /lib64/libm.so.6 (0x00007fe30c34b000)\n\t/lib64/ld-linux-x86-64.so.2 (0x00007fe30da50000)\n\n```\nWhile now python outputs this during compilation:\n\n```\n[python3-3.6.1.p1] crypt('', '$6$Ukf2OXfG3jHYFFCX')\n[python3-3.6.1.p1] Address = '0xc4c020'\n\n```\nAs you can see, the address is compatible with the theory I presented, that in some way the value of the pointer gets chopped when coming out of crypt. Still no success in stepping into crypt, but I don't see why, it was so easy the first time around...",
    "created_at": "2018-06-21T15:09:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391353",
    "user": "https://github.com/sagetrac-Vaush"
}
```

<a id='comment:48'></a>
Ok, sorry for the misunderstandings.\\
Here is the output of ldd:

```
vaush@jesu-c290:src$ ldd build/lib.linux-x86_64-3.6-pydebug/_crypt.cpython-36dm-x86_64-linux-gnu.so
	linux-vdso.so.1 (0x00007ffeca7f6000)
	libcrypt.so.1 => /lib64/libcrypt.so.1 (0x00007fe30d625000)
	libpython3.6dm.so.1.0 => /run/media/vaush/SageMath/SageMath/local/var/tmp/sage/build/python3-3.6.1.p1/src/libpython3.6dm.so.1.0 (0x00007fe30d0c4000)
	libpthread.so.0 => /lib64/libpthread.so.0 (0x00007fe30cea5000)
	libc.so.6 => /lib64/libc.so.6 (0x00007fe30cae6000)
	libdl.so.2 => /lib64/libdl.so.2 (0x00007fe30c8e2000)
	libutil.so.1 => /lib64/libutil.so.1 (0x00007fe30c6df000)
	libm.so.6 => /lib64/libm.so.6 (0x00007fe30c34b000)
	/lib64/ld-linux-x86-64.so.2 (0x00007fe30da50000)

```
While now python outputs this during compilation:

```
[python3-3.6.1.p1] crypt('', '$6$Ukf2OXfG3jHYFFCX')
[python3-3.6.1.p1] Address = '0xc4c020'

```
As you can see, the address is compatible with the theory I presented, that in some way the value of the pointer gets chopped when coming out of crypt. Still no success in stepping into crypt, but I don't see why, it was so easy the first time around...



---

archive/issue_comments_391354.json:
```json
{
    "body": "<a id='comment:49'></a>\nReplying to [Vaush](#comment%3A48):\n> Still no success in stepping into crypt, but I don't see why, it was so easy the first time around...\n\nI don't see how you'd step in a system library in a meaningful way - they usually are stripped, you won't see any symbols.\n\nHave a look at https://fedoraproject.org/wiki/StackTraces#Installing_debuginfo_RPMs_using_DNF",
    "created_at": "2018-06-21T17:11:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391354",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:49'></a>
Replying to [Vaush](#comment%3A48):
> Still no success in stepping into crypt, but I don't see why, it was so easy the first time around...

I don't see how you'd step in a system library in a meaningful way - they usually are stripped, you won't see any symbols.

Have a look at https://fedoraproject.org/wiki/StackTraces#Installing_debuginfo_RPMs_using_DNF



---

archive/issue_comments_391355.json:
```json
{
    "body": "<a id='comment:50'></a>\nI installed the debug infos already, to no avail.\nAnyway, I know that it shouldn't be possible, but the first time around I just naively did it, and stepped into the function in some way",
    "created_at": "2018-06-21T19:17:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391355",
    "user": "https://github.com/sagetrac-Vaush"
}
```

<a id='comment:50'></a>
I installed the debug infos already, to no avail.
Anyway, I know that it shouldn't be possible, but the first time around I just naively did it, and stepped into the function in some way



---

archive/issue_comments_391356.json:
```json
{
    "body": "<a id='comment:51'></a>\nI have a theory. The `implicit declaration of function 'crypt'` warning causes GCC to guess the return type as `int` (which is 32 bits). Now in reality the return type is `char *` (64 bits). So that might explain the zeroed bits.\n\nIf this theory is correct, then simply adding\n\n```\n#include <crypt.h>\n```\nshould fix the problem.\n\nCould you try just adding that line to `_cryptmodule.c`?",
    "created_at": "2018-06-21T19:40:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391356",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:51'></a>
I have a theory. The `implicit declaration of function 'crypt'` warning causes GCC to guess the return type as `int` (which is 32 bits). Now in reality the return type is `char *` (64 bits). So that might explain the zeroed bits.

If this theory is correct, then simply adding

```
#include <crypt.h>
```
should fix the problem.

Could you try just adding that line to `_cryptmodule.c`?



---

archive/issue_comments_391357.json:
```json
{
    "body": "<a id='comment:52'></a>\nReplying to [@jdemeyer](#comment%3A51):\n> I have a theory. The `implicit declaration of function 'crypt'` warning causes GCC to guess the return type as `int` (which is 32 bits). Now in reality the return type is `char *` (64 bits). So that might explain the zeroed bits.\n> \n> If this theory is correct, then simply adding\n> \n> ```\n> #include <crypt.h>\n> ```\n> should fix the problem.\n> \n> Could you try just adding that line to `_cryptmodule.c`?\n\nOr, as I have been saying already, just change the patch you are adding so that it drops `crypt_r` chunk, as it would be precisely the same thing...\nAnyhow, this theory is easy to confirm:\n\n```\n/* cry.c */\n#include <stdio.h>\n#ifdef CRYP\n#include <crypt.h>\n#endif\nint main()\n{\nchar *word=\"blah\";\nchar *salt=\"foo\";\nchar *res;\nres = crypt(word, salt);\nprintf(\"%s\\n\",res);\nreturn 0;\n}\n```\nNow trying this out, with the right include:\n\n```\n$ gcc -DCRYP cry.c -lcrypt\n$ ./a.out \nfo9NXBQQtNBSA\n```\nand without include\n\n```\n$ gcc cry.c -lcrypt\ncry.c: In function \u2018main\u2019:\ncry.c:10:7: warning: implicit declaration of function \u2018crypt\u2019 [-Wimplicit-function-declaration]\n res = crypt(word, salt);\n       ^~~~~\ncry.c:10:5: warning: assignment makes pointer from integer without a cast [-Wint-conversion]\n res = crypt(word, salt);\n     ^\n$ ./a.out \nSegmentation fault\n```\n\nMorale: pay attention to compiler warnings :-)",
    "created_at": "2018-06-22T00:35:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391357",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:52'></a>
Replying to [@jdemeyer](#comment%3A51):
> I have a theory. The `implicit declaration of function 'crypt'` warning causes GCC to guess the return type as `int` (which is 32 bits). Now in reality the return type is `char *` (64 bits). So that might explain the zeroed bits.
> 
> If this theory is correct, then simply adding
> 
> ```
> #include <crypt.h>
> ```
> should fix the problem.
> 
> Could you try just adding that line to `_cryptmodule.c`?

Or, as I have been saying already, just change the patch you are adding so that it drops `crypt_r` chunk, as it would be precisely the same thing...
Anyhow, this theory is easy to confirm:

```
/* cry.c */
#include <stdio.h>
#ifdef CRYP
#include <crypt.h>
#endif
int main()
{
char *word="blah";
char *salt="foo";
char *res;
res = crypt(word, salt);
printf("%s\n",res);
return 0;
}
```
Now trying this out, with the right include:

```
$ gcc -DCRYP cry.c -lcrypt
$ ./a.out 
fo9NXBQQtNBSA
```
and without include

```
$ gcc cry.c -lcrypt
cry.c: In function ‘main’:
cry.c:10:7: warning: implicit declaration of function ‘crypt’ [-Wimplicit-function-declaration]
 res = crypt(word, salt);
       ^~~~~
cry.c:10:5: warning: assignment makes pointer from integer without a cast [-Wint-conversion]
 res = crypt(word, salt);
     ^
$ ./a.out 
Segmentation fault
```

Morale: pay attention to compiler warnings :-)



---

archive/issue_comments_391358.json:
```json
{
    "body": "<a id='comment:53'></a>\nReplying to [@dimpase](#comment%3A52):\n> Morale: pay attention to compiler warnings :-)\n\nAbsolutely. I was totally confused earlier because the upstream PR incorrectly states \"Because crypt() only depends on primitive C types, we currently get\naway with calling it without it being declared.\"",
    "created_at": "2018-06-22T05:18:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391358",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:53'></a>
Replying to [@dimpase](#comment%3A52):
> Morale: pay attention to compiler warnings :-)

Absolutely. I was totally confused earlier because the upstream PR incorrectly states "Because crypt() only depends on primitive C types, we currently get
away with calling it without it being declared."



---

archive/issue_comments_391359.json:
```json
{
    "body": "<a id='comment:54'></a>\nThis should be fixed in 3.7.0, so we should just upgrade when that version comes out.",
    "created_at": "2018-06-22T07:57:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391359",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:54'></a>
This should be fixed in 3.7.0, so we should just upgrade when that version comes out.



---

archive/issue_events_306356.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-06-22T07:57:34Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "008080",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25391#event-306356"
}
```



---

archive/issue_events_306357.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-06-22T07:57:34Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25391#event-306357"
}
```



---

archive/issue_comments_391360.json:
```json
{
    "body": "**Changing upstream** from \"Reported upstream. Developers acknowledge bug.\" to \"Fixed upstream, in a later stable release.\".",
    "created_at": "2018-06-22T07:57:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391360",
    "user": "https://github.com/jdemeyer"
}
```

**Changing upstream** from "Reported upstream. Developers acknowledge bug." to "Fixed upstream, in a later stable release.".



---

archive/issue_events_306358.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-06-22T07:57:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "label": "https://github.com/sagemath/sage/labels/duplicate",
    "label_color": "008080",
    "label_name": "duplicate",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25391#event-306358"
}
```



---

archive/issue_comments_391361.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -4,4 +4,6 @@\n - linbox 1.5.2  (fixed in #25353)\n \n The 1st error manifests itself as a failure to import the crypt module during the build of Python 3.\n-It is due to an unspecified issue with Fedora 28 implementation of `crypt()`, which as reported in https://fedoraproject.org/wiki/Changes/Replace_glibc_libcrypt_with_libxcrypt is not the standard glibc implementation. Since I couldn't find a way to fix the crypt implementation in a reliable manner, I opted to implement the patch reported here https://bugs.python.org/issue28503 to allow python to use `crypt_r()`, which works.\n+It is due to an unspecified issue with Fedora 28 implementation of `crypt()`, which as reported in https://fedoraproject.org/wiki/Changes/Replace_glibc_libcrypt_with_libxcrypt is not the standard glibc implementation.\n+\n+This was fixed in https://bugs.python.org/issue32635\n``````\n",
    "created_at": "2018-06-22T07:57:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391361",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -4,4 +4,6 @@
 - linbox 1.5.2  (fixed in #25353)
 
 The 1st error manifests itself as a failure to import the crypt module during the build of Python 3.
-It is due to an unspecified issue with Fedora 28 implementation of `crypt()`, which as reported in https://fedoraproject.org/wiki/Changes/Replace_glibc_libcrypt_with_libxcrypt is not the standard glibc implementation. Since I couldn't find a way to fix the crypt implementation in a reliable manner, I opted to implement the patch reported here https://bugs.python.org/issue28503 to allow python to use `crypt_r()`, which works.
+It is due to an unspecified issue with Fedora 28 implementation of `crypt()`, which as reported in https://fedoraproject.org/wiki/Changes/Replace_glibc_libcrypt_with_libxcrypt is not the standard glibc implementation.
+
+This was fixed in https://bugs.python.org/issue32635
``````




---

archive/issue_events_306359.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-06-22T07:57:34Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "milestone_number": null,
    "milestone_title": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25391#event-306359"
}
```



---

archive/issue_comments_391362.json:
```json
{
    "body": "<a id='comment:55'></a>\nI made #25771 to update to Python 3.6.6 which contains the backported crypt fix",
    "created_at": "2018-07-04T14:53:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391362",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:55'></a>
I made #25771 to update to Python 3.6.6 which contains the backported crypt fix



---

archive/issue_comments_391363.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,5 +1,5 @@\n SageMath 8.3.beta1 building produced 3 different errors when run on Fedora 28 64bit with  gcc 8.1, specifically when building the packages:\n-- python 3.6.1\n+- python 3.6.1 (fixed in #25771)\n - python 2.7.14 (fixed in #25204)\n - linbox 1.5.2  (fixed in #25353)\n \n``````\n",
    "created_at": "2018-08-10T23:28:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25391#issuecomment-391363",
    "user": "https://github.com/sagetrac-Vaush"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,5 +1,5 @@
 SageMath 8.3.beta1 building produced 3 different errors when run on Fedora 28 64bit with  gcc 8.1, specifically when building the packages:
-- python 3.6.1
+- python 3.6.1 (fixed in #25771)
 - python 2.7.14 (fixed in #25204)
 - linbox 1.5.2  (fixed in #25353)
 
``````

