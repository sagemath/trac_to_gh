# Issue 25559: py3: an issue with weak cache ?

archive/issues_025322.json:
```json
{
    "body": "Trying to build the doc with sage3, one meets the following issue, for which I have no clue. Travis had an idea, maybe ?\n\n```\nsage: ct=CartanType(['C', 2, 1])\nsage: AS=ct.AmbientSpace\nsage: RS=RootSystem(ct)\nsage: AS(RS,QQ)\n---------------------------------------------------------------------------\nKeyError                                  Traceback (most recent call last)\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/misc/cachefunc.pyx in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6174)()\n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/misc/weak_dict.pyx in sage.misc.weak_dict.WeakValueDictionary.__getitem__ (build/cythonized/sage/misc/weak_dict.c:3561)()\n\nKeyError: ((<class 'sage.combinat.root_system.type_affine.AmbientSpace'>, Root system of type ['C', 2, 1], Rational Field), ())\n\nDuring handling of the above exception, another exception occurred:\n\nAttributeError                            Traceback (most recent call last)\n<ipython-input-34-c74e77f39a4f> in <module>()\n----> 1 AS(RS,QQ)\n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/misc/classcall_metaclass.pyx in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1639)()\n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/misc/cachefunc.pyx in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6300)()\n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/structure/unique_representation.py in __classcall__(cls, *args, **options)\n   1024             True\n   1025         \"\"\"\n-> 1026         instance = typecall(cls, *args, **options)\n   1027         assert isinstance( instance, cls )\n   1028         if instance.__class__.__reduce__ == CachedRepresentation.__reduce__:\n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/misc/classcall_metaclass.pyx in sage.misc.classcall_metaclass.typecall (build/cythonized/sage/misc/classcall_metaclass.c:2089)()\n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/combinat/root_system/type_affine.py in __init__(self, root_system, base_ring)\n    158         self.classical().module_morphism(self.monomial, codomain=self).register_as_coercion()\n    159         # Duplicated from ambient_space.AmbientSpace\n--> 160         coroot_lattice = self.root_system.coroot_lattice()\n    161         coroot_lattice.module_morphism(self.simple_coroot, codomain=self).register_as_coercion()\n    162 \n\n/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/combinat/root_system/root_system.py in coroot_lattice(self)\n    518             Coroot lattice of the Root system of type ['A', 3]\n    519         \"\"\"\n--> 520         return self.dual.root_lattice()\n    521 \n    522     def coroot_space(self, base_ring=QQ):\n\nAttributeError: 'RootSystem' object has no attribute 'dual'\n```\n\n**CC:**  @embray @jdemeyer @tscrim @nthiery\n\n**Reviewer:** Travis Scrimshaw\n\n**Resolution:** worksforme\n\nIssue created by migration from https://trac.sagemath.org/ticket/25559\n\n",
    "closed_at": "2018-07-26T16:27:21Z",
    "created_at": "2018-06-11T18:51:18Z",
    "labels": [
        "component: python3",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "py3: an issue with weak cache ?",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25559",
    "user": "https://github.com/fchapoton"
}
```
Trying to build the doc with sage3, one meets the following issue, for which I have no clue. Travis had an idea, maybe ?

```
sage: ct=CartanType(['C', 2, 1])
sage: AS=ct.AmbientSpace
sage: RS=RootSystem(ct)
sage: AS(RS,QQ)
---------------------------------------------------------------------------
KeyError                                  Traceback (most recent call last)
/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/misc/cachefunc.pyx in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6174)()

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/misc/weak_dict.pyx in sage.misc.weak_dict.WeakValueDictionary.__getitem__ (build/cythonized/sage/misc/weak_dict.c:3561)()

KeyError: ((<class 'sage.combinat.root_system.type_affine.AmbientSpace'>, Root system of type ['C', 2, 1], Rational Field), ())

During handling of the above exception, another exception occurred:

AttributeError                            Traceback (most recent call last)
<ipython-input-34-c74e77f39a4f> in <module>()
----> 1 AS(RS,QQ)

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/misc/classcall_metaclass.pyx in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1639)()

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/misc/cachefunc.pyx in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6300)()

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/structure/unique_representation.py in __classcall__(cls, *args, **options)
   1024             True
   1025         """
-> 1026         instance = typecall(cls, *args, **options)
   1027         assert isinstance( instance, cls )
   1028         if instance.__class__.__reduce__ == CachedRepresentation.__reduce__:

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/misc/classcall_metaclass.pyx in sage.misc.classcall_metaclass.typecall (build/cythonized/sage/misc/classcall_metaclass.c:2089)()

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/combinat/root_system/type_affine.py in __init__(self, root_system, base_ring)
    158         self.classical().module_morphism(self.monomial, codomain=self).register_as_coercion()
    159         # Duplicated from ambient_space.AmbientSpace
--> 160         coroot_lattice = self.root_system.coroot_lattice()
    161         coroot_lattice.module_morphism(self.simple_coroot, codomain=self).register_as_coercion()
    162 

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/combinat/root_system/root_system.py in coroot_lattice(self)
    518             Coroot lattice of the Root system of type ['A', 3]
    519         """
--> 520         return self.dual.root_lattice()
    521 
    522     def coroot_space(self, base_ring=QQ):

AttributeError: 'RootSystem' object has no attribute 'dual'
```

**CC:**  @embray @jdemeyer @tscrim @nthiery

**Reviewer:** Travis Scrimshaw

**Resolution:** worksforme

Issue created by migration from https://trac.sagemath.org/ticket/25559





---

archive/issue_comments_491548.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -3,6 +3,7 @@\n ```\n sage: ct=CartanType(['C', 2, 1])\n sage: AS=ct.AmbientSpace\n+sage: RS=RootSystem(ct)\n sage: AS(RS,QQ)\n ---------------------------------------------------------------------------\n KeyError                                  Traceback (most recent call last)\n``````\n",
    "created_at": "2018-06-11T18:52:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25559",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25559#issuecomment-491548",
    "user": "https://github.com/fchapoton"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -3,6 +3,7 @@
 ```
 sage: ct=CartanType(['C', 2, 1])
 sage: AS=ct.AmbientSpace
+sage: RS=RootSystem(ct)
 sage: AS(RS,QQ)
 ---------------------------------------------------------------------------
 KeyError                                  Traceback (most recent call last)
``````




---

archive/issue_comments_491549.json:
```json
{
    "body": "<a id='comment:2'></a>\nNote that this works for \n\n```\nct=CartanType(['C', 2])\n```",
    "created_at": "2018-06-11T18:56:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25559",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25559#issuecomment-491549",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:2'></a>
Note that this works for 

```
ct=CartanType(['C', 2])
```



---

archive/issue_comments_491550.json:
```json
{
    "body": "<a id='comment:3'></a>\nIncidentally, the creation of `RootSystem` includes the construction of its dual, with the root system as a construction parameter. Classic `UniqueRepresentation` memory leak. This is now #25560\n\n(I think this is orthogonal to the problem you're encountering, but I stumbled on it when browsing the relevant code).",
    "created_at": "2018-06-11T20:08:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25559",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25559#issuecomment-491550",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:3'></a>
Incidentally, the creation of `RootSystem` includes the construction of its dual, with the root system as a construction parameter. Classic `UniqueRepresentation` memory leak. This is now #25560

(I think this is orthogonal to the problem you're encountering, but I stumbled on it when browsing the relevant code).



---

archive/issue_comments_491551.json:
```json
{
    "body": "<a id='comment:4'></a>\nI'm not sure, but I don't quite understand the construction in full detail. Nicolas, I know you explained it to me once (I think it was at PyCon a few years ago), but I don't remember the details. Could you explain what is needed and why?\n\nAlso, #25560 is a duplicate of #18426.",
    "created_at": "2018-06-11T23:54:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25559",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25559#issuecomment-491551",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:4'></a>
I'm not sure, but I don't quite understand the construction in full detail. Nicolas, I know you explained it to me once (I think it was at PyCon a few years ago), but I don't remember the details. Could you explain what is needed and why?

Also, #25560 is a duplicate of #18426.



---

archive/issue_events_072861.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-06-19T12:28:26Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25559",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25559#event-72861"
}
```



---

archive/issue_comments_491552.json:
```json
{
    "body": "<a id='comment:5'></a>\naaprently, this was fixed by #25587",
    "created_at": "2018-06-19T12:28:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25559",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25559#issuecomment-491552",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:5'></a>
aaprently, this was fixed by #25587



---

archive/issue_comments_491553.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2018-06-19T12:28:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25559",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25559#issuecomment-491553",
    "user": "https://github.com/fchapoton"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_491554.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2018-06-19T23:51:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25559",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25559#issuecomment-491554",
    "user": "https://github.com/tscrim"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_491555.json:
```json
{
    "body": "<a id='comment:6'></a>\nOkay.",
    "created_at": "2018-06-19T23:51:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25559",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25559#issuecomment-491555",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:6'></a>
Okay.



---

archive/issue_comments_491556.json:
```json
{
    "body": "**Reviewer:** Travis Scrimshaw",
    "created_at": "2018-06-19T23:51:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25559",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25559#issuecomment-491556",
    "user": "https://github.com/tscrim"
}
```

**Reviewer:** Travis Scrimshaw



---

archive/issue_events_072862.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-07-26T16:27:21Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/25559",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25559#event-72862"
}
```



---

archive/issue_comments_491557.json:
```json
{
    "body": "**Resolution:** worksforme",
    "created_at": "2018-07-26T16:27:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25559",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25559#issuecomment-491557",
    "user": "https://github.com/embray"
}
```

**Resolution:** worksforme
