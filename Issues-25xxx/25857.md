# Issue 25857: Toolchain dependencies that have circular self-dependencies should not be uninstalled before reinstalling/upgrading them

archive/issues_025620.json:
```json
{
    "assignees": [],
    "body": "On Cygwin I tried doing `./sage -f mpir` and everything broke.\n\nThis is because my C compiler uses mpc and mpfr, and on Cygwin (see #25816) at least, it ends up using Sage's mpc and mpfr DLLs.  This may be less of a problem on other platforms but I haven't given much thought to it yet.\n\nThe mpc and mpfr DLLs in Sage break when Sage's mpir gets uninstalled, so it's necessary *at a minimum* to also uninstall mpc and mpfr.  But at that point it might also make sense to recursively uninstall *anything* that depends on mpir.  This seems reasonable given that they'll have to be re-built anyways.\n\nComponent: **build**\n\nAuthor: **Erik Bray**\n\nBranch/Commit: **[`fb51d4e`](https://github.com/sagemath/sagetrac-mirror/commit/fb51d4ef640bb74c3f8e09eb2c89da74fcc0e978)**\n\nReviewer: **Dima Pasechnik, Jeroen Demeyer**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/25857_\n\n",
    "closed_at": "2018-10-20T11:59:15Z",
    "created_at": "2018-07-13T11:54:27Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20build",
        "https://github.com/sagemath/sage/labels/p%3A%20critical%20/%202",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.5",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Toolchain dependencies that have circular self-dependencies should not be uninstalled before reinstalling/upgrading them",
    "type": "issue",
    "updated_at": "2018-10-28T14:52:23Z",
    "url": "https://github.com/sagemath/sage/issues/25857",
    "user": "https://github.com/embray"
}
```
On Cygwin I tried doing `./sage -f mpir` and everything broke.

This is because my C compiler uses mpc and mpfr, and on Cygwin (see #25816) at least, it ends up using Sage's mpc and mpfr DLLs.  This may be less of a problem on other platforms but I haven't given much thought to it yet.

The mpc and mpfr DLLs in Sage break when Sage's mpir gets uninstalled, so it's necessary *at a minimum* to also uninstall mpc and mpfr.  But at that point it might also make sense to recursively uninstall *anything* that depends on mpir.  This seems reasonable given that they'll have to be re-built anyways.

Component: **build**

Author: **Erik Bray**

Branch/Commit: **[`fb51d4e`](https://github.com/sagemath/sagetrac-mirror/commit/fb51d4ef640bb74c3f8e09eb2c89da74fcc0e978)**

Reviewer: **Dima Pasechnik, Jeroen Demeyer**

_Issue created by migration from https://trac.sagemath.org/ticket/25857_





---

archive/issue_events_354343.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-07-13T11:54:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "milestone_number": null,
    "milestone_title": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25857#event-354343"
}
```



---

archive/issue_events_354344.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-07-13T11:54:27Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20build",
    "label_color": "0000b0",
    "label_name": "c: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25857#event-354344"
}
```



---

archive/issue_events_354345.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-07-13T11:54:27Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25857#event-354345"
}
```



---

archive/issue_events_354346.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-07-13T11:54:27Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25857#event-354346"
}
```



---

archive/issue_events_354347.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-07-13T13:07:16Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25857#event-354347"
}
```



---

archive/issue_events_354348.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-07-13T13:07:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20blocker%20/%201",
    "label_color": "ff0000",
    "label_name": "p: blocker / 1",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25857#event-354348"
}
```



---

archive/issue_comments_397284.json:
```json
{
    "body": "Replying to [ticket:25857 embray]:\n> On Cygwin I tried doing `./sage -f mpir` and everything broke.\n\nCan you give more details :-)\n\nI disagree with your solution: it just needs to reorder the operations from\n\n1. Uninstall\n2. Build\n3. Install\n\nto\n\n1. Build\n2. Uninstall\n3. Install\n\nThat shouldn't break anything.\n\nIf this is not easy to fix, maybe we should just disable the uninstall feature for now?",
    "created_at": "2018-07-13T13:07:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397284",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [ticket:25857 embray]:
> On Cygwin I tried doing `./sage -f mpir` and everything broke.

Can you give more details :-)

I disagree with your solution: it just needs to reorder the operations from

1. Uninstall
2. Build
3. Install

to

1. Build
2. Uninstall
3. Install

That shouldn't break anything.

If this is not easy to fix, maybe we should just disable the uninstall feature for now?



---

archive/issue_comments_397285.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nReplying to [@jdemeyer](#comment%3A1):\n> Replying to [ticket:25857 embray]:\n> > On Cygwin I tried doing `./sage -f mpir` and everything broke.\n\n> \n> Can you give more details :-)\n\nI think I did in the description.  By \"everything\" I mean that as soon as mpir's configure tries to detect a C compiler, gcc breaks because it's loading DLLs from `$SAGE_LOCAL` (ugh), and those DLLs are in turn compiled against the mpir from Sage, and are incompatible with my system's GMP.\n\nThe problem here is my system's gcc using libraries from Sage, when it really shouldn't.  But this is a little difficult to avoid, unless I can patch things somewhere so that executables from the system such as gcc or git are explicitly *not* run with Sage's environment modifications (e.g. to `$PATH`).  I believe this is less of a problem on Linux.\n\n> I disagree with your solution: it just needs to reorder the operations from\n\nWhy?  I think it's a rather sensible solution.\n\n> 1. Uninstall\n> 2. Build\n> 3. Install\n> \n> to\n> \n> 1. Build\n> 2. Uninstall\n> 3. Install\n\nIt sort of depends on what you mean by \"order of operations\".  Currently, `sage-spkg` does the second process, which is certainly my preference.  (This process has its own problems, e.g. when building Python--this is partly Python's fault, and partly our fault for not providing better isolation between build and runtime environments.)\n\nHowever, when you run `./sage -f` like I did, it manually calls `make <pkg>-clean` before calling `make <pkg>`.  Perhaps it shouldn't.  \n\nI don't consider this a blocker though, unless the problem can be reproduced other than on Cygwin, since I'm pretty much the only person who does development on Cygwin, and this isn't a normal use case.",
    "created_at": "2018-07-13T13:41:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397285",
    "user": "https://github.com/embray"
}
```

<div id="comment:2" align="right">comment:2</div>

Replying to [@jdemeyer](#comment%3A1):
> Replying to [ticket:25857 embray]:
> > On Cygwin I tried doing `./sage -f mpir` and everything broke.

> 
> Can you give more details :-)

I think I did in the description.  By "everything" I mean that as soon as mpir's configure tries to detect a C compiler, gcc breaks because it's loading DLLs from `$SAGE_LOCAL` (ugh), and those DLLs are in turn compiled against the mpir from Sage, and are incompatible with my system's GMP.

The problem here is my system's gcc using libraries from Sage, when it really shouldn't.  But this is a little difficult to avoid, unless I can patch things somewhere so that executables from the system such as gcc or git are explicitly *not* run with Sage's environment modifications (e.g. to `$PATH`).  I believe this is less of a problem on Linux.

> I disagree with your solution: it just needs to reorder the operations from

Why?  I think it's a rather sensible solution.

> 1. Uninstall
> 2. Build
> 3. Install
> 
> to
> 
> 1. Build
> 2. Uninstall
> 3. Install

It sort of depends on what you mean by "order of operations".  Currently, `sage-spkg` does the second process, which is certainly my preference.  (This process has its own problems, e.g. when building Python--this is partly Python's fault, and partly our fault for not providing better isolation between build and runtime environments.)

However, when you run `./sage -f` like I did, it manually calls `make <pkg>-clean` before calling `make <pkg>`.  Perhaps it shouldn't.  

I don't consider this a blocker though, unless the problem can be reproduced other than on Cygwin, since I'm pretty much the only person who does development on Cygwin, and this isn't a normal use case.



---

archive/issue_comments_397286.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nFWIW I did lots of testing of the uninstaller on Linux, including doing odd things like `./sage -f mpir` (and I did specifically focus on mpir due to its involvement in tricky dependency cycles). Never saw any problem like this.",
    "created_at": "2018-07-13T13:42:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397286",
    "user": "https://github.com/embray"
}
```

<div id="comment:3" align="right">comment:3</div>

FWIW I did lots of testing of the uninstaller on Linux, including doing odd things like `./sage -f mpir` (and I did specifically focus on mpir due to its involvement in tricky dependency cycles). Never saw any problem like this.



---

archive/issue_comments_397287.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nAnyways, a lot more packages have problems if you *don't* remove their previous versions before building new versions of those packages, than the other way around.  In this case, it's because mpir has dependents that are in turn dependencies of the compiler.  In that case I would just uninstall all of mpir's dependents as well, hence my suggestion of recursive uninstall.\n\nI don't like uninstalling things before their replacements are built, but it seems that's pretty necessary a lot of the time.  For that reason I think I'll place a higher priority on #25202.",
    "created_at": "2018-07-13T13:45:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397287",
    "user": "https://github.com/embray"
}
```

<div id="comment:4" align="right">comment:4</div>

Anyways, a lot more packages have problems if you *don't* remove their previous versions before building new versions of those packages, than the other way around.  In this case, it's because mpir has dependents that are in turn dependencies of the compiler.  In that case I would just uninstall all of mpir's dependents as well, hence my suggestion of recursive uninstall.

I don't like uninstalling things before their replacements are built, but it seems that's pretty necessary a lot of the time.  For that reason I think I'll place a higher priority on #25202.



---

archive/issue_comments_397288.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nThis reminds me--did you ever get anywhere with creating a separate build-time package for mpir?  Something like that might also help.  Same for the other \"toolchain-deps\" (zlib, mpfr, mpc).  They all share the problem that breaking them can break the C compiler which, in turn, needs them to build.",
    "created_at": "2018-07-13T13:58:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397288",
    "user": "https://github.com/embray"
}
```

<div id="comment:5" align="right">comment:5</div>

This reminds me--did you ever get anywhere with creating a separate build-time package for mpir?  Something like that might also help.  Same for the other "toolchain-deps" (zlib, mpfr, mpc).  They all share the problem that breaking them can break the C compiler which, in turn, needs them to build.



---

archive/issue_comments_397289.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nReplying to [@embray](#comment%3A4):\n> In that case I would just uninstall all of mpir's dependents as well, hence my suggestion of recursive uninstall.\n\nHow would you deal with a Sage-built GCC? That will obviously depend on Sage's MPIR too.",
    "created_at": "2018-07-13T14:13:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397289",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:6" align="right">comment:6</div>

Replying to [@embray](#comment%3A4):
> In that case I would just uninstall all of mpir's dependents as well, hence my suggestion of recursive uninstall.

How would you deal with a Sage-built GCC? That will obviously depend on Sage's MPIR too.



---

archive/issue_comments_397290.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nReplying to [@embray](#comment%3A5):\n> This reminds me--did you ever get anywhere with creating a separate build-time package for mpir?\n\nCreating a separate package might simplify the build system, but it wouldn't fix the uninstall problem.",
    "created_at": "2018-07-13T14:14:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397290",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:7" align="right">comment:7</div>

Replying to [@embray](#comment%3A5):
> This reminds me--did you ever get anywhere with creating a separate build-time package for mpir?

Creating a separate package might simplify the build system, but it wouldn't fix the uninstall problem.



---

archive/issue_comments_397291.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nReplying to [@embray](#comment%3A3):\n> FWIW I did lots of testing of the uninstaller on Linux, including doing odd things like `./sage -f mpir` (and I did specifically focus on mpir due to its involvement in tricky dependency cycles). Never saw any problem like this.\n\nDid you do that with a Sage-built GCC? That's where things get tricky.",
    "created_at": "2018-07-13T14:15:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397291",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:8" align="right">comment:8</div>

Replying to [@embray](#comment%3A3):
> FWIW I did lots of testing of the uninstaller on Linux, including doing odd things like `./sage -f mpir` (and I did specifically focus on mpir due to its involvement in tricky dependency cycles). Never saw any problem like this.

Did you do that with a Sage-built GCC? That's where things get tricky.



---

archive/issue_comments_397292.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nA few additional thoughts:\n\na) As for sage-gcc, recursively uninstalling all dependents doubly makes sense.  If you rebuild mpir you have to rebuild gcc anyways.\n\nb) I'm thinking at the very least recursive uninstall should happen for all the \"toolchain-deps\"\n\nc) Something I think would make all of this work better (either instead of, or parallel to separate packages), would be to have a separate install prefix, either under `$SAGE_LOCAL` or parallel to `$SAGE_LOCAL` or all toolchain dependencies.  This prefix would be superseded by the usual SAGE_LOCAL paths, so the bootstrap toolchain never entirely goes away, but packages that are otherwise dependents of the toolchain can still be upgraded without breaking the existing toolchain.",
    "created_at": "2018-07-13T14:22:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397292",
    "user": "https://github.com/embray"
}
```

<div id="comment:9" align="right">comment:9</div>

A few additional thoughts:

a) As for sage-gcc, recursively uninstalling all dependents doubly makes sense.  If you rebuild mpir you have to rebuild gcc anyways.

b) I'm thinking at the very least recursive uninstall should happen for all the "toolchain-deps"

c) Something I think would make all of this work better (either instead of, or parallel to separate packages), would be to have a separate install prefix, either under `$SAGE_LOCAL` or parallel to `$SAGE_LOCAL` or all toolchain dependencies.  This prefix would be superseded by the usual SAGE_LOCAL paths, so the bootstrap toolchain never entirely goes away, but packages that are otherwise dependents of the toolchain can still be upgraded without breaking the existing toolchain.



---

archive/issue_comments_397293.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@jdemeyer](#comment%3A8):\n> Replying to [@embray](#comment%3A3):\n> > FWIW I did lots of testing of the uninstaller on Linux, including doing odd things like `./sage -f mpir` (and I did specifically focus on mpir due to its involvement in tricky dependency cycles). Never saw any problem like this.\n\n> \n> Did you do that with a Sage-built GCC? That's where things get tricky.\n\nI did, and I don't remember having any problems (again, on Linux), but that was a long time ago now so my memory is hazy.",
    "created_at": "2018-07-13T14:23:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397293",
    "user": "https://github.com/embray"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@jdemeyer](#comment%3A8):
> Replying to [@embray](#comment%3A3):
> > FWIW I did lots of testing of the uninstaller on Linux, including doing odd things like `./sage -f mpir` (and I did specifically focus on mpir due to its involvement in tricky dependency cycles). Never saw any problem like this.

> 
> Did you do that with a Sage-built GCC? That's where things get tricky.

I did, and I don't remember having any problems (again, on Linux), but that was a long time ago now so my memory is hazy.



---

archive/issue_comments_397294.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nReplying to [@embray](#comment%3A10):\n> I did, and I don't remember having any problems (again, on Linux)\n\nMaybe your system GMP libraries were compatible with the Sage MPIR libraries, so the GCC-in-Sage used your system GMP library while MPIR was being rebuilt? Just guessing...",
    "created_at": "2018-07-13T14:28:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397294",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:11" align="right">comment:11</div>

Replying to [@embray](#comment%3A10):
> I did, and I don't remember having any problems (again, on Linux)

Maybe your system GMP libraries were compatible with the Sage MPIR libraries, so the GCC-in-Sage used your system GMP library while MPIR was being rebuilt? Just guessing...



---

archive/issue_comments_397295.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nI'd think it would almost have to.  I don't see how else it could work.\n\nAll the more reason to have separate copies as \"toolchain dependencies\", and even then only needed when doing silly things like building gcc.  Then, a developer wanting to do things (such as I was doing) like experiment with patching and reconfiguring mpir can do so on top of that without breaking the toolchain.",
    "created_at": "2018-07-13T14:36:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397295",
    "user": "https://github.com/embray"
}
```

<div id="comment:12" align="right">comment:12</div>

I'd think it would almost have to.  I don't see how else it could work.

All the more reason to have separate copies as "toolchain dependencies", and even then only needed when doing silly things like building gcc.  Then, a developer wanting to do things (such as I was doing) like experiment with patching and reconfiguring mpir can do so on top of that without breaking the toolchain.



---

archive/issue_comments_397296.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nThe question is what can we do *right now* to fix this serious bug?",
    "created_at": "2018-07-13T14:53:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397296",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:13" align="right">comment:13</div>

The question is what can we do *right now* to fix this serious bug?



---

archive/issue_comments_397297.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nUnless someone can reproduce this outside of Cygwin, I don't think it's that serious.  I just installed sage-gcc on a Linux build and am trying all manner of `./sage -f mpir/gcc/etc` without any problems.\n\nI'm going to keep thinking about it though.  If I can find a simple solution that works for Cygwin I believe it would work on Linux as well.  Perhaps one very localized solution would be that if one of the `toolchain-deps` gets uninstalled they should all be uninstalled and rebuilt.",
    "created_at": "2018-07-13T15:19:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397297",
    "user": "https://github.com/embray"
}
```

<div id="comment:14" align="right">comment:14</div>

Unless someone can reproduce this outside of Cygwin, I don't think it's that serious.  I just installed sage-gcc on a Linux build and am trying all manner of `./sage -f mpir/gcc/etc` without any problems.

I'm going to keep thinking about it though.  If I can find a simple solution that works for Cygwin I believe it would work on Linux as well.  Perhaps one very localized solution would be that if one of the `toolchain-deps` gets uninstalled they should all be uninstalled and rebuilt.



---

archive/issue_comments_397298.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nReplying to [@embray](#comment%3A14):\n> Unless someone can reproduce this outside of Cygwin, I don't think it's that serious.\n\nGiven the analysis, I don't see any reason why this would be limited to Cygwin.",
    "created_at": "2018-07-16T10:49:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397298",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:15" align="right">comment:15</div>

Replying to [@embray](#comment%3A14):
> Unless someone can reproduce this outside of Cygwin, I don't think it's that serious.

Given the analysis, I don't see any reason why this would be limited to Cygwin.



---

archive/issue_comments_397299.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nJust reproduced it on Ubuntu 16.04.1 LTS (CPU architecture ppc64le) with system compiler\n\n```\ngcc (Ubuntu/IBM 5.4.0-6ubuntu1~16.04.10) 5.4.0 20160609\nCopyright (C) 2015 Free Software Foundation, Inc.\nThis is free software; see the source for copying conditions.  There is NO\nwarranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n```\n\nWhen running `./sage -f mpir` on Sage 8.3.rc1, the problem is as I predicted:\n\n```\n$ ldd local/libexec/gcc/powerpc64le-unknown-linux-gnu/7.2.0/cc1\n        linux-vdso64.so.1 =>  (0x00003fffa2290000)\n        libmpc.so.3 => /home/jdemeyer/sage-test/local/lib/libmpc.so.3 (0x00003fffa2260000)\n        libmpfr.so.6 => /home/jdemeyer/sage-test/local/lib/libmpfr.so.6 (0x00003fffa21c0000)\n        libgmp.so.23 => not found\n        libdl.so.2 => /lib/powerpc64le-linux-gnu/libdl.so.2 (0x00003fffa2180000)\n        libz.so.1 => /home/jdemeyer/sage-test/local/lib/libz.so.1 (0x00003fffa2140000)\n        libm.so.6 => /lib/powerpc64le-linux-gnu/libm.so.6 (0x00003fffa2050000)\n        libc.so.6 => /lib/powerpc64le-linux-gnu/libc.so.6 (0x00003fffa1e80000)\n        /lib64/ld64.so.2 (0x00003fffa22b0000)\n        libgmp.so.23 => not found\n        libgmp.so.23 => not found\n```\ncausing obvious build failures.",
    "created_at": "2018-07-16T11:16:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397299",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:16" align="right">comment:16</div>

Just reproduced it on Ubuntu 16.04.1 LTS (CPU architecture ppc64le) with system compiler

```
gcc (Ubuntu/IBM 5.4.0-6ubuntu1~16.04.10) 5.4.0 20160609
Copyright (C) 2015 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
```

When running `./sage -f mpir` on Sage 8.3.rc1, the problem is as I predicted:

```
$ ldd local/libexec/gcc/powerpc64le-unknown-linux-gnu/7.2.0/cc1
        linux-vdso64.so.1 =>  (0x00003fffa2290000)
        libmpc.so.3 => /home/jdemeyer/sage-test/local/lib/libmpc.so.3 (0x00003fffa2260000)
        libmpfr.so.6 => /home/jdemeyer/sage-test/local/lib/libmpfr.so.6 (0x00003fffa21c0000)
        libgmp.so.23 => not found
        libdl.so.2 => /lib/powerpc64le-linux-gnu/libdl.so.2 (0x00003fffa2180000)
        libz.so.1 => /home/jdemeyer/sage-test/local/lib/libz.so.1 (0x00003fffa2140000)
        libm.so.6 => /lib/powerpc64le-linux-gnu/libm.so.6 (0x00003fffa2050000)
        libc.so.6 => /lib/powerpc64le-linux-gnu/libc.so.6 (0x00003fffa1e80000)
        /lib64/ld64.so.2 (0x00003fffa22b0000)
        libgmp.so.23 => not found
        libgmp.so.23 => not found
```
causing obvious build failures.



---

archive/issue_comments_397300.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nI'll try to reproduce that on x86_64, as I don't have access to that architecture.  But I see what you're saying in general.\n\nThere are two cases here:\n\n* without sage-gcc\n* with sage-gcc\n\nThe reason I focused here on Cygwin is that this a problem for Cygwin even *without* sage-gcc due to problems with the DLL search path on Windows.  It non-sage-gcc should not have any problem on Linux.\n\nBut it is a problem certainly for sage-gcc if it's built against a sage-mpir that is not compatible somehow or other with the system's libgmp.\n\n\nThis all goes back to (one of) Sage's original sins, which is that you're building software packages in a build environment that is also the installation target.  For most packages this is not a big problem, but for your build toolchain itself it certainly is.  This is why I think that for bootstrapping purposes the build toochain and its dependencies should have some level of isolation from the rest of the install target.\n\nAs for a solution, I'd certainly be willing to disable the new-style uninstallation as the default behavior for now. Honestly, I would have preferred to wait until more/all of DESTDIR-related updates were in, as well as #25140, though be design it's supposed to be able to work without that (and does in most cases).  But I'm hesitant because for the majority of packages it does work well now, and I'm not entirely sure what the impact would be of fully disabling it now (but maybe it would be small).\n\nSo I think for now it still might be best to find a middle-ground.  What if, for now, for toolchain dependencies only, we ensure that their files are not removed before reinstalling them?  This could work in part with cooperation from `sage-spkg` by adding a flag similar to pip's `--ignore-installed` which causes it to ignore dependencies that are already satisfied and just install on top of them, rather than uninstalling conflicting/existing dependencies first.",
    "created_at": "2018-07-16T16:42:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397300",
    "user": "https://github.com/embray"
}
```

<div id="comment:17" align="right">comment:17</div>

I'll try to reproduce that on x86_64, as I don't have access to that architecture.  But I see what you're saying in general.

There are two cases here:

* without sage-gcc
* with sage-gcc

The reason I focused here on Cygwin is that this a problem for Cygwin even *without* sage-gcc due to problems with the DLL search path on Windows.  It non-sage-gcc should not have any problem on Linux.

But it is a problem certainly for sage-gcc if it's built against a sage-mpir that is not compatible somehow or other with the system's libgmp.


This all goes back to (one of) Sage's original sins, which is that you're building software packages in a build environment that is also the installation target.  For most packages this is not a big problem, but for your build toolchain itself it certainly is.  This is why I think that for bootstrapping purposes the build toochain and its dependencies should have some level of isolation from the rest of the install target.

As for a solution, I'd certainly be willing to disable the new-style uninstallation as the default behavior for now. Honestly, I would have preferred to wait until more/all of DESTDIR-related updates were in, as well as #25140, though be design it's supposed to be able to work without that (and does in most cases).  But I'm hesitant because for the majority of packages it does work well now, and I'm not entirely sure what the impact would be of fully disabling it now (but maybe it would be small).

So I think for now it still might be best to find a middle-ground.  What if, for now, for toolchain dependencies only, we ensure that their files are not removed before reinstalling them?  This could work in part with cooperation from `sage-spkg` by adding a flag similar to pip's `--ignore-installed` which causes it to ignore dependencies that are already satisfied and just install on top of them, rather than uninstalling conflicting/existing dependencies first.



---

archive/issue_events_354349.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-07-17T06:37:06Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "milestone_number": null,
    "milestone_title": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25857#event-354349"
}
```



---

archive/issue_events_354350.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-07-17T06:37:06Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "milestone_number": null,
    "milestone_title": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25857#event-354350"
}
```



---

archive/issue_comments_397301.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nPersonally, I would prefer to revert uninstall completely because that's the safest operation. But if you have a different solution which is reasonably simple, that might be OK for me too.",
    "created_at": "2018-07-17T06:37:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397301",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:18" align="right">comment:18</div>

Personally, I would prefer to revert uninstall completely because that's the safest operation. But if you have a different solution which is reasonably simple, that might be OK for me too.



---

archive/issue_comments_397302.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nI mean, this issue needs to be resolved somehow anyways--the new package uninstallation is not going away long-term.",
    "created_at": "2018-07-17T10:47:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397302",
    "user": "https://github.com/embray"
}
```

<div id="comment:19" align="right">comment:19</div>

I mean, this issue needs to be resolved somehow anyways--the new package uninstallation is not going away long-term.



---

archive/issue_comments_397303.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nI'm currently testing a fix that I think is pretty uninvasive.  I would still consider it a work-around but it's reasonable.",
    "created_at": "2018-07-17T14:54:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397303",
    "user": "https://github.com/embray"
}
```

<div id="comment:20" align="right">comment:20</div>

I'm currently testing a fix that I think is pretty uninvasive.  I would still consider it a work-around but it's reasonable.



---

archive/issue_events_354351.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-07-17T16:07:23Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25857#event-354351"
}
```



---

archive/issue_events_354352.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-07-17T16:07:23Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "title_is": "Toolchain dependencies that have circular self-dependencies should not be uninstalled before reinstalling/upgrading them",
    "title_was": "Uninstall should probably be recursive",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25857#event-354352"
}
```



---

archive/issue_comments_397304.json:
```json
{
    "body": "Branch: **[u/embray/ticket-25857](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/ticket-25857)**",
    "created_at": "2018-07-17T16:07:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397304",
    "user": "https://github.com/embray"
}
```

Branch: **[u/embray/ticket-25857](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/ticket-25857)**



---

archive/issue_comments_397305.json:
```json
{
    "body": "Author: **Erik Bray**",
    "created_at": "2018-07-17T16:07:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397305",
    "user": "https://github.com/embray"
}
```

Author: **Erik Bray**



---

archive/issue_comments_397306.json:
```json
{
    "body": "Commit: **[`9976091`](https://github.com/sagemath/sagetrac-mirror/commit/99760919b4cf66c55dba78d7a4153273b474948d)**",
    "created_at": "2018-07-17T16:07:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397306",
    "user": "https://github.com/embray"
}
```

Commit: **[`9976091`](https://github.com/sagemath/sagetrac-mirror/commit/99760919b4cf66c55dba78d7a4153273b474948d)**



---

archive/issue_comments_397307.json:
```json
{
    "body": "<div id=\"comment:21\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2965003cb1fd4acecdd099ec876ff99069de2bc9\"><code>2965003</code></a></td><td><code>add vim modeline for this file</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f5f68da5228889c77a1fee2ae00a6e1f7a32d3c2\"><code>f5f68da</code></a></td><td><code>Add a package that by all rights should be included in this list</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/15c7b88bd76c58b769a06c2d4c8dede4ef33d850\"><code>15c7b88</code></a></td><td><code>move this list into a TOOLCHAIN_DEPS variable we can use to inspect this list elsewhere</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1954e5e9020a63b851bfa008e5ac54bd1f71bd19\"><code>1954e5e</code></a></td><td><code>Add -k/--keep-existing to sage-spkg</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f1411c5ee7e3aad4a11e2eeab767e980a0d65abb\"><code>f1411c5</code></a></td><td><code>From <spkg>-clean targets in the Makefile, just remove the package's</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/99760919b4cf66c55dba78d7a4153273b474948d\"><code>9976091</code></a></td><td><code>Use sage-spkg --keep-existing when installing/re-installing packages in</code></td></tr></table>\n",
    "created_at": "2018-07-17T16:07:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397307",
    "user": "https://github.com/embray"
}
```

<div id="comment:21"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2965003cb1fd4acecdd099ec876ff99069de2bc9"><code>2965003</code></a></td><td><code>add vim modeline for this file</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f5f68da5228889c77a1fee2ae00a6e1f7a32d3c2"><code>f5f68da</code></a></td><td><code>Add a package that by all rights should be included in this list</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/15c7b88bd76c58b769a06c2d4c8dede4ef33d850"><code>15c7b88</code></a></td><td><code>move this list into a TOOLCHAIN_DEPS variable we can use to inspect this list elsewhere</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1954e5e9020a63b851bfa008e5ac54bd1f71bd19"><code>1954e5e</code></a></td><td><code>Add -k/--keep-existing to sage-spkg</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f1411c5ee7e3aad4a11e2eeab767e980a0d65abb"><code>f1411c5</code></a></td><td><code>From <spkg>-clean targets in the Makefile, just remove the package's</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/99760919b4cf66c55dba78d7a4153273b474948d"><code>9976091</code></a></td><td><code>Use sage-spkg --keep-existing when installing/re-installing packages in</code></td></tr></table>




---

archive/issue_comments_397308.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\n[f1411c5](https://github.com/sagemath/sagetrac-mirror/commit/f1411c5ee7e3aad4a11e2eeab767e980a0d65abb) works for toolchain packages, but can actually break other packages that rely on the new-style uninstaller to remove files should should be removed in order to reinstall that package.  This came up for me in the case of elliptic_curves.  Simply deleting the stamp file can be a problem, because it means erasing the file manifest for that package (perhaps an argument that they should not be one in the same, but that's another issue).\n\nThis can be fixed by further narrowing things so that `<spkg>-clean` works the old way only for packages in TOOLCHAIN_DEPS.",
    "created_at": "2018-07-17T16:53:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397308",
    "user": "https://github.com/embray"
}
```

<div id="comment:22" align="right">comment:22</div>

[f1411c5](https://github.com/sagemath/sagetrac-mirror/commit/f1411c5ee7e3aad4a11e2eeab767e980a0d65abb) works for toolchain packages, but can actually break other packages that rely on the new-style uninstaller to remove files should should be removed in order to reinstall that package.  This came up for me in the case of elliptic_curves.  Simply deleting the stamp file can be a problem, because it means erasing the file manifest for that package (perhaps an argument that they should not be one in the same, but that's another issue).

This can be fixed by further narrowing things so that `<spkg>-clean` works the old way only for packages in TOOLCHAIN_DEPS.



---

archive/issue_events_354353.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-07-17T16:53:03Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25857#event-354353"
}
```



---

archive/issue_events_354354.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-07-17T16:53:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25857#event-354354"
}
```



---

archive/issue_comments_397309.json:
```json
{
    "body": "Changed commit from **[`9976091`](https://github.com/sagemath/sagetrac-mirror/commit/99760919b4cf66c55dba78d7a4153273b474948d)** to **[`22a1f34`](https://github.com/sagemath/sagetrac-mirror/commit/22a1f34f0157cc5f9599e094e0e23da040ef768f)**",
    "created_at": "2018-07-17T17:23:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397309",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`9976091`](https://github.com/sagemath/sagetrac-mirror/commit/99760919b4cf66c55dba78d7a4153273b474948d)** to **[`22a1f34`](https://github.com/sagemath/sagetrac-mirror/commit/22a1f34f0157cc5f9599e094e0e23da040ef768f)**



---

archive/issue_comments_397310.json:
```json
{
    "body": "<div id=\"comment:23\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/22a1f34f0157cc5f9599e094e0e23da040ef768f\"><code>22a1f34</code></a></td><td><code>Revert to using sage-spkg-uninstall in <spkg>-clean targets, but add a</code></td></tr></table>\n",
    "created_at": "2018-07-17T17:23:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397310",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:23"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/22a1f34f0157cc5f9599e094e0e23da040ef768f"><code>22a1f34</code></a></td><td><code>Revert to using sage-spkg-uninstall in <spkg>-clean targets, but add a</code></td></tr></table>




---

archive/issue_events_354355.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-07-17T17:24:00Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25857#event-354355"
}
```



---

archive/issue_events_354356.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-07-17T17:24:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25857#event-354356"
}
```



---

archive/issue_comments_397311.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nIMHO this would be a mistake to merge at the last minute; This does not fix any bug that generates wrong answers, has no testsuite coverage, etc. Its much safer to merge it at the beginnig of the next beta phase...",
    "created_at": "2018-07-17T22:27:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397311",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:25" align="right">comment:25</div>

IMHO this would be a mistake to merge at the last minute; This does not fix any bug that generates wrong answers, has no testsuite coverage, etc. Its much safer to merge it at the beginnig of the next beta phase...



---

archive/issue_comments_397312.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nI don't like the change `$(inst_zlib)` -> `zlib`. It will prevent using a system `zlib` if we ever want that.",
    "created_at": "2018-07-18T06:55:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397312",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:26" align="right">comment:26</div>

I don't like the change `$(inst_zlib)` -> `zlib`. It will prevent using a system `zlib` if we ever want that.



---

archive/issue_events_354357.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-07-18T06:57:04Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20blocker%20/%201",
    "label_color": "ff0000",
    "label_name": "p: blocker / 1",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25857#event-354357"
}
```



---

archive/issue_events_354358.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-07-18T06:57:04Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25857#event-354358"
}
```



---

archive/issue_events_354359.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-07-18T07:00:24Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25857#event-354359"
}
```



---

archive/issue_events_354360.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-07-18T07:00:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20blocker%20/%201",
    "label_color": "ff0000",
    "label_name": "p: blocker / 1",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25857#event-354360"
}
```



---

archive/issue_comments_397313.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nThis fixes a very serious bug when building from source. You may not like the solution, but the bug is real.",
    "created_at": "2018-07-18T07:00:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397313",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:28" align="right">comment:28</div>

This fixes a very serious bug when building from source. You may not like the solution, but the bug is real.



---

archive/issue_comments_397314.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nIt doesn't break configure && make as far as I can tell. Basically there is an obscure makefile target that requires a full rebuild to recover. How is that a release blocker, just don't do it until its fixed.\n\nIn a similar vein, `make doc` frequently breaks incremental builds and nobody thinks thats a release blocker.",
    "created_at": "2018-07-18T07:05:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397314",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:29" align="right">comment:29</div>

It doesn't break configure && make as far as I can tell. Basically there is an obscure makefile target that requires a full rebuild to recover. How is that a release blocker, just don't do it until its fixed.

In a similar vein, `make doc` frequently breaks incremental builds and nobody thinks thats a release blocker.



---

archive/issue_comments_397315.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nReplying to [@jdemeyer](#comment%3A26):\n> I don't like the change `$(inst_zlib)` -> `zlib`. It will prevent using a system `zlib` if we ever want that.\n\nI'm not sure that's true.  My system for enabling use of more system packages wouldn't be impacted by that, I don't think.  But if that's your only review comment I'll fix it; it's not a big deal (I think it's still useful to have a variable listing the bare package names, but I can add a separate one).",
    "created_at": "2018-07-18T07:42:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397315",
    "user": "https://github.com/embray"
}
```

<div id="comment:30" align="right">comment:30</div>

Replying to [@jdemeyer](#comment%3A26):
> I don't like the change `$(inst_zlib)` -> `zlib`. It will prevent using a system `zlib` if we ever want that.

I'm not sure that's true.  My system for enabling use of more system packages wouldn't be impacted by that, I don't think.  But if that's your only review comment I'll fix it; it's not a big deal (I think it's still useful to have a variable listing the bare package names, but I can add a separate one).



---

archive/issue_comments_397316.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nReplying to [@vbraun](#comment%3A29):\n> It doesn't break configure && make as far as I can tell. Basically there is an obscure makefile target that requires a full rebuild to recover. How is that a release blocker, just don't do it until its fixed.\n> \n> In a similar vein, `make doc` frequently breaks incremental builds and nobody thinks thats a release blocker.\n\nI actually kind of agree with Volker on this one :)  But I'm also sympathetic to it since:\n\na) I broke it.\n\nb) I was bitten by this issue myself, and on Cygwin it can rather badly break patchbots since it affects Cygwin even without installing sage-gcc.\n\nc) The fix is simple (IMO) and if it helps Jeroen sleep at night I don't see the problem.",
    "created_at": "2018-07-18T07:45:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397316",
    "user": "https://github.com/embray"
}
```

<div id="comment:31" align="right">comment:31</div>

Replying to [@vbraun](#comment%3A29):
> It doesn't break configure && make as far as I can tell. Basically there is an obscure makefile target that requires a full rebuild to recover. How is that a release blocker, just don't do it until its fixed.
> 
> In a similar vein, `make doc` frequently breaks incremental builds and nobody thinks thats a release blocker.

I actually kind of agree with Volker on this one :)  But I'm also sympathetic to it since:

a) I broke it.

b) I was bitten by this issue myself, and on Cygwin it can rather badly break patchbots since it affects Cygwin even without installing sage-gcc.

c) The fix is simple (IMO) and if it helps Jeroen sleep at night I don't see the problem.



---

archive/issue_comments_397317.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nReplying to [@vbraun](#comment%3A25):\n> IMHO this would be a mistake to merge at the last minute; This does not fix any bug that generates wrong answers, has no testsuite coverage, etc. Its much safer to merge it at the beginnig of the next beta phase...\n\nAlso it wouldn't be \"last minute\" it if we had a release schedule that created fewer artificial \"panic windows\".",
    "created_at": "2018-07-18T07:47:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397317",
    "user": "https://github.com/embray"
}
```

<div id="comment:32" align="right">comment:32</div>

Replying to [@vbraun](#comment%3A25):
> IMHO this would be a mistake to merge at the last minute; This does not fix any bug that generates wrong answers, has no testsuite coverage, etc. Its much safer to merge it at the beginnig of the next beta phase...

Also it wouldn't be "last minute" it if we had a release schedule that created fewer artificial "panic windows".



---

archive/issue_comments_397318.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nI'm not very comfortable with code like\n\n```\n\t+$(AM_V_at)sage-logger -p '$$(SAGE_SPKG) \\\n\t\t$(if $(filter $(1),$(TOOLCHAIN_DEPS)),--keep-existing) \\\n\t\t$(1)-$(2)' '$$(SAGE_LOGS)/$(1)-$(2).log'\n```\nI never liked your idea about defining these kind of rules in `Makefile` syntax. How am I supposed to understand what is going on here?",
    "created_at": "2018-07-19T07:04:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397318",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:33" align="right">comment:33</div>

I'm not very comfortable with code like

```
	+$(AM_V_at)sage-logger -p '$$(SAGE_SPKG) \
		$(if $(filter $(1),$(TOOLCHAIN_DEPS)),--keep-existing) \
		$(1)-$(2)' '$$(SAGE_LOGS)/$(1)-$(2).log'
```
I never liked your idea about defining these kind of rules in `Makefile` syntax. How am I supposed to understand what is going on here?



---

archive/issue_comments_397319.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nThis comment\n\n```\n# Note: This list is determined from the dependencies of the TOOLCHAIN\n# packages which include gcc, and optionally ccache; in principle this\n# list is redundant.\n```\nis not completely accurate since it should also include the dependencies of the system toolchain, which may use Sage libraries (or did we fix that?)",
    "created_at": "2018-07-19T07:06:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397319",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:34" align="right">comment:34</div>

This comment

```
# Note: This list is determined from the dependencies of the TOOLCHAIN
# packages which include gcc, and optionally ccache; in principle this
# list is redundant.
```
is not completely accurate since it should also include the dependencies of the system toolchain, which may use Sage libraries (or did we fix that?)



---

archive/issue_comments_397320.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nAlso, `TOOLCHAIN_DEPS` should only contain the runtime dependencies of the toolchain (I mean the runtime of the toolchain, when building packages), so not `xz`.",
    "created_at": "2018-07-19T07:07:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397320",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:35" align="right">comment:35</div>

Also, `TOOLCHAIN_DEPS` should only contain the runtime dependencies of the toolchain (I mean the runtime of the toolchain, when building packages), so not `xz`.



---

archive/issue_comments_397321.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nSetting this to needs_work for me because of [comment:26] and [comment:34] and [comment:35] but I haven't finished testing.",
    "created_at": "2018-07-19T07:20:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397321",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:36" align="right">comment:36</div>

Setting this to needs_work for me because of [comment:26] and [comment:34] and [comment:35] but I haven't finished testing.



---

archive/issue_events_354361.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-07-19T07:20:37Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25857#event-354361"
}
```



---

archive/issue_events_354362.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-07-19T07:20:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25857#event-354362"
}
```



---

archive/issue_comments_397322.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nReplying to [@jdemeyer](#comment%3A33):\n> I'm not very comfortable with code like\n> \n> ```\n> \t+$(AM_V_at)sage-logger -p '$$(SAGE_SPKG) \\\n> \t\t$(if $(filter $(1),$(TOOLCHAIN_DEPS)),--keep-existing) \\\n> \t\t$(1)-$(2)' '$$(SAGE_LOGS)/$(1)-$(2).log'\n> ```\n> I never liked your idea about defining these kind of rules in `Makefile` syntax. How am I supposed to understand what is going on here?\n\nI'm sorry but you'll have to live with that.  Read the docs?  With GNU make functions, if you ignore the `$` (or at least, understand that the function call is treated the same as any other variable expansion), and the commas, then it reads more or less like LISP:\n\n`(if (filter <the-dependency> TOOLCHAIN_DEPS) --keep-existing)`\n\nwhere `filter` expands to `<the-dependency>` if it is found in `TOOLCHAIN_DEPS`, and `if` expands to its second argument if its first argument is non-empty (or to its optional third argument if the first argument is empty).",
    "created_at": "2018-07-19T07:37:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397322",
    "user": "https://github.com/embray"
}
```

<div id="comment:38" align="right">comment:38</div>

Replying to [@jdemeyer](#comment%3A33):
> I'm not very comfortable with code like
> 
> ```
> 	+$(AM_V_at)sage-logger -p '$$(SAGE_SPKG) \
> 		$(if $(filter $(1),$(TOOLCHAIN_DEPS)),--keep-existing) \
> 		$(1)-$(2)' '$$(SAGE_LOGS)/$(1)-$(2).log'
> ```
> I never liked your idea about defining these kind of rules in `Makefile` syntax. How am I supposed to understand what is going on here?

I'm sorry but you'll have to live with that.  Read the docs?  With GNU make functions, if you ignore the `$` (or at least, understand that the function call is treated the same as any other variable expansion), and the commas, then it reads more or less like LISP:

`(if (filter <the-dependency> TOOLCHAIN_DEPS) --keep-existing)`

where `filter` expands to `<the-dependency>` if it is found in `TOOLCHAIN_DEPS`, and `if` expands to its second argument if its first argument is non-empty (or to its optional third argument if the first argument is empty).



---

archive/issue_comments_397323.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nReplying to [@jdemeyer](#comment%3A34):\n> This comment\n> \n> ```\n> # Note: This list is determined from the dependencies of the TOOLCHAIN\n> # packages which include gcc, and optionally ccache; in principle this\n> # list is redundant.\n> ```\n> is not completely accurate since it should also include the dependencies of the system toolchain, which may use Sage libraries (or did we fix that?)\n\nWhy would the system toolchain ever use Sage libraries unless the user were doing something like setting `LD_LIBRARY_PATH`?",
    "created_at": "2018-07-19T07:39:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397323",
    "user": "https://github.com/embray"
}
```

<div id="comment:39" align="right">comment:39</div>

Replying to [@jdemeyer](#comment%3A34):
> This comment
> 
> ```
> # Note: This list is determined from the dependencies of the TOOLCHAIN
> # packages which include gcc, and optionally ccache; in principle this
> # list is redundant.
> ```
> is not completely accurate since it should also include the dependencies of the system toolchain, which may use Sage libraries (or did we fix that?)

Why would the system toolchain ever use Sage libraries unless the user were doing something like setting `LD_LIBRARY_PATH`?



---

archive/issue_comments_397324.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nReplying to [@jdemeyer](#comment%3A35):\n> Also, `TOOLCHAIN_DEPS` should only contain the runtime dependencies of the toolchain (I mean the runtime of the toolchain, when building packages), so not `xz`.\n\nI'm not really clear on where xz fits into this.  Why is it listed as a dependency of gcc in the first place?",
    "created_at": "2018-07-19T07:40:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397324",
    "user": "https://github.com/embray"
}
```

<div id="comment:40" align="right">comment:40</div>

Replying to [@jdemeyer](#comment%3A35):
> Also, `TOOLCHAIN_DEPS` should only contain the runtime dependencies of the toolchain (I mean the runtime of the toolchain, when building packages), so not `xz`.

I'm not really clear on where xz fits into this.  Why is it listed as a dependency of gcc in the first place?



---

archive/issue_comments_397325.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">comment:41</div>\n\nReplying to [@embray](#comment%3A40):\n> Why is it listed as a dependency of gcc in the first place?\n\nOnly because the GCC tarball is xz-compressed.",
    "created_at": "2018-07-19T07:45:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397325",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:41" align="right">comment:41</div>

Replying to [@embray](#comment%3A40):
> Why is it listed as a dependency of gcc in the first place?

Only because the GCC tarball is xz-compressed.



---

archive/issue_comments_397326.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">comment:42</div>\n\nReplying to [@embray](#comment%3A39):\n> Why would the system toolchain ever use Sage libraries unless the user were doing something like setting `LD_LIBRARY_PATH`?\n\nWe certainly did that in the past but maybe not anymore.",
    "created_at": "2018-07-19T07:46:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397326",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:42" align="right">comment:42</div>

Replying to [@embray](#comment%3A39):
> Why would the system toolchain ever use Sage libraries unless the user were doing something like setting `LD_LIBRARY_PATH`?

We certainly did that in the past but maybe not anymore.



---

archive/issue_comments_397327.json:
```json
{
    "body": "<div id=\"comment:43\" align=\"right\">comment:43</div>\n\nReplying to [@jdemeyer](#comment%3A42):\n> Replying to [@embray](#comment%3A39):\n> > Why would the system toolchain ever use Sage libraries unless the user were doing something like setting `LD_LIBRARY_PATH`?\n\n> \n> We certainly did that in the past but maybe not anymore.\n\nOnly on Cygwin, where it's required for `dlopen` to work, but it has no other effect on Cygwin.  There's no reason otherwise to set `LD_LIBRARY_PATH` in the Sage environment in general since we mostly rely on RPATH.  There are just a few individual special cases where it's set (but not for running the compiler).",
    "created_at": "2018-07-19T07:54:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397327",
    "user": "https://github.com/embray"
}
```

<div id="comment:43" align="right">comment:43</div>

Replying to [@jdemeyer](#comment%3A42):
> Replying to [@embray](#comment%3A39):
> > Why would the system toolchain ever use Sage libraries unless the user were doing something like setting `LD_LIBRARY_PATH`?

> 
> We certainly did that in the past but maybe not anymore.

Only on Cygwin, where it's required for `dlopen` to work, but it has no other effect on Cygwin.  There's no reason otherwise to set `LD_LIBRARY_PATH` in the Sage environment in general since we mostly rely on RPATH.  There are just a few individual special cases where it's set (but not for running the compiler).



---

archive/issue_comments_397328.json:
```json
{
    "body": "<div id=\"comment:44\" align=\"right\">comment:44</div>\n\nReplying to [@jdemeyer](#comment%3A41):\n> Replying to [@embray](#comment%3A40):\n> > Why is it listed as a dependency of gcc in the first place?\n\n> \n> Only because the GCC tarball is xz-compressed.\n\nWow, ok...\n\nI'll just, drop the commit that added it then.",
    "created_at": "2018-07-19T07:55:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397328",
    "user": "https://github.com/embray"
}
```

<div id="comment:44" align="right">comment:44</div>

Replying to [@jdemeyer](#comment%3A41):
> Replying to [@embray](#comment%3A40):
> > Why is it listed as a dependency of gcc in the first place?

> 
> Only because the GCC tarball is xz-compressed.

Wow, ok...

I'll just, drop the commit that added it then.



---

archive/issue_comments_397329.json:
```json
{
    "body": "<div id=\"comment:45\" align=\"right\">comment:45</div>\n\nReplying to [@vbraun](#comment%3A29):\n> It doesn't break configure && make as far as I can tell.\n\nIt doesn't break a build from scratch but I don't understand why. It should break since mpir is built twice (once before GCC and once after GCC).",
    "created_at": "2018-07-19T09:13:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397329",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:45" align="right">comment:45</div>

Replying to [@vbraun](#comment%3A29):
> It doesn't break configure && make as far as I can tell.

It doesn't break a build from scratch but I don't understand why. It should break since mpir is built twice (once before GCC and once after GCC).



---

archive/issue_comments_397330.json:
```json
{
    "body": "<div id=\"comment:46\" align=\"right\">comment:46</div>\n\nWhen building mpir the second time (after GCC) I get\n\n```\nNo record that 'mpir' was ever installed; skipping uninstall\n```\n\nCan anybody explain this?",
    "created_at": "2018-07-19T09:17:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397330",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:46" align="right">comment:46</div>

When building mpir the second time (after GCC) I get

```
No record that 'mpir' was ever installed; skipping uninstall
```

Can anybody explain this?



---

archive/issue_comments_397331.json:
```json
{
    "body": "<div id=\"comment:47\" align=\"right\">comment:47</div>\n\nReplying to [@jdemeyer](#comment%3A45):\n> Replying to [@vbraun](#comment%3A29):\n> > It doesn't break configure && make as far as I can tell.\n\n> \n> It doesn't break a build from scratch but I don't understand why. It should break since mpir is built twice (once before GCC and once after GCC).\n\nHow exactly are you reproducing the issue?  I can reproduce it by running `./sage -f mpir`.  The reason for this is very specific to `./sage -f`, because it *explicitly* calls `make clean-mpir` before trying to rebuild mpir.  During a normal build from scratch that does not happen.",
    "created_at": "2018-07-19T09:24:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397331",
    "user": "https://github.com/embray"
}
```

<div id="comment:47" align="right">comment:47</div>

Replying to [@jdemeyer](#comment%3A45):
> Replying to [@vbraun](#comment%3A29):
> > It doesn't break configure && make as far as I can tell.

> 
> It doesn't break a build from scratch but I don't understand why. It should break since mpir is built twice (once before GCC and once after GCC).

How exactly are you reproducing the issue?  I can reproduce it by running `./sage -f mpir`.  The reason for this is very specific to `./sage -f`, because it *explicitly* calls `make clean-mpir` before trying to rebuild mpir.  During a normal build from scratch that does not happen.



---

archive/issue_comments_397332.json:
```json
{
    "body": "<div id=\"comment:48\" align=\"right\">comment:48</div>\n\nReplying to [@jdemeyer](#comment%3A46):\n> When building mpir the second time (after GCC) I get\n> \n> ```\n> No record that 'mpir' was ever installed; skipping uninstall\n> ```\n> \n> Can anybody explain this?\n\nAre you getting that *with* this patch, or on bare 8.3.rc1.\n\nEither way that's normal.  That's just what `sage-spkg-uninstall` says if it can't find `local/var/lib/sage/installed/mpir-<whatever>`.  As far is it knows there's nothing to uninstall.",
    "created_at": "2018-07-19T09:26:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397332",
    "user": "https://github.com/embray"
}
```

<div id="comment:48" align="right">comment:48</div>

Replying to [@jdemeyer](#comment%3A46):
> When building mpir the second time (after GCC) I get
> 
> ```
> No record that 'mpir' was ever installed; skipping uninstall
> ```
> 
> Can anybody explain this?

Are you getting that *with* this patch, or on bare 8.3.rc1.

Either way that's normal.  That's just what `sage-spkg-uninstall` says if it can't find `local/var/lib/sage/installed/mpir-<whatever>`.  As far is it knows there's nothing to uninstall.



---

archive/issue_comments_397333.json:
```json
{
    "body": "<div id=\"comment:49\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2965003cb1fd4acecdd099ec876ff99069de2bc9\"><code>2965003</code></a></td><td><code>add vim modeline for this file</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9c1b4f6c24391f952c73783503a33eea0469fdc2\"><code>9c1b4f6</code></a></td><td><code>move this list into a TOOLCHAIN_DEPS variable we can use to inspect this list elsewhere</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/311989deda9e285993f826239b098c35ae72da09\"><code>311989d</code></a></td><td><code>Add -k/--keep-existing to sage-spkg</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/89205fe53d870f30de59abc10afc5fff94b99cca\"><code>89205fe</code></a></td><td><code>From <spkg>-clean targets in the Makefile, just remove the package's</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/cdc6d7056d07b127bc2100a64b05ffbead299a48\"><code>cdc6d70</code></a></td><td><code>Use sage-spkg --keep-existing when installing/re-installing packages in</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0a2ab6a9f61e9da6477f096aa5a22685cc4813d7\"><code>0a2ab6a</code></a></td><td><code>Revert to using sage-spkg-uninstall in <spkg>-clean targets, but add a</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3cb9be71e5aa428dc32c8b6d8ba578444536d343\"><code>3cb9be7</code></a></td><td><code>make the toolchain dependency stamp files directly</code></td></tr></table>\n",
    "created_at": "2018-07-19T11:49:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397333",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:49"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2965003cb1fd4acecdd099ec876ff99069de2bc9"><code>2965003</code></a></td><td><code>add vim modeline for this file</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9c1b4f6c24391f952c73783503a33eea0469fdc2"><code>9c1b4f6</code></a></td><td><code>move this list into a TOOLCHAIN_DEPS variable we can use to inspect this list elsewhere</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/311989deda9e285993f826239b098c35ae72da09"><code>311989d</code></a></td><td><code>Add -k/--keep-existing to sage-spkg</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/89205fe53d870f30de59abc10afc5fff94b99cca"><code>89205fe</code></a></td><td><code>From <spkg>-clean targets in the Makefile, just remove the package's</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/cdc6d7056d07b127bc2100a64b05ffbead299a48"><code>cdc6d70</code></a></td><td><code>Use sage-spkg --keep-existing when installing/re-installing packages in</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0a2ab6a9f61e9da6477f096aa5a22685cc4813d7"><code>0a2ab6a</code></a></td><td><code>Revert to using sage-spkg-uninstall in <spkg>-clean targets, but add a</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3cb9be71e5aa428dc32c8b6d8ba578444536d343"><code>3cb9be7</code></a></td><td><code>make the toolchain dependency stamp files directly</code></td></tr></table>




---

archive/issue_comments_397334.json:
```json
{
    "body": "Changed commit from **[`22a1f34`](https://github.com/sagemath/sagetrac-mirror/commit/22a1f34f0157cc5f9599e094e0e23da040ef768f)** to **[`3cb9be7`](https://github.com/sagemath/sagetrac-mirror/commit/3cb9be71e5aa428dc32c8b6d8ba578444536d343)**",
    "created_at": "2018-07-19T11:49:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397334",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`22a1f34`](https://github.com/sagemath/sagetrac-mirror/commit/22a1f34f0157cc5f9599e094e0e23da040ef768f)** to **[`3cb9be7`](https://github.com/sagemath/sagetrac-mirror/commit/3cb9be71e5aa428dc32c8b6d8ba578444536d343)**



---

archive/issue_comments_397335.json:
```json
{
    "body": "<div id=\"comment:50\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2da7f8e7ba0fd588bf3cff48b4c78798288e1f73\"><code>2da7f8e</code></a></td><td><code>updated questionable comment; maybe a little better?</code></td></tr></table>\n",
    "created_at": "2018-07-19T11:52:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397335",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:50"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2da7f8e7ba0fd588bf3cff48b4c78798288e1f73"><code>2da7f8e</code></a></td><td><code>updated questionable comment; maybe a little better?</code></td></tr></table>




---

archive/issue_comments_397336.json:
```json
{
    "body": "Changed commit from **[`3cb9be7`](https://github.com/sagemath/sagetrac-mirror/commit/3cb9be71e5aa428dc32c8b6d8ba578444536d343)** to **[`2da7f8e`](https://github.com/sagemath/sagetrac-mirror/commit/2da7f8e7ba0fd588bf3cff48b4c78798288e1f73)**",
    "created_at": "2018-07-19T11:52:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397336",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`3cb9be7`](https://github.com/sagemath/sagetrac-mirror/commit/3cb9be71e5aa428dc32c8b6d8ba578444536d343)** to **[`2da7f8e`](https://github.com/sagemath/sagetrac-mirror/commit/2da7f8e7ba0fd588bf3cff48b4c78798288e1f73)**



---

archive/issue_comments_397337.json:
```json
{
    "body": "<div id=\"comment:51\" align=\"right\">comment:51</div>\n\nReplying to [@jdemeyer](#comment%3A36):\n> Setting this to needs_work for me because of [comment:26] and [comment:34] and [comment:35] but I haven't finished testing.\n\nI think I've addressed all of these:\n\n[x] removed `xz` from `TOOLCHAIN_DEPS`\n\n[x] used `$(MAKE) $(inst_pkg)` for each package in `TOOLCHAIN_DEPS` (serially)\n\n[x] updated the comment; though I don't know if what it says now is really any better (I think it is though)\n\n\nSorry for my flippancy about make syntax constructs but I really think it makes things simpler; there's nothing out of the ordinary about it.",
    "created_at": "2018-07-19T11:54:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397337",
    "user": "https://github.com/embray"
}
```

<div id="comment:51" align="right">comment:51</div>

Replying to [@jdemeyer](#comment%3A36):
> Setting this to needs_work for me because of [comment:26] and [comment:34] and [comment:35] but I haven't finished testing.

I think I've addressed all of these:

[x] removed `xz` from `TOOLCHAIN_DEPS`

[x] used `$(MAKE) $(inst_pkg)` for each package in `TOOLCHAIN_DEPS` (serially)

[x] updated the comment; though I don't know if what it says now is really any better (I think it is though)


Sorry for my flippancy about make syntax constructs but I really think it makes things simpler; there's nothing out of the ordinary about it.



---

archive/issue_events_354363.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-07-19T11:54:42Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25857#event-354363"
}
```



---

archive/issue_events_354364.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-07-19T11:54:42Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25857#event-354364"
}
```



---

archive/issue_events_354365.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-07-24T20:52:42Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "milestone_number": null,
    "milestone_title": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25857#event-354365"
}
```



---

archive/issue_events_354366.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-07-24T20:52:42Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "milestone_number": null,
    "milestone_title": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25857#event-354366"
}
```



---

archive/issue_comments_397338.json:
```json
{
    "body": "<div id=\"comment:52\" align=\"right\">comment:52</div>\n\nI changed my mind about the urgency if it only happens on force rebuilds (`sage -f ...`)",
    "created_at": "2018-07-24T20:52:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397338",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:52" align="right">comment:52</div>

I changed my mind about the urgency if it only happens on force rebuilds (`sage -f ...`)



---

archive/issue_events_354367.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-07-24T20:52:42Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20blocker%20/%201",
    "label_color": "ff0000",
    "label_name": "p: blocker / 1",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25857#event-354367"
}
```



---

archive/issue_events_354368.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-07-24T20:52:42Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20critical%20/%202",
    "label_color": "ff7700",
    "label_name": "p: critical / 2",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25857#event-354368"
}
```



---

archive/issue_comments_397339.json:
```json
{
    "body": "<div id=\"comment:53\" align=\"right\">comment:53</div>\n\nFWIW it can also screw up patchbots since they're regularly jumping back and forth between branches (which might end up requiring a rebuild of mpir and/or dependencies).\n\nBut if that's still fixed by the next beta release I don't see it as that big a deal.",
    "created_at": "2018-07-25T13:39:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397339",
    "user": "https://github.com/embray"
}
```

<div id="comment:53" align="right">comment:53</div>

FWIW it can also screw up patchbots since they're regularly jumping back and forth between branches (which might end up requiring a rebuild of mpir and/or dependencies).

But if that's still fixed by the next beta release I don't see it as that big a deal.



---

archive/issue_comments_397340.json:
```json
{
    "body": "<div id=\"comment:54\" align=\"right\">comment:54</div>\n\nReplying to [@embray](#comment%3A38):\n> I'm sorry but you'll have to live with that.  Read the docs?\n\nUnderstanding this syntactically is not the same as actually understanding it semantically. Whenever I try to review this ticket, I also end up realizing that there is no way to be sure that this `Makefile` syntax does what it is supposed to do.\n\nAnd your suggestion to run `make -f build/make/Makefile -n DEBUG_RULES=1` would be useful if it would actually do what it said: the `toolchain-deps` rules that you change on this ticket do not appear there.\n\nI'm not making this comment just to be annoying or pedantic. I really do think that it's a serious problem with #21524.",
    "created_at": "2018-07-30T14:56:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397340",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:54" align="right">comment:54</div>

Replying to [@embray](#comment%3A38):
> I'm sorry but you'll have to live with that.  Read the docs?

Understanding this syntactically is not the same as actually understanding it semantically. Whenever I try to review this ticket, I also end up realizing that there is no way to be sure that this `Makefile` syntax does what it is supposed to do.

And your suggestion to run `make -f build/make/Makefile -n DEBUG_RULES=1` would be useful if it would actually do what it said: the `toolchain-deps` rules that you change on this ticket do not appear there.

I'm not making this comment just to be annoying or pedantic. I really do think that it's a serious problem with #21524.



---

archive/issue_comments_397341.json:
```json
{
    "body": "<div id=\"comment:55\" align=\"right\">comment:55</div>\n\nSome other comments:\n\n1. the flags `SAGE_INSTALL_FETCH_ONLY`, `SAGE_CHECK` and `SAGE_KEEP_BUILT_SPKGS` are meant to be usable as environment variables. So I would do the same for `KEEP_EXISTING` (rename it to `SAGE_KEEP_EXISTING` and remove `KEEP_EXISTING=0`).\n\n2. keep the whitespace line in the `-clean` rule.",
    "created_at": "2018-07-30T15:01:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397341",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:55" align="right">comment:55</div>

Some other comments:

1. the flags `SAGE_INSTALL_FETCH_ONLY`, `SAGE_CHECK` and `SAGE_KEEP_BUILT_SPKGS` are meant to be usable as environment variables. So I would do the same for `KEEP_EXISTING` (rename it to `SAGE_KEEP_EXISTING` and remove `KEEP_EXISTING=0`).

2. keep the whitespace line in the `-clean` rule.



---

archive/issue_comments_397342.json:
```json
{
    "body": "<div id=\"comment:56\" align=\"right\">comment:56</div>\n\nReplying to [@jdemeyer](#comment%3A55):\n> Some other comments:\n> \n> 1. the flags `SAGE_INSTALL_FETCH_ONLY`, `SAGE_CHECK` and `SAGE_KEEP_BUILT_SPKGS` are meant to be usable as environment variables. So I would do the same for `KEEP_EXISTING` (rename it to `SAGE_KEEP_EXISTING` and remove `KEEP_EXISTING=0`).\n\nOk.\n\n> 2. keep the whitespace line in the `-clean` rule.\n\nYes, weirdly I thought I already fixed that.  I don't know why the fix went away again.",
    "created_at": "2018-07-30T15:56:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397342",
    "user": "https://github.com/embray"
}
```

<div id="comment:56" align="right">comment:56</div>

Replying to [@jdemeyer](#comment%3A55):
> Some other comments:
> 
> 1. the flags `SAGE_INSTALL_FETCH_ONLY`, `SAGE_CHECK` and `SAGE_KEEP_BUILT_SPKGS` are meant to be usable as environment variables. So I would do the same for `KEEP_EXISTING` (rename it to `SAGE_KEEP_EXISTING` and remove `KEEP_EXISTING=0`).

Ok.

> 2. keep the whitespace line in the `-clean` rule.

Yes, weirdly I thought I already fixed that.  I don't know why the fix went away again.



---

archive/issue_comments_397343.json:
```json
{
    "body": "<div id=\"comment:57\" align=\"right\">comment:57</div>\n\nReplying to [@jdemeyer](#comment%3A54):\n> Replying to [@embray](#comment%3A38):\n> > I'm sorry but you'll have to live with that.  Read the docs?\n\n> \n> Understanding this syntactically is not the same as actually understanding it semantically. Whenever I try to review this ticket, I also end up realizing that there is no way to be sure that this `Makefile` syntax does what it is supposed to do.\n> \n> And your suggestion to run `make -f build/make/Makefile -n DEBUG_RULES=1` would be useful if it would actually do what it said: the `toolchain-deps` rules that you change on this ticket do not appear there.\n\nThat's just for printing the automatically generated rules, not for printing every rule in the makefile, not statically-defined targets, like `toolchain-deps`.\n\nI'm not sure what's unclear about that target.\n\n> I'm not making this comment just to be annoying or pedantic. I really do think that it's a serious problem with #21524.\n\nI believe your intentions are sincere, but I still find this objection very confusing.  I feel like you're just stubbornly refusing to learn for some reason, because I find it easy to understand, and to check; maybe just not as easy as, say, a Python script.  I don't know if that's what's going on; that's just what it feels like to me.  Maybe a tutorial on make would help; I don't know.\n\nAnyways, I think that discussion is outside the scope of this ticket.",
    "created_at": "2018-07-30T16:03:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397343",
    "user": "https://github.com/embray"
}
```

<div id="comment:57" align="right">comment:57</div>

Replying to [@jdemeyer](#comment%3A54):
> Replying to [@embray](#comment%3A38):
> > I'm sorry but you'll have to live with that.  Read the docs?

> 
> Understanding this syntactically is not the same as actually understanding it semantically. Whenever I try to review this ticket, I also end up realizing that there is no way to be sure that this `Makefile` syntax does what it is supposed to do.
> 
> And your suggestion to run `make -f build/make/Makefile -n DEBUG_RULES=1` would be useful if it would actually do what it said: the `toolchain-deps` rules that you change on this ticket do not appear there.

That's just for printing the automatically generated rules, not for printing every rule in the makefile, not statically-defined targets, like `toolchain-deps`.

I'm not sure what's unclear about that target.

> I'm not making this comment just to be annoying or pedantic. I really do think that it's a serious problem with #21524.

I believe your intentions are sincere, but I still find this objection very confusing.  I feel like you're just stubbornly refusing to learn for some reason, because I find it easy to understand, and to check; maybe just not as easy as, say, a Python script.  I don't know if that's what's going on; that's just what it feels like to me.  Maybe a tutorial on make would help; I don't know.

Anyways, I think that discussion is outside the scope of this ticket.



---

archive/issue_events_354369.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-07-30T16:04:10Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25857#event-354369"
}
```



---

archive/issue_events_354370.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-07-30T16:04:10Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25857#event-354370"
}
```



---

archive/issue_comments_397344.json:
```json
{
    "body": "<div id=\"comment:59\" align=\"right\">comment:59</div>\n\nReplying to [@embray](#comment%3A56):\n> Replying to [@jdemeyer](#comment%3A55):\n> > Some other comments:\n> > \n> > 1. the flags `SAGE_INSTALL_FETCH_ONLY`, `SAGE_CHECK` and `SAGE_KEEP_BUILT_SPKGS` are meant to be usable as environment variables. So I would do the same for `KEEP_EXISTING` (rename it to `SAGE_KEEP_EXISTING` and remove `KEEP_EXISTING=0`).\n\n> \n> Ok.\n\nActually, the more I think about it, I think we should avoid adding yet another environment variable for now.  Is this something we actually need?  If there's not an obvious use case for setting this flag for all packages I think it should be avoided.  The name `SAGE_KEEP_EXISTING` is also very unclear as to what it does.  Keep existing what?  In the context of the `sage-spkg` script it makes sense, but it's very unobvious otherwise.",
    "created_at": "2018-07-30T16:07:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397344",
    "user": "https://github.com/embray"
}
```

<div id="comment:59" align="right">comment:59</div>

Replying to [@embray](#comment%3A56):
> Replying to [@jdemeyer](#comment%3A55):
> > Some other comments:
> > 
> > 1. the flags `SAGE_INSTALL_FETCH_ONLY`, `SAGE_CHECK` and `SAGE_KEEP_BUILT_SPKGS` are meant to be usable as environment variables. So I would do the same for `KEEP_EXISTING` (rename it to `SAGE_KEEP_EXISTING` and remove `KEEP_EXISTING=0`).

> 
> Ok.

Actually, the more I think about it, I think we should avoid adding yet another environment variable for now.  Is this something we actually need?  If there's not an obvious use case for setting this flag for all packages I think it should be avoided.  The name `SAGE_KEEP_EXISTING` is also very unclear as to what it does.  Keep existing what?  In the context of the `sage-spkg` script it makes sense, but it's very unobvious otherwise.



---

archive/issue_comments_397345.json:
```json
{
    "body": "Changed commit from **[`2da7f8e`](https://github.com/sagemath/sagetrac-mirror/commit/2da7f8e7ba0fd588bf3cff48b4c78798288e1f73)** to **[`85a368f`](https://github.com/sagemath/sagetrac-mirror/commit/85a368f2b4763f4721fb6541953573805cb4b14f)**",
    "created_at": "2018-07-30T16:11:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397345",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`2da7f8e`](https://github.com/sagemath/sagetrac-mirror/commit/2da7f8e7ba0fd588bf3cff48b4c78798288e1f73)** to **[`85a368f`](https://github.com/sagemath/sagetrac-mirror/commit/85a368f2b4763f4721fb6541953573805cb4b14f)**



---

archive/issue_comments_397346.json:
```json
{
    "body": "<div id=\"comment:60\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/85a368f2b4763f4721fb6541953573805cb4b14f\"><code>85a368f</code></a></td><td><code>each of these templates should have an empty newline at the end to make them more readable when printed one after the other</code></td></tr></table>\n",
    "created_at": "2018-07-30T16:11:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397346",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:60"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/85a368f2b4763f4721fb6541953573805cb4b14f"><code>85a368f</code></a></td><td><code>each of these templates should have an empty newline at the end to make them more readable when printed one after the other</code></td></tr></table>




---

archive/issue_events_354371.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-07-30T16:11:43Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25857#event-354371"
}
```



---

archive/issue_events_354372.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-07-30T16:11:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25857#event-354372"
}
```



---

archive/issue_comments_397347.json:
```json
{
    "body": "<div id=\"comment:62\" align=\"right\">comment:62</div>\n\nReplying to [@embray](#comment%3A57):\n> Replying to [@jdemeyer](#comment%3A54):\n> > Replying to [@embray](#comment%3A38):\n> > > I'm sorry but you'll have to live with that.  Read the docs?\n\n> > \n> > Understanding this syntactically is not the same as actually understanding it semantically. Whenever I try to review this ticket, I also end up realizing that there is no way to be sure that this `Makefile` syntax does what it is supposed to do.\n\nWhich syntax specifically?  What are you trying to check?",
    "created_at": "2018-07-30T16:14:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397347",
    "user": "https://github.com/embray"
}
```

<div id="comment:62" align="right">comment:62</div>

Replying to [@embray](#comment%3A57):
> Replying to [@jdemeyer](#comment%3A54):
> > Replying to [@embray](#comment%3A38):
> > > I'm sorry but you'll have to live with that.  Read the docs?

> > 
> > Understanding this syntactically is not the same as actually understanding it semantically. Whenever I try to review this ticket, I also end up realizing that there is no way to be sure that this `Makefile` syntax does what it is supposed to do.

Which syntax specifically?  What are you trying to check?



---

archive/issue_comments_397348.json:
```json
{
    "body": "<div id=\"comment:63\" align=\"right\">comment:63</div>\n\nReplying to [@embray](#comment%3A59):\n> If there's not an obvious use case for setting this flag for all packages I think it should be avoided.\n\nWhy? I would argue the opposite: it doesn't harm to support it as an environment variable, so why should we not do that?\n\n> The name `SAGE_KEEP_EXISTING` is also very unclear as to what it does.\n\nThen call it `SAGE_SKIP_UNINSTALL` or whatever.",
    "created_at": "2018-08-07T12:08:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397348",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:63" align="right">comment:63</div>

Replying to [@embray](#comment%3A59):
> If there's not an obvious use case for setting this flag for all packages I think it should be avoided.

Why? I would argue the opposite: it doesn't harm to support it as an environment variable, so why should we not do that?

> The name `SAGE_KEEP_EXISTING` is also very unclear as to what it does.

Then call it `SAGE_SKIP_UNINSTALL` or whatever.



---

archive/issue_comments_397349.json:
```json
{
    "body": "<div id=\"comment:64\" align=\"right\">comment:64</div>\n\nReplying to [@embray](#comment%3A62):\n> Which syntax specifically?  What are you trying to check?\n\nI'm just trying to check that this branch does what it seems to be doing. It *looks* like it does the right thing (skipping uninstall for toolchain packages) but how I can be sure?\n\nBy now, I've looked at this ticket a few times and I guess it's OK. I'll wait for your reply on the environment variable issue before doing a final review.",
    "created_at": "2018-08-07T12:16:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397349",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:64" align="right">comment:64</div>

Replying to [@embray](#comment%3A62):
> Which syntax specifically?  What are you trying to check?

I'm just trying to check that this branch does what it seems to be doing. It *looks* like it does the right thing (skipping uninstall for toolchain packages) but how I can be sure?

By now, I've looked at this ticket a few times and I guess it's OK. I'll wait for your reply on the environment variable issue before doing a final review.



---

archive/issue_comments_397350.json:
```json
{
    "body": "<div id=\"comment:65\" align=\"right\">comment:65</div>\n\nReplying to [@jdemeyer](#comment%3A64):\n> Replying to [@embray](#comment%3A62):\n> > Which syntax specifically?  What are you trying to check?\n\n> \n> I'm just trying to check that this branch does what it seems to be doing. It *looks* like it does the right thing (skipping uninstall for toolchain packages) but how I can be sure?\n\nI'm still not sure what you're asking here.  Are you just asking how to test code in a makefile?  How can you be sure any code does what you think it looks like it does?  I'm not trying to be facetious--I'm just trying to get to the bottom of what your concern is.",
    "created_at": "2018-08-08T13:27:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397350",
    "user": "https://github.com/embray"
}
```

<div id="comment:65" align="right">comment:65</div>

Replying to [@jdemeyer](#comment%3A64):
> Replying to [@embray](#comment%3A62):
> > Which syntax specifically?  What are you trying to check?

> 
> I'm just trying to check that this branch does what it seems to be doing. It *looks* like it does the right thing (skipping uninstall for toolchain packages) but how I can be sure?

I'm still not sure what you're asking here.  Are you just asking how to test code in a makefile?  How can you be sure any code does what you think it looks like it does?  I'm not trying to be facetious--I'm just trying to get to the bottom of what your concern is.



---

archive/issue_comments_397351.json:
```json
{
    "body": "<div id=\"comment:66\" align=\"right\">comment:66</div>\n\nReplying to [@jdemeyer](#comment%3A63):\n> Replying to [@embray](#comment%3A59):\n> > If there's not an obvious use case for setting this flag for all packages I think it should be avoided.\n\n> \n> Why? I would argue the opposite: it doesn't harm to support it as an environment variable, so why should we not do that?\n\nI don't agree.  Adding any new \"feature\" means you have to support it. The main purpose of this change (although it *does* add new features in the form of new command-line flags to some scripts) was not really to add new features so much as to workaround a specific problem.  So better to keep the feature surface area of the change minimal.  I also believe the YAGNI principle applies here.\n\nBut if you *really* want it for some reason a compromise might be to change the name but not document it anywhere.  I'm also a little unsure about this in that it's really a behavior of the uninstallation that this is changing, not the installation.  ~~If anything it should be an environment variable read by the uninstaller, but there again it adds needless complication...~~ (That last sentence didn't make sense; I misremembered what my own patch does :)",
    "created_at": "2018-08-08T13:31:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397351",
    "user": "https://github.com/embray"
}
```

<div id="comment:66" align="right">comment:66</div>

Replying to [@jdemeyer](#comment%3A63):
> Replying to [@embray](#comment%3A59):
> > If there's not an obvious use case for setting this flag for all packages I think it should be avoided.

> 
> Why? I would argue the opposite: it doesn't harm to support it as an environment variable, so why should we not do that?

I don't agree.  Adding any new "feature" means you have to support it. The main purpose of this change (although it *does* add new features in the form of new command-line flags to some scripts) was not really to add new features so much as to workaround a specific problem.  So better to keep the feature surface area of the change minimal.  I also believe the YAGNI principle applies here.

But if you *really* want it for some reason a compromise might be to change the name but not document it anywhere.  I'm also a little unsure about this in that it's really a behavior of the uninstallation that this is changing, not the installation.  ~~If anything it should be an environment variable read by the uninstaller, but there again it adds needless complication...~~ (That last sentence didn't make sense; I misremembered what my own patch does :)



---

archive/issue_comments_397352.json:
```json
{
    "body": "<div id=\"comment:67\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/fb51d4ef640bb74c3f8e09eb2c89da74fcc0e978\"><code>fb51d4e</code></a></td><td><code>allow 'sage-spkg -k' to also be implied by setting the environment varible SAGE_SPKG_SKIP_UNINSTALL=yes</code></td></tr></table>\n",
    "created_at": "2018-08-10T11:08:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397352",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:67"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/fb51d4ef640bb74c3f8e09eb2c89da74fcc0e978"><code>fb51d4e</code></a></td><td><code>allow 'sage-spkg -k' to also be implied by setting the environment varible SAGE_SPKG_SKIP_UNINSTALL=yes</code></td></tr></table>




---

archive/issue_comments_397353.json:
```json
{
    "body": "Changed commit from **[`85a368f`](https://github.com/sagemath/sagetrac-mirror/commit/85a368f2b4763f4721fb6541953573805cb4b14f)** to **[`fb51d4e`](https://github.com/sagemath/sagetrac-mirror/commit/fb51d4ef640bb74c3f8e09eb2c89da74fcc0e978)**",
    "created_at": "2018-08-10T11:08:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397353",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`85a368f`](https://github.com/sagemath/sagetrac-mirror/commit/85a368f2b4763f4721fb6541953573805cb4b14f)** to **[`fb51d4e`](https://github.com/sagemath/sagetrac-mirror/commit/fb51d4ef640bb74c3f8e09eb2c89da74fcc0e978)**



---

archive/issue_comments_397354.json:
```json
{
    "body": "<div id=\"comment:68\" align=\"right\">comment:68</div>\n\nHow about this?  I called it `SAGE_SPKG_SKIP_UNINSTALL` and noted it in the documentation at the top of `sage-spkg`, but not elsewhere, at least for now.\n\nI'd like to get this done already; I think this fix is too important to be held up any longer by bikeshedding.",
    "created_at": "2018-08-10T11:10:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397354",
    "user": "https://github.com/embray"
}
```

<div id="comment:68" align="right">comment:68</div>

How about this?  I called it `SAGE_SPKG_SKIP_UNINSTALL` and noted it in the documentation at the top of `sage-spkg`, but not elsewhere, at least for now.

I'd like to get this done already; I think this fix is too important to be held up any longer by bikeshedding.



---

archive/issue_comments_397355.json:
```json
{
    "body": "<div id=\"comment:69\" align=\"right\">comment:69</div>\n\nPerhaps this should get #25188 as a dependence, so that the latter and this are merged together, with just one new configure tarball instead of two...",
    "created_at": "2018-09-07T08:50:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397355",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:69" align="right">comment:69</div>

Perhaps this should get #25188 as a dependence, so that the latter and this are merged together, with just one new configure tarball instead of two...



---

archive/issue_comments_397356.json:
```json
{
    "body": "<div id=\"comment:70\" align=\"right\">comment:70</div>\n\nLooks like the latest patchbot build failed due to #18438.\n\nDima, that's not a bad idea, but I'd like to see a positive review on both first.",
    "created_at": "2018-09-07T09:14:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397356",
    "user": "https://github.com/embray"
}
```

<div id="comment:70" align="right">comment:70</div>

Looks like the latest patchbot build failed due to #18438.

Dima, that's not a bad idea, but I'd like to see a positive review on both first.



---

archive/issue_comments_397357.json:
```json
{
    "body": "Reviewer: **Dima Pasechnik, Jeroen Demeyer**",
    "created_at": "2018-10-15T09:55:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397357",
    "user": "https://github.com/dimpase"
}
```

Reviewer: **Dima Pasechnik, Jeroen Demeyer**



---

archive/issue_events_354373.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2018-10-15T09:55:10Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25857#event-354373"
}
```



---

archive/issue_events_354374.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2018-10-15T09:55:10Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25857#event-354374"
}
```



---

archive/issue_events_354375.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-10-20T11:59:15Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25857#event-354375"
}
```



---

archive/issue_events_354376.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "cd84b4b5bb2a752cb82cda4d1f649877a181c568",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2018-10-20T11:59:15Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25857#event-354376"
}
```



---

archive/issue_comments_397358.json:
```json
{
    "body": "Changed branch from **[u/embray/ticket-25857](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/ticket-25857)** to **[`fb51d4e`](https://github.com/sagemath/sagetrac-mirror/commit/fb51d4ef640bb74c3f8e09eb2c89da74fcc0e978)**",
    "created_at": "2018-10-20T11:59:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397358",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/embray/ticket-25857](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/ticket-25857)** to **[`fb51d4e`](https://github.com/sagemath/sagetrac-mirror/commit/fb51d4ef640bb74c3f8e09eb2c89da74fcc0e978)**



---

archive/issue_comments_397359.json:
```json
{
    "body": "<div id=\"comment:73\" align=\"right\">comment:73</div>\n\nThis should be re-targeted for 8.5.",
    "created_at": "2018-10-28T14:52:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/25857#issuecomment-397359",
    "user": "https://github.com/embray"
}
```

<div id="comment:73" align="right">comment:73</div>

This should be re-targeted for 8.5.



---

archive/issue_events_354377.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-10-28T14:52:23Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "milestone_number": null,
    "milestone_title": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25857#event-354377"
}
```



---

archive/issue_events_354378.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-10-28T14:52:23Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/25857",
    "milestone_number": null,
    "milestone_title": "sage-8.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/25857#event-354378"
}
```
