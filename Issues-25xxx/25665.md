# Issue 25665: Don't use installed_packages() for threejs URL

archive/issues_025428.json:
```json
{
    "body": "Since Sage 8.3.beta3, running the command\n\n```\nshow(sphere(), viewer='threejs', online=True)\n```\nin a Jupyter notebook displays nothing. It was fine in Sage <= 8.3.beta2. \nNote that the option `online=True` is required by tools like http://nbviewer.jupyter.org/ and [CoCalc](https://cocalc.com).\n\nIt seems that the issue is due to the following change introduced in #25040 (which has been merged in Sage 8.3.beta3):\n\n```\nsage: installed_packages()['threejs']\n'r80.p0'\n```\nwhile in Sage <= 8.3.beta2, one has\n\n```\nsage: installed_packages()['threejs']\n'r80'\n```\nIndeed the value of `installed_packages()['threejs']` is used to form the url in lines 749-750 of `src/sage/repl/rich_output/display_manager.py`\n\nCC:  @embray @jdemeyer @antonio-rojas @kiwifb\n\nKeywords: threejs\n\nBranch/Commit: 867e1ffe5b15a3827d2828ad57ac23f392f7f4ee\n\nReviewer: Eric Gourgoulhon\n\nAuthor: Fr\u00e9d\u00e9ric Chapoton\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/25665\n\n",
    "closed_at": "2018-07-07T01:34:46Z",
    "created_at": "2018-06-26T11:49:35Z",
    "labels": [
        "component: graphics",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.3",
    "title": "Don't use installed_packages() for threejs URL",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25665",
    "user": "https://github.com/egourgoulhon"
}
```
Since Sage 8.3.beta3, running the command

```
show(sphere(), viewer='threejs', online=True)
```
in a Jupyter notebook displays nothing. It was fine in Sage <= 8.3.beta2. 
Note that the option `online=True` is required by tools like http://nbviewer.jupyter.org/ and [CoCalc](https://cocalc.com).

It seems that the issue is due to the following change introduced in #25040 (which has been merged in Sage 8.3.beta3):

```
sage: installed_packages()['threejs']
'r80.p0'
```
while in Sage <= 8.3.beta2, one has

```
sage: installed_packages()['threejs']
'r80'
```
Indeed the value of `installed_packages()['threejs']` is used to form the url in lines 749-750 of `src/sage/repl/rich_output/display_manager.py`

CC:  @embray @jdemeyer @antonio-rojas @kiwifb

Keywords: threejs

Branch/Commit: 867e1ffe5b15a3827d2828ad57ac23f392f7f4ee

Reviewer: Eric Gourgoulhon

Author: Frédéric Chapoton

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/25665





---

archive/issue_comments_491822.json:
```json
{
    "body": "Replying to [ticket:25665 egourgoulhon]:\n> Indeed the value of `installed_packages()['threejs']` is used to form the url in lines 749-750 of `src/sage/repl/rich_output/display_manager.py`\n\n\nThat's a really bad idea for multiple reasons.",
    "created_at": "2018-06-26T11:53:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25665#issuecomment-491822",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [ticket:25665 egourgoulhon]:
> Indeed the value of `installed_packages()['threejs']` is used to form the url in lines 749-750 of `src/sage/repl/rich_output/display_manager.py`


That's a really bad idea for multiple reasons.



---

archive/issue_comments_491823.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -18,7 +18,7 @@\n sage: installed_packages()['threejs']\n 'r80'\n ```\n-Indeed the value of `installed_packages()['threejs']` is used to form the url in lines 749-750 of `src/sage/repl/rich_output/display_manager.py` and it turns out that https://cdn.rawgit.com/mrdoob/three.js/r80/build/three.min.js is a valid url, while https://cdn.rawgit.com/mrdoob/three.js/r80.p0/build/three.min.js is not.\n+Indeed the value of `installed_packages()['threejs']` is used to form the url in lines 749-750 of `src/sage/repl/rich_output/display_manager.py`\n \n Comment: 1\n \n``````\n",
    "created_at": "2018-06-26T11:57:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25665#issuecomment-491823",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -18,7 +18,7 @@
 sage: installed_packages()['threejs']
 'r80'
 ```
-Indeed the value of `installed_packages()['threejs']` is used to form the url in lines 749-750 of `src/sage/repl/rich_output/display_manager.py` and it turns out that https://cdn.rawgit.com/mrdoob/three.js/r80/build/three.min.js is a valid url, while https://cdn.rawgit.com/mrdoob/three.js/r80.p0/build/three.min.js is not.
+Indeed the value of `installed_packages()['threejs']` is used to form the url in lines 749-750 of `src/sage/repl/rich_output/display_manager.py`
 
 Comment: 1
 
``````




---

archive/issue_comments_491824.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,24 @@\n+Since Sage 8.3.beta3, running the command\n \n+```\n+show(sphere(), viewer='threejs', online=True)\n+```\n+in a Jupyter notebook displays nothing. It was fine in Sage <= 8.3.beta2. \n+Note that the option `online=True` is required by tools like http://nbviewer.jupyter.org/ and [CoCalc](https://cocalc.com).\n+\n+It seems that the issue is due to the following change introduced in #25040 (which has been merged in Sage 8.3.beta3):\n+\n+```\n+sage: installed_packages()['threejs']\n+'r80.p0'\n+```\n+while in Sage <= 8.3.beta2, one has\n+\n+```\n+sage: installed_packages()['threejs']\n+'r80'\n+```\n+Indeed the value of `installed_packages()['threejs']` is used to form the url in lines 749-750 of `src/sage/repl/rich_output/display_manager.py`\n \n Comment: 1\n \n``````\n",
    "created_at": "2018-06-26T11:59:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25665#issuecomment-491824",
    "user": "https://github.com/egourgoulhon"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,24 @@
+Since Sage 8.3.beta3, running the command
 
+```
+show(sphere(), viewer='threejs', online=True)
+```
+in a Jupyter notebook displays nothing. It was fine in Sage <= 8.3.beta2. 
+Note that the option `online=True` is required by tools like http://nbviewer.jupyter.org/ and [CoCalc](https://cocalc.com).
+
+It seems that the issue is due to the following change introduced in #25040 (which has been merged in Sage 8.3.beta3):
+
+```
+sage: installed_packages()['threejs']
+'r80.p0'
+```
+while in Sage <= 8.3.beta2, one has
+
+```
+sage: installed_packages()['threejs']
+'r80'
+```
+Indeed the value of `installed_packages()['threejs']` is used to form the url in lines 749-750 of `src/sage/repl/rich_output/display_manager.py`
 
 Comment: 1
 
``````




---

archive/issue_comments_491825.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:2 jdemeyer]:\n> Replying to [ticket:25665 egourgoulhon]:\n> > Indeed the value of `installed_packages()['threejs']` is used to form the url in lines 749-750 of `src/sage/repl/rich_output/display_manager.py`\n\n> \n> That's a really bad idea for multiple reasons.\n\n\nYes probably. I guess that was to ensure compatibility between the version of threejs actually used by Sage. By the way, in the directory `upstream`, we have `threejs-r80.tar.gz`, so where does the `.p0` come from?",
    "created_at": "2018-06-26T12:02:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25665#issuecomment-491825",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:5'></a>Replying to [comment:2 jdemeyer]:
> Replying to [ticket:25665 egourgoulhon]:
> > Indeed the value of `installed_packages()['threejs']` is used to form the url in lines 749-750 of `src/sage/repl/rich_output/display_manager.py`

> 
> That's a really bad idea for multiple reasons.


Yes probably. I guess that was to ensure compatibility between the version of threejs actually used by Sage. By the way, in the directory `upstream`, we have `threejs-r80.tar.gz`, so where does the `.p0` come from?



---

archive/issue_comments_491826.json:
```json
{
    "body": "<a id='comment:7'></a>That was indeed to ensure that the same version is used. If there is a better way - please implement it! And an obvious way to get rid of patched suffixes for this particular case is to just use the part of the version before the dot.",
    "created_at": "2018-06-26T19:03:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25665#issuecomment-491826",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:7'></a>That was indeed to ensure that the same version is used. If there is a better way - please implement it! And an obvious way to get rid of patched suffixes for this particular case is to just use the part of the version before the dot.



---

archive/issue_comments_491827.json:
```json
{
    "body": "Changing commit from \"\" to \"867e1ffe5b15a3827d2828ad57ac23f392f7f4ee\"",
    "created_at": "2018-07-01T07:59:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25665#issuecomment-491827",
    "user": "https://github.com/fchapoton"
}
```

Changing commit from "" to "867e1ffe5b15a3827d2828ad57ac23f392f7f4ee"



---

archive/issue_comments_491828.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-07-01T07:59:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25665#issuecomment-491828",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_491829.json:
```json
{
    "body": "Changing author from \"\" to \"Fr\u00e9d\u00e9ric Chapoton\"",
    "created_at": "2018-07-01T07:59:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25665#issuecomment-491829",
    "user": "https://github.com/fchapoton"
}
```

Changing author from "" to "Frédéric Chapoton"



---

archive/issue_comments_491830.json:
```json
{
    "body": "<a id='comment:10'></a>New commits:",
    "created_at": "2018-07-01T07:59:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25665#issuecomment-491830",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:10'></a>New commits:



---

archive/issue_comments_491831.json:
```json
{
    "body": "Changing branch from \"\" to \"u/chapoton/25665\"",
    "created_at": "2018-07-01T07:59:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25665#issuecomment-491831",
    "user": "https://github.com/fchapoton"
}
```

Changing branch from "" to "u/chapoton/25665"



---

archive/issue_comments_491832.json:
```json
{
    "body": "<a id='comment:11'></a>The use of is `installed_packages` at runtime in sage is of course one of my pet hates. I don't have an alternative to offer at the present time. In fact I am just realising how this bit is broken in sage-on-gentoo right now (I don't offer an offline option either). Where could I find a list of valid versions for the online cdn? Is there something like \"latest\"?",
    "created_at": "2018-07-01T08:14:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25665#issuecomment-491832",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:11'></a>The use of is `installed_packages` at runtime in sage is of course one of my pet hates. I don't have an alternative to offer at the present time. In fact I am just realising how this bit is broken in sage-on-gentoo right now (I don't offer an offline option either). Where could I find a list of valid versions for the online cdn? Is there something like "latest"?



---

archive/issue_comments_491833.json:
```json
{
    "body": "<a id='comment:12'></a>Thanks for the fix!",
    "created_at": "2018-07-01T09:43:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25665#issuecomment-491833",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:12'></a>Thanks for the fix!



---

archive/issue_comments_491834.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-07-01T09:43:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25665#issuecomment-491834",
    "user": "https://github.com/egourgoulhon"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_491835.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Eric Gourgoulhon\"",
    "created_at": "2018-07-01T09:43:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25665#issuecomment-491835",
    "user": "https://github.com/egourgoulhon"
}
```

Changing reviewer from "" to "Eric Gourgoulhon"



---

archive/issue_events_064256.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-07-07T01:34:46Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/25665",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25665#event-64256"
}
```



---

archive/issue_comments_491836.json:
```json
{
    "body": "Changing branch from \"u/chapoton/25665\" to \"867e1ffe5b15a3827d2828ad57ac23f392f7f4ee\"",
    "created_at": "2018-07-07T01:34:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25665#issuecomment-491836",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/chapoton/25665" to "867e1ffe5b15a3827d2828ad57ac23f392f7f4ee"



---

archive/issue_comments_491837.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-07-07T01:34:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25665#issuecomment-491837",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
