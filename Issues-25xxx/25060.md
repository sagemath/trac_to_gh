# Issue 25060: Quotient ring elements don't convert correctly from Singular

archive/issues_025060.json:
```json
{
    "body": "CC:  @mezzarobba\n\nTest case:\n\nCreate a multivariate quotient ring, construct an ideal, extract a generator from the ideal, and ensure that it can be `lift`ed back to the original ring:\n\n```\nsage: R.<x,y> = QQ[]\nsage: SE.<xbar,ybar> = R.quotient(x^2 + y^2 - 1)\nsage: P = ideal(xbar,ybar)\nsage: P.0\nxbar\nsage: P.0.parent()\nQuotient of Multivariate Polynomial Ring in x, y over Rational Field by the ideal (x^2 + y^2 - 1)\nsage: P.0.lift()\nx\nsage: P.0.lift().parent()\nMultivariate Polynomial Ring in x, y over Rational Field\n```\n\nNow convert the ideal to Singular, then back to Sage, and try to do the lift again:\n\n```\nsage: P2 = P._singular_().sage()\nsage: P2\nIdeal (x, y) of Quotient of Multivariate Polynomial Ring in x, y over Rational Field by the ideal (x^2 + y^2 - 1)\nsage: P2.0\nx\nsage: P2.0.parent()\nQuotient of Multivariate Polynomial Ring in x, y over Rational Field by the ideal (x^2 + y^2 - 1)\nsage: P2.0.lift()\nx\nsage: P2.0.lift().parent()\nQuotient of Multivariate Polynomial Ring in x, y over Rational Field by the ideal (x^2 + y^2 - 1)\n```\n\nThe problem is related to how a QuotientRingElement is constructed:\n\n```\nHelp on class QuotientRingElement in module sage.rings.quotient_ring_element:\n\nclass QuotientRingElement(sage.structure.element.RingElement)\n |  An element of a quotient ring `R/I`.\n |  \n |  INPUT:\n |  \n |  - ``parent`` - the ring `R/I`\n |  \n |  - ``rep`` - a representative of the element in `R`; this is used\n |    as the internal representation of the element\n |  \n |  - ``reduce`` - bool (optional, default: True) - if True, then the\n |    internal representation of the element is ``rep`` reduced modulo\n |    the ideal `I`\n```\n\nNotice that `rep` should be in the cover ring, but the Singular conversion function builds it in the quotient ring itself.\n\nAnother problem with this code is that it assumes that any QuotientRing_generic is implemented using MPolynomial_polydict.\n\nThis patch uses the default element constructors of both the QuotientRing and the MPolynomialRing to correctly convert quotient ring elements back from Singular to Sage.\n\nThere is a single change to a regression test, where a Singular element is now reduced modulo the quotient ring's ideal when it gets converted to Sage (as it should be, in my opinion).\n\nI couldn't simplify the test case any further, because just converting a quotient ring element to Singular and back to Sage moved it into the cover ring:\n\n```\nsage: xbar._singular_().sage()\nx\nsage: xbar._singular_().sage().parent()\nMultivariate Polynomial Ring in x, y over Rational Field\n```\n\nI think this might be a separate bug.\n\nAlso, should the term \"cover ring\" or \"ambient ring\" be preferred?  QuotientRing implements the method `cover_ring` and makes `ambient` a copy of it.\n\nIssue created by migration from https://trac.sagemath.org/ticket/25297\n\n",
    "closed_at": "2018-05-15T22:33:34Z",
    "created_at": "2018-05-06T04:16:45Z",
    "labels": [
        "component: interfaces",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.3",
    "title": "Quotient ring elements don't convert correctly from Singular",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25060",
    "user": "https://github.com/BrentBaccala"
}
```
CC:  @mezzarobba

Test case:

Create a multivariate quotient ring, construct an ideal, extract a generator from the ideal, and ensure that it can be `lift`ed back to the original ring:

```
sage: R.<x,y> = QQ[]
sage: SE.<xbar,ybar> = R.quotient(x^2 + y^2 - 1)
sage: P = ideal(xbar,ybar)
sage: P.0
xbar
sage: P.0.parent()
Quotient of Multivariate Polynomial Ring in x, y over Rational Field by the ideal (x^2 + y^2 - 1)
sage: P.0.lift()
x
sage: P.0.lift().parent()
Multivariate Polynomial Ring in x, y over Rational Field
```

Now convert the ideal to Singular, then back to Sage, and try to do the lift again:

```
sage: P2 = P._singular_().sage()
sage: P2
Ideal (x, y) of Quotient of Multivariate Polynomial Ring in x, y over Rational Field by the ideal (x^2 + y^2 - 1)
sage: P2.0
x
sage: P2.0.parent()
Quotient of Multivariate Polynomial Ring in x, y over Rational Field by the ideal (x^2 + y^2 - 1)
sage: P2.0.lift()
x
sage: P2.0.lift().parent()
Quotient of Multivariate Polynomial Ring in x, y over Rational Field by the ideal (x^2 + y^2 - 1)
```

The problem is related to how a QuotientRingElement is constructed:

```
Help on class QuotientRingElement in module sage.rings.quotient_ring_element:

class QuotientRingElement(sage.structure.element.RingElement)
 |  An element of a quotient ring `R/I`.
 |  
 |  INPUT:
 |  
 |  - ``parent`` - the ring `R/I`
 |  
 |  - ``rep`` - a representative of the element in `R`; this is used
 |    as the internal representation of the element
 |  
 |  - ``reduce`` - bool (optional, default: True) - if True, then the
 |    internal representation of the element is ``rep`` reduced modulo
 |    the ideal `I`
```

Notice that `rep` should be in the cover ring, but the Singular conversion function builds it in the quotient ring itself.

Another problem with this code is that it assumes that any QuotientRing_generic is implemented using MPolynomial_polydict.

This patch uses the default element constructors of both the QuotientRing and the MPolynomialRing to correctly convert quotient ring elements back from Singular to Sage.

There is a single change to a regression test, where a Singular element is now reduced modulo the quotient ring's ideal when it gets converted to Sage (as it should be, in my opinion).

I couldn't simplify the test case any further, because just converting a quotient ring element to Singular and back to Sage moved it into the cover ring:

```
sage: xbar._singular_().sage()
x
sage: xbar._singular_().sage().parent()
Multivariate Polynomial Ring in x, y over Rational Field
```

I think this might be a separate bug.

Also, should the term "cover ring" or "ambient ring" be preferred?  QuotientRing implements the method `cover_ring` and makes `ambient` a copy of it.

Issue created by migration from https://trac.sagemath.org/ticket/25297





---

archive/issue_comments_352206.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-05-06T04:27:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25060#issuecomment-352206",
    "user": "https://github.com/BrentBaccala"
}
```

New commits:



---

archive/issue_comments_352207.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-05-06T04:27:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25060#issuecomment-352207",
    "user": "https://github.com/BrentBaccala"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_352208.json:
```json
{
    "body": "Travis, sorry, but while I sometimes have to patch stuff that uses libsingular, I know very little about Singular in general, or about the Singular text interface in Sage...\n\nThat being said, the changes in this ticket look good to me. (A question on a minor point though: why are you changing `isinstance()` to `is_Foo()` in some places? I think the current tendency is to slowly get rid of these `is_Foo()` functions in cases where they don't bring anything.)",
    "created_at": "2018-05-10T19:04:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25060#issuecomment-352208",
    "user": "https://github.com/mezzarobba"
}
```

Travis, sorry, but while I sometimes have to patch stuff that uses libsingular, I know very little about Singular in general, or about the Singular text interface in Sage...

That being said, the changes in this ticket look good to me. (A question on a minor point though: why are you changing `isinstance()` to `is_Foo()` in some places? I think the current tendency is to slowly get rid of these `is_Foo()` functions in cases where they don't bring anything.)



---

archive/issue_comments_352209.json:
```json
{
    "body": "Replying to [comment:3 mmezzarobba]:\n> Travis, sorry, but while I sometimes have to patch stuff that uses libsingular, I know very little about Singular in general, or about the Singular text interface in Sage...\n\n\nNo worries. I have even less knowledge, but I was just trying to put someone in cc who might either know, use the code, or know who could review the code.\n\n> That being said, the changes in this ticket look good to me. (A question on a minor point though: why are you changing `isinstance()` to `is_Foo()` in some places? I think the current tendency is to slowly get rid of these `is_Foo()` functions in cases where they don't bring anything.)\n\n\n+1 on reverting these changes as well.",
    "created_at": "2018-05-10T22:21:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25060#issuecomment-352209",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:3 mmezzarobba]:
> Travis, sorry, but while I sometimes have to patch stuff that uses libsingular, I know very little about Singular in general, or about the Singular text interface in Sage...


No worries. I have even less knowledge, but I was just trying to put someone in cc who might either know, use the code, or know who could review the code.

> That being said, the changes in this ticket look good to me. (A question on a minor point though: why are you changing `isinstance()` to `is_Foo()` in some places? I think the current tendency is to slowly get rid of these `is_Foo()` functions in cases where they don't bring anything.)


+1 on reverting these changes as well.



---

archive/issue_comments_352210.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-13T01:56:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25060#issuecomment-352210",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_352211.json:
```json
{
    "body": "Replying to [comment:4 tscrim]:\n> Replying to [comment:3 mmezzarobba]:\n> > That being said, the changes in this ticket look good to me. (A question on a minor point though: why are you changing `isinstance()` to `is_Foo()` in some places? I think the current tendency is to slowly get rid of these `is_Foo()` functions in cases where they don't bring anything.)\n\n> \n> +1 on reverting these changes as well.\n\n\nI'm pretty new to Sage, and thought that those `is_Foo()` were provided, and so should be preferred.  Change reverted.",
    "created_at": "2018-05-13T01:57:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25060#issuecomment-352211",
    "user": "https://github.com/BrentBaccala"
}
```

Replying to [comment:4 tscrim]:
> Replying to [comment:3 mmezzarobba]:
> > That being said, the changes in this ticket look good to me. (A question on a minor point though: why are you changing `isinstance()` to `is_Foo()` in some places? I think the current tendency is to slowly get rid of these `is_Foo()` functions in cases where they don't bring anything.)

> 
> +1 on reverting these changes as well.


I'm pretty new to Sage, and thought that those `is_Foo()` were provided, and so should be preferred.  Change reverted.



---

archive/issue_comments_352212.json:
```json
{
    "body": "Patchbot is green, so I am going to give the go-ahead. Thanks to both.\n\nBrent, the reasoning is that it is an extra Python function call, which is relatively expensive compared to an `isinstance`. Plus we eventually hope to do away with most/all of the `is_Foo()` functions.",
    "created_at": "2018-05-13T08:34:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25060#issuecomment-352212",
    "user": "https://github.com/tscrim"
}
```

Patchbot is green, so I am going to give the go-ahead. Thanks to both.

Brent, the reasoning is that it is an extra Python function call, which is relatively expensive compared to an `isinstance`. Plus we eventually hope to do away with most/all of the `is_Foo()` functions.



---

archive/issue_comments_352213.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-05-13T08:34:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25060#issuecomment-352213",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_352214.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-05-15T22:33:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25060#issuecomment-352214",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_063409.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-05-15T22:33:34Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/25060",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25060#event-63409"
}
```
