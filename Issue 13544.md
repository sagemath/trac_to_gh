# Issue 13544: multiprocessing and sig_block don't interact well

Issue created by migration from https://trac.sagemath.org/ticket/13748

Original creator: roed

Original creation time: 2012-11-24 13:38:46

Assignee: jdemeyer

CC:  kini ohanar jhpalmieri jdemeyer

The following problem arose while working on #12415.  Put the following code in your `~/.sage/init.sage`:


```
import multiprocessing
class Task(multiprocessing.Process):
    def run(self):
        sage_namespace = dict(sage.all_cmdline.__dict__)
        exec compile("from sage.tests.interrupt import *","","single",0,1) in sage_namespace
        exec compile("test_sig_block()","","single",0,1) in sage_namespace
        exec compile("sig_on_count()","","single",0,1) in sage_namespace
Task().start()
```


It will result in the following being printed (though your Sage process survives since the segfault occurs in a chile process):


```
42
0

------------------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred in Sage.
This probably occurred because a *compiled* component of Sage has a bug
in it and is not properly wrapped with sig_on(), sig_off(). You might
want to run Sage under gdb with 'sage -gdb' to debug this.
Sage will now terminate.
------------------------------------------------------------------------
```


Typing it in to a running Sage session does not cause the same failure.


---

Comment by jdemeyer created at 2013-01-03 17:25:47

I found the culprit. Putting all the code inside `try:/except:` instead of just `sig_on()` fixes the problem.


---

Attachment

Apparently, it is illegal to exit a `try` block while `sig_on()` is in effect.

Patch (which also adds some debug code for `sig_block()`/`sig_unblock()`) needs review.


---

Comment by jdemeyer created at 2013-01-03 18:39:38

Changing status from new to needs_review.


---

Comment by vbraun created at 2013-01-08 11:41:25

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2013-01-08 11:41:25

I suppose that it does confuse something on the Python heap when you suddenly jump back into the try/except block? 

Patch looks good to me.


---

Comment by jdemeyer created at 2013-01-09 09:00:02

Resolution: fixed
