# Issue 23122: Don't embed rpaths during the build

Issue created by migration from Trac.

Original creator: infinity0

Original creation time: 2017-07-03 22:17:44




---

Comment by infinity0 created at 2017-07-03 22:25:49

Changing status from new to needs_review.


---

Comment by infinity0 created at 2017-07-03 22:25:49

New commits:


---

Comment by infinity0 created at 2017-07-03 22:25:49

Changing priority from major to minor.


---

Comment by infinity0 created at 2017-07-03 22:25:49

Changing type from PLEASE CHANGE to enhancement.


---

Comment by infinity0 created at 2017-07-03 22:25:49

Changing component from PLEASE CHANGE to build.


---

Comment by fbissey created at 2017-07-03 23:36:34

Thou shall not use sage's provided `sage-env` in sage-on-distro. Seriously don't :) I am even wondering why I contribute to it.

Setting rpath is sage as an arbitrary prefixed package's way to find its own stuff. Historically sage was using `LD_LIBRARY_PATH` or equivalent. Which was also set in `sage-env`.... To be clear if you remove the rpath and sage is not installed in system path, which is what happens for vanilla installs, someone will have to put `LD_LIBRARY_PATH` back.

Which goes back to my point. My recommendation for fellow distros is just bring your own `sage-env`, don't burden yourself with that bag of seemingly random stuff (it used to be worse much worse). It is just toxic to distros in this shape. May be if we rebuilt it from scratch using autotools it would be more palatable but that's much more than your small change here.


---

Comment by fbissey created at 2017-07-03 23:57:23

Now Looking more closely I see you re-introduce `LD_LIBRARY_PATH` (which is linux only, use DYLD_LIBRARY_PATH on OS X please). You could say the debate between rpath and LD_LIBRARY_PATH has already happened and a shift from one to the other was made.

So you want them to switch back... I am not sure what to say to you about that.


---

Comment by infinity0 created at 2017-07-04 07:32:16

We don't ship Sage's own `sage-env`, we took that tip off Gentoo a while ago. :) However we build with it for various reasons. For example, Sage needs access to `SAGE_SRC` during the build, and various other things we don't put in our own `sage-env`.

It seems [OpenBSD](https://man.openbsd.org/ldconfig) and [FreeBSD](https://www.freebsd.org/cgi/man.cgi?query=ld.so) do support `LD_LIBRARY_PATH`. I'm not sure when they added this, perhaps FreeBSD means Mac OS X now also supports it. Do you have a link to any threads on this topic? Maybe it's a good time for Sage to revisit this issue.

As I said, the main advantage is that `SAGE_LOCAL` can be moved around. It's also useful for reproducible builds, which last time I checked, Sage was very close to achieving - there was only some Cython issue with embedded paths.


---

Comment by jdemeyer created at 2017-07-04 07:56:26

Changing status from needs_review to needs_info.


---

Comment by jdemeyer created at 2017-07-04 07:56:26

There have been many discussions in the past about this... I don't know much about dynamic linking myself, but I do know that there are reasons why Sage uses rpaths.

At least this ticket should be discussed on sage-devel.


---

Comment by fbissey created at 2017-07-04 08:24:46

Replying to [comment:6 infinity0]:
> We don't ship Sage's own `sage-env`, we took that tip off Gentoo a while ago. :) However we build with it for various reasons. For example, Sage needs access to `SAGE_SRC` during the build, and various other things we don't put in our own `sage-env`.
> 

You can use `sage-env` for that but really during the build of "sagelib" most thing are coming from `sage/env.py`. Those value can be overridden by the environment which is the main reason my ebuild has the following section

```
	export SAGE_LOCAL="${EPREFIX}"/usr
	export SAGE_ROOT=`pwd`/..
	export SAGE_SRC=`pwd`
	export SAGE_ETC=`pwd`/bin
	export SAGE_DOC=`pwd`/build_doc
	export SAGE_DOC_SRC=`pwd`/doc
	export SAGE_DOC_MATHJAX=yes
	export VARTEXFONTS="${T}"/fonts
	export SAGE_VERSION=${PV}
	export SAGE_NUM_THREADS=$(makeopts_jobs)
```

`pwd` in that context is the `src` folder from the sage tarball. The build takes its cues from there.

Otherwise I agree with Jeroen. A flip back of this magnitude has to be discussed on sage-devel. Having an experience on HPC and various package managers which build software stack on top on an OS I fall heavily in the rpath camp. No solution to this problem is 100% perfect, but rpath now does it for me. Sage as a software stack falls in that category. This is of course different from the "sagelib" component itself, which should be free to have a life independent of the sage packaging system.
