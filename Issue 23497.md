# Issue 23497: Implement iterator for generic permutations in Cython

Issue created by migration from https://trac.sagemath.org/ticket/23734

Original creator: tscrim

Original creation time: 2017-08-28 04:51:05

CC:  sage-combinat chapoton darij saliola

Keywords: days88, IMA coding sprints

We Cythonize the permutation iterator (`__iter__` method) for speed and for any class that wants to use them but just wanted to use lists.


---

Comment by tscrim created at 2017-08-28 04:54:03

We get a speedup of about 20%:

```
sage: P = Permutations([1,1,1,2,2,3,4,5])
sage: %timeit list(P)
100 loops, best of 3: 10.4 ms per loop
```

versus the old

```
sage: P = Permutations([1,1,1,2,2,3,4,5])
sage: %timeit list(P)
100 loops, best of 3: 12.1 ms per loop
```


This was part of the code I used to try and get a fast monomial * monomial for #23694.
----
New commits:


---

Comment by tscrim created at 2017-08-28 04:54:03

Changing status from new to needs_review.


---

Comment by git created at 2017-08-28 05:23:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-08-28 10:50:14

1. It is bad practice to use `int` for indices (even though it is unlikely that anybody will ever use permutations with more than 2<sup>31</sup> elements). Use `Py_ssize_t` instead.

2. A more general design remark: if you really just want to store an array of integers, a Python `list` is not the most efficient. More efficient would be to use a Python [array](https://docs.python.org/2/library/array.html) (essentially a C array with a Python interface) for example.


---

Comment by jdemeyer created at 2017-08-28 10:50:14

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-08-28 16:19:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-08-28 16:23:35

Replying to [comment:4 jdemeyer]:
> 1. It is bad practice to use `int` for indices (even though it is unlikely that anybody will ever use permutations with more than 2<sup>31</sup> elements). Use `Py_ssize_t` instead.

Done.

> 2. A more general design remark: if you really just want to store an array of integers, a Python `list` is not the most efficient. More efficient would be to use a Python [array](https://docs.python.org/2/library/array.html) (essentially a C array with a Python interface) for example.

I would except Cython doesn't seem to like them as a type. Part of me is tempted to use true C array of `Py_ssize_t`, but at the same time, that would limit the input from making this a more generic tool. Granted, enforcing `Py_ssize_t` wouldn't be such a bad thing. Do you have a thought on this?


---

Comment by tscrim created at 2017-08-28 16:23:35

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-08-28 20:43:57

Replying to [comment:6 tscrim]:
> I would except Cython doesn't seem to like them as a type.

I should have mentioned http://cython.readthedocs.io/en/latest/src/tutorial/array.html


---

Comment by git created at 2017-08-28 22:44:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-08-28 22:50:50

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by tscrim created at 2017-08-28 22:51:50

Thank you, that is very useful information and will give me some more tools to speed things up. I redid the iterator using arrays, which then makes the pure iterator go 3x faster. However, it did actually make the `Permutations` iterator slower because of the extra conversion; once I implemented a custom Cython build-the-list function, I got a 7% speedup instead (9.3ms compared to the timings above). Yet, I added the flag to skip the validation checks for the element constructor and now get:

```
sage: P = Permutations([1,1,1,2,2,3,4,5])
sage: %timeit list(P)
100 loops, best of 3: 2.26 ms per loop
```



---

Comment by git created at 2017-08-31 00:52:15

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2017-09-01 23:55:10

How does the timings compare to `itertools.permutations`?

```
sage: for p in itertools.permutations([0,1,2]):
....:     print p
(0, 1, 2)
(0, 2, 1)
(1, 0, 2)
(1, 2, 0)
(2, 0, 1)
(2, 1, 0)
```

(note: `itertools.permutations` do not handle the multisets)


---

Comment by tscrim created at 2017-09-02 00:14:44


```
sage: from array import array
sage: import itertools
sage: def test_itertools(n):
....:     for p in itertools.permutations(list(range(n))):
....:         pass
sage: def test_next_perm(n):
....:     data = array('I', list(range(n)))
....:     while next_perm(data):
....:         data.tolist()
```

gives

```
sage: %timeit test_itertools(3)
The slowest run took 7.87 times longer than the fastest. This could mean that an intermediate result is being cached.
1000000 loops, best of 3: 1.03 µs per loop
sage: %timeit test_next_perm(3)
The slowest run took 5.16 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 2.31 µs per loop
sage: %timeit test_itertools(10)
1 loop, best of 3: 200 ms per loop
sage: %timeit test_next_perm(10)
1 loop, best of 3: 1.16 s per loop
```

However, if we use:

```
sage: def test_next_perm(n):
....:     data = array('I', list(range(n)))
....:     while next_perm(data):
....:         pass
```

then we get

```
sage: %timeit test_next_perm(3)
The slowest run took 8.06 times longer than the fastest. This could mean that an intermediate result is being cached.
1000000 loops, best of 3: 976 ns per loop
sage: %timeit test_next_perm(10)
10 loops, best of 3: 108 ms per loop
sage: %timeit test_next_perm(11)
1 loop, best of 3: 1.19 s per loop
sage: %timeit test_itertools(11)
1 loop, best of 3: 2.37 s per loop
```

So a _lot_ of time is lost converting back to a list. However, if you can work only in arrays, then it becomes very quick.


---

Comment by tscrim created at 2017-09-05 19:42:34

Essentially a green bot.


---

Comment by vdelecroix created at 2017-09-06 18:22:39

`cpdef next_perm(array.array l)` -> `cpdef bint next_perm(array.array l)`

And you can have an unsafe faster `map_to_list` as follows

```
cdef extern from "Python.h":
    void Py_INCREF(PyObject *)

cdef extern from "listobject.h":
    list PyList_New(Py_ssize_t size)
    void PyList_SET_ITEM(list l, Py_ssize_t, PyObject *)

cdef extern from "tupleobject.h":
    PyObject * PyTuple_GET_ITEM(PyObject *op, Py_ssize_t i)

cpdef list map_to_list(array.array l, values, int n):
    cdef int i
    cdef list ret = PyList_New(n)
    cdef PyObject * t
    for i in range(n):
        t = PyTuple_GET_ITEM(<PyObject *> values, l.data.as_uints[i])
        Py_INCREF(t)
        PyList_SET_ITEM(ret, i, t)
    return ret
```



---

Comment by vdelecroix created at 2017-09-06 18:25:15

(be careful to not import the C-API functions from Cython as the generated C code would be different)


---

Comment by tscrim created at 2017-09-24 17:02:54

Sorry for letting this languish.

I'm not sure what you mean by comment:16. Are you referring to the `from cpython.list import *` line? Somewhat related is the code above gives a signature conflict with `PyList_SET_ITEM` where the third argument is an `int` in my code and a `PyObject*` in your code. Could you give me a little more information or make changes directly in the branch?


---

Comment by vdelecroix created at 2017-09-24 18:48:37

Indeed. You need to import from `cpython.list` only the things you are using avoiding the functions that are declared in my version. In particular you could not use the joker `*`. The signatures in Cython files are slightly different from the one in Python headers (main change is that `PyObject *` are replaced with `object`).


---

Comment by git created at 2017-09-24 19:57:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2017-09-24 19:57:53

See my commits.


---

Comment by tscrim created at 2017-09-29 20:51:21

Thank you. Your changes LGTM. Can I consider this at a positive review?


---

Comment by vdelecroix created at 2017-09-30 08:10:08

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2017-09-30 15:52:44

Thank you again.


---

Comment by vbraun created at 2017-10-05 06:53:58

Resolution: fixed
