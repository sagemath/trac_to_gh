# Issue 17830: sage/graphs/graph.py: multigraph recognition in init fails

Issue created by migration from https://trac.sagemath.org/ticket/18067

Original creator: darij

Original creation time: 2015-03-27 06:48:24

CC:  ncohen sage-combinat tmonteil vdelecroix dcoudert

Keywords: graphs, sage-combinat,

The idea seems to be that the `__init__` method of `Graph` should check if the user provides some edges more than 1 time, and, if so, return a multigraph instead of a graph. In reality, whether this happens depends on the order of vertices the user provides:


```
sage: Graph([[1,2],[1,2]])
Multi-graph on 2 vertices
sage: Graph([[1,2],[2,1]])
Graph on 2 vertices
```


Apparently, it is the `if len(set(data[u])) != len(data[u])` conditional on line 1497 of graph.py which fails to fire in the second example.


---

Comment by ncohen created at 2015-03-27 09:49:29

Hello !

I was actually thinking of this very behaviour last week, as many things in the (di)Graph constructors should be rewritten. A lot of time is also wasted because we have to detect what the user 'intends' to build, and at some point I thought that this could be solved by asking the user to tell us explicitly whether (s)he wants a simple graph or a multigraph, using the `multiedges=True` flag. Nowadays, I am not so sure anymore.

In this specific case, I also believe that, as you advise, we should return a multigraph. But to understand better what it works this way, see how it works for dictionary input (note that 'list of edges' input is converted into dictionary input):


```
sage: Graph({1:[2],2:[1]}).edges()
[(1, 2, None)]
```


What do you think the user wants in this case ? Is (s)he giving us a multigraph, or merely giving the adjacencies between the vertices in both directions?

Right now, giving the adjacencies in both direction or giving them only once yields the same result


```
sage: Graph({1:[2],2:[1]}) == Graph({1:[2]})
True
```


And of course, saying twice that 2 is a neighbor of 1 yields a multigraph


```
sage: Graph({1:[2,2]})
Multi-graph on 2 vertices
```


I will fix this bug soon, by making `Graph(list_of_edges)` call `add_edge` immediately. The code will also be shorter. But the graph constructors will have to be rewritten, and standards will change. We cannot guess the user's intent without guessing wrong at times, and we want to avoid that.

Nathann


---

Comment by darij created at 2015-03-27 19:39:20

Sorry, Nathann; I have no idea how to fix this mess short of replacing the catch-all `__init__` by a bunch of separate constructors each of which does one thing well and has a predictable return type. Guessing the user's intent shouldn't happen unless the user asks for it.


---

Comment by ncohen created at 2015-03-27 21:48:11

> Sorry, Nathann; I have no idea how to fix this mess short of replacing the catch-all `__init__` by a bunch of separate constructors each of which does one thing well and has a predictable return type.

Don't worry, I will write some code for that very soon. I am about to leave to Liege (Belgium) for some Sage days so I will not be able to do it this week-end most probably (I'll be backpacking) but it will definitely be done during the week.

I would also like to turn this huge `__init__` into independent functions, but that is not totally straightforward either. I do want to make it shorter, though.

> Guessing the user's intent shouldn't happen unless the user asks for it.

I agree with you. But I already wrote something to make those argument mandatory, and noticed that it broke doctests.. Because a complete graph stored as a multigraph is not (for Sage) equal to a complete graph (stored as a simple graph) and other problems like that.

Well. 1) I will fix this in the next days and 2) I am aware that this code has to be changed, and I will do something about it. Especially since David Coudert would like to be able to load huge graphs in Sage, and that it is currently impossible.

Nathann


---

Comment by darij created at 2015-03-27 21:58:04

Thanks a lot!

Yes, efficiency is too a reason to get rid of this ducktyping orgy.


---

Comment by ncohen created at 2015-04-01 09:19:29

Changing status from new to needs_review.


---

Comment by ncohen created at 2015-04-01 09:19:29

Just added a branch, and explained what in does in this ticket's description. Needs review `:-)`

Nathann


---

Comment by git created at 2015-04-01 09:20:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-04-01 09:29:42

more beautiful description!


---

Comment by git created at 2015-04-01 14:28:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2015-04-01 14:30:43

New commits:


---

Comment by darij created at 2015-04-02 01:09:22

I have nowhere near the expertise required to review this, but you have my thanks. This is a courageous and overdue step towards cleaning up the Augean stables of Sage's constructors.

Meanwhile, this:

```
        if format is None and is_Matrix(data):
            if data.is_square() and data == data.transpose():
                format = 'adjacency_matrix'
            else:
                format = 'incidence_matrix'
                msg += "Non-symmetric or non-square matrix assumed to be an incidence matrix: "
```

is so ugly it is almost ridiculous. Good job improving the if-condition, but IMHO the whole logic should go to hell. To drive the point home, maybe add a doctest with the matrix

```
0 0 0 0 1 1
0 0 0 1 0 1
0 0 0 1 1 0
0 1 1 0 0 0
1 0 1 0 0 0
1 1 0 0 0 0
```

as either incidence or adjacency matrix.


---

Comment by ncohen created at 2015-04-02 11:17:27

Hello,

> I have nowhere near the expertise required to review this, but you have my thanks. This is a courageous and overdue step towards cleaning up the Augean stables of Sage's constructors.

Well, this code really needs to be rewritten properly.

> is so ugly it is almost ridiculous.
+1

> Good job improving the if-condition, but IMHO the whole logic should go to hell.

Ahahaha. Well, I also agree with you on that point, but I cannot get code in Sage by myself. I know that I only fixed a small part of the problem in this ticket, but doing too many things at once makes it impossible to find a reviewer. Soooooo while I already know what the next ticket will be about, I thought that it was better to write a smaller patch first. Then the other will come.

> To drive the point home, maybe add a doctest with the matrix

I do not believe in adding doctests to explain that our code is bad. Let us change the code.

Nathann


---

Comment by darij created at 2015-04-02 18:52:06

That's fine -- it doesn't need to be fixed in this one ticket.

For reference, what is the rationale behind replacing `_weighted` by `weighted()`?


---

Comment by ncohen created at 2015-04-02 21:48:21

> For reference, what is the rationale behind replacing `_weighted` by `weighted()`?

Nothing smart. Only the trace of some debugging I did, before I noticed that I did not set `_weighted` to something different from None in an early version of the branch.

Nathann


---

Comment by ncohen created at 2015-04-09 06:56:16

Hellos guys! It would help if somebody could reviw this ticket, for I have more changes to make in the constructors (speed and clarity).

Nathann


---

Comment by dcoudert created at 2015-04-10 03:52:37

Changing status from needs_review to positive_review.


---

Comment by dcoudert created at 2015-04-10 03:52:37

For me the patch is OK. All tests pass (sage/graphs/ and sage/graphs/*/) and the doc builds normally.
David.


---

Comment by ncohen created at 2015-04-10 06:23:51

THaaaaaaaaaaaaaanks !!!!

Nathann


---

Comment by git created at 2015-04-11 22:59:00

Changing status from positive_review to needs_review.


---

Comment by git created at 2015-04-11 22:59:00

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by vbraun created at 2015-04-11 22:59:37

Fixed merge failure...


---

Comment by vbraun created at 2015-04-11 22:59:37

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-04-14 19:43:31

Resolution: fixed
