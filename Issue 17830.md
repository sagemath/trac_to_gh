# Issue 17830: sage/graphs/graph.py: multigraph recognition in init fails

archive/issues_017830.json:
```json
{
    "body": "CC:  ncohen sage-combinat tmonteil vdelecroix dcoudert\n\nKeywords: graphs, sage-combinat,\n\nThe idea seems to be that the `__init__` method of `Graph` should check if the user provides some edges more than 1 time, and, if so, return a multigraph instead of a graph. In reality, whether this happens depends on the order of vertices the user provides:\n\n\n```\nsage: Graph([[1,2],[1,2]])\nMulti-graph on 2 vertices\nsage: Graph([[1,2],[2,1]])\nGraph on 2 vertices\n```\n\n\nApparently, it is the `if len(set(data[u])) != len(data[u])` conditional on line 1497 of graph.py which fails to fire in the second example.\n\nIssue created by migration from https://trac.sagemath.org/ticket/18067\n\n",
    "created_at": "2015-03-27T06:48:24Z",
    "labels": [
        "graph theory",
        "major",
        "bug"
    ],
    "title": "sage/graphs/graph.py: multigraph recognition in init fails",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17830",
    "user": "darij"
}
```
CC:  ncohen sage-combinat tmonteil vdelecroix dcoudert

Keywords: graphs, sage-combinat,

The idea seems to be that the `__init__` method of `Graph` should check if the user provides some edges more than 1 time, and, if so, return a multigraph instead of a graph. In reality, whether this happens depends on the order of vertices the user provides:


```
sage: Graph([[1,2],[1,2]])
Multi-graph on 2 vertices
sage: Graph([[1,2],[2,1]])
Graph on 2 vertices
```


Apparently, it is the `if len(set(data[u])) != len(data[u])` conditional on line 1497 of graph.py which fails to fire in the second example.

Issue created by migration from https://trac.sagemath.org/ticket/18067





---

archive/issue_comments_239069.json:
```json
{
    "body": "Hello !\n\nI was actually thinking of this very behaviour last week, as many things in the (di)Graph constructors should be rewritten. A lot of time is also wasted because we have to detect what the user 'intends' to build, and at some point I thought that this could be solved by asking the user to tell us explicitly whether (s)he wants a simple graph or a multigraph, using the `multiedges=True` flag. Nowadays, I am not so sure anymore.\n\nIn this specific case, I also believe that, as you advise, we should return a multigraph. But to understand better what it works this way, see how it works for dictionary input (note that 'list of edges' input is converted into dictionary input):\n\n\n```\nsage: Graph({1:[2],2:[1]}).edges()\n[(1, 2, None)]\n```\n\n\nWhat do you think the user wants in this case ? Is (s)he giving us a multigraph, or merely giving the adjacencies between the vertices in both directions?\n\nRight now, giving the adjacencies in both direction or giving them only once yields the same result\n\n\n```\nsage: Graph({1:[2],2:[1]}) == Graph({1:[2]})\nTrue\n```\n\n\nAnd of course, saying twice that 2 is a neighbor of 1 yields a multigraph\n\n\n```\nsage: Graph({1:[2,2]})\nMulti-graph on 2 vertices\n```\n\n\nI will fix this bug soon, by making `Graph(list_of_edges)` call `add_edge` immediately. The code will also be shorter. But the graph constructors will have to be rewritten, and standards will change. We cannot guess the user's intent without guessing wrong at times, and we want to avoid that.\n\nNathann",
    "created_at": "2015-03-27T09:49:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17830#issuecomment-239069",
    "user": "ncohen"
}
```

Hello !

I was actually thinking of this very behaviour last week, as many things in the (di)Graph constructors should be rewritten. A lot of time is also wasted because we have to detect what the user 'intends' to build, and at some point I thought that this could be solved by asking the user to tell us explicitly whether (s)he wants a simple graph or a multigraph, using the `multiedges=True` flag. Nowadays, I am not so sure anymore.

In this specific case, I also believe that, as you advise, we should return a multigraph. But to understand better what it works this way, see how it works for dictionary input (note that 'list of edges' input is converted into dictionary input):


```
sage: Graph({1:[2],2:[1]}).edges()
[(1, 2, None)]
```


What do you think the user wants in this case ? Is (s)he giving us a multigraph, or merely giving the adjacencies between the vertices in both directions?

Right now, giving the adjacencies in both direction or giving them only once yields the same result


```
sage: Graph({1:[2],2:[1]}) == Graph({1:[2]})
True
```


And of course, saying twice that 2 is a neighbor of 1 yields a multigraph


```
sage: Graph({1:[2,2]})
Multi-graph on 2 vertices
```


I will fix this bug soon, by making `Graph(list_of_edges)` call `add_edge` immediately. The code will also be shorter. But the graph constructors will have to be rewritten, and standards will change. We cannot guess the user's intent without guessing wrong at times, and we want to avoid that.

Nathann



---

archive/issue_comments_239070.json:
```json
{
    "body": "Sorry, Nathann; I have no idea how to fix this mess short of replacing the catch-all `__init__` by a bunch of separate constructors each of which does one thing well and has a predictable return type. Guessing the user's intent shouldn't happen unless the user asks for it.",
    "created_at": "2015-03-27T19:39:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17830#issuecomment-239070",
    "user": "darij"
}
```

Sorry, Nathann; I have no idea how to fix this mess short of replacing the catch-all `__init__` by a bunch of separate constructors each of which does one thing well and has a predictable return type. Guessing the user's intent shouldn't happen unless the user asks for it.



---

archive/issue_comments_239071.json:
```json
{
    "body": "> Sorry, Nathann; I have no idea how to fix this mess short of replacing the catch-all `__init__` by a bunch of separate constructors each of which does one thing well and has a predictable return type.\n\nDon't worry, I will write some code for that very soon. I am about to leave to Liege (Belgium) for some Sage days so I will not be able to do it this week-end most probably (I'll be backpacking) but it will definitely be done during the week.\n\nI would also like to turn this huge `__init__` into independent functions, but that is not totally straightforward either. I do want to make it shorter, though.\n\n> Guessing the user's intent shouldn't happen unless the user asks for it.\n\nI agree with you. But I already wrote something to make those argument mandatory, and noticed that it broke doctests.. Because a complete graph stored as a multigraph is not (for Sage) equal to a complete graph (stored as a simple graph) and other problems like that.\n\nWell. 1) I will fix this in the next days and 2) I am aware that this code has to be changed, and I will do something about it. Especially since David Coudert would like to be able to load huge graphs in Sage, and that it is currently impossible.\n\nNathann",
    "created_at": "2015-03-27T21:48:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17830#issuecomment-239071",
    "user": "ncohen"
}
```

> Sorry, Nathann; I have no idea how to fix this mess short of replacing the catch-all `__init__` by a bunch of separate constructors each of which does one thing well and has a predictable return type.

Don't worry, I will write some code for that very soon. I am about to leave to Liege (Belgium) for some Sage days so I will not be able to do it this week-end most probably (I'll be backpacking) but it will definitely be done during the week.

I would also like to turn this huge `__init__` into independent functions, but that is not totally straightforward either. I do want to make it shorter, though.

> Guessing the user's intent shouldn't happen unless the user asks for it.

I agree with you. But I already wrote something to make those argument mandatory, and noticed that it broke doctests.. Because a complete graph stored as a multigraph is not (for Sage) equal to a complete graph (stored as a simple graph) and other problems like that.

Well. 1) I will fix this in the next days and 2) I am aware that this code has to be changed, and I will do something about it. Especially since David Coudert would like to be able to load huge graphs in Sage, and that it is currently impossible.

Nathann



---

archive/issue_comments_239072.json:
```json
{
    "body": "Thanks a lot!\n\nYes, efficiency is too a reason to get rid of this ducktyping orgy.",
    "created_at": "2015-03-27T21:58:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17830#issuecomment-239072",
    "user": "darij"
}
```

Thanks a lot!

Yes, efficiency is too a reason to get rid of this ducktyping orgy.



---

archive/issue_comments_239073.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-04-01T09:19:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17830#issuecomment-239073",
    "user": "ncohen"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_239074.json:
```json
{
    "body": "Just added a branch, and explained what in does in this ticket's description. Needs review `:-)`\n\nNathann",
    "created_at": "2015-04-01T09:19:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17830#issuecomment-239074",
    "user": "ncohen"
}
```

Just added a branch, and explained what in does in this ticket's description. Needs review `:-)`

Nathann



---

archive/issue_comments_239075.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-01T09:20:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17830#issuecomment-239075",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_239076.json:
```json
{
    "body": "more beautiful description!",
    "created_at": "2015-04-01T09:29:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17830#issuecomment-239076",
    "user": "vdelecroix"
}
```

more beautiful description!



---

archive/issue_comments_239077.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-01T14:28:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17830#issuecomment-239077",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_239078.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-04-01T14:30:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17830#issuecomment-239078",
    "user": "ncohen"
}
```

New commits:



---

archive/issue_comments_239079.json:
```json
{
    "body": "I have nowhere near the expertise required to review this, but you have my thanks. This is a courageous and overdue step towards cleaning up the Augean stables of Sage's constructors.\n\nMeanwhile, this:\n\n```\n        if format is None and is_Matrix(data):\n            if data.is_square() and data == data.transpose():\n                format = 'adjacency_matrix'\n            else:\n                format = 'incidence_matrix'\n                msg += \"Non-symmetric or non-square matrix assumed to be an incidence matrix: \"\n```\n\nis so ugly it is almost ridiculous. Good job improving the if-condition, but IMHO the whole logic should go to hell. To drive the point home, maybe add a doctest with the matrix\n\n```\n0 0 0 0 1 1\n0 0 0 1 0 1\n0 0 0 1 1 0\n0 1 1 0 0 0\n1 0 1 0 0 0\n1 1 0 0 0 0\n```\n\nas either incidence or adjacency matrix.",
    "created_at": "2015-04-02T01:09:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17830#issuecomment-239079",
    "user": "darij"
}
```

I have nowhere near the expertise required to review this, but you have my thanks. This is a courageous and overdue step towards cleaning up the Augean stables of Sage's constructors.

Meanwhile, this:

```
        if format is None and is_Matrix(data):
            if data.is_square() and data == data.transpose():
                format = 'adjacency_matrix'
            else:
                format = 'incidence_matrix'
                msg += "Non-symmetric or non-square matrix assumed to be an incidence matrix: "
```

is so ugly it is almost ridiculous. Good job improving the if-condition, but IMHO the whole logic should go to hell. To drive the point home, maybe add a doctest with the matrix

```
0 0 0 0 1 1
0 0 0 1 0 1
0 0 0 1 1 0
0 1 1 0 0 0
1 0 1 0 0 0
1 1 0 0 0 0
```

as either incidence or adjacency matrix.



---

archive/issue_comments_239080.json:
```json
{
    "body": "Hello,\n\n> I have nowhere near the expertise required to review this, but you have my thanks. This is a courageous and overdue step towards cleaning up the Augean stables of Sage's constructors.\n\nWell, this code really needs to be rewritten properly.\n\n> is so ugly it is almost ridiculous.\n+1\n\n> Good job improving the if-condition, but IMHO the whole logic should go to hell.\n\nAhahaha. Well, I also agree with you on that point, but I cannot get code in Sage by myself. I know that I only fixed a small part of the problem in this ticket, but doing too many things at once makes it impossible to find a reviewer. Soooooo while I already know what the next ticket will be about, I thought that it was better to write a smaller patch first. Then the other will come.\n\n> To drive the point home, maybe add a doctest with the matrix\n\nI do not believe in adding doctests to explain that our code is bad. Let us change the code.\n\nNathann",
    "created_at": "2015-04-02T11:17:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17830#issuecomment-239080",
    "user": "ncohen"
}
```

Hello,

> I have nowhere near the expertise required to review this, but you have my thanks. This is a courageous and overdue step towards cleaning up the Augean stables of Sage's constructors.

Well, this code really needs to be rewritten properly.

> is so ugly it is almost ridiculous.
+1

> Good job improving the if-condition, but IMHO the whole logic should go to hell.

Ahahaha. Well, I also agree with you on that point, but I cannot get code in Sage by myself. I know that I only fixed a small part of the problem in this ticket, but doing too many things at once makes it impossible to find a reviewer. Soooooo while I already know what the next ticket will be about, I thought that it was better to write a smaller patch first. Then the other will come.

> To drive the point home, maybe add a doctest with the matrix

I do not believe in adding doctests to explain that our code is bad. Let us change the code.

Nathann



---

archive/issue_comments_239081.json:
```json
{
    "body": "That's fine -- it doesn't need to be fixed in this one ticket.\n\nFor reference, what is the rationale behind replacing `_weighted` by `weighted()`?",
    "created_at": "2015-04-02T18:52:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17830#issuecomment-239081",
    "user": "darij"
}
```

That's fine -- it doesn't need to be fixed in this one ticket.

For reference, what is the rationale behind replacing `_weighted` by `weighted()`?



---

archive/issue_comments_239082.json:
```json
{
    "body": "> For reference, what is the rationale behind replacing `_weighted` by `weighted()`?\n\nNothing smart. Only the trace of some debugging I did, before I noticed that I did not set `_weighted` to something different from None in an early version of the branch.\n\nNathann",
    "created_at": "2015-04-02T21:48:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17830#issuecomment-239082",
    "user": "ncohen"
}
```

> For reference, what is the rationale behind replacing `_weighted` by `weighted()`?

Nothing smart. Only the trace of some debugging I did, before I noticed that I did not set `_weighted` to something different from None in an early version of the branch.

Nathann



---

archive/issue_comments_239083.json:
```json
{
    "body": "Hellos guys! It would help if somebody could reviw this ticket, for I have more changes to make in the constructors (speed and clarity).\n\nNathann",
    "created_at": "2015-04-09T06:56:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17830#issuecomment-239083",
    "user": "ncohen"
}
```

Hellos guys! It would help if somebody could reviw this ticket, for I have more changes to make in the constructors (speed and clarity).

Nathann



---

archive/issue_comments_239084.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-04-10T03:52:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17830#issuecomment-239084",
    "user": "dcoudert"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_239085.json:
```json
{
    "body": "For me the patch is OK. All tests pass (sage/graphs/ and sage/graphs/*/) and the doc builds normally.\nDavid.",
    "created_at": "2015-04-10T03:52:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17830#issuecomment-239085",
    "user": "dcoudert"
}
```

For me the patch is OK. All tests pass (sage/graphs/ and sage/graphs/*/) and the doc builds normally.
David.



---

archive/issue_comments_239086.json:
```json
{
    "body": "THaaaaaaaaaaaaaanks !!!!\n\nNathann",
    "created_at": "2015-04-10T06:23:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17830#issuecomment-239086",
    "user": "ncohen"
}
```

THaaaaaaaaaaaaaanks !!!!

Nathann



---

archive/issue_comments_239087.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2015-04-11T22:59:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17830#issuecomment-239087",
    "user": "git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_239088.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2015-04-11T22:59:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17830#issuecomment-239088",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_239089.json:
```json
{
    "body": "Fixed merge failure...",
    "created_at": "2015-04-11T22:59:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17830#issuecomment-239089",
    "user": "vbraun"
}
```

Fixed merge failure...



---

archive/issue_comments_239090.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-04-11T22:59:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17830#issuecomment-239090",
    "user": "vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_239091.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-04-14T19:43:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17830#issuecomment-239091",
    "user": "vbraun"
}
```

Resolution: fixed
