# Issue 14201: The libncurses hack breaks Python/readline

Issue created by migration from Trac.

Original creator: vbraun

Original creation time: 2013-04-03 11:34:58

Assignee: jdemeyer

CC:  jdemeyer jpflori leif

#12725 symlinks libtermcap.a to libncurses.a if it doesn't exist. This workaround allows Sage to compile, but the readline in Python is broken. Installing the ncurses headers from the distribution (yum install ncurses-devel) fixes this, because then the symlink is not created. 

Example video:  http://youtu.be/dxp1SIXbIyY


---

Comment by jdemeyer created at 2013-04-03 12:21:01

Does Python's readline work correctly with the old termcap spkg (http://boxen.math.washington.edu/home/release/sage-5.6/sage-5.6/spkg/standard/termcap-1.3.1.p2.spkg)? Because if it worked neither before #12725, nor after #12725, there is no bug.

If Python's readline did work before #12725 and #12725 broke it: please attach logs of the Python compilation, before and after (with the same Sage version, serial install).


---

Comment by jpflori created at 2013-04-03 12:30:13

I've tested an old 4.8 install which works fine whereas I found the same problem as Volker on a recent 5.9.beta2.
This is on two different Ubuntu 12.04.1 installs where libncurses5 and libncursesw5 packages are installed but no -dev packages are.


---

Comment by jdemeyer created at 2013-04-03 12:36:08

Replying to [comment:3 jpflori]:
> I've tested an old 4.8 install which works fine whereas I found the same problem as Volker on a recent 5.9.beta2.
> This is on two different Ubuntu 12.04.1 installs where libncurses5 and libncursesw5 packages are installed but no -dev packages are.

OK, then please try the things I asked to Volker: try without #12725 and show the Python logs so we can see what the problem is.


---

Comment by jpflori created at 2013-04-03 12:39:52

As I already typed that, here is a bit of info:
* On the 4.8 install, I have the usual "Python build finished, but the necessary bits to build these modules were not found" and the modules listed include _curses and _curses_panel.
* On the 5.9.beta2 install, it only lists the _curses_panel module and I have a new worrying line "Failed to build these modules" which only lists _curses. And indeed before in the log, there's an error:

```
In file included from .../_cursesmodule.c:114:0:
Include/py_curses.h:57:20: erreur fatale: curses.h : Aucun fichier ou dossier de ce type
```



---

Comment by jpflori created at 2013-04-03 12:42:45

(And installing the latest Python spkg on the 4.8 Sage install gives the same result as the old 2.6.* spkg which it included, i.e. missing bits for _curses and _curses_panel.)


---

Comment by jdemeyer created at 2013-04-03 12:54:18

Replying to [comment:6 jpflori]:
> (And installing the latest Python spkg on the 4.8 Sage install gives the same result as the old 2.6.* spkg which it included, i.e. missing bits for _curses and _curses_panel.)
But the end result is the same: the `_curses` module doesn't build (either due to "missing bits" or "failed to build"), neither with #12725, nor without. So I still doubt that #12725 is a problem.

What happens with other packages using readline, PARI/GP for example? How is the line editing in

```
$ ./sage --gp
```

And what is the header message when starting GP, it indicates whether or not readline is used.


---

Comment by jpflori created at 2013-04-03 12:57:29

And after removing the libncurses.a symlink and rebuilding the Python 2.7 spkg on the 5.9.beta2, the log looks similar to the one on the 4.8 install.
But Sage command line still seems broken (I've rebuilt ipython and run ./sage -b).

I could not test the new python on the 4.8 install as it does not like it that much and fails to rebuild.

No such problems on 5.6 and 5.7, so I guess that #12725 is not the culprit for the bug (although the error message about _curses I get shows it may not be that useful).
Maybe new ipython?


---

Comment by vbraun created at 2013-04-03 12:58:58

The standard Fedora install contains `ncurses` and `ncurses-libs` rpms, which install `libncurses.so.5` but no `libncurses.so`. Only the `ncurses-devel` package, which is not installed by default, brings `libncurses.so`.


---

Comment by jpflori created at 2013-04-03 13:02:04

Replying to [comment:8 jpflori]:
> And after removing the libncurses.a symlink and rebuilding the Python 2.7 spkg on the 5.9.beta2, the log looks similar to the one on the 4.8 install.
> But Sage command line still seems broken (I've rebuilt ipython and run ./sage -b).
> 
> I could not test the new python on the 4.8 install as it does not like it that much and fails to rebuild.
> 
> No such problems on 5.6 and 5.7, so I guess that #12725 is not the culprit for the bug (although the error message about _curses I get shows it may not be that useful).
> Maybe new ipython?
Ipython was updated in 5.7, so that's not it.


---

Comment by vbraun created at 2013-04-03 13:04:15

I've removed `ncurses-devel` again and compiled sage-5.9.beta2 with the old termcap-1.3.1.p2.spkg. The python command line is still borked in the same way. But no libncurses symlink. So I guess the bug is somewhere else.


---

Comment by jpflori created at 2013-04-03 13:06:28

Replying to [comment:7 jdemeyer]:
> Replying to [comment:6 jpflori]:
> > (And installing the latest Python spkg on the 4.8 Sage install gives the same result as the old 2.6.* spkg which it included, i.e. missing bits for _curses and _curses_panel.)
> But the end result is the same: the `_curses` module doesn't build (either due to "missing bits" or "failed to build"), neither with #12725, nor without. So I still doubt that #12725 is a problem.
> 
> What happens with other packages using readline, PARI/GP for example? How is the line editing in
> {{{
> $ ./sage --gp
> }}}
> And what is the header message when starting GP, it indicates whether or not readline is used.
I've now rebuilt readline, ipython, pari as well, still without the libncurses.a symlink.
./sage -gp works fine (and shows realine 6.2 is enabled), and sage command line still broken.


---

Comment by jpflori created at 2013-04-03 13:07:40

Note the ./sage -python command line is fine, whereas ./sage -ipython is not.


---

Comment by jpflori created at 2013-04-03 13:08:55

In Sage 5.7, the sage command line is fine whereas the ipython one is already (in color) and broken.


---

Comment by jpflori created at 2013-04-03 13:10:05

In fact with the old ipython 0.10 from sage 5.6, the command line is already broken.


---

Comment by leif created at 2013-04-03 13:22:39

Replying to [comment:9 vbraun]:
> The standard Fedora install contains `ncurses` and `ncurses-libs` rpms, which install `libncurses.so.5` but no `libncurses.so`. Only the `ncurses-devel` package, which is not installed by default, brings `libncurses.so`.

Which is pretty correct.  No system should have `foo.so` (nor `foo.a`!) unless `foo.h` (i.e., the related headers) are also present.


---

Comment by vbraun created at 2013-04-03 13:25:39

To go from broken -> fixed: Install ncurses-devel, recompile readline, recompile python.


---

Comment by vbraun created at 2013-04-03 13:34:29

The `sage -gp` readline also is different between the working and broken sage commandline. If I compile the working readline, `sage -gp` has correct multi-line readline (input is continued on subsequent lines. With the broken readline, `sage -gp` falls back to single-line readline (input scrolls horizontally if necessary).


---

Comment by vbraun created at 2013-04-03 13:39:47

Curiously, the log file for readline is identical (apart from the timing stats). But it fails to link to tinfo in the broken version

```
[vbraun`@`volker-desktop sage-5.9.beta2]$ ldd local/lib/libreadline.so
	linux-vdso.so.1 =>  (0x00007fff365fe000)
	libc.so.6 => /lib64/libc.so.6 (0x00007f2866ee3000)
	/lib64/ld-linux-x86-64.so.2 (0x0000003c14800000)
```

vs the fixed version:

```
[vbraun`@`volker-desktop sage-5.9.beta2]$ ldd local/lib/libreadline.so
	linux-vdso.so.1 =>  (0x00007fffef3fe000)
	libtinfo.so.5 => /lib64/libtinfo.so.5 (0x00007ffb0c10a000)
	libc.so.6 => /lib64/libc.so.6 (0x00007ffb0bd51000)
	/lib64/ld-linux-x86-64.so.2 (0x0000003c14800000)
[vbraun`@`volker-desktop sage-5.9.beta2]$ cat /usr/lib64/libncurses.so
INPUT(libncurses.so.5 -ltinfo)
```



---

Attachment

Diff between broken and fixed python install


---

Comment by jpflori created at 2013-04-03 13:44:58

Replying to [comment:19 vbraun]:
> The `sage -gp` readline also is different between the working and broken sage commandline. If I compile the working readline, `sage -gp` has correct multi-line readline (input is continued on subsequent lines. With the broken readline, `sage -gp` falls back to single-line readline (input scrolls horizontally if necessary).
> 
With all versions I have, I get horizontla scrolling indeed (but not borken as with the ipython command prompt).


---

Comment by jdemeyer created at 2013-04-03 13:45:41

Replying to [comment:16 vbraun]:
> Deleting (renaming) `$SAGE_LOCAL/share` fixes this, even without recompiling.
So the issue is IPython configuration then?


---

Comment by jpflori created at 2013-04-03 13:47:07

Replying to [comment:18 vbraun]:
> To go from broken -> fixed: Install ncurses-devel, recompile readline, recompile python.
But I guess this "fixed" readline links to libncurses, doesn't it?
We don't want that...
We want to use the libtermcap we provide.


---

Comment by vbraun created at 2013-04-03 13:50:51

In fact, I don't need to recompile python. Just install ncurses-devel and recompile readline = working. Uninstall ncurses-devel and recompile readline = broken.


---

Comment by vbraun created at 2013-04-03 13:54:54

The real reason is libtinfo. In fact I can just `export LD_PRELOAD=/usr/lib64/libtinfo.so.5` and this fixes it.


---

Comment by vbraun created at 2013-04-03 13:57:23

So what should we do, make a tinfo spkg or require ncurses-devel?


---

Comment by leif created at 2013-04-03 13:59:32

Replying to [comment:23 jpflori]:
> Replying to [comment:18 vbraun]:
> > To go from broken -> fixed: Install ncurses-devel, recompile readline, recompile python.
> But I guess this "fixed" readline links to libncurses, doesn't it?
> We don't want that...
> We want to use the libtermcap we provide.

Not me.  We shouldn't build libtermcap at all on systems that have libncurses / libtinfo [-dev].


---

Comment by jdemeyer created at 2013-04-03 14:03:13

Replying to [comment:27 vbraun]:
> So what should we do, make a tinfo spkg or require ncurses-devel?
Fix IPython?


---

Comment by jpflori created at 2013-04-03 14:09:04

Replying to [comment:28 leif]:
> Replying to [comment:23 jpflori]:
> > Replying to [comment:18 vbraun]:
> > > To go from broken -> fixed: Install ncurses-devel, recompile readline, recompile python.
> > But I guess this "fixed" readline links to libncurses, doesn't it?
> > We don't want that...
> > We want to use the libtermcap we provide.
> 
> Not me.  We shouldn't build libtermcap at all on systems that have libncurses / libtinfo [-dev].
And what about systems not having any -dev packages?


---

Comment by jpflori created at 2013-04-03 14:13:43

Replying to [comment:26 vbraun]:
> The real reason is libtinfo. In fact I can just `export LD_PRELOAD=/usr/lib64/libtinfo.so.5` and this fixes it.
I don't have libtinfo on my systems :)


---

Comment by jpflori created at 2013-04-03 14:17:29

I guess Ubuntu packages it inside libncurses: https://bugs.launchpad.net/ubuntu/+source/ncurses/+bug/259139


---

Comment by vbraun created at 2013-04-03 14:27:23

Fedora packages libtinfo also as part of ncurses.

Jeroen, please read my edits on comment:16


---

Comment by jpflori created at 2013-04-03 14:28:02

If I run LD_PRELOAD=...libncurses.so.5 ./sage -ipython then long command lines are ok.
Notice that the same experiment with ./sage -gp still gives me horizontal scrolling.


---

Comment by jdemeyer created at 2013-04-03 14:29:55

Replying to [comment:33 vbraun]:
> Jeroen, please read my edits on comment:16
OK, I didn't understand your edit, I just removed the whole comment, which is actually more clear.


---

Comment by jpflori created at 2013-04-03 14:36:06

What's strange is that iPython runs "import curses" which fails (whether lincurses is preloaded or not) and so should behave correctly without curses installed.


---

Comment by vbraun created at 2013-04-03 14:38:00

Replying to [comment:34 jpflori]:
> If I run LD_PRELOAD=...libncurses.so.5 ./sage -ipython then long command lines are ok.
> Notice that the same experiment with ./sage -gp still gives me horizontal scrolling.

Hmm, strange. Works for me: with LD_PRELOAD, `sage -gp` has multi-line readline. Without it, only single-line.


---

Comment by vbraun created at 2013-04-03 14:39:59

libtinfo is actually part of ncurses (distributed inside the ncurses tarball)


---

Comment by jpflori created at 2013-04-03 14:57:45

Replying to [comment:38 vbraun]:
> libtinfo is actually part of ncurses (distributed inside the ncurses tarball)
Yup, and on Ubuntu, there is even no separate libtinfo.so file (except for the libncurses-dbg debug package).
The functions it should provided are actually provided by libncurses.so directly.


---

Comment by vbraun created at 2013-04-03 15:03:47

Ubuntu 12.04 has /lib/i386-linux-gnu/libtinfo.so.5 and /lib/x86_64-linux-gnu/libtinfo.so.5.


---

Comment by jpflori created at 2013-04-03 15:09:17

Oh yes it has...
Please disregard all my rambling then.


---

Comment by leif created at 2013-04-03 15:12:31

Replying to [comment:41 jpflori]:
> Oh yes it has...

Otherwise

```
INPUT(libncurses.so.5 -ltinfo)
```

wouldn't make sense... ;-)

> Please disregard all my rambling then.


---

Comment by vbraun created at 2013-04-03 16:07:57

I made some experimental spkgs for 

  * Ncurses: http://www.stp.dias.ie/~vbraun/Sage/spkg/ncurses-5.9.spkg
  * Readline (using curses instead of libtermcap): http://www.stp.dias.ie/~vbraun/Sage/spkg/readline-6.2.p4.spkg


---

Attachment

Updated patch


---

Comment by vbraun created at 2013-04-04 18:14:01

for review only


---

Attachment


---

Comment by vbraun created at 2013-04-04 18:17:04

Changing status from new to needs_review.


---

Comment by jpflori created at 2013-04-05 09:38:46

Just for completeness, I'd like to see if its possible to fix iPython so its not broken when using termcap only.
I'll have some time tonight or tomorrow hopefully.


---

Comment by vbraun created at 2013-04-05 10:05:32

Its really readline that breaks, as demonstrated by the fact that it falls back to single-line editing. Ihmo its pointless to improve support for the dead libtermcap, but then its your time ;-)


---

Comment by jpflori created at 2013-04-05 11:42:52

Replying to [comment:48 vbraun]:
> Its really readline that breaks, as demonstrated by the fact that it falls back to single-line editing. Ihmo its pointless to improve support for the dead libtermcap, but then its your time ;-)
Can we consider it is broken because it uses single-line editing mode?
Isn't that to be expected with termcap?
(I really have no clue...)

Note that this single-line mode is ok in gp and python, it's only in ipython its broken, so there is a problem with ipython (and its been there since at least 0.10, we just encountered it recently in Sage because the way we use ipython must have changed).

Anyway, I agree that multi-line editing looks nicer so just ignoring this ipython/readline/termcap problem and using ipython/readlines/ncurses is a sensible workaround/fix.


---

Comment by jpflori created at 2013-04-05 11:44:30

I see you disabled static libs, any reason for that except for the fact "shared libraries are better" (or "static ones sucks" :)).


---

Comment by vbraun created at 2013-04-05 13:17:30

Only because static libraries suck.


---

Comment by vbraun created at 2013-04-05 13:25:12

About the horizontal-scroll-mode, that just shows that readline couldn't figure out the UP capability. Its pretty clear that this is because we only installed libtermcap, but not an actual termcap data file. So libtermcap used to fall back to `/etc/termcap`, but newer Linux distributions don't include that any more since libtermcap is being phased out in favor of ncurses.


---

Comment by jpflori created at 2013-04-05 13:39:03

Good point.
Ubuntu 12.04 does not ship /etc/termcap indeed.
Although that does not clearly explain the discrepancy between the behavior of ipython vs. python and gp.


---

Comment by jhpalmieri created at 2013-04-05 18:38:17

The ncurses spkg fails to build on OS X 10.8.3. [log file here](http://sage.math.washington.edu/home/palmieri/misc/ncurses-5.9.log).


---

Comment by vbraun created at 2013-04-05 20:15:53

Fixed, new spkg at same place. I checked that it compiles on bsd.math.


---

Comment by jpflori created at 2013-07-04 15:33:04

Just a reminder for myself: HAVE TO FIX THIS.
Either find out how ipython breaks with termcap only or be lazy and use Volker spkgs.

The broken command line edit is just driving me crazy, I cannot understand why the google groups are not flooded by rants about that.
Does every one use the notebook?


---

Comment by vbraun created at 2013-07-04 15:57:05

We should switch to ncurses anyways, I don't see a point in adding workarounds for termcap.

I guess most users already have ncurses headers in their OS install, if you install any development packages then its very likely to be pulled in.


---

Comment by jpflori created at 2013-07-04 16:04:14

Agreed, I'll try to review it tonight.

If by any chance there have been upgrades to curses and readline, could you upload new spkgs?


---

Comment by vbraun created at 2013-07-04 21:02:09

Neither readline nor ncurses has been updated in the last 3 months... neither of them is exactly a moving target ;-)


---

Comment by jpflori created at 2013-07-04 21:10:01

Yup I saw that.

Cleaned up spkg are up.

I'm testing them right now.


---

Comment by jpflori created at 2013-07-04 21:13:45

I've removed obsolete comments, homogenized spkg scripts and so on.
The only thing Im not sure about is the LIB_TERMCAP patch which was added in #11970 is needed anymore.

The only thing you did I changed is to not disable static libs :)
Please let keep that change for later and for a more general clean up of spkgs regarding static libs.


---

Comment by jpflori created at 2013-07-04 22:47:51

Spkgs at:
* http://boxen.math.washington.edu/home/jpflori/ncurses-5.9.p0.spkg
* http://boxen.math.washington.edu/home/jpflori/readline-6.4.p5.spkg
termcap patch was needed to finish building Sage.
Looks to be working.
ldd'ing $SAGE_LOCAL/lib shows only ncurses in the same dir.


---

Comment by vbraun created at 2013-07-04 23:58:39

spkg urls don't work


---

Comment by jpflori created at 2013-07-05 07:08:10

Fixed:
* http://boxen.math.washington.edu/home/jpflori/spkg/ncurses-5.9.p0.spkg
* http://boxen.math.washington.edu/home/jpflori/spkg/readline-6.2.p5.spkg


---

Comment by jpflori created at 2013-07-05 14:05:35

Strange, yesterday the doc failed to build because of not finding some UP stuff in readline, and I thought it was solved by readding the termcap patch.
But now on another machine it fails though I used the patch.


---

Comment by jpflori created at 2013-07-05 14:38:55

Maybe that was because of old termcap libs being around on this setup were I.
Removing them and rebuilding everything was fine...


---

Comment by vbraun created at 2013-07-05 15:28:54

And this is why we shouldn't have static libraries (sorry couldn't resist ;-)


---

Comment by vbraun created at 2013-07-05 17:50:27

Whats the point of 

```
    [ -r "$patch" ] || continue  # Skip non-existing or non-readable patches
}}} 
IMHO we should error out if the spkg permissions are not set correctly instead of silently not applying the patch.


---

Comment by vbraun created at 2013-07-05 18:46:30

The rest looks good to me (modulo building static libraries, though I don't mind disabling them globally after we switch to git and the new repo layout)


---

Comment by leif created at 2013-07-05 20:15:08

Replying to [comment:69 vbraun]:
> Whats the point of 
> {{{
>     [ -r "$patch" ] || continue  # Skip non-existing or non-readable patches
> }}} 
> IMHO we should error out if the spkg permissions are not set correctly instead of silently not applying the patch.

That's Jeroen's invention, the idea being to be able to (temporarily) "disable" a patch by `chmod -r ...` without having to change `spkg-install` (which usually unconditionally applies all [readable] patches in a loop).

And if there are no patches at all, `patch` doesn't bail out because the shell doesn't expand `.../*.patch` (where `[ -f ... ]` would be sufficient).


---

Comment by leif created at 2013-07-05 20:17:55

Replying to [comment:62 jpflori]:
> The only thing Im not sure about is the LIB_TERMCAP patch which was added in #11970 is needed anymore.

Did you finally remove it?  (Too lazy to look at the spkg now.)

If so, please make sure R still builds on `$DISTRO`...


---

Comment by jpflori created at 2013-07-05 20:39:51

I did at first, but in a build from scratch the doc failed to build complaining about UP missing and after rebuilding readline with it, it was ok so I've left it in.

Another installation of just the two spkg after that on a system where Sage was already installed, with the patch in, also failed with the same error.
But it seems it was because a previous libtermcap.a was already in $SAGE_LOCAL/lib when the spkgs were built.
At least removing libtermcap.a and rebuilding once more let the doc build.
Note I've not looked deeply into this and this is mostly experimental.
But I seem to remember that in this latter case, the first libreadline.so produced was not linked with libtinfo (that ncurses should now provide, but I did not look to see if it was there during that try) and that the second one was.
Not completely sure about that though.


---

Comment by vbraun created at 2013-07-06 14:29:28

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2013-07-06 14:29:28

R builds for me, even has working readline in the standalone R binary.


---

Comment by jdemeyer created at 2013-08-02 15:09:50

The spkg needs some trivial work:

In `SPKG.txt`, the license should be GPL v3+ and the following paragraph needs to be updated:

```
## Dependencies

 * GNU patch

 * libtermcap (or libncurses or libtinfo), but not Sage's one,
   since we only build a static version. I.e., the system has
   to provide one of these.
```


Also, the file `src/support/mkinstalldirs` is not user-writable, which is strange.


---

Comment by jdemeyer created at 2013-08-02 15:09:50

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2013-08-02 16:06:39

I've updated the readline spkg documentation.

The permissions of `mkinstalldirs` are what upstream uses; since its not copied anywhere it doesn't really matter if it is user-writeable or not.


---

Comment by vbraun created at 2013-08-02 16:06:39

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2013-08-04 16:24:02

Some files in `$SAGE_LOCAL/bin` need to be added to `.hgignore`:

```
? captoinfo
? clear
? infocmp
? infotocap
? ncurses5-config
? reset
? tabs
? tic
? toe
? tput
? tset
```



---

Comment by jdemeyer created at 2013-08-04 16:24:02

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-08-05 10:04:44

Changing status from needs_work to needs_review.


---

Attachment


---

Comment by vbraun created at 2013-08-05 10:11:08

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2013-08-05 10:11:08

Thanks!


---

Comment by jdemeyer created at 2013-08-14 09:59:11

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-08-14 09:59:11

Buildbot failure on snapperkob (Ubuntu 12.04 x86_64) while building Python:

```
building 'readline' extension
gcc -pthread -fPIC -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -I/home/buildbot/build/sage/snapperkob/snapperkob_full/build/sage-5.12.beta1/local/include -I. -IInclude -I./Include -I/usr/include/x86_64-linux-gnu -I/usr/local/include -I/home/buildbot/build/sage/snapperkob/snapperkob_full/build/sage-5.12.beta1/spkg/build/python-2.7.5.p1/src/Include -I/home/buildbot/build/sage/snapperkob/snapperkob_full/build/sage-5.12.beta1/spkg/build/python-2.7.5.p1/src -c /home/buildbot/build/sage/snapperkob/snapperkob_full/build/sage-5.12.beta1/spkg/build/python-2.7.5.p1/src/Modules/readline.c -o build/temp.linux-x86_64-2.7/home/buildbot/build/sage/snapperkob/snapperkob_full/build/sage-5.12.beta1/spkg/build/python-2.7.5.p1/src/Modules/readline.o
gcc -pthread -shared -L/home/buildbot/build/sage/snapperkob/snapperkob_full/build/sage-5.12.beta1/local/lib -L/home/buildbot/build/sage/snapperkob/snapperkob_full/build/sage-5.12.beta1/local/lib build/temp.linux-x86_64-2.7/home/buildbot/build/sage/snapperkob/snapperkob_full/build/sage-5.12.beta1/spkg/build/python-2.7.5.p1/src/Modules/readline.o -L/usr/lib/termcap -L/home/buildbot/build/sage/snapperkob/snapperkob_full/build/sage-5.12.beta1/local/lib -L/usr/lib/x86_64-linux-gnu -L/usr/local/lib -L. -lreadline -lncurses -lpython2.7 -o build/lib.linux-x86_64-2.7/readline.so
*** WARNING: renaming "readline" since importing it failed: /home/buildbot/build/sage/snapperkob/snapperkob_full/build/sage-5.12.beta1/local/lib/libreadline.so.6: undefined symbol: UP
```


This causes in the end

```
Testing importing of various modules...
ctypes module imported OK
math module imported OK
hashlib module imported OK
crypt module imported OK
Traceback (most recent call last):
  File "<string>", line 1, in <module>
ImportError: No module named readline
readline module failed to import
socket module imported OK
Error: One or more modules failed to import.
```

* [Python build log](http://build.sagemath.org/sage/builders/AIMS%20snapperkob%20%28Ubuntu%2012.04%20x86_64%29/builds/402/steps/shell_6/logs/python)
* [readline build log](http://build.sagemath.org/sage/builders/AIMS%20snapperkob%20%28Ubuntu%2012.04%20x86_64%29/builds/402/steps/shell_6/logs/python)
* [Other logs of that build](http://build.sagemath.org/sage/builders/AIMS%20snapperkob%20%28Ubuntu%2012.04%20x86_64%29/builds/402)


---

Comment by jdemeyer created at 2013-08-14 10:10:51

Exact same failure on `arando` (Ubuntu 13.04 32-bit).


---

Comment by jdemeyer created at 2013-08-14 10:26:26

No, the issue that, despite the `-lncurses` in the gcc invocation, Python's `readline.so` does not actually link against `libncurses.so:

```
(sage-sh) buildbot`@`arando:src$ ldd build/lib.linux-i686-2.7/readline.so
        linux-gate.so.1 =>  (0xb778b000)
        libreadline.so.6 => /var/lib/buildbot/build/sage/arando-1/arando_full/build/sage-5.12.beta1/local/lib/libreadline.so.6 (0xb7746000)
        libpython2.7.so.1.0 => /var/lib/buildbot/build/sage/arando-1/arando_full/build/sage-5.12.beta1/local/lib/libpython2.7.so.1.0 (0xb758e000)
        libpthread.so.0 => /lib/i386-linux-gnu/libpthread.so.0 (0xb7564000)
        libc.so.6 => /lib/i386-linux-gnu/libc.so.6 (0xb73b1000)
        libdl.so.2 => /lib/i386-linux-gnu/libdl.so.2 (0xb73ac000)
        libutil.so.1 => /lib/i386-linux-gnu/libutil.so.1 (0xb73a8000)
        libm.so.6 => /lib/i386-linux-gnu/libm.so.6 (0xb7365000)
        /lib/ld-linux.so.2 (0xb778c000)
```

Some dynamic linking expert is needed here.

Running Python with `LD_PRELOAD="$SAGE_LOCAL/lib/libncurses.so"` solves the problem.


---

Comment by jdemeyer created at 2013-08-14 10:34:11

The issue is [https://lists.ubuntu.com/archives/ubuntu-devel/2010-November/031991.html](https://lists.ubuntu.com/archives/ubuntu-devel/2010-November/031991.html)

Adding `-Wl,--no-as-needed` to the linker invocation solves the problem.

```
gcc -pthread -shared -L/var/lib/buildbot/build/sage/arando-1/arando_full/build/sage-5.12.beta1/local/lib -L/var/lib/buildbot/build/sage/arando-1/arando_full/build/sage-5.12.beta1/local/lib build/temp.linux-i686-2.7/var/lib/buildbot/build/sage/arando-1/arando_full/build/sage-5.12.beta1/spkg/build/python-2.7.5.p1/src/Modules/readline.o -L/usr/lib/termcap -L/var/lib/buildbot/build/sage/arando-1/arando_full/build/sage-5.12.beta1/local/lib -L/usr/lib/i386-linux-gnu -L/usr/local/lib -L. -lreadline -Wl,--no-as-needed -lncurses -lpython2.7 -o build/lib.linux-i686-2.7/readline.so
```



---

Comment by vbraun created at 2013-08-14 11:20:40

libcurses is just a symlink to libncurses. I don't have an account on any of those machines. Can you post the ldd output for libncurses.so and libreadline.so? I would guess that the latter is underlinked, and since python readline.so doesn't use UP directly we end up not pulling in ncurses.


---

Comment by jdemeyer created at 2013-08-14 11:23:28


```
(sage-sh) buildbot`@`arando:sage$ ldd $SAGE_LOCAL/lib/libncurses.so
        linux-gate.so.1 =>  (0xb7759000)
        libc.so.6 => /lib/i386-linux-gnu/libc.so.6 (0xb7573000)
        libtinfo.so.5 => /var/lib/buildbot/build/sage/arando-1/arando_full/build/sage-5.12.beta1/local/lib/libtinfo.so.5 (0xb7549000)
        /lib/ld-linux.so.2 (0xb775a000)
(sage-sh) buildbot`@`arando:sage$ ldd $SAGE_LOCAL/lib/libreadline.so
        linux-gate.so.1 =>  (0xb773a000)
        libc.so.6 => /lib/i386-linux-gnu/libc.so.6 (0xb753a000)
        /lib/ld-linux.so.2 (0xb773b000)
```



---

Comment by jdemeyer created at 2013-08-14 11:26:10

Contrast with `boxen.math` (Ubuntu 8.04):

```
(sage-sh) jdemeyer`@`boxen:sage-5.12.beta1$ ldd $SAGE_LOCAL/lib/libncurses.so
        linux-vdso.so.1 =>  (0x00007fff2fffe000)
        libc.so.6 => /lib/libc.so.6 (0x00007ffc27946000)
        libtinfo.so.5 => /mazur/release/merger/sage-5.12.beta1/local/lib/libtinfo.so.5 (0x00007ffc27712000)
        /lib64/ld-linux-x86-64.so.2 (0x00007ffc27ee2000)
(sage-sh) jdemeyer`@`boxen:sage-5.12.beta1$ ldd $SAGE_LOCAL/lib/libreadline.so
        linux-vdso.so.1 =>  (0x00007fff099fe000)
        libncurses.so.5 => /mazur/release/merger/sage-5.12.beta1/local/lib/libncurses.so.5 (0x00007f8b01386000)
        libc.so.6 => /lib/libc.so.6 (0x00007f8b0100f000)
        libtinfo.so.5 => /mazur/release/merger/sage-5.12.beta1/local/lib/libtinfo.so.5 (0x00007f8b00ddc000)
        /lib64/ld-linux-x86-64.so.2 (0x00007f8b017f0000)
```



---

Comment by vbraun created at 2013-08-14 12:49:53

Yes, it is exactly as I suspected: libreadline does not link against libncurses. In fact, the terminal handling stuff is in libtinfo (part of ncurses), this is why the `-lcurses` is a no-op when linking libreadline.

I've updated the readline spkg to link with `-ltinfo`, this is the proper thing to do. While I was at it I removed various old cruft.


---

Comment by vbraun created at 2013-08-14 12:49:53

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2013-08-14 12:56:08

for review only


---

Attachment

Looks good on first sight, still have to test it though...


---

Comment by jdemeyer created at 2013-08-14 16:06:05

`ncurses` always fails its testsuite (`spkg-check`) because of

```
Running the test suite for ncurses-5.9...
make[3]: *** No rule to make target `check'.
```



---

Comment by jdemeyer created at 2013-08-14 16:06:05

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2013-08-14 16:08:36

`ncurses` fails to build on `mark` (Solaris SPARC) because of

```
/home/buildbot/build/sage/mark-1/mark_full/build/sage-5.12.beta1/local/bin/g++ -I../c++ -I../include -I. -DHAVE_CONFIG_H   -D__EXTENSIONS__ -D_XOPEN_SOURCE=500 -D_FILE_OFFSET_BITS=64  -DNDEBUG -I. -I../include -I/home/buildbot/build/sage/mark-1/mark_full/build/sage-5.12.beta1/local/include  -fPIC -c ../c++/cursesm.cc -o ../obj_s/cursesm.o
<command-line>:0:0: warning: "_XOPEN_SOURCE" redefined [enabled by default]
../c++/cursesm.cc:1:0: note: this is the location of the previous definition
<command-line>:0:0: warning: "_XOPEN_SOURCE" redefined [enabled by default]
../c++/cursesf.cc:1:0: note: this is the location of the previous definition
In file included from /home/buildbot/build/sage/mark-1/mark_full/build/sage-5.12.beta1/local/lib/gcc/sparc-sun-solaris2.10/4.7.3/include-fixed/iso/stdlib_iso.h:39:0,
                 from /usr/include/stdlib.h:18,
                 from ../c++/internal.h:53,
                 from ../c++/cursesm.cc:34:
/home/buildbot/build/sage/mark-1/mark_full/build/sage-5.12.beta1/local/lib/gcc/sparc-sun-solaris2.10/4.7.3/include-fixed/sys/feature_tests.h:341:2: error: #error "Compiler or options invalid for pre-UNIX 03 X/Open applications 	and pre-2001 POSIX applications"
```



---

Comment by vbraun created at 2013-08-14 17:49:35

I've deleted spkg-check and added the patch from http://stackoverflow.com/questions/6774738/compiling-ncurses-on-solaris-compiler-or-options-invalid-for-pre-unix-03-x-op

Updated ncurses spkg at the same place.


---

Comment by vbraun created at 2013-08-14 17:49:35

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2013-08-15 08:49:28

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-08-15 08:49:28

Haven't tested all systems yet, but looks good so far.


---

Comment by jdemeyer created at 2013-08-20 08:01:37

Resolution: fixed


---

Comment by jpflori created at 2013-10-22 17:06:34

Just a random rant on this closed ticket: not building the readline static library makes python fails to build on Cygwin.
Ok this is without doubt because of python build system as it does not manage to find the specially named shared libraries on cygwin (note that when shared and static are installed, gcc will be smart enough to pick the shared one first, so this really is a python issue which fails to detect the shared one...).


---

Comment by jpflori created at 2013-10-22 17:08:37

Note for myself: http://bugs.python.org/issue4032
