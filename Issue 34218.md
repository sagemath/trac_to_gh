# Issue 34218: Fix monomial_coefficients for submodules of free modules from sage.modules

Issue created by migration from https://trac.sagemath.org/ticket/34455

Original creator: mkoeppe

Original creation time: 2022-08-30 06:09:40

CC:  tscrim mmasdeu

Bug: 

```
sage: V = ZZ^3
sage: U = V.submodule([[1, 2, 3], [1, 1, 1]])
sage: U
sage: u = U([2, 3, 4])
sage: u.monomial_coefficients()
{0: 2, 1: 3, 2: 4}
```

This is incorrect - by definition of `monomial_coefficients`, basis indices are mapped to coefficients; but

```
sage: u.parent().basis()
[
(1, 0, -1),
(0, 1, 2)
]
```


We also add a method `_test_monomial_coefficients` to run some tests on this and related methods of `ModulesWithBasis`.

Part of #30309


---

Comment by tscrim created at 2022-08-30 07:10:18

Now we can do it with

```
U.coordinate_vector(u)
```

(made into a `dict`). We just get a bit of a performance penalty for this. However, this will have a different output than `u.dict()`, which probably benefits us as we can raise a deprecation warning for the places that are relying on the old functionality.

I don't think anything explicitly is relying on this, but I am just a bit worried about some idempotent construction might implicitly be doing it (such as `U(u.monomial_coefficients())`). I am pretty sure it is fine though.


---

Comment by mkoeppe created at 2022-08-30 07:17:44

My guess is that nothing that works relies on `monomial_coefficients`... 

With a bit of luck we can also solve #18520...


---

Comment by git created at 2022-09-01 04:00:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-09-01 04:01:11

Changing status from new to needs_review.


---

Comment by tscrim created at 2022-09-07 15:06:21

This has some doctest failures reported by the patchbot. Some are trivial, some look a bit more serious.

The `classical_lie_algebras.py` is probably my responsibility to fix or at least understand (not right now, now it is sleeping time). I might have done something a little improper there. Although I am not quite sure what would lead to that error from the patchbot report.

If you could figure out the `quivers/algebra.py` one, that would be good.


---

Comment by tscrim created at 2022-09-08 01:12:35

The issue with the Lie algebras is that I had to have a mechanism to deal with the cases when the Lie algebra was defined as a subalgebra of an infinite dimensional Lie algebra. I never liked it as it was a fairly big hack, but it worked for what I wanted at the time. This is something I have wanted to fix but haven't had the time/motivation to do so. In particular, it should work when the parent is in `FiniteDimensionalLieAlgebrasWithBasis()` and use that as a test, with making sure Lie subalgebras of a finite dimensional (associative) algebra knows they are finite dimensional with bringing up the general construction for construction a basis from the `ClassicalMatrixLieAlgebra`.

If we wanted to take on a little more technical debt, we can simply override the `monomial_coefficients` in `ClassicalMatrixLieAlgebra.Element`.

However, the correct thing to do is make the `LieAlgebraFromAssociative` always be the ambient associative algebra considered as a Lie algebra and when we pass the generators, that returns a Lie subalgebra. Putting it all into one class was not a good idea.


---

Comment by mkoeppe created at 2022-09-08 03:33:03

I don't have time to look into it this week, but it sounds like #34487 may be related


---

Comment by mkoeppe created at 2022-09-08 19:49:14

Found #25033 "Improve `monomial_coefficients` for Lie algebras when they are known to be finite dimensional"


---

Comment by tscrim created at 2022-09-09 01:41:12

Haha I forgot about that. Itâ€™s almost like I knew this was a problem. *facepalm*


---

Comment by git created at 2022-09-09 17:31:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-09 17:32:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-09-09 17:57:05

I don't understand the failure related to `BruhatTitsHarmonicCocycleElement`. It looks to me like a genuine bug::

```
sage: X = BruhatTitsQuotient(31,7)
sage: H = X.harmonic_cocycles(2,prec=10)
sage: v = H.basis()[0]
sage: bool(v)
True
sage: v.monomial_coefficients()
{}
```



---

Comment by tscrim created at 2022-09-11 04:53:39

The output of that monomial coefficients is explicitly set to be `{}`. The doc says it is the comply with pickling for some reason. This makes no sense to me. I agree this is a bug.

It seems to be easy to fix: We change

```python
def monomial_coefficients(self, copy=True):
    return self.__element.monomial_coefficients(copy=copy)
```

(or `self.element()`).
