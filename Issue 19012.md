# Issue 19012: Interface with TdLib

Issue created by migration from https://trac.sagemath.org/ticket/19249

Original creator: llarisch

Original creation time: 2015-09-19 23:03:12

CC:  dcoudert




---

Comment by llarisch created at 2015-09-19 23:27:52

Changing type from PLEASE CHANGE to enhancement.


---

Comment by llarisch created at 2015-09-19 23:27:52

Changing component from PLEASE CHANGE to packages: experimental.


---

Comment by llarisch created at 2015-09-19 23:27:52

Changing priority from major to minor.


---

Comment by llarisch created at 2015-09-19 23:35:51

New commits:


---

Comment by ncohen created at 2015-09-20 12:50:18

Hello,

This looks very nice indeed, but because I expect the review to be rather long in this case, it would probably be best to start by exposing a reduced amount of features from your library. A general function to compute the treewidth exactly, for instance, would be ideal as we would be able to compare its output with what we already have (which is *slow*).

For a start, I guess that some things should be done directly in your library: is it necessary to have Sage apply a patch to it? Is there a reason why what your patch does cannot already be included in your code?

Your makefile appears to be manual, and it would probably be best to have it created by autotools. I had to learn this not so long ago and I found it rather painful to learn, but the purpose is to make sure that your code will compile everywhere, so that you do not need to test every platform manually. I can probably help with that, as well as send you a pdf book that helped me a lot while learning it.

Finally, I am not sure if you are aware that you can have C instructions in a 'def' function of a cython file. I see that you have several `cdef cython_<something>` functions with a `def <something>` couterpart, and there is no technical reason to do that. If you have another reason for doing this, then consider this remark as an mistake from my part.

Is your code available on some web page? Is there a public repository for it? Are you the only author? Are there theoretical publications related to it? This kind of information would be interesting to us, and is expected to be found in a SPKG.txt file.

http://doc.sagemath.org/html/en/developer/packaging.html#the-spkg-txt-file

Regards,

Nathann


---

Comment by git created at 2015-09-24 14:21:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by llarisch created at 2015-10-03 16:56:01

While testing my version of an exact algorithm for treewidth against the sage version, i noticed that the sage version doesnt work: it is NOT sufficient to just consider the neighbourhood of computed cut. Counterexample:

G = Graph()
G.add_vertex(0)
G.add_vertex(1)
G.add_vertex(2)
G.add_vertex(3)
G.add_vertex(4)
G.add_vertex(5)
G.add_vertex(6)
G.add_vertex(7)
G.add_vertex(8)
G.add_edge(0,2)
G.add_edge(0,3)
G.add_edge(0,5)
G.add_edge(0,6)
G.add_edge(1,4)
G.add_edge(1,8)
G.add_edge(2,8)
G.add_edge(3,4)
G.add_edge(4,5)
G.add_edge(4,7)
G.add_edge(6,8)
G.add_edge(7,8)
G.treewidth()

But G has treewidth 2. (you possibly have to change the vertex labeling to see the error).


---

Comment by ncohen created at 2015-10-03 16:59:15

Right, this graph clearly has width 2 `O_o`


---

Comment by llarisch created at 2015-10-03 17:21:04

Replying to [comment:7 ncohen]:
> Right, this graph clearly has width 2 `O_o`

And the error can be arbitrary bad. One can construct a graph, such that a cut is not connected in a graph and has to be included in a bag of a tree decomposition. Here it is {0,4,8}.


---

Comment by git created at 2015-10-04 02:47:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by llarisch created at 2015-10-04 02:58:37

>For a start, I guess that some things should be done directly in your library: is it necessary to >have Sage apply a patch to it? Is there a reason why what your patch does cannot already be >included in your code?

I have to instantiante template functions and convert a "sage graph" to a boost graph.

>Your makefile appears to be manual, and it would probably be best to have it created by autotools. >I had to learn this not so long ago and I found it rather painful to learn, but the purpose is to >make sure that your code will compile everywhere, so that you do not need to test every platform >manually. I can probably help with that, as well as send you a pdf book that helped me a lot while >learning it.

Is there a minimal example for that? 

The "tdlib"-part of the documentation has failed to build (UNABLE TO IMPORT MODULE): Is there some import-statement missing? What can be the reasons (its not the content of the *.pyx-file)?


---

Comment by ncohen created at 2015-10-04 05:46:48

> I have to instantiante template functions and convert a "sage graph" to a boost graph.

I still believe that you can do it without patching your code. Let your code deal with boost graphs only, and let Sage only call it on Boost instances (see sage/graphs/base/boost_graph.pyx). This issue should not be a reason to patch your library.

> >Your makefile appears to be manual, and it would probably be best to have it created by autotools. >I had to learn this not so long ago and I found it rather painful to learn, but the purpose is to >make sure that your code will compile everywhere, so that you do not need to test every platform >manually. I can probably help with that, as well as send you a pdf book that helped me a lot while >learning it.
> 
> Is there a minimal example for that? 

All over internet. One that was done recently for Sage is there:
https://github.com/graph-algorithms/edge-addition-planarity-suite

> The "tdlib"-part of the documentation has failed to build (UNABLE TO IMPORT MODULE): Is there some import-statement missing? What can be the reasons (its not the content of the *.pyx-file)?

Probably something like that:
http://doc.sagemath.org/html/en/developer/sage_manuals.html#adding-a-new-file

Nathann


---

Comment by ncohen created at 2015-10-04 05:47:44

Or, otherwise, because you should import your module like others, as it is done in all.py?


---

Comment by llarisch created at 2015-10-04 20:06:14

Is there a way to generate a boost graph with an appended struct? I've seen that

ctypedef BoostGraph[vecS, vecS, undirectedS,    vecS, EdgeWeight] BoostVecWeightedGraph

exists, but I would need:

ctypedef BoostGraph[vecS, vecS, undirectedS,    vecS, X] BG,

such that X is a vertex property. Is there a (not too complicated) way to realize this?


---

Comment by ncohen created at 2015-10-04 20:14:23

I do not know of one.


---

Comment by llarisch created at 2015-10-04 20:54:16

Replying to [comment:14 ncohen]:
> I do not know of one.

In this case, the patches are inevitable (treedecompositions are boost graphs with a set as a vertex property). I could merely displace some graph conversion stuff into the library.. 

---

Does automake cp & rm files automatically? If this is the case: which flags have to be passed to autoconfig on the sage side in spkg-install? So far:



```
AC_INIT(tdlib, larisch@informatik.uni-frankfurt.de)
AM_INIT_AUTOMAKE([subdir-objects] [foreign])

# The version of the libtool library is of the form current:revision:age
#
# See http://www.gnu.org/software/libtool/manual/html_node/Updating-version-info.html
#
# When doing a release, they should be updated like this:
# 1. If no interfaces changed, only implementations: just increment
# revision.
# 2. If interfaces were added, none removed: increment current, set
# revision to zero and increment age.
# 3. If interfaces were removed (breaks backward compatibility): increment
# current, and set both revision and age to zero.
LT_CURRENT=0
LT_REVISION=0
LT_AGE=0
AC_SUBST(LT_CURRENT)
AC_SUBST(LT_REVISION)
AC_SUBST(LT_AGE)

AC_PROG_CXX
AC_PROG_LIBTOOL
AC_PROG_INSTALL

CXXFLAGS="-O3"

AC_OUTPUT(Makefile)
```




```
lib_LTLIBRARIES = libtd.la

libtd_la_SOURCES = sage_tdlib.cpp
libtd_la_LDFLAGS = $(AM_LDFLAGS) -version-info @LT_CURRENT@:@LT_REVISION@:@LT_AGE@
```



---

Comment by ncohen created at 2015-10-04 21:01:42

> In this case, the patches are inevitable (treedecompositions are boost graphs with a set as a vertex property). I could merely displace some graph conversion stuff into the library.. 

Yes. Your library has no reason to be able to handle Sage graph, so just write Sage code to call it with the kind of graph that it expects.

> Does automake cp & rm files automatically? If this is the case: which flags have to be passed to autoconfig on the sage side in spkg-install? So far:

I do not understand this question.

Nathann


---

Comment by ncohen created at 2015-10-05 20:09:04

Hello,,

> While testing my version of an exact algorithm for treewidth against the sage version, i noticed that the sage version doesnt work: it is NOT sufficient to just consider the neighbourhood of computed cut. Counterexample:

Thank you very much for this bug report. It has been fixed in #19358 (needs_review).

Nathann


---

Comment by git created at 2015-10-29 16:16:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by llarisch created at 2015-10-29 16:35:08

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2015-10-29 20:30:45

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-10-29 20:30:45

Some technical points: the source tarball is _not_ meant to be committed, you should just provide a link on this ticket (or attach it to this ticket).

Second, can you write to upstream about the autotools-based build system? Ideally, it should be added to upstream instead of Sage.

Third, autotools is not part of Sage: you must not run `autogen.sh` in `spkg-install`. If upstream does not want autotools, then you should put the autotools-based build system in the source tarball directly (both the autotools source files and the generated files).


---

Comment by jdemeyer created at 2015-10-29 20:34:00

Two more details:

1. Unfortunately you cannot add the `tdlib` module to the documentation, since we currently do not support "optional" documentation.

2. Please undo the added whitespace to `module_list.py`.


---

Comment by jdemeyer created at 2015-10-29 20:38:38

Also, is there any reason that you have the file `sage_tdlib.hpp` twice? Surely, one time is enough. I even think that zero times is enough if you move the `.cpp` file to the Sage library and use [http://docs.cython.org/src/userguide/external_C_code.html#implementing-functions-in-c](http://docs.cython.org/src/userguide/external_C_code.html#implementing-functions-in-c)


---

Comment by ncohen created at 2015-10-30 09:30:18

Could you remove the compiled libraries from the hidden directory .lib of your archive?


---

Comment by git created at 2015-10-30 15:41:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-10-30 15:45:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-10-30 15:53:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by llarisch created at 2015-10-30 15:59:59

Just to be sure: The upstream tarballs are just copies of "original tarballs" and will be downloaded from sage mirrors?


---

Comment by ncohen created at 2015-10-30 16:01:18

> Just to be sure: The upstream tarballs are just copies of "original tarballs" and will be downloaded from sage mirrors? 

Indeed. And when the original (aka 'upstream') tarball is updated (and if we want this update to be reflected in Sage) then we must open a ticket to update it. That's the workflow nowadays.

Nathann


---

Comment by git created at 2015-10-30 16:28:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2015-10-30 16:29:48

(please don't forget to set the ticket's status to 'needs_review'  when you will be done with your modifications)

Nathann


---

Comment by git created at 2015-10-30 16:39:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by llarisch created at 2015-10-30 16:40:32

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2015-10-31 10:47:08

Changing status from needs_review to needs_info.


---

Comment by ncohen created at 2015-10-31 10:47:08

Helloooooooooo Lukas,

Here is another review:

- From the url at which you placed your tarball I found your website, and this
  page [1] really looks like "TdLib's official page". Could you add this url at
  the end of the 'description' section of the SPKG.txt file?

- It would be cool if your tarball contained a 'license' (or 'copying') file
  asserting that it is licensed under the GPL2.

- I do not understand why you need to copy/paste sage_tdlib.cpp into your
  tarball if you want it to compile. Could you please explain me? In no other
  package do we need to do such a thing. Usually the tarball works by itself,
  and we have in Sage some interface code that is linked with it.

- One such instance is the interface with boost. You will find it in the
  following files:

      sage/graphs/base/boost_graph.pyx
      sage/graphs/base/boost_graph.pxd
      sage/graphs/base/boost_interface.cpp

- Your 'spkg-install' file copies files that you removed from your tarball
  (i.e. ./.libs/*)

- I do not understand what exactly this warning means. Could you tell me? `^^;`
  {{{
  +#!!!!!!   NOTICE   !!!!!!!!
  +#Sage vertices have to be named by unsigned integers
  +#Sage bags of decompositions have to be lists of unsigned integers
  +#!!!!!!!!!!!!!!!!!!!!!!!!!!
  }}}

- Could you strip 'cython_' from the beginning of the functions you define?

- The code of `get_width` can be replaced by:
  {{{
  return max(len(x) for x in T)-1
  }}}

- It is slightly incorrect to have your class `TreeDecomposition` inherit from
  `Graph`, while having a function like `get_width` rely on the vertices' labels
  (you assume that they are sets). Indeed, the vertices of a graph can be
  relabeled, which would break this function. I don't think that you need this
  class, to be honest.

- We have something like `for(auto i: something)` in python. You can rewrite
  {{{
  +    V_python = G.vertices()
  +    for i in range(0, len(V_python)):
  +        V.push_back(V_python[i])
  }}}
  As
  {{{
  +    for v in G:
  +        V.push_back(v)
  }}}

  (it occurs several times in your code)

- Similarly (don't scream -- I know it can hurt when you see it for the first
  time) you can write this in Python:
  {{{
  a,b = 1,2
  }}}
  Which means that this also works
  {{{
  for u,v,l in G.edges():
      E.push_back(u)
      E.push_back(v)
  }}}
  Note that if you don't need the labels, then this also works:
  {{{
  for u,v in G.edges(labels=False):
      E.push_back(u)
      E.push_back(v)
  }}}

- Some of your 'TEST' and 'EXAMPLE' tags are not indented as they should (4
  spaces).

Nathann

[1] http://www.tdi.informatik.uni-frankfurt.de/~lukas/


---

Comment by git created at 2015-11-01 19:38:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by llarisch created at 2015-11-01 20:21:22

Thanks for the hints!


> - I do not understand why you need to copy/paste sage_tdlib.cpp into your
>   tarball if you want it to compile. Could you please explain me? In no other
>   package do we need to do such a thing. Usually the tarball works by itself,
>   and we have in Sage some interface code that is linked with it.
> 
> - One such instance is the interface with boost. You will find it in the
>   following files:
> 
>       sage/graphs/base/boost_graph.pyx
>       sage/graphs/base/boost_graph.pxd
>       sage/graphs/base/boost_interface.cpp
> 

Since there is no cython-way to generate a boost graph with an appended struct for the vertices (boost_graph.pyx only supports appended structs for edges), a boost graph has to be generated manually (make_tdlib_graph in *.pyx, sage_tdlib_*). 

If there would exist a cython-interface for the required graphs, one could build the *.so by instantiating the exact algorithm, which would require to copy a *.cpp file (that only containes a line that instantiates the exact algorithm) and a makefile into the tarball.

Do you have a idea for this?


> - Your 'spkg-install' file copies files that you removed from your tarball
>   (i.e. ./.libs/*)

./libs is generated by make (automake creates a .libs by default) -> ./libs should exist

> - I do not understand what exactly this warning means. Could you tell me? `^^;`
>   {{{
>   +#!!!!!!   NOTICE   !!!!!!!!
>   +#Sage vertices have to be named by unsigned integers
>   +#Sage bags of decompositions have to be lists of unsigned integers
>   +#!!!!!!!!!!!!!!!!!!!!!!!!!!
>   }}}

G.vertices() should return a list of unsigned integers, e.g. treedecomposition_exact() does not work with TutteGraph(), since TutteGraph().vertices() returnes a list of tuples

> - It is slightly incorrect to have your class `TreeDecomposition` inherit from
>   `Graph`, while having a function like `get_width` rely on the vertices' labels
>   (you assume that they are sets). Indeed, the vertices of a graph can be
>   relabeled, which would break this function. I don't think that you need this
>   class, to be honest.

Ok, i just thought something like that would be nice:

sage: T = tdlib.treedecomposition_exact(G)
tree decomposition of width 4 computed
sage: T
Treedecomposition of width 4 on 15 vertices <--

Would it be better to use g.name("tree decompostion") for this purposes?

Lukas


---

Comment by ncohen created at 2015-11-01 20:48:15

Hellooooooooooooooo,

> If there would exist a cython-interface for the required graphs, one could build the *.so by instantiating the exact algorithm, which would require to copy a *.cpp file (that only containes a line that instantiates the exact algorithm) and a makefile into the tarball.
> 
> Do you have a idea for this?

I'm still not understand exactly what you explain. I may be missing something obvious, but we will probably understand each other eventually:

I understand from what you tell me that the graph data structure that is used in your library is not exactly a boost graph, but 'a boost graph plus something'.

If this 'something' is about a list of labels for vertices, then it probably means that boost_interface should be updated to handle it. If it is something more specific to tree-decompositions, then it should belong to the files you create.

Here is how I see the situation (tell me if -- for some reason -- it does not apply):

1) You have a library that take a data X as input, and returns a data Y as output. To us that is "upstream's design decision", and we usually have no control over X nor over Y.

2) We have some Cython code that takes a graph, and converts it into format X. We call the library's functions on the data it expects, and get some data Y as a result, which we convert back into Cython/Python before handing it back to the user

3) If, because of some limitation of Cython, we cannot directly convert Python into X (or turn Y into Python) then we can have another layer in the middle, i.e. a c++ file, which is what happens with boost_interface.

This way we adapt to whatever the library expect, and there is no need to have anything sage-related in the library.

> > - Your 'spkg-install' file copies files that you removed from your tarball
> >   (i.e. ./.libs/*)
> 
> ./libs is generated by make (automake creates a .libs by default) -> ./libs should exist

Oh, I see. Usually the copying of the files produced by a 'make' is performed by 'make install'. Is there a reason why you don't use it?

> G.vertices() should return a list of unsigned integers, e.g. treedecomposition_exact() does not work with TutteGraph(), since TutteGraph().vertices() returnes a list of tuples

I see. That happens very often with any kind of 'efficient' code, as handling labels really is a hassle (trust me `:-/`). That shouldn't be a constraint on the user, however, but on ourselves. In those cases, we usually call the library's function on a *relabelled* copy of the graph (so that the vertices are integers), and apply the inverse treatment on its output so that the user gets what (s)he expects (and in particular so that (s)he can call the function on any kind of graph).

> Ok, i just thought something like that would be nice:
> 
> sage: T = tdlib.treedecomposition_exact(G)
> tree decomposition of width 4 computed
> sage: T
> Treedecomposition of width 4 on 15 vertices <--
> 
> Would it be better to use g.name("tree decompostion") for this purposes?

Definitely `:-)`

Thanks,

Nathann


---

Comment by ncohen created at 2015-11-01 20:51:22

I forgot to add an example of this relabelling. What I do here may be sufficient for you, but you can look at the doc of 'relabel' (which handles more stuff)


```
g = graphs.KneserGraph(5,2)
V = g.vertices()
g_int = g.relabel(inplace=False) # uses the ordering of g.vertices() (see the doc)
S_int = g_int.independent_set()
S = [V[i] for i in S_int]
```



---

Comment by git created at 2015-11-01 21:21:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-11-01 21:42:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by llarisch created at 2015-11-01 22:27:17

Hello,

Replying to [comment:36 ncohen]:
> 3) If, because of some limitation of Cython, we cannot directly convert Python into X (or turn Y into Python) then we can have another layer in the middle, i.e. a c++ file, which is what happens with boost_interface.

In my opinion, this is the case and for that reason sage_tdlib.cpp exists. In addition, i cannot use boost_interface, since vertex properties are not covered there. As mentioned above, i need a 

ctypedef BoostGraph[vecS, vecS, undirectedS, vecS, X] BG,

where X is some struct. Concrete (see sage_tdlib.cpp):

For the input graph


```

struct Vertex{
    ...
    ...
    unsigned int id;
    ...
};

typedef boost::adjacency_list<boost::setS, boost::vecS, boost::undirectedS, Vertex> TD_graph_t;
```



And for the output treedecomposition:



```
struct bag{
    ...
    ...
    std::set<unsigned int> bag;
    ...
};

typedef boost::adjacency_list<boost::vecS, boost::vecS, boost::undirectedS, bag> TD_tree_dec_t;
```


The reason for sage_tdlib.cpp is to do the conversion

sage graph -> V,E as vectors -> boost graph

and

boost graph (tree decomposition) -> V, E, bags as vectors -> sage graph.

> This way we adapt to whatever the library expect, and there is no need to have anything sage-related in the library.

Currently, nothing sage-related (except for the build-system) is in the library.

Lukas


---

Comment by ncohen created at 2015-11-02 07:04:50

Helloooooooo Lucas !

I see I see, thank you for the details. Why then do you need to copy `sage_tdlib.cpp` *inside* of your archive before compiling it? This is the thing that bothers me.

Nathann


---

Comment by llarisch created at 2015-11-02 07:20:20

Hello,


> 
> I see I see, thank you for the details. Why then do you need to copy `sage_tdlib.cpp` *inside* of your archive before compiling it? This is the thing that bothers me.
> 

I meant no harm by it =), i will fix that.

Where is the right place for the automake-generated makefiles and related stuff? Currently, this files are located in the tarball, but that is misguided since they refer to sage_tdlib.*. Maybe in some directory in spkg/tdlib along with sage_tdlib?


---

Comment by jdemeyer created at 2015-11-02 07:27:07

Replying to [comment:42 llarisch]:
> Where is the right place for the automake-generated makefiles and related stuff?
In the official upstream tarball.

> Currently, this files are located in the tarball, but that is misguided since they refer to sage_tdlib.*.

I think Nathann has been trying to tell you that the `sage_tdlib` files should not be in the upstream tarball, but in Sage itself. So then there is no problem.


---

Comment by ncohen created at 2015-11-02 07:30:45

Helloooooo,

> Where is the right place for the automake-generated makefiles and related stuff? Currently, this files are located in the tarball, but that is misguided since they refer to sage_tdlib.*. Maybe in some directory in spkg/tdlib along with sage_tdlib?

Well, the automake-generated makefiles are usually in the tarball `^^;`

We don't consider those to be sage-specific. Makefiles are very common in the open-source world, as those things make sure that the code compiles on any platform. So usually, the tarballs we get come with those things in it, and spkg-install is some variation of 'configure && make && make install'.

Somehow, your none of the files contained in your tarball (including the makefiles) should mention this sage_tdlib file.

Nathann


---

Comment by llarisch created at 2015-11-02 07:45:39

The thing is that the library itself only consist of template functions, such that a makefile does not make sense, since external use of some library functions is supposed to generate the needed functions -> building a shared library out of the original tarball would not generate the necessary code. The code for the exact algorithm is generated by the call 

treedec::exact_decomposition_cutset(G, T, lb);

with

typedef boost::adjacency_list<boost::setS, boost::listS, boost::undirectedS, Vertex> TD_graph_t;  

TD_graph_t G;

in sage_tdlib.cpp.


---

Comment by ncohen created at 2015-11-02 08:03:04

HMmmmm.... `O_o`

Well, then I guess all you need is to copy all you hpp files to SAGE_INCLUDE/tdlib/, and that's it?...

Nathann


---

Comment by jdemeyer created at 2015-11-02 13:09:57

Please fill in your author name on this ticket.


---

Comment by jdemeyer created at 2015-11-02 14:02:37

Please remove this line from `SPKG.txt`:

```
tarball: http://www.tdi.informatik.uni-frankfurt.de/~lukas/data/tdlib-0.3.1.tar.bz2
```



---

Comment by git created at 2015-11-02 14:27:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-11-05 17:59:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by llarisch created at 2015-11-05 18:19:11

Current state:

-Since tdlib is a template library, an installation just copies the headers to SAGELOCAL/include/tdlib

-The sage-distutils build-system will build a shared library out of sage_tdlib.cpp and the headers in /include/tdlib

-sage_tdlib.cpp is necessary until /base/boost_graph supportes vertex properties (especially std::set). currently, edge properties are supported and vertex properties are pre-defined by some vertex ids

-Even if /base/boost_graph is updated, s.t. vertex properties are supported, some c-code layer is necessary for instanciating the library code with the needed type -> in each case, a c-code layer is necessary.

Lukas


---

Comment by llarisch created at 2015-11-08 18:44:54

Changing status from needs_info to needs_review.


---

Comment by ncohen created at 2015-11-09 14:02:53

Helloooooooo Lukas,

I read and changed a couple of things in your code (mostly cleaning). I am trying to find a way to avoid this .cpp file. I added my two commits at u/ncohen/19249, which you can add atop of this branch if you agree with them.

Thanks,

Nathann


---

Comment by git created at 2015-11-09 18:11:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2015-11-16 10:24:16

Hellooooooooooo Lukas !

Okay, I give up `:-)`

I tried to shortcut your .cpp file but I wasn't able to, and even though I may have gotten 'close' my solutions were very awkward and would probably be a shot in our feet if we ever need something more generic. Let it stay as it is.

What would you think of modifying `Graph.treewidth` right now in order to make it call your library when it is installed?

The way we do it is (see `Graph.automorphism_group`) to have an 'algorithm' selector set to `None`  by default (which means 'use the best routine available'), which can also be defined manually if one wants to call Sage's algorithm or yours, explicitly.

This also lets us write doctests to check that both algorithms return the same value.

Either way this ticket will soon be merged in Sage. Thanks,

Nathann


---

Comment by git created at 2015-11-16 22:35:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2015-11-17 17:28:35

Hellooooooooo,

There were a couple of problems with error management and documentation. I pused a commit at public/19249. If you agree with it, then I guess this can go.

Nathann


---

Comment by llarisch created at 2015-11-17 19:11:07

Replying to [comment:59 ncohen]:
> Hellooooooooo,
> 
> There were a couple of problems with error management and documentation. I pused a commit at public/19249. If you agree with it, then I guess this can go.
> 
> Nathann

I agree =)

Currently, the tdlib-algorithm computes the treewidth in each case and k is a lower bound on the resulting width. I will add some code to support the version 'treewidth < k?' soon. 

Thanks for your review!

Lukas


---

Comment by ncohen created at 2015-11-17 21:33:04

New commits:


---

Comment by git created at 2015-11-17 21:35:33

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2015-11-17 21:36:53

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by ncohen created at 2015-11-17 21:38:03

Err.. Sorry with the mess with the git branch. It should now be in a correct state, with just a merging operation atop of your branch and a commit meant to clean the doc/code.

If you still have no problem with it, please change the ticket's status to `needs_review` on my behalf.

Thanks,

Nathann


---

Comment by git created at 2015-11-17 21:44:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by llarisch created at 2015-11-17 22:00:01

Replying to [comment:65 ncohen]:
> Err.. Sorry with the mess with the git branch. It should now be in a correct state, with just a merging operation atop of your branch and a commit meant to clean the doc/code.
> 
> If you still have no problem with it, please change the ticket's status to `needs_review` on my behalf.
> 
> Thanks,
> 
> Nathann

The current state is already `needs_review` ?!


---

Comment by ncohen created at 2015-11-18 12:45:41

That's only because I am an idiot. I meant 'positive_review'.


---

Comment by llarisch created at 2015-11-18 13:02:27

In build/pkgs/tdlib/type, the package type is set to `optional`. Is this correct?


---

Comment by llarisch created at 2015-11-18 13:30:45

There are still some problems with the trivial cases in the sage algorithm for treewidth:



```
sage: G = Graph()
sage: G.treewidth() #should be -1
0
sage: G.add_vertex(1)
sage: G.treewidth() #should be 0
1
```



---

Comment by ncohen created at 2015-11-18 18:04:18

I think I fixed the second case in the commit I added here. The empty graph may also return 1, however. It has to be fixed but not necessarily in this ticket, so we can merge it anyway and fix that elsewhere.

Nathann


---

Comment by llarisch created at 2015-11-18 18:22:08

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2015-11-18 20:18:23

I think you should have removed the whitespace changes to `module_list.py` (see [comment:21]) but I guess it's too late now.


---

Comment by vbraun created at 2015-11-19 14:15:03

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2015-11-19 14:15:03


```
sage -t --long src/sage/graphs/graph.py
**********************************************************************
File "src/sage/graphs/graph.py", line 2345, in sage.graphs.graph.Graph.treewidth
Failed example:
    Graph(1).treewidth()
Expected:
    0
Got:
    1
**********************************************************************
File "src/sage/graphs/graph.py", line 2355, in sage.graphs.graph.Graph.treewidth
Failed example:
    graphs.PetersenGraph().treewidth(k=3,certificate=True)
Expected:
    Tree decomposition: Graph on 6 vertices
Got:
    False
**********************************************************************
1 item had failures:
   2 of  30 in sage.graphs.graph.Graph.treewidth
    [717 tests, 2 failures, 16.17 s]
sage -t --long src/sage/graphs/graph_decompositions/tdlib.pyx
**********************************************************************
File "src/sage/graphs/graph_decompositions/tdlib.pyx", line 126, in sage.graphs.graph_decompositions.tdlib.treedecomposition_exact
Failed example:
    import sage.graphs.graph_decompositions.tdlib as tdlib
Exception raised:
    Traceback (most recent call last):
      File "/mnt/highperf/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/mnt/highperf/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.graph_decompositions.tdlib.treedecomposition_exact[0]>", line 1, in <module>
        import sage.graphs.graph_decompositions.tdlib as tdlib
    ImportError: No module named tdlib
**********************************************************************
File "src/sage/graphs/graph_decompositions/tdlib.pyx", line 128, in sage.graphs.graph_decompositions.tdlib.treedecomposition_exact
Failed example:
    T = tdlib.treedecomposition_exact(G)
Exception raised:
    Traceback (most recent call last):
      File "/mnt/highperf/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/mnt/highperf/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.graph_decompositions.tdlib.treedecomposition_exact[2]>", line 1, in <module>
        T = tdlib.treedecomposition_exact(G)
    NameError: name 'tdlib' is not defined
**********************************************************************
File "src/sage/graphs/graph_decompositions/tdlib.pyx", line 129, in sage.graphs.graph_decompositions.tdlib.treedecomposition_exact
Failed example:
    T.show(vertex_size=2000)
Exception raised:
    Traceback (most recent call last):
      File "/mnt/highperf/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/mnt/highperf/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.graph_decompositions.tdlib.treedecomposition_exact[3]>", line 1, in <module>
        T.show(vertex_size=Integer(2000))
    NameError: name 'T' is not defined
**********************************************************************
File "src/sage/graphs/graph_decompositions/tdlib.pyx", line 133, in sage.graphs.graph_decompositions.tdlib.treedecomposition_exact
Failed example:
    import sage.graphs.graph_decompositions.tdlib as tdlib
Exception raised:
    Traceback (most recent call last):
      File "/mnt/highperf/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/mnt/highperf/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.graph_decompositions.tdlib.treedecomposition_exact[4]>", line 1, in <module>
        import sage.graphs.graph_decompositions.tdlib as tdlib
    ImportError: No module named tdlib
**********************************************************************
File "src/sage/graphs/graph_decompositions/tdlib.pyx", line 135, in sage.graphs.graph_decompositions.tdlib.treedecomposition_exact
Failed example:
    T = tdlib.treedecomposition_exact(G)
Exception raised:
    Traceback (most recent call last):
      File "/mnt/highperf/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/mnt/highperf/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.graph_decompositions.tdlib.treedecomposition_exact[6]>", line 1, in <module>
        T = tdlib.treedecomposition_exact(G)
    NameError: name 'tdlib' is not defined
**********************************************************************
File "src/sage/graphs/graph_decompositions/tdlib.pyx", line 137, in sage.graphs.graph_decompositions.tdlib.treedecomposition_exact
Failed example:
    T = tdlib.treedecomposition_exact(G)
Exception raised:
    Traceback (most recent call last):
      File "/mnt/highperf/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/mnt/highperf/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.graph_decompositions.tdlib.treedecomposition_exact[8]>", line 1, in <module>
        T = tdlib.treedecomposition_exact(G)
    NameError: name 'tdlib' is not defined
**********************************************************************
File "src/sage/graphs/graph_decompositions/tdlib.pyx", line 173, in sage.graphs.graph_decompositions.tdlib.get_width
Failed example:
    import sage.graphs.graph_decompositions.tdlib as tdlib
Exception raised:
    Traceback (most recent call last):
      File "/mnt/highperf/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/mnt/highperf/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.graph_decompositions.tdlib.get_width[0]>", line 1, in <module>
        import sage.graphs.graph_decompositions.tdlib as tdlib
    ImportError: No module named tdlib
**********************************************************************
File "src/sage/graphs/graph_decompositions/tdlib.pyx", line 175, in sage.graphs.graph_decompositions.tdlib.get_width
Failed example:
    T = tdlib.treedecomposition_exact(G)
Exception raised:
    Traceback (most recent call last):
      File "/mnt/highperf/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/mnt/highperf/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.graph_decompositions.tdlib.get_width[2]>", line 1, in <module>
        T = tdlib.treedecomposition_exact(G)
    NameError: name 'tdlib' is not defined
**********************************************************************
File "src/sage/graphs/graph_decompositions/tdlib.pyx", line 176, in sage.graphs.graph_decompositions.tdlib.get_width
Failed example:
    tdlib.get_width(T)
Exception raised:
    Traceback (most recent call last):
      File "/mnt/highperf/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/mnt/highperf/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.graph_decompositions.tdlib.get_width[3]>", line 1, in <module>
        tdlib.get_width(T)
    NameError: name 'tdlib' is not defined
**********************************************************************
2 items had failures:
   3 of   5 in sage.graphs.graph_decompositions.tdlib.get_width
   6 of  10 in sage.graphs.graph_decompositions.tdlib.treedecomposition_exact
    [13 tests, 9 failures, 0.01 s]
```



---

Comment by ncohen created at 2015-11-19 14:32:26

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2015-11-19 14:32:26

Sorry, I was careless. 'optional' flags were missing in the second file, and the behaviour was sometimes wrong in the first one.

Lukas, as previously could you double check my last commit and change this ticket's status if you agree with it?

Nathann


---

Comment by git created at 2015-11-19 14:33:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-11-19 14:57:43

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-11-19 14:59:13

I rebased and squashed the commits which were previously positively reviewed, removing the whitespace changes in `src/module_list.py`. [Nathann's commit](http://git.sagemath.org/sage.git/commit/?id=030819926c0e666d6bef48674493a34dd6732b60) still needs review.


---

Comment by vbraun created at 2015-11-19 15:14:56

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-11-21 00:31:07

Resolution: fixed
