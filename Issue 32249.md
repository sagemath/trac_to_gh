# Issue 32249: KeyError followed by AttributeError while calling .closest_vector()

archive/issues_032249.json:
```json
{
    "body": "CC:  malb slabbe\n\nThe following code in Sage 9.4 gives me **KeyError: ((None,), ())** followed by **AttributeError: 'sage.symbolic.expression.Expression' object has no attribute 'ceil**':\n\n\n```\nfrom sage.modules.free_module_integer import IntegerLattice                                                                                                                                                                                                               \nL = IntegerLattice([[-1,  0,  1],[1,0,2]])                                                                                                                                                                                                                                \nL.closest_vector((1,1,1))\n```\n\n\nIt was suggested at https://ask.sagemath.org/question/58842/ that the latter error comes from `sqrt(5).ceil()` not working.\n\nI see the same error on many other `.closest_vector()` call - so essentially its functionality is broken at the moment.\n\nIssue created by migration from https://trac.sagemath.org/ticket/32486\n\n",
    "created_at": "2021-09-07T20:47:17Z",
    "labels": [
        "linear algebra",
        "critical",
        "bug"
    ],
    "title": "KeyError followed by AttributeError while calling .closest_vector()",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32249",
    "user": "@maxale"
}
```
CC:  malb slabbe

The following code in Sage 9.4 gives me **KeyError: ((None,), ())** followed by **AttributeError: 'sage.symbolic.expression.Expression' object has no attribute 'ceil**':


```
from sage.modules.free_module_integer import IntegerLattice                                                                                                                                                                                                               
L = IntegerLattice([[-1,  0,  1],[1,0,2]])                                                                                                                                                                                                                                
L.closest_vector((1,1,1))
```


It was suggested at https://ask.sagemath.org/question/58842/ that the latter error comes from `sqrt(5).ceil()` not working.

I see the same error on many other `.closest_vector()` call - so essentially its functionality is broken at the moment.

Issue created by migration from https://trac.sagemath.org/ticket/32486





---

archive/issue_comments_460505.json:
```json
{
    "body": "Yes, it looks like in:\n\nhttps://github.com/sagemath/sage/blob/c349c87d0dea805c92d589a259c4ed1a20407ca5/src/sage/modules/diamond_cutting.py#L261\n\nthere should be a numerical norm computation rather than the symbolic one that occurs now. This code is in a branch of the code that deals with non-maximal-rank lattices. It's clear this code has not been well-tested for this scenario, so I'd recommend against using it in this case at this point without reviewing the code a little more comprehensively. Errors like this may be indicative of carelessly written code that you wouldn't want to trust the results of, but it could also just be a one-off edge case that was missed.",
    "created_at": "2021-09-25T18:18:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32249",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32249#issuecomment-460505",
    "user": "nbruin"
}
```

Yes, it looks like in:

https://github.com/sagemath/sage/blob/c349c87d0dea805c92d589a259c4ed1a20407ca5/src/sage/modules/diamond_cutting.py#L261

there should be a numerical norm computation rather than the symbolic one that occurs now. This code is in a branch of the code that deals with non-maximal-rank lattices. It's clear this code has not been well-tested for this scenario, so I'd recommend against using it in this case at this point without reviewing the code a little more comprehensively. Errors like this may be indicative of carelessly written code that you wouldn't want to trust the results of, but it could also just be a one-off edge case that was missed.



---

archive/issue_comments_460506.json:
```json
{
    "body": "My guess is that the code contains something like sqrt(n) which meed to be trwated as a real not a symbolic sqrt.",
    "created_at": "2021-09-25T20:57:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32249",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32249#issuecomment-460506",
    "user": "cremona"
}
```

My guess is that the code contains something like sqrt(n) which meed to be trwated as a real not a symbolic sqrt.



---

archive/issue_comments_460507.json:
```json
{
    "body": "Replying to [comment:3 cremona]:\n> My guess is that the code contains something like sqrt(n) which meed to be trwated as a real not a symbolic sqrt.\nIndeed, that is exactly what happens in the line referenced above. However, when figuring out what the largest norm is that occurs, one should probably not take square roots at all! Perhaps at a later point, the actual L_2-norm is required rather than its square, but then one should compute it there, and not for the whole list. That's another signal that makes me a little reserved about the apparent code quality here.",
    "created_at": "2021-09-25T22:41:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32249",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32249#issuecomment-460507",
    "user": "nbruin"
}
```

Replying to [comment:3 cremona]:
> My guess is that the code contains something like sqrt(n) which meed to be trwated as a real not a symbolic sqrt.
Indeed, that is exactly what happens in the line referenced above. However, when figuring out what the largest norm is that occurs, one should probably not take square roots at all! Perhaps at a later point, the actual L_2-norm is required rather than its square, but then one should compute it there, and not for the whole list. That's another signal that makes me a little reserved about the apparent code quality here.



---

archive/issue_comments_460508.json:
```json
{
    "body": "cc-ind the author - hopefully we at least might know the reference for this method.",
    "created_at": "2021-10-02T09:00:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32249",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32249#issuecomment-460508",
    "user": "dimpase"
}
```

cc-ind the author - hopefully we at least might know the reference for this method.



---

archive/issue_comments_460509.json:
```json
{
    "body": "please review - I replaced L_2 by L_1 norms, added the test from the ticket description\n----\nNew commits:",
    "created_at": "2021-10-02T09:34:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32249",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32249#issuecomment-460509",
    "user": "dimpase"
}
```

please review - I replaced L_2 by L_1 norms, added the test from the ticket description
----
New commits:



---

archive/issue_comments_460510.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-10-02T09:34:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32249",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32249#issuecomment-460510",
    "user": "dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_460511.json:
```json
{
    "body": "I don't think that's the right fix, \\ell_2 norm is generally understood and LLL (which is called after) works in the \\ell_2 norm. Shouldn't `RR(abs(v))` do the trick?",
    "created_at": "2021-10-02T14:14:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32249",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32249#issuecomment-460511",
    "user": "malb"
}
```

I don't think that's the right fix, \ell_2 norm is generally understood and LLL (which is called after) works in the \ell_2 norm. Shouldn't `RR(abs(v))` do the trick?



---

archive/issue_comments_460512.json:
```json
{
    "body": "there is no need for a square root taking (what happens in `abs()`), it goes via SR, and thus is a bad idea - in particular if you just need an upper bound!",
    "created_at": "2021-10-02T17:17:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32249",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32249#issuecomment-460512",
    "user": "dimpase"
}
```

there is no need for a square root taking (what happens in `abs()`), it goes via SR, and thus is a bad idea - in particular if you just need an upper bound!



---

archive/issue_comments_460513.json:
```json
{
    "body": "We're taking slightly longer vectors in this patch, but this can only be harmful for the performance, as far as I understand.\n\nBesides, I'm sure there are good algorithms to find a ceil(abs(v)), without first computing a floating point approximation of abs(v), no?",
    "created_at": "2021-10-02T17:40:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32249",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32249#issuecomment-460513",
    "user": "dimpase"
}
```

We're taking slightly longer vectors in this patch, but this can only be harmful for the performance, as far as I understand.

Besides, I'm sure there are good algorithms to find a ceil(abs(v)), without first computing a floating point approximation of abs(v), no?



---

archive/issue_comments_460514.json:
```json
{
    "body": "if one has to go with \\ell_2 norm then one needs to call a function for the squared \\ell_2 norm n2 of v, \nand then take (r,rem)-n2.sqrtrem() (which basically wraps one call to GMP) of the result;\n\nthen ceil(abs(v)) is r if rem==0, and r+1 otherwise.",
    "created_at": "2021-10-02T19:11:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32249",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32249#issuecomment-460514",
    "user": "dimpase"
}
```

if one has to go with \ell_2 norm then one needs to call a function for the squared \ell_2 norm n2 of v, 
and then take (r,rem)-n2.sqrtrem() (which basically wraps one call to GMP) of the result;

then ceil(abs(v)) is r if rem==0, and r+1 otherwise.



---

archive/issue_comments_460515.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-02T19:43:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32249",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32249#issuecomment-460515",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_460516.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-10-02T19:47:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32249",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32249#issuecomment-460516",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_460517.json:
```json
{
    "body": "OK, so this is the original algorithm, using inner_product and carefully rounded sqrt from GMP.\nPlease review.",
    "created_at": "2021-10-02T19:50:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32249",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32249#issuecomment-460517",
    "user": "dimpase"
}
```

OK, so this is the original algorithm, using inner_product and carefully rounded sqrt from GMP.
Please review.



---

archive/issue_comments_460518.json:
```json
{
    "body": "Looks good to me, thanks Dima!",
    "created_at": "2021-10-03T13:32:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32249",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32249#issuecomment-460518",
    "user": "malb"
}
```

Looks good to me, thanks Dima!



---

archive/issue_comments_460519.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-10-03T13:32:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32249",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32249#issuecomment-460519",
    "user": "malb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_460520.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-10-10T10:17:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32249",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32249#issuecomment-460520",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_460521.json:
```json
{
    "body": "I'd like to bring everyone's attention to yet another bug #34091 in `.closest_vector()` that also renders it unusable.",
    "created_at": "2022-08-31T21:21:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32249",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32249#issuecomment-460521",
    "user": "@maxale"
}
```

I'd like to bring everyone's attention to yet another bug #34091 in `.closest_vector()` that also renders it unusable.
