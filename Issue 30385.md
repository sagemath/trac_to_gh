# Issue 30385: build/bin/sage-spkg: Allow overriding SAGE_LOCAL by SAGE_SPKG_PREFIX

Issue created by migration from https://trac.sagemath.org/ticket/30622

Original creator: mkoeppe

Original creation time: 2020-09-21 03:19:05

CC:  jhpalmieri mjo @kliem

This is for #29013 - which proposes to install Python packages in `$SAGE_VENV` instead of `$SAGE_LOCAL`.

`Makefile` would set `SAGE_SPKG_PREFIX=$SAGE_VENV` for these packages.  This will in particular set the installation location of installation records to `$SAGE_VENV/var/lib/sage/{installed,scripts,wheels}`.


---

Comment by git created at 2020-09-24 02:31:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-10-05 01:08:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-11-30 03:00:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-11-30 03:09:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-11-30 03:15:49

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-11-30 03:55:27

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-11-30 04:49:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-11-30 04:50:07

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Changing keywords from "" to "sd111".


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111


---

Comment by @kliem created at 2020-12-07 07:10:39

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2020-12-07 07:10:39

LGTM.


---

Comment by mkoeppe created at 2020-12-07 07:16:41

Thank you!


---

Comment by vbraun created at 2020-12-13 00:45:52

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2020-12-13 00:45:52

Merge conflict


---

Comment by git created at 2020-12-13 21:52:23

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by mkoeppe created at 2020-12-13 22:01:25

Merged #30375


---

Comment by mkoeppe created at 2020-12-13 22:01:25

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2020-12-21 23:35:28

Resolution: fixed


---

Comment by vbraun created at 2020-12-27 23:56:09

Breaks making source tarballs:

```
Sage version 9.3.beta5, release date 2020-12-27
Cloning into '/home/release/Sage/tmp/sage-9.3.beta5'...
done.
Enumerating objects: 737573, done.
Counting objects: 100% (737573/737573), done.
Delta compression using up to 16 threads
Compressing objects: 100% (702757/702757), done.
Writing objects: 100% (737573/737573), done.
Total 737573 (delta 588187), reused 141018 (delta 0), pack-reused 0
Checking connectivity: 737573, done.
Finished cloning Sage sources
Makefile:22: *** This Makefile needs to be invoked by build/make/install.  Stop.
Traceback (most recent call last):
  File "/home/release/opt/bin/git-releasemgr", line 16, in <module>
    cmdline.launch()
  File "/home/release/opt/git-trac-command/git_trac/releasemgr/cmdline.py", line 166, in launch
    app.release(args.version, check=args.check)
  File "/home/release/opt/git-trac-command/git_trac/releasemgr/app.py", line 315, in release
    create_tarball()
  File "/home/release/opt/git-trac-command/git_trac/releasemgr/make_release.py", line 15, in create_tarball
    check_call(['sage', '-sdist'])
  File "/home/release/opt/conda/lib/python2.7/subprocess.py", line 190, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command '['sage', '-sdist']' returned non-zero exit status 2
```



---

Comment by vbraun created at 2020-12-27 23:56:09

Changing status from closed to new.


---

Comment by vbraun created at 2020-12-27 23:56:09

Resolution changed from fixed to 


---

Comment by git created at 2020-12-28 04:31:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-28 04:32:12

Changing status from new to needs_review.


---

Comment by @kliem created at 2020-12-28 07:07:16

There is two small things that could be fixed along the way:
- `make dist` does not appear in `make --help`.
- `local/bin/sage-sdist` claims it should be called by `spkg/bin/sage`, but it is really run by `local/bin/sage`.

The error message `This Makefile needs to be invoked by build/make/install` seems strange, as there is at least one other legal way to call the Makefile, as we discovered here. If it is not included in the message, I think the comment should be more verbose.


---

Comment by git created at 2020-12-28 18:19:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-28 18:21:15

Replying to [comment:30 gh-kliem]:
> There is two small things that could be fixed along the way:
> - `make dist` does not appear in `make --help`.

My version of `make` here on macOS does not list any targets on `make --help`. In any case, beyond the scope of the ticket.

> - `local/bin/sage-sdist` claims it should be called by `spkg/bin/sage`, but it is really run by `local/bin/sage`.

Updated.


---

Comment by git created at 2020-12-28 18:22:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-12-29 08:48:40

Back to positive review.


---

Comment by @kliem created at 2020-12-29 08:48:40

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-12-29 18:21:49

Thanks.


---

Comment by vbraun created at 2021-01-03 12:15:39

Resolution: fixed


---

Comment by @kliem created at 2021-01-19 08:27:39

Apparently we broke `sage -b` with this ticket.
