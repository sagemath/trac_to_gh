# Issue 22700: Implement a "distribute" method

Issue created by migration from Trac.

Original creator: charpent

Original creation time: 2017-05-03 14:53:12

CC:  rws tscrim

Motivation : some "obvious" transformations, sometimes helpful in routine calculations, cannot be obtained via the current methods. Some (elementary,
i. e. high-school- or undergrad-level) exemples : given the declarations :

```
var("a,b")
var("j,p", domain="integer")
f,g,X=function("f,g,X")
```


the following equalities, true under no or mild conditions, cannot be deduced currently :

```
sum(X(j)+Y(j),j,1,p)==sum(X(j),j,1,p)+sum(Y(j),j,1,p) ## (1)
prod(X(j)*Y(j),j,1,p)==prod(X(j),j,1,p)*prod(Y(j),j,1,p) ## (2)
integrate(f(x)+g(x),x,a,b)==integrate(f(x),x,a,b)+integrate(g(x),x,a,b) ## (3)
```


Similarly, if A, B and C are matrices over a suitable ring and of
suitable dimensions, the following equalities cannot be
straightforwardly obtained.

```
(A+B).trace()==A.trace()+B.trace() ## (4)
(A*B).det()==A.det()*B.det() ## (5)
```


(Curiously, `(f(x)+g(x)).diff(x)` _does_ return
`diff(f(x),x)+diff(g(x),x)` (and a way to return to the original
expression does not seem to exist currently)).

The ability to generate the right-hand form from the left-hand form of
these various examples is sometimes useful in (low-level)
examples. The examples (1) and/or (2) arise naturally when deriving the
maximum-likelihood estimators of the mean and variance of a given
distribution. The third one is often encountered in elementary calculus
exercises.

In all cases, an operator is "distributed" over another one :
(1) : symbolic_sum is distributed over addition.
(2) : symbolic product is distributed over multiplication.
(3) : integration is ditributed over addition.
(4) : trace is distributed over (matrix) addition.
(5) : determinant is distributed over (matrix) multiplication.

Implementing (1) as an extension of the `expand()` method of
Expression is tempting (see #22915). However, there are situations
where this expansion is *not* useful. So, creating a method for such
situations seems useful.

One should note that such "distributions" are not systematically
valid : we have a collection of special cases rather than a general
mechanism. So this method shoud either limit itself to a few
recognized cases or take keyword argument(s) specifying what should be
distributed over what.

Another design choice is to know if these distributions should be
recursive or run only on the top level of a given expression
(possibly controlled by another keyword argument).

The present ticket aims at implementing this method for `sage.symbolic.expression.Expression`, at least in cases (1) to (3) (case (2) needs an implementation of the symbolic products, see #17505). Further suggestions for other classes are welcome...


---

Comment by charpent created at 2017-05-03 15:10:20

Discussion opened on[sage-devel](https://groups.google.com/forum/#!topic/sage-devel/9Dd3IiHvTYA)


---

Comment by charpent created at 2017-05-09 05:02:09

First implementation :
- Symbolic sum of a sum ==> sum of symbolic sums
- Integral (definite or not) of a sum ==> sum of integrals.

Passes `ptestlong` with the same errors as those reported for 8.0.beta4 and 8.0.beta5

==>`neeeds_review`
----
New commits:


---

Comment by charpent created at 2017-05-09 05:02:09

Changing status from new to needs_review.


---

Comment by charpent created at 2017-05-09 13:33:21

Changing status from needs_review to needs_work.


---

Comment by charpent created at 2017-05-09 13:33:21

Further verifications show that this does not work in all cases.

Back to the old drawing board...


---

Comment by git created at 2017-05-09 15:11:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by charpent created at 2017-05-09 16:44:31

Passes `ptestlong` with the same (unrelated) failures as before +one transient timeout :

```
sage -t --long src/sage/modular/modform/find_generators.py 
```

which passes when run standalone.

==>`needs_review` again.


---

Comment by charpent created at 2017-05-09 16:44:31

Changing status from needs_work to needs_review.


---

Comment by charpent created at 2017-05-11 13:30:03

Changing status from needs_review to needs_work.


---

Comment by charpent created at 2017-05-11 13:30:03

Planning to implement the multiplicative case allowed by #17505.


---

Comment by tscrim created at 2017-05-11 13:53:13

Minor comment: Instead of using `map`, you can do, e.g.,

```diff
map(lambda t:treat_term(op, t, la), aa)
treat_term(op, t, la) for t in aa
```

(with wrapping it as a list comprehension `[treat_term(op, t, la) for t in aa]` when you need a list).

Addendum - I feel this is cleaner and IIRC, it is faster.


---

Comment by charpent created at 2017-05-11 14:15:23

Replying to [comment:8 tscrim]:
> Minor comment: Instead of using `map`, you can do, e.g.,
> {{{#!diff
> map(lambda t:treat_term(op, t, la), aa)
> treat_term(op, t, la) for t in aa
> }}}
> (with wrapping it as a list comprehension `[treat_term(op, t, la) for t in aa]` when you need a list).

Indeed (my Lisp roots (and my age...) are showing).

> Addendum - I feel this is cleaner and IIRC, it is faster.

I'll check that. But I'll submit first the "map" version (which works...), and re-submit the "comprehension" version afterwards if it makes a serious difference.

BTW : other enhancements are possible. For example create a local (static) dictionary of distributable operators, whose values are functions processing the corresponding case of distribution (with possible generalizations/factorizations). I didn't feel the four special cases we treat in SR so fare were worth it, but if you have other ideas, you're welcome...

Commit forthcoming. Review request after `ptestlong` (sually a couple of hours...).


---

Comment by git created at 2017-05-11 14:19:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-05-11 14:26:01

It's about 3x slower to use `map`:

```
sage: %timeit [i for i in range(10000)]
1000 loops, best of 3: 265 µs per loop
sage: %timeit map(lambda i: i, range(10000))
1000 loops, best of 3: 897 µs per loop
```

Also in Python2, `map` returns a list, which takes extra time and memory to create. Whereas for the `sum`, you only need a generator object.

I cannot comment so much about the operators as it is a little beyond my expertise.


---

Comment by charpent created at 2017-05-11 15:35:36

This version passes `ptestlong` with the same three failure (deemed unrelated).

I'll try Travis' version before marking the better version for review.
----
New commits:


---

Comment by git created at 2017-05-11 16:10:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by charpent created at 2017-05-11 19:54:14

With Travis' suggestion, passes `ptestlong` with the same result as before ==> `needs_review`

Do you think that this enhancement should be passed to Maxima ? The algorithm seems simple to port in Maxima or Lisp.


---

Comment by charpent created at 2017-05-11 19:54:14

Changing status from needs_work to needs_review.


---

Comment by git created at 2017-05-12 14:04:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by charpent created at 2017-05-12 14:07:43

Merged #17505 again. Should be reviewable.


---

Comment by tscrim created at 2017-05-12 14:19:06

In general, it is always better to pass things to upstream. Although for now, we should do things on our side.

Some other small comments:
- There is a typo:
  {{{
_ Symbolic product of a product ==> product of symbolic products.
  }}}
- `self` is not considered as an input.
- Small change to your `INPUT:`:
  {{{
        - ``recursive`` -- (default: ``True``) the distribution proceeds
          along the subtrees of the expression
  }}}


---

Comment by git created at 2017-05-12 14:38:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by charpent created at 2017-05-12 14:41:21

Cosmetic (but important) changes to the documentation. Thank you, Travis.

`sage -t --long src/sage/symbolic/expression.pyx` passes without failure. Would you mind reviewing it (I probably can't `ptestlong` right now...).


---

Comment by charpent created at 2017-05-12 14:41:57

Replying to [comment:18 tscrim]:

You are still listed as an author in the docstring (credit where credit is due...).


---

Comment by tscrim created at 2017-05-12 14:46:36

I shouldn't be because I just did some simple review changes (so please remove me). But thank you. :)

Everything else looks good.


---

Comment by mforets created at 2017-05-12 14:56:47

is the word "indiced" correct or it is "indexed"? (i'm not native english speaker though..)


---

Comment by git created at 2017-05-12 14:58:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-05-12 14:59:28

`indexed` is correct adjective.


---

Comment by git created at 2017-05-12 15:03:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by charpent created at 2017-05-12 15:04:19

RReplying to [comment:22 tscrim]:
> I shouldn't be because I just did some simple review changes

Your suggestion to do without map() was a good one (and teached me something I tend to oversee : Python is not Lisp...).

> (so please remove me).

If you insist...

> But thank you. :)
> 
> Everything else looks good.

So this last update (including indiced --> indexed) should be reviewed...
----
New commits:


---

Comment by tscrim created at 2017-05-12 15:11:48

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2017-05-12 15:11:48

Replying to [comment:27 charpent]:
> RReplying to [comment:22 tscrim]:
> > I shouldn't be because I just did some simple review changes
> 
> Your suggestion to do without map() was a good one (and teached me something I tend to oversee : Python is not Lisp...).

I am always learning things from my reviewers too.

> > (so please remove me).
> 
> If you insist...

Thank you. I didn't really author code other than give suggestions, so I don't think I should be listed as an author. :)

You will need to add a doctest in the dependency, but you don't have to merge it into this ticket explicitly (because it is a dependency and will be done by Volker in the develop branch).


---

Comment by charpent created at 2017-05-12 15:17:24

Replying to [comment:28 tscrim]:

[ Snip ... ]

> You will need to add a doctest in the dependency, but you don't have to merge it into this ticket explicitly (because it is a dependency and will be done by Volker in the develop branch).

This should wait Ralf's implementation of the externally-visible `product` method and function (currently, we have to either import an internal function or cast to Sage a Maxima contraption...) : that will be cleaner an probably more useful to users.


---

Comment by rws created at 2017-05-13 13:05:56

Interesting. Both branches apply but mine has a hunk that fuses two hunks into one; yours has the first of the two so my hunk cannot be applied. I'll upload a branch where the two are separated.


---

Comment by rws created at 2017-05-13 13:10:33

Replying to [comment:30 rws]:
> Interesting. Both branches apply but mine has a hunk that fuses two hunks into one; yours has the first of the two so my hunk cannot be applied. I'll upload a branch where the two are separated.

Ah that should have gone to #22989.


---

Comment by charpent created at 2017-05-13 13:23:51

Replying to [comment:31 rws]:
> Replying to [comment:30 rws]:
> > Interesting. Both branches apply but mine has a hunk that fuses two hunks into one; yours has the first of the two so my hunk cannot be applied. I'll upload a branch where the two are separated.
> 
> Ah that should have gone to #22989.

Go ahead. Do you need me to do anything ?


---

Comment by vbraun created at 2017-05-14 08:19:59

Resolution: fixed


---

Comment by chapoton created at 2017-05-19 11:39:45

**WARNING**

You have used here "apply()" which is not python3-compatible. Please correct this ASAP in another ticket.

Reference: www.diveintopython3.net/porting-code-to-python-3-with-2to3.html

The Python 2 builtin apply() has been removed in Python 3


---

Comment by charpent created at 2017-05-19 11:48:20

Replying to [comment:34 chapoton]:
> **WARNING**
> 
> You have used here "apply()" which is not python3-compatible. Please correct this ASAP in another ticket.

Will do that, maybe over the coming week-end, but have to think about it I'm not much of a Python coder...).

> Reference: www.diveintopython3.net/porting-code-to-python-3-with-2to3.html

Thanks for the suggestion.

> The Python 2 builtin apply() has been removed in Python 3

H... right.


---

Comment by chapoton created at 2017-05-19 12:06:18

Do you want me to take care of that, and then be a reviewer ? Maybe this will be faster.


---

Comment by chapoton created at 2017-05-19 12:10:56

I created #23030
