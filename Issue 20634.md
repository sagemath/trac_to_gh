# Issue 20634: Fix a few more issues with sage-uncompress-spkg

Issue created by migration from https://trac.sagemath.org/ticket/20871

Original creator: embray

Original creation time: 2016-06-24 09:50:22

Fixes 2 issues:

1. An outright bug following from #20721: If the files in a tarball are not all under a top-level directory (shouldn't be the case, but possible), the `-d` flag did not work as advertised.

2. Always unset setuid and setgid flags.  There's no reason they should be set in a source tarball (I don't think?) and it will mitigate issues like #20870


---

Comment by embray created at 2016-06-24 09:50:35

Changing status from new to needs_review.


---

Comment by embray created at 2016-06-24 10:54:20

Changing type from PLEASE CHANGE to defect.


---

Comment by mkoeppe created at 2016-06-27 05:24:27

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2016-06-28 03:50:03

There is still an issue with zip files.

`sage -i bliss` gives:

```
[bliss-0.73] Found local metadata for bliss-0.73
[bliss-0.73] Using cached file /Users/mkoeppe/cvs/sage/upstream/bliss-0.73.zip
[bliss-0.73] bliss-0.73
[bliss-0.73] ====================================================
[bliss-0.73] Setting up build directory for bliss-0.73
[bliss-0.73] Traceback (most recent call last):
[bliss-0.73]   File "/Users/mkoeppe/cvs/sage/build/bin/sage-uncompress-spkg", line 260, in <module>
[bliss-0.73]     sys.exit(main())
[bliss-0.73]   File "/Users/mkoeppe/cvs/sage/build/bin/sage-uncompress-spkg", line 212, in main
[bliss-0.73]     archive = cls.open(filename)
[bliss-0.73] TypeError: unbound method open() must be called with SageZipFile instance as first argument (got str instance instead)
[bliss-0.73] Error: failed to extract /Users/mkoeppe/cvs/sage/upstream/bliss-0.73.zip
```



---

Comment by mkoeppe created at 2016-06-28 03:50:03

Changing status from positive_review to needs_work.


---

Comment by embray created at 2016-06-28 07:41:03

> There is still an issue with zip files.

Was this reported before?

Might as well fix it as part of this ticket too while I'm fixing bugs.

It looks like the `ZipFile` class is inconsistent with the `TarFile` class, where `open` is a classmethod.  I think I knew that but forgot this time.


---

Comment by mkoeppe created at 2016-06-28 07:55:08

Replying to [comment:5 embray]:
> > There is still an issue with zip files.
> 
> Was this reported before?

I didn't see a report; but zip files did work in the past. Perhaps introduced in #20721? I didn't catch it at this time.

> Might as well fix it as part of this ticket too while I'm fixing bugs.

Thanks.


---

Comment by vbraun created at 2016-06-28 14:26:30

Resolution: fixed


---

Comment by vbraun created at 2016-06-28 14:27:25

Changing status from closed to new.


---

Comment by vbraun created at 2016-06-28 14:27:25

Resolution changed from fixed to 


---

Comment by vbraun created at 2016-06-28 14:27:36

New commits:


---

Comment by embray created at 2016-06-28 14:30:50

What just happened here?


---

Comment by git created at 2016-06-28 15:25:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2016-06-28 15:40:11

I merged the positively-reviewed ticket, all tests passed, and then I closed the ticket.


---

Comment by embray created at 2016-06-28 15:46:12

The status was `needs_work` though.  I just pushed another commit that should have been included.


---

Comment by vbraun created at 2016-06-28 15:53:10

The status was positive review when I merged the ticket.


---

Comment by embray created at 2016-06-28 16:19:49

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2016-06-28 16:55:08

Branch works now, but may need merge/rebase.


---

Comment by mkoeppe created at 2016-06-28 16:55:08

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-06-29 10:23:04

Merge conflict


---

Comment by vbraun created at 2016-06-29 10:23:04

Changing status from positive_review to needs_work.


---

Comment by git created at 2016-06-30 16:21:03

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2016-06-30 16:22:06

Rebased.


---

Comment by embray created at 2016-06-30 16:22:06

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2016-07-01 13:13:57

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-07-02 08:49:04

Resolution: fixed
