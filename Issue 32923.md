# Issue 32923: update Singular to 4.3.0

Issue created by migration from https://trac.sagemath.org/ticket/33160

Original creator: dimpase

Original creation time: 2022-01-13 13:34:12

CC:  fbissey mjo @mwageringel tscrim slelievre dimpase tmonteil arojas

The previous update was on #32907


---

Comment by mkoeppe created at 2022-01-23 03:50:34

Builds OK on macOS, but I'm getting this on docbuilding:

```
[sagemath_doc_html-none] // ** loaded /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/bin/../share/singular/LIB/freegb.lib (4.1.2.0,Feb_2019)
[sagemath_doc_html-none] // ** loaded /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/bin/../libexec/singular/MOD/freealgebra.so
[sagemath_doc_html-none] // ** loaded /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/bin/../share/singular/LIB/fpalgebras.lib (4.1.2.0,Feb_2019)
[sagemath_doc_html-none] // ** loaded /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/bin/../share/singular/LIB/general.lib (4.1.2.0,Feb_2019)
[sagemath_doc_html-none] // ** loaded /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/bin/../share/singular/LIB/ring.lib (4.1.2.0,Feb_2019)
[sagemath_doc_html-none] // ** loaded /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/bin/../share/singular/LIB/primdec.lib (4.2.1.1,Jul_2021)
[sagemath_doc_html-none] // ** loaded /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/bin/../share/singular/LIB/absfact.lib (4.1.2.0,Feb_2019)
[sagemath_doc_html-none] // ** loaded /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/bin/../share/singular/LIB/triang.lib (4.1.2.0,Feb_2019)
[sagemath_doc_html-none] // ** loaded /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/bin/../share/singular/LIB/random.lib (4.1.2.0,Feb_2019)
[sagemath_doc_html-none] // ** loaded /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/bin/../share/singular/LIB/elim.lib (4.1.2.0,Feb_2019)
[sagemath_doc_html-none] // ** loaded /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/bin/../share/singular/LIB/matrix.lib (4.1.2.0,Feb_2019)
[sagemath_doc_html-none] // ** loaded /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/bin/../share/singular/LIB/nctools.lib (4.1.2.0,Feb_2019)
[sagemath_doc_html-none] // ** loaded /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/bin/../share/singular/LIB/polylib.lib (4.2.0.0,Dec_2020)
[sagemath_doc_html-none] // ** loaded /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/bin/../share/singular/LIB/inout.lib (4.1.2.0,Feb_2019)
[sagemath_doc_html-none] // ** loaded /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/bin/../share/singular/LIB/qhmoduli.lib (4.1.2.0,Feb_2019)
[sagemath_doc_html-none] // ** loaded /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/bin/../share/singular/LIB/rinvar.lib (4.1.2.0,Feb_2019)
[sagemath_doc_html-none] // ** loaded /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/bin/../share/singular/LIB/zeroset.lib (4.1.2.0,Feb_2019)
[sagemath_doc_html-none] // ** loaded /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/bin/../share/singular/LIB/primitiv.lib (4.1.2.0,Feb_2019)
[sagemath_doc_html-none] // ** loaded /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/bin/../share/singular/LIB/presolve.lib (4.1.2.0,Feb_2019)
[sagemath_doc_html-none] ------------------------------------------------------------------------
[sagemath_doc_html-none] (no backtrace available)
[sagemath_doc_html-none] ------------------------------------------------------------------------
[sagemath_doc_html-none] Unhandled SIGSEGV: A segmentation fault occurred.
[sagemath_doc_html-none] This probably occurred because a *compiled* module has a bug
[sagemath_doc_html-none] in it and is not properly wrapped with sig_on(), sig_off().
[sagemath_doc_html-none] Python will now terminate.
[sagemath_doc_html-none] ------------------------------------------------------------------------
[sagemath_doc_html-none] /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/bin/sage-python: line 2: 90459 Segmentation fault: 11  sage -python "$@"
[sagemath_doc_html-none] make[6]: *** [doc-inventory--reference-algebras] Error 139
```

----
New commits:


---

Comment by chapoton created at 2022-01-24 14:54:59

I have tried to launch an experimental patchbot on the ticket, and it fails, see the latest report's log. Not clear to me if this comes from a wrong experimental patchbot or from the singular update itself.


---

Comment by dimpase created at 2022-01-24 15:15:32

The bot should uninstall Singular it has installed, it seems.

The bot can check that the patch touches `build/pkgs/FOOBAR/package-version.txt`, and
run `make FOOBAR-clean`.


---

Comment by chapoton created at 2022-01-24 16:06:05

I ran my bot twice on this ticket, that could be the reason why it did not re-build singular the second time. Still, why would it fail if the new singular is already built ?

A priori, no need to clean any package afterwards, the bot will just re-build any anterior version when testing another ticket. I can see a problem only when we ask the patchbot to build immediatly a different version of the same package with the same number. This should not happen so often.


---

Comment by dimpase created at 2022-01-24 16:24:13

Are you sure you have Singular 4.3.0 installed there? It might be just a confusing error message, and in fact you have 4.2.1 there (but probably not...).

 
Anyhow, a package upgrade must cause rebuild of everything that depends on it (e.g. sagelib in this case, and sagelib is not rebuilt (thus the error - libfactory-4.2.1, something from the older Singular version, is not found)).


---

Comment by chapoton created at 2022-01-24 17:28:42

Thanks, indeed, something wrong happened.

Let me launch the bot again on this one, after testing another ticket.


---

Comment by chapoton created at 2022-01-24 17:41:26

argh, once again building singular 4.3, but not sagelib..

EDIT: hmm, in fact, the log says it has built sagelib successfully

EDIT but it does not re-build pynac. Should this happen ?


---

Comment by mkoeppe created at 2022-02-01 00:28:38

Changing priority from major to critical.


---

Comment by dimpase created at 2022-02-03 20:12:10

Replying to [comment:12 chapoton]:
> argh, once again building singular 4.3, but not sagelib..
> 
> EDIT: hmm, in fact, the log says it has built sagelib successfully
> 
> EDIT but it does not re-build pynac. Should this happen ?

There is no more pynac spkg. It's merged into sagelib,
and lives in src/sage/symbolic/ginac/ and in src/sage/symbolic/

Could it be that some cython `# distutils:` declarations for dependent libfactory are missing somewhere
there?  (it used to be taken care by the deps of pynac, cf. e.g. https://github.com/sagemath/sage/blob/9.4/build/pkgs/pynac/dependencies).


---

Comment by git created at 2022-02-05 01:17:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-05 19:07:14

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2022-02-05 19:25:42

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-02-07 18:38:38

I don't think #32211 is a dependency - Singular will still work with older versions of FLINT. (Otherwise, we would have to bump the minimal flint version in its spkg-configure...)


---

Comment by slelievre created at 2022-05-16 16:27:09

Singular 4.3.0p1 is out.

By the way if any Singular experts can chime in at #33327
(in multivariate polynomial rings over QQbar, when factoring,
any variable named "c" gets renamed "`@`c", leading to an error).


---

Comment by git created at 2022-06-26 00:01:12

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-06-26 00:06:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2022-06-27 22:27:49

Surprisingly, it doesn't seem to break anything. Should we just go ahead and push for it? I guess someone should check it works on cygwin.


---

Comment by mkoeppe created at 2022-06-29 22:18:52

Changing status from new to needs_review.


---

Comment by slelievre created at 2022-07-01 14:10:52

Corresponding upgrade tickets (pull requests) in Homebrew:

- [Singular 4.3.0](https://github.com/Homebrew/homebrew-core/pull/104053) (done)
- [Singular 4.3.0p1](https://github.com/Homebrew/homebrew-core/pull/104604) (needs help)


---

Comment by git created at 2022-07-05 21:01:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-05 21:05:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-07-07 17:21:58

Replying to [comment:30 fbissey]:
> Surprisingly, it doesn't seem to break anything. Should we just go ahead and push for it? I guess someone should check it works on cygwin.

Cygwin build went through (https://github.com/mkoeppe/sage/actions/runs/2618873352). There are currently numerous severe issues in the doctests (#34127), but nothing that appears to be related to Singular.

Linux/macOS tests ran at https://github.com/mkoeppe/sage/actions/runs/2618873340, looking fine

So let's get this in.


---

Comment by mkoeppe created at 2022-07-07 17:24:22

Although I do see:

```
sage -t --random-seed=179896279548957748620787144430703969151 src/sage/rings/polynomial/multi_polynomial.pyx
**********************************************************************
File "src/sage/rings/polynomial/multi_polynomial.pyx", line 1389, in sage.rings.polynomial.multi_polynomial.MPolynomial.sylvester_matrix
Failed example:
    f.sylvester_matrix(g, x).determinant() == f.resultant(g, x)
Exception raised:
    Traceback (most recent call last):
      File "/sage/local/var/lib/sage/venv-python3.10.3/lib/python3.10/site-packages/sage/doctest/forker.py", line 695, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/sage/local/var/lib/sage/venv-python3.10.3/lib/python3.10/site-packages/sage/doctest/forker.py", line 1093, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.polynomial.multi_polynomial.MPolynomial.sylvester_matrix[9]>", line 1, in <module>
        f.sylvester_matrix(g, x).determinant() == f.resultant(g, x)
      File "sage/rings/polynomial/multi_polynomial.pyx", line 1473, in sage.rings.polynomial.multi_polynomial.MPolynomial.sylvester_matrix (build/cythonized/sage/rings/polynomial/multi_polynomial.c:16983)
        raise ValueError("The Sylvester matrix is not defined for zero polynomials")
    ValueError: The Sylvester matrix is not defined for zero polynomials
**********************************************************************
```

on `fedora-35-minimal` (https://github.com/mkoeppe/sage/runs/7204192589?check_suite_focus=true), but this may be a random failure


---

Comment by mkoeppe created at 2022-07-07 17:28:00

Also

```
sage -t --random-seed=93277916729348676985025280872443577797 src/sage/rings/polynomial/hilbert.pyx
**********************************************************************
File "src/sage/rings/polynomial/hilbert.pyx", line 581, in sage.rings.polynomial.hilbert.hilbert_poincare_series
Failed example:
    J.hilbert_numerator(algorithm='singular')
Expected:
    120*t^33 - 3465*t^32 + 48180*t^31 - 429374*t^30 + 2753520*t^29 - 13522410*t^28 + 52832780*t^27 - 168384150*t^26 + 445188744*t^25 - 987193350*t^24 + 1847488500*t^23 + 1372406746*t^22 - 403422496*t^21 - 8403314*t^20 - 471656596*t^19 + 1806623746*t^18 + 752776200*t^17 + 752776200*t^16 - 1580830020*t^15 + 1673936550*t^14 - 1294246800*t^13 + 786893250*t^12 - 382391100*t^11 + 146679390*t^10 - 42299400*t^9 + 7837830*t^8 - 172260*t^7 - 468930*t^6 + 183744*t^5 - 39270*t^4 + 5060*t^3 - 330*t^2 + 1
Got:
    overflow at t^22
    overflow at t^21
    overflow at t^20
    overflow at t^19
    overflow at t^18
    120*t^33 - 3465*t^32 + 48180*t^31 - 429374*t^30 + 2753520*t^29 - 13522410*t^28 + 52832780*t^27 - 168384150*t^26 + 445188744*t^25 - 987193350*t^24 + 1847488500*t^23 + 752776200*t^17 + 752776200*t^16 - 1580830020*t^15 + 1673936550*t^14 - 1294246800*t^13 + 786893250*t^12 - 382391100*t^11 + 146679390*t^10 - 42299400*t^9 + 7837830*t^8 - 172260*t^7 - 468930*t^6 + 183744*t^5 - 39270*t^4 + 5060*t^3 - 330*t^2 + 1
**********************************************************************
```

on `ubuntu-bionic-i386-standard` (https://github.com/mkoeppe/sage/runs/7204194455?check_suite_focus=true)

This test was activated in #32907, which was already present in Sage 9.6, for which the test of hilbert.pyx succeeded - https://github.com/sagemath/sage/runs/6443848545?check_suite_focus=true. So this appears to be a regression in Singular for 32bit


---

Comment by mkoeppe created at 2022-07-07 17:51:26

The tests of 4.3.0p1 in https://github.com/mkoeppe/sage/actions/runs/2593290132 succeed on two 32bit platforms. So the regression may have been introduced in 4.3.1


---

Comment by mkoeppe created at 2022-07-07 18:00:40

From the NEWS for 4.3.1 (https://github.com/Singular/Singular/blob/spielwiese/doc/NEWS.texi):

```
@item overflow check for @nref{vdim}
@item better overflow check/les overflows for Hilbert function (@nref{hilb})
@item new algorithm for Hilbert function (@nref{hilb})
```



---

Comment by git created at 2022-07-07 18:04:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-07 18:58:04

(pushed to wrong ticket, fixed)


---

Comment by git created at 2022-07-07 18:58:42

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-07-07 19:00:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-07-08 01:06:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-07-11 04:13:20

Replying to [comment:46 mkoeppe]:
> From the NEWS for 4.3.1 (https://github.com/Singular/Singular/blob/spielwiese/doc/NEWS.texi):
> {{{
> `@`item overflow check for `@`nref{vdim}
> `@`item better overflow check/les overflows for Hilbert function (`@`nref{hilb})
> `@`item new algorithm for Hilbert function (`@`nref{hilb})
> }}}

See also #33134, #33178


---

Comment by dimpase created at 2022-07-11 11:36:26

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2022-07-11 11:36:26

lgtm


---

Comment by mkoeppe created at 2022-07-11 13:53:44

Thanks!


---

Comment by vbraun created at 2022-07-17 08:55:34

Changing status from positive_review to needs_info.


---

Comment by vbraun created at 2022-07-17 08:55:34

Please test if the 32-bit failure on #33134 is caused by this ticket


---

Comment by dimpase created at 2022-07-17 10:20:01

Changing status from needs_info to positive_review.


---

Comment by dimpase created at 2022-07-17 10:20:01

Replying to [comment:56 vbraun]:
> Please test if the 32-bit failure on #33134 is caused by this ticket

no, it is not. the reason for #33134 32-bit issue is missing treatment of the test for the 32-bit case


---

Comment by vbraun created at 2022-07-18 19:47:27

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2022-07-18 19:47:27

Well this ticket does indeed not build, so I once again waste my time on it.


---

Comment by mkoeppe created at 2022-07-18 20:01:34

Volker, can we get details please, or is your policy still to withhold this information in order to teach us a lesson?


---

Comment by dimpase created at 2022-07-18 22:03:32

I don't have a 32-bit builder, anyway.


---

Comment by vbraun created at 2022-07-18 23:08:07

Same failure that I previously reported on #33134

```
**********************************************************************
File "src/sage/rings/polynomial/hilbert.pyx", line 583, in sage.rings.polynomial.hilbert.hilbert_poincare_series
Failed example:
    J.hilbert_numerator(algorithm='singular')
Expected nothing
Got:
    overflow at t^22
    overflow at t^21
    overflow at t^20
    overflow at t^19
    overflow at t^18
    120*t^33 - 3465*t^32 + 48180*t^31 - 429374*t^30 + 2753520*t^29 - 13522410*t^28 + 52832780*t^27 - 168384150*t^26 + 445188744*t^25 - 987193350*t^24 + 1847488500*t^23 + 752776200*t^17 + 752776200*t^16 - 1580830020*t^15 + 1673936550*t^14 - 1294246800*t^13 + 786893250*t^12 - 382391100*t^11 + 146679390*t^10 - 42299400*t^9 + 7837830*t^8 - 172260*t^7 - 468930*t^6 + 183744*t^5 - 39270*t^4 + 5060*t^3 - 330*t^2 + 1
**********************************************************************
```



---

Comment by git created at 2022-07-18 23:19:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-07-18 23:20:24

I've merged in #33134 and edited that doctest slightly.


---

Comment by mkoeppe created at 2022-07-18 23:20:24

Changing status from needs_work to needs_review.


---

Comment by git created at 2022-07-19 02:47:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-07-19 02:48:23

Tested successfully with `tox -e docker-debian-buster-i386-standard`.


---

Comment by mkoeppe created at 2022-07-19 02:48:23

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2022-07-19 07:37:42

OK, also works (on 64-bit) with `SAGE_CHECK=yes`


---

Comment by vbraun created at 2022-07-28 19:10:30

Resolution: fixed


---

Comment by dimpase created at 2022-10-21 12:43:25

4.3.1p1 is broken on Fedora 34, as it does not have `fstream.h` (it does have `fstream`).
Reported upstream: https://github.com/Singular/Singular/issues/1156
