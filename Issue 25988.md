# Issue 25988: py3: change the repr of Finite families

Issue created by migration from https://trac.sagemath.org/ticket/26225

Original creator: chapoton

Original creation time: 2018-09-08 12:27:11

by pprinting their dict (sort by key)


---

Comment by chapoton created at 2018-09-08 12:27:56

Changing status from new to needs_review.


---

Comment by chapoton created at 2018-09-08 12:27:56

New commits:


---

Comment by git created at 2018-09-08 17:06:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2018-09-08 21:30:15

General +1 to this change, but see comment 4 of #24438. In particular, having a `_keys` means the iteration order for `FiniteFamily` is fixed, and I think the repr should reflect that.


---

Comment by git created at 2018-09-11 08:42:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-11 11:35:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-09-11 13:18:59


```diff
diff --git a/src/sage/sets/family.py b/src/sage/sets/family.py
index db94e7e..a780518 100644
--- a/src/sage/sets/family.py
+++ b/src/sage/sets/family.py
@@ -35,6 +35,7 @@ Check :trac:`12482` (shall be run in a fresh session)::
 #*****************************************************************************
 import types
 from copy import copy
+from pprint import pformat, saferepr
 
 from six import itervalues
 from six.moves import range
@@ -659,8 +660,21 @@ class FiniteFamily(AbstractFamily):
             sage: from sage.sets.family import FiniteFamily
             sage: FiniteFamily({3: 'a'}) # indirect doctest
             Finite family {3: 'a'}
+
+            sage: FiniteFamily({3: 'a', 4: 'b'}) # indirect doctest
+            Finite family {3: 'a', 4: 'b'}
+
+            sage: FiniteFamily({3: 'a', 4: 'b'}, keys=[4,3]) # indirect doctest
+            Finite family {4: 'b', 3: 'a'}
         """
-        return "Finite family %s"%self._dictionary
+        if self._keys is None:
+            d = ' '.join(pformat(self._dictionary).splitlines())
+            return "Finite family %s" % d
+
+        d = ', '.join('{}: {}'.format(saferepr(key),
+                                      saferepr(self._dictionary[key]))
+                      for key in self._keys)
+        return 'Finite family ``'.format(d)
```


You could avoid some duplication (and inconsistency in string formatting methods) by writing this like:


```python
if self._keys:
    d = ', '.join('{}: {}'.format(saferepr(key),
                                  saferepr(self._dictionary[key]))
                  for key in self._keys)
else:
    d = ' '.join(pformat(self._dictionary)[1:-1].splitlines())

return 'Finite family ``'.format(d)
```


or similar.


Travis, does this address the problems with #24438?  I haven't checked carefully.  Doesn't this version mean that elements not in the `keys` argument won't be displayed at all?  Is that desirable?


---

Comment by tscrim created at 2018-09-11 13:28:59

My understanding is this ticket would be another way to fix #24438, but a nuance may be lost on me. It should be that `keys` should match the keys of the dict object used in the construction (well, more generally, `keys` is treated as the input to a function -- equivalently, a sequence indexed by `keys` -- so things not in `keys` should not be displayed).


---

Comment by embray created at 2018-09-11 13:44:30

Ok.  Other than my above code style suggestion this is better then.


---

Comment by git created at 2018-09-11 13:55:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-09-11 13:58:11

There is an annoying doctest failure in 

```
src/sage/algebras/lie_algebras/classical_lie_algebra.py
```

which is not clear to me. The order seems to change from one machine to another..


---

Comment by tscrim created at 2018-09-11 14:06:22

So it has to do with the fact that roots and coroots are incomparable, hence `sorted` is random but the underlying dict is small enough that it doesn't visibly suffer from this. What we should do is just add a fixed set of keys. So for `str_keys`, it would be

```
keys = (['e{}'.format(i) for i in index_set] + ['f{}'.format(i) for i in index_set]
        + ['h{}'.format(i) for i in index_set])
```

and the other case would be

```
keys = ([alpha[i] for i in index_set] + [-alpha[i] for i in index_set]
        + [alphacheck[i] for i in index_set])
```

and then

```
Family(keys, ret.__getitem__)
```



---

Comment by git created at 2018-09-11 14:19:43

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2018-09-11 14:20:05

thanks, done. I am now launching my patchbots.


---

Comment by chapoton created at 2018-09-11 17:57:52

ok, both bots are morally green


---

Comment by tscrim created at 2018-09-11 23:49:19

Can you check that this change does not affect #26078? If it does, could you make #26078 a dependency?

Otherwise LGTM (I don't know of any other tickets that would otherwise have a conflict with this change).


---

Comment by chapoton created at 2018-09-12 06:42:43

It should not interfere, as here we only change the output of "Finite family", not the output of "Family". And there is no "Finite Family" in #26078.


---

Comment by tscrim created at 2018-09-12 06:44:40

Ah, right, they are all instances of `TrivialFamily`. Thanks.


---

Comment by tscrim created at 2018-09-12 06:44:40

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-09-13 19:25:22

Resolution: fixed
