# Issue 23446: Speed up function field doctests

archive/issues_023446.json:
```json
{
    "body": "CC:  chapoton roed xcaruso\n\nFollowup to #23193.\n\nFunction field doctests take 10 minutes on reasonable machines. That's way too much.\n\nIssue created by migration from https://trac.sagemath.org/ticket/23683\n\n",
    "created_at": "2017-08-23T13:18:22Z",
    "labels": [
        "commutative algebra",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Speed up function field doctests",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23446",
    "user": "saraedum"
}
```
CC:  chapoton roed xcaruso

Followup to #23193.

Function field doctests take 10 minutes on reasonable machines. That's way too much.

Issue created by migration from https://trac.sagemath.org/ticket/23683





---

archive/issue_comments_328115.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-08-23T13:51:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23446",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23446#issuecomment-328115",
    "user": "saraedum"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_328116.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-08-23T13:51:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23446",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23446#issuecomment-328116",
    "user": "saraedum"
}
```

New commits:



---

archive/issue_comments_328117.json:
```json
{
    "body": "I think you should rather reduce the length of \"some_elements\" to at most 5 or 6. I have not chekced the current length, but it is probably much too long. IT was 3 before the ticket that caused the \"long-time doctest\" problem.",
    "created_at": "2017-08-23T13:55:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23446",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23446#issuecomment-328117",
    "user": "chapoton"
}
```

I think you should rather reduce the length of "some_elements" to at most 5 or 6. I have not chekced the current length, but it is probably much too long. IT was 3 before the ticket that caused the "long-time doctest" problem.



---

archive/issue_comments_328118.json:
```json
{
    "body": "Why should some_elements be so short? This is precisely why we introduced max_runs in the first place. If I would write some_elements() manually, I would centainly come up with a list much longer than that. We actually find lots of bugs with having long some_elements lists in say p-adics code.",
    "created_at": "2017-08-23T14:00:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23446",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23446#issuecomment-328118",
    "user": "saraedum"
}
```

Why should some_elements be so short? This is precisely why we introduced max_runs in the first place. If I would write some_elements() manually, I would centainly come up with a list much longer than that. We actually find lots of bugs with having long some_elements lists in say p-adics code.



---

archive/issue_comments_328119.json:
```json
{
    "body": "ok, I did not know about max_runs.",
    "created_at": "2017-08-23T14:01:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23446",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23446#issuecomment-328119",
    "user": "chapoton"
}
```

ok, I did not know about max_runs.



---

archive/issue_comments_328120.json:
```json
{
    "body": "The length is typically about 50. The problem is that some doctests consider squares or triples of these. I think that max_runs is the way to go to make these doctests fast enough.",
    "created_at": "2017-08-23T14:02:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23446",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23446#issuecomment-328120",
    "user": "saraedum"
}
```

The length is typically about 50. The problem is that some doctests consider squares or triples of these. I think that max_runs is the way to go to make these doctests fast enough.



---

archive/issue_comments_328121.json:
```json
{
    "body": "Replying to [comment:8 saraedum]:\n> The length is typically about 50. The problem is that some doctests consider squares or triples of these. I think that max_runs is the way to go to make these doctests fast enough.\n\n-1 because it doesn't get the same sort of coverage as to using 5-10 elements. E.g., it only does `x0 * (y * z) == (x0 * y) * z` for a fixed `x0`, which maybe too simple. So IMO, it is better to do a subset of `some_elements` (passed via `elements` to the `TestSuite`) to make sure you get more complicated elements tested, which is part of the reason you have these more complicated `some_elements()`, right?\n\nReally, `some_elements()` is designed primarily for testing rather than to tell the user something. So having smaller number of `some_elements()`, but having those elements be \"interesting\" (in an appropriate definition), is what I think it should be.",
    "created_at": "2017-08-23T14:29:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23446",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23446#issuecomment-328121",
    "user": "tscrim"
}
```

Replying to [comment:8 saraedum]:
> The length is typically about 50. The problem is that some doctests consider squares or triples of these. I think that max_runs is the way to go to make these doctests fast enough.

-1 because it doesn't get the same sort of coverage as to using 5-10 elements. E.g., it only does `x0 * (y * z) == (x0 * y) * z` for a fixed `x0`, which maybe too simple. So IMO, it is better to do a subset of `some_elements` (passed via `elements` to the `TestSuite`) to make sure you get more complicated elements tested, which is part of the reason you have these more complicated `some_elements()`, right?

Really, `some_elements()` is designed primarily for testing rather than to tell the user something. So having smaller number of `some_elements()`, but having those elements be "interesting" (in an appropriate definition), is what I think it should be.



---

archive/issue_comments_328122.json:
```json
{
    "body": "I think this is a problem of `some_elements` or the doctests that use pairs and triples. Either `some_elements` should not just select the first few, or the doctests should generate the product in a more \"interesting\" fashion.",
    "created_at": "2017-08-23T14:43:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23446",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23446#issuecomment-328122",
    "user": "saraedum"
}
```

I think this is a problem of `some_elements` or the doctests that use pairs and triples. Either `some_elements` should not just select the first few, or the doctests should generate the product in a more "interesting" fashion.



---

archive/issue_comments_328123.json:
```json
{
    "body": "I am strongly opposed to shorten some_elements. As I said, having some_elements be long has proved very useful in the past. Of course, if the pairs tested are not \"interesting\" that is very bad.",
    "created_at": "2017-08-23T14:44:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23446",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23446#issuecomment-328123",
    "user": "saraedum"
}
```

I am strongly opposed to shorten some_elements. As I said, having some_elements be long has proved very useful in the past. Of course, if the pairs tested are not "interesting" that is very bad.



---

archive/issue_comments_328124.json:
```json
{
    "body": "This is now #23686.",
    "created_at": "2017-08-23T14:47:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23446",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23446#issuecomment-328124",
    "user": "saraedum"
}
```

This is now #23686.



---

archive/issue_comments_328125.json:
```json
{
    "body": "Replying to [comment:10 saraedum]:\n> I think this is a problem of `some_elements` or the doctests that use pairs and triples. Either `some_elements` should not just select the first few, or the doctests should generate the product in a more \"interesting\" fashion.\n\nThat would be an overengineered solution: you create a long list just to make a shorter list by sampling, which in turn, does not guarantee you get good elements. We could randomize this, but then you could have things that look like heisenbugs. So I do not think it makes any sense to have something like `_test_associative` to not go through all triples of the testing elements.",
    "created_at": "2017-08-23T15:05:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23446",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23446#issuecomment-328125",
    "user": "tscrim"
}
```

Replying to [comment:10 saraedum]:
> I think this is a problem of `some_elements` or the doctests that use pairs and triples. Either `some_elements` should not just select the first few, or the doctests should generate the product in a more "interesting" fashion.

That would be an overengineered solution: you create a long list just to make a shorter list by sampling, which in turn, does not guarantee you get good elements. We could randomize this, but then you could have things that look like heisenbugs. So I do not think it makes any sense to have something like `_test_associative` to not go through all triples of the testing elements.



---

archive/issue_comments_328126.json:
```json
{
    "body": "I can write down manually a lot of interesting elements in a p-adic ring that I would want tests to be run for. There are so many weird corner cases with precision in particular in extensions that you do not want to shorten these lists. Of course you can not test everything in all triples but that's ok. I still want almost everything be tested for the individual elements and pairs. (Actually p-adic some_elements is not so large yet because (as far as I recall) when we wrote it max_runs was not ready yet.)\nWhat is wrong about not just taking the plain cartesian product but do some deterministic sampling? How we implement that is a different question. I believe there are a few viable options by either adapting the tests or have some_elements detect that it is being queried for a prouduct.",
    "created_at": "2017-08-23T15:28:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23446",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23446#issuecomment-328126",
    "user": "saraedum"
}
```

I can write down manually a lot of interesting elements in a p-adic ring that I would want tests to be run for. There are so many weird corner cases with precision in particular in extensions that you do not want to shorten these lists. Of course you can not test everything in all triples but that's ok. I still want almost everything be tested for the individual elements and pairs. (Actually p-adic some_elements is not so large yet because (as far as I recall) when we wrote it max_runs was not ready yet.)
What is wrong about not just taking the plain cartesian product but do some deterministic sampling? How we implement that is a different question. I believe there are a few viable options by either adapting the tests or have some_elements detect that it is being queried for a prouduct.



---

archive/issue_comments_328127.json:
```json
{
    "body": "Replying to [comment:14 saraedum]:\n> What is wrong about not just taking the plain cartesian product but do some deterministic sampling?\n\nBecause then you have fundamentally no control over the elements that are chosen and it can defeat the entire purpose of having a few interesting elements. Say you want 4 relatively trivial elements and 1 very complicated element in order to test interesting examples but it is too slow otherwise (perhaps in reality it would be 2x or 3x these particular numbers). It is very likely that you would sample only the trivial elements, but you would have no idea that those were the ones sampled, much less have any clear (or even feasible) way to change that. If you want to sample elements, then *you* sample the elements and pass them to the `TestSuite`. However, you have to do that for every such test, so the best solution is to make `some_elements` smaller and instead pass `elements` with more complicated elements for those other more fundamental tests.",
    "created_at": "2017-08-23T19:23:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23446",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23446#issuecomment-328127",
    "user": "tscrim"
}
```

Replying to [comment:14 saraedum]:
> What is wrong about not just taking the plain cartesian product but do some deterministic sampling?

Because then you have fundamentally no control over the elements that are chosen and it can defeat the entire purpose of having a few interesting elements. Say you want 4 relatively trivial elements and 1 very complicated element in order to test interesting examples but it is too slow otherwise (perhaps in reality it would be 2x or 3x these particular numbers). It is very likely that you would sample only the trivial elements, but you would have no idea that those were the ones sampled, much less have any clear (or even feasible) way to change that. If you want to sample elements, then *you* sample the elements and pass them to the `TestSuite`. However, you have to do that for every such test, so the best solution is to make `some_elements` smaller and instead pass `elements` with more complicated elements for those other more fundamental tests.



---

archive/issue_comments_328128.json:
```json
{
    "body": "Whatever solution is chosen at the end, you should not remove the real time indications in the comments, but update them.",
    "created_at": "2017-08-24T16:52:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23446",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23446#issuecomment-328128",
    "user": "chapoton"
}
```

Whatever solution is chosen at the end, you should not remove the real time indications in the comments, but update them.



---

archive/issue_comments_328129.json:
```json
{
    "body": "I would prefer to see this solved, even if in a bad way, than to stay unsolved any second longer.",
    "created_at": "2017-08-25T15:04:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23446",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23446#issuecomment-328129",
    "user": "chapoton"
}
```

I would prefer to see this solved, even if in a bad way, than to stay unsolved any second longer.



---

archive/issue_comments_328130.json:
```json
{
    "body": "Replying to [comment:15 tscrim]:\n> Replying to [comment:14 saraedum]:\n> > What is wrong about not just taking the plain cartesian product but do some deterministic sampling?\n> \n> Because then you have fundamentally no control over the elements that are chosen and it can defeat the entire purpose of having a few interesting elements. Say you want 4 relatively trivial elements and 1 very complicated element in order to test interesting examples but it is too slow otherwise (perhaps in reality it would be 2x or 3x these particular numbers). It is very likely that you would sample only the trivial elements, but you would have no idea that those were the ones sampled, much less have any clear (or even feasible) way to change that. If you want to sample elements, then *you* sample the elements and pass them to the `TestSuite`. However, you have to do that for every such test, so the best solution is to make `some_elements` smaller and instead pass `elements` with more complicated elements for those other more fundamental tests.\n\nI don't understand. How can I pass in pairs and triples of elements to the TestSuite? I also don't understand the proposal apart from that technicality. If I follow what you propose, then I pass in a long list of elements to most test (the ones that are linear in the number of elements) and just use the default `some_elements` for the tests that use pairs and triples?",
    "created_at": "2017-08-25T16:52:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23446",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23446#issuecomment-328130",
    "user": "saraedum"
}
```

Replying to [comment:15 tscrim]:
> Replying to [comment:14 saraedum]:
> > What is wrong about not just taking the plain cartesian product but do some deterministic sampling?
> 
> Because then you have fundamentally no control over the elements that are chosen and it can defeat the entire purpose of having a few interesting elements. Say you want 4 relatively trivial elements and 1 very complicated element in order to test interesting examples but it is too slow otherwise (perhaps in reality it would be 2x or 3x these particular numbers). It is very likely that you would sample only the trivial elements, but you would have no idea that those were the ones sampled, much less have any clear (or even feasible) way to change that. If you want to sample elements, then *you* sample the elements and pass them to the `TestSuite`. However, you have to do that for every such test, so the best solution is to make `some_elements` smaller and instead pass `elements` with more complicated elements for those other more fundamental tests.

I don't understand. How can I pass in pairs and triples of elements to the TestSuite? I also don't understand the proposal apart from that technicality. If I follow what you propose, then I pass in a long list of elements to most test (the ones that are linear in the number of elements) and just use the default `some_elements` for the tests that use pairs and triples?



---

archive/issue_comments_328131.json:
```json
{
    "body": "I've been talking with David at Days 88 about this, and I realized that I wasn't clear that I am not opposed to the current branch as a short-term solution. Julian, if you could update the timings, I will set a positive review.\n\nAlso, David and I discussed implementing a sampling feature to the `TestSuite` that would not be run by default, but by passing another argument to `TestSuite` that would only be used when the number of elements was bigger than `max_runs`.",
    "created_at": "2017-08-25T16:54:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23446",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23446#issuecomment-328131",
    "user": "tscrim"
}
```

I've been talking with David at Days 88 about this, and I realized that I wasn't clear that I am not opposed to the current branch as a short-term solution. Julian, if you could update the timings, I will set a positive review.

Also, David and I discussed implementing a sampling feature to the `TestSuite` that would not be run by default, but by passing another argument to `TestSuite` that would only be used when the number of elements was bigger than `max_runs`.



---

archive/issue_comments_328132.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-08-25T16:58:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23446",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23446#issuecomment-328132",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_328133.json:
```json
{
    "body": "Replying to [comment:16 chapoton]:\n> Whatever solution is chosen at the end, you should not remove the real time indications in the comments, but update them.\nOk. I put indications back in.",
    "created_at": "2017-08-25T16:59:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23446",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23446#issuecomment-328133",
    "user": "saraedum"
}
```

Replying to [comment:16 chapoton]:
> Whatever solution is chosen at the end, you should not remove the real time indications in the comments, but update them.
Ok. I put indications back in.



---

archive/issue_comments_328134.json:
```json
{
    "body": "Replying to [comment:19 tscrim]:\n> I've been talking with David at Days 88 about this, and I realized that I wasn't clear that I am not opposed to the current branch as a short-term solution. Julian, if you could update the timings, I will set a positive review.\nOk. Cool.\n\n> Also, David and I discussed implementing a sampling feature to the `TestSuite` that would not be run by default, but by passing another argument to `TestSuite` that would only be used when the number of elements was bigger than `max_runs`.\nCould you elaborate or maybe rather comment on the followup ticket?",
    "created_at": "2017-08-25T17:03:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23446",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23446#issuecomment-328134",
    "user": "saraedum"
}
```

Replying to [comment:19 tscrim]:
> I've been talking with David at Days 88 about this, and I realized that I wasn't clear that I am not opposed to the current branch as a short-term solution. Julian, if you could update the timings, I will set a positive review.
Ok. Cool.

> Also, David and I discussed implementing a sampling feature to the `TestSuite` that would not be run by default, but by passing another argument to `TestSuite` that would only be used when the number of elements was bigger than `max_runs`.
Could you elaborate or maybe rather comment on the followup ticket?



---

archive/issue_comments_328135.json:
```json
{
    "body": "Replying to [comment:22 saraedum]:\n> Replying to [comment:19 tscrim]:\n> > I've been talking with David at Days 88 about this, and I realized that I wasn't clear that I am not opposed to the current branch as a short-term solution. Julian, if you could update the timings, I will set a positive review.\n> Ok. Cool.\n\nMinor typo: `# long timeA (10s)`; you can set a positive review once fixed.\n\n> > Also, David and I discussed implementing a sampling feature to the `TestSuite` that would not be run by default, but by passing another argument to `TestSuite` that would only be used when the number of elements was bigger than `max_runs`.\n> Could you elaborate or maybe rather comment on the followup ticket?\n\nI believe David (Roe) will post the followup ticket with perhaps more details and/or a first implementation. What we agreed upon was basically the following:\n\n- if `some_elements()^N > max_runs` and something like `max_samples` or `sampling=True` was passed:\n  * do sampling\n- else:\n  * use the direct iterator\n\nAs far as sampling goes, in order to do \"good\" sampling, we would need to decide upon a convention for where in `some_elements` the more \"interesting\" objects are at the end and we sample more heavily from there.\n\nSomething that I have used the `TestSuite` for is to increase the `max_runs` and fix failures as more interesting elements come up. So I needed that to behave in a more deterministic way as with sampling, it could be nice for `N` but fail for `N-1` because of the elements used. I also like it to work for infinite (enumerated) sets as well.",
    "created_at": "2017-08-25T18:29:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23446",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23446#issuecomment-328135",
    "user": "tscrim"
}
```

Replying to [comment:22 saraedum]:
> Replying to [comment:19 tscrim]:
> > I've been talking with David at Days 88 about this, and I realized that I wasn't clear that I am not opposed to the current branch as a short-term solution. Julian, if you could update the timings, I will set a positive review.
> Ok. Cool.

Minor typo: `# long timeA (10s)`; you can set a positive review once fixed.

> > Also, David and I discussed implementing a sampling feature to the `TestSuite` that would not be run by default, but by passing another argument to `TestSuite` that would only be used when the number of elements was bigger than `max_runs`.
> Could you elaborate or maybe rather comment on the followup ticket?

I believe David (Roe) will post the followup ticket with perhaps more details and/or a first implementation. What we agreed upon was basically the following:

- if `some_elements()^N > max_runs` and something like `max_samples` or `sampling=True` was passed:
  * do sampling
- else:
  * use the direct iterator

As far as sampling goes, in order to do "good" sampling, we would need to decide upon a convention for where in `some_elements` the more "interesting" objects are at the end and we sample more heavily from there.

Something that I have used the `TestSuite` for is to increase the `max_runs` and fix failures as more interesting elements come up. So I needed that to behave in a more deterministic way as with sampling, it could be nice for `N` but fail for `N-1` because of the elements used. I also like it to work for infinite (enumerated) sets as well.



---

archive/issue_comments_328136.json:
```json
{
    "body": "The followup is #23724.  I'm happy for feedback on the approach taken there.",
    "created_at": "2017-08-26T04:12:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23446",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23446#issuecomment-328136",
    "user": "roed"
}
```

The followup is #23724.  I'm happy for feedback on the approach taken there.



---

archive/issue_comments_328137.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-08-26T11:49:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23446",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23446#issuecomment-328137",
    "user": "chapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_328138.json:
```json
{
    "body": "after correcting the typo, I am setting to positive\n----\nNew commits:",
    "created_at": "2017-08-26T11:49:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23446",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23446#issuecomment-328138",
    "user": "chapoton"
}
```

after correcting the typo, I am setting to positive
----
New commits:



---

archive/issue_comments_328139.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-09-04T06:10:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23446",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23446#issuecomment-328139",
    "user": "vbraun"
}
```

Resolution: fixed
