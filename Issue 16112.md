# Issue 16112: Make UniqueFactory unpickling more flexible

archive/issues_016112.json:
```json
{
    "body": "Assignee: tscrim\n\nCC:  simonking nthiery\n\nKeywords: UniqueFactory pickle\n\nCurrently `UniqueFactory`'s unpickling protocol is to call `generic_factory_unpickle()`, whose first argument *must* be an instance of `UniqueFactory`. However we might want to change the object in the global namespace, let's say to a function, and then we will not be able to unpickle any  thing beforehand (`register_unpickle_override` can not help here because the pickle info is `(UniqueFactory`, `generic_factory_unpickle)`). Came up in #15289.\n\nIssue created by migration from https://trac.sagemath.org/ticket/16349\n\n",
    "created_at": "2014-05-13T15:42:28Z",
    "labels": [
        "pickling",
        "major",
        "bug"
    ],
    "title": "Make UniqueFactory unpickling more flexible",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16112",
    "user": "tscrim"
}
```
Assignee: tscrim

CC:  simonking nthiery

Keywords: UniqueFactory pickle

Currently `UniqueFactory`'s unpickling protocol is to call `generic_factory_unpickle()`, whose first argument *must* be an instance of `UniqueFactory`. However we might want to change the object in the global namespace, let's say to a function, and then we will not be able to unpickle any  thing beforehand (`register_unpickle_override` can not help here because the pickle info is `(UniqueFactory`, `generic_factory_unpickle)`). Came up in #15289.

Issue created by migration from https://trac.sagemath.org/ticket/16349





---

archive/issue_comments_210194.json:
```json
{
    "body": "Travis, you have been inserted as \"Author\", but I think you did not provide code. So, I took the liberty to replace your name by mine, and attach a branch. The new doctest demonstrates how to replace a unique factory by unique representation and correctly unpickle.\n----\nNew commits:",
    "created_at": "2014-05-14T11:34:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16112#issuecomment-210194",
    "user": "SimonKing"
}
```

Travis, you have been inserted as "Author", but I think you did not provide code. So, I took the liberty to replace your name by mine, and attach a branch. The new doctest demonstrates how to replace a unique factory by unique representation and correctly unpickle.
----
New commits:



---

archive/issue_comments_210195.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-05-14T11:34:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16112#issuecomment-210195",
    "user": "SimonKing"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_210196.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-05-14T12:46:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16112#issuecomment-210196",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_210197.json:
```json
{
    "body": "I had to fix one detail (I made a wrong assumption on the format of `_factory_data`.",
    "created_at": "2014-05-14T12:47:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16112#issuecomment-210197",
    "user": "SimonKing"
}
```

I had to fix one detail (I made a wrong assumption on the format of `_factory_data`.



---

archive/issue_comments_210198.json:
```json
{
    "body": "Hey Simon, I didn't have a chance to finish it yesterday. I will finish up what I was working on today as an alternative proposal.",
    "created_at": "2014-05-14T16:08:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16112#issuecomment-210198",
    "user": "tscrim"
}
```

Hey Simon, I didn't have a chance to finish it yesterday. I will finish up what I was working on today as an alternative proposal.



---

archive/issue_comments_210199.json:
```json
{
    "body": "Okay I've just put in both versions. I've implemented something similar to `register_unpickle_override()` (which I've called `register_factory_unpickle()`). This way we can handle when the factory is removed from the global namespace (such as for name change). If you could check that and agree, then we can set this to positive review. Thanks.\n----\nNew commits:",
    "created_at": "2014-05-15T16:19:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16112#issuecomment-210199",
    "user": "tscrim"
}
```

Okay I've just put in both versions. I've implemented something similar to `register_unpickle_override()` (which I've called `register_factory_unpickle()`). This way we can handle when the factory is removed from the global namespace (such as for name change). If you could check that and agree, then we can set this to positive review. Thanks.
----
New commits:



---

archive/issue_comments_210200.json:
```json
{
    "body": "With the current branch, we provide two ways to deal with old pickles of `UniqueFactory`: If we replace the old factory by something new that has the same name, is in the same module and can process the same input as the `UniqueFactory`, then nothing more needs to be done (that's my contribution). Moreover, it is possible to override unpickling so that a new callable is used for unpickling *even if the old factory is still there* (that's your contribution). I think both possibilities make sense. Hence, I complete the positive review.",
    "created_at": "2014-05-16T09:39:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16112#issuecomment-210200",
    "user": "SimonKing"
}
```

With the current branch, we provide two ways to deal with old pickles of `UniqueFactory`: If we replace the old factory by something new that has the same name, is in the same module and can process the same input as the `UniqueFactory`, then nothing more needs to be done (that's my contribution). Moreover, it is possible to override unpickling so that a new callable is used for unpickling *even if the old factory is still there* (that's your contribution). I think both possibilities make sense. Hence, I complete the positive review.



---

archive/issue_comments_210201.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-05-16T09:39:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16112#issuecomment-210201",
    "user": "SimonKing"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_210202.json:
```json
{
    "body": "Thank you Simon.",
    "created_at": "2014-05-16T14:35:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16112#issuecomment-210202",
    "user": "tscrim"
}
```

Thank you Simon.



---

archive/issue_comments_210203.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-05-19T12:53:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16112#issuecomment-210203",
    "user": "vbraun"
}
```

Resolution: fixed
