# Issue 28933: Fix R installation errors related to gfortran

archive/issues_028933.json:
```json
{
    "body": "CC:  @dimpase @EmmanuelCharpentier @kiwifb @orlitzky @timokau\n\nAs reported \n- for 9.0.rc1 in https://groups.google.com/d/msg/sage-release/YaedKjwMhzc/d44U0MM3BwAJ\n- for 9.1.beta3 in https://groups.google.com/d/msg/sage-release/xxEfql2Isgg/bV-FQN8VFQAJ\n\nhttps://developer.r-project.org/Blog/public/2019/05/15/gfortran-issues-with-lapack/index.html\n\nIssue created by migration from https://trac.sagemath.org/ticket/29170\n\n",
    "created_at": "2020-02-09T02:38:16Z",
    "labels": [
        "packages: standard",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "Fix R installation errors related to gfortran",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28933",
    "user": "@mkoeppe"
}
```
CC:  @dimpase @EmmanuelCharpentier @kiwifb @orlitzky @timokau

As reported 
- for 9.0.rc1 in https://groups.google.com/d/msg/sage-release/YaedKjwMhzc/d44U0MM3BwAJ
- for 9.1.beta3 in https://groups.google.com/d/msg/sage-release/xxEfql2Isgg/bV-FQN8VFQAJ

https://developer.r-project.org/Blog/public/2019/05/15/gfortran-issues-with-lapack/index.html

Issue created by migration from https://trac.sagemath.org/ticket/29170





---

archive/issue_comments_409581.json:
```json
{
    "body": "gcc fix here (linked from the R link) https://gcc.gnu.org/bugzilla/show_bug.cgi?id=90329\n\nnot clear what they actually did - new option(s) added to gfortran?",
    "created_at": "2020-02-09T12:05:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28933",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28933#issuecomment-409581",
    "user": "@dimpase"
}
```

gcc fix here (linked from the R link) https://gcc.gnu.org/bugzilla/show_bug.cgi?id=90329

not clear what they actually did - new option(s) added to gfortran?



---

archive/issue_comments_409582.json:
```json
{
    "body": "Ok, I read that whole thread so no one else has to. Ultimately, this is due to broken code that needs to be updated. The GCC developers have done two things:\n\n* Added `-fc-prototypes-external`, to help people fix that broken code.\n* In the meantime, they have added a workaround in the form of the (on by default) `-ftail-call-workaround` flag (https://gcc.gnu.org/onlinedocs/gfortran/Code-Gen-Options.html). That keeps the broken code working for now, but the option will eventually be turned off and go away.\n\nThe workaround was backported all the way back to gcc-7.x, so really what we should be doing is telling everyone to use a new-enough gfortran. The workaround is in gcc-9.2, and based on the release dates, I presume it's also in 7.5, 8.4, and everything newer than that.\n\nWe can probably just update gfortran's spkg-configure.m4 to ensure a new-enough version. Maybe for now it would suffice to check if the `-ftail-call-workaround` flag is supported. That would rule out older compilers from before things were broken, but is easy to implement.",
    "created_at": "2020-03-16T03:34:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28933",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28933#issuecomment-409582",
    "user": "@orlitzky"
}
```

Ok, I read that whole thread so no one else has to. Ultimately, this is due to broken code that needs to be updated. The GCC developers have done two things:

* Added `-fc-prototypes-external`, to help people fix that broken code.
* In the meantime, they have added a workaround in the form of the (on by default) `-ftail-call-workaround` flag (https://gcc.gnu.org/onlinedocs/gfortran/Code-Gen-Options.html). That keeps the broken code working for now, but the option will eventually be turned off and go away.

The workaround was backported all the way back to gcc-7.x, so really what we should be doing is telling everyone to use a new-enough gfortran. The workaround is in gcc-9.2, and based on the release dates, I presume it's also in 7.5, 8.4, and everything newer than that.

We can probably just update gfortran's spkg-configure.m4 to ensure a new-enough version. Maybe for now it would suffice to check if the `-ftail-call-workaround` flag is supported. That would rule out older compilers from before things were broken, but is easy to implement.



---

archive/issue_comments_409583.json:
```json
{
    "body": "See also: #29379 Upgrade R to 3.6.3 (which does not fix these errors)",
    "created_at": "2020-03-20T21:58:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28933",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28933#issuecomment-409583",
    "user": "@mkoeppe"
}
```

See also: #29379 Upgrade R to 3.6.3 (which does not fix these errors)



---

archive/issue_comments_409584.json:
```json
{
    "body": "See also:  #29378 Update OpenBLAS to 0.3.9 (which also does not fix these errors)",
    "created_at": "2020-03-21T01:53:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28933",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28933#issuecomment-409584",
    "user": "@mkoeppe"
}
```

See also:  #29378 Update OpenBLAS to 0.3.9 (which also does not fix these errors)



---

archive/issue_comments_409585.json:
```json
{
    "body": "Replying to [comment:5 mkoeppe]:\n> See also:  #29378 Update OpenBLAS to 0.3.9 (which also does not fix these errors)\nIIRC, the bugs in question (related to passing strings) are in \"canonical\" Fortran Lapack routines, and OpenBLAS does not amend Fortran code",
    "created_at": "2020-03-21T02:47:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28933",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28933#issuecomment-409585",
    "user": "@dimpase"
}
```

Replying to [comment:5 mkoeppe]:
> See also:  #29378 Update OpenBLAS to 0.3.9 (which also does not fix these errors)
IIRC, the bugs in question (related to passing strings) are in "canonical" Fortran Lapack routines, and OpenBLAS does not amend Fortran code



---

archive/issue_comments_409586.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2020-03-21T14:03:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28933",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28933#issuecomment-409586",
    "user": "@mkoeppe"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_409587.json:
```json
{
    "body": "Our R 3.6.2 already contains checks in `configure` that are intended to address the problem with the Fortran ABI. On one of the failing platforms, however, I see:\n\n```\n[r-3.6.2.p0] checking if need -fno-optimize-sibling-calls for gfortran... yes\n[r-3.6.2.p0] checking for type of 'hidden' Fortran character lengths... \n[r-3.6.2.p0] checking for xmkmf... no\n```\n\nwhich looks suspicious (note - no result shown for the type)",
    "created_at": "2020-03-22T00:44:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28933",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28933#issuecomment-409587",
    "user": "@mkoeppe"
}
```

Our R 3.6.2 already contains checks in `configure` that are intended to address the problem with the Fortran ABI. On one of the failing platforms, however, I see:

```
[r-3.6.2.p0] checking if need -fno-optimize-sibling-calls for gfortran... yes
[r-3.6.2.p0] checking for type of 'hidden' Fortran character lengths... 
[r-3.6.2.p0] checking for xmkmf... no
```

which looks suspicious (note - no result shown for the type)



---

archive/issue_comments_409588.json:
```json
{
    "body": "from config.log there:\n\n```\nconfigure:20320: checking for type of 'hidden' Fortran character lengths\n/usr/bin/ld: conftestf.o: relocation R_X86_64_32 against `.rodata' can not be used when making a PIE object; recompile with -fPIC\n/usr/bin/ld: final link failed: nonrepresentable section on output\ncollect2: error: ld returned 1 exit status\nconfigure:20384: result: \n```\n",
    "created_at": "2020-03-22T00:46:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28933",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28933#issuecomment-409588",
    "user": "@mkoeppe"
}
```

from config.log there:

```
configure:20320: checking for type of 'hidden' Fortran character lengths
/usr/bin/ld: conftestf.o: relocation R_X86_64_32 against `.rodata' can not be used when making a PIE object; recompile with -fPIC
/usr/bin/ld: final link failed: nonrepresentable section on output
collect2: error: ld returned 1 exit status
configure:20384: result: 
```




---

archive/issue_comments_409589.json:
```json
{
    "body": "bug in R's ./configure ?",
    "created_at": "2020-03-22T00:49:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28933",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28933#issuecomment-409589",
    "user": "@dimpase"
}
```

bug in R's ./configure ?



---

archive/issue_comments_409590.json:
```json
{
    "body": "In any case missing error handling. I'm on it",
    "created_at": "2020-03-22T00:58:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28933",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28933#issuecomment-409590",
    "user": "@mkoeppe"
}
```

In any case missing error handling. I'm on it



---

archive/issue_comments_409591.json:
```json
{
    "body": "Adding `-fPIC` to CFLAGS & FCFLAGS seems to do the trick.",
    "created_at": "2020-03-22T01:24:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28933",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28933#issuecomment-409591",
    "user": "@mkoeppe"
}
```

Adding `-fPIC` to CFLAGS & FCFLAGS seems to do the trick.



---

archive/issue_comments_409592.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-03-22T01:29:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28933",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28933#issuecomment-409592",
    "user": "@mkoeppe"
}
```

New commits:



---

archive/issue_comments_409593.json:
```json
{
    "body": "Tests run at https://github.com/mkoeppe/sage/actions/runs/60562504",
    "created_at": "2020-03-22T01:32:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28933",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28933#issuecomment-409593",
    "user": "@mkoeppe"
}
```

Tests run at https://github.com/mkoeppe/sage/actions/runs/60562504



---

archive/issue_comments_409594.json:
```json
{
    "body": "One needs to check whether the latest R still has this issue, and notify upstream, if it does.",
    "created_at": "2020-03-22T01:39:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28933",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28933#issuecomment-409594",
    "user": "@dimpase"
}
```

One needs to check whether the latest R still has this issue, and notify upstream, if it does.



---

archive/issue_comments_409595.json:
```json
{
    "body": "see above - upgrading to the latest release 3.6.3 did not fix the problem. I'll check for unreleased fixes",
    "created_at": "2020-03-22T01:43:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28933",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28933#issuecomment-409595",
    "user": "@mkoeppe"
}
```

see above - upgrading to the latest release 3.6.3 did not fix the problem. I'll check for unreleased fixes



---

archive/issue_comments_409596.json:
```json
{
    "body": "Also in R trunk there is no error handling.",
    "created_at": "2020-03-22T01:45:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28933",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28933#issuecomment-409596",
    "user": "@mkoeppe"
}
```

Also in R trunk there is no error handling.



---

archive/issue_comments_409597.json:
```json
{
    "body": "https://github.com/wch/r-source/blob/trunk/configure.ac#L1108\nIn this situation, the macro `R_PROG_FC_CHAR_LEN_T` (from `m4/R.m4`) produces an empty `$r_cv_prog_fc_char_len_t`, which causes the compilation errors. Error checking should be added either in the macro or in the macro call.\n\nUpstream does not have an open bug reporting system. Perhaps an R user can communicate this problem to upstream.",
    "created_at": "2020-03-22T01:54:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28933",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28933#issuecomment-409597",
    "user": "@mkoeppe"
}
```

https://github.com/wch/r-source/blob/trunk/configure.ac#L1108
In this situation, the macro `R_PROG_FC_CHAR_LEN_T` (from `m4/R.m4`) produces an empty `$r_cv_prog_fc_char_len_t`, which causes the compilation errors. Error checking should be added either in the macro or in the macro call.

Upstream does not have an open bug reporting system. Perhaps an R user can communicate this problem to upstream.



---

archive/issue_comments_409598.json:
```json
{
    "body": "Shouldn't R also handle the need to add `-fPIC` in its ./configure ?",
    "created_at": "2020-03-22T02:01:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28933",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28933#issuecomment-409598",
    "user": "@dimpase"
}
```

Shouldn't R also handle the need to add `-fPIC` in its ./configure ?



---

archive/issue_comments_409599.json:
```json
{
    "body": "I don't really understand what's happening there. It may have to do with the way we compile the gfortran spkg. Note all of the platforms where the failure occured use system gcc but a gfortran from our spkg.",
    "created_at": "2020-03-22T02:05:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28933",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28933#issuecomment-409599",
    "user": "@mkoeppe"
}
```

I don't really understand what's happening there. It may have to do with the way we compile the gfortran spkg. Note all of the platforms where the failure occured use system gcc but a gfortran from our spkg.



---

archive/issue_comments_409600.json:
```json
{
    "body": "maybe our gfortran doesn't have the needed workaround in, or perhaps there is a gfortran's default that needs to be turned on at gfortran's build time?",
    "created_at": "2020-03-22T02:10:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28933",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28933#issuecomment-409600",
    "user": "@dimpase"
}
```

maybe our gfortran doesn't have the needed workaround in, or perhaps there is a gfortran's default that needs to be turned on at gfortran's build time?



---

archive/issue_comments_409601.json:
```json
{
    "body": "Maybe we should get rid of our gfortran instead of R, at least on the various linux distributions where there are other sane alternatives.",
    "created_at": "2020-03-22T02:11:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28933",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28933#issuecomment-409601",
    "user": "@jhpalmieri"
}
```

Maybe we should get rid of our gfortran instead of R, at least on the various linux distributions where there are other sane alternatives.



---

archive/issue_comments_409602.json:
```json
{
    "body": "there are unfortunate souls that need Sage running on HPC systems, which often have quite outdated software and non-responsive or just absent sysadmins, and so they need to build Sage's toolchain.\n\nI'd spin out the toolchain in a separate package.",
    "created_at": "2020-03-22T02:17:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28933",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28933#issuecomment-409602",
    "user": "@dimpase"
}
```

there are unfortunate souls that need Sage running on HPC systems, which often have quite outdated software and non-responsive or just absent sysadmins, and so they need to build Sage's toolchain.

I'd spin out the toolchain in a separate package.



---

archive/issue_comments_409603.json:
```json
{
    "body": "I think this is a working fix. I would not want to get rid of the sage distribution's ability to install gfortran. Lots of poorly maintained Linux boxes in universities everywhere.\n\nAnd we already advertise the distribution packages for gfortran and R.",
    "created_at": "2020-03-22T02:17:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28933",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28933#issuecomment-409603",
    "user": "@mkoeppe"
}
```

I think this is a working fix. I would not want to get rid of the sage distribution's ability to install gfortran. Lots of poorly maintained Linux boxes in universities everywhere.

And we already advertise the distribution packages for gfortran and R.



---

archive/issue_comments_409604.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-03-22T03:18:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28933",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28933#issuecomment-409604",
    "user": "@mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_409605.json:
```json
{
    "body": "Tests run at https://github.com/mkoeppe/sage/actions/runs/60588138",
    "created_at": "2020-03-22T03:20:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28933",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28933#issuecomment-409605",
    "user": "@mkoeppe"
}
```

Tests run at https://github.com/mkoeppe/sage/actions/runs/60588138



---

archive/issue_comments_409606.json:
```json
{
    "body": "This seems to fix the problem. See for example for `ubuntu-bionic-minimal` at https://github.com/mkoeppe/sage/runs/524868489\n\nNeeds review",
    "created_at": "2020-03-22T15:15:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28933",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28933#issuecomment-409606",
    "user": "@mkoeppe"
}
```

This seems to fix the problem. See for example for `ubuntu-bionic-minimal` at https://github.com/mkoeppe/sage/runs/524868489

Needs review



---

archive/issue_comments_409607.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-03-22T17:11:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28933",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28933#issuecomment-409607",
    "user": "@dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_409608.json:
```json
{
    "body": "ok, it works.",
    "created_at": "2020-03-22T17:11:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28933",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28933#issuecomment-409608",
    "user": "@dimpase"
}
```

ok, it works.



---

archive/issue_comments_409609.json:
```json
{
    "body": "Thanks!",
    "created_at": "2020-03-22T17:43:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28933",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28933#issuecomment-409609",
    "user": "@mkoeppe"
}
```

Thanks!



---

archive/issue_comments_409610.json:
```json
{
    "body": "`R_PROG_FC_CHAR_LEN_T` might be buggy, it does not use any \"normal\" autoconf macros for test programs, doing instead pure shell.",
    "created_at": "2020-03-22T18:04:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28933",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28933#issuecomment-409610",
    "user": "@dimpase"
}
```

`R_PROG_FC_CHAR_LEN_T` might be buggy, it does not use any "normal" autoconf macros for test programs, doing instead pure shell.



---

archive/issue_comments_409611.json:
```json
{
    "body": "Replying to [comment:33 dimpase]:\n> `R_PROG_FC_CHAR_LEN_T` might be buggy, it does not use any \"normal\" autoconf macros for test programs, doing instead pure shell.\n\nI think you're right and we would wind up with `-fPIC` added for this one check if they had used the autotools magic. Adding `-fPIC` globally works around the issue, but isn't a good long-term solution (Case 3 in https://wiki.gentoo.org/wiki/Project:AMD64/Fixing_-fPIC_Errors_Guide).\n\nSince the compile/link command is hard-coded into `R_PROG_FC_CHAR_LEN_T`, can we append `-fPIC` for just the one check? Then upstream should be able to either do the same thing, or use some autotools stuff to fix it in the future.",
    "created_at": "2020-03-23T18:27:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28933",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28933#issuecomment-409611",
    "user": "@orlitzky"
}
```

Replying to [comment:33 dimpase]:
> `R_PROG_FC_CHAR_LEN_T` might be buggy, it does not use any "normal" autoconf macros for test programs, doing instead pure shell.

I think you're right and we would wind up with `-fPIC` added for this one check if they had used the autotools magic. Adding `-fPIC` globally works around the issue, but isn't a good long-term solution (Case 3 in https://wiki.gentoo.org/wiki/Project:AMD64/Fixing_-fPIC_Errors_Guide).

Since the compile/link command is hard-coded into `R_PROG_FC_CHAR_LEN_T`, can we append `-fPIC` for just the one check? Then upstream should be able to either do the same thing, or use some autotools stuff to fix it in the future.



---

archive/issue_comments_409612.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-03-25T22:48:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28933",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28933#issuecomment-409612",
    "user": "@vbraun"
}
```

Resolution: fixed
