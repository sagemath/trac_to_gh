# Issue 20994: improve FriCAS interface

archive/issues_020994.json:
```json
{
    "body": "CC:  bpage @hemmecke @dkrenn @dimpase\n\nKeywords: FriCAS\n\nThe FriCAS interface is currently very rudimentary.  In particular, converting the results of a computation into sage types is available only in very few special cases.\n\nIssue created by migration from https://trac.sagemath.org/ticket/21231\n\n",
    "created_at": "2016-08-12T11:05:04Z",
    "labels": [
        "component: interfaces"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.4",
    "title": "improve FriCAS interface",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20994",
    "user": "https://github.com/mantepse"
}
```
CC:  bpage @hemmecke @dkrenn @dimpase

Keywords: FriCAS

The FriCAS interface is currently very rudimentary.  In particular, converting the results of a computation into sage types is available only in very few special cases.

Issue created by migration from https://trac.sagemath.org/ticket/21231





---

archive/issue_comments_290364.json:
```json
{
    "body": "1) implement a method that (reliably!) yields a tuple `(type, 1d algebra output, 2d algebra output, error message, etc)` as strings.  `1d algebra output` should come in \"unparsed inputform\" as one very long string, I'd say.  `2d algebra output` should be empty if 1d output is available.\n\nIt should be able to deal with very long lines, too, possibly be using file io.  This involves use of ioHook and some regexps.\n\n2) implement a method that translates fricas output into sage types.\n\nI think this could work as follows: we want to map fricas types to sage constructors, possibly recursively.  Recall that what's really sent to fricas is something like `\"sage23 := [x<sup>n/y</sup>n for n in 1..3]\"`, so that sage can access the result using the variable `\"sage23\"`.  This string is referred to as `self._name`\n\nNow what I propose is a method which takes a parsed type, e.g., `\"Integer\"` or `(\"List\", \"Integer\")` or \n`(\"UnivariatePolynomial\", \"x\", (\"Fraction\", \"Integer\"))`\n\n```\ndef to_sage(type):\n    if type == \"Integer\":\n         return to_sage_integer()\n    elif type == \"String\":\n         return to_sage_string()\n    ...\n    elif isinstance(type, tuple):\n        if type[0] == \"List\":\n            return to_sage_list(type[1])\n        elif type[0] == \"Fraction\":\n            return to_sage_fraction(type[1])\n        ....\n```\n\nand so on.\n\nSo, if the type is `(\"List\" (\"Fraction\" (\"UnivariatePolynomial\" \"x\" \"Integer\")))`, this method would call\n\n```\n    to_sage_list((\"Fraction\" (\"UnivariatePolynomial\" \"x\" \"Integer\"))\n```\n\nwhich might be something like\n\n```\ndef to_sage_list(self, type):\n    n = fricas.eval(\"#\" + self._name).to_sage_integer()\n    return [fricas.eval(self._name + \".%n\").to_sage(type) for n in range(1,n+1)]\n```",
    "created_at": "2016-08-12T11:08:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290364",
    "user": "https://github.com/mantepse"
}
```

1) implement a method that (reliably!) yields a tuple `(type, 1d algebra output, 2d algebra output, error message, etc)` as strings.  `1d algebra output` should come in "unparsed inputform" as one very long string, I'd say.  `2d algebra output` should be empty if 1d output is available.

It should be able to deal with very long lines, too, possibly be using file io.  This involves use of ioHook and some regexps.

2) implement a method that translates fricas output into sage types.

I think this could work as follows: we want to map fricas types to sage constructors, possibly recursively.  Recall that what's really sent to fricas is something like `"sage23 := [x<sup>n/y</sup>n for n in 1..3]"`, so that sage can access the result using the variable `"sage23"`.  This string is referred to as `self._name`

Now what I propose is a method which takes a parsed type, e.g., `"Integer"` or `("List", "Integer")` or 
`("UnivariatePolynomial", "x", ("Fraction", "Integer"))`

```
def to_sage(type):
    if type == "Integer":
         return to_sage_integer()
    elif type == "String":
         return to_sage_string()
    ...
    elif isinstance(type, tuple):
        if type[0] == "List":
            return to_sage_list(type[1])
        elif type[0] == "Fraction":
            return to_sage_fraction(type[1])
        ....
```

and so on.

So, if the type is `("List" ("Fraction" ("UnivariatePolynomial" "x" "Integer")))`, this method would call

```
    to_sage_list(("Fraction" ("UnivariatePolynomial" "x" "Integer"))
```

which might be something like

```
def to_sage_list(self, type):
    n = fricas.eval("#" + self._name).to_sage_integer()
    return [fricas.eval(self._name + ".%n").to_sage(type) for n in range(1,n+1)]
```



---

archive/issue_comments_290365.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2016-08-12T11:08:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290365",
    "user": "https://github.com/mantepse"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_290366.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-08-12T23:37:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290366",
    "user": "https://github.com/mantepse"
}
```

New commits:



---

archive/issue_comments_290367.json:
```json
{
    "body": "This is very beta, but I'd be very happy to receive some comments.",
    "created_at": "2016-08-12T23:38:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290367",
    "user": "https://github.com/mantepse"
}
```

This is very beta, but I'd be very happy to receive some comments.



---

archive/issue_comments_290368.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-08-12T23:51:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290368",
    "user": "https://github.com/mantepse"
}
```

New commits:



---

archive/issue_comments_290369.json:
```json
{
    "body": "Branch name doesn't have leading slash\n\n---\nNew commits:",
    "created_at": "2016-08-13T21:04:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290369",
    "user": "https://github.com/vbraun"
}
```

Branch name doesn't have leading slash

---
New commits:



---

archive/issue_comments_290370.json:
```json
{
    "body": "Replying to [comment:6 vbraun]:\n> Branch name doesn't have leading slash\n\n\nHowto?  I used\n\n```\ngit push --set-upstream trac HEAD:u/mantepse/21231\n```",
    "created_at": "2016-08-14T07:54:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290370",
    "user": "https://github.com/mantepse"
}
```

Replying to [comment:6 vbraun]:
> Branch name doesn't have leading slash


Howto?  I used

```
git push --set-upstream trac HEAD:u/mantepse/21231
```



---

archive/issue_comments_290371.json:
```json
{
    "body": "Replying to [comment:7 mantepse]:\n> Replying to [comment:6 vbraun]:\n> > Branch name doesn't have leading slash\n\n> \n> Howto?  I used\n> \n> \n> ```\n> git push --set-upstream trac HEAD:u/mantepse/21231\n> ```\n\nThis is fine, this does not do anything to the webpage contents. You made a typo, this leading slash, while editing the latter.",
    "created_at": "2016-08-14T09:56:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290371",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:7 mantepse]:
> Replying to [comment:6 vbraun]:
> > Branch name doesn't have leading slash

> 
> Howto?  I used
> 
> 
> ```
> git push --set-upstream trac HEAD:u/mantepse/21231
> ```

This is fine, this does not do anything to the webpage contents. You made a typo, this leading slash, while editing the latter.



---

archive/issue_comments_290372.json:
```json
{
    "body": "(it actually doesn't depend on #21209, since it works with any installation of FriCAS but never mind)",
    "created_at": "2016-08-14T15:28:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290372",
    "user": "https://github.com/mantepse"
}
```

(it actually doesn't depend on #21209, since it works with any installation of FriCAS but never mind)



---

archive/issue_comments_290373.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-14T15:54:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290373",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290374.json:
```json
{
    "body": "Sage worksheet under 7.2",
    "created_at": "2016-08-15T01:59:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290374",
    "user": "https://trac.sagemath.org/admin/accounts/users/bpage"
}
```

Sage worksheet under 7.2



---

archive/issue_comments_290375.json:
```json
{
    "body": "Attachment [sage-7.4.beta0-fricas.pdf](tarball://root/attachments/some-uuid/ticket21231/sage-7.4.beta0-fricas.pdf) by bpage created at 2016-08-15 02:01:17\n\nSage worksheet under 7.4.beta0 (typeset output fails)",
    "created_at": "2016-08-15T02:01:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290375",
    "user": "https://trac.sagemath.org/admin/accounts/users/bpage"
}
```

Attachment [sage-7.4.beta0-fricas.pdf](tarball://root/attachments/some-uuid/ticket21231/sage-7.4.beta0-fricas.pdf) by bpage created at 2016-08-15 02:01:17

Sage worksheet under 7.4.beta0 (typeset output fails)



---

archive/issue_comments_290376.json:
```json
{
    "body": "In Sage Worksheet typeset output or FriCAS object fails with this patch on 7.4.beta0.  See attached pdf files.\n\nhttps://trac.sagemath.org/attachment/ticket/21231/sage-7.2-fricas.pdf  (typeset output OK)\n\nhttps://trac.sagemath.org/attachment/ticket/21231/sage-7.4.beta0-fricas.pdf  (typeset output fails)\n\nI am not sure whether or not this example worked under 7.4.beta0 without the patch.",
    "created_at": "2016-08-15T02:07:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290376",
    "user": "https://trac.sagemath.org/admin/accounts/users/bpage"
}
```

In Sage Worksheet typeset output or FriCAS object fails with this patch on 7.4.beta0.  See attached pdf files.

https://trac.sagemath.org/attachment/ticket/21231/sage-7.2-fricas.pdf  (typeset output OK)

https://trac.sagemath.org/attachment/ticket/21231/sage-7.4.beta0-fricas.pdf  (typeset output fails)

I am not sure whether or not this example worked under 7.4.beta0 without the patch.



---

archive/issue_comments_290377.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-15T09:37:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290377",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290378.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-16T00:07:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290378",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290379.json:
```json
{
    "body": "I have a question about the `_fricas_init_` and `_fricas_` methods\ndefined in various files, in particular in\n`~/sage-develop/src/sage/rings/rational_field.py` and `in\n~/sage-develop/src/sage/rings/real_mpfr.pyx`, see below.\n\nThe question is: the doctests work without adapting the methods.\nWhat are the methods supposed to do?\n\n`~/sage-develop/src/sage/rings/rational_field.py`\n\n```\n    def _axiom_init_(self):\n        r\"\"\"\n        Return the axiom/fricas representation of `\\QQ`.\n\n        EXAMPLES::\n\n           sage: axiom(QQ)    #optional - axiom # indirect doctest\n           Fraction Integer\n           sage: fricas(QQ)   #optional - fricas # indirect doctest\n           Fraction(Integer)\n\n        \"\"\"\n        return 'Fraction Integer'\n\n    _fricas_init_ = _axiom_init_\n```\n\n\n\nin `~/sage-develop/src/sage/rings/real_mpfr.pyx`\n\n```\n    def _axiom_(self, axiom):\n        \"\"\"\n        Return ``self`` as a floating point number in Axiom.\n\n        EXAMPLES::\n\n            sage: R = RealField(100)\n            sage: R(pi)\n            3.1415926535897932384626433833\n            sage: axiom(R(pi))  # optional - axiom # indirect doctest\n            3.1415926535 8979323846 26433833\n            sage: fricas(R(pi)) # optional - fricas\n            3.1415926535_8979323846_26433833\n\n        \"\"\"\n        prec = self.parent().prec()\n\n        #Set the precision in Axiom\n        old_prec = axiom('precision(%s)$Float'%prec)\n        res = axiom('%s :: Float'%self.exact_rational())\n        axiom.eval('precision(%s)$Float'%old_prec)\n\n        return res\n\n    _fricas_ = _axiom_\n```",
    "created_at": "2016-08-16T00:09:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290379",
    "user": "https://github.com/mantepse"
}
```

I have a question about the `_fricas_init_` and `_fricas_` methods
defined in various files, in particular in
`~/sage-develop/src/sage/rings/rational_field.py` and `in
~/sage-develop/src/sage/rings/real_mpfr.pyx`, see below.

The question is: the doctests work without adapting the methods.
What are the methods supposed to do?

`~/sage-develop/src/sage/rings/rational_field.py`

```
    def _axiom_init_(self):
        r"""
        Return the axiom/fricas representation of `\QQ`.

        EXAMPLES::

           sage: axiom(QQ)    #optional - axiom # indirect doctest
           Fraction Integer
           sage: fricas(QQ)   #optional - fricas # indirect doctest
           Fraction(Integer)

        """
        return 'Fraction Integer'

    _fricas_init_ = _axiom_init_
```



in `~/sage-develop/src/sage/rings/real_mpfr.pyx`

```
    def _axiom_(self, axiom):
        """
        Return ``self`` as a floating point number in Axiom.

        EXAMPLES::

            sage: R = RealField(100)
            sage: R(pi)
            3.1415926535897932384626433833
            sage: axiom(R(pi))  # optional - axiom # indirect doctest
            3.1415926535 8979323846 26433833
            sage: fricas(R(pi)) # optional - fricas
            3.1415926535_8979323846_26433833

        """
        prec = self.parent().prec()

        #Set the precision in Axiom
        old_prec = axiom('precision(%s)$Float'%prec)
        res = axiom('%s :: Float'%self.exact_rational())
        axiom.eval('precision(%s)$Float'%old_prec)

        return res

    _fricas_ = _axiom_
```



---

archive/issue_comments_290380.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-16T00:58:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290380",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290381.json:
```json
{
    "body": "The once missing thing is the error handling.  I was expecting that raising an error in `eval` would be sufficient, as indicated by the patch below.  However, if I then do `fricas(\"something stupid\")`, no error is raised.  What am I doing wrong?\n\n```\n--- a/src/sage/interfaces/fricas.py\n+++ b/src/sage/interfaces/fricas.py\n@@ -385,8 +385,7 @@ class FriCAS(ExtraTabCompletion, Expect):\n                 return \"\\r\\n\".join(line[FRICAS_MULTI_LINE_START:] for line in lines)\n \n         else:\n-            print(output)\n-            return\n+            raise RuntimeError(\"FriCAS has not recognized '%s' as a valid operation: %s\" % (code, output))\n \n     def set(self, var, value):\n         \"\"\"Set the variable var to the given value.\n```",
    "created_at": "2016-08-16T01:48:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290381",
    "user": "https://github.com/mantepse"
}
```

The once missing thing is the error handling.  I was expecting that raising an error in `eval` would be sufficient, as indicated by the patch below.  However, if I then do `fricas("something stupid")`, no error is raised.  What am I doing wrong?

```
--- a/src/sage/interfaces/fricas.py
+++ b/src/sage/interfaces/fricas.py
@@ -385,8 +385,7 @@ class FriCAS(ExtraTabCompletion, Expect):
                 return "\r\n".join(line[FRICAS_MULTI_LINE_START:] for line in lines)
 
         else:
-            print(output)
-            return
+            raise RuntimeError("FriCAS has not recognized '%s' as a valid operation: %s" % (code, output))
 
     def set(self, var, value):
         """Set the variable var to the given value.
```



---

archive/issue_comments_290382.json:
```json
{
    "body": "Calling `fricas(\"something stupid\")` ends up in `fricas.set` which calls `expect._eval_line` not `fricas.eval`.  This interface stuff is truly twisted. Check especially the inheritance.  `FriCAS` inherits from `Expect` that inherits `Interface`. Check `__call__` and `_create` in `Interface` and go from there.\n\n`fricas.py` should probably override `_eval_line` in the same way as `axiom.py`.",
    "created_at": "2016-08-16T12:16:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290382",
    "user": "https://trac.sagemath.org/admin/accounts/users/bpage"
}
```

Calling `fricas("something stupid")` ends up in `fricas.set` which calls `expect._eval_line` not `fricas.eval`.  This interface stuff is truly twisted. Check especially the inheritance.  `FriCAS` inherits from `Expect` that inherits `Interface`. Check `__call__` and `_create` in `Interface` and go from there.

`fricas.py` should probably override `_eval_line` in the same way as `axiom.py`.



---

archive/issue_comments_290383.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-16T17:56:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290383",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290384.json:
```json
{
    "body": "`fricas.py` used to inherit some functions from `axiom.py`. The new version no longer uses any part of the Axiom interface. One of the casualties of this change was `_latex_` from `PanAxiomElement`. The function `_latex_` is responsible for producing LaTeX output in typeset mode.  The following patch incorporates the `_latex_` function from `axiom.py` and corrects the problem reported above in #21231#comment:12\n\n\n```\ndiff --git a/src/sage/interfaces/fricas.py b/src/sage/interfaces/fricas.py\nindex 8831c6c..5c1bc64 100644\n--- a/src/sage/interfaces/fricas.py\n+++ b/src/sage/interfaces/fricas.py\n@@ -201,6 +201,7 @@ from __future__ import print_function\n \n from sage.interfaces.tab_completion import ExtraTabCompletion\n from sage.interfaces.expect import Expect, ExpectElement, FunctionElement, ExpectFunction\n+from sage.misc.multireplace import multiple_replace\n from sage.env import DOT_SAGE\n import re\n import six\n@@ -571,6 +572,31 @@ class FriCASElement(ExpectElement):\n             raise IndexError(\"index out of range\")\n         return self.elt(n+1)\n \n+    def _latex_(self):\n+        r\"\"\"\n+        EXAMPLES::\n+\n+            sage: a = fricas(1/2) #optional - fricas\n+            sage: latex(a)       #optional - fricas\n+             1 \\over 2\n+\n+        \"\"\"\n+        self._check_valid()\n+        P = self.parent()\n+        s = P._eval_line('outputAsTex(%s)'%self.name())\n+        if not '$$' in s:\n+            raise RuntimeError(\"Error texing axiom object.\")\n+        i = s.find('$$')\n+        j = s.rfind('$$')\n+        s = s[i+2:j]\n+        s = multiple_replace({'\\r':'', '\\n':' ',\n+                              ' \\\\sp ':'^',\n+                              '\\\\arcsin ':'\\\\sin^{-1} ',\n+                              '\\\\arccos ':'\\\\cos^{-1} ',\n+                              '\\\\arctan ':'\\\\tan^{-1} '},\n+            re.sub(r'\\\\leqno\\(.*?\\)','',s)) # no eq number!\n+        return s\n+\n     def __int__(self):\n         return int(self.sage())\n```\n\nI am not sure of the relevance of the particular substitutions that were performed by the old `axiom.py` code.\n\nSorry for just including a patch but I am not sure whether or not I could have just pushed this change to trac since this branch seems to be private.",
    "created_at": "2016-08-16T21:26:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290384",
    "user": "https://trac.sagemath.org/admin/accounts/users/bpage"
}
```

`fricas.py` used to inherit some functions from `axiom.py`. The new version no longer uses any part of the Axiom interface. One of the casualties of this change was `_latex_` from `PanAxiomElement`. The function `_latex_` is responsible for producing LaTeX output in typeset mode.  The following patch incorporates the `_latex_` function from `axiom.py` and corrects the problem reported above in #21231#comment:12


```
diff --git a/src/sage/interfaces/fricas.py b/src/sage/interfaces/fricas.py
index 8831c6c..5c1bc64 100644
--- a/src/sage/interfaces/fricas.py
+++ b/src/sage/interfaces/fricas.py
@@ -201,6 +201,7 @@ from __future__ import print_function
 
 from sage.interfaces.tab_completion import ExtraTabCompletion
 from sage.interfaces.expect import Expect, ExpectElement, FunctionElement, ExpectFunction
+from sage.misc.multireplace import multiple_replace
 from sage.env import DOT_SAGE
 import re
 import six
@@ -571,6 +572,31 @@ class FriCASElement(ExpectElement):
             raise IndexError("index out of range")
         return self.elt(n+1)
 
+    def _latex_(self):
+        r"""
+        EXAMPLES::
+
+            sage: a = fricas(1/2) #optional - fricas
+            sage: latex(a)       #optional - fricas
+             1 \over 2
+
+        """
+        self._check_valid()
+        P = self.parent()
+        s = P._eval_line('outputAsTex(%s)'%self.name())
+        if not '$$' in s:
+            raise RuntimeError("Error texing axiom object.")
+        i = s.find('$$')
+        j = s.rfind('$$')
+        s = s[i+2:j]
+        s = multiple_replace({'\r':'', '\n':' ',
+                              ' \\sp ':'^',
+                              '\\arcsin ':'\\sin^{-1} ',
+                              '\\arccos ':'\\cos^{-1} ',
+                              '\\arctan ':'\\tan^{-1} '},
+            re.sub(r'\\leqno\(.*?\)','',s)) # no eq number!
+        return s
+
     def __int__(self):
         return int(self.sage())
```

I am not sure of the relevance of the particular substitutions that were performed by the old `axiom.py` code.

Sorry for just including a patch but I am not sure whether or not I could have just pushed this change to trac since this branch seems to be private.



---

archive/issue_comments_290385.json:
```json
{
    "body": "FriCAS uses\n\n```\nsage: fricas('asin(x)')\nasin(x)\nsage: fricas('acos(x)')\nacos(x)\nsage: fricas('atan(x)')\natan(x)\n```\n\nSage replaces `asin`, `acos` and `atan` with `arcsin`, `arccos` and `arctan`\n\n```\nsage: asin(x)\narcsin(x)\nsage: acos(x)\narccos(x)\nsage: atan(x)\narctan(x)\n```\n\nBut FriCAS does not use these names so the following results in an error:\n\n```\nsage: fricas(asin(x))\n...\n   There are no library operations named arcsin \n      Use HyperDoc Browse or issue\n                                                                                                                   )what op arctan\n      to learn if there is any operation containing \" arctan \" in its name.\n ...\nsage: fricas(acos(x))\n...\n   There are no library operations named arccos \n      Use HyperDoc Browse or issue\n                                                                                                                   )what op arctan\n      to learn if there is any operation containing \" arctan \" in its name.\n ...\nsage: fricas(atan(x))\n...\n   There are no library operations named arctan \n      Use HyperDoc Browse or issue\n                                                                                                                   )what op arctan\n      to learn if there is any operation containing \" arctan \" in its name.\n ...\n```",
    "created_at": "2016-08-16T22:30:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290385",
    "user": "https://trac.sagemath.org/admin/accounts/users/bpage"
}
```

FriCAS uses

```
sage: fricas('asin(x)')
asin(x)
sage: fricas('acos(x)')
acos(x)
sage: fricas('atan(x)')
atan(x)
```

Sage replaces `asin`, `acos` and `atan` with `arcsin`, `arccos` and `arctan`

```
sage: asin(x)
arcsin(x)
sage: acos(x)
arccos(x)
sage: atan(x)
arctan(x)
```

But FriCAS does not use these names so the following results in an error:

```
sage: fricas(asin(x))
...
   There are no library operations named arcsin 
      Use HyperDoc Browse or issue
                                                                                                                   )what op arctan
      to learn if there is any operation containing " arctan " in its name.
 ...
sage: fricas(acos(x))
...
   There are no library operations named arccos 
      Use HyperDoc Browse or issue
                                                                                                                   )what op arctan
      to learn if there is any operation containing " arctan " in its name.
 ...
sage: fricas(atan(x))
...
   There are no library operations named arctan 
      Use HyperDoc Browse or issue
                                                                                                                   )what op arctan
      to learn if there is any operation containing " arctan " in its name.
 ...
```



---

archive/issue_comments_290386.json:
```json
{
    "body": "> Sorry for just including a patch but I am not sure whether or not I could have just pushed this change to trac since this branch seems to be private.\n\n\nPutting patches here is perfect for me, actually!  Many thanks!",
    "created_at": "2016-08-17T08:09:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290386",
    "user": "https://github.com/mantepse"
}
```

> Sorry for just including a patch but I am not sure whether or not I could have just pushed this change to trac since this branch seems to be private.


Putting patches here is perfect for me, actually!  Many thanks!



---

archive/issue_comments_290387.json:
```json
{
    "body": "Replying to [comment:22 mantepse]:\n> > Sorry for just including a patch but I am not sure whether or not I could have just pushed this change to trac since this branch seems to be private.\n\n> \n> Putting patches here is perfect for me, actually!  Many thanks!\n\n\nalthough you could have just pushed your own (i.e. u/bpage) or public (i.e. public/) branch; then your commit(s) could be [cherry-picked](https://www.kernel.org/pub/software/scm/git/docs/git-cherry-pick.html). An advantage is that it's no error-prone cutting/pasting, (and it is known whom to [blame](https://www.kernel.org/pub/software/scm/git/docs/git-blame.html) :-)).",
    "created_at": "2016-08-17T08:23:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290387",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:22 mantepse]:
> > Sorry for just including a patch but I am not sure whether or not I could have just pushed this change to trac since this branch seems to be private.

> 
> Putting patches here is perfect for me, actually!  Many thanks!


although you could have just pushed your own (i.e. u/bpage) or public (i.e. public/) branch; then your commit(s) could be [cherry-picked](https://www.kernel.org/pub/software/scm/git/docs/git-cherry-pick.html). An advantage is that it's no error-prone cutting/pasting, (and it is known whom to [blame](https://www.kernel.org/pub/software/scm/git/docs/git-blame.html) :-)).



---

archive/issue_comments_290388.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-17T13:42:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290388",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290389.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-08-17T13:42:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290389",
    "user": "https://github.com/mantepse"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_290390.json:
```json
{
    "body": "Typeset output from FriCAS in the notebook is not working. Apparently the most recent commit is still missing `_latex_`.",
    "created_at": "2016-08-17T15:09:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290390",
    "user": "https://trac.sagemath.org/admin/accounts/users/bpage"
}
```

Typeset output from FriCAS in the notebook is not working. Apparently the most recent commit is still missing `_latex_`.



---

archive/issue_comments_290391.json:
```json
{
    "body": "I think the markers `|startKeyedMsg|` and `|endOfKeyedMsg|` look strange in the error message and traceback. In the notebook only `|endOfKeyedMsg|` is shown as the output until clicking to expand the traceback. These markers should probably be removed from the output before displaying the message to the user.",
    "created_at": "2016-08-17T15:52:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290391",
    "user": "https://trac.sagemath.org/admin/accounts/users/bpage"
}
```

I think the markers `|startKeyedMsg|` and `|endOfKeyedMsg|` look strange in the error message and traceback. In the notebook only `|endOfKeyedMsg|` is shown as the output until clicking to expand the traceback. These markers should probably be removed from the output before displaying the message to the user.



---

archive/issue_comments_290392.json:
```json
{
    "body": "Thanks for reminding me of LaTeX, I'm embarassed - I forgot!\n\nRemoving `|startKeyedMsg|` and `|endOfKeyedMsg|` and the like is not completely trivial, but I'll try!",
    "created_at": "2016-08-17T17:40:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290392",
    "user": "https://github.com/mantepse"
}
```

Thanks for reminding me of LaTeX, I'm embarassed - I forgot!

Removing `|startKeyedMsg|` and `|endOfKeyedMsg|` and the like is not completely trivial, but I'll try!



---

archive/issue_comments_290393.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-08-17T17:40:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290393",
    "user": "https://github.com/mantepse"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_290394.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-17T22:23:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290394",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290395.json:
```json
{
    "body": "Thanks, Martin. Here is a small patch that fixes a few problems with FriCAS-generated LaTeX. For example:\n\n```\nsage: latex(fricas(\"integrate(sin(x+1/x),x)\"))\n \\int ^{\\displaystyle x} {{\\sin  \\left( {{{{{ \\%A} ^{2}}+1} \\over \\%A}}  \\right)} \\  {d \\%A}}   \n\n```\n\nand also subscripts and subscripts in a few other cases.\n\n```\ndiff --git a/src/sage/interfaces/fricas.py b/src/sage/interfaces/fricas.py\nindex 8d2ac3f..594d5b8 100644\n--- a/src/sage/interfaces/fricas.py\n+++ b/src/sage/interfaces/fricas.py\n@@ -598,7 +598,10 @@ class FriCASElement(ExpectElement):\n         j = s.rfind('$$')\n         s = s[i+2:j]\n         s = multiple_replace({'\\r':'', '\\n':' ',\n-                              ' \\\\sp ':'^',\n+                              '\\\\sp ':'^',\n+                              '\\\\sp{':'^{',\n+                              '\\\\sb ':'_',\n+                              '\\\\sb{':'_{',\n                               '\\\\arcsin ':'\\\\sin^{-1} ',\n                               '\\\\arccos ':'\\\\cos^{-1} ',\n                               '\\\\arctan ':'\\\\tan^{-1} '},\n```",
    "created_at": "2016-08-17T22:46:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290395",
    "user": "https://trac.sagemath.org/admin/accounts/users/bpage"
}
```

Thanks, Martin. Here is a small patch that fixes a few problems with FriCAS-generated LaTeX. For example:

```
sage: latex(fricas("integrate(sin(x+1/x),x)"))
 \int ^{\displaystyle x} {{\sin  \left( {{{{{ \%A} ^{2}}+1} \over \%A}}  \right)} \  {d \%A}}   

```

and also subscripts and subscripts in a few other cases.

```
diff --git a/src/sage/interfaces/fricas.py b/src/sage/interfaces/fricas.py
index 8d2ac3f..594d5b8 100644
--- a/src/sage/interfaces/fricas.py
+++ b/src/sage/interfaces/fricas.py
@@ -598,7 +598,10 @@ class FriCASElement(ExpectElement):
         j = s.rfind('$$')
         s = s[i+2:j]
         s = multiple_replace({'\r':'', '\n':' ',
-                              ' \\sp ':'^',
+                              '\\sp ':'^',
+                              '\\sp{':'^{',
+                              '\\sb ':'_',
+                              '\\sb{':'_{',
                               '\\arcsin ':'\\sin^{-1} ',
                               '\\arccos ':'\\cos^{-1} ',
                               '\\arctan ':'\\tan^{-1} '},
```



---

archive/issue_comments_290396.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-17T23:23:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290396",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290397.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-08-17T23:27:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290397",
    "user": "https://github.com/mantepse"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_290398.json:
```json
{
    "body": "Hi Bill,\n\nI don't understand your patch: why would you replace `\\sp{` by `^{` if you replace `\\sp` by `^` anyway.  Also, isn't `\\sp` valid LaTeX?\n\nBut more importantly: shouldn't this patch really applied to FriCAS itself?",
    "created_at": "2016-08-18T06:31:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290398",
    "user": "https://github.com/mantepse"
}
```

Hi Bill,

I don't understand your patch: why would you replace `\sp{` by `^{` if you replace `\sp` by `^` anyway.  Also, isn't `\sp` valid LaTeX?

But more importantly: shouldn't this patch really applied to FriCAS itself?



---

archive/issue_comments_290399.json:
```json
{
    "body": "Maybe tex.spad from my mathjax branch might be interesting. It spits out true latex.\nhttps://github.com/hemmecke/fricas/commits/mathjax\nBut maybe you really want mathjax or even 1d output of FriCAS objects, then look into\nmathjax.spad or 1d.spad. Most importantly, the output form can be changed at runtime.\n\nNote that these files are GPL3+ and are therefore not (yet) part of FriCAS.",
    "created_at": "2016-08-18T06:52:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290399",
    "user": "https://github.com/hemmecke"
}
```

Maybe tex.spad from my mathjax branch might be interesting. It spits out true latex.
https://github.com/hemmecke/fricas/commits/mathjax
But maybe you really want mathjax or even 1d output of FriCAS objects, then look into
mathjax.spad or 1d.spad. Most importantly, the output form can be changed at runtime.

Note that these files are GPL3+ and are therefore not (yet) part of FriCAS.



---

archive/issue_comments_290400.json:
```json
{
    "body": "Hi Bill and Ralf!\n\nI'd like to get this ticket in soon (and in particular, stop working on it very soon).  So if FriCAS produces only TeX currently, I'd like to leave it at this.  As soon as the new `tex.spad` is in FriCAS, we can pick it up here, OK?",
    "created_at": "2016-08-18T07:02:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290400",
    "user": "https://github.com/mantepse"
}
```

Hi Bill and Ralf!

I'd like to get this ticket in soon (and in particular, stop working on it very soon).  So if FriCAS produces only TeX currently, I'd like to leave it at this.  As soon as the new `tex.spad` is in FriCAS, we can pick it up here, OK?



---

archive/issue_comments_290401.json:
```json
{
    "body": "> {{{\n>                                '\\\\arcsin ':'\\\\sin^{-1} ',\n>                                '\\\\arccos ':'\\\\cos^{-1} ',\n>                                '\\\\arctan ':'\\\\tan^{-1} '},\n> }}}\n\n\nanother question: why are you replacing `\\arctan` and friends? As far as I know, this is perfectyl valid LaTeX, no?",
    "created_at": "2016-08-18T07:04:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290401",
    "user": "https://github.com/mantepse"
}
```

> {{{
>                                '\\arcsin ':'\\sin^{-1} ',
>                                '\\arccos ':'\\cos^{-1} ',
>                                '\\arctan ':'\\tan^{-1} '},
> }}}


another question: why are you replacing `\arctan` and friends? As far as I know, this is perfectyl valid LaTeX, no?



---

archive/issue_comments_290402.json:
```json
{
    "body": "Yes, it is. And given the usual meaning of sin<sup>2</sup>(x) = (sin(x))<sup>2</sup> and not sin(sin(x)), I even think that writing sin<sup>(-1)</sup> for arcsin is even confusing, no?",
    "created_at": "2016-08-18T07:21:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290402",
    "user": "https://github.com/hemmecke"
}
```

Yes, it is. And given the usual meaning of sin<sup>2</sup>(x) = (sin(x))<sup>2</sup> and not sin(sin(x)), I even think that writing sin<sup>(-1)</sup> for arcsin is even confusing, no?



---

archive/issue_comments_290403.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-18T08:09:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290403",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290404.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-18T11:14:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290404",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290405.json:
```json
{
    "body": "Replying to [comment:34 mantepse]:\n> Hi Bill,\n> \n> I don't understand your patch: why would you replace `\\sp{` by `^{` if you replace `\\sp` by `^` anyway.\n\n\nNote the space `'\\sp '`. It is looking for termination of `\\sp`.\n\n> Also, isn't `\\sp` valid LaTeX?\n\n\nNot as far as I know - maybe TeX?  In any case it does not work in Sage notebook.\n\n> \n> But more importantly: shouldn't this patch really applied to\n> FriCAS itself?\n\n\nPerhaps.  Waldek would probably accept a patch to that effect.",
    "created_at": "2016-08-18T12:39:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290405",
    "user": "https://trac.sagemath.org/admin/accounts/users/bpage"
}
```

Replying to [comment:34 mantepse]:
> Hi Bill,
> 
> I don't understand your patch: why would you replace `\sp{` by `^{` if you replace `\sp` by `^` anyway.


Note the space `'\sp '`. It is looking for termination of `\sp`.

> Also, isn't `\sp` valid LaTeX?


Not as far as I know - maybe TeX?  In any case it does not work in Sage notebook.

> 
> But more importantly: shouldn't this patch really applied to
> FriCAS itself?


Perhaps.  Waldek would probably accept a patch to that effect.



---

archive/issue_comments_290406.json:
```json
{
    "body": "Replying to [comment:36 mantepse]:\n> Hi Bill and Ralf!\n> \n> I'd like to get this ticket in soon (and in particular, stop working on it very soon).  So if FriCAS produces only TeX currently, I'd like to leave it at this.  As soon as the new `tex.spad` is in FriCAS, we can pick it up here, OK?\n\n\nI think Waldek is unlikely to change his position on the exclusion of copyleft licensed code in FriCAS since FriCAS already has a more permissive license. Of course that does not prevent its inclusion in the FriCAS external package here if someone were so inclined.",
    "created_at": "2016-08-18T12:45:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290406",
    "user": "https://trac.sagemath.org/admin/accounts/users/bpage"
}
```

Replying to [comment:36 mantepse]:
> Hi Bill and Ralf!
> 
> I'd like to get this ticket in soon (and in particular, stop working on it very soon).  So if FriCAS produces only TeX currently, I'd like to leave it at this.  As soon as the new `tex.spad` is in FriCAS, we can pick it up here, OK?


I think Waldek is unlikely to change his position on the exclusion of copyleft licensed code in FriCAS since FriCAS already has a more permissive license. Of course that does not prevent its inclusion in the FriCAS external package here if someone were so inclined.



---

archive/issue_comments_290407.json:
```json
{
    "body": "Replying to [comment:37 mantepse]:\n\n> another question: why are you replacing `\\arctan` and friends? As far as I know, this is perfectyl valid LaTeX, no?\n\n\nYes. I agree with this change.  I just copied (with some reservations) what was added to the Axiom interface.",
    "created_at": "2016-08-18T12:47:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290407",
    "user": "https://trac.sagemath.org/admin/accounts/users/bpage"
}
```

Replying to [comment:37 mantepse]:

> another question: why are you replacing `\arctan` and friends? As far as I know, this is perfectyl valid LaTeX, no?


Yes. I agree with this change.  I just copied (with some reservations) what was added to the Axiom interface.



---

archive/issue_comments_290408.json:
```json
{
    "body": "Error output in Sage notebook still looks like this\n\n```\nfricas(\"something stupid\")\n\nTraceback (click to the left of this block for traceback)\n...\n```\n|endOfKeyedMsg|\nExpanded:\n\n```\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\n...\n  File \"/home/wspage/sage/local/lib/python2.7/site-packages/sage/interfaces/fricas.py\", line 399, in set\n    raise RuntimeError(\"An error occurred when FriCAS evaluated '%s': %s\" % (value, output))\nTypeError: An error occurred when FriCAS evaluated 'something stupid': |startKeyedMsg|\n   There are no library operations named something \n      Use HyperDoc Browse or issue\n                               )what op something\n      to learn if there is any operation containing \" something \" in its \n      name.\n \n   Cannot find a definition or applicable library operation named \n      something with argument type(s) \n                                Variable(stupid)\n      \n      Perhaps you should use \"@\" to indicate the required return type, or \n      \"$\" to specify which version of the function you need.\n```\n|endOfKeyedMsg|\n|startKeyedMsg|\n|endOfKeyedMsg|\n\nIt would be nice to get rid of `|startKeyedMsg|` and `|endOfKeyedMsg|` and include something more meaningful in the unexpanded version.",
    "created_at": "2016-08-18T12:55:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290408",
    "user": "https://trac.sagemath.org/admin/accounts/users/bpage"
}
```

Error output in Sage notebook still looks like this

```
fricas("something stupid")

Traceback (click to the left of this block for traceback)
...
```
|endOfKeyedMsg|
Expanded:

```
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
...
  File "/home/wspage/sage/local/lib/python2.7/site-packages/sage/interfaces/fricas.py", line 399, in set
    raise RuntimeError("An error occurred when FriCAS evaluated '%s': %s" % (value, output))
TypeError: An error occurred when FriCAS evaluated 'something stupid': |startKeyedMsg|
   There are no library operations named something 
      Use HyperDoc Browse or issue
                               )what op something
      to learn if there is any operation containing " something " in its 
      name.
 
   Cannot find a definition or applicable library operation named 
      something with argument type(s) 
                                Variable(stupid)
      
      Perhaps you should use "@" to indicate the required return type, or 
      "$" to specify which version of the function you need.
```
|endOfKeyedMsg|
|startKeyedMsg|
|endOfKeyedMsg|

It would be nice to get rid of `|startKeyedMsg|` and `|endOfKeyedMsg|` and include something more meaningful in the unexpanded version.



---

archive/issue_comments_290409.json:
```json
{
    "body": "Conversion of the following FriCAS result to Sage fails.\n\n```\nsage: fricas(\"integrate(sin(x+1/x),x)\")\n\n   x       2\n ++      %A  + 1\n |   sin(-------)d%A\n++          %A\n\nsage: fricas(\"integrate(sin(x+1/x),x)\").sage()\n...\nTypeError: Bad function call: integral(sin((x^2+1)/x),x: !!! :Symbol)\n```",
    "created_at": "2016-08-18T13:02:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290409",
    "user": "https://trac.sagemath.org/admin/accounts/users/bpage"
}
```

Conversion of the following FriCAS result to Sage fails.

```
sage: fricas("integrate(sin(x+1/x),x)")

   x       2
 ++      %A  + 1
 |   sin(-------)d%A
++          %A

sage: fricas("integrate(sin(x+1/x),x)").sage()
...
TypeError: Bad function call: integral(sin((x^2+1)/x),x: !!! :Symbol)
```



---

archive/issue_comments_290410.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-18T16:50:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290410",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290411.json:
```json
{
    "body": "Excellent, thanks! This now looks great to me.",
    "created_at": "2016-08-18T17:10:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290411",
    "user": "https://trac.sagemath.org/admin/accounts/users/bpage"
}
```

Excellent, thanks! This now looks great to me.



---

archive/issue_comments_290412.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-08-18T17:12:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290412",
    "user": "https://trac.sagemath.org/admin/accounts/users/bpage"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_290413.json:
```json
{
    "body": "Oops, I was a bit too hasty and enthusiastic. Just one last thing ...\n\nTry this in the sage --notebook\n\n```\n%fricas\nx+1\n```\nI see the following markers displayed\n\n```\n   x + 1\n```\nCan you get rid of the markers in this case too?",
    "created_at": "2016-08-18T17:26:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290413",
    "user": "https://trac.sagemath.org/admin/accounts/users/bpage"
}
```

Oops, I was a bit too hasty and enthusiastic. Just one last thing ...

Try this in the sage --notebook

```
%fricas
x+1
```
I see the following markers displayed

```
   x + 1
```
Can you get rid of the markers in this case too?



---

archive/issue_comments_290414.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-08-18T17:26:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290414",
    "user": "https://trac.sagemath.org/admin/accounts/users/bpage"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_290415.json:
```json
{
    "body": "if\n\n```\n%fricas\nx+1\n```\ndisplays the output of `fricas.eval(1+1)` instead of `fricas(1+1)`, this is going to be rather hard.  How could I find out?",
    "created_at": "2016-08-18T17:47:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290415",
    "user": "https://github.com/mantepse"
}
```

if

```
%fricas
x+1
```
displays the output of `fricas.eval(1+1)` instead of `fricas(1+1)`, this is going to be rather hard.  How could I find out?



---

archive/issue_comments_290416.json:
```json
{
    "body": "`fricas.eval` calls `_eval_line` inherited from `Expect`. Maybe you should just override it?",
    "created_at": "2016-08-18T18:05:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290416",
    "user": "https://trac.sagemath.org/admin/accounts/users/bpage"
}
```

`fricas.eval` calls `_eval_line` inherited from `Expect`. Maybe you should just override it?



---

archive/issue_comments_290417.json:
```json
{
    "body": "I wanted to avoid overriding `eval` and `_eval_line` because they do not have much description, so their expected behaviour is not completely clear to me.\n\nThe easy thing would be to have another option `reformat=True`, which sets `|$ioHook|` to `nil`, and call `eval` with `reformat=False` always...",
    "created_at": "2016-08-18T18:27:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290417",
    "user": "https://github.com/mantepse"
}
```

I wanted to avoid overriding `eval` and `_eval_line` because they do not have much description, so their expected behaviour is not completely clear to me.

The easy thing would be to have another option `reformat=True`, which sets `|$ioHook|` to `nil`, and call `eval` with `reformat=False` always...



---

archive/issue_comments_290418.json:
```json
{
    "body": "Well this is a slightly different but related topic: I prefer to treat Sage notebook cells beginning with `%fricas` like `.input` files rather than command lines. Because `.input` language syntax is somewhat more general it allows FriCAS code such as\n\n```\nfor i in 1..10 repeat\n  if i<5 then\n    output i\n  else\n    output i+1\n```\nI notice that you already have code that allows creation and execution of `.input` files for very long expressions.  Making `_eval_line` always create `.input` files would not be difficult if you override it in `fricas.py`.",
    "created_at": "2016-08-18T18:51:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290418",
    "user": "https://trac.sagemath.org/admin/accounts/users/bpage"
}
```

Well this is a slightly different but related topic: I prefer to treat Sage notebook cells beginning with `%fricas` like `.input` files rather than command lines. Because `.input` language syntax is somewhat more general it allows FriCAS code such as

```
for i in 1..10 repeat
  if i<5 then
    output i
  else
    output i+1
```
I notice that you already have code that allows creation and execution of `.input` files for very long expressions.  Making `_eval_line` always create `.input` files would not be difficult if you override it in `fricas.py`.



---

archive/issue_comments_290419.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-18T19:07:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290419",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290420.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2016-08-18T19:28:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290420",
    "user": "https://trac.sagemath.org/admin/accounts/users/bpage"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_290421.json:
```json
{
    "body": "Reviewer is now very happy. :)  Maybe we can consider `.input` format cells in a later ticket.",
    "created_at": "2016-08-18T19:28:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290421",
    "user": "https://trac.sagemath.org/admin/accounts/users/bpage"
}
```

Reviewer is now very happy. :)  Maybe we can consider `.input` format cells in a later ticket.



---

archive/issue_comments_290422.json:
```json
{
    "body": "There is actually an easy way to achieve what you want:\nFirst say:\n\n```\nfricas._eval_using_file_cutoff=30\n```\n(I don't know what a good value is.  Don't make it 0 or 1.)\nand then:\n\n```\n%fricas\nfor i in 100000..100010 repeat\n  if i<5 then\n    output i\n  else\n    output partition(i+1)\n```\n\nNote however, that the result will not be displayed one by one, but only after the full thing is finished.  I hate that.",
    "created_at": "2016-08-18T19:33:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290422",
    "user": "https://github.com/mantepse"
}
```

There is actually an easy way to achieve what you want:
First say:

```
fricas._eval_using_file_cutoff=30
```
(I don't know what a good value is.  Don't make it 0 or 1.)
and then:

```
%fricas
for i in 100000..100010 repeat
  if i<5 then
    output i
  else
    output partition(i+1)
```

Note however, that the result will not be displayed one by one, but only after the full thing is finished.  I hate that.



---

archive/issue_comments_290423.json:
```json
{
    "body": "Replying to [comment:56 mantepse]:\n> There is actually an easy way to achieve what you want:\n> First say:\n> \n> ```\n> fricas._eval_using_file_cutoff=30\n> ```\n> (I don't know what a good value is.  Don't make it 0 or 1.)\n\n\nNice!  In fact\n\n```\nfricas._eval_using_file_cutoff=1\n```\nseems to work for me.  Did you have a problem setting it to 1?\n\nI could be happy with just such a flag option, especially if it was a bit more obvious like:\n\n```\nfricas.inputFormat(true)\n```\nBut why not make it the default? Would you expect a serious performance issue?\n\n> \n> Note however, that the result will not be displayed one by one, but only after the full thing is finished.  I hate that.\n\n\nOf course, but this is not a problem in one of the most important uses: defining a long function.",
    "created_at": "2016-08-19T12:54:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290423",
    "user": "https://trac.sagemath.org/admin/accounts/users/bpage"
}
```

Replying to [comment:56 mantepse]:
> There is actually an easy way to achieve what you want:
> First say:
> 
> ```
> fricas._eval_using_file_cutoff=30
> ```
> (I don't know what a good value is.  Don't make it 0 or 1.)


Nice!  In fact

```
fricas._eval_using_file_cutoff=1
```
seems to work for me.  Did you have a problem setting it to 1?

I could be happy with just such a flag option, especially if it was a bit more obvious like:

```
fricas.inputFormat(true)
```
But why not make it the default? Would you expect a serious performance issue?

> 
> Note however, that the result will not be displayed one by one, but only after the full thing is finished.  I hate that.


Of course, but this is not a problem in one of the most important uses: defining a long function.



---

archive/issue_comments_290424.json:
```json
{
    "body": "> Nice!  In fact\n> \n> ```\n> fricas._eval_using_file_cutoff=1\n> ```\n> seems to work for me.  Did you have a problem setting it to 1?\n\n\nYes, but that might have been noise.\n\n> I could be happy with just such a flag option, especially if it was a bit more obvious like:\n> \n> ```\n> fricas.inputFormat(true)\n> ```\n\n\nNot sure yet, especially about the user interface.\n\n> But why not make it the default? Would you expect a serious performance issue?\n\n\nYes.\n\n> > Note however, that the result will not be displayed one by one, but only after the full thing is finished.  I hate that.\n\n> \n> Of course, but this is not a problem in one of the most important uses: defining a long function.\n\n\nIn case you have time there are two major things that remain to be done (on separate tickets):\n\n* find out how Waldek's fricas-as-library works.\n\n* find out how to make `fricas._eval_line` and `fricas.eval` print stuff they receive immediately, until a special marker is encountered.  (We can control the special marker via `|$ioHook|`, but for the moment let's pretend it is `|startAlgebraOutput|`.  To be honest, I don't even know whether this is possible.\n\nI don't want to modify this ticket much further, unless the patchbot requires me to do so, to have it merged soon.",
    "created_at": "2016-08-19T13:14:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290424",
    "user": "https://github.com/mantepse"
}
```

> Nice!  In fact
> 
> ```
> fricas._eval_using_file_cutoff=1
> ```
> seems to work for me.  Did you have a problem setting it to 1?


Yes, but that might have been noise.

> I could be happy with just such a flag option, especially if it was a bit more obvious like:
> 
> ```
> fricas.inputFormat(true)
> ```


Not sure yet, especially about the user interface.

> But why not make it the default? Would you expect a serious performance issue?


Yes.

> > Note however, that the result will not be displayed one by one, but only after the full thing is finished.  I hate that.

> 
> Of course, but this is not a problem in one of the most important uses: defining a long function.


In case you have time there are two major things that remain to be done (on separate tickets):

* find out how Waldek's fricas-as-library works.

* find out how to make `fricas._eval_line` and `fricas.eval` print stuff they receive immediately, until a special marker is encountered.  (We can control the special marker via `|$ioHook|`, but for the moment let's pretend it is `|startAlgebraOutput|`.  To be honest, I don't even know whether this is possible.

I don't want to modify this ticket much further, unless the patchbot requires me to do so, to have it merged soon.



---

archive/issue_comments_290425.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2016-08-19T13:39:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290425",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_290426.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2016-08-19T13:39:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290426",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_290427.json:
```json
{
    "body": "I only changed *really* minor documentation stuff.",
    "created_at": "2016-08-19T18:26:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290427",
    "user": "https://github.com/mantepse"
}
```

I only changed *really* minor documentation stuff.



---

archive/issue_comments_290428.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-08-19T18:26:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290428",
    "user": "https://github.com/mantepse"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_290429.json:
```json
{
    "body": "reviewer name must be *full real name*",
    "created_at": "2016-08-19T19:36:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290429",
    "user": "https://github.com/fchapoton"
}
```

reviewer name must be *full real name*



---

archive/issue_comments_290430.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-08-21T14:19:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290430",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_290431.json:
```json
{
    "body": "Is it \"needs_work\" because of the missing reviewer name?\n\n(the patchbot doesn't like it because it cannot fetch the branch, that's not my fault I believe)",
    "created_at": "2016-08-21T15:13:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290431",
    "user": "https://github.com/mantepse"
}
```

Is it "needs_work" because of the missing reviewer name?

(the patchbot doesn't like it because it cannot fetch the branch, that's not my fault I believe)



---

archive/issue_comments_290432.json:
```json
{
    "body": "I am unsure of the correct protocol when setting/re-setting this \"positive review\" flag ...",
    "created_at": "2016-08-21T16:07:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290432",
    "user": "https://trac.sagemath.org/admin/accounts/users/bpage"
}
```

I am unsure of the correct protocol when setting/re-setting this "positive review" flag ...



---

archive/issue_comments_290433.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2016-08-21T16:07:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290433",
    "user": "https://trac.sagemath.org/admin/accounts/users/bpage"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_290434.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-08-23T22:01:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290434",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_290435.json:
```json
{
    "body": "```\nsage -t --long src/sage/interfaces/fricas.py\n**********************************************************************\nFile \"src/sage/interfaces/fricas.py\", line 971, in sage.interfaces.fricas.FriCASElement._sage_\nFailed example:\n    fricas(\"integrate(sin((x^2+1)/x),x)\").sage()\nException raised:\n    Traceback (most recent call last):\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 498, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 861, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.interfaces.fricas.FriCASElement._sage_[1]>\", line 1, in <module>\n        fricas(\"integrate(sin((x^2+1)/x),x)\").sage()\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 244, in __call__\n        return cls(self, x, name=name)\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 1382, in __init__\n        raise_(TypeError, x, sys.exc_info()[2])\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 1377, in __init__\n        self._name = parent._create(value, name=name)\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 434, in _create\n        self.set(name, value)\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/fricas.py\", line 506, in set\n        output = self.eval(cmd, reformat=False)\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/fricas.py\", line 596, in eval\n        **kwds)\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 1294, in eval\n        for L in code.split('\\n') if L != ''])\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 905, in _eval_line\n        self._start()\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/fricas.py\", line 273, in _start\n        Expect._start(self)\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 486, in _start\n        (self.name(), cmd, e, self._install_hints()))\n    TypeError: unable to start fricas because the command 'fricas -nox -noclef' failed: The command was not found or was not executable: fricas.\n\n**********************************************************************\n1 item had failures:\n   1 of   3 in sage.interfaces.fricas.FriCASElement._sage_\n    [3 tests, 1 failure, 0.19 s]\n```",
    "created_at": "2016-08-23T22:01:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290435",
    "user": "https://github.com/vbraun"
}
```

```
sage -t --long src/sage/interfaces/fricas.py
**********************************************************************
File "src/sage/interfaces/fricas.py", line 971, in sage.interfaces.fricas.FriCASElement._sage_
Failed example:
    fricas("integrate(sin((x^2+1)/x),x)").sage()
Exception raised:
    Traceback (most recent call last):
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 498, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 861, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.fricas.FriCASElement._sage_[1]>", line 1, in <module>
        fricas("integrate(sin((x^2+1)/x),x)").sage()
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 244, in __call__
        return cls(self, x, name=name)
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1382, in __init__
        raise_(TypeError, x, sys.exc_info()[2])
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1377, in __init__
        self._name = parent._create(value, name=name)
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 434, in _create
        self.set(name, value)
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/fricas.py", line 506, in set
        output = self.eval(cmd, reformat=False)
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/fricas.py", line 596, in eval
        **kwds)
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1294, in eval
        for L in code.split('\n') if L != ''])
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 905, in _eval_line
        self._start()
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/fricas.py", line 273, in _start
        Expect._start(self)
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 486, in _start
        (self.name(), cmd, e, self._install_hints()))
    TypeError: unable to start fricas because the command 'fricas -nox -noclef' failed: The command was not found or was not executable: fricas.

**********************************************************************
1 item had failures:
   1 of   3 in sage.interfaces.fricas.FriCASElement._sage_
    [3 tests, 1 failure, 0.19 s]
```



---

archive/issue_comments_290436.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-24T00:18:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290436",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290437.json:
```json
{
    "body": "Thanks, fixed.  I'm very sorry, but my git-foo is very weak, so there are some commits in the branch which do not belong.\n\nIf there is an easy way to get rid of them, please let me know...  They are:\n\n```\n\u200b43c1136\tExclude plain text from IPython super call\n\u200bb027498\tMerge branch 'u/vbraun/call_repr_once' of git://trac.sagemath.org/sage into develop\n\n\u200b1347786\tAdd jump_number() to posets.\n\u200b3e6ef52\t<tab> to spaces.\n\u200bfe815c8\tMerge branch 'u/jmantysalo/jump_number' of git://trac.sagemath.org/sage into fricas-interface\n\u200baa04d96\tAdd algorithm-keyword to canonical labeling of posets.\n\u200bd923dc1\tMerge branch 'u/jmantysalo/posets__add_algorithm_keyword_to_canonical_relabel__' of git://trac.sagemath.org/sage into fricas-interface\n\n\n\u200b92378ca\tFix for sage shell with TERM=dumb\n\u200bfc0b081\tMerge branch 'u/mkoeppe/sage_mode_for_emacs_has_display_problem_in_sage_7_4_beta0' of git://trac.sagemath.org/sage into fricas-interface\n```\n\nOr should I just create a new branch and copy the good stuff into that new branch?",
    "created_at": "2016-08-24T00:47:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290437",
    "user": "https://github.com/mantepse"
}
```

Thanks, fixed.  I'm very sorry, but my git-foo is very weak, so there are some commits in the branch which do not belong.

If there is an easy way to get rid of them, please let me know...  They are:

```
​43c1136	Exclude plain text from IPython super call
​b027498	Merge branch 'u/vbraun/call_repr_once' of git://trac.sagemath.org/sage into develop

​1347786	Add jump_number() to posets.
​3e6ef52	<tab> to spaces.
​fe815c8	Merge branch 'u/jmantysalo/jump_number' of git://trac.sagemath.org/sage into fricas-interface
​aa04d96	Add algorithm-keyword to canonical labeling of posets.
​d923dc1	Merge branch 'u/jmantysalo/posets__add_algorithm_keyword_to_canonical_relabel__' of git://trac.sagemath.org/sage into fricas-interface


​92378ca	Fix for sage shell with TERM=dumb
​fc0b081	Merge branch 'u/mkoeppe/sage_mode_for_emacs_has_display_problem_in_sage_7_4_beta0' of git://trac.sagemath.org/sage into fricas-interface
```

Or should I just create a new branch and copy the good stuff into that new branch?



---

archive/issue_comments_290438.json:
```json
{
    "body": "To undo the merge you have to go back to before it:\n\n```\ngit reset --hard 2231cea79d5c2c11e3520b623c7b5f2a19548b7a\n```\nand then only add the commit you want\n\n```\ngit cherry-pick c651222036f3a60e3d55a52423dc0e325d469e95\n```\nand then (force) push the new branch",
    "created_at": "2016-08-24T06:54:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290438",
    "user": "https://github.com/vbraun"
}
```

To undo the merge you have to go back to before it:

```
git reset --hard 2231cea79d5c2c11e3520b623c7b5f2a19548b7a
```
and then only add the commit you want

```
git cherry-pick c651222036f3a60e3d55a52423dc0e325d469e95
```
and then (force) push the new branch



---

archive/issue_comments_290439.json:
```json
{
    "body": "https://trac.sagemath.org/ticket/21209#comment:64 shows that you need to implement `fricas.quit()` here.",
    "created_at": "2016-08-30T04:53:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290439",
    "user": "https://github.com/dimpase"
}
```

https://trac.sagemath.org/ticket/21209#comment:64 shows that you need to implement `fricas.quit()` here.



---

archive/issue_comments_290440.json:
```json
{
    "body": "https://trac.sagemath.org/ticket/21209#comment:66 indicates that it is sufficient to append a `\\r` to the quitstring.",
    "created_at": "2016-08-30T06:21:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290440",
    "user": "https://github.com/mantepse"
}
```

https://trac.sagemath.org/ticket/21209#comment:66 indicates that it is sufficient to append a `\r` to the quitstring.



---

archive/issue_comments_290441.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-15T14:54:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290441",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290442.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-15T15:43:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290442",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290443.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-16T14:24:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290443",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290444.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-09-16T14:28:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290444",
    "user": "https://github.com/mantepse"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_290445.json:
```json
{
    "body": "There is something strange about the way FriCAS matrices are being typeset.\n\n\n```\nsage: latex(fricas(\"matrix([[1,2],[3,4]])\"))\n {\\left[ 1, \\: 2  \\right]} \\  {\\left[ 3, \\: 4  \\right]} \n```\nbut\n\n```\nsage: fricas(\"matrix([[1,2],[3,4]])::TEX\")\n[\"$$\", \"\\left[\", \"\\begin{array}{cc}\", \"1 & 2 \\\\ \", \"3 & 4 \", \"\\end{array}\",\n \"\\right]\", \"$$\"]\n```\nHowever in other cases it looks normal. For example:\n\n```\nsage: latex(fricas(\"integrate(sin(x/(1+sqrt(x))),x)\"))\n \\int ^{\\displaystyle x} {{\\sin  \\left( {{ \\%A \\over {{\\sqrt { \\%A}}+1}}}  \\right)} \\  {d \\%A}}   \n\nsage: fricas(\"integrate(sin(x/(1+sqrt(x))),x)::TEX\")\n[\"$$\", \"\\int \\sp{\\displaystyle x} {{\\sin \", \"\\left(\",\n \"{{ \\%A \\over {{\\sqrt { \\%A}}+1}}} \", \"\\right)}\", \"\\  {d \\%A}} \", \"$$\"]\n```",
    "created_at": "2016-09-17T15:59:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290445",
    "user": "https://trac.sagemath.org/admin/accounts/users/bpage"
}
```

There is something strange about the way FriCAS matrices are being typeset.


```
sage: latex(fricas("matrix([[1,2],[3,4]])"))
 {\left[ 1, \: 2  \right]} \  {\left[ 3, \: 4  \right]} 
```
but

```
sage: fricas("matrix([[1,2],[3,4]])::TEX")
["$$", "\left[", "\begin{array}{cc}", "1 & 2 \\ ", "3 & 4 ", "\end{array}",
 "\right]", "$$"]
```
However in other cases it looks normal. For example:

```
sage: latex(fricas("integrate(sin(x/(1+sqrt(x))),x)"))
 \int ^{\displaystyle x} {{\sin  \left( {{ \%A \over {{\sqrt { \%A}}+1}}}  \right)} \  {d \%A}}   

sage: fricas("integrate(sin(x/(1+sqrt(x))),x)::TEX")
["$$", "\int \sp{\displaystyle x} {{\sin ", "\left(",
 "{{ \%A \over {{\sqrt { \%A}}+1}}} ", "\right)}", "\  {d \%A}} ", "$$"]
```



---

archive/issue_comments_290446.json:
```json
{
    "body": "Replying to [comment:76 bpage]:\n> There is something strange about the way FriCAS matrices are being typeset.\n> \n> \n> \n> ```\n> sage: latex(fricas(\"matrix([[1,2],[3,4]])\"))\n>  {\\left[ 1, \\: 2  \\right]} \\  {\\left[ 3, \\: 4  \\right]} \n> ```\n> but\n> \n> ```\n> sage: fricas(\"matrix([[1,2],[3,4]])::TEX\")\n> [\"$$\", \"\\left[\", \"\\begin{array}{cc}\", \"1 & 2 \\\\ \", \"3 & 4 \", \"\\end{array}\",\n>  \"\\right]\", \"$$\"]\n> ```\n\n\nI am using `outputAsTex`.  Should I use `::TEX` instead?",
    "created_at": "2016-09-17T17:03:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290446",
    "user": "https://github.com/mantepse"
}
```

Replying to [comment:76 bpage]:
> There is something strange about the way FriCAS matrices are being typeset.
> 
> 
> 
> ```
> sage: latex(fricas("matrix([[1,2],[3,4]])"))
>  {\left[ 1, \: 2  \right]} \  {\left[ 3, \: 4  \right]} 
> ```
> but
> 
> ```
> sage: fricas("matrix([[1,2],[3,4]])::TEX")
> ["$$", "\left[", "\begin{array}{cc}", "1 & 2 \\ ", "3 & 4 ", "\end{array}",
>  "\right]", "$$"]
> ```


I am using `outputAsTex`.  Should I use `::TEX` instead?



---

archive/issue_comments_290447.json:
```json
{
    "body": "I am perplexed that `outputAsTex` does not produce the same thing as `::TEX`. I was not aware of that. Perhaps this should be reported as a bug in FriCAS? In any case it seems that the FriCAS command:\n\n```\n)set output tex on\n```\nuses the latter method.\n\n```\n(1) -> outputAsTex matrix [[1,2],[3,4]]\n$$\n{\\left[ 1, \\: 2 \n\\right]}\n\\  {\\left[ 3, \\: 4 \n\\right]}\n\\leqno(1)\n$$\n\n                                                                   Type: Void\n(2) -> matrix([[1,2],[3,4]])::TEX\n\n   (2)\n   [\"$$\", \"\\left[\", \"\\begin{array}{cc}\", \"1 & 2 \\\\ \", \"3 & 4 \", \"\\end{array}\",\n    \"\\right]\", \"$$\"]\n                                                              Type: TexFormat\n(3) -> )set output tex on\n(3) -> matrix([[1,2],[3,4]])     \n\n        +1  2+\n   (3)  |    |\n        +3  4+\n$$\n\\left[\n\\begin{array}{cc}\n1 & 2 \\\\ \n3 & 4 \n\\end{array}\n\\right]\n\\leqno(3)\n$$\n\n                                                        Type: Matrix(Integer)\n```\nI think it is reasonable to expect that typeset mode with the FriCAS interface would produce the same result.",
    "created_at": "2016-09-17T18:58:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290447",
    "user": "https://trac.sagemath.org/admin/accounts/users/bpage"
}
```

I am perplexed that `outputAsTex` does not produce the same thing as `::TEX`. I was not aware of that. Perhaps this should be reported as a bug in FriCAS? In any case it seems that the FriCAS command:

```
)set output tex on
```
uses the latter method.

```
(1) -> outputAsTex matrix [[1,2],[3,4]]
$$
{\left[ 1, \: 2 
\right]}
\  {\left[ 3, \: 4 
\right]}
\leqno(1)
$$

                                                                   Type: Void
(2) -> matrix([[1,2],[3,4]])::TEX

   (2)
   ["$$", "\left[", "\begin{array}{cc}", "1 & 2 \\ ", "3 & 4 ", "\end{array}",
    "\right]", "$$"]
                                                              Type: TexFormat
(3) -> )set output tex on
(3) -> matrix([[1,2],[3,4]])     

        +1  2+
   (3)  |    |
        +3  4+
$$
\left[
\begin{array}{cc}
1 & 2 \\ 
3 & 4 
\end{array}
\right]
\leqno(3)
$$

                                                        Type: Matrix(Integer)
```
I think it is reasonable to expect that typeset mode with the FriCAS interface would produce the same result.



---

archive/issue_comments_290448.json:
```json
{
    "body": "ping?",
    "created_at": "2016-09-20T07:30:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290448",
    "user": "https://github.com/mantepse"
}
```

ping?



---

archive/issue_comments_290449.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-22T09:24:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290449",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290450.json:
```json
{
    "body": "Thanks for the update. The output of\n\n    sage: latex(fricas(\"matrix([[1,2],[3,4]])\"))\n    \\left[ \\begin{array}{cc} 1 & 2 \\\\ 3 & 4 \\end{array}  \\right]\n\nnow looks good but ...\n\nIn\n\n    sage --notebook\n\nthe output from a cell beginning with\n\n    %fricas\n\nis no longer being typeset even though the `[x]Typeset` option is checked.",
    "created_at": "2016-09-22T13:16:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290450",
    "user": "https://trac.sagemath.org/admin/accounts/users/bpage"
}
```

Thanks for the update. The output of

    sage: latex(fricas("matrix([[1,2],[3,4]])"))
    \left[ \begin{array}{cc} 1 & 2 \\ 3 & 4 \end{array}  \right]

now looks good but ...

In

    sage --notebook

the output from a cell beginning with

    %fricas

is no longer being typeset even though the `[x]Typeset` option is checked.



---

archive/issue_comments_290451.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-22T18:51:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290451",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290452.json:
```json
{
    "body": "My comment about how typeset mode works in the a Sage worksheet was incorrect. Everything looks good! Thanks.",
    "created_at": "2016-09-24T14:28:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290452",
    "user": "https://trac.sagemath.org/admin/accounts/users/bpage"
}
```

My comment about how typeset mode works in the a Sage worksheet was incorrect. Everything looks good! Thanks.



---

archive/issue_comments_290453.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-09-24T14:28:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290453",
    "user": "https://trac.sagemath.org/admin/accounts/users/bpage"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_290454.json:
```json
{
    "body": "Merge conflict",
    "created_at": "2016-09-24T14:31:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290454",
    "user": "https://github.com/vbraun"
}
```

Merge conflict



---

archive/issue_comments_290455.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-09-24T14:31:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290455",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_290456.json:
```json
{
    "body": "Replying to [comment:84 vbraun]:\n> Merge conflict\n\n\nI just did\n\n```\nwspage@strix ~/sage $ git branch\n  develop\n  master\n* t/21231/fricas_interface\nwspage@strix ~/sage $ git pull\nremote: Counting objects: 1865, done.\nremote: Compressing objects: 100% (794/794), done.\nremote: Total 1291 (delta 1146), reused 618 (delta 493)\nReceiving objects: 100% (1291/1291), 190.57 KiB | 175.00 KiB/s, done.\nResolving deltas: 100% (1146/1146), completed with 398 local objects.\nFrom git://trac.sagemath.org/sage\n   0ae5fd8..c5dadf9  develop    -> trac/develop\n   62b052e..b57c07f  u/chapoton/21210 -> trac/u/chapoton/21210\n   eda9412..c76bdfa  u/chapoton/21523 -> trac/u/chapoton/21523\n   41d35fc..9114ec8  u/chapoton/21577 -> trac/u/chapoton/21577\n * [new branch]      u/jdemeyer/gp2c_does_not_pass_self_checks -> trac/u/jdemeyer/gp2c_does_not_pass_self_checks\n + f54ecb5...ccd9c1e u/jdemeyer/pari__use_prot_none_for_unused_virtual_stack_memory -> trac/u/jdemeyer/pari__use_prot_none_for_unused_virtual_stack_memory  (forced update)\n * [new tag]         7.4.beta6  -> 7.4.beta6\nAlready up-to-date.\n```\nand did not see any conflict.  How can I see what is wrong?",
    "created_at": "2016-09-24T16:31:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290456",
    "user": "https://trac.sagemath.org/admin/accounts/users/bpage"
}
```

Replying to [comment:84 vbraun]:
> Merge conflict


I just did

```
wspage@strix ~/sage $ git branch
  develop
  master
* t/21231/fricas_interface
wspage@strix ~/sage $ git pull
remote: Counting objects: 1865, done.
remote: Compressing objects: 100% (794/794), done.
remote: Total 1291 (delta 1146), reused 618 (delta 493)
Receiving objects: 100% (1291/1291), 190.57 KiB | 175.00 KiB/s, done.
Resolving deltas: 100% (1146/1146), completed with 398 local objects.
From git://trac.sagemath.org/sage
   0ae5fd8..c5dadf9  develop    -> trac/develop
   62b052e..b57c07f  u/chapoton/21210 -> trac/u/chapoton/21210
   eda9412..c76bdfa  u/chapoton/21523 -> trac/u/chapoton/21523
   41d35fc..9114ec8  u/chapoton/21577 -> trac/u/chapoton/21577
 * [new branch]      u/jdemeyer/gp2c_does_not_pass_self_checks -> trac/u/jdemeyer/gp2c_does_not_pass_self_checks
 + f54ecb5...ccd9c1e u/jdemeyer/pari__use_prot_none_for_unused_virtual_stack_memory -> trac/u/jdemeyer/pari__use_prot_none_for_unused_virtual_stack_memory  (forced update)
 * [new tag]         7.4.beta6  -> 7.4.beta6
Already up-to-date.
```
and did not see any conflict.  How can I see what is wrong?



---

archive/issue_comments_290457.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-24T17:00:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290457",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290458.json:
```json
{
    "body": "fixed trivial merge conflict.",
    "created_at": "2016-09-24T17:02:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290458",
    "user": "https://github.com/mantepse"
}
```

fixed trivial merge conflict.



---

archive/issue_comments_290459.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2016-09-24T17:02:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290459",
    "user": "https://github.com/mantepse"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_290460.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2016-09-26T06:10:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290460",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_290461.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2016-09-26T06:10:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290461",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_290462.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-10-02T11:52:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290462",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_290463.json:
```json
{
    "body": "Passes `ptestlong` on top of 7.4beta6 (+#21622, mandatory for getting Sage to compile) with one failure :\n\n```\n----------------------------------------------------------------------\nsage -t --long --warn-long 113.7 src/sage/homology/simplicial_complex.py  # 1 doctest failed\n----------------------------------------------------------------------\n```\n\nwhich passes standalone :\n\n```\ncharpent@asus16-ec:/usr/local/sage-7$ sage -t --long --warn-long 113.7 src/sage/homology/simplicial_complex.py \nRunning doctests with ID 2016-10-02-13-43-39-bc494aee.\nGit branch: t/21231/fricas_interface\nUsing --optional=atlas,database_gap,mpir,python2,sage,sage_mode\nDoctesting 1 file.\nsage -t --long --warn-long 113.7 src/sage/homology/simplicial_complex.py\n    [588 tests, 3.20 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 3.3 seconds\n    cpu time: 3.0 seconds\n    cumulative wall time: 3.2 seconds\n```\n\nThis failure is a recurring known problem. ==> `positive_review` notwithstanding.",
    "created_at": "2016-10-02T11:52:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290463",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Passes `ptestlong` on top of 7.4beta6 (+#21622, mandatory for getting Sage to compile) with one failure :

```
----------------------------------------------------------------------
sage -t --long --warn-long 113.7 src/sage/homology/simplicial_complex.py  # 1 doctest failed
----------------------------------------------------------------------
```

which passes standalone :

```
charpent@asus16-ec:/usr/local/sage-7$ sage -t --long --warn-long 113.7 src/sage/homology/simplicial_complex.py 
Running doctests with ID 2016-10-02-13-43-39-bc494aee.
Git branch: t/21231/fricas_interface
Using --optional=atlas,database_gap,mpir,python2,sage,sage_mode
Doctesting 1 file.
sage -t --long --warn-long 113.7 src/sage/homology/simplicial_complex.py
    [588 tests, 3.20 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 3.3 seconds
    cpu time: 3.0 seconds
    cumulative wall time: 3.2 seconds
```

This failure is a recurring known problem. ==> `positive_review` notwithstanding.



---

archive/issue_comments_290464.json:
```json
{
    "body": "There are a few docbuild errors, I'll correct them tomorrow morning.",
    "created_at": "2016-10-02T14:18:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290464",
    "user": "https://github.com/mantepse"
}
```

There are a few docbuild errors, I'll correct them tomorrow morning.



---

archive/issue_comments_290465.json:
```json
{
    "body": "Replying to [comment:90 mantepse]:\n> There are a few docbuild errors,\n\n\nWups. I missed that (how did you find this ?).\n\n> I'll correct them tomorrow morning.\n\n\nRing me afterwards, I'll re-test it un the evening (European time).",
    "created_at": "2016-10-02T15:44:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290465",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Replying to [comment:90 mantepse]:
> There are a few docbuild errors,


Wups. I missed that (how did you find this ?).

> I'll correct them tomorrow morning.


Ring me afterwards, I'll re-test it un the evening (European time).



---

archive/issue_comments_290466.json:
```json
{
    "body": "Replying to [comment:91 charpent]:\n> Replying to [comment:90 mantepse]:\n> > There are a few docbuild errors,\n\n> \n> Wups. I missed that (how did you find this ?).\n\n\nI only saw it on the patchbot report...  (there is one one 7.4 beta6 by cristal which seems to report something real)",
    "created_at": "2016-10-02T16:22:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290466",
    "user": "https://github.com/mantepse"
}
```

Replying to [comment:91 charpent]:
> Replying to [comment:90 mantepse]:
> > There are a few docbuild errors,

> 
> Wups. I missed that (how did you find this ?).


I only saw it on the patchbot report...  (there is one one 7.4 beta6 by cristal which seems to report something real)



---

archive/issue_comments_290467.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2016-10-03T08:53:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290467",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_290468.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2016-10-03T08:53:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290468",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_290469.json:
```json
{
    "body": "Everything should be fine now!",
    "created_at": "2016-10-03T08:54:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290469",
    "user": "https://github.com/mantepse"
}
```

Everything should be fine now!



---

archive/issue_comments_290470.json:
```json
{
    "body": "Passes `ptestlong` with the same failure as before, which again passes standalone.\n\n`positive_review`",
    "created_at": "2016-10-03T19:28:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290470",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Passes `ptestlong` with the same failure as before, which again passes standalone.

`positive_review`



---

archive/issue_comments_290471.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-10-03T19:28:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290471",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_290472.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2016-10-10T10:25:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290472",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_290473.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2016-10-10T10:25:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290473",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_290474.json:
```json
{
    "body": "the latest push created a mega-patch for no good reason. What was the reason for this?",
    "created_at": "2016-10-10T10:40:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290474",
    "user": "https://github.com/dimpase"
}
```

the latest push created a mega-patch for no good reason. What was the reason for this?



---

archive/issue_comments_290475.json:
```json
{
    "body": "I am sorry, I thought I am supposed to merge when a new develop appears.  Could you tell me how to revert?",
    "created_at": "2016-10-10T10:43:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290475",
    "user": "https://github.com/mantepse"
}
```

I am sorry, I thought I am supposed to merge when a new develop appears.  Could you tell me how to revert?



---

archive/issue_comments_290476.json:
```json
{
    "body": "Replying to [comment:98 mantepse]:\n> I am sorry, I thought I am supposed to merge when a new develop appears.  Could you tell me how to revert?\n\n\nonly if there are merge conflicts (which you would see by the Branch field in the ticket turning red).\n\nJust [revert](http://stackoverflow.com/questions/927358/how-to-undo-last-commits-in-git) the last commit (and push again, with -f switch). Not sure how to do this using `git trac` if you must use it...\nLet me know if you get stuck on this.",
    "created_at": "2016-10-10T10:55:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290476",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:98 mantepse]:
> I am sorry, I thought I am supposed to merge when a new develop appears.  Could you tell me how to revert?


only if there are merge conflicts (which you would see by the Branch field in the ticket turning red).

Just [revert](http://stackoverflow.com/questions/927358/how-to-undo-last-commits-in-git) the last commit (and push again, with -f switch). Not sure how to do this using `git trac` if you must use it...
Let me know if you get stuck on this.



---

archive/issue_comments_290477.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-10-10T11:08:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290477",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_290478.json:
```json
{
    "body": "Replying to [comment:99 dimpase]:\n\nThank you!",
    "created_at": "2016-10-10T11:10:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290478",
    "user": "https://github.com/mantepse"
}
```

Replying to [comment:99 dimpase]:

Thank you!



---

archive/issue_comments_290479.json:
```json
{
    "body": "OK, good, back to the positively reviewed patch.",
    "created_at": "2016-10-10T11:22:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290479",
    "user": "https://github.com/dimpase"
}
```

OK, good, back to the positively reviewed patch.



---

archive/issue_comments_290480.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-10-10T11:22:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290480",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_290481.json:
```json
{
    "body": "You should not use a bare `except:` (see the end of `src/sage/symbolic/integration/external.py`). Moreover, I would suggest to replace\n\n```\n     try:\n        return result.sage()\n     except:\n        raise ValueError(\"Unable to parse: {}\".format(result))\n```\nby\n\n```\nreturn result.sage()\n```",
    "created_at": "2016-10-12T06:20:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290481",
    "user": "https://github.com/jdemeyer"
}
```

You should not use a bare `except:` (see the end of `src/sage/symbolic/integration/external.py`). Moreover, I would suggest to replace

```
     try:
        return result.sage()
     except:
        raise ValueError("Unable to parse: {}".format(result))
```
by

```
return result.sage()
```



---

archive/issue_comments_290482.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-10-12T06:20:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290482",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_290483.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-10-12T06:31:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290483",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290484.json:
```json
{
    "body": "I agree - I only adapted this part of the code.",
    "created_at": "2016-10-12T06:32:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290484",
    "user": "https://github.com/mantepse"
}
```

I agree - I only adapted this part of the code.



---

archive/issue_comments_290485.json:
```json
{
    "body": "could you set this back to positive review?  I would really like to get this into sage soon, because there will be trivial, but tedious merge conflicts all the time otherwise.  I'd be grateful...",
    "created_at": "2016-10-12T08:22:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290485",
    "user": "https://github.com/mantepse"
}
```

could you set this back to positive review?  I would really like to get this into sage soon, because there will be trivial, but tedious merge conflicts all the time otherwise.  I'd be grateful...



---

archive/issue_comments_290486.json:
```json
{
    "body": "Well, if you don't set it to `needs_review`, I don't know that it's ready for review.",
    "created_at": "2016-10-12T08:38:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290486",
    "user": "https://github.com/jdemeyer"
}
```

Well, if you don't set it to `needs_review`, I don't know that it's ready for review.



---

archive/issue_comments_290487.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-10-12T08:38:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290487",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_290488.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-10-12T08:39:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290488",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_290489.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-10-21T07:04:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20994#issuecomment-290489",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_056594.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-10-21T07:04:20Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20994",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20994#event-56594"
}
```
