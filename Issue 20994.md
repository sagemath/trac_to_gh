# Issue 20994: improve FriCAS interface

Issue created by migration from https://trac.sagemath.org/ticket/21231

Original creator: mantepse

Original creation time: 2016-08-12 11:05:04

CC:  bpage hemmecke dkrenn dimpase

Keywords: FriCAS

The FriCAS interface is currently very rudimentary.  In particular, converting the results of a computation into sage types is available only in very few special cases.


---

Comment by mantepse created at 2016-08-12 11:08:31

1) implement a method that (reliably!) yields a tuple `(type, 1d algebra output, 2d algebra output, error message, etc)` as strings.  `1d algebra output` should come in "unparsed inputform" as one very long string, I'd say.  `2d algebra output` should be empty if 1d output is available.

It should be able to deal with very long lines, too, possibly be using file io.  This involves use of ioHook and some regexps.

2) implement a method that translates fricas output into sage types.

I think this could work as follows: we want to map fricas types to sage constructors, possibly recursively.  Recall that what's really sent to fricas is something like `"sage23 := [x<sup>n/y</sup>n for n in 1..3]"`, so that sage can access the result using the variable `"sage23"`.  This string is referred to as `self._name`

Now what I propose is a method which takes a parsed type, e.g., `"Integer"` or `("List", "Integer")` or 
`("UnivariatePolynomial", "x", ("Fraction", "Integer"))`


```
def to_sage(type):
    if type == "Integer":
         return to_sage_integer()
    elif type == "String":
         return to_sage_string()
    ...
    elif isinstance(type, tuple):
        if type[0] == "List":
            return to_sage_list(type[1])
        elif type[0] == "Fraction":
            return to_sage_fraction(type[1])
        ....
```


and so on.

So, if the type is `("List" ("Fraction" ("UnivariatePolynomial" "x" "Integer")))`, this method would call


```
    to_sage_list(("Fraction" ("UnivariatePolynomial" "x" "Integer"))
```


which might be something like


```
def to_sage_list(self, type):
    n = fricas.eval("#" + self._name).to_sage_integer()
    return [fricas.eval(self._name + ".%n").to_sage(type) for n in range(1,n+1)]
```



---

Comment by mantepse created at 2016-08-12 11:08:51

Changing type from PLEASE CHANGE to enhancement.


---

Comment by mantepse created at 2016-08-12 23:37:20

New commits:


---

Comment by mantepse created at 2016-08-12 23:38:43

This is very beta, but I'd be very happy to receive some comments.


---

Comment by mantepse created at 2016-08-12 23:51:55

New commits:


---

Comment by vbraun created at 2016-08-13 21:04:13

Branch name doesn't have leading slash
----
New commits:


---

Comment by mantepse created at 2016-08-14 07:54:29

Replying to [comment:6 vbraun]:
> Branch name doesn't have leading slash

Howto?  I used


```
git push --set-upstream trac HEAD:u/mantepse/21231
```



---

Comment by dimpase created at 2016-08-14 09:56:42

Replying to [comment:7 mantepse]:
> Replying to [comment:6 vbraun]:
> > Branch name doesn't have leading slash
> 
> Howto?  I used
> 
> {{{
> git push --set-upstream trac HEAD:u/mantepse/21231
> }}}
This is fine, this does not do anything to the webpage contents. You made a typo, this leading slash, while editing the latter.


---

Comment by mantepse created at 2016-08-14 15:28:09

(it actually doesn't depend on #21209, since it works with any installation of FriCAS but never mind)


---

Comment by git created at 2016-08-14 15:54:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bpage created at 2016-08-15 01:59:48

Sage worksheet under 7.2


---

Attachment

Sage worksheet under 7.4.beta0 (typeset output fails)


---

Comment by bpage created at 2016-08-15 02:07:31

In Sage Worksheet typeset output or FriCAS object fails with this patch on 7.4.beta0.  See attached pdf files.

https://trac.sagemath.org/attachment/ticket/21231/sage-7.2-fricas.pdf  (typeset output OK)

https://trac.sagemath.org/attachment/ticket/21231/sage-7.4.beta0-fricas.pdf  (typeset output fails)

I am not sure whether or not this example worked under 7.4.beta0 without the patch.


---

Comment by git created at 2016-08-15 09:37:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-08-16 00:07:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2016-08-16 00:09:01

I have a question about the `_fricas_init_` and `_fricas_` methods
defined in various files, in particular in
`~/sage-develop/src/sage/rings/rational_field.py` and `in
~/sage-develop/src/sage/rings/real_mpfr.pyx`, see below.

The question is: the doctests work without adapting the methods.
What are the methods supposed to do?

`~/sage-develop/src/sage/rings/rational_field.py`

```
    def _axiom_init_(self):
        r"""
        Return the axiom/fricas representation of `\QQ`.

        EXAMPLES::

           sage: axiom(QQ)    #optional - axiom # indirect doctest
           Fraction Integer
           sage: fricas(QQ)   #optional - fricas # indirect doctest
           Fraction(Integer)

        """
        return 'Fraction Integer'

    _fricas_init_ = _axiom_init_
```




in `~/sage-develop/src/sage/rings/real_mpfr.pyx`


```
    def _axiom_(self, axiom):
        """
        Return ``self`` as a floating point number in Axiom.

        EXAMPLES::

            sage: R = RealField(100)
            sage: R(pi)
            3.1415926535897932384626433833
            sage: axiom(R(pi))  # optional - axiom # indirect doctest
            3.1415926535 8979323846 26433833
            sage: fricas(R(pi)) # optional - fricas
            3.1415926535_8979323846_26433833

        """
        prec = self.parent().prec()

        #Set the precision in Axiom
        old_prec = axiom('precision(%s)$Float'%prec)
        res = axiom('%s :: Float'%self.exact_rational())
        axiom.eval('precision(%s)$Float'%old_prec)

        return res

    _fricas_ = _axiom_
```



---

Comment by git created at 2016-08-16 00:58:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2016-08-16 01:48:55

The once missing thing is the error handling.  I was expecting that raising an error in `eval` would be sufficient, as indicated by the patch below.  However, if I then do `fricas("something stupid")`, no error is raised.  What am I doing wrong?


```
--- a/src/sage/interfaces/fricas.py
+++ b/src/sage/interfaces/fricas.py
@@ -385,8 +385,7 @@ class FriCAS(ExtraTabCompletion, Expect):
                 return "\r\n".join(line[FRICAS_MULTI_LINE_START:] for line in lines)
 
         else:
-            print(output)
-            return
+            raise RuntimeError("FriCAS has not recognized '%s' as a valid operation: %s" % (code, output))
 
     def set(self, var, value):
         """Set the variable var to the given value.
```



---

Comment by bpage created at 2016-08-16 12:16:32

Calling `fricas("something stupid")` ends up in `fricas.set` which calls `expect._eval_line` not `fricas.eval`.  This interface stuff is truly twisted. Check especially the inheritance.  `FriCAS` inherits from `Expect` that inherits `Interface`. Check `__call__` and `_create` in `Interface` and go from there.

`fricas.py` should probably override `_eval_line` in the same way as `axiom.py`.


---

Comment by git created at 2016-08-16 17:56:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bpage created at 2016-08-16 21:26:57

`fricas.py` used to inherit some functions from `axiom.py`. The new version no longer uses any part of the Axiom interface. One of the casualties of this change was `_latex_` from `PanAxiomElement`. The function `_latex_` is responsible for producing LaTeX output in typeset mode.  The following patch incorporates the `_latex_` function from `axiom.py` and corrects the problem reported above in #21231#comment:12



```
diff --git a/src/sage/interfaces/fricas.py b/src/sage/interfaces/fricas.py
index 8831c6c..5c1bc64 100644
--- a/src/sage/interfaces/fricas.py
+++ b/src/sage/interfaces/fricas.py
@@ -201,6 +201,7 @@ from __future__ import print_function
 
 from sage.interfaces.tab_completion import ExtraTabCompletion
 from sage.interfaces.expect import Expect, ExpectElement, FunctionElement, ExpectFunction
+from sage.misc.multireplace import multiple_replace
 from sage.env import DOT_SAGE
 import re
 import six
@@ -571,6 +572,31 @@ class FriCASElement(ExpectElement):
             raise IndexError("index out of range")
         return self.elt(n+1)
 
+    def _latex_(self):
+        r"""
+        EXAMPLES::
+
+            sage: a = fricas(1/2) #optional - fricas
+            sage: latex(a)       #optional - fricas
+             1 \over 2
+
+        """
+        self._check_valid()
+        P = self.parent()
+        s = P._eval_line('outputAsTex(%s)'%self.name())
+        if not '$$' in s:
+            raise RuntimeError("Error texing axiom object.")
+        i = s.find('$$')
+        j = s.rfind('$$')
+        s = s[i+2:j]
+        s = multiple_replace({'\r':'', '\n':' ',
+                              ' \\sp ':'^',
+                              '\\arcsin ':'\\sin^{-1} ',
+                              '\\arccos ':'\\cos^{-1} ',
+                              '\\arctan ':'\\tan^{-1} '},
+            re.sub(r'\\leqno\(.*?\)','',s)) # no eq number!
+        return s
+
     def __int__(self):
         return int(self.sage())
```


I am not sure of the relevance of the particular substitutions that were performed by the old `axiom.py` code.

Sorry for just including a patch but I am not sure whether or not I could have just pushed this change to trac since this branch seems to be private.


---

Comment by bpage created at 2016-08-16 22:30:18

FriCAS uses

```
sage: fricas('asin(x)')
asin(x)
sage: fricas('acos(x)')
acos(x)
sage: fricas('atan(x)')
atan(x)
```


Sage replaces `asin`, `acos` and `atan` with `arcsin`, `arccos` and `arctan`

```
sage: asin(x)
arcsin(x)
sage: acos(x)
arccos(x)
sage: atan(x)
arctan(x)
```


But FriCAS does not use these names so the following results in an error:

```
sage: fricas(asin(x))
...
   There are no library operations named arcsin 
      Use HyperDoc Browse or issue
                                                                                                                   )what op arctan
      to learn if there is any operation containing " arctan " in its name.
 ...
sage: fricas(acos(x))
...
   There are no library operations named arccos 
      Use HyperDoc Browse or issue
                                                                                                                   )what op arctan
      to learn if there is any operation containing " arctan " in its name.
 ...
sage: fricas(atan(x))
...
   There are no library operations named arctan 
      Use HyperDoc Browse or issue
                                                                                                                   )what op arctan
      to learn if there is any operation containing " arctan " in its name.
 ...
```



---

Comment by mantepse created at 2016-08-17 08:09:28

> Sorry for just including a patch but I am not sure whether or not I could have just pushed this change to trac since this branch seems to be private.

Putting patches here is perfect for me, actually!  Many thanks!


---

Comment by dimpase created at 2016-08-17 08:23:24

Replying to [comment:22 mantepse]:
> > Sorry for just including a patch but I am not sure whether or not I could have just pushed this change to trac since this branch seems to be private.
> 
> Putting patches here is perfect for me, actually!  Many thanks!

although you could have just pushed your own (i.e. u/bpage) or public (i.e. public/) branch; then your commit(s) could be [cherry-picked](https://www.kernel.org/pub/software/scm/git/docs/git-cherry-pick.html). An advantage is that it's no error-prone cutting/pasting, (and it is known whom to [blame](https://www.kernel.org/pub/software/scm/git/docs/git-blame.html) :-)).


---

Comment by git created at 2016-08-17 13:42:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2016-08-17 13:42:55

Changing status from new to needs_review.


---

Comment by bpage created at 2016-08-17 15:09:33

Typeset output from FriCAS in the notebook is not working. Apparently the most recent commit is still missing `_latex_`.


---

Comment by bpage created at 2016-08-17 15:52:37

I think the markers `|startKeyedMsg|` and `|endOfKeyedMsg|` look strange in the error message and traceback. In the notebook only `|endOfKeyedMsg|` is shown as the output until clicking to expand the traceback. These markers should probably be removed from the output before displaying the message to the user.


---

Comment by mantepse created at 2016-08-17 17:40:25

Thanks for reminding me of LaTeX, I'm embarassed - I forgot!

Removing `|startKeyedMsg|` and `|endOfKeyedMsg|` and the like is not completely trivial, but I'll try!


---

Comment by mantepse created at 2016-08-17 17:40:45

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-08-17 22:23:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bpage created at 2016-08-17 22:46:33

Thanks, Martin. Here is a small patch that fixes a few problems with FriCAS-generated LaTeX. For example:


```
sage: latex(fricas("integrate(sin(x+1/x),x)"))
 \int ^{\displaystyle x} {{\sin  \left( {{{{{ \%A} ^{2}}+1} \over \%A}}  \right)} \  {d \%A}}   

```


and also subscripts and subscripts in a few other cases.


```
diff --git a/src/sage/interfaces/fricas.py b/src/sage/interfaces/fricas.py
index 8d2ac3f..594d5b8 100644
--- a/src/sage/interfaces/fricas.py
+++ b/src/sage/interfaces/fricas.py
@@ -598,7 +598,10 @@ class FriCASElement(ExpectElement):
         j = s.rfind('$$')
         s = s[i+2:j]
         s = multiple_replace({'\r':'', '\n':' ',
-                              ' \\sp ':'^',
+                              '\\sp ':'^',
+                              '\\sp{':'^{',
+                              '\\sb ':'_',
+                              '\\sb{':'_{',
                               '\\arcsin ':'\\sin^{-1} ',
                               '\\arccos ':'\\cos^{-1} ',
                               '\\arctan ':'\\tan^{-1} '},
```



---

Comment by git created at 2016-08-17 23:23:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2016-08-17 23:27:19

Changing status from needs_work to needs_review.


---

Comment by mantepse created at 2016-08-18 06:31:49

Hi Bill,

I don't understand your patch: why would you replace `\sp{` by `^{` if you replace `\sp` by `^` anyway.  Also, isn't `\sp` valid LaTeX?

But more importantly: shouldn't this patch really applied to FriCAS itself?


---

Comment by hemmecke created at 2016-08-18 06:52:15

Maybe tex.spad from my mathjax branch might be interesting. It spits out true latex.
https://github.com/hemmecke/fricas/commits/mathjax
But maybe you really want mathjax or even 1d output of FriCAS objects, then look into
mathjax.spad or 1d.spad. Most importantly, the output form can be changed at runtime.

Note that these files are GPL3+ and are therefore not (yet) part of FriCAS.


---

Comment by mantepse created at 2016-08-18 07:02:15

Hi Bill and Ralf!

I'd like to get this ticket in soon (and in particular, stop working on it very soon).  So if FriCAS produces only TeX currently, I'd like to leave it at this.  As soon as the new `tex.spad` is in FriCAS, we can pick it up here, OK?


---

Comment by mantepse created at 2016-08-18 07:04:56

> {{{
>                                '\\arcsin ':'\\sin^{-1} ',
>                                '\\arccos ':'\\cos^{-1} ',
>                                '\\arctan ':'\\tan^{-1} '},
> }}}

another question: why are you replacing `\arctan` and friends? As far as I know, this is perfectyl valid LaTeX, no?


---

Comment by hemmecke created at 2016-08-18 07:21:48

Yes, it is. And given the usual meaning of sin<sup>2</sup>(x) = (sin(x))<sup>2</sup> and not sin(sin(x)), I even think that writing sin<sup>(-1)</sup> for arcsin is even confusing, no?


---

Comment by git created at 2016-08-18 08:09:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-08-18 11:14:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bpage created at 2016-08-18 12:39:26

Replying to [comment:34 mantepse]:
> Hi Bill,
> 
> I don't understand your patch: why would you replace `\sp{` by `^{` if you replace `\sp` by `^` anyway.

Note the space `'\sp '`. It is looking for termination of `\sp`.

> Also, isn't `\sp` valid LaTeX?

Not as far as I know - maybe TeX?  In any case it does not work in Sage notebook.

> 
> But more importantly: shouldn't this patch really applied to
> FriCAS itself?

Perhaps.  Waldek would probably accept a patch to that effect.


---

Comment by bpage created at 2016-08-18 12:45:21

Replying to [comment:36 mantepse]:
> Hi Bill and Ralf!
> 
> I'd like to get this ticket in soon (and in particular, stop working on it very soon).  So if FriCAS produces only TeX currently, I'd like to leave it at this.  As soon as the new `tex.spad` is in FriCAS, we can pick it up here, OK?

I think Waldek is unlikely to change his position on the exclusion of copyleft licensed code in FriCAS since FriCAS already has a more permissive license. Of course that does not prevent its inclusion in the FriCAS external package here if someone were so inclined.


---

Comment by bpage created at 2016-08-18 12:47:14

Replying to [comment:37 mantepse]:

> another question: why are you replacing `\arctan` and friends? As far as I know, this is perfectyl valid LaTeX, no?

Yes. I agree with this change.  I just copied (with some reservations) what was added to the Axiom interface.


---

Comment by bpage created at 2016-08-18 12:55:41

Error output in Sage notebook still looks like this

```
fricas("something stupid")

Traceback (click to the left of this block for traceback)
...
```

|endOfKeyedMsg|
Expanded:


```
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
...
  File "/home/wspage/sage/local/lib/python2.7/site-packages/sage/interfaces/fricas.py", line 399, in set
    raise RuntimeError("An error occurred when FriCAS evaluated '%s': %s" % (value, output))
TypeError: An error occurred when FriCAS evaluated 'something stupid': |startKeyedMsg|
   There are no library operations named something 
      Use HyperDoc Browse or issue
                               )what op something
      to learn if there is any operation containing " something " in its 
      name.
 
   Cannot find a definition or applicable library operation named 
      something with argument type(s) 
                                Variable(stupid)
      
      Perhaps you should use "@" to indicate the required return type, or 
      "$" to specify which version of the function you need.
```

|endOfKeyedMsg|
|startKeyedMsg|
|endOfKeyedMsg|

It would be nice to get rid of `|startKeyedMsg|` and `|endOfKeyedMsg|` and include something more meaningful in the unexpanded version.


---

Comment by bpage created at 2016-08-18 13:02:19

Conversion of the following FriCAS result to Sage fails.

```
sage: fricas("integrate(sin(x+1/x),x)")

   x       2
 ++      %A  + 1
 |   sin(-------)d%A
++          %A

sage: fricas("integrate(sin(x+1/x),x)").sage()
...
TypeError: Bad function call: integral(sin((x^2+1)/x),x: !!! :Symbol)
```



---

Comment by git created at 2016-08-18 16:50:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bpage created at 2016-08-18 17:10:32

Excellent, thanks! This now looks great to me.


---

Comment by bpage created at 2016-08-18 17:12:18

Changing status from needs_review to positive_review.


---

Comment by bpage created at 2016-08-18 17:26:37

Oops, I was a bit too hasty and enthusiastic. Just one last thing ...

Try this in the sage --notebook


```
%fricas
x+1
```

I see the following markers displayed

```
   x + 1
```

Can you get rid of the markers in this case too?


---

Comment by bpage created at 2016-08-18 17:26:37

Changing status from positive_review to needs_work.


---

Comment by mantepse created at 2016-08-18 17:47:00

if

```
%fricas
x+1
```

displays the output of `fricas.eval(1+1)` instead of `fricas(1+1)`, this is going to be rather hard.  How could I find out?


---

Comment by bpage created at 2016-08-18 18:05:48

`fricas.eval` calls `_eval_line` inherited from `Expect`. Maybe you should just override it?


---

Comment by mantepse created at 2016-08-18 18:27:59

I wanted to avoid overriding `eval` and `_eval_line` because they do not have much description, so their expected behaviour is not completely clear to me.

The easy thing would be to have another option `reformat=True`, which sets `|$ioHook|` to `nil`, and call `eval` with `reformat=False` always...


---

Comment by bpage created at 2016-08-18 18:51:58

Well this is a slightly different but related topic: I prefer to treat Sage notebook cells beginning with `%fricas` like `.input` files rather than command lines. Because `.input` language syntax is somewhat more general it allows FriCAS code such as

```
for i in 1..10 repeat
  if i<5 then
    output i
  else
    output i+1
```

I notice that you already have code that allows creation and execution of `.input` files for very long expressions.  Making `_eval_line` always create `.input` files would not be difficult if you override it in `fricas.py`.


---

Comment by git created at 2016-08-18 19:07:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bpage created at 2016-08-18 19:28:06

Changing status from needs_work to positive_review.


---

Comment by bpage created at 2016-08-18 19:28:06

Reviewer is now very happy. :)  Maybe we can consider `.input` format cells in a later ticket.


---

Comment by mantepse created at 2016-08-18 19:33:51

There is actually an easy way to achieve what you want:
First say:

```
fricas._eval_using_file_cutoff=30
```

(I don't know what a good value is.  Don't make it 0 or 1.)
and then:

```
%fricas
for i in 100000..100010 repeat
  if i<5 then
    output i
  else
    output partition(i+1)
```


Note however, that the result will not be displayed one by one, but only after the full thing is finished.  I hate that.


---

Comment by bpage created at 2016-08-19 12:54:02

Replying to [comment:56 mantepse]:
> There is actually an easy way to achieve what you want:
> First say:
> {{{
> fricas._eval_using_file_cutoff=30
> }}}
> (I don't know what a good value is.  Don't make it 0 or 1.)

Nice!  In fact

```
fricas._eval_using_file_cutoff=1
```

seems to work for me.  Did you have a problem setting it to 1?

I could be happy with just such a flag option, especially if it was a bit more obvious like:

```
fricas.inputFormat(true)
```

But why not make it the default? Would you expect a serious performance issue?

> 
> Note however, that the result will not be displayed one by one, but only after the full thing is finished.  I hate that.

Of course, but this is not a problem in one of the most important uses: defining a long function.


---

Comment by mantepse created at 2016-08-19 13:14:02

> Nice!  In fact
> {{{
> fricas._eval_using_file_cutoff=1
> }}}
> seems to work for me.  Did you have a problem setting it to 1?

Yes, but that might have been noise.

> I could be happy with just such a flag option, especially if it was a bit more obvious like:
> {{{
> fricas.inputFormat(true)
> }}}

Not sure yet, especially about the user interface.

> But why not make it the default? Would you expect a serious performance issue?

Yes.

> > Note however, that the result will not be displayed one by one, but only after the full thing is finished.  I hate that.
> 
> Of course, but this is not a problem in one of the most important uses: defining a long function.

In case you have time there are two major things that remain to be done (on separate tickets):

* find out how Waldek's fricas-as-library works.

* find out how to make `fricas._eval_line` and `fricas.eval` print stuff they receive immediately, until a special marker is encountered.  (We can control the special marker via `|$ioHook|`, but for the moment let's pretend it is `|startAlgebraOutput|`.  To be honest, I don't even know whether this is possible.

I don't want to modify this ticket much further, unless the patchbot requires me to do so, to have it merged soon.


---

Comment by git created at 2016-08-19 13:39:43

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2016-08-19 13:39:43

Changing status from positive_review to needs_review.


---

Comment by mantepse created at 2016-08-19 18:26:56

I only changed *really* minor documentation stuff.


---

Comment by mantepse created at 2016-08-19 18:26:56

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2016-08-19 19:36:41

reviewer name must be *full real name*


---

Comment by vbraun created at 2016-08-21 14:19:20

Changing status from positive_review to needs_work.


---

Comment by mantepse created at 2016-08-21 15:13:37

Is it "needs_work" because of the missing reviewer name?

(the patchbot doesn't like it because it cannot fetch the branch, that's not my fault I believe)


---

Comment by bpage created at 2016-08-21 16:07:46

I am unsure of the correct protocol when setting/re-setting this "positive review" flag ...


---

Comment by bpage created at 2016-08-21 16:07:46

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2016-08-23 22:01:59

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2016-08-23 22:01:59


```
sage -t --long src/sage/interfaces/fricas.py
**********************************************************************
File "src/sage/interfaces/fricas.py", line 971, in sage.interfaces.fricas.FriCASElement._sage_
Failed example:
    fricas("integrate(sin((x^2+1)/x),x)").sage()
Exception raised:
    Traceback (most recent call last):
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 498, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 861, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.fricas.FriCASElement._sage_[1]>", line 1, in <module>
        fricas("integrate(sin((x^2+1)/x),x)").sage()
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 244, in __call__
        return cls(self, x, name=name)
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1382, in __init__
        raise_(TypeError, x, sys.exc_info()[2])
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1377, in __init__
        self._name = parent._create(value, name=name)
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 434, in _create
        self.set(name, value)
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/fricas.py", line 506, in set
        output = self.eval(cmd, reformat=False)
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/fricas.py", line 596, in eval
        **kwds)
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1294, in eval
        for L in code.split('\n') if L != ''])
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 905, in _eval_line
        self._start()
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/fricas.py", line 273, in _start
        Expect._start(self)
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 486, in _start
        (self.name(), cmd, e, self._install_hints()))
    TypeError: unable to start fricas because the command 'fricas -nox -noclef' failed: The command was not found or was not executable: fricas.

**********************************************************************
1 item had failures:
   1 of   3 in sage.interfaces.fricas.FriCASElement._sage_
    [3 tests, 1 failure, 0.19 s]
```



---

Comment by git created at 2016-08-24 00:18:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2016-08-24 00:47:33

Thanks, fixed.  I'm very sorry, but my git-foo is very weak, so there are some commits in the branch which do not belong.

If there is an easy way to get rid of them, please let me know...  They are:


```
​43c1136	Exclude plain text from IPython super call
​b027498	Merge branch 'u/vbraun/call_repr_once' of git://trac.sagemath.org/sage into develop

​1347786	Add jump_number() to posets.
​3e6ef52	<tab> to spaces.
​fe815c8	Merge branch 'u/jmantysalo/jump_number' of git://trac.sagemath.org/sage into fricas-interface
​aa04d96	Add algorithm-keyword to canonical labeling of posets.
​d923dc1	Merge branch 'u/jmantysalo/posets__add_algorithm_keyword_to_canonical_relabel__' of git://trac.sagemath.org/sage into fricas-interface


​92378ca	Fix for sage shell with TERM=dumb
​fc0b081	Merge branch 'u/mkoeppe/sage_mode_for_emacs_has_display_problem_in_sage_7_4_beta0' of git://trac.sagemath.org/sage into fricas-interface
```


Or should I just create a new branch and copy the good stuff into that new branch?


---

Comment by vbraun created at 2016-08-24 06:54:24

To undo the merge you have to go back to before it:

```
git reset --hard 2231cea79d5c2c11e3520b623c7b5f2a19548b7a
```

and then only add the commit you want

```
git cherry-pick c651222036f3a60e3d55a52423dc0e325d469e95
```

and then (force) push the new branch


---

Comment by dimpase created at 2016-08-30 04:53:37

https://trac.sagemath.org/ticket/21209#comment:64 shows that you need to implement `fricas.quit()` here.


---

Comment by mantepse created at 2016-08-30 06:21:13

https://trac.sagemath.org/ticket/21209#comment:66 indicates that it is sufficient to append a `\r` to the quitstring.


---

Comment by git created at 2016-09-15 14:54:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-09-15 15:43:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-09-16 14:24:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2016-09-16 14:28:30

Changing status from needs_work to needs_review.


---

Comment by bpage created at 2016-09-17 15:59:53

There is something strange about the way FriCAS matrices are being typeset.



```
sage: latex(fricas("matrix([[1,2],[3,4]])"))
 {\left[ 1, \: 2  \right]} \  {\left[ 3, \: 4  \right]} 
```

but

```
sage: fricas("matrix([[1,2],[3,4]])::TEX")
["$$", "\left[", "\begin{array}{cc}", "1 & 2 \\ ", "3 & 4 ", "\end{array}",
 "\right]", "$$"]
```

However in other cases it looks normal. For example:

```
sage: latex(fricas("integrate(sin(x/(1+sqrt(x))),x)"))
 \int ^{\displaystyle x} {{\sin  \left( {{ \%A \over {{\sqrt { \%A}}+1}}}  \right)} \  {d \%A}}   

sage: fricas("integrate(sin(x/(1+sqrt(x))),x)::TEX")
["$$", "\int \sp{\displaystyle x} {{\sin ", "\left(",
 "{{ \%A \over {{\sqrt { \%A}}+1}}} ", "\right)}", "\  {d \%A}} ", "$$"]
```



---

Comment by mantepse created at 2016-09-17 17:03:26

Replying to [comment:76 bpage]:
> There is something strange about the way FriCAS matrices are being typeset.
> 
> 
> {{{
> sage: latex(fricas("matrix([[1,2],[3,4]])"))
>  {\left[ 1, \: 2  \right]} \  {\left[ 3, \: 4  \right]} 
> }}}
> but
> {{{
> sage: fricas("matrix([[1,2],[3,4]])::TEX")
> ["$$", "\left[", "\begin{array}{cc}", "1 & 2 \\ ", "3 & 4 ", "\end{array}",
>  "\right]", "$$"]
> }}}

I am using `outputAsTex`.  Should I use `::TEX` instead?


---

Comment by bpage created at 2016-09-17 18:58:14

I am perplexed that `outputAsTex` does not produce the same thing as `::TEX`. I was not aware of that. Perhaps this should be reported as a bug in FriCAS? In any case it seems that the FriCAS command:

```
)set output tex on
```

uses the latter method.

```
(1) -> outputAsTex matrix [[1,2],[3,4]]
$$
{\left[ 1, \: 2 
\right]}
\  {\left[ 3, \: 4 
\right]}
\leqno(1)
$$

                                                                   Type: Void
(2) -> matrix([[1,2],[3,4]])::TEX

   (2)
   ["$$", "\left[", "\begin{array}{cc}", "1 & 2 \\ ", "3 & 4 ", "\end{array}",
    "\right]", "$$"]
                                                              Type: TexFormat
(3) -> )set output tex on
(3) -> matrix([[1,2],[3,4]])     

        +1  2+
   (3)  |    |
        +3  4+
$$
\left[
\begin{array}{cc}
1 & 2 \\ 
3 & 4 
\end{array}
\right]
\leqno(3)
$$

                                                        Type: Matrix(Integer)
```

I think it is reasonable to expect that typeset mode with the FriCAS interface would produce the same result.


---

Comment by mantepse created at 2016-09-20 07:30:11

ping?


---

Comment by git created at 2016-09-22 09:24:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bpage created at 2016-09-22 13:16:23

Thanks for the update. The output of

    sage: latex(fricas("matrix([[1,2],[3,4]])"))
    \left[ \begin{array}{cc} 1 & 2 \\ 3 & 4 \end{array}  \right]

now looks good but ...

In

    sage --notebook

the output from a cell beginning with

    %fricas

is no longer being typeset even though the `[x]Typeset` option is checked.


---

Comment by git created at 2016-09-22 18:51:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bpage created at 2016-09-24 14:28:39

My comment about how typeset mode works in the a Sage worksheet was incorrect. Everything looks good! Thanks.


---

Comment by bpage created at 2016-09-24 14:28:39

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-09-24 14:31:07

Merge conflict


---

Comment by vbraun created at 2016-09-24 14:31:07

Changing status from positive_review to needs_work.


---

Comment by bpage created at 2016-09-24 16:31:35

Replying to [comment:84 vbraun]:
> Merge conflict

I just did


```
wspage@strix ~/sage $ git branch
  develop
  master
* t/21231/fricas_interface
wspage@strix ~/sage $ git pull
remote: Counting objects: 1865, done.
remote: Compressing objects: 100% (794/794), done.
remote: Total 1291 (delta 1146), reused 618 (delta 493)
Receiving objects: 100% (1291/1291), 190.57 KiB | 175.00 KiB/s, done.
Resolving deltas: 100% (1146/1146), completed with 398 local objects.
From git://trac.sagemath.org/sage
   0ae5fd8..c5dadf9  develop    -> trac/develop
   62b052e..b57c07f  u/chapoton/21210 -> trac/u/chapoton/21210
   eda9412..c76bdfa  u/chapoton/21523 -> trac/u/chapoton/21523
   41d35fc..9114ec8  u/chapoton/21577 -> trac/u/chapoton/21577
 * [new branch]      u/jdemeyer/gp2c_does_not_pass_self_checks -> trac/u/jdemeyer/gp2c_does_not_pass_self_checks
 + f54ecb5...ccd9c1e u/jdemeyer/pari__use_prot_none_for_unused_virtual_stack_memory -> trac/u/jdemeyer/pari__use_prot_none_for_unused_virtual_stack_memory  (forced update)
 * [new tag]         7.4.beta6  -> 7.4.beta6
Already up-to-date.
```

and did not see any conflict.  How can I see what is wrong?


---

Comment by git created at 2016-09-24 17:00:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2016-09-24 17:02:12

fixed trivial merge conflict.


---

Comment by mantepse created at 2016-09-24 17:02:12

Changing status from needs_work to positive_review.


---

Comment by git created at 2016-09-26 06:10:31

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2016-09-26 06:10:31

Changing status from positive_review to needs_review.


---

Comment by charpent created at 2016-10-02 11:52:55

Changing status from needs_review to positive_review.


---

Comment by charpent created at 2016-10-02 11:52:55

Passes `ptestlong` on top of 7.4beta6 (+#21622, mandatory for getting Sage to compile) with one failure :

```
----------------------------------------------------------------------
sage -t --long --warn-long 113.7 src/sage/homology/simplicial_complex.py  # 1 doctest failed
----------------------------------------------------------------------
```


which passes standalone :


```
charpent@asus16-ec:/usr/local/sage-7$ sage -t --long --warn-long 113.7 src/sage/homology/simplicial_complex.py 
Running doctests with ID 2016-10-02-13-43-39-bc494aee.
Git branch: t/21231/fricas_interface
Using --optional=atlas,database_gap,mpir,python2,sage,sage_mode
Doctesting 1 file.
sage -t --long --warn-long 113.7 src/sage/homology/simplicial_complex.py
    [588 tests, 3.20 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 3.3 seconds
    cpu time: 3.0 seconds
    cumulative wall time: 3.2 seconds
```


This failure is a recurring known problem. ==> `positive_review` notwithstanding.


---

Comment by mantepse created at 2016-10-02 14:18:50

There are a few docbuild errors, I'll correct them tomorrow morning.


---

Comment by charpent created at 2016-10-02 15:44:30

Replying to [comment:90 mantepse]:
> There are a few docbuild errors,

Wups. I missed that (how did you find this ?).

> I'll correct them tomorrow morning.

Ring me afterwards, I'll re-test it un the evening (European time).


---

Comment by mantepse created at 2016-10-02 16:22:25

Replying to [comment:91 charpent]:
> Replying to [comment:90 mantepse]:
> > There are a few docbuild errors,
> 
> Wups. I missed that (how did you find this ?).

I only saw it on the patchbot report...  (there is one one 7.4 beta6 by cristal which seems to report something real)


---

Comment by git created at 2016-10-03 08:53:20

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2016-10-03 08:53:20

Changing status from positive_review to needs_review.


---

Comment by mantepse created at 2016-10-03 08:54:30

Everything should be fine now!


---

Comment by charpent created at 2016-10-03 19:28:41

Passes `ptestlong` with the same failure as before, which again passes standalone.

`positive_review`


---

Comment by charpent created at 2016-10-03 19:28:41

Changing status from needs_review to positive_review.


---

Comment by git created at 2016-10-10 10:25:49

Changing status from positive_review to needs_review.


---

Comment by git created at 2016-10-10 10:25:49

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by dimpase created at 2016-10-10 10:40:42

the latest push created a mega-patch for no good reason. What was the reason for this?


---

Comment by mantepse created at 2016-10-10 10:43:14

I am sorry, I thought I am supposed to merge when a new develop appears.  Could you tell me how to revert?


---

Comment by dimpase created at 2016-10-10 10:55:11

Replying to [comment:98 mantepse]:
> I am sorry, I thought I am supposed to merge when a new develop appears.  Could you tell me how to revert?

only if there are merge conflicts (which you would see by the Branch field in the ticket turning red).

Just [revert](http://stackoverflow.com/questions/927358/how-to-undo-last-commits-in-git) the last commit (and push again, with -f switch). Not sure how to do this using `git trac` if you must use it...
Let me know if you get stuck on this.


---

Comment by git created at 2016-10-10 11:08:59

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mantepse created at 2016-10-10 11:10:48

Replying to [comment:99 dimpase]:

Thank you!


---

Comment by dimpase created at 2016-10-10 11:22:26

OK, good, back to the positively reviewed patch.


---

Comment by dimpase created at 2016-10-10 11:22:26

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2016-10-12 06:20:24

You should not use a bare `except:` (see the end of `src/sage/symbolic/integration/external.py`). Moreover, I would suggest to replace

```
     try:
        return result.sage()
     except:
        raise ValueError("Unable to parse: {}".format(result))
```

by

```
return result.sage()
```



---

Comment by jdemeyer created at 2016-10-12 06:20:24

Changing status from positive_review to needs_work.


---

Comment by git created at 2016-10-12 06:31:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2016-10-12 06:32:19

I agree - I only adapted this part of the code.


---

Comment by mantepse created at 2016-10-12 08:22:39

could you set this back to positive review?  I would really like to get this into sage soon, because there will be trivial, but tedious merge conflicts all the time otherwise.  I'd be grateful...


---

Comment by jdemeyer created at 2016-10-12 08:38:30

Well, if you don't set it to `needs_review`, I don't know that it's ready for review.


---

Comment by jdemeyer created at 2016-10-12 08:38:30

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2016-10-12 08:39:37

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-10-21 07:04:20

Resolution: fixed
