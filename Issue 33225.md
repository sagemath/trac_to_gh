# Issue 33225: Use Arb by default in bernoulli() for large n

Issue created by migration from https://trac.sagemath.org/ticket/33462

Original creator: fredrik.johansson

Original creation time: 2022-03-05 10:15:10

Keywords: performance, bernoulli numbers

`bernoulli(n)` currently uses algorithm='flint' for n <= 20000, 'arb' for n <= 300000 and 'bernmm' for larger values

Now that Arb has been upgrated to version 2.22, using 'arb' by default should always be faster than 'bernmm', and it should be faster than 'flint' except for n <= 1000 or so.

Anyone interested in this might also look into adding an Arb backend for `euler_number` and Flint backends for `stirling_number1` and `stirling_number2`.


```
sage: %timeit u=bernoulli(10^2);
5.81 µs ± 70.2 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit u=bernoulli(10^2, algorithm="arb");
7.29 µs ± 85.9 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)

sage: %timeit u=bernoulli(300);
15.2 µs ± 95.8 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit u=bernoulli(300, algorithm="arb");
15.9 µs ± 188 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)

sage: %timeit u=bernoulli(1000);
96.3 µs ± 470 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
sage: %timeit u=bernoulli(1000, algorithm="arb");
93.7 µs ± 615 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)

sage: %timeit u=bernoulli(3000);
980 µs ± 5.55 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
sage: %timeit u=bernoulli(3000, algorithm="arb");
931 µs ± 7.29 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)

sage: %timeit u=bernoulli(10^4);
13.1 ms ± 199 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
sage: %timeit u=bernoulli(10^4, algorithm="arb");
12.5 ms ± 90.7 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)

sage: %time u=bernoulli(10^5);
CPU times: user 782 ms, sys: 0 ns, total: 782 ms
Wall time: 783 ms
sage: %time u=bernoulli(10^5, algorithm="arb");
CPU times: user 780 ms, sys: 3.95 ms, total: 784 ms
Wall time: 792 ms

sage: %time u=bernoulli(300002);                                                                    
CPU times: user 18.9 s, sys: 12 ms, total: 18.9 s
Wall time: 18.9 s
sage: %time u=bernoulli(300002, algorithm="arb");                                                   
CPU times: user 4.41 s, sys: 3.98 ms, total: 4.41 s
Wall time: 4.41 s

sage: %time u=bernoulli(10^6);
CPU times: user 3min 30s, sys: 460 ms, total: 3min 30s
Wall time: 3min 31s
sage: %time u=bernoulli(10^6, algorithm="arb");
CPU times: user 45.3 s, sys: 176 ms, total: 45.5 s
Wall time: 45.7 s
```



---

Comment by @Parcly-Taxel created at 2022-09-12 02:36:45

It seems that 'arb' is at least as fast as 'flint' and 'bernmm' in *all* cases, so we should be able to just change the default value of the `algorithm` argument of `bernoulli()` to 'arb':


```
sage: for k in [300002, 500000, 857142, 10^6]:
....:     print(k, "->", bernoulli(k).denom())
....:     %timeit u=bernoulli(k)
....:     %timeit u=bernoulli(k, algorithm="arb")
....: 
300002 -> 6
11.2 s ± 22.2 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
2.54 s ± 908 µs per loop (mean ± std. dev. of 7 runs, 1 loop each)
500000 -> 584711591137493802510
29.8 s ± 3.59 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
6.12 s ± 5.2 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
857142 -> 105840750435775953936277435815611490313458
1min 26s ± 133 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
16 s ± 4.91 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
1000000 -> 936123257411127577818510
1min 58s ± 98.9 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
21 s ± 30.5 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
```



```
sage: for k in range(1000, 20001, 1000):
....:     print(k, "->", bernoulli(k).denom())
....:     %timeit u=bernoulli(k)
....:     %timeit u=bernoulli(k, algorithm="arb")
....: 
1000 -> 342999030
54.4 µs ± 135 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
50.8 µs ± 22.2 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
2000 -> 2338224387510
200 µs ± 113 ns per loop (mean ± std. dev. of 7 runs, 1,000 loops each)
203 µs ± 129 ns per loop (mean ± std. dev. of 7 runs, 1,000 loops each)
3000 -> 12072109463901626300591430
532 µs ± 2.8 µs per loop (mean ± std. dev. of 7 runs, 1,000 loops each)
503 µs ± 453 ns per loop (mean ± std. dev. of 7 runs, 1,000 loops each)
4000 -> 9355235774427510
924 µs ± 307 ns per loop (mean ± std. dev. of 7 runs, 1,000 loops each)
916 µs ± 1.72 µs per loop (mean ± std. dev. of 7 runs, 1,000 loops each)
5000 -> 342999030
1.52 ms ± 3.22 µs per loop (mean ± std. dev. of 7 runs, 1,000 loops each)
1.47 ms ± 441 ns per loop (mean ± std. dev. of 7 runs, 1,000 loops each)
6000 -> 23819712138720623763379673045824710
2.38 ms ± 1.26 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
2.32 ms ± 1.4 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
7000 -> 973943254441542227370
3.3 ms ± 2.03 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
3.2 ms ± 1.28 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
8000 -> 14977732474858443510
4.44 ms ± 1.68 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
4.2 ms ± 1.79 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
9000 -> 4091851784687571609141381951327092757255270
5.67 ms ± 1.34 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
5.37 ms ± 1.74 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
10000 -> 2338224387510
7.02 ms ± 1.67 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
6.72 ms ± 2.39 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
11000 -> 3862356698269410
8.99 ms ± 1.1 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
8.7 ms ± 1.54 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
12000 -> 9244358821901057920696360970065432476870
10.8 ms ± 23.3 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
10.2 ms ± 1.67 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
13000 -> 68225826385202094166345590
12.5 ms ± 2.43 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
11.9 ms ± 3.47 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
14000 -> 2101447285714761763613810041770
15 ms ± 9.12 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
14.3 ms ± 3.05 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
15000 -> 12072109463901626300591430
17.2 ms ± 3.12 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
16.6 ms ± 3.36 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
16000 -> 153621224988664580900849910
19.8 ms ± 3.53 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
18.8 ms ± 3.47 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
17000 -> 399469361302110
22.5 ms ± 59.3 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
21.4 ms ± 35.2 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
18000 -> 8073711716830936658066202329411001478249309991945190
25.5 ms ± 18.4 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
24.8 ms ± 30.4 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
19000 -> 8555679771912016170204030
29 ms ± 51.6 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
27.7 ms ± 21.8 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
20000 -> 9355235774427510
31.9 ms ± 15 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
30.1 ms ± 22.1 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
```



```
sage: for k in range(50, 2300, 50):
....:     print(k, "->", bernoulli(k).denom())
....:     %timeit u=bernoulli(k)
....:     %timeit u=bernoulli(k, algorithm="arb")
....: 
50 -> 66
2.63 µs ± 6.47 ns per loop (mean ± std. dev. of 7 runs, 100,000 loops each)
1.88 µs ± 12.2 ns per loop (mean ± std. dev. of 7 runs, 1,000,000 loops each)
100 -> 33330
3.41 µs ± 8.94 ns per loop (mean ± std. dev. of 7 runs, 100,000 loops each)
2.76 µs ± 3.86 ns per loop (mean ± std. dev. of 7 runs, 100,000 loops each)
150 -> 2162622
4.31 µs ± 8.4 ns per loop (mean ± std. dev. of 7 runs, 100,000 loops each)
3.38 µs ± 5.75 ns per loop (mean ± std. dev. of 7 runs, 100,000 loops each)
200 -> 1366530
5.01 µs ± 5.8 ns per loop (mean ± std. dev. of 7 runs, 100,000 loops each)
4.46 µs ± 8.77 ns per loop (mean ± std. dev. of 7 runs, 100,000 loops each)
250 -> 16566
6.8 µs ± 3.03 ns per loop (mean ± std. dev. of 7 runs, 100,000 loops each)
5.92 µs ± 14 ns per loop (mean ± std. dev. of 7 runs, 100,000 loops each)
300 -> 866054419230
8.34 µs ± 19 ns per loop (mean ± std. dev. of 7 runs, 100,000 loops each)
7.5 µs ± 16.1 ns per loop (mean ± std. dev. of 7 runs, 100,000 loops each)
350 -> 4686
10.4 µs ± 10.6 ns per loop (mean ± std. dev. of 7 runs, 100,000 loops each)
9.56 µs ± 9.8 ns per loop (mean ± std. dev. of 7 runs, 100,000 loops each)
400 -> 9315635010
10.3 µs ± 33.9 ns per loop (mean ± std. dev. of 7 runs, 100,000 loops each)
10.1 µs ± 176 ns per loop (mean ± std. dev. of 7 runs, 100,000 loops each)
450 -> 41089818
12.5 µs ± 137 ns per loop (mean ± std. dev. of 7 runs, 100,000 loops each)
12.1 µs ± 157 ns per loop (mean ± std. dev. of 7 runs, 100,000 loops each)
500 -> 8365830
15.4 µs ± 10.2 ns per loop (mean ± std. dev. of 7 runs, 100,000 loops each)
15.4 µs ± 9.4 ns per loop (mean ± std. dev. of 7 runs, 100,000 loops each)
550 -> 1518
17.6 µs ± 21.2 ns per loop (mean ± std. dev. of 7 runs, 100,000 loops each)
16.8 µs ± 51.3 ns per loop (mean ± std. dev. of 7 runs, 100,000 loops each)
600 -> 21340446944246430
21.3 µs ± 13.9 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
19.8 µs ± 62.6 ns per loop (mean ± std. dev. of 7 runs, 100,000 loops each)
650 -> 8646
21.8 µs ± 15 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
21.9 µs ± 33.6 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
700 -> 48107155470
29.3 µs ± 14.5 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
27.8 µs ± 37.3 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
750 -> 407656409622
32.2 µs ± 14.8 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
32.1 µs ± 39.4 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
800 -> 9315635010
31.3 µs ± 66.6 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
30.2 µs ± 35.4 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
850 -> 66
39.4 µs ± 41.6 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
37 µs ± 17.2 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
900 -> 110199362466082890
39.3 µs ± 38.2 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
39.4 µs ± 42.2 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
950 -> 12606
48.5 µs ± 38.2 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
48.3 µs ± 24.2 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
1000 -> 342999030
55.5 µs ± 34.1 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
51.2 µs ± 17.7 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
1050 -> 1464173668545126
54.3 µs ± 43.6 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
54.5 µs ± 54.8 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
1100 -> 766590
58.4 µs ± 38.8 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
57.5 µs ± 51.8 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
1150 -> 3570402
72.1 µs ± 24.1 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
70.9 µs ± 35.8 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
1200 -> 42107247672297314156359710
70 µs ± 36.7 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
69.7 µs ± 34.5 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
1250 -> 16566
75.9 µs ± 64.3 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
75.3 µs ± 56.1 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
1300 -> 301064657190
79.2 µs ± 35.5 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
78.5 µs ± 184 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
1350 -> 11135340678
88.9 µs ± 212 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
89.2 µs ± 1.01 µs per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
1400 -> 554242538169870
116 µs ± 2.91 µs per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
101 µs ± 971 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
1450 -> 5650194
110 µs ± 1.23 µs per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
109 µs ± 1.33 µs per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
1500 -> 163252124079274230
122 µs ± 715 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
122 µs ± 1.86 µs per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
1550 -> 20526
127 µs ± 322 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
117 µs ± 231 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
1600 -> 14914331651010
117 µs ± 749 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
117 µs ± 569 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
1650 -> 1103090766162
148 µs ± 245 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
141 µs ± 345 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
1700 -> 33330
143 µs ± 2.07 µs per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
142 µs ± 58.8 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
1750 -> 1176186
173 µs ± 510 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
166 µs ± 504 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
1800 -> 357004741097023204553137770
155 µs ± 271 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
157 µs ± 553 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
1850 -> 66
184 µs ± 531 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
182 µs ± 805 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
1900 -> 12101823030
193 µs ± 314 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
193 µs ± 143 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
1950 -> 43665282377178
224 µs ± 44.4 ns per loop (mean ± std. dev. of 7 runs, 1,000 loops each)
213 µs ± 546 ns per loop (mean ± std. dev. of 7 runs, 1,000 loops each)
2000 -> 2338224387510
201 µs ± 145 ns per loop (mean ± std. dev. of 7 runs, 1,000 loops each)
203 µs ± 145 ns per loop (mean ± std. dev. of 7 runs, 1,000 loops each)
2050 -> 5478
194 µs ± 136 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
188 µs ± 3.36 µs per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
2100 -> 5018284389659301123019967310
215 µs ± 216 ns per loop (mean ± std. dev. of 7 runs, 1,000 loops each)
216 µs ± 255 ns per loop (mean ± std. dev. of 7 runs, 1,000 loops each)
2150 -> 28446
247 µs ± 207 ns per loop (mean ± std. dev. of 7 runs, 1,000 loops each)
232 µs ± 285 ns per loop (mean ± std. dev. of 7 runs, 1,000 loops each)
2200 -> 2797286910
234 µs ± 183 ns per loop (mean ± std. dev. of 7 runs, 1,000 loops each)
236 µs ± 166 ns per loop (mean ± std. dev. of 7 runs, 1,000 loops each)
2250 -> 17435056983123318
258 µs ± 206 ns per loop (mean ± std. dev. of 7 runs, 1,000 loops each)
258 µs ± 750 ns per loop (mean ± std. dev. of 7 runs, 1,000 loops each)
```

