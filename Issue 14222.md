# Issue 14222: Runaway ECL processes

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2013-04-08 08:57:37

Assignee: roed

CC:  leif jpflori

Under some circumstances, after doctesting, there remain ECL processes consuming more and more memory.


---

Comment by jdemeyer created at 2013-04-08 10:33:23

Changing assignee from roed to jdemeyer.


---

Comment by jdemeyer created at 2013-04-08 10:33:23

Changing component from doctest framework to packages: standard.


---

Comment by jdemeyer created at 2013-04-08 11:41:10

Changing status from new to needs_review.


---

Comment by cremona created at 2013-04-08 12:12:49

I am testing this now, on a machine which showed the problem up to now.  I expect it to work since it's the machine on which Jeroen diagnosed the problem, so anyone else who saw the problem should test it too.


---

Comment by leif created at 2013-04-08 19:38:24

Isn't the problem also that PExpect interfaces apparently do not properly get shut down?




The bug / patch should be (better) documented in the spkg;  AFAICS there's not even a link to the upstream report there.


---

Comment by novoselt created at 2013-04-08 19:50:39

Fixes the problem for me!


---

Comment by cremona created at 2013-04-08 19:59:42

I installed the spkg and patch and now almost no file can be doctested successfully.  For example

```
      File "/home/jec/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/maxima_lib.py", line 80, in <module>
        ecl_eval("(require 'maxima)")
      File "ecl.pyx", line 1225, in sage.libs.ecl.ecl_eval (sage/libs/ecl.c:7102)
      File "ecl.pyx", line 1240, in sage.libs.ecl.ecl_eval (sage/libs/ecl.c:7039)
      File "ecl.pyx", line 246, in sage.libs.ecl.ecl_safe_eval (sage/libs/ecl.c:2901)
    RuntimeError: ECL says: Module error: Don't know how to REQUIRE MAXIMA.
```



---

Comment by leif created at 2013-04-08 20:04:42

Replying to [comment:12 cremona]:
> I installed the spkg and patch and now almost no file can be doctested successfully.  For example
> {{{
>       File "/home/jec/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/maxima_lib.py", line 80, in <module>
>         ecl_eval("(require 'maxima)")
>       File "ecl.pyx", line 1225, in sage.libs.ecl.ecl_eval (sage/libs/ecl.c:7102)
>       File "ecl.pyx", line 1240, in sage.libs.ecl.ecl_eval (sage/libs/ecl.c:7039)
>       File "ecl.pyx", line 246, in sage.libs.ecl.ecl_safe_eval (sage/libs/ecl.c:2901)
>     RuntimeError: ECL says: Module error: Don't know how to REQUIRE MAXIMA.
> }}}

You of course have to rebuild the spkgs that depend on ECL as well, i.e., Maxima, and do `sage -b` afterwards.


---

Comment by leif created at 2013-04-08 20:15:57

FWIW, I think we met that "double-fault" problem with `stderr` before, quite a while ago, and IIRC discussed it with upstream, so it's a bit astonishing it's still in.  (Although the circumstances were probably slightly different.)


---

Comment by leif created at 2013-04-08 20:22:36

`SPKG.txt` lacks a "Patches" section, and the following "Special Update/Build Instructions" should get corrected:


```
 * Note: the way we configure Sage, CXX and CXXFLAGS are unused.
 * Note: for the time being, ECL is built single threaded library as it
   seems to interact badly with the pexpect interface and Sage's signal
   handling when built multithreaded.
```

(Related to the first, printing the settings of `CXX` and `CXXFLAGS` in `spkg-install` then makes no sense.)


---

Comment by leif created at 2013-04-08 22:02:33

As expected, for me solves the [comment:ticket:14055:36 issues with ECL and (Ubuntu's) GNU Make 3.81 and the new doctesting framework] on Ubuntu 10.04.4 LTS x86_64.  (Haven't tested on x86 yet, but I assume it will fix the specific ECL issue there as well.)

Still, a working cleaner should have properly killed the processes, and it's not obvious what actually caused ECL running amok (i.e., why writing to `stderr` fails in the first place).


---

Comment by jdemeyer created at 2013-04-09 06:15:59

I made some further small changes to the `spkg-install` file.


---

Comment by cremona created at 2013-04-09 14:09:42

OK, it worked for me after both rebuilding maxima and also the whole Sage library (sage -ba) after applying the patch and new spkg.


---

Comment by vbraun created at 2013-04-09 14:30:18

Looks good to me


---

Comment by vbraun created at 2013-04-09 14:30:18

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-04-10 06:58:25

On various, this causes ECL-related doctest failures. I have no idea why...


---

Comment by jdemeyer created at 2013-04-10 07:00:29

Also: `/dev/full` doesn't exist on all systems.


---

Attachment


---

Comment by jdemeyer created at 2013-04-10 07:27:23

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-04-10 07:58:22

In particular, the doctest

```
sage: var('a,b,c') ## line 416 ##
(a, b, c)
sage: eqn = [a+b*c==1, b-a*c==0, a+b==5] ## line 418 ##
sage: s = solve(eqn, a,b,c); s ## line 419 ##
```

in `devel/sage/doc/en/constructions/linear_algebra.rst` seems problematic for ECL.


---

Comment by vbraun created at 2013-04-10 09:38:28

I guess `/dev/full` is linux only.

I don't get any doctest failures from `linear_algebra.rst`, for the record.


---

Comment by jdemeyer created at 2013-04-10 09:49:37

Replying to [comment:24 vbraun]:
> I don't get any doctest failures from `linear_algebra.rst`, for the record.
Well, the error isn't reproducible. When it fails, it usually fails like

```
sage: var('a,b,c') ## line 416 ##
(a, b, c)
sage: eqn = [a+b*c==1, b-a*c==0, a+b==5] ## line 418 ##
sage: s = solve(eqn, a,b,c); s ## line 419 ##

;;; Unhandled lisp initialization error
;;; Message:
UNBOUND-VARIABLE
;;; Arguments:

Internal or unrecoverable error in:

Lisp initialization error.

  [2: No such file or directory]

;;; ECL C Backtrace
;;; /home/buildbot/build/sage/eno-1/eno_full/build/sage-5.9.rc0/local/lib/libecl.so.12.12(si_dump_c_backtrace+0x28) [0x7f6a15678208]
;;; /home/buildbot/build/sage/eno-1/eno_full/build/sage-5.9.rc0/local/lib/libecl.so.12.12(ecl_internal_error+0x3f) [0x7f6a156631df]
;;; /home/buildbot/build/sage/eno-1/eno_full/build/sage-5.9.rc0/local/lib/libecl.so.12.12(+0x124324) [0x7f6a15663324]
;;; /home/buildbot/build/sage/eno-1/eno_full/build/sage-5.9.rc0/local/lib/libecl.so.12.12(cl_funcall+0x70) [0x7f6a15646410]
;;; /home/buildbot/build/sage/eno-1/eno_full/build/sage-5.9.rc0/local/lib/libecl.so.12.12(cl_error+0xdb) [0x7f6a1566416b]
;;; /home/buildbot/build/sage/eno-1/eno_full/build/sage-5.9.rc0/local/lib/libecl.so.12.12(+0x1254b2) [0x7f6a156644b2]
;;; /home/buildbot/build/sage/eno-1/eno_full/build/sage-5.9.rc0/local/lib/libecl.so.12.12(FEwrong_type_argument+0x1e) [0x7f6a156644de]
;;; /home/buildbot/build/sage/eno-1/eno_full/build/sage-5.9.rc0/local/lib/libecl.so.12.12(stream_dispatch_table+0x17) [0x7f6a15656e47]
;;; /home/buildbot/build/sage/eno-1/eno_full/build/sage-5.9.rc0/local/lib/libecl.so.12.12(ecl_write_char+0x1b) [0x7f6a156576db]
;;; /home/buildbot/build/sage/eno-1/eno_full/build/sage-5.9.rc0/local/lib/libecl.so.12.12(+0x13769b) [0x7f6a1567669b]
;;; /home/buildbot/build/sage/eno-1/eno_full/build/sage-5.9.rc0/local/lib/libecl.so.12.12(_ecl_write_symbol+0x156) [0x7f6a15676bf6]
;;; /home/buildbot/build/sage/eno-1/eno_full/build/sage-5.9.rc0/local/lib/libecl.so.12.12(si_write_ugly_object+0x26) [0x7f6a15675cf6]
;;; /home/buildbot/build/sage/eno-1/eno_full/build/sage-5.9.rc0/local/lib/libecl.so.12.12(+0x12430b) [0x7f6a1566330b]
;;; /home/buildbot/build/sage/eno-1/eno_full/build/sage-5.9.rc0/local/lib/libecl.so.12.12(cl_funcall+0x70) [0x7f6a15646410]
;;; /home/buildbot/build/sage/eno-1/eno_full/build/sage-5.9.rc0/local/lib/libecl.so.12.12(cl_error+0xdb) [0x7f6a1566416b]
;;; /home/buildbot/build/sage/eno-1/eno_full/build/sage-5.9.rc0/local/lib/libecl.so.12.12(+0x125308) [0x7f6a15664308]
;;; /home/buildbot/build/sage/eno-1/eno_full/build/sage-5.9.rc0/local/lib/libecl.so.12.12(ecl_interpret+0x19cd) [0x7f6a1564869d]
;;; /home/buildbot/build/sage/eno-1/eno_full/build/sage-5.9.rc0/local/lib/libecl.so.12.12(+0x10e36f) [0x7f6a1564d36f]
;;; /home/buildbot/build/sage/eno-1/eno_full/build/sage-5.9.rc0/local/lib/libecl.so.12.12(si_eval_with_env+0x2eb) [0x7f6a1564ef2b]
;;; /home/buildbot/build/sage/eno-1/eno_full/build/sage-5.9.rc0/local/lib/libecl.so.12.12(si_signal_simple_error+0x26d) [0x7f6a15613e6d]
;;; /home/buildbot/build/sage/eno-1/eno_full/build/sage-5.9.rc0/local/lib/libecl.so.12.12(FEwrong_type_nth_arg+0x109) [0x7f6a15663d29]
;;; /home/buildbot/build/sage/eno-1/eno_full/build/sage-5.9.rc0/local/lib/libecl.so.12.12(_ecl_sethash+0) [0x7f6a156901a0]
;;; /home/buildbot/build/sage/eno-1/eno_full/build/sage-5.9.rc0/local/lib/libecl.so.12.12(+0x14df58) [0x7f6a1568cf58]
;;; /lib64/libpthread.so.0() [0x36e9e0f500]
;;; /home/buildbot/build/sage/eno-1/eno_full/build/sage-5.9.rc0/local/lib/libecl.so.12.12(+0xb621e) [0x7f6a155f521e]
;;; /home/buildbot/build/sage/eno-1/eno_full/build/sage-5.9.rc0/local/lib/libecl.so.12.12(+0xbce17) [0x7f6a155fbe17]
;;; /home/buildbot/build/sage/eno-1/eno_full/build/sage-5.9.rc0/local/lib/libecl.so.12.12(+0xbd368) [0x7f6a155fc368]
;;; /home/buildbot/build/sage/eno-1/eno_full/build/sage-5.9.rc0/local/lib/libecl.so.12.12(+0xbd882) [0x7f6a155fc882]
;;; /home/buildbot/build/sage/eno-1/eno_full/build/sage-5.9.rc0/local/lib/libecl.so.12.12(+0xbd8bd) [0x7f6a155fc8bd]
;;; /home/buildbot/build/sage/eno-1/eno_full/build/sage-5.9.rc0/local/lib/libecl.so.12.12(+0xbd8bd) [0x7f6a155fc8bd]
;;; /home/buildbot/build/sage/eno-1/eno_full/build/sage-5.9.rc0/local/lib/libecl.so.12.12(+0xbd8bd) [0x7f6a155fc8bd]
;;; /home/buildbot/build/sage/eno-1/eno_full/build/sage-5.9.rc0/local/lib/libecl.so.12.12(+0xbd8bd) [0x7f6a155fc8bd]

**********************************************************************
----------------------------------------------------------------------
sage -t --long devel/sage/doc/en/constructions/linear_algebra.rst  # Killed due to abort
----------------------------------------------------------------------
```



---

Comment by jdemeyer created at 2013-04-11 09:41:12

New version of the patch seems to work fine.


---

Comment by jdemeyer created at 2013-04-11 09:41:12

Changing status from needs_work to needs_review.


---

Comment by jpflori created at 2013-04-11 10:09:27

I guess you mean the version where you check /dev/full exists?


---

Comment by jdemeyer created at 2013-04-11 10:22:23

Replying to [comment:28 jpflori]:
> I guess you mean the version where you check /dev/full exists?
And the new version of `patches/write_error.patch` inside the ECL spkg.


---

Comment by jpflori created at 2013-04-11 10:26:55

Could you post the old version so that I can spot the differences?


---

Comment by jdemeyer created at 2013-04-11 11:38:32

Replying to [comment:30 jpflori]:
> Could you post the old version so that I can spot the differences?
I don't have the old version anymore. But that doesn't matter, could you perhaps review it as if there never was a previous version?


---

Comment by jpflori created at 2013-04-11 12:42:00

As the patch is quite simple, I was wondering what was failing before and caused the random failures, but of course I can pretend this previous version did not exist.


---

Comment by jdemeyer created at 2013-04-11 12:57:19

The previous version patched `restartable_io_error()` but that was called from different places, possibly causing the problems.


---

Comment by vbraun created at 2013-04-12 14:43:53

Looks good to me.


---

Comment by vbraun created at 2013-04-12 14:43:53

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-04-12 14:50:05

Resolution: fixed


---

Comment by Snark created at 2013-04-12 15:18:19

Was the patch forwarded to upstream?


---

Comment by jdemeyer created at 2013-04-12 15:23:10

Replying to [comment:36 Snark]:
> Was the patch forwarded to upstream?
Yes.


---

Comment by Snark created at 2013-04-12 15:33:57

Replying to [comment:37 jdemeyer]:
> Replying to [comment:36 Snark]:
> > Was the patch forwarded to upstream?
> Yes.

Perfect!


---

Comment by jhpalmieri created at 2013-04-13 03:25:32

Replying to [comment:25 jdemeyer]:
> Replying to [comment:24 vbraun]:
> > I don't get any doctest failures from `linear_algebra.rst`, for the record.
> Well, the error isn't reproducible. When it fails, it usually fails like

Are you sure this is related to this ticket? I only see this after applying the patches at #14055, and I see this whether I have applied the patches here or not. This is happening on both mark and taurus. (I also mentioned it on #14055.)


---

Comment by jdemeyer created at 2013-04-29 12:34:29

Replying to [comment:36 Snark]:
> Was the patch forwarded to upstream?
Yes, but upstream is totally ignoring it...


---

Comment by dimpase created at 2015-07-20 20:13:45

Replying to [comment:40 jdemeyer]:
> Replying to [comment:36 Snark]:
> > Was the patch forwarded to upstream?
> Yes, but upstream is totally ignoring it...

here is another try. Upstream points out, correctly, that the patch does not work if ECL is configured without disabling threads.

https://gitlab.com/embeddable-common-lisp/ecl/merge_requests/1
and
https://gitlab.com/embeddable-common-lisp/ecl/issues/43
