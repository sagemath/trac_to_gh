# Issue 21988: LatticePoset: add quotient lattice

Issue created by migration from https://trac.sagemath.org/ticket/22225

Original creator: jmantysalo

Original creation time: 2017-01-21 19:00:03

CC:  mantepse

This patch will add a function to compute the quotient lattice.


---

Comment by jmantysalo created at 2017-01-21 19:04:11

Martin, you reviewed #20058 and so may be interested in this too. The code should work, but I am currently compiling it on a slow machine.

What you think about function name, parameter names and examples? I am not very satisfied, but don't know what would be better.
----
New commits:


---

Comment by git created at 2017-01-22 06:37:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2017-01-22 07:41:08

Changing status from new to needs_review.


---

Comment by mantepse created at 2017-01-22 08:23:36

* I think you should specify the possibilities for `element_constructor` in the docstring.

* it might be nice to show an example using the `FiniteLatticePoset.congruence` method.

* why aren't you satisfied with the names?


---

Comment by jmantysalo created at 2017-01-22 08:33:51

Replying to [comment:5 mantepse]:
> * I think you should specify the possibilities for `element_constructor` in the docstring.

True. I'll do.

> * it might be nice to show an example using the `FiniteLatticePoset.congruence` method.

?? All examples are done with that. Actually this `quotient()` function makes no sense alone.

> * why aren't you satisfied with the names?

Should `element_constructor` be `element_labels`? Should I have `C` or `T` (from `\Theta`) as first parameter? `'integer'` or `'integers'`? I feel that there is no natural and clear naming. Might be because I don't write in my native language.


---

Comment by mantepse created at 2017-01-22 09:09:06

Replying to [comment:6 jmantysalo]:
> Replying to [comment:5 mantepse]:

> > * it might be nice to show an example using the `FiniteLatticePoset.congruence` method.
> 
> ?? All examples are done with that. Actually this `quotient()` function makes no sense alone.

I'm sorry, I must have been blind.  Please excuse me.


---

Comment by git created at 2017-01-22 09:47:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2017-01-22 09:55:52

Is it "quotient by congruence" or "quotient of congruence" or something else?


---

Comment by jmantysalo created at 2017-01-29 14:04:13

More comments for this one?


---

Comment by tscrim created at 2017-01-29 14:35:27

I would change the docstring to

```
        Return the quotient lattice by ``congruence``.

        Let `L` be a lattice and `\Theta` be a congruence of `L` with
        congurence classes `\Theta_1, \Theta_2, \ldots`. The quotient
        lattice `L/\Theta` is the lattice with elements
        `\{\Theta_1, \Theta_2, \ldots\}` and meet and join given by the
        original lattice. Explicitly, if `e_1 \in \Theta_1` and
        `e_2 \in \Theta_2`, such that `e_1 \vee e_2 \in \Theta_3` then
        `\Theta_1 \vee \Theta_2 = \Theta_3` in `L/\Theta` and similarly
        for meets.

        INPUT:

        - ``congruence`` -- list of lists; a congruence

        - ``element_constructor`` -- string; the elements of the resulting
          lattice and can be one of the following:

          * ``'tuple'`` - elements are tuples of elements of the original
            lattice
          * ``'lattice'`` - elements are sublattices of the original lattice
          * ``'integer'`` - elements are labeled by integers

        .. WARNING::

            ``congruence`` is expected to be a valid congruence of the
            lattice. This is *not* checked.
```

I would also change `element_constructor` to `element_labels` as the former suggests it allows a function valid input.


---

Comment by jmantysalo created at 2017-01-30 06:58:17

I would like to have as few `WARNING`s as possible. Can we avoid that by requiring the input to be of type SetPartition? And/or `rename()` the set partition given by `congruence()`? Then the user would really need to break things to get an error.

Or do we break something if we just put extra value `._congruence_base_lattice` pointing to the lattice to a `SetPartition`-object? Of course that would cost some extra bytes for every congruence.


---

Comment by tscrim created at 2017-01-30 15:37:29

Replying to [comment:12 jmantysalo]:
> I would like to have as few `WARNING`s as possible.

Then you need to check that your input is a valid congruence.

> Can we avoid that by requiring the input to be of type SetPartition? And/or `rename()` the set partition given by `congruence()`? Then the user would really need to break things to get an error.

I don't see anything in the code that assumes it is an instance of `SetPartition`. So I don't understand what you're trying to get at here. Although I suspect it is not the issue.

> Or do we break something if we just put extra value `._congruence_base_lattice` pointing to the lattice to a `SetPartition`-object? Of course that would cost some extra bytes for every congruence.

I'm not sure what you mean here.


---

Comment by git created at 2017-01-30 19:18:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2017-01-30 19:20:47

Replying to [comment:13 tscrim]:
> I'm not sure what you mean here.

I made a PoC, see the code.

As currently `LatticePoset` is never deallocated, it does not hurt more to have an extra pointer for it. But of course this will still eat some bytes.


---

Comment by tscrim created at 2017-01-31 15:07:43

That is going to fail in an extremely subtle way if the user passes in something constructed from `congruence` and then the "same" set partition constructed directly. It is also completely unnecessary by how you are handling the input.

If you want a check, then you need to check that it satisfies the properties of being a congruence (I would also then add an extra argument `check=True` to have the option of turning this off). Otherwise it needs to be a `.. WARNING::`.


---

Comment by jmantysalo created at 2017-02-01 20:34:28

Replying to [comment:16 tscrim]:
> That is going to fail in an extremely subtle way if the user passes in something constructed from `congruence` and then the "same" set partition constructed directly.

?? With this PoC:


```
sage: L1 = Posets.BooleanLattice(3)
sage: L2 = L1.relabel(lambda x: 7-x)
sage: c = L1.congruence([[0, 1]])
sage: L2.quotient(c)

. . . ValueError: AAARghsss!
```


But OK, I'll change the docstring.


---

Comment by tscrim created at 2017-02-02 00:31:25

The problem is if they pass in the "same" set partition for the congruence but not created by `L1.congruence`:

```
sage: L1 = Posets.BooleanLattice(3)
sage: c = L1.congruence([[0, 1]]); c
{{0, 1}, {2, 3}, {4, 5}, {6, 7}}
sage: L1.quotient(c)
Finite lattice containing 4 elements
sage: c2 = SetPartition([[0,1], [2,3], [4,5], [6,7]])
sage: c == c2
True
sage: L1.quotient(c2)
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
...
AttributeError: 'SetPartitions_all_with_category.element_class' object has no attribute '_congruence_base_lattice'
```



---

Comment by jmantysalo created at 2017-02-02 04:49:02

Replying to [comment:18 tscrim]:
> The problem is if they pass in the "same" set partition for the congruence but not created by `L1.congruence`:
> {{{
> sage: c == c2
> True
> }}}

OK, I understand. So to avoid warning we should have a specific class (inherited from `SetPartition`), but that's too much. If we only change `name` on result from `congruence` it would help too little.

I'll do docstring modification.


---

Comment by git created at 2017-02-02 08:36:58

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jmantysalo created at 2017-02-02 08:50:22

Changing status from needs_review to needs_work.


---

Comment by jmantysalo created at 2017-02-02 08:50:22

Added Travis to author, as I took the docstring from him.

Replying to [comment:11 tscrim]:

> I would also change `element_constructor` to `element_labels` as the former suggests it allows a function valid input.

Hmm... `vertical_composition` has `labels`, `sublattices_lattice` has `element_constructor`. On posets `disjoint_union` etc. has `labels`. OTOH `with_bounds` have `labels` with different meaning. Only `antichains` and `chains` use `element_constructor`.

But yes, I think `labels` is best one. Martin, comments on this?


---

Comment by tscrim created at 2017-02-02 15:31:48

I second `labels`.


---

Comment by git created at 2017-02-03 07:32:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2017-02-03 07:34:16

Changing status from needs_work to needs_review.


---

Comment by jmantysalo created at 2017-02-03 07:34:16

Maybe we can go with this.


---

Comment by mantepse created at 2017-02-05 21:03:11

I have no time to check this properly, but I think `labels` is good - that's also what `GenericGraph.disjoint_union` uses.


---

Comment by git created at 2017-02-11 05:59:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2017-02-11 06:05:37

There was a merge conflict because of added `import six`. Should work now.

I think that we are now close to have all basic functionality relating to lattice congruences. Subdirect decomposition should be easy after this and some other tickets are closed.


---

Comment by tscrim created at 2017-02-11 15:17:14

I suspect the doctest in `src/sage/misc/rest_index_of_methods.py` will (still) fail. The number 55 just needs to be bumped slightly.


---

Comment by git created at 2017-02-12 06:25:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2017-02-12 06:27:03

Replying to [comment:28 tscrim]:
> I suspect the doctest in `src/sage/misc/rest_index_of_methods.py` will (still) fail. The number 55 just needs to be bumped slightly.

OK, I increased it from 55 to 65.


---

Comment by mantepse created at 2017-02-12 10:59:15

A typo in the docstring: "congurence" should be "congruence".


---

Comment by git created at 2017-02-12 11:36:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2017-02-12 11:56:57

Replying to [comment:31 mantepse]:
> A typo in the docstring: "congurence" should be "congruence".

Corrected.


---

Comment by mantepse created at 2017-02-12 14:06:03

Looks good.  Here is a test you might enjoy:

```
sage: n=6
sage: d = {pi: pi.inverse().descents(from_zero=False) for pi in Permutations(n)}
sage: C = [[pi for pi in d if d[pi]==des] for des in d.values()]
sage: L = LatticePoset(Posets.SymmetricGroupWeakOrderPoset(n))
sage: M = L.quotient(L.congruence(C))
sage: M.is_isomorphic(Posets.BooleanLattice(n-1))
True
```


Unfortunately, this won't work out of the box, because `Posets.SymmetricGroupWeakOrderPoset(n)` creates strange labels.  Also it should be possible to replace `L.congruence(C)` with just `SetPartition(C)`, but there is a bug (#22361).

Anyway, I think this is great!


---

Comment by mantepse created at 2017-02-12 14:07:45

(I cannot build the documentation here in reasonable time, because my computer is too small. Can I set it to positive review anyway?)


---

Comment by jmantysalo created at 2017-02-12 14:21:05

Replying to [comment:35 mantepse]:
> (I cannot build the documentation here in reasonable time, because my computer is too small. Can I set it to positive review anyway?)

If you are unsure, you can check patchbot log, see docbuild-module. As the last version was OK, and I only changed one typo, I think you can set this to positive review.


---

Comment by mantepse created at 2017-02-12 14:37:49

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-02-14 18:58:55

Resolution: fixed
