# Issue 23089: Polyhedron from inexact MIP is broken

Issue created by migration from https://trac.sagemath.org/ticket/23326

Original creator: mforets

Original creation time: 2017-06-26 10:37:54

CC:  dimpase mkoeppe

Keywords: optimization, polyhedron

Creating a `polyhedron` defined by a `MixedIntegerLinearProgram` seems to be broken if the MIP's base ring is real double field; it raises `AttributeError: type object 'float' has no attribute 'is_exact'`.

Reported in [ask.sage](https://ask.sagemath.org/question/33782/computing-polyhedron-from-mip/).


---

Comment by mforets created at 2017-06-26 10:49:20

two obvious ways would be: 

- in MIP's `def polyhedron`, cast the floats to RDF before passing to `Polyhedron` constructor

- in `def Polyhedra` at `parent.py`, add checks like `.. is RDF or float`

i tried the second one; it works with this ticket but it triggers other things :


```
File "src/sage/numerical/mip.pyx", line 669, in sage.numerical.mip.MixedIntegerLinearProgram.base_ring
Failed example:
    d = polytopes.dodecahedron()
```


so it doesn't seem to be a good idea.
----
New commits:


---

Comment by mforets created at 2017-06-26 10:49:51

Changing component from PLEASE CHANGE to numerical.


---

Comment by dimpase created at 2017-06-26 11:35:25

I think one of the bugs is here, line 707 of `sage/rings/real_double.pyx`.

```
self._value = float(x)
```

Indeed, `float()` is Python float, it's not `RDF`.

More bugs(?) like this are in `MixedIntegerLinearProgram`, where `float` is used for no good reason, IMHO.


---

Comment by tmonteil created at 2017-06-26 20:43:31

I just suggested a fix to be discussed (based upon Marcelo's branch), i guess it is consistent with the current logic of both the `Polyhedron` constructor and `MILP` behaviour.

That said, there are two things i do not like with those logics:

Regarding the `Polyhedron` constructor, (part of) the current logic is: if the ring of all the entries is one of `ZZ`, `QQ`, `RDF`, then make it the base ring, otherwise, try to turn the entries into integers (if it succeeds, then the base ring is `ZZ` or `QQ`), otherwise the base ring is `RDF`. In particular, if the entries are Python floats corresponding to integers, then the base ring will be `ZZ` or `QQ`. But if the entries are `RDF` elements corresponding to integers, then the base ring will be `RDF`. It also makes something non-predictive: imagine that the user wants to construct tons of float polytopes, but one of them has integer entries for no good reason, its base ring will be different than the others polytopes.

Regarding `MILP`, constraints are considered as floats, whatever the type of constraints defined by the user. I do understand that solvers might require that, but if `MILP` is built from integer or rational entries, it should remind about that and postprocess the output of the solvers to be consistent with the user input.

Also, both "features" are linked so that the current mixture works (i.e. if the MILP is made of integer entries, then it will lead to a rational polytope), but i do not find it very secure: the MILP outputs floats even if it knows that the polytope is rational, then the polyhedron constructor guesses that the polytope has to be rational. Again, what happens when the user defines a float MILP, and that by some rounding coincidence, it turns out that the constraints are integers ?

----
New commits:


---

Comment by dimpase created at 2017-06-26 21:00:20

Practically speaking, if one wants to study the polyhedron of an (MI)LP, then an appropriate (MI)LP backend should should be used: e.g. for rational inequalities one should use `ppl` backend, which does exact computations over `QQ`, and so the polyhedron constructed will be over `QQ`; there is also a backend that understands exact algebraic numbers, etc.

Constructing an LP over floats/RDF and then investigating the underlying polyhedron is obviously not a very safe undertaking.


---

Comment by vdelecroix created at 2017-06-27 10:35:31

Hi Marcelo, Thierry,

Did you have a look at #22605? Of course it breaks some doctests in MIP but the polyhedron constructor gets much better.

Vincent


---

Comment by mforets created at 2017-06-28 08:37:40

Replying to [comment:7 vdelecroix]:
> Hi Marcelo, Thierry,
> 
> Did you have a look at #22605? Of course it breaks some doctests in MIP but the polyhedron constructor gets much better.
> 
> Vincent

Thanks for pointing it out. I've pulled and tried #22605. Indeed, that fixes this ticket but MIP's `polyhedra` existent doctests now fail because it always returns RDF polyhedra. 

So I understand that the thing to be fixed here is some processing at MIP's `polyhedron` as suggested in Thierry's comment:5


---

Comment by mforets created at 2017-06-28 13:45:39

ThenÂ if #22605 gets in, here we can just adapt the backend, `p = MixedIntegerLinearProgram(solver='ppl')`, in the doctests that involve rationals, while keeping the one i added with `solver='GLPK'`. Does it make sense?


---

Comment by mforets created at 2017-07-27 15:10:45

Changing status from new to needs_review.


---

Comment by mforets created at 2017-07-27 15:10:45

Last 10 new commits:


---

Comment by mforets created at 2017-07-27 19:53:39

.. filling the authors field


---

Comment by vdelecroix created at 2017-09-04 05:59:08

Would be simpler and cleaner to just rebase your 5 lines commit on the latest beta (8.1.beta3) which contains #22605.


---

Comment by mforets created at 2017-09-04 13:05:52

is it the same as `git checkout t/mforets/23326` followed by a `git merge develop`?


---

Comment by vdelecroix created at 2017-09-04 16:31:53

No. Just do

```bash
$ git checkout t/mforets/23326
$ git reset --hard develop      # reset the branch on top of develop
$ git cherry-pick `9dc381e`     # just pick the one commit needed
```

An additional merge introduces plenty of complications.

After that you will need to force push on the trac server. That is provide the option `-f`

```bash
$ git push trac -f HEAD:u/mforets/23326
```



---

Comment by git created at 2017-09-04 18:44:41

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mforets created at 2017-09-04 18:53:48

great! that worked, thanks.


---

Comment by vdelecroix created at 2017-09-05 12:50:42

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-09-10 11:57:36

Resolution: fixed
