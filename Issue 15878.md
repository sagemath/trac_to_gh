# Issue 15878: Class misconception with isogenies

archive/issues_015878.json:
```json
{
    "body": "CC:  @defeo @yyyyx4\n\nThe isogenies implementation suffers several conception issues; the main issues I can quickly describe are:\n\n* the _mul_ method of EllipticCurveIsogeny is not handled by the general Morphism class:\n\n```\nsage: E = EllipticCurve(j=GF(7)(0))\nsage: phi=E.isogeny( [E(0), E((0,1)), E((0,-1))])\nsage: phi*phi\n[...]\nTypeError: Elliptic Curve defined by y^2 = x^3 + 1 over Finite Field of size 7 is not in Category of hom sets in Category of Schemes\n```\n\n\n--> I've edited ell_curve_isogeny.py in order to make this work: the codomain() and domain() methods  initially gaves \"Elliptic Curve ...\", I've updated to \"Abelian group of points of Elliptic Curve ...\" (and tried to make the other parts of code consistant with that).\n\n \n* Hierarchy class is not well think: e.g. WeierstrassIsomorphism is not a child of EllipticCurveIsogeny. Moreover, we can not compose isogeny and Weierstrass Isomorphism. There exist a \"SchemeMorphism\" class; maybe it's a good idea to make EllipticCurveIsogeny subclass of this ?\nFollwing the previous code:\n\n```\nsage: i=WeierstrassIsomorphism(E,(2,0,0,0))\nsage: phi*i\nComposite map:\n  From: Abelian group of points on Elliptic Curve defined by y^2 = x^3 + 1 over Finite Field of size 7\n  To:   Abelian group of points on Elliptic Curve defined by y^2 = x^3 + 1 over Finite Field of size 7\n  Defn:   Generic morphism:\n          From: Abelian group of points on Elliptic Curve defined by y^2 = x^3 + 1 over Finite Field of size 7\n          To:   Abelian group of points on Elliptic Curve defined by y^2 = x^3 + 1 over Finite Field of size 7\n          Via:  (u,r,s,t) = (2, 0, 0, 0)\n        then\n          Isogeny of degree 3:\n          From: Abelian group of points on Elliptic Curve defined by y^2 = x^3 + 1 over Finite Field of size 7\n          To: Abelian group of points on Elliptic Curve defined by y^2 = x^3 + 1 over Finite Field of size 7\nsage: i*phi\n---------------------------------------------------------------------------\nAttributeError                            Traceback (most recent call last)\n<ipython-input-13-b2d0bfcb3b82> in <module>()\n----> 1 i*phi\n\n/home/sebsheep/sage/local/lib/python2.7/site-packages/sage/schemes/elliptic_curves/weierstrass_morphism.pyc in __mul__(self, other)\n    582             True\n    583         \"\"\"\n--> 584         if self._domain_curve==other._codomain_curve:\n    585             w=baseWI.__mul__(self,other)\n    586             return WeierstrassIsomorphism(other._domain_curve, w.tuple(), self._codomain_curve)\n\n/home/sebsheep/sage/local/lib/python2.7/site-packages/sage/structure/element.so in sage.structure.element.Element.__getattr__ (sage/structure/element.c:3868)()\n\n/home/sebsheep/sage/local/lib/python2.7/site-packages/sage/structure/misc.so in sage.structure.misc.getattr_from_other_class (sage/structure/misc.c:1696)()\n\nAttributeError: 'EllipticCurveIsogeny' object has no attribute '_codomain_curve'\n```\n\n\nI've joined a \"preliminary draft\" of a new \"sage/local/lib/python2.7/site-packages/sage/schemes/elliptic_curves/ell_curve_isogeny.py\" wrote in a few hours.\n\nIssue created by migration from https://trac.sagemath.org/ticket/16115\n\n",
    "created_at": "2014-04-09T20:35:11Z",
    "labels": [
        "algebraic geometry",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Class misconception with isogenies",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15878",
    "user": "sbesnier"
}
```
CC:  @defeo @yyyyx4

The isogenies implementation suffers several conception issues; the main issues I can quickly describe are:

* the _mul_ method of EllipticCurveIsogeny is not handled by the general Morphism class:

```
sage: E = EllipticCurve(j=GF(7)(0))
sage: phi=E.isogeny( [E(0), E((0,1)), E((0,-1))])
sage: phi*phi
[...]
TypeError: Elliptic Curve defined by y^2 = x^3 + 1 over Finite Field of size 7 is not in Category of hom sets in Category of Schemes
```


--> I've edited ell_curve_isogeny.py in order to make this work: the codomain() and domain() methods  initially gaves "Elliptic Curve ...", I've updated to "Abelian group of points of Elliptic Curve ..." (and tried to make the other parts of code consistant with that).

 
* Hierarchy class is not well think: e.g. WeierstrassIsomorphism is not a child of EllipticCurveIsogeny. Moreover, we can not compose isogeny and Weierstrass Isomorphism. There exist a "SchemeMorphism" class; maybe it's a good idea to make EllipticCurveIsogeny subclass of this ?
Follwing the previous code:

```
sage: i=WeierstrassIsomorphism(E,(2,0,0,0))
sage: phi*i
Composite map:
  From: Abelian group of points on Elliptic Curve defined by y^2 = x^3 + 1 over Finite Field of size 7
  To:   Abelian group of points on Elliptic Curve defined by y^2 = x^3 + 1 over Finite Field of size 7
  Defn:   Generic morphism:
          From: Abelian group of points on Elliptic Curve defined by y^2 = x^3 + 1 over Finite Field of size 7
          To:   Abelian group of points on Elliptic Curve defined by y^2 = x^3 + 1 over Finite Field of size 7
          Via:  (u,r,s,t) = (2, 0, 0, 0)
        then
          Isogeny of degree 3:
          From: Abelian group of points on Elliptic Curve defined by y^2 = x^3 + 1 over Finite Field of size 7
          To: Abelian group of points on Elliptic Curve defined by y^2 = x^3 + 1 over Finite Field of size 7
sage: i*phi
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
<ipython-input-13-b2d0bfcb3b82> in <module>()
----> 1 i*phi

/home/sebsheep/sage/local/lib/python2.7/site-packages/sage/schemes/elliptic_curves/weierstrass_morphism.pyc in __mul__(self, other)
    582             True
    583         """
--> 584         if self._domain_curve==other._codomain_curve:
    585             w=baseWI.__mul__(self,other)
    586             return WeierstrassIsomorphism(other._domain_curve, w.tuple(), self._codomain_curve)

/home/sebsheep/sage/local/lib/python2.7/site-packages/sage/structure/element.so in sage.structure.element.Element.__getattr__ (sage/structure/element.c:3868)()

/home/sebsheep/sage/local/lib/python2.7/site-packages/sage/structure/misc.so in sage.structure.misc.getattr_from_other_class (sage/structure/misc.c:1696)()

AttributeError: 'EllipticCurveIsogeny' object has no attribute '_codomain_curve'
```


I've joined a "preliminary draft" of a new "sage/local/lib/python2.7/site-packages/sage/schemes/elliptic_curves/ell_curve_isogeny.py" wrote in a few hours.

Issue created by migration from https://trac.sagemath.org/ticket/16115





---

archive/issue_comments_206234.json:
```json
{
    "body": "first draft",
    "created_at": "2014-04-09T20:36:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15878#issuecomment-206234",
    "user": "sbesnier"
}
```

first draft



---

archive/issue_comments_206235.json:
```json
{
    "body": "Changing component from algebraic geometry to elliptic curves.",
    "created_at": "2014-04-10T18:32:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15878#issuecomment-206235",
    "user": "@pjbruin"
}
```

Changing component from algebraic geometry to elliptic curves.



---

archive/issue_comments_206236.json:
```json
{
    "body": "Attachment [ell_curve_isogeny.py](tarball://root/attachments/some-uuid/ticket16115/ell_curve_isogeny.py) by @pjbruin created at 2014-04-10 18:32:12\n\nThere are indeed various aspects in which isogenies could be improved.\n\nAs for your first point, this should be addressed in #12880.  (Note that the mathematically correct solution is to make the domain and codomain be the elliptic curves themselves, not the groups of points.)  This can only really be fixed after #11474.\n\nTying the various classes closer together as in your second point is certainly worth looking at.  One could even consider making `EllipticCurveIsogeny` inherit from `SchemeMorphism_polynomial_projective_space`, but perhaps that class is too specialised in an orthogonal direction.\n\nIt is not recommended to simply upload the Python files you changed; in that way it is impossible to see what your changes are or on what version of Sage you based them.  Use Git instead; see [http://sagemath.org/doc/developer/](http://sagemath.org/doc/developer/) for an introduction to the Sage development process.\n\nFinally, please be aware that \"misconception\" is not the most charitable way to describe the work that has been done so far.  A lot of code in Sage dates from years back when the \"right\" infrastructure (more specific base classes, category code etc.) was simply not available.  There is certainly a lot of room to improve the design in many parts of Sage, but time and resources are limited, and changes need to be made in small steps to avoid breaking existing code.",
    "created_at": "2014-04-10T18:32:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15878#issuecomment-206236",
    "user": "@pjbruin"
}
```

Attachment [ell_curve_isogeny.py](tarball://root/attachments/some-uuid/ticket16115/ell_curve_isogeny.py) by @pjbruin created at 2014-04-10 18:32:12

There are indeed various aspects in which isogenies could be improved.

As for your first point, this should be addressed in #12880.  (Note that the mathematically correct solution is to make the domain and codomain be the elliptic curves themselves, not the groups of points.)  This can only really be fixed after #11474.

Tying the various classes closer together as in your second point is certainly worth looking at.  One could even consider making `EllipticCurveIsogeny` inherit from `SchemeMorphism_polynomial_projective_space`, but perhaps that class is too specialised in an orthogonal direction.

It is not recommended to simply upload the Python files you changed; in that way it is impossible to see what your changes are or on what version of Sage you based them.  Use Git instead; see [http://sagemath.org/doc/developer/](http://sagemath.org/doc/developer/) for an introduction to the Sage development process.

Finally, please be aware that "misconception" is not the most charitable way to describe the work that has been done so far.  A lot of code in Sage dates from years back when the "right" infrastructure (more specific base classes, category code etc.) was simply not available.  There is certainly a lot of room to improve the design in many parts of Sage, but time and resources are limited, and changes need to be made in small steps to avoid breaking existing code.



---

archive/issue_comments_206237.json:
```json
{
    "body": "See also #7368 for another to-do list for isogenies.",
    "created_at": "2014-04-11T11:16:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15878#issuecomment-206237",
    "user": "@pjbruin"
}
```

See also #7368 for another to-do list for isogenies.



---

archive/issue_comments_206238.json:
```json
{
    "body": "Changing keywords from \"\" to \"days57\".",
    "created_at": "2014-04-11T22:03:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15878#issuecomment-206238",
    "user": "@defeo"
}
```

Changing keywords from "" to "days57".



---

archive/issue_comments_206239.json:
```json
{
    "body": "About `SchemeMorphism` also see the description of #14711 of why it currently does not inherit `Morphism` (simple enough reason, cython won't let you do that currently...).\n\nIIRC this was the corresponding discussion:\n* https://groups.google.com/d/msg/cython-users/-GvwK6sEF0E/vAaliNBQ9XMJ",
    "created_at": "2014-04-18T15:49:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15878#issuecomment-206239",
    "user": "jpflori"
}
```

About `SchemeMorphism` also see the description of #14711 of why it currently does not inherit `Morphism` (simple enough reason, cython won't let you do that currently...).

IIRC this was the corresponding discussion:
* https://groups.google.com/d/msg/cython-users/-GvwK6sEF0E/vAaliNBQ9XMJ



---

archive/issue_comments_206240.json:
```json
{
    "body": "I implemented Weierstrass morphisms in 2007: it was the first piece of Sage development I did.  Until that time it was impossible to change models or move points from one model to another!  And the implementation of isogenies was done much later than that.\n\nI do agree that the EllipticCurveIsogeny class is not designed in the way I would want it to be, but it works well enough and has been used an enormous amount over QQ and over number fields, even if it has not been possible (for example) to compose isogenies.\n\nI also agree with Peter that the domain and codomain must be elliptic curves, and not sets or groups of points.\n\nI am currently working on extending the class IsogenyClass_EC to work over number fields (see #16743).  I don't expect that the work done on this and related tickets will affect that a lot.",
    "created_at": "2014-07-30T13:12:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15878#issuecomment-206240",
    "user": "@JohnCremona"
}
```

I implemented Weierstrass morphisms in 2007: it was the first piece of Sage development I did.  Until that time it was impossible to change models or move points from one model to another!  And the implementation of isogenies was done much later than that.

I do agree that the EllipticCurveIsogeny class is not designed in the way I would want it to be, but it works well enough and has been used an enormous amount over QQ and over number fields, even if it has not been possible (for example) to compose isogenies.

I also agree with Peter that the domain and codomain must be elliptic curves, and not sets or groups of points.

I am currently working on extending the class IsogenyClass_EC to work over number fields (see #16743).  I don't expect that the work done on this and related tickets will affect that a lot.



---

archive/issue_comments_206241.json:
```json
{
    "body": "added",
    "created_at": "2015-10-20T18:45:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15878#issuecomment-206241",
    "user": "adhalanay"
}
```

added



---

archive/issue_comments_206242.json:
```json
{
    "body": "I think this is resolved with #32388 and #32502.",
    "created_at": "2021-10-23T06:37:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15878#issuecomment-206242",
    "user": "@yyyyx4"
}
```

I think this is resolved with #32388 and #32502.



---

archive/issue_comments_206243.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-10-23T06:37:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15878#issuecomment-206243",
    "user": "@yyyyx4"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_206244.json:
```json
{
    "body": "I agree.",
    "created_at": "2022-09-17T16:56:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15878#issuecomment-206244",
    "user": "@mkoeppe"
}
```

I agree.



---

archive/issue_comments_206245.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-09-17T16:56:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15878#issuecomment-206245",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_206246.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2022-11-14T19:36:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15878#issuecomment-206246",
    "user": "@mkoeppe"
}
```

Resolution: invalid
