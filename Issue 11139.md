# Issue 11139: engine="pdflatex" in view is ignored

Issue created by migration from Trac.

Original creator: saliola

Original creation time: 2011-05-08 03:40:16

Assignee: jason, was

CC:  jhpalmieri

Keywords: latex, pdflatex

The view command states that the pdflatex argument is deprecated and that one should use the engine argument instead.

But if one sets engine="pdflatex", it is overwritten, and so one currently needs to use the deprecated pdflatex option.


---

Comment by saliola created at 2011-05-08 04:33:25

Changing status from new to needs_review.


---

Attachment


---

Comment by saliola created at 2011-05-08 18:29:12

Changing keywords from "latex, pdflatex" to "latex, pdflatex, days30".


---

Comment by chapoton created at 2011-06-01 13:34:11

You should modify the header of your patch : replace

trac_11311: fix view to not overwrite engine="pdflatex"

by

#11311: fix view to not overwrite engine="pdflatex"

Then the buildbot will be more happy.


---

Attachment

Thanks for catching this. I corrected this in the new patch.


---

Comment by kcrisman created at 2011-06-16 03:44:42

Apply [attachment:trac_11311_engine_pdflatex_view-fs.2.patch].


---

Comment by kcrisman created at 2011-06-16 03:48:11

Franco, you need to rebase this against your own patch at #11315 which was recently merged :)

I may do this if the patch behaves as promised.


---

Comment by kcrisman created at 2011-06-16 04:11:35

Question:  when I do

```
sage: view(2,engine='pdflatex')
```

it opens in my pdf viewer, not in my TeX program.  This seems wrong, based on the current doc, but I could be wrong. 

I'm also attaching a rebased patch.


---

Comment by kcrisman created at 2011-06-16 04:11:35

Changing status from needs_review to needs_info.


---

Attachment

Apply [attachment:trac_11311-rebased.patch].


---

Comment by chapoton created at 2011-06-22 08:08:52

Apply trac_11311-rebased.patch


---

Comment by jhpalmieri created at 2011-06-29 21:32:57

With the current patch, we have a little code duplication, so we could make the following change:

```diff
diff --git a/sage/misc/latex.py b/sage/misc/latex.py
--- a/sage/misc/latex.py
+++ b/sage/misc/latex.py
`@``@` -1851,6 +1851,10 `@``@` def view(objects, title='SAGE', debug=Fa
         else:
             latex_options = {}
         s = _latex_file_(objects, title=title, sep=sep, tiny=tiny, debug=debug, **latex_options)
+    if engine is None:
+        engine = _Latex_prefs._option["engine"]
+    if pdflatex or (viewer == "pdf" and engine == "latex"):
+        engine = "pdflatex"
     # notebook
     if EMBEDDED_MODE and viewer is None:
         jsMath_okay = True
`@``@` -1862,10 +1866,6 `@``@` def view(objects, title='SAGE', debug=Fa
         if jsMath_okay:
             print JSMath().eval(objects, mode=mode)  # put comma at end of line?
         else:
-            if engine is None:
-                engine = _Latex_prefs._option["engine"]
-            if pdflatex or (viewer == "pdf" and engine == "latex"):
-                engine = "pdflatex"
             base_dir = os.path.abspath("")
             png_file = graphics_filename(ext='png')
             png_link = "cell://" + png_file
`@``@` -1874,10 +1874,6 `@``@` def view(objects, title='SAGE', debug=Fa
             print '<html><img src="%s"></html>'%png_link  # put comma at end of line?
         return
     # command line or notebook with viewer
-    if engine is None:
-        engine = _Latex_prefs._option["engine"]
-    if pdflatex or (viewer == "pdf" and engine == "latex"):
-        engine = "pdflatex"
     tmp = tmp_dir('sage_viewer')
     tex_file = os.path.join(tmp, "sage.tex")
     open(tex_file,'w').write(s)
```

Otherwise, I think it looks good.

As far as opening in a pdf viewer rather than in a TeX program, hasn't that been the behavior for a while?  (Sage basically opens up the file, blah.pdf or blah.dvi, using some sensible default depending on the OS -- see the file misc/viewer.py.  On OS X, for example, this just calls "open blah.pdf" or "open blah.dvi", depending on which file is produced.)


---

Comment by jhpalmieri created at 2011-10-26 21:23:54

I'm attaching a referee patch which removes the code duplication referred to above.

Karl-Dieter: the program "sage-open", as defined in sage/misc/viewer.py, should be used to open the output file.  Before the patch here, it was called with `output_file` set to "sage.dvi" or something like that.  After the patch, it is called with `output_file` set to "sage.pdf".  So any difference in what program is being used is because this is producing a pdf file, not a dvi file.

I'd like to change this from "needs info" to "positive review".   Is that okay?


---

Comment by saliola created at 2011-10-26 21:30:15

Changing status from needs_info to needs_review.


---

Comment by saliola created at 2011-10-26 21:30:15

Looks good to me.


---

Comment by saliola created at 2011-10-26 21:30:31

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2011-11-03 16:14:43

Milestone sage-4.7.3 deleted


---

Comment by jdemeyer created at 2011-11-07 10:11:13

Resolution: fixed


---

Comment by jdemeyer created at 2011-11-08 15:02:47

Changing status from closed to new.


---

Comment by jdemeyer created at 2011-11-08 15:02:47

I get doctest failures on a system which does not have `latex` installed:

```
sage -t  -long -force_lib devel/sage/sage/misc/latex.py
**********************************************************************
File "/Users/jdemeyer/sage-4.8.alpha1/devel/sage-main/sage/misc/latex.py", line 1877:
    sage: view(4, engine="garbage")
Expected:
    Traceback (most recent call last):
    ...
    ValueError: Unsupported LaTeX engine.
Got:
    Error: XeLaTeX does not seem to be installed.  Download it from
    ctan.org and try again.
    Latex error
**********************************************************************
File "/Users/jdemeyer/sage-4.8.alpha1/devel/sage-main/sage/misc/latex.py", line 1882:
    sage: view(4, engine="garbage", viewer="pdf")
Expected:
    Traceback (most recent call last):
    ...
    ValueError: Unsupported LaTeX engine.
Got:
    Error: XeLaTeX does not seem to be installed.  Download it from
    ctan.org and try again.
    Latex error
**********************************************************************
```


Fixing this would mean adding "# optional - latex" to the doctest.

But it also makes me wonder: why check the existence of XeLaTeX when `engine="garbage"`?  This doesn't make much sense to me.


---

Comment by jdemeyer created at 2011-11-08 15:02:47

Resolution changed from fixed to 


---

Comment by kcrisman created at 2011-11-08 16:00:32

This seems to have been introduced (or expanded, at least) in #8486.

```
    if engine and not have_pdflatex() and not have_xelatex(): 
 	        print "Error: %s does not seem to be installed.  Download it from" % _Latex_prefs._option["engine_name"] 
```

so `engine` is certainly `True` since it's nonempty, and we definitely don't have any of those things.  And it first checks whether one has LaTeX, before it checks the engines.  

Now we have 

```
sage: sage.misc.latex._Latex_prefs._option
{'engine': 'latex', 'matrix_delimiters': ['(', ')'], 'jsmath_avoid': [], 'engine_name': 'LaTeX', 'blackboard_bold': False, 'macros': _, 'vector_delimiters': ['(', ')'], 'preamble': _}
```

in a regular install.  The question is whether there is anywhere `engine` gets reset...  

Aha!  [Line 1404](http://hg.sagemath.org/sage-main/file/9e29a3d84c48/sage/misc/latex.py#l1404) (of the current 4.7.2) shows that this is set to `xelatex` and then not reset.   Apparently the doctest framework doesn't clear this, I'm not sure exactly where this all lives.

Solution should be:
 * Fix the reset of the engine
 * Leave the error message and `# random` it.   Or even include both error messages so that the documentation shows exactly what we expect with and without a working LaTeX installation.

What do you think?


---

Comment by jdemeyer created at 2011-11-08 17:14:50

Replying to [comment:22 kcrisman]:
> What do you think?
I think we should try to find a solution which leaves all doctests as they are (including the new ones on this ticket): change the code, not the tests.

Maybe the code should be more like:

```
if engine is None:
    engine = "latex"
if (engine=="latex" and not have_latex()) or (engine=="pdflatex" and not have_pdflatex()) or (engine=="xelatex" and not have_xelatex):
    raise RuntimeError,...
```



---

Attachment

apply on top of other patch


---

Comment by jhpalmieri created at 2011-11-23 22:24:07

Here's a new referee patch.  This just moves the code which checks the value of 'engine' earlier, so if 'engine' is set to a bad value, then that error gets caught first.  For me, on an OS X box (with a pretty good TeX installation), on sage.math (with a mediocre TeX installation (no xetex or xelatex), and on the skynet machine eno (no TeX at all), the following passes all tests, repeatedly:

```
sage -t  --randorder devel/sage/sage/misc/latex.py
```

(The patch also adds a line to one example to reset the latex preamble, so that tests pass when the order of the tests is randomized.)


---

Comment by jhpalmieri created at 2011-11-23 22:24:07

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2011-11-23 22:33:40

Here's an alternate version, which just consolidates some code (while checking whether `engine == 'pdflatex'`, check whether pdflatex is installed, for example).


---

Comment by chapoton created at 2012-04-26 07:46:40

Trying to help the buildbot ...


---

Comment by chapoton created at 2012-05-10 19:30:03

*ping*

What is the status of this patch ?

The bot has not understood which patch to apply. Let us try again.

Apply trac_11311-rebased.patch  and trac_11311-ref.v2.patch


---

Comment by jhpalmieri created at 2012-05-10 20:07:42

Here is a rebased version of the "v2" patch.


---

Comment by jhpalmieri created at 2012-05-10 20:08:06

apply on top of rebased patch


---

Attachment

Thanks for the review patch. Positive review.


---

Comment by saliola created at 2012-05-20 23:18:22

Changing status from needs_review to positive_review.


---

Comment by saliola created at 2012-05-21 00:44:27

I just noticed that randomizing the doctests fails sometimes, with errors of the following form:

```
sage -t  --randorder devel/sage/sage/misc/latex.py
...
File "/Users/saliola/Applications/sage-5.0/devel/sage/sage/misc/latex.py", line 221:
    sage: builtin_constant_function(NotImplemented)
Expected:
    '\\mbox{\\rm NotImplemented}'
Got:
    '{\\rm NotImplemented}'
...
```

Since this isn't cause by this patch (in fact, this patch improves things), I created a new ticket #12986 for this.


---

Comment by jdemeyer created at 2012-05-21 22:33:13

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2012-05-21 22:33:13

The patch only applies with fuzz 2 and therefore should be rebased to sage-5.1.beta0.


---

Attachment

rebased to Sage 5.0


---

Comment by jhpalmieri created at 2012-05-22 01:52:25

Changing status from needs_work to positive_review.


---

Comment by jhpalmieri created at 2012-05-22 01:52:25

Here's a rebased patch (combining the old two patches).  (Despite its name and my comment when I attached it, it was actually rebased to Sage 5.1.beta0.)


---

Comment by jdemeyer created at 2012-05-23 21:33:02

Resolution: fixed


---

Comment by jdemeyer created at 2012-05-23 21:35:02

Changing status from closed to new.


---

Comment by jdemeyer created at 2012-05-23 21:35:02

Nothing against this patch, just didn't mean to merge it now (probably next beta).


---

Comment by jdemeyer created at 2012-05-23 21:35:02

Resolution changed from fixed to 


---

Comment by jdemeyer created at 2012-05-23 21:35:11

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2012-05-23 21:35:18

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-06-14 06:38:04

Resolution: fixed
