# Issue 14248: Upgrade to Cython 0.19

archive/issues_014248.json:
```json
{
    "body": "Assignee: jdemeyer\n\nCC:  robertwb\n\nUpgrade to Cython 0.19 when it's released.\n\nIssue created by migration from https://trac.sagemath.org/ticket/14452\n\n",
    "created_at": "2013-04-15T12:04:02Z",
    "labels": [
        "packages: standard",
        "major",
        "enhancement"
    ],
    "title": "Upgrade to Cython 0.19",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14248",
    "user": "jdemeyer"
}
```
Assignee: jdemeyer

CC:  robertwb

Upgrade to Cython 0.19 when it's released.

Issue created by migration from https://trac.sagemath.org/ticket/14452





---

archive/issue_comments_179262.json:
```json
{
    "body": "Robert, I think there is a serious Cython bug: the `__new__` method of a class might actually use the wrong class: in `devel/sage/sage/libs/gap/element.pyx`, the code\n\n```\ndef GapElement_Record r = GapElement_Record.__new__(GapElement_Record)\n```\n\ngenerates\n\n```\n__pyx_t_1 = __pyx_tp_new_4sage_4libs_3gap_7element_GapElement(((PyTypeObject *)((PyObject*)__pyx_ptype_4sage_4libs_3gap_7element_GapElement_Record)), ((PyObject *)__pyx_empty_tuple), NULL);\n```\n\nNote the call to the `tp_new` function of `GapElement` (a child class), not `GapElement_Record`.",
    "created_at": "2013-04-16T17:30:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14248#issuecomment-179262",
    "user": "jdemeyer"
}
```

Robert, I think there is a serious Cython bug: the `__new__` method of a class might actually use the wrong class: in `devel/sage/sage/libs/gap/element.pyx`, the code

```
def GapElement_Record r = GapElement_Record.__new__(GapElement_Record)
```

generates

```
__pyx_t_1 = __pyx_tp_new_4sage_4libs_3gap_7element_GapElement(((PyTypeObject *)((PyObject*)__pyx_ptype_4sage_4libs_3gap_7element_GapElement_Record)), ((PyObject *)__pyx_empty_tuple), NULL);
```

Note the call to the `tp_new` function of `GapElement` (a child class), not `GapElement_Record`.



---

archive/issue_comments_179263.json:
```json
{
    "body": "https://github.com/cython/cython/pull/214",
    "created_at": "2013-04-17T05:41:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14248#issuecomment-179263",
    "user": "robertwb"
}
```

https://github.com/cython/cython/pull/214



---

archive/issue_comments_179264.json:
```json
{
    "body": "Attachment [sage_crash_W7eVMu.log](tarball://root/attachments/some-uuid/ticket14452/sage_crash_W7eVMu.log) by jdemeyer created at 2013-04-17 18:13:03",
    "created_at": "2013-04-17T18:13:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14248#issuecomment-179264",
    "user": "jdemeyer"
}
```

Attachment [sage_crash_W7eVMu.log](tarball://root/attachments/some-uuid/ticket14452/sage_crash_W7eVMu.log) by jdemeyer created at 2013-04-17 18:13:03



---

archive/issue_comments_179265.json:
```json
{
    "body": "Here is what I found about the docbuilder crash: it works with Cython 0.18, not with current master at `0ee15b1829125b6844ac13f437c2d9bd61a4ceca`.\n\nIn `lazy_import.pyx`, somehow `self._object` becomes `NULL` in the line\n\n```\nsetattr(cls, alias, self._object)\n```\n\nwhich is compiled to\n\n```\n           __pyx_t_1 = __pyx_v_self->_object;                                      \n           __Pyx_INCREF(__pyx_t_1);\n           __pyx_t_10 = PyObject_SetAttr(__pyx_v_cls, __pyx_v_alias, __pyx_t_1); if (unlikely(__pyx_t_10 == -1)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 169; __py\n           __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;                                 \n```\n\nI don't see anything suspicious here.",
    "created_at": "2013-04-18T08:04:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14248#issuecomment-179265",
    "user": "jdemeyer"
}
```

Here is what I found about the docbuilder crash: it works with Cython 0.18, not with current master at `0ee15b1829125b6844ac13f437c2d9bd61a4ceca`.

In `lazy_import.pyx`, somehow `self._object` becomes `NULL` in the line

```
setattr(cls, alias, self._object)
```

which is compiled to

```
           __pyx_t_1 = __pyx_v_self->_object;                                      
           __Pyx_INCREF(__pyx_t_1);
           __pyx_t_10 = PyObject_SetAttr(__pyx_v_cls, __pyx_v_alias, __pyx_t_1); if (unlikely(__pyx_t_10 == -1)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 169; __py
           __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;                                 
```

I don't see anything suspicious here.



---

archive/issue_comments_179266.json:
```json
{
    "body": "Generating just `lazy_import.c` with Cython-0.18 makes the documentation build.",
    "created_at": "2013-04-18T08:08:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14248#issuecomment-179266",
    "user": "jdemeyer"
}
```

Generating just `lazy_import.c` with Cython-0.18 makes the documentation build.



---

archive/issue_comments_179267.json:
```json
{
    "body": "Robert, I feel like I can not do much more to debug the docbuilding since I don't really understand the mechanics of `lazy_import`.",
    "created_at": "2013-04-18T08:42:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14248#issuecomment-179267",
    "user": "jdemeyer"
}
```

Robert, I feel like I can not do much more to debug the docbuilding since I don't really understand the mechanics of `lazy_import`.



---

archive/issue_comments_179268.json:
```json
{
    "body": "I don't see anything suspicious there either. Can you try compiling lazy_import.pyx with -O0? What's the diff of this file between 0.18 and 0.19?",
    "created_at": "2013-04-18T22:56:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14248#issuecomment-179268",
    "user": "robertwb"
}
```

I don't see anything suspicious there either. Can you try compiling lazy_import.pyx with -O0? What's the diff of this file between 0.18 and 0.19?



---

archive/issue_comments_179269.json:
```json
{
    "body": "Replying to [comment:13 robertwb]:\n> Can you try compiling lazy_import.pyx with -O0?\nI did, and it didn't help. I could try to bisect the Cython git repo for the bug.",
    "created_at": "2013-04-19T06:17:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14248#issuecomment-179269",
    "user": "jdemeyer"
}
```

Replying to [comment:13 robertwb]:
> Can you try compiling lazy_import.pyx with -O0?
I did, and it didn't help. I could try to bisect the Cython git repo for the bug.



---

archive/issue_comments_179270.json:
```json
{
    "body": "Results of bisecting:\n\n* commit `19c0408476515c89a60655b753f08a3bd18eec83` is good\n\n* commit `d44a0845fc91bf7ade61dee431358f375c580f44` is bad\n\nAll commits in between simply fail to compile.",
    "created_at": "2013-04-19T10:41:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14248#issuecomment-179270",
    "user": "jdemeyer"
}
```

Results of bisecting:

* commit `19c0408476515c89a60655b753f08a3bd18eec83` is good

* commit `d44a0845fc91bf7ade61dee431358f375c580f44` is bad

All commits in between simply fail to compile.



---

archive/issue_comments_179271.json:
```json
{
    "body": "The relevant change seems to be the line\n\n```\nobj = self._get_object(owner=owner)\n```\n\n\nwhich was compiled in the **good** way as\n\n```\n  __pyx_t_1 = PyObject_GetAttr(((PyObject *)__pyx_v_self), __pyx_n_s___get_object); if (unlikely(!__pyx_t_1)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 401; __pyx_clineno = __LINE__; goto __pyx_L1_error;}\n  __Pyx_GOTREF(__pyx_t_1);\n  __pyx_t_2 = PyDict_New(); if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 401; __pyx_clineno = __LINE__; goto __pyx_L1_error;}\n  __Pyx_GOTREF(((PyObject *)__pyx_t_2));\n  if (PyDict_SetItem(__pyx_t_2, ((PyObject *)__pyx_n_s__owner), __pyx_v_owner) < 0) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 401; __pyx_clineno = __LINE__; goto __pyx_L1_error;}\n  __pyx_t_3 = PyObject_Call(__pyx_t_1, ((PyObject *)__pyx_empty_tuple), ((PyObject *)__pyx_t_2)); if (unlikely(!__pyx_t_3)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 401; __pyx_clineno = __LINE__; goto __pyx_L1_error;}\n  __Pyx_GOTREF(__pyx_t_3);\n  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;\n  __Pyx_DECREF(((PyObject *)__pyx_t_2)); __pyx_t_2 = 0;\n  __pyx_v_obj = __pyx_t_3;\n  __pyx_t_3 = 0;\n```\n\n\nand in the **bad** way as\n\n```\n  __pyx_t_2.__pyx_n = 1;\n  __pyx_t_2.owner = __pyx_v_owner;\n  __pyx_t_1 = ((struct __pyx_vtabstruct_4sage_4misc_11lazy_import_LazyImport *)__pyx_v_self->__pyx_vtab)->_get_object(__pyx_v_self, 0, &__pyx_t_2); if (unlikely(!__pyx_t_1)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 401; __pyx_clineno = __LINE__; goto __pyx_L1_error;}\n  __Pyx_GOTREF(__pyx_t_1);\n  __pyx_v_obj = __pyx_t_1;\n  __pyx_t_1 = 0;\n```\n",
    "created_at": "2013-04-19T14:02:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14248#issuecomment-179271",
    "user": "jdemeyer"
}
```

The relevant change seems to be the line

```
obj = self._get_object(owner=owner)
```


which was compiled in the **good** way as

```
  __pyx_t_1 = PyObject_GetAttr(((PyObject *)__pyx_v_self), __pyx_n_s___get_object); if (unlikely(!__pyx_t_1)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 401; __pyx_clineno = __LINE__; goto __pyx_L1_error;}
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_2 = PyDict_New(); if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 401; __pyx_clineno = __LINE__; goto __pyx_L1_error;}
  __Pyx_GOTREF(((PyObject *)__pyx_t_2));
  if (PyDict_SetItem(__pyx_t_2, ((PyObject *)__pyx_n_s__owner), __pyx_v_owner) < 0) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 401; __pyx_clineno = __LINE__; goto __pyx_L1_error;}
  __pyx_t_3 = PyObject_Call(__pyx_t_1, ((PyObject *)__pyx_empty_tuple), ((PyObject *)__pyx_t_2)); if (unlikely(!__pyx_t_3)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 401; __pyx_clineno = __LINE__; goto __pyx_L1_error;}
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __Pyx_DECREF(((PyObject *)__pyx_t_2)); __pyx_t_2 = 0;
  __pyx_v_obj = __pyx_t_3;
  __pyx_t_3 = 0;
```


and in the **bad** way as

```
  __pyx_t_2.__pyx_n = 1;
  __pyx_t_2.owner = __pyx_v_owner;
  __pyx_t_1 = ((struct __pyx_vtabstruct_4sage_4misc_11lazy_import_LazyImport *)__pyx_v_self->__pyx_vtab)->_get_object(__pyx_v_self, 0, &__pyx_t_2); if (unlikely(!__pyx_t_1)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 401; __pyx_clineno = __LINE__; goto __pyx_L1_error;}
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_v_obj = __pyx_t_1;
  __pyx_t_1 = 0;
```




---

archive/issue_comments_179272.json:
```json
{
    "body": "Alternatively, changing the line\n\n```\ncpdef _get_object(self, owner=None):\n```\n\nto\n\n```\ndef _get_object(self, owner=None):\n```\n\nalso fixes the problem. I am applying this workaround in [attachment:14452_cython_0.19.patch].",
    "created_at": "2013-04-19T14:41:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14248#issuecomment-179272",
    "user": "jdemeyer"
}
```

Alternatively, changing the line

```
cpdef _get_object(self, owner=None):
```

to

```
def _get_object(self, owner=None):
```

also fixes the problem. I am applying this workaround in [attachment:14452_cython_0.19.patch].



---

archive/issue_comments_179273.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-04-19T14:53:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14248#issuecomment-179273",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_179274.json:
```json
{
    "body": "spkg diff",
    "created_at": "2013-04-21T15:07:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14248#issuecomment-179274",
    "user": "jdemeyer"
}
```

spkg diff



---

archive/issue_comments_179275.json:
```json
{
    "body": "Attachment [cython-0.19.p0.diff](tarball://root/attachments/some-uuid/ticket14452/cython-0.19.p0.diff) by jdemeyer created at 2013-04-21 15:07:43",
    "created_at": "2013-04-21T15:07:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14248#issuecomment-179275",
    "user": "jdemeyer"
}
```

Attachment [cython-0.19.p0.diff](tarball://root/attachments/some-uuid/ticket14452/cython-0.19.p0.diff) by jdemeyer created at 2013-04-21 15:07:43



---

archive/issue_comments_179276.json:
```json
{
    "body": "With these patches, all fine on the buildbot.",
    "created_at": "2013-04-22T12:04:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14248#issuecomment-179276",
    "user": "jdemeyer"
}
```

With these patches, all fine on the buildbot.



---

archive/issue_comments_179277.json:
```json
{
    "body": "Attachment [14452_cython_0.19.patch](tarball://root/attachments/some-uuid/ticket14452/14452_cython_0.19.patch) by jdemeyer created at 2013-04-23 10:39:52",
    "created_at": "2013-04-23T10:39:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14248#issuecomment-179277",
    "user": "jdemeyer"
}
```

Attachment [14452_cython_0.19.patch](tarball://root/attachments/some-uuid/ticket14452/14452_cython_0.19.patch) by jdemeyer created at 2013-04-23 10:39:52



---

archive/issue_comments_179278.json:
```json
{
    "body": "Rebased to #13826.",
    "created_at": "2013-04-23T10:41:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14248#issuecomment-179278",
    "user": "jdemeyer"
}
```

Rebased to #13826.



---

archive/issue_comments_179279.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2013-04-23T18:38:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14248#issuecomment-179279",
    "user": "jdemeyer"
}
```

Changing priority from major to critical.



---

archive/issue_comments_179280.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-04-23T18:51:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14248#issuecomment-179280",
    "user": "robertwb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_179281.json:
```json
{
    "body": "Thanks for debugging this! I filed http://trac.cython.org/cython_trac/ticket/810 about (what I think is) the underlying bug you uncovered with the lazy import stuff.",
    "created_at": "2013-04-23T18:51:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14248#issuecomment-179281",
    "user": "robertwb"
}
```

Thanks for debugging this! I filed http://trac.cython.org/cython_trac/ticket/810 about (what I think is) the underlying bug you uncovered with the lazy import stuff.



---

archive/issue_comments_179282.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-04-23T19:08:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14248#issuecomment-179282",
    "user": "jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_179283.json:
```json
{
    "body": "Replying to [comment:26 robertwb]:\n> Thanks for debugging this! I filed http://trac.cython.org/cython_trac/ticket/810 about (what I think is) the underlying bug you uncovered with the lazy import stuff. \nDo you have a better idea about what precisely is wrong? I isolated the problem, but I don't know why it segfaults.",
    "created_at": "2013-04-24T12:24:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14248#issuecomment-179283",
    "user": "jdemeyer"
}
```

Replying to [comment:26 robertwb]:
> Thanks for debugging this! I filed http://trac.cython.org/cython_trac/ticket/810 about (what I think is) the underlying bug you uncovered with the lazy import stuff. 
Do you have a better idea about what precisely is wrong? I isolated the problem, but I don't know why it segfaults.
