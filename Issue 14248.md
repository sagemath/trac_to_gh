# Issue 14248: Upgrade to Cython 0.19

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2013-04-15 12:04:02

Assignee: jdemeyer

CC:  robertwb

Upgrade to Cython 0.19 when it's released.


---

Comment by jdemeyer created at 2013-04-16 17:30:13

Robert, I think there is a serious Cython bug: the `__new__` method of a class might actually use the wrong class: in `devel/sage/sage/libs/gap/element.pyx`, the code

```
def GapElement_Record r = GapElement_Record.__new__(GapElement_Record)
```

generates

```
__pyx_t_1 = __pyx_tp_new_4sage_4libs_3gap_7element_GapElement(((PyTypeObject *)((PyObject*)__pyx_ptype_4sage_4libs_3gap_7element_GapElement_Record)), ((PyObject *)__pyx_empty_tuple), NULL);
```

Note the call to the `tp_new` function of `GapElement` (a child class), not `GapElement_Record`.


---

Comment by robertwb created at 2013-04-17 05:41:38

https://github.com/cython/cython/pull/214


---

Attachment


---

Comment by jdemeyer created at 2013-04-18 08:04:53

Here is what I found about the docbuilder crash: it works with Cython 0.18, not with current master at `0ee15b1829125b6844ac13f437c2d9bd61a4ceca`.

In `lazy_import.pyx`, somehow `self._object` becomes `NULL` in the line

```
setattr(cls, alias, self._object)
```

which is compiled to

```
           __pyx_t_1 = __pyx_v_self->_object;                                      
           __Pyx_INCREF(__pyx_t_1);
           __pyx_t_10 = PyObject_SetAttr(__pyx_v_cls, __pyx_v_alias, __pyx_t_1); if (unlikely(__pyx_t_10 == -1)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 169; __py
           __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;                                 
```

I don't see anything suspicious here.


---

Comment by jdemeyer created at 2013-04-18 08:08:20

Generating just `lazy_import.c` with Cython-0.18 makes the documentation build.


---

Comment by jdemeyer created at 2013-04-18 08:42:43

Robert, I feel like I can not do much more to debug the docbuilding since I don't really understand the mechanics of `lazy_import`.


---

Comment by robertwb created at 2013-04-18 22:56:56

I don't see anything suspicious there either. Can you try compiling lazy_import.pyx with -O0? What's the diff of this file between 0.18 and 0.19?


---

Comment by jdemeyer created at 2013-04-19 06:17:34

Replying to [comment:13 robertwb]:
> Can you try compiling lazy_import.pyx with -O0?
I did, and it didn't help. I could try to bisect the Cython git repo for the bug.


---

Comment by jdemeyer created at 2013-04-19 10:41:44

Results of bisecting:

* commit `19c0408476515c89a60655b753f08a3bd18eec83` is good

* commit `d44a0845fc91bf7ade61dee431358f375c580f44` is bad

All commits in between simply fail to compile.


---

Comment by jdemeyer created at 2013-04-19 14:02:41

The relevant change seems to be the line

```
obj = self._get_object(owner=owner)
```


which was compiled in the *good* way as

```
  __pyx_t_1 = PyObject_GetAttr(((PyObject *)__pyx_v_self), __pyx_n_s___get_object); if (unlikely(!__pyx_t_1)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 401; __pyx_clineno = __LINE__; goto __pyx_L1_error;}
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_2 = PyDict_New(); if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 401; __pyx_clineno = __LINE__; goto __pyx_L1_error;}
  __Pyx_GOTREF(((PyObject *)__pyx_t_2));
  if (PyDict_SetItem(__pyx_t_2, ((PyObject *)__pyx_n_s__owner), __pyx_v_owner) < 0) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 401; __pyx_clineno = __LINE__; goto __pyx_L1_error;}
  __pyx_t_3 = PyObject_Call(__pyx_t_1, ((PyObject *)__pyx_empty_tuple), ((PyObject *)__pyx_t_2)); if (unlikely(!__pyx_t_3)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 401; __pyx_clineno = __LINE__; goto __pyx_L1_error;}
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __Pyx_DECREF(((PyObject *)__pyx_t_2)); __pyx_t_2 = 0;
  __pyx_v_obj = __pyx_t_3;
  __pyx_t_3 = 0;
```


and in the *bad* way as

```
  __pyx_t_2.__pyx_n = 1;
  __pyx_t_2.owner = __pyx_v_owner;
  __pyx_t_1 = ((struct __pyx_vtabstruct_4sage_4misc_11lazy_import_LazyImport *)__pyx_v_self->__pyx_vtab)->_get_object(__pyx_v_self, 0, &__pyx_t_2); if (unlikely(!__pyx_t_1)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 401; __pyx_clineno = __LINE__; goto __pyx_L1_error;}
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_v_obj = __pyx_t_1;
  __pyx_t_1 = 0;
```



---

Comment by jdemeyer created at 2013-04-19 14:41:55

Alternatively, changing the line

```
cpdef _get_object(self, owner=None):
```

to

```
def _get_object(self, owner=None):
```

also fixes the problem. I am applying this workaround in [attachment:14452_cython_0.19.patch].


---

Comment by jdemeyer created at 2013-04-19 14:53:50

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2013-04-21 15:07:01

spkg diff


---

Attachment


---

Comment by jdemeyer created at 2013-04-22 12:04:59

With these patches, all fine on the buildbot.


---

Attachment


---

Comment by jdemeyer created at 2013-04-23 10:41:05

Rebased to #13826.


---

Comment by jdemeyer created at 2013-04-23 18:38:49

Changing priority from major to critical.


---

Comment by robertwb created at 2013-04-23 18:51:58

Changing status from needs_review to positive_review.


---

Comment by robertwb created at 2013-04-23 18:51:58

Thanks for debugging this! I filed http://trac.cython.org/cython_trac/ticket/810 about (what I think is) the underlying bug you uncovered with the lazy import stuff.


---

Comment by jdemeyer created at 2013-04-23 19:08:37

Resolution: fixed


---

Comment by jdemeyer created at 2013-04-24 12:24:32

Replying to [comment:26 robertwb]:
> Thanks for debugging this! I filed http://trac.cython.org/cython_trac/ticket/810 about (what I think is) the underlying bug you uncovered with the lazy import stuff. 
Do you have a better idea about what precisely is wrong? I isolated the problem, but I don't know why it segfaults.
