# Issue 10496: Improvements in canonical_form, is_isomorphic, and graph_isom_equivalent_non_edge_labeled_graph

Issue created by migration from Trac.

Original creator: stumpc5

Original creation time: 2011-01-03 16:23:05

Assignee: jason, ncohen, rlm

CC:  rlm@rlmiller.org aschilling

Keywords: graph, canonical form, isomorphism

This ticket implements several improvements in the three method in the summary.

Still needs work!


---

Comment by rlm created at 2011-01-11 00:11:49

More specifically, one improvement this ticket makes is the following:

Before, if given an edge labeled graph, the automorphism group function would first translate this to a non-edge labeled graph of larger size. It would do so by making a vertex `('o',v)` for each original vertex `v`, and also other vertices labeled `('x', i)`.

This ticket includes the optimization of using consecutive integers in the resulting graph instead of tuples to label the vertices. This removes a lot of overhead when translating back and forth, which makes the automorphism group function much faster.


---

Comment by rlm created at 2011-01-11 00:14:17

Changing status from new to needs_work.


---

Comment by rlm created at 2011-01-11 00:14:17

Unfortunately, the patch here doeesn't finish the job. For example, on lines 13088--13814, the old translation is still used, and as a result several doctests fail, in `sage/graphs/generic_graph.py` and `sage/geometry/polyhedra/py`.


---

Comment by rlm created at 2011-01-11 00:53:43

Sorry, that should have been lines 13808--13814.

Same thing also on line 14347.

Another problem is that copying graph backends is not currently implemented. However, it may seem to be when the line `G._backend = copy( g._backend )` executes without error. It seems to be simply copying the link address:

```
sage: G = Graph(sparse=True)
sage: G.add_edges( [(0,1,'a'),(1,2,'b'),(2,3,'c'),(3,4,'b'),(4,0,'a')] )
sage: G.num_verts()
5
sage: X = G.canonical_label(edge_labels=True)
sage: G.num_verts()
10
```


So that really needs to be fixed.

Also, this could have better coding style: `for i in [ v for v in g if v not in G_vertices ]:`. This could be `for i in g if i not in G_vertices:`, as there is no need to construct a list there.


---

Comment by stumpc5 created at 2011-01-11 15:55:48

Replying to [comment:3 rlm]:

> Another problem is that copying graph backends is not currently implemented. However, it may seem to be when the line `G._backend = copy( g._backend )` executes without error.

I now only make G = copy( g ), so this is again quite slow. But I don't see a better way to do it, do you?

> Also, this could have better coding style: `for i in [ v for v in g if v not in G_vertices ]:`. This could be `for i in g if i not in G_vertices:`, as there is no need to construct a list there.

done.


---

Attachment


---

Comment by rlm created at 2011-01-18 21:50:19

Changing status from needs_work to needs_review.


---

Comment by rlm created at 2011-01-18 21:50:19

The first patch looks very good. Since the ordering of canonical labels will now change for multi-edge and edge labeled graphs, this might be worth mentioning in the release note. Canonical labels are not in principle supposed to be stable from one release to the next, but they generally are. So it would be good to warn users about this.

As a result, I had to change one of the doctests in `species.py` whose canonical label is relabeled. I am certainly happy with the first patch, so if someone can review my patch, then this ticket can be set to positive review.


---

Comment by ncohen created at 2011-01-23 13:06:28

Hellooooooo !!

Only two errors in a -testall -long :


```python
sage -t -long sage-bug/sage/graphs/generic_graph.py
**********************************************************************
File "/home/ncohen/sage/devel/sage-bug/sage/graphs/generic_graph.py", line 14686:
    sage: G.is_isomorphic(H, edge_labels=True)
Expected:
    True
Got:
    False
**********************************************************************
File "/home/ncohen/sage/devel/sage-bug/sage/graphs/generic_graph.py", line 14688:
    sage: G.is_isomorphic(H, edge_labels=True, certify=True)
Expected:
    {0: 1, 1: 2, 2: 3, 3: 4, 4: 0}
Got:
    (False, None)
**********************************************************************
```


(I'm running the latest alpha1)

By the way : would you know of a "cheap/elegant" way to deal with this :


```python
sage: g = graphs.KneserGraph(8,2)
sage: h = g.copy()
sage: %timeit g.is_isomorphic(h)
125 loops, best of 3: 6.27 ms per loop
sage: h.relabel()
sage: %timeit g.is_isomorphic(h)
125 loops, best of 3: 4.72 ms per loop
sage: g.relabel()
sage: %timeit g.is_isomorphic(h)
125 loops, best of 3: 3.13 ms per loop
```


Or is it just because of the way labels are handled ?

Nathann


---

Comment by ncohen created at 2011-01-23 13:06:28

Changing status from needs_review to needs_work.


---

Comment by rlm created at 2011-03-11 05:25:47

Changing status from needs_work to needs_review.


---

Comment by rlm created at 2011-03-11 05:56:38

apply after other patch


---

Attachment


---

Attachment

I just posted a trivially rebased version of the patch trac_10549_refinements_graphs-cs.2.patch, which should now cleanly apply to sage-4.6.2. The same patch is now also in the sage-combinat queue (with the older version of the patch refinement_graphs-cs.patch disabled).

Anne


---

Comment by aschilling created at 2011-03-12 09:49:27

trac_10549_part2.patch correctly fixes a bug in isomorphisms of graphs when edge labels are supposed to be considered.

Anne


---

Comment by rlm created at 2011-03-12 19:30:14

Since you're happy with the second patch and I'm happy with the first, I'm setting this to positive review.


---

Comment by rlm created at 2011-03-12 19:30:14

Changing status from needs_review to positive_review.


---

Comment by rlm created at 2011-03-12 19:30:14

Changing priority from major to critical.


---

Comment by stumpc5 created at 2011-03-12 20:47:15

I somehow missed Nathann's message. Thanks for providing a patch!

Best, Christian


---

Comment by jdemeyer created at 2011-03-17 19:22:57

Resolution: fixed


---

Comment by jdemeyer created at 2011-03-19 17:12:14

Resolution changed from fixed to 


---

Comment by jdemeyer created at 2011-03-19 17:12:14

Some problems on various Buildbot machines (probably the ones which are 32-bit):

```
sage -t -long  -force_lib devel/sage/sage/combinat/species/species.py
**********************************************************************
File "/home/buildbot/build/sage/cicero-1/cicero_full/build/sage-4.7.alpha2/devel/sage-main/sage/combinat/species/species.py", line 667:
    sage: list(sorted(labels.items()))
Expected:
    [(Combinatorial species, 1),
     (Product of (Combinatorial species) and (Combinatorial species), 3),
     (Singleton species, 0),
     (Sum of (Singleton species) and (Product of (Combinatorial species) and (Combinatorial species)), 2)]
Got:
    [(Combinatorial species, 0), (Product of (Combinatorial species) and (Combinatorial species), 1), (Singleton species, 3), (Sum of (Singleton species) and (Product of (Combinatorial species) and (Combinatorial species)), 2)]
**********************************************************************
File "/home/buildbot/build/sage/cicero-1/cicero_full/build/sage-4.7.alpha2/devel/sage-main/sage/combinat/species/species.py", line 672:
    sage: g.edges()
Expected:
    [(1, 2, None), (2, 0, None), (2, 3, None), (3, 1, None), (3, 1, None)]
Got:
    [(0, 2, None), (1, 0, None), (1, 0, None), (2, 1, None), (2, 3, None)]
**********************************************************************
```



---

Comment by jdemeyer created at 2011-03-19 17:12:14

Changing status from closed to new.


---

Comment by jdemeyer created at 2011-03-19 17:12:24

Changing status from new to needs_work.


---

Attachment


---

Comment by rlm created at 2011-04-12 20:28:05

Changing status from needs_work to needs_review.


---

Comment by rlm created at 2011-04-12 20:28:05

I'm setting this to needs_review, although note that its dependency #11181 is not quite ready yet.


---

Comment by stumpc5 created at 2011-04-18 22:26:25

Apply trac_10549_flat.patch


---

Comment by ncohen created at 2011-04-30 17:34:29

Positive review to this one !

Passes -testall -long, so I hope the many, many doctests scattered in Sage which use those methods would have gone ballistic in case I missed something dangerous `:-)`

Nathann


---

Comment by ncohen created at 2011-04-30 17:34:29

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2011-05-10 08:20:00

This patch conflicts with #10804.


---

Comment by jdemeyer created at 2011-05-10 08:20:00

Changing status from positive_review to needs_work.


---

Comment by rlm created at 2011-05-11 20:49:00

Changing status from needs_work to positive_review.


---

Comment by rlm created at 2011-05-11 20:49:00

Go ahead and merge this one, I'll rebase the other one.


---

Comment by jdemeyer created at 2011-05-13 06:13:29

Resolution: fixed
