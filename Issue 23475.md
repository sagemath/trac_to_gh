# Issue 23475: update tachyon to 0.99

Issue created by migration from Trac.

Original creator: dimpase

Original creation time: 2017-08-25 10:56:35

CC:  slelievre mjo fbissey arojas tscrim

We currently are shipping a 7 years old tachyon (0.98).
0.99b6 is from 2013, and is de facto stable version, e.g. in debian or gentoo.

This is also needed to make Sage work on arm64/aarch64, see #23687.

the tarball is here: http://jedi.ks.uiuc.edu/~johns/tachyon/files/0.99b6/tachyon-0.99b6.tar.gz


---

Comment by chapoton created at 2017-08-25 17:03:38

None of our 4 patches does apply. I do not know if they should be removed or rebased.
----
New commits:


---

Comment by dimpase created at 2017-08-26 22:56:20

there are quite a few doctests failing with this branch. Presumably the interface might have changed a bit.


---

Comment by fbissey created at 2017-08-27 03:13:39

Replying to [comment:2 dimpase]:
> there are quite a few doctests failing with this branch. Presumably the interface might have changed a bit.

That's what I remember. Are all the failing doctests in doc? I realised yesterday that I have lost the ability to test those in sage-on-gentoo recently (for some reason .rst files get installed as .rst.txt and then they are not tested). So I miss all broken doctests from rst files at the moment. 

For the record I don't seem to have any (repeatable) failures on the stuff I doctest in sage-on-gentoo.


---

Comment by dimpase created at 2017-08-27 17:04:11

This is what I get with ptestlong:

```
sage -t --long --warn-long 45.7 src/sage/plot/plot3d/parametric_plot3d.py  # 1 doctest failed
sage -t --long --warn-long 45.7 src/sage/plot/plot3d/implicit_plot3d.py  # 6 doctests failed
sage -t --long --warn-long 45.7 src/sage/plot/plot3d/platonic.py  # 1 doctest failed
sage -t --long --warn-long 45.7 src/sage/graphs/generic_graph.py  # 9 doctests failed
sage -t --long --warn-long 45.7 src/sage/plot/plot3d/parametric_surface.pyx  # 3 doctests failed
sage -t --long --warn-long 45.7 src/sage/plot/plot3d/implicit_surface.pyx  # 1 doctest failed
sage -t --long --warn-long 45.7 src/sage/plot/plot3d/tachyon.py  # 21 doctests failed
sage -t --long --warn-long 45.7 src/sage/combinat/tiling.py  # 1 doctest failed
sage -t --long --warn-long 45.7 src/sage/numerical/sdp.pyx  # 9 doctests failed
sage -t --long --warn-long 45.7 src/sage/numerical/backends/cvxopt_sdp_backend.pyx  # 7 doctests failed
sage -t --long --warn-long 45.7 src/sage/geometry/polyhedron/backend_normaliz.py  # 2 doctests failed
sage -t --long --warn-long 45.7 src/sage/plot/plot3d/index_face_set.pyx  # 1 doctest failed
sage -t --long --warn-long 45.7 src/sage/plot/plot3d/base.pyx  # 1 doctest failed
```

Typically it's something about PNG interface:

```
Using --optional=ccache,cmake,database_gap,gap_packages,mpir,normaliz,pynormaliz,python2,qhull,sage
Doctesting entire Sage library.
Sorting sources by runtime so that slower doctests are run first....
Doctesting 3578 files using 4 threads.
sage -t --long --warn-long 45.7 src/sage/plot/plot3d/parametric_plot3d.py
**********************************************************************
File "src/sage/plot/plot3d/parametric_plot3d.py", line 172, in sage.plot.plot3d.parametric_plot3d.?
Failed example:
    P.show(viewer='tachyon')
Exception raised:
    Traceback (most recent call last):
      File "/home/dima/Sage/sage-dev/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 515, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/dima/Sage/sage-dev/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 885, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.plot.plot3d.parametric_plot3d.?[13]>", line 1, in <module>
        P.show(viewer='tachyon')
      File "sage/plot/plot3d/base.pyx", line 1478, in sage.plot.plot3d.base.Graphics3d.show (build/cythonized/sage/plot/plot3d/base.c
:21367)
        dm.display_immediately(self, **kwds)
      File "/home/dima/Sage/sage-dev/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py", line 834, in displa
y_immediately
        self._backend.display_immediately(plain_text, rich_output)
      File "/home/dima/Sage/sage-dev/local/lib/python2.7/site-packages/sage/repl/rich_output/backend_doctest.py", line 209, in displa
y_immediately
        self.validate(rich_output)
      File "/home/dima/Sage/sage-dev/local/lib/python2.7/site-packages/sage/repl/rich_output/backend_doctest.py", line 270, in valida
te
        assert rich_output.png.get().startswith('\x89PNG')
    AssertionError
```

Running the corresponding lines at the Sage prompt works and shows a meaningful plot.
However, it's not stored in a PNG file, it's stored in TGA file:

```
$ file tmp_ZccmzF.png 
tmp_ZccmzF.png: Targa image data - RGB 500 x 500 x 24 - top Targa image data - RGB 500 x 500 x 24 - top
```



---

Comment by dimpase created at 2017-08-27 17:26:46

In fact, ldd says that tachyon is not linked to libpng - no wonder it cannot do PNG.


---

Comment by dimpase created at 2017-08-27 17:40:23

I see that Debian has a set of patches to this version, including autotoolisation!
https://packages.debian.org/source/sid/tachyon

Should we use them, rather than keep wrestling with patches to Makefiles?


---

Comment by fbissey created at 2017-08-27 20:22:53

Probably. The linking problem would also explain why I don't see those failures in s-o-g.


---

Comment by fbissey created at 2017-08-28 09:32:50

That's a lot of patches https://anonscm.debian.org/cgit/debian-science/packages/tachyon.git/tree/debian/patches but most of them will probably be handy. Are you up to write a `spkg-src`?


---

Comment by dimpase created at 2017-08-28 11:00:44

Replying to [comment:8 fbissey]:
> That's a lot of patches https://anonscm.debian.org/cgit/debian-science/packages/tachyon.git/tree/debian/patches but most of them will probably be handy. Are you up to write a `spkg-src`?

I have a problem with them at the moment: namely, applying these patches and invoking `autoreconf -i -f` leads to

```
src/Makefile.am:33: error: HAVE_LD_VERSION_SCRIPT does not appear in AM_CONDITIONAL
```

Note that `src/Makefile.am` has the following lines around line 33:

```
libtachyon_la_LD_VERSION_SCRIPT=
if HAVE_LD_VERSION_SCRIPT
libtachyon_la_LD_VERSION_SCRIPT+= -Wl,--version-script=$(top_srcdir)/src/tachyon.map
endif
```

This can be remedied by adding to `configure.ac` the following:

```
AM_CONDITIONAL([HAVE_LD_VERSION_SCRIPT],   [blah...])
```

but I don't quite see what `blah...` should be. (I put in some random shell call just to see if it helps, and it does, but that's of course not a proper fix).


So this looks like a bug in Debian patches (namely in `upstream-rationalization-autotools.patch`), which only manifests itself in non-Debian setting.


---

Comment by dimpase created at 2017-08-28 12:47:34

And I also don't get how to configure and run make to create a `tachyon` executable. All what `make install` does, it installs headers and various dynamic libs, such as `libtachyon-mt-thr.so.0.0.0`.


---

Comment by slelievre created at 2019-01-30 20:17:15

Changing keywords from "" to "upgrade, tachyon".


---

Comment by embray created at 2019-03-25 10:56:15

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)


---

Comment by embray created at 2019-06-14 14:54:19

As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).


---

Comment by @timokau created at 2019-08-13 19:23:42

For what it's worth I'm just fixing up aarch64 sage on nixos and I get no doctest failures with tachyon 0.99b2 (the version we ship).

There are some transient timeout failures, but that's it. Probably not related to tachyon.


---

Comment by mjo created at 2022-01-19 00:13:34

There's officially a new release, v0.99.2:

  http://jedi.ks.uiuc.edu/~johns/raytracer/


---

Comment by git created at 2022-03-06 20:29:22

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-03-06 20:34:52

Patches need updating or removing


---

Comment by git created at 2022-03-07 10:06:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2022-03-07 10:10:55

Now it builds (at least on Linux). For tests, there was an option renaming `focallength->FOCALDIST`.
The following patch makes all tests pass:

```diff
--- a/src/sage/interfaces/tachyon.py
+++ b/src/sage/interfaces/tachyon.py
`@``@` -261,13 +261,13 `@``@` written in the sequence they are listed in the examples in this section.
   The {\bf PROJECTION} keyword must be followed by one of the supported
 camera projection mode identifiers {\bf PERSPECTIVE}, {\bf PERSPECTIVE_DOF},
 {\bf ORTHOGRAPHIC}, or {\bf FISHEYE}.  The {\bf FISHEYE} projection mode
-requires two extra parameters {\bf FOCALLENGTH} and {\bf APERTURE}
+requires two extra parameters {\bf FOCALDIST} and {\bf APERTURE}
 which precede the regular camera options.
 
 \begin{verbatim}
 Camera
   projection perspective_dof
-  focallength 0.75
+  FOCALDIST 0.75
   aperture 0.02
   Zoom 0.666667
   Aspectratio 1.000000
diff --git a/src/sage/plot/plot3d/tachyon.py b/src/sage/plot/plot3d/tachyon.py
index 08caf38d67..41b646a80f 100644
--- a/src/sage/plot/plot3d/tachyon.py
+++ b/src/sage/plot/plot3d/tachyon.py
`@``@` -92,7 +92,7 `@``@` angle, right angle)::
 Finally there is the ``projection='perspective_dof'`` option. ::
 
     sage: T = Tachyon(xres=800, antialiasing=4, raydepth=10,
-    ....: projection='perspective_dof', focallength='1.0', aperture='.0025')
+    ....: projection='perspective_dof', FOCALDIST='1.0', aperture='.0025')
     sage: T.light((0,5,7), 1.0, (1,1,1))
     sage: T.texture('t1', opacity=1, specular=.3)
     sage: T.texture('t2', opacity=1, specular=.3, color=(0,0,1))
`@``@` -186,7 +186,7 `@``@` class Tachyon(WithEqualityById, SageObject):
       or ``'fisheye'``.
     - ``frustum`` - (default ''), otherwise list of four numbers. Only
       used with projection='fisheye'.
-    - ``focallength`` - (default ''), otherwise a number. Only used
+    - ``FOCALDIST`` - (default ''), otherwise a number. Only used
       with projection='perspective_dof'.
     - ``aperture`` - (default ''), otherwise a number.  Only used
       with projection='perspective_dof'.
`@``@` -331,7 +331,7 `@``@` class Tachyon(WithEqualityById, SageObject):
     Use of the ``projection='perspective_dof'`` option.  This may not be
     implemented correctly. ::
 
-        sage: T = Tachyon(xres=800,antialiasing=4, raydepth=10, projection='perspective_dof', focallength='1.0', aperture='.0025')
+        sage: T = Tachyon(xres=800,antialiasing=4, raydepth=10, projection='perspective_dof', FOCALDIST='1.0', aperture='.0025')
         sage: T.light((0,5,7), 1.0, (1,1,1))
         sage: T.texture('t1', opacity=1, specular=.3)
         sage: T.texture('t2', opacity=1, specular=.3, color=(0,0,1))
`@``@` -365,7 +365,7 `@``@` class Tachyon(WithEqualityById, SageObject):
                  look_at=[0, 0, 0],
                  viewdir=None,
                  projection='PERSPECTIVE',
-                 focallength='',
+                 FOCALDIST='',
                  aperture='',
                  frustum=''):
         r"""
`@``@` -391,7 +391,7 `@``@` class Tachyon(WithEqualityById, SageObject):
             self._camera_position = (-3, 0, 0) # default value
         self._updir = updir
         self._projection = projection
-        self._focallength = focallength
+        self._FOCALDIST = FOCALDIST
         self._aperture = aperture
         self._frustum = frustum
         self._objects = []
`@``@` -624,9 +624,9 `@``@` class Tachyon(WithEqualityById, SageObject):
         camera_out = r"""
            camera
               projection %s""" % (tostr(self._projection))
-        if self._focallength != '':
+        if self._FOCALDIST != '':
             camera_out = camera_out + r"""
-              focallength %s""" % (float(self._focallength))
+              FOCALDIST %s""" % (float(self._FOCALDIST))
         if self._aperture != '':
             camera_out = camera_out + r"""
               aperture %s""" % (float(self._aperture))
```


Not sure how to best handle this and older versions of `tachyon` at the same time.


---

Comment by dimpase created at 2022-03-15 10:45:33

Probably the latter could be accomplished by using a decorator.


---

Comment by mkoeppe created at 2022-05-01 19:00:51

opensuse-tumbleweed now has a new tachyon, causes failures https://github.com/sagemath/sage/runs/6236170449


---

Comment by mkoeppe created at 2022-05-01 19:12:46

and 0.99.5 is out


---

Comment by tornaria created at 2022-12-21 03:05:09

The following makes all tests pass with new versions of tachyon, without breaking old versions. I tested it with 0.99 (old) and 0.99.5 (new).

This does not change the sage interface in `sage.plot.plot3d.tachyon`, it will still use `focallength` so the change is very safe to apply. In the future (possibly when tachyon in sage gets upgraded), all the `focallength` occurences in `sage.plot.plot3d.tachyon` can be replaced by `focaldist` for consistency with new tachyon, and the logic here can be reversed (i.e. patch the model when `self.version() < '0.99.2'`).




{{{ #!diff
--- a/src/sage/interfaces/tachyon.py
+++ b/src/sage/interfaces/tachyon.py
`@``@` -683,12 +683,14 `@``@`
 #*****************************************************************************
 
 import os
+import re
 
 from sage.cpython.string import bytes_to_str
 from sage.misc.pager import pager
 from sage.misc.superseded import deprecation
 from sage.misc.temporary_file import tmp_filename
 from sage.structure.sage_object import SageObject
+from sage.misc.cachefunc import cached_method
 
 
 class TachyonRT(SageObject):
`@``@` -799,6 +801,11 `@``@` class TachyonRT(SageObject):
             Parser failed due to an input file syntax error.
             Aborting render.
         """
+        if self.version() >= '0.99.2':
+            # this keyword was changed in 0.99.2
+            model = model.replace(
+                    "              focallength ",
+                    "              focaldist ")
         modelfile = tmp_filename(ext='.dat')
         with open(modelfile, 'w') as file:
             file.write(model)
`@``@` -851,6 +858,22 `@``@` class TachyonRT(SageObject):
         else:
             print(r)
 
+    `@`cached_method
+    def version(self):
+        """
+        Returns the version of the Tachyon raytracer being used.
+
+        TESTS::
+
+            sage: tachyon_rt.version()  # not tested
+            0.98.9
+            sage: tachyon_rt.version() >= '0.98.9'
+            True
+        """
+        with os.popen('tachyon') as f:
+            r = f.read()
+        return re.search(r"Version ([\d.]*)", r)[1]
+
     def help(self, use_pager=True):
         """
         Deprecated: type 'sage.interfaces.tachyon?' for help
}}}


BTW, in order for tachyon spkg to work in aarch64, all I had to do is the following trivial change:
{{{ #!diff
--- a/build/pkgs/tachyon/spkg-install.in
+++ b/build/pkgs/tachyon/spkg-install.in
`@``@` -30,7 +30,7 `@``@`
     ppc*|powerpc*)
         TARGET=linux-ppc
         ;;
-    armv6l*|armv7l*)
+    armv6l*|armv7l*|aarch64*)
         TARGET=linux-arm-thr
         ;;
     esac
}}}


---

Comment by dimpase created at 2022-12-21 08:22:42

afk, please post your branch here
