# Issue 23475: update tachyon to 0.99

archive/issues_023475.json:
```json
{
    "body": "CC:  slelievre mjo fbissey arojas tscrim\n\nWe currently are shipping a 7 years old tachyon (0.98).\n0.99b6 is from 2013, and is de facto stable version, e.g. in debian or gentoo.\n\nThis is also needed to make Sage work on arm64/aarch64, see #23687.\n\nthe tarball is here: http://jedi.ks.uiuc.edu/~johns/tachyon/files/0.99b6/tachyon-0.99b6.tar.gz\n\nIssue created by migration from https://trac.sagemath.org/ticket/23712\n\n",
    "created_at": "2017-08-25T10:56:35Z",
    "labels": [
        "packages: standard",
        "major",
        "enhancement"
    ],
    "title": "update tachyon to 0.99",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23475",
    "user": "dimpase"
}
```
CC:  slelievre mjo fbissey arojas tscrim

We currently are shipping a 7 years old tachyon (0.98).
0.99b6 is from 2013, and is de facto stable version, e.g. in debian or gentoo.

This is also needed to make Sage work on arm64/aarch64, see #23687.

the tarball is here: http://jedi.ks.uiuc.edu/~johns/tachyon/files/0.99b6/tachyon-0.99b6.tar.gz

Issue created by migration from https://trac.sagemath.org/ticket/23712





---

archive/issue_comments_328985.json:
```json
{
    "body": "None of our 4 patches does apply. I do not know if they should be removed or rebased.\n----\nNew commits:",
    "created_at": "2017-08-25T17:03:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23475#issuecomment-328985",
    "user": "chapoton"
}
```

None of our 4 patches does apply. I do not know if they should be removed or rebased.
----
New commits:



---

archive/issue_comments_328986.json:
```json
{
    "body": "there are quite a few doctests failing with this branch. Presumably the interface might have changed a bit.",
    "created_at": "2017-08-26T22:56:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23475#issuecomment-328986",
    "user": "dimpase"
}
```

there are quite a few doctests failing with this branch. Presumably the interface might have changed a bit.



---

archive/issue_comments_328987.json:
```json
{
    "body": "Replying to [comment:2 dimpase]:\n> there are quite a few doctests failing with this branch. Presumably the interface might have changed a bit.\n\nThat's what I remember. Are all the failing doctests in doc? I realised yesterday that I have lost the ability to test those in sage-on-gentoo recently (for some reason .rst files get installed as .rst.txt and then they are not tested). So I miss all broken doctests from rst files at the moment. \n\nFor the record I don't seem to have any (repeatable) failures on the stuff I doctest in sage-on-gentoo.",
    "created_at": "2017-08-27T03:13:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23475#issuecomment-328987",
    "user": "fbissey"
}
```

Replying to [comment:2 dimpase]:
> there are quite a few doctests failing with this branch. Presumably the interface might have changed a bit.

That's what I remember. Are all the failing doctests in doc? I realised yesterday that I have lost the ability to test those in sage-on-gentoo recently (for some reason .rst files get installed as .rst.txt and then they are not tested). So I miss all broken doctests from rst files at the moment. 

For the record I don't seem to have any (repeatable) failures on the stuff I doctest in sage-on-gentoo.



---

archive/issue_comments_328988.json:
```json
{
    "body": "This is what I get with ptestlong:\n\n```\nsage -t --long --warn-long 45.7 src/sage/plot/plot3d/parametric_plot3d.py  # 1 doctest failed\nsage -t --long --warn-long 45.7 src/sage/plot/plot3d/implicit_plot3d.py  # 6 doctests failed\nsage -t --long --warn-long 45.7 src/sage/plot/plot3d/platonic.py  # 1 doctest failed\nsage -t --long --warn-long 45.7 src/sage/graphs/generic_graph.py  # 9 doctests failed\nsage -t --long --warn-long 45.7 src/sage/plot/plot3d/parametric_surface.pyx  # 3 doctests failed\nsage -t --long --warn-long 45.7 src/sage/plot/plot3d/implicit_surface.pyx  # 1 doctest failed\nsage -t --long --warn-long 45.7 src/sage/plot/plot3d/tachyon.py  # 21 doctests failed\nsage -t --long --warn-long 45.7 src/sage/combinat/tiling.py  # 1 doctest failed\nsage -t --long --warn-long 45.7 src/sage/numerical/sdp.pyx  # 9 doctests failed\nsage -t --long --warn-long 45.7 src/sage/numerical/backends/cvxopt_sdp_backend.pyx  # 7 doctests failed\nsage -t --long --warn-long 45.7 src/sage/geometry/polyhedron/backend_normaliz.py  # 2 doctests failed\nsage -t --long --warn-long 45.7 src/sage/plot/plot3d/index_face_set.pyx  # 1 doctest failed\nsage -t --long --warn-long 45.7 src/sage/plot/plot3d/base.pyx  # 1 doctest failed\n```\n\nTypically it's something about PNG interface:\n\n```\nUsing --optional=ccache,cmake,database_gap,gap_packages,mpir,normaliz,pynormaliz,python2,qhull,sage\nDoctesting entire Sage library.\nSorting sources by runtime so that slower doctests are run first....\nDoctesting 3578 files using 4 threads.\nsage -t --long --warn-long 45.7 src/sage/plot/plot3d/parametric_plot3d.py\n**********************************************************************\nFile \"src/sage/plot/plot3d/parametric_plot3d.py\", line 172, in sage.plot.plot3d.parametric_plot3d.?\nFailed example:\n    P.show(viewer='tachyon')\nException raised:\n    Traceback (most recent call last):\n      File \"/home/dima/Sage/sage-dev/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 515, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/dima/Sage/sage-dev/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 885, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.plot.plot3d.parametric_plot3d.?[13]>\", line 1, in <module>\n        P.show(viewer='tachyon')\n      File \"sage/plot/plot3d/base.pyx\", line 1478, in sage.plot.plot3d.base.Graphics3d.show (build/cythonized/sage/plot/plot3d/base.c\n:21367)\n        dm.display_immediately(self, **kwds)\n      File \"/home/dima/Sage/sage-dev/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py\", line 834, in displa\ny_immediately\n        self._backend.display_immediately(plain_text, rich_output)\n      File \"/home/dima/Sage/sage-dev/local/lib/python2.7/site-packages/sage/repl/rich_output/backend_doctest.py\", line 209, in displa\ny_immediately\n        self.validate(rich_output)\n      File \"/home/dima/Sage/sage-dev/local/lib/python2.7/site-packages/sage/repl/rich_output/backend_doctest.py\", line 270, in valida\nte\n        assert rich_output.png.get().startswith('\\x89PNG')\n    AssertionError\n```\n\nRunning the corresponding lines at the Sage prompt works and shows a meaningful plot.\nHowever, it's not stored in a PNG file, it's stored in TGA file:\n\n```\n$ file tmp_ZccmzF.png \ntmp_ZccmzF.png: Targa image data - RGB 500 x 500 x 24 - top Targa image data - RGB 500 x 500 x 24 - top\n```\n",
    "created_at": "2017-08-27T17:04:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23475#issuecomment-328988",
    "user": "dimpase"
}
```

This is what I get with ptestlong:

```
sage -t --long --warn-long 45.7 src/sage/plot/plot3d/parametric_plot3d.py  # 1 doctest failed
sage -t --long --warn-long 45.7 src/sage/plot/plot3d/implicit_plot3d.py  # 6 doctests failed
sage -t --long --warn-long 45.7 src/sage/plot/plot3d/platonic.py  # 1 doctest failed
sage -t --long --warn-long 45.7 src/sage/graphs/generic_graph.py  # 9 doctests failed
sage -t --long --warn-long 45.7 src/sage/plot/plot3d/parametric_surface.pyx  # 3 doctests failed
sage -t --long --warn-long 45.7 src/sage/plot/plot3d/implicit_surface.pyx  # 1 doctest failed
sage -t --long --warn-long 45.7 src/sage/plot/plot3d/tachyon.py  # 21 doctests failed
sage -t --long --warn-long 45.7 src/sage/combinat/tiling.py  # 1 doctest failed
sage -t --long --warn-long 45.7 src/sage/numerical/sdp.pyx  # 9 doctests failed
sage -t --long --warn-long 45.7 src/sage/numerical/backends/cvxopt_sdp_backend.pyx  # 7 doctests failed
sage -t --long --warn-long 45.7 src/sage/geometry/polyhedron/backend_normaliz.py  # 2 doctests failed
sage -t --long --warn-long 45.7 src/sage/plot/plot3d/index_face_set.pyx  # 1 doctest failed
sage -t --long --warn-long 45.7 src/sage/plot/plot3d/base.pyx  # 1 doctest failed
```

Typically it's something about PNG interface:

```
Using --optional=ccache,cmake,database_gap,gap_packages,mpir,normaliz,pynormaliz,python2,qhull,sage
Doctesting entire Sage library.
Sorting sources by runtime so that slower doctests are run first....
Doctesting 3578 files using 4 threads.
sage -t --long --warn-long 45.7 src/sage/plot/plot3d/parametric_plot3d.py
**********************************************************************
File "src/sage/plot/plot3d/parametric_plot3d.py", line 172, in sage.plot.plot3d.parametric_plot3d.?
Failed example:
    P.show(viewer='tachyon')
Exception raised:
    Traceback (most recent call last):
      File "/home/dima/Sage/sage-dev/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 515, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/dima/Sage/sage-dev/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 885, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.plot.plot3d.parametric_plot3d.?[13]>", line 1, in <module>
        P.show(viewer='tachyon')
      File "sage/plot/plot3d/base.pyx", line 1478, in sage.plot.plot3d.base.Graphics3d.show (build/cythonized/sage/plot/plot3d/base.c
:21367)
        dm.display_immediately(self, **kwds)
      File "/home/dima/Sage/sage-dev/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py", line 834, in displa
y_immediately
        self._backend.display_immediately(plain_text, rich_output)
      File "/home/dima/Sage/sage-dev/local/lib/python2.7/site-packages/sage/repl/rich_output/backend_doctest.py", line 209, in displa
y_immediately
        self.validate(rich_output)
      File "/home/dima/Sage/sage-dev/local/lib/python2.7/site-packages/sage/repl/rich_output/backend_doctest.py", line 270, in valida
te
        assert rich_output.png.get().startswith('\x89PNG')
    AssertionError
```

Running the corresponding lines at the Sage prompt works and shows a meaningful plot.
However, it's not stored in a PNG file, it's stored in TGA file:

```
$ file tmp_ZccmzF.png 
tmp_ZccmzF.png: Targa image data - RGB 500 x 500 x 24 - top Targa image data - RGB 500 x 500 x 24 - top
```




---

archive/issue_comments_328989.json:
```json
{
    "body": "In fact, ldd says that tachyon is not linked to libpng - no wonder it cannot do PNG.",
    "created_at": "2017-08-27T17:26:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23475#issuecomment-328989",
    "user": "dimpase"
}
```

In fact, ldd says that tachyon is not linked to libpng - no wonder it cannot do PNG.



---

archive/issue_comments_328990.json:
```json
{
    "body": "I see that Debian has a set of patches to this version, including autotoolisation!\nhttps://packages.debian.org/source/sid/tachyon\n\nShould we use them, rather than keep wrestling with patches to Makefiles?",
    "created_at": "2017-08-27T17:40:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23475#issuecomment-328990",
    "user": "dimpase"
}
```

I see that Debian has a set of patches to this version, including autotoolisation!
https://packages.debian.org/source/sid/tachyon

Should we use them, rather than keep wrestling with patches to Makefiles?



---

archive/issue_comments_328991.json:
```json
{
    "body": "Probably. The linking problem would also explain why I don't see those failures in s-o-g.",
    "created_at": "2017-08-27T20:22:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23475#issuecomment-328991",
    "user": "fbissey"
}
```

Probably. The linking problem would also explain why I don't see those failures in s-o-g.



---

archive/issue_comments_328992.json:
```json
{
    "body": "That's a lot of patches https://anonscm.debian.org/cgit/debian-science/packages/tachyon.git/tree/debian/patches but most of them will probably be handy. Are you up to write a `spkg-src`?",
    "created_at": "2017-08-28T09:32:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23475#issuecomment-328992",
    "user": "fbissey"
}
```

That's a lot of patches https://anonscm.debian.org/cgit/debian-science/packages/tachyon.git/tree/debian/patches but most of them will probably be handy. Are you up to write a `spkg-src`?



---

archive/issue_comments_328993.json:
```json
{
    "body": "Replying to [comment:8 fbissey]:\n> That's a lot of patches https://anonscm.debian.org/cgit/debian-science/packages/tachyon.git/tree/debian/patches but most of them will probably be handy. Are you up to write a `spkg-src`?\n\nI have a problem with them at the moment: namely, applying these patches and invoking `autoreconf -i -f` leads to\n\n```\nsrc/Makefile.am:33: error: HAVE_LD_VERSION_SCRIPT does not appear in AM_CONDITIONAL\n```\n\nNote that `src/Makefile.am` has the following lines around line 33:\n\n```\nlibtachyon_la_LD_VERSION_SCRIPT=\nif HAVE_LD_VERSION_SCRIPT\nlibtachyon_la_LD_VERSION_SCRIPT+= -Wl,--version-script=$(top_srcdir)/src/tachyon.map\nendif\n```\n\nThis can be remedied by adding to `configure.ac` the following:\n\n```\nAM_CONDITIONAL([HAVE_LD_VERSION_SCRIPT],   [blah...])\n```\n\nbut I don't quite see what `blah...` should be. (I put in some random shell call just to see if it helps, and it does, but that's of course not a proper fix).\n\n\nSo this looks like a bug in Debian patches (namely in `upstream-rationalization-autotools.patch`), which only manifests itself in non-Debian setting.",
    "created_at": "2017-08-28T11:00:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23475#issuecomment-328993",
    "user": "dimpase"
}
```

Replying to [comment:8 fbissey]:
> That's a lot of patches https://anonscm.debian.org/cgit/debian-science/packages/tachyon.git/tree/debian/patches but most of them will probably be handy. Are you up to write a `spkg-src`?

I have a problem with them at the moment: namely, applying these patches and invoking `autoreconf -i -f` leads to

```
src/Makefile.am:33: error: HAVE_LD_VERSION_SCRIPT does not appear in AM_CONDITIONAL
```

Note that `src/Makefile.am` has the following lines around line 33:

```
libtachyon_la_LD_VERSION_SCRIPT=
if HAVE_LD_VERSION_SCRIPT
libtachyon_la_LD_VERSION_SCRIPT+= -Wl,--version-script=$(top_srcdir)/src/tachyon.map
endif
```

This can be remedied by adding to `configure.ac` the following:

```
AM_CONDITIONAL([HAVE_LD_VERSION_SCRIPT],   [blah...])
```

but I don't quite see what `blah...` should be. (I put in some random shell call just to see if it helps, and it does, but that's of course not a proper fix).


So this looks like a bug in Debian patches (namely in `upstream-rationalization-autotools.patch`), which only manifests itself in non-Debian setting.



---

archive/issue_comments_328994.json:
```json
{
    "body": "And I also don't get how to configure and run make to create a `tachyon` executable. All what `make install` does, it installs headers and various dynamic libs, such as `libtachyon-mt-thr.so.0.0.0`.",
    "created_at": "2017-08-28T12:47:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23475#issuecomment-328994",
    "user": "dimpase"
}
```

And I also don't get how to configure and run make to create a `tachyon` executable. All what `make install` does, it installs headers and various dynamic libs, such as `libtachyon-mt-thr.so.0.0.0`.



---

archive/issue_comments_328995.json:
```json
{
    "body": "Changing keywords from \"\" to \"upgrade, tachyon\".",
    "created_at": "2019-01-30T20:17:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23475#issuecomment-328995",
    "user": "slelievre"
}
```

Changing keywords from "" to "upgrade, tachyon".



---

archive/issue_comments_328996.json:
```json
{
    "body": "Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)",
    "created_at": "2019-03-25T10:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23475#issuecomment-328996",
    "user": "embray"
}
```

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)



---

archive/issue_comments_328997.json:
```json
{
    "body": "As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).",
    "created_at": "2019-06-14T14:54:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23475#issuecomment-328997",
    "user": "embray"
}
```

As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).



---

archive/issue_comments_328998.json:
```json
{
    "body": "For what it's worth I'm just fixing up aarch64 sage on nixos and I get no doctest failures with tachyon 0.99b2 (the version we ship).\n\nThere are some transient timeout failures, but that's it. Probably not related to tachyon.",
    "created_at": "2019-08-13T19:23:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23475#issuecomment-328998",
    "user": "@timokau"
}
```

For what it's worth I'm just fixing up aarch64 sage on nixos and I get no doctest failures with tachyon 0.99b2 (the version we ship).

There are some transient timeout failures, but that's it. Probably not related to tachyon.



---

archive/issue_comments_328999.json:
```json
{
    "body": "There's officially a new release, v0.99.2:\n\n  http://jedi.ks.uiuc.edu/~johns/raytracer/",
    "created_at": "2022-01-19T00:13:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23475#issuecomment-328999",
    "user": "mjo"
}
```

There's officially a new release, v0.99.2:

  http://jedi.ks.uiuc.edu/~johns/raytracer/



---

archive/issue_comments_329000.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-03-06T20:29:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23475#issuecomment-329000",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_329001.json:
```json
{
    "body": "Patches need updating or removing",
    "created_at": "2022-03-06T20:34:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23475#issuecomment-329001",
    "user": "mkoeppe"
}
```

Patches need updating or removing



---

archive/issue_comments_329002.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-07T10:06:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23475#issuecomment-329002",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_329003.json:
```json
{
    "body": "Now it builds (at least on Linux). For tests, there was an option renaming `focallength->FOCALDIST`.\nThe following patch makes all tests pass:\n\n```diff\n--- a/src/sage/interfaces/tachyon.py\n+++ b/src/sage/interfaces/tachyon.py\n@@ -261,13 +261,13 @@ written in the sequence they are listed in the examples in this section.\n   The {\\bf PROJECTION} keyword must be followed by one of the supported\n camera projection mode identifiers {\\bf PERSPECTIVE}, {\\bf PERSPECTIVE_DOF},\n {\\bf ORTHOGRAPHIC}, or {\\bf FISHEYE}.  The {\\bf FISHEYE} projection mode\n-requires two extra parameters {\\bf FOCALLENGTH} and {\\bf APERTURE}\n+requires two extra parameters {\\bf FOCALDIST} and {\\bf APERTURE}\n which precede the regular camera options.\n \n \\begin{verbatim}\n Camera\n   projection perspective_dof\n-  focallength 0.75\n+  FOCALDIST 0.75\n   aperture 0.02\n   Zoom 0.666667\n   Aspectratio 1.000000\ndiff --git a/src/sage/plot/plot3d/tachyon.py b/src/sage/plot/plot3d/tachyon.py\nindex 08caf38d67..41b646a80f 100644\n--- a/src/sage/plot/plot3d/tachyon.py\n+++ b/src/sage/plot/plot3d/tachyon.py\n@@ -92,7 +92,7 @@ angle, right angle)::\n Finally there is the ``projection='perspective_dof'`` option. ::\n \n     sage: T = Tachyon(xres=800, antialiasing=4, raydepth=10,\n-    ....: projection='perspective_dof', focallength='1.0', aperture='.0025')\n+    ....: projection='perspective_dof', FOCALDIST='1.0', aperture='.0025')\n     sage: T.light((0,5,7), 1.0, (1,1,1))\n     sage: T.texture('t1', opacity=1, specular=.3)\n     sage: T.texture('t2', opacity=1, specular=.3, color=(0,0,1))\n@@ -186,7 +186,7 @@ class Tachyon(WithEqualityById, SageObject):\n       or ``'fisheye'``.\n     - ``frustum`` - (default ''), otherwise list of four numbers. Only\n       used with projection='fisheye'.\n-    - ``focallength`` - (default ''), otherwise a number. Only used\n+    - ``FOCALDIST`` - (default ''), otherwise a number. Only used\n       with projection='perspective_dof'.\n     - ``aperture`` - (default ''), otherwise a number.  Only used\n       with projection='perspective_dof'.\n@@ -331,7 +331,7 @@ class Tachyon(WithEqualityById, SageObject):\n     Use of the ``projection='perspective_dof'`` option.  This may not be\n     implemented correctly. ::\n \n-        sage: T = Tachyon(xres=800,antialiasing=4, raydepth=10, projection='perspective_dof', focallength='1.0', aperture='.0025')\n+        sage: T = Tachyon(xres=800,antialiasing=4, raydepth=10, projection='perspective_dof', FOCALDIST='1.0', aperture='.0025')\n         sage: T.light((0,5,7), 1.0, (1,1,1))\n         sage: T.texture('t1', opacity=1, specular=.3)\n         sage: T.texture('t2', opacity=1, specular=.3, color=(0,0,1))\n@@ -365,7 +365,7 @@ class Tachyon(WithEqualityById, SageObject):\n                  look_at=[0, 0, 0],\n                  viewdir=None,\n                  projection='PERSPECTIVE',\n-                 focallength='',\n+                 FOCALDIST='',\n                  aperture='',\n                  frustum=''):\n         r\"\"\"\n@@ -391,7 +391,7 @@ class Tachyon(WithEqualityById, SageObject):\n             self._camera_position = (-3, 0, 0) # default value\n         self._updir = updir\n         self._projection = projection\n-        self._focallength = focallength\n+        self._FOCALDIST = FOCALDIST\n         self._aperture = aperture\n         self._frustum = frustum\n         self._objects = []\n@@ -624,9 +624,9 @@ class Tachyon(WithEqualityById, SageObject):\n         camera_out = r\"\"\"\n            camera\n               projection %s\"\"\" % (tostr(self._projection))\n-        if self._focallength != '':\n+        if self._FOCALDIST != '':\n             camera_out = camera_out + r\"\"\"\n-              focallength %s\"\"\" % (float(self._focallength))\n+              FOCALDIST %s\"\"\" % (float(self._FOCALDIST))\n         if self._aperture != '':\n             camera_out = camera_out + r\"\"\"\n               aperture %s\"\"\" % (float(self._aperture))\n```\n\n\nNot sure how to best handle this and older versions of `tachyon` at the same time.",
    "created_at": "2022-03-07T10:10:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23475#issuecomment-329003",
    "user": "dimpase"
}
```

Now it builds (at least on Linux). For tests, there was an option renaming `focallength->FOCALDIST`.
The following patch makes all tests pass:

```diff
--- a/src/sage/interfaces/tachyon.py
+++ b/src/sage/interfaces/tachyon.py
@@ -261,13 +261,13 @@ written in the sequence they are listed in the examples in this section.
   The {\bf PROJECTION} keyword must be followed by one of the supported
 camera projection mode identifiers {\bf PERSPECTIVE}, {\bf PERSPECTIVE_DOF},
 {\bf ORTHOGRAPHIC}, or {\bf FISHEYE}.  The {\bf FISHEYE} projection mode
-requires two extra parameters {\bf FOCALLENGTH} and {\bf APERTURE}
+requires two extra parameters {\bf FOCALDIST} and {\bf APERTURE}
 which precede the regular camera options.
 
 \begin{verbatim}
 Camera
   projection perspective_dof
-  focallength 0.75
+  FOCALDIST 0.75
   aperture 0.02
   Zoom 0.666667
   Aspectratio 1.000000
diff --git a/src/sage/plot/plot3d/tachyon.py b/src/sage/plot/plot3d/tachyon.py
index 08caf38d67..41b646a80f 100644
--- a/src/sage/plot/plot3d/tachyon.py
+++ b/src/sage/plot/plot3d/tachyon.py
@@ -92,7 +92,7 @@ angle, right angle)::
 Finally there is the ``projection='perspective_dof'`` option. ::
 
     sage: T = Tachyon(xres=800, antialiasing=4, raydepth=10,
-    ....: projection='perspective_dof', focallength='1.0', aperture='.0025')
+    ....: projection='perspective_dof', FOCALDIST='1.0', aperture='.0025')
     sage: T.light((0,5,7), 1.0, (1,1,1))
     sage: T.texture('t1', opacity=1, specular=.3)
     sage: T.texture('t2', opacity=1, specular=.3, color=(0,0,1))
@@ -186,7 +186,7 @@ class Tachyon(WithEqualityById, SageObject):
       or ``'fisheye'``.
     - ``frustum`` - (default ''), otherwise list of four numbers. Only
       used with projection='fisheye'.
-    - ``focallength`` - (default ''), otherwise a number. Only used
+    - ``FOCALDIST`` - (default ''), otherwise a number. Only used
       with projection='perspective_dof'.
     - ``aperture`` - (default ''), otherwise a number.  Only used
       with projection='perspective_dof'.
@@ -331,7 +331,7 @@ class Tachyon(WithEqualityById, SageObject):
     Use of the ``projection='perspective_dof'`` option.  This may not be
     implemented correctly. ::
 
-        sage: T = Tachyon(xres=800,antialiasing=4, raydepth=10, projection='perspective_dof', focallength='1.0', aperture='.0025')
+        sage: T = Tachyon(xres=800,antialiasing=4, raydepth=10, projection='perspective_dof', FOCALDIST='1.0', aperture='.0025')
         sage: T.light((0,5,7), 1.0, (1,1,1))
         sage: T.texture('t1', opacity=1, specular=.3)
         sage: T.texture('t2', opacity=1, specular=.3, color=(0,0,1))
@@ -365,7 +365,7 @@ class Tachyon(WithEqualityById, SageObject):
                  look_at=[0, 0, 0],
                  viewdir=None,
                  projection='PERSPECTIVE',
-                 focallength='',
+                 FOCALDIST='',
                  aperture='',
                  frustum=''):
         r"""
@@ -391,7 +391,7 @@ class Tachyon(WithEqualityById, SageObject):
             self._camera_position = (-3, 0, 0) # default value
         self._updir = updir
         self._projection = projection
-        self._focallength = focallength
+        self._FOCALDIST = FOCALDIST
         self._aperture = aperture
         self._frustum = frustum
         self._objects = []
@@ -624,9 +624,9 @@ class Tachyon(WithEqualityById, SageObject):
         camera_out = r"""
            camera
               projection %s""" % (tostr(self._projection))
-        if self._focallength != '':
+        if self._FOCALDIST != '':
             camera_out = camera_out + r"""
-              focallength %s""" % (float(self._focallength))
+              FOCALDIST %s""" % (float(self._FOCALDIST))
         if self._aperture != '':
             camera_out = camera_out + r"""
               aperture %s""" % (float(self._aperture))
```


Not sure how to best handle this and older versions of `tachyon` at the same time.



---

archive/issue_comments_329004.json:
```json
{
    "body": "Probably the latter could be accomplished by using a decorator.",
    "created_at": "2022-03-15T10:45:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23475#issuecomment-329004",
    "user": "dimpase"
}
```

Probably the latter could be accomplished by using a decorator.



---

archive/issue_comments_329005.json:
```json
{
    "body": "opensuse-tumbleweed now has a new tachyon, causes failures https://github.com/sagemath/sage/runs/6236170449",
    "created_at": "2022-05-01T19:00:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23475#issuecomment-329005",
    "user": "mkoeppe"
}
```

opensuse-tumbleweed now has a new tachyon, causes failures https://github.com/sagemath/sage/runs/6236170449



---

archive/issue_comments_329006.json:
```json
{
    "body": "and 0.99.5 is out",
    "created_at": "2022-05-01T19:12:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23475#issuecomment-329006",
    "user": "mkoeppe"
}
```

and 0.99.5 is out



---

archive/issue_comments_329007.json:
```json
{
    "body": "The following makes all tests pass with new versions of tachyon, without breaking old versions. I tested it with 0.99 (old) and 0.99.5 (new).\n\nThis does not change the sage interface in `sage.plot.plot3d.tachyon`, it will still use `focallength` so the change is very safe to apply. In the future (possibly when tachyon in sage gets upgraded), all the `focallength` occurences in `sage.plot.plot3d.tachyon` can be replaced by `focaldist` for consistency with new tachyon, and the logic here can be reversed (i.e. patch the model when `self.version() < '0.99.2'`).\n\n\n\n\n\n```\n #!diff\n--- a/src/sage/interfaces/tachyon.py\n+++ b/src/sage/interfaces/tachyon.py\n@@ -683,12 +683,14 @@\n #*****************************************************************************\n \n import os\n+import re\n \n from sage.cpython.string import bytes_to_str\n from sage.misc.pager import pager\n from sage.misc.superseded import deprecation\n from sage.misc.temporary_file import tmp_filename\n from sage.structure.sage_object import SageObject\n+from sage.misc.cachefunc import cached_method\n \n \n class TachyonRT(SageObject):\n@@ -799,6 +801,11 @@ class TachyonRT(SageObject):\n             Parser failed due to an input file syntax error.\n             Aborting render.\n         \"\"\"\n+        if self.version() >= '0.99.2':\n+            # this keyword was changed in 0.99.2\n+            model = model.replace(\n+                    \"              focallength \",\n+                    \"              focaldist \")\n         modelfile = tmp_filename(ext='.dat')\n         with open(modelfile, 'w') as file:\n             file.write(model)\n@@ -851,6 +858,22 @@ class TachyonRT(SageObject):\n         else:\n             print(r)\n \n+    @cached_method\n+    def version(self):\n+        \"\"\"\n+        Returns the version of the Tachyon raytracer being used.\n+\n+        TESTS::\n+\n+            sage: tachyon_rt.version()  # not tested\n+            0.98.9\n+            sage: tachyon_rt.version() >= '0.98.9'\n+            True\n+        \"\"\"\n+        with os.popen('tachyon') as f:\n+            r = f.read()\n+        return re.search(r\"Version ([\\d.]*)\", r)[1]\n+\n     def help(self, use_pager=True):\n         \"\"\"\n         Deprecated: type 'sage.interfaces.tachyon?' for help\n```\n\n\n\nBTW, in order for tachyon spkg to work in aarch64, all I had to do is the following trivial change:\n\n```\n #!diff\n--- a/build/pkgs/tachyon/spkg-install.in\n+++ b/build/pkgs/tachyon/spkg-install.in\n@@ -30,7 +30,7 @@\n     ppc*|powerpc*)\n         TARGET=linux-ppc\n         ;;\n-    armv6l*|armv7l*)\n+    armv6l*|armv7l*|aarch64*)\n         TARGET=linux-arm-thr\n         ;;\n     esac\n```\n",
    "created_at": "2022-12-21T03:05:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23475#issuecomment-329007",
    "user": "tornaria"
}
```

The following makes all tests pass with new versions of tachyon, without breaking old versions. I tested it with 0.99 (old) and 0.99.5 (new).

This does not change the sage interface in `sage.plot.plot3d.tachyon`, it will still use `focallength` so the change is very safe to apply. In the future (possibly when tachyon in sage gets upgraded), all the `focallength` occurences in `sage.plot.plot3d.tachyon` can be replaced by `focaldist` for consistency with new tachyon, and the logic here can be reversed (i.e. patch the model when `self.version() < '0.99.2'`).





```
 #!diff
--- a/src/sage/interfaces/tachyon.py
+++ b/src/sage/interfaces/tachyon.py
@@ -683,12 +683,14 @@
 #*****************************************************************************
 
 import os
+import re
 
 from sage.cpython.string import bytes_to_str
 from sage.misc.pager import pager
 from sage.misc.superseded import deprecation
 from sage.misc.temporary_file import tmp_filename
 from sage.structure.sage_object import SageObject
+from sage.misc.cachefunc import cached_method
 
 
 class TachyonRT(SageObject):
@@ -799,6 +801,11 @@ class TachyonRT(SageObject):
             Parser failed due to an input file syntax error.
             Aborting render.
         """
+        if self.version() >= '0.99.2':
+            # this keyword was changed in 0.99.2
+            model = model.replace(
+                    "              focallength ",
+                    "              focaldist ")
         modelfile = tmp_filename(ext='.dat')
         with open(modelfile, 'w') as file:
             file.write(model)
@@ -851,6 +858,22 @@ class TachyonRT(SageObject):
         else:
             print(r)
 
+    @cached_method
+    def version(self):
+        """
+        Returns the version of the Tachyon raytracer being used.
+
+        TESTS::
+
+            sage: tachyon_rt.version()  # not tested
+            0.98.9
+            sage: tachyon_rt.version() >= '0.98.9'
+            True
+        """
+        with os.popen('tachyon') as f:
+            r = f.read()
+        return re.search(r"Version ([\d.]*)", r)[1]
+
     def help(self, use_pager=True):
         """
         Deprecated: type 'sage.interfaces.tachyon?' for help
```



BTW, in order for tachyon spkg to work in aarch64, all I had to do is the following trivial change:

```
 #!diff
--- a/build/pkgs/tachyon/spkg-install.in
+++ b/build/pkgs/tachyon/spkg-install.in
@@ -30,7 +30,7 @@
     ppc*|powerpc*)
         TARGET=linux-ppc
         ;;
-    armv6l*|armv7l*)
+    armv6l*|armv7l*|aarch64*)
         TARGET=linux-arm-thr
         ;;
     esac
```




---

archive/issue_comments_329008.json:
```json
{
    "body": "afk, please post your branch here",
    "created_at": "2022-12-21T08:22:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23475#issuecomment-329008",
    "user": "dimpase"
}
```

afk, please post your branch here



---

archive/issue_comments_329009.json:
```json
{
    "body": "See `u/tornaria/tachyon`. I'm not sure if I should overwrite the current branch, or move this to a separate ticket.\n\nMy branch is \"safe\" in the sense that it doesn't touch the spkg (other than allowing building on linux aarch64 but that is broken now and the trivial change doesn't affect other architectures) but it will allow sagemath to work ok with newer versions of tachyon in the system.\n\nI'd rather see those two commits on 9.8 if upgrading tachyon spkg needs more testing, since I will be upgrading tachyon on void linux soon.",
    "created_at": "2022-12-21T22:56:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23475#issuecomment-329009",
    "user": "tornaria"
}
```

See `u/tornaria/tachyon`. I'm not sure if I should overwrite the current branch, or move this to a separate ticket.

My branch is "safe" in the sense that it doesn't touch the spkg (other than allowing building on linux aarch64 but that is broken now and the trivial change doesn't affect other architectures) but it will allow sagemath to work ok with newer versions of tachyon in the system.

I'd rather see those two commits on 9.8 if upgrading tachyon spkg needs more testing, since I will be upgrading tachyon on void linux soon.



---

archive/issue_comments_329010.json:
```json
{
    "body": "changing Branch field here does not overwrite anything - the old branch stays good and well. (you need to use git to overwrite a branch)",
    "created_at": "2022-12-22T08:45:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23475#issuecomment-329010",
    "user": "dimpase"
}
```

changing Branch field here does not overwrite anything - the old branch stays good and well. (you need to use git to overwrite a branch)



---

archive/issue_comments_329011.json:
```json
{
    "body": "New commits:",
    "created_at": "2022-12-22T08:49:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23475#issuecomment-329011",
    "user": "dimpase"
}
```

New commits:



---

archive/issue_comments_329012.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-12-22T08:49:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23475#issuecomment-329012",
    "user": "dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_329013.json:
```json
{
    "body": "added checksums etc (for 0.99.5)",
    "created_at": "2022-12-22T22:44:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23475#issuecomment-329013",
    "user": "dimpase"
}
```

added checksums etc (for 0.99.5)



---

archive/issue_comments_329014.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-12-22T23:00:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23475#issuecomment-329014",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_329015.json:
```json
{
    "body": "doesn't work with 0.99.5: typical error is\n\n```\nsage -t --warn-long 60.9 --random-seed=298292522010650641629269891184485194160 src/sage/plot/plot3d/implicit_plot3d.py\n**********************************************************************\nFile \"src/sage/plot/plot3d/implicit_plot3d.py\", line 53, in sage.plot.plot3d.implicit_plot3d.implicit_plot3d\nFailed example:\n    implicit_plot3d((x^2 + y^2 + z^2), (x,-2,2), (y,-2,2), (z,-2,2), plot_points=60, contour=[1,3,5],\n                    region=lambda x,y,z: x<=0.2 or y>=0.2 or z<=0.2, color='aquamarine').show(viewer='tachyon')\nException raised:\n    Traceback (most recent call last):\n      File \"/mnt/opt/Sage/sage-dev/src/sage/doctest/forker.py\", line 695, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/mnt/opt/Sage/sage-dev/src/sage/doctest/forker.py\", line 1093, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.plot.plot3d.implicit_plot3d.implicit_plot3d[2]>\", line 1, in <module>\n        implicit_plot3d((x**Integer(2) + y**Integer(2) + z**Integer(2)), (x,-Integer(2),Integer(2)), (y,-Integer(2),Integer(2)), (z,-Integer(2),Integer(2)), plot_points=Integer(60), contour=[Integer(1),Integer(3),Integer(5)],\n      File \"sage/plot/plot3d/base.pyx\", line 1800, in sage.plot.plot3d.base.Graphics3d.show\n        dm.display_immediately(self, **kwds)\n      File \"/mnt/opt/Sage/sage-dev/src/sage/repl/rich_output/display_manager.py\", line 854, in display_immediately\n        self._backend.display_immediately(plain_text, rich_output)\n      File \"/mnt/opt/Sage/sage-dev/src/sage/repl/rich_output/backend_doctest.py\", line 210, in display_immediately\n        self.validate(rich_output)\n      File \"/mnt/opt/Sage/sage-dev/src/sage/repl/rich_output/backend_doctest.py\", line 271, in validate\n        assert rich_output.png.get().startswith(b'\\x89PNG')\n    AssertionError\n```\n",
    "created_at": "2022-12-23T11:45:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23475#issuecomment-329015",
    "user": "dimpase"
}
```

doesn't work with 0.99.5: typical error is

```
sage -t --warn-long 60.9 --random-seed=298292522010650641629269891184485194160 src/sage/plot/plot3d/implicit_plot3d.py
**********************************************************************
File "src/sage/plot/plot3d/implicit_plot3d.py", line 53, in sage.plot.plot3d.implicit_plot3d.implicit_plot3d
Failed example:
    implicit_plot3d((x^2 + y^2 + z^2), (x,-2,2), (y,-2,2), (z,-2,2), plot_points=60, contour=[1,3,5],
                    region=lambda x,y,z: x<=0.2 or y>=0.2 or z<=0.2, color='aquamarine').show(viewer='tachyon')
Exception raised:
    Traceback (most recent call last):
      File "/mnt/opt/Sage/sage-dev/src/sage/doctest/forker.py", line 695, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/mnt/opt/Sage/sage-dev/src/sage/doctest/forker.py", line 1093, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.plot.plot3d.implicit_plot3d.implicit_plot3d[2]>", line 1, in <module>
        implicit_plot3d((x**Integer(2) + y**Integer(2) + z**Integer(2)), (x,-Integer(2),Integer(2)), (y,-Integer(2),Integer(2)), (z,-Integer(2),Integer(2)), plot_points=Integer(60), contour=[Integer(1),Integer(3),Integer(5)],
      File "sage/plot/plot3d/base.pyx", line 1800, in sage.plot.plot3d.base.Graphics3d.show
        dm.display_immediately(self, **kwds)
      File "/mnt/opt/Sage/sage-dev/src/sage/repl/rich_output/display_manager.py", line 854, in display_immediately
        self._backend.display_immediately(plain_text, rich_output)
      File "/mnt/opt/Sage/sage-dev/src/sage/repl/rich_output/backend_doctest.py", line 210, in display_immediately
        self.validate(rich_output)
      File "/mnt/opt/Sage/sage-dev/src/sage/repl/rich_output/backend_doctest.py", line 271, in validate
        assert rich_output.png.get().startswith(b'\x89PNG')
    AssertionError
```




---

archive/issue_comments_329016.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-12-23T12:06:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23475#issuecomment-329016",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_329017.json:
```json
{
    "body": "png patch was missing from Gonzalo's branch; we now add it, and it fixed comment:36",
    "created_at": "2022-12-23T12:07:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23475#issuecomment-329017",
    "user": "dimpase"
}
```

png patch was missing from Gonzalo's branch; we now add it, and it fixed comment:36
