# Issue 33402: Replace sage.graphs.graph_editor with a call to phitigra

Issue created by migration from https://trac.sagemath.org/ticket/33639

Original creator: mkoeppe

Original creation time: 2022-04-03 18:42:46

CC:  kcrisman chapoton dcoudert dimpase @jfraymond novoselt

phitigra was added as an optional package in #30540.


---

Comment by @jfraymond created at 2022-04-12 06:23:45

New commits:


---

Comment by dcoudert created at 2022-04-12 09:03:09

Could you add in the ticket description what should be done to launch the editor.
I tried in a Jupiter notebook and only got:

```
graph_editor()
<phitigra.graph_editor.GraphEditor object at 0x1755ab820>
```



---

Comment by @jfraymond created at 2022-04-12 11:35:52

Yes, I just added it in the description.

It is slightly different than the previous editor: here we define an editor object, that we have to display (with `.show()`) in order to draw the graph with the mouse. The drawn graph can then be retrieved with the `.get_graph()` method of the editor object.

The call to `graph_editor` could directly show the widget, but then I don't know how we would retrieve the drawn graph.

By the way, I am not done with the changes yet, I only pushed the commit so that  I can work on this from a different computer.


---

Comment by kcrisman created at 2022-04-12 12:00:45

Thanks for working on this!  The old graph editor was really a fantastic resource we loved to show off, and a good replacement  would have been useful even last week for me to advertise.

If there is the possibility of demonstrating/documenting a few (even if not possible to be tested) examples in your coming updates, that would also be great.  It is likely that this would be used by people 

Also, if we could see whether this works properly in the Sage cell server before it's released in a final version (beta is fine), that would be good, so I'm cc:ing Andrey N.


---

Comment by @jfraymond created at 2022-04-12 12:10:19

Replying to [comment:6 kcrisman]:
> Thanks for working on this!  The old graph editor was really a fantastic resource we loved to show off, and a good replacement  would have been useful even last week for me to advertise.
> 
> If there is the possibility of demonstrating/documenting a few (even if not possible to be tested) examples in your coming updates, that would also be great.  It is likely that this would be used by people 
> 
> Also, if we could see whether this works properly in the Sage cell server before it's released in a final version (beta is fine), that would be good, so I'm cc:ing Andrey N.

Hi,

The repository of the editor widget ( https://github.com/jfraymond/phitigra ) has a demo notebook (`demo.ipynb`) where some of the examples of use are shown.

Currently it is already possible to try the demo notebook after installing the editor package with `sage -pip`.

During a short period of time it was possible to run it on mybinder https://mybinder.org/v2/gh/jfraymond/phitigra/master?filepath=demo.ipynb but for some reason (on the mybinder side?) it stopped working.


---

Comment by dcoudert created at 2022-04-12 14:15:41

I tried on macOS 12.2.1 and it works well. It just needs some documentation.


---

Comment by mkoeppe created at 2022-04-13 01:58:07


```
+    try:
+        from phitigra import GraphEditor
+    except ModuleNotFoundError:
+        raise ModuleNotFoundError("The graph editor is provided by the optional package phitigra, which currently not installed.")
```

It's best to replace this with a "lazy_import with feature", similar to 
https://github.com/sagemath/sage/blob/develop/src/sage/sat/solvers/picosat.py#L23


---

Comment by git created at 2022-04-20 07:45:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-04-20 09:53:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @jfraymond created at 2022-04-20 10:00:08

There are now some live examples of the widget using the recently introduced ".. JUPYTER-EXECUTE::" sphinx directive (this is the reason why I merged the develop branch). I was not able to completely test them, presumably because the version of sage running them (online?) does not include the current ticket yet. If this is a problem I can revert to a previous commit and add the examples in an other ticket.


---

Comment by @jfraymond created at 2022-04-20 10:00:08

Changing status from new to needs_review.


---

Comment by dcoudert created at 2022-04-20 14:08:56

What's the expected behavior of the live examples if phitigra is not installed ?


---

Comment by @jfraymond created at 2022-04-20 16:08:19

That's a good question. I just tested and the documentation does not build in this case :(.

If I guessed correctly from what I experienced in this first encounter with sphinx-jupyter
* there is a non-interactive "preview" of the jupyter part generated when building the doc (this clearly requires the package to exist on the computer building the doc)
* then one can click on the "Make live" button and run the code of the cell on some server somewhere in the cloud (for this to work this server as well should have the package)

As it is an optional package I guess the correct choice here is to remove these live examples, right ?
By the way, how should I proceed with the doctests (that also require the package to be installed)? Is there a way to tell sage to skip the tests in a file if the package is not present, of is it better to mark all the examples and tests with `# not tested`? (Tests are being made in the package anyway).


---

Comment by dcoudert created at 2022-04-20 16:42:30

You can try `# optional - phitigra`, but since the introduction of `Feature` other solutions might be better.

Matthias will certainly clarify this.


---

Comment by mkoeppe created at 2022-04-20 20:07:38

`# optional - phitigra` is the correct solution, but to make it work, you will have to add a module `sage.features.phitigra`. You can adapt it from `sage.features.igraph`.


---

Comment by mkoeppe created at 2022-04-20 20:09:13

... or adapt it from `sage.features.sphinx`, which is a tiny bit simpler.


---

Comment by klee created at 2022-04-22 06:01:40

This is a nice addition to sage. Thanks for working on this.

A few comments:

1. The ticket #33320 would make all code blocks in sage docoumentation runnable. This will in effect deprecate using `.. JUPYTER-EXECUTE::` directly. The ticket needs review too.

2. Please respect the developer's guide: https://doc.sagemath.org/html/en/developer/coding_basics.html#headings-of-sage-library-code-files. The file `graph_editor.py` is old, and does not follow the guidelines.


---

Comment by klee created at 2022-04-22 06:26:18

Replying to [comment:18 klee]:
> 1. The ticket #33320 would make all code blocks in sage docoumentation runnable. This will in effect deprecate using `.. JUPYTER-EXECUTE::` directly. The ticket needs review too.

To be clear, there is no problem in your using `.. JUPYTER-EXECUTE::` in this ticket.


---

Comment by @jfraymond created at 2022-04-22 06:39:13

Thank you all for the advice!

Replying to [comment:18 klee]:
> 1. The ticket #33320 would make all code blocks in sage docoumentation runnable. This will in effect deprecate using `.. JUPYTER-EXECUTE::` directly. The ticket needs review too.

Is there a way (maybe with #33320?) to tell sphinx that the **live** code blocks depend on an optional package and should be ignored if the package is not installed (like the `# optional - <package_name>` tag for doctests)?
It seems that currently, what is in a `.. JUPYTER-EXECUTE` block gets ran anyway (even with the `# optional - <package_name>` tag) which results in an error if the package is not installed. (I read about the `.. ifconfig::` directive in sphinx's doc to conditionally include some sections but it seems that it comes as an extention that is not in our sphinx install.)


---

Comment by @jfraymond created at 2022-04-22 06:39:13

Changing status from needs_review to needs_work.


---

Comment by klee created at 2022-04-22 07:08:05

Replying to [comment:20 gh-jfraymond]:
> Thank you all for the advice!
> 
> Replying to [comment:18 klee]:
> > 1. The ticket #33320 would make all code blocks in sage docoumentation runnable. This will in effect deprecate using `.. JUPYTER-EXECUTE::` directly. The ticket needs review too.
> 
> Is there a way (maybe with #33320?) to tell sphinx that the **live** code blocks depend on an optional package and should be ignored if the package is not installed (like the `# optional - <package_name>` tag for doctests)?
> It seems that currently, what is in a `.. JUPYTER-EXECUTE` block gets ran anyway (even with the `# optional - <package_name>` tag) which results in an error if the package is not installed. (I read about the `.. ifconfig::` directive in sphinx's doc to conditionally include some sections but it seems that it comes as an extension that is not in our sphinx install.)

You mean the error in building the reference manual. Right. Currently there is no way to avoid that. As you observed, the vanilla jupyter-sphinx run the code block in the build time, needlessly for us.

With #33320, the patched jupyter-sphinx do no run code blocks in the build time. So there should be no problem. But unfortunately as I just checked, because of a bug in #33320, this ticket merged with #33320 still fails. I would work on this.


---

Comment by klee created at 2022-04-22 07:10:25

Replying to [comment:21 klee]:
> With #33320, the patched jupyter-sphinx do no run code blocks in the build time. So there should be no problem. But unfortunately as I just checked, because of a bug in #33320, this ticket merged with #33320 still fails. I would work on this. 

If you remove the `.. JUPYTER-EXECUTE::` block and build the live doc, there would be no problem.


---

Comment by git created at 2022-04-22 11:47:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @jfraymond created at 2022-04-22 11:53:56

So in the end I removed all examples of live code (with `JUPYTER_EXECUTE`) because otherwise the doc would not build on systems without the package. If at some point (after #33320 is completed?) it becomes possible to have these live examples, I can add them back (in a different ticket).  


On my computer the tests succeed and the doc builds (for this file) regardless of whether phitigra is installed or not.


---

Comment by @jfraymond created at 2022-04-22 11:53:56

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-04-22 19:38:26


```
+from sage.features import PythonModule
+lazy_import('phitigra', 'GraphEditor',
+            feature=PythonModule('phitigra', spkg='phitigra'))
```

Now that `sage.features.phitigra.Phitigra` exists, it is best to use it here


---

Comment by git created at 2022-04-23 07:45:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @jfraymond created at 2022-04-23 07:46:49

I just replaced like that:

```diff
-from sage.features import PythonModule
-lazy_import('phitigra', 'GraphEditor',
-            feature=PythonModule('phitigra', spkg='phitigra'))
+from sage.features.phitigra import Phitigra
+lazy_import('phitigra', 'GraphEditor', feature=Phitigra())
```



---

Comment by mkoeppe created at 2022-04-23 17:37:57

Thanks, the use of `Feature`s looks good now.


---

Comment by klee created at 2022-04-24 09:03:26

New commits:


---

Comment by klee created at 2022-04-24 09:05:01

I did some edits. If you are okay with those, then you can give positive review.


---

Comment by @jfraymond created at 2022-04-24 10:54:26

Changing status from needs_review to positive_review.


---

Comment by @jfraymond created at 2022-04-24 10:54:26

Thanks!


---

Comment by mkoeppe created at 2022-05-07 18:35:50

Changing priority from major to blocker.


---

Comment by git created at 2022-05-08 07:32:38

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2022-05-08 07:32:38

Changing status from positive_review to needs_review.


---

Comment by chapoton created at 2022-05-08 07:36:47

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2022-05-08 07:36:47

this was not necessary ; patchbot is dumb and only giving advice

suggestion : never ever do something on a positive reviewed ticket, unless it is critical


---

Comment by @jfraymond created at 2022-05-08 07:39:34

OK, thanks for the advice and sorry for the useless commit then.
I though this was what was preventing the ticket to be closed.
And indeed the patchbot can be dumb, here I think it was the word "sagenb" **in a comment** that was causing the problem.


---

Comment by chapoton created at 2022-05-08 07:48:06

Bah, ça prend toujours une plombe pour qu'un ticket soit intégré dans sage. Et encore plus longtemps quand on est dans une période juste avant une nouvelle version. La 9.6 ne va pas tarder.


---

Comment by vbraun created at 2022-05-12 21:42:23

Resolution: fixed
