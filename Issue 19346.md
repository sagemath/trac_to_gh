# Issue 19346: random triangulation as simplicial complex

Issue created by migration from Trac.

Original creator: chapoton

Original creation time: 2015-11-13 14:39:45

CC:  ncohen

Keywords: random simplicial complex

After #19520, let us now create the same random triangulations of the sphere of dimensions 2 as simplicial complexes. This will allow to take their flip graph.


---

Comment by chapoton created at 2015-11-13 14:40:29

New commits:


---

Comment by ncohen created at 2015-11-13 14:52:06

Err... Are you building the graph of [maximal cliques/faces] of the random triangulation? The code is awfully similar to what appeared in #19520.

Nathann


---

Comment by chapoton created at 2015-11-13 16:56:05

No, no, because the random triangulation, as a graph, has many more triangles and has even larger cliques. Some information is lost there, which is exactly the data of the triangles which are really triangles.


---

Comment by git created at 2015-11-14 09:11:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-11-14 09:33:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2015-11-14 09:36:49

Do you think that it could be complicated to modify `RandomTriangulation` to build a combinatorial embedding while the graph is being built? This way we could get the data that you want with a call to `.faces()`.
----
New commits:


---

Comment by git created at 2015-11-14 09:37:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2015-11-14 09:38:23

(or, alternatively, could a call to `.is_planar(set_embedding=True)/.faces()` do the trick? Or is that too slow?)

Nathann


---

Comment by chapoton created at 2015-11-14 09:43:15

* modifying the code in #19520 to manage the embedding seems difficult (by the lack of a proper class for planar graphs, as I have said before). I would love to, and maybe will need too, but this will be hard.

* the 'is_planar' is much too slow, and is in fact re-building by brute force the embedding we should already know.

* one option would be to drop the code in #19520 and get the edge graph from the code here. I would prefer not to. This is just a little code duplication, do you really mind ?

* I still have other projects in the same vein..


---

Comment by ncohen created at 2015-11-14 09:47:18

> * modifying the code in #19520 to manage the embedding seems difficult (by the lack of a proper class for planar graphs, as I have said before). I would love to, and maybe will need too, but this will be hard.

You can easily manage embeddings right now, with get/set_embedding. All you need to know is the order of the neighbours of every vertex 'v'. Don't we have this information when building the graph? 

> * the 'is_planar' is much too slow, and is in fact re-building by brute force the embedding we should already know.

Okay.

> * one option would be to drop the code in #19520 and get the edge graph from the code here. I would prefer no too. This is just a little code duplication, do you really mind ?

I don't mind if there is no way around it, and if there is an easy way out I prefer it.

> * I still have other projects in the same vein..

Do you plan a third copy/paste because of some information that you cannot find from the function you implement here? `:-P`

Nathann


---

Comment by git created at 2015-11-30 19:09:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-12-01 08:07:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2015-12-01 08:34:34

Changing status from new to needs_review.


---

Comment by ncohen created at 2015-12-01 08:36:08

If you want a review from me you will have to answer [comment:10] first.


---

Comment by chapoton created at 2015-12-03 00:01:33

Replying to [comment:10 ncohen]:
> > * modifying the code in #19520 to manage the embedding seems difficult (by the lack of a proper class for planar graphs, as I have said before). I would love to, and maybe will need too, but this will be hard.
> 
> You can easily manage embeddings right now, with get/set_embedding. All you need to know is the order of the neighbours of every vertex 'v'. Don't we have this information when building the graph? 

I think it would not be easy to manage the embedding in the rotate-and-close algo. Every single edge addition would have to do a lot of job to do to change the embedding.

> > * one option would be to drop the code in #19520 and get the edge graph from the code here. I would prefer no too. This is just a little code duplication, do you really mind ?
> 
> I don't mind if there is no way around it, and if there is an easy way out I prefer it.

ok. If you insist on no-code-duplication, as I said, one can get the graph from the simplicial complex, maybe at the prize of some (big?) speed loss.

> > * I still have other projects in the same vein..
> 
> Do you plan a third copy/paste because of some information that you cannot find from the function you implement here? `:-P`

Could well be. My aim is to build a random interval in the Tamari lattices. For this I have to
obtain a random minimal Schnyder wood. For the moment, this is only a project, so I cannot
say right now how much code I will re-use.


---

Comment by ncohen created at 2015-12-03 09:05:23

Hello,

> I think it would not be easy to manage the embedding in the rotate-and-close algo. Every single edge addition would have to do a lot of job to do to change the embedding.

In Sage, the embedding is represented by a list associated to each vertex. Given the picture  have in mind of the algorithm (though perhaps it is wrong) the algorithm starts from a tree and keeps adding edges, each of which is, when it is added, on the outer face.

I wonder if when adding edge uv, it does not boil down to adding v at the end of u's list, and adding u at the beginning of v's list.

And something slightly more specific for a and b.

> ok. If you insist on no-code-duplication, as I said, one can get the graph from the simplicial complex, maybe at the prize of some (big?) speed loss.

A big speed loss is a good justification for code duplication.

Nathann


---

Comment by git created at 2016-01-24 10:45:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-01-27 16:42:47

Some timings

```
sage: %timeit simplicial_complexes.RandomTwoSphere(1000).graph()
1 loops, best of 3: 769 ms per loop
sage: %timeit graphs.RandomTriangulation(1000)
1 loops, best of 3: 189 ms per loop
```

So at least it is not a good idea to use the simplicial complex to generate the graph.


---

Comment by tscrim created at 2016-01-27 22:54:24

My 2 cents, I would pull out the common code into separate helper functions (and in particular, the internal helper `rotate_word_to_next_occurrence()`).


---

Comment by git created at 2016-01-28 08:38:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2016-01-28 08:41:30

You realize that the code is longer after your 'refactoring' than before, and that the code of both functions is still almost the same?

Nathann


---

Comment by ncohen created at 2016-01-28 08:42:36

I understand that you want this reviewed, but implementing "whatever a reviewer asks for as long as it is easy" in the hope that he will click on `positive_review` is not a responsible behaviour.

Nathann


---

Comment by ncohen created at 2016-01-28 08:58:42

Changing status from needs_review to needs_work.


---

Comment by ncohen created at 2016-01-28 08:58:42

> Some timings
> {{{
> sage: %timeit simplicial_complexes.RandomTwoSphere(1000).graph()
> 1 loops, best of 3: 769 ms per loop
> sage: %timeit graphs.RandomTriangulation(1000)
> 1 loops, best of 3: 189 ms per loop
> }}}

Some timings:


```
sage: %timeit simplicial_complexes.RandomTwoSphere(1000)
1 loops, best of 3: 246 ms per loop
sage: %timeit graphs.RandomTriangulation(1000)
1 loops, best of 3: 222 ms per loop
```


That's what happens when you replace the last line of `RandomTwoSphere` this way:


```diff
-    return SimplicialComplex(triangles)
+    return triangles
```


Another timing:


```
sage: %timeit simplicial_complexes.RandomTwoSphere(1000)
1 loops, best of 3: 269 ms per loop
sage: %timeit graphs.RandomTriangulation(1000)
1 loops, best of 3: 219 ms per loop
```


That's what happens when you do the following replacement instead:


```
-    return SimplicialComplex(triangles)
+    return SimplicialComplex(triangles,maximality_check=False)
```



Once this (second) replacement is done, here is the effect on the `.graph` function:


```
sage: %timeit simplicial_complexes.RandomTwoSphere(1000).graph()
1 loops, best of 3: 345 ms per loop
sage: %timeit graphs.RandomTriangulation(1000)
1 loops, best of 3: 222 ms per loop
```


If that is still too much for your (I assume computer-intensive) needs, it seems that the .graph function is unnecessarily slow


```
sage: def simplex_to_graph(S):
    g = Graph()
    for S in S._facets:
        g.add_cycle(g)
    return g
sage: %timeit simplex_to_graph(simplicial_complexes.RandomTwoSphere(1000))
1 loops, best of 3: 288 ms per loop
sage: %timeit graphs.RandomTriangulation(1000)
1 loops, best of 3: 226 ms per loop
```


So please stop messing around by moving around blocks of 5 lines, and keep only one of these two functions (unless you still find the speed penalty too big).

Nathann


---

Comment by ncohen created at 2016-01-28 09:00:27

P.S.: I've never seen anything of that kind:


```
REFERENCES: [PS2006]_
```


As far as I know we only write a 'REFERENCES' block when we *define* a new reference.


---

Comment by ncohen created at 2016-01-28 09:02:11

P.S.: If you use the `SimplicialComplex` class often, you may want to 'simplify' the maximality check by checking first whether the facets all have the same size.

Nathann


---

Comment by chapoton created at 2016-01-28 09:18:39

Hello Nathann.

Thanks for your comments, and for your time.

Concerning the suggestion of Travis, I can of course revert this factorisation. But you may qualify this as "just doing everything that a potential reviewer asks for".

I was trying to think about adding the embedding information on the graph method, as you suggested before. I am not sure that this data is easily recoverable from the simplicial complex. So it seems to me that keeping both still has a value, if I manage to add the embedding.

1) the graph method would give an embedded (planar) graph. 

2) the simplicial complex method (besides giving an interesting object by itself) allows to compute easily the planar dual of this graph, which would give another class of nice random graphs.


---

Comment by ncohen created at 2016-01-28 09:25:05

Yo,

> Concerning the suggestion of Travis, I can of course revert this factorisation. But you may qualify this as "just doing everything that a potential reviewer asks for".

I don't have anything against people telling me why they think one of my suggestions is wrong. If you think useful to keep this independent function, I'm all ears.

> I was trying to think about adding the embedding information on the graph method, as you suggested before. I am not sure that this data is easily recoverable from the simplicial complex. So it seems to me that keeping both still has a value, if I manage to add the embedding.

If you manage to add the embedding to the `Graph` function, then it will be straightforward to build the `SimplicialComplex` from it. So again in this case, you can do without the `SimplicialComplex` constructor, which will merely list the faces of the `Graph` object (assuming that it contains the embedding).

I have nothing against that.

Nathann


---

Comment by git created at 2016-01-28 11:11:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-01-28 12:41:28

Some timings now that we have the embedding:

```
sage: %timeit SimplicialComplex([set(flatten(d)) for d in graphs.RandomTriangulation(100).faces()])
10 loops, best of 3: 82.6 ms per loop
sage: %timeit simplicial_complexes.RandomTwoSphere(100)
100 loops, best of 3: 5.26 ms per loop
```

so going through the graph to get the simplicial complex is not efficient..


---

Comment by ncohen created at 2016-01-28 13:02:21

> Some timings now that we have the embedding:
> {{{
> sage: %timeit SimplicialComplex([set(flatten(d)) for d in graphs.RandomTriangulation(100).faces()])
> 10 loops, best of 3: 82.6 ms per loop
> sage: %timeit simplicial_complexes.RandomTwoSphere(100)
> 100 loops, best of 3: 5.26 ms per loop
> }}}
> so going through the graph to get the simplicial complex is not efficient..

Some other timings:


```
def triangles(G):
    G = G.relabel(inplace=False)
    return [(u,v,w) for u,L in G._embedding.iteritems() 
            for v,w in zip(L,L[1:]+[L[0]]) if u<v and u<w]

sage: %timeit graphs.RandomTriangulation(1000)
1 loops, best of 3: 258 ms per loop
sage: %timeit SimplicialComplex(triangles(graphs.RandomTriangulation(1000)),maximality_check=False)
1 loops, best of 3: 304 ms per loop
sage: %timeit simplicial_complexes.RandomTwoSphere(1000)
1 loops, best of 3: 299 ms per loop
```


And a check:


```
sage: g=graphs.RandomTriangulation(1000)
sage: h=Graph()
sage: _=map(h.add_cycle,triangles(g))
sage: g == h
True
```


I have too much respect for you to think that you even gave it a decent try. You would have at least added `maximality_check=False`, as I made this remark this very morning.

Nathann


---

Comment by git created at 2016-01-28 13:40:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-01-28 13:42:21

Indeed, I was too quick. 

I agree to use the graph to generate the simplicial complex.

Maybe you can at last be happy with the state of affairs ?


---

Comment by ncohen created at 2016-01-28 13:44:10

Hello,

> I agree to use the graph to generate the simplicial complex.
> 
> Maybe you can at last be happy with the state of affairs ?

Thank you. I have absolutely nothing against the current design of functions. And I may take a look at `Graph.faces()`, just in case it may not be slow for triangulations only.

Nathann


---

Comment by git created at 2016-01-28 14:02:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-01-28 14:03:02

ok, let me put this back to needs_review, then.


---

Comment by chapoton created at 2016-01-28 14:03:02

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2016-01-28 16:10:17

Replying to [comment:23 ncohen]:
> You realize that the code is longer after your 'refactoring' than before, and that the code of both functions is still almost the same?

To be fair, what really made it longer is the docstrings and doctests, which is not a bad thing either. Also, it would have made it easier in terms of long-term maintenance (you only have to make changes in one place).

I've seen things like as in comment:26 (although not in so compact of state), and IMO that is a good way to add a reference that you don't specifically cite in the docstring.


---

Comment by ncohen created at 2016-01-29 10:34:48

Hello,

The branch looks good. I only wonder about that: why keep it?


```
+    # graph.relabel()   # does not act on the embedding !
```


If you expect `.relabel()` to apply to the embedding, then the right reaction is to write a bugfix, isn't it?

Could you also add a doctest like that?


```
sage: for i in range(10):
....:    g = graphs.RandomTriangulation(10)
....:    assert g.is_planar(on_embedding=g.get_embedding())
```


I let it run for a long time, but that's probably safer to have it in the tests.

Thanks,

Nathann


---

Comment by git created at 2016-01-29 14:28:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-01-29 14:35:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2016-01-29 14:38:59

Yoooooooooo !

I just ran the test on the files you changed, and it's all right. Can I switch it to `positive_review` or do you have changes pending?

Nathann


---

Comment by chapoton created at 2016-01-29 14:43:43

Hello,

no, I am all done.

Thanks a lot for your time, and your patience.


---

Comment by ncohen created at 2016-01-29 14:44:56

Yoooooooooooooo !

> no, I am all done.

Excellent. Then let it go. Thanks for the code `:-)`

Nathann


---

Comment by ncohen created at 2016-01-29 14:44:56

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-01-30 00:11:05

Resolution: fixed
