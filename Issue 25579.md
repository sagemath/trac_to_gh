# Issue 25579: git broken in ./sage -sh on Cygwin

Issue created by migration from https://trac.sagemath.org/ticket/25816

Original creator: embray

Original creation time: 2018-07-10 14:47:35

This is a problem that has been plaguing me for a few months but I haven't taken much time to work out the source of the problem yet.

It might also be dependent on the package version of Cygwin's git pacakge, but when using the system git from Cygwin in a `./sage -sh` shell, it's broken.  A workaround is to put `PATH=/usr/bin:$PATH` in front.  So it seems maybe some library installed as part of Sage is incompatible with the system git.

This is a problem, in particular, for `pip install`ing packages from a git repo, for example.


---

Comment by embray created at 2018-07-10 15:56:56

In the process of `git clone` it forks and spawns `/usr/libexec/git-core/git-remote-https.exe`. This in turn loads:


```
--- Process 1812 loaded C:\Windows\System32\ntdll.dll at 00007FFEA4BF0000
--- Process 1812 loaded C:\Windows\System32\kernel32.dll at 00007FFEA3D30000
--- Process 1812 loaded C:\Windows\System32\KernelBase.dll at 00007FFEA1B90000
--- Process 1812 thread 13644 created
--- Process 1812 thread 17792 created
--- Process 1812 thread 29828 created
--- Process 1812 loaded C:\cygwin64\bin\cygcurl-4.dll at 00000003F6D60000
--- Process 1812 loaded C:\cygwin64\bin\cygwin1.dll at 0000000180040000
--- Process 1812 loaded C:\cygwin64\bin\cygintl-8.dll at 00000003ECE50000
--- Process 1812 loaded C:\Users\Erik M. Bray\Home\src\sagemath\sage\local\bin\cygiconv-2.dll at 00000003CB550000
--- Process 1812 loaded C:\Users\Erik M. Bray\Home\src\sagemath\sage\local\bin\cygpcre-1.dll at 00000003C6FC0000
--- Process 1812 loaded C:\cygwin64\bin\cygz.dll at 00000003E8DC0000
--- Process 1812 loaded C:\cygwin64\bin\cygcrypto-1.0.0.dll at 00000003F5180000
--- Process 1812 loaded C:\cygwin64\bin\cyggssapi_krb5-2.dll at 00000003F2EF0000
--- Process 1812 loaded C:\cygwin64\bin\cygldap-2-4-2.dll at 00000003F26A0000
--- Process 1812 loaded C:\cygwin64\bin\cygidn2-0.dll at 00000003F2BC0000
--- Process 1812 loaded C:\cygwin64\bin\cyglber-2-4-2.dll at 00000003F2750000
--- Process 1812 loaded C:\cygwin64\bin\cygnghttp2-14.dll at 00000003ECF70000
--- Process 1812 loaded C:\cygwin64\bin\cygpsl-5.dll at 00000003EBEA0000
--- Process 1812 loaded C:\cygwin64\bin\cygssh2-1.dll at 00000003EB010000
--- Process 1812 loaded C:\cygwin64\bin\cygssl-1.0.0.dll at 00000003EAFA0000
--- Process 1812, exception c0000139 at 00007FFEA4C89968
--- Process 1812 loaded C:\cygwin64\bin\cygkrb5-3.dll at 00000003EC900000
--- Process 1812 loaded C:\cygwin64\bin\cygk5crypto-3.dll at 00000003EC9E0000
--- Process 1812 thread 21968 exited with status 0xc0000139
--- Process 1812 thread 17792 exited with status 0xc0000139
--- Process 1812 thread 29828 exited with status 0xc0000139
--- Process 1812 exited with status 0xc0000139
```


and then dies.  It's odd that it loads iconv and pcre from Sage.  Rather, it's expected in a way, but where it gets strange is that `git.exe` also loads these DLLs but it uses the versions from the system:


```
--- Process 9444 created
--- Process 9444 loaded C:\Windows\System32\ntdll.dll at 00007FFEA4BF0000
--- Process 9444 loaded C:\Windows\System32\kernel32.dll at 00007FFEA3D30000
--- Process 9444 loaded C:\Windows\System32\KernelBase.dll at 00007FFEA1B90000
--- Process 9444 thread 9700 created
--- Process 9444 thread 4776 created
--- Process 9444 thread 1016 created
--- Process 9444 loaded C:\cygwin64\bin\cygwin1.dll at 0000000180040000
--- Process 9444 loaded C:\cygwin64\bin\cygiconv-2.dll at 00000003F2530000
--- Process 9444 loaded C:\cygwin64\bin\cygintl-8.dll at 00000003ECE50000
--- Process 9444 loaded C:\cygwin64\bin\cygpcre-1.dll at 00000003EC540000
--- Process 9444 loaded C:\cygwin64\bin\cygz.dll at 00000003E8DC0000
```


It could be some subtlety about the DLL order?  That remains unclear at the moment.  I need to take a closer look at the DLL dependency trees.


---

Comment by embray created at 2018-07-10 16:24:16

I think I know the reason.  It's because DLL search order normally looks first in the same directory as the executable loading the DLL, then resorts to `$PATH`.  Since `git.exe` is in `/usr/bin/` it has most of its dependent DLLs right beside it.  But executables installed under `/usr/libexec/` do not, so they find these DLLs first in `$SAGE_LOCAL/bin`.

This is definitely a bit of an oddity to git, since so much of it is installed user `/usr/libexec/git-core`.  

I'm not sure much can be done about this from the Sage end of things.  Perhaps for the Sage-for-Windows build I can ensure that some DLLs are copied into `/usr/libexec/git-core/` in order for git to function properly.


---

Comment by embray created at 2018-07-10 16:27:22

Turns out this only affects those two DLLs:


```
$ cygcheck.exe /usr/libexec/git-core/*.exe | grep 'sage\\local' | sed 's/^ *//' | sort | uniq
C:\Users\Erik M. Bray\Home\src\sagemath\sage\local\bin\cygiconv-2.dll
C:\Users\Erik M. Bray\Home\src\sagemath\sage\local\bin\cygpcre-1.dll
```



---

Comment by embray created at 2018-07-10 16:35:49

This works as a general solution.  I'll add it to the [Cygwin64Port](Cygwin64Port) wiki page:


```
for dllname in $(cygcheck.exe /usr/libexec/git-core/*.exe | grep 'sage\\local' | sed 's|.*\\\(.\+\.dll\)|\1|' | sort | uniq); do
    cp /usr/bin/$dllname /usr/libexec/git-core/
done
```


This might also be worth mentioning upstream in the Cygwin git package, since this is a bit fragile.


---

Comment by embray created at 2018-07-10 16:39:40

Replying to [comment:2 embray]:
> I'm not sure much can be done about this from the Sage end of things.  Perhaps for the Sage-for-Windows build I can ensure that some DLLs are copied into `/usr/libexec/git-core/` in order for git to function properly.

Well, one thing we could do is prefer not to build those libraries in the first place.  That, of course, is being worked on...


---

Comment by git created at 2018-07-11 15:32:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-12-28 14:10:15

Retargeting some of my tickets (somewhat optimistically for now).


---

Comment by embray created at 2019-03-25 10:44:36

Removing most of the rest of my open tickets out of the 8.7 milestone, which should be closed.


---

Comment by embray created at 2019-06-15 21:36:32

This branch was probably for another ticket.


---

Comment by slelievre created at 2019-06-15 23:02:06

Replying to [comment:12 embray]:
> This branch was probably for another ticket.

Yes, it was for #25826.
