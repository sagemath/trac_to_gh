# Issue 20972: update fricas to 1.2.7 (current)

Issue created by migration from Trac.

Original creator: dimpase

Original creation time: 2016-08-10 16:52:59

CC:  dkrenn mantepse hemmecke

subject says it all, see http://fricas.sourceforge.net/


---

Comment by mantepse created at 2016-08-11 19:23:47

I am currently rebuilding sage-develop...

Do I understand correctly that I should rename ```fricas-1.2.7-full.tar.bz2``` to ```fricas-1.2.7.tar.bz2``` before putting it into the ```upstream``` directory?


---

Comment by leif created at 2016-08-11 19:31:47

Replying to [comment:4 mantepse]:
> Do I understand correctly that I should rename ```fricas-1.2.7-full.tar.bz2``` to ```fricas-1.2.7.tar.bz2``` before putting it into the ```upstream``` directory?

Would make sense.

Not sure if we can/should strip (=repackage) the tarball anyway; the description at least sounds as if there were things included we don't need for Sage / to ship.  But it isn't huge either.

If you do, you could create an `spkg-src` script, or at least document what you did in _"Special !Update/Build Instructions"_ in `SPKG.txt`.


---

Comment by leif created at 2016-08-11 19:34:28

More precisely, `fricas-VERSION-full.tar.bz2` in `checksums.ini` is supposed to work as well.


---

Comment by mantepse created at 2016-08-11 19:43:16

Replying to [comment:5 leif]:
> Replying to [comment:4 mantepse]:
> > Do I understand correctly that I should rename ```fricas-1.2.7-full.tar.bz2``` to ```fricas-1.2.7.tar.bz2``` before putting it into the ```upstream``` directory?
> 
> Would make sense.
>
> Not sure if we can/should strip (=repackage) the tarball anyway; the description at least sounds as if there were things included we don't need for Sage / to ship.  But it isn't huge either.

As far as I know: no, the things included in the "full" tarball are precisely those needed.

Unfortunately, build with ecl fails for the same reason as reported.


---

Comment by mantepse created at 2016-08-11 19:55:20

From Dima via sage-devel:

ECL does not use uffi: prefix any more, it's ffi: instead, according to their docs.
Replacing all the  uffi: with ffi: in src/lisp/fricas-lisp.lisp makes compiler happy.

Currently running the build, takes a while...


---

Comment by leif created at 2016-08-11 19:59:42

Dima said the following works:

```diff
diff -Naur fricas-1.2.7.orig/src/lisp/fricas-lisp.lisp fricas-1.2.7/src/lisp/fricas-lisp.lisp
--- fricas-1.2.7.orig/src/lisp/fricas-lisp.lisp	2015-09-25 02:06:15.000000000 +0200
+++ fricas-1.2.7/src/lisp/fricas-lisp.lisp	2016-08-11 21:57:25.840863287 +0200
`@``@` -556,10 +556,10 `@``@`
                     (dolist (el strs)
                         (setf wrapper `(FFI:WITH-CSTRING ,el ,wrapper)))
                     (setf wrapper `(defun ,name ,largs ,wrapper))
-                    `(progn (uffi:def-function (,c-name ,sym)
+                    `(progn (ffi:def-function (,c-name ,sym)
                                 ,fargs :returning ,l-ret)
                             ,wrapper))
-                `(uffi:def-function (,c-name ,name)
+                `(ffi:def-function (,c-name ,name)
                      ,fargs :returning ,l-ret)))))
 
 (defmacro fricas-foreign-call (name c-name return-type &rest arguments)
`@``@` -788,14 +788,14 `@``@`
 #+:ecl
 (progn
 
-(uffi:def-function ("sock_get_string_buf" sock_get_string_buf_wrapper)
+(ffi:def-function ("sock_get_string_buf" sock_get_string_buf_wrapper)
                    ((purpose :int) (buf (:array :unsigned-char 10000)) (len :int))
                    :returning :void)
 
 (defun |sockGetStringFrom| (purpose)
-    (uffi:with-foreign-object (buf '(:array :unsigned-char 10000))
+    (ffi:with-foreign-object (buf '(:array :unsigned-char 10000))
         (sock_get_string_buf_wrapper purpose buf 10000)
-        (uffi:convert-from-foreign-string buf)))
+        (ffi:convert-from-foreign-string buf)))
 
 )
 
`@``@` -825,7 +825,7 `@``@`
   (LISP::defentry |makedir| (LISP::string)         (LISP::int "makedir")))
 
 #+:ecl
-(uffi:def-function ("directoryp" raw_file_kind)
+(ffi:def-function ("directoryp" raw_file_kind)
                    ((arg :cstring))
                    :returning :int)
 #+:ecl
`@``@` -834,7 +834,7 `@``@`
            (raw_file_kind cname)))
 
 #+:ecl
-(uffi:def-function ("makedir" raw_makedir)
+(ffi:def-function ("makedir" raw_makedir)
                    ((arg :cstring))
                    :returning :int)
 
```


(`sed -i 's/uffi:/ffi:/' fricas-1.2.7/src/lisp/fricas-lisp.lisp`)


---

Comment by mantepse created at 2016-08-11 20:06:35

I can confirm this, the build just finished.  I am now looking for tests.


---

Comment by dimpase created at 2016-08-11 20:35:58

New commits:


---

Comment by dimpase created at 2016-08-11 20:41:30

Changing status from new to needs_review.


---

Comment by dimpase created at 2016-08-11 20:41:30

Here is a discussion on [FriCAS list](https://groups.google.com/d/msg/fricas-devel/tko6MdXgFNM/fRb_JgGhCAAJ).
I take it that they see this as a bug. Perhaps there is a more intelligent way to fix this, more CL-y one...


---

Comment by mantepse created at 2016-08-11 20:48:20

As far as I can see fix is CL-y, because it is fixing precisely the ecl-dependend functions...

I am still looking into the tests, but I suppose fixing them belongs to a different ticket.

Can I give this positive review?  (It works on my computer...)


---

Comment by leif created at 2016-08-11 20:55:05

`SPKG.txt` should get fixed and updated (as the patch has no header)... ;-)

I'd also add `[ -r "$patch" ] && ...` as usual.

Is there a test suite?

Does `make install` install the docs as well?  Do we otherwise want to install them, and if so, how, where?


---

Comment by leif created at 2016-08-11 20:56:21

P.S.:  I'd also say fixing (now?) broken doctests belongs to updating the package.


---

Comment by dimpase created at 2016-08-11 21:01:38

Replying to [comment:16 leif]:
> P.S.:  I'd also say fixing (now?) broken doctests belongs to updating the package.

Needless to say, all the 44 tests from `src/sage/interfaces/fricas.py` pass for me :-)


---

Comment by leif created at 2016-08-11 21:03:29

Replying to [comment:17 dimpase]:
> Replying to [comment:16 leif]:
> > P.S.:  I'd also say fixing (now?) broken doctests belongs to updating the package.
> 
> Needless to say, all the 44 tests from `src/sage/interfaces/fricas.py` pass for me :-)

There are more elsewhere.

(I assume you *did* specify `--optional=fricas`... ;-) )


---

Comment by mantepse created at 2016-08-11 21:17:24

There is one trivial fix in ```axiom.py``` (line 686 should not be "\leqno(11)" but rather "..."), but the conversion of even basic fricas types to sage types is broken.

Can anybody tell me where the method ``variables`` comes from (is implemented):

```
sage: a = fricas(1/2)
sage: a.variables()
[]
```

?


---

Comment by mantepse created at 2016-08-11 21:22:32

Just found out, it's provided by FriCAS.  But it's use is very likely abuse.


---

Comment by git created at 2016-08-11 22:00:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2016-08-11 22:14:05

For `fricas(1/2).sage()`, the fix looks doable, one needs to deal with `FriCAS`'s type Fraction. But the following is a bit weird:

```
sage: fricas(1/x).type()
Fraction(Polynomial(Integer))
sage: fricas(1/x).denominator()
x
sage: fricas(1/x).numerator()
1
sage: fricas(1/x).numerator().type()
Fraction(Polynomial(Integer))
sage: fricas(1/x).denominator().type()
Fraction(Polynomial(Integer))
```

Why do types of numerators and denominator are still `Fraction(...)`? This does not look right.


---

Comment by mantepse created at 2016-08-11 22:51:12

Replying to [comment:22 dimpase]:

> Why do types of numerators and denominator are still `Fraction(...)`? This does not look right.

This is actually correct.  You want `denom` and `numer`.


---

Comment by git created at 2016-08-12 15:17:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-08-12 16:00:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2016-08-12 16:05:39

OK, all done. Please have another look.
By the way, docs are installed in `SAGE_LOCAL/lib/fricas/target/x86_64-unknown-linux/share/`, at least if I do ` SAGE_SPKG_INSTALL_DOCS=yes sage -i fricas`.

Starting FriCAS at the `sage -sh` prompt then automatically pops up a docs "HyperText" menu, which uses some X11 stuff for displaying.


---

Comment by leif created at 2016-08-12 16:27:08

Replying to [comment:26 dimpase]:
> By the way, docs are installed in `SAGE_LOCAL/lib/fricas/target/x86_64-unknown-linux/share/`, at least if I do ` SAGE_SPKG_INSTALL_DOCS=yes sage -i fricas`.

Hmmm, nice folder name.  Is that configurable?  (It presumably has to find its own documentation, so we cannot manually copy it elsewhere; a link from `SAGE_LOCAL/share/...` may also help otherwise.)

\\
 
> Starting FriCAS at the `sage -sh` prompt then automatically pops up a docs "HyperText" menu, which uses some X11 stuff for displaying.

Is this a problem on MacOS X?


---

Comment by leif created at 2016-08-12 16:36:19

Ok, looks better.  (Haven't pulled nor run tests though yet.)

\\

Are the (upload) scripts smart enough to remove the old version if we keep the `-full`?  (I'm not sure, but don't care much either.  I guess the mirrors will only delete if we do so as well.)


---

Comment by leif created at 2016-08-12 16:38:37

Oh, forgot:

A note in the patch (probably a link to the upstream report) would be good as well.


---

Comment by dimpase created at 2016-08-12 16:40:20

Replying to [comment:27 leif]:
> Replying to [comment:26 dimpase]:
> > By the way, docs are installed in `SAGE_LOCAL/lib/fricas/target/x86_64-unknown-linux/share/`, at least if I do ` SAGE_SPKG_INSTALL_DOCS=yes sage -i fricas`.
> 
> Hmmm, nice folder name.  Is that configurable?  (It presumably has to find its own documentation, so we cannot manually copy it elsewhere; a link from `SAGE_LOCAL/share/...` may also help otherwise.)
> 
> \\
>  
> > Starting FriCAS at the `sage -sh` prompt then automatically pops up a docs "HyperText" menu, which uses some X11 stuff for displaying.
> 
> Is this a problem on MacOS X?
> 
It's not a problem on SMC - it just prints a warning, and carries on regardless (probably the same on OSX). Anyhow, there is an option to disable GUI at startup completely.


---

Comment by dimpase created at 2016-08-12 16:43:33

Replying to [comment:29 leif]:
> Oh, forgot:
> 
> A note in the patch (probably a link to the upstream report) would be good as well.
>  
This patch shall go as soon as new FriCAS is released. They already [have it](https://github.com/fricas/fricas/commit/9146dcb84a6f671cf0699d8df568c20a0a95553f) in their repos.


---

Comment by leif created at 2016-08-12 16:51:19

OK.


---

Comment by leif created at 2016-08-12 16:52:51

Changing keywords from "" to "uffi ECL".


---

Comment by dimpase created at 2016-08-14 10:56:31

ping?


---

Comment by mantepse created at 2016-08-14 15:01:29

Since the interface has its own ticket #21231 I vote for merging this as soon as possible.

Martin


---

Comment by leif created at 2016-08-14 15:06:14

I'll trigger a final test...

Does #21231 logically depend on this (apart from the UFFI patch)?


---

Comment by dimpase created at 2016-08-14 15:19:13

Replying to [comment:36 leif]:
> I'll trigger a final test...
> 
> Does #21231 logically depend on this (apart from the UFFI patch)?

this ticket updates the FriCAS version too, you know... :-)


---

Comment by leif created at 2016-08-14 15:32:33

Replying to [comment:37 dimpase]:
> Replying to [comment:36 leif]:
> > I'll trigger a final test...
> > 
> > Does #21231 logically depend on this (apart from the UFFI patch)?
> 
> this ticket updates the FriCAS version too, you know... :-) 

1) It's smells like a _minor_ update (1.2.*4* to 1.2.*7*).

2) The _Dependencies_ field of #21231 is empty.

So I was asking mainly because of 2).


---

Comment by mantepse created at 2016-08-14 15:44:17

As I wrote on the #21231, strictly speaking #21231 does NOT depend on this ticket, because the interface will work just fine with a system install of FriCAS.


---

Comment by dimpase created at 2016-08-14 15:47:11

Replying to [comment:39 mantepse]:
> As I wrote on the #21231, strictly speaking #21231 does NOT depend on this ticket, because the interface will work just fine with a system install of FriCAS.

IMHO it is better to stick with a version provided by Sage, to make sure that all doctests pass (for the output might depend on FriCAS version).


---

Comment by dimpase created at 2016-08-14 15:50:54

Replying to [comment:38 leif]:
> Replying to [comment:37 dimpase]:
> > Replying to [comment:36 leif]:
> > > I'll trigger a final test...
> > > 
> > > Does #21231 logically depend on this (apart from the UFFI patch)?
> > 
> > this ticket updates the FriCAS version too, you know... :-) 
> 
> 1) It's smells like a _minor_ update (1.2.*4* to 1.2.*7*).
> 
to my non-musical ear, minor does not differ much from major...

> 2) The _Dependencies_ field of #21231 is empty.

#21231 is about a different, new interface.

> 
> So I was asking mainly because of 2).
>


---

Comment by dimpase created at 2016-08-14 15:54:14

Replying to [comment:38 leif]:
> 2) The _Dependencies_ field of #21231 is empty.
well, no, it is not.


---

Comment by leif created at 2016-08-14 16:15:08

Replying to [comment:42 dimpase]:
> Replying to [comment:38 leif]:
> > 2) The _Dependencies_ field of #21231 is empty.
> well, no, it is not.

Race condition. ;-)


---

Comment by leif created at 2016-08-14 16:54:09

Changing status from needs_review to positive_review.


---

Comment by leif created at 2016-08-14 16:54:09

I won't comment on the 5043 style warnings... XD


---

Comment by dimpase created at 2016-08-14 20:07:48

Replying to [comment:44 leif]:
> I won't comment on the 5043 style warnings... XD
[Style 5043](https://www.vxintimate.com/style/5043/)? No,please don't, indeed...


---

Comment by leif created at 2016-08-14 20:27:12

Replying to [comment:45 dimpase]:
> Replying to [comment:44 leif]:
> > I won't comment on the 5043 style warnings... XD
> [Style 5043](https://www.vxintimate.com/style/5043/)? No,please don't, indeed...

Well, [unfortunately due to popular demand this product is currently out of stock.](http://indiarush.com/velvet-zari-work-green-semi-stiitched-lehenga-style-saree-5043/)


---

Comment by vbraun created at 2016-08-15 18:27:13

Resolution: fixed


---

Comment by leif created at 2016-08-27 21:33:00

Looks like I'm having more than a dozen `AXIOMsys` orphans from (testing) this...


---

Comment by mantepse created at 2016-08-28 06:43:41

Replying to [comment:48 leif]:
> Looks like I'm having more than a dozen `AXIOMsys` orphans from (testing) this...

Could you please expand?  Is there a problem?  If so, did you test with the new interface  #21231 , or the old one?


---

Comment by leif created at 2016-08-28 12:10:29

Replying to [comment:49 mantepse]:
> Replying to [comment:48 leif]:
> > Looks like I'm having more than a dozen `AXIOMsys` orphans from (testing) this...
> 
> Could you please expand?  Is there a problem?  If so, did you test with the new interface  #21231 , or the old one?

Just with the old interface, hence I reported it here.  (There were 27 orphans from perhaps testing `src/sage/interfaces/*` once or twice and one `ptestlong` I think.  I only incidentally noticed them after weeks because they weren't very active either.)

So when reviewing #21231, one should look whether there's still a problem.


---

Comment by mantepse created at 2016-08-28 12:26:54

Replying to [comment:50 leif]:
> Replying to [comment:49 mantepse]:
> > Replying to [comment:48 leif]:
> > > Looks like I'm having more than a dozen `AXIOMsys` orphans from (testing) this...
> > 
> > Could you please expand?  Is there a problem?  If so, did you test with the new interface  #21231 , or the old one?
> 
> Just with the old interface, hence I reported it here.  (There were 27 orphans from perhaps testing `src/sage/interfaces/*` once or twice and one `ptestlong` I think.  I only incidentally noticed them after weeks because they weren't very active either.)
> 
> So when reviewing #21231, one should look whether there's still a problem.

Could you provide a testcase, or some instructions how to see the orphans?  That would make things much easier for me - because I have no idea how to do this...


---

Comment by dimpase created at 2016-08-28 22:57:59

To see if there are orphans on Linux, look at the output of

```
$ ps -def | grep fricas
```

I see a couple of these just after one run of

```
./sage -tp --optional=fricas,sage src/sage/interfaces/fricas.py 
```



---

Comment by leif created at 2016-08-28 23:04:01

Replying to [comment:51 mantepse]:
> Replying to [comment:50 leif]:
> > Replying to [comment:49 mantepse]:
> > > Replying to [comment:48 leif]:
> > > > Looks like I'm having more than a dozen `AXIOMsys` orphans from (testing) this...
> > > 
> > > Could you please expand?  Is there a problem?  If so, did you test with the new interface  #21231 , or the old one?
> > 
> > Just with the old interface, hence I reported it here.  (There were 27 orphans from perhaps testing `src/sage/interfaces/*` once or twice and one `ptestlong` I think.  I only incidentally noticed them after weeks because they weren't very active either.)
> > 
> > So when reviewing #21231, one should look whether there's still a problem.
> 
> Could you provide a testcase, or some instructions how to see the orphans?  That would make things much easier for me - because I have no idea how to do this...

Ah, sorry, forgot to answer.

You can also use e.g. `ps x | grep AXIOMsys | grep -v grep`.

(And `kill $(ps x | grep AXIOMsys | grep -v grep | awk '{ print $1 }')` ;-) )


---

Comment by leif created at 2016-08-28 23:11:12

Note that you should look a while _after_ you've left Sage, as normally the Sage Cleaner should kill them (but that only works if the interfaces are properly written / their PIDs properly recorded).


---

Comment by mantepse created at 2016-08-29 06:33:45

Thank you.  Indeed, there is a bug.  However, I don't know yet how to fix it, I thought that `fricas.quit()` would send `fricas._quit_string()` to fricas, but apparently it doesn't.  So, what should I do?  (I couldn't find anything but `_quit_string` in other interfaces...)


---

Comment by dimpase created at 2016-08-29 09:38:49

Replying to [comment:55 mantepse]:
> Thank you.  Indeed, there is a bug.  However, I don't know yet how to fix it, I thought that `fricas.quit()` would send `fricas._quit_string()` to fricas, but apparently it doesn't.  So, what should I do?  (I couldn't find anything but `_quit_string` in other interfaces...)

I think the problem is that more child processes of FriCAS are launched than `sage-cleaner` (a script that cleans up after Sage ends) is able to deal with.
In fact, you see that

```
sage: fricas._quit_string()
')lisp (quit)'
```

which is as it should be, as `FriCAS` inherits from `PanAxiom` class (in `sage/interfaces/axiom.py`), where `_quit_string` is defined.
And you see that `fricas.quit()` does kill the instance corresponding to `fricas.pid()`, as it should, by looking at the output of `ps -def...`.

Here is how it goes: I start Sage and execute `fricas.pid()` at the prompt; I see that this results in launching of a bunch of things:

```
dima     30739 30652  0 10:21 pts/4    00:00:00 /home/dima/Sage/sage/local/lib/fricas/target/x86_64-unknown-linux/bin/sman -nox -noclef -ws /home/dima/Sage/sage/local/lib/fricas/target/x86_64-unknown-linux/bin/AXIOMsys
dima     30745 30739  1 10:21 pts/5    00:00:00 /home/dima/Sage/sage/local/lib/fricas/target/x86_64-unknown-linux/bin/AXIOMsys -- /home/dima/Sage/sage/local/lib/fricas/target/x86_64-unknown-linux/bin/
dima     30746 30739  0 10:21 pts/4    00:00:00 /home/dima/Sage/sage/local/lib/fricas/target/x86_64-unknown-linux/lib/session
dima     30747 30739  0 10:21 pts/4    00:00:00 /home/dima/Sage/sage/local/lib/fricas/target/x86_64-unknown-linux/lib/spadclient
dima     30748 30739  0 10:21 pts/4    00:00:00 /home/dima/Sage/sage/local/lib/fricas/target/x86_64-unknown-linux/bin/sman -nox -noclef -ws /home/dima/Sage/sage/local/lib/fricas/target/x86_64-unknown-linux/bin/AXIOMsys
```

of which the 1st one corresponds to PID reported by `fricas.pid()`. 

If I issue `fricas.quit()` and then quit Sage then no zombies live on. But if I just quit Sage then I get a zombie, one of these

```
/home/dima/Sage/sage/local/lib/fricas/target/x86_64-unknown-linux/bin/AXIOMsys -- /home/dima/Sage/sage/local/lib/fricas/target/x86_64-unknown-linux/bin/
```


Probably, the information on these extra processes' PIDs has to be registered somewhere for `sage-cleaner` to succeed.


---

Comment by mantepse created at 2016-08-29 10:59:03

Are you sure that `_quit_string` is used at all?  Because, if it is sent to fricas, then fricas should quit (and it does so on my machine).

Simply killing a few processes is error prone, I'd say.


---

Comment by dimpase created at 2016-08-29 11:30:36

`_quit_string` is used when you explicitly call `fricas.quit()`. But it is not used by `sage-cleaner`, AFAICS (although this is fixable, I guess). `sage-cleaner` would kill all sub-processed spawned by a process launched by a process with the PID it knows. But it seems that that zombie suprocesses of FriCAS don't have parent's PID equal to FriCAS, they are parented by the same PID as the main FriCAS process, if I read this correctly from the output of `ps -def`. 

Do you know how FriCAS launches these (sub?)processes?


---

Comment by leif created at 2016-08-29 11:59:43

The purpose of the Sage Cleaner is not to shut down pexpect interfaces, that is supposed to be done by Sage when exiting.

The Sage Cleaner is just there to afterwards (after a while) kill spawned processes if something went wrong.  And he doesn't know child processes spawned by these foreign ones, they have to belong to the same process group to make killing them work.


---

Comment by mantepse created at 2016-08-29 12:47:38

Replying to [comment:58 dimpase]:

> `_quit_string' is used when you explicitly call `fricas.quit()`.

I cannot see this in the code. However, I do see it when tracing.  Possibly a newline is missing?

> Do you know how FriCAS launches these (sub?)processes?

No.


---

Comment by dimpase created at 2016-08-29 14:00:21

Replying to [comment:59 leif]:
> The purpose of the Sage Cleaner is not to shut down pexpect interfaces, that is supposed to be done by Sage when exiting.
> 
> The Sage Cleaner is just there to afterwards (after a while) kill spawned processes if something went wrong.  And he doesn't know child processes spawned by these foreign ones, they have to belong to the same process group to make killing them work.

OK, what happens is more subtle: if `fricas.quit()` is not invoked before exiting Sage, then zombie arises with parent's ID of `systemd`. Before exit, however, the (pre)zombie parent's ID is good, it's the same as shown by `fricas.pid()`. 

IMHO this means that `sage-cleaner` fails to kill it; when it did get `fricas.quit()` it flips to a ready to die state, but not otherwise.


---

Comment by mantepse created at 2016-08-29 18:23:25

I just noticed that `fricas.quit()` does work (at least with the new interface).  However, it takes a very long time:

```
sage: def doit():
....:     F = fricas(1+1).parent(); a = time.time(); F.quit()
....:     result = ["testing"]
....:     while result != []:
....:         result = !ps x | grep AXIOMsys | grep -v grep
....:         sleep(1)
....:     print time.time() - a
....:     
sage: doit()
16.3083839417
```


It shouldn't.  If I use `fricas._expect.write(")quit\r")`, fricas quits immediately.  So, indeed, `"\r"` is missing.  Should I simply modify the quitstring?


---

Comment by dimpase created at 2016-08-29 19:35:45

Replying to [comment:62 mantepse]:
> I just noticed that `fricas.quit()` does work (at least with the new interface).  However, it takes a very long time:
> {{{
> sage: def doit():
> ....:     F = fricas(1+1).parent(); a = time.time(); F.quit()
> ....:     result = ["testing"]
> ....:     while result != []:
> ....:         result = !ps x | grep AXIOMsys | grep -v grep
> ....:         sleep(1)
> ....:     print time.time() - a
> ....:     
> sage: doit()
> 16.3083839417
> }}}
> 
> It shouldn't.  If I use `fricas._expect.write(")quit\r")`, fricas quits immediately.  So, indeed, `"\r"` is missing.  Should I simply modify the quitstring?

well, IMHO if `\r` was missing in _quit_string then `fricas.quit()` would not be working at all... (well, perhaps it is slow as it is because it invokes lisp.)

Here your command has no effect:

```
sage: fricas.pid()
6130
sage: fricas._expect.write(")quit\r")
sage: fricas.pid()
6130
sage: fricas.quit()
sage: fricas.pid() # right, now we get a new instance!
6507
```

Please check that you don't see the same picture with your new interface.


---

Comment by mantepse created at 2016-08-29 20:49:37

On my computer, `fricas.pid()` cannot be used to see whether fricas is running:

```
sage: fricas.pid()
10923
sage: !ps x | grep AXIOMsys | grep -v grep
10923 pts/3    Ss+    0:00 /usr/local/lib/fricas/target/x86_64-unknown-linux/bin/sman -nox -noclef -ws /usr/local/lib/fricas/target/x86_64-unknown-linux/bin/AXIOMsys
10929 pts/4    Ss+    0:00 /usr/local/lib/fricas/target/x86_64-unknown-linux/bin/AXIOMsys -- /usr/local/lib/fricas/target/x86_64-unknown-linux/bin/
10932 pts/3    S+     0:00 /usr/local/lib/fricas/target/x86_64-unknown-linux/bin/sman -nox -noclef -ws /usr/local/lib/fricas/target/x86_64-unknown-linux/bin/AXIOMsys
sage: fricas._expect.write(")quit\r")
sage: !ps x | grep AXIOMsys | grep -v grep
sage: fricas.pid()
10923
```



---

Comment by dimpase created at 2016-08-30 04:49:38

Replying to [comment:64 mantepse]:
> On my computer, `fricas.pid()` cannot be used to see whether fricas is running:
> {{{
> sage: fricas.pid()
> 10923
> sage: !ps x | grep AXIOMsys | grep -v grep
> 10923 pts/3    Ss+    0:00 /usr/local/lib/fricas/target/x86_64-unknown-linux/bin/sman -nox -noclef -ws /usr/local/lib/fricas/target/x86_64-unknown-linux/bin/AXIOMsys
> 10929 pts/4    Ss+    0:00 /usr/local/lib/fricas/target/x86_64-unknown-linux/bin/AXIOMsys -- /usr/local/lib/fricas/target/x86_64-unknown-linux/bin/
> 10932 pts/3    S+     0:00 /usr/local/lib/fricas/target/x86_64-unknown-linux/bin/sman -nox -noclef -ws /usr/local/lib/fricas/target/x86_64-unknown-linux/bin/AXIOMsys
> sage: fricas._expect.write(")quit\r")
> sage: !ps x | grep AXIOMsys | grep -v grep
> sage: fricas.pid()
> 10923
> }}}

no, what you see is that fricas is running, with pid 10923, and that `fricas._expect.write(")quit\r")` is ignored by it. If you implemented `_quit_string` properly you would also be able to stop it as is possible with the old interface.


---

Comment by mantepse created at 2016-08-30 06:19:33

Dima, I don't understand your reasoning.  I would think that the first line below quits the fricas process on my machine, as the output of the second line shows.

```
sage: fricas._expect.write(")quit\r")
sage: !ps x | grep AXIOMsys | grep -v grep
sage: fricas.pid()
10923
```

The third line is in accordance with the doc of `.pid()`:

```
   Return the PID of the underlying sub-process.

   REMARK:

   If the interface terminates unexpectedly, the original PID will
   still be used. But if it was terminated using "quit()", a new sub-
   process with a new PID is automatically started.

   EXAMPLE:

      sage: pid = gap.pid()
      sage: gap.eval('quit;')
      ''
      sage: pid == gap.pid()
      True
      sage: gap.quit()
      sage: pid == gap.pid()
      False
```


So, in my opinion a possible fix is to append a `\r` to the quitstring - and of course, this should work with the old interface, too, although I did not test.

No idea though why fricas needs it, and, for example, gap, doesn't.


---

Comment by dimpase created at 2016-09-02 12:55:52

Sorry, indeed, I didn't quite parse what you wrote. Anyhow, as soon as your new interface is ready, I'd be glad to have a look at it. Are there any git-related issues you need to fix?


---

Comment by mantepse created at 2016-09-02 13:37:35

Replying to [comment:67 dimpase]:
> Sorry, indeed, I didn't quite parse what you wrote. Anyhow, as soon as your new interface is ready, I'd be glad to have a look at it.

Thank you!

> Are there any git-related issues you need to fix?

Indeed - I made a mess with the commits and found no time to correct them.  It would be of great help if you could, for example, create a "clean" branch from my branch, deleting all the commits which obviously don't belong (I made a list at the ticket).

I think the only work that remains to be done there is to add that "\r" to the quitstring, add a test to the `quit()` method, and probably some others to make the patchbot happy.

If the following an acceptable test for `quit()`?

```
sage: p = fricas.pid();
sage: l = !ps x | grep AXIOMsys | grep -v grep
sage: any(s.strip().startswith(str(p)) for s in l)
True
sage: fricas.quit()
sage: any(s.strip().startswith(str(p)) for s in l)
False
```



---

Comment by leif created at 2016-09-02 19:39:09

Replying to [comment:68 mantepse]:
> Is the following an acceptable test for `quit()`?
> {{{
> sage: p = fricas.pid();
> sage: l = !ps x | grep AXIOMsys | grep -v grep
> sage: any(s.strip().startswith(str(p)) for s in l)
> True
> sage: fricas.quit()
> sage: any(s.strip().startswith(str(p)) for s in l)
> False
> }}}

Unfortunately no.  Neither `ps`, nor `x`, nor the output format are really portable _I think<sup>TM</sup>_.  So you'd presumably have to use some Python stuff instead.  Not to mention you shouldn't use `!` (but `os.system()` or one of its replacements instead).

Rather orthogonal to that, you must not use `.startswith()`, but rather `.split()[0]==str(p)`.


---

Comment by leif created at 2016-09-07 13:12:58

Jeroen just suggested on sage-devel to make the Python package `psutil` standard.

You could look into that for retrieving process information in a portable way.


---

Comment by mantepse created at 2016-09-08 20:31:09

I just managed to install `psutil`, and found out:

```
sage: import psutil
sage: p = fricas.pid(); p
22184
sage: pr = psutil.Process(p); pr
<psutil.Process(pid=22184, name='sman') at 140240479360400>
sage: pr.children()
[<psutil.Process(pid=22190, name='AXIOMsys') at 140240479356752>,
 <psutil.Process(pid=22191, name='session') at 140240479356816>,
 <psutil.Process(pid=22192, name='spadclient') at 140240479356880>,
 <psutil.Process(pid=22193, name='sman') at 140240479356944>]
sage: fricas._expect.write(")quit\r")
sage: pr.children()
[]
sage: pr
<psutil.Process(pid=22184, name='sman') at 140240479360400>
```

This remaining job is killed when exiting sage.  However:

```
sage: p = gap.pid(); p
22582
sage: pr = psutil.Process(p); pr
<psutil.Process(pid=22582, name='gap') at 140240479291088>
sage: pr.children()
[]
sage: gap.quit()
sage: pr
<psutil.Process(pid=22582 (terminated)) at 140240479291088>
```

So it's better, but not perfect.  Is it good enough?
