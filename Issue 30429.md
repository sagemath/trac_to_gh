# Issue 30429: Add "sage_setup: distribution" directives to all Cython modules needing external libraries

Issue created by migration from https://trac.sagemath.org/ticket/30666

Original creator: mkoeppe

Original creation time: 2020-09-26 14:30:43

CC:  @tobiasdiez dimpase

This is preparation for Meta-ticket #29705 (Modularization) and #30371.


---

Comment by @tobiasdiez created at 2020-09-26 18:34:40

Good idea to separate this into a new ticket.

While working on #30371, I noticed that most cython files using singular cannot be compiled without pynac. So maybe these should be combined.

Also, I think, there should be distributions for GAP, CCObject, linbox, ratpoints, zn_poly and mari.

What do you think about renaming sage_setup: distribution to sage_setup: dependency? I think this better reflects the purpose. The distribution is then generated based on which dependencies are available. Another idea would be to use `distutils: libraries` which already contains some of the dependencies anyway (e.g. arb, gmp, flint).


---

Comment by mkoeppe created at 2020-09-26 20:04:43

Replying to [comment:5 gh-tobiasdiez]:
> While working on #30371, I noticed that most cython files using singular cannot be compiled without pynac. So maybe these should be combined.

I think they should be separate because I really want to be able to make singular optional. pynac, on the other hand, is essential for our symbolics implementation.

> Also, I think, there should be distributions for GAP, CCObject, linbox, ratpoints, zn_poly and mari.

Yes, please add to the list in the ticket description with explanation (what is CCObject?)

> What do you think about renaming sage_setup: distribution to sage_setup: dependency?

No, I wouldn't like that. As soon as you start with declaring "dependencies", there will be combinatorial explosion from the combinations of such dependencies. I really want a well-designed partition of the source files into (relatively few) disjoint distributions. This is crucial for the modularization -- each distribution will eventually be separately compilable and installable package on PyPI.


---

Comment by @tobiasdiez created at 2020-09-27 07:48:37

Ok, makes sense.
Which distribution should be assigned to files that have two dependencies (e.g use pynac and singular)?

My idea was that the cython file declares which dependencies it has, and in the setup.py file you have a list of distributions and their dependencies. If all dependencies are met, that particular distribution is built. E.g. distribution "sage-singular" relies on "pynac" and "singular". (That's only a feeling, but it feels strange to have distributions determined by dependencies and not by a theme or subject, e.g. "sage-singular" vs "sage-symbolic calculation". But you have a better overview, so I trust you there.)

I've added the above distributions to the list.
(Forget about CCObject, it was a missing import in #30371 that confused me.)


---

Comment by mkoeppe created at 2020-09-27 17:52:46

Replying to [comment:8 gh-tobiasdiez]:
> Which distribution should be assigned to files that have two dependencies (e.g use pynac and singular)?

Distributions can certainly depend on other distributions. `sage-singular` could depend on `sage-pynac`. Let's include this in the ticket description. (In the modularized build, `sage-singular`'s `setup.py` or `setup.cfg` would have `install_requires = sage-pynac`.)

Also, often it is relatively easy to remove some of these dependencies by small changes to a few source files, moving a few methods around. See for example #29911. We can take work on this in follow-up tickets.

> it feels strange to have distributions determined by dependencies and not by a theme or subject, e.g. "sage-singular" vs "sage-symbolic calculation". 

Perhaps, but there is actually an important "political" (open source community) reason for this design too. By naming these components after major libraries that provide the features, we make these libraries and their important role for Sage more visible to end users. Attribution tends to be an important motivating factor to developers of these libraries.


---

Comment by mkoeppe created at 2020-09-27 18:36:17

To expand on this a little bit: I wouldn't rule out distributions named after topics. The present ticket only provides a "skeleton" of distributions that are (1) technically needed to take care of compile-time dependencies, (2) provides attribution. Later on (in follow-up tickets), for example, there could be a distribution `sage-feature-padics` or something like this that has `sage-ntl` as a dependency and packages `sage.rings.padics`.


---

Comment by mkoeppe created at 2020-10-04 17:05:03

Replying to [comment:6 mkoeppe]:
> Replying to [comment:5 gh-tobiasdiez]:
> > While working on #30371, I noticed that most cython files using singular cannot be compiled without pynac. So maybe these should be combined.
> 
> I think they should be separate because I really want to be able to make singular optional. pynac, on the other hand, is essential for our symbolics implementation.

When I wrote this, I didn't recall that singular's `libfactory` is actually a dependency of pynac. So I think you are right, it's best to have pynac and singular in one distribution (for now, at least).


---

Comment by mkoeppe created at 2020-12-06 17:43:20

Changing keywords from "" to "sd111".


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2022-11-17 06:48:12

New commits:


---

Comment by git created at 2022-11-17 06:58:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-11-17 08:33:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-11-17 08:41:27

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-11-18 22:40:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-12-03 00:50:02

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-12-03 21:14:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-12-03 21:27:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-12-03 21:29:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-12-04 04:40:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-12-04 05:50:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-12-04 07:03:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-12-04 07:05:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-12-04 07:27:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-12-04 07:29:43

Changing status from new to needs_review.


---

Comment by dimpase created at 2022-12-04 17:42:55

How are all these tags like `# sage_setup: distribution = sagemath-gap` processed?


---

Comment by mkoeppe created at 2022-12-04 18:55:11

They are processed by the functions in `sage_setup.find`, via `sage.misc.package_dir`.


---

Comment by git created at 2022-12-04 19:08:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-12-04 19:11:28


```
sage -t --random-seed=146157697718740975867546676674797881386 sage/groups/perm_gps/partn_ref/data_structures.pyx
**********************************************************************
File "sage/groups/perm_gps/partn_ref/data_structures.pyx", line 1221, in sage.groups.perm_gps.partn_ref.data_structures.SC_test_list_perms
Failed example:
    for i in range(2,9):
        test_Sn_on_m_points(i,i,1,0)
Expected nothing
Got:
    ImportError: cannot import name n_is_prime
    Exception ignored in: 'sage.groups.perm_gps.partn_ref.data_structures.SC_is_giant'
    Traceback (most recent call last):
      File "<doctest sage.groups.perm_gps.partn_ref.data_structures.SC_test_list_perms[2]>", line 4, in test_Sn_on_m_points
```



---

Comment by mkoeppe created at 2022-12-04 19:16:13

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-12-04 20:33:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-12-04 20:39:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-12-04 20:42:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-12-06 21:27:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-12-06 21:27:35

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2022-12-07 17:33:17

there are a number of files with `m4` suffix, which does not seem to be `m4` files.
Should they rather get `in` suffux?


---

Comment by mkoeppe created at 2022-12-07 17:57:08

They are processed by m4, see `build/pkgs/sagelib/bootstrap`


---

Comment by dimpase created at 2022-12-07 20:09:49

Imho they should have .in suffix. Otherwise, looks OK.


---

Comment by mkoeppe created at 2022-12-07 20:17:38

The .in files in use with autotools are not processed by m4.

These .m4 files are processed by m4. For example, in setup.cfg.m4 you'll see the m4 macro call `esyscmd`.


---

Comment by dimpase created at 2022-12-07 20:22:04

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2022-12-07 20:22:04

ah, OK. I misunderstood what "processed" means in this context.


---

Comment by mkoeppe created at 2022-12-07 20:24:07

Thanks!


---

Comment by fbissey created at 2022-12-13 20:58:30

When I build the full sagelib with this ticket included (but I do not build those sub distribution yet) in sage-on-gentoo, building the documentation fails. After inspection, I have the sources installed for `sage/libs/flint`, `sage/libs/arb` etc, but none of compiled module are installed. Is there something I am missing or doing wrong?


---

Comment by mkoeppe created at 2022-12-13 21:03:43

Are you building from `src/` or from `pkgs/sagemath-standard/`?


---

Comment by fbissey created at 2022-12-13 21:07:53

`src` with the `setup.py` from `sagemath-standard`. This is when I build against develop or the Volker merging branch. The main reason I am starting from `src` in those cases, is that patch does not like links.


---

Comment by fbissey created at 2022-12-13 21:11:42

I also delete `src/sage_setup` so it is not used instead of the installed one.


---

Comment by mkoeppe created at 2022-12-13 21:24:11

OK, that's something that I'll have to fix in `pkgs/sagemath-standard/setup.py`.
Thanks for catching this


---

Comment by mkoeppe created at 2022-12-13 21:24:11

Changing status from positive_review to needs_work.


---

Comment by git created at 2022-12-14 06:56:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-12-19 05:01:48

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:
