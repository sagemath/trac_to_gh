# Issue 22622: Do not check for a zero result in arithmetics of coordinate functions and scalar fields

Issue created by migration from Trac.

Original creator: egourgoulhon

Original creation time: 2017-04-23 13:36:05

CC:  tscrim

Keywords: coordinate function, scalar field, manifold

In the arithmetics of symbolic coordinate functions (methods `sage.manifolds.coord_func_symb.CoordFunctionSymb._add_`, `_sub_`, `_mul_` and `div`), the final result (`res` below) is checked against zero as follows:

```
if res == 0:
    return self.parent().zero()
```

Now, for complicated expressions, such a check involves Maxima and is very slow. Moreover, there is no great benefit in representing all the zero functions by a unique object (the zero of the parent). This tickets proposes therefore to remove the check. 
It also removes a similar check in the arithmetics of scalar fields (class `sage.manifolds.scalarfield.ScalarField`).

The gain in performance is quite significant:
`sage -tp --long src/sage/manifolds/` (with 8 cores) yields

```
Total time for all tests: 245.9 seconds
    cpu time: 1570.5 seconds
    cumulative wall time: 1689.6 seconds
```

instead of

```
Total time for all tests: 300.5 seconds
    cpu time: 1757.9 seconds
    cumulative wall time: 1876.0 seconds
```

On computationally demanding worksheets, like the [Kerr spacetime one](http://nbviewer.jupyter.org/github/sagemanifolds/SageManifolds/blob/master/Worksheets/v1.0/SM_Kerr.ipynb), the gain is even greater: the total time for running all cells is 386 s, instead of 610 s. 

Besides, the method `is_zero` of class `CoordFunctionSymb` is replaced by a method `__bool__` (with an alias to `__nonzero__` for Python 2 compatibility), leaving the method `is_zero` only in the base class `sage.structure.element.Element`.


---

Comment by egourgoulhon created at 2017-04-23 13:40:04

Changing status from new to needs_review.


---

Comment by egourgoulhon created at 2017-04-23 13:40:04

New commits:


---

Comment by tscrim created at 2017-04-28 05:20:22

The question comes down to checking whether the element represents zero or if constructing a new 0 element is faster. There is also the `x.is_trivial_zero()`, which might catch some of the cases. Additionally, am I correct is that `is_zero` returns `not self`? Otherwise it LGTM.


---

Comment by git created at 2017-04-28 11:29:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2017-04-28 11:41:52

Replying to [comment:4 tscrim]:
> The question comes down to checking whether the element represents zero or if constructing a new 0 element is faster. 

Indeed.

>There is also the `x.is_trivial_zero()`, which might catch some of the cases.

Thanks for pointing out `is_trivial_zero()`; I've restored checks by means of this function in the above commit. For `sage -tp --long src/sage/manifolds/`, there is no noticeable difference and for the Kerr metric worksheet, the total time becomes 378 s, instead of 386 s. So I think we can buy it! 
> Additionally, am I correct is that `is_zero` returns `not self`? 

Yes, it is defined like this in `src/sage/structure/element.pyx` and it is that method which is inheritated by coordinate functions.


---

Comment by tscrim created at 2017-04-28 12:53:21

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2017-04-28 12:53:21

Ah, right, it is a subclass of `Element`. Thanks.


---

Comment by egourgoulhon created at 2017-04-28 13:24:43

Many thanks for the review!


---

Comment by vbraun created at 2017-04-29 23:30:05

Resolution: fixed
