# Issue 12051: the 'sage.rings.complex_mpc' optional extension is broken in sage-4.8.alpha3 and over

Issue created by migration from https://trac.sagemath.org/ticket/12223

Original creator: fbissey

Original creation time: 2011-12-22 18:49:27

Assignee: tbd

The optional mpc package installs fine but when I execute sage -b to built the sage code I get

```
Successfully installed mpc-0.8.3-dev-svn793
Now cleaning up tmp files.
Making Sage/Python scripts relocatable...
Finished installing mpc-0.8.3-dev-svn793.spkg
fbissey@QCD-nzi3 /home/work/fbissey/sandbox/sage-4.8.alpha4 $ ./sage -b

----------------------------------------------------------
sage: Building and installing modified Sage library files.


Installing c_lib
scons: `install' is up to date.
Updating Cython code....
Building sage/rings/complex_mpc.pyx because it depends on /home/work/fbissey/sandbox/sage-4.8.alpha4/local/include/mpc.h.
Execute 1 commands (using 1 threads)
python `which cython`  --old-style-globals --disable-function-redefinition --embed-positions --directive cdivision=True,autotestdict=False,fast_getattr=True -I/home/work/fbissey/sandbox/sage-4.8.alpha4/devel/sage-main -o sage/rings/complex_mpc.c sage/rings/complex_mpc.pyx
sage/rings/complex_mpc.pyx --> /home/work/fbissey/sandbox/sage-4.8.alpha4/local/lib/python2.6/site-packages//sage/rings/complex_mpc.pyx
Time to execute 1 commands: 3.12862586975 seconds
Finished compiling Cython code (time = 4.00216197968 seconds)
running install
running build
running build_py
running build_ext
building 'sage.rings.complex_mpc' extension
Execute 1 commands (using 1 threads)
gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -O3 -Wall -Wstrict-prototypes -fPIC -I/home/work/fbissey/sandbox/sage-4.8.alpha4/local/include -I/home/work/fbissey/sandbox/sage-4.8.alpha4/local/include/csage -I/home/work/fbissey/sandbox/sage-4.8.alpha4/devel/sage/sage/ext -I/home/work/fbissey/sandbox/sage-4.8.alpha4/local/include/python2.6 -c sage/rings/complex_mpc.c -o build/temp.linux-x86_64-2.6/sage/rings/complex_mpc.o -w
sage/rings/complex_mpc.c: In function '__pyx_pf_4sage_5rings_11complex_mpc_15MPComplexNumber_16__float__':
sage/rings/complex_mpc.c:9720:48: error: cast specifies array type
error: command 'gcc' failed with exit status 1
sage: There was an error installing modified sage library code.
```

I suspect the recent cython upgrade is responsible.


---

Comment by fbissey created at 2011-12-22 22:45:06

the faulty C code:

```
    /* "sage/rings/complex_mpc.pyx":1107
 *         if mpfr_zero_p(self.value.im):
 *             return mpfr_get_d(<mpfr_t> self.value.re,\
 *                                    rnd_re((<MPComplexField_class>self._parent).__rnd))             # <<<<<<<<<<<<<<
 *         else:
 *             raise TypeError, "can't convert complex to float; use abs(z)"
 */
    __pyx_t_2 = PyFloat_FromDouble(mpfr_get_d(((mpfr_t)((struct __pyx_obj_4sage_5rings_11complex_mpc_MPComplexNumber *)__pyx_v_self)->value->re), __pyx_f_4sage_5rings_11complex_mpc_rnd_re(((struct __pyx_obj_4sage_5rings_11complex_mpc_MPComplexField_class *)((struct __pyx_obj_4sage_5rings_11complex_mpc_MPComplexNumber *)__pyx_v_self)->__pyx_base.__pyx_base.__pyx_base.__pyx_base.__pyx_base._parent)->__pyx___rnd))); if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 1106; __pyx_clineno = __LINE__; goto __pyx_L1_error;}  <=line 9720
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_r = __pyx_t_2;
    __pyx_t_2 = 0;
    goto __pyx_L0;
    goto __pyx_L5;
  }
  /*else*/ {

    /* "sage/rings/complex_mpc.pyx":1109
 *                                    rnd_re((<MPComplexField_class>self._parent).__rnd))
 *         else:
 *             raise TypeError, "can't convert complex to float; use abs(z)"             # <<<<<<<<<<<<<<
 *
 *     def __complex__(self):
 */
    __Pyx_Raise(__pyx_builtin_TypeError, ((PyObject *)__pyx_kp_s_76), 0, 0);
    {__pyx_filename = __pyx_f[0]; __pyx_lineno = 1109; __pyx_clineno = __LINE__; goto __pyx_L1_error;}
  }
  __pyx_L5:;

  __pyx_r = Py_None; __Pyx_INCREF(Py_None);
  goto __pyx_L0;
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_AddTraceback("sage.rings.complex_mpc.MPComplexNumber.__float__", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

```



---

Comment by fbissey created at 2012-01-25 22:08:38

I am putting this to blocker since the spkg builds correctly and then because the extension is broken it breaks sage -b.


---

Comment by fbissey created at 2012-01-25 22:08:38

Changing priority from major to blocker.


---

Comment by jdemeyer created at 2012-01-31 20:35:23

Just wondering: why isn't this a standard package?  I guess complex arithmetic in Sage would benefit from it.


---

Comment by fbissey created at 2012-01-31 20:50:13

There was some discussion a while back when David Kirkby put it in shape last. If I remember correctly the gist of it was that you could do complex arithmetic some other way in sage and that there wasn't much benefits from it. I would have to dig sage-devel to find it.


---

Comment by jdemeyer created at 2012-02-15 15:56:09

Changing status from new to needs_review.


---

Attachment


---

Comment by jdemeyer created at 2012-02-15 15:56:36

See #12515 to make this a standard spkg.


---

Comment by fbissey created at 2012-02-16 02:05:34

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2012-02-16 02:05:34

Ok I tested the patch and it works. I am giving this a positive review.


---

Comment by jdemeyer created at 2012-02-22 10:45:36

Resolution: fixed
