# Issue 21680: Binomial Random Hypergraph

Issue created by migration from Trac.

Original creator: pelegm

Original creation time: 2016-11-21 19:22:07

Keywords: hypergraph,random

I have implemented binomial random hypergraph. This is my first time writing code in sage, and I would appreciate any feedback.


---

Comment by git created at 2016-11-21 19:22:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pelegm created at 2016-11-21 19:24:24

Changing status from new to needs_review.


---

Comment by pelegm created at 2016-11-22 09:31:07

Changing keywords from "hypergraph,random" to "hypergraph,random,days79".


---

Comment by slabbe created at 2016-11-23 22:45:51

Here are some comments:

1. `INPUT:` is missing

2. No empty line is needed between input items.

3. You should describe the type of the input:


```
- ``n`` -- integer, number of nodes of the graph
```


4. There *must* be `EXAMPLES::`. There can be also some `TESTS::`. I suggest to keep the limit cases inside a TEST block:


```
            sage: hypergraphs.RandomBinomialUniform(50, 3, 1).num_blocks()
            19600
            sage: hypergraphs.RandomBinomialUniform(50, 3, 0).num_blocks()
            0
```


and the one with `p=0.2` inside the `EXAMPLE` block without the call to that other `numblock` method.


```
sage: hypergraphs.RandomBinomialUniform(50, 3, 0.2)
Incidence structure with 50 points and 3915 blocks 
```


5. I think that the line `sage: set_random_seed(0)` is not necessary because the doctest framework already set the random seed so that random doctest always return the same thing...

6. Is the `seed` input only there for doctests reason? Or do you expect a human user to need this? If not, I would suggest to remove this input to the function. Also not that you can add `# random` at the end of a `sage:` line in doctests so that it only tests that no error are produced. See http://doc.sagemath.org/html/en/developer/coding_basics.html#section-further-conventions

7. In fact, I would remove `num_blocks()` everywhere in the examples. When we quickly look, we think that this methods return a integer...

8. I would suggest that you read the section http://doc.sagemath.org/html/en/developer/coding_basics.html#documentation-strings. Normally, everything that I said is explained there.

9. `(default=None)` -> `(default: `None`)`, in case you keep the seed input


---

Comment by slabbe created at 2016-11-23 22:45:51

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2016-11-24 09:54:02

Hello,

I do not understand what you are doing with the `seed` variable in your code... it is set but never used! Manipulating the random state should not be part of your function. There are Sage functions for that purpose.

Vincent


---

Comment by vdelecroix created at 2016-11-24 10:02:23

This is very inefficient if p is small

```
edges = [e for e in combinations(range(n), k) if random() < p]
```

You need to use another approach...

The cardinality of your "edge space" is binomial(n,k). What you want to do is basically pick a binomial random variable B(binomial(n,k), p) and then pick that number of sets. This can be done as follows

```
sage: S = Subsets(range(50), 5)
sage: sample(S, 10)
[{34, 38, 5, 30, 21},
 {16, 1, 35, 5, 45},
 {34, 3, 4, 5, 15},
 {9, 2, 5, 6, 47},
 {35, 20, 37, 22, 15},
 {0, 17, 42, 12, 45},
 {8, 24, 19, 13, 22},
 {36, 42, 28, 5, 29},
 {48, 17, 49, 33, 7},
 {1, 39, 29, 43, 9}]
```

Hence you just need to generate a random number distributed with binomial distribution.


---

Comment by vdelecroix created at 2016-11-24 10:28:19

And for generating binomial distribution there is at least

    https://docs.scipy.org/doc/numpy/reference/generated/numpy.random.binomial.html


---

Comment by pelegm created at 2016-11-24 12:51:37

Replying to [comment:7 vdelecroix]:

> I do not understand what you are doing with the `seed` variable in your code... it is set but never used! Manipulating the random state should not be part of your function. There are Sage functions for that purpose.

This is probably right. I do want to get `seed` as a parameter, though, to be consistent with `graphs/generators/random.py`, though. I'm just not sure what exactly to do with it.


---

Comment by pelegm created at 2016-11-24 13:15:45

`sample` yields an `OverflowError`:


```python
sage: n = 10000
sage: p = 1/n
sage: k = 17
sage: sample(Subsets(range(n), k), binomial(n, p))
Traceback (most recent call last):
  File "<ipython-input-57-6d20b3bde428>", line 1, in <module>
    sample(Subsets(range(n), k), binomial(n, p))
  File "/usr/lib/sagemath/local/lib/python2.7/site-packages/sage/misc/prandom.py", line 178, in sample
    return _pyrand().sample(population, k)
  File "/usr/lib/sagemath/local/lib/python/random.py", line 321, in sample
    n = len(population)
OverflowError: Python int too large to convert to C long
```


I am also quite worried about the fact that `numpy` probably converts `p` into a float. Not sure it should matter much, but still...

(this was tested in Sage 7.3... until I'll build 7.5beta3 properly)


---

Comment by pelegm created at 2016-11-24 13:27:42

I think the maximum number of edges in the complete uniform hypergraph that this can handle via the proposed method is roughly `1e18` (check that `xrange`, for example, fails for `1e19`).


---

Comment by vdelecroix created at 2016-11-25 12:24:15

Replying to [comment:11 pelegm]:
> `sample` yields an `OverflowError`:
> 
> {{{#!python
> sage: n = 10000
> sage: p = 1/n
> sage: k = 17
> sage: sample(Subsets(range(n), k), binomial(n, p))
> Traceback (most recent call last):
>   File "<ipython-input-57-6d20b3bde428>", line 1, in <module>
>     sample(Subsets(range(n), k), binomial(n, p))
>   File "/usr/lib/sagemath/local/lib/python2.7/site-packages/sage/misc/prandom.py", line 178, in sample
>     return _pyrand().sample(population, k)
>   File "/usr/lib/sagemath/local/lib/python/random.py", line 321, in sample
>     n = len(population)
> OverflowError: Python int too large to convert to C long
> }}}
> 
> I am also quite worried about the fact that `numpy` probably converts `p` into a float. Not sure it should matter much, but still...

I confirm the behavior on the latest beta (7.5.beta4). I don't think the conversion to float by numpy matters.

On the other hand, as we discussed in Jerusalem it would actually be simpler to have two methods:
 * one for GNM (not needing binomial)
 * one for GNP (that calls GNM with appropriate parameters)


---

Comment by dcoudert created at 2016-11-26 09:58:43

I'm also in favor of having GNM and GNP like methods.

In above example, you use `binomial(n, p)` with `p=1/k`. If p is a float, then `binomial` will raise `TypeError: either m or x-m must be an integer`.
You may try this instead `sample(Subsets(range(n), k), randint(0,binomial(n, k)))`.


Obviously, the main limitation for the maximum size of a random uniform hypergraph is not what `range` can handle but the memory of your computer. `1e9` should already be beyond what you can do.

David.


---

Comment by git created at 2016-11-26 12:55:03

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by pelegm created at 2016-11-26 12:55:19

Rebased to `develop`.


---

Comment by pelegm created at 2016-11-26 13:16:35

OK, so this is my plan for the uniform model:

```python
        if m < 0:
            raise ValueError("Number of edges must be nonnegative.")

        from sage.combinat.subset import Subsets
        all_edges = Subsets(n, k)
        max_points = len(all_edges)
        if m > max_points:
            raise ValueError("Number of edges may not exceed {}".format(
                max_points))

        from sage.misc.prandom import sample

        try:
            edges = sample(all_edges, m)

        except OverflowError:
            from sys import maxint
            from sage.functions.other import binomial

            if binomial(n, k) > maxint:
                raise OverflowError("binomial(n, k) may not exceed {}".format(
                    maxint))

            raise

        from sage.combinat.designs.incidence_structures import IncidenceStructure
        return IncidenceStructure(edges)
```


Now, for the binomial model, which function do you think I should use?

1. Import `numpy.random.binomial`, or
2. Implement `binomial` in `sage.misc.prandom` (either as a call to numpy, or copying code from numpy? I think it is implemented in C in numpy...)


---

Comment by dcoudert created at 2016-11-26 13:31:05

You have only 1 call, so this should be sufficient

```
sage: from sage.misc.prandom import randint
sage: m = randint(0, binomial(1000,17))
```



---

Comment by pelegm created at 2016-11-26 16:29:37

Replying to [comment:18 dcoudert]:
> You have only 1 call, so this should be sufficient
> {{{
> sage: from sage.misc.prandom import randint
> sage: m = randint(0, binomial(1000,17))
> }}}

This will not yield the current distribution. `randint` is uniform, rather than binomial.


---

Comment by vdelecroix created at 2016-11-26 16:52:02

Replying to [comment:17 pelegm]:
> OK, so this is my plan for the uniform model:
> [SNIP CODE]

I would actually regroup and simplify the errors (and please in the error message start with lower case and no ponctuation at the end)

```python
from sage.combinat.subset import Subsets
from sage.misc.prandom import sample
all_edges = Subsets(n, k)
try:
    edges = sample(all_edges, m)
except OverflowError:
    raise OverflowError("binomial({},{}) too large to be treated".format(n,k))
except ValueError:
    raise ValueError("number of edges m must between 0 and binomial({},{})".format(n,k))

from sage.combinat.designs.incidence_structures import IncidenceStructure
return IncidenceStructure(edges)
```

I don't think that the overflow in `sample` has to do with the second argument... It is raised (indirectly) in your example by

```
sage: len(Subsets(range(10000), 17))
Traceback (most recent call last):
...
OverflowError: Python int too large to convert to C long
```



---

Comment by pelegm created at 2016-11-26 17:21:31

Great, thanks. In the meanwhile I implement the binomial random hypergraph using NumPy's `binomial` function.  If there will be any negative comments, I'll think of a new solution.


---

Comment by vdelecroix created at 2016-11-26 17:23:39

Replying to [comment:21 pelegm]:
> Great, thanks. In the meanwhile I implement the binomial random hypergraph using NumPy's `binomial` function. If there will be any negative comments, I'll think of a new solution.

I am good with it!


---

Comment by pelegm created at 2018-06-28 15:37:01

Replying to [comment:20 vdelecroix]:
> I would actually regroup and simplify the errors (and please in the error message start with lower case and no ponctuation at the end)
> {{{#!python
> from sage.combinat.subset import Subsets
> from sage.misc.prandom import sample
> all_edges = Subsets(n, k)
> try:
>     edges = sample(all_edges, m)
> except OverflowError:
>     raise OverflowError("binomial({},{}) too large to be treated".format(n,k))
> except ValueError:
>     raise ValueError("number of edges m must between 0 and binomial({},{})".format(n,k))
> 
> from sage.combinat.designs.incidence_structures import IncidenceStructure
> return IncidenceStructure(edges)
> }}}

The problem by this implementation is that it creates a hypergraph without the isolated vertices.  This is easy to fix, I'm on it.


---

Comment by pelegm created at 2018-06-28 15:37:01

Set assignee to pelegm.


---

Comment by pelegm created at 2018-06-28 15:37:23

Changing keywords from "hypergraph,random,days79" to "hypergraph,random,days79,days94".


---

Comment by pelegm created at 2018-06-28 15:54:06

Changing status from needs_work to needs_review.


---

Comment by pelegm created at 2018-06-28 15:54:06

New commits:


---

Comment by pelegm created at 2018-06-28 15:55:49

I avoided using seed since randomness is currently using numpy's, and working with two random states seems wrong.  Wasn't sure what other tests I should add.


---

Comment by dcoudert created at 2018-06-28 16:21:04

`Retrun` -> `Return`

in method, `BinomialRandomUniform`, shouldn't you ensure that `m = nrn.binomial(binomial(n, k), p)` can be done / that it's not too large? or is it handled in `UniformRandomUniform` ?

The `TESTS` block is in fact a `EXAMPLES` block.

What if `n` or `k` or `n` are values `<= 0`? You may need specific tests for theses cases.


---

Comment by pelegm created at 2018-06-29 06:24:20

Changing status from needs_review to needs_work.


---

Comment by pelegm created at 2018-06-29 09:35:50

Replying to [comment:28 dcoudert]:
> `Retrun` -> `Return`

Thanks, will fix.
 
> in method, `BinomialRandomUniform`, shouldn't you ensure that `m = nrn.binomial(binomial(n, k), p)` can be done / that it's not too large? or is it handled in `UniformRandomUniform` ?

Indeed, for large inputs there's some weird issue in numpy I can't really understand at the moment:


```
sage: nrn.binomial(binomial(10000, 7), 0.1)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-6-d91f2b509dee> in <module>()
----> 1 nrn.binomial(binomial(Integer(10000), Integer(7)), RealNumber('0.1'))

mtrand.pyx in mtrand.RandomState.binomial()

TypeError: Cannot cast array data from dtype('O') to dtype('int64') according to the rule 'safe'
```


> The `TESTS` block is in fact a `EXAMPLES` block.
Ok.

> What if `n` or `k` or `n` are values `<= 0`? You may need specific tests for theses cases.
Will do.


---

Comment by git created at 2018-06-29 11:11:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pelegm created at 2018-06-29 11:11:28

Changing status from needs_work to needs_review.


---

Comment by dcoudert created at 2018-06-29 21:54:54

Shouldn't we put an empty line after `TESTS::` ?

Once done (or not done if not necessary), you can set this ticket to positive review for me.


---

Comment by git created at 2018-06-30 07:02:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pelegm created at 2018-06-30 07:02:51

Thanks!


---

Comment by pelegm created at 2018-06-30 07:02:51

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-07-03 23:40:23

Resolution: fixed
