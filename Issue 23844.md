# Issue 23844: Disable building Curl on OS X

Issue created by migration from https://trac.sagemath.org/ticket/24081

Original creator: jhpalmieri

Original creation time: 2017-10-20 18:00:39

Recent versions of curl, libcurl, and its headers are installed by Xcode on OS X, so we do not need to install it as part of Sage.


---

Comment by jhpalmieri created at 2017-10-20 18:11:16

As far as I can tell, curl is only used by R. With the branch here, R finds the system's curl and builds successfully with it.


---

Comment by jhpalmieri created at 2017-10-20 18:14:35

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2017-10-20 18:14:35

New commits:


---

Comment by jhpalmieri created at 2017-10-20 18:20:36

We could instead test for the curl version, and if not 7.22 or greater (because that's what R wants), build curl. I have no idea if there are old OS X systems with curl versions predating 7.22.


---

Comment by jhpalmieri created at 2017-10-20 18:21:39

In fact this might be easy: `curl-config --checkfor 7.22` should do it. Is it worth it?


---

Comment by jhpalmieri created at 2017-10-20 18:31:43

Something like this:

```diff
diff --git a/build/pkgs/curl/spkg-install b/build/pkgs/curl/spkg-install
index 1259cb7d6c..49a49f2644 100644
--- a/build/pkgs/curl/spkg-install
+++ b/build/pkgs/curl/spkg-install
@@ -13,8 +13,14 @@ if [ "$SAGE_FAT_BINARY" = yes ]; then
 fi
 
 if [ "$UNAME" = "Darwin" ]; then
-   echo "Skipping build of curl on OS X: using system's version instead."
-   exit 0
+    curl-config --checkfor 7.22 \
+        && echo "Skipping build of curl on OS X: using system's version instead." \
+        && exit 0
+   if [ $MACOSX_VERSION -ge 16 ]; then
+       echo "OS X 10.$[$MACOSX_VERSION-4] Building with clang and --with-darwinssl."
+       CC=clang
+       CURL_CONFIGURE="--with-darwinssl $CURL_CONFIGURE"
+   fi
 fi
 
 ./configure --prefix="$SAGE_LOCAL" --libdir="$SAGE_LOCAL/lib" \
```



---

Comment by jhpalmieri created at 2017-10-20 18:32:45

Then we would also have to figure out what to do in `spkg-check`.


---

Comment by jhpalmieri created at 2017-10-20 19:11:11

By the way, the optional package `cmake` depends on curl, too, and it also builds using the system library.


---

Comment by jdemeyer created at 2017-10-21 07:51:18

Preferably, these things are handled in `configure.ac` now. See `git` and `yasm` for examples.


---

Comment by jdemeyer created at 2017-10-21 07:51:18

Changing status from needs_review to needs_work.


---

Comment by jhpalmieri created at 2017-10-21 21:18:25

I don't know autoconf syntax. Is this right?

```diff
diff --git a/configure.ac b/configure.ac
index 9fa143b319..69446bf568 100644
--- a/configure.ac
+++ b/configure.ac
@@ -315,6 +315,14 @@ AC_CACHE_CHECK([for yasm], [ac_cv_path_YASM],
         [need_to_install_yasm=yes; ac_cv_path_YASM=no])],
         [ac_cv_path_YASM="not needed for $host_cpu"]))
 
+# Only install curl if we cannot find version 7.22 or later, since
+# that is what R needs.
+need_to_install_curl=no
+AC_CACHE_CHECK([for curl], [ac_cv_path_CURL], [
+    AC_PATH_PROGS_FEATURE_CHECK(CURL, [curl],
+    [${ac_path_CURL}-config --checkfor 7.22 >/dev/null 2>/dev/null && ac_cv_path_CURL=${ac_path_CURL}],
+    [need_to_install_curl=yes; ac_cv_path_CURL=no])])
+
 ###############################################################################
 # Check C/C++/Fortran compilers
 ###############################################################################
```

It seems to work, for what that's worth. Also, should we check for a curl installation in general as this does, or just on Darwin?


---

Comment by jhpalmieri created at 2017-10-21 21:22:44

By the way, right after I posted this snippet, I read the top of the file where it says to check for libraries later, so I moved the check to just before "Check header files".


---

Comment by jhpalmieri created at 2017-10-23 14:53:27

Since the OS X system curl has `SSL` as a feature, I wonder if this will also solve the problem with SSL support for `R`.


---

Comment by git created at 2017-10-24 00:02:34

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2017-10-24 00:03:29

This works for me. It checks regardless of the OS for `curl` version 7.22 or later. Or should it be OS X only?


---

Comment by jhpalmieri created at 2017-10-24 00:03:29

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2017-10-24 00:04:55

We could also add a check like `curl-config --features | grep SSL` to test for SSL support.


---

Comment by embray created at 2017-10-24 14:11:04

If this is true then doesn't this obviate a lot of the sturm und drang concerning OpenSSL support, especially on OSX?


---

Comment by jhpalmieri created at 2017-10-24 14:47:23

See comment:12. I also posted something along these lines to the sage-devel thread a day or two ago.


---

Comment by jhpalmieri created at 2017-10-24 14:49:59

I'm upgrading this to a blocker since something needs to be done with curl to build on the most recent OS X.


---

Comment by jhpalmieri created at 2017-10-24 14:49:59

Changing priority from major to blocker.


---

Comment by jhpalmieri created at 2017-10-25 05:25:41

There should be an accompanying `configure-VERSION.tar.gz` file, but I don't know how to produce that. So to test this, run `autoreconf` and then `make`...


---

Comment by jdemeyer created at 2017-10-25 08:26:15

Replying to [comment:19 jhpalmieri]:
> There should be an accompanying `configure-VERSION.tar.gz` file

Only if the changes to `configure.ac` are _required_ to build Sage with this branch, which is not the case here. In fact, such a tarball is never needed for tickets which change only `configure.ac` and nothing else.


---

Comment by jdemeyer created at 2017-10-25 08:27:27

Changing status from needs_review to needs_info.


---

Comment by jdemeyer created at 2017-10-25 08:27:27

Does Sage require the curl library or the curl program? The comment says "Check libraries" but the code checks the program...


---

Comment by jdemeyer created at 2017-10-25 08:57:10

R checks

```
checking for curl-config... /home/jdemeyer/sage/local/bin/curl-config
checking libcurl version ... 7.53.1
checking curl/curl.h usability... yes
checking curl/curl.h presence... yes
checking for curl/curl.h... yes
checking if libcurl is version 7 and >= 7.22.0... yes
```

So you should at least check the header `curl/curl.h` too.


---

Comment by jdemeyer created at 2017-10-25 08:57:10

Changing status from needs_info to needs_work.


---

Comment by jhpalmieri created at 2017-10-25 14:38:39

The page https://curl.haxx.se/libcurl/using/curl-config.html says that `curl-config` (which is what is in the code) gets information about `libcurl`. We can also check for curl/curl.h, though.


---

Comment by jdemeyer created at 2017-10-25 14:45:38

Replying to [comment:23 jhpalmieri]:
> We can also check for curl/curl.h, though.

See https://www.gnu.org/software/autoconf/manual/autoconf-2.69/html_node/Generic-Headers.html


---

Comment by git created at 2017-10-25 14:50:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2017-10-25 14:51:17

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2017-10-25 22:42:46

Rather than using `curl-config`, we could instead use `AC_CHECK_LIB([curl], function, ...)`, although I'm not sure what to use for `function`.


---

Comment by jdemeyer created at 2017-10-31 10:39:31

I don't think that you need to set `ac_cv_path_CURL` in the header check.


---

Comment by jdemeyer created at 2017-10-31 10:49:43

New commits:


---

Comment by jdemeyer created at 2017-10-31 10:51:59

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2017-10-31 10:52:12

Changing component from packages: standard to build: configure.


---

Comment by jdemeyer created at 2017-10-31 10:55:16

Replying to [comment:27 jhpalmieri]:
> Rather than using `curl-config`, we could instead use `AC_CHECK_LIB([curl], function, ...)`, although I'm not sure what to use for `function`.

Let's try the simple version first. It would be quite unlikely that `curl-config` exists but the library not.


---

Comment by jhpalmieri created at 2017-10-31 14:24:21

Great, thanks very much!


---

Comment by vbraun created at 2017-11-02 11:06:10

Resolution: fixed
