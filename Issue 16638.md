# Issue 16638: Some caching in orthogonal_array_recursive

archive/issues_016638.json:
```json
{
    "body": "CC:  vdelecroix\n\nWin some perf with a couple of improvements. Nothing fantastic, but still worth taking.\n\nNathann\n\nIssue created by migration from https://trac.sagemath.org/ticket/16875\n\n",
    "created_at": "2014-08-24T22:51:14Z",
    "labels": [
        "combinatorial designs",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "Some caching in orthogonal_array_recursive",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16638",
    "user": "ncohen"
}
```
CC:  vdelecroix

Win some perf with a couple of improvements. Nothing fantastic, but still worth taking.

Nathann

Issue created by migration from https://trac.sagemath.org/ticket/16875





---

archive/issue_comments_219368.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-08-24T23:07:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16638#issuecomment-219368",
    "user": "ncohen"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_219369.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2014-08-24T23:08:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16638#issuecomment-219369",
    "user": "ncohen"
}
```

Last 10 new commits:



---

archive/issue_comments_219370.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-08-25T00:54:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16638#issuecomment-219370",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_219371.json:
```json
{
    "body": "Hello,\n\nWhat we win with my first commit is impressive!\n\nAbout your commit: I do not like the fact that we cache twice the same data. `_OA_cache` already contains everything.\n\nVincent",
    "created_at": "2014-08-25T01:00:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16638#issuecomment-219371",
    "user": "vdelecroix"
}
```

Hello,

What we win with my first commit is impressive!

About your commit: I do not like the fact that we cache twice the same data. `_OA_cache` already contains everything.

Vincent



---

archive/issue_comments_219372.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2014-08-25T01:00:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16638#issuecomment-219372",
    "user": "vdelecroix"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_219373.json:
```json
{
    "body": "Yo !\n\n> What we win with my first commit is impressive!\n\nThe imports.... `T_T`\n\nAnd they don't even appear in %prun `T_T`\n\n> About your commit: I do not like the fact that we cache twice the same data. `_OA_cache` already contains everything.\n\nWell, do you like the timings ? Actually, it seems that your removing the imports was an important part of why the recursive functions were so slow. With your modification my caching only saves one second over the 10 that it takes to build the table up to 1000, but well... I think it's worth keeping anyway. And perhaps we will remove that when everything will be in Cython for it will not save anything anymore.\n\nNathann",
    "created_at": "2014-08-25T08:52:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16638#issuecomment-219373",
    "user": "ncohen"
}
```

Yo !

> What we win with my first commit is impressive!

The imports.... `T_T`

And they don't even appear in %prun `T_T`

> About your commit: I do not like the fact that we cache twice the same data. `_OA_cache` already contains everything.

Well, do you like the timings ? Actually, it seems that your removing the imports was an important part of why the recursive functions were so slow. With your modification my caching only saves one second over the 10 that it takes to build the table up to 1000, but well... I think it's worth keeping anyway. And perhaps we will remove that when everything will be in Cython for it will not save anything anymore.

Nathann



---

archive/issue_comments_219374.json:
```json
{
    "body": "Another proposition at `public/16875-bis`. I implemented a `orthogonal_array_available` and hence avoid the double caching. I really do **not** like the fact that we cache twice the same information.\n\nVincent",
    "created_at": "2014-08-25T10:07:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16638#issuecomment-219374",
    "user": "vdelecroix"
}
```

Another proposition at `public/16875-bis`. I implemented a `orthogonal_array_available` and hence avoid the double caching. I really do **not** like the fact that we cache twice the same information.

Vincent



---

archive/issue_comments_219375.json:
```json
{
    "body": "Yo !\n\nYou may not like this additional caching (1Mb or RAM ? Yes I understand, that can be a problem) but what I do not like are public functions like yours with \"the hack I need for my own code\" that checks consecutive values. You just don't write that in a user-exposed function.\n\nHere is a proposition: your two commits here are good and are useful, se we need them now. If this Mb of caching is a problem for you then we can remove it from this ticket and let it go like that.\n\nYour function `orthogonal_array_available` looks a lot like the function `is_available(k,n_` I proposed to implement earlier in a \"designs.orthogonal_arrays\" orbject, along with `build(k,n)`, `best_k(n)`, etc... So if we have to do something like that we will do it properly with such functions.\n\nI will also use the chance to convert the caching system to pure Cython, so that it will become a simple array lookup, nothing more complicated.\n\nWe can also keep this caching thing in the meantime, it's up to you.\n\nTell me and I will start writing the code.\n\nNathann",
    "created_at": "2014-08-25T11:27:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16638#issuecomment-219375",
    "user": "ncohen"
}
```

Yo !

You may not like this additional caching (1Mb or RAM ? Yes I understand, that can be a problem) but what I do not like are public functions like yours with "the hack I need for my own code" that checks consecutive values. You just don't write that in a user-exposed function.

Here is a proposition: your two commits here are good and are useful, se we need them now. If this Mb of caching is a problem for you then we can remove it from this ticket and let it go like that.

Your function `orthogonal_array_available` looks a lot like the function `is_available(k,n_` I proposed to implement earlier in a "designs.orthogonal_arrays" orbject, along with `build(k,n)`, `best_k(n)`, etc... So if we have to do something like that we will do it properly with such functions.

I will also use the chance to convert the caching system to pure Cython, so that it will become a simple array lookup, nothing more complicated.

We can also keep this caching thing in the meantime, it's up to you.

Tell me and I will start writing the code.

Nathann



---

archive/issue_comments_219376.json:
```json
{
    "body": "Hello,\n\n> You may not like this additional caching (1Mb or RAM ? Yes I understand, that can be a problem) but what I do not like are public functions like yours with \"the hack I need for my own code\" that checks consecutive values. You just don't write that in a user-exposed function.\n\nBecause your caching is not \"the hack I need for my own code\"? Moreover, in my `orthogonal_array_available` it makes not a big difference to remove the `mult` parameter. And if you prefer, I can set the name to `_orthogonal_array_available`. My problem is not the fact that you use memory, but the fact that you cache twice the same data.\n\nThe simplest would be to let this ticket go without `_cache_m_zero_one_two` and without `orthogonal_array_available`. And it is clear that the good solution would be to implement the Cython version of the function you suggest: `is_available`.\n\nVincent",
    "created_at": "2014-08-25T11:40:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16638#issuecomment-219376",
    "user": "vdelecroix"
}
```

Hello,

> You may not like this additional caching (1Mb or RAM ? Yes I understand, that can be a problem) but what I do not like are public functions like yours with "the hack I need for my own code" that checks consecutive values. You just don't write that in a user-exposed function.

Because your caching is not "the hack I need for my own code"? Moreover, in my `orthogonal_array_available` it makes not a big difference to remove the `mult` parameter. And if you prefer, I can set the name to `_orthogonal_array_available`. My problem is not the fact that you use memory, but the fact that you cache twice the same data.

The simplest would be to let this ticket go without `_cache_m_zero_one_two` and without `orthogonal_array_available`. And it is clear that the good solution would be to implement the Cython version of the function you suggest: `is_available`.

Vincent



---

archive/issue_comments_219377.json:
```json
{
    "body": "Changing status from needs_info to positive_review.",
    "created_at": "2014-08-25T11:54:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16638#issuecomment-219377",
    "user": "ncohen"
}
```

Changing status from needs_info to positive_review.



---

archive/issue_comments_219378.json:
```json
{
    "body": "Yo !\n\n> Because your caching is not \"the hack I need for my own code\"?\n\nMy function is cached and is named `_cache_m_zero_k_m`. It *SCREAMS* that it is not meant for users. Yours is named \"orthogonal_arrayy_available\" and supports a weird parameters aboit consecutive values.\n\n> Moreover, in my `orthogonal_array_available` it makes not a big difference to remove the `mult` parameter. And if you prefer, I can set the name to `_orthogonal_array_available`. My problem is not the fact that you use memory, but the fact that you cache twice the same data.\n\nYou have nothing when the data being stored is 99% of useless pointers because it's dictionaries toward Integer objects, or when you store numbers between 0 and 1000 ont 64-bits integers, but it becomes a problem when instead of the useless data you store twice the same thing ? `:-P`\n\n> The simplest would be to let this ticket go without `_cache_m_zero_one_two` and without `orthogonal_array_available`. And it is clear that the good solution would be to implement the Cython version of the function you suggest: `is_available`.\n\nOkay ! Then I update this branch in a second and give it a positive review (all the code is yours). And I will begin to write this is_availabe function in a second, everything in Cython. Let's hope that it will make a big difference !\n\nNathann",
    "created_at": "2014-08-25T11:54:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16638#issuecomment-219378",
    "user": "ncohen"
}
```

Yo !

> Because your caching is not "the hack I need for my own code"?

My function is cached and is named `_cache_m_zero_k_m`. It *SCREAMS* that it is not meant for users. Yours is named "orthogonal_arrayy_available" and supports a weird parameters aboit consecutive values.

> Moreover, in my `orthogonal_array_available` it makes not a big difference to remove the `mult` parameter. And if you prefer, I can set the name to `_orthogonal_array_available`. My problem is not the fact that you use memory, but the fact that you cache twice the same data.

You have nothing when the data being stored is 99% of useless pointers because it's dictionaries toward Integer objects, or when you store numbers between 0 and 1000 ont 64-bits integers, but it becomes a problem when instead of the useless data you store twice the same thing ? `:-P`

> The simplest would be to let this ticket go without `_cache_m_zero_one_two` and without `orthogonal_array_available`. And it is clear that the good solution would be to implement the Cython version of the function you suggest: `is_available`.

Okay ! Then I update this branch in a second and give it a positive review (all the code is yours). And I will begin to write this is_availabe function in a second, everything in Cython. Let's hope that it will make a big difference !

Nathann



---

archive/issue_comments_219379.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:",
    "created_at": "2014-08-25T11:55:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16638#issuecomment-219379",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:



---

archive/issue_comments_219380.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2014-08-25T11:55:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16638#issuecomment-219380",
    "user": "git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_219381.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-08-25T12:10:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16638#issuecomment-219381",
    "user": "vdelecroix"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_219382.json:
```json
{
    "body": "(set back to positive review as a push changes the status)",
    "created_at": "2014-08-25T12:10:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16638#issuecomment-219382",
    "user": "vdelecroix"
}
```

(set back to positive review as a push changes the status)



---

archive/issue_comments_219383.json:
```json
{
    "body": "Thanks !\n\nNathann",
    "created_at": "2014-08-25T15:28:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16638#issuecomment-219383",
    "user": "ncohen"
}
```

Thanks !

Nathann



---

archive/issue_comments_219384.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-08-25T19:36:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16638",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16638#issuecomment-219384",
    "user": "vbraun"
}
```

Resolution: fixed
