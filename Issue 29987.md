# Issue 29987: Fix configure quiet mode as it lets a few things through

Issue created by migration from https://trac.sagemath.org/ticket/30224

Original creator: slelievre

Original creation time: 2020-07-26 16:29:22

CC:  mkoeppe slelievre dimpase mjo

Keywords: quiet

In a fresh git clone of Sage 9.2.beta6, `./configure -q`
printed two lines to stdout and one to stderr.

```
$ ./configure -q
11.4.3
1.5.3
(ignoring conda because no environment is active) $
```


To figure out where these come from, I ran `./configure`
in non-quiet mode, redirecting stdout to a file:

```
$ ./configure > dot-slash-configure-output.txt
(ignoring conda because no environment is active) $
```

and again, redirecting both stdout and stderr to a file:

```
$ ./configure > dot-slash-configure-output.txt
$
```


The corresponding lines when running without `-q` seem to be:

```
...
Checking whether SageMath should install SPKG ntl...
...
checking NTL version >= 10.3... 11.4.3
...
Checking whether SageMath should install SPKG mpfi...
...
checking MPFI version >= 1.5... 1.5.3
...
checking for the package system in use... (ignoring conda
because no environment is active) homebrew
...
```

The `(ignoring conda ...)` part seems to go to stderr instead of stdout.

Initial report:

- [sage-devel post, 2020-07-26](https://groups.google.com/d/topic/sage-devel/TRdqXvmDISA/discussion)


---

Comment by git created at 2020-07-26 17:30:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-26 17:33:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-26 17:40:30

Changing status from new to needs_review.


---

Comment by slelievre created at 2020-07-29 16:00:40

Changing status from needs_review to needs_work.


---

Comment by slelievre created at 2020-07-29 16:00:40

I see no improvement after applying this branch.

This is on macOS:

```
$ git checkout develop
$ make distclean
$ git trac try 30224
$ ./configure -q
11.4.3
1.5.3
(ignoring conda because no environment is active) $
```



---

Comment by mkoeppe created at 2020-07-29 17:20:31

Did you run `./bootstrap`?


---

Comment by slelievre created at 2020-07-29 19:15:43

Changing status from needs_work to positive_review.


---

Comment by slelievre created at 2020-07-29 19:15:43

I did not know to run `./bootstrap` and don't know much about it.

I thought `./bootstrap` was automatically run by `./configure`.

I guess that is what happens on a fresh clone.

Now I realise `make distclean` does not clean all the way to the fresh clone state.

Thanks to your hint I now ran the following and quiet mode works!

```
$ ./bootstrap
src/doc/bootstrap:52: installing src/doc/en/installation/arch.txt and src/doc/en/installation/arch-optional.txt
src/doc/bootstrap:52: installing src/doc/en/installation/debian.txt and src/doc/en/installation/debian-optional.txt
src/doc/bootstrap:52: installing src/doc/en/installation/fedora.txt and src/doc/en/installation/fedora-optional.txt
src/doc/bootstrap:52: installing src/doc/en/installation/cygwin.txt and src/doc/en/installation/cygwin-optional.txt
src/doc/bootstrap:52: installing src/doc/en/installation/homebrew.txt and src/doc/en/installation/homebrew-optional.txt
src/doc/bootstrap:59: installing src/doc/en/reference/spkg/*.rst
src/doc/bootstrap:89: installing src/doc/en/reference/repl/options.txt
bootstrap:69: installing 'config/config.rpath'
configure.ac:314: installing 'config/compile'
configure.ac:89: installing 'config/config.guess'
configure.ac:89: installing 'config/config.sub'
configure.ac:43: installing 'config/install-sh'
configure.ac:43: installing 'config/missing'
$ ./configure -q
$
```


Positive review from me but please anyone more knowledgeable have a look too.


---

Comment by mkoeppe created at 2020-07-29 19:39:33

Thanks!


---

Comment by mkoeppe created at 2020-07-29 19:42:35

Replying to [comment:8 slelievre]:
> I thought `./bootstrap` was automatically run by `./configure`.

`configure` does not run it, but `make` runs it when the `configure` script does not exist or is older than its sources files (`configure.ac` and various stuff in `m4`, `build/pkgs`).


---

Comment by mjo created at 2020-07-30 23:21:37

Two comments:

1. The MPFI/NTL checks don't need to print anything at all. Could we simply delete the `prinf()` calls there instead of sending them to stderr, since they're not errors?

2. The output from sage-guess-package-system doesn't look like an error to me, it's more informational. Maybe it should just be printed to stdout as well? Especially if the solution is going to be to redirect it again...


---

Comment by mkoeppe created at 2020-07-30 23:51:19

Replying to [comment:11 mjo]:
> 1. The MPFI/NTL checks don't need to print anything at all. Could we simply delete the `prinf()` calls there instead of sending them to stderr, since they're not errors?

It ends up in config.log, where I think it is valuable.

> 2. The output from sage-guess-package-system doesn't look like an error to me, it's more informational. Maybe it should just be printed to stdout as well? Especially if the solution is going to be to redirect it again...

It is crucial to separate the two types of output -- the package system and the information message -- because the package system is also processed by a script. The information message is for humans.


---

Comment by mjo created at 2020-07-31 00:21:30

Replying to [comment:12 mkoeppe]:
> Replying to [comment:11 mjo]:
> > 1. The MPFI/NTL checks don't need to print anything at all. Could we simply delete the `prinf()` calls there instead of sending them to stderr, since they're not errors?
> 
> It ends up in config.log, where I think it is valuable.

In that case, we could send them directly to `AS_MESSAGE_FD` or `AS_MESSAGE_LOG_FD` instead of passing through `stderr`? I'm not 100% sure what goes on with all of the output/error descriptors in autotools, but some day someone may want to redirect stdout/stderr to separate files and it would be nice if stderr didn't contain normal output from the "checking..." results.


---

Comment by mkoeppe created at 2020-07-31 00:27:53

Replying to [comment:13 mjo]:
> Replying to [comment:12 mkoeppe]:
> > Replying to [comment:11 mjo]:
> > > 1. The MPFI/NTL checks don't need to print anything at all. Could we simply delete the `prinf()` calls there instead of sending them to stderr, since they're not errors?
> > 
> > It ends up in config.log, where I think it is valuable.
> 
> In that case, we could send them directly to `AS_MESSAGE_FD` or `AS_MESSAGE_LOG_FD` instead of passing through `stderr`? I'm not 100% sure what goes on with all of the output/error descriptors in autotools [...]

You can learn about them here:
https://www.gnu.org/software/autoconf/manual/autoconf-2.60/html_node/File-Descriptor-Macros.html

I am using it as documented.


---

Comment by mjo created at 2020-07-31 00:46:52

What I'm unsure of is the bigger picture of what check output gets redirected where. The version number printed by the two test programs is arguably part of the "checking..." output, and should ultimately be sent to `AS_MESSAGE_FD`. Apparently that doesn't happen right now, otherwise this ticket wouldn't exist, so `stdout` within `AC_RUN_IFELSE` must wind up somewhere other than `AS_MESSAGE_FD`. How printing to `stderr` fixes the issue is what's unclear to me; does `stderr` from within the `AC_RUN_IFELSE` macro get redirected to `AS_MESSAGE_FD`? Or just somewhere else that happens to work out?

What I was suggesting is that within those two test programs, we use `AS_MESSAGE_FD` instead of the constant `stderr`. I think that will still solve the problem, because that's what you're doing for the conda warning. It's also more explicit and doesn't rely on whatever magic causes `stderr` within `AC_RUN_IFELSE` to get redirected to someplace that winds up in config.log but not the console when `-q` is given.


---

Comment by mkoeppe created at 2020-07-31 01:08:33

Replying to [comment:15 mjo]:
> What I'm unsure of is the bigger picture of what check output gets redirected where. The version number printed by the two test programs is arguably part of the "checking..." output, and should ultimately be sent to `AS_MESSAGE_FD`.

Yes, all messages that should be shown to the user need to be sent to `AS_MESSAGE_FD`. That's what all the autoconf macros for printing do.

> Apparently that doesn't happen right now, otherwise this ticket wouldn't exist, so `stdout` within `AC_RUN_IFELSE` must wind up somewhere other than `AS_MESSAGE_FD`. How printing to `stderr` fixes the issue is what's unclear to me; does `stderr` from within the `AC_RUN_IFELSE` macro get redirected to `AS_MESSAGE_FD`? 

`AC_RUN_IFELSE` redirects stderr to `AS_MESSAGE_LOG_FD`. This is how compiler warnings/errors end up in `config.log`. I have the test program print to stderr for this reason. Neither compilers nor test programs have any business of printing to stdout. `AC_RUN_IFELSE` does not redirect stdout.

> What I was suggesting is that within those two test programs, we use `AS_MESSAGE_FD` instead of the constant `stderr`. 

No, I want it to go the log, not to the terminal: At the terminal, only "yes" or "no" is needed. The user will need the detail of what specific version was found (and determined to be insufficient) only for diagnostic purposes; hence, the log. So `AS_MESSAGE_LOG_FD`, not `AS_MESSAGE_FD`.


---

Comment by mjo created at 2020-07-31 02:08:58

Replying to [comment:16 mkoeppe]:
> So `AS_MESSAGE_LOG_FD`, not `AS_MESSAGE_FD`.

I was thinking of


```
fprintf((FILE*)]]AS_MESSAGE_LOG_FD[[,...
```


but now that I've tried it, it was nonsense to begin with. The file descriptor from the parent shell is meaningless in the newly-compiled program, and we don't have a way to append `>&AS_MESSAGE_LOG_FD` to the command-line. So everything's fine here.


---

Comment by mkoeppe created at 2020-07-31 02:20:00

Replying to [comment:17 mjo]:
> The file descriptor from the parent shell is meaningless in the newly-compiled program, and we don't have a way to append `>&AS_MESSAGE_LOG_FD` to the command-line.

That's right.

Glad to clear this up!


---

Comment by slelievre created at 2020-08-03 01:39:50

On Debian 10 "buster" I observed one more such "leak" when

```
checking whether we have a properly patched Symmetrica version... 
```

which outputs blocks of size 1x1, 2x2, 3x3, 5x5, 7x7 looking like

```
[1:0:0]
[1:1:0]
[1:2:1]
```

Fix that here or in a follow-up ticket?


---

Comment by slelievre created at 2020-08-03 01:48:56

The file `build/pkgs/symmetrica/spkg-configure.m4` is not similar
enough to the NTL and MPFI ones that I can figure out a fix.
In passing, its indentation mixes tabs and spaces.


---

Comment by dimpase created at 2020-08-03 09:28:08

Replying to [comment:21 slelievre]:
> The file `build/pkgs/symmetrica/spkg-configure.m4` is not similar
> enough to the NTL and MPFI ones that I can figure out a fix.
> In passing, its indentation mixes tabs and spaces.

the output is done by symmetrica's function `println()`. A hopefully suitable replacement is called `fprintln()` - I never tried it, but you're welcome to dig up the docs on it and try.


---

Comment by slelievre created at 2020-08-03 14:28:10

Thanks Dima, I tried and indeed, on top of previous changes on this ticket, changing line 18 of file `build/pkgs/symmetrica/spkg-configure.m4` as follows

```
-            [println(b);]
+            [fprintln(stderr, b);]
```

does the trick. Should I push a commit here or in a new ticket depending on this one?


---

Comment by dimpase created at 2020-08-03 16:14:48

Replying to [comment:23 slelievre]:
> Thanks Dima, I tried and indeed, on top of previous changes on this ticket, changing line 18 of file `build/pkgs/symmetrica/spkg-configure.m4` as follows
> {{{
> -            [println(b);]
> +            [fprintln(stderr, b);]
> }}}
> does the trick. Should I push a commit here or in a new ticket depending on this one?

A new ticket with the branch based on this one is better.


---

Comment by slelievre created at 2020-08-03 17:34:44

I opened #30282 for `build/pkgs/symmetrica/spkg-configure.m4`.


---

Comment by vbraun created at 2020-08-07 19:07:26

Resolution: fixed
