# Issue 16143: improve startup time of libGAP

Issue created by migration from https://trac.sagemath.org/ticket/16380

Original creator: dimpase

Original creation time: 2014-05-20 09:44:13

CC:  vbraun ncohen wdj

Keywords: libgap, startup time

currently libGAP loads slower than GAP with pexpect interface. 

```
$ ./sage --nodotsage
 Sage Version 6.3.beta1, Release Date: 2014-05-13                   │
sage: 
sage: gap("1")
1
sage: 
Exiting Sage (CPU time 0m0.22s, Wall time 0m21.87s).
Exiting spawned Gap process.
nash:sage dima$ ./sage --nodotsage
Sage Version 6.3.beta1, Release Date: 2014-05-13                   │
sage: libgap("1")
"1"
sage: 
Exiting Sage (CPU time 0m7.06s, Wall time 0m16.95s).
```


About extra 7 sec on a Core2 `x86_64` machine, at least according to the CPU time report, which might be lying(?).


---

Comment by dimpase created at 2014-05-20 09:56:35

in view of `--nodotsage` used, no prebuilt GAP workspace is loaded, thus
https://bitbucket.org/vbraun/libgap/issue/2/workspace-support
is probably not directly related.


---

Comment by dimpase created at 2014-05-20 22:35:33

Why is `libgap` linked to `libgmp` rather than  to `libmpir` (which are copies of each other, as far as I can tell) ? My understanding is that   `libmpir` is already loaded at Sage startup, while `libgmp` is not. If we are hit by `dlopen` slowness, this might be something to consider changing.


---

Comment by dimpase created at 2014-05-22 14:26:17

Replying to [comment:1 dimpase]:
> in view of `--nodotsage` used, no prebuilt GAP workspace is loaded, thus
> https://bitbucket.org/vbraun/libgap/issue/2/workspace-support
> is probably not directly related.

I should retract this, my timings were off. Now I bet that it really is the main problem of slowness on startup.


---

Comment by dimpase created at 2014-07-22 12:47:41

The workspace to load should be created by `libGAP`, and not by "normal" `GAP`. Then it all works.

Should we mimic the way "normal" GAP deals with the workspaces? Or are there other/better ideas?


---

Comment by vbraun created at 2014-07-23 02:19:33

Changing status from new to needs_review.


---

Comment by vbraun created at 2014-07-23 02:19:33

This works for me...
----
New commits:


---

Comment by vbraun created at 2014-07-23 02:20:45

PS: 7 seconds!?! Time to get one of those SSDs ;-)


---

Comment by tscrim created at 2014-07-23 06:42:07

Goes from ~20s to under 1s (after the second run). This will speed up development for Lie theory and Weyl groups significantly.


---

Comment by tscrim created at 2014-07-23 06:42:07

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2014-07-23 08:24:00

Shouldn't installaing extra GAP packages (in `database_gap` and in `gap_packages`) trigger libgap workspace updates?


---

Comment by vbraun created at 2014-07-23 14:11:17

It does right now because you get the "Forcing sage-location, probably because a new package was installed." which touches `libgap.la`. Which, in turn, invalidates the saved workspace. Though that is not a good mechanism, and we probably want to get rid of the sage-location thing. There should be a generic hook to delete cached stuff after installing of packages, but afaik there is none. The GAP interface has the same problem, I think.


---

Comment by vbraun created at 2014-07-23 14:29:10

Also, the extra packages are not loaded into the saved libgap workspace. Regardless of whether they are installed or not.


---

Comment by vbraun created at 2014-07-23 17:31:32

Resolution: fixed
