# Issue 31387: fedora-34-standard: eclib, singular build failures with system ntl

Issue created by migration from https://trac.sagemath.org/ticket/31624

Original creator: mkoeppe

Original creation time: 2021-04-08 17:32:06

CC:  dimpase @jamesjer fbissey enriqueartal mjo malb

from https://groups.google.com/g/sage-release/c/6WjKQt_e_B8/m/dpx1qILOCwAJ (for 9.3.rc2):

9.3.beta8> fedora-34-standard:
9.3.beta8>   [eclib-20190909]   /usr/bin/ld: /usr/lib64/libntl.so: undefined reference to `std::__exception_ptr::exception_ptr::_M_release()`@`CXXABI_1.3.13'

fedora-34-standard eclib problem is unchanged in 9.3.rc2, and also issues with ntl show up in singular


---

Comment by mkoeppe created at 2021-05-06 18:26:05

As noted in #29703, upgrading our gcc spkg to 10.3 does not fix this issue.

So we should probably improve our `ntl/spkg-configure.m4` to make sure that it is usable. (Related: #31578, which will also modify `ntl/spkg-configure.m4`


---

Comment by mkoeppe created at 2021-05-06 18:27:32

Changing priority from major to critical.


---

Comment by mkoeppe created at 2021-05-06 18:40:52

As I wrote in https://groups.google.com/g/sage-release/c/PAeKAGNJIJA/m/guT9UeiYAgAJ, we could just have ntl's `spkg-configure.m4` reject system NTL if we reject system gcc.
I'm preparing a patch for this


---

Comment by mkoeppe created at 2021-05-06 18:40:52

Changing priority from critical to blocker.


---

Comment by mkoeppe created at 2021-05-06 18:52:13

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-05-06 18:52:13

New commits:


---

Comment by mkoeppe created at 2021-05-06 19:42:29

Also: 

```
  [ipykernel-5.2.1] error installing, exit status 1. End of log file:
  [ipykernel-5.2.1]       File "/sage/local/lib64/python3.9/site-packages/zmq/backend/cython/__init__.py", line 6, in <module>
  [ipykernel-5.2.1]         from . import (constants, error, message, context,
  [ipykernel-5.2.1]     ImportError: /sage/local/lib/libstdc++.so.6: version `GLIBCXX_3.4.29' not found (required by /lib64/libzmq.so.5)
  [ipykernel-5.2.1]     Building wheel for ipykernel (PEP 517): finished with status 'error'
  [ipykernel-5.2.1]     ERROR: Failed building wheel for ipykernel
  [ipykernel-5.2.1]   Failed to build ipykernel
```



---

Comment by git created at 2021-05-06 19:44:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-05-06 23:57:30

With these changes, `make build` succeeds.
But building the documentation reveals another error:

```
[dochtml]   File "sage/matrix/matrix_modn_sparse.pyx", line 1, in init sage.matrix.matrix_modn_sparse (build/cythonized/sage/matrix/matrix_modn_sparse.cpp:17097)
[dochtml]   File "sage/matrix/matrix_integer_sparse.pyx", line 1, in init sage.matrix.matrix_integer_sparse (build/cythonized/sage/matrix/matrix_integer_sparse.cpp:17107)
[dochtml]   File "sage/matrix/matrix_integer_dense.pyx", line 1, in init sage.matrix.matrix_integer_dense (build/cythonized/sage/matrix/matrix_integer_dense.cpp:57743)
[dochtml] ImportError: /sage/local/lib/libstdc++.so.6: version `GLIBCXX_3.4.29' not found (required by /lib64/libvmaf.so.0)
```



---

Comment by git created at 2021-05-07 06:57:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by enriqueartal created at 2021-05-07 18:46:56

I found this error while building, I think that `--with-system-libgd=no --with-system-brial=no` (at least one of them) in `./configure` did work.

Replying to [comment:11 mkoeppe]:
> With these changes, `make build` succeeds.
> But building the documentation reveals another error:
> {{{
> [dochtml]   File "sage/matrix/matrix_modn_sparse.pyx", line 1, in init sage.matrix.matrix_modn_sparse (build/cythonized/sage/matrix/matrix_modn_sparse.cpp:17097)
> [dochtml]   File "sage/matrix/matrix_integer_sparse.pyx", line 1, in init sage.matrix.matrix_integer_sparse (build/cythonized/sage/matrix/matrix_integer_sparse.cpp:17107)
> [dochtml]   File "sage/matrix/matrix_integer_dense.pyx", line 1, in init sage.matrix.matrix_integer_dense (build/cythonized/sage/matrix/matrix_integer_dense.cpp:57743)
> [dochtml] ImportError: /sage/local/lib/libstdc++.so.6: version `GLIBCXX_3.4.29' not found (required by /lib64/libvmaf.so.0)
> }}}
> 
>


---

Comment by mkoeppe created at 2021-05-07 18:48:59

I already did the `libgd` above and just ran into the `brial` issue too.


---

Comment by git created at 2021-05-07 18:50:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-05-07 19:11:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-05-07 19:51:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-05-07 20:30:55

With this I am running into an fplll build error:

```
[fplll-5.4.0] libtool: link: g++ -std=c++11 -O2 -g -fPIC -I/sage/local/include/ -Wl,-rpath-link -Wl,/sage/local/lib -Wl,-rpath -Wl,/sage/local/lib -o .libs/fplll main.o  -L/sage/local/lib ./.libs/libfplll.so -lmpfr -lgmp -pthread -Wl,-rpath -Wl,/sage/local/lib
[fplll-5.4.0] libtool: link: g++ -std=c++11 -O2 -g -fPIC -I/sage/local/include/ -Wl,-rpath-link -Wl,/sage/local/lib -Wl,-rpath -Wl,/sage/local/lib -o .libs/latticegen latticegen.o  -L/sage/local/lib ./.libs/libfplll.so -lmpfr -lgmp -pthread -Wl,-rpath -Wl,/sage/local/lib
[fplll-5.4.0] /usr/bin/ld: /usr/lib64/libqd.so.0: undefined reference to `std::__istream_extract(std::istream&, char*, long)@GLIBCXX_3.4.29'
[fplll-5.4.0] collect2: error: ld returned 1 exit status
[fplll-5.4.0] make[6]: *** [Makefile:1119: latticegen] Error 1
[fplll-5.4.0] make[6]: *** Waiting for unfinished jobs....
[fplll-5.4.0] /usr/bin/ld: /usr/lib64/libqd.so.0: undefined reference to `std::__istream_extract(std::istream&, char*, long)@GLIBCXX_3.4.29'
[fplll-5.4.0] collect2: error: ld returned 1 exit status
```



---

Comment by mkoeppe created at 2021-05-07 20:44:46

We do not have an spkg for qd -- so we cannot fix this problem with spkg-configure.
Opened #31792 for adding a package for it


---

Comment by git created at 2021-05-07 23:06:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-05-08 00:21:36

This version works for me.
Let's get it into Sage 9.3 please


---

Comment by dimpase created at 2021-05-08 09:25:25

as #29703 is a dependency with 9.4 milestone, it does not seem to make sense to insist on 9.3 milestone here.


---

Comment by mkoeppe created at 2021-05-08 15:46:42

I forgot to remove the dependency.


---

Comment by vbraun created at 2021-05-09 08:22:16

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-05-09 15:12:09

Thanks!


---

Comment by vbraun created at 2021-05-09 20:34:38

Resolution: fixed


---

Comment by enriqueartal created at 2021-05-27 07:22:50

I am not sure if it is related to this ticket, but I get a persistent error compiling libgd in 9.4.beta0 in Fedora 34: 

/usr/bin/ld: /usr/lib64/libvmaf.so.0: undefined reference to `std::__throw_bad_array_new_length()`@`GLIBCXX_3.4.29'

For 9.3 ./configure --with-system-zeromq=no --with-system-eclib=no --with-system-flint=no --with-system-flintqs=no --with-system-ntl=no --with-system-libgd=no --with-system-brial=no was ok


---

Comment by dimpase created at 2021-05-27 11:06:07

Replying to [comment:28 enriqueartal]:
> I am not sure if it is related to this ticket, but I get a persistent error compiling libgd in 9.4.beta0 in Fedora 34: 

can't you just use the system libgd?


---

Comment by enriqueartal created at 2021-05-28 05:57:29

Replying to [comment:29 dimpase]:
> Replying to [comment:28 enriqueartal]:
> > I am not sure if it is related to this ticket, but I get a persistent error compiling libgd in 9.4.beta0 in Fedora 34: 
> 
> can't you just use the system libgd?
> 
Even after ./configure --with-system-libgd=yes it tries to compile libgd-2.3.2


---

Comment by mkoeppe created at 2021-05-28 06:09:17

`libgd` is rejected because of g++11. Unfortunately building `libgd` ourselves appears to create similar issues with other libraries that are (optional) dependencies (not shipped with Sage). The best way to fix this is to fix the remaining issues that block our use of system gcc 11 (#31786). We could also try to fix up our `libgd` install scripts (see #27901)
