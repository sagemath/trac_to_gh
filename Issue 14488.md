# Issue 14488: Fix hardcoded 'make' in NTL's build scripts

Issue created by migration from Trac.

Original creator: leif

Original creation time: 2013-06-05 19:20:48

Assignee: leif

CC:  jpflori

Keywords: spkg

Fixed spkg on the way...


---

Comment by leif created at 2013-06-05 20:50:25

Diff between the `.p0` and the `.p1`.  For reference / review only.


---

Attachment


---

Comment by leif created at 2013-06-05 20:57:12

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2013-06-06 09:17:10

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2013-06-06 09:17:10

I think it would be much better to have just one patch fixing this issue, instead of 3 (one per file). This makes it easier to document what the patch does (`SPKG.txt` should mention this patch).

Also, having just one patch makes it easier to report upstream (which should be done).


---

Comment by jpflori created at 2013-06-06 09:21:34

Same feeling as Jeroen.
If you also feel like contacting Shoup to integrate all of our patches, please go ahead :)


---

Comment by leif created at 2013-06-06 15:09:44

That's (to some extent) a matter of taste, although I actually prefer [cumulative] patches with "verbose names", too.  (It only sometimes gets messy when different patches patch the same files, and especially when they're applied in some "random" order.) 

But there was already `patches/mfile.patch` (fixing Cygwin stuff<sup>*</sup>), so I followed the scheme that was already there.

----

<sup>*</sup> Does anyone recall OTOH who added that?  XD


---

Comment by jpflori created at 2013-06-06 15:17:19

I guess I'm the culprit for the Cygwin patch...
As all the previous patches only have one purpose and touch only one file, it may be a good time to rename them, DoConfig and mfile are not really talkative.

Of course patching the same file multiple times with your new set of patches might be problematic.


---

Comment by jpflori created at 2013-06-06 15:23:22

I'd say the easiest way to go now is to rebase this ticket on the trivial change of #2114.


---

Comment by leif created at 2013-06-06 15:29:00

Replying to [comment:6 jpflori]:
> I'd say the easiest way to go now is to rebase this ticket on the trivial change of #2114.

Au contraire I'd say (if that's correctly spelled).


---

Comment by leif created at 2013-06-06 15:57:27

Is "refactor and rename patches" in any way related to the ticket's subject, namely fixing a *defect* (which the current spkg properly does)?

Honestly, if you feel all the patches should be restructured (including their documentation), that can be done on another ticket.


---

Comment by jdemeyer created at 2013-06-06 19:41:34

Replying to [comment:8 leif]:
> Is "refactor and rename patches" in any way related to the ticket's subject, namely fixing a *defect* (which the current spkg properly does)?
Perhaps what is meant is simply my comment about having _one_ patch to fix `make` and documenting that patch in `SPKG.txt`.


---

Comment by jpflori created at 2013-06-06 19:53:57

Yeah, let's just do that.

To properly refactor we should split the libtool part in DoConfig.patch and merge it with mfile.patch into a libtool_flag.patch later and put the remaining part into a disable_help.patch.
Maybe move new.h.patch to new_singular.patch.
And properly document everything in SPKG.txt by reflecting what is done by which patch (although the names should be then more talkative).
But I can do that in a folow up ticket.


---

Comment by jpflori created at 2013-06-06 20:29:08

I've put an spkg doing all the above and based on #2114 at:
* http://boxen.math.washington.edu/home/jpflori/spkg/ntl-5.5.2.p2.spkg


---

Attachment

Spkg diff, for review only.


---

Comment by jpflori created at 2013-06-06 20:34:12

Changing status from needs_work to needs_review.


---

Comment by jpflori created at 2013-06-06 20:34:12

Changing keywords from "spkg" to "spkg ntl".


---

Comment by leif created at 2013-06-07 13:16:32

`patches/make.patch` lacks the patch to `src/src/TestScript`.

(I'd also rename the patch to `use_MAKE.patch` or smth like that.)


---

Comment by leif created at 2013-06-07 13:16:32

Changing status from needs_review to needs_work.


---

Comment by leif created at 2013-06-07 13:20:26

"Patches" is usually a subsection of "Special !Update/Build Instructions", i.e., `=== Patches ===`.


---

Comment by leif created at 2013-06-07 13:29:01

And if you like, do

```diff
--- a/patches/make.patch
+++ b/patches/make.patch
`@``@` -31,7 +31,7 `@``@`
  
  setup4:
 -	sh Wizard $(WIZARD)
-+	+sh Wizard $(WIZARD) # shell script invoking a Perl script invoking \$MAKE
++	+sh Wizard $(WIZARD) # shell script invoking a Perl script invoking $$MAKE
  
  
  ntl.a:	$(OBJ) 
`@``@` -44,7 +44,7 `@``@`
  	./QuickTest
  	sh RemoveProg QuickTest
 -	sh TestScript
-+	+sh TestScript # shell script invoking \$MAKE
++	+sh TestScript # shell script invoking $$MAKE
  
  #################################################################
  #
```

which fixes a minor flaw I only noticed after I had already uploaded my original spkg...


---

Comment by jdemeyer created at 2013-06-07 14:20:48

Why did you remove the patches involving `LIBTOOL_LINK_FLAGS`? This doesn't seem to be documented.


---

Comment by leif created at 2013-06-07 14:58:52

Replying to [comment:16 jdemeyer]:
> Why did you remove the patches involving `LIBTOOL_LINK_FLAGS`?

?  They're (now) in `patches/libtool_flag.patch`.

> This doesn't seem to be documented.


---

Comment by leif created at 2013-06-07 15:02:40

Still, we have

```
 * libtool_flag.patch: modify mfile to enable the build of a shared library
   on Cygwin
```

but

```sh
$ grep '^+++' patches/libtool_flag.patch 
+++ src/src/DoConfig	2012-08-07 12:17:12.828358360 +0200
+++ src/src/mfile	2013-06-05 20:43:25.845240069 +0200
```

I.e., add `DoConfig` to the patch's documentation.


---

Comment by jdemeyer created at 2013-06-08 08:27:49

Replying to [comment:17 leif]:
> They're (now) in `patches/libtool_flag.patch`.
I don't see that file in [attachment:ntl-5.5.2.p2.patch]. Did you forget to `hg add` that file?


---

Comment by jdemeyer created at 2013-06-08 08:32:56

Making some changes to the spkg, hang on...


---

Comment by leif created at 2013-06-08 10:30:34

Replying to [comment:19 jdemeyer]:
> Replying to [comment:17 leif]:
> > They're (now) in `patches/libtool_flag.patch`.
> I don't see that file in [attachment:ntl-5.5.2.p2.patch]. Did you forget to `hg add` that file?

`.hgignore` is the problem.  (It contains `libtool` rather than `libtool/`.)


---

Comment by leif created at 2013-06-08 10:36:47

Replying to [comment:19 jdemeyer]:
> Replying to [comment:17 leif]:
> > They're (now) in `patches/libtool_flag.patch`.
> Did you forget to `hg add` that file?

And yes, fixing `.hgignore`, indeed one gets:

```
? patches/libtool_flag.patch
```



---

Comment by jdemeyer created at 2013-06-08 11:39:10

Better wait for a review of #2114 first, otherwise we can be rebasing forever.


---

Comment by vbraun created at 2013-07-10 15:20:56

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2013-07-10 15:20:56

Superseded by #14876


---

Comment by vbraun created at 2013-07-10 18:14:10

Since the new upstream version is incompatible with our Singular, lets make a new spkg here with the fixes needed for the git transition. The version bump can wait until Singular is ready.


---

Attachment

For review purposes only


---

Comment by jpflori created at 2013-07-11 08:25:36

Is the "Make everything writable" part actually needed?
I guess so, or you wouldn't have added it, but I was not aware of that.


---

Comment by jpflori created at 2013-07-11 11:56:03

Changing status from needs_review to needs_work.


---

Comment by jpflori created at 2013-07-11 11:56:03

It would be nice to have a way to use a local copy of ntl tarball in spkg-src (just as you did for Singular in #14737).


---

Comment by vbraun created at 2013-07-11 12:50:21

I haven't checked if the "make writeable" part is really needed. But since it also depends on umask and since wrong permissions in tarballs are not that uncommon, I think its better to include it.

The ntl tarball is tiny and on a fast server, so I didn't need an option to use a local copy for writing/testing the script. If you need it, feel free to open a ticket with that feature request.


---

Comment by vbraun created at 2013-07-11 12:50:21

Changing status from needs_work to needs_review.


---

Comment by jpflori created at 2013-07-11 21:40:08

Replying to [comment:29 vbraun]:
> I haven't checked if the "make writeable" part is really needed. But since it also depends on umask and since wrong permissions in tarballs are not that uncommon, I think its better to include it.
> 
> The ntl tarball is tiny and on a fast server, so I didn't need an option to use a local copy for writing/testing the script. If you need it, feel free to open a ticket with that feature request.
Except when the site is down :)


---

Comment by jpflori created at 2013-07-11 21:43:06

Maybe we could remove autom4te.cache from the libtool dir.


---

Comment by jpflori created at 2013-07-11 21:44:02

Otherwise everything is fine.


---

Comment by vbraun created at 2013-07-11 22:26:40

I've added a `rm -rf autom4te.cache` to `spkg-src` and re-ran it.


---

Comment by vbraun created at 2013-07-11 22:27:13

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-08-02 14:18:56

Resolution: fixed
