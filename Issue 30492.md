# Issue 30492: Fix gap_packages for Xcode 12

Issue created by migration from https://trac.sagemath.org/ticket/30729

Original creator: mkoeppe

Original creation time: 2020-10-05 19:01:56

CC:  dimpase jhpalmieri soehms

Follow-up from #30720


---

Comment by dimpase created at 2020-10-05 19:21:03

I've opened https://github.com/gap-packages/cohomolo/issues/27


---

Comment by mkoeppe created at 2020-10-05 21:04:28

Was the update ticket #29314 successfully tested on Xcode 12?


---

Comment by dimpase created at 2020-10-05 21:34:35

it might be I didn't test the whole of gap_packages. I thought I did.


---

Comment by jhpalmieri created at 2020-10-05 21:50:17

I don't think #29314 upgrades `gap_packages`, but the new `gap` and `libsemigroups` build for me.


---

Comment by mkoeppe created at 2020-10-05 21:55:45

Replying to [comment:5 jhpalmieri]:
> I don't think #29314 upgrades `gap_packages`

It does because it uses the same tarball as `gap`, via symlinks in `build/pkgs/gap_packages`


---

Comment by mkoeppe created at 2020-10-06 18:15:37

As suggested in #29314, patching the failing packages using the diff to the GAP 4.11 distribution would be a way forward.


---

Comment by mkoeppe created at 2020-10-06 18:30:36

The failure is now also reproduced on GH Actions in `local-homebrew-usrlocal-macos-maximal-xcode12`, https://github.com/mkoeppe/sage/runs/1208931537


---

Comment by jhpalmieri created at 2020-10-06 20:18:40

I see the same error with this branch.
----
New commits:


---

Comment by dimpase created at 2020-10-07 22:35:56

Replying to [comment:11 jhpalmieri]:
> I see the same error with this branch.

in GAP 4.10 the cohomolo's Makefile.in does not have a [line](https://github.com/gap-packages/cohomolo/blob/8f7340a5b604fc70db890ca64b68fcfade0c0c21/Makefile.in#L19)

```
EXTRA_CFLAGS += -Wno-implicit-function-declaration
```


which is present in GAP 4.11 - so probably the quickest patch would be to add it in GAP 4.10.
(I started on fixing the code itself, but it's a nontrivial amount of changes).


---

Comment by dimpase created at 2020-10-08 11:04:41

Even quicker should be to do

```diff
diff --git a/build/pkgs/gap_packages/spkg-install.in b/build/pkgs/gap_packages/spkg-install.in
index 10b444b5c6..cc094ad40c 100644
--- a/build/pkgs/gap_packages/spkg-install.in
+++ b/build/pkgs/gap_packages/spkg-install.in
@@ -3,6 +3,8 @@ PKG_DIR="$GAP_ROOT/pkg"
 
 PKG_SRC_DIR="$(pwd)/src/pkg"
 cd "$PKG_SRC_DIR"
+CFLAGS = "$CFLAGS -Wno-implicit-function-declaration"
+export CFLAGS
 
 # directly install pure GAP packages
 #
```



---

Comment by jhpalmieri created at 2020-10-08 21:37:56

I tried this, and it doesn't work for me: same error as before.


---

Comment by dimpase created at 2020-10-08 21:55:37

Replying to [comment:14 jhpalmieri]:
> I tried this, and it doesn't work for me: same error as before.

Could we see the full error, with the corresponding compiler call?


---

Comment by dimpase created at 2020-10-08 22:15:06

the old Makefile.in there needs a patch, in fact, that's why it does not work


---

Comment by jhpalmieri created at 2020-10-08 22:40:32

This works for me, instead:

```diff
diff --git a/build/pkgs/gap_packages/spkg-install.in b/build/pkgs/gap_packages/spkg-install.in
index 10b444b5c6..56c444e11f 100644
--- a/build/pkgs/gap_packages/spkg-install.in
+++ b/build/pkgs/gap_packages/spkg-install.in
@@ -68,6 +68,8 @@ install_compiled_pkg()
 for pkg in cohomolo-* crypting-* grape-* guava-* orb-*
 do
     echo "Building GAP package $pkg"
+    CFLAGS="$CFLAGS -Wno-implicit-function-declaration"
+    export CFLAGS
     cd "$PKG_SRC_DIR/$pkg"
     ./configure "$GAP_ROOT"
     sdh_make -j1
```



---

Comment by dimpase created at 2020-10-08 22:45:29

Replying to [comment:17 jhpalmieri]:
> This works for me, instead:
> {{{
> #!diff
> diff --git a/build/pkgs/gap_packages/spkg-install.in b/build/pkgs/gap_packages/spkg-install.in
> index 10b444b5c6..56c444e11f 100644
> --- a/build/pkgs/gap_packages/spkg-install.in
> +++ b/build/pkgs/gap_packages/spkg-install.in
> `@``@` -68,6 +68,8 `@``@` install_compiled_pkg()
>  for pkg in cohomolo-* crypting-* grape-* guava-* orb-*
>  do
>      echo "Building GAP package $pkg"
> +    CFLAGS="$CFLAGS -Wno-implicit-function-declaration"
> +    export CFLAGS
>      cd "$PKG_SRC_DIR/$pkg"
>      ./configure "$GAP_ROOT"
>      sdh_make -j1
> }}}
yes, I'm testing essentially the same branch, will post it soon.


---

Comment by dimpase created at 2020-10-08 23:39:05

Changing status from new to needs_review.


---

Comment by dimpase created at 2020-10-08 23:39:05

OK, this should be it


---

Comment by jhpalmieri created at 2020-10-09 03:32:48

This isn't working for me. First, one of the patches is wrong:

```diff
diff --git a/build/pkgs/gap_packages/patches/cohomolo_makefile.patch b/build/pkgs/gap_packages/patches/cohomolo_makefile.patch
index 401deba09d..01f0e85587 100644
--- a/build/pkgs/gap_packages/patches/cohomolo_makefile.patch
+++ b/build/pkgs/gap_packages/patches/cohomolo_makefile.patch
@@ -1,7 +1,7 @@
-diff --git a/Makefile.in b/Makefile.in
+diff --git a/pkg/cohomolo-1.6.7/Makefile.in b/pkg/cohomolo-1.6.7/Makefile.in
 index 96a6c75..ab8b8c3 100644
---- a/Makefile.in
-+++ b/Makefile.in
+--- a/pkg/cohomolo-1.6.7/Makefile.in
++++ b/pkg/cohomolo-1.6.7/Makefile.in
 @@ -2,13 +2,18 @@
  # all executables are put into the bin directory.
  BIN = bin/@GAPARCH@
```

Even after fixing that, I get an error building gap_packages:

```
gcc -c -O2 -g -Wno-implicit-function-declaration -Wno-return-type -Wno-dangling-else -Wno-unused-result pcd.c 
pcd.c:22:8: error: redefinition of 'conj' as different kind of symbol
       conj[NPT],conjinv[NPT],facord[MEXP],pinv[NPT/2],rel[2*MEXP],
       ^
pcd.c:22:8: note: unguarded header; consider using #ifdef guards or #pragma once
pcd.c:22:8: note: previous definition is here
1 error generated.
```

Using only the change in comment:17 worked, but I'm not getting this new branch to work. Is anyone else having better luck?


---

Comment by dimpase created at 2020-10-09 07:53:34

Please make a branch that works for you and post it here. We'll review it for other systems.


---

Comment by jhpalmieri created at 2020-10-09 19:42:20

I can't push a branch, but these are the changes:

```diff
diff --git a/build/pkgs/gap_packages/spkg-install.in b/build/pkgs/gap_packages/spkg-install.in
index 10b444b5c6..56c444e11f 100644
--- a/build/pkgs/gap_packages/spkg-install.in
+++ b/build/pkgs/gap_packages/spkg-install.in
@@ -68,6 +68,8 @@ install_compiled_pkg()
 for pkg in cohomolo-* crypting-* grape-* guava-* orb-*
 do
     echo "Building GAP package $pkg"
+    CFLAGS="$CFLAGS -Wno-implicit-function-declaration"
+    export CFLAGS
     cd "$PKG_SRC_DIR/$pkg"
     ./configure "$GAP_ROOT"
     sdh_make -j1
diff --git a/src/sage/tests/gap_packages.py b/src/sage/tests/gap_packages.py
index 340ceb8c29..cf9a68cec2 100644
--- a/src/sage/tests/gap_packages.py
+++ b/src/sage/tests/gap_packages.py
@@ -6,6 +6,7 @@ TESTS::
     sage: from sage.tests.gap_packages import all_installed_packages, test_packages
     sage: pkgs = all_installed_packages(ignore_dot_gap=True)
     sage: test_packages(pkgs, only_failures=True)    # optional - gap_packages
+    ...
       Status   Package   GAP Output
     +--------+---------+------------+
 
```



---

Comment by dimpase created at 2020-10-09 19:45:45

what is happening when you are trying to push?


---

Comment by jhpalmieri created at 2020-10-09 19:46:54

I get an error like some of the ones reported earlier today:

```
% git trac push 30729        
Pushing to Trac #30729...
Guessed remote branch: u/jhpalmieri/fix_gap_packages_for_xcode_12
Traceback (most recent call last):
  File "/usr/local/bin/git-trac", line 17, in <module>
    cmdline.launch()
  File "/usr/local/lib/python3.8/site-packages/git_trac/cmdline.py", line 247, in launch
    app.push(ticket_number, remote=args.remote, force=args.force)
  File "/usr/local/lib/python3.8/site-packages/git_trac/app.py", line 218, in push
    self.repo.push(remote, force)
  File "/usr/local/lib/python3.8/site-packages/git_trac/git_repository.py", line 196, in push
    self.git.echo.push('trac', refspec)
  File "/usr/local/lib/python3.8/site-packages/git_trac/git_interface.py", line 340, in meth
    return self.execute(git_cmd, *args, **kwds)
  File "/usr/local/lib/python3.8/site-packages/git_trac/git_interface.py", line 95, in execute
    result = self._interface._run(cmd, args, kwds, 
  File "/usr/local/lib/python3.8/site-packages/git_trac/git_interface.py", line 262, in _run
    raise GitError(result)
git_trac.git_error.GitError: git returned with non-zero exit code (1) when executing "git push trac HEAD:refs/heads/u/jhpalmieri/fix_gap_packages_for_xcode_12"
    STDERR: remote: error: insufficient permission for adding an object to repository database ./objects
    STDERR: remote: fatal: failed to write object
    STDERR: error: remote unpack failed: unpack-objects abnormal exit
    STDERR: To trac.sagemath.org:sage.git
    STDERR:  ! [remote rejected]       HEAD -> u/jhpalmieri/fix_gap_packages_for_xcode_12 (unpacker error)
    STDERR: error: failed to push some refs to 'git@trac.sagemath.org:sage.git'
```

(Same with with `git trac push ... --force`)


---

Comment by dimpase created at 2020-10-09 19:58:30

could you try pushing now?

I've learned about group permissions and did

```
setfacl -m "default:group::rwx" objects
```


Strange that ACL utils were not installed on the box, so I don't know how it worked before I messed it up...


---

Comment by jhpalmieri created at 2020-10-09 20:14:49

Success! Thank you.
----
New commits:


---

Comment by dimpase created at 2020-10-09 21:57:42

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-10-09 21:57:42

ok, this works on Debian.


---

Comment by vbraun created at 2020-10-31 18:07:58

Resolution: fixed
