# Issue 11984: Pretty print LatexExpr directly

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2011-12-15 09:42:30

Assignee: jason

CC:  tdemedts@java.ugent.be jhpalmieri

An object of type `LatexExpr` should be pretty-printed as-is, that is

```
sage: pretty_print(LatexExpr('x^2 + 1'))
```

should really typeset "x^2 + 1" instead of displaying the string "x^2 + 1".


---

Attachment


---

Comment by jdemeyer created at 2011-12-15 10:14:22

Changing status from new to needs_review.


---

Attachment

I got a bit confused by the description of the class, so I propose the attached change. The main patch has positive review from me.


---

Comment by jdemeyer created at 2011-12-16 09:30:25

I removed "Strings are wrapped into verbatim environment for typeset output, while LaTeX expressions are left as-is" because I think that's confusing.  I added some more documentation changes and examples.  Needs review.


---

Comment by ppurka created at 2011-12-16 14:40:49

There is just one point. It is not possible to combine normal strings with latex strings or LatexExpr with itself. Something like this fails to produce the right output: `LatexExpr(r'\Delta') + LatexExpr(r'\frac{x}2')`. This gives the wrong output even though the addition goes through as strings. Proposed patch is attached, though I leave it up to you to decide whether to include it.

Other than this minor point, the patches provided earlier work as advertised. So, positive review from my side.


---

Comment by novoselt created at 2011-12-16 20:31:18

If we do add the last patch (which is a bit beyond the title of this ticket), then I think that we MUST add a space between concatenated expressions: if you join "x" and "y" into "xy" it may be exactly what you need, but "\alpha" and "x" get joined into "\alphax" which is not a valid code any more (as I have "discovered" at #9478). Plus spaces (or even new lines) help reading the code and adjusting it if necessary.

I also was actually surprised that `"\frac{x}2"` works, I would put it as `"\frac{x}{2}"`, although it is just a personal preference, I guess ;-)


---

Comment by jdemeyer created at 2011-12-16 20:36:40

Replying to [comment:9 novoselt]:
> If we do add the last patch (which is a bit beyond the title of this ticket), then I think that we MUST add a space between concatenated expressions: if you join "x" and "y" into "xy" it may be exactly what you need, but "\alpha" and "x" get joined into "\alphax" which is not a valid code any more (as I have "discovered" at #9478). Plus spaces (or even new lines) help reading the code and adjusting it if necessary.
The problem is that maybe sometimes you _don't_ want a space.  How about adding a "{}" instead which acts like a seperator but otherwise doesn't do much.


---

Comment by jdemeyer created at 2011-12-16 20:48:44

This breaks the pdf manual:

```
Runaway argument?
\PYG {g+gp}{sage: }\PYG {n}{LatexExpr}\PYG {p}{(}\PYG {l+s}{r"}\PYG {\ETC.
! Forbidden control sequence found while scanning use of \FancyVerbGetLine.
<inserted text>
                \par
l.126604 ...r}\PYG{p}{(}\PYG{l+s}{r"}\PYG{l+s}{^^L
                                                  rac\PYGZob{}x\PYGZca{}2 + ...

?
! Emergency stop.
<inserted text>
                \par
l.126604 ...r}\PYG{p}{(}\PYG{l+s}{r"}\PYG{l+s}{^^L
                                                  rac\PYGZob{}x\PYGZca{}2 + ...

!  ==> Fatal error occurred, no output PDF file produced!
Transcript written on reference.log.
```



---

Comment by novoselt created at 2011-12-16 21:06:18

Replying to [comment:10 jdemeyer]:
> The problem is that maybe sometimes you _don't_ want a space.  How about adding a "{}" instead which acts like a seperator but otherwise doesn't do much.

In what situations does the space matter in math mode? It seems to me that if both were valid expressions before, then they can be separated by a space without any harm... As I understand `{}` will do the same, but it will make the code much uglier, `x{}y` is not as cool as `x y`. And I think that readability of the LaTeX output is a valid concern since I quite regularly take some Sage generated code and then do some manual tweaking. For example - take a long polynomial and then typeset it in an align-environment in a paper. In editors that auto-wrap lines on spaces it is also preferable to have just a space separator.

If there are situations when space does not work, which I think are quite rare since I cannot think of any, one always has an option of converting things to strings, doing anything there and then assembling them back. On a related note, it would be nice to have automatic vertical assembling of such expressions as well, but it is definitely beyond this ticket.


---

Comment by novoselt created at 2011-12-16 21:08:57

Which patch does break the PDF manual? The last one or all of them?


---

Comment by jdemeyer created at 2011-12-16 21:18:33

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2011-12-16 21:18:33

Replying to [comment:13 novoselt]:
> Which patch does break the PDF manual? The last one or all of them?

Problem solved by using `r"""` instead of `"""`.

Concerning adding: you are right, I did not consider that we are using math mode all the time.  But you should use `_add_` (single underscores).  I don't know why, but Sage does it this way.


---

Comment by novoselt created at 2011-12-16 21:33:38

I think `_add_` is used so that coercion can work properly. But it requires inheriting from `SageObject` or maybe even `Element`, so that generic `__add__` can do its part of the job. So I doubt it will work for `LatexExpr` which inherits from `str` and nothing else.


---

Comment by ppurka created at 2011-12-17 02:10:22

Actually space seems to work just fine to separate elements. Since we are in math mode, JSMath will collapse the extra spaces automatically.

As mentioned by novoselt, `_add_` does not work. I tried it out just now. Updated the patch.


---

Comment by jdemeyer created at 2011-12-19 13:29:54

Add to LatexExpr (added space in between the two)


---

Attachment


---

Attachment

Positive review to everything except my extra_doc patch.


---

Comment by jdemeyer created at 2011-12-19 13:45:14

Changing status from needs_work to needs_review.


---

Comment by novoselt created at 2011-12-19 15:16:17

Changing status from needs_review to positive_review.


---

Comment by novoselt created at 2011-12-19 15:16:17

Positive review to the last patch as well! Why do we have the reviewer field before the author one?..


---

Comment by jdemeyer created at 2011-12-20 09:20:47

Unfortunately there are some doctest errors in various unrelated files. I am working on a patch.


---

Comment by jdemeyer created at 2011-12-20 09:20:47

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2011-12-20 09:22:17

Changing keywords from "" to "sd35".


---

Comment by jdemeyer created at 2011-12-20 11:25:59

Changing status from needs_work to needs_review.


---

Attachment


---

Comment by jdemeyer created at 2011-12-20 15:33:21

New patch also allows str + LatexExpr additions, which needed a few changes in various places inside Sage.  I left one more substantial change for differential forms at #12197.

Needs review.


---

Comment by jhpalmieri created at 2011-12-21 01:14:09

I think I'll join the patch party: I'm attaching a patch which rewords a few docstrings. Otherwise, everything looks good to me.  With the patch at #12197 and all of the patches here, all tests pass.

I'm willing to give everything but my patch a positive review.


---

Attachment

Reviewer patch looks fine.


---

Comment by jdemeyer created at 2011-12-21 12:15:20

Changing status from needs_review to positive_review.


---

Comment by ppurka created at 2011-12-21 13:03:13

I guess you are patching some 4.8alpha version of sage. I was patching 4.7.2, so I had to modify the patch [attachment:12156_fix_latex.patch] for `sage/modular/dirichlet.py` to read as:

```diff
diff --git a/sage/modular/dirichlet.py b/sage/modular/dirichlet.py
--- a/sage/modular/dirichlet.py
+++ b/sage/modular/dirichlet.py
`@``@` -511,7 +511,7 `@``@`
         for i in range(len(self.values_on_gens())):
             if i != 0:
                 mapst += ', '
-            mapst += latex(self.parent().unit_gens()[i]) + ' \mapsto ' + latex(self.values_on_gens()[i])
+            mapst += self.parent().unit_gens()[i]._latex_() + ' \mapsto ' + self.values_on_gens()[i]._latex_()
         return r'Dirichlet character modulo %s of conductor %s mapping $%s$'%(self.modulus(), self.conductor(), mapst)
                  
         def base_ring(self):
```


This, along with #12197 makes it pass the doctests. So, positive review from me too.


---

Comment by jdemeyer created at 2011-12-24 01:04:53

Resolution: fixed
