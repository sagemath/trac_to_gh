# Issue 19382: Simplify words.py

Issue created by migration from Trac.

Original creator: vdelecroix

Original creation time: 2015-11-24 22:40:08

CC:  slabbe

Currently we have too many parent for words:
 - for finite and infinite words (`Words_all`, `Words_over_alphabet`, `Words_over_OrderedAlphabet`)
 - finite words (`FiniteWords_over_OrderedAlphabet`)
 - infinite words (`InfiniteWords_over_OrderedAlphabet`)
 - words of fixed length (`FiniteWords_length_k_over_OrderedAlphabet` and `Words_n`)

This lead to subtle bug like

```
sage: W = Words([0,1], finite=False, infinite=True)
sage: u = W.an_element()
sage: u[2:5].parent()   # a finite word !!
Infinite Words over {0, 1}
```


The proposal of this ticket is to have only three classes:
 - `FiniteWords`
 - `Words_n`: words of length `n` (as a slice of the one before)
 - `InfiniteWords` (or `FullShift`)
The parent `FiniteWords` should hence have a method `.shift()` that return the associated shift (e.g `u ** Infinity` will belong there). Similarly, the parent `InfiniteWords` should have a method `.factors()` that return the set of factors (and finite slices will belong there).


---

Comment by slabbe created at 2015-11-25 09:55:26

Sounds great. I will be reviewing this.


---

Comment by vdelecroix created at 2015-11-25 20:08:04

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2015-11-25 20:08:04

It took me much more time than expected... It is not yet completely finished but all tests pass in `combinat/words/`, `combinat/lyndon_word.py` and `combinat/e_one_star.py`.
----
New commits:


---

Comment by git created at 2015-11-25 21:53:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-11-25 22:35:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-11-25 22:35:38

What a mess this unpickling stuff!!!


---

Comment by git created at 2015-11-26 10:26:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-11-26 10:40:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-11-26 14:13:14

All tests pass!


---

Comment by slabbe created at 2015-11-26 14:18:25

Is it ready for review? I saw a TODO in the diff...


---

Comment by vdelecroix created at 2015-11-26 14:23:28

Replying to [comment:10 slabbe]:
> Is it ready for review? I saw a TODO in the diff...

Read for review. The TODO can be removed. It was because of the `cmp_letters` method. Now its status is decided on construction as follows

```
        if alphabet.cardinality() == Infinity or \
           (alphabet.cardinality() < 36 and
            all(alphabet.unrank(i) > alphabet.unrank(j) for
            i in range(min(36,alphabet.cardinality())) for j in range(i))):
            self.cmp_letters = cmp
        else:
            self.cmp_letters = self._cmp_letters
```

where `_cmp_letters` is the previous version which compares by ranking in the alphabet. It is of course not ideal, but I think that we should get rid of this `cmp_letters` anyway.


---

Comment by git created at 2015-11-26 17:29:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2015-11-27 13:00:15

Some methods are missing doctests apparently:

```
Decreased doctests in combinat/words/morphism.py: from 53 / 53 = 100% to 53 / 56 = 94%
Decreased doctests in combinat/words/paths.py: from 57 / 57 = 100% to 57 / 59 = 96%
Decreased doctests in combinat/words/words.py: from 45 / 45 = 100% to 63 / 66 = 95%
```



---

Comment by vdelecroix created at 2015-11-27 13:18:25

Is that a problem?


---

Comment by vdelecroix created at 2015-11-27 13:20:05

In `words.py`, I can add some:

```
TESTS:

    sage: print "hello"
    hello
```

but I do not see the point. The missing doctest are in the deprecated class ``Words_all`` I do not see any relevant test...

For `morphism.py` and `paths.py` I will complete the missing ones.


---

Comment by git created at 2015-11-27 13:37:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2015-11-27 15:03:14

The ones at lines 302 and 1721 are not deprecated. The method `_cmp_letters` is tested with `cmp_letters` (?). To my opinion, the two methods that are deprecated should also be doctested. It will take three lines, show the user how to use those methods. Maybe with a pickle through an indirect doctest, I don't know. For the one at line 2429, say why this method must exist, it contains only "pass", why?


```
------------------------------------------------------------------------
SCORE src/sage/combinat/words/words.py: 95.5% (63 of 66)

Missing documentation:
     * line 1721: def _element_classes(self)
     * line 2424: def __setstate__(self, state)
     * line 2429: def _element_constructor_(self)

Possibly wrong (function name doesn't occur in doctests):
     * line 302: def _cmp_letters(self, letter1, letter2)
------------------------------------------------------------------------
```



---

Comment by git created at 2015-11-27 17:36:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-11-27 17:46:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2015-11-30 14:56:19

Why `Words_n` inherits from `Parent` instead of `AbstractLanguage`?


---

Comment by slabbe created at 2015-11-30 15:15:00

Should a parent return an element for which he is the parent?


```
sage: W = Words('abc') 
sage: W 
Finite and infinite words over {'a', 'b', 'c'}
sage: W('aabbcc').parent()
Finite words over {'a', 'b', 'c'}
sage: W('aabbcc').parent() == W
False   
```



```
sage: W = Words(range(4))     
sage: W(lambda n:n%4).parent() == W 
False  
```



---

Comment by vdelecroix created at 2015-11-30 15:19:31

Replying to [comment:20 slabbe]:
> Why `Words_n` inherits for `Parent` instead of `AbstractLanguage`?

`AbstractLanguage` is designed to disappear. For the moment it just holds the `_alphabet` attributes and some deprecated methods. I am not sure that all language should keep this `_alphabet` attribute. That can be changed. Do we want that languages implement a method `alphabet` or simply provides an alphabet to the constructor of a base class?

`Words_n` does not care about an attribute `_alphabet` since it is initialized with a `FiniteWords` as first argument. It is essentially an empty shell.


---

Comment by vdelecroix created at 2015-11-30 15:22:36

Replying to [comment:21 slabbe]:
> Should a parent return an element for which he is the parent?

There are other parents doing the same

```
sage: NN.an_element().parent() == NN
False
sage: Primes().an_element().parent() == Primes()
False
```

And this is the concept of facade (in the Sage category sense).

With my branch you always have:
- finte words have a parent `FiniteWords`
- infinite words have a parent `InfiniteWords`
- words with indefinite status have a parent `FiniteOrInfiniteWords`
In particular

```
sage: W = Words('ab')
sage: W('ab').parent() is W.finite_words()
True
sage: W(lambda n: 'a', length='infinite').parent() is W.infinite_words()
True
sage: W(iter("ab"*100)).parent() is W
True
```



---

Comment by slabbe created at 2015-11-30 15:24:33

Replying to [comment:22 vdelecroix]:
> `AbstractLanguage` is designed to disappear.

If so, say it in the docstring `__doc__` of `AbstractLanguage`. It helps to know what should be the next improvements to the code.

> For the moment it just holds the `_alphabet` attributes and some deprecated methods.

But it contains some other nondeprecated methods too.


---

Comment by vdelecroix created at 2015-11-30 15:27:12

Replying to [comment:24 slabbe]:
> Replying to [comment:22 vdelecroix]:
> > `AbstractLanguage` is designed to disappear.
> 
> If so, say it in the docstring `__doc__` of `AbstractLanguage`. It helps to know what should be the next improvements to the code.
> 
> > For the moment it just holds the `_alphabet` attributes and some deprecated methods.
> 
> But it contains some other nondeprecated methods too.

Right. Let say that it is an experimental abstraction of a potential `Language` base class... I will update the doc (not changing anything else).


---

Comment by slabbe created at 2015-11-30 15:29:19

Replying to [comment:23 vdelecroix]:
> With my branch you always have:
> - finte words have a parent `FiniteWords`
> - infinite words have a parent `InfiniteWords`
> - words with indefinite status have a parent `FiniteOrInfiniteWords`

It is interesting that you write `FiniteOrInfiniteWords` here instead of `FiniteAndInfiniteWords` in the code because I was going to suggest to call that class `FiniteOrInfiniteWords` instead.


---

Comment by git created at 2015-11-30 15:30:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-11-30 15:31:35

Replying to [comment:26 slabbe]:
> Replying to [comment:23 vdelecroix]:
> > With my branch you always have:
> > - finte words have a parent `FiniteWords`
> > - infinite words have a parent `InfiniteWords`
> > - words with indefinite status have a parent `FiniteOrInfiniteWords`
> 
> It is interesting that you write `FiniteOrInfiniteWords` here instead of `FiniteAndInfiniteWords` in the code because I was going to suggest to call that class `FiniteOrInfiniteWords` instead.

Oh right. It is clearly a union, hence `Or` makes more sense... will do it.


---

Comment by git created at 2015-11-30 15:32:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2015-11-30 16:03:47

I am still not done with the review as I need more time to think and look at the code... Will continue this tomorrow.


---

Comment by slabbe created at 2015-12-02 09:14:28

- Are sure that we do not prefer the `__call__` to be implemented in one place in `AbstractLanguage`? Lot of documentation is a copy paste...
 - Argument `length` in unused in `InfiniteWords.__call__`.
 - Documentation of `InfiniteWords.__call__` should not mention list, str, tuple, char and the length argument.
 - The below lines in `FiniteWords._word_from_word` seem useless. Same comment for `InfiniteWords._word_from_word`:

```python
from sage.combinat.words.finite_word import CallableFromListOfWords
if isinstance(data._func, CallableFromListOfWords):
    # The following line is important because, in this case,
    # data._func is also a tuple (indeed
    # CallableFromListOfWords inherits from tuple)
    datatype = "callable"
```

 - `Words_n.__call__` should include a `INPUTS:` block
 - The following imports are not used:

```
from sage.misc.mrange import xmrange
from sage.structure.parent import Set_PythonType
from sage.combinat.combinat import InfiniteAbstractCombinatorialClass
```



---

Comment by slabbe created at 2015-12-02 09:14:28

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-12-02 14:00:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-12-02 14:03:58

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2015-12-02 14:03:58

Replying to [comment:32 slabbe]:
>  - Are sure that we do not prefer the `__call__` to be implemented in one place in `AbstractLanguage`? Lot of documentation is a copy paste...

Definitely not. We do not want to impose the class of elements for (future) languages. Moreover:
 - you should not be able to build infinite words from `FiniteWords` or finite ones from `InfiniteWords`.
 - the code is now much simpler, isn't it?

To my mind, the documentation is completely useless. Which user will do

```
sage: W = Words('ab')
sage: W.__call__?
```



---

Comment by mantepse created at 2015-12-02 15:04:11

As a very casual user of words: I would expect `FiniteOrInfiniteWords` to be `Words`...


---

Comment by vdelecroix created at 2015-12-02 15:12:20

Replying to [comment:35 mantepse]:
> As a very casual user of words: I would expect `FiniteOrInfiniteWords` to be `Words`...

One problem is that `Words` is the name of the factory that dispatch to the actual classes `FiniteWords`, `InfiniteWords`, `FiniteOrInfiniteWords` or `Words_n`. Why do you care about the class names? You will never have to do

```
sage: FiniteOrInfiniteWords(my_alphabet)
```



---

Comment by mantepse created at 2015-12-02 15:43:18

OK, great, sorry for the noise!


---

Comment by slabbe created at 2015-12-03 10:02:28

The fourth item of my previous comment has not been answered.


---

Comment by slabbe created at 2015-12-03 10:02:28

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-12-03 11:56:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-12-03 11:57:02

Replying to [comment:38 slabbe]:
> The fourth item of my previous comment has not been answered.

Indeed.


---

Comment by vdelecroix created at 2015-12-03 11:57:02

Changing status from needs_work to needs_review.


---

Comment by slabbe created at 2015-12-04 09:23:59

Changing status from needs_review to needs_work.


---

Comment by slabbe created at 2015-12-04 09:23:59

I think this comment inside `FiniteWords._word_from_word`


```
+            # this must be put first for the reason that CallableFromListOfWords
+            # inherits from tuple
```


is unnecessary and date from the time were one method was doing everything for the creation of a word. Then, data could be a tuple or a `CallableFromListOfWords` which inherits from tuple explaining the reason we needed to test for `isinstance(data, CallableFromListOfWords)` first.

Now, in that method, data is word (not a tuple neither a `CallableFromListOfWords`) so the isinstance tests can be done in any order. Question: what is best to test first?


---

Comment by git created at 2015-12-04 12:43:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-12-04 12:45:32

I tried to do my best for `FiniteWords._word_from_word`. I also removed `_word_from_callable` from `FiniteOrInfiniteWords` and simplified its `__call__`.


---

Comment by vdelecroix created at 2015-12-04 12:45:32

Changing status from needs_work to needs_review.


---

Comment by slabbe created at 2015-12-04 14:49:32

I looked at the code. It looks good. But I now get (also reported by the patchbots):


```
----------------------------------------------------------------------
sage -t --warn-long 31.0 permutation.py  # 1 doctest failed
sage -t --warn-long 31.0 parking_functions.py  # 62 doctests failed
----------------------------------------------------------------------
```



---

Comment by slabbe created at 2015-12-04 14:49:32

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-12-04 15:16:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-12-04 15:17:13

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2015-12-04 15:17:13

Right. Permutations or parking functions are callable but should be considered as finite...


---

Comment by slabbe created at 2015-12-04 15:40:44

I would prefer if the code of `FiniteOrInfiniteWords.__call__` be like the others `FiniteWords.__call__` and `InfiniteWords.__call__` in the sense that first the function does:


```
if datatype is not None:
    #return directly the good word
    if datatype in ['str', 'list', 'char', 'tuple']:
        return etc...
else:
    #guess the datatype, the length, etc.
```


if you agree. It makes the code easier to read and be convince anybody that it does the minimal and most efficient path in the function.

Doing what you do in `InfiniteWords.__call__` essentially reverts ticket #17021 where that kind of guessing was done first. Note that to avoid duplication of code, it is possible that you will have to recreate `_word_from_callable` because of that... or maybe not.


---

Comment by vdelecroix created at 2015-12-04 15:58:31

Replying to [comment:47 slabbe]:
> I would prefer if the code of `FiniteOrInfiniteWords.__call__` be like the others `FiniteWords.__call__` and `InfiniteWords.__call__` in the sense that first the function does:
> 
> ` <SNIP> `
> 
> if you agree. It makes the code easier to read and be convince anybody that it does the minimal and most efficient path in the function.
> 
> Doing what you do in `InfiniteWords.__call__` essentially reverts ticket #17021 where that kind of guessing was done first. Note that to avoid duplication of code, it is possible that you will have to recreate `_word_from_callable` because of that... or maybe not.

If a user provides `datatype` *and* `length` there will be no guessing... And with what I changed the first step is to determine the length (in order to determine the parent). I do not see how to handle what you suggested without copy/paste.


---

Comment by vdelecroix created at 2015-12-04 15:59:41

Moreover, the `length` guessing is based on what the user input as `datatype`...


---

Comment by vdelecroix created at 2015-12-04 17:34:49

Some timings with the branch

```
sage: W = Words()
sage: FW = FiniteWords()
sage: L = range(1000)
sage: %timeit W(L, check=False)
100000 loops, best of 3: 2.54 µs per loop
sage: %timeit W(L, length="finite", check=False)
1000000 loops, best of 3: 1.58 µs per loop
sage: %timeit W(L, datatype="list", check=False)
100000 loops, best of 3: 1.75 µs per loop
sage: %timeit W(L, length="finite", datatype="list", check=False)
1000000 loops, best of 3: 1.49 µs per loop
sage: %timeit FW(L, check=False)
1000000 loops, best of 3: 823 ns per loop
```

Whereas we have on develop

```
sage: W = Words()
sage: %timeit W(L, check=False)
1000000 loops, best of 3: 800 ns per loop
```

It looks like the code in the branch is:
 - 3x slower now if nothing is provided
 - 2x slower if length or datatype is provided
 - 1x if call directly `FiniteWords`
Plenty of reasons: more inheritance, more function calls.


---

Comment by git created at 2015-12-06 14:10:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2015-12-07 16:05:09

Good to go.


---

Comment by slabbe created at 2015-12-07 16:05:09

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2015-12-07 16:07:25

Great! Thanks for the review!


---

Comment by vbraun created at 2015-12-08 16:27:16

Resolution: fixed
