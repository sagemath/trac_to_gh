# Issue 17859: Libsingular conversion of (signed?) int to sage might have a muisunderstanding about bitlength

Issue created by migration from https://trac.sagemath.org/ticket/18096

Original creator: nbruin

Original creation time: 2015-03-31 18:12:46

Note (in singular)

```
> LIB "normal.lib";
> ring r=0,(x,y,z),dp;
> ideal i=(x-y)*(y-z)*(z-x);
> genus(i);
-2
```

whereas in sage:

```
sage: x,y,z = QQ['x,y,z'].gens()
sage: C= Curve((x-y)*(y-z)*(z-x)); 
sage: sage: import sage.libs.singular.function_factory
sage: sage: sing_genus = sage.libs.singular.function_factory.ff.normal__lib.genus
sage: I=C.defining_ideal()
sage: sing_genus(I)
4294967294
```

so somehow the -2 seems to be represented in libsingular as a 32-bit signed integer and gets interpreted by sage as (probably) a 64-bit signed integer. The relevant code lives in
sage.lib.singular.function.pyx:951 (to_python):

```
        elif rtyp == INT_CMD:
            return <long>to_convert.data
```

Oddly enough, most of libsingular seems to refer to such fields with a `(long)` cast as well, and I would expect that, since sage and libsingular are supposed to be compiled with compatible compilers, they would agree on what `long` means.



---

Comment by nbruin created at 2015-03-31 20:08:07

Changing status from new to needs_review.


---

Comment by nbruin created at 2015-03-31 20:08:07

interpreting the value as an int rather than a long seems to work. Input welcome from someone with more singular knowledge.

(note that the `<int><long>` cast is necessary because a cast to `<int>` directly from `<void *>` causes a "loss of information" error).
----
New commits:


---

Comment by nbruin created at 2015-04-01 05:35:51

Corroborating evidence that this is the appropriate cast:
[ftp://ftp.fu-berlin.de/science/math/singular/doc/modules.pdf] contains casts `(int)(long)` from INT_CMD marked fields too. In general, the Singular documentation mentions that the `int` type (which is claimed to correspond to the `INT_CMD` type indicator) has range limitations consistent with 32-bit signed integers. So I'm pretty sure at this point that the proposed fix here is correct.


---

Comment by jdemeyer created at 2015-04-01 07:26:08

Add a doctest and you're good to go.


---

Comment by jdemeyer created at 2015-04-01 07:26:08

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-04-01 16:09:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nbruin created at 2015-04-01 16:10:13

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-04-02 10:08:59

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-04-14 19:43:24

Resolution: fixed
