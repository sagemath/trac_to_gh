# Issue 23734: floordiv in orders returns a number field element

Issue created by migration from Trac.

Original creator: saraedum

Original creation time: 2017-10-06 00:59:40

The result of a `//` should remain in the same ring, but it currently does not:

```
sage: (GaussianIntegers()(1)//1).parent()
Number Field in I with defining polynomial x^2 + 1
```


This is caused by order elements inheriting from `FieldElement` which makes the assumption that `_floordiv_` and `_div_` are the same.


---

Comment by roed created at 2017-10-06 02:32:09

This is tricky, since most orders in number fields are not Euclidean, so quotient with remainder doesn't make sense.


---

Comment by jdemeyer created at 2017-10-06 07:56:40

Well, the correct behaviour would be to do the right thing in the imaginary quadratic orders which are naturally Euclidean and raise an exception otherwise.


---

Comment by saraedum created at 2017-10-07 15:53:33

For me it would be sufficient for `a//b` to be `parent(a/b)` and raise an exception (NotImplemented?) if that is not in the same ring.


---

Comment by roed created at 2017-10-18 21:47:25

Replying to [comment:2 jdemeyer]:
> Well, the correct behaviour would be to do the right thing in the imaginary quadratic orders which are naturally Euclidean and raise an exception otherwise.

There are other orders which are norm Euclidean (some real quadratic orders for example).  See http://www.fen.bilkent.edu.tr/~franz/publ/survey.pdf

Of course, it's computationally more difficult to find a remainder when the unit group is nontrivial.


---

Comment by jdemeyer created at 2017-10-20 13:40:19

New commits:


---

Comment by jdemeyer created at 2017-10-20 13:44:12

Changing status from new to needs_review.


---

Comment by roed created at 2017-10-20 16:59:01

First, the patchbot is unhappy: there's a strange merge failure on Cygwin, complaining about `CONFLICT (content): Merge conflict in src/sage/parallel/map_reduce.py` (which I don't understand, since other merges into `8.1.beta8` succeeded), and a test failure in `sage/structure/element.pyx`.

Some thoughts on the code:

* Julian suggested having `a//b` return `parent(a/b)` when b divides `a` and raise an error otherwise.  This makes sense for any integral domain, and I think it's a good idea: so often this is what we want for floor division.  It's a bit strange to have different behavior for different `b`, but we already do this to some extent: `b=0` will always raise an error.

* Why did you choose to round to even?  It would be more consistent with `QQ` to round down.

* I think we should also implement `__mod__` and `quo_rem` to match this implementation of floor division.  This doesn't have to be on this ticket.


---

Comment by roed created at 2017-10-20 16:59:15

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-10-20 17:51:25

Replying to [comment:9 roed]:
> First, the patchbot is unhappy: there's a strange merge failure on Cygwin, complaining about `CONFLICT (content): Merge conflict in src/sage/parallel/map_reduce.py`

That happens on every ticket, it must be a problem with that bot.


---

Comment by jdemeyer created at 2017-10-20 17:53:03

Replying to [comment:9 roed]:
> Julian suggested having `a//b` return `parent(a/b)` when b divides `a` and raise an error otherwise.

Surely, you made a mistake somewhere in this sentence (`a//b` should not return a ring!). And I can't guess what you meant.


---

Comment by jdemeyer created at 2017-10-20 18:09:55

Replying to [comment:9 roed]:
> * Why did you choose to round to even?  It would be more consistent with `QQ` to round down.

Consistency with `QQ` was not a goal here. I guess it could be done but then it becomes less obvious to generalize to all number field elements. You cannot just round down the first component (the `x` in `x + y sqrt(D)`) in all cases. So either we would need to round down `x` only when `y` is zero or an integer, but that seems like needless complication to me.

Besides, I like the idea that `x // y` gives the closest possible order element to `x / y`.


---

Comment by roed created at 2017-10-20 20:39:48

Replying to [comment:12 jdemeyer]:
> Replying to [comment:9 roed]:
> > Julian suggested having `a//b` return `parent(a/b)` when b divides `a` and raise an error otherwise.
> 
> Surely, you made a mistake somewhere in this sentence (`a//b` should not return a ring!). And I can't guess what you meant.

Say `a` and `b` both have an order `R` as their parent.  I meant that `a//b` should return `R(a/b)`.


---

Comment by jdemeyer created at 2017-10-20 21:18:29

Replying to [comment:14 roed]:
> Say `a` and `b` both have an order `R` as their parent.  I meant that `a//b` should return `R(a/b)`.

OK, I see what you mean now. I guess a better approach would be: `a//b` returns either an order element `t` such that `N(a/b - t) < 1` or it raises `ArithmeticError`. That would generalize both the Euclidean division and the exact division.


---

Comment by roed created at 2017-10-20 21:32:09

Replying to [comment:15 jdemeyer]:
> Replying to [comment:14 roed]:
> > Say `a` and `b` both have an order `R` as their parent.  I meant that `a//b` should return `R(a/b)`.
> 
> OK, I see what you mean now. I guess a better approach would be: `a//b` returns either an order element `t` such that `N(a/b - t) < 1` or it raises `ArithmeticError`. That would generalize both the Euclidean division and the exact division.

Agreed: I think that's the optimal solution.  Figuring out what that `t` is in the non-imaginary quadratic case is probably beyond the scope of this ticket.


---

Comment by jdemeyer created at 2017-10-23 09:28:02

Unfortunately, this introduces an additional complication that the order is no longer guaranteed to be maximal...


---

Comment by git created at 2017-10-23 14:00:43

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-10-23 14:06:11

Changing status from needs_work to needs_review.


---

Comment by git created at 2017-10-27 07:55:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2018-05-21 17:04:34

Sorry, I had somehow forgotten about this ticket. Some comments:

* `intentially` should read `intentionally`
* The patchbot (coverage) is unhappy about the removal of the floordiv example
* There are some failing doctests it seems
* Why don't we implement my original proposal as well? I.e., `a//b==R(a/b)` if `a/b in R`?


---

Comment by saraedum created at 2018-05-21 17:04:34

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-06-12 09:41:35

Replying to [comment:22 saraedum]:
> * Why don't we implement my original proposal as well? I.e., `a//b==R(a/b)` if `a/b in R`?

What do you mean *exactly*? I thought I did implement that, but it seems that you don't agree.


---

Comment by git created at 2018-06-12 12:02:58

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-06-12 12:08:30

Changing status from needs_work to needs_review.


---

Comment by git created at 2018-06-19 09:17:27

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by saraedum created at 2018-06-19 13:04:01

Replying to [comment:23 jdemeyer]:
> Replying to [comment:22 saraedum]:
> > * Why don't we implement my original proposal as well? I.e., `a//b==R(a/b)` if `a/b in R`?
> 
> What do you mean *exactly*? I thought I did implement that, but it seems that you don't agree.

This ticket was originally not only about quadratic imaginary orders (I think you changed the scope at some point.) I think that `a//b` should always return `a/b` if that is in the original ringâ€¦I really just want `a//1` not to fail.


---

Comment by saraedum created at 2018-07-04 16:08:03

Changing status from needs_review to needs_info.
