# Issue 34251: sage.misc.weak_dict: Replace iteritems by items

archive/issues_034251.json:
```json
{
    "body": "CC:  chapoton tscrim klee\n\nas suggested in #33726#comment:5\n\nIssue created by migration from https://trac.sagemath.org/ticket/34488\n\n",
    "created_at": "2022-09-03T21:57:12Z",
    "labels": [
        "python3",
        "major",
        "enhancement"
    ],
    "title": "sage.misc.weak_dict: Replace iteritems by items",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34251",
    "user": "mkoeppe"
}
```
CC:  chapoton tscrim klee

as suggested in #33726#comment:5

Issue created by migration from https://trac.sagemath.org/ticket/34488





---

archive/issue_comments_485766.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-09-08T10:06:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34251#issuecomment-485766",
    "user": "chapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_485767.json:
```json
{
    "body": "New commits:",
    "created_at": "2022-09-08T10:06:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34251#issuecomment-485767",
    "user": "chapoton"
}
```

New commits:



---

archive/issue_comments_485768.json:
```json
{
    "body": "seems to have a green light. Please review",
    "created_at": "2022-09-08T17:03:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34251#issuecomment-485768",
    "user": "chapoton"
}
```

seems to have a green light. Please review



---

archive/issue_comments_485769.json:
```json
{
    "body": "Do we really need `items_list` and `values_list`?",
    "created_at": "2022-09-08T17:35:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34251#issuecomment-485769",
    "user": "mkoeppe"
}
```

Do we really need `items_list` and `values_list`?



---

archive/issue_comments_485770.json:
```json
{
    "body": "Well, this is here to provide replacement for functions that are replaced by iterators.\n\nI can as well remove them, for sure...",
    "created_at": "2022-09-08T17:36:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34251#issuecomment-485770",
    "user": "chapoton"
}
```

Well, this is here to provide replacement for functions that are replaced by iterators.

I can as well remove them, for sure...



---

archive/issue_comments_485771.json:
```json
{
    "body": "Yes, I'd suggest to remove them",
    "created_at": "2022-09-08T18:25:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34251#issuecomment-485771",
    "user": "mkoeppe"
}
```

Yes, I'd suggest to remove them



---

archive/issue_comments_485772.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-08T18:31:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34251#issuecomment-485772",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_485773.json:
```json
{
    "body": "done\n----\nNew commits:",
    "created_at": "2022-09-08T18:31:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34251#issuecomment-485773",
    "user": "chapoton"
}
```

done
----
New commits:



---

archive/issue_comments_485774.json:
```json
{
    "body": "Negative on removing values_list and items_list. The iterators are really quite unreliable on a weak dictionary, because the content of a weak dict can change over time in unexpected ways, not just through explicit deletes on the dictionary.\n\nThe list versions have much better defined behaviour: there, at least at the time of the call, strong references to the values get fixed in the list.\n\nIt also means that `[do_something_with(a) for a in D.values_list()]` and `[do_something_with(a) for a in D.itervalues(D)]` can actually behave differently, because the second one has more activity by `do_something_with` injected in between the iteration over `D`, whereas the first one starts with fixing all the values of `D` with strong references before anything is done with them. So the change of `values` and `items` as proposed here may cause changes in behaviour (and bugs to surface?).\n\nIterating over weak dictionaries is a little ill-defined conceptiually anyway, because you're never sure if something is in there. So I think it's in principle fine to change the use a little bit, but you need to be prepared that it can cause quite unexpected changes in behaviour, of a kind that is quite likely not covered by the doctests.",
    "created_at": "2022-09-08T21:56:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34251#issuecomment-485774",
    "user": "nbruin"
}
```

Negative on removing values_list and items_list. The iterators are really quite unreliable on a weak dictionary, because the content of a weak dict can change over time in unexpected ways, not just through explicit deletes on the dictionary.

The list versions have much better defined behaviour: there, at least at the time of the call, strong references to the values get fixed in the list.

It also means that `[do_something_with(a) for a in D.values_list()]` and `[do_something_with(a) for a in D.itervalues(D)]` can actually behave differently, because the second one has more activity by `do_something_with` injected in between the iteration over `D`, whereas the first one starts with fixing all the values of `D` with strong references before anything is done with them. So the change of `values` and `items` as proposed here may cause changes in behaviour (and bugs to surface?).

Iterating over weak dictionaries is a little ill-defined conceptiually anyway, because you're never sure if something is in there. So I think it's in principle fine to change the use a little bit, but you need to be prepared that it can cause quite unexpected changes in behaviour, of a kind that is quite likely not covered by the doctests.



---

archive/issue_comments_485775.json:
```json
{
    "body": "here is a branch not removing the list methods",
    "created_at": "2022-09-16T12:13:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34251#issuecomment-485775",
    "user": "chapoton"
}
```

here is a branch not removing the list methods



---

archive/issue_comments_485776.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-09-26T00:18:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34251#issuecomment-485776",
    "user": "mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_485777.json:
```json
{
    "body": "Not sure if I agree with the reasoning in comment:9 but there's nothing wrong with the current branch.",
    "created_at": "2022-09-26T00:18:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34251#issuecomment-485777",
    "user": "mkoeppe"
}
```

Not sure if I agree with the reasoning in comment:9 but there's nothing wrong with the current branch.



---

archive/issue_comments_485778.json:
```json
{
    "body": "To clarify: weak dictionaries are not the kinds of things you should be iterating over anyway. The only valid use I can think of is as a cache, and I think that's the use in sage for them. So I think that the production code doesn't actually *use* any of the iterators. They're there fore debugging. And in that case, you SHOULD probably use `items_list` or `values_list`, because then at least you get something that's a little closer to a well-defined snapshot (in time) of the contents. There is a semaphore in place that counts how many iterators are given out on the dictionary, which prevent some cleaning (but not the disappearance of values!) of the dictionary. So it's better if iterators on (weak) dictionaries are short-lived: a dangling one somewhere can really affect the maintenance on the dict!\n\nThat said, the methods on `WeakDict` are really just there to mirror those on the normal dict, so I'm OK with `values` and `items` following the conventions in Python3. There's a good warning in their documentations, which should nudge the conscientious programmer to double-check their approach.\n\nFor reference:\nhttps://github.com/python/cpython/blob/main/Objects/dictobject.c#L4016 shows that in Python3, iterators can now in fact lead to errors if the underlying dict is mutated. Given that `WeakValueDict` can normally be mutated when a GC happens, we need some guard against that (and that's there! Such deletes get queued until the iterator semaphore on the weakdict reaches 0). However, other explicit mutations (adding to the dict or explicitly deleting entries) could still mutate the dict. That's currently not guarded. We could raise an error in our iterator as well. Note, however, that `PyDict_Next` still isn't guarded in Py3 and that code needs to be prudent about using it (and in a multi-threaded arrangement or one where interrupt code can touch a dict, this cannot be done fully without having a semaphore protecting the dict or something like it).\n\nThe guard on Py3 dict iterators is a little strict: a deletion is in principle safe because it won't lead to reshaping the dict; yet iterators in Py3 would throw an error for that. This leads to some strange behaviour:\n\n```\nsage: W=dict(enumerate(range(10)))                                              \nsage: I=iter(W)                                                                 \nsage: next(I)                                                                   \n0\nsage: del W[7]                                                                  \nsage: W[11]=10                                                                   \nsage: next(I)                                                                   \n1\nsage: del W[8]                                                                  \nsage: next(I)                                                                   \nRuntimeError: dictionary changed size during iteration\n```\n\nif the length of the dict happens to not have changed: no error, even if new elements were added! So the guard implemented in Py3 on iterators is imperfect anyway.",
    "created_at": "2022-09-26T03:11:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34251#issuecomment-485778",
    "user": "nbruin"
}
```

To clarify: weak dictionaries are not the kinds of things you should be iterating over anyway. The only valid use I can think of is as a cache, and I think that's the use in sage for them. So I think that the production code doesn't actually *use* any of the iterators. They're there fore debugging. And in that case, you SHOULD probably use `items_list` or `values_list`, because then at least you get something that's a little closer to a well-defined snapshot (in time) of the contents. There is a semaphore in place that counts how many iterators are given out on the dictionary, which prevent some cleaning (but not the disappearance of values!) of the dictionary. So it's better if iterators on (weak) dictionaries are short-lived: a dangling one somewhere can really affect the maintenance on the dict!

That said, the methods on `WeakDict` are really just there to mirror those on the normal dict, so I'm OK with `values` and `items` following the conventions in Python3. There's a good warning in their documentations, which should nudge the conscientious programmer to double-check their approach.

For reference:
https://github.com/python/cpython/blob/main/Objects/dictobject.c#L4016 shows that in Python3, iterators can now in fact lead to errors if the underlying dict is mutated. Given that `WeakValueDict` can normally be mutated when a GC happens, we need some guard against that (and that's there! Such deletes get queued until the iterator semaphore on the weakdict reaches 0). However, other explicit mutations (adding to the dict or explicitly deleting entries) could still mutate the dict. That's currently not guarded. We could raise an error in our iterator as well. Note, however, that `PyDict_Next` still isn't guarded in Py3 and that code needs to be prudent about using it (and in a multi-threaded arrangement or one where interrupt code can touch a dict, this cannot be done fully without having a semaphore protecting the dict or something like it).

The guard on Py3 dict iterators is a little strict: a deletion is in principle safe because it won't lead to reshaping the dict; yet iterators in Py3 would throw an error for that. This leads to some strange behaviour:

```
sage: W=dict(enumerate(range(10)))                                              
sage: I=iter(W)                                                                 
sage: next(I)                                                                   
0
sage: del W[7]                                                                  
sage: W[11]=10                                                                   
sage: next(I)                                                                   
1
sage: del W[8]                                                                  
sage: next(I)                                                                   
RuntimeError: dictionary changed size during iteration
```

if the length of the dict happens to not have changed: no error, even if new elements were added! So the guard implemented in Py3 on iterators is imperfect anyway.



---

archive/issue_comments_485779.json:
```json
{
    "body": "Thanks a lot for sharing this detailed analysis!",
    "created_at": "2022-09-26T21:22:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34251#issuecomment-485779",
    "user": "mkoeppe"
}
```

Thanks a lot for sharing this detailed analysis!



---

archive/issue_comments_485780.json:
```json
{
    "body": "Sorry to revert the status on the ticket, but I think there is a mismatch in the translation currently made:\n\nIn Py3, `D.keys()`, `D.values()` and `D.items()` return *view* objects. The corresponding iterators are obtained through `iter(D.keys())` etc. The view objects act as (multi)set views on the content.\n\nCompare:\n\n```\nsage: D=dict(enumerate(range(10)));\nsage: I=D.keys()\nsage: [a for a in I] == [a for a in I]\nTrue\nsage: I=iter(D.keys())\nsage: [a for a in I] == [a for a in I]\nFalse\n```\n\nSo I'm not so sure that changing `keys()` to return `iterkeys()` rather than a list is such an improvement: the (old) list implementation actually behaves better for the test above. The proper Py2.7 method would be `viewkeys()`, but that never made it into our `WeakDictionary` implementation. See https://peps.python.org/pep-0469/\n\n**EDIT:** on the other hand, the python library itself is happy to make these iterators, which are guarded in about the same way it's done in our implementation. We should be a safer/faster drop-in replacement for `weakref.WeakValueDictionary` (see [Lib/weakref.py:218](https://github.com/python/cpython/blob/5458b7e39eb41b146c650b76e04ac67213138a82/Lib/weakref.py#L218)). So I guess iterators are OK. (a big advantage we have is that we don't do hash computations upon weakref removal. That blew up rather spectacularly, and I don't think that's been fixed in the Py3 version)",
    "created_at": "2022-09-26T23:43:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34251#issuecomment-485780",
    "user": "nbruin"
}
```

Sorry to revert the status on the ticket, but I think there is a mismatch in the translation currently made:

In Py3, `D.keys()`, `D.values()` and `D.items()` return *view* objects. The corresponding iterators are obtained through `iter(D.keys())` etc. The view objects act as (multi)set views on the content.

Compare:

```
sage: D=dict(enumerate(range(10)));
sage: I=D.keys()
sage: [a for a in I] == [a for a in I]
True
sage: I=iter(D.keys())
sage: [a for a in I] == [a for a in I]
False
```

So I'm not so sure that changing `keys()` to return `iterkeys()` rather than a list is such an improvement: the (old) list implementation actually behaves better for the test above. The proper Py2.7 method would be `viewkeys()`, but that never made it into our `WeakDictionary` implementation. See https://peps.python.org/pep-0469/

**EDIT:** on the other hand, the python library itself is happy to make these iterators, which are guarded in about the same way it's done in our implementation. We should be a safer/faster drop-in replacement for `weakref.WeakValueDictionary` (see [Lib/weakref.py:218](https://github.com/python/cpython/blob/5458b7e39eb41b146c650b76e04ac67213138a82/Lib/weakref.py#L218)). So I guess iterators are OK. (a big advantage we have is that we don't do hash computations upon weakref removal. That blew up rather spectacularly, and I don't think that's been fixed in the Py3 version)



---

archive/issue_comments_485781.json:
```json
{
    "body": "Changing status from positive_review to needs_info.",
    "created_at": "2022-09-26T23:43:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34251#issuecomment-485781",
    "user": "nbruin"
}
```

Changing status from positive_review to needs_info.



---

archive/issue_comments_485782.json:
```json
{
    "body": "Changing status from needs_info to positive_review.",
    "created_at": "2022-09-27T01:32:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34251#issuecomment-485782",
    "user": "nbruin"
}
```

Changing status from needs_info to positive_review.



---

archive/issue_comments_485783.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-09-28T23:04:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34251",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34251#issuecomment-485783",
    "user": "vbraun"
}
```

Resolution: fixed
