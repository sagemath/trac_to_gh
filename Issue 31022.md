# Issue 31022: Remove Python2 default from pickling protocol

archive/issues_031022.json:
```json
{
    "body": "CC:  @tscrim @mkoeppe\n\nPython 2 compatibility is still set as default for `SagePickler` and uses protocol 2. State of the art is Python 3 with protocol 4, and since Sage 9.0, backwards compatibility to Python 2 is not supported anymore.\n\nI suggest to set `py2combat` to `False` by default.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31259\n\n",
    "created_at": "2021-01-18T08:48:39Z",
    "labels": [
        "component: misc"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Remove Python2 default from pickling protocol",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31022",
    "user": "https://github.com/mjungmath"
}
```
CC:  @tscrim @mkoeppe

Python 2 compatibility is still set as default for `SagePickler` and uses protocol 2. State of the art is Python 3 with protocol 4, and since Sage 9.0, backwards compatibility to Python 2 is not supported anymore.

I suggest to set `py2combat` to `False` by default.

Issue created by migration from https://trac.sagemath.org/ticket/31259





---

archive/issue_comments_442616.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-01-18T08:51:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31022#issuecomment-442616",
    "user": "https://github.com/mjungmath"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_442617.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-01-18T08:53:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31022#issuecomment-442617",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_442618.json:
```json
{
    "body": "Uhh, patchbot dislikes the changes. Many doctests fail. Shouldn't protocol 4 be the standard pickling protocol in Sage, too?",
    "created_at": "2021-01-18T21:46:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31022#issuecomment-442618",
    "user": "https://github.com/mjungmath"
}
```

Uhh, patchbot dislikes the changes. Many doctests fail. Shouldn't protocol 4 be the standard pickling protocol in Sage, too?



---

archive/issue_comments_442619.json:
```json
{
    "body": "If we're going to change pickling protocol, it's going to be even more important to comprehensively test that previous version pickles can still be unpickled. Particularly, it might be necessary to up internal version code of some pickles so that we can branch the unpickling code appropriately.\n\nWe used to have a pickle jar that contained historical pickles that could be tested. This has fallen into disuse, unfortunately. Perhaps it needs to be restored (and stocked with a good supply of py2-generated pickles!).\n\nWe see time and again that people store important data in the form of pickles with the expectation it will be accessible in the future.",
    "created_at": "2021-01-19T04:43:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31022#issuecomment-442619",
    "user": "https://github.com/nbruin"
}
```

If we're going to change pickling protocol, it's going to be even more important to comprehensively test that previous version pickles can still be unpickled. Particularly, it might be necessary to up internal version code of some pickles so that we can branch the unpickling code appropriately.

We used to have a pickle jar that contained historical pickles that could be tested. This has fallen into disuse, unfortunately. Perhaps it needs to be restored (and stocked with a good supply of py2-generated pickles!).

We see time and again that people store important data in the form of pickles with the expectation it will be accessible in the future.



---

archive/issue_comments_442620.json:
```json
{
    "body": "Replying to [comment:5 nbruin]:\n> If we're going to change pickling protocol, it's going to be even more important to comprehensively test that previous version pickles can still be unpickled.\n\n> We see time and again that people store important data in the form of pickles with the expectation it will be accessible in the future.\n\n\nMakes both sense.\n\n>Particularly, it might be necessary to up internal version code of some pickles so that we can branch the unpickling code appropriately.\n\nWhat does that mean?\n\n> We used to have a pickle jar that contained historical pickles that could be tested. This has fallen into disuse, unfortunately. Perhaps it needs to be restored (and stocked with a good supply of py2-generated pickles!).\n\nWhere can I find this the remains? Do you have an example for me?",
    "created_at": "2021-01-21T22:21:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31022#issuecomment-442620",
    "user": "https://github.com/mjungmath"
}
```

Replying to [comment:5 nbruin]:
> If we're going to change pickling protocol, it's going to be even more important to comprehensively test that previous version pickles can still be unpickled.

> We see time and again that people store important data in the form of pickles with the expectation it will be accessible in the future.


Makes both sense.

>Particularly, it might be necessary to up internal version code of some pickles so that we can branch the unpickling code appropriately.

What does that mean?

> We used to have a pickle jar that contained historical pickles that could be tested. This has fallen into disuse, unfortunately. Perhaps it needs to be restored (and stocked with a good supply of py2-generated pickles!).

Where can I find this the remains? Do you have an example for me?



---

archive/issue_comments_442621.json:
```json
{
    "body": "It was removed in #24337",
    "created_at": "2021-01-21T22:47:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31022#issuecomment-442621",
    "user": "https://github.com/mkoeppe"
}
```

It was removed in #24337



---

archive/issue_comments_442622.json:
```json
{
    "body": "I am new to pickling. However what I read so far, the pickling protocol (from version 2 upwards) should be encoded in the first two bytes of the dump. Thus, one could easily check the pickling protocol before and unpickle appropriately.",
    "created_at": "2021-01-21T23:09:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31022#issuecomment-442622",
    "user": "https://github.com/mjungmath"
}
```

I am new to pickling. However what I read so far, the pickling protocol (from version 2 upwards) should be encoded in the first two bytes of the dump. Thus, one could easily check the pickling protocol before and unpickle appropriately.



---

archive/issue_comments_442623.json:
```json
{
    "body": "Replying to [comment:8 gh-mjungmath]:\n> I am new to pickling. However what I read so far, the pickling protocol (from version 2 upwards) should be encoded in the first two bytes of the dump. Thus, one could easily check the pickling protocol before and unpickle appropriately.\n\nClasses that implement their own `__reduce__` method may include a version number with it, so that when more recent versions of the unpicklers can recognize and correctly unpickle old pickles. This is in principle independent of the pickle protocol, but it could easily be that an option like `py2compat` changes the *content* of the pickle (in fact, it almost has to). So, if you're changing the default value of py2compat, then you're likely producing different pickles, which may need changes at the unpickler side. In that case, changing an internal version number may help in maintaining code that can deal with the new pickles while still maintaining the capability to decode the old ones.\n\nOn the other hand, when reading the code, it seems `py2compat` really only affects the protocol choice. So it seems the claim that `py2compat` would engage in\n\n\n```\nfixing up imports of standard library modules and types whose names changed between Python 2 and 3\n```\n\n\nseems to not be correct. I'd expect that problems arising from just a protocol change are going to be fairly mild. (Python's unpickler will definitely look at the first two bytes and choose the right protocol decoder)",
    "created_at": "2021-01-23T07:22:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31022#issuecomment-442623",
    "user": "https://github.com/nbruin"
}
```

Replying to [comment:8 gh-mjungmath]:
> I am new to pickling. However what I read so far, the pickling protocol (from version 2 upwards) should be encoded in the first two bytes of the dump. Thus, one could easily check the pickling protocol before and unpickle appropriately.

Classes that implement their own `__reduce__` method may include a version number with it, so that when more recent versions of the unpicklers can recognize and correctly unpickle old pickles. This is in principle independent of the pickle protocol, but it could easily be that an option like `py2compat` changes the *content* of the pickle (in fact, it almost has to). So, if you're changing the default value of py2compat, then you're likely producing different pickles, which may need changes at the unpickler side. In that case, changing an internal version number may help in maintaining code that can deal with the new pickles while still maintaining the capability to decode the old ones.

On the other hand, when reading the code, it seems `py2compat` really only affects the protocol choice. So it seems the claim that `py2compat` would engage in


```
fixing up imports of standard library modules and types whose names changed between Python 2 and 3
```


seems to not be correct. I'd expect that problems arising from just a protocol change are going to be fairly mild. (Python's unpickler will definitely look at the first two bytes and choose the right protocol decoder)



---

archive/issue_comments_442624.json:
```json
{
    "body": "I don't really understand the problem. The option `py2compat` is already a dead end neither passed to any other object nor stored as an attribute. Changing the default value here should therefore not affect processes elsewhere, related to this option at least.\n\nAnd if the pickler already keeps track of the protocol of the dump automatically, I don't see a problem of changing the protocol.\n\nOr is there something I miss?",
    "created_at": "2021-01-23T10:32:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31022#issuecomment-442624",
    "user": "https://github.com/mjungmath"
}
```

I don't really understand the problem. The option `py2compat` is already a dead end neither passed to any other object nor stored as an attribute. Changing the default value here should therefore not affect processes elsewhere, related to this option at least.

And if the pickler already keeps track of the protocol of the dump automatically, I don't see a problem of changing the protocol.

Or is there something I miss?



---

archive/issue_comments_442625.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-03-15T22:07:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31022#issuecomment-442625",
    "user": "https://github.com/mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_442626.json:
```json
{
    "body": "Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31022#issuecomment-442626",
    "user": "https://github.com/mkoeppe"
}
```

Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_comments_442627.json:
```json
{
    "body": "Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.",
    "created_at": "2021-12-18T19:53:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31022#issuecomment-442627",
    "user": "https://github.com/mkoeppe"
}
```

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.
