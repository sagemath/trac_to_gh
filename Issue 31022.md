# Issue 31022: Remove Python2 default from pickling protocol

Issue created by migration from https://trac.sagemath.org/ticket/31259

Original creator: @mjungmath

Original creation time: 2021-01-18 08:48:39

CC:  tscrim mkoeppe

Python 2 compatibility is still set as default for `SagePickler` and uses protocol 2. State of the art is Python 3 with protocol 4, and since Sage 9.0, backwards compatibility to Python 2 is not supported anymore.

I suggest to set `py2combat` to `False` by default.


---

Comment by @mjungmath created at 2021-01-18 08:51:37

Changing status from new to needs_review.


---

Comment by git created at 2021-01-18 08:53:47

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @mjungmath created at 2021-01-18 21:46:13

Uhh, patchbot dislikes the changes. Many doctests fail. Shouldn't protocol 4 be the standard pickling protocol in Sage, too?


---

Comment by nbruin created at 2021-01-19 04:43:52

If we're going to change pickling protocol, it's going to be even more important to comprehensively test that previous version pickles can still be unpickled. Particularly, it might be necessary to up internal version code of some pickles so that we can branch the unpickling code appropriately.

We used to have a pickle jar that contained historical pickles that could be tested. This has fallen into disuse, unfortunately. Perhaps it needs to be restored (and stocked with a good supply of py2-generated pickles!).

We see time and again that people store important data in the form of pickles with the expectation it will be accessible in the future.


---

Comment by @mjungmath created at 2021-01-21 22:21:54

Replying to [comment:5 nbruin]:
> If we're going to change pickling protocol, it's going to be even more important to comprehensively test that previous version pickles can still be unpickled.

> We see time and again that people store important data in the form of pickles with the expectation it will be accessible in the future.


Makes both sense.

>Particularly, it might be necessary to up internal version code of some pickles so that we can branch the unpickling code appropriately.

What does that mean?

> We used to have a pickle jar that contained historical pickles that could be tested. This has fallen into disuse, unfortunately. Perhaps it needs to be restored (and stocked with a good supply of py2-generated pickles!).

Where can I find this the remains? Do you have an example for me?


---

Comment by mkoeppe created at 2021-01-21 22:47:36

It was removed in #24337


---

Comment by @mjungmath created at 2021-01-21 23:09:59

I am new to pickling. However what I read so far, the pickling protocol (from version 2 upwards) should be encoded in the first two bytes of the dump. Thus, one could easily check the pickling protocol before and unpickle appropriately.


---

Comment by nbruin created at 2021-01-23 07:22:13

Replying to [comment:8 gh-mjungmath]:
> I am new to pickling. However what I read so far, the pickling protocol (from version 2 upwards) should be encoded in the first two bytes of the dump. Thus, one could easily check the pickling protocol before and unpickle appropriately.

Classes that implement their own `__reduce__` method may include a version number with it, so that when more recent versions of the unpicklers can recognize and correctly unpickle old pickles. This is in principle independent of the pickle protocol, but it could easily be that an option like `py2compat` changes the *content* of the pickle (in fact, it almost has to). So, if you're changing the default value of py2compat, then you're likely producing different pickles, which may need changes at the unpickler side. In that case, changing an internal version number may help in maintaining code that can deal with the new pickles while still maintaining the capability to decode the old ones.

On the other hand, when reading the code, it seems `py2compat` really only affects the protocol choice. So it seems the claim that `py2compat` would engage in


```
fixing up imports of standard library modules and types whose names changed between Python 2 and 3
```


seems to not be correct. I'd expect that problems arising from just a protocol change are going to be fairly mild. (Python's unpickler will definitely look at the first two bytes and choose the right protocol decoder)


---

Comment by @mjungmath created at 2021-01-23 10:32:17

I don't really understand the problem. The option `py2compat` is already a dead end neither passed to any other object nor stored as an attribute. Changing the default value here should therefore not affect processes elsewhere, related to this option at least.

And if the pickler already keeps track of the protocol of the dump automatically, I don't see a problem of changing the protocol.

Or is there something I miss?


---

Comment by mkoeppe created at 2021-03-15 22:07:04

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by mkoeppe created at 2021-12-18 19:53:12

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.
