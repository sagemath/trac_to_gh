# Issue 32412: Replace sage.doctest.external.has_* functions by Features

Issue created by migration from https://trac.sagemath.org/ticket/32649

Original creator: mkoeppe

Original creation time: 2021-10-07 18:29:08

CC:  klee jhpalmieri slabbe dimpase jdemeyer saraedum tscrim dcoudert tmonteil vdelecroix




---

Comment by mkoeppe created at 2021-10-07 19:02:52

New commits:


---

Comment by git created at 2021-10-07 19:47:16

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-10-07 19:55:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-07 22:11:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-07 22:21:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-07 22:26:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-07 23:13:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-10-07 23:44:09

Changing status from new to needs_review.


---

Comment by git created at 2021-10-08 01:48:51

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-10-08 01:55:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2021-10-08 06:38:29

Abandoning human-readable string for `name` of a feature seems to be a regression. How about adding a new attribute like `short_name` or `slug` to be used in optional tag, which defaults to the `name` (perhaps normalized) if not explicitly provided?


---

Comment by mkoeppe created at 2021-10-08 16:00:55

A regression, I don't know. If you look at the updated error messages, such as here:

```
@@ -264,7 +274,7 @@ class FeatureNotPresentError(RuntimeError):
             sage: GapPackage("gapZuHoh8Uu").require()  # indirect doctest
             Traceback (most recent call last):
             ...
-            FeatureNotPresentError: GAP package gapZuHoh8Uu is not available.
+            FeatureNotPresentError: gap_package_gapZuHoh8Uu is not available.
             `TestPackageAvailability("gapZuHoh8Uu")` evaluated to `fail` in GAP.
         """
         lines = ["{feature} is not available.".format(feature=self.feature.name)]
```

I don't think it is any less human readable than before; in particular because features have full control over how to format the `reason` for failure.


---

Comment by klee created at 2021-10-09 11:41:52

Replying to [comment:18 mkoeppe]:
> I don't think it is any less human readable than before...

I meant replacing space with underline and decapitalization etc. I am not strong on this point if the authors of the features frame are positive.


---

Comment by mkoeppe created at 2021-10-09 21:24:04

Cc'ing a few more people who have worked on `sage.features`


---

Comment by mkoeppe created at 2021-10-10 05:32:14

Replying to [comment:20 klee]:
> I meant replacing space with underline and decapitalization etc.

Yes - that's what comment:18 referred to


---

Comment by slabbe created at 2021-10-14 19:49:48

Current branch has merge conflicts with 9.5.beta3.


---

Comment by slabbe created at 2021-10-14 19:49:48

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-10-14 19:53:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-10-14 19:53:52

merged latest version of #32614


---

Comment by mkoeppe created at 2021-10-14 19:53:52

Changing status from needs_work to needs_review.


---

Comment by klee created at 2021-10-15 01:35:34

While changing `name` to fit with "optional tag" (as you did), how about adding (optional) `description` argument to keep the original plain "name"?


```python
--- a/src/sage/features/__init__.py
+++ b/src/sage/features/__init__.py
class Feature(TrivialUniqueRepresentation):
     A feature of the runtime environment
 
     INPUT:
 
     - ``name`` -- (string) name of the feature; this should be suitable as an optional tag
       for the Sage doctester, i.e., lowercase alphanumeric with underscores (``_``) allowed;
       features that correspond to Python modules/packages may use periods (``.``)
 
     - ``spkg`` -- (string) name of the SPKG providing the feature
 
+    - ``description`` -- (string) optional; plain English description of the feature
+
     - ``url`` -- a URL for the upstream package providing the feature
 
...

-    def __init__(self, name, spkg=None, url=None):
+    def __init__(self, name, spkg=None, url=None, description=None):
         r"""
         TESTS::
 
             sage: from sage.features import Feature
             sage: from sage.features.gap import GapPackage
             sage: isinstance(GapPackage("grape", spkg="gap_packages"), Feature)  # indirect doctest
             True
         """
         self.name = name
         self.spkg = spkg
         self.url = url
+        self.description = description
+
         self._cache_is_present = None
         self._cache_resolution = None
 
...
 
     def __repr__(self):
         r"""
         Return a printable representation of this object.
 
         EXAMPLES::
 
             sage: from sage.features.gap import GapPackage
             sage: GapPackage("grape")  # indirect doctest
-            Feature('gap_package_grape')
+            Feature('GAP package grape')
         """
-        return 'Feature({name!r})'.format(name=self.name)
+        description = self.description if self.description else self.name
+        return 'Feature({description!r})'.format(description=description)
```



---

Comment by mkoeppe created at 2021-10-15 01:44:17

I don't have a strong objection. But observing that (for a feature based on an spkg that is a Python distribution package), we have
- the name of the Python package
- the name of the spkg
- the short description in the SPKG.rst
- the long description in the SPKG.rst
- the classname of the feature
- the description of the feature
- the tag of the feature
- the docstring of the feature
... I considered it an improvement to cut out one of them....


---

Comment by klee created at 2021-10-15 02:06:11

Replying to [comment:27 mkoeppe]:
> I don't have a strong objection. But observing that (for a feature based on an spkg that is a Python distribution package), we have
> - the name of the Python package
> - the name of the spkg
> - the short description in the SPKG.rst
> - the long description in the SPKG.rst
> - the classname of the feature
> - the description of the feature
> - the tag of the feature
> - the docstring of the feature
> ... I considered it an improvement to cut out one of them....

There is no "tag of the feature". From the user's point of view, the others does not help. As `description` is optional, it doesn't add to the developer's burden.

If you are okay, I can upload a commit to restore the original "name"s using `description`. Still it is okay with me to drop this commit eventually for some reason...


---

Comment by mkoeppe created at 2021-10-15 02:07:26

Fine, go ahead


---

Comment by git created at 2021-10-15 04:16:56

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by klee created at 2021-10-15 04:21:54

Printing of a Feature is not changed: by `name`,  but `description` is added if present.


---

Comment by klee created at 2021-10-15 04:23:09

I am positive on the branch.

You can set it positive if you are okay with my additions.


---

Comment by mkoeppe created at 2021-10-15 04:36:53

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-10-15 04:36:53

Looking great, thanks.


---

Comment by slabbe created at 2021-10-15 07:45:41

Changing status from positive_review to needs_work.


---

Comment by slabbe created at 2021-10-15 07:45:41

Sorry, I should have said I started tests before going to sleep yesterday. Here is what I see this morning:


```
sage -t --long --random-seed=0 src/sage/features/join_feature.py
**********************************************************************
File "src/sage/features/join_feature.py", line 59, in sage.features.join_feature.JoinFeature._is_present
Failed example:
    Latte()._is_present()  # optional - latte_int
Expected:
    FeatureTestResult('LattE', True)
Got:
    FeatureTestResult('latte_int', True)
**********************************************************************
File "src/sage/features/join_feature.py", line 75, in sage.features.join_feature.JoinFeature.is_functional
Failed example:
    Latte().is_functional()  # optional - latte_int
Expected:
    FeatureTestResult('LattE', True)
Got:
    FeatureTestResult('latte_int', True)
**********************************************************************
2 items had failures:
   1 of   3 in sage.features.join_feature.JoinFeature._is_present
   1 of   3 in sage.features.join_feature.JoinFeature.is_functional
    0 tests not run because we ran out of time
    [12 tests, 2 failures, 0.01 s]
```


Everything else is fine (except the last commit about description which was not tested by me).


---

Comment by git created at 2021-10-15 09:02:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2021-10-15 09:04:41

Replying to [comment:35 slabbe]:
> Everything else is fine (except the last commit about description which was not tested by me).

Thanks for catching the failures.


---

Comment by klee created at 2021-10-15 09:04:41

Changing status from needs_work to needs_review.


---

Comment by slabbe created at 2021-10-15 10:15:18

Looks good now, that is, I get `All tests passed` with `sage -btp --optional=sage,optional,external,build src/sage/features/` now.


---

Comment by slabbe created at 2021-10-15 10:15:18

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-10-15 16:18:26

Thanks for reviewing!


---

Comment by slabbe created at 2021-10-15 18:16:29

Oups, is it too late to put it back to "needs work"? Because patchbot pyflakes says:


```
src/sage/doctest/external.py:38:1 'urllib.error' imported but unused
src/sage/doctest/external.py:39:1 'urllib.request.Request' imported but unused
src/sage/doctest/external.py:39:1 'urllib.request.urlopen' imported but unused
src/sage/doctest/external.py:40:1 'ssl.SSLContext' imported but unused

src/sage/features/graphviz.py:14:1 '.Feature' imported but unused
src/sage/features/graphviz.py:14:1 '.FeatureTestResult' imported but unused

src/sage/features/latte.py:5:1 '.Feature' imported but unused
src/sage/features/latte.py:5:1 '.FeatureTestResult' imported but unused

src/sage/features/rubiks.py:12:1 '.Feature' imported but unused
src/sage/features/rubiks.py:12:1 '.FeatureTestResult' imported but unused

found 10 pyflakes errors in the modified files
pyflakes -- 0 seconds
```


Also

```
========== coverage ==========
git checkout patchbot/ticket_merged
Full doctests in features/internet.py: 2 / 2 = 100%
Missing doctests in features/mcqd.py: 0 / 1 = 0%
Missing doctests in features/meataxe.py: 0 / 1 = 0%
Missing doctests in features/mip_backends.py: 0 / 4 = 0%
Missing doctests in features/sagemath.py: 1 / 7 = 14%
Missing doctests in features/tdlib.py: 0 / 1 = 0%
Coverage went from 50872 / 52638 = 96.645% to 50873 / 52652 = 96.621%
====================
```



---

Comment by mkoeppe created at 2021-10-15 19:33:47

Changing status from positive_review to needs_work.


---

Comment by git created at 2021-10-15 20:07:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-15 20:16:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-15 20:16:44

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-10-15 20:17:54

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-10-15 20:17:54

Here are some fixes for these style warnings, contributions welcome


---

Comment by git created at 2021-10-16 03:47:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2021-10-16 03:50:02

Added more doctests to make bots happy. I could not run tests for numerical backends (cplex, gurobi, coin) because I failed to install them.


---

Comment by mkoeppe created at 2021-10-16 03:55:48

Thank you! I'll test it with the coin backend.


---

Comment by mkoeppe created at 2021-10-16 04:04:52

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-10-20 23:01:01

Resolution: fixed
