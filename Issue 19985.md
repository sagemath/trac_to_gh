# Issue 19985: One-off doctest failures in a fresh install

Issue created by migration from https://trac.sagemath.org/ticket/20222

Original creator: defeo

Original creation time: 2016-03-16 13:43:45

CC:  jdemeyer embray nthiery

I'm getting some irrelevant doctests failures (on branch develop), due to some Matplotlib first time artifacts.


```
sage -t --long src/sage/geometry/fan.py
**********************************************************************
File "src/sage/geometry/fan.py", line 2887, in sage.geometry.fan.?.plot
Failed example:
    fan.plot()
Expected:
    Graphics object consisting of 31 graphics primitives
Got:
    doctest:273: UserWarning: Matplotlib is building the font cache using fc-list. This may take a moment.
    Graphics object consisting of 31 graphics primitives
**********************************************************************
1 item had failures:
   1 of   3 in sage.geometry.fan.?.plot
    [492 tests, 1 failure, 9.60 s]
sage -t --long src/sage/categories/coxeter_groups.py
**********************************************************************
File "src/sage/categories/coxeter_groups.py", line 1681, in sage.categories.coxeter_groups.CoxeterGroups.ElementMethods.bruhat_lower_cov
ers
Failed example:
    P.show()
Expected nothing
Got:
    doctest:273: UserWarning: Matplotlib is building the font cache using fc-list. This may take a moment.
**********************************************************************
1 item had failures:
   1 of  15 in sage.categories.coxeter_groups.CoxeterGroups.ElementMethods.bruhat_lower_covers
    [461 tests, 1 failure, 18.31 s]
```


Of course, the failures go away when the tests are rerun. Any way we can avoid these failures?


---

Comment by jdemeyer created at 2016-03-16 13:52:46

Running tests inside a fresh docker container could be a good way to check for problems like this.


---

Comment by embray created at 2016-03-16 14:15:20

Still don't have automated builds of the sagemath-develop container running yet, but hope to have that sooner or later.


---

Comment by jdemeyer created at 2016-10-25 07:02:56

Changing component from doctest framework to build.


---

Comment by jdemeyer created at 2016-10-25 07:02:56

Changing priority from minor to major.


---

Comment by jdemeyer created at 2016-10-25 07:03:37

Can't we simply ignore these warnings?


---

Comment by defeo created at 2016-10-25 09:40:10

Replying to [comment:4 jdemeyer]:
> Can't we simply ignore these warnings?

What's the standard way to ignore warnings in doctests, again?


---

Comment by embray created at 2016-11-07 13:06:35

I wonder if the initial sage startup shouldn't also take care of this.


---

Comment by jdemeyer created at 2016-11-07 13:23:13

Replying to [comment:6 embray]:
> I wonder if the initial sage startup shouldn't also take care of this.

That's not really possible because the relevant matplotlib files are _user_ files (inside `$DOT_SAGE`, which is typically in `$HOME`), not _system_ files.


---

Comment by embray created at 2016-11-07 14:36:39

I think I see what you're saying--I'm so used at this point to running my own copy of sage that it's warped my viewpoint in ugly ways :)

But isn't there some initial creation of user files in `$DOT_SAGE` the first time a user runs Sage?  That's what I meant.


---

Comment by mkoeppe created at 2017-01-01 03:15:59

Upstream issue: https://github.com/matplotlib/matplotlib/issues/5836


---

Comment by jdemeyer created at 2017-06-14 09:38:57

New commits:


---

Comment by jdemeyer created at 2017-06-14 09:38:57

Changing status from new to needs_review.


---

Comment by embray created at 2017-06-14 09:55:05

Changing status from needs_review to positive_review.


---

Comment by embray created at 2017-06-14 09:55:05

Huh, I thought this was already fixed.  I haven't run into it in a while.


---

Comment by vbraun created at 2017-06-14 22:44:56

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2017-06-14 22:44:56


```
sage -t --long --warn-long 81.6 src/sage/tests/startup.py
**********************************************************************
File "src/sage/tests/startup.py", line 6, in sage.tests.startup
Failed example:
    'numpy' in sys.modules
Expected:
    False
Got:
    True
**********************************************************************
File "src/sage/tests/startup.py", line 8, in sage.tests.startup
Failed example:
    'pyparsing' in sys.modules
Expected:
    False
Got:
    True
**********************************************************************
1 item had failures:
   2 of   7 in sage.tests.startup
    [6 tests, 2 failures, 1.47 s]
```



---

Comment by git created at 2017-06-19 09:18:24

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-06-19 09:20:56

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-06-19 09:22:20

New version which imports matplotlib in a forked child process.


---

Comment by jdemeyer created at 2017-06-19 09:22:20

Changing status from needs_work to needs_review.


---

Comment by git created at 2017-10-25 09:28:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by saraedum created at 2018-01-14 01:56:10

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-01-15 22:29:37

Resolution: fixed


---

Comment by jhpalmieri created at 2018-05-16 18:29:01

I'm seeing these failures again in 8.3.beta1.


---

Comment by jhpalmieri created at 2018-05-16 18:29:15

See #25375 for a followup ticket.
