# Issue 15343: prereq tarball is missing

Issue created by migration from https://trac.sagemath.org/ticket/15580

Original creator: jdemeyer

Original creation time: 2013-12-24 09:40:37

CC:  ohanar vbraun

After downloading Sage 6.0 either from git or from the `.tar.gz` sdist tarball, the prereq tarball `prereq-1.2.tar.gz` is missing. This is a huge problem, because many checks are skipped because of this.


---

Comment by ohanar created at 2013-12-24 11:27:35

Actually `prereq-1.2.tar.gz` should work if you drop it into the `upstream` directory, but since it was different, it didn't receive any of the extra treatment the other packages got.


---

Comment by jdemeyer created at 2013-12-24 11:36:35

Replying to [comment:2 ohanar]:
> Actually `prereq-1.2.tar.gz` should work if you drop it into the `upstream` directory
OK, I see that. But it's not distributed by default.


---

Comment by jdemeyer created at 2013-12-27 12:29:58

If somebody can merge the prereq tarball contents in the git repo, I can easily do the rest.


---

Comment by ohanar created at 2013-12-28 09:23:41

I've exported `prereq-1.2`'s history to the root directory with no cleanup (e.g. there is still the hgignore).
----
New commits:


---

Comment by jdemeyer created at 2013-12-28 17:39:43

I have a patch ready, but I need to rebuild Sage before it can be uploaded...


---

Comment by jdemeyer created at 2013-12-28 21:49:58

Not yet ready for review, requires more work.


---

Comment by jdemeyer created at 2013-12-28 23:36:36

Changing status from new to needs_review.


---

Comment by git created at 2013-12-29 00:09:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2013-12-29 10:37:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ohanar created at 2013-12-30 05:33:08

Looks fine to me, so long as someone can review my reviewer commit. (It is just restoring a small regression of `sage-sdist`.)
----
New commits:


---

Comment by ohanar created at 2013-12-30 05:36:44

One comment I have is that having a toplevel configure script might confuse those not familiar with sage's odd build system. Maybe we should move it to be under the build directory?


---

Comment by jdemeyer created at 2013-12-30 10:07:58

Replying to [comment:15 ohanar]:
> One comment I have is that having a toplevel configure script might confuse those not familiar with sage's odd build system. Maybe we should move it to be under the build directory?

My hope is to converge to a more standard build system, so having `./configure` at the top-level makes the most sense. And even if it confuses people, doing `./configure && make` like the usual packages still works.


---

Comment by jdemeyer created at 2013-12-30 10:15:27

Replying to [comment:14 ohanar]:
> Looks fine to me, so long as someone can review my reviewer commit. (It is just restoring a small regression of `sage-sdist`.)
I don't think there is a regression to be fixed there. It's true that `python setup.py` is run indeed because of my patch, but why is that a problem? I never liked the `[ -z "$$SAGE_INSTALL_FETCH_ONLY" ]` in `build/deps` and I want to remove that. The only reason I didn't do that on this ticket is to avoid potential merge conflicts. And reusing the `$(INST)/sage` build rule to copy the sources makes both `build/deps` and `sage-sdist` harder to understand for no good reason.

So my proposal is still to merge my patch as-is, but of course I'm listening to suggestions...


---

Comment by ohanar created at 2013-12-30 11:23:32

Replying to [comment:17 jdemeyer]:
> I don't think there is a regression to be fixed there. It's true that `python setup.py` is run indeed because of my patch, but why is that a problem?
It requires that all of the sage libraries dependencies to already be built (otherwise it will bail). Before this branch, you could clone a sage repository, and without running `make`, you could run (without error) `sage -sdist`.

This was not true back in mercurial land, but then again, `sage-sdist` had to be a lot more complicated since there were a number of repositories to manage.

I think that the best solution to these issues are to include the package type (and dependencies) in the metadata of each individual package. Right now you have to do this psuedo-build to pull just the standard packages (since the only thing that records them as standard is that they are a dependency of sage in `build/deps`).

I would propose my additional commit for now (or some alternative to restore `sage -sdist` for freshly cloned repos), and open a new ticket to introduce the extra metadata.


---

Comment by ohanar created at 2013-12-30 11:23:57

Replying to [comment:16 jdemeyer]:
> My hope is to converge to a more standard build system, so having `./configure` at the top-level makes the most sense. And even if it confuses people, doing `./configure && make` like the usual packages still works.

Ok, sounds good.


---

Comment by jdemeyer created at 2013-12-30 11:39:18

Replying to [comment:18 ohanar]:
> and open a new ticket to introduce the extra metadata.
On the other hand, I don't like the idea of storing the same information (which packages are "standard") twice.


---

Comment by jdemeyer created at 2013-12-30 11:42:13

Replying to [comment:18 ohanar]:
> Replying to [comment:17 jdemeyer]:
> > I don't think there is a regression to be fixed there. It's true that `python setup.py` is run indeed because of my patch, but why is that a problem?
> It requires that all of the sage libraries dependencies to already be built (otherwise it will bail). Before this branch, you could clone a sage repository, and without running `make`, you could run (without error) `sage -sdist`.
OK, I get it. I'm not convinced that the extra complication is justified for this use-case, but I'll fix it (but hopefully in a simpler way than your patch).


---

Comment by jdemeyer created at 2013-12-30 11:42:13

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2013-12-30 11:50:12

I think this is sufficient

```diff
commit 0255a2a53e9aebaf54c0fab335ef0202a6b77ae8
Author: Jeroen Demeyer <jdemeyer@cage.ugent.be>
Date:   Mon Dec 30 12:47:06 2013 +0100

    Allow sage --sdist without building Sage

diff --git a/src/bin/sage-clone-source b/src/bin/sage-clone-source
index aabc452..090466b 100755
--- a/src/bin/sage-clone-source
+++ b/src/bin/sage-clone-source
@@ -20,7 +20,7 @@ SRC="$1"
 DST="$2"
 
 rm -rf "$DST"
-mkdir "$DST"
+mkdir -p "$DST"
 
 git clone "$SRC" "$DST"
 
diff --git a/src/bin/sage-sdist b/src/bin/sage-sdist
index 3a554b6..1aee0cc 100755
--- a/src/bin/sage-sdist
+++ b/src/bin/sage-sdist
@@ -46,7 +46,9 @@ sage-clone-source "$SAGE_ROOT" "$TMP_DIR/$TARGET"
 # Download and copy all upstream tarballs (the -B option to make forces
 # all targets to be built unconditionally)
 cd "$SAGE_ROOT/build"
-SAGE_INSTALL_GCC=yes SAGE_SPKG_OPTS="-f -d" SAGE_SPKG_COPY_UPSTREAM="$TMP_DIR/$TARGET/upstream" ./install -B all
+SAGE_INSTALL_GCC=yes SAGE_SPKG_COPY_UPSTREAM="$TMP_DIR/$TARGET/upstream" \
+SAGE_INSTALL_FETCH_ONLY=yes SAGE_SPKG_OPTS="-f -d" \
+./install -B all
 
 # Create source .tar.gz
 cd "$TMP_DIR"
```



---

Comment by jdemeyer created at 2013-12-30 13:57:08

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2013-12-30 13:57:08

New commits:


---

Comment by ohanar created at 2013-12-31 05:44:08

Sure, this is fine.


---

Comment by ohanar created at 2013-12-31 05:44:08

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-12-31 10:10:50

Does this imply also a positive review to #15596 by transitivity?


---

Comment by vbraun created at 2014-01-04 02:47:26

Fails on mod:

```
configure.ac:21: error: Autoconf version 2.63 or higher is required
configure.ac:21: the top level
autom4te: /usr/bin/m4 failed with exit status: 63
aclocal: autom4te failed with exit status: 63
```



---

Comment by jdemeyer created at 2014-01-04 10:22:17

Replying to [comment:26 vbraun]:
> Fails on mod:
> {{{
> configure.ac:21: error: Autoconf version 2.63 or higher is required
> configure.ac:21: the top level
> autom4te: /usr/bin/m4 failed with exit status: 63
> aclocal: autom4te failed with exit status: 63
> }}}
Of course it fails, installing from `git` now requires a recent enough version of autotools (this is true for many projects, it's not the fault of Sage).

If you're bothered by this, you could drop the `git` builder on `mod` and only build from the source tarball (which doesn't require autotools).


---

Comment by jdemeyer created at 2014-01-04 12:01:32

Why does it say "does not merge cleanly"? It merges cleanly for me...


---

Comment by vbraun created at 2014-01-04 18:08:20

Andrew is working on the git plugin this week, so its possibly not accurate at the moment.

Do we really need ac 2.63, which is only about 5 years old? 2.61 doesn't work? Also I don't see the new dependency being documented.

In any case, I think OSX users will be in a world of hurt if we merge this. I take it you are volunteering to walk them through autoconf installation? ;-)


---

Comment by ohanar created at 2014-01-04 21:56:26

Replying to [comment:28 jdemeyer]:
> Why does it say "does not merge cleanly"? It merges cleanly for me...

This particular merge confuses a lot of git tools since there is a new root in your branch. I should be rolling out the new plugin later today, but it won't fix this ticket (or this sort of issue). In the long run, these sorts of merge issues should disappear as all the old repositories get merged.


---

Comment by vbraun created at 2014-01-05 00:40:39

I discussed this with Andrew and we agreed to just package the autogenerated files into a tarball, and make it so that the "make configure" target automatically updates the tarball / checksum.ini. Objections?


---

Comment by jdemeyer created at 2014-01-05 09:47:38

Replying to [comment:29 vbraun]:
> Andrew is working on the git plugin this week, so its possibly not accurate at the moment.
> 
> Do we really need ac 2.63, which is only about 5 years old? 2.61 doesn't work?
Probably, but I can easily check to be sure.

> Also I don't see the new dependency being documented.
Well, building directly from the git repo isn't documented anywhere AFAIK, that would be the natural place to document the extra dependency.


---

Comment by jdemeyer created at 2014-01-05 09:49:28

Replying to [comment:31 vbraun]:
> I discussed this with Andrew and we agreed to just package the autogenerated files into a tarball. Objections?
No objections in principle. But this tarball should not be treated like other "upstream" tarballs. I prefer a direct call to `sage-download-file`, without going through `sage-spkg` and checksum checking.

I think creating this tarball should be left to `sage --sdist`, I don't see the point of recreating it every time you run `autoconf`.


---

Comment by jdemeyer created at 2014-01-05 10:12:50

I am working on this.


---

Comment by jdemeyer created at 2014-01-05 10:12:50

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2014-01-05 10:31:09

You're right, `autoconf` version 2.60 does work (2.59 does not).


---

Comment by vbraun created at 2014-01-05 18:09:45

Replying to [comment:34 jdemeyer]:
> I think creating this tarball should be left to `sage --sdist`, I don't see the point of recreating it every time you run `autoconf`.

If we want to treat that tarball like all other tarballs then we need to commit its checksum *before* running `sage -sdist`. Also, for testing it would be nice to run the new tarball through the buildbot before releasing it. Of course that can be worked around by running `sage -sdist` twice but then thats hardly ideal. 

And while one could treat it completely different from the other tarballs, I don't see why we have to give up checksumming here.


---

Comment by jdemeyer created at 2014-01-05 18:36:43

Replying to [comment:37 vbraun]:
> I don't see why we have to give up checksumming here.
Because checksumming is done is `sage-spkg` and this tarball wouldn't `sage-spkg`. And I would very much be against using `sage-spkg` for this, since it would be the upside-down world. Normally, `configure` is run as very first thing in a build and it might for example be used to configure `sage-spkg`. This currently isn't the case, but we should plan for it.


---

Comment by vbraun created at 2014-01-05 19:11:12

Either way you need a script somewhere that a) does not depend on configure output and b) downloads a tarball and run the `spkg-install` script. If we want to auto-generate the equivalent of a `sage-spkg` script then we can just give it a different name, no?


---

Comment by jdemeyer created at 2014-01-05 19:20:53

Replying to [comment:39 vbraun]:
> Either way you need a script somewhere that a) does not depend on configure output and b) downloads a tarball and run the `spkg-install` script.
I don't understand what you're saying here. We need a script that
1. does not depend on configure output
1. downloads a tarball
but that script does not need to
1. check checksums
1. run `spkg-install`

I also really don't want to come up with an overkill solution for this. Personally, I'd be happy to simply say "if you want to build from `git`, make sure you have autotools installed". There's always the source tarball which doesn't require autotools and once you've built Sage, you could install the autotools package, or simply hope that an outdated `configure` script is still fine.


---

Comment by vbraun created at 2014-01-05 19:27:46

I also want to make it as easy as possible, this is why I'm suggesting to just treat it as every other tarball instead of a custom script just for that one.


---

Attachment

Volker, are you able to put files in the `upstream` directory on the server? If so, please do that for [attachment:configure-6.1.beta2.tar.gz]


---

Comment by git created at 2014-01-05 21:41:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2014-01-05 21:43:03

This is the simplest solution I could come up with which should work...
----
New commits:
----
New commits:


---

Comment by jdemeyer created at 2014-01-05 21:43:10

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2014-01-06 04:14:25

I don't like the fact that I can't test the updated tarball on the buildbot without bumping the version. This slows down the release process as I have to bump version and re-run the buildbot. For a release I just want to bump the version and publish it immediately afterward. Any other change can break things, so requres testing, ie. another day twiddling thumbs.


---

Comment by jdemeyer created at 2014-01-06 08:24:25

Replying to [comment:46 vbraun]:
> I don't like the fact that I can't test the updated tarball on the buildbot without bumping the version. This slows down the release process as I have to bump version and re-run the buildbot.
I thought you were using a private git repo for the buildbot? In that case, you could easily do the version bump only in your private repo. Alternatively, point `$SAGE_UPSTREAM` to a place you control.

My philosophy with the buildbot was to always test the *exact* source tarball that I would release. If you're testing first, then changing the version number, then `sdist`, something could go wrong in those last two steps and you would never notice.

And yes, there has been at least one bug which dependended on the length of the Sage version number, so it can happen.


---

Comment by vbraun created at 2014-01-06 08:30:26

I'm not testing the source tarball at all, its much faster to do incremental builds for git commits with occasional full rebuilds.


---

Comment by jdemeyer created at 2014-01-06 08:34:17

Replying to [comment:48 vbraun]:
> its much faster to do incremental builds for git commits with occasional full rebuilds.
Even then, I still don't understand why this patch prevents you from testing properly.


---

Comment by vbraun created at 2014-01-06 08:36:50

It doesn't prevent me from testing, but it makes it slower and involves more steps than it should.


---

Comment by jdemeyer created at 2014-01-06 08:44:21

Replying to [comment:50 vbraun]:
> It doesn't prevent me from testing, but it makes it slower and involves more steps than it should.
Why slower? I don't understand the problem...


---

Comment by vbraun created at 2014-01-06 08:52:14

I want to have a workflow where I merge branches, test, and once it works slap on the new version and release. Bumping the version should not require another test run. Bumping the version just to make the new configure-x.y.z tarball and then resetting to before the version bump is also not desirable.


---

Comment by jdemeyer created at 2014-01-06 09:01:52

Replying to [comment:52 vbraun]:
> I want to have a workflow where I merge branches, test, and once it works slap on the new version and release. Bumping the version should not require another test run. Bumping the version just to make the new configure-x.y.z tarball and then resetting to before the version bump is also not desirable. 

Why not the following workflow:
1. In volker's private repo, bump the version number and merge various patches
2. Run `sage --sdist` to generate the configure tarball
3. Put the configure tarball in some accessible place
4. Run the buildbots on Volker's private repo
5. If tests pass, merge Volker's repo with the official repo.

(Ideally, I would argue there should also be a 4b. Run at least one buildbot on the source tarball instead of the git repo)

What alternative would you propose? You need to generate the configure tarball anyway before you can test it, regardless of any version bumps...


---

Comment by vbraun created at 2014-01-06 09:16:56

Since we don't put the version into `AC_INIT` we don't have to bump the tarball at all with each version. Not doing anything is always the easiest and least error-prone.

Just increment configure-n.tar, configure-(n+1).tar, ... each time you have to re-run autoconf (i.e. `make configure` / `autogen.sh`).


---

Comment by vbraun created at 2014-01-06 09:20:53

Also, I've been bumping the version in the source and tagging the new version at the same commit. IMHO having version and tag match is the easiest to understand for others. That requires me to bump the version at the end of the beta series.


---

Comment by jdemeyer created at 2014-01-06 09:21:02

Replying to [comment:54 vbraun]:
> we don't put the version into `AC_INIT`
That's "fixed" in #15606, but it's not really important anyway.

> Not doing anything is always the easiest and least error-prone.
I disagree. Doing the same thing every time (i.e. always changing the version number) is always the easiest and least error-prone. Special cases are often the cause for errors.

> Just increment configure-n.tar, configure-(n+1).tar, ... each time you have to re-run autoconf (i.e. make configure / autogen.sh).
And how are you going to implement this auto-incrementing and keeping track of which number to use... this seems far more complicated than my proposal.


---

Comment by jdemeyer created at 2014-01-06 09:25:50

Replying to [comment:55 vbraun]:
> Also, I've been bumping the version in the source and tagging the new version at the same commit. IMHO having version and tag match is the easiest to understand for others. That requires me to bump the version at the end of the beta series.
One could argue that the new version "starts" right after the old tag. The first commit after sage-6.1.beta4 belongs to sage-6.1.beta5, so I would find it logical that checking out that commit would give the new version number.


---

Comment by vbraun created at 2014-01-06 09:29:58

On can certainly argue for other ways of labeling things. In the end, doing it this way is one step vs. two separate steps, so its easier for me.

Replying to [comment:56 jdemeyer]:
> And how are you going to implement this auto-incrementing and keeping track of which number to use..

Easy, there will be a `build/pkgs/configure/package-version.txt` that contains the integer `n`. Reading it and incrementing it by one is standard bash `$[n+1]`


---

Comment by git created at 2014-01-06 10:15:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2014-01-06 10:17:00

Do you like this better?


---

Comment by vbraun created at 2014-01-06 22:08:58

Looks good. Is there an argument against automatically increasing the version number whenever you re-run autoconf? Skipping configure-$version numbers costs us nothing, but forgetting to increase it will potentially cause major problems. 

Also, filling out the other files (e.g. checksums.ini) in the `build/pkgs/configure` files will make it easier to manage the upstream directory on the sagemath web server in a unified manner.


---

Comment by jdemeyer created at 2014-01-07 07:40:00

Replying to [comment:61 vbraun]:
> Looks good. Is there an argument against automatically increasing the version number whenever you re-run autoconf? Skipping configure-$version numbers costs us nothing, but forgetting to increase it will potentially cause major problems.
Would you agree with increasing the version number automatically in `sage-update-version`?


---

Comment by vbraun created at 2014-01-07 07:58:47

My main question is whether we are going to hardcode the current version into the autogenerated scripts or not (see #15606). If that is the case then we of course should save the new autogenerated stuff in `sage-update-version`. If not then there would be no need to tie version to the autogenerated scripts, so we should not.


---

Comment by jdemeyer created at 2014-01-07 08:43:47

Replying to [comment:63 vbraun]:
> My main question is whether we are going to hardcode the current version into the autogenerated scripts or not (see #15606).
I propose to do so indeed.


---

Comment by vbraun created at 2014-01-07 09:25:03

Ok, fine. Thats imho the right thing to do, keep the version in configure.ac and then generate all other files that contain the version form .in files at configure time.

I'd still prefer to not use the Sage version as the configure tarball version since it'll be potentially confusing to test different configure tarballs on the buildbot if it needs to be debugged.


---

Comment by git created at 2014-01-07 11:46:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2014-01-07 11:48:50

OK, new approach. I now have a script `src/bin/sage-autogen` which takes care of creating the configure tarball and computing the checksum. It can optionally (with the `-i` option) increase the version number. This script is never run automatically, it must be explicitly called by the release manager. But then the release manager can freely choose when to do this.


---

Comment by jdemeyer created at 2014-01-08 15:08:57

Replying to [comment:48 vbraun]:
> I'm not testing the source tarball at all
I think that's a mistake. If something breaks `sage-sdist`, you need to know.


---

Comment by vbraun created at 2014-01-11 22:05:13

At the end of the day, the git repo is the authorative download. The source tarball is added as a convenience, but I don't think there is a point in worrying too much about it.


---

Comment by vbraun created at 2014-01-12 02:49:19

Gnu recommends `./bootstrap` (http://www.gnu.org/software/automake/faq/autotools-faq.html#What-does-_002e_002fbootstrap-or-_002e_002fautogen_002esh-do_003f} instead of autogen.

Also, the new configure tarball needs to be committed together with the version number change (and should eventually **become** the version number change) to end up with the correct tag.

I'll implement these changes...


---

Comment by vbraun created at 2014-01-12 03:42:08

I agree with everything so far, only my final commits need review.
----
New commits:


---

Comment by jdemeyer created at 2014-01-12 06:46:30

In `SPKG.txt`, _They are shippd_ [sic] _with_ is not a sentence.


---

Comment by jdemeyer created at 2014-01-12 06:46:30

Changing status from needs_review to needs_work.


---

Comment by git created at 2014-01-12 16:51:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2014-01-12 19:45:06

Volker: I'm fine with your patch, modulo a few details in my reviewer commit.


---

Comment by jdemeyer created at 2014-01-12 19:45:06

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2014-01-12 19:45:30

New commits:


---

Comment by jdemeyer created at 2014-01-13 09:04:29

Replying to [comment:69 vbraun]:
> At the end of the day, the git repo is the authorative download. The source tarball is added as a convenience
Given that the [Sage home page](http://www.sagemath.org/) only has links to the source and binary tarballs, I'd say the opposite is true.

> but I don't think there is a point in worrying too much about it.
Perhaps not, but this ticket could certainly break sdists. So if you don't want automated testing, you should at least try building from an sdist generated after this ticket.


---

Comment by vbraun created at 2014-01-14 05:16:57

Breaks incremental builds on mod:

```
configure:2803: $? = 1
configure:2826: checking for C compiler default output file name
configure:2853: gcc   -I/mnt/SSD1/mod_buildslave/sage_git/build/local/include  -L/mnt/SSD1/mod_buildslave/sage_git/build/local/lib conftest.c  >&5
/mnt/SSD1/mod_buildslave/sage_git/build/local/libexec/gcc/x86_64-unknown-linux-gnu/4.7.3/cc1: error while loading shared libraries: libmpc.so.3: cannot open shared object file: No such file or directory
configure:2856: $? = 1
configure:2894: result: 
configure: failed program was:
configure:2901: error: C compiler cannot create executables
See `config.log' for more details
```

Why does it even know about the `$SAGE_LOCAL` paths? The part should also set up `LD_LIBRARY_PATH`...


---

Comment by vbraun created at 2014-01-14 05:24:54

Btw the "See `config.log' for more details" is kind of impractical. It would be nice if the config.log would be inserted into the prereq.log file, especially if something goes wrong.


---

Comment by vbraun created at 2014-01-14 05:25:52

Full rebuild works on mod, for the record.


---

Comment by jdemeyer created at 2014-01-14 07:58:00

Replying to [comment:79 vbraun]:
> Why does it even know about the `$SAGE_LOCAL` paths? The part should also set up `LD_LIBRARY_PATH`...

Could it be a bug in your build scripts?

In any case, if the full build works, I wouldn't worry too much...


---

Comment by jdemeyer created at 2014-01-14 07:59:23

Replying to [comment:80 vbraun]:
> Btw the "See `config.log' for more details" is kind of impractical. It would be nice if the config.log would be inserted into the prereq.log file, especially if something goes wrong.
OK, I'll have a look at that in #15606.


---

Comment by jdemeyer created at 2014-01-14 09:07:37

Replying to [comment:79 vbraun]:
> Why does it even know about the `$SAGE_LOCAL` paths? The part should also set up `LD_LIBRARY_PATH`...
It seems you discovered a very old bug. `build/install` adds `SAGE_LOCAL/bin` to the `PATH`, but doesn't change `LD_LIBRARY_PATH`.


---

Comment by jdemeyer created at 2014-01-14 10:15:26

The reason that the bug hasn't been seen before is that `configure` was never re-run after upgrading.


---

Comment by git created at 2014-01-14 11:57:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2014-01-14 16:40:49

Mirror directory layout is `SAGE_UPSTREAM/configure/configure-n.tar.gz`, for the record


---

Comment by vbraun created at 2014-01-14 16:55:40

Still fails on mark/skynet:

```
make[1]: Entering directory `/home/buildbot/build/sage/mark-1/sage_git/build/build'
make[1]: warning: -jN forced in submake: disabling jobserver mode.
make[1]: Warning: File `Makefile' has modification time 6.4e+02 s in the future
make -j2 base
make[2]: Entering directory `/home/buildbot/build/sage/mark-1/sage_git/build/build'
make[2]: warning: -jN forced in submake: disabling jobserver mode.
make[2]: Warning: File `Makefile' has modification time 6.4e+02 s in the future
/home/buildbot/build/sage/mark-1/sage_git/build/build/pipestatus "./prereq.sh 2>&1" "tee -a /home/buildbot/build/sage/mark-1/sage_git/build/logs/pkgs/prereq.log"
Starting prerequisite check.
Machine: SunOS mark 5.10 Generic_127111-01 sun4u sparc SUNW,Sun-Blade-2500

make[3]: Entering directory `/home/buildbot/build/sage/mark-1/sage_git/build'
make[3]: warning: -jN forced in submake: disabling jobserver mode.
make[3]: Warning: File `Makefile' has modification time 5.5e+02 s in the future
test -f config/missing || make -j2 config/missing || \
		bash -c 'source src/bin/sage-env; sage-download-file $SAGE_UPSTREAM/configure/configure-`cat build/pkgs/configure/package-version.txt`.tar.gz | tar zxf -'
config/missing --run aclocal -I m4
config/missing: aclocal: not found
make[3]: *** [configure] Error 1
make[3]: warning:  Clock skew detected.  Your build may be incomplete.
make[3]: Leaving directory `/home/buildbot/build/sage/mark-1/sage_git/build'
make[2]: *** [/home/buildbot/build/sage/mark-1/sage_git/build/local/var/lib/sage/installed/prereq] Error 2
make[2]: Target `base' not remade because of errors.
make[2]: warning:  Clock skew detected.  Your build may be incomplete.
make[2]: Leaving directory `/home/buildbot/build/sage/mark-1/sage_git/build/build'
make[1]: *** [all] Error 2
make[1]: warning:  Clock skew detected.  Your build may be incomplete.
make[1]: Leaving directory `/home/buildbot/build/sage/mark-1/sage_git/build/build'
```

----
New commits:


---

Comment by jdemeyer created at 2014-01-14 21:02:37

Not tested, but I guess this should help.
----
New commits:


---

Comment by vbraun created at 2014-01-15 03:05:36

How is that supposed to change anything? The `aclocal.m4' is not in the confball, so you need aclocal to generate it. The job of the "missing" script is to mangle the timestamps as if aclocal has run, but you still need the file whose timestamp is to be changed.


---

Comment by vbraun created at 2014-01-15 03:28:24

PS: What running with bash does give you is the proper warning before it errors out:

```
WARNING: 'aclocal' is missing on your system.
         You should only need it if you modified 'acinclude.m4' or
         'configure.ac' or m4 files included by 'configure.ac'.
         The 'aclocal' program is part of the GNU Automake package:
         <http://www.gnu.org/software/automake>
         It also requires GNU Autoconf, GNU m4 and Perl in order to run:
         <http://www.gnu.org/software/autoconf>
         <http://www.gnu.org/software/m4/>
         <http://www.perl.org/>
make[3]: *** [configure] Error 127
```



---

Comment by vbraun created at 2014-01-15 03:29:34

PPS: any thoughts on enabling `AM_MAINTAINER_MODE`?


---

Comment by vbraun created at 2014-01-15 05:31:06

I guess disabling maintainer mode is only interesting when you actually run the automake-generated makefile. But we probably should, then. I'll put it in for now.

In any case, we should only run autotools from the bootstrap script. As long as we don't use the automake output there are no timestamp issues.
----
New commits:


---

Comment by jdemeyer created at 2014-01-15 07:38:31

I disagree with `./sage -f configure` since I absolutely don't want `configure` to act like a spkg. I prefer `configure` to have as few dependencies as possible. I much prefer to not depend on `sage-spkg` (and preferably also not on `build/install` nor `sage-env`, but that's harder for now).

Also, what was wrong with bootstrapping from the top-level `Makefile`? Doesn't the `missing` script work properly? I like the fact that `configure` gets regenerated automatically when I edit `configure.ac`.


---

Comment by jdemeyer created at 2014-01-15 07:52:36

Replying to [comment:92 vbraun]:
> How is that supposed to change anything? The `aclocal.m4' is not in the confball, so you need aclocal to generate it.
OK, I forgot to add that file, no big deal.


---

Comment by jdemeyer created at 2014-01-15 08:15:47

Hmm, it seems that `missing` has changed functionality. Now it doesn't really do anything, except for printing a more verbose error message. Old versions of `missing` did indeed touch the files.


---

Comment by jdemeyer created at 2014-01-15 13:32:36

Volker, this patch simply stops using the `missing` script while keeping the rest of the bootstrap process.
----
New commits:


---

Comment by vbraun created at 2014-01-15 14:37:10

bootstrap shouldn't call make to do its business, usually it would run automake to generate the makefile. But we can also disentangle that later if you prefer.

AFAIK we do guarantee that "sage -f" works even before building Sage, so that you can install replacements for certain optional build-time dependencies (e.g. ccache). Not using that mechanism means that "make download" won't work, for example. Not to mention that it duplicates the sagemath upstream url, doesn't verify the checksum, etc. I don't necessarily care so much about using it, just wanted to make sure that you thought about the potential downsides of downloading the confball manually.


---

Comment by vbraun created at 2014-01-15 14:38:28

PS: I agree that missing changed and should be treated as implementation details for the autotools, i.e., do not call directly.


---

Comment by jdemeyer created at 2014-01-15 14:55:30

Replying to [comment:102 vbraun]:
> AFAIK we do guarantee that "sage -f" works even before building Sage, so that you can install replacements for certain optional build-time dependencies (e.g. ccache). Not using that mechanism means that "make download" won't work, for example. Not to mention that it duplicates the sagemath upstream url, doesn't verify the checksum, etc. I don't necessarily care so much about using it, just wanted to make sure that you thought about the potential downsides of downloading the confball manually. 
I was thinking of moving towards a more typical "configure + make" model. Then `./sage -f` should be guaranteed to work only _after_ `./configure` but before `make`. What we actually want for optional packages would be something like

```
$ ./configure --enable-ccache --enable-build-gcc --enable-mirror=http://example.com/ --optional-packages=database_gap
$ make
```



---

Comment by jdemeyer created at 2014-01-15 14:57:30

Replying to [comment:102 vbraun]:
> bootstrap shouldn't call make to do its business, usually it would run automake to generate the makefile. But we can also disentangle that later if you prefer.
Perhaps you are right. But I would indeed prefer to do that later, especially since #15606 changes the bootstrap process also.


---

Comment by vbraun created at 2014-01-15 15:17:42

Replying to [comment:104 jdemeyer]:
> {{{
> $ ./configure --enable-ccache --enable-build-gcc --enable-mirror=http://example.com/ --optional-packages=database_gap
> }}}

Sounds good to me, but does not have to prevent `sage -f` from working (with sane defaults) before configure is run. If you want to change the mirror url then you just have to have your own set of autotools.


---

Comment by jdemeyer created at 2014-01-15 20:19:42

Replying to [comment:106 vbraun]:
> Sounds good to me, but does not have to prevent `sage -f` from working (with sane defaults) before configure is run.
I'd say: let's see how things evolve. I will not actively prevent `sage -f` from working.


---

Comment by vbraun created at 2014-01-15 20:23:05

fine with me...


---

Comment by vbraun created at 2014-01-15 20:23:05

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-01-16 04:50:34

Another side effect of treating the confball different:

```
vbraun@boxen:~/Sage/git$ git clone ...
vbraun@boxen:~/Sage/git$ ./sage -sdist
Sage version 6.1.beta5, release date 2014-01-15
Error: configure tarball '/home/vbraun/Sage/git/upstream/configure-3.tar.gz' does not exist.
```



---

Comment by vbraun created at 2014-01-16 05:10:37

Resolution: fixed
