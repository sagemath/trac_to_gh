# Issue 30863: Memory leak with multivariate polynomial evaluation in finite field

archive/issues_030863.json:
```json
{
    "body": "CC:  @slel\n\nKeywords: memory\n\nI observed a memory leak (tested with sage 9.1.) when evaluating a multivariate polynomial with coefficients in a finite field, see the following code:\n\n\n```\nn = 4\nF.<h> = GF(2^n)\nP.<x,y,z> = PolynomialRing(F)\n\ng = x^5 + y^7 + h*x*y + h**2*x^2*z^5\n\nwhile (1==1):\n\tv = g(F(1),F(h),F(1))\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/31100\n\n",
    "created_at": "2020-12-23T10:26:58Z",
    "labels": [
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Memory leak with multivariate polynomial evaluation in finite field",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30863",
    "user": "https://github.com/cbe90"
}
```
CC:  @slel

Keywords: memory

I observed a memory leak (tested with sage 9.1.) when evaluating a multivariate polynomial with coefficients in a finite field, see the following code:


```
n = 4
F.<h> = GF(2^n)
P.<x,y,z> = PolynomialRing(F)

g = x^5 + y^7 + h*x*y + h**2*x^2*z^5

while (1==1):
	v = g(F(1),F(h),F(1))
```


Issue created by migration from https://trac.sagemath.org/ticket/31100





---

archive/issue_comments_440582.json:
```json
{
    "body": "Changing keywords from \"memory\" to \"memory, memleak\".",
    "created_at": "2020-12-25T09:27:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30863",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30863#issuecomment-440582",
    "user": "https://github.com/slel"
}
```

Changing keywords from "memory" to "memory, memleak".



---

archive/issue_comments_440583.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to commutative algebra.",
    "created_at": "2020-12-25T09:27:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30863",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30863#issuecomment-440583",
    "user": "https://github.com/slel"
}
```

Changing component from PLEASE CHANGE to commutative algebra.



---

archive/issue_comments_440584.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-12-30T03:43:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30863",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30863#issuecomment-440584",
    "user": "https://github.com/tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_440585.json:
```json
{
    "body": "I am not observing this with 9.3.beta4. So this probably was fixed sometime in between 9.1 and now.",
    "created_at": "2020-12-30T03:43:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30863",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30863#issuecomment-440585",
    "user": "https://github.com/tscrim"
}
```

I am not observing this with 9.3.beta4. So this probably was fixed sometime in between 9.1 and now.



---

archive/issue_events_081220.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2020-12-30T03:43:39Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30863",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30863#event-81220"
}
```



---

archive/issue_comments_440586.json:
```json
{
    "body": "I think there is still a leak of 2MB about every 10K iterations. The leak is smaller (2MB about every 85K iterations) if I use simpler examples for F, P, and g:\n\n```\nsage: from time import time \n....: F = GF(2) \n....: P.<x, y> = PolynomialRing(F) \n....: g = x^3 + x^2 \n....: count = 0 \n....: mem_orig = get_memory_usage() \n....: mem_updated = mem_orig \n....: time_orig = time() \n....: while True: \n....:     v = g(F(1), F(1)) \n....:     count += 1 \n....:     mem_now = get_memory_usage() \n....:     if mem_now != mem_updated: \n....:         mem_updated = mem_now \n....:         time_now = time() \n....:         print(f\"memory lost = {mem_now - mem_orig}MB after {count} iterations in {round(\n....: time_now - time_orig, 1)} seconds\")                                                     \nmemory lost = 2.0MB after 72135 iterations in 84.3 seconds\nmemory lost = 4.0MB after 158151 iterations in 179.4 seconds\nmemory lost = 6.0MB after 244167 iterations in 370.0 seconds\nmemory lost = 8.0MB after 330183 iterations in 585.5 seconds\netc.\n```\n\nThis is with 9.3.beta5 on MacOS, but results are similar (except the timings are faster) on `CoCalc` with 9.1 and 9.2.",
    "created_at": "2021-01-09T21:27:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30863",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30863#issuecomment-440586",
    "user": "https://github.com/DaveWitteMorris"
}
```

I think there is still a leak of 2MB about every 10K iterations. The leak is smaller (2MB about every 85K iterations) if I use simpler examples for F, P, and g:

```
sage: from time import time 
....: F = GF(2) 
....: P.<x, y> = PolynomialRing(F) 
....: g = x^3 + x^2 
....: count = 0 
....: mem_orig = get_memory_usage() 
....: mem_updated = mem_orig 
....: time_orig = time() 
....: while True: 
....:     v = g(F(1), F(1)) 
....:     count += 1 
....:     mem_now = get_memory_usage() 
....:     if mem_now != mem_updated: 
....:         mem_updated = mem_now 
....:         time_now = time() 
....:         print(f"memory lost = {mem_now - mem_orig}MB after {count} iterations in {round(
....: time_now - time_orig, 1)} seconds")                                                     
memory lost = 2.0MB after 72135 iterations in 84.3 seconds
memory lost = 4.0MB after 158151 iterations in 179.4 seconds
memory lost = 6.0MB after 244167 iterations in 370.0 seconds
memory lost = 8.0MB after 330183 iterations in 585.5 seconds
etc.
```

This is with 9.3.beta5 on MacOS, but results are similar (except the timings are faster) on `CoCalc` with 9.1 and 9.2.



---

archive/issue_events_081221.json:
```json
{
    "actor": "https://github.com/DaveWitteMorris",
    "created_at": "2021-01-09T21:27:42Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30863",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30863#event-81221"
}
```



---

archive/issue_events_081222.json:
```json
{
    "actor": "https://github.com/DaveWitteMorris",
    "created_at": "2021-01-09T21:27:42Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30863",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30863#event-81222"
}
```



---

archive/issue_comments_440587.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-01-09T21:27:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30863",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30863#issuecomment-440587",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_440588.json:
```json
{
    "body": "Okay, I am seeing it now, including on the original example.",
    "created_at": "2021-01-14T06:00:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30863",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30863#issuecomment-440588",
    "user": "https://github.com/tscrim"
}
```

Okay, I am seeing it now, including on the original example.



---

archive/issue_comments_440589.json:
```json
{
    "body": "This is not just limited to finite fields. It also happens over `F = QQ`. It also happens in both of these cases:\n\n```\n        if res == NULL:\n            return res_parent(0)\n        if p_LmIsConstant(res, _ring):\n            sage_res = si2sa( p_GetCoeff(res, _ring), _ring, parent._base )\n            p_Delete(&res, _ring)            # sage_res contains copy\n```\n\nMy guess is it is somewhere within the `singular_polynomial_call` function.\n\nAddendum: #16958 might be relevant.",
    "created_at": "2021-01-14T08:08:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30863",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30863#issuecomment-440589",
    "user": "https://github.com/tscrim"
}
```

This is not just limited to finite fields. It also happens over `F = QQ`. It also happens in both of these cases:

```
        if res == NULL:
            return res_parent(0)
        if p_LmIsConstant(res, _ring):
            sage_res = si2sa( p_GetCoeff(res, _ring), _ring, parent._base )
            p_Delete(&res, _ring)            # sage_res contains copy
```

My guess is it is somewhere within the `singular_polynomial_call` function.

Addendum: #16958 might be relevant.



---

archive/issue_comments_440590.json:
```json
{
    "body": "Replying to [comment:5 tscrim]:\n> My guess is it is somewhere within the `singular_polynomial_call` function.\n\nI have confirmed that the leak is coming from in there. In fact, I believe I have further isolated it to the line\n\n```\ncdef ideal *res_id = fast_map_common_subexp(from_id, r, to_id, r)\n```\n\nThis is a singular function, so it makes me believe there is a bug in Singular. At least, I cannot find any other place where it could be leaking, but it is possible I missed something. I am stumped at this point. `:/`",
    "created_at": "2021-01-14T09:13:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30863",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30863#issuecomment-440590",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:5 tscrim]:
> My guess is it is somewhere within the `singular_polynomial_call` function.

I have confirmed that the leak is coming from in there. In fact, I believe I have further isolated it to the line

```
cdef ideal *res_id = fast_map_common_subexp(from_id, r, to_id, r)
```

This is a singular function, so it makes me believe there is a bug in Singular. At least, I cannot find any other place where it could be leaking, but it is possible I missed something. I am stumped at this point. `:/`



---

archive/issue_comments_440591.json:
```json
{
    "body": "Moving this ticket to 9.4, as it seems unlikely that it will be merged in 9.3, which is in the release candidate stage",
    "created_at": "2021-04-02T20:21:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30863",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30863#issuecomment-440591",
    "user": "https://github.com/mkoeppe"
}
```

Moving this ticket to 9.4, as it seems unlikely that it will be merged in 9.3, which is in the release candidate stage



---

archive/issue_events_081223.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-04-02T20:21:54Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30863",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30863#event-81223"
}
```



---

archive/issue_events_081224.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-04-02T20:21:54Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30863",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30863#event-81224"
}
```



---

archive/issue_events_081225.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30863",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30863#event-81225"
}
```



---

archive/issue_events_081226.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30863",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30863#event-81226"
}
```



---

archive/issue_comments_440592.json:
```json
{
    "body": "Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30863",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30863#issuecomment-440592",
    "user": "https://github.com/mkoeppe"
}
```

Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_events_081227.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:24:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30863",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30863#event-81227"
}
```



---

archive/issue_events_081228.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:24:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30863",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30863#event-81228"
}
```



---

archive/issue_events_081229.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:19:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30863",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30863#event-81229"
}
```



---

archive/issue_events_081230.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:19:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30863",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30863#event-81230"
}
```



---

archive/issue_events_081231.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30863",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30863#event-81231"
}
```



---

archive/issue_events_081232.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30863",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30863#event-81232"
}
```
