# Issue 30863: Memory leak with multivariate polynomial evaluation in finite field

Issue created by migration from https://trac.sagemath.org/ticket/31100

Original creator: @cbe90

Original creation time: 2020-12-23 10:26:58

CC:  slelievre

Keywords: memory

I observed a memory leak (tested with sage 9.1.) when evaluating a multivariate polynomial with coefficients in a finite field, see the following code:


```
n = 4
F.<h> = GF(2^n)
P.<x,y,z> = PolynomialRing(F)

g = x^5 + y^7 + h*x*y + h**2*x^2*z^5

while (1==1):
	v = g(F(1),F(h),F(1))
```



---

Comment by slelievre created at 2020-12-25 09:27:32

Changing keywords from "memory" to "memory, memleak".


---

Comment by slelievre created at 2020-12-25 09:27:32

Changing component from PLEASE CHANGE to commutative algebra.


---

Comment by tscrim created at 2020-12-30 03:43:39

Changing status from new to needs_review.


---

Comment by tscrim created at 2020-12-30 03:43:39

I am not observing this with 9.3.beta4. So this probably was fixed sometime in between 9.1 and now.


---

Comment by @DaveWitteMorris created at 2021-01-09 21:27:42

I think there is still a leak of 2MB about every 10K iterations. The leak is smaller (2MB about every 85K iterations) if I use simpler examples for F, P, and g:

```
sage: from time import time 
....: F = GF(2) 
....: P.<x, y> = PolynomialRing(F) 
....: g = x^3 + x^2 
....: count = 0 
....: mem_orig = get_memory_usage() 
....: mem_updated = mem_orig 
....: time_orig = time() 
....: while True: 
....:     v = g(F(1), F(1)) 
....:     count += 1 
....:     mem_now = get_memory_usage() 
....:     if mem_now != mem_updated: 
....:         mem_updated = mem_now 
....:         time_now = time() 
....:         print(f"memory lost = {mem_now - mem_orig}MB after {count} iterations in {round(
....: time_now - time_orig, 1)} seconds")                                                     
memory lost = 2.0MB after 72135 iterations in 84.3 seconds
memory lost = 4.0MB after 158151 iterations in 179.4 seconds
memory lost = 6.0MB after 244167 iterations in 370.0 seconds
memory lost = 8.0MB after 330183 iterations in 585.5 seconds
etc.
```

This is with 9.3.beta5 on MacOS, but results are similar (except the timings are faster) on `CoCalc` with 9.1 and 9.2.


---

Comment by @DaveWitteMorris created at 2021-01-09 21:27:42

Changing status from needs_review to needs_work.


---

Comment by tscrim created at 2021-01-14 06:00:11

Okay, I am seeing it now, including on the original example.


---

Comment by tscrim created at 2021-01-14 08:08:43

This is not just limited to finite fields. It also happens over `F = QQ`. It also happens in both of these cases:

```
        if res == NULL:
            return res_parent(0)
        if p_LmIsConstant(res, _ring):
            sage_res = si2sa( p_GetCoeff(res, _ring), _ring, parent._base )
            p_Delete(&res, _ring)            # sage_res contains copy
```

My guess is it is somewhere within the `singular_polynomial_call` function.

Addendum: #16958 might be relevant.


---

Comment by tscrim created at 2021-01-14 09:13:14

Replying to [comment:5 tscrim]:
> My guess is it is somewhere within the `singular_polynomial_call` function.

I have confirmed that the leak is coming from in there. In fact, I believe I have further isolated it to the line

```
cdef ideal *res_id = fast_map_common_subexp(from_id, r, to_id, r)
```

This is a singular function, so it makes me believe there is a bug in Singular. At least, I cannot find any other place where it could be leaking, but it is possible I missed something. I am stumped at this point. `:/`


---

Comment by mkoeppe created at 2021-04-02 20:21:54

Moving this ticket to 9.4, as it seems unlikely that it will be merged in 9.3, which is in the release candidate stage


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.
