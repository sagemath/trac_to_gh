# Issue 31038: QEPCAD: improve installation locations

Issue created by migration from https://trac.sagemath.org/ticket/31275

Original creator: mkoeppe

Original creation time: 2021-01-21 19:51:36

CC:  jhpalmieri mjo

QEPCAD assumes unusual locations for several files, including 
 - `$SAGE_LOCAL/default.qepcadrc` (which would better live in `$SAGE_ETC` (= `$SAGE_LOCAL/etc`)
 - `$SAGE_LOCAL/bin/qepcad.help` (which would better live in `$SAGE_LOCAL/share/qepcad`)
(We already use Fedora's patches (https://src.fedoraproject.org/rpms/qepcad-B/blob/master/f/qepcad-B.spec), which make some changes to qepcad's environment.)

It would be good to improve this.



---

Comment by jhpalmieri created at 2021-01-21 20:01:16

Also, very low on the priority list since this is an experimental package, but the `spkg-install.in` script could be rewritten to use the `sdh` tools.


---

Comment by mkoeppe created at 2021-06-24 02:37:24

I think we can just remove `default.qepcadrc` entirely and just set SINGULARPATH as an env var


---

Comment by mkoeppe created at 2021-08-01 23:17:22

As noted in #29024, we should get rid of `qepcad`'s use of the environment variable `SINGULARPATH` - as preparation for singular spkg-configure.


---

Comment by mjo created at 2021-08-06 22:54:11

`SINGULARPATH` is only mentioned in `qepcad-B-env.patch` whose value I doubt. The default for `$qe` is Fedora-specific, and `$SINGULARPATH` should not be needed at all because the compiled `Singular` executable knows it.

What's more, we seem to be setting `SINGULAR` in QEPCAD's rc file...


```
cat > "$SAGE_LOCAL/default.qepcadrc" <<EOF
# THIS FILE IS AUTOMATICALLY GENERATED by build/pkgs/qepcad/spkg-install.in -- DO NOT EDIT

#####################################################
# QEPCAD rc file.
# This file allows for some customization of QEPCAD.
# Right now, the ability to give a path to Singular,
# so that it gets used for some computer algebra
# computations is the only feature.
#####################################################
SINGULAR $SAGE_LOCAL/bin
EOF
```


but the only place that's used is to execute "Singular" (in `source/db/SINGULAR.c`):


```C++
   string SingularCall = SingularBase + "/Singular";
   ...
    execlp(SingularCall.c_str(),
           SingularCall.c_str(),
           "-q",
           "--no-warn",
           "--min-time=0.001",
           "--ticks-per-sec=1000",
           NULL);
```


Since `execlp()` searches `PATH`, the whole mess can simply be replaced by `execlp("Singular",...)`. If we want to create a nice backwards-compatible patch, we could use `SingularBase + "/Singular"` when `SINGULAR` is defined, and `"Singular"` otherwise. Then deleting `SINGULAR` from our qepcad rc file would make it do the right thing, but the patch could be used by others without breaking configs that rely on `SINGULAR` being set.


---

Comment by mjo created at 2021-08-18 13:30:58

This seems to work. I dropped the nonsensical `qepcad-B-env.patch`, and added a new patch that chaged the `SINGULAR` variable in `default.qepcadrc` into a boolean. Now "yes" makes it launch `Singular` from the `$PATH`, and anything else disables it.
----
New commits:


---

Comment by mjo created at 2021-08-18 13:30:58

Changing status from new to needs_review.


---

Comment by git created at 2021-08-18 19:19:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-09-14 14:24:08

test errors like

```
 File "/mnt/opt/Sage/sage-dev/local/lib/python3.8/site-packages/sage/interfaces/qepcad.py", line 687, in _update_command_info
        with open(os.path.join(SAGE_LOCAL, 'bin', 'qepcad.help')) as help:
    FileNotFoundError: [Errno 2] No such file or directory: '/mnt/opt/Sage/sage-dev/local/bin/qepcad.help'
```

whereas the location used now is `$SAGE_LOCAL/share/qepcad/qepcad.help`.

So one needs to change `sage/interfaces/qepcad.py` to fix this.


---

Comment by dimpase created at 2021-09-14 14:34:33

few other tests need a fix. I'll provide a branch.


---

Comment by dimpase created at 2021-09-14 14:50:23

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2021-09-14 14:50:23

New commits:


---

Comment by mjo created at 2021-09-14 16:27:58

Thanks for the fix! I guess I forgot to re-test after I realized that I hadn't actually solved the problem in $description and moved the help/rc files.


---

Comment by vbraun created at 2021-09-15 22:06:15

Resolution: fixed
