# Issue 12307: Clean up sage-spkg

Issue created by migration from https://trac.sagemath.org/ticket/12479

Original creator: jdemeyer

Original creation time: 2012-02-09 10:07:22

Assignee: GeorgSWeber




---

Comment by jhpalmieri created at 2012-02-09 16:21:05

See also #11021.


---

Comment by jdemeyer created at 2012-02-14 09:25:53

Thanks for the link.  I think that ticket is now too bitrotted.  We should consider the ideas from that ticket and apply them (better in separate tickets instead of one "fix everything" ticket).


---

Comment by jhpalmieri created at 2012-02-25 22:50:08

What is the file `SAGE.txt` referred to in this script? Should it be `SPKG.txt` instead? For example:

```
        echo >&2 "No file SAGE.txt in $PKG_NAME"
```


By the way, #12579 also modifies sage-spkg; you might take a look at that ticket if you have time.

What do you think of replacing `./spkg-check` with `time ./spkg-check`?


---

Comment by jdemeyer created at 2012-02-26 09:04:45

Replying to [comment:5 jhpalmieri]:
> What is the file `SAGE.txt` referred to in this script? Should it be `SPKG.txt` instead?
Of course, but I don't want to mistake of #11021: fixing too many things on one ticket.  On this ticket, I essentially just want to clean things up, with little or none functional difference.

> What do you think of replacing `./spkg-check` with `time ./spkg-check`?


---

Comment by jdemeyer created at 2012-02-26 22:37:07

Replying to [comment:5 jhpalmieri]:
> What do you think of replacing `./spkg-check` with `time ./spkg-check`?
Done.


---

Comment by jdemeyer created at 2012-02-27 15:01:22

John, could you please review this?


---

Comment by jdemeyer created at 2012-02-27 15:01:22

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2012-02-27 23:51:46

This is pretty minor, but if a package has been installed already, for example, then with the patch, `sage -i pkg` still creates `SAGE_BUILD_DIR`, then quits without doing anything else. It would be nicer if this directory were not created until needed.

I will look at this more later.


---

Comment by jhpalmieri created at 2012-02-28 03:46:04

My previous comment about creating directories unnecessarily also applies when running `sage -i` with no arguments.

For "Authors", perhaps you could add something like:

```
 - William Stein and others (Sage 4.8 and earlier)
```

after your name.

The header might also include documentation about the options -f, -s, -info.  Actually, I don't think -info is used anywhere, nor is it accessible from the main sage script; should it be deleted altogether (here or on another ticket)?  If we want to keep it, then consider lines 209-213:

```
    echo ""
    if [ $? -ne 0 ]; then
        echo >&2 "No file SPKG.txt in $PKG_NAME"
        exit 1
    fi
```

Won't the test `if [ $? -ne 0]; then` reflect the exit status of the `echo` command?  I think that the `echo` line should be deleted and the test moved inside the previous if block, so it's connected to the tar command.  Or something like that.


---

Comment by jdemeyer created at 2012-02-28 07:50:40

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2012-02-28 07:50:40

Replying to [comment:12 jhpalmieri]:
> My previous comment about creating directories unnecessarily also applies when running `sage -i` with no arguments.
> 
> For "Authors", perhaps you could add something like:
> {{{
>  - William Stein and others (Sage 4.8 and earlier)
> }}}
> after your name.
I changed this to

```
# AUTHORS:
#
# - Jeroen Demeyer (2012-02-27): #12479: big reorganization.
#
# - Volker Braun, Jeroen Demeyer (2012-01-18): #11073: remove the
#   spkg/base repository, move this file from local/bin/sage-spkg to
#   spkg/bin/sage-spkg.
#
# - William Stein, John Palmieri and others (Sage 4.8 and earlier).
```

The reason I put your name also is because it appears several times in `hg log` of the 4.8 `sage-spkg`.

> Actually, I don't think -info is used anywhere, nor is it accessible from the main sage script; should it be deleted altogether (here or on another ticket)?
See #12606.


---

Comment by jdemeyer created at 2012-02-28 07:51:47

Replying to [comment:11 jhpalmieri]:
> This is pretty minor, but if a package has been installed already, for example, then with the patch, `sage -i pkg` still creates `SAGE_BUILD_DIR`, then quits without doing anything else. It would be nicer if this directory were not created until needed.
Okay, I will change this in the follow-up #12602.


---

Comment by jdemeyer created at 2012-02-28 07:54:36

Replying to [comment:15 jdemeyer]:
> Replying to [comment:11 jhpalmieri]:
> > This is pretty minor, but if a package has been installed already, for example, then with the patch, `sage -i pkg` still creates `SAGE_BUILD_DIR`, then quits without doing anything else. It would be nicer if this directory were not created until needed.
> Okay, I will change this in the follow-up #12602.
Never mind, I'll do it on this ticket anyway.


---

Comment by jdemeyer created at 2012-02-28 10:10:02

John, new patch needs review.  I also made some changes to `spkg/bin/sage` in the calls to `sage-spkg`.  I think I took care of all your comments, except for `-info` which I moved to #12606.

This version allows multiple options, so you can do something silly like

```
./sage -i -f -s -f -f -m spkg/optional/mpc-0.9.spkg
```



---

Comment by jdemeyer created at 2012-02-28 10:10:02

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2012-02-28 21:39:03

The patch to `spkg/bin/sage` needs work: the combination of

```sh
if [ "$1" = '-i' ]; then
   shift
   install "$@"   # used to be    install " " "$@"
fi
```

and (in the install function)

```sh
    if [ $# -le 1 ]; then
        exec sage-spkg
    fi
```

means that `sage -i pkg` just lists the currently installed packages. Maybe this test should say `if [ $# -eq 0 ]`?  Maybe if after processing the flags, there are no arguments left, then you should run `exec sage-spkg`?  For example:

```diff
diff --git a/spkg/bin/sage b/spkg/bin/sage
--- a/spkg/bin/sage
+++ b/spkg/bin/sage
@@ -767,11 +767,9 @@ fi
 
 install() {
     cd "$SAGE_ROOT/spkg"
-    if [ $# -le 1 ]; then
-        exec sage-spkg
-    fi
     SAGE_LOGS="$SAGE_ROOT/spkg/logs"
     mkdir -p "$SAGE_LOGS"
+    no_pkg="yes"
     for PKG in "$@"
     do
         # Check for options
@@ -784,6 +782,7 @@ install() {
             -s) OPTS="-s"
                 continue;;
         esac
+        no_pkg="no"
 
         echo "Calling sage-spkg on '$PKG'"
         PKG_NAME=`echo "$PKG" | sed -e "s/\.spkg$//"`
@@ -804,6 +803,9 @@ install() {
         fi
         shift
     done
+    if [ $no_pkg = "yes" ]; then
+        exec sage-spkg
+    fi
     exit $?
 }
```

There are probably better ways of doing this.

Otherwise, I think this is looking good.

This is a possible suggestion for another ticket: have a command-line flag for spkg-install which sets `SAGE_CHECK` to be "yes".  That might be more convenient than setting `SAGE_CHECK=yes`, running `sage -i ...`, then unsetting `SAGE_CHECK`.


---

Comment by jhpalmieri created at 2012-02-28 21:39:03

Changing status from needs_review to needs_work.


---

Attachment


---

Comment by jdemeyer created at 2012-02-28 22:38:07

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2012-02-28 22:38:07

Fixed, needs review.

I like your idea of a SPKG_CHECK=yes command line option, how about -c for check?  But not on this ticket.


---

Comment by jhpalmieri created at 2012-02-29 21:43:45

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2012-02-29 21:43:45

Okay, this looks good.

> I like your idea of a SPKG_CHECK=yes command line option, how about -c for check?  But not on this ticket.

See #12613.


---

Comment by kcrisman created at 2012-02-29 22:03:31

This shouldn't have anything to do with positive review here, but aren't there a few spkgs that run tests automatically with or without `SAGE_CHECK`, and don't have spkg-check files?  I see them sometimes while waiting for Sage to build... For instance, R does this, I believe, and maybe one of the elliptic curve packages.


---

Comment by jhpalmieri created at 2012-02-29 22:37:28

I'm not sure. Some spkgs (like zn_poly) run a small batch of tests always, and then run much longer tests if `SAGE_CHECK` is set. Anything on this ticket or related ones won't affect tests which are run by the `spkg-install` script; these just affect whether the `spkg-check` script is run.


---

Comment by kcrisman created at 2012-03-01 02:15:16

I guess I was referring to `echo "Package $PKG_NAME has no test suite." `, which wouldn't strictly be true if there was a full test suite run that didn't happen to be in an spkg-check file.   Well, not so important.


---

Comment by jdemeyer created at 2012-03-04 21:17:30

Resolution: fixed


---

Comment by leif created at 2012-04-05 21:02:40

I don't know to which ticket / change it exactly belongs, but I noticed that one meanwhile gets an error when using `sage -i ...` before building Sage (something at the of `sage-spkg` trying to `cd` to some not-yet-existent directory, `$SAGE_LOCAL/bin/` IIRC).  The script doesn't exit with an error, just the shell complains, i.e. the spkg apparently gets installed, I'm just not sure whether some more or less important code got skipped.

Atm too tired to investigate myself... :P


---

Comment by jdemeyer created at 2012-04-05 21:09:33

Replying to [comment:25 leif]:
> I don't know to which ticket / change it exactly belongs, but I noticed that one meanwhile gets an error when using `sage -i ...` before building Sage (something at the of `sage-spkg` trying to `cd` to some not-yet-existent directory, `$SAGE_LOCAL/bin/` IIRC).
It must be the `spkg-install` file doing that.  With `patch` (the first spkg I tried), there are no errors:

```
$ ./sage -i patch
Calling sage-spkg on 'patch'
patch-2.5.9.p2
====================================================
Extracting package /padic/scratch/jdemeyer/sage-5.0.beta12/spkg/standard/patch-2.5.9.p2.spkg
-rw-r--r-- 1 jdemeyer jdemeyer 174221 Aug 16  2011 /padic/scratch/jdemeyer/sage-5.0.beta12/spkg/standard/patch-2.5.9.p2.spkg
Finished extraction
****************************************************
Host system:
Linux boxen 2.6.24-24-server #1 SMP Fri Sep 18 16:47:05 UTC 2009 x86_64 GNU/Linux
****************************************************
C compiler: gcc
C compiler version:
Using built-in specs.
COLLECT_GCC=gcc
COLLECT_LTO_WRAPPER=/home/jdemeyer/local/libexec/gcc/x86_64-unknown-linux-gnu/4.6.1/lto-wrapper
Target: x86_64-unknown-linux-gnu
Configured with: ../gcc-4.6.1/configure --prefix=/home/jdemeyer/local
Thread model: posix
gcc version 4.6.1 (GCC)
****************************************************
checking for gcc... gcc
checking for C compiler default output... a.out
checking whether the C compiler works... yes
[...]
```

