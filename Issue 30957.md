# Issue 30957: Make ModuleElementWithMutability compatible with require_mutable wrapper

Issue created by migration from https://trac.sagemath.org/ticket/31194

Original creator: @mjungmath

Original creation time: 2021-01-07 13:51:34

CC:  mkoeppe tscrim

In #30181, the class `ModuleElementWithMutability` was introduced. Unfortunately, this class is not compatible with the wrapper in `sage.structure.Mutability.require_mutable` and `sage.structure.Mutability.require_immutable` respectively due to different attribute names.

Furthermore, I suggest to improve the error message for the decorator in accordance to the method `_require_mutable`.


---

Comment by @mjungmath created at 2021-01-07 14:27:45

Changing status from new to needs_review.


---

Comment by @mjungmath created at 2021-01-07 14:52:35

Alternatively, see #31196. However, I suggest both because of unification.
----
New commits:


---

Comment by tscrim created at 2021-01-09 01:17:53

You would also need to change the corresponding attribute in `element.pxd`:

```diff
 cdef class ModuleElementWithMutability(ModuleElement):
-    cdef bint _is_mutable
+    cdef bint _is_immutable
     cpdef bint is_immutable(self)
     cpdef bint is_mutable(self)
```

You currently have numerous doctest failures because of this. There will probably be a few other places that require some touch ups that you can check for with a `grep`.


---

Comment by tscrim created at 2021-01-09 01:18:03

Changing status from needs_review to needs_work.


---

Comment by @mjungmath created at 2021-01-09 01:53:01

Replying to [comment:4 tscrim]:
> You would also need to change the corresponding attribute in `element.pxd`:
> {{{#!diff
>  cdef class ModuleElementWithMutability(ModuleElement):
> -    cdef bint _is_mutable
> +    cdef bint _is_immutable
>      cpdef bint is_immutable(self)
>      cpdef bint is_mutable(self)
> }}}

Yes, thanks.

> You currently have numerous doctest failures because of this. There will probably be a few other places that require some touch ups that you can check for with a `grep`.

Yes, there is more than expected. Some of them need individual attention.


---

Comment by git created at 2021-01-09 14:16:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-01-09 14:32:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mjungmath created at 2021-01-09 14:33:00

Changing status from needs_work to needs_review.


---

Comment by @mjungmath created at 2021-01-09 14:33:00

I hope that's it. Please double check.


---

Comment by tscrim created at 2021-01-10 13:00:11

Almost there (see the patchbot):

```
sage -t --long --random-seed=0 src/sage/homology/simplicial_complex.py  # 1 doctest failed
sage -t --long --random-seed=0 src/sage/modules/free_module_element.pyx  # 5 doctests failed
```



---

Comment by git created at 2021-01-10 19:25:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-01-10 19:26:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mjungmath created at 2021-01-10 19:28:33

I had to adapt the doctest in `free_module_element.py`.

`simplicial_complex.py` had a small bug with the attribute treatment which I fixed.

I hope, patchbot is satisfied now...


---

Comment by tscrim created at 2021-01-12 00:35:51

So I don't think you should change the API for the `_v1` functions in the free module code. You should either create new `_v2` versions or just negate a bunch of the values. This will be better for backwards compatibility.

Other than that, the patchbot is happy.


---

Comment by git created at 2021-01-12 09:33:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-01-12 13:11:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mjungmath created at 2021-01-18 21:43:03

Patchbot likes this, too.


---

Comment by tscrim created at 2021-01-19 04:06:04

Okay, this LGTM now. Thank you.


---

Comment by tscrim created at 2021-01-19 04:06:04

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-01-31 20:53:41

Resolution: fixed
