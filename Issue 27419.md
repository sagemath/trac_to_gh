# Issue 27419: Fix table display in Jupyter notebook with Sage kernel

Issue created by migration from https://trac.sagemath.org/ticket/27656

Original creator: slelievre

Original creation time: 2019-04-13 11:22:46

CC:  chapoton embray jdemeyer kcrisman vbraun

Keywords: jupyter, table, display

As reported in

- [Ask Sage question 46005: Issue printing tables in Jupyter Notebook](https://ask.sagemath.org/question/46005/)

the following fails to display the expected table properly
in the Jupyter Notebook with the Sage kernel:

```
%display latex
rows = [('A', 'B', 'C'), (0, 1, 2), (3, 4, 5), (6, 7, 8)]
table(rows)
```


The table displays fine in text mode in the Sage REPL:

```
sage: rows = [('A', 'B', 'C'), (0, 1, 2), (3, 4, 5), (6, 7, 8)]
sage: table(rows)
  A   B   C
  0   1   2
  3   4   5
  6   7   8
```



---

Comment by jhpalmieri created at 2019-04-13 15:23:04

Please provide OS information and the Sage version. The command works just fine for me in the Jupyter notebook with Sage 8.8.beta1 on OS X, with both Safari and Firefox.


---

Comment by jhpalmieri created at 2019-04-13 15:33:56

Oh, is it a Python 3 problem? I see this issue with Python 3 but not Python 2.


---

Comment by slelievre created at 2019-04-13 21:19:51

Right, forgot to mention this is with Python 3.


---

Comment by jhpalmieri created at 2019-04-13 23:19:03

This reminds me of #24784. I would guess that the problem is in the `_html_` method for tables, possibly in the use of `StringIO`.


---

Comment by jhpalmieri created at 2019-04-14 03:48:12

Maybe the problem is really in `HtmlFragment`. Note that this code produces similar gibberish with Python 3 but not Python 2:

```
A = ([1, 1], [3, 1], [-1, -1])
b = (1000, 1500, -400)
c = (10, 5)
P = InteractiveLPProblemStandardForm(A, b, c)
P.run_simplex_method()
```

The `run_simplex_method` also calls `HtmlFragment`.

Or try this:

```
a = 123
html.eval('<sage>a</sage>')
```



---

Comment by jhpalmieri created at 2019-04-14 03:50:40

Changing priority from major to critical.


---

Comment by slelievre created at 2019-04-15 15:34:10

Hopefully a Python3 expert can help with this.


---

Comment by embray created at 2019-04-15 15:46:02

I didn't realize this was only on Python 3.  Mostly likely the problem is something returning `bytes` when it should return `str`.


---

Comment by jhpalmieri created at 2019-04-30 22:46:12

I don't know enough about how the Jupyter notebook displays things. The failure of

```
sage.misc.html.HtmlFragment('hello')
```

says that the problem is in how the notebook displays instances of `HtmlFragment`. This is Python 3 only, so Erik is likely right that something is producing `bytes` instead of `str`. Can someone who understands the Jupyter notebook shed any light on this?


---

Comment by embray created at 2019-05-03 14:30:35

I haven't tested it yet, but this is likely the fix we want:


```diff
diff --git a/src/sage/repl/rich_output/backend_ipython.py b/src/sage/repl/rich_output/backend_ipython.py
index eeeb526183..7c27d48a21 100644
--- a/src/sage/repl/rich_output/backend_ipython.py
+++ b/src/sage/repl/rich_output/backend_ipython.py
@@ -539,8 +539,8 @@ class BackendIPythonNotebook(BackendIPython):
                      u'text/plain': plain_text.text.get_unicode(),
             }, {})
         elif isinstance(rich_output, OutputHtml):
-            return ({u'text/html':  rich_output.html.get(),
-                     u'text/plain': plain_text.text.get(),
+            return ({u'text/html':  rich_output.html.get_unicode(),
+                     u'text/plain': plain_text.text.get_unicode(),
             }, {})
         elif isinstance(rich_output, OutputImagePng):
             return ({u'image/png':  rich_output.png.get(),
@@ -548,7 +548,7 @@ class BackendIPythonNotebook(BackendIPython):
             }, {})
         elif isinstance(rich_output, OutputImageGif):
             return ({u'text/html':  rich_output.html_fragment(),
-                     u'text/plain': plain_text.text.get(),
+                     u'text/plain': plain_text.text.get_unicode(),
             }, {})
         elif isinstance(rich_output, OutputImageJpg):
             return ({u'image/jpeg':  rich_output.jpg.get(),
```



---

Comment by jhpalmieri created at 2019-05-03 17:48:01

That works for me.


---

Comment by jhpalmieri created at 2019-05-03 18:01:09

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2019-05-03 18:01:09

New commits:


---

Comment by jhpalmieri created at 2019-05-03 18:01:16

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-05-06 11:56:53

Resolution: fixed


---

Comment by embray created at 2019-05-06 14:06:50

Thanks for making the branch and reviewing it.


---

Comment by chapoton created at 2019-06-02 06:43:10

This was also proposed long ago in #19186.


---

Comment by slelievre created at 2019-06-02 17:08:56

Sorry! I looked for an existing ticket before opening this one but missed #19186.
