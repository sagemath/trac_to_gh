# Issue 10960: Singular 3-1-1-4.p4 fails to build with gcc 4.6.0 on OpenSolaris.

Issue created by migration from Trac.

Original creator: drkirkby

Original creation time: 2011-03-29 22:40:00

Assignee: GeorgSWeber

After trying to build Sage with the latest gcc (4.6.0) on OpenSolaris, I find it fails when building Singular, despite Singular (and all of Sage) builds with gcc-4.5.0.


```
In file included from ../kernel/ring.h:13:0,
                 from ../kernel/ideals.h:11,
                 from ipshell.h:12,
                 from tesths.cc:20:
../kernel/polys-impl.h:177:0: warning: "pPolyAssumeReturn" redefined [enabled by default]
../kernel/polys-impl.h:176:0: note: this is the location of the previous definition
mpsr_Tok.cc: In function 'void mpsr_ttGen()':
mpsr_Tok.cc:551:29: warning: deprecated conversion from string constant to 'char*' [-Wwrite-strings]
Undefined			first referenced
 symbol  			    in file
uniFactorizer(CanonicalForm const&, Variable const&, bool const&) /export/home/drkirkby/sage-new-gcc/sage-4.7.alpha2/local/lib/libsingcf.a(facFqFactorize.o)
ld: fatal: symbol referencing errors. No output written to gentable1
collect2: ld returned 1 exit status
make[4]: *** [iparith.inc] Error 1
Undefined			first referenced
 symbol  			    in file
uniFactorizer(CanonicalForm const&, Variable const&, bool const&) /export/home/drkirkby/sage-new-gcc/sage-4.7.alpha2/local/lib/libsingcf.a(facFqFactorize.o)
ld: fatal: symbol referencing errors. No output written to gentable2
collect2: ld returned 1 exit status
make[4]: *** [mpsr_Tok.inc] Error 1
make[4]: Target `install' not remade because of errors.
make[4]: Leaving directory `/export/home/drkirkby/sage-new-gcc/sage-4.7.alpha2/spkg/build/singular-3-1-1-4.p4/src/Singular'
make[3]: *** [install] Error 1
make[3]: Leaving directory `/export/home/drkirkby/sage-new-gcc/sage-4.7.alpha2/spkg/build/singular-3-1-1-4.p4/src'
make[2]: *** [/export/home/drkirkby/sage-new-gcc/sage-4.7.alpha2/local/bin/Singular-3-1-1] Error 2
make[2]: Leaving directory `/export/home/drkirkby/sage-new-gcc/sage-4.7.alpha2/spkg/build/singular-3-1-1-4.p4/src'
Unable to build Singular.

real	3m22.783s
user	6m14.242s
sys	0m22.671s
sage: An error occurred while installing singular-3-1-1-4.p4
```


A full log is attached.


---

Attachment

Failed build of Singular 3-1-1-4.p4 as part of Sage 4.7.alpha2 on a Sun Ultra 27 running OpenSolaris 06/2009


---

Comment by drkirkby created at 2011-03-29 22:43:36

Changing type from PLEASE CHANGE to defect.


---

Comment by drkirkby created at 2011-03-29 22:43:36

Changing component from build to solaris.


---

Comment by drkirkby created at 2011-03-29 22:43:36

I've set the component to "solaris" as that is the only confirmed system on which this fails to build. Can someone change the component to "build" if this fails on Linux or OS X. 

Dave


---

Comment by drkirkby created at 2011-03-29 22:43:36

Changing assignee from GeorgSWeber to drkirkby.


---

Comment by vbraun created at 2011-03-30 02:46:04

Changing component from solaris to build.


---

Comment by vbraun created at 2011-03-30 02:46:04

Changing assignee from drkirkby to GeorgSWeber.


---

Comment by vbraun created at 2011-03-30 02:46:04

Also fails on Fedora 15 alpha which uses gcc-4.6


---

Comment by burcin created at 2011-03-31 14:22:17

I just posted this to the `libsingular-devel` list:

http://groups.google.com/group/libsingular-devel/browse_thread/thread/508c352214392315


---

Comment by AlexanderDreyer created at 2011-03-31 15:35:20

Maybe a demangling issue?
See my comment here:
http://groups.google.com/group/libsingular-devel/browse_thread/thread/508c352214392315?hl=en
My best,
  Alexander


---

Comment by vbraun created at 2011-03-31 16:02:57

On a related note, our goal should probably be to update Singular to the newest upstream. IIRC I was able to build the latest upstream with gcc-4.6, but only the standalone singular. I was unable to build libsingular, though.


---

Comment by drkirkby created at 2011-04-07 20:30:25

Replying to [comment:5 vbraun]:
> On a related note, our goal should probably be to update Singular to the newest upstream. IIRC I was able to build the latest upstream with gcc-4.6, but only the standalone singular. I was unable to build libsingular, though.

We should really try to get this solved before the 24<sup>th</sup> May 2011, since Fedora 15 is released then, and Sage will fail to build on a fairly popular linux distribution. 

http://fedoraproject.org/wiki/Releases/15/Schedule


---

Comment by AlexanderDreyer created at 2011-04-07 20:59:35

I reported that upstream:
http://www.singular.uni-kl.de:8002/trac/ticket/332


---

Comment by drkirkby created at 2011-04-07 22:03:43

Changing priority from major to critical.


---

Comment by drkirkby created at 2011-04-07 22:03:43

Replying to [comment:7 AlexanderDreyer]:
> I reported that upstream:
> http://www.singular.uni-kl.de:8002/trac/ticket/332
Thank you. 

Burcin has already reported it on the mailing list, but there has been no response from any developers. Having it submitted to the bug database, as you have done, can only be a good thing. 

I've updated this to 'critical' as I think it's a pretty important bug to solve. Not that the priories seem to mean very much - e.g. #9739 has been opened for 8 months and has been a blocker for 5 months. 

Dave


---

Comment by drkirkby created at 2011-04-08 20:47:19

I've reported on the singular list that the latest version still fails with gcc 4.6.0. I later tried to post this:

-----------
With gcc 4.5.0 the same version builds ok on the same computer, so it does appear to be an issue with gcc 4.6.0.

I would suggest it would be worth trying to build this with Sun Studio (which is a free download)

 http://www.oracle.com/technetwork/server-storage/solarisstudio/downloads/index.html

on a Linux system. The Sun (Oracle) compiler is much stricter than the GNU compilers, so will show up problems that current versions of GCC may not. It goes without saying this will not build with Sun Studio. (I tried this on a Solaris system, but you should get the same on a Linux machine).

Dave
-----------

but it was rejected as it was thought to be spam. I guess it contains a link, but I don't think it's too much like spam. 

Dave


---

Comment by AlexanderDreyer created at 2011-04-08 21:17:19

In principle not a bad idea, but due to some implementation tricks making Singular to compile von Solaris studio would be a full port.

As I pointed out on libSingular-devel, there is a demangling issue for some C++ function names on gcc 4.6. (Maybe tied to optimization options.)


---

Comment by drkirkby created at 2011-04-08 21:45:23

Replying to [comment:10 AlexanderDreyer]:
> In principle not a bad idea, but due to some implementation tricks making Singular to compile von Solaris studio would be a full port.

It suspect it would only need to be converted to standard C and/and C++. 

> As I pointed out on libSingular-devel, there is a demangling issue for some C++ function names on gcc 4.6. (Maybe tied to optimization options.)


---

Comment by AlexanderDreyer created at 2011-04-08 22:05:17

> It suspect it would only need to be converted to standard C and/and C++. 
Indeed, but this is ot done overnight.

And: it won't fix this bug here. The lines of source code, that cause trouble are standard, this problem seems to accur during the compiler's optimization.


---

Comment by drkirkby created at 2011-04-08 22:36:44

Replying to [comment:12 AlexanderDreyer]:
> > It suspect it would only need to be converted to standard C and/and C++. 
> Indeed, but this is ot done overnight.

True. 

> And: it won't fix this bug here. The lines of source code, that cause trouble are standard, this problem seems to accur during the compiler's optimization.

IIRC, Singular uses -O3, which is a bit risky. Perhaps the optimiation level can be dropped to -O2, which is much safer. If I'm mistaken, and it is -O2, then I don't have any suggestions.


---

Comment by drkirkby created at 2011-04-08 22:40:33

I've removed the "_on OpenSolaris_" from the title, as this is not specific to that platform, so the ticket title should reflect this.


---

Comment by drkirkby created at 2011-04-09 09:44:14

Changing status from new to needs_info.


---

Comment by drkirkby created at 2011-04-09 09:44:14

Replying to [comment:13 drkirkby]:

> IIRC, Singular uses -O3, which is a bit risky. Perhaps the optimiation level can be dropped to -O2, which is much safer.

Reduced optimisation probably solves the problem. Changing to -O2 allows Singular to build with gcc 4.6.0 on at least OpenSolaris, but I have not yet verified if the doctests pass. I will start a fresh build of Sage, then run all the long doctests. 

If one looks in spkg-install, one find that compiling at -O3 has caused problems in the past, so on one platform -O0 is used. 

So I suspect this is solved. I've placed a package at 

http://boxen.math.washington.edu/home/kirkby/patches/singular-3-1-1-4.p5.spkg

We will need to verify if this builds and passes the tests properly on Linux, OS X, Solaris 10 (both x86 and SPARC) with gcc 4.6.0 before I will mark this for review. For now I'm setting to "needs info"

Dave 

PS.

I reported about an hour ago to the Singular developers that I believe they are using reserved words in Singular too (http://www.singular.uni-kl.de:8002/trac/ticket/333).


---

Attachment

Reduces optimisation. For review purposes only.


---

Comment by AlexanderDreyer created at 2011-04-09 21:31:37

This seems to be the right solution: looking at Singular's original settings I just realized that most of Singular is not compiled with -O3 already. (This is the reason why plain Singular doesn't fail to build. The overall optimization level is set in the spkg, so its merely a bug of the package.)
Maybe a better solution would be not to *increase* optimization and stay with the original settings.

Building/installing of the skpg is fine for me. Let's see whether the tests succeed.


---

Comment by AlexanderDreyer created at 2011-04-09 21:31:37

Changing status from needs_info to needs_review.


---

Comment by AlexanderDreyer created at 2011-04-09 23:56:51

Changing status from needs_review to positive_review.


---

Comment by AlexanderDreyer created at 2011-04-09 23:56:51

The tests suceeded, so positive review.


---

Comment by jdemeyer created at 2011-04-11 09:17:24

Replying to [comment:17 AlexanderDreyer]:
> This seems to be the right solution

I completely disagree.  Dropping the optimization is at best a workaround.  IMHO it can _never_ be "the right solution".  It means that either the compiler or the code has a bug.  Maybe dropping the optimization to `-O2` covers up any issues, but I think one should really investigate what the true problem is.

I am _very strongly_ against saying to never increase the optimization level to `-O3`.  If some later upstream version has fixed this problem, we _should_ increase the optimization level back to `-O3`.


---

Comment by drkirkby created at 2011-04-11 10:57:17

Replying to [comment:19 jdemeyer]:
> Replying to [comment:17 AlexanderDreyer]:
> > This seems to be the right solution
> 
> I completely disagree.  Dropping the optimization is at best a workaround. 

Agreed. 

>  IMHO it can _never_ be "the right solution".  It means that either the compiler or the code has a bug.  Maybe dropping the optimization to `-O2` covers up any issues, but I think one should really investigate what the true problem is.


Well, a lot of the code in Sage is very difficult to navigate. Sage developers did not write it. Much is incomprehensible. Most gives a lot of compiler warnings. Sorting out if a gcc bug or a bug in the code is difficult. Then if it is a bug in the code, finding where is often very very difficult. One could spend ages on it. 


> I am _very strongly_ against saying to never increase the optimization level to `-O3`.  If some later upstream version has fixed this problem, we _should_ increase the optimization level back to `-O3`.

Given this code has caused many issues on many platforms with optimization issues, then I think not increasing it is worthwhile. It should also be realised that -O3 does not necessarily run faster than -O2. The higher optimization level invokes more speculative optimisations, which may cause the code to run slower. See this point from a GCC developer.

http://gcc.gnu.org/ml/gcc-help/2010-07/msg00190.html


--------
_The -O3 optoin should be safe for correct code. An important difference between -O2/-O3 and -O1 is that -O2 and -O3 enable strict aliasing and strict overflow. Those options provide better optimization for correct code, but are far more likely to cause unexpected code generation for incorrect code. See the -fstrict-aliasing and -fstrict-overflow options._

_The main difference between -O3 and -O2 is that -O3 enables more speculative optimizations. These should not miscompile your code, but they may cause your program to run more slowly. _
------

So in summary
 * The upstream developers use -O2
 * Both -O2 and -O3 can cause problems with bad code. 
 * -O3 can be slower than -O2
 * Previous attempts to use -O3 have caused problems on numerous platforms
   * Fedora
   * OpenSUSE on Itanium
   * gcc on any platform
 * Just for good measure, the code can't be compiled with the Sun compiler, as it has hard-coded uses gcc-specific flags, so we can't even get a second opinion about doggy lines of code. 
 * Finding whether it's a gcc bug or a bug in Singular would take quite a bit of effort, and IMHO would be better spent elsewhere. 

There seems to be little appetite among the Sage community for investigating (and possibly fixing) the *thousands* of compiler warnings - some of which look potentially serious to me. To me at least, permitting -O3 on code which has caused numerous issues in the past is unwise. 

Dave


---

Comment by AlexanderDreyer created at 2011-04-11 11:25:38

> > > This seems to be the right solution
> > 
> > I completely disagree.  Dropping the optimization is at best a workaround. 
Of course, I meant a solution for now (let's call this workaround).

I also wanted to point out, that upstream Singular uses different optimization levels for different parts of the system. Some parts are actually compiled with -O3 (not the one which causes problems). 
So I had wanted to suggest, that the spkg should not increase the optimization level over the levels, respectively, intended by the upstream developers. (It's known that -O3 sometimes yields performance issues.)

For some reason the Sage-package forces a unified optimization setting for all parts of Singular. Avoiding this would be the best of course.

BTW: I'm pretty sure, the issue is a compiler bug: It complies without problems, but the linker looks for a (C++) function, whose mangled name doesn't fit what the linker expects.


---

Comment by jdemeyer created at 2011-04-11 12:43:52

Some administrative comment: there is already a new Singular spkg at #9497 (which will probably be merged in sage-4.7.alpha5), so you should rebase this ticket to the spkg at #9497.


---

Comment by jdemeyer created at 2011-04-11 12:48:32

David, would you agree with the compromise to weaken your wording about the `-O3` issue?  I.e. replace "Please do not push the optimisation to -O3. This has caused too many problems." by something along the lines of "Currently, building Singular with -O3 fails using gcc 4.6.0.  Therefore, we compile using -O2."


---

Comment by vbraun created at 2011-04-11 17:01:31

I dug around for the missing symbol a bit and the issue is in const propagation where some function should get compiled into a const and a non-const version, but apparently one of them is missing when linking everything. I'm not sure if its a compiler bug or a misuse of const-ness that causes it.

With lower optimization gcc probably doesn't emit two distinct versions of the function. So the bug should only affect whether the code compiles or not, but never give wrong results.


---

Comment by jdemeyer created at 2011-04-11 20:33:58

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2011-04-18 08:27:34

Changing priority from critical to blocker.


---

Comment by AlexanderDreyer created at 2011-04-18 09:05:25

Changing status from needs_work to needs_review.


---

Comment by AlexanderDreyer created at 2011-04-18 09:05:25

I put the merged spkg here:
http://boxen.math.washington.edu/home/dreyer/spkg/singular-3-1-1-4.p7.spkg
Unfortunately, somebody else will need to review it now.


---

Comment by drkirkby created at 2011-04-19 04:53:38

Positive review. 

Is there a good reason this can't be merged into 4.7 now? Then all the gcc 4.6.0 issues will be resolved. #11159 does mention that gcc 4.6.0 will not build Sage and addresses an issue about GNU tar on Os X. But quite honestly if this is merged, and #11159 is not, then the is just a minor documentation error about GNU tar on OS X. I feel the gcc 4.6.0 issue is far more important than a minor error in the documentation. Or another ticket can be created to remove the comments about gcc 4.6.0 not building Sage. 

Dave


---

Comment by drkirkby created at 2011-04-19 04:54:09

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2011-04-19 10:02:57

Are we really supposed to *overwrite* CFLAGS instead of *appending* CLFAGS when SAGE64 is set?

From `spkg-install`:

```
if [ "x$SAGE64" = xyes ]; then
    echo "Building a 64-bit version of Singular"
    CFLAGS="-O2 -g -m64 "
    CXXFLAGS="-O2 -g -m64"
    CPPFLAGS="-O2 -g -m64"
    LDFLAGS="-m64 "; export LDFLAGS
    if [ "x`uname`" = xSunOS ] ; then
      CC="$CC -m64"
      export CC
      CXX="$CXX -m64"
      export CXX
    fi
fi
```



---

Comment by jdemeyer created at 2011-04-19 10:08:48

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2011-04-19 10:08:48

New spkg (not overwriting of CFLAGS when SAGE64 is set): [http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-1-4.p8.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-1-4.p8.spkg)


---

Comment by jdemeyer created at 2011-04-19 10:09:46

Changing status from needs_work to needs_review.


---

Comment by drkirkby created at 2011-04-19 10:35:30

Replying to [comment:23 jdemeyer]:
> David, would you agree with the compromise to weaken your wording about the `-O3` issue?  I.e. replace "Please do not push the optimisation to -O3. This has caused too many problems." by something along the lines of "Currently, building Singular with -O3 fails using gcc 4.6.0.  Therefore, we compile using -O2."

I will make it less strong, but I feel it needs to be a bit stronger than just mention gcc 4.6.0. 

How about 

_The original Singular source code builds part of Singular with -O2 and part with -O3. On several occasions Sage has forced the optimisation of the complete package to -O3, but this has caused various problems (tickets x, y, and x) either with specific compilers or on specific platforms. If you feel tempted to increase the optimiation to -O3, ask on the Singular mailing (whatever`@`wherever.org) list for advice and discuss in on sage-devel first. Also note that -O3 can be slower than -O2 in some instances._

Does that seem reasonable?


---

Comment by drkirkby created at 2011-04-19 10:37:29

Replying to [comment:31 jdemeyer]:
> Are we really supposed to *overwrite* CFLAGS instead of *appending* CLFAGS when SAGE64 is set?

No, that is an error, though it is a separate issue to the subject of the ticket. But it is easy to fix. 

Dave


---

Comment by jdemeyer created at 2011-04-19 12:48:47

Replying to [comment:35 drkirkby]:
> Replying to [comment:31 jdemeyer]:
> > Are we really supposed to *overwrite* CFLAGS instead of *appending* CLFAGS when SAGE64 is set?
> 
> No, that is an error, though it is a separate issue to the subject of the ticket. But it is easy to fix. 

In that case, please review my spkg [http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-1-4.p8.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-1-4.p8.spkg).


---

Comment by jdemeyer created at 2011-04-19 12:56:46

Replying to [comment:34 drkirkby]:
> Replying to [comment:23 jdemeyer]:
> > David, would you agree with the compromise to weaken your wording about the `-O3` issue?  I.e. replace "Please do not push the optimisation to -O3. This has caused too many problems." by something along the lines of "Currently, building Singular with -O3 fails using gcc 4.6.0.  Therefore, we compile using -O2."
> 
> I will make it less strong, but I feel it needs to be a bit stronger than just mention gcc 4.6.0. 
> 
> How about 
> 
> _The original Singular source code builds part of Singular with -O2 and part with -O3. On several occasions Sage has forced the optimisation of the complete package to -O3, but this has caused various problems (tickets x, y, and x) either with specific compilers or on specific platforms. If you feel tempted to increase the optimiation to -O3, ask on the Singular mailing (whatever`@`wherever.org) list for advice and discuss in on sage-devel first. Also note that -O3 can be slower than -O2 in some instances._
> 
> Does that seem reasonable? 

It's not unreasonable, but a lot of fuzz about nothing.  What do you think of the following comment from my spkg:

```
# By default, parts of Singular are compiled with -O2 and parts
# with -O3.  If we do set any CFLAGS, this always overrides the
# default CFLAGS set by upstream.  In order to be compatible, we
# set the optimization to -O2.
```

I think it's most important to explain *why* we use `-O2`.  Since there is a good reason to use `-O2`, of course one should not randomly increase the `-O` level.


---

Comment by drkirkby created at 2011-04-19 20:42:28

Replying to [comment:37 jdemeyer]:
> I think it's most important to explain *why* we use `-O2`.  Since there is a good reason to use `-O2`, of course one should not randomly increase the `-O` level.

But my point is that this package does appear to have had the optimisation randomly increased several times, which for Singular is a particularly bad idea, as it has caused numerous problems. Your wording gives no hint of the dangers. We are not being compatible for the sake of it - we are doing so as it is dangerous to do otherwise. 

Dave


---

Comment by jdemeyer created at 2011-04-20 06:53:15

How about adding a phrase like this:

```
# By default, parts of Singular are compiled with -O2 and parts
# with -O3.  If we do set any CFLAGS, this always overrides the
# default CFLAGS set by upstream.  In order to be compatible, we
# set the optimization to -O2.  Increasing the optimization level
# to -O3 has caused various problems in the past either with
# specific compilers or on specific platforms.
```



---

Comment by jdemeyer created at 2011-04-20 08:30:51

New package, use -O2 optimization level also for ia64 systems (testing on iras shows that this now works): [http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-1-4.p8.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-1-4.p8.spkg)


---

Comment by drkirkby created at 2011-04-20 10:25:10

That looks ok to me. 

Could this not go into 4.7? It seems to me we have fixes for all the gcc 4.6.0 issues. If Sage will build on some platforms with gcc 4.6.0, we have a lot more chance of finding any remaining issues on other platforms.


---

Comment by drkirkby created at 2011-04-20 10:25:10

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2011-04-20 15:01:53

Replying to [comment:41 drkirkby]:
> Could this not go into 4.7?

I'm willing to try...


---

Comment by jdemeyer created at 2011-04-20 19:56:44

Resolution: fixed


---

Comment by jdemeyer created at 2011-04-20 20:58:57

I have also closed #6240 because of this ticket.


---

Comment by jdemeyer created at 2011-04-30 20:12:55

Diff for the singular spkg, for reviewing only


---

Attachment

Please see #11278 for a *blocker* follow-up, any ideas more than welcome...
