# Issue 26481: Upgrade to three.js r98

Issue created by migration from Trac.

Original creator: slelievre

Original creation time: 2018-11-19 07:47:57

CC:  arojas fbissey novoselt schilly slelievre was egourgoulhon

Keywords: upgrade, threejs, three.js

This ticket is to upgrade to three.js r98.

Our last upgrade of our threejs package was to Three.js r80 in #22226 in 2017-01.

In a [sage-support discussion](https://groups.google.com/d/msg/sage-support/bb6D_FkpJNQ/discussion) about 3D plotting on Arch Linux, [Antonio Rojas points out](https://groups.google.com/d/msg/sage-support/bb6D_FkpJNQ/qRrYcBG9AwAJ) that:

> The three.js version shipped by Arch is too new and not supported by Sage.
> Either use jsmol (which is still the default), or use the online version of three.js
> (viewer='threejs', online=True) (with sagemath 8.4-4, in previous versions the
> online version doesn't work either).


---

Comment by arojas created at 2018-11-19 12:37:44

The breakage happened in r91. Since that version, plots only show a black box at first. If you click and drag on the black box you get the axes (which rotate correctly), but no plot.


---

Comment by slelievre created at 2019-01-13 18:55:20

Three.js r100 is out.


---

Comment by slelievre created at 2019-01-30 09:20:32

Has this problem already been dealt with on SageCell or CoCalc, by any chance?


---

Comment by slelievre created at 2019-01-30 09:25:31

Replying to [comment:1 arojas]:

> The breakage happened in r91.

Are there any hints in the [three.js r90--r91 migration guide](https://github.com/mrdoob/three.js/wiki/Migration-Guide#r90--r91)?


---

Comment by arojas created at 2019-01-30 13:44:19

Replying to [comment:4 slelievre]:
> Replying to [comment:1 arojas]:
> 
> > The breakage happened in r91.
> 
> Are there any hints in the [three.js r90--r91 migration guide](https://github.com/mrdoob/three.js/wiki/Migration-Guide#r90--r91)?

The first bad build is https://github.com/mrdoob/three.js/commit/e5012e237dd1f05182dc1879347e7cb05bbebf48


---

Comment by novoselt created at 2019-01-30 17:15:33

Replying to [comment:3 slelievre]:
> Has this problem already been dealt with on SageCell or CoCalc, by any chance?

CoCalc has independent threejs code. This used to be the case with SageMathCell, but since it leads to incompatibilities between different interfaces and adds maintenance load, I was very happy to ditch it when threejs got available in Sage itself. I have no plans to change it back ;-)


---

Comment by paulmasson created at 2019-03-29 19:34:29

Replying to [comment:4 slelievre]:
> Replying to [comment:1 arojas]:
> 
> > The breakage happened in r91.
> 
> Are there any hints in the [three.js r90--r91 migration guide](https://github.com/mrdoob/three.js/wiki/Migration-Guide#r90--r91)?
In the first line: Geometry().center() has changed behavior. 

There is some cleanup that needs to happen in the Three.js template before this upgrade. Then Iâ€™ll take care of this ticket.


---

Comment by paulmasson created at 2019-04-13 00:15:30

Changing status from new to needs_review.


---

Comment by paulmasson created at 2019-04-13 00:15:30

Please test existing notebooks with multiple transparent objects to confirm proper rendering of them.
----
New commits:


---

Comment by egourgoulhon created at 2019-04-19 14:43:54

Changing status from needs_review to needs_work.


---

Attachment

In a jupyter notebook, the following command

```
show(line3d([(1,2,3), (1,0,-2), (3,1,4), (2,1,-2)]), viewer='threejs')
```

results in a black box. If one click on it, one obtains an empty 3D frame, with no line drawn.


---

Comment by git created at 2019-04-19 21:15:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by paulmasson created at 2019-04-19 21:16:41

Changing status from needs_work to needs_review.


---

Comment by paulmasson created at 2019-04-19 21:16:41

Forgot to correct the centering for points and lines. Should work now.


---

Attachment

threejs plot of 2 spheres


---

Comment by egourgoulhon created at 2019-04-24 19:25:35

Changing status from needs_review to positive_review.


---

Comment by egourgoulhon created at 2019-04-24 19:25:35

Sorry for the delay in replying and thanks for the update.
I've checked it in both python2 and python3 Sage. Everything seems OK. Some issues are not fixed by the upgrade to r100:

- the code

```
g = sphere(color='red', opacity=0.2)
g += sphere((0.5,0,0), color='lightgrey', opacity=0.4)
show(g, viewer='threejs')
```

results in a truncated grey sphere, with some spurious shaded layers, cf. the attached image: ![](two_spheres.png))
- the code

```
icosahedron(viewer='threejs')
```

yields a "rounded" icosahedron.

These issues were already there in r80 and I understand that it is not the scope of this ticket to fix them. So positive review and thanks for the upgrade!


---

Comment by paulmasson created at 2019-04-24 20:11:14

Eric, thanks for the review. I have several enhancements in mind but will wait until this ticket is merged in the next beta.

The icosahedron can be fixed with flat shading. I've already identified a spot in the code that should work for all Platonic solids.

The problem with the spheres is just part of how transparency works in WebGL. If you rotate the figure you'll see that the red sphere is truncated itself from certain angles. WebGL renders transparent objects as if located entirely at the center of the object. Extended intersecting transparent objects will always experience these sorts of issues. I don't think there's much I can do about that.


---

Comment by vbraun created at 2019-04-27 18:01:19

Where is the tarball?


---

Comment by vbraun created at 2019-04-27 18:01:19

Changing status from positive_review to needs_work.


---

Comment by paulmasson created at 2019-04-27 18:08:04

Changing status from needs_work to positive_review.


---

Comment by paulmasson created at 2019-04-27 18:08:04

Replying to [comment:16 vbraun]:
> Where is the tarball?
Just after [comment:10 this comment]


---

Comment by egourgoulhon created at 2019-04-28 08:09:15

Replying to [comment:15 paulmasson]:
> Eric, thanks for the review. I have several enhancements in mind but will wait until this ticket is merged in the next beta.
> 

OK very good.

> The icosahedron can be fixed with flat shading. I've already identified a spot in the code that should work for all Platonic solids.
> 
> The problem with the spheres is just part of how transparency works in WebGL. If you rotate the figure you'll see that the red sphere is truncated itself from certain angles. WebGL renders transparent objects as if located entirely at the center of the object. Extended intersecting transparent objects will always experience these sorts of issues. I don't think there's much I can do about that.

Thanks for these explanations.


---

Comment by vbraun created at 2019-05-06 11:56:41

Resolution: fixed
