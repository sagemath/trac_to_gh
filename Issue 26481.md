# Issue 26481: Upgrade to three.js r98

archive/issues_026481.json:
```json
{
    "body": "CC:  @antonio-rojas @kiwifb @novoselt @haraldschilly @slel @williamstein @egourgoulhon\n\nKeywords: upgrade, threejs, three.js\n\nThis ticket is to upgrade to three.js r98.\n\nOur last upgrade of our threejs package was to Three.js r80 in #22226 in 2017-01.\n\nIn a [sage-support discussion](https://groups.google.com/d/msg/sage-support/bb6D_FkpJNQ/discussion) about 3D plotting on Arch Linux, [Antonio Rojas points out](https://groups.google.com/d/msg/sage-support/bb6D_FkpJNQ/qRrYcBG9AwAJ) that:\n\n> The three.js version shipped by Arch is too new and not supported by Sage.\n> Either use jsmol (which is still the default), or use the online version of three.js\n> (viewer='threejs', online=True) (with sagemath 8.4-4, in previous versions the\n> online version doesn't work either).\n\nIssue created by migration from https://trac.sagemath.org/ticket/26718\n\n",
    "created_at": "2018-11-19T07:47:57Z",
    "labels": [
        "component: packages: standard"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "Upgrade to three.js r98",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26481",
    "user": "https://github.com/slel"
}
```
CC:  @antonio-rojas @kiwifb @novoselt @haraldschilly @slel @williamstein @egourgoulhon

Keywords: upgrade, threejs, three.js

This ticket is to upgrade to three.js r98.

Our last upgrade of our threejs package was to Three.js r80 in #22226 in 2017-01.

In a [sage-support discussion](https://groups.google.com/d/msg/sage-support/bb6D_FkpJNQ/discussion) about 3D plotting on Arch Linux, [Antonio Rojas points out](https://groups.google.com/d/msg/sage-support/bb6D_FkpJNQ/qRrYcBG9AwAJ) that:

> The three.js version shipped by Arch is too new and not supported by Sage.
> Either use jsmol (which is still the default), or use the online version of three.js
> (viewer='threejs', online=True) (with sagemath 8.4-4, in previous versions the
> online version doesn't work either).

Issue created by migration from https://trac.sagemath.org/ticket/26718





---

archive/issue_comments_372076.json:
```json
{
    "body": "The breakage happened in r91. Since that version, plots only show a black box at first. If you click and drag on the black box you get the axes (which rotate correctly), but no plot.",
    "created_at": "2018-11-19T12:37:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26481#issuecomment-372076",
    "user": "https://github.com/antonio-rojas"
}
```

The breakage happened in r91. Since that version, plots only show a black box at first. If you click and drag on the black box you get the axes (which rotate correctly), but no plot.



---

archive/issue_comments_372077.json:
```json
{
    "body": "Three.js r100 is out.",
    "created_at": "2019-01-13T18:55:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26481#issuecomment-372077",
    "user": "https://github.com/slel"
}
```

Three.js r100 is out.



---

archive/issue_comments_372078.json:
```json
{
    "body": "Has this problem already been dealt with on SageCell or CoCalc, by any chance?",
    "created_at": "2019-01-30T09:20:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26481#issuecomment-372078",
    "user": "https://github.com/slel"
}
```

Has this problem already been dealt with on SageCell or CoCalc, by any chance?



---

archive/issue_comments_372079.json:
```json
{
    "body": "Replying to [comment:1 arojas]:\n\n> The breakage happened in r91.\n\nAre there any hints in the [three.js r90--r91 migration guide](https://github.com/mrdoob/three.js/wiki/Migration-Guide#r90--r91)?",
    "created_at": "2019-01-30T09:25:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26481#issuecomment-372079",
    "user": "https://github.com/slel"
}
```

Replying to [comment:1 arojas]:

> The breakage happened in r91.

Are there any hints in the [three.js r90--r91 migration guide](https://github.com/mrdoob/three.js/wiki/Migration-Guide#r90--r91)?



---

archive/issue_comments_372080.json:
```json
{
    "body": "Replying to [comment:4 slelievre]:\n> Replying to [comment:1 arojas]:\n> \n> > The breakage happened in r91.\n> \n> Are there any hints in the [three.js r90--r91 migration guide](https://github.com/mrdoob/three.js/wiki/Migration-Guide#r90--r91)?\n\nThe first bad build is https://github.com/mrdoob/three.js/commit/e5012e237dd1f05182dc1879347e7cb05bbebf48",
    "created_at": "2019-01-30T13:44:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26481#issuecomment-372080",
    "user": "https://github.com/antonio-rojas"
}
```

Replying to [comment:4 slelievre]:
> Replying to [comment:1 arojas]:
> 
> > The breakage happened in r91.
> 
> Are there any hints in the [three.js r90--r91 migration guide](https://github.com/mrdoob/three.js/wiki/Migration-Guide#r90--r91)?

The first bad build is https://github.com/mrdoob/three.js/commit/e5012e237dd1f05182dc1879347e7cb05bbebf48



---

archive/issue_comments_372081.json:
```json
{
    "body": "Replying to [comment:3 slelievre]:\n> Has this problem already been dealt with on SageCell or CoCalc, by any chance?\n\nCoCalc has independent threejs code. This used to be the case with SageMathCell, but since it leads to incompatibilities between different interfaces and adds maintenance load, I was very happy to ditch it when threejs got available in Sage itself. I have no plans to change it back ;-)",
    "created_at": "2019-01-30T17:15:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26481#issuecomment-372081",
    "user": "https://github.com/novoselt"
}
```

Replying to [comment:3 slelievre]:
> Has this problem already been dealt with on SageCell or CoCalc, by any chance?

CoCalc has independent threejs code. This used to be the case with SageMathCell, but since it leads to incompatibilities between different interfaces and adds maintenance load, I was very happy to ditch it when threejs got available in Sage itself. I have no plans to change it back ;-)



---

archive/issue_comments_372082.json:
```json
{
    "body": "Replying to [comment:4 slelievre]:\n> Replying to [comment:1 arojas]:\n> \n> > The breakage happened in r91.\n> \n> Are there any hints in the [three.js r90--r91 migration guide](https://github.com/mrdoob/three.js/wiki/Migration-Guide#r90--r91)?\nIn the first line: Geometry().center() has changed behavior. \n\nThere is some cleanup that needs to happen in the Three.js template before this upgrade. Then I\u2019ll take care of this ticket.",
    "created_at": "2019-03-29T19:34:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26481#issuecomment-372082",
    "user": "https://github.com/paulmasson"
}
```

Replying to [comment:4 slelievre]:
> Replying to [comment:1 arojas]:
> 
> > The breakage happened in r91.
> 
> Are there any hints in the [three.js r90--r91 migration guide](https://github.com/mrdoob/three.js/wiki/Migration-Guide#r90--r91)?
In the first line: Geometry().center() has changed behavior. 

There is some cleanup that needs to happen in the Three.js template before this upgrade. Then Iâ€™ll take care of this ticket.



---

archive/issue_comments_372083.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-04-13T00:15:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26481#issuecomment-372083",
    "user": "https://github.com/paulmasson"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_372084.json:
```json
{
    "body": "Please test existing notebooks with multiple transparent objects to confirm proper rendering of them.\n----\nNew commits:",
    "created_at": "2019-04-13T00:15:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26481#issuecomment-372084",
    "user": "https://github.com/paulmasson"
}
```

Please test existing notebooks with multiple transparent objects to confirm proper rendering of them.
----
New commits:



---

archive/issue_comments_372085.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-04-19T14:43:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26481#issuecomment-372085",
    "user": "https://github.com/egourgoulhon"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_372086.json:
```json
{
    "body": "Attachment [threejs-r100.tar.gz](tarball://root/attachments/some-uuid/ticket26718/threejs-r100.tar.gz) by @egourgoulhon created at 2019-04-19 14:43:54\n\nIn a jupyter notebook, the following command\n\n```\nshow(line3d([(1,2,3), (1,0,-2), (3,1,4), (2,1,-2)]), viewer='threejs')\n```\n\nresults in a black box. If one click on it, one obtains an empty 3D frame, with no line drawn.",
    "created_at": "2019-04-19T14:43:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26481#issuecomment-372086",
    "user": "https://github.com/egourgoulhon"
}
```

Attachment [threejs-r100.tar.gz](tarball://root/attachments/some-uuid/ticket26718/threejs-r100.tar.gz) by @egourgoulhon created at 2019-04-19 14:43:54

In a jupyter notebook, the following command

```
show(line3d([(1,2,3), (1,0,-2), (3,1,4), (2,1,-2)]), viewer='threejs')
```

results in a black box. If one click on it, one obtains an empty 3D frame, with no line drawn.



---

archive/issue_comments_372087.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-04-19T21:15:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26481#issuecomment-372087",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_372088.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-04-19T21:16:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26481#issuecomment-372088",
    "user": "https://github.com/paulmasson"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_372089.json:
```json
{
    "body": "Forgot to correct the centering for points and lines. Should work now.",
    "created_at": "2019-04-19T21:16:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26481#issuecomment-372089",
    "user": "https://github.com/paulmasson"
}
```

Forgot to correct the centering for points and lines. Should work now.



---

archive/issue_comments_372090.json:
```json
{
    "body": "Attachment [two_spheres.png](tarball://root/attachments/some-uuid/ticket26718/two_spheres.png) by @egourgoulhon created at 2019-04-24 19:22:16\n\nthreejs plot of 2 spheres",
    "created_at": "2019-04-24T19:22:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26481#issuecomment-372090",
    "user": "https://github.com/egourgoulhon"
}
```

Attachment [two_spheres.png](tarball://root/attachments/some-uuid/ticket26718/two_spheres.png) by @egourgoulhon created at 2019-04-24 19:22:16

threejs plot of 2 spheres



---

archive/issue_comments_372091.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-04-24T19:25:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26481#issuecomment-372091",
    "user": "https://github.com/egourgoulhon"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_372092.json:
```json
{
    "body": "Sorry for the delay in replying and thanks for the update.\nI've checked it in both python2 and python3 Sage. Everything seems OK. Some issues are not fixed by the upgrade to r100:\n\n- the code\n\n```\ng = sphere(color='red', opacity=0.2)\ng += sphere((0.5,0,0), color='lightgrey', opacity=0.4)\nshow(g, viewer='threejs')\n```\n\nresults in a truncated grey sphere, with some spurious shaded layers, cf. the attached image: ![](two_spheres.png))\n- the code\n\n```\nicosahedron(viewer='threejs')\n```\n\nyields a \"rounded\" icosahedron.\n\nThese issues were already there in r80 and I understand that it is not the scope of this ticket to fix them. So positive review and thanks for the upgrade!",
    "created_at": "2019-04-24T19:25:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26481#issuecomment-372092",
    "user": "https://github.com/egourgoulhon"
}
```

Sorry for the delay in replying and thanks for the update.
I've checked it in both python2 and python3 Sage. Everything seems OK. Some issues are not fixed by the upgrade to r100:

- the code

```
g = sphere(color='red', opacity=0.2)
g += sphere((0.5,0,0), color='lightgrey', opacity=0.4)
show(g, viewer='threejs')
```

results in a truncated grey sphere, with some spurious shaded layers, cf. the attached image: ![](two_spheres.png))
- the code

```
icosahedron(viewer='threejs')
```

yields a "rounded" icosahedron.

These issues were already there in r80 and I understand that it is not the scope of this ticket to fix them. So positive review and thanks for the upgrade!



---

archive/issue_comments_372093.json:
```json
{
    "body": "Eric, thanks for the review. I have several enhancements in mind but will wait until this ticket is merged in the next beta.\n\nThe icosahedron can be fixed with flat shading. I've already identified a spot in the code that should work for all Platonic solids.\n\nThe problem with the spheres is just part of how transparency works in WebGL. If you rotate the figure you'll see that the red sphere is truncated itself from certain angles. WebGL renders transparent objects as if located entirely at the center of the object. Extended intersecting transparent objects will always experience these sorts of issues. I don't think there's much I can do about that.",
    "created_at": "2019-04-24T20:11:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26481#issuecomment-372093",
    "user": "https://github.com/paulmasson"
}
```

Eric, thanks for the review. I have several enhancements in mind but will wait until this ticket is merged in the next beta.

The icosahedron can be fixed with flat shading. I've already identified a spot in the code that should work for all Platonic solids.

The problem with the spheres is just part of how transparency works in WebGL. If you rotate the figure you'll see that the red sphere is truncated itself from certain angles. WebGL renders transparent objects as if located entirely at the center of the object. Extended intersecting transparent objects will always experience these sorts of issues. I don't think there's much I can do about that.



---

archive/issue_comments_372094.json:
```json
{
    "body": "Where is the tarball?",
    "created_at": "2019-04-27T18:01:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26481#issuecomment-372094",
    "user": "https://github.com/vbraun"
}
```

Where is the tarball?



---

archive/issue_comments_372095.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-04-27T18:01:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26481#issuecomment-372095",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_372096.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2019-04-27T18:08:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26481#issuecomment-372096",
    "user": "https://github.com/paulmasson"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_372097.json:
```json
{
    "body": "Replying to [comment:16 vbraun]:\n> Where is the tarball?\nJust after [comment:10 this comment]",
    "created_at": "2019-04-27T18:08:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26481#issuecomment-372097",
    "user": "https://github.com/paulmasson"
}
```

Replying to [comment:16 vbraun]:
> Where is the tarball?
Just after [comment:10 this comment]



---

archive/issue_comments_372098.json:
```json
{
    "body": "Replying to [comment:15 paulmasson]:\n> Eric, thanks for the review. I have several enhancements in mind but will wait until this ticket is merged in the next beta.\n> \n\nOK very good.\n\n> The icosahedron can be fixed with flat shading. I've already identified a spot in the code that should work for all Platonic solids.\n> \n> The problem with the spheres is just part of how transparency works in WebGL. If you rotate the figure you'll see that the red sphere is truncated itself from certain angles. WebGL renders transparent objects as if located entirely at the center of the object. Extended intersecting transparent objects will always experience these sorts of issues. I don't think there's much I can do about that.\n\nThanks for these explanations.",
    "created_at": "2019-04-28T08:09:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26481#issuecomment-372098",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:15 paulmasson]:
> Eric, thanks for the review. I have several enhancements in mind but will wait until this ticket is merged in the next beta.
> 

OK very good.

> The icosahedron can be fixed with flat shading. I've already identified a spot in the code that should work for all Platonic solids.
> 
> The problem with the spheres is just part of how transparency works in WebGL. If you rotate the figure you'll see that the red sphere is truncated itself from certain angles. WebGL renders transparent objects as if located entirely at the center of the object. Extended intersecting transparent objects will always experience these sorts of issues. I don't think there's much I can do about that.

Thanks for these explanations.



---

archive/issue_events_024608.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-05-06T11:56:41Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26481",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26481#event-24608"
}
```



---

archive/issue_comments_372099.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-05-06T11:56:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26481#issuecomment-372099",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
