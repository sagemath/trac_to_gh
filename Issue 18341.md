# Issue 18341: Python 3 preparation: Special function __div__() is used no more in Py3

Issue created by migration from Trac.

Original creator: wluebbe

Original creation time: 2015-06-02 05:46:48

Keywords: python3

There (among others) the three special functions `__div__()`, `__truediv__()` and `__floordiv__()`.

They are invoked by the division operators `/` and `//`:
* In Py2: `__div__()` and `__floordiv__()` are called.
* In Py2 (when `from __future__ import division` is in effect): `__truediv__()` and `__floordiv__()` are called.
* In Py3: `__truediv__()` and `__floordiv__()` are called.
So in the last two cases `__div__()` is not called for `/` but `__truediv__()`. 
If `__truediv__()` is not available an exception is thrown.

Therefor classes defining `__div__()` must be checked that they also work in the last two cases! The related special function `__idiv__()` is effected too.

The ticket is tracked as a dependency of #15995.


---

Comment by wluebbe created at 2015-06-02 06:08:41

Script illustrating __div__() et.al. with Py2 (and from future import  division) and Py3


---

Attachment

To observe the actual code behavior (besides reading the Python docs) I created a small test script (see the attached file). A summary of the output under various conditions is here:

```
__div__       is defined
__truediv__   is defined
__floordiv__  is defined
__idiv__      is defined
__itruediv__  is defined
__ifloordiv__ is defined

python version: 2.7.10 (default, May 23 2015, 09:44:00) [MSC v.1500 64 bit (AMD64)]
from __future__ import division is NOT active
function: __div__       115 10 ## operator is /; result=cla(11)
function: __floordiv__  115 10 ## operator is //; result=cla(11)
function: __idiv__      215 10 ## operator is /=; result=cla(21)
function: __ifloordiv__ 215 10 ## operator is //=; result=cla(21)

Python version: 2.7.10 (default, May 23 2015, 09:44:00) [MSC v.1500 64 bit (AMD64)]
from __future__ import division is active
function: __truediv__   115 10 ## operator is /; result=cla(11.5)
function: __floordiv__  115 10 ## operator is //; result=cla(11)
function: __itruediv__  215 10 ## operator is /=; result=cla(21.5)
function: __ifloordiv__ 215 10 ## operator is //=; result=cla(21)

Python version: 3.4.3 (v3.4.3:9b73f1c3e601, Feb 24 2015, 22:44:40) [MSC v.1600 64 bit (AMD64)]
from __future__ import division is NOT active
function: __truediv__   115 10 ## operator is /; result=cla(11.5)
function: __floordiv__  115 10 ## operator is //; result=cla(11)
function: __itruediv__  215 10 ## operator is /=; result=cla(21.5)
function: __ifloordiv__ 215 10 ## operator is //=; result=cla(21)

Python version: 3.4.3 (v3.4.3:9b73f1c3e601, Feb 24 2015, 22:44:40) [MSC v.1600 64 bit (AMD64)]
from __future__ import division is active
function: __truediv__   115 10 ## operator is /; result=cla(11.5)
function: __floordiv__  115 10 ## operator is //; result=cla(11)
function: __itruediv__  215 10 ## operator is /=; result=cla(21.5)
function: __ifloordiv__ 215 10 ## operator is //=; result=cla(21)
```



---

Attachment

The result of   git grep -P "div__" >~/grep-of-div__.txt


---

Comment by wluebbe created at 2015-06-02 12:17:49

Currently the branch contains the changes of 20 .py modules. 
I start working on the .pyx modules now.
----
New commits:


---

Comment by wluebbe created at 2015-06-02 12:17:49

Set assignee to wluebbe.


---

Comment by wluebbe created at 2015-06-02 12:27:26

But trying the same approach does not seem to work for (e.g.) `src/sage/ext/fast_callable.pyx`.


```
    def __truediv__(s, o):
    ...
    ...
    # for Python 2 without from __future__ import division
    __div__ = __truediv__
```

apparently does not define `__div__()`.


---

Comment by jdemeyer created at 2015-06-02 12:42:54

Replying to [comment:3 wluebbe]:
> But trying the same approach does not seem to work for (e.g.) `src/sage/ext/fast_callable.pyx`.
> 
> {{{
>     def __truediv__(s, o):
>     ...
>     ...
>     # for Python 2 without from __future__ import division
>     __div__ = __truediv__
> }}}
> apparently does not define `__div__()`.

A `cdef class` in Cython is really a different thing than a Python `class`. So it's normal that the same approach doesn't work.

You could (and should) use the `__div__ = __truediv__` trick for a `class` defined in Cython code.


---

Comment by jdemeyer created at 2015-06-02 12:47:37

How about this in Cython?

```
from cpython.number cimport PyNumber_TrueDivide

def __div__(self, other):
    return PyNumber_TrueDivide(self, other)
```



---

Comment by wluebbe created at 2015-06-02 13:10:47

That gives a compile error:

```
Cythonizing sage/ext/fast_callable.pyx

Error compiling Cython file:
------------------------------------------------------------
...
            div(1, v_0)
        """
        return _expression_binop_helper(s, o, op_div)

    # for Python 2 without from __future__ import division
    from cpython.number cimport PyNumber_TrueDivide
   ^
------------------------------------------------------------

sage/ext/fast_callable.pyx:917:4: cimport only allowed at module level

Error compiling Cython file:
------------------------------------------------------------
...
        return _expression_binop_helper(s, o, op_div)

    # for Python 2 without from __future__ import division
    from cpython.number cimport PyNumber_TrueDivide
    def __div__(self, other):
        return PyNumber_TrueDivide(self, other)
                                 ^
------------------------------------------------------------

sage/ext/fast_callable.pyx:919:34: undeclared name not builtin: PyNumber_TrueDivide
```


Copying the code from `def __div__` to `def ___truediv__` clearly works - but there must be a better way!


---

Comment by jdemeyer created at 2015-06-02 13:21:20

Replying to [comment:6 wluebbe]:
> That gives a compile error:
> {{{
> sage/ext/fast_callable.pyx:917:4: cimport only allowed at module level
> }}}

Well, that's because you need to write

```
... cimport ...

cdef class ...
```

instead of

```
cdef class ...

    ... cimport ...
```



---

Comment by wluebbe created at 2015-06-02 13:29:06

Yes, that did the trick.

I was thinking that I could do without learning Cython ... but ... sigh ...

Thanks for the help!


---

Comment by wluebbe created at 2015-06-02 14:05:22

Not a complete success :-( . I am going into a never ending recursion:

```
    RuntimeError: maximum recursion depth exceeded while calling a Python object
**********************************************************************
1 item had failures:
   2 of   9 in sage.ext.fast_callable.Expression.__truediv__
```


I am just looking for a way that `__div__` directly delegates the work to `__truediv__`? Calling `PyNumber_TrueDivide` seems to cause the recursion. 
How can I call the directly previously defined method `__truediv__(s, o)` from within `def __div__(s,o):`?


---

Comment by jdemeyer created at 2015-06-03 10:19:29

I would be easier if you just show me what you have done.


---

Comment by wluebbe created at 2015-06-03 11:28:24

My current changes are in u/wluebbe/18578-1. 
Meanwhile I will have a look at the Cython doc.


---

Comment by jdemeyer created at 2015-06-03 12:07:17

Replying to [comment:9 wluebbe]:
> Not a complete success :-( . I am going into a never ending recursion:
> {{{
>     RuntimeError: maximum recursion depth exceeded while calling a Python object
> **********************************************************************
> 1 item had failures:
>    2 of   9 in sage.ext.fast_callable.Expression.__truediv__
> }}}
If you look at the traceback, you see why:

```
      File "sage/ext/fast_callable.pyx", line 918, in sage.ext.fast_callable.Expression.__div__ (build/cythonized/sage/ext/fast_callable.c:7203)
        return PyNumber_TrueDivide(self, other)
      File "sage/structure/element.pyx", line 2025, in sage.structure.element.RingElement.__truediv__ (build/cythonized/sage/structure/element.c:18064)
        return self.__div__(right)
      File "sage/structure/element.pyx", line 2038, in sage.structure.element.RingElement.__div__ (build/cythonized/sage/structure/element.c:18205)
        return coercion_model.bin_op(self, right, div)
      File "sage/structure/coerce.pyx", line 1040, in sage.structure.coerce.CoercionModel_cache_maps.bin_op (build/cythonized/sage/structure/coerce.c:9052)
        res = mul_method(x)
```

The problem is caused by this code in `element.pyx`:

```
    def __truediv__(self, right):
        # in sage all divs are true
        if not isinstance(self, Element):
            return coercion_model.bin_op(self, right, div)
        return self.__div__(right)
```



---

Comment by wluebbe created at 2015-06-03 14:07:34

I see -- and `element.pyx` is also on my todo list.
But that code is not the easiest to understand :-/


---

Comment by jdemeyer created at 2015-06-06 11:12:51

In the cases where the objects involved are `Parent`s, I would rather just put

```
def __div__(self, other):
    return PyNumber_TrueDivide(self, other)
```

in `Parent` instead of manually adding `__div__ = __truediv__` everywhere.


---

Comment by jdemeyer created at 2015-06-06 11:57:37

I created #18622 to deal with `element.pyx`


---

Comment by wluebbe created at 2015-06-09 07:40:02

I will work on the other pyx modules with sage-6.8.beta4 (#18622 has just been closed).


---

Comment by git created at 2015-06-22 06:59:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by wluebbe created at 2015-06-22 07:00:46

Resolved merge conflict with sage-6.8.beta5.


---

Comment by jdemeyer created at 2015-06-22 08:07:01

When you continue working on this, please keep in mind [comment:15].


---

Comment by jdemeyer created at 2015-06-22 08:07:32

In `src/sage/rings/number_field/number_field_ideal.py`, you are replacing `_div_` (single underscore!). That's wrong and should not be changed.


---

Comment by git created at 2015-06-22 09:12:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by wluebbe created at 2015-06-22 09:26:00

Replying to [comment:21 jdemeyer]:
> When you continue working on this, please keep in mind [comment:15].
Yes, I will.

While merging sage-6.8.beta5 I got confused: I did not notice what your change of `number_field_ideal.py` in #18622 was. And I pushed before testing the merge ... 
Then I struggled with undoing my mess :-/


---

Comment by git created at 2015-06-22 14:25:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by wluebbe created at 2015-06-22 14:30:30

Changing status from new to needs_review.


---

Comment by wluebbe created at 2015-06-22 14:33:14

Perhaps those tiny new functions might also need doctests?


---

Comment by jdemeyer created at 2015-06-22 18:28:23

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-06-22 18:28:23

See [comment:15]


---

Comment by jdemeyer created at 2015-06-22 18:31:36

In `src/sage/rings/polynomial/polynomial_element.pyx`, in `__truediv__`, call `RingElement.__truediv__` instead `RingElement.__div__`.


---

Comment by jdemeyer created at 2015-06-22 18:32:59

Don't use

```
PeriodicRegion.__truediv__(self, other)
```

in Cython. It's much slower than `PyNumber_TrueDivide`.


---

Comment by jdemeyer created at 2015-11-06 14:27:21

See also #19535 and #19536 for some partial progress.


---

Comment by jdemeyer created at 2016-01-07 09:40:06

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2016-01-07 09:40:06

New commits:


---

Comment by jdemeyer created at 2016-01-07 11:37:23

See also #19842.


---

Comment by vbraun created at 2016-01-07 23:25:54

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-01-08 19:17:35

Resolution: fixed
