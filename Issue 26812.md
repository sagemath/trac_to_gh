# Issue 26812: py3: some fix in Riemann surfaces

Issue created by migration from https://trac.sagemath.org/ticket/27049

Original creator: chapoton

Original creation time: 2019-01-13 09:31:04

CC:  tscrim

only partial, there remains 4 failing doctests out of 36


---

Comment by chapoton created at 2019-01-13 09:31:30

Changing status from new to needs_review.


---

Comment by chapoton created at 2019-01-13 09:31:30

New commits:


---

Comment by chapoton created at 2019-01-13 14:18:53

green bot, please review


---

Comment by tscrim created at 2019-01-13 17:01:18

LGTM.


---

Comment by tscrim created at 2019-01-13 17:01:18

Changing status from needs_review to positive_review.


---

Comment by nbruin created at 2019-01-14 21:09:28

Changed back to using sqrt method. It's much faster because it doesn't have to do all the generic stuff. This is a core routine -- it actually makes a difference if it's fast.

(also -- not a fan of all the trivial whitespace edits. It makes it hard to tell from the diff what has actually changed. If you have to touch a line anyway: sure, go ahead. Otherwise I think it's better to just leave it in the original form and not impose (subjective) aesthetics --PEP8's suggestions are mainly against too much whitespace; less so for too little :-) )
----
New commits:


---

Comment by nbruin created at 2019-01-14 21:33:27

Very minor change, but I guess someone should take a look at it before we set it back to positive review.


---

Comment by nbruin created at 2019-01-14 21:33:27

Changing status from positive_review to needs_review.


---

Comment by tscrim created at 2019-01-15 06:28:06

It would be fine with me except it can have a `float` input, which leads to these doctest failures (according to the patchbot):

```
sage -t --long src/sage/schemes/riemann_surfaces/riemann_surface.py  # 32 doctests failed
```



---

Comment by tscrim created at 2019-01-15 06:28:06

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2019-01-15 07:22:28

Whatever way, the point of this ticket is to make this module's doctests pass with both python2 and python3. If you want to keep the speed, this may not be so easy.

EDIT: pep8 is official for sage, see

https://doc.sagemath.org/html/en/developer/coding_basics.html#python-code-style


---

Comment by nbruin created at 2019-01-15 07:26:28

Replying to [comment:7 tscrim]:
> It would be fine with me except it can have a `float` input, which leads to these doctest failures (according to the patchbot)

That's strange. I cannot replicate that behaviour. It seems to me this bot is testing python 2, so it doesn't look like a py2/3 issue. Is this bot anomalous? If I had access to a platform where this behaviour occurs, I could probably debug this quite quickly.


---

Comment by chapoton created at 2019-01-15 07:30:06

Maybe this python3-like behaviour is caused by the line

```
from __future__ import division
```

that we really want to add.


---

Comment by nbruin created at 2019-01-15 07:38:47

Replying to [comment:10 chapoton]:
> Maybe this python3-like behaviour is caused by the line
> {{{
> from __future__ import division
> }}}
> that we really want to add.

Apparently only on some platforms then, because I ran this exact branch without problems. It means some divisions need to be encoded differently. 

Is it indeed the case that dividing an element of RealField by a python integer may yield a float on some and a RealField element on others if "division" is imported? That would be really bad and would make porting a lot harder.


---

Comment by chapoton created at 2019-01-15 07:45:54

I don't know.

We could try to use `**QQ((1,2))`but it will probably be just as slow as `sqrt(...)`


---

Comment by nbruin created at 2019-01-15 08:08:36

Replying to [comment:12 chapoton]:
> We could try to use `**QQ((1,2))`but it will probably be just as slow as `sqrt(...)`

No, if this really is a problem we can replace the "division by two" by an exponent operation, which would be very fast. I just need to know which operations are the problematic ones. On the computers I have access to, there is no problem, so I can't debug the problem presently.


---

Comment by git created at 2019-01-15 08:14:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nbruin created at 2019-01-15 08:14:49

Let's see how the bot fares with this.


---

Comment by chapoton created at 2019-01-15 08:18:15

got with python2 77 doctests failings in the modified file, for example

```
File "src/sage/schemes/riemann_surfaces/riemann_surface.py", line 2244, in sage.schemes.riemann_surfaces.riemann_surface.RiemannSurfaceSum.__add__
Failed example:
    S1+S1+S1
Exception raised:
    Traceback (most recent call last):
      File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1086, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.schemes.riemann_surfaces.riemann_surface.RiemannSurfaceSum.__add__[3]>", line 1, in <module>
        S1+S1+S1
      File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/schemes/riemann_surfaces/riemann_surface.py", line 2043, in __add__
        return RiemannSurfaceSum([self,other])
      File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/schemes/riemann_surfaces/riemann_surface.py", line 2168, in __init__
        PM = s.period_matrix()
      File "sage/misc/cachefunc.pyx", line 2314, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (build/cythonized/sage/misc/cachefunc.c:12763)
        self.cache = f(self._instance)
      File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/schemes/riemann_surfaces/riemann_surface.py", line 1562, in period_matrix
        PM=self.matrix_of_integral_values(differentials)
      File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/schemes/riemann_surfaces/riemann_surface.py", line 1499, in matrix_of_integral_values
        cycles = self.homology_basis()
      File "sage/misc/cachefunc.pyx", line 2314, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (build/cythonized/sage/misc/cachefunc.c:12763)
        self.cache = f(self._instance)
      File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/schemes/riemann_surfaces/riemann_surface.py", line 1170, in homology_basis
        edgesu = self.upstairs_edges()
      File "sage/misc/cachefunc.pyx", line 2314, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (build/cythonized/sage/misc/cachefunc.c:12763)
        self.cache = f(self._instance)
      File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/schemes/riemann_surfaces/riemann_surface.py", line 935, in upstairs_edges
        homotopycont = self.homotopy_continuation(e)
      File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/schemes/riemann_surfaces/riemann_surface.py", line 711, in homotopy_continuation
        delta = self._compute_delta(path(T), epsilon, wvalues=currw)/path_length
      File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/schemes/riemann_surfaces/riemann_surface.py", line 650, in _compute_delta
        lowerbound = self._CC(self._a0) >> 1
    TypeError: unsupported operand type(s) for >>: 'sage.rings.complex_number.ComplexNumber' and 'int'
```



---

Comment by chapoton created at 2019-01-15 08:21:27

Did you try with a python3-built sage ?

Replying to [comment:13 nbruin]:
> Replying to [comment:12 chapoton]:
> > We could try to use `**QQ((1,2))`but it will probably be just as slow as `sqrt(...)`
> 
> No, if this really is a problem we can replace the "division by two" by an exponent operation, which would be very fast. I just need to know which operations are the problematic ones. On the computers I have access to, there is no problem, so I can't debug the problem presently.


---

Comment by chapoton created at 2019-01-15 08:24:37

When undoing the bad change in `lowerbound = self._CC(self._a0) >> 1`,
I still get 36 failing doctests in python3 and 32 failing doctests in python2 (same as the one reported by Travis above)


---

Comment by git created at 2019-01-15 08:43:37

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by nbruin created at 2019-01-15 08:47:31

By running "sage -b" I was able to replicate the erroneous behaviour :-). Turns out the problem arose from an erroneous "fractional" exponent that was never fractional, so this code was actually not behaving as intended before, but doing so silently.

Hopefully the problem is solved now.


---

Comment by chapoton created at 2019-01-15 09:06:21

ok, thanks. This seems to work both in python2 and in python3. I have launched my bot on it.


---

Comment by chapoton created at 2019-01-15 09:08:16

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2019-01-15 10:55:03

Bot is now green. so this should be good to go. Positive review, everybody ?


---

Comment by tscrim created at 2019-01-15 16:08:52

LGTM.


---

Comment by tscrim created at 2019-01-15 16:08:52

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-01-24 18:17:31

Resolution: fixed
