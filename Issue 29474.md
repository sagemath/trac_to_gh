# Issue 29474: sagelib setup.py: Dependencies on header files of packages

archive/issues_029474.json:
```json
{
    "body": "CC:  dimpase charpent mjo @kliem slelievre\n\nRebuilds should be triggered when headers of relevant packages change.\n\nIn `setup.py` we have:\n\n```\n# Do not put all, but only the most common libraries and their headers\n# (that are likely to change on an upgrade) here:\n# [At least at the moment. Make sure the headers aren't copied with \"-p\",\n# or explicitly touch them in the respective spkg's spkg-install.]\nlib_headers = { \"gmp\":     [ os.path.join(SAGE_INC, 'gmp.h') ],   # cf. #8664, #9896\n                \"gmpxx\":   [ os.path.join(SAGE_INC, 'gmpxx.h') ],\n                \"ntl\":     [ os.path.join(SAGE_INC, 'NTL', 'config.h') ]\n              }\n```\n\nExcept for this (which is much too limited and also needs updating in light of the spkg-configure mechanism), we do not have dependency tracking for sagelib. Neither of distutils, setuptools, cython seem to have a mechanism for generating dependencies like gcc -M. This would be certainly be nice to have; in particular if it included dependencies on \"system\" headers and libraries, so that sagelib could automatically rebuild when system headers/libraries change (as in, most recently, \u200bhttps://groups.google.com/d/msg/sage-release/A53tGGsJNLg/uA01oUugAQAJ)..\n\nIssue created by migration from https://trac.sagemath.org/ticket/29711\n\n",
    "created_at": "2020-05-19T01:23:55Z",
    "labels": [
        "build",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "sagelib setup.py: Dependencies on header files of packages",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29474",
    "user": "mkoeppe"
}
```
CC:  dimpase charpent mjo @kliem slelievre

Rebuilds should be triggered when headers of relevant packages change.

In `setup.py` we have:

```
# Do not put all, but only the most common libraries and their headers
# (that are likely to change on an upgrade) here:
# [At least at the moment. Make sure the headers aren't copied with "-p",
# or explicitly touch them in the respective spkg's spkg-install.]
lib_headers = { "gmp":     [ os.path.join(SAGE_INC, 'gmp.h') ],   # cf. #8664, #9896
                "gmpxx":   [ os.path.join(SAGE_INC, 'gmpxx.h') ],
                "ntl":     [ os.path.join(SAGE_INC, 'NTL', 'config.h') ]
              }
```

Except for this (which is much too limited and also needs updating in light of the spkg-configure mechanism), we do not have dependency tracking for sagelib. Neither of distutils, setuptools, cython seem to have a mechanism for generating dependencies like gcc -M. This would be certainly be nice to have; in particular if it included dependencies on "system" headers and libraries, so that sagelib could automatically rebuild when system headers/libraries change (as in, most recently, â€‹https://groups.google.com/d/msg/sage-release/A53tGGsJNLg/uA01oUugAQAJ)..

Issue created by migration from https://trac.sagemath.org/ticket/29711





---

archive/issue_comments_418331.json:
```json
{
    "body": "What you really want to do here is rebuild sagelib whenever the public API of a dependency changes in a backwards-incompatible way. We devised \"subslots\" in Gentoo for the purpose of telling the package manager when it needs to rebuild. The documentation looks complicated but the basic idea is that we're copy/pasting the major component of the soname into the ebuild. When it changes, the package manager knows to rebuild the things that depend on it.\n\nRebuilding whenever any header of any dependency changes is an OK way to fake it, but it's going to trigger unnecessary sagelib rebuilds frequently.",
    "created_at": "2020-05-19T12:34:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29474",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29474#issuecomment-418331",
    "user": "mjo"
}
```

What you really want to do here is rebuild sagelib whenever the public API of a dependency changes in a backwards-incompatible way. We devised "subslots" in Gentoo for the purpose of telling the package manager when it needs to rebuild. The documentation looks complicated but the basic idea is that we're copy/pasting the major component of the soname into the ebuild. When it changes, the package manager knows to rebuild the things that depend on it.

Rebuilding whenever any header of any dependency changes is an OK way to fake it, but it's going to trigger unnecessary sagelib rebuilds frequently.



---

archive/issue_comments_418332.json:
```json
{
    "body": "Replying to [comment:2 mjo]:\n> What you really want to do here is rebuild sagelib whenever the public API of a dependency changes in a backwards-incompatible way. We devised \"subslots\" in Gentoo for the purpose of telling the package manager when it needs to rebuild. The documentation looks complicated \n\n... indeed, from a quick look it seems there's a lot of Gentoo jargon there...\n\n> but the basic idea is that we're copy/pasting the major component of the soname into the ebuild. When it changes, the package manager knows to rebuild the things that depend on it.\n\nThanks for the pointer. It's probably a little bit more complicated for us because if I'm not mistaken, upstream packages are not always very careful with their sonames (which is then fixed in distributions)",
    "created_at": "2020-06-12T20:58:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29474",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29474#issuecomment-418332",
    "user": "mkoeppe"
}
```

Replying to [comment:2 mjo]:
> What you really want to do here is rebuild sagelib whenever the public API of a dependency changes in a backwards-incompatible way. We devised "subslots" in Gentoo for the purpose of telling the package manager when it needs to rebuild. The documentation looks complicated 

... indeed, from a quick look it seems there's a lot of Gentoo jargon there...

> but the basic idea is that we're copy/pasting the major component of the soname into the ebuild. When it changes, the package manager knows to rebuild the things that depend on it.

Thanks for the pointer. It's probably a little bit more complicated for us because if I'm not mistaken, upstream packages are not always very careful with their sonames (which is then fixed in distributions)



---

archive/issue_comments_418333.json:
```json
{
    "body": "The update of these paths, necessary because of the spkg-configure mechanism for GMP and NTL could use the environment variables set in `sage-build-env-config`.",
    "created_at": "2020-06-12T22:36:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29474",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29474#issuecomment-418333",
    "user": "mkoeppe"
}
```

The update of these paths, necessary because of the spkg-configure mechanism for GMP and NTL could use the environment variables set in `sage-build-env-config`.



---

archive/issue_comments_418334.json:
```json
{
    "body": "I'll do this in #29847.",
    "created_at": "2020-06-12T22:37:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29474",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29474#issuecomment-418334",
    "user": "mkoeppe"
}
```

I'll do this in #29847.



---

archive/issue_comments_418335.json:
```json
{
    "body": "Replying to [comment:6 mkoeppe]:\n> I'll do this in #29847.\n... or rather #29855.",
    "created_at": "2020-06-14T05:30:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29474",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29474#issuecomment-418335",
    "user": "mkoeppe"
}
```

Replying to [comment:6 mkoeppe]:
> I'll do this in #29847.
... or rather #29855.



---

archive/issue_comments_418336.json:
```json
{
    "body": "Replying to [comment:4 mkoeppe]:\n> \n> Thanks for the pointer. It's probably a little bit more complicated for us because if I'm not mistaken, upstream packages are not always very careful with their sonames (which is then fixed in distributions)\n> \n\nIn hindsight, it wouldn't really work for sage anyway. Since the (gentoo) developer makes up the subslot, he's able to change the subslot when the upstream API changes even if upstream doesn't change their soname. But rebuild-on-subslot-change only works for us because we know that all packages will be installed from the same repository. With sage, some packages may come from the system, and then you won't have access to that information. So rebuilding every time the headers change might be the best we can do.",
    "created_at": "2020-06-15T13:27:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29474",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29474#issuecomment-418336",
    "user": "mjo"
}
```

Replying to [comment:4 mkoeppe]:
> 
> Thanks for the pointer. It's probably a little bit more complicated for us because if I'm not mistaken, upstream packages are not always very careful with their sonames (which is then fixed in distributions)
> 

In hindsight, it wouldn't really work for sage anyway. Since the (gentoo) developer makes up the subslot, he's able to change the subslot when the upstream API changes even if upstream doesn't change their soname. But rebuild-on-subslot-change only works for us because we know that all packages will be installed from the same repository. With sage, some packages may come from the system, and then you won't have access to that information. So rebuilding every time the headers change might be the best we can do.



---

archive/issue_comments_418337.json:
```json
{
    "body": "See also #29791 comment 6",
    "created_at": "2020-06-15T14:27:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29474",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29474#issuecomment-418337",
    "user": "mkoeppe"
}
```

See also #29791 comment 6



---

archive/issue_comments_418338.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29474",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29474#issuecomment-418338",
    "user": "mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_418339.json:
```json
{
    "body": "every sufficiently complicated Python module project will reimplement bits of make and autotools, in Python....",
    "created_at": "2022-08-25T06:14:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29474",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29474#issuecomment-418339",
    "user": "dimpase"
}
```

every sufficiently complicated Python module project will reimplement bits of make and autotools, in Python....
