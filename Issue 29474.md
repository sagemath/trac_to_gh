# Issue 29474: sagelib setup.py: Dependencies on header files of packages

Issue created by migration from https://trac.sagemath.org/ticket/29711

Original creator: mkoeppe

Original creation time: 2020-05-19 01:23:55

CC:  dimpase charpent mjo @kliem slelievre

Rebuilds should be triggered when headers of relevant packages change.

In `setup.py` we have:

```
# Do not put all, but only the most common libraries and their headers
# (that are likely to change on an upgrade) here:
# [At least at the moment. Make sure the headers aren't copied with "-p",
# or explicitly touch them in the respective spkg's spkg-install.]
lib_headers = { "gmp":     [ os.path.join(SAGE_INC, 'gmp.h') ],   # cf. #8664, #9896
                "gmpxx":   [ os.path.join(SAGE_INC, 'gmpxx.h') ],
                "ntl":     [ os.path.join(SAGE_INC, 'NTL', 'config.h') ]
              }
```

Except for this (which is much too limited and also needs updating in light of the spkg-configure mechanism), we do not have dependency tracking for sagelib. Neither of distutils, setuptools, cython seem to have a mechanism for generating dependencies like gcc -M. This would be certainly be nice to have; in particular if it included dependencies on "system" headers and libraries, so that sagelib could automatically rebuild when system headers/libraries change (as in, most recently, â€‹https://groups.google.com/d/msg/sage-release/A53tGGsJNLg/uA01oUugAQAJ)..


---

Comment by mjo created at 2020-05-19 12:34:50

What you really want to do here is rebuild sagelib whenever the public API of a dependency changes in a backwards-incompatible way. We devised "subslots" in Gentoo for the purpose of telling the package manager when it needs to rebuild. The documentation looks complicated but the basic idea is that we're copy/pasting the major component of the soname into the ebuild. When it changes, the package manager knows to rebuild the things that depend on it.

Rebuilding whenever any header of any dependency changes is an OK way to fake it, but it's going to trigger unnecessary sagelib rebuilds frequently.


---

Comment by mkoeppe created at 2020-06-12 20:58:51

Replying to [comment:2 mjo]:
> What you really want to do here is rebuild sagelib whenever the public API of a dependency changes in a backwards-incompatible way. We devised "subslots" in Gentoo for the purpose of telling the package manager when it needs to rebuild. The documentation looks complicated 

... indeed, from a quick look it seems there's a lot of Gentoo jargon there...

> but the basic idea is that we're copy/pasting the major component of the soname into the ebuild. When it changes, the package manager knows to rebuild the things that depend on it.

Thanks for the pointer. It's probably a little bit more complicated for us because if I'm not mistaken, upstream packages are not always very careful with their sonames (which is then fixed in distributions)


---

Comment by mkoeppe created at 2020-06-12 22:36:05

The update of these paths, necessary because of the spkg-configure mechanism for GMP and NTL could use the environment variables set in `sage-build-env-config`.


---

Comment by mkoeppe created at 2020-06-12 22:37:00

I'll do this in #29847.


---

Comment by mkoeppe created at 2020-06-14 05:30:39

Replying to [comment:6 mkoeppe]:
> I'll do this in #29847.
... or rather #29855.


---

Comment by mjo created at 2020-06-15 13:27:06

Replying to [comment:4 mkoeppe]:
> 
> Thanks for the pointer. It's probably a little bit more complicated for us because if I'm not mistaken, upstream packages are not always very careful with their sonames (which is then fixed in distributions)
> 

In hindsight, it wouldn't really work for sage anyway. Since the (gentoo) developer makes up the subslot, he's able to change the subslot when the upstream API changes even if upstream doesn't change their soname. But rebuild-on-subslot-change only works for us because we know that all packages will be installed from the same repository. With sage, some packages may come from the system, and then you won't have access to that information. So rebuilding every time the headers change might be the best we can do.


---

Comment by mkoeppe created at 2020-06-15 14:27:01

See also #29791 comment 6


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by dimpase created at 2022-08-25 06:14:31

every sufficiently complicated Python module project will reimplement bits of make and autotools, in Python....
