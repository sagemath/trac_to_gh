# Issue 21219: revert #19612  -- don't mess with PYTHONUSERBASE at all.

Issue created by migration from https://trac.sagemath.org/ticket/21456

Original creator: was

Original creation time: 2016-09-08 23:49:06

CC:  mjo

I personally disagree with trying to make Sage's python and the general environment be as isolated as possibly from each other.  We should try to interoperate with the greater Python world as much as possible, not change things to discourage that.   If you want total isolation, use Docker, don't mess with environment variables like this...

I realize that this might just get closed due to philosophical differences.    How about just document PYTHONUSERBASE in our FAQ or something (like it is in python) and trust users to have a clue? 


---

Comment by jdemeyer created at 2016-09-09 09:18:26

Perhaps you should post to `sage-devel` about this ticket? The change is trivial to make (and I agree with it) but I think that other people should be able to give their opinion.


---

Comment by was created at 2016-09-09 15:38:10

Good idea -- done.

- https://groups.google.com/g/sage-devel/c/1-2NpaQYgog/m/CpcroholCgAJ


---

Comment by nbruin created at 2016-09-09 18:54:07

In order to see what the ramifications are: if I'm not mistaken, the main effect that `PYTHONUSERBASE` has is that if `$PYTHONUSERBASE/lib/python2.7/site-packages` exists, then it's added to `sys.path` and used for module lookup. Furthermore, if on a unix machine the variable `PYTHONUSERBASE` doesn't exist then the value `$HOME/.local` is used.

As you can see, python gets around the problems of the possibility of multiple incompatible python versions by including the version number in the path name. 

Clashes could occur if for a package `python setup.py install --user` is run, or `sage -python setup.py install --user`.

The problem is that the system python2.7 and sage's python2.7 are linked against significantly different libraries and hence are quite possibly incompatible: packages installed for one may not be able to run on the other.

Particularly, a user who wants to install a package (that is sensitive to some of the linking differences) in both the system python and the sage python would probably think that running both `install --user` commands would get the desired result. It does now. If we do not change `PYTHONUSERBASE` the user would need to learn about `PYTHONUSERBASE` and set it in sage to be able to use both.

(or have write permission on the sage install so that he/she doesn't have to include the `--user` option for the sage install, and hope that the system python will pick up its own version before the one reachable via `PYTHONUSERBASE`).

It would suggest to me that we shouldn't particularly be messing with the value of `PYTHONUSERBASE` but may want to build the sage python with version `python2.7.sage` to distinguish it from the system python. It could be that there are too many locations where that would lead to other problems, though.

Eventually it would be nice if sage could really just be installed as a python package in the system python, of course, but we're not there yet. If we could build the "sage specific" python with a separate version identifier it might help with the migration at some point.


---

Comment by embray created at 2016-09-22 14:10:29

Could someone clarify exactly what it is that Sage is doing with `$PYTHONUSERBASE`?  And is it something `sage` the library is doing, or something that `sage-env` is doing?


---

Comment by mkoeppe created at 2021-10-10 20:22:49

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-10-10 20:22:49

This comes up periodically as a wishlist item, most recently in https://groups.google.com/g/sage-devel/c/Cw8-COJg65E/m/Scd6PM7HBAAJ; but the rationale for disabling PYTHONUSERBASE still applies (https://groups.google.com/g/sage-devel/c/Cw8-COJg65E/m/Scd6PM7HBAAJ). 

Let's close this as wontfix; users should use user-defined venvs instead - see https://groups.google.com/g/sage-devel/c/Cw8-COJg65E/m/3HzKDFDOBAAJ


---

Comment by mjo created at 2021-11-20 22:21:01

Do we still need to poison `PYTHONUSERBASE` in `sage-env` at all, now that we're using a venv? I don't see a difference in `sys.path`. Removing it won't solve the real issue reported (the venv hides your user packages anyway), but we may be able to remove some cruft if the poisoning no longer helps. And doing so would allow user packages to be detected by `./configure` in #29665 after we've ensured that the versions/features are correct.

**Poisoned, system-site:**

`['', '/usr/lib/python39.zip', '/usr/lib/python3.9', '/usr/lib/python3.9/lib-dynload', '/home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages', '/usr/lib/python3.9/site-packages']`

**Unpoisoned, system-site:**

`['', '/usr/lib/python39.zip', '/usr/lib/python3.9', '/usr/lib/python3.9/lib-dynload', '/home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages', '/usr/lib/python3.9/site-packages']`

**Poisoned, no system-site:**

`['', '/usr/lib/python39.zip', '/usr/lib/python3.9', '/usr/lib/python3.9/lib-dynload', '/home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages']`

**Unpoisoned, no system-site:**

`['', '/usr/lib/python39.zip', '/usr/lib/python3.9', '/usr/lib/python3.9/lib-dynload', '/home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages']`


---

Comment by mkoeppe created at 2021-11-20 22:30:37

When `--without-system-python3` is in use, our `python3` is not a venv python; in this situation the user site-packages win over the packages installed by Sage.


---

Comment by mjo created at 2021-11-20 22:54:09

Changing status from needs_review to positive_review.


---

Comment by mjo created at 2021-11-20 22:54:09

Can it be time to force system python3 yet?

I guess we can close this then, in favor of eventually doing things the right way: insisting on system python3, dropping the `PYTHONUSERBASE` poisoning, and using `spkg-configure.m4` to determine whether or not the system/user packages are satisfactory.

As long as we have a python3 SPKG, there is still a good reason to have this around... so that it's possible to override broken user site packages with SPKG installs.


---

Comment by mkoeppe created at 2021-11-20 23:57:15

Resolution: invalid


---

Comment by mkoeppe created at 2021-11-21 00:01:14

Replying to [comment:8 mjo]:
> Can it be time to force system python3 yet?

I don't think so -- note python 3.10 is rolling out and we still don't support it...


---

Comment by mjo created at 2021-11-21 13:25:25

Replying to [comment:10 mkoeppe]:
> Replying to [comment:8 mjo]:
> > Can it be time to force system python3 yet?
> 
> I don't think so -- note python 3.10 is rolling out and we still don't support it...

This is only a problem on distros where python-3.10 is standard and it's difficult to install python-3.9 (nowhere).
