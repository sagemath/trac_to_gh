# Issue 22807: py3: use unicode in sageinspect

archive/issues_022807.json:
```json
{
    "body": "CC:  @jdemeyer @embray @vbraun @tscrim\n\npreparation to py3\n\n**One important change**: allows any doctest to pass if sage returns u'blabla' and the doctest requires 'blabla'\n\nIssue created by migration from https://trac.sagemath.org/ticket/23044\n\n",
    "created_at": "2017-05-21T15:48:40Z",
    "labels": [
        "component: python3"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "py3: use unicode in sageinspect",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22807",
    "user": "https://github.com/fchapoton"
}
```
CC:  @jdemeyer @embray @vbraun @tscrim

preparation to py3

**One important change**: allows any doctest to pass if sage returns u'blabla' and the doctest requires 'blabla'

Issue created by migration from https://trac.sagemath.org/ticket/23044





---

archive/issue_comments_318565.json:
```json
{
    "body": "let us wait for a bot's opinion\n----\nNew commits:",
    "created_at": "2017-05-21T15:52:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318565",
    "user": "https://github.com/fchapoton"
}
```

let us wait for a bot's opinion
----
New commits:



---

archive/issue_comments_318566.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-05-21T15:52:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318566",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_318567.json:
```json
{
    "body": "Changing keywords from \"\" to \"unicode\".",
    "created_at": "2017-05-21T16:19:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318567",
    "user": "https://github.com/fchapoton"
}
```

Changing keywords from "" to "unicode".



---

archive/issue_comments_318568.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-21T19:54:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318568",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_318569.json:
```json
{
    "body": "Some tests are failing on the patchbot. Some are trivial (in a way) and others not so much.",
    "created_at": "2017-05-22T01:29:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318569",
    "user": "https://github.com/tscrim"
}
```

Some tests are failing on the patchbot. Some are trivial (in a way) and others not so much.



---

archive/issue_comments_318570.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-05-22T06:36:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318570",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_318571.json:
```json
{
    "body": "yes, in particular the doc does not build.. needs to be investigated",
    "created_at": "2017-05-22T06:36:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318571",
    "user": "https://github.com/fchapoton"
}
```

yes, in particular the doc does not build.. needs to be investigated



---

archive/issue_comments_318572.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-22T19:19:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318572",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_318573.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-22T19:52:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318573",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_318574.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-23T07:08:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318574",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_318575.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-05-23T13:29:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318575",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_318576.json:
```json
{
    "body": "green bot, please review !",
    "created_at": "2017-05-23T13:29:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318576",
    "user": "https://github.com/fchapoton"
}
```

green bot, please review !



---

archive/issue_comments_318577.json:
```json
{
    "body": "1. From the patch:\n\n```\nBut this breaks on something like \"[u\"Singular's stuff\", u'good']\" !!!\n```\n\n\nYou may want to consider using [strip_string_literals](https://github.com/cython/cython/blob/master/Cython/Build/Dependencies.py#L277) for a more robust implementation.\n\n2. The `[u\"Singular's stuff\", u'good']` example should be a doctest (depending on your opinion on 1, either to show that it works or to show how it breaks).\n\n3. Revert this:\n\n```diff\ndiff --git a/src/sage/misc/six.py b/src/sage/misc/six.py\nindex 37295c7..eed7d9a 100644\n--- a/src/sage/misc/six.py\n+++ b/src/sage/misc/six.py\n@@ -5,7 +5,7 @@ Python 2 and 3 Compatibility\n \n from __future__ import absolute_import\n \n-from six import *\n+from six import text_type, binary_type\n \n \n def with_metaclass(meta, *bases):\n```\n\nThe `import *` is intentional: the idea is that `sage.misc.six` can replace the standard `six` module.\n\n4. Since the commits don't really make sense, I suggest to squash this to 1 commit.",
    "created_at": "2017-05-23T13:46:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318577",
    "user": "https://github.com/jdemeyer"
}
```

1. From the patch:

```
But this breaks on something like "[u"Singular's stuff", u'good']" !!!
```


You may want to consider using [strip_string_literals](https://github.com/cython/cython/blob/master/Cython/Build/Dependencies.py#L277) for a more robust implementation.

2. The `[u"Singular's stuff", u'good']` example should be a doctest (depending on your opinion on 1, either to show that it works or to show how it breaks).

3. Revert this:

```diff
diff --git a/src/sage/misc/six.py b/src/sage/misc/six.py
index 37295c7..eed7d9a 100644
--- a/src/sage/misc/six.py
+++ b/src/sage/misc/six.py
@@ -5,7 +5,7 @@ Python 2 and 3 Compatibility
 
 from __future__ import absolute_import
 
-from six import *
+from six import text_type, binary_type
 
 
 def with_metaclass(meta, *bases):
```

The `import *` is intentional: the idea is that `sage.misc.six` can replace the standard `six` module.

4. Since the commits don't really make sense, I suggest to squash this to 1 commit.



---

archive/issue_comments_318578.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-05-23T13:46:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318578",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_318579.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-05-23T13:56:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318579",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_318580.json:
```json
{
    "body": "Thanks for the suggestion to use `strip_string_literals`. But I do not understand how I could use it and what it does, given that is has no doctest.",
    "created_at": "2017-05-23T14:01:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318580",
    "user": "https://github.com/fchapoton"
}
```

Thanks for the suggestion to use `strip_string_literals`. But I do not understand how I could use it and what it does, given that is has no doctest.



---

archive/issue_comments_318581.json:
```json
{
    "body": "It's not clear to me what you mean with \"**internal** unicode u markers\" (if you stress the word `**internal**`, explain what it means).",
    "created_at": "2017-05-23T14:01:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318581",
    "user": "https://github.com/jdemeyer"
}
```

It's not clear to me what you mean with "**internal** unicode u markers" (if you stress the word `**internal**`, explain what it means).



---

archive/issue_comments_318582.json:
```json
{
    "body": "Well, the input is a string (typically the doc of a sage method) and some of the letters u that it contains are there to mark the presence of unicode strings inside. This is the meaning of internal. That the input string itself is unicode or not, we do not care.",
    "created_at": "2017-05-23T14:05:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318582",
    "user": "https://github.com/fchapoton"
}
```

Well, the input is a string (typically the doc of a sage method) and some of the letters u that it contains are there to mark the presence of unicode strings inside. This is the meaning of internal. That the input string itself is unicode or not, we do not care.



---

archive/issue_comments_318583.json:
```json
{
    "body": "Replying to [comment:15 chapoton]:\n> Well, the input is a string (typically the doc of a sage method) and some of the letters u that it contains are there to mark the presence of unicode strings inside. This is the meaning of internal. That the input string itself is unicode or not, we do not care.\n\nDon't explain on Trac, explain in the docstring.",
    "created_at": "2017-05-23T14:06:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318583",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:15 chapoton]:
> Well, the input is a string (typically the doc of a sage method) and some of the letters u that it contains are there to mark the presence of unicode strings inside. This is the meaning of internal. That the input string itself is unicode or not, we do not care.

Don't explain on Trac, explain in the docstring.



---

archive/issue_comments_318584.json:
```json
{
    "body": "Replying to [comment:15 chapoton]:\n> Well, the input is a string (typically the doc of a sage method) and some of the letters u that it contains are there to mark the presence of unicode strings inside. This is the meaning of internal. That the input string itself is unicode or not, we do not care.\n\nI think the word `**internal**` adds more confusion than it solves. I would remove it.",
    "created_at": "2017-05-23T14:07:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318584",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:15 chapoton]:
> Well, the input is a string (typically the doc of a sage method) and some of the letters u that it contains are there to mark the presence of unicode strings inside. This is the meaning of internal. That the input string itself is unicode or not, we do not care.

I think the word `**internal**` adds more confusion than it solves. I would remove it.



---

archive/issue_comments_318585.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-23T14:12:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318585",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_318586.json:
```json
{
    "body": "here is more doc for remove_unicode_u",
    "created_at": "2017-05-23T14:12:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318586",
    "user": "https://github.com/fchapoton"
}
```

here is more doc for remove_unicode_u



---

archive/issue_comments_318587.json:
```json
{
    "body": "I'm not totally convinced by the logic in the doctest framework. I think we should call `remove_unicode_u` on the output unconditionally. I know that this will break existing doctests, but those doctests would break anyway on Python 3. And it's better to fix it now that there are not so many doctests with `u''`.",
    "created_at": "2017-05-23T14:14:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318587",
    "user": "https://github.com/jdemeyer"
}
```

I'm not totally convinced by the logic in the doctest framework. I think we should call `remove_unicode_u` on the output unconditionally. I know that this will break existing doctests, but those doctests would break anyway on Python 3. And it's better to fix it now that there are not so many doctests with `u''`.



---

archive/issue_comments_318588.json:
```json
{
    "body": "\n```\nsage: remove_unicode_u(\"'\u20ac'\")\n---------------------------------------------------------------------------\nUnicodeDecodeError                        Traceback (most recent call last)\n<ipython-input-7-8e5f967a743e> in <module>()\n----> 1 remove_unicode_u(\"'\u20ac'\")\n\n/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/doctest/parsing.pyc in remove_unicode_u(string)\n    106             final.append(\"'\")\n    107         parity += 1\n--> 108     string1 = u''.join(final[:-1])\n    109 \n    110     # same for u\"\n\nUnicodeDecodeError: 'ascii' codec can't decode byte 0xe2 in position 1: ordinal not in range(128)\n```\n",
    "created_at": "2017-05-23T14:19:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318588",
    "user": "https://github.com/jdemeyer"
}
```


```
sage: remove_unicode_u("'€'")
---------------------------------------------------------------------------
UnicodeDecodeError                        Traceback (most recent call last)
<ipython-input-7-8e5f967a743e> in <module>()
----> 1 remove_unicode_u("'€'")

/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/doctest/parsing.pyc in remove_unicode_u(string)
    106             final.append("'")
    107         parity += 1
--> 108     string1 = u''.join(final[:-1])
    109 
    110     # same for u"

UnicodeDecodeError: 'ascii' codec can't decode byte 0xe2 in position 1: ordinal not in range(128)
```




---

archive/issue_comments_318589.json:
```json
{
    "body": "I was thinking to 2 things:\n\n1) do not spend more time in the doctests\n\n2) the failing doctests in python3 can be cared of somewhere else (how many are there ?)",
    "created_at": "2017-05-23T14:21:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318589",
    "user": "https://github.com/fchapoton"
}
```

I was thinking to 2 things:

1) do not spend more time in the doctests

2) the failing doctests in python3 can be cared of somewhere else (how many are there ?)



---

archive/issue_comments_318590.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-23T14:27:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318590",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_318591.json:
```json
{
    "body": "now works with bytes input (still return unicode)",
    "created_at": "2017-05-23T14:28:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318591",
    "user": "https://github.com/fchapoton"
}
```

now works with bytes input (still return unicode)



---

archive/issue_comments_318592.json:
```json
{
    "body": "* do you think there is a way to use `strip_string_literals` or do you instead suggest to get inspired by the code ?\n\n* I would prefer not to apply \"remove_unicode_u\" to all doctests, one reason is that it is not working perfectly, another is for speed, and another is to keep our current doctests with u for the moment.",
    "created_at": "2017-05-23T20:25:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318592",
    "user": "https://github.com/fchapoton"
}
```

* do you think there is a way to use `strip_string_literals` or do you instead suggest to get inspired by the code ?

* I would prefer not to apply "remove_unicode_u" to all doctests, one reason is that it is not working perfectly, another is for speed, and another is to keep our current doctests with u for the moment.



---

archive/issue_comments_318593.json:
```json
{
    "body": "Changing status from needs_work to needs_info.",
    "created_at": "2017-05-23T20:25:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318593",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_work to needs_info.



---

archive/issue_comments_318594.json:
```json
{
    "body": "I don't think the level of complexity in this is really necessary (making sure a closing quote is found, etc.).  Astropy's doctest checker just uses a [simple regex](https://github.com/astropy/astropy/blob/master/astropy/tests/output_checker.py#L43) which, given knowledge of Python syntax and typical `repr`s of Python objects, is almost always going to be a positive match.  It's true one can come up with examples where it would be a false positive but I don't think it's ever occurred in practice.\n\nThat said, Sage has a lot more doctests and a lot more odd cases, and you've already worked out a way to do this that's perhaps more robust so I wouldn't toss it out if it works.  I would just eliminate the code duplication, perhaps by making an inline function, like:\n\n\n```python\ndef strip_u_prefix(s, q):\n    prefix = 'u' + q\n    initial = s.split(prefix)\n    parity = 0\n    final = []\n    for part in initial:\n        parity += part.count(q)\n        final.append(part)\n        if parity % 2:\n            final.append(prefix)\n        else:\n            final.append(q)\n        parity += 1\n    return u''.join(final[:-1])\n\ns = strip_u_prefix(s, '\"')\nreturn strip_u_prefix(s, \"'\")\n```\n\n\nor something like that.",
    "created_at": "2017-05-24T08:03:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318594",
    "user": "https://github.com/embray"
}
```

I don't think the level of complexity in this is really necessary (making sure a closing quote is found, etc.).  Astropy's doctest checker just uses a [simple regex](https://github.com/astropy/astropy/blob/master/astropy/tests/output_checker.py#L43) which, given knowledge of Python syntax and typical `repr`s of Python objects, is almost always going to be a positive match.  It's true one can come up with examples where it would be a false positive but I don't think it's ever occurred in practice.

That said, Sage has a lot more doctests and a lot more odd cases, and you've already worked out a way to do this that's perhaps more robust so I wouldn't toss it out if it works.  I would just eliminate the code duplication, perhaps by making an inline function, like:


```python
def strip_u_prefix(s, q):
    prefix = 'u' + q
    initial = s.split(prefix)
    parity = 0
    final = []
    for part in initial:
        parity += part.count(q)
        final.append(part)
        if parity % 2:
            final.append(prefix)
        else:
            final.append(q)
        parity += 1
    return u''.join(final[:-1])

s = strip_u_prefix(s, '"')
return strip_u_prefix(s, "'")
```


or something like that.



---

archive/issue_comments_318595.json:
```json
{
    "body": "Replying to [comment:25 chapoton]:\n> * do you think there is a way to use `strip_string_literals` or do you instead suggest to get inspired by the code ?\n\nIt seems overcomplicated.\n\n> * I would prefer not to apply \"remove_unicode_u\" to all doctests, one reason is that it is not working perfectly, another is for speed, and another is to keep our current doctests with u for the moment.\n\nI'd be surprised if this really had any impact on speed in the grand scheme of things.  In a full test run it might add up to a few seconds.  But if you can demonstrate otherwise, a simple regexp as I suggested above might mitigate somewhat.\n\nI think it's simpler to apply this on all tests by default since it's very easy to forget otherwise, but there should probably be an option to disable it on a specific test in the rare case where it removes a false positive.",
    "created_at": "2017-05-24T08:07:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318595",
    "user": "https://github.com/embray"
}
```

Replying to [comment:25 chapoton]:
> * do you think there is a way to use `strip_string_literals` or do you instead suggest to get inspired by the code ?

It seems overcomplicated.

> * I would prefer not to apply "remove_unicode_u" to all doctests, one reason is that it is not working perfectly, another is for speed, and another is to keep our current doctests with u for the moment.

I'd be surprised if this really had any impact on speed in the grand scheme of things.  In a full test run it might add up to a few seconds.  But if you can demonstrate otherwise, a simple regexp as I suggested above might mitigate somewhat.

I think it's simpler to apply this on all tests by default since it's very easy to forget otherwise, but there should probably be an option to disable it on a specific test in the rare case where it removes a false positive.



---

archive/issue_comments_318596.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-24T11:20:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318596",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_318597.json:
```json
{
    "body": "Replying to [comment:27 embray]:\n> Replying to [comment:25 chapoton]:\n> > * do you think there is a way to use `strip_string_literals` or do you instead suggest to get inspired by the code ?\n> \n> It seems overcomplicated.\n\nI would argue the opposite: if you can re-use an existing function which does most of the work, things become *less* complicated.\n\nI must add that I haven't actually checked if `strip_string_literals` can be used. But if yes, that seems the way to go.",
    "created_at": "2017-05-24T11:33:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318597",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:27 embray]:
> Replying to [comment:25 chapoton]:
> > * do you think there is a way to use `strip_string_literals` or do you instead suggest to get inspired by the code ?
> 
> It seems overcomplicated.

I would argue the opposite: if you can re-use an existing function which does most of the work, things become *less* complicated.

I must add that I haven't actually checked if `strip_string_literals` can be used. But if yes, that seems the way to go.



---

archive/issue_comments_318598.json:
```json
{
    "body": "Replying to [comment:29 jdemeyer]:\n> Replying to [comment:27 embray]:\n> > Replying to [comment:25 chapoton]:\n> > > * do you think there is a way to use `strip_string_literals` or do you instead suggest to get inspired by the code ?\n> > \n> > It seems overcomplicated.\n> \n> I would argue the opposite: if you can re-use an existing function which does most of the work, things become *less* complicated.\n> \n> I must add that I haven't actually checked if `strip_string_literals` can be used. But if yes, that seems the way to go.\n\nNormally I would agree of course, but not in the case of an undocumented function, buried in Cython's internals, which I don't believe guarantee a stable API of any sort.  I don't think it's a good idea to rely on miscellaneous undocumented functions somewhere in another package that isn't all that related to what you're actually using it for (granted, at least in Cython's case, it is related to parsing Python).\n\nI think if, for this case, one wanted to reuse some existing machinery the stdlib's [ast](https://docs.python.org/2/library/ast.html#ast-helpers) module would be a better choice.  This can be used to parse output for Python literals and interpret them as needed (and if the output isn't a valid Python literal then we probably shouldn't try to interpret it as such).  But I still think that's overkill for this purpose, where in my experience as simple regexp has almost always worked.\n\nOn a final note, for something like checking doctest output you also want a lot more immediate control over the details, since there *are* bound to be corner cases eventually.",
    "created_at": "2017-05-24T11:49:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318598",
    "user": "https://github.com/embray"
}
```

Replying to [comment:29 jdemeyer]:
> Replying to [comment:27 embray]:
> > Replying to [comment:25 chapoton]:
> > > * do you think there is a way to use `strip_string_literals` or do you instead suggest to get inspired by the code ?
> > 
> > It seems overcomplicated.
> 
> I would argue the opposite: if you can re-use an existing function which does most of the work, things become *less* complicated.
> 
> I must add that I haven't actually checked if `strip_string_literals` can be used. But if yes, that seems the way to go.

Normally I would agree of course, but not in the case of an undocumented function, buried in Cython's internals, which I don't believe guarantee a stable API of any sort.  I don't think it's a good idea to rely on miscellaneous undocumented functions somewhere in another package that isn't all that related to what you're actually using it for (granted, at least in Cython's case, it is related to parsing Python).

I think if, for this case, one wanted to reuse some existing machinery the stdlib's [ast](https://docs.python.org/2/library/ast.html#ast-helpers) module would be a better choice.  This can be used to parse output for Python literals and interpret them as needed (and if the output isn't a valid Python literal then we probably shouldn't try to interpret it as such).  But I still think that's overkill for this purpose, where in my experience as simple regexp has almost always worked.

On a final note, for something like checking doctest output you also want a lot more immediate control over the details, since there *are* bound to be corner cases eventually.



---

archive/issue_comments_318599.json:
```json
{
    "body": "Replying to [comment:30 embray]:\n> Normally I would agree of course, but not in the case of an undocumented function, buried in Cython's internals, which I don't believe guarantee a stable API of any sort.\n\nWhile there is no *guarantee*, we can rely on it as long as Cython provides that function. For the record: that function has existed for almost 7 years with the current functionality. In the case that Cython moves/deletes/changes that function, we can always adapt Sage. In the worst case, we just copy that function to the Sage sources.\n\nI disagree with `ast` since that's almost certainly going to be a lot slower. I believe that `strip_string_literals()` is the right tool for the job.\n\n> On a final note, for something like checking doctest output you also want a lot more immediate control over the details, since there are bound to be corner cases eventually. \n\nI have no idea what you mean with this.",
    "created_at": "2017-05-24T12:36:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318599",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:30 embray]:
> Normally I would agree of course, but not in the case of an undocumented function, buried in Cython's internals, which I don't believe guarantee a stable API of any sort.

While there is no *guarantee*, we can rely on it as long as Cython provides that function. For the record: that function has existed for almost 7 years with the current functionality. In the case that Cython moves/deletes/changes that function, we can always adapt Sage. In the worst case, we just copy that function to the Sage sources.

I disagree with `ast` since that's almost certainly going to be a lot slower. I believe that `strip_string_literals()` is the right tool for the job.

> On a final note, for something like checking doctest output you also want a lot more immediate control over the details, since there are bound to be corner cases eventually. 

I have no idea what you mean with this.



---

archive/issue_comments_318600.json:
```json
{
    "body": "In my last commit, I'm using `strip_string_literals()` to simplify and correct `remove_unicode_u()`. I just wanted to show how simple the function becomes; if you still feel that this isn't the right solution, feel free to remove that commit.\n----\nNew commits:",
    "created_at": "2017-05-24T12:54:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318600",
    "user": "https://github.com/jdemeyer"
}
```

In my last commit, I'm using `strip_string_literals()` to simplify and correct `remove_unicode_u()`. I just wanted to show how simple the function becomes; if you still feel that this isn't the right solution, feel free to remove that commit.
----
New commits:



---

archive/issue_comments_318601.json:
```json
{
    "body": "Replying to [comment:31 jdemeyer]:\n> Replying to [comment:30 embray]:\n> > On a final note, for something like checking doctest output you also want a lot more immediate control over the details, since there are bound to be corner cases eventually. \n> \n> I have no idea what you mean with this.\n\nWhat I mean is that when you have some code that parses output from doctests, one can sometimes stumble upon corner cases where it doesn't work properly for a test you're working on. So it's convenient to be able to easily tweak the code in the rare instances that that occurs.  Of course it is usually rare, but I write from experience on this.\n\nI disagree with everything else--I don't think it's wise to be cherry-picking random code from other Python packages that are not designed as libraries to be used by third-parties.  But it's ultimately up to Fr\u00e9d\u00e9ric if he's doing the work.",
    "created_at": "2017-05-24T13:39:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318601",
    "user": "https://github.com/embray"
}
```

Replying to [comment:31 jdemeyer]:
> Replying to [comment:30 embray]:
> > On a final note, for something like checking doctest output you also want a lot more immediate control over the details, since there are bound to be corner cases eventually. 
> 
> I have no idea what you mean with this.

What I mean is that when you have some code that parses output from doctests, one can sometimes stumble upon corner cases where it doesn't work properly for a test you're working on. So it's convenient to be able to easily tweak the code in the rare instances that that occurs.  Of course it is usually rare, but I write from experience on this.

I disagree with everything else--I don't think it's wise to be cherry-picking random code from other Python packages that are not designed as libraries to be used by third-parties.  But it's ultimately up to Frédéric if he's doing the work.



---

archive/issue_comments_318602.json:
```json
{
    "body": "\n```\n+    from Cython.Build.Dependencies import strip_string_literals\n```\n\n\nI don't see why the in-line import is used here.  This generally shouldn't be done unless there's a good reason.",
    "created_at": "2017-05-24T13:40:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318602",
    "user": "https://github.com/embray"
}
```


```
+    from Cython.Build.Dependencies import strip_string_literals
```


I don't see why the in-line import is used here.  This generally shouldn't be done unless there's a good reason.



---

archive/issue_comments_318603.json:
```json
{
    "body": "Indeed, it sound like a good solution to use \"strip_string_literals\". Thanks to Jeroen for showing how to do that. I am not very worried about using an arcane function found somewhere inside cython.\n\nGiven the large quantity of failing doctests triggered by the general application of the replacement rule (see patchbot report), I would very much prefer if we postpone this general application to a later ticket. I think that this should probably be coordinated with a fully unicode-aware doctest framework (#14153).",
    "created_at": "2017-05-24T14:50:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318603",
    "user": "https://github.com/fchapoton"
}
```

Indeed, it sound like a good solution to use "strip_string_literals". Thanks to Jeroen for showing how to do that. I am not very worried about using an arcane function found somewhere inside cython.

Given the large quantity of failing doctests triggered by the general application of the replacement rule (see patchbot report), I would very much prefer if we postpone this general application to a later ticket. I think that this should probably be coordinated with a fully unicode-aware doctest framework (#14153).



---

archive/issue_comments_318604.json:
```json
{
    "body": "Here is a branch, on top of Jeroen's branch, that does not try the systematic replacement. I propose to do that later in another ticket, because there are some  issues in relation with our unicode-unfriendly doc-framework.\n----\nNew commits:",
    "created_at": "2017-05-25T09:17:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318604",
    "user": "https://github.com/fchapoton"
}
```

Here is a branch, on top of Jeroen's branch, that does not try the systematic replacement. I propose to do that later in another ticket, because there are some  issues in relation with our unicode-unfriendly doc-framework.
----
New commits:



---

archive/issue_comments_318605.json:
```json
{
    "body": "Replying to [comment:35 embray]:\n> {{{\n> +    from Cython.Build.Dependencies import strip_string_literals\n> }}}\n> \n> I don't see why the in-line import is used here.  This generally shouldn't be done unless there's a good reason.\n\nSorry, I do not understand what this means. Should I put this import at the beginning of the file instead ?",
    "created_at": "2017-05-27T18:49:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318605",
    "user": "https://github.com/fchapoton"
}
```

Replying to [comment:35 embray]:
> {{{
> +    from Cython.Build.Dependencies import strip_string_literals
> }}}
> 
> I don't see why the in-line import is used here.  This generally shouldn't be done unless there's a good reason.

Sorry, I do not understand what this means. Should I put this import at the beginning of the file instead ?



---

archive/issue_comments_318606.json:
```json
{
    "body": "Do you think that I should split off the \"trivial\" parts of this ticket ?",
    "created_at": "2017-05-30T12:10:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318606",
    "user": "https://github.com/fchapoton"
}
```

Do you think that I should split off the "trivial" parts of this ticket ?



---

archive/issue_comments_318607.json:
```json
{
    "body": "Replying to [comment:38 chapoton]:\n> Replying to [comment:35 embray]:\n> > {{{\n> > +    from Cython.Build.Dependencies import strip_string_literals\n> > }}}\n> > \n> > I don't see why the in-line import is used here.  This generally shouldn't be done unless there's a good reason.\n> \n> Sorry, I do not understand what this means. Should I put this import at the beginning of the file instead ?\n\nYes, the only reason to put an import inside a function definition is in special cases, such as where use of that function will be rare and a possibly expensive import should be avoided if not needed, or where it's needed to avoid a circular import or something like that.",
    "created_at": "2017-05-30T12:27:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318607",
    "user": "https://github.com/embray"
}
```

Replying to [comment:38 chapoton]:
> Replying to [comment:35 embray]:
> > {{{
> > +    from Cython.Build.Dependencies import strip_string_literals
> > }}}
> > 
> > I don't see why the in-line import is used here.  This generally shouldn't be done unless there's a good reason.
> 
> Sorry, I do not understand what this means. Should I put this import at the beginning of the file instead ?

Yes, the only reason to put an import inside a function definition is in special cases, such as where use of that function will be rare and a possibly expensive import should be avoided if not needed, or where it's needed to avoid a circular import or something like that.



---

archive/issue_comments_318608.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-31T11:46:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318608",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_318609.json:
```json
{
    "body": "Green bot.\n\nDoes anybody strongly object if we postpone the switch to (always preparse by remove_unicode_u) to another ticket ?",
    "created_at": "2017-05-31T19:28:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318609",
    "user": "https://github.com/fchapoton"
}
```

Green bot.

Does anybody strongly object if we postpone the switch to (always preparse by remove_unicode_u) to another ticket ?



---

archive/issue_comments_318610.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2017-05-31T19:28:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318610",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_318611.json:
```json
{
    "body": "ping ?",
    "created_at": "2017-06-05T08:40:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318611",
    "user": "https://github.com/fchapoton"
}
```

ping ?



---

archive/issue_comments_318612.json:
```json
{
    "body": "No objection from me.",
    "created_at": "2017-06-05T09:10:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318612",
    "user": "https://github.com/tscrim"
}
```

No objection from me.



---

archive/issue_comments_318613.json:
```json
{
    "body": "Would it be possible to do in this ticket just the minimal changes which are needed to support the \"u\" prefix in doctests? Because this ticket does that plus various unrelated fixes. I always find it hard to review tickets which combine new features with unrelated cleanup.",
    "created_at": "2017-06-06T09:23:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318613",
    "user": "https://github.com/jdemeyer"
}
```

Would it be possible to do in this ticket just the minimal changes which are needed to support the "u" prefix in doctests? Because this ticket does that plus various unrelated fixes. I always find it hard to review tickets which combine new features with unrelated cleanup.



---

archive/issue_comments_318614.json:
```json
{
    "body": "I agree. I will try to do the split, but this is not in my git confidence area..",
    "created_at": "2017-06-06T09:26:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318614",
    "user": "https://github.com/fchapoton"
}
```

I agree. I will try to do the split, but this is not in my git confidence area..



---

archive/issue_comments_318615.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-06-06T09:47:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318615",
    "user": "https://github.com/fchapoton"
}
```

New commits:



---

archive/issue_comments_318616.json:
```json
{
    "body": "Done. Other changes are split off as #23147",
    "created_at": "2017-06-06T09:57:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318616",
    "user": "https://github.com/fchapoton"
}
```

Done. Other changes are split off as #23147



---

archive/issue_comments_318617.json:
```json
{
    "body": "EDIT: wrong ticket, sorry",
    "created_at": "2017-06-06T09:58:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318617",
    "user": "https://github.com/fchapoton"
}
```

EDIT: wrong ticket, sorry



---

archive/issue_comments_318618.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-06-06T09:58:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318618",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_318619.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-06-06T10:03:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318619",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_318620.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-06-07T07:43:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318620",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_318621.json:
```json
{
    "body": "Thanks!",
    "created_at": "2017-06-07T07:43:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318621",
    "user": "https://github.com/jdemeyer"
}
```

Thanks!



---

archive/issue_comments_318622.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-06-09T18:37:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22807#issuecomment-318622",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
