# Issue 22807: py3: use unicode in sageinspect

Issue created by migration from https://trac.sagemath.org/ticket/23044

Original creator: chapoton

Original creation time: 2017-05-21 15:48:40

CC:  jdemeyer embray vbraun tscrim

preparation to py3

**One important change**: allows any doctest to pass if sage returns u'blabla' and the doctest requires 'blabla'


---

Comment by chapoton created at 2017-05-21 15:52:12

let us wait for a bot's opinion
----
New commits:


---

Comment by chapoton created at 2017-05-21 15:52:12

Changing status from new to needs_review.


---

Comment by chapoton created at 2017-05-21 16:19:29

Changing keywords from "" to "unicode".


---

Comment by git created at 2017-05-21 19:54:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-05-22 01:29:36

Some tests are failing on the patchbot. Some are trivial (in a way) and others not so much.


---

Comment by chapoton created at 2017-05-22 06:36:42

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2017-05-22 06:36:42

yes, in particular the doc does not build.. needs to be investigated


---

Comment by git created at 2017-05-22 19:19:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-05-22 19:52:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-05-23 07:08:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-05-23 13:29:23

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2017-05-23 13:29:23

green bot, please review !


---

Comment by jdemeyer created at 2017-05-23 13:46:59

1. From the patch:

```
But this breaks on something like "[u"Singular's stuff", u'good']" !!!
```


You may want to consider using [strip_string_literals](https://github.com/cython/cython/blob/master/Cython/Build/Dependencies.py#L277) for a more robust implementation.

2. The `[u"Singular's stuff", u'good']` example should be a doctest (depending on your opinion on 1, either to show that it works or to show how it breaks).

3. Revert this:

```diff
diff --git a/src/sage/misc/six.py b/src/sage/misc/six.py
index 37295c7..eed7d9a 100644
--- a/src/sage/misc/six.py
+++ b/src/sage/misc/six.py
@@ -5,7 +5,7 @@ Python 2 and 3 Compatibility
 
 from __future__ import absolute_import
 
-from six import *
+from six import text_type, binary_type
 
 
 def with_metaclass(meta, *bases):
```

The `import *` is intentional: the idea is that `sage.misc.six` can replace the standard `six` module.

4. Since the commits don't really make sense, I suggest to squash this to 1 commit.


---

Comment by jdemeyer created at 2017-05-23 13:46:59

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-05-23 13:56:36

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2017-05-23 14:01:15

Thanks for the suggestion to use `strip_string_literals`. But I do not understand how I could use it and what it does, given that is has no doctest.


---

Comment by jdemeyer created at 2017-05-23 14:01:28

It's not clear to me what you mean with "**internal** unicode u markers" (if you stress the word `**internal**`, explain what it means).


---

Comment by chapoton created at 2017-05-23 14:05:32

Well, the input is a string (typically the doc of a sage method) and some of the letters u that it contains are there to mark the presence of unicode strings inside. This is the meaning of internal. That the input string itself is unicode or not, we do not care.


---

Comment by jdemeyer created at 2017-05-23 14:06:38

Replying to [comment:15 chapoton]:
> Well, the input is a string (typically the doc of a sage method) and some of the letters u that it contains are there to mark the presence of unicode strings inside. This is the meaning of internal. That the input string itself is unicode or not, we do not care.

Don't explain on Trac, explain in the docstring.


---

Comment by jdemeyer created at 2017-05-23 14:07:17

Replying to [comment:15 chapoton]:
> Well, the input is a string (typically the doc of a sage method) and some of the letters u that it contains are there to mark the presence of unicode strings inside. This is the meaning of internal. That the input string itself is unicode or not, we do not care.

I think the word `**internal**` adds more confusion than it solves. I would remove it.


---

Comment by git created at 2017-05-23 14:12:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-05-23 14:12:55

here is more doc for remove_unicode_u


---

Comment by jdemeyer created at 2017-05-23 14:14:42

I'm not totally convinced by the logic in the doctest framework. I think we should call `remove_unicode_u` on the output unconditionally. I know that this will break existing doctests, but those doctests would break anyway on Python 3. And it's better to fix it now that there are not so many doctests with `u''`.


---

Comment by jdemeyer created at 2017-05-23 14:19:32


```
sage: remove_unicode_u("'€'")
---------------------------------------------------------------------------
UnicodeDecodeError                        Traceback (most recent call last)
<ipython-input-7-8e5f967a743e> in <module>()
----> 1 remove_unicode_u("'€'")

/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/doctest/parsing.pyc in remove_unicode_u(string)
    106             final.append("'")
    107         parity += 1
--> 108     string1 = u''.join(final[:-1])
    109 
    110     # same for u"

UnicodeDecodeError: 'ascii' codec can't decode byte 0xe2 in position 1: ordinal not in range(128)
```



---

Comment by chapoton created at 2017-05-23 14:21:25

I was thinking to 2 things:

1) do not spend more time in the doctests

2) the failing doctests in python3 can be cared of somewhere else (how many are there ?)


---

Comment by git created at 2017-05-23 14:27:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-05-23 14:28:48

now works with bytes input (still return unicode)


---

Comment by chapoton created at 2017-05-23 20:25:15

* do you think there is a way to use `strip_string_literals` or do you instead suggest to get inspired by the code ?

* I would prefer not to apply "remove_unicode_u" to all doctests, one reason is that it is not working perfectly, another is for speed, and another is to keep our current doctests with u for the moment.


---

Comment by chapoton created at 2017-05-23 20:25:15

Changing status from needs_work to needs_info.


---

Comment by embray created at 2017-05-24 08:03:47

I don't think the level of complexity in this is really necessary (making sure a closing quote is found, etc.).  Astropy's doctest checker just uses a [simple regex](https://github.com/astropy/astropy/blob/master/astropy/tests/output_checker.py#L43) which, given knowledge of Python syntax and typical `repr`s of Python objects, is almost always going to be a positive match.  It's true one can come up with examples where it would be a false positive but I don't think it's ever occurred in practice.

That said, Sage has a lot more doctests and a lot more odd cases, and you've already worked out a way to do this that's perhaps more robust so I wouldn't toss it out if it works.  I would just eliminate the code duplication, perhaps by making an inline function, like:


```python
def strip_u_prefix(s, q):
    prefix = 'u' + q
    initial = s.split(prefix)
    parity = 0
    final = []
    for part in initial:
        parity += part.count(q)
        final.append(part)
        if parity % 2:
            final.append(prefix)
        else:
            final.append(q)
        parity += 1
    return u''.join(final[:-1])

s = strip_u_prefix(s, '"')
return strip_u_prefix(s, "'")
```


or something like that.


---

Comment by embray created at 2017-05-24 08:07:28

Replying to [comment:25 chapoton]:
> * do you think there is a way to use `strip_string_literals` or do you instead suggest to get inspired by the code ?

It seems overcomplicated.

> * I would prefer not to apply "remove_unicode_u" to all doctests, one reason is that it is not working perfectly, another is for speed, and another is to keep our current doctests with u for the moment.

I'd be surprised if this really had any impact on speed in the grand scheme of things.  In a full test run it might add up to a few seconds.  But if you can demonstrate otherwise, a simple regexp as I suggested above might mitigate somewhat.

I think it's simpler to apply this on all tests by default since it's very easy to forget otherwise, but there should probably be an option to disable it on a specific test in the rare case where it removes a false positive.


---

Comment by git created at 2017-05-24 11:20:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-05-24 11:33:19

Replying to [comment:27 embray]:
> Replying to [comment:25 chapoton]:
> > * do you think there is a way to use `strip_string_literals` or do you instead suggest to get inspired by the code ?
> 
> It seems overcomplicated.

I would argue the opposite: if you can re-use an existing function which does most of the work, things become _less_ complicated.

I must add that I haven't actually checked if `strip_string_literals` can be used. But if yes, that seems the way to go.


---

Comment by embray created at 2017-05-24 11:49:37

Replying to [comment:29 jdemeyer]:
> Replying to [comment:27 embray]:
> > Replying to [comment:25 chapoton]:
> > > * do you think there is a way to use `strip_string_literals` or do you instead suggest to get inspired by the code ?
> > 
> > It seems overcomplicated.
> 
> I would argue the opposite: if you can re-use an existing function which does most of the work, things become _less_ complicated.
> 
> I must add that I haven't actually checked if `strip_string_literals` can be used. But if yes, that seems the way to go.

Normally I would agree of course, but not in the case of an undocumented function, buried in Cython's internals, which I don't believe guarantee a stable API of any sort.  I don't think it's a good idea to rely on miscellaneous undocumented functions somewhere in another package that isn't all that related to what you're actually using it for (granted, at least in Cython's case, it is related to parsing Python).

I think if, for this case, one wanted to reuse some existing machinery the stdlib's [ast](https://docs.python.org/2/library/ast.html#ast-helpers) module would be a better choice.  This can be used to parse output for Python literals and interpret them as needed (and if the output isn't a valid Python literal then we probably shouldn't try to interpret it as such).  But I still think that's overkill for this purpose, where in my experience as simple regexp has almost always worked.

On a final note, for something like checking doctest output you also want a lot more immediate control over the details, since there _are_ bound to be corner cases eventually.


---

Comment by jdemeyer created at 2017-05-24 12:36:00

Replying to [comment:30 embray]:
> Normally I would agree of course, but not in the case of an undocumented function, buried in Cython's internals, which I don't believe guarantee a stable API of any sort.

While there is no _guarantee_, we can rely on it as long as Cython provides that function. For the record: that function has existed for almost 7 years with the current functionality. In the case that Cython moves/deletes/changes that function, we can always adapt Sage. In the worst case, we just copy that function to the Sage sources.

I disagree with `ast` since that's almost certainly going to be a lot slower. I believe that `strip_string_literals()` is the right tool for the job.

> On a final note, for something like checking doctest output you also want a lot more immediate control over the details, since there are bound to be corner cases eventually. 

I have no idea what you mean with this.


---

Comment by jdemeyer created at 2017-05-24 12:54:21

In my last commit, I'm using `strip_string_literals()` to simplify and correct `remove_unicode_u()`. I just wanted to show how simple the function becomes; if you still feel that this isn't the right solution, feel free to remove that commit.
----
New commits:


---

Comment by embray created at 2017-05-24 13:39:10

Replying to [comment:31 jdemeyer]:
> Replying to [comment:30 embray]:
> > On a final note, for something like checking doctest output you also want a lot more immediate control over the details, since there are bound to be corner cases eventually. 
> 
> I have no idea what you mean with this.

What I mean is that when you have some code that parses output from doctests, one can sometimes stumble upon corner cases where it doesn't work properly for a test you're working on. So it's convenient to be able to easily tweak the code in the rare instances that that occurs.  Of course it is usually rare, but I write from experience on this.

I disagree with everything else--I don't think it's wise to be cherry-picking random code from other Python packages that are not designed as libraries to be used by third-parties.  But it's ultimately up to Frédéric if he's doing the work.


---

Comment by embray created at 2017-05-24 13:40:20


```
+    from Cython.Build.Dependencies import strip_string_literals
```


I don't see why the in-line import is used here.  This generally shouldn't be done unless there's a good reason.


---

Comment by chapoton created at 2017-05-24 14:50:08

Indeed, it sound like a good solution to use "strip_string_literals". Thanks to Jeroen for showing how to do that. I am not very worried about using an arcane function found somewhere inside cython.

Given the large quantity of failing doctests triggered by the general application of the replacement rule (see patchbot report), I would very much prefer if we postpone this general application to a later ticket. I think that this should probably be coordinated with a fully unicode-aware doctest framework (#14153).


---

Comment by chapoton created at 2017-05-25 09:17:50

Here is a branch, on top of Jeroen's branch, that does not try the systematic replacement. I propose to do that later in another ticket, because there are some  issues in relation with our unicode-unfriendly doc-framework.
----
New commits:


---

Comment by chapoton created at 2017-05-27 18:49:52

Replying to [comment:35 embray]:
> {{{
> +    from Cython.Build.Dependencies import strip_string_literals
> }}}
> 
> I don't see why the in-line import is used here.  This generally shouldn't be done unless there's a good reason.

Sorry, I do not understand what this means. Should I put this import at the beginning of the file instead ?


---

Comment by chapoton created at 2017-05-30 12:10:08

Do you think that I should split off the "trivial" parts of this ticket ?


---

Comment by embray created at 2017-05-30 12:27:55

Replying to [comment:38 chapoton]:
> Replying to [comment:35 embray]:
> > {{{
> > +    from Cython.Build.Dependencies import strip_string_literals
> > }}}
> > 
> > I don't see why the in-line import is used here.  This generally shouldn't be done unless there's a good reason.
> 
> Sorry, I do not understand what this means. Should I put this import at the beginning of the file instead ?

Yes, the only reason to put an import inside a function definition is in special cases, such as where use of that function will be rare and a possibly expensive import should be avoided if not needed, or where it's needed to avoid a circular import or something like that.


---

Comment by git created at 2017-05-31 11:46:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-05-31 19:28:03

Green bot.

Does anybody strongly object if we postpone the switch to (always preparse by remove_unicode_u) to another ticket ?


---

Comment by chapoton created at 2017-05-31 19:28:03

Changing status from needs_info to needs_review.


---

Comment by chapoton created at 2017-06-05 08:40:49

ping ?


---

Comment by tscrim created at 2017-06-05 09:10:07

No objection from me.


---

Comment by jdemeyer created at 2017-06-06 09:23:55

Would it be possible to do in this ticket just the minimal changes which are needed to support the "u" prefix in doctests? Because this ticket does that plus various unrelated fixes. I always find it hard to review tickets which combine new features with unrelated cleanup.


---

Comment by chapoton created at 2017-06-06 09:26:05

I agree. I will try to do the split, but this is not in my git confidence area..


---

Comment by chapoton created at 2017-06-06 09:47:55

New commits:


---

Comment by chapoton created at 2017-06-06 09:57:08

Done. Other changes are split off as #23147


---

Comment by chapoton created at 2017-06-06 09:58:21

EDIT: wrong ticket, sorry


---

Comment by chapoton created at 2017-06-06 09:58:21

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2017-06-06 10:03:01

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-06-07 07:43:59

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2017-06-07 07:43:59

Thanks!


---

Comment by vbraun created at 2017-06-09 18:37:54

Resolution: fixed
