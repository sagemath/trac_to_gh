# Issue 15270: Static sparse graphs on > 65536 vertices

archive/issues_015270.json:
```json
{
    "body": "CC:  simonking @dcoudert stumpc5\n\nOn Sage-devel [1], Christian reported an humiliating error message :\n\n\n\nThis is because Sage's \"static_sparse_graphs\" are stored on `unsigned short` fields (and thus to 65536 vertices), and though this is a meaningful limitation for Sage's code to compute the \"all pairs shortest path\" (the distance between all pairs of vertices, i.e. a n^2 matrix of integers), it does not make any sense to refuse to compute the diameter of such graphs.\n\nSoooooooooo this patch changes these \"unsigned short\" to good old integers (which are not unsigned because it makes the code clearer and does not change much), which is also good to have when Simon is about to use the same data structure for combinatorial graphs, which can be huge.\n\nI have to mention that this does not make \"diameter\" answer very fast either on instances with more than 65536 vertices `:-/`\n\nBut at least we can build them `T_T`\n\nWhat this patch does:\n* change the type of the static_sparse_graph data structure from ushort to int, as well as the functions that use it\n* change the `all_pairs_shortest_path_BFS` function to first compute the distance on a `int *` array of length `n`. The values are then copied into the `n^2` matrix of `ushort` if necessary. That's a loss of time, but it's either this or rewriting two versions of the function `:-/`\n* remove a useless `degree` variable in the same function\n* Some simplifications from place to place in the code\n\nNathann\n\n[1] https://groups.google.com/d/msg/sage-devel/2AI1CNdDm6w/jHKh26pMzqcJ\n\nIssue created by migration from https://trac.sagemath.org/ticket/15507\n\n",
    "created_at": "2013-12-10T13:38:43Z",
    "labels": [
        "component: graph theory"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.1",
    "title": "Static sparse graphs on > 65536 vertices",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15270",
    "user": "https://github.com/nathanncohen"
}
```
CC:  simonking @dcoudert stumpc5

On Sage-devel [1], Christian reported an humiliating error message :



This is because Sage's "static_sparse_graphs" are stored on `unsigned short` fields (and thus to 65536 vertices), and though this is a meaningful limitation for Sage's code to compute the "all pairs shortest path" (the distance between all pairs of vertices, i.e. a n^2 matrix of integers), it does not make any sense to refuse to compute the diameter of such graphs.

Soooooooooo this patch changes these "unsigned short" to good old integers (which are not unsigned because it makes the code clearer and does not change much), which is also good to have when Simon is about to use the same data structure for combinatorial graphs, which can be huge.

I have to mention that this does not make "diameter" answer very fast either on instances with more than 65536 vertices `:-/`

But at least we can build them `T_T`

What this patch does:
* change the type of the static_sparse_graph data structure from ushort to int, as well as the functions that use it
* change the `all_pairs_shortest_path_BFS` function to first compute the distance on a `int *` array of length `n`. The values are then copied into the `n^2` matrix of `ushort` if necessary. That's a loss of time, but it's either this or rewriting two versions of the function `:-/`
* remove a useless `degree` variable in the same function
* Some simplifications from place to place in the code

Nathann

[1] https://groups.google.com/d/msg/sage-devel/2AI1CNdDm6w/jHKh26pMzqcJ

Issue created by migration from https://trac.sagemath.org/ticket/15507





---

archive/issue_comments_196070.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-12-10T13:42:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15270#issuecomment-196070",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_196071.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2013-12-10T14:13:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15270#issuecomment-196071",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_196072.json:
```json
{
    "body": "Thanks for working on that - how do I find your branch, it doesn't seem to be valid, and I just fetched and do not see any branch containing \"15507\".\n\nCheers, C.",
    "created_at": "2013-12-10T14:14:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15270#issuecomment-196072",
    "user": "https://trac.sagemath.org/admin/accounts/users/stumpc5"
}
```

Thanks for working on that - how do I find your branch, it doesn't seem to be valid, and I just fetched and do not see any branch containing "15507".

Cheers, C.



---

archive/issue_comments_196073.json:
```json
{
    "body": "Ah, there it is...\n\nI still don't feel super comfortable, it more feels like git is using me rather than how it should be. E.g., in #15228 I don't know how to kick the patchbot. I also do not know how to get rid of branches I checked out once. Anyway, I will look at your changes now.\n\nBest, C.",
    "created_at": "2013-12-10T14:17:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15270#issuecomment-196073",
    "user": "https://trac.sagemath.org/admin/accounts/users/stumpc5"
}
```

Ah, there it is...

I still don't feel super comfortable, it more feels like git is using me rather than how it should be. E.g., in #15228 I don't know how to kick the patchbot. I also do not know how to get rid of branches I checked out once. Anyway, I will look at your changes now.

Best, C.



---

archive/issue_comments_196074.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2013-12-10T14:21:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15270#issuecomment-196074",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_196075.json:
```json
{
    "body": "(sorry, I updated the branch since, as there were two broken doctests left. Some integers were printed as 1L instead of 1 `T_T`)\n\nNathann",
    "created_at": "2013-12-10T14:23:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15270#issuecomment-196075",
    "user": "https://github.com/nathanncohen"
}
```

(sorry, I updated the branch since, as there were two broken doctests left. Some integers were printed as 1L instead of 1 `T_T`)

Nathann



---

archive/issue_comments_196076.json:
```json
{
    "body": "Out of curiosity: why do you now use `public/ticketnumber` after using `u/ncohen/ticketnumber` before?\n\nI cannot judge if you created any problems anywhere in the code, but I guess you know what you are doing...\n\nI just ran the doctest on all of graphs, and the only error I see is `AttributeError in doctesting framework` which is also there without having your changes applied.\n\nI didn't see any new doctest for the code testing the diameter for something bigger, line the line graph of 70000 vertices. Don't you think it would be nice to have such an example in the code?\n\nCheers, Christian",
    "created_at": "2013-12-10T14:36:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15270#issuecomment-196076",
    "user": "https://trac.sagemath.org/admin/accounts/users/stumpc5"
}
```

Out of curiosity: why do you now use `public/ticketnumber` after using `u/ncohen/ticketnumber` before?

I cannot judge if you created any problems anywhere in the code, but I guess you know what you are doing...

I just ran the doctest on all of graphs, and the only error I see is `AttributeError in doctesting framework` which is also there without having your changes applied.

I didn't see any new doctest for the code testing the diameter for something bigger, line the line graph of 70000 vertices. Don't you think it would be nice to have such an example in the code?

Cheers, Christian



---

archive/issue_comments_196077.json:
```json
{
    "body": "The syntax checker was around... in order to read n<sup>2</sup> you should write n caret 2 caret.",
    "created_at": "2013-12-10T16:50:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15270#issuecomment-196077",
    "user": "https://github.com/videlec"
}
```

The syntax checker was around... in order to read n<sup>2</sup> you should write n caret 2 caret.



---

archive/issue_comments_196078.json:
```json
{
    "body": "Yooooooooooo !!\n\n> Out of curiosity: why do you now use `public/ticketnumber` after using `u/ncohen/ticketnumber` before?\n\n\nBecause I don't like it that people have to create their own branch to add a commit. Most of the time it's only typos or non-controversial stuff, so well, let's keep it simple and write on the same branches. I don't link this permission stuff anyway.\n\n> I just ran the doctest on all of graphs, and the only error I see is `AttributeError in doctesting framework` which is also there without having your changes applied.\n\n\nHmmmmmm... Perhaps you should report that somewhere, the git version should be the \"official\" version quite soon.\n\n> I didn't see any new doctest for the code testing the diameter for something bigger, line the line graph of 70000 vertices. Don't you think it would be nice to have such an example in the code?\n\n\nWell... It takes two minutes on its own. I thought that it was a bit too much for a doctest `O_o`\n\nNathann",
    "created_at": "2013-12-10T19:00:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15270#issuecomment-196078",
    "user": "https://github.com/nathanncohen"
}
```

Yooooooooooo !!

> Out of curiosity: why do you now use `public/ticketnumber` after using `u/ncohen/ticketnumber` before?


Because I don't like it that people have to create their own branch to add a commit. Most of the time it's only typos or non-controversial stuff, so well, let's keep it simple and write on the same branches. I don't link this permission stuff anyway.

> I just ran the doctest on all of graphs, and the only error I see is `AttributeError in doctesting framework` which is also there without having your changes applied.


Hmmmmmm... Perhaps you should report that somewhere, the git version should be the "official" version quite soon.

> I didn't see any new doctest for the code testing the diameter for something bigger, line the line graph of 70000 vertices. Don't you think it would be nice to have such an example in the code?


Well... It takes two minutes on its own. I thought that it was a bit too much for a doctest `O_o`

Nathann



---

archive/issue_comments_196079.json:
```json
{
    "body": "> Well... It takes two minutes on its own. I thought that it was a bit too much for a doctest `O_o`\n\n\nagreed. So, how am I getting the patchbot off the couch to get to work?",
    "created_at": "2013-12-10T19:27:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15270#issuecomment-196079",
    "user": "https://trac.sagemath.org/admin/accounts/users/stumpc5"
}
```

> Well... It takes two minutes on its own. I thought that it was a bit too much for a doctest `O_o`


agreed. So, how am I getting the patchbot off the couch to get to work?



---

archive/issue_comments_196080.json:
```json
{
    "body": "> agreed. So, how am I getting the patchbot off the couch to get to work?\n\n\nNoooooooooo Idea ! I ran the tests on my own computer `O_o`\n\nNathann",
    "created_at": "2013-12-10T20:01:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15270#issuecomment-196080",
    "user": "https://github.com/nathanncohen"
}
```

> agreed. So, how am I getting the patchbot off the couch to get to work?


Noooooooooo Idea ! I ran the tests on my own computer `O_o`

Nathann



---

archive/issue_comments_196081.json:
```json
{
    "body": "What happened to the branch -- is it gone?",
    "created_at": "2013-12-12T20:10:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15270#issuecomment-196081",
    "user": "https://trac.sagemath.org/admin/accounts/users/stumpc5"
}
```

What happened to the branch -- is it gone?



---

archive/issue_comments_196082.json:
```json
{
    "body": "Well, no... I can import it from trac, so it exists !\n\nI will reupload it under a different name, in my own folder.\n\nI wouldn' want it to disappear.\n\nNathann",
    "created_at": "2013-12-12T21:32:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15270#issuecomment-196082",
    "user": "https://github.com/nathanncohen"
}
```

Well, no... I can import it from trac, so it exists !

I will reupload it under a different name, in my own folder.

I wouldn' want it to disappear.

Nathann



---

archive/issue_comments_196083.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2013-12-12T21:33:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15270#issuecomment-196083",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_196084.json:
```json
{
    "body": "The doctests pass, the patch does what it is supposed to, so I am setting this to positive review.\n\nOnly trac seems to not to be knowing where the branch is, but I can import it from trac, so there should be a way out...",
    "created_at": "2013-12-13T15:15:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15270#issuecomment-196084",
    "user": "https://trac.sagemath.org/admin/accounts/users/stumpc5"
}
```

The doctests pass, the patch does what it is supposed to, so I am setting this to positive review.

Only trac seems to not to be knowing where the branch is, but I can import it from trac, so there should be a way out...



---

archive/issue_comments_196085.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-12-13T15:15:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15270#issuecomment-196085",
    "user": "https://trac.sagemath.org/admin/accounts/users/stumpc5"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_196086.json:
```json
{
    "body": "HMmmmmmmmmm weird `O_o`\n\nThanks for the review, though !!!\n\nNathann",
    "created_at": "2013-12-14T13:14:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15270#issuecomment-196086",
    "user": "https://github.com/nathanncohen"
}
```

HMmmmmmmmmm weird `O_o`

Thanks for the review, though !!!

Nathann



---

archive/issue_comments_196087.json:
```json
{
    "body": "Doesn't merge with sage-6.0, please fix.",
    "created_at": "2013-12-19T19:55:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15270#issuecomment-196087",
    "user": "https://github.com/vbraun"
}
```

Doesn't merge with sage-6.0, please fix.



---

archive/issue_comments_196088.json:
```json
{
    "body": "Done !\n\nNathann",
    "created_at": "2013-12-19T20:00:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15270#issuecomment-196088",
    "user": "https://github.com/nathanncohen"
}
```

Done !

Nathann



---

archive/issue_comments_196089.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. Last 10 new commits:",
    "created_at": "2013-12-19T20:00:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15270#issuecomment-196089",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. Last 10 new commits:



---

archive/issue_comments_196090.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2013-12-19T20:00:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15270#issuecomment-196090",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_196091.json:
```json
{
    "body": "Doesn't actually work\n\n```\nCython.Compiler.Errors.InternalError: Internal compiler error: 'sage/misc/bitset_pxd.pxi' not found\n```",
    "created_at": "2013-12-19T21:45:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15270#issuecomment-196091",
    "user": "https://github.com/vbraun"
}
```

Doesn't actually work

```
Cython.Compiler.Errors.InternalError: Internal compiler error: 'sage/misc/bitset_pxd.pxi' not found
```



---

archive/issue_comments_196092.json:
```json
{
    "body": "Arggggg... Must be because of Jeroen's patch on the bitset things.. Don't remember which one it was though `O_o`",
    "created_at": "2013-12-19T21:50:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15270#issuecomment-196092",
    "user": "https://github.com/nathanncohen"
}
```

Arggggg... Must be because of Jeroen's patch on the bitset things.. Don't remember which one it was though `O_o`



---

archive/issue_comments_196093.json:
```json
{
    "body": "Yoooooooo ! Sorry 'bout that. It was because of #13352. Jeroen replaced these imports almost everywhere, but of course not in the patches needing review `:-P`\n\nI updated the last commit. This one compiles and passes tests.\n\nNathann",
    "created_at": "2013-12-19T22:14:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15270#issuecomment-196093",
    "user": "https://github.com/nathanncohen"
}
```

Yoooooooo ! Sorry 'bout that. It was because of #13352. Jeroen replaced these imports almost everywhere, but of course not in the patches needing review `:-P`

I updated the last commit. This one compiles and passes tests.

Nathann



---

archive/issue_comments_196094.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2013-12-19T22:15:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15270#issuecomment-196094",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_196095.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-12-19T22:40:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15270#issuecomment-196095",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_045288.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-12-20T10:49:06Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/15270",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15270#event-45288"
}
```



---

archive/issue_comments_196096.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-12-20T10:49:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15270",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15270#issuecomment-196096",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
