# Issue 15270: Static sparse graphs on > 65536 vertices

Issue created by migration from Trac.

Original creator: ncohen

Original creation time: 2013-12-10 13:38:43

CC:  simonking dcoudert stumpc5

On Sage-devel [1], Christian reported an humiliating error message :



This is because Sage's "static_sparse_graphs" are stored on `unsigned short` fields (and thus to 65536 vertices), and though this is a meaningful limitation for Sage's code to compute the "all pairs shortest path" (the distance between all pairs of vertices, i.e. a n^2 matrix of integers), it does not make any sense to refuse to compute the diameter of such graphs.

Soooooooooo this patch changes these "unsigned short" to good old integers (which are not unsigned because it makes the code clearer and does not change much), which is also good to have when Simon is about to use the same data structure for combinatorial graphs, which can be huge.

I have to mention that this does not make "diameter" answer very fast either on instances with more than 65536 vertices `:-/`

But at least we can build them `T_T`

What this patch does:
* change the type of the static_sparse_graph data structure from ushort to int, as well as the functions that use it
* change the `all_pairs_shortest_path_BFS` function to first compute the distance on a `int *` array of length `n`. The values are then copied into the `n^2` matrix of `ushort` if necessary. That's a loss of time, but it's either this or rewriting two versions of the function `:-/`
* remove a useless `degree` variable in the same function
* Some simplifications from place to place in the code

Nathann

[1] https://groups.google.com/d/msg/sage-devel/2AI1CNdDm6w/jHKh26pMzqcJ


---

Comment by ncohen created at 2013-12-10 13:42:20

Changing status from new to needs_review.


---

Comment by git created at 2013-12-10 14:13:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by stumpc5 created at 2013-12-10 14:14:56

Thanks for working on that - how do I find your branch, it doesn't seem to be valid, and I just fetched and do not see any branch containing "15507".

Cheers, C.


---

Comment by stumpc5 created at 2013-12-10 14:17:27

Ah, there it is...

I still don't feel super comfortable, it more feels like git is using me rather than how it should be. E.g., in #15228 I don't know how to kick the patchbot. I also do not know how to get rid of branches I checked out once. Anyway, I will look at your changes now.

Best, C.


---

Comment by git created at 2013-12-10 14:21:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2013-12-10 14:23:36

(sorry, I updated the branch since, as there were two broken doctests left. Some integers were printed as 1L instead of 1 `T_T`)

Nathann


---

Comment by stumpc5 created at 2013-12-10 14:36:33

Out of curiosity: why do you now use `public/ticketnumber` after using `u/ncohen/ticketnumber` before?

I cannot judge if you created any problems anywhere in the code, but I guess you know what you are doing...

I just ran the doctest on all of graphs, and the only error I see is `AttributeError in doctesting framework` which is also there without having your changes applied.

I didn't see any new doctest for the code testing the diameter for something bigger, line the line graph of 70000 vertices. Don't you think it would be nice to have such an example in the code?

Cheers, Christian


---

Comment by vdelecroix created at 2013-12-10 16:50:40

The syntax checker was around... in order to read n<sup>2</sup> you should write n caret 2 caret.


---

Comment by ncohen created at 2013-12-10 19:00:00

Yooooooooooo !!

> Out of curiosity: why do you now use `public/ticketnumber` after using `u/ncohen/ticketnumber` before?

Because I don't like it that people have to create their own branch to add a commit. Most of the time it's only typos or non-controversial stuff, so well, let's keep it simple and write on the same branches. I don't link this permission stuff anyway.

> I just ran the doctest on all of graphs, and the only error I see is `AttributeError in doctesting framework` which is also there without having your changes applied.

Hmmmmmm... Perhaps you should report that somewhere, the git version should be the "official" version quite soon.

> I didn't see any new doctest for the code testing the diameter for something bigger, line the line graph of 70000 vertices. Don't you think it would be nice to have such an example in the code?

Well... It takes two minutes on its own. I thought that it was a bit too much for a doctest `O_o`

Nathann


---

Comment by stumpc5 created at 2013-12-10 19:27:34

> Well... It takes two minutes on its own. I thought that it was a bit too much for a doctest `O_o`

agreed. So, how am I getting the patchbot off the couch to get to work?


---

Comment by ncohen created at 2013-12-10 20:01:50

> agreed. So, how am I getting the patchbot off the couch to get to work?

Noooooooooo Idea ! I ran the tests on my own computer `O_o`

Nathann


---

Comment by stumpc5 created at 2013-12-12 20:10:21

What happened to the branch -- is it gone?


---

Comment by ncohen created at 2013-12-12 21:32:40

Well, no... I can import it from trac, so it exists !

I will reupload it under a different name, in my own folder.

I wouldn' want it to disappear.

Nathann


---

Comment by git created at 2013-12-12 21:33:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by stumpc5 created at 2013-12-13 15:15:53

The doctests pass, the patch does what it is supposed to, so I am setting this to positive review.

Only trac seems to not to be knowing where the branch is, but I can import it from trac, so there should be a way out...


---

Comment by stumpc5 created at 2013-12-13 15:15:53

Changing status from needs_review to positive_review.


---

Comment by ncohen created at 2013-12-14 13:14:31

HMmmmmmmmmm weird `O_o`

Thanks for the review, though !!!

Nathann


---

Comment by vbraun created at 2013-12-19 19:55:50

Doesn't merge with sage-6.0, please fix.


---

Comment by ncohen created at 2013-12-19 20:00:28

Done !

Nathann


---

Comment by git created at 2013-12-19 20:00:48

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. Last 10 new commits:


---

Comment by git created at 2013-12-19 20:00:48

Changing status from positive_review to needs_review.


---

Comment by vbraun created at 2013-12-19 21:45:06

Doesn't actually work

```
Cython.Compiler.Errors.InternalError: Internal compiler error: 'sage/misc/bitset_pxd.pxi' not found
```



---

Comment by ncohen created at 2013-12-19 21:50:58

Arggggg... Must be because of Jeroen's patch on the bitset things.. Don't remember which one it was though `O_o`


---

Comment by ncohen created at 2013-12-19 22:14:38

Yoooooooo ! Sorry 'bout that. It was because of #13352. Jeroen replaced these imports almost everywhere, but of course not in the patches needing review `:-P`

I updated the last commit. This one compiles and passes tests.

Nathann


---

Comment by git created at 2013-12-19 22:15:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2013-12-19 22:40:28

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2013-12-20 10:49:06

Resolution: fixed
