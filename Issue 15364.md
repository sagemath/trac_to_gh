# Issue 15364: Implementation of power series using PARI

Issue created by migration from Trac.

Original creator: pbruin

Original creation time: 2013-12-28 17:06:24

Keywords: pari series performance

Add a class `PowerSeries_pari` for power series based on PARI's `t_SER` type.  At least if the base ring is a finite field, this is much faster than the existing implementation based on NTL polynomials.


---

Comment by git created at 2013-12-28 18:59:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pbruin created at 2013-12-28 19:04:06

The current branch enables the new power series class if the base field is of type `FiniteField_pari_ffelt`, since it yields a noticeable improvement at least in that case.

Here is a more or less random example with power series over a PARI finite field.

Setup:

```
sage: F.<a> = FiniteField(29^10)
sage: v = [F.random_element() for i in range(100)]
sage: w = [F.random_element() for i in range(100)]
sage: R.<x> = PowerSeriesRing(F, implementation=....)
sage: f = R(v, 100); g = R(w, 100)
```

Timings (with `-c -r 1`, in milliseconds):

```
           pari     poly
R(v, 100)  0.252    23.6
f.list()   0.460    6.28
f + g      0.0328   0.204
f * g      6.24     6.64
~f         6.84     29.6
f^2        3.2      6.44
```



---

Comment by pbruin created at 2013-12-28 19:04:06

Changing status from new to needs_review.


---

Comment by git created at 2013-12-28 20:55:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2013-12-30 13:54:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-01-13 12:22:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-01-17 22:34:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-03-25 15:35:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2014-04-22 13:24:29

I'm confused. If I click on the branch here the file `power_series_poly.pyx` containing `class PowerSeries_poly` is shown as deleted. Is this intended?


---

Comment by pbruin created at 2014-04-22 13:38:15

Replying to [comment:10 rws]:
> I'm confused. If I click on the branch here the file `power_series_poly.pyx` containing `class PowerSeries_poly` is shown as deleted. Is this intended?
No, this is a Trac bug.  If you check out this branch you can see the real changes with `git diff develop...ticket/15601` (substitute your local branch name).


---

Comment by git created at 2014-05-25 15:37:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pbruin created at 2014-08-19 12:14:56

There are a few doctest failures after merging in #15767, caused by what seems to be a PARI bug:

```
gp > f = Ser(Mod(0, 3), 'x)
%1 = Mod(0, 3) + O(x^16)
gp > valuation(f, 'x)
%2 = 0
gp > f * 1
%3 = Mod(0, 3)*x^15 + O(x^16)
```



---

Comment by pbruin created at 2014-08-19 12:14:56

Changing status from needs_review to needs_work.


---

Comment by git created at 2014-08-25 20:09:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pbruin created at 2014-08-25 20:15:35

Replied to related existing bug report at http://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=1587.


---

Comment by git created at 2014-08-25 21:28:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pbruin created at 2014-09-11 12:47:19

There were some glitches in PARI's handling of various kinds of zeroes in series.  These are fixed by a sequence of upstream commits  (e0167bc, 3e727c1, f6fece5, 480e7ae, f8e1592) related to PARI bug report 1587.  It's probably easiest to wait for the next stable PARI version including these fixes.


---

Comment by git created at 2015-03-06 16:42:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pbruin created at 2015-03-06 16:45:07

Changing status from needs_work to needs_review.


---

Comment by pbruin created at 2015-03-06 16:45:07

The bugs mentioned in comment:19 are fixed as of #16997.


---

Comment by jdemeyer created at 2015-03-06 17:19:16

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-03-06 17:19:16

1. Replace `PY_TYPE_CHECK` by `isinstance`.

2. Is this still relevant?

```
# Substitution of p-adic numbers in power series is
# currently not implemented in PARI (2.5.5).
```


3. This looks fishy:

```
if isinstance(n, slice):
    # get values from slice object
    start = n.start if n.start is not None else 0
    stop = self._prec if n.stop is None else n.stop
    if stop is infinity:
        stop = self.polynomial().degree() + 1
    step = 1 if n.step is None else n.step

    # find corresponding polynomial
    poly = self.polynomial()[start:stop]
    if step is not None:
        coeffs = poly.padded_list(stop)
        for i in range(start, stop):
            if (i - start) % step:
                coeffs[i] = 0
        poly = self._parent._poly_ring()(coeffs)
```

I think you can (more or less) replace all the above code by

```
coeffs = self.padded_list()[n]
poly = self._parent._poly_ring()(coeffs)
```



---

Comment by jdemeyer created at 2015-03-06 17:25:36

In error message like

```
raise ValueError('unknown power series implementation: %s' % implementation)
```

I prefer to see `%r` instead of `%s` (this will print strings with quotes and it might also print non-strings more nicely)


---

Comment by git created at 2015-03-07 08:02:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pbruin created at 2015-03-07 08:21:55

Replying to [comment:22 jdemeyer]:
> 1. Replace `PY_TYPE_CHECK` by `isinstance`.
OK, done.
> 2. Is this still relevant?
> {{{
> # Substitution of p-adic numbers in power series is
> # currently not implemented in PARI (2.5.5).
> }}}
Yes, unfortunately.
> 3. This looks fishy: [...] I think you can (more or less) replace all the above code by
> {{{
> coeffs = self.padded_list()[n]
> poly = self._parent._poly_ring()(coeffs)
> }}}
This was adapted from `power_series_poly.pyx`.  I would prefer to solve this using

```
poly = self.polynomial()[n]
```

to also handle negative `start`/`stop`/`step` correctly.  Unfortunately, the `__getitem__()` methods of polynomials do not yet implement `f[start:stop:step]` with `step != 1`.  Maybe we should open a ticket for this and then simplify `__getitem__()` for power series to use the one for polynomials?


---

Comment by pbruin created at 2015-07-22 20:29:28

Replying to [comment:25 pbruin]:
> Unfortunately, the `__getitem__()` methods of polynomials do not yet implement `f[start:stop:step]` with `step != 1`.  Maybe we should open a ticket for this and then simplify `__getitem__()` for power series to use the one for polynomials?
This is now #18940.


---

Comment by git created at 2015-10-14 21:50:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pbruin created at 2015-10-14 21:51:53

Changing status from needs_work to needs_review.


---

Comment by pbruin created at 2015-10-14 21:51:53

(Note to reviewers: the dependency #18940 has not been merged into this ticket.)


---

Comment by git created at 2015-10-14 22:09:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-01-06 21:02:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-01-22 00:12:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-01-22 20:18:05

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2016-01-22 20:21:31

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2016-01-23 10:44:07

Why are you wrapping a Python `gen` instead of a PARI `GEN` (like for `element_pari_ffelt`)? Wrapping a wrapper sounds inefficient.

Edit: I'm not saying this is a needs_work issue, but I would like to know the reason.


---

Comment by jdemeyer created at 2016-01-23 10:46:36

I would like to see some basic examples added to the top-level docstring of `src/sage/rings/power_series_pari.pyx`. In particular, it would be good to have examples over various base rings (it is the default implementation over ffelt, but it works over other rings too, right?).


---

Comment by jdemeyer created at 2016-01-23 10:48:13

Replace

```
from sage.libs.pari.pari_instance cimport PariInstance
import sage.libs.pari.all
cdef PariInstance pari = sage.libs.pari.all.pari
```

by

```
from sage.libs.pari.pari_instance cimport pari_instance as pari
```



---

Comment by jdemeyer created at 2016-01-23 10:55:54


```
def __init__(self, parent, f=0, prec=infinity, check=True)
```

is missing an `INPUT:` block. Moreover, it seems that the argument `check` makes _functional_ changes to `__init__` and I don't know if that is supposed to be like that.

I suggest to rename `check=True` to `value_from_pari=False` and replace `if not check and isinstance(f, pari_gen):` by `if value_from_pari:`.

*EDIT*: maybe it's better to move this code completely out of `__init__` and make a new classmethod `def construct_from_pari()` which bypasses `__init__` completely.


---

Comment by jdemeyer created at 2016-01-23 10:55:54

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2016-01-23 10:57:32

Still in `__init__`, I don't think you use the fact that `v` is of type `str`, so replace

```
cdef str v = parent.variable_name()
```

by

```
v = parent.variable_name()
```



---

Comment by jdemeyer created at 2016-01-23 11:00:55

Same thing in `__invert__` and `__pow__` and `_div_`: replace

```
cdef pari_gen h = ...
```

by

```
h = ...
```



---

Comment by jdemeyer created at 2016-01-23 11:11:16

Replace

```
use_lazy_mpoly_ring=False
```

by

```
use_lazy_mpoly_ring=None
```

and

```
if use_lazy_mpoly_ring:
    deprecation(...)
```

by

```
if use_lazy_mpoly_ring is not None:
    deprecation(...)
```



---

Comment by jdemeyer created at 2016-01-23 11:53:43

Before:

```
sage: R.<x> = PowerSeriesRing(GF(31^20, 'a')); x.reverse()
x + O(x^20)
```

After:

```
sage: R.<x> = PowerSeriesRing(GF(31^20, 'a')); x.reverse()
...
AttributeError: 'sage.rings.power_series_pari.PowerSeries_pari' object has no attribute 'reverse'
```



---

Comment by jdemeyer created at 2016-01-23 11:54:40

Before:

```
sage: R.<x> = PowerSeriesRing(GF(31^20, 'a')); x // x
1
```


After:

```
sage: R.<x> = PowerSeriesRing(GF(31^20, 'a')); x // x
...
TypeError: unsupported operand type(s) for //: 'sage.rings.power_series_pari.PowerSeries_pari' and 'sage.rings.power_series_pari.PowerSeries_pari'
```


(but note #2034)


---

Comment by git created at 2016-01-23 12:47:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pbruin created at 2016-01-23 13:02:35

Replying to [comment:43 jdemeyer]:
> Before:
> {{{
> sage: R.<x> = PowerSeriesRing(GF(31^20, 'a')); x // x
> 1
> }}}
> 
> After:
> {{{
> sage: R.<x> = PowerSeriesRing(GF(31^20, 'a')); x // x
> ...
> TypeError: unsupported operand type(s) for //: 'sage.rings.power_series_pari.PowerSeries_pari' and 'sage.rings.power_series_pari.PowerSeries_pari'
> }}}
> 
> (but note #2034)
What is `__floordiv__()` supposed to do anyway?  I can't immediately think of a case where it should behave differently from `__div__`, and the documentation of `PowerSeries_poly.__floordiv__()` doesn't help either.


---

Comment by pbruin created at 2016-01-23 13:08:20

Replying to [comment:35 jdemeyer]:
> Why are you wrapping a Python `gen` instead of a PARI `GEN` (like for `element_pari_ffelt`)? Wrapping a wrapper sounds inefficient.
It seemed more efficient in terms of developer time...  Power series are probably less time-critical than finite field elements.


---

Comment by jdemeyer created at 2016-01-23 19:00:06

Replying to [comment:45 pbruin]:
> What is `__floordiv__()` supposed to do anyway?

Interesting question. Looking at the code, it seems to be the same as ordinary division.

It is very old code from

```
commit 4a1096784560180aa9497d70cffe1a9c93d41ab1
Author: robertwb <robertwb`@`math.washington.edu>
Date:   Tue Aug 8 23:43:19 2006 +0000

    [project `@` ring and power series coercion, floordiv for polynomials]

```



---

Comment by jdemeyer created at 2016-01-23 19:01:09

Anyway, my point was not very specific about floor division, just that certain things are implemented for ordinary power series, but not for PARI power series. This is bad because it might break existing code.


---

Comment by git created at 2016-02-16 10:46:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pbruin created at 2016-02-16 11:08:58

Replying to [comment:48 jdemeyer]:
> Anyway, my point was not very specific about floor division, just that certain things are implemented for ordinary power series, but not for PARI power series. This is bad because it might break existing code.
This is now #20062.


---

Comment by git created at 2016-03-29 09:21:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-02 13:45:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-05-26 10:41:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-05-26 12:53:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pbruin created at 2016-05-26 12:56:38

Changing status from needs_work to needs_review.


---

Comment by pbruin created at 2016-05-26 12:56:38

I think all reviewer comments so far have now been taken into account.


---

Comment by git created at 2016-05-30 10:59:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-06-13 14:05:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-06-25 07:00:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-10-11 09:57:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pbruin created at 2016-10-24 09:02:38

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-10-25 05:43:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pbruin created at 2016-10-25 05:44:19

Changing status from needs_work to needs_review.


---

Comment by git created at 2016-11-18 08:56:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pbruin created at 2017-01-23 09:30:31

Split off some parts as separate tickets, updated and squashed the branch.


---

Comment by git created at 2017-01-25 10:50:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-01-26 07:32:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-01-28 23:59:32

I made some minor revisions and python3 compatibility. I also removed the deprecation and the corresponding one in the PARI polynomials. If my changes are good, then you can set a positive review.
----
New commits:


---

Comment by pbruin created at 2017-01-30 06:32:03

Replying to [comment:68 tscrim]:
> I made some minor revisions and python3 compatibility. I also removed the deprecation and the corresponding one in the PARI polynomials. If my changes are good, then you can set a positive review.
Thanks.  I see that the deprecated function alias is almost 2 years old, so removing it is fine.

Just out of curiosity: did you have a particular reason for changing `"""` to `r"""` in some docstrings?  As far as I know this is only needed if the docstring contains backslashes that should be left alone.


---

Comment by pbruin created at 2017-01-30 06:32:03

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2017-01-30 06:41:07

Replying to [comment:69 pbruin]:
> Just out of curiosity: did you have a particular reason for changing `"""` to `r"""` in some docstrings?  As far as I know this is only needed if the docstring contains backslashes that should be left alone.

Either it was more of a habit (i.e., I didn't notice I did it) or I was being paranoid about things.


---

Comment by vbraun created at 2017-02-02 22:09:31

Resolution: fixed
