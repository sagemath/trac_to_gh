# Issue 21079: fix hash of (dense) matrices

Issue created by migration from https://trac.sagemath.org/ticket/21316

Original creator: dkrenn

Original creation time: 2016-08-23 14:56:27

It took me only 4 guesses to find two matrices with the same hash:

```
sage: N = Matrix([[1,1],[2,2]]); N.set_immutable(); hash(N)
3
sage: N = Matrix([[0,0],[0,1]]); N.set_immutable(); hash(N)
3
```

This should not be that easy.

In particular (looking at the code in `sage.matrix.matric_dense`), the hash value does not depend on entry 1,1 of the matrix (multiplication by zero in the hash code):

```
sage: N = Matrix([[3,2],[0,0]]); N.set_immutable(); hash(N)
2
sage: N = Matrix([[443,2],[0,0]]); N.set_immutable(); hash(N)
2
sage: N = Matrix([[2,2],[0,0]]); N.set_immutable(); hash(N)
2
```



---

Comment by dkrenn created at 2016-08-23 14:59:54

From `sage.matrix.matrix_dense`:

```
        v = self._list()
        cdef Py_ssize_t i
        cdef long h = 0

        for i from 0 <= i < len(v):
            h = h ^ (i * hash(v[i]))
```

What is a good caching strategy? Simply `h = hash(tuple(self._list()))`?


---

Comment by ibookstein created at 2017-07-29 21:22:19

Non-cryptographic hashes don't have to be resilient to collision attacks, but should indeed give good hash value spread for the input space - which this implementation doesn't.

I can confirm that this implementation causes massive performance degradation when matrices are used as dictionary keys, for instance.

See [tuple hash algorithm](http://effbot.org/zone/python-hash.htm#tuples) and [explanations why XORing hash values doesn't perform very well](https://stackoverflow.com/a/263416/1638488).

While the current implementation does try to 'save' itself from the disadvantages of XORing hash values by multiplying by the index, it still performs very poorly.

I tried the solution dkrenn suggested and it does indeed work much better.
If we don't care about the performance cost of creating a tuple (and a list), seeing as the hash value is cached, it's a nice solution.


---

Comment by dkrenn created at 2017-07-30 07:36:50

New commits:


---

Comment by ibookstein created at 2017-11-22 11:56:05

Looks like major work was put into this issue in #19050, rendering this ticket a duplicate.


---

Comment by jdemeyer created at 2017-11-22 12:43:05

Duplicate of #10950.


---

Comment by jdemeyer created at 2017-11-22 12:43:05

Resolution: duplicate
