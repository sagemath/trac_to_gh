# Issue 21079: fix hash of (dense) matrices

archive/issues_021079.json:
```json
{
    "body": "It took me only 4 guesses to find two matrices with the same hash:\n\n```\nsage: N = Matrix([[1,1],[2,2]]); N.set_immutable(); hash(N)\n3\nsage: N = Matrix([[0,0],[0,1]]); N.set_immutable(); hash(N)\n3\n```\nThis should not be that easy.\n\nIn particular (looking at the code in `sage.matrix.matric_dense`), the hash value does not depend on entry 1,1 of the matrix (multiplication by zero in the hash code):\n\n```\nsage: N = Matrix([[3,2],[0,0]]); N.set_immutable(); hash(N)\n2\nsage: N = Matrix([[443,2],[0,0]]); N.set_immutable(); hash(N)\n2\nsage: N = Matrix([[2,2],[0,0]]); N.set_immutable(); hash(N)\n2\n```\n\nIssue created by migration from https://trac.sagemath.org/ticket/21316\n\n",
    "closed_at": "2017-11-22T12:43:05Z",
    "created_at": "2016-08-23T14:56:27Z",
    "labels": [
        "component: misc",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "fix hash of (dense) matrices",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21079",
    "user": "https://github.com/dkrenn"
}
```
It took me only 4 guesses to find two matrices with the same hash:

```
sage: N = Matrix([[1,1],[2,2]]); N.set_immutable(); hash(N)
3
sage: N = Matrix([[0,0],[0,1]]); N.set_immutable(); hash(N)
3
```
This should not be that easy.

In particular (looking at the code in `sage.matrix.matric_dense`), the hash value does not depend on entry 1,1 of the matrix (multiplication by zero in the hash code):

```
sage: N = Matrix([[3,2],[0,0]]); N.set_immutable(); hash(N)
2
sage: N = Matrix([[443,2],[0,0]]); N.set_immutable(); hash(N)
2
sage: N = Matrix([[2,2],[0,0]]); N.set_immutable(); hash(N)
2
```

Issue created by migration from https://trac.sagemath.org/ticket/21316





---

archive/issue_comments_291681.json:
```json
{
    "body": "From `sage.matrix.matrix_dense`:\n\n```\n        v = self._list()\n        cdef Py_ssize_t i\n        cdef long h = 0\n\n        for i from 0 <= i < len(v):\n            h = h ^ (i * hash(v[i]))\n```\nWhat is a good caching strategy? Simply `h = hash(tuple(self._list()))`?",
    "created_at": "2016-08-23T14:59:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21079",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21079#issuecomment-291681",
    "user": "https://github.com/dkrenn"
}
```

From `sage.matrix.matrix_dense`:

```
        v = self._list()
        cdef Py_ssize_t i
        cdef long h = 0

        for i from 0 <= i < len(v):
            h = h ^ (i * hash(v[i]))
```
What is a good caching strategy? Simply `h = hash(tuple(self._list()))`?



---

archive/issue_comments_291682.json:
```json
{
    "body": "Non-cryptographic hashes don't have to be resilient to collision attacks, but should indeed give good hash value spread for the input space - which this implementation doesn't.\n\nI can confirm that this implementation causes massive performance degradation when matrices are used as dictionary keys, for instance.\n\nSee [tuple hash algorithm](http://effbot.org/zone/python-hash.htm#tuples) and [explanations why XORing hash values doesn't perform very well](https://stackoverflow.com/a/263416/1638488).\n\nWhile the current implementation does try to 'save' itself from the disadvantages of XORing hash values by multiplying by the index, it still performs very poorly.\n\nI tried the solution dkrenn suggested and it does indeed work much better.\nIf we don't care about the performance cost of creating a tuple (and a list), seeing as the hash value is cached, it's a nice solution.",
    "created_at": "2017-07-29T21:22:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21079",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21079#issuecomment-291682",
    "user": "https://trac.sagemath.org/admin/accounts/users/ibookstein"
}
```

Non-cryptographic hashes don't have to be resilient to collision attacks, but should indeed give good hash value spread for the input space - which this implementation doesn't.

I can confirm that this implementation causes massive performance degradation when matrices are used as dictionary keys, for instance.

See [tuple hash algorithm](http://effbot.org/zone/python-hash.htm#tuples) and [explanations why XORing hash values doesn't perform very well](https://stackoverflow.com/a/263416/1638488).

While the current implementation does try to 'save' itself from the disadvantages of XORing hash values by multiplying by the index, it still performs very poorly.

I tried the solution dkrenn suggested and it does indeed work much better.
If we don't care about the performance cost of creating a tuple (and a list), seeing as the hash value is cached, it's a nice solution.



---

archive/issue_events_056751.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/ibookstein",
    "created_at": "2017-07-29T21:28:45Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/21079",
    "milestone": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21079#event-56751"
}
```



---

archive/issue_comments_291683.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-07-30T07:36:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21079",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21079#issuecomment-291683",
    "user": "https://github.com/dkrenn"
}
```

New commits:



---

archive/issue_comments_291684.json:
```json
{
    "body": "Looks like major work was put into this issue in #19050, rendering this ticket a duplicate.",
    "created_at": "2017-11-22T11:56:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21079",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21079#issuecomment-291684",
    "user": "https://trac.sagemath.org/admin/accounts/users/ibookstein"
}
```

Looks like major work was put into this issue in #19050, rendering this ticket a duplicate.



---

archive/issue_events_056752.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-11-22T12:43:05Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/21079",
    "milestone": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21079#event-56752"
}
```



---

archive/issue_events_056753.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-11-22T12:43:05Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/21079",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21079#event-56753"
}
```



---

archive/issue_comments_291685.json:
```json
{
    "body": "Duplicate of #10950.",
    "created_at": "2017-11-22T12:43:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21079",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21079#issuecomment-291685",
    "user": "https://github.com/jdemeyer"
}
```

Duplicate of #10950.



---

archive/issue_events_056754.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-11-22T12:43:05Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/21079",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21079#event-56754"
}
```



---

archive/issue_comments_291686.json:
```json
{
    "body": "Resolution: duplicate",
    "created_at": "2017-11-22T12:43:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21079",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21079#issuecomment-291686",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: duplicate
