# Issue 30504: Refactor to break cyclic import in complex numbers

Issue created by migration from https://trac.sagemath.org/ticket/30741

Original creator: @tobiasdiez

Original creation time: 2020-10-07 18:22:49

CC:  mkoeppe tscrim arojas

Importing `complex_number` does currently not work without previously importing `sage.all`. This is because of a couple of cyclic imports (e.g. `complex_number` -> `complex_double` -> `complex_number`).

In this ticket, we break these cyclic imports by narrowing down some of the global module imports to local function-wide imports. This was not possible in the case of the `CCtoCDF` class, since there `ComplexDoubleElement` is cimported, which has to be done on the module level. I've hence extracted this class to a new module `complex_conversion.pyx`.


---

Comment by @tobiasdiez created at 2020-10-07 18:22:56

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-10-07 18:39:48

Changes of this type need careful review regarding possible performance penalties from the import


---

Comment by vdelecroix created at 2020-10-10 21:22:57

Instead of

```
+            from sage.rings.complex_conversion import CCtoCDF
+            return CCtoCDF(S, self)
```

Why don't you add a proper `.pxd` file and does a `cimport` at module level?


---

Comment by @tobiasdiez created at 2020-10-11 10:56:21

A module level `cipmort CCtoCDF` would lead again to a circular import: complex_double -> complex_conversion (for CCtoCDF) -> complex_double (for ComplexDoubleElement).


---

Comment by vdelecroix created at 2020-10-11 11:10:55

Replying to [comment:4 gh-tobiasdiez]:
> A module level `cipmort CCtoCDF` would lead again to a circular import: complex_double -> complex_conversion (for CCtoCDF) -> complex_double (for ComplexDoubleElement). 

`cimport` does **not** trigger the Python module import (the things in the `.pyx`). It is just reading the corresponding `.pxd` file.

EDIT: and it is perfectly fine to have circular imports here as these are guarded with macros at the C level


---

Comment by mkoeppe created at 2020-10-24 23:09:59

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by git created at 2021-10-18 23:16:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-10-18 23:24:31

With #32612 you can also use `isinstance(..., sage.rings.abc.ComplexIntervalField)` instead of using a local import


---

Comment by git created at 2021-10-18 23:34:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-10-18 23:34:33

Replying to [comment:11 mkoeppe]:
> With #32612 you can also use `isinstance(..., sage.rings.abc.ComplexIntervalField)` instead of using a local import

Thanks for the pointer! Done


---

Comment by git created at 2021-10-21 07:57:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-10-21 17:17:24

still needs work or ready for review?


---

Comment by git created at 2021-10-22 21:15:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-10-22 21:16:07

I've fixed the branch but does it actually solve anything?


---

Comment by git created at 2021-11-26 21:21:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-11-26 21:22:39

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2021-11-26 21:22:39

New commits:


---

Comment by @tobiasdiez created at 2021-11-26 21:25:32

Thanks for the help Matthias!

It still needed a bit further cleanup, but should work now. I've updated the ticket description to discuss what didn't work before but now does.


---

Comment by mkoeppe created at 2021-11-26 22:12:31

Thanks, this looks good. I'll test this now also with #32601, but I don't expect problems


---

Comment by mkoeppe created at 2021-11-26 22:34:12

Changing status from needs_review to positive_review.


---

Comment by @tobiasdiez created at 2021-11-27 16:12:55

Thanks for the review!


---

Comment by vbraun created at 2021-12-06 00:21:08


```
sage -t --long --warn-long 43.1 --random-seed=227602538950590531556014576097185838563 src/sage/geometry/hyperbolic_space/hyperbolic_geodesic.py
**********************************************************************
File "src/sage/geometry/hyperbolic_space/hyperbolic_geodesic.py", line 2038, in sage.geometry.hyperbolic_space.hyperbolic_geodesic.HyperbolicGeodesicPD.plot
Failed example:
    H = h.plot(thickness=6, color="orange"); H           # optional - sage.plot
Expected:
    Graphics object consisting of 2 graphics primitives        # optional - sage.plot
Got:
    Graphics object consisting of 2 graphics primitives
**********************************************************************
```



---

Comment by vbraun created at 2021-12-06 00:21:08

Changing status from positive_review to needs_work.


---

Comment by mkoeppe created at 2021-12-06 00:35:21

Fixed in #32174.


---

Comment by mkoeppe created at 2021-12-06 00:35:21

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2021-12-19 11:47:53

Resolution: fixed
