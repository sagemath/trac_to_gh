# Issue 12517: Segfault in solve_left for sparse matrices over ZZ

Issue created by migration from https://trac.sagemath.org/ticket/12689

Original creator: davidloeffler

Original creation time: 2012-03-18 19:16:31

Assignee: jason, was

Keywords: segfault

Calling solve_left on a sparse integer matrix results in an instant segfault:

```
sage: A = identity_matrix(ZZ, 2, sparse=True)
sage: B = identity_matrix(ZZ, 2, sparse=True)
sage: A.solve_left(B)
/storage/masiao/sage-5.0.beta8/spkg/bin/sage: line 308:  7843 Segmentation fault      sage-ipython "$@" -i
```



---

Comment by dsm created at 2012-03-18 20:29:49

We can push the bug a bit farther back:



```

sage: A = identity_matrix(ZZ, 2, sparse=True)
sage: B = identity_matrix(ZZ, 2, sparse=True)
sage: A.augment(B)
[1 0 1 0]
[0 1 0 1]
sage: A.change_ring(QQ).augment(B.change_ring(QQ))
[1 0 1 0]
[0 1 0 1]
sage: A.change_ring(QQ).augment(B)
[  1   0 1/0   0]
[  0   1   0 1/0]
```


1/0 doesn't look right..


---

Comment by dsm created at 2012-03-18 20:51:43

Ah, okay.  I think I see what's going on.  In matrix_sparse.pyx's augment:


```

        cdef Matrix_sparse other = right.sparse_matrix()

    [...]

        if not (self._base_ring is right.base_ring()):
            right = right.change_ring(self._base_ring)
```


attemps to change the right base ring to agree, but during the insertion process, it still uses the old unchanged one:


```
        for i, j in right.nonzero_positions(copy=False):
            Z.set_unsafe(i, j + self._ncols, other.get_unsafe(i,j))
```


If we instead use

```

            other = other.change_ring(self._base_ring)
```


then everything seems to work:


```

sage: z = A.change_ring(QQ).augment(B)
[skipping debugging output]
sage: z
[1 0 1 0]
[0 1 0 1]
```


and 


```

sage: A.solve_left(B)
[1 0]
[0 1]
sage: parent(_)
Full MatrixSpace of 2 by 2 sparse matrices over Rational Field

```


So I think the fix is a one-liner.  Any takers?


---

Comment by was created at 2012-03-18 20:58:19

> Any takes? 

I'll post a patch if you'll review it :-)


---

Comment by dsm created at 2012-03-18 21:02:48

Deal.  Should probably add tests both in augment for the incompatible-ring bug and in solve_left for the original.


---

Comment by dsm created at 2012-03-18 21:06:21

Although since uses Z._subdivide_on_augment(self, right) uses right too, maybe it's a two-liner. :^)


---

Attachment


---

Comment by was created at 2012-03-18 21:14:38

Changing status from new to needs_review.


---

Comment by dsm created at 2012-03-18 21:36:41

Running test suite now, but it looks fine. Don't forget that we have the new ":trac:`12689`" markup now, though!


---

Comment by was created at 2012-03-18 22:28:54

Replying to [comment:7 dsm]:
> Running test suite now, but it looks fine. Don't forget that we have the new ":trac:`12689`" markup now, though!

Cool.  I've never heard of it.


---

Comment by dsm created at 2012-03-19 03:20:02

Patch applies against 5.0.beta8 (and 4.8) and runs; fixes the OP's symptom; has a doctest; doesn't introduce new doctest failures (I have quite a few on beta8 but they came before, and it works cleanly against 4.8); and it's clear what the bug was and why this patch fixes it.

Positive review.


---

Comment by dsm created at 2012-03-19 03:20:02

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-03-23 15:23:35

Resolution: fixed
