# Issue 17330: Cross product matrix (hat operator)

Issue created by migration from https://trac.sagemath.org/ticket/17567

Original creator: gagern

Original creation time: 2014-12-30 14:17:26

For some operations it's useful to write a cross product between two vectors as a matrix times vector (or vector times matrix) linear transformation. Of course, this is most useful in those situations where the cross product isn't multiplied straight away, but the matrix is used on its own.

One application that I know of is when intersecting a conic with a line using projective geometry. There, conjugating the matrix of the conic with the cross product matrix of the line results in a degenerate conic which factors into the points of intersection. But I've heard that there are applications in 3D computer graphics as well, where this is known as the [hat operator](http://en.wikipedia.org/wiki/Hat_operator#Cross_product).

The simplest implementation would be something like this:


```
def cross_product_matrix(v):
    return matrix([e.cross_product(v) for e in v.parent().basis()])
```


It satisfies these conditions:


```
cross_product_matrix(v)*w == v.cross_product(w)
w*cross_product_matrix(v) == w.cross_product(v)
```


But I guess it would be better to implement this as a method of `FreeModuleElement`. I'm not sure whether it would be better to access the basis as I did above, or whether it would be preferable to hard-code the matrix layout, both for the sake of performance and because it ensures we don't depend on the basis.


---

Comment by gagern created at 2014-12-30 14:21:01

OK, here is my stab at implementing this. I chose to duplicate functionality from `cross_product` for the sake of performance. If you disagree and would prefer a more high-level description as outlined in the ticket summary, please let me know.
----
New commits:


---

Comment by gagern created at 2014-12-30 14:25:02

Changing status from new to needs_review.


---

Comment by tscrim created at 2015-01-10 05:22:56

A few comments. Please remove the `self` as input, it's not considered as such. I would also consider using the `:wikipedia:`Hat_operator#Cross_product`` in the documentation.

A bit more substantial, I would instead check the rank by `self.parent().rank()` and define `s` inside of each of the 2 cases. This is a slight speed penalty in the general ring case, but for `ZZ`, which always copies the list, this could result in a big speedup:

```
sage: m = (ZZ^4).random_element()
sage: %timeit len(m.list(copy=False))
1000000 loops, best of 3: 1.39 µs per loop
sage: %timeit m.parent().rank()
1000000 loops, best of 3: 955 ns per loop
sage: m = (QQ['t']^4).random_element()
sage: %timeit len(m.list(copy=False))
1000000 loops, best of 3: 791 ns per loop
sage: m = (ZZ^20).random_element()
sage: %timeit len(m.list(copy=False))
100000 loops, best of 3: 3.03 µs per loop
```

Plus this is more robust if the behavior is changed to mimic `ZZ` (i.e., it always copies the elements). I might also consider adding the definition of `R` and `zero` inside of the 2 cases as well, but that is a definite micro-optimization.

Somewhat of a side note, constructing the basis might be an expensive operation. So if you don't really need it, then let's stay away from using it.

Nice little patch; looks good otherwise.


---

Comment by gagern created at 2015-01-10 08:04:15

Replying to [comment:5 tscrim]:
> A few comments. Please remove the `self` as input, it's not considered as such. I would also consider using the `:wikipedia:`Hat_operator#Cross_product`` in the documentation.

Didn't know we had such syntax. Nice!

> A bit more substantial, I would instead check the rank by `self.parent().rank()` and define `s` inside of each of the 2 cases.

I was copying the approach from `cross_product`. The case where the operation is not defined will be rarely used, so I see no point optimizing for that. So if you almost always end up in one of the two defined cases, and you want a list `s` in each of these, then you might as well start by computing that list. Or, to do a proper performance comparison, you'd have to compare `len(s)` against `self.parent().rank()`. I guess the former would win, but the difference should be neglible.

> This is a slight speed penalty in the general ring case, but for `ZZ`, which always copies the list, this could result in a big speedup[…]

In that case, we might want to consider avoiding that list `s` altogether, and using `self[i]` directly instead. Not sure how that compares performance-wise. Whatever choice we make, there is little reason to handle `cross_product_matrix` different from `cross_product`. Should I adapt my patch to avoid the list for both cases?

> Nice little patch; looks good otherwise.

Thanks!


---

Comment by gagern created at 2015-01-26 15:39:01

I'd like to leave my commit as is, for the following reasons.

Replying to [comment:5 tscrim]:
> A few comments. Please remove the `self` as input, it's not considered as such.

I'm somehow not sure this is universally accepted.


```
$ git ls-files -z | xargs -0 grep -Ee '- +``self``[: ]' | wc -l
442
```


While I agree that one can gain little from a description like “`self` is any object of the class we're talking about here”, the case at hand is somewhat different, since there are extra requirements for that object. Making them clear in the *INPUT* section seems important to me. If you still disagree, I'd like this discussed on the dev list, unless you can provide a convincing argument.

If this was already discussed on the list, I'd welcome some pointer. [This thread](https://groups.google.com/d/msg/sage-devel/wCYdiMFyiH8/i3rZwywv9AEJ) gives an example with `self` in the docstring, and noone objected. But the issue at hand was somethinbg different. [This post](https://groups.google.com/d/msg/sage-devel/087GdkT9n4g/Y9CIQwZBdiwJ) suggests documenting “anything special about self”, but it might be considered somewhat dated, or the opinion of a single person without any discussion about it. It certainly contradicts the first thread I referenced with regard to indentation.

So far I haven't found a discussion specifically about whether or not to include `self` in the *INPUT* section, and no developer guide document either.

> I would also consider using the `:wikipedia:`Hat_operator#Cross_product`` in the documentation.

Considered it, and tried it out. But in the HTML text the hash (anchor separator) looks ugly, and if I try to use it in the link target annotation it doesn't work at all.

> A bit more substantial, I would instead check the rank by `self.parent().rank()` and define `s` inside of each of the 2 cases.

As I said, I'm not optimizing for the case where the operation is not defined, and in the other two cases we need the `s` array sooner or later, so it might as well be sooner.

> for `ZZ`, which always copies the list, this could result in a big speedup

The only way to avoid this list copy for the cases of rank 3 or 7 is by doing element access on `self` instead of a (possibly copied) list of entries. I did some comparison, my implementation against one (called `cross_product_matrix2`) which replaces every occurrence of `s[i]` by `self[i]`, does not set `s` at all, and uses `self.parent().rank()` (cached to a variable) instead of `len(s)` for case distinction. The difference is neglible, but slightly in favor of my code as it is here, with the array copy.


```
sage: m = (ZZ^3).random_element()
sage: %timeit m.cross_product_matrix()
10000 loops, best of 3: 166 µs per loop
sage: %timeit m.cross_product_matrix2()
10000 loops, best of 3: 169 µs per loop
sage: m = (ZZ^7).random_element()
sage: %timeit m.cross_product_matrix2()
1000 loops, best of 3: 187 µs per loop
sage: %timeit m.cross_product_matrix()
10000 loops, best of 3: 182 µs per loop
```


> Plus this is more robust if the behavior is changed to mimic `ZZ` (i.e., it always copies the elements). I might also consider adding the definition of `R` and `zero` inside of the 2 cases as well, but that is a definite micro-optimization.

Same argument as above: we'll need them in either of the defined cases, so let's share.

> Somewhat of a side note, constructing the basis might be an expensive operation. So if you don't really need it, then let's stay away from using it.

Glad you see it this way as well.

> Nice little patch; looks good otherwise.

Could I convince you? Will you give this a positive review even if I don't change anything?


---

Comment by tscrim created at 2015-01-26 22:52:06

Sorry, this had fallen off my todo list.

Replying to [comment:7 gagern]:
> I'd like to leave my commit as is, for the following reasons.
> 
> Replying to [comment:5 tscrim]:
> > A few comments. Please remove the `self` as input, it's not considered as such.
> 
> I'm somehow not sure this is universally accepted.
> 
> {{{
> $ git ls-files -z | xargs -0 grep -Ee '- +``self``[: ]' | wc -l
> 442
> }}}
> 
> While I agree that one can gain little from a description like “`self` is any object of the class we're talking about here”, the case at hand is somewhat different, since there are extra requirements for that object. Making them clear in the *INPUT* section seems important to me. If you still disagree, I'd like this discussed on the dev list, unless you can provide a convincing argument.
> 
> If this was already discussed on the list, I'd welcome some pointer. [This thread](https://groups.google.com/d/msg/sage-devel/wCYdiMFyiH8/i3rZwywv9AEJ) gives an example with `self` in the docstring, and noone objected. But the issue at hand was somethinbg different. [This post](https://groups.google.com/d/msg/sage-devel/087GdkT9n4g/Y9CIQwZBdiwJ) suggests documenting “anything special about self”, but it might be considered somewhat dated, or the opinion of a single person without any discussion about it. It certainly contradicts the first thread I referenced with regard to indentation.
> 
> So far I haven't found a discussion specifically about whether or not to include `self` in the *INPUT* section, and no developer guide document either.

Most (all?) of that is in legacy code, and unfortunately, I recall this discussion happening on a trac ticket and I don't remember which one. To me, the requirements are clear both from the preceding paragraph and the error message. Moreover, `self` is always referring to the class in question and is not given as part of the input of the _method_ (it is of the _function_ via the indirection, but that's a technical detail that a user isn't likely to know or care about IMO). Also it's a more general python thing: http://sphinxcontrib-napoleon.readthedocs.org/en/latest/example_google.html. If you think this still warrants a discussion on sage-devel, feel free to start one.

In the same vein, I'm not sure an `ArithmeticError` is the proper type of error as no arithmetic is being performed in contrast with `cross_product`. I'm thinking this should actually be a `ValueError` since the given object does not 

> > I would also consider using the `:wikipedia:`Hat_operator#Cross_product`` in the documentation.
> 
> Considered it, and tried it out. But in the HTML text the hash (anchor separator) looks ugly, and if I try to use it in the link target annotation it doesn't work at all.

The integrated link does look better.

> > A bit more substantial, I would instead check the rank by `self.parent().rank()` and define `s` inside of each of the 2 cases.
> 
> As I said, I'm not optimizing for the case where the operation is not defined, and in the other two cases we need the `s` array sooner or later, so it might as well be sooner.
> 
> > for `ZZ`, which always copies the list, this could result in a big speedup
> 
> The only way to avoid this list copy for the cases of rank 3 or 7 is by doing element access on `self` instead of a (possibly copied) list of entries. I did some comparison, my implementation against one (called `cross_product_matrix2`) which replaces every occurrence of `s[i]` by `self[i]`, does not set `s` at all, and uses `self.parent().rank()` (cached to a variable) instead of `len(s)` for case distinction. The difference is neglible, but slightly in favor of my code as it is here, with the array copy.

It's slightly interesting to me that the copy of the list is slower than the overhead of the `__getitem__`. However for sparse vectors, I noticed a clear slowdown by not using the list.

> Could I convince you? Will you give this a positive review even if I don't change anything?

I ended up getting ~10% speedup by using a direct call to `MatrixSpace`:

```
sage: m = (ZZ^7).random_element()
sage: %timeit m.cross_product_matrix()
1000 loops, best of 3: 507 µs per loop
```

Before:

```
sage: %timeit m.cross_product_matrix()
1000 loops, best of 3: 552 µs per loop
```

I also used the `self.parent().rank()` and put the creation of both the matrix space and getting the list inside each of the 2 statements because creating a parent can be a (relatively) expensive operation and same for the list. It's an extra 2 lines of (simple) code that could result in a major speedup in case someone was trying to call this method on a long vector and was catching the thrown error.
----
New commits:


---

Comment by jdemeyer created at 2015-02-10 09:45:12

Replying to [comment:8 tscrim]:
> In the same vein, I'm not sure an `ArithmeticError` is the proper type of error as no arithmetic is being performed in contrast with `cross_product`. I'm thinking this should actually be a `ValueError`

I would argue for `TypeError` actually. In Sage, `TypeError` is usually given for objects from the wrong parent. For example

```
sage: vector([1,2]) + vector([1,2,3])
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
...
TypeError: unsupported operand parent(s) for '+': 'Ambient free module of rank 2 over the principal ideal domain Integer Ring' and 'Ambient free module of rank 3 over the principal ideal domain Integer Ring'
```



---

Comment by chapoton created at 2015-08-09 12:23:28

needs rebase, does not apply


---

Comment by chapoton created at 2015-08-09 12:23:28

Changing status from needs_review to needs_work.


---

Comment by gagern created at 2015-08-26 08:25:21

Rebased, and changed the error for both `cross_product` and `cross_product_matrix` to `TypeError` as suggested.
----
New commits:


---

Comment by gagern created at 2015-08-26 08:25:21

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2015-08-27 03:08:34

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2015-08-27 03:08:34

LGTM. Thanks Martin and for your wisdom Jeroen.


---

Comment by vbraun created at 2015-08-28 01:20:32

Resolution: fixed
