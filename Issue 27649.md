# Issue 27649: Misc pip upgrades again

Issue created by migration from https://trac.sagemath.org/ticket/27886

Original creator: chapoton

Original creation time: 2019-05-28 18:41:50

CC:  slelievre vbraun embray jdemeyer fbissey

similar to #26969

What could be updated:

```
Babel                        2.6.0      2.7.0    wheel
backports.ssl-match-hostname 3.5.0.1    3.7.0.1  sdist
bleach                       3.0.2      3.1.0    wheel
certifi                      2018.11.29 2019.3.9 wheel
configparser                 3.5.0      3.7.4    wheel
cvxopt                       1.1.8      1.2.3    wheel
cypari2                      2.1.0      2.1.1    sdist
Cython                       0.29.5     0.29.8   wheel
decorator                    4.3.0      4.4.0    wheel
defusedxml                   0.5.0      0.6.0    wheel
entrypoints                  0.2.3      0.3      wheel
Flask                        0.10.1     1.0.3    wheel
Flask-AutoIndex              0.6        0.6.2    sdist
Flask-Babel                  0.9        0.12.2   sdist
ipykernel                    4.8.2      5.1.1    wheel
ipython                      5.8.0      7.5.0    wheel
Jinja2                       2.10       2.10.1   wheel
jsonschema                   2.6.0      3.0.1    wheel
kiwisolver                   1.0.1      1.1.0    wheel
MarkupSafe                   1.1.0      1.1.1    wheel
matplotlib                   2.2.3      3.1.0    wheel
nbconvert                    5.4.0      5.5.0    wheel
networkx                     2.2        2.3      sdist
notebook                     5.7.6      5.7.8    wheel
numpy                        1.16.1     1.16.3   wheel
packaging                    18.0       19.0     wheel
path.py                      7.1        12.0.1   wheel
pexpect                      4.6.0      4.7.0    wheel
Pillow                       5.3.0      6.0.0    wheel
pip                          18.1       19.1.1   wheel
pkgconfig                    1.4.0      1.5.1    wheel
prometheus-client            0.5.0      0.6.0    sdist
prompt-toolkit               1.0.15     2.0.9    wheel
psutil                       5.2.0      5.6.2    sdist
ptyprocess                   0.5.1      0.6.0    wheel
Pygments                     2.3.1      2.4.2    wheel
pyparsing                    2.3.0      2.4.0    wheel
python-dateutil              2.5.3      2.8.0    wheel
pytz                         2018.7     2019.1   wheel
pyzmq                        17.1.2     18.0.1   wheel
requests                     2.13.0     2.22.0   wheel
rpy2                         2.8.2      3.0.4    sdist
scandir                      1.9.0      1.10.0   sdist
scipy                        1.2.0      1.3.0    wheel
setuptools                   40.6.3     41.0.1   wheel
setuptools-scm               3.1.0      3.3.3    wheel
Sphinx                       1.8.5      2.0.1    wheel
sphinxcontrib-websupport     1.1.0      1.1.2    wheel
terminado                    0.8.1      0.8.2    wheel
tornado                      4.5.2      6.0.2    sdist
Twisted                      16.3.0     19.2.0   sdist
Werkzeug                     0.14.1     0.15.4   wheel
```



---

Comment by jhpalmieri created at 2019-05-28 20:53:52

Some of these are only for Python 3: `ipython`, `ipykernel`, `matplotlib`, `Sphinx`, `rpy2` (?), possibly others. In some cases (`matplotlib`, `rpy2`) we may be able to upgrade one or two minor versions and still maintain compatibility with Python 2, but we can't upgrade to the latest version yet.


---

Comment by slelievre created at 2019-05-28 22:29:04

To take into account py2 / py3, upgrade this:

```
package upstream             version    latest   wheel  py3     spkg name in Sage
official name                in Sage    py2-ok   sdist  only    if different
-------------------------------------------------------------------------------
Babel                        2.6.0      2.7.0    wheel          babel
backports.ssl-match-hostname 3.5.0.1    3.7.0.1  sdist          backports_ssl_match_hostname
bleach                       3.0.2      3.1.0    wheel
certifi                      2018.11.29 2019.3.9 wheel
configparser                 3.5.0      3.7.4    wheel
cvxopt                       1.1.8      1.2.3    wheel
cypari2                      2.1.0      2.1.1    sdist
Cython                       0.29.5     0.29.8   wheel          cython
decorator                    4.3.0      4.4.0    wheel
defusedxml                   0.5.0      0.6.0    wheel
entrypoints                  0.2.3      0.3      wheel
Flask                        0.10.1     1.0.3    wheel          flask
Flask-AutoIndex              0.6        0.6.2    sdist          flask_autoindex
Flask-Babel                  0.9        0.12.2   sdist          flask_babel
ipykernel                    4.8.2      4.10.0   wheel  5+
Jinja2                       2.10       2.10.1   wheel          jinja2
jsonschema                   2.6.0      3.0.1    wheel
kiwisolver                   1.0.1      1.1.0    wheel
MarkupSafe                   1.1.0      1.1.1    wheel          markupsafe
nbconvert                    5.4.0      5.5.0    wheel
networkx                     2.2        2.3      sdist
notebook                     5.7.6      5.7.8    wheel
numpy                        1.16.1     1.16.3   wheel
packaging                    18.0       19.0     wheel
path.py                      7.1        11.5.2   wheel  12+     pathpy
pexpect                      4.6.0      4.7.0    wheel
Pillow                       5.3.0      6.0.0    wheel          pillow
pip                          18.1       19.1.1   wheel
pkgconfig                    1.4.0      1.5.1    wheel
prometheus-client            0.5.0      0.6.0    sdist          prometheus_client
prompt-toolkit               1.0.15     2.0.9    wheel          prompt_toolkit
psutil                       5.2.0      5.6.2    sdist
ptyprocess                   0.5.1      0.6.0    wheel
Pygments                     2.3.1      2.4.2    wheel          pygments
pyparsing                    2.3.0      2.4.0    wheel
python-dateutil              2.5.3      2.8.0    wheel          dateutil
pytz                         2018.7     2019.1   wheel
pyzmq                        17.1.2     18.0.1   wheel
requests                     2.13.0     2.22.0   wheel
rpy2                         2.8.2      2.8.6    sdist  2.9+
scandir                      1.9.0      1.10.0   sdist
scipy                        1.2.0      1.2.1    wheel  1.3+
setuptools                   40.6.3     41.0.1   wheel
setuptools-scm               3.1.0      3.3.3    wheel          setuptools_scm
sphinxcontrib-websupport     1.1.0      1.1.2    wheel          sphinxcontrib_websupport
terminado                    0.8.1      0.8.2    wheel
tornado                      4.5.2      5.1.1    sdist  6+
Twisted                      16.3.0     19.2.0   sdist          twisted
Werkzeug                     0.14.1     0.15.4   wheel          werkzeug
```


Cannot upgrade this until we drop Python 2:

```
ipython                      5.8.0      5.8.0    wheel  6+
matplotlib                   2.2.3      2.2.3    wheel  3+
Sphinx                       1.8.5      1.8.5    wheel  2+     sphinx
```


Additional possible PyPI upgrades:

```
readline 6.3.008.p0 --> gnureadline 6.3.8
pyx 0.12.1.p0 --> 0.14.1
scons 1.2.0 --> 3.0.5
```



---

Comment by slelievre created at 2019-05-28 22:30:27

Changing component from PLEASE CHANGE to packages: standard.


---

Comment by jhpalmieri created at 2019-05-28 22:34:31

It looks to me as though matplotlib 2.2.4 would be okay for Python 2, but nothing beyond that.


---

Comment by fbissey created at 2019-05-28 23:19:16

Replying to [comment:4 jhpalmieri]:
> It looks to me as though matplotlib 2.2.4 would be okay for Python 2, but nothing beyond that.

Using it in sage-on-gentoo.


---

Comment by chapoton created at 2019-05-31 13:49:49

as in #26969, we may need to exclude "ptyprocess" and "tornado"

Volker, do you have an easy way to do this kind of batch upgrade, as you did it before ?


---

Comment by chapoton created at 2019-06-05 10:01:38

New commits:


---

Comment by git created at 2019-06-07 07:21:49

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2019-06-07 07:22:48

ok, maybe this is a good first step. Includes an update of cython.


---

Comment by chapoton created at 2019-06-07 07:22:48

Changing status from new to needs_review.


---

Comment by chapoton created at 2019-06-07 07:31:40

cypari does not build. Should I add back the cython trashcan patch ?


---

Comment by chapoton created at 2019-06-07 07:31:40

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-06-07 08:09:36

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2019-06-07 08:10:12

ok, I have added back the cython patch. Back to needs review.


---

Comment by chapoton created at 2019-06-07 08:10:12

Changing status from needs_work to needs_review.


---

Comment by slelievre created at 2019-06-07 08:39:48

Updating the ticket description to reflect the actual changes.


---

Comment by slelievre created at 2019-06-07 08:39:48

Changing keywords from "" to "upgrade, cython".


---

Comment by jhpalmieri created at 2019-06-07 20:06:37

Works for me on OS X, both Python 2 and 3. Others should try on other platforms.

Unfortunately it doesn't fix the Python 3 doctest failure in `cpython`.


---

Comment by chapoton created at 2019-06-10 16:40:16

Which failure remains in the cpython folder under python3 ? Both of these :

```
┣ debug.pyx  # 1
┗ dict_del_by_value.pyx  # 2
```

or just one ? The upgrade is supposed only to fix the second file. For the first one, see #27964


---

Comment by jhpalmieri created at 2019-06-10 18:55:20

I still get both failures. I'll try `make distclean` and then rebuild to see if that helps.


---

Comment by jhpalmieri created at 2019-06-10 19:57:38

After `make distclean`, same result: both files have failures.


---

Comment by chapoton created at 2019-06-10 19:59:52

And Jeroen, who knows about cython and prevented me to fix that in a naive way, seems not to be very active here at the moment.


---

Comment by jhpalmieri created at 2019-06-10 20:48:11

I see:

```
test_del_dictitem_by_exact_value(D, ZZ, 2)
```

fails, but

```
test_del_dictitem_by_exact_value(D, ZZ, int(2))
```

works. What was your naive fix? I would be tempted to use

```
test_del_dictitem_by_exact_value(D, ZZ, hash(2))
```

This is more robust, since it works in this kind of case:

```
sage: D = {1230981308409180310928308123: ZZ}
sage: test_del_dictitem_by_exact_value(D, ZZ, hash(1230981308409180310928308123))
```

while

```
sage: D = {1230981308409180310928308123: ZZ}
sage: test_del_dictitem_by_exact_value(D, ZZ, 1230981308409180310928308123)
```

fails with both Python 2 and 3. The current doctest relies on the fact that the hash of the Sage integer 2 is equal to 2, and this doesn't generalize to integers that are too large.


---

Comment by chapoton created at 2019-06-12 07:56:03

ok, I will do that in another ticket, thanks for the suggestion.

see #27972


---

Comment by jdemeyer created at 2019-06-12 09:29:33

The `test_del_dictitem_by_exact_value` failure is fixed upstream at https://github.com/cython/cython/commit/28251032f86c266065e4976080230481b1a1bb29

I suggest to just apply that patch instead of "fixing" the doctest.


---

Comment by chapoton created at 2019-06-12 11:38:30

But this is supposed to be in cython 0.29.3 ??

6 months ago, in #26855 you said : Fixed upstream, but not in a stable release


---

Comment by jdemeyer created at 2019-06-12 12:15:52

It's not fixed in a Cython bugfix release it seems, but only in the next major release.


---

Comment by jdemeyer created at 2019-06-12 12:24:40

...or maybe it was meant to be fixed in 0.29.x but forgotten.


---

Comment by git created at 2019-06-12 12:44:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2019-06-12 15:59:37

This change does fix the py3 doctest failures in `cpython/dict_del_by_value.pyx`. I was hoping it would fix some of the doctests in integer.pyx, but it doesn't seem to have done that.


---

Comment by jhpalmieri created at 2019-06-18 04:27:46

Let's merge this into an early 8.9 beta.


---

Comment by jhpalmieri created at 2019-06-18 04:27:46

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-06-27 20:13:28

Resolution: fixed
