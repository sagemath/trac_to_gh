# Issue 32199: sage-env, sage-build-env: No longer allow environment variables CC, CFLAGS, ... to override configured variables

Issue created by migration from https://trac.sagemath.org/ticket/32436

Original creator: mkoeppe

Original creation time: 2021-08-30 00:12:59

CC:  @kliem dimpase

This is an incompatible change to long-standing behavior of Sage, but the change will bring the build system in line with autotools and avoid confusing failures such as the one reported in: https://groups.google.com/g/sage-release/c/WX3m7T8-SeM/m/It62bpVpAgAJ

Bonus points if overriding CC, CFLAGS, ... will still be possible by passing them as makefile variables on the command line (`make CFLAGS="-gggg" build`)


---

Comment by dimpase created at 2021-08-30 11:35:52

so e.g. `FC=footran ./configure`
will have no effect?

This will need a bit of testing, as, iirc, some packages really need env vars set.


---

Comment by mkoeppe created at 2021-08-30 16:55:33

No, `FC=footran ./configure` (or `./configure FC=footran`) will of course use the variable.

But `FC=footran make` will not use the variable (except if it invokes `./configure --recheck`).


---

Comment by mkoeppe created at 2021-08-30 16:56:39

Replying to [comment:2 dimpase]:
> some packages really need env vars set.

Of course, that's why our build scripts (`sage-env`, `sage-build-env`) set them (to the configured values)


---

Comment by @kliem created at 2021-09-10 12:04:46

New commits:


---

Comment by @kliem created at 2021-09-10 12:04:46

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-09-10 23:10:41

Looking good except that this comment: 

```
 
 # The compilers are set in order of priority by
-# 1) environment variables
+# 1) given as make arguments (e.g. ``make CC=gcc``)
 # 2) compiler installed by sage
-# 3) compiler set at configuration time 
+# 3) compiler set at configuration time
 if [ -z "$CC" ]; then
```

is not quite accurate. Better to distinguish the cases `sage -buildsh` (or `make`) vs other uses


---

Comment by @kliem created at 2021-09-11 05:33:39

Replying to [comment:8 mkoeppe]:
> Looking good except that this comment: 
> {{{
>  
>  # The compilers are set in order of priority by
> -# 1) environment variables
> +# 1) given as make arguments (e.g. ``make CC=gcc``)
>  # 2) compiler installed by sage
> -# 3) compiler set at configuration time 
> +# 3) compiler set at configuration time
>  if [ -z "$CC" ]; then
> }}}
> is not quite accurate. Better to distinguish the cases `sage -buildsh` (or `make`) vs other uses

I don't understand. What do you think the correct comment would be?

Currently, `$CC`, `$FC`, `$CXX` are picked up for any use of `sage -...` and `make ...`.
The first modification is only possible with make (or in `sage --buildsh` and `sage -sh` after having started it).


---

Comment by mkoeppe created at 2021-12-18 19:53:12

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.


---

Comment by mkoeppe created at 2022-05-10 19:08:49

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2022-05-10 19:08:49

the branch doesn't look right - it removes src/bin/sage-env


---

Comment by mkoeppe created at 2022-05-18 00:39:45

Replying to [comment:12 mkoeppe]:
> the branch doesn't look right - it removes src/bin/sage-env
I think only the trac merger was confused


---

Comment by git created at 2022-05-18 00:39:58

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-05-18 00:40:07

Rebased.


---

Comment by mkoeppe created at 2022-05-18 00:46:16

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2022-05-19 23:11:17

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2022-05-19 23:11:17


```
    Traceback (most recent call last):
      File "/home/release/Sage/local/var/lib/sage/venv-python3.10.3/lib/python3.10/site-packages/sage/doctest/forker.py", line 695, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.10.3/lib/python3.10/site-packages/sage/doctest/forker.py", line 1093, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.structure.element.ElementWithCachedMethod[3]>", line 1, in <module>
        cython('\n'.join(cython_code))
      File "sage/misc/lazy_import.pyx", line 391, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:4256)
        return self.get_object()(*args, **kwds)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.10.3/lib/python3.10/site-packages/sage/misc/cython.py", line 661, in cython_compile
        return cython_import_all(tmpfile, get_globals(), **kwds)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.10.3/lib/python3.10/site-packages/sage/misc/cython.py", line 551, in cython_import_all
        m = cython_import(filename, **kwds)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.10.3/lib/python3.10/site-packages/sage/misc/cython.py", line 526, in cython_import
        name, build_dir = cython(filename, **kwds)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.10.3/lib/python3.10/site-packages/sage/misc/cython.py", line 405, in cython
        raise RuntimeError(msg.strip())
    RuntimeError: Command "-Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -g -O2 -fPIC -I/home/release/Sage -I/home/release/Sage/local/var/lib/sage/venv-python3.10.3/lib/python3.10/site-packages -I/home/release/Sage/local/var/lib/sage/venv-python3.10.3/lib/python3.10/site-packages/numpy/core/include -I/home/release/Sage/local/var/lib/sage/venv-python3.10.3/include/python3.10 -I/home/release/Sage/local/var/lib/sage/venv-python3.10.3/include/python3.10 -c /home/release/.sage/temp/zen/1157140/spyx/_home_release__sage_temp_zen_1157140_tmp_cc_94jp8_pyx/_home_release__sage_temp_zen_1157140_tmp_cc_94jp8_pyx_0.c -o /home/release/.sage/temp/zen/1157140/spyx/_home_release__sage_temp_zen_1157140_tmp_cc_94jp8_pyx/build/temp.linux-x86_64-3.10/home/release/.sage/temp/zen/1157140/spyx/_home_release__sage_temp_zen_1157140_tmp_cc_94jp8_pyx/_home_release__sage_temp_zen_1157140_tmp_cc_94jp8_pyx_0.o -w" failed with exit status 127
```



---

Comment by mkoeppe created at 2022-05-19 23:15:44

Full log please


---

Comment by mkoeppe created at 2022-05-20 01:43:41

Can't guess what exactly was done to provoke this error, but there is indeed a problem: Within a `sage -sh`, the `src/bin/sage` initializes `CC` etc. to empty and then `src/bin/sage-env` does not set `CC` because of `SAGE_ENV_SOURCED`.
