# Issue 32199: sage-env, sage-build-env: No longer allow environment variables CC, CFLAGS, ... to override configured variables

archive/issues_032199.json:
```json
{
    "body": "CC:  @kliem @dimpase\n\nThis is an incompatible change to long-standing behavior of Sage, but the change will bring the build system in line with autotools and avoid confusing failures such as the one reported in: https://groups.google.com/g/sage-release/c/WX3m7T8-SeM/m/It62bpVpAgAJ\n\nBonus points if overriding CC, CFLAGS, ... will still be possible by passing them as makefile variables on the command line (`make CFLAGS=\"-gggg\" build`)\n\nIssue created by migration from https://trac.sagemath.org/ticket/32436\n\n",
    "created_at": "2021-08-30T00:12:59Z",
    "labels": [
        "build",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "sage-env, sage-build-env: No longer allow environment variables CC, CFLAGS, ... to override configured variables",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32199",
    "user": "@mkoeppe"
}
```
CC:  @kliem @dimpase

This is an incompatible change to long-standing behavior of Sage, but the change will bring the build system in line with autotools and avoid confusing failures such as the one reported in: https://groups.google.com/g/sage-release/c/WX3m7T8-SeM/m/It62bpVpAgAJ

Bonus points if overriding CC, CFLAGS, ... will still be possible by passing them as makefile variables on the command line (`make CFLAGS="-gggg" build`)

Issue created by migration from https://trac.sagemath.org/ticket/32436





---

archive/issue_comments_460052.json:
```json
{
    "body": "so e.g. `FC=footran ./configure`\nwill have no effect?\n\nThis will need a bit of testing, as, iirc, some packages really need env vars set.",
    "created_at": "2021-08-30T11:35:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32199",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32199#issuecomment-460052",
    "user": "@dimpase"
}
```

so e.g. `FC=footran ./configure`
will have no effect?

This will need a bit of testing, as, iirc, some packages really need env vars set.



---

archive/issue_comments_460053.json:
```json
{
    "body": "No, `FC=footran ./configure` (or `./configure FC=footran`) will of course use the variable.\n\nBut `FC=footran make` will not use the variable (except if it invokes `./configure --recheck`).",
    "created_at": "2021-08-30T16:55:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32199",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32199#issuecomment-460053",
    "user": "@mkoeppe"
}
```

No, `FC=footran ./configure` (or `./configure FC=footran`) will of course use the variable.

But `FC=footran make` will not use the variable (except if it invokes `./configure --recheck`).



---

archive/issue_comments_460054.json:
```json
{
    "body": "Replying to [comment:2 dimpase]:\n> some packages really need env vars set.\n\nOf course, that's why our build scripts (`sage-env`, `sage-build-env`) set them (to the configured values)",
    "created_at": "2021-08-30T16:56:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32199",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32199#issuecomment-460054",
    "user": "@mkoeppe"
}
```

Replying to [comment:2 dimpase]:
> some packages really need env vars set.

Of course, that's why our build scripts (`sage-env`, `sage-build-env`) set them (to the configured values)



---

archive/issue_comments_460055.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-09-10T12:04:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32199",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32199#issuecomment-460055",
    "user": "@kliem"
}
```

New commits:



---

archive/issue_comments_460056.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-09-10T12:04:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32199",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32199#issuecomment-460056",
    "user": "@kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_460057.json:
```json
{
    "body": "Looking good except that this comment: \n\n```\n \n # The compilers are set in order of priority by\n-# 1) environment variables\n+# 1) given as make arguments (e.g. ``make CC=gcc``)\n # 2) compiler installed by sage\n-# 3) compiler set at configuration time \n+# 3) compiler set at configuration time\n if [ -z \"$CC\" ]; then\n```\n\nis not quite accurate. Better to distinguish the cases `sage -buildsh` (or `make`) vs other uses",
    "created_at": "2021-09-10T23:10:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32199",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32199#issuecomment-460057",
    "user": "@mkoeppe"
}
```

Looking good except that this comment: 

```
 
 # The compilers are set in order of priority by
-# 1) environment variables
+# 1) given as make arguments (e.g. ``make CC=gcc``)
 # 2) compiler installed by sage
-# 3) compiler set at configuration time 
+# 3) compiler set at configuration time
 if [ -z "$CC" ]; then
```

is not quite accurate. Better to distinguish the cases `sage -buildsh` (or `make`) vs other uses



---

archive/issue_comments_460058.json:
```json
{
    "body": "Replying to [comment:8 mkoeppe]:\n> Looking good except that this comment: \n> {{{\n>  \n>  # The compilers are set in order of priority by\n> -# 1) environment variables\n> +# 1) given as make arguments (e.g. ``make CC=gcc``)\n>  # 2) compiler installed by sage\n> -# 3) compiler set at configuration time \n> +# 3) compiler set at configuration time\n>  if [ -z \"$CC\" ]; then\n> }}}\n> is not quite accurate. Better to distinguish the cases `sage -buildsh` (or `make`) vs other uses\n\nI don't understand. What do you think the correct comment would be?\n\nCurrently, `$CC`, `$FC`, `$CXX` are picked up for any use of `sage -...` and `make ...`.\nThe first modification is only possible with make (or in `sage --buildsh` and `sage -sh` after having started it).",
    "created_at": "2021-09-11T05:33:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32199",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32199#issuecomment-460058",
    "user": "@kliem"
}
```

Replying to [comment:8 mkoeppe]:
> Looking good except that this comment: 
> {{{
>  
>  # The compilers are set in order of priority by
> -# 1) environment variables
> +# 1) given as make arguments (e.g. ``make CC=gcc``)
>  # 2) compiler installed by sage
> -# 3) compiler set at configuration time 
> +# 3) compiler set at configuration time
>  if [ -z "$CC" ]; then
> }}}
> is not quite accurate. Better to distinguish the cases `sage -buildsh` (or `make`) vs other uses

I don't understand. What do you think the correct comment would be?

Currently, `$CC`, `$FC`, `$CXX` are picked up for any use of `sage -...` and `make ...`.
The first modification is only possible with make (or in `sage --buildsh` and `sage -sh` after having started it).



---

archive/issue_comments_460059.json:
```json
{
    "body": "Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.",
    "created_at": "2021-12-18T19:53:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32199",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32199#issuecomment-460059",
    "user": "@mkoeppe"
}
```

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.



---

archive/issue_comments_460060.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-05-10T19:08:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32199",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32199#issuecomment-460060",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_460061.json:
```json
{
    "body": "the branch doesn't look right - it removes src/bin/sage-env",
    "created_at": "2022-05-10T19:08:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32199",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32199#issuecomment-460061",
    "user": "@mkoeppe"
}
```

the branch doesn't look right - it removes src/bin/sage-env



---

archive/issue_comments_460062.json:
```json
{
    "body": "Replying to [comment:12 mkoeppe]:\n> the branch doesn't look right - it removes src/bin/sage-env\nI think only the trac merger was confused",
    "created_at": "2022-05-18T00:39:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32199",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32199#issuecomment-460062",
    "user": "@mkoeppe"
}
```

Replying to [comment:12 mkoeppe]:
> the branch doesn't look right - it removes src/bin/sage-env
I think only the trac merger was confused



---

archive/issue_comments_460063.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-05-18T00:39:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32199",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32199#issuecomment-460063",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_460064.json:
```json
{
    "body": "Rebased.",
    "created_at": "2022-05-18T00:40:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32199",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32199#issuecomment-460064",
    "user": "@mkoeppe"
}
```

Rebased.



---

archive/issue_comments_460065.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2022-05-18T00:46:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32199",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32199#issuecomment-460065",
    "user": "@mkoeppe"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_460066.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2022-05-19T23:11:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32199",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32199#issuecomment-460066",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_460067.json:
```json
{
    "body": "\n```\n    Traceback (most recent call last):\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.10.3/lib/python3.10/site-packages/sage/doctest/forker.py\", line 695, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.10.3/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1093, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.structure.element.ElementWithCachedMethod[3]>\", line 1, in <module>\n        cython('\\n'.join(cython_code))\n      File \"sage/misc/lazy_import.pyx\", line 391, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:4256)\n        return self.get_object()(*args, **kwds)\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.10.3/lib/python3.10/site-packages/sage/misc/cython.py\", line 661, in cython_compile\n        return cython_import_all(tmpfile, get_globals(), **kwds)\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.10.3/lib/python3.10/site-packages/sage/misc/cython.py\", line 551, in cython_import_all\n        m = cython_import(filename, **kwds)\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.10.3/lib/python3.10/site-packages/sage/misc/cython.py\", line 526, in cython_import\n        name, build_dir = cython(filename, **kwds)\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.10.3/lib/python3.10/site-packages/sage/misc/cython.py\", line 405, in cython\n        raise RuntimeError(msg.strip())\n    RuntimeError: Command \"-Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -g -O2 -fPIC -I/home/release/Sage -I/home/release/Sage/local/var/lib/sage/venv-python3.10.3/lib/python3.10/site-packages -I/home/release/Sage/local/var/lib/sage/venv-python3.10.3/lib/python3.10/site-packages/numpy/core/include -I/home/release/Sage/local/var/lib/sage/venv-python3.10.3/include/python3.10 -I/home/release/Sage/local/var/lib/sage/venv-python3.10.3/include/python3.10 -c /home/release/.sage/temp/zen/1157140/spyx/_home_release__sage_temp_zen_1157140_tmp_cc_94jp8_pyx/_home_release__sage_temp_zen_1157140_tmp_cc_94jp8_pyx_0.c -o /home/release/.sage/temp/zen/1157140/spyx/_home_release__sage_temp_zen_1157140_tmp_cc_94jp8_pyx/build/temp.linux-x86_64-3.10/home/release/.sage/temp/zen/1157140/spyx/_home_release__sage_temp_zen_1157140_tmp_cc_94jp8_pyx/_home_release__sage_temp_zen_1157140_tmp_cc_94jp8_pyx_0.o -w\" failed with exit status 127\n```\n",
    "created_at": "2022-05-19T23:11:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32199",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32199#issuecomment-460067",
    "user": "@vbraun"
}
```


```
    Traceback (most recent call last):
      File "/home/release/Sage/local/var/lib/sage/venv-python3.10.3/lib/python3.10/site-packages/sage/doctest/forker.py", line 695, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.10.3/lib/python3.10/site-packages/sage/doctest/forker.py", line 1093, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.structure.element.ElementWithCachedMethod[3]>", line 1, in <module>
        cython('\n'.join(cython_code))
      File "sage/misc/lazy_import.pyx", line 391, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:4256)
        return self.get_object()(*args, **kwds)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.10.3/lib/python3.10/site-packages/sage/misc/cython.py", line 661, in cython_compile
        return cython_import_all(tmpfile, get_globals(), **kwds)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.10.3/lib/python3.10/site-packages/sage/misc/cython.py", line 551, in cython_import_all
        m = cython_import(filename, **kwds)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.10.3/lib/python3.10/site-packages/sage/misc/cython.py", line 526, in cython_import
        name, build_dir = cython(filename, **kwds)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.10.3/lib/python3.10/site-packages/sage/misc/cython.py", line 405, in cython
        raise RuntimeError(msg.strip())
    RuntimeError: Command "-Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -g -O2 -fPIC -I/home/release/Sage -I/home/release/Sage/local/var/lib/sage/venv-python3.10.3/lib/python3.10/site-packages -I/home/release/Sage/local/var/lib/sage/venv-python3.10.3/lib/python3.10/site-packages/numpy/core/include -I/home/release/Sage/local/var/lib/sage/venv-python3.10.3/include/python3.10 -I/home/release/Sage/local/var/lib/sage/venv-python3.10.3/include/python3.10 -c /home/release/.sage/temp/zen/1157140/spyx/_home_release__sage_temp_zen_1157140_tmp_cc_94jp8_pyx/_home_release__sage_temp_zen_1157140_tmp_cc_94jp8_pyx_0.c -o /home/release/.sage/temp/zen/1157140/spyx/_home_release__sage_temp_zen_1157140_tmp_cc_94jp8_pyx/build/temp.linux-x86_64-3.10/home/release/.sage/temp/zen/1157140/spyx/_home_release__sage_temp_zen_1157140_tmp_cc_94jp8_pyx/_home_release__sage_temp_zen_1157140_tmp_cc_94jp8_pyx_0.o -w" failed with exit status 127
```




---

archive/issue_comments_460068.json:
```json
{
    "body": "Full log please",
    "created_at": "2022-05-19T23:15:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32199",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32199#issuecomment-460068",
    "user": "@mkoeppe"
}
```

Full log please



---

archive/issue_comments_460069.json:
```json
{
    "body": "Can't guess what exactly was done to provoke this error, but there is indeed a problem: Within a `sage -sh`, the `src/bin/sage` initializes `CC` etc. to empty and then `src/bin/sage-env` does not set `CC` because of `SAGE_ENV_SOURCED`.",
    "created_at": "2022-05-20T01:43:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32199",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32199#issuecomment-460069",
    "user": "@mkoeppe"
}
```

Can't guess what exactly was done to provoke this error, but there is indeed a problem: Within a `sage -sh`, the `src/bin/sage` initializes `CC` etc. to empty and then `src/bin/sage-env` does not set `CC` because of `SAGE_ENV_SOURCED`.
