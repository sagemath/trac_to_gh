# Issue 14390: dot2tex not detected any longer

Issue created by migration from https://trac.sagemath.org/ticket/14594

Original creator: aschilling

Original creation time: 2013-05-15 16:30:14

Assignee: sage-combinat

CC:  sage-combinat

Keywords: dot2tex

Since sage-5.10.beta2 there is a problem with the detection of dot2tex. Even with dot2tex installed  via

```
    sage -f http://sage.math.washington.edu/home/nthiery/dot2tex-2.8.7-2.spkg
```

it is not detected any longer:

```
    sage: import dot2tex
    ...
    ImportError: No module named pyparsing
```

This is crucial though since in combinatorics we heavily rely on being able to draw pictures:

```
    sage: B = CrystalOfTableaux(['A',2],shape=[1])
    sage: view(B)
    dot2tex not available.  Install after running 'sage -sh'
```



---

Comment by tscrim created at 2013-05-17 07:07:43

Some things I've tried:

- installing pyparsing on my system directly (on ubuntu)
- installing pyparsing 1.5.5 using `sage -sh` as:
  {{{
  easy_install http://cheeseshop.python.org/packages/source/p/pyparsing/pyparsing-1.5.5.tar.gz
  }}}
  I also tried `easy_install pyparsing` but that just returned an error (likely because of it being python 3).

I'm guessing we will need to make it a spkg?

Best,

Travis

PS - I haven't tried restarting my system after trying these, but I don't think anything will change. If it does work, I'll post, otherwise it didn't.


---

Comment by tscrim created at 2013-05-17 19:15:27

Changing priority from major to blocker.


---

Comment by tscrim created at 2013-05-17 19:15:27

I think this should be a blocker since none of the crystal pictures/latex work anymore.


---

Comment by leif created at 2013-05-17 23:25:36

Replying to [ticket:14594 aschilling]:
> {{{
>     ImportError: No module named pyparsing
> }}}
> dot2tex indeed needs pyparsing. And pyparsing used to ship with
> matplotlib, but apparently the new version of matplotlib does not
> include it anymore.

MPL now ships with `pyparsing_py2` and `pyparsing_py3`, so apparently simply `dot2tex`'s import statement has to be changed.


```
----------------------------------------------------------------------
----------------------------------------------------------------------
**********************************************************************
*                                                                    *
* Warning: this is a prerelease version, and it may be unstable.     *
*                                                                    *
**********************************************************************
sage: from matplotlib import pyparsing_py2
sage: 
```



---

Comment by leif created at 2013-05-18 00:03:08

FWIW, installing `dot2tex` with `SAGE_CHECK=yes` _does_ fail, and without just succeeds because of

```
.../sage-5.10.beta3/local/lib/python/distutils/dist.py:267: UserWarning: Unknown distribution option: 'install_requires'
  warnings.warn(msg)
running install
running build
running build_py
running build_scripts
running install_lib
...
```

i.e.,

```python
      install_requires = ['matplotlib.pyparsing'],
```

in (the patched) `setup.py` simply doesn't work.


---

Comment by leif created at 2013-05-18 02:54:15

Tentative fixed spkg:  http://boxen.math.washington.edu/home/leif/Sage/spkgs/dot2tex-2.8.7-2.p1.spkg

Works for me, modulo not all tests passing (`SAGE_CHECK=yes`, but I've also changed `spkg-check` to fail on _any_ test suite error).

Since the original spkg doesn't conform to the usual conventions (naming, style of `SPKG.txt`, `src/` not in `.hgignore` and hence all upstream files under revision control as well), I haven't updated `SPKG.txt`, nor committed any changes.  (Diff is attached.)


---

Comment by leif created at 2013-05-18 02:57:56

Changing status from new to needs_review.


---

Comment by leif created at 2013-05-18 03:10:13

New version of `patches/use-matplotlib-pyparsing.patch`.  For reference / review only (as the spkg diff looks pretty ugly).


---

Attachment

Hey Leif,

Thank you for fixing this. That works for me as well and all the tests in the `combinat/crystals` folder. I'll run all tests later tonight.

Thanks,

Travis


---

Comment by jdemeyer created at 2013-05-19 08:39:35

Changing priority from blocker to critical.


---

Comment by jdemeyer created at 2013-05-19 08:41:56

What exactly needs review? Please update the ticket description.


---

Comment by leif created at 2013-05-19 09:34:59

Replying to [comment:10 jdemeyer]:
> What exactly needs review? Please update the ticket description.

Just that the new (optional) dot2tex spkg works with both the old and the new matplotlib spkg (in Sage 5.10.beta0 and later), but see [comment:6 my note above], i.e., it's not yet ready to get "merged".


---

Comment by jdemeyer created at 2013-05-19 10:18:36

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2013-05-19 10:21:21

Changing component from combinatorics to packages: optional.


---

Comment by leif created at 2013-05-19 18:23:56

I'd also like to get some feedback w.r.t. `spkg-check`;  it now (IMHO correctly) returns an error if _any_ of the tests failed, while it previously only did if _the last_ failed.

Haven't investigated, but it seems at least some of the tests (`src/tests/test_*`) have prerequisites not commonly installed, and presumably not necessary for (typical) use with Sage.

It probably makes sense to exclude these by simply changing the pattern, or explicitly listing only those reasonable for Sage's purposes.

P.S.:  Just noticed there are _only four_ test files, so we may actually have to _modify_ some of them instead of simply excluding them.




Feel free to forward this to sage-combinat-devel ... :P


---

Comment by leif created at 2013-05-19 18:33:20

Changing keywords from "dot2tex" to "dot2tex spkg pyparsing".


---

Comment by nthiery created at 2013-05-19 21:56:44

Replying to [comment:4 leif]:
> MPL now ships with `pyparsing_py2` and `pyparsing_py3`, so apparently simply `dot2tex`'s import statement has to be changed.

I had actually made a search in the new matplotlib, but looking for
pyparsing.py so I missed it ... Well, that's very good news! Thanks
so much for investigating and for working on the spkg!

Cheers,
                           Nicolas


---

Comment by nthiery created at 2013-05-19 22:04:07

Replying to [comment:6 leif]:
> Tentative fixed spkg:  http://boxen.math.washington.edu/home/leif/Sage/spkgs/dot2tex-2.8.7-2.p1.spkg

Just checking: did you start from the latest spkg dot2tex-2.8.6.2 advertised on #7004 (see #13624)?
Otherwise we should merge the two spkgs.

By the way: what about using the occasion to make dot2tex a standard package? After all, it's very small, it's used quite extensively, and that would be a good step toward simplifying the installation instructions for graph drawing with graphviz.

Cheers,
                                        Nicolas


---

Comment by nthiery created at 2013-05-19 22:10:10

Replying to [comment:14 leif]:
> I'd also like to get some feedback w.r.t. `spkg-check`;  it now (IMHO correctly) returns an error if _any_ of the tests failed, while it previously only did if _the last_ failed.

+1

> Haven't investigated, but it seems at least some of the tests (`src/tests/test_*`) have prerequisites not commonly installed, and presumably not necessary for (typical) use with Sage.

I haven't looked at them recently; is there anything beyond graphviz and latex's preview package?
Maybe the tkz-berge and friend style files?

For those, it would actually be good to ship them with the standard Sage installation, for they are tiny and required for tikz graph drawing without dot2tex, and yet a pain to install by hand. But that might be another ticket.

What do you think?

> It probably makes sense to exclude these by simply changing the pattern, or explicitly listing only those reasonable for Sage's purposes.
> 
> P.S.:  Just noticed there are _only four_ test files, so we may actually have to _modify_ some of them instead of simply excluding them.

Both options are fine for me, with a small preference for the first
one which does not require touching the upstream sources.

Cheers,
                                     Nicolas


---

Comment by leif created at 2013-05-19 22:38:47

Replying to [comment:17 nthiery]:
> Replying to [comment:6 leif]:
> > Tentative fixed spkg:  http://boxen.math.washington.edu/home/leif/Sage/spkgs/dot2tex-2.8.7-2.p1.spkg
> 
> Just checking: did you start from the latest spkg dot2tex-2.8.6.2 advertised on #7004 (see #13624)?

Nope, at least I'm not sure; #7004 mentions some 2.8.7-dev spkg (ticket "merged" long time ago), but I took the one from the optional spkgs repository:

[http://sagemath.org/packages/optional/dot2tex-2.8.7-2.spkg](http://sagemath.org/packages/optional/dot2tex-2.8.7-2.spkg) (or probably the one with the same name mentioned in the ticket's description, I don't recall.)

(I wasn't aware of other pending(?) changes.)




> Otherwise we should merge the two spkgs.

Probably...  I just created a new clean one (named `dot2tex-2.8.7.p1.spkg`) from the above, which doesn't include my changes [except for `.hgignore`], where I removed all traces of upstream from the Mercurial history, and added tags for a `2.8.7.p0` and the `.p1`.  `src/` is (still) *vanilla* upstream version 2.8.7 (released "stable", no svn version).

I was going to add my changes (and some clean-up of `SPKG.txt`) into a `.p2` based on that `.p1`.

I can of course add further changes later on top of that, probably into a `.p3`, if you just tell me what these changes are ...  (Portions from upstream's devel version, which we could also add as patches, or just Sage-specific patches, changes to `spkg-{install,check}`?)




> By the way: what about using the occasion to make dot2tex a standard package? After all, it's very small, it's used quite extensively, and that would be a good step toward simplifying the installation instructions for graph drawing with graphviz.

I thought it was (or had to be) optional because of its MIT license, but IANAL.

Otherwise my new one with `src/` in `.hgignore` is only a fraction of the size of the previous one: :-D

```
3,1M	        dot2tex-2.8.7-2.spkg
944K        dot2tex-2.8.7.p1.spkg
```



---

Comment by leif created at 2013-05-19 22:40:50

Replying to [comment:19 leif]:
> Replying to [comment:17 nthiery]:
> > Just checking: did you start from the latest spkg dot2tex-2.8.6.2 advertised on #7004 (see #13624)?
> 
> Nope, at least I'm not sure; #7004 mentions some 2.8.7-dev spkg (ticket "merged" long time ago), but I took the one from the optional spkgs repository:
> 
> [http://sagemath.org/packages/optional/dot2tex-2.8.7-2.spkg](http://sagemath.org/packages/optional/dot2tex-2.8.7-2.spkg) (or probably the one with the same name mentioned in the ticket's description, I don't recall.)

Just checked, I grabbed the former, if that matters...


---

Comment by leif created at 2013-05-19 22:46:11

Replying to [comment:20 leif]:
> > [http://sagemath.org/packages/optional/dot2tex-2.8.7-2.spkg](http://sagemath.org/packages/optional/dot2tex-2.8.7-2.spkg) (or probably the one with the same name mentioned in the ticket's description, I don't recall.)
> 
> Just checked, I grabbed the former, if that matters...

It doesn't:

```sh
$ md5sum /home/nthiery/dot2tex-2.8.7-2.spkg /home/sagemath/www-files/packages/optional/dot2tex-2.8.7-2.spkg 
42bfb0deecb56386ef29e74235c947cf  /home/nthiery/dot2tex-2.8.7-2.spkg
42bfb0deecb56386ef29e74235c947cf  /home/sagemath/www-files/packages/optional/dot2tex-2.8.7-2.spkg
```


But now I see there's also the newer

```
-rw-r--r-- 1 nthiery nthiery 3783363 2013-04-02 07:16 /home/nthiery/dot2tex-2.8.7-dev.spkg
```


I'll take a look at that later ...


---

Comment by leif created at 2013-05-19 23:20:10

Replying to [comment:21 leif]:
> But now I see there's also the newer
> {{{
> -rw-r--r-- 1 nthiery nthiery 3783363 2013-04-02 07:16 /home/nthiery/dot2tex-2.8.7-dev.spkg
> }}}
> 
> I'll take a look at that later ...

I see:

```
changeset:   9:829fa7be9e52
tag:         tip
user:        Nicolas M. Thiery <nthiery@users.sf.net>
date:        Thu Apr 28 13:14:30 2011 -0400
files:       SPKG.txt patches/fix-stdout-redirection.patch spkg-install
description:
Removed now unneeded patches/fix-stdout-redirection.patch


changeset:   8:c3a62788e000
user:        Nicolas M. Thiery <nthiery@users.sf.net>
date:        Thu Apr 28 09:58:33 2011 -0400
files:       SPKG.txt src/MANIFEST.in src/changelog.txt src/doc/img/dot2texiex1.png src/doc/img/dot2texiex2.png src/doc/pdf/balls.pdf src/doc/pdf/consistent.pdf src/doc/pdf/dot2texiex1.pdf src/doc/pdf/dot2texiex2.pdf src/doc/pdf/ex1comb.pdf src/doc/pdf/ex1gstyle.pdf src/doc/pdf/ex1huge.pdf src/doc/pdf/ex2.pdf src/doc/pdf/fsm1.pdf src/doc/pdf/lblstyle.pdf src/doc/pdf/nodewidth1.pdf src/doc/pdf/nodewidth2.pdf src/doc/pdf/pgfarrows.pdf src/doc/pdf/pgftikzsimple.pdf src/doc/pdf/preproc1a.pdf src/doc/pdf/preproc1b.pdf src/doc/pdf/pstarrows.pdf src/doc/pdf/texmode.pdf src/doc/pdf/texmodeb.pdf src/doc/pdf/tikzedgelabels.pdf src/doc/pdf/topaths1.pdf src/doc/pdf/valignmode0.pdf src/doc/pdf/valignmode1.pdf src/doc/pdf/valignmode2.pdf src/doc/pdf/valignmode3.pdf src/dot2tex/__init__.py src/dot2tex/dot2tex.py src/dot2tex/dotparsing.py src/readme.txt src/setup.py src/tests/test_dot2tex.py src/tests/test_dotparsing.py src/tests/test_graphparsing.py
description:
Updated to dot2tex-2.8.7-dev


changeset:   7:dccc7b29ec0b
user:        Nicolas M. Thiery <nthiery@users.sf.net>
date:        Sat Apr 17 22:48:38 2010 +0200
files:       SPKG.txt patches/fix-stdout-redirection.patch spkg-check spkg-install
description:
Added patches/fix-stdout-redirection.patch and fixed partially spkg-check

...
```


Changeset !#7 corresponds to the `dot2tex-2.8.7-2` spkg, so you mainly updated to some devel version, thereby removing a patch.


---

Comment by leif created at 2013-05-20 00:13:06

And now also found #14408 ... (for the `-dev` spkg)


---

Comment by nthiery created at 2013-05-20 01:26:30

Replying to [comment:22 leif]:
> Changeset !#7 corresponds to the `dot2tex-2.8.7-2` spkg, so you
> mainly updated to some devel version, thereby removing a patch.

Yes indeed! The devel version also fixes the issue mentioned
in #14408. You can grab the latest version from:

	http://code.google.com/p/dot2tex/source/

Again, thanks so much for handling this! I'll be happy to review it.

Cheers,
                                Nicolas


---

Comment by leif created at 2013-05-20 20:37:27

Replying to [comment:18 nthiery]:
> Replying to [comment:14 leif]:
> > I'd also like to get some feedback w.r.t. `spkg-check`;  it now (IMHO correctly) returns an error if _any_ of the tests failed, while it previously only did if _the last_ failed.
> 
> +1
> 
> > Haven't investigated, but it seems at least some of the tests (`src/tests/test_*`) have prerequisites not commonly installed, and presumably not necessary for (typical) use with Sage.
> 
> I haven't looked at them recently; is there anything beyond graphviz and latex's preview package?
> Maybe the tkz-berge and friend style files?

After having installed `pdftk`, `spkg-check` still fails for me at least because of

```
IOError: [Errno 2] No such file or directory: 'testgraphs/parsetests/current.dot'
IOError: [Errno 2] No such file or directory: 'testgraphs/parsetests/ports.dot'
IOError: [Errno 2] No such file or directory: 'testgraphs/parsetests/unicode1.dot'
```

which doesn't seem to be a regression ...  8-/

They're missing in the original 2.8.7-2 spkg as well as in upstream's 2.8.7 release tarball.  But perhaps _I'm_ just missing something...

Did anyone recently (or ever ;-) ) successfully install the spkg with `SAGE_CHECK=yes`?




> > It probably makes sense to exclude these by simply changing the pattern, or explicitly listing only those reasonable for Sage's purposes.
> > 
> > P.S.:  Just noticed there are _only four_ test files, so we may actually have to _modify_ some of them instead of simply excluding them.
> 
> Both options are fine for me, with a small preference for the first
> one which does not require touching the upstream sources.


---

Comment by leif created at 2013-05-20 21:59:01

Replying to [comment:25 leif]:
> After having installed `pdftk`, `spkg-check` still fails for me at least because of
> {{{
> IOError: [Errno 2] No such file or directory: 'testgraphs/parsetests/current.dot'
> IOError: [Errno 2] No such file or directory: 'testgraphs/parsetests/ports.dot'
> IOError: [Errno 2] No such file or directory: 'testgraphs/parsetests/unicode1.dot'
> }}}
> which doesn't seem to be a regression ...  8-/
> 
> They're missing in the original 2.8.7-2 spkg as well as in upstream's 2.8.7 release tarball.

I didn't find any traces of those three files in the svn nor the Mercurial repo.

So we could patch out the last three tests in `tests/test_comparedotparsing.py`:

```python
class DotparsingTest(unittest.TestCase):
    def setUp(self):
        if not os.path.exists(PNG_DIR):
            os.mkdir(PNG_DIR)
        if not os.path.exists(DOT_DIR):
            os.mkdir(DOT_DIR)

    def test_ids(self):
        self.assertEqual(test_dotfile("ids.dot"),1)
    def test_multilines(self):
        self.assertEqual(test_dotfile("multilines.dot"),1)
    def test_subgraphs(self):
        self.assertEqual(test_dotfile("subgraphs.dot"),1)
    def test_quoting(self):
        self.assertEqual(test_dotfile("quoting.dot"),1)
    def test_unicode1(self):
        self.assertEqual(test_dotfile("unicode1.dot"),1)
    def test_current(self):
        self.assertEqual(test_dotfile("current.dot"),1)
    def test_ports(self):
        self.assertEqual(test_dotfile("ports.dot"),1)
```

(Note that these tests are still present even in the latest versions; actually, the whole file hasn't changed at all since at least when the Mercurial repo was created.)

Or _someone<sup>TM</sup>_ would have to create the missing reference files...


---

Comment by leif created at 2013-05-20 22:00:06

Changing status from needs_work to needs_info.


---

Comment by leif created at 2013-05-21 01:10:54

Another dumb thing:

`tests/test_buildexamples.py` apparently fails just because the examples are built in the wrong order.

The generated `graphofgraphs.tex` includes a couple of PDFs built by other examples, but that fails in the first place.  (Rerunning it with the other temporary files in `tests/exrender/` still present works.) 

Besides that, `spkg-check` now succeeds for me (skipping the above-mentioned comparisons to non-existent reference files).


---

Comment by nthiery created at 2013-05-21 01:31:10

It's kind of you to be investigating those failing tests, but we don't need them. So I would say: just report upstream and skip them.

Thanks!
                               Nicolas


---

Comment by leif created at 2013-05-21 03:04:01

Doctesting the Sage library (5.10.beta3) with `sage -t --long --optional=dot2tex ...`, I get:

```
----------------------------------------------------------------------
sage -t --long devel/sage/sage/combinat/rigged_configurations/kleber_tree.py  # 1 doctest failed
sage -t --long devel/sage/sage/categories/crystals.py  # 2 doctests failed
sage -t --long devel/sage/sage/graphs/digraph.py  # 1 doctest failed
sage -t --long devel/sage/sage/graphs/generic_graph.py  # 43 doctests failed
sage -t --long devel/sage/sage/graphs/graph.py  # 5 doctests failed
sage -t --long devel/sage/sage/graphs/graph_latex.py  # 3 doctests failed
----------------------------------------------------------------------
```

Most of these presumably due to wrong tagging (`NameError: name 'foo' is not defined`).

With `--optional=dot2tex,sage` in contrast, only the following doctest error:

```
**********************************************************************
File "devel/sage/sage/combinat/rigged_configurations/kleber_tree.py", line 387, in sage.combinat.rigged_configurations.kleber_tree.KleberTree._latex_
Failed example:
    KT._latex_()   #optional - dot2tex
Expected nothing
Got:
    '\n\\begin{tikzpicture}[>=latex,line join=bevel,]\n%%\n\\node (Klebertreenodewithweight1+0+0andupwardsedgeroot0+1+0) at (13bp,82bp) [draw,draw=none] {$V_{\\omega_{1}}$};\n  \\node (Klebertreenodewithweight0+2+0andupwardsedgeroot0+0+0) at (13bp,8bp) [draw,draw=none] {$V_{2\\omega_{2}}$};\n  \\draw [black,->] (Klebertreenodewithweight1+0+0andupwardsedgeroot0+1+0) ..controls (13bp,63bp) and (13bp,42bp)  .. (Klebertreenodewithweight0+2+0andupwardsedgeroot0+0+0);\n  \\pgfsetstrokecolor{black}\n  \\draw (35bp,45bp) node {$\\left(0, 1, 0\\right)$};\n%\n\\end{tikzpicture}\n'
**********************************************************************
1 item had failures:
   1 of   3 in sage.combinat.rigged_configurations.kleber_tree.KleberTree._latex_
```

:-)




It seems there are no dot2tex-optional tests in the documentation (`*.rst`):

```
Doctesting 3 files.
sage -t --long devel/sage/doc/en/thematic_tutorials/lie/affine_hw_crystals.rst
    [0 tests, 0.00 s]
sage -t --long devel/sage/doc/en/thematic_tutorials/lie/affine_finite_crystals.rst
    [0 tests, 0.02 s]
sage -t --long devel/sage/doc/en/thematic_tutorials/lie/crystals.rst
    [0 tests, 0.03 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
```

But, ooops, just noticed they're tagged `# optional - dot2tex graphviz`...

Same problem without adding `sage` to the `--optional` list:

```
----------------------------------------------------------------------
sage -t --long devel/sage/doc/en/thematic_tutorials/lie/affine_hw_crystals.rst  # 2 doctests failed
sage -t --long devel/sage/doc/en/thematic_tutorials/lie/affine_finite_crystals.rst  # 1 doctest failed
sage -t --long devel/sage/doc/en/thematic_tutorials/lie/crystals.rst  # 2 doctests failed
----------------------------------------------------------------------
```

Again, with `--optional=dot2tex,graphviz,sage`:

```
Doctesting 3 files.
sage -t --long devel/sage/doc/en/thematic_tutorials/lie/affine_hw_crystals.rst
    [14 tests, 17.73 s]
sage -t --long devel/sage/doc/en/thematic_tutorials/lie/affine_finite_crystals.rst
    [97 tests, 22.79 s]
sage -t --long devel/sage/doc/en/thematic_tutorials/lie/crystals.rst
    [116 tests, 45.62 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
```

... but I also get five pop-up windows showing `sage.pdf`! XD


---

Comment by aschilling created at 2013-05-21 03:28:42

> It seems there are no dot2tex-optional tests in the documentation (`*.rst`):
> {{{
> Doctesting 3 files.
> sage -t --long devel/sage/doc/en/thematic_tutorials/lie/affine_hw_crystals.rst
>     [0 tests, 0.00 s]
> sage -t --long devel/sage/doc/en/thematic_tutorials/lie/affine_finite_crystals.rst
>     [0 tests, 0.02 s]
> sage -t --long devel/sage/doc/en/thematic_tutorials/lie/crystals.rst
>     [0 tests, 0.03 s]
> ----------------------------------------------------------------------
> All tests passed!
> ----------------------------------------------------------------------
> }}}
> But, ooops, just noticed they're tagged `# optional - dot2tex graphviz`...

> Same problem without adding `sage` to the `--optional` list:
> {{{
> ----------------------------------------------------------------------
> sage -t --long devel/sage/doc/en/thematic_tutorials/lie/affine_hw_crystals.rst  # 2 doctests failed
> sage -t --long devel/sage/doc/en/thematic_tutorials/lie/affine_finite_crystals.rst  # 1 doctest failed
> sage -t --long devel/sage/doc/en/thematic_tutorials/lie/crystals.rst  # 2 doctests failed
> ----------------------------------------------------------------------
> }}}
> Again, with `--optional=dot2tex,graphviz,sage`:
> {{{
> Doctesting 3 files.
> sage -t --long devel/sage/doc/en/thematic_tutorials/lie/affine_hw_crystals.rst
>     [14 tests, 17.73 s]
> sage -t --long devel/sage/doc/en/thematic_tutorials/lie/affine_finite_crystals.rst
>     [97 tests, 22.79 s]
> sage -t --long devel/sage/doc/en/thematic_tutorials/lie/crystals.rst
>     [116 tests, 45.62 s]
> ----------------------------------------------------------------------
> All tests passed!
> ----------------------------------------------------------------------
> }}}
> ... but I also get five pop-up windows showing `sage.pdf`! XD
> 

Leif, thanks for the report! Are you saying that the tags in the code are wrong? The view commands in the code make the pdf files, but they are supposed to show pictures (not just `sage.pdf`).

Best,

Anne


---

Comment by leif created at 2013-05-21 04:10:25

Replying to [comment:31 aschilling]:
> > ... but I also get five pop-up windows showing `sage.pdf`! XD

Rerunning the tests of the Sage library with `--optional=dot2tex,graphviz,sage` (i.e., this time also `graphviz`), I get _eleven_ pop-up windows.




> Leif, thanks for the report! Are you saying that the tags in the code are wrong?

IMHO yes.  Some tests marked optional depend on data that's not defined unless one also specifies `sage`.  I'm not entirely sure whether the _behaviour_ w.r.t. that changed with the new doctesting framework (in Sage 5.9 and later); the (syntax of the) options to `sage -t ...` did.




> The view commands in the code make the pdf files, but they are supposed to show pictures (not just `sage.pdf`).

Yes, I of course meant I get the generated PDFs shown (entitled `sage.pdf`), but that shouldn't happen when doctesting.


----


For completeness (Sage library with `[--long] --optional=dot2tex,graphviz,sage`):

```
**********************************************************************
File "devel/sage/sage/graphs/graph_latex.py", line 1325, in sage.graphs.graph_latex.GraphLatex.dot2tex_picture
Failed example:
    print g.latex_options().dot2tex_picture()  # optional - dot2tex graphviz
Expected:
    \begin{tikzpicture}[>=latex,line join=bevel,]
    %%
      \node (0+1) at (...bp,...bp) [draw,draw=none] {$\left(\text{0}, 1\right)$};
      \node (0+0) at (...bp,...bp) [draw,draw=none] {$\left(\text{0}, 0\right)$};
      \node (1+0) at (...bp,...bp) [draw,draw=none] {$\left(\text{1}, 0\right)$};
      \node (1+1) at (...bp,...bp) [draw,draw=none] {$\left(\text{1}, 1\right)$};
      \draw [->] (1+0) ..controls (...bp,...bp) and (...bp,...bp)  .. (0+1);
      \draw [->] (0+0) ..controls (...bp,...bp) and (...bp,...bp)  .. (0+1);
      \draw [->] (0+0) ..controls (...bp,...bp) and (...bp,...bp)  .. (1+1);
      \draw [->] (1+0) ..controls (...bp,...bp) and (...bp,...bp)  .. (1+1);
    %
    \end{tikzpicture}
Got:
    <BLANKLINE>
    \begin{tikzpicture}[>=latex,line join=bevel,]
    %%
    \node (0+0) at (14bp,63bp) [draw,draw=none] {$\left(0, 0\right)$};
      \node (0+1) at (60bp,9bp) [draw,draw=none] {$\left(0, 1\right)$};
      \node (1+0) at (60bp,63bp) [draw,draw=none] {$\left(1, 0\right)$};
      \node (1+1) at (14bp,9bp) [draw,draw=none] {$\left(1, 1\right)$};
      \draw [black,->] (0+0) ..controls (29bp,46bp) and (38bp,35bp)  .. (0+1);
      \draw [black,->] (1+0) ..controls (45bp,46bp) and (36bp,35bp)  .. (1+1);
      \draw [black,->] (0+0) ..controls (14bp,47bp) and (14bp,37bp)  .. (1+1);
      \draw [black,->] (1+0) ..controls (60bp,47bp) and (60bp,37bp)  .. (0+1);
    %
    \end{tikzpicture}
    <BLANKLINE>
**********************************************************************
```





And this is the _only one_ I get because of missing LaTeX packages:

```
**********************************************************************
File "devel/sage/sage/combinat/posets/posets.py", line 1087, in sage.combinat.posets.posets.FinitePoset._latex_
Failed example:
    print P._latex_() #optional - dot2tex graphviz
Expected:
    \begin{tikzpicture}
    %
    \useasboundingbox (0,0) rectangle (5.0cm,5.0cm);
    %
    \definecolor{cv0}{rgb}{0.0,0.0,0.0}
    \definecolor{cfv0}{rgb}{1.0,1.0,1.0}
    \definecolor{clv0}{rgb}{0.0,0.0,0.0}
    \definecolor{cv1}{rgb}{0.0,0.0,0.0}
    \definecolor{cfv1}{rgb}{1.0,1.0,1.0}
    \definecolor{clv1}{rgb}{0.0,0.0,0.0}
    \definecolor{cv0v1}{rgb}{0.0,0.0,0.0}
    %
    \Vertex[style={minimum size=1.0cm,draw=cv0,fill=cfv0,text=clv0,shape=circle},LabelOut=false,L=\hbox{$1$},x=0.0cm,y=0.0cm]{v0}
    \Vertex[style={minimum size=1.0cm,draw=cv1,fill=cfv1,text=clv1,shape=circle},LabelOut=false,L=\hbox{$2$},x=5.0cm,y=5.0cm]{v1}
    %
    \Edge[lw=0.1cm,style={post, bend right,color=cv0v1,},](v0)(v1)
    %
    \end{tikzpicture}
Got:
    <BLANKLINE>
    Warning: `tkz-graph.sty` is not part of this computer's TeX installation.
    This package is required to render graphs in LaTeX.
    Visit 'http://altermundus.com/pages/graph.html'.
    <BLANKLINE>
    <BLANKLINE>
    Warning: `tkz-berge.sty` is not part of this computer's TeX installation.
    This package is required to render graphs in LaTeX.
    Visit 'http://altermundus.com/pages/graph.html'.
    <BLANKLINE>
    \begin{tikzpicture}
    %
    \useasboundingbox (0,0) rectangle (5.0cm,5.0cm);
    %
    \definecolor{cv0}{rgb}{0.0,0.0,0.0}
    \definecolor{cfv0}{rgb}{1.0,1.0,1.0}
    \definecolor{clv0}{rgb}{0.0,0.0,0.0}
    \definecolor{cv1}{rgb}{0.0,0.0,0.0}
    \definecolor{cfv1}{rgb}{1.0,1.0,1.0}
    \definecolor{clv1}{rgb}{0.0,0.0,0.0}
    \definecolor{cv0v1}{rgb}{0.0,0.0,0.0}
    %
    \Vertex[style={minimum size=1.0cm,draw=cv0,fill=cfv0,text=clv0,shape=circle},LabelOut=false,L=\hbox{$1$},x=5.0cm,y=0.0cm]{v0}
    \Vertex[style={minimum size=1.0cm,draw=cv1,fill=cfv1,text=clv1,shape=circle},LabelOut=false,L=\hbox{$2$},x=0.0cm,y=5.0cm]{v1}
    %
    \Edge[lw=0.1cm,style={post, bend right,color=cv0v1,},](v0)(v1)
    %
    \end{tikzpicture}
**********************************************************************
```



---

Comment by leif created at 2013-05-21 04:18:15

Replying to [comment:29 nthiery]:
> It's kind of you to be investigating those failing tests, but we don't need them. So I would say: just report upstream and skip them.

I've added two patches, one skipping comparisons to the three non-existing reference files, the other fixing the build order of the examples.

In case they're still needed with #14408 (at least the former most probably will be), we can submit them upstream, but I'm not going to do this right now.


---

Comment by tscrim created at 2013-05-21 04:50:15

Leif,

I know a few of the popup windows come from `view(a_crystal)` type commands (there might also be some `a_crystal.plot()`), but I thought `view()` was not suppose to display anything during doctests (I believe there is a ticket about this, but I can't find it...)

As for the optional tests, I believe some of them have tests which are run on the object, which doesn't require !`dot2tex`, and then the same object is also run through a `view()`.

To recap, currently we should (I suspect they might have been broken beforehand) fix optional doctests in the following files:

- `combinat/kleber_tree.py`
- `graphs/graph_latex.py`
- `combinat/posets/posets.py`

As well as (possibly) adding additional optional tags, and making sure the doctests don't show pdfs. Correct?

Thanks for your work on this,

Travis


---

Comment by leif created at 2013-05-21 04:58:06

Diff between the `2.8.7.p1` (former `2.8.7-2`) and the `.p2` spkg.  For reference / review only.


---

Comment by leif created at 2013-05-21 05:19:21

Changing status from needs_info to needs_review.


---

Attachment

Just for the record, the [.p1 spkg](http://boxen.math.washington.edu/home/leif/Sage/spkgs/dot2tex-2.8.7.p1.spkg) is a remake of Nicolas' `dot2tex-2.8.7-2.spkg`, with all traces of upstream files removed from the Mercurial history (and `src/` now in `.hgignore`), and some tags added.

For the [new .p2 spkg](http://boxen.math.washington.edu/home/leif/Sage/spkgs/dot2tex-2.8.7.p2.spkg) with my fixes, based on the above-mentioned `.p1`, see the ticket's description; [attachment:dot2tex-2.8.7.p1-p2.diff diff for easier reviewing] also attached.  Please build, test, and report! ;-)

(Supposed to work with older Sage / matplotlib versions as well.)


---

Comment by leif created at 2013-05-21 06:05:50

Replying to [comment:35 leif]:
> For the [new .p2 spkg](http://boxen.math.washington.edu/home/leif/Sage/spkgs/dot2tex-2.8.7.p2.spkg) with my fixes, based on the above-mentioned `.p1`, see the ticket's description; [attachment:dot2tex-2.8.7.p1-p2.diff diff for easier reviewing] also attached.  Please build, test, and report! ;-)
> 
> (Supposed to work with older Sage / matplotlib versions as well.)

P.S.: matplotlib was upgraded in Sage 5.10.beta0.


---

Comment by slabbe created at 2013-05-21 11:55:35

> To recap, currently we should (I suspect they might have been broken beforehand) fix optional doctests in the following files:
> 
> - `combinat/kleber_tree.py`
> - `graphs/graph_latex.py`
> - `combinat/posets/posets.py`

Note that my review patch available at #13624 (trac_13624-review-sl.patch) is (1) adding one doctest and (2) fixing broken optional dot2tex doctests for the `graph_latex.py` and `generic_graph.py` files. Maybe the part (2) could be moved to this ticket?

SÃ©bastien


---

Comment by leif created at 2013-05-21 15:56:32

Replying to [comment:37 slabbe]:
> Note that my review patch available at #13624 (trac_13624-review-sl.patch) is (1) adding one doctest and (2) fixing broken optional dot2tex doctests for the `graph_latex.py` and `generic_graph.py` files. Maybe the part (2) could be moved to this ticket?

I'd prefer to leave it there (or, more precisely, not to move it here), since it's unrelated to this ticket, which could get "merged" simply by putting the new spkg into the optional spkg repo.  (The fixed spkg doesn't change the output of `dot2tex` or any doctest; #14408 _might_.)


---

Comment by nthiery created at 2013-05-22 01:34:46

Replying to [comment:36 leif]:
> Replying to [comment:35 leif]:
> > For the [new .p2 spkg](http://boxen.math.washington.edu/home/leif/Sage/spkgs/dot2tex-2.8.7.p2.spkg) with my fixes, based on the above-mentioned `.p1`, see the ticket's description; [attachment:dot2tex-2.8.7.p1-p2.diff diff for easier reviewing] also attached.  Please build, test, and report! ;-)

I have been through the diff's and am happy with them. I have installed the spkg and ran its test succesfully on 5.10.beta2 as well as 5.10.beta4 git style. Assuming all sage tests pass, feel free to set a positive review on my behalf.


---

Comment by nthiery created at 2013-05-22 01:35:51

Remaining questions:

- Do we want to use this ticket to upgrade dot2tex to its latest devel version?
- Do we want to use this ticket to make dot2tex a non optional spkg?


---

Comment by leif created at 2013-05-22 01:41:59

Replying to [comment:40 nthiery]:
> Remaining questions:
> 
> - Do we want to use this ticket to upgrade dot2tex to its latest devel version?

I'd say no, that's for #14408.




> - Do we want to use this ticket to make dot2tex a non optional spkg?

As mentioned before, I thought its MIT license would prevent us from doing so (but IANAL).  Besides that, I don't think anybody would object (since it's much smaller now ;-) ), but it also *requires* graphviz, doesn't it?


---

Comment by nthiery created at 2013-05-22 01:44:51

Replying to [comment:19 leif]:
> I thought it was (or had to be) optional because of its MIT license, but IANAL.

According to http://en.wikipedia.org/wiki/MIT_License, MIT is GPL
compatible, so that should not be an issue. I think it has not been
standard so far just because we never took the time to discuss and do
it.

Granted dot2tex is not so useful without graphviz (and graphviz is
supposed to have a GPL incompatible license; though we don't link to
it, well, IANAL either). I still think it would simplify our user's
life to have dot2tex standard, and only have to worry about installing
graphviz if not already preinstalled in the distro.

What do you think? Should I make a poll on sage-devel for making
dot2tex a standard spkg, either in this ticket or a later ticket?

Cheers,
                              Nicolas


---

Comment by aschilling created at 2013-05-22 01:55:54

> Granted dot2tex is not so useful without graphviz (and graphviz is
> supposed to have a GPL incompatible license; though we don't link to
> it, well, IANAL either). I still think it would simplify our user's
> life to have dot2tex standard, and only have to worry about installing
> graphviz if not already preinstalled in the distro.
> 
> What do you think? Should I make a poll on sage-devel for making
> dot2tex a standard spkg, either in this ticket or a later ticket?

Yes, I think it would be a good idea to make it a standard package!

Anne


---

Comment by leif created at 2013-05-22 02:06:39

Replying to [comment:42 nthiery]:
> Replying to [comment:19 leif]:
> > I thought it was (or had to be) optional because of its MIT license, but IANAL.
> 
> According to http://en.wikipedia.org/wiki/MIT_License, MIT is GPL
> compatible, so that should not be an issue.

Yes, just read the same... :-)




> Granted dot2tex is not so useful without graphviz (and graphviz is
> supposed to have a GPL incompatible license; though we don't link to
> it, well, IANAL either). I still think it would simplify our user's
> life to have dot2tex standard, and only have to worry about installing
> graphviz if not already preinstalled in the distro.

We could ship it as a standard spkg, and only build / install it if its prerequisites (e.g. graphviz) are present.

Or install it regardless (although then certainly `spkg-check` would fail if not all necessary parts are available), but then IMHO Sage must not bail out in a bad way if the user tries to use it without having the other parts.  Don't know how much of an effort that would mean.




> What do you think? Should I make a poll on sage-devel for making
> dot2tex a standard spkg, either in this ticket or a later ticket?

I personally don't care much...


---

Comment by tscrim created at 2013-05-22 02:52:21

I'd like this to also be a standard package.

However just running `sage -i` on the spkg, I get the following:

```
----------------------------------------------------------------------
----------------------------------------------------------------------
**********************************************************************
*                                                                    *
* Warning: this is a prerelease version, and it may be unstable.     *
*                                                                    *
**********************************************************************
sage: C = CrystalOfTableaux(['A',2], shape=[2,1])
ERROR    Could not locate Graphviz binaries
ERROR    Failed to create xdotdata. Is Graphviz installed?
ERROR    Failed to parse the input data. Is it a valid dot file?
Try to input xdot data directly. Example:
    dot -Txdot file.dot | dot2tex > file.tex
| Sage Version 5.10.beta3, Release Date: 2013-05-15                  |
| Type "notebook()" for the browser-based notebook interface.        |
| Type "help()" for help.                                            |
If this does not work, check that you have an updated version of PyParsing and
Graphviz. Users have reported problems with old versions. You can also run
dot2tex in debug mode using the --debug option:
    dot2tex --debug file.dot
A file dot2tex.log will be written to the current directory with detailed
information useful for debugging.
An exception has occurred, use %tb to see the full traceback.

SystemExit: 1

To exit: use 'exit', 'quit', or Ctrl-D.
```

which was working with the p1 spkg. I presume I shouldn't have to do anything else to get it to work, but what else should I try/do? (I don't think installing the (experimental) graphviz would work, nor does it seem like the right solution...)

Best,

Travis


---

Comment by nthiery created at 2013-05-22 03:02:19

Replying to [comment:45 tscrim]:
> I'd like this to also be a standard package.
> 
> However just running `sage -i` on the spkg, I get the following:
> {{{
> ----------------------------------------------------------------------
> | Sage Version 5.10.beta3, Release Date: 2013-05-15                  |
> | Type "notebook()" for the browser-based notebook interface.        |
> | Type "help()" for help.                                            |
> ----------------------------------------------------------------------
> **********************************************************************
> *                                                                    *
> * Warning: this is a prerelease version, and it may be unstable.     *
> *                                                                    *
> **********************************************************************
> sage: C = CrystalOfTableaux(['A',2], shape=[2,1])
> ERROR    Could not locate Graphviz binaries
> ERROR    Failed to create xdotdata. Is Graphviz installed?
> ERROR    Failed to parse the input data. Is it a valid dot file?
> Try to input xdot data directly. Example:
>     dot -Txdot file.dot | dot2tex > file.tex
> 
> If this does not work, check that you have an updated version of PyParsing and
> Graphviz. Users have reported problems with old versions. You can also run
> dot2tex in debug mode using the --debug option:
>     dot2tex --debug file.dot
> A file dot2tex.log will be written to the current directory with detailed
> information useful for debugging.
> An exception has occurred, use %tb to see the full traceback.
> 
> SystemExit: 1
> 
> To exit: use 'exit', 'quit', or Ctrl-D.
> }}}
> which was working with the p1 spkg. I presume I shouldn't have to do anything else to get it to work, but what else should I try/do? (I don't think installing the (experimental) graphviz would work, nor does it seem like the right solution...)

For the record, I just tried the above command (adding a call to view)
with Sage 5.10.beta4, and it worked for me (Ubuntu, with graphviz
provided by the distribution).

I assume graphviz is in Sage's path?


---

Comment by leif created at 2013-05-22 03:19:37

Replying to [comment:45 tscrim]:
> I'd like this to also be a standard package.
> 
> However just running `sage -i` on the spkg, I get the following:
> {{{
> ...
> An exception has occurred, use %tb to see the full traceback.
> }}}

Hint, hint!

> {{{
> ...
> SystemExit: 1
> 
> To exit: use 'exit', 'quit', or Ctrl-D.
> }}}
(I hope Sage did _not_ really exit...)

> which was working with the p1 spkg. I presume I shouldn't have to do anything else to get it to work, but what else should I try/do? (I don't think installing the (experimental) graphviz would work, nor does it seem like the right solution...)

I don't fully understand what you did or tried to do;  installing Sage and the dot2tex spkg on a "virgin" system without dot2tex's prerequisites (and without `SAGE_CHECK=yes`)?

Also, the `.p1` would not work with Sage 5.10.* (because of matplotlib 1.2.x).


---

Comment by tscrim created at 2013-05-22 07:39:25

Seems like I somehow accidentally deleted my installation of graphviz. It works okay. Sorry for the white noise. (And no, sage did not actually exit.)


---

Comment by jdemeyer created at 2013-05-22 09:04:19

About making `dot2tex` standard: I see no point in this unless you also make `graphviz` standard, which cannot legally be done for license reasons. What would probably make more sense is combining `graphviz` and `dot2tex` in one optional package.


---

Comment by nthiery created at 2013-05-22 14:41:14

I started a poll on:

https://groups.google.com/forum/?fromgroups#!topic/sage-devel/U0Ij_06H2mk


---

Comment by nthiery created at 2013-05-22 14:43:51

Replying to [comment:49 jdemeyer]:
> About making `dot2tex` standard: I see no point in this unless you also make `graphviz` standard, which cannot legally be done for license reasons. What would probably make more sense is combining `graphviz` and `dot2tex` in one optional package.

See my comments on sage-devel. History seems to tell that we do not really have the manpower to maintain a graphviz spkg, and anyway it probably does not really makes sense: it's as easy to install as an optional spkg or as an os package.


---

Comment by aschilling created at 2013-05-23 22:48:20

> For the [new .p2 spkg](http://boxen.math.washington.edu/home/leif/Sage/spkgs/dot2tex-2.8.7.p2.spkg) with my fixes, based on the above-mentioned `.p1`, see the ticket's description; [attachment:dot2tex-2.8.7.p1-p2.diff diff for easier reviewing] also attached.  Please build, test, and report! ;-)
> 
> (Supposed to work with older Sage / matplotlib versions as well.)

I just installed the p2 version on MacOS and it works great! Thank you.

Anne


---

Comment by leif created at 2013-05-24 04:56:47

There's a new preliminary spkg available for testing at #14408.  (dot2tex's test suite is more than likely to fail atm.)

Doctesting the Sage library with that may still make sense.


---

Comment by tscrim created at 2013-05-24 19:06:39

Since it seems like the question of making `dot2tex` a standard package is controversial and the changes currently fix the problem, what's left to do before setting this to positive review? Has anyone tried this on `5.9` or below? The spkg diff looks good to me and running:

```
sage -i -f -c http://boxen.math.washington.edu/home/leif/Sage/spkgs/dot2tex-2.8.7.p2.spkg
...
GPL Ghostscript 9.05: Error: Font Renderer Plugin ( FreeType ) return code = -1
ready. %%BoundingBox: 148 556 612 667
Creating output file nodenames_pst.eps ... ready.
GPL Ghostscript 9.05: Error: Font Renderer Plugin ( FreeType ) return code = -1
GPL Ghostscript 9.05: Error: Font Renderer Plugin ( FreeType ) return code = -1
GPL Ghostscript 9.05: Error: Font Renderer Plugin ( FreeType ) return code = -1
GPL Ghostscript 9.05: Error: Font Renderer Plugin ( FreeType ) return code = -1
.sh: 1: pdftk: not found
WARNING  Failed to run command:
pdftk autosize_cmp.pdf colors_cmp.pdf compassports_cmp.pdf concentrate_cmp.pdf escstr_cmp.pdf invis_cmp.pdf nodenames_cmp.pdf cat output testrenders.pdf dont_ask
F
======================================================================
FAIL: test_zzzzzzzzzzzfinal (__main__.RenderTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "test_multirender.py", line 313, in test_zzzzzzzzzzzfinal
    self.failIf(err)
AssertionError: 32512 is not false

----------------------------------------------------------------------
Ran 8 tests in 72.121s

FAILED (failures=1)
Processing autosize.dot
Processing colors.dot
Processing compassports.dot
Processing concentrate.dot
Processing escstr.dot
Processing invis.dot
Processing nodenames.dot

Error(s) running dot2tex's test suite.

real	2m42.307s
user	1m11.820s
sys	0m49.403s
************************************************************************
Error testing package dot2tex-2.8.7.p2
************************************************************************
```

However I do *not* have `pdftk` installed on my system. From comment:25 I'm guessing this is okay? I'll also try it with `pdftk` installed.


---

Comment by nthiery created at 2013-05-24 19:27:45

Replying to [comment:54 tscrim]:
> Since it seems like the question of making `dot2tex` a standard package is controversial

And anyway that would be for #14408.

> Has anyone tried this on `5.9` or below?

I think we should not worry about this. This package will be updated
in the optional spkg for 5.10 and later; this has to be a different
repository from the optional spkg for earlier versions of Sage (or
not???).

No clue about the pdftk thing.

Cheers,
                             Nicolas


---

Comment by tscrim created at 2013-05-24 19:33:33

With `pdftk`, all tests pass:

```
sage -i -f -c http://boxen.math.washington.edu/home/leif/Sage/spkgs/dot2tex-2.8.7.p2.spkg
...
dot2tex's test suite passed successfully.

real	2m56.101s
user	1m12.137s
sys	0m54.015s
```

Leif, is it okay for the tests not to pass without `pdftk`?

Replying to [comment:55 nthiery]:
> > Has anyone tried this on 5.9 or below?
>I think we should not worry about this. This package will be updated in the optional spkg for 5.10 and later; this has to be a different repository from the optional spkg for earlier versions of Sage (or not???).
Okay.


---

Comment by tscrim created at 2013-05-27 16:13:05

Since this works (as before), with `pdftk` all the spkg tests pass, and it would be good to get this as the default `dot2tex` spkg before `5.10` is released, I'm setting this to positive review.


---

Comment by tscrim created at 2013-05-27 16:13:05

Changing status from needs_review to positive_review.


---

Comment by schilly created at 2013-05-27 20:21:50

I just put the file on the server. I double checked it, 2.8.7.p2. in optional.


---

Comment by jdemeyer created at 2013-05-28 08:25:10

Resolution: fixed


---

Comment by nthiery created at 2013-05-28 14:34:54

Thanks guys! That will be a lifesaver during the upcoming Sage days :-)


---

Comment by leif created at 2013-06-03 15:45:30

For fixing broken optional dot2tex doctests, see #14680.


---

Comment by leif created at 2014-03-29 20:20:00

For matplotlib >= 1.3.x (#14993, merged into Sage 6.2.beta5), we apparently have to adapt the spkg again, as MPL no longer ships with pyparsing (but Sage now ships it as a _separate_ package), so importing `matplotlib.pyparsing` fails.  (The installation of the optional dot2tex package still succeeds -- unless one also tries to run its test suite, but using dot2tex now more or less *silently* fails.  Quite odd.)


---

Comment by stumpc5 created at 2014-04-30 07:27:47

Replying to [comment:62 leif]:
> For matplotlib >= 1.3.x (#14993, merged into Sage 6.2.beta5), we apparently have to adapt the spkg again, as MPL no longer ships with pyparsing (but Sage now ships it as a _separate_ package), so importing `matplotlib.pyparsing` fails.  (The installation of the optional dot2tex package still succeeds -- unless one also tries to run its test suite, but using dot2tex now more or less *silently* fails.  Quite odd.)

I just ran into that issue -- are there any solutions so far?

Thanks, Christian


---

Comment by slabbe created at 2014-04-30 09:25:29

Replying to [comment:63 stumpc5]:
> I just ran into that issue -- are there any solutions so far?

I just tried an ugly monkey fix which worked. First I did `sage -i pyparsing` and in my case that package was already installed.

Then, I edited the file `/Users/slabbe/Applications/sage-git/local/lib/python2.7/site-packages/dot2tex/dotparsing.py` in the following way:


```diff
26,27c26,30
-     import matplotlib.pyparsing as pyparsing
-     # just raise if that failed, too
+     try:
+         import matplotlib.pyparsing as pyparsing
+     except ImportError:
+         import pyparsing
+         # just raise if that failed, too
36c39
-     ParseException, ParseResults, CharsNotIn, _noncomma, dblQuotedString, QuotedString, ParserElement,
+     ParseException, ParseResults, CharsNotIn, dblQuotedString, QuotedString, ParserElement,
```


Then, I tested this example:


```python
sage: G = DiGraph()
sage: G.add_edge(3333, 88, 'my_label')
sage: G.set_latex_options(format='dot2tex')
sage: view(G)
```


and it worked again.


---

Comment by stumpc5 created at 2014-04-30 09:29:40

Replying to [comment:64 slabbe]:
> I just tried an ugly monkey fix which worked. First I did `sage -i pyparsing` and in my case that package was already installed.
> 
> Then, I edited the file `/Users/slabbe/Applications/sage-git/local/lib/python2.7/site-packages/dot2tex/dotparsing.py` in the following way:

I did word by word the same some minutes ago :-) Thanks for checking anyway...


---

Comment by aschilling created at 2014-04-30 15:01:00

Replying to [comment:65 stumpc5]:
> Replying to [comment:64 slabbe]:
> > I just tried an ugly monkey fix which worked. First I did `sage -i pyparsing` and in my case that package was already installed.
> > 
> > Then, I edited the file `/Users/slabbe/Applications/sage-git/local/lib/python2.7/site-packages/dot2tex/dotparsing.py` in the following way:
> 
> I did word by word the same some minutes ago :-) Thanks for checking anyway...

Hi Christian,

Are you using the latest version of the package? See

http://trac.sagemath.org/ticket/16026

This works for me!

Anne


---

Comment by stumpc5 created at 2014-04-30 15:08:35

Replying to [comment:66 aschilling]:
> Are you using the latest version of the package?

âI am using the latest development version 6.2.rc0â and got the error there. But that patch is already merged there, isn't it?


---

Comment by aschilling created at 2014-04-30 15:10:37

Replying to [comment:67 stumpc5]:
> Replying to [comment:66 aschilling]:
> > Are you using the latest version of the package?
> 
> âI am using the latest development version 6.2.rc0â and got the error there. But that patch is already merged there, isn't it?

But did you install

 âhttp://boxen.math.washington.edu/home/vbraun/upstream/dot2tex-20120520.tar.bz2

or the old version?


---

Comment by stumpc5 created at 2014-04-30 15:22:47

Replying to [comment:68 aschilling]:
> or the old version?

I guess the old version -- I just used `sage -i dot2tex` as I am supposed to do to install an optional package...


---

Comment by slabbe created at 2014-04-30 21:55:14

Replying to [comment:68 aschilling]:
> But did you install
> 
>  âhttp://boxen.math.washington.edu/home/vbraun/upstream/dot2tex-20120520.tar.bz2
> 
> or the old version?

Anne, can you tell me how to install the new git version of dot2tex spkg? I tried:


```
$ sage -f http://www.sagemath.org/packages/upstream/dot2tex/dot2tex-20120520.tar.bz2
```


and I got:


```
Attempting to download package dot2tex-20120520.tar.bz2
>>> Trying to download http://www.sagemath.org/packages/upstream/dot2tex/dot2tex-20120520.tar.bz2
[............................................................]
dot2tex-20120520.tar.bz2
====================================================
Extracting package /Users/slabbe/Applications/sage-git/upstream/dot2tex-20120520.tar.bz2
-rw-r--r--  1 slabbe  staff  1731531 Apr 30 23:51 /Users/slabbe/Applications/sage-git/upstream/dot2tex-20120520.tar.bz2
Finished extraction
/Users/slabbe/Applications/sage-git/src/bin/sage-spkg: line 594: cd: dot2tex-20120520.tar.bz2: No such file or directory
Error: after extracting, the directory dot2tex-20120520.tar.bz2 does not exist
```



---

Comment by jhpalmieri created at 2014-04-30 22:19:59

Download the tar.bz2 file and put it in `sage/upstream`. Verify that the file `sage/build/pkgs/dot2tex/package-version.txt` contains "20120520". Then do `sage -f dot2tex`.

(I think that once Sage 6.2 becomes official, then the new tar.bz2 file will go to the mirrors and replace the old package.)


---

Comment by slabbe created at 2014-05-02 08:15:34

Replying to [comment:71 jhpalmieri]:
> Download the tar.bz2 file and put it in `sage/upstream`. Verify that the file `sage/build/pkgs/dot2tex/package-version.txt` contains "20120520". Then do `sage -f dot2tex`.

Did that. Here is my setup:


```
$ ls upstream/dot2tex*
upstream/dot2tex-2.8.7.p2.spkg
upstream/dot2tex-20120520.tar.bz2
$ ls build/pkgs/dot2tex/
package-version.txt
$ cat build/pkgs/dot2tex/package-version.txt 
20120520
```


But I also need the content of the checksum (where can I find it?):


```
$ sage -f dot2tex
sed: /Users/slabbe/Applications/sage-git/build/pkgs/dot2tex/checksums.ini: No such file or directory
Found local metadata for dot2tex-20120520
Attempting to download package dot2tex-20120520
>>> Trying to download http://www.sagemath.org/packages/upstream/dot2tex/
[.]
No checksum file: /Users/slabbe/Applications/sage-git/build/pkgs/dot2tex/checksums.ini
```


Also, why does it try to download it since it is in `upstream` directory?


---

Comment by jhpalmieri created at 2014-05-02 14:50:57

Something is wrong with your branch. With the current develop branch, I see

```
$ ls build/pkgs/dot2tex/
SPKG.txt             package-version.txt  spkg-check*
checksums.ini        patches/             spkg-install*
$ cat build/pkgs/dot2tex/package-version.txt 
20120520
```

You're missing most of the files in `build/pkgs/dot2tex`.

(If you had a `checksums.ini` file which matched the file in `upstream`, it wouldn't download anything.)


---

Comment by slabbe created at 2014-05-02 21:33:42

The way to install a spkg does not seem to be clear. I suggest to move the discussion concerning the installation of an optional spkg on sage-devel. I start a new thread now.

SÃ©bastien
