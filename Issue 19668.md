# Issue 19668: Upgrade PARI/GP to latest master

archive/issues_019668.json:
```json
{
    "body": "CC:  @rwst\n\nSee http://trac.sagemath.org/ticket/18210#comment:31 for some prior work on this issue.\n\nIssue created by migration from https://trac.sagemath.org/ticket/19905\n\n",
    "created_at": "2016-01-18T06:49:47Z",
    "labels": [
        "PLEASE CHANGE",
        "major"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.1",
    "title": "Upgrade PARI/GP to latest master",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19668",
    "user": "buck"
}
```
CC:  @rwst

See http://trac.sagemath.org/ticket/18210#comment:31 for some prior work on this issue.

Issue created by migration from https://trac.sagemath.org/ticket/19905





---

archive/issue_comments_270364.json:
```json
{
    "body": "This is what I have so far, but I see that `src/sage/libs/pari/paridecl.pxd` needs to be updated.\n`@`jdemeyer: How is this file maintained? I don't trust my ability to do this accurately, manually. It seems like something that should also be done by the autogen/pari system.\n\n\n\n\n```diff\ndiff --git a/build/pkgs/pari/checksums.ini b/build/pkgs/pari/checksums.ini\nindex c62c530..aabe08d 100644\n--- a/build/pkgs/pari/checksums.ini\n+++ b/build/pkgs/pari/checksums.ini\n@@ -1,4 +1,4 @@\n tarball=pari-VERSION.tar.gz\n-sha1=fa23e0c8b6e38a356048d19224dc9b9658d77724\n-md5=c753faaa4780de5ad8d461f0ffd70ecf\n-cksum=1220765312\n+sha1=55299bfe042da491648897e830030083809d9967\n+md5=97738f8e92bba498f7dfd723c8e9d910\n+cksum=1221580104\ndiff --git a/build/pkgs/pari/package-version.txt b/build/pkgs/pari/package-version.txt\nindex 2b25bd1..5fdd71e 100644\n--- a/build/pkgs/pari/package-version.txt\n+++ b/build/pkgs/pari/package-version.txt\n@@ -1 +1 @@\n-2.8-1813-g6157df4.p0\n+2.8-2230-g450ce38\ndiff --git a/build/pkgs/pari/patches/public_memory_functions.patch b/build/pkgs/pari/patches/public_memory_functions.patch\nindex b3726d7..ee14fa4 100644\n--- a/build/pkgs/pari/patches/public_memory_functions.patch\n+++ b/build/pkgs/pari/patches/public_memory_functions.patch\n@@ -9,9 +9,9 @@ index 7067183..4ede6ed 100644\n +void *  pari_mainstack_malloc(size_t size);\n +void    pari_mainstack_mfree(void *s, size_t size);\n +void    pari_mainstack_free(struct pari_mainstack *st);\n- void    paristack_alloc(size_t rsize, size_t vsize);\n  void    paristack_newrsize(ulong newsize);\n  void    paristack_resize(ulong newsize);\n+ void    paristack_setsize(size_t rsize, size_t vsize);\n diff --git a/src/language/init.c b/src/language/init.c\n index 7b5922d..2a578d7 100644\n --- a/src/language/init.c\ndiff --git a/src/sage_setup/autogen/pari/args.py b/src/sage_setup/autogen/pari/args.py\nindex 57356b4..a2749df 100644\n--- a/src/sage_setup/autogen/pari/args.py\n+++ b/src/sage_setup/autogen/pari/args.py\n@@ -254,6 +254,16 @@ class PariArgumentPrec(PariArgumentClass):\n         s = \"        {name} = prec_bits_to_words({name})\\n\"\n         return s.format(name=self.name)\n \n+class PariArgumentBitPrec(PariArgumentClass):\n+    def _typerepr(self):\n+        return \"bitprec\"\n+    def ctype(self):\n+        return \"long\"\n+    def always_default(self):\n+        return \"0\"\n+    def get_argument_name(self, namesiter):\n+        return \"bitprecision\"\n+\n class PariArgumentSeriesPrec(PariArgumentClass):\n     def _typerepr(self):\n         return \"serprec\"\n@@ -277,6 +287,7 @@ pari_arg_types = {\n         'U': PariArgumentULong,\n         'n': PariArgumentVariable,\n         'p': PariArgumentPrec,\n+        'b': PariArgumentBitPrec,\n         'P': PariArgumentSeriesPrec,\n \n     # Codes which are known but not actually supported for Sage\ndiff --git a/src/sage_setup/autogen/pari/generator.py b/src/sage_setup/autogen/pari/generator.py\nindex 7aa9990..9b78d88 100644\n--- a/src/sage_setup/autogen/pari/generator.py\n+++ b/src/sage_setup/autogen/pari/generator.py\n@@ -233,9 +233,9 @@ class PariFunctionGenerator(object):\n         D = sorted(D.values(), key=lambda d: d['function'])\n         sys.stdout.write(\"Generating PARI functions:\")\n \n-        self.gen_file = open(self.gen_filename, 'w')\n+        self.gen_file = open(self.gen_filename + '.tmp', 'w')\n         self.gen_file.write(gen_banner)\n-        self.instance_file = open(self.instance_filename, 'w')\n+        self.instance_file = open(self.instance_filename + '.tmp', 'w')\n         self.instance_file.write(instance_banner)\n \n         for v in D:\n@@ -249,3 +249,7 @@ class PariFunctionGenerator(object):\n \n         self.gen_file.close()\n         self.instance_file.close()\n+\n+        # All done? Let's commit.\n+        os.rename(self.gen_filename + '.tmp', self.gen_filename)\n+        os.rename(self.instance_filename + '.tmp', self.instance_filename)\n```\n",
    "created_at": "2016-01-18T06:57:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19668#issuecomment-270364",
    "user": "buck"
}
```

This is what I have so far, but I see that `src/sage/libs/pari/paridecl.pxd` needs to be updated.
`@`jdemeyer: How is this file maintained? I don't trust my ability to do this accurately, manually. It seems like something that should also be done by the autogen/pari system.




```diff
diff --git a/build/pkgs/pari/checksums.ini b/build/pkgs/pari/checksums.ini
index c62c530..aabe08d 100644
--- a/build/pkgs/pari/checksums.ini
+++ b/build/pkgs/pari/checksums.ini
@@ -1,4 +1,4 @@
 tarball=pari-VERSION.tar.gz
-sha1=fa23e0c8b6e38a356048d19224dc9b9658d77724
-md5=c753faaa4780de5ad8d461f0ffd70ecf
-cksum=1220765312
+sha1=55299bfe042da491648897e830030083809d9967
+md5=97738f8e92bba498f7dfd723c8e9d910
+cksum=1221580104
diff --git a/build/pkgs/pari/package-version.txt b/build/pkgs/pari/package-version.txt
index 2b25bd1..5fdd71e 100644
--- a/build/pkgs/pari/package-version.txt
+++ b/build/pkgs/pari/package-version.txt
@@ -1 +1 @@
-2.8-1813-g6157df4.p0
+2.8-2230-g450ce38
diff --git a/build/pkgs/pari/patches/public_memory_functions.patch b/build/pkgs/pari/patches/public_memory_functions.patch
index b3726d7..ee14fa4 100644
--- a/build/pkgs/pari/patches/public_memory_functions.patch
+++ b/build/pkgs/pari/patches/public_memory_functions.patch
@@ -9,9 +9,9 @@ index 7067183..4ede6ed 100644
 +void *  pari_mainstack_malloc(size_t size);
 +void    pari_mainstack_mfree(void *s, size_t size);
 +void    pari_mainstack_free(struct pari_mainstack *st);
- void    paristack_alloc(size_t rsize, size_t vsize);
  void    paristack_newrsize(ulong newsize);
  void    paristack_resize(ulong newsize);
+ void    paristack_setsize(size_t rsize, size_t vsize);
 diff --git a/src/language/init.c b/src/language/init.c
 index 7b5922d..2a578d7 100644
 --- a/src/language/init.c
diff --git a/src/sage_setup/autogen/pari/args.py b/src/sage_setup/autogen/pari/args.py
index 57356b4..a2749df 100644
--- a/src/sage_setup/autogen/pari/args.py
+++ b/src/sage_setup/autogen/pari/args.py
@@ -254,6 +254,16 @@ class PariArgumentPrec(PariArgumentClass):
         s = "        {name} = prec_bits_to_words({name})\n"
         return s.format(name=self.name)
 
+class PariArgumentBitPrec(PariArgumentClass):
+    def _typerepr(self):
+        return "bitprec"
+    def ctype(self):
+        return "long"
+    def always_default(self):
+        return "0"
+    def get_argument_name(self, namesiter):
+        return "bitprecision"
+
 class PariArgumentSeriesPrec(PariArgumentClass):
     def _typerepr(self):
         return "serprec"
@@ -277,6 +287,7 @@ pari_arg_types = {
         'U': PariArgumentULong,
         'n': PariArgumentVariable,
         'p': PariArgumentPrec,
+        'b': PariArgumentBitPrec,
         'P': PariArgumentSeriesPrec,
 
     # Codes which are known but not actually supported for Sage
diff --git a/src/sage_setup/autogen/pari/generator.py b/src/sage_setup/autogen/pari/generator.py
index 7aa9990..9b78d88 100644
--- a/src/sage_setup/autogen/pari/generator.py
+++ b/src/sage_setup/autogen/pari/generator.py
@@ -233,9 +233,9 @@ class PariFunctionGenerator(object):
         D = sorted(D.values(), key=lambda d: d['function'])
         sys.stdout.write("Generating PARI functions:")
 
-        self.gen_file = open(self.gen_filename, 'w')
+        self.gen_file = open(self.gen_filename + '.tmp', 'w')
         self.gen_file.write(gen_banner)
-        self.instance_file = open(self.instance_filename, 'w')
+        self.instance_file = open(self.instance_filename + '.tmp', 'w')
         self.instance_file.write(instance_banner)
 
         for v in D:
@@ -249,3 +249,7 @@ class PariFunctionGenerator(object):
 
         self.gen_file.close()
         self.instance_file.close()
+
+        # All done? Let's commit.
+        os.rename(self.gen_filename + '.tmp', self.gen_filename)
+        os.rename(self.instance_filename + '.tmp', self.instance_filename)
```




---

archive/issue_comments_270365.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to packages: standard.",
    "created_at": "2016-01-18T06:57:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19668#issuecomment-270365",
    "user": "buck"
}
```

Changing component from PLEASE CHANGE to packages: standard.



---

archive/issue_comments_270366.json:
```json
{
    "body": "Replying to [comment:1 buck]:\n> This is what I have so far, but I see that `src/sage/libs/pari/paridecl.pxd` needs to be updated.\n> `@`jdemeyer: How is this file maintained?\nManually. It's mostly a copy and paste from PARI's `<paridecl.h>`.\n\n> It seems like something that should also be done by the autogen/pari system.\nFeel free to propose a patch :-)\n\nI would prefer this ticket to depend on #19883 in order to avoid merge conflicts.",
    "created_at": "2016-01-18T07:15:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19668#issuecomment-270366",
    "user": "@jdemeyer"
}
```

Replying to [comment:1 buck]:
> This is what I have so far, but I see that `src/sage/libs/pari/paridecl.pxd` needs to be updated.
> `@`jdemeyer: How is this file maintained?
Manually. It's mostly a copy and paste from PARI's `<paridecl.h>`.

> It seems like something that should also be done by the autogen/pari system.
Feel free to propose a patch :-)

I would prefer this ticket to depend on #19883 in order to avoid merge conflicts.



---

archive/issue_comments_270367.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2016-01-18T10:12:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19668#issuecomment-270367",
    "user": "@jdemeyer"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_270368.json:
```json
{
    "body": "A reviewer without author?",
    "created_at": "2016-01-18T10:12:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19668#issuecomment-270368",
    "user": "@jdemeyer"
}
```

A reviewer without author?



---

archive/issue_comments_270369.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-01-18T23:08:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19668#issuecomment-270369",
    "user": "buck"
}
```

New commits:



---

archive/issue_comments_270370.json:
```json
{
    "body": "Set assignee to buck.",
    "created_at": "2016-01-18T23:08:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19668#issuecomment-270370",
    "user": "buck"
}
```

Set assignee to buck.



---

archive/issue_comments_270371.json:
```json
{
    "body": "You should write your real name in the Author field.\n\nAlso don't forget to post a link to the tarball (created with `make snapshot`) and to set the ticket to `needs_review` if you are done.",
    "created_at": "2016-01-19T07:11:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19668#issuecomment-270371",
    "user": "@jdemeyer"
}
```

You should write your real name in the Author field.

Also don't forget to post a link to the tarball (created with `make snapshot`) and to set the ticket to `needs_review` if you are done.



---

archive/issue_comments_270372.json:
```json
{
    "body": "What does the \"Fixed upstream, but not in a stable release.\" refer to?",
    "created_at": "2016-01-19T07:21:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19668#issuecomment-270372",
    "user": "@jdemeyer"
}
```

What does the "Fixed upstream, but not in a stable release." refer to?



---

archive/issue_comments_270373.json:
```json
{
    "body": "`@`buck: do you intend to finish this?",
    "created_at": "2016-01-25T21:17:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19668#issuecomment-270373",
    "user": "@jdemeyer"
}
```

`@`buck: do you intend to finish this?



---

archive/issue_comments_270374.json:
```json
{
    "body": "`@`buck: I will finish this. Remember to add your real name as author.",
    "created_at": "2016-01-29T11:42:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19668#issuecomment-270374",
    "user": "@jdemeyer"
}
```

`@`buck: I will finish this. Remember to add your real name as author.



---

archive/issue_comments_270375.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-01-29T16:34:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19668#issuecomment-270375",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_270376.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-01-29T20:13:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19668#issuecomment-270376",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_270377.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-01-29T20:17:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19668#issuecomment-270377",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_270378.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-01-29T22:04:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19668#issuecomment-270378",
    "user": "@jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_270379.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-01-30T18:13:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19668#issuecomment-270379",
    "user": "buck"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_270380.json:
```json
{
    "body": "LGTM.\n\nThanks for finishing up. I hope my patch helped some.",
    "created_at": "2016-01-30T18:13:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19668#issuecomment-270380",
    "user": "buck"
}
```

LGTM.

Thanks for finishing up. I hope my patch helped some.



---

archive/issue_comments_270381.json:
```json
{
    "body": "Replying to [comment:20 buck]:\n> I hope my patch helped some.\n\nOf course it did. Thank you too.",
    "created_at": "2016-01-31T09:06:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19668#issuecomment-270381",
    "user": "@jdemeyer"
}
```

Replying to [comment:20 buck]:
> I hope my patch helped some.

Of course it did. Thank you too.



---

archive/issue_comments_270382.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-01-31T13:31:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19668",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19668#issuecomment-270382",
    "user": "@vbraun"
}
```

Resolution: fixed
