# Issue 19668: Upgrade PARI/GP to latest master

Issue created by migration from Trac.

Original creator: buck

Original creation time: 2016-01-18 06:49:47

CC:  rws

See http://trac.sagemath.org/ticket/18210#comment:31 for some prior work on this issue.


---

Comment by buck created at 2016-01-18 06:57:18

This is what I have so far, but I see that `src/sage/libs/pari/paridecl.pxd` needs to be updated.
`@`jdemeyer: How is this file maintained? I don't trust my ability to do this accurately, manually. It seems like something that should also be done by the autogen/pari system.




```diff
diff --git a/build/pkgs/pari/checksums.ini b/build/pkgs/pari/checksums.ini
index c62c530..aabe08d 100644
--- a/build/pkgs/pari/checksums.ini
+++ b/build/pkgs/pari/checksums.ini
`@``@` -1,4 +1,4 `@``@`
 tarball=pari-VERSION.tar.gz
-sha1=fa23e0c8b6e38a356048d19224dc9b9658d77724
-md5=c753faaa4780de5ad8d461f0ffd70ecf
-cksum=1220765312
+sha1=55299bfe042da491648897e830030083809d9967
+md5=97738f8e92bba498f7dfd723c8e9d910
+cksum=1221580104
diff --git a/build/pkgs/pari/package-version.txt b/build/pkgs/pari/package-version.txt
index 2b25bd1..5fdd71e 100644
--- a/build/pkgs/pari/package-version.txt
+++ b/build/pkgs/pari/package-version.txt
`@``@` -1 +1 `@``@`
-2.8-1813-g6157df4.p0
+2.8-2230-g450ce38
diff --git a/build/pkgs/pari/patches/public_memory_functions.patch b/build/pkgs/pari/patches/public_memory_functions.patch
index b3726d7..ee14fa4 100644
--- a/build/pkgs/pari/patches/public_memory_functions.patch
+++ b/build/pkgs/pari/patches/public_memory_functions.patch
`@``@` -9,9 +9,9 `@``@` index 7067183..4ede6ed 100644
 +void *  pari_mainstack_malloc(size_t size);
 +void    pari_mainstack_mfree(void *s, size_t size);
 +void    pari_mainstack_free(struct pari_mainstack *st);
- void    paristack_alloc(size_t rsize, size_t vsize);
  void    paristack_newrsize(ulong newsize);
  void    paristack_resize(ulong newsize);
+ void    paristack_setsize(size_t rsize, size_t vsize);
 diff --git a/src/language/init.c b/src/language/init.c
 index 7b5922d..2a578d7 100644
 --- a/src/language/init.c
diff --git a/src/sage_setup/autogen/pari/args.py b/src/sage_setup/autogen/pari/args.py
index 57356b4..a2749df 100644
--- a/src/sage_setup/autogen/pari/args.py
+++ b/src/sage_setup/autogen/pari/args.py
`@``@` -254,6 +254,16 `@``@` class PariArgumentPrec(PariArgumentClass):
         s = "        {name} = prec_bits_to_words({name})\n"
         return s.format(name=self.name)
 
+class PariArgumentBitPrec(PariArgumentClass):
+    def _typerepr(self):
+        return "bitprec"
+    def ctype(self):
+        return "long"
+    def always_default(self):
+        return "0"
+    def get_argument_name(self, namesiter):
+        return "bitprecision"
+
 class PariArgumentSeriesPrec(PariArgumentClass):
     def _typerepr(self):
         return "serprec"
`@``@` -277,6 +287,7 `@``@` pari_arg_types = {
         'U': PariArgumentULong,
         'n': PariArgumentVariable,
         'p': PariArgumentPrec,
+        'b': PariArgumentBitPrec,
         'P': PariArgumentSeriesPrec,
 
     # Codes which are known but not actually supported for Sage
diff --git a/src/sage_setup/autogen/pari/generator.py b/src/sage_setup/autogen/pari/generator.py
index 7aa9990..9b78d88 100644
--- a/src/sage_setup/autogen/pari/generator.py
+++ b/src/sage_setup/autogen/pari/generator.py
`@``@` -233,9 +233,9 `@``@` class PariFunctionGenerator(object):
         D = sorted(D.values(), key=lambda d: d['function'])
         sys.stdout.write("Generating PARI functions:")
 
-        self.gen_file = open(self.gen_filename, 'w')
+        self.gen_file = open(self.gen_filename + '.tmp', 'w')
         self.gen_file.write(gen_banner)
-        self.instance_file = open(self.instance_filename, 'w')
+        self.instance_file = open(self.instance_filename + '.tmp', 'w')
         self.instance_file.write(instance_banner)
 
         for v in D:
`@``@` -249,3 +249,7 `@``@` class PariFunctionGenerator(object):
 
         self.gen_file.close()
         self.instance_file.close()
+
+        # All done? Let's commit.
+        os.rename(self.gen_filename + '.tmp', self.gen_filename)
+        os.rename(self.instance_filename + '.tmp', self.instance_filename)
```



---

Comment by buck created at 2016-01-18 06:57:18

Changing component from PLEASE CHANGE to packages: standard.


---

Comment by jdemeyer created at 2016-01-18 07:15:03

Replying to [comment:1 buck]:
> This is what I have so far, but I see that `src/sage/libs/pari/paridecl.pxd` needs to be updated.
> `@`jdemeyer: How is this file maintained?
Manually. It's mostly a copy and paste from PARI's `<paridecl.h>`.

> It seems like something that should also be done by the autogen/pari system.
Feel free to propose a patch :-)

I would prefer this ticket to depend on #19883 in order to avoid merge conflicts.


---

Comment by jdemeyer created at 2016-01-18 10:12:42

Changing type from PLEASE CHANGE to enhancement.


---

Comment by jdemeyer created at 2016-01-18 10:12:42

A reviewer without author?


---

Comment by buck created at 2016-01-18 23:08:02

New commits:


---

Comment by buck created at 2016-01-18 23:08:02

Set assignee to buck.


---

Comment by jdemeyer created at 2016-01-19 07:11:13

You should write your real name in the Author field.

Also don't forget to post a link to the tarball (created with `make snapshot`) and to set the ticket to `needs_review` if you are done.


---

Comment by jdemeyer created at 2016-01-19 07:21:39

What does the "Fixed upstream, but not in a stable release." refer to?


---

Comment by jdemeyer created at 2016-01-25 21:17:27

`@`buck: do you intend to finish this?


---

Comment by jdemeyer created at 2016-01-29 11:42:17

`@`buck: I will finish this. Remember to add your real name as author.


---

Comment by git created at 2016-01-29 16:34:08

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-01-29 20:13:00

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-01-29 20:17:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-01-29 22:04:33

Changing status from new to needs_review.


---

Comment by buck created at 2016-01-30 18:13:03

Changing status from needs_review to positive_review.


---

Comment by buck created at 2016-01-30 18:13:03

LGTM.

Thanks for finishing up. I hope my patch helped some.


---

Comment by jdemeyer created at 2016-01-31 09:06:55

Replying to [comment:20 buck]:
> I hope my patch helped some.

Of course it did. Thank you too.


---

Comment by vbraun created at 2016-01-31 13:31:29

Resolution: fixed
