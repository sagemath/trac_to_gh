# Issue 30011: Normaliz backend is broken with double description input

Issue created by migration from https://trac.sagemath.org/ticket/30248

Original creator: jipilab

Original creation time: 2020-07-29 14:17:26

CC:  @kliem @laisrast mkoeppe tscrim

Keywords: polytope, backend, normaliz, hyperplane, regions

This bug was found while manipulating hyperplane arrangements.

A minimal example to reproduce the bug is:


```
sage: p1 = Polyhedron(backend='normaliz', base_ring=AA, rays=[(AA(0), AA(0), AA(1)), (AA(0), AA(1), AA(-1)), (AA(1), AA(0), AA(-1))], vertices=[(AA(0), AA(0), AA(0))])
sage: p1
A 3-dimensional polyhedron in AA^3 defined as the convex hull of 1 vertex and 3 rays
sage: -p1
A 3-dimensional polyhedron in AA^3 defined as the convex hull of 1 vertex and 3 lines
sage: p2 = Polyhedron(backend='normaliz', base_ring=AA, rays=[(AA(-1), AA(0), AA(1)), (AA(-1), AA(1), AA(0)), (AA(0), AA(0), AA(-1))], vertices=[(AA(0), AA(0), AA(0))])
sage: p2
A 3-dimensional polyhedron in AA^3 defined as the convex hull of 1 vertex and 3 rays
sage: -p2
A 3-dimensional polyhedron in AA^3 defined as the convex hull of 1 vertex and 3 lines
```


Looking at `dilation` it seems that dilation is not the problem, it does the right thing, but the `parent.element_class` call messes things up.

Notice that changing the base ring to `QQ` or `ZZ` or removing the `'normaliz'` backend, one does not get the error... This is nasty.

In the hyperplane arrangement, there are some rational regions, and some irrational regions...


---

Comment by @kliem created at 2020-07-29 15:52:35

Notice that normaliz doesn't use precomputed double description yet (waiting for the package upgrade). I suspect intitialzing from inequaltities doesn't work correctly and there is an even simpler one line example for this.


---

Comment by @kliem created at 2020-07-29 16:11:27

What might be causing it, is passing a generator for the inequalries (in this case you cannot get the error with the normal constructor).

If we iterate twice through it (only for number fields), the second time you obviosly don't get anything, which explains the three lines.

One solution may be to make a tuple out of the generators, once we decided what we dispose in `Polyhedron_base.__init__`. The main reason for the generators is that we do not want to generate something, which we dispose of a few lines later.


---

Comment by mkoeppe created at 2020-07-29 17:34:38

Changing priority from major to critical.


---

Comment by jipilab created at 2020-07-30 08:11:03

Found it.

Line 858 and 859 in `backend_normaliz` in the method `_compute_nmz_data_lists_and_field`, which is called by `_init_H_representation`.

The fact that the base ring is enforced to be `AA` while the data is really in `QQ` is taken care of by these 2 lines (normaliz should be used and not Qnormaliz). But! Since dilation ships 2 maps for the Hreps, the `data_lists` are empty at that point!

Ouff! Ok, I think this shouldn't be too hard to fix.

...this is a sign that this use-case was not really tested... It pops up when one wants to deal with lots of sorts of polyhedra and eventually need to fix a base ring (done in Hyperplane arrangements). Oiii.


---

Comment by @kliem created at 2020-07-30 08:28:37

I implemented a few test suite methods already. If you run a test suite on your polyhedron, does it succeed?


---

Comment by jipilab created at 2020-07-30 09:07:18

Changing status from new to needs_review.


---

Comment by jipilab created at 2020-07-30 09:07:18

New commits:


---

Comment by jipilab created at 2020-07-30 09:09:17

Replying to [comment:5 gh-kliem]:
> I implemented a few test suite methods already. If you run a test suite on your polyhedron, does it succeed?

Yes. It seems so.


---

Comment by @kliem created at 2020-07-30 09:43:02

Replying to [comment:7 jipilab]:
> Replying to [comment:5 gh-kliem]:
> > I implemented a few test suite methods already. If you run a test suite on your polyhedron, does it succeed?
> 
> Yes. It seems so.

OK. Then this is a friendly reminder to go on with it.


---

Comment by jipilab created at 2020-08-05 09:07:03

Ping! I think it would be important to have this ticket in the next release...


---

Comment by tscrim created at 2020-08-05 11:07:31

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2020-08-05 11:07:31

LGTM.


---

Comment by vbraun created at 2020-08-09 08:47:31

Resolution: fixed
