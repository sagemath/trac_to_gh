# Issue 10833: shortest path all pairs through BFS computations.

Issue created by migration from Trac.

Original creator: ncohen

Original creation time: 2011-03-10 15:52:03

Assignee: tbd

CC:  ylchapuy mvngu jason rlm

I do not think I can make them faster than that... Perhaps multithreading ? :-p


```
sage: g = graphs.PetersenGraph()
sage: %timeit g.shortest_path_all_pairs(algorithm = "BFS")
625 loops, best of 3: 321 µs per loop
sage: %timeit g.shortest_path_all_pairs(algorithm = "Floyd-Warshall-Cython")
625 loops, best of 3: 466 µs per loop
sage: %timeit g.shortest_path_all_pairs(algorithm = "Floyd-Warshall-Python")
125 loops, best of 3: 5.51 ms per loop
```


```
sage: g = graphs.Grid2dGraph(5,5)
sage: %timeit g.shortest_path_all_pairs(algorithm = "BFS")
125 loops, best of 3: 2.02 ms per loop
sage: %timeit g.shortest_path_all_pairs(algorithm = "Floyd-Warshall-Cython")
125 loops, best of 3: 3.29 ms per loop
sage: %timeit g.shortest_path_all_pairs(algorithm = "Floyd-Warshall-Python")
5 loops, best of 3: 117 ms per loop
```


```
sage: g = graphs.Grid2dGraph(15,15)
sage: %timeit g.shortest_path_all_pairs(algorithm = "BFS")
5 loops, best of 3: 157 ms per loop
sage: %timeit g.shortest_path_all_pairs(algorithm = "Floyd-Warshall-Cython")
5 loops, best of 3: 601 ms per loop
sage: %timeit g.shortest_path_all_pairs(algorithm = "Floyd-Warshall-Python")
Still running..
```


And for larger values ...


```
sage: g = graphs.Grid2dGraph(30,30)
sage: %time d=g.shortest_path_all_pairs(algorithm = "BFS")
CPU times: user 2.75 s, sys: 0.01 s, total: 2.76 s
Wall time: 2.76 s
sage: %time d=g.shortest_path_all_pairs(algorithm = "Floyd-Warshall-Cython")
CPU times: user 34.71 s, sys: 0.08 s, total: 34.80 s
Wall time: 34.87 s
```


Method ``distance_all_pairs``


```
sage: g = graphs.PetersenGraph()
sage: %timeit g.distance_all_pairs(algorithm="BFS")
625 loops, best of 3: 319 µs per loop
sage: %timeit g.distance_all_pairs(algorithm="Floyd-Warshall")
625 loops, best of 3: 222 µs per loop
sage: g = graphs.Grid2dGraph(20,20)
sage: %timeit g.distance_all_pairs(algorithm="BFS")
5 loops, best of 3: 536 ms per loop
sage: %timeit g.distance_all_pairs(algorithm="Floyd-Warshall")
5 loops, best of 3: 2.76 s per loop
```


Even improved, it still does not beat Floyd Warshall for small graphs... So for the moment, I made the ``distance_all_pairs`` method use BFS for graphs on more than 20 vertices and Floyd Warshall otherwise. Tell me if you think it sound.


```
sage: g = graphs.PetersenGraph()
sage: %timeit g.distance_all_pairs()
625 loops, best of 3: 222 µs per loop
sage: g = graphs.Grid2dGraph(20,20)
sage: %timeit g.distance_all_pairs()
5 loops, best of 3: 530 ms per loop
```


Perhaps the reason is that this new method still computes both paths and distances while it is not required for distance_all_pairs...

Nathann


---

Comment by ncohen created at 2011-03-10 15:55:06

Changing status from new to needs_review.


---

Comment by ylchapuy created at 2011-03-10 18:36:41

> I do not think I can make them faster than that...

You can... see the following patch


---

Comment by ylchapuy created at 2011-03-10 18:39:41

apply after trac_10905.patch


---

Attachment

apply both trac_10905.patch and trac10905-efficiency_improvment.patch


---

Comment by ylchapuy created at 2011-03-10 19:00:56

It could even be around 25% faster using 'out_neighbors_unsafe'.
I don't know if its legible to use it.


---

Comment by ylchapuy created at 2011-03-10 20:59:51

Changing component from PLEASE CHANGE to graph theory.


---

Comment by ylchapuy created at 2011-03-10 20:59:51

Changing type from PLEASE CHANGE to enhancement.


---

Attachment


---

Comment by ncohen created at 2011-03-11 15:37:36

Something needs to be done about that though :


```
sage: g = graphs.Grid2dGraph(50,50)
sage: %time d = g.shortest_path_all_pairs()
CPU times: user 6.17 s, sys: 0.25 s, total: 6.42 s
Wall time: 7.68 s
sage: get_memory_usage()
626.47265625
sage: sage: sage: %time d = g.shortest_path_all_pairs()
CPU times: user 9.57 s, sys: 1.32 s, total: 10.89 s
Wall time: 73.24 s
sage: get_memory_usage()
1095.99609375
```


Pretty... unpleasant `:-p`

Nathann


---

Comment by ncohen created at 2011-03-11 15:51:49

> Pretty... unpleasant `:-p`

And most probably the weight of dictionary d in which I store the result of the method. Sorry for that `:-D`

Nathann


---

Comment by ylchapuy created at 2011-03-11 18:43:18

Now that I stopped playing making it faster some remarks for the review:
  * doctest the ValueError (and correct the small bug I guess)
  * same remark as #10855 concerning method vs function (might be irrelevant)
  * in generic_graph.py, lines 11088-11089: typo one Cython should be Python
  * doctest this ValueError too
  * doctest the by_weight stuff

otherwise sounds good


---

Comment by ylchapuy created at 2011-03-11 18:43:18

Changing status from needs_review to needs_work.


---

Comment by ncohen created at 2011-03-13 13:29:28

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2011-03-13 13:40:40

This patch addresses all the comments, except the by_weight stuff which is already tested in the large block of outputs :


```
sage: G.shortest_path_all_pairs(by_weight = True)
```


Nathann


---

Comment by ylchapuy created at 2011-03-14 13:03:36

last patch missing...


---

Attachment


---

Comment by ncohen created at 2011-03-14 13:05:17

I ran some last "sage -t" and forgot it last time... Sorry `^^;`

Nathann


---

Comment by ylchapuy created at 2011-03-15 07:19:16

Changing status from needs_review to positive_review.


---

Comment by ylchapuy created at 2011-03-15 07:19:16

Sounds good to me now. Positive review.


---

Comment by jdemeyer created at 2011-04-12 13:23:55

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2011-04-12 13:23:55

[attachment:trac_10905.patch] needs a proper commit message (use `hg qrefresh -e` to change the message).


---

Comment by ncohen created at 2011-04-12 13:26:21

Done !

Nathann


---

Comment by ncohen created at 2011-04-12 13:26:21

Changing status from needs_work to positive_review.


---

Attachment


---

Comment by jdemeyer created at 2011-04-13 07:43:58

Resolution: fixed
