# Issue 10833: shortest path all pairs through BFS computations.

archive/issues_010833.json:
```json
{
    "body": "Assignee: tbd\n\nCC:  ylchapuy mvngu @jasongrout @rlmill\n\nI do not think I can make them faster than that... Perhaps multithreading ? :-p\n\n\n```\nsage: g = graphs.PetersenGraph()\nsage: %timeit g.shortest_path_all_pairs(algorithm = \"BFS\")\n625 loops, best of 3: 321 \u00b5s per loop\nsage: %timeit g.shortest_path_all_pairs(algorithm = \"Floyd-Warshall-Cython\")\n625 loops, best of 3: 466 \u00b5s per loop\nsage: %timeit g.shortest_path_all_pairs(algorithm = \"Floyd-Warshall-Python\")\n125 loops, best of 3: 5.51 ms per loop\n```\n\n\n```\nsage: g = graphs.Grid2dGraph(5,5)\nsage: %timeit g.shortest_path_all_pairs(algorithm = \"BFS\")\n125 loops, best of 3: 2.02 ms per loop\nsage: %timeit g.shortest_path_all_pairs(algorithm = \"Floyd-Warshall-Cython\")\n125 loops, best of 3: 3.29 ms per loop\nsage: %timeit g.shortest_path_all_pairs(algorithm = \"Floyd-Warshall-Python\")\n5 loops, best of 3: 117 ms per loop\n```\n\n\n```\nsage: g = graphs.Grid2dGraph(15,15)\nsage: %timeit g.shortest_path_all_pairs(algorithm = \"BFS\")\n5 loops, best of 3: 157 ms per loop\nsage: %timeit g.shortest_path_all_pairs(algorithm = \"Floyd-Warshall-Cython\")\n5 loops, best of 3: 601 ms per loop\nsage: %timeit g.shortest_path_all_pairs(algorithm = \"Floyd-Warshall-Python\")\nStill running..\n```\n\n\nAnd for larger values ...\n\n\n```\nsage: g = graphs.Grid2dGraph(30,30)\nsage: %time d=g.shortest_path_all_pairs(algorithm = \"BFS\")\nCPU times: user 2.75 s, sys: 0.01 s, total: 2.76 s\nWall time: 2.76 s\nsage: %time d=g.shortest_path_all_pairs(algorithm = \"Floyd-Warshall-Cython\")\nCPU times: user 34.71 s, sys: 0.08 s, total: 34.80 s\nWall time: 34.87 s\n```\n\n\nMethod ``distance_all_pairs``\n\n\n```\nsage: g = graphs.PetersenGraph()\nsage: %timeit g.distance_all_pairs(algorithm=\"BFS\")\n625 loops, best of 3: 319 \u00b5s per loop\nsage: %timeit g.distance_all_pairs(algorithm=\"Floyd-Warshall\")\n625 loops, best of 3: 222 \u00b5s per loop\nsage: g = graphs.Grid2dGraph(20,20)\nsage: %timeit g.distance_all_pairs(algorithm=\"BFS\")\n5 loops, best of 3: 536 ms per loop\nsage: %timeit g.distance_all_pairs(algorithm=\"Floyd-Warshall\")\n5 loops, best of 3: 2.76 s per loop\n```\n\n\nEven improved, it still does not beat Floyd Warshall for small graphs... So for the moment, I made the ``distance_all_pairs`` method use BFS for graphs on more than 20 vertices and Floyd Warshall otherwise. Tell me if you think it sound.\n\n\n```\nsage: g = graphs.PetersenGraph()\nsage: %timeit g.distance_all_pairs()\n625 loops, best of 3: 222 \u00b5s per loop\nsage: g = graphs.Grid2dGraph(20,20)\nsage: %timeit g.distance_all_pairs()\n5 loops, best of 3: 530 ms per loop\n```\n\n\nPerhaps the reason is that this new method still computes both paths and distances while it is not required for distance_all_pairs...\n\nNathann\n\nIssue created by migration from https://trac.sagemath.org/ticket/10905\n\n",
    "created_at": "2011-03-10T15:52:03Z",
    "labels": [
        "component: please change"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.7",
    "title": "shortest path all pairs through BFS computations.",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10833",
    "user": "https://github.com/nathanncohen"
}
```
Assignee: tbd

CC:  ylchapuy mvngu @jasongrout @rlmill

I do not think I can make them faster than that... Perhaps multithreading ? :-p


```
sage: g = graphs.PetersenGraph()
sage: %timeit g.shortest_path_all_pairs(algorithm = "BFS")
625 loops, best of 3: 321 µs per loop
sage: %timeit g.shortest_path_all_pairs(algorithm = "Floyd-Warshall-Cython")
625 loops, best of 3: 466 µs per loop
sage: %timeit g.shortest_path_all_pairs(algorithm = "Floyd-Warshall-Python")
125 loops, best of 3: 5.51 ms per loop
```


```
sage: g = graphs.Grid2dGraph(5,5)
sage: %timeit g.shortest_path_all_pairs(algorithm = "BFS")
125 loops, best of 3: 2.02 ms per loop
sage: %timeit g.shortest_path_all_pairs(algorithm = "Floyd-Warshall-Cython")
125 loops, best of 3: 3.29 ms per loop
sage: %timeit g.shortest_path_all_pairs(algorithm = "Floyd-Warshall-Python")
5 loops, best of 3: 117 ms per loop
```


```
sage: g = graphs.Grid2dGraph(15,15)
sage: %timeit g.shortest_path_all_pairs(algorithm = "BFS")
5 loops, best of 3: 157 ms per loop
sage: %timeit g.shortest_path_all_pairs(algorithm = "Floyd-Warshall-Cython")
5 loops, best of 3: 601 ms per loop
sage: %timeit g.shortest_path_all_pairs(algorithm = "Floyd-Warshall-Python")
Still running..
```


And for larger values ...


```
sage: g = graphs.Grid2dGraph(30,30)
sage: %time d=g.shortest_path_all_pairs(algorithm = "BFS")
CPU times: user 2.75 s, sys: 0.01 s, total: 2.76 s
Wall time: 2.76 s
sage: %time d=g.shortest_path_all_pairs(algorithm = "Floyd-Warshall-Cython")
CPU times: user 34.71 s, sys: 0.08 s, total: 34.80 s
Wall time: 34.87 s
```


Method ``distance_all_pairs``


```
sage: g = graphs.PetersenGraph()
sage: %timeit g.distance_all_pairs(algorithm="BFS")
625 loops, best of 3: 319 µs per loop
sage: %timeit g.distance_all_pairs(algorithm="Floyd-Warshall")
625 loops, best of 3: 222 µs per loop
sage: g = graphs.Grid2dGraph(20,20)
sage: %timeit g.distance_all_pairs(algorithm="BFS")
5 loops, best of 3: 536 ms per loop
sage: %timeit g.distance_all_pairs(algorithm="Floyd-Warshall")
5 loops, best of 3: 2.76 s per loop
```


Even improved, it still does not beat Floyd Warshall for small graphs... So for the moment, I made the ``distance_all_pairs`` method use BFS for graphs on more than 20 vertices and Floyd Warshall otherwise. Tell me if you think it sound.


```
sage: g = graphs.PetersenGraph()
sage: %timeit g.distance_all_pairs()
625 loops, best of 3: 222 µs per loop
sage: g = graphs.Grid2dGraph(20,20)
sage: %timeit g.distance_all_pairs()
5 loops, best of 3: 530 ms per loop
```


Perhaps the reason is that this new method still computes both paths and distances while it is not required for distance_all_pairs...

Nathann

Issue created by migration from https://trac.sagemath.org/ticket/10905





---

archive/issue_comments_114691.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-03-10T15:55:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10833",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10833#issuecomment-114691",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_114692.json:
```json
{
    "body": "> I do not think I can make them faster than that...\n\nYou can... see the following patch",
    "created_at": "2011-03-10T18:36:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10833",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10833#issuecomment-114692",
    "user": "https://trac.sagemath.org/admin/accounts/users/ylchapuy"
}
```

> I do not think I can make them faster than that...

You can... see the following patch



---

archive/issue_comments_114693.json:
```json
{
    "body": "apply after trac_10905.patch",
    "created_at": "2011-03-10T18:39:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10833",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10833#issuecomment-114693",
    "user": "https://trac.sagemath.org/admin/accounts/users/ylchapuy"
}
```

apply after trac_10905.patch



---

archive/issue_comments_114694.json:
```json
{
    "body": "Attachment [trac10905-efficiency_improvment.patch](tarball://root/attachments/some-uuid/ticket10905/trac10905-efficiency_improvment.patch) by ylchapuy created at 2011-03-10 18:40:07\n\napply both trac_10905.patch and trac10905-efficiency_improvment.patch",
    "created_at": "2011-03-10T18:40:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10833",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10833#issuecomment-114694",
    "user": "https://trac.sagemath.org/admin/accounts/users/ylchapuy"
}
```

Attachment [trac10905-efficiency_improvment.patch](tarball://root/attachments/some-uuid/ticket10905/trac10905-efficiency_improvment.patch) by ylchapuy created at 2011-03-10 18:40:07

apply both trac_10905.patch and trac10905-efficiency_improvment.patch



---

archive/issue_comments_114695.json:
```json
{
    "body": "It could even be around 25% faster using 'out_neighbors_unsafe'.\nI don't know if its legible to use it.",
    "created_at": "2011-03-10T19:00:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10833",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10833#issuecomment-114695",
    "user": "https://trac.sagemath.org/admin/accounts/users/ylchapuy"
}
```

It could even be around 25% faster using 'out_neighbors_unsafe'.
I don't know if its legible to use it.



---

archive/issue_comments_114696.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to graph theory.",
    "created_at": "2011-03-10T20:59:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10833",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10833#issuecomment-114696",
    "user": "https://trac.sagemath.org/admin/accounts/users/ylchapuy"
}
```

Changing component from PLEASE CHANGE to graph theory.



---

archive/issue_comments_114697.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2011-03-10T20:59:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10833",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10833#issuecomment-114697",
    "user": "https://trac.sagemath.org/admin/accounts/users/ylchapuy"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_114698.json:
```json
{
    "body": "Attachment [trac10905-improve_via_out_neighbors_unsafe.patch](tarball://root/attachments/some-uuid/ticket10905/trac10905-improve_via_out_neighbors_unsafe.patch) by ylchapuy created at 2011-03-11 06:13:00",
    "created_at": "2011-03-11T06:13:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10833",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10833#issuecomment-114698",
    "user": "https://trac.sagemath.org/admin/accounts/users/ylchapuy"
}
```

Attachment [trac10905-improve_via_out_neighbors_unsafe.patch](tarball://root/attachments/some-uuid/ticket10905/trac10905-improve_via_out_neighbors_unsafe.patch) by ylchapuy created at 2011-03-11 06:13:00



---

archive/issue_comments_114699.json:
```json
{
    "body": "Something needs to be done about that though :\n\n\n```\nsage: g = graphs.Grid2dGraph(50,50)\nsage: %time d = g.shortest_path_all_pairs()\nCPU times: user 6.17 s, sys: 0.25 s, total: 6.42 s\nWall time: 7.68 s\nsage: get_memory_usage()\n626.47265625\nsage: sage: sage: %time d = g.shortest_path_all_pairs()\nCPU times: user 9.57 s, sys: 1.32 s, total: 10.89 s\nWall time: 73.24 s\nsage: get_memory_usage()\n1095.99609375\n```\n\n\nPretty... unpleasant `:-p`\n\nNathann",
    "created_at": "2011-03-11T15:37:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10833",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10833#issuecomment-114699",
    "user": "https://github.com/nathanncohen"
}
```

Something needs to be done about that though :


```
sage: g = graphs.Grid2dGraph(50,50)
sage: %time d = g.shortest_path_all_pairs()
CPU times: user 6.17 s, sys: 0.25 s, total: 6.42 s
Wall time: 7.68 s
sage: get_memory_usage()
626.47265625
sage: sage: sage: %time d = g.shortest_path_all_pairs()
CPU times: user 9.57 s, sys: 1.32 s, total: 10.89 s
Wall time: 73.24 s
sage: get_memory_usage()
1095.99609375
```


Pretty... unpleasant `:-p`

Nathann



---

archive/issue_comments_114700.json:
```json
{
    "body": "> Pretty... unpleasant `:-p`\n\nAnd most probably the weight of dictionary d in which I store the result of the method. Sorry for that `:-D`\n\nNathann",
    "created_at": "2011-03-11T15:51:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10833",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10833#issuecomment-114700",
    "user": "https://github.com/nathanncohen"
}
```

> Pretty... unpleasant `:-p`

And most probably the weight of dictionary d in which I store the result of the method. Sorry for that `:-D`

Nathann



---

archive/issue_comments_114701.json:
```json
{
    "body": "Now that I stopped playing making it faster some remarks for the review:\n* doctest the ValueError (and correct the small bug I guess)\n* same remark as #10855 concerning method vs function (might be irrelevant)\n* in generic_graph.py, lines 11088-11089: typo one Cython should be Python\n* doctest this ValueError too\n* doctest the by_weight stuff\n\notherwise sounds good",
    "created_at": "2011-03-11T18:43:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10833",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10833#issuecomment-114701",
    "user": "https://trac.sagemath.org/admin/accounts/users/ylchapuy"
}
```

Now that I stopped playing making it faster some remarks for the review:
* doctest the ValueError (and correct the small bug I guess)
* same remark as #10855 concerning method vs function (might be irrelevant)
* in generic_graph.py, lines 11088-11089: typo one Cython should be Python
* doctest this ValueError too
* doctest the by_weight stuff

otherwise sounds good



---

archive/issue_comments_114702.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-03-11T18:43:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10833",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10833#issuecomment-114702",
    "user": "https://trac.sagemath.org/admin/accounts/users/ylchapuy"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_114703.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-03-13T13:29:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10833",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10833#issuecomment-114703",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_114704.json:
```json
{
    "body": "This patch addresses all the comments, except the by_weight stuff which is already tested in the large block of outputs :\n\n\n```\nsage: G.shortest_path_all_pairs(by_weight = True)\n```\n\n\nNathann",
    "created_at": "2011-03-13T13:40:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10833",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10833#issuecomment-114704",
    "user": "https://github.com/nathanncohen"
}
```

This patch addresses all the comments, except the by_weight stuff which is already tested in the large block of outputs :


```
sage: G.shortest_path_all_pairs(by_weight = True)
```


Nathann



---

archive/issue_comments_114705.json:
```json
{
    "body": "last patch missing...",
    "created_at": "2011-03-14T13:03:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10833",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10833#issuecomment-114705",
    "user": "https://trac.sagemath.org/admin/accounts/users/ylchapuy"
}
```

last patch missing...



---

archive/issue_comments_114706.json:
```json
{
    "body": "Attachment [trac_10905-doctests.patch](tarball://root/attachments/some-uuid/ticket10905/trac_10905-doctests.patch) by @nathanncohen created at 2011-03-14 13:04:40",
    "created_at": "2011-03-14T13:04:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10833",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10833#issuecomment-114706",
    "user": "https://github.com/nathanncohen"
}
```

Attachment [trac_10905-doctests.patch](tarball://root/attachments/some-uuid/ticket10905/trac_10905-doctests.patch) by @nathanncohen created at 2011-03-14 13:04:40



---

archive/issue_comments_114707.json:
```json
{
    "body": "I ran some last \"sage -t\" and forgot it last time... Sorry `^^;`\n\nNathann",
    "created_at": "2011-03-14T13:05:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10833",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10833#issuecomment-114707",
    "user": "https://github.com/nathanncohen"
}
```

I ran some last "sage -t" and forgot it last time... Sorry `^^;`

Nathann



---

archive/issue_comments_114708.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-03-15T07:19:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10833",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10833#issuecomment-114708",
    "user": "https://trac.sagemath.org/admin/accounts/users/ylchapuy"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_114709.json:
```json
{
    "body": "Sounds good to me now. Positive review.",
    "created_at": "2011-03-15T07:19:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10833",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10833#issuecomment-114709",
    "user": "https://trac.sagemath.org/admin/accounts/users/ylchapuy"
}
```

Sounds good to me now. Positive review.



---

archive/issue_comments_114710.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2011-04-12T13:23:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10833",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10833#issuecomment-114710",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_114711.json:
```json
{
    "body": "[attachment:trac_10905.patch] needs a proper commit message (use `hg qrefresh -e` to change the message).",
    "created_at": "2011-04-12T13:23:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10833",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10833#issuecomment-114711",
    "user": "https://github.com/jdemeyer"
}
```

[attachment:trac_10905.patch] needs a proper commit message (use `hg qrefresh -e` to change the message).



---

archive/issue_comments_114712.json:
```json
{
    "body": "Done !\n\nNathann",
    "created_at": "2011-04-12T13:26:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10833",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10833#issuecomment-114712",
    "user": "https://github.com/nathanncohen"
}
```

Done !

Nathann



---

archive/issue_comments_114713.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2011-04-12T13:26:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10833",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10833#issuecomment-114713",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_114714.json:
```json
{
    "body": "Attachment [trac_10905.patch](tarball://root/attachments/some-uuid/ticket10905/trac_10905.patch) by @nathanncohen created at 2011-04-12 13:26:41",
    "created_at": "2011-04-12T13:26:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10833",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10833#issuecomment-114714",
    "user": "https://github.com/nathanncohen"
}
```

Attachment [trac_10905.patch](tarball://root/attachments/some-uuid/ticket10905/trac_10905.patch) by @nathanncohen created at 2011-04-12 13:26:41



---

archive/issue_comments_114715.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-04-13T07:43:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10833",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10833#issuecomment-114715",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
