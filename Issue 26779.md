# Issue 26779: DESTDIR support for gcc, improvements to gfortran

Issue created by migration from https://trac.sagemath.org/ticket/27016

Original creator: embray

Original creation time: 2019-01-04 11:19:11

CC:  vbraun dimpase jdemeyer konrad127123

Keywords: destdir gcc

This does a few things:

* Updates the gcc SPKG to support DESTDIR installation so that it can now be uninstalled as well

* This includes a patch (adapted from Debian) to make gcc install libraries to `${prefix}/lib` instead of `${prefix}/lib64` on Linux (this does not appear to be a problem on Cygwin, macOS, or FreeBSD that I'm aware of).

* Additional refactoring to reduce duplication between the gcc and gfortran SPKGs: This includes the patches from gcc as the can also be relevant to gfortran.

I've tested this a good bit on Linux (being able to uninstall gcc now is nice), but it needs more testing on other platforms, particularly macOS since it's the primary case for installing this package in the first place, and involves additional workarounds.

This would also fix #26996 for the case of installing gfortran on Linux.


---

Comment by embray created at 2019-01-04 11:19:22

Changing status from new to needs_review.


---

Comment by embray created at 2019-01-22 12:30:28

Pinging a few people who might be interested in reviewing this ticket.  If not, sorry for the noise--you can remove yourself from the CC field.


---

Comment by dimpase created at 2019-01-22 18:07:53

test, please ignore


---

Comment by jhpalmieri created at 2019-01-22 18:13:28

I only have access to OS X, so I have removed myself. 

By the way, once you are on the cc list, there is no apparent way to remove yourself. I removed myself and asked Dima to send a test message, which I received. (Thanks, Dima!) I don't mind, I can handle a few extra email messages. But I wonder if there is a way to fix this aspect of trac's configuration for those who are actually bothered by extra trac messages.

I suppose one other thing to try is to have someone else do the removal from the cc list: it may be that once someone displays any activity on the ticket, they are automatically cc'ed after that, even if their only activity was to remove their name from the cc list. If someone else has to do it, that's a lot of effort to be removed from the cc list.


---

Comment by embray created at 2019-01-23 12:06:36

Replying to [comment:5 jhpalmieri]:
> I only have access to OS X, so I have removed myself. 

Actually that's a large part of why I pinged you.  Although this was motivated by fixing an issue on Linux, OSX is the primary reason we package gcc and gfortran at all.  And since this reworks those packages a bit it needs OSX testing.  Plus, whatever disagreements we've had in the past, your reviews are always thorough and thoughtful.  If you don't have time though no problem--I have SSH access to an OSX machine now too (10.14 I believe).

> By the way, once you are on the cc list, there is no apparent way to remove yourself. I removed myself and asked Dima to send a test message, which I received. (Thanks, Dima!) I don't mind, I can handle a few extra email messages. But I wonder if there is a way to fix this aspect of trac's configuration for those who are actually bothered by extra trac messages.

Hmm, that is annoying.  I believe that once you comment on a trac ticket you're "subscribed" to it, even if your only interaction was to remove yourself from the CC list.  

Notification settings are on https://trac.sagemath.org/prefs/notification and you want to make sure to _not_ have "Ticket that I previously updated is modified" selected.  Unfortunately I don't think there's otherwise a built-in way to "unsubscribe" from a specific ticket.


---

Comment by slelievre created at 2019-01-24 16:30:58

The un-cc-ing problem has been discussed before.

I just opened a wiki page here with pointers to relevant pages on Trac's Trac:

- [SageTracNotification](SageTracNotification)


---

Comment by jhpalmieri created at 2019-01-24 20:15:04

Replying to [comment:6 embray]:
> Replying to [comment:5 jhpalmieri]:
> > I only have access to OS X, so I have removed myself. 
> 
> Actually that's a large part of why I pinged you.  Although this was motivated by fixing an issue on Linux, OSX is the primary reason we package gcc and gfortran at all.  And since this reworks those packages a bit it needs OSX testing.  Plus, whatever disagreements we've had in the past, your reviews are always thorough and thoughtful.  If you don't have time though no problem--I have SSH access to an OSX machine now too (10.14 I believe).

Sorry, I misread something in the ticket description so I thought it didn't apply.

I don't know if I will have the time. I have installed gfortran on all of my OS X machines precisely so I don't have to build Sage's gcc each time I build Sage, so I would have to temporarily hide gfortran, build with and without this branch, making sure everything works as advertised. If I stumble on some free time soon I will try to do it, but it may not happen.


---

Comment by embray created at 2019-01-31 12:47:03

I've tested this on OSX and had success.  As I had hoped it doesn't ultimately change anything about how gcc is built and installed on OSX. In other words, nothing changed functionality-wise as intended.  This is just mostly refactoring.


---

Comment by dimpase created at 2019-01-31 16:46:13

I found out I cannot really test this on FreeBSD 12.0, as building of gfortran fails due to some cryptic linker-related problem I don't want to look into (it's not a problem for that platform per se, as it has a luxurious choice of two free fortran compilers, gfortran and flang).


---

Comment by embray created at 2019-01-31 16:47:57

Replying to [comment:10 dimpase]:
> I found out I cannot really test this on FreeBSD 12.0, as building of gfortran fails due to some cryptic linker-related problem I don't want to look into (it's not a problem for that platform per se, as it has a luxurious choice of two free fortran compilers, gfortran and flang).

Is that true, I'm guessing, even without this patch?


---

Comment by dimpase created at 2019-01-31 17:05:49

Replying to [comment:11 embray]:
> Replying to [comment:10 dimpase]:
> > I found out I cannot really test this on FreeBSD 12.0, as building of gfortran fails due to some cryptic linker-related problem I don't want to look into (it's not a problem for that platform per se, as it has a luxurious choice of two free fortran compilers, gfortran and flang).
> 
> Is that true, I'm guessing, even without this patch?

Correct. Sorry for not saying this right.


---

Comment by embray created at 2019-02-01 14:27:53

That's okay, I just wanted to make sure that was the case.  Even if FreeBSD support is still not 100% I wouldn't want to make it _worse_ somehow.


---

Comment by dimpase created at 2019-02-11 10:24:39

let me check that you don't break using FC=flang


---

Comment by embray created at 2019-02-11 10:32:37

Hahah ^^; should that work at all in the first place?  When you say "using FC=flang" do you mean just `export FC=flang` to the environment?

To be clear, I don't think this changes anything in what happens when you run `./configure`.  It does mainly two things:

* Refactors the `spkg-build`/`spkg-install` for the gfortran package so that it does not duplicate much effort from the gcc SPKG.

* Adds the Debian-inspired patch for gcc so that it doesn't install libraries to `${prefix}/lib64` on Linux


---

Comment by dimpase created at 2019-02-18 16:57:10

Lgtm


---

Comment by dimpase created at 2019-02-19 13:44:56

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-02-22 22:01:08

Resolution: fixed
