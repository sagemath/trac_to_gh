# Issue 32312: Remove package mpir

Issue created by migration from https://trac.sagemath.org/ticket/32549

Original creator: mkoeppe

Original creation time: 2021-09-22 02:59:56

CC:  jhpalmieri mjo dimpase â€‹wbhart brg@gladman.plus.com riemannic@gmail.com

MPIR, a fork of GMP, has not been updated upstream. The latest release, 3.0.0, is from 2017-03-01 (https://mpir.org/downloads.html). 

Sage currently provides an SPKG for MPIR as a configurable alternative to GMP. We should remove this option and package, as previously suggested in #29620#comment:10

 


---

Comment by tmonteil created at 2021-09-22 09:49:23

It seems there are some commits since then (the last is from December 2020 for Linux version and August 2021 for Windows version), perhaps should we ask to the people involved in MPIR how they see the future of MPIR ?


---

Comment by mjo created at 2021-09-22 13:50:06

+1

Regardless of the state of MPIR upstream, sage never really developed a coherent plan for packages that are substitutes for one another. The `./configure` options that are available now don't really make sense, and the best thing to do for our end users is to eliminate the confusion (if also the choice). If someone later wants to overhaul the build system to handle these choices consistently, then OK; but I don't think anyone does right now.


---

Comment by dimpase created at 2021-09-22 15:49:15

The upstream (Bill) told me some time ago that due to Spectre and other CPU vulns discovered few years ago, parts of MPIR became obsolete, as speedups there relied on CPUs being unpatched.

IMHO it's semi-abandonware now.


---

Comment by mkoeppe created at 2021-09-22 15:57:29

Replying to [comment:2 mjo]:
> sage never really developed a coherent plan for packages that are substitutes for one another. The `./configure` options that are available now don't really make sense
#29620 tracks this


---

Comment by mkoeppe created at 2021-09-23 03:29:08

New commits:


---

Comment by mkoeppe created at 2021-09-23 03:29:08

Changing status from new to needs_review.


---

Comment by git created at 2021-09-23 03:34:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2021-09-23 04:11:35

There are a few references to yasm: a comment in `m4/sage_spkg_configure.m4` and many mentions in `doc/en/developer/portability_testing.rst`.


---

Comment by git created at 2021-09-23 04:13:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-09-23 04:16:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-09-23 04:20:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-09-23 04:28:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-09-23 04:34:06

In two places of the Sage library, also `'mpir'` appears as a possible value of an `algorithm` parameter:

```
src/sage/arith/misc.py:        sage: a = binomial(100, 45, algorithm='mpir')
src/sage/rings/integer.pyx:    def binomial(self, m, algorithm='mpir'):
```



---

Comment by git created at 2021-09-23 04:39:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-09-23 08:22:03

Replying to [comment:13 mkoeppe]:
> In two places of the Sage library, also `'mpir'` appears as a possible value of an `algorithm` parameter:
> {{{
> src/sage/arith/misc.py:        sage: a = binomial(100, 45, algorithm='mpir')
> src/sage/rings/integer.pyx:    def binomial(self, m, algorithm='mpir'):
> }}}

this option should be renamed `gmp`, and respective tests should drop `# optional` tag.
Indeed, it just calls a gmp/mpir function (which are more or less the same, and mpir provided a replacement for gmp there).

```
sage: 100.binomial(45, algorithm='mpir')
61448471214136179596720592960
```

see, it still works, without any mpir installed.


---

Comment by git created at 2021-09-23 14:43:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-09-23 14:47:23

Replying to [comment:15 dimpase]:
> this option should be renamed `gmp`

I have kept `mpir` as an alias, without deprecation warnings; after all, if we use system GMP, that could as well be MPIR


---

Comment by dimpase created at 2021-09-23 15:27:35

there is still an `#optional : mpir` tag in integer.pyx, line 6427.
And analogous `gmp` tag few lines down.


---

Comment by git created at 2021-09-23 16:23:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-09-23 16:23:55

Replying to [comment:18 dimpase]:
> there is still an `#optional : mpir` tag in integer.pyx, line 6427.
> And analogous `gmp` tag few lines down.
These doctests weren't actually being run because neither `mpir` nor `gmp` were optional packages. I've rewritten it in a less specific way, it now runs


---

Comment by git created at 2021-09-23 16:30:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2021-09-23 20:01:26

There is a similar test in `src/sage/ext/memory.pyx`. We can also remove `mpir` from `COPYING.txt`. (Was there ever talk of autogenerating that file? Each package could have a file `license.txt`...)


---

Comment by jhpalmieri created at 2021-09-23 21:57:55

Also in `m4/sage_spkg_collect.m4`:

```
    # Packages that should be included in the source distribution
    # This includes all standard packages and two special cases
    case "$SPKG_NAME" in
    mpir)
        in_sdist=yes
        ;;
    esac
```



---

Comment by jhpalmieri created at 2021-09-23 22:01:42

I don't understand this comment, line 286 in `src/sage/all.py`:

```
    # Free globally allocated mpir integers.
```

Just delete the comment and leave the code? Replace the comment with something else? Remove the code?


---

Comment by jhpalmieri created at 2021-09-23 22:02:52

Here are some proposed changes:

```diff
diff --git a/COPYING.txt b/COPYING.txt
index 2da3a8e492..7ce750a1aa 100644
--- a/COPYING.txt
+++ b/COPYING.txt
@@ -86,7 +86,6 @@ mistune                     Modified BSD
 mpc                         LGPLv3+
 mpfi                        COPYING is GPLv2, source files state LGPLv2.1+
 mpfr                        LGPLv3+
-mpir                        LGPLv3+
 mpmath                      Modified BSD
 networkx                    Modified BSD
 ntl                         GPLv2+
diff --git a/build/pkgs/ecm/spkg-configure.m4 b/build/pkgs/ecm/spkg-configure.m4
index e62c21cb32..d5302a89fb 100644
--- a/build/pkgs/ecm/spkg-configure.m4
+++ b/build/pkgs/ecm/spkg-configure.m4
@@ -1,7 +1,7 @@
 SAGE_SPKG_CONFIGURE([ecm], [
     m4_pushdef([SAGE_ECM_MINVER],[7.0.4])
     AC_REQUIRE([SAGE_SPKG_CONFIGURE_GMP])
-    AC_MSG_CHECKING([installing gmp/mpir? ])
+    AC_MSG_CHECKING([installing gmp? ])
     if test x$sage_spkg_install_gmp = xyes; then
         AC_MSG_RESULT([yes; install ecm as well])
         sage_spkg_install_ecm=yes
diff --git a/build/pkgs/gdb/SPKG.rst b/build/pkgs/gdb/SPKG.rst
index b89773fe67..0716ac53fa 100644
--- a/build/pkgs/gdb/SPKG.rst
+++ b/build/pkgs/gdb/SPKG.rst
@@ -19,17 +19,6 @@ Upstream Contact
 
 http://www.gnu.org/software/gdb/
 
-Dependencies
-------------
-
--  python
--  mpc
--  mpfr
--  ppl
--  gmp/mpir
--  makeinfo (external)
-
-
 Special Update/Build Instructions
 ---------------------------------
 
diff --git a/build/pkgs/isl/spkg-configure.m4 b/build/pkgs/isl/spkg-configure.m4
index 1b16f70870..d7bbef80c6 100644
--- a/build/pkgs/isl/spkg-configure.m4
+++ b/build/pkgs/isl/spkg-configure.m4
@@ -1,6 +1,6 @@
 SAGE_SPKG_CONFIGURE([isl], [
     AC_REQUIRE([SAGE_SPKG_CONFIGURE_GMP])
-    AC_MSG_CHECKING([installing gmp/mpir? ])
+    AC_MSG_CHECKING([installing gmp? ])
     if test x$sage_spkg_install_gmp = xyes; then
         AC_MSG_RESULT([yes; install isl as well])
         sage_spkg_install_isl=yes
diff --git a/build/pkgs/mpfr/spkg-configure.m4 b/build/pkgs/mpfr/spkg-configure.m4
index 2300be6707..f64ede4b75 100644
--- a/build/pkgs/mpfr/spkg-configure.m4
+++ b/build/pkgs/mpfr/spkg-configure.m4
@@ -1,6 +1,6 @@
 SAGE_SPKG_CONFIGURE([mpfr], [
     AC_REQUIRE([SAGE_SPKG_CONFIGURE_GMP])
-    AC_MSG_CHECKING([installing gmp/mpir? ])
+    AC_MSG_CHECKING([installing gmp? ])
     if test x$sage_spkg_install_gmp = xyes; then
         AC_MSG_RESULT([yes; install mpfr as well])
         sage_spkg_install_mpfr=yes
diff --git a/m4/sage_spkg_collect.m4 b/m4/sage_spkg_collect.m4
index 1ab62d6fa4..c364ab62b7 100644
--- a/m4/sage_spkg_collect.m4
+++ b/m4/sage_spkg_collect.m4
@@ -259,14 +259,6 @@ for DIR in $SAGE_ROOT/build/pkgs/*; do
         AS_VAR_POPDEF([sage_require])dnl
         AS_VAR_POPDEF([sage_spkg_install])dnl
 
-    # Packages that should be included in the source distribution
-    # This includes all standard packages and two special cases
-    case "$SPKG_NAME" in
-    mpir)
-        in_sdist=yes
-        ;;
-    esac
-
     # Determine package source
     #
     if test -f "$DIR/requirements.txt"; then
```



---

Comment by mkoeppe created at 2021-09-23 22:16:10

All looking fine, please push them to the ticket


---

Comment by jhpalmieri created at 2021-09-23 22:25:20

Replying to [comment:26 mkoeppe]:
> All looking fine, please push them to the ticket

Done
----
New commits:


---

Comment by dimpase created at 2021-09-26 08:25:10

Let's use this ticket to update to consistently use `SAGE_SPKG_DEPCHECK` instead of that `if test ...` in all the packages affected.


---

Comment by dimpase created at 2021-09-26 09:24:09

the monster isn't completely gone yet:

```
build//pkgs/ppl/spkg-install.in:# Make sure that we prefer Sage's mpir library over system-wide gmp/mpir installs
src/doc/it/faq/faq-usage.rst:    rm spkg/installed/mpir* spkg/installed/atlas*
src/doc/it/faq/faq-general.rst:`MPIR <http://www.mpir.org>`_,
src/doc/en/faq/faq-usage.rst:    $ rm spkg/installed/mpir* spkg/installed/atlas*
src/doc/en/faq/faq-general.rst:`MPIR <http://www.mpir.org>`_,
src/sage/ext_data/valgrind/sage-additional.supp:   fun:sage_mpir_malloc
src/sage/ext_data/valgrind/sage-additional.supp:   mpir_realloc
src/sage/ext_data/valgrind/sage-additional.supp:   fun:sage_mpir_realloc
src/sage/ext/memory.pyx:    sage: 2^(2^63-2)      # optional - mpir
src/sage/all.py:    # Free globally allocated mpir integers.
```

taking care of this now.
----
New commits:


---

Comment by git created at 2021-09-26 09:49:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-09-26 18:30:28

Looking good. Let's merge #30350 (ATLAS removal) to resolve merge conflicts in the documentation and other places


---

Comment by git created at 2021-09-26 18:37:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-09-26 19:20:10

there were a couple of docbuild errors in FAQs  in my branch. Should merge the  latest commit from `u/dimpase/remove_package_mpir`


---

Comment by git created at 2021-09-26 19:56:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-09-26 20:49:40

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2021-09-26 20:49:40

OK, this works.


---

Comment by vbraun created at 2021-10-10 10:20:32

Merge conflict


---

Comment by vbraun created at 2021-10-10 10:20:32

Changing status from positive_review to needs_work.


---

Comment by git created at 2021-10-10 17:40:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-10-10 17:41:24

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2021-10-13 22:51:04

Resolution: fixed


---

Comment by was created at 2021-10-20 18:04:57

> perhaps should we ask to the people involved in MPIR how they see the future of MPIR ?

Bill also told me recently that MPIR is not going forward at this point for a combination of reasons.  +1 to this ticket.
