# Issue 30954: ubuntu-bionic-standard (python 3.6): make ptest fails with UnicodeDecodeError

Issue created by migration from https://trac.sagemath.org/ticket/31191

Original creator: mkoeppe

Original creation time: 2021-01-06 18:57:17

CC:  @kliem dimpase jhpalmieri

(from #29913)

â€‹https://github.com/mkoeppe/sage/runs/1583194874?check_suite_focus=true


---

Comment by mkoeppe created at 2021-01-06 21:30:58

Unclear where this is coming from - perhaps a source file without `coding` header?


---

Comment by mkoeppe created at 2021-02-13 04:51:06

Something has changed on `ubuntu-bionic` since the fixes we made for Sage 9.2 (#30576). Now system python3.6 misbehaves although all `LC_*/LANG` variables are unset.

The specific failure can be fixed like this:

```diff
diff --git a/src/sage/doctest/control.py b/src/sage/doctest/control.py
index 7d2b84b9c3..ef5ec5c2e5 100644
--- a/src/sage/doctest/control.py
+++ b/src/sage/doctest/control.py
@@ -223,7 +223,7 @@ def skipfile(filename):
     base, ext = os.path.splitext(filename)
     if ext not in ('.py', '.pyx', '.pxd', '.pxi', '.sage', '.spyx', '.rst', '.tex'):
         return True
-    with open(filename) as F:
+    with open(filename, encoding="utf-8", errors="ignore") as F:
         line_count = 0
         for line in F:
             if nodoctest_regex.match(line):
```

but after that some individual doctest have similar unicode errors.  
Setting the locale (for example `LANG=C.UTF-8 make ptest`) fixes all of these errors.


---

Comment by mkoeppe created at 2021-02-13 05:11:20

Likely this patch has made its way into ubuntu-bionic security updates. https://github.com/python/cpython/pull/8975/files


---

Comment by mkoeppe created at 2021-02-13 05:23:24

That patch makes it sound as if the change is specific to FreeBSD, but I don't see that in the actual changes.


---

Comment by mkoeppe created at 2021-02-13 07:09:15

New commits:


---

Comment by mkoeppe created at 2021-02-13 07:09:15

Changing status from new to needs_review.


---

Comment by @kliem created at 2021-02-14 20:45:52

I think it is fine.

https://github.com/kliem/sage/pull/39/checks


---

Comment by mkoeppe created at 2021-02-14 21:53:44

Thanks for testing! I didn't expect difficulties


---

Comment by @kliem created at 2021-02-15 06:56:39

LGTM.


---

Comment by @kliem created at 2021-02-15 06:56:39

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-02-15 07:02:16

Thank you!


---

Comment by vbraun created at 2021-03-01 00:21:22

Resolution: fixed
