# Issue 30954: ubuntu-bionic-standard (python 3.6): make ptest fails with UnicodeDecodeError

archive/issues_030954.json:
```json
{
    "body": "CC:  @kliem @dimpase @jhpalmieri\n\n(from #29913)\n\n\u200bhttps://github.com/mkoeppe/sage/runs/1583194874?check_suite_focus=true\n\nIssue created by migration from https://trac.sagemath.org/ticket/31191\n\n",
    "created_at": "2021-01-06T18:57:17Z",
    "labels": [
        "doctest framework",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "ubuntu-bionic-standard (python 3.6): make ptest fails with UnicodeDecodeError",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30954",
    "user": "@mkoeppe"
}
```
CC:  @kliem @dimpase @jhpalmieri

(from #29913)

â€‹https://github.com/mkoeppe/sage/runs/1583194874?check_suite_focus=true

Issue created by migration from https://trac.sagemath.org/ticket/31191





---

archive/issue_comments_442085.json:
```json
{
    "body": "Unclear where this is coming from - perhaps a source file without `coding` header?",
    "created_at": "2021-01-06T21:30:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30954#issuecomment-442085",
    "user": "@mkoeppe"
}
```

Unclear where this is coming from - perhaps a source file without `coding` header?



---

archive/issue_comments_442086.json:
```json
{
    "body": "Something has changed on `ubuntu-bionic` since the fixes we made for Sage 9.2 (#30576). Now system python3.6 misbehaves although all `LC_*/LANG` variables are unset.\n\nThe specific failure can be fixed like this:\n\n```diff\ndiff --git a/src/sage/doctest/control.py b/src/sage/doctest/control.py\nindex 7d2b84b9c3..ef5ec5c2e5 100644\n--- a/src/sage/doctest/control.py\n+++ b/src/sage/doctest/control.py\n@@ -223,7 +223,7 @@ def skipfile(filename):\n     base, ext = os.path.splitext(filename)\n     if ext not in ('.py', '.pyx', '.pxd', '.pxi', '.sage', '.spyx', '.rst', '.tex'):\n         return True\n-    with open(filename) as F:\n+    with open(filename, encoding=\"utf-8\", errors=\"ignore\") as F:\n         line_count = 0\n         for line in F:\n             if nodoctest_regex.match(line):\n```\n\nbut after that some individual doctest have similar unicode errors.  \nSetting the locale (for example `LANG=C.UTF-8 make ptest`) fixes all of these errors.",
    "created_at": "2021-02-13T04:51:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30954#issuecomment-442086",
    "user": "@mkoeppe"
}
```

Something has changed on `ubuntu-bionic` since the fixes we made for Sage 9.2 (#30576). Now system python3.6 misbehaves although all `LC_*/LANG` variables are unset.

The specific failure can be fixed like this:

```diff
diff --git a/src/sage/doctest/control.py b/src/sage/doctest/control.py
index 7d2b84b9c3..ef5ec5c2e5 100644
--- a/src/sage/doctest/control.py
+++ b/src/sage/doctest/control.py
@@ -223,7 +223,7 @@ def skipfile(filename):
     base, ext = os.path.splitext(filename)
     if ext not in ('.py', '.pyx', '.pxd', '.pxi', '.sage', '.spyx', '.rst', '.tex'):
         return True
-    with open(filename) as F:
+    with open(filename, encoding="utf-8", errors="ignore") as F:
         line_count = 0
         for line in F:
             if nodoctest_regex.match(line):
```

but after that some individual doctest have similar unicode errors.  
Setting the locale (for example `LANG=C.UTF-8 make ptest`) fixes all of these errors.



---

archive/issue_comments_442087.json:
```json
{
    "body": "Likely this patch has made its way into ubuntu-bionic security updates. https://github.com/python/cpython/pull/8975/files",
    "created_at": "2021-02-13T05:11:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30954#issuecomment-442087",
    "user": "@mkoeppe"
}
```

Likely this patch has made its way into ubuntu-bionic security updates. https://github.com/python/cpython/pull/8975/files



---

archive/issue_comments_442088.json:
```json
{
    "body": "That patch makes it sound as if the change is specific to FreeBSD, but I don't see that in the actual changes.",
    "created_at": "2021-02-13T05:23:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30954#issuecomment-442088",
    "user": "@mkoeppe"
}
```

That patch makes it sound as if the change is specific to FreeBSD, but I don't see that in the actual changes.



---

archive/issue_comments_442089.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-02-13T07:09:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30954#issuecomment-442089",
    "user": "@mkoeppe"
}
```

New commits:



---

archive/issue_comments_442090.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-02-13T07:09:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30954#issuecomment-442090",
    "user": "@mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_442091.json:
```json
{
    "body": "I think it is fine.\n\nhttps://github.com/kliem/sage/pull/39/checks",
    "created_at": "2021-02-14T20:45:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30954#issuecomment-442091",
    "user": "@kliem"
}
```

I think it is fine.

https://github.com/kliem/sage/pull/39/checks



---

archive/issue_comments_442092.json:
```json
{
    "body": "Thanks for testing! I didn't expect difficulties",
    "created_at": "2021-02-14T21:53:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30954#issuecomment-442092",
    "user": "@mkoeppe"
}
```

Thanks for testing! I didn't expect difficulties



---

archive/issue_comments_442093.json:
```json
{
    "body": "LGTM.",
    "created_at": "2021-02-15T06:56:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30954#issuecomment-442093",
    "user": "@kliem"
}
```

LGTM.



---

archive/issue_comments_442094.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-02-15T06:56:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30954#issuecomment-442094",
    "user": "@kliem"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_442095.json:
```json
{
    "body": "Thank you!",
    "created_at": "2021-02-15T07:02:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30954#issuecomment-442095",
    "user": "@mkoeppe"
}
```

Thank you!



---

archive/issue_comments_442096.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-03-01T00:21:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30954#issuecomment-442096",
    "user": "@vbraun"
}
```

Resolution: fixed
