# Issue 12649: testcc.sh: allow $CC to contain multiple words

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2012-04-09 18:38:48

Assignee: GeorgSWeber

If CC="gcc -m32" (for example), then the following will fail:

```
$ testcc.sh $CC
Usage: spkg/bin/testcc.sh name_or_path_to_the_C_compiler
[...]
```


We should allow `testcc.sh` to accept multiple arguments and use all of them to run the C compiler.


---

Comment by jdemeyer created at 2012-04-09 18:57:44

Changing status from new to needs_review.


---

Comment by leif created at 2012-04-09 21:52:58

Stylewise, I'd use `[ $# -lt  1 ]`.

The usage should say "`$0 name_or_path_to_the_C_compiler [optional arguments]`".

I'd also use `$`@`` instead of `"$`@`"`, then quoting `$CC` doesn't hurt (so you wouldn't have to change the M4RIE spkg either), and the latter won't work as probably expected.

It's also a bit funny to use `grep ... | sed ...`; a single invocation of `sed` is sufficient.  (At least he didn't use `... | cat | ...` ;-) )


---

Comment by jdemeyer created at 2012-04-09 21:57:51

Replying to [comment:5 leif]:
> Stylewise, I'd use `[ $# -lt  1 ]`.
In case the user supplies -2 arguments :-)


---

Comment by jdemeyer created at 2012-04-09 22:01:35

Replying to [comment:5 leif]:
> I'd also use `$`@`` instead of `"$`@`"`, then quoting `$CC` doesn't hurt (so you wouldn't have to change the M4RIE spkg either), and the latter won't work as probably expected.
I think quoting `$CC` should hurt because it's wrong.

One must not run

```
"$CC" foo.c -o foo
```

so I think one should also not run

```
testcc.sh "$CC"
```



---

Comment by leif created at 2012-04-09 22:03:10

Replying to [comment:5 leif]:
> I'd also use `$`@`` instead of `"$`@`"`, then quoting `$CC` doesn't hurt (so you wouldn't have to change the M4RIE spkg either), and the latter won't work as probably expected.
> 
> It's also a bit funny to use `grep ... | sed ...`; a single invocation of `sed` is sufficient.

I.e.,

```sh
$`@` -E $TESTFILE | sed -n '/^[A-Z]/s/ //gp'
```



---

Comment by jdemeyer created at 2012-04-09 22:04:47

Changing assignee from GeorgSWeber to jdemeyer.


---

Comment by jdemeyer created at 2012-04-09 22:04:47

New version, needs review.


---

Comment by leif created at 2012-04-09 22:11:41

Replying to [comment:7 jdemeyer]:
> Replying to [comment:5 leif]:
> > I'd also use `$`@`` instead of `"$`@`"`, then quoting `$CC` doesn't hurt (so you wouldn't have to change the M4RIE spkg either), and the latter won't work as probably expected.
> I think quoting `$CC` should hurt because it's wrong.

You can't say it's wrong.  But using `"$`@`"` would only make sense if one e.g. did

```sh
testcc.sh "$CC" "some argument with spaces" otherargument
# (if $CC is actually a single pathname with spaces in it)

# or, likewise
testcc.sh $CC "some argument with spaces" otherargument
```

which I think nobody will do.


---

Comment by leif created at 2012-04-09 22:28:39

Positive review for the patch to `testcc.sh` *if you remove the extra `grep`*... ;-)




The (patch to the) M4RIE spkg needs work anyway:

```sh
if [ "$COMPILER"  = "GNU" ] ; then 
    ...
```


(`testcc.sh` never returns `GNU`, at most `GCC`.)


---

Comment by leif created at 2012-04-09 22:38:01

Replying to [comment:11 leif]:
> The (patch to the) M4RIE spkg needs work anyway:
> {{{
> #!sh
> if [ "$COMPILER"  = "GNU" ] ; then 
>     ...
> }}}
> 
> (`testcc.sh` never returns `GNU`, at most `GCC`.)

And wouldn't using `testcflags.sh -fPIC -Wall -pedantic` there be more appropriate anyway?


---

Comment by leif created at 2012-04-10 02:59:01

Changing status from needs_review to needs_work.


---

Comment by leif created at 2012-04-10 02:59:01

... if you change the spkg _here_.

(And the changelog entry should say _"... *when calling* `testcc.sh`."_, provided you don't change `spkg-install` to use `testcflags.sh` of course, the latter being much better.)


---

Comment by leif created at 2012-04-10 03:43:41

Btw., `testcflags.sh` also needs work, as I already reported on sage-devel a while ago:

```sh
...
outfile=testcflags-$$
cfile=$outfile.c
...
rm -f $TESTFILE $OUTFILE
...
```


(And there are a few other issues with it.  Wonder who reviewed such, as the temporary files will *always* remain, while completely unrelated files might get deleted(!).)


---

Comment by jdemeyer created at 2012-04-10 08:20:50

Added a fix also for testcflags.sh.


---

Comment by jdemeyer created at 2012-04-10 08:48:51

Changing status from needs_work to needs_review.


---

Attachment


---

Comment by leif created at 2012-04-11 13:16:05

The test for the compiler used in M4RIE's `spkg-install` to add specific flags is still a bit weird; you could just use `testcflags.sh` for all of this, although `+ z` is currently a bit problematic (in case the space is really required), because `testcflags.sh` tests the flags one by one, and passing `"+ z"` as a single parameter to it might not work either, since the compiler most probably doesn't expect it to be passed as a single argument.

But the quoting in `testcflags.sh` wouldn't work as expected anyway, so you could just omit the quotes there _when calling the compiler_ with previous and the currently to be tested flags.






If `SAGE_DEBUG=yes`, `-O0` should be *ap*pended to `CFLAGS`, as it was.


---

Comment by leif created at 2012-04-11 13:23:24

Replying to [comment:17 leif]:
> But the quoting in `testcflags.sh` wouldn't work as expected anyway, so you could just omit the quotes there _when calling the compiler_ with previous and the currently to be tested flags.

Oh I see, you've meanwhile fixed that, such that we could now use (e.g.) `testcflags.sh -fPIC -Kpic "+ z"`.


---

Comment by leif created at 2012-04-11 13:30:09

W.r.t. `testcflags.sh`:

I'd move the usage instructions from the comment into the error message given if `CC` isn't set, and add `$# -eq 0` (or `$# -lt 1`) to the test, such that calling `testcflags.sh` without arguments outputs its usage.


---

Comment by leif created at 2012-04-11 13:44:36

A few more comments:

 * The scripts could respect `TMP` and `TMPDIR` if set.

 * On Cygwin `-o foo` will create `foo.exe`, so that should (also) be removed.

 * Using `sed -n '/^[A-Z]/s/ //gp'` is much faster than `sed -n 's/ //g;/^[A-Z]/p'`.

 * In `spkg/install`, there should be a way to bypass the installation of GCC (if the compiler isn't GCC), e.g. if `SAGE_PORT=yes` (?).  Or is there already such?


---

Comment by leif created at 2012-04-11 14:10:56

Replying to [comment:20 leif]:
>  * In `spkg/install`, there should be a way to bypass the installation of GCC (if the compiler isn't GCC), e.g. if `SAGE_PORT=yes` (?).  Or is there already such?

Doesn't look like.  (Although one can set `SAGE_INSTALL_GCC=no`.)

Quite unrelated, but from `spkg/install` (i.e., while we're at it):

```sh
if [ -z "$SAGE_FORTRAN" ]; then
    if command -v gfortran >/dev/null 2>/dev/null; then
        SAGE_FORTRAN=gfortran
    elif command -v g95 >/dev/null 2>/dev/null; then
        SAGE_FORTRAN=g95
    elif command -v g77 >/dev/null 2>/dev/null; then
        SAGE_FORTRAN=g77
    fi
fi
```

ignores settings of `FC` and `F77`, the standard variables containing the Fortran compiler.

The created `sage_fortran` script hardcodes `-m64` (and ignores `FFLAGS`, `FCFLAGS`, `F77FLAGS` etc.).

Don't know whether that's really intentional, but also the _current setting_ of `SAGE_FORTRAN` is hardcoded into the script, such that later changing `SAGE_FORTRAN` has no effect.


---

Comment by leif created at 2012-04-11 14:57:02

More on `spkg/install`: :-)

```sh
grep '^\($\|[0-3]\.\|4\.[0-3]\|4\.6\.[01]$\)'
```

is GNUism and non-portable; either use

```sh
egrep '^($|[0-3]\.|4\.[0-3]|4\.6\.[01]$)'
```

or, preferably, shell pattern matching, which is reliable, and in which case you could also more easily handle e.g. a 4.6.1 version on Ubuntu.


---

Comment by jdemeyer created at 2012-04-11 16:14:25

Replying to [comment:22 leif]:
> More on `spkg/install`: :-)
> {{{
> #!sh
> grep '^\($\|[0-3]\.\|4\.[0-3]\|4\.6\.[01]$\)'
> }}}
> is GNUism and non-portable; either use
> {{{
> #!sh
> egrep '^($|[0-3]\.|4\.[0-3]|4\.6\.[01]$)'
> }}}
> or, preferably, shell pattern matching, which is reliable, and in which case you could also more easily handle e.g. a 4.6.1 version on Ubuntu.
See #12825.


---

Comment by jdemeyer created at 2012-04-11 16:15:43

Replying to [comment:21 leif]:
> Quite unrelated, but from `spkg/install` (i.e., while we're at it):
> {{{
> #!sh
> if [ -z "$SAGE_FORTRAN" ]; then
>     if command -v gfortran >/dev/null 2>/dev/null; then
>         SAGE_FORTRAN=gfortran
>     elif command -v g95 >/dev/null 2>/dev/null; then
>         SAGE_FORTRAN=g95
>     elif command -v g77 >/dev/null 2>/dev/null; then
>         SAGE_FORTRAN=g77
>     fi
> fi
> }}}
> ignores settings of `FC` and `F77`, the standard variables containing the Fortran compiler.
> 
> The created `sage_fortran` script hardcodes `-m64` (and ignores `FFLAGS`, `FCFLAGS`, `F77FLAGS` etc.).
> 
> Don't know whether that's really intentional, but also the _current setting_ of `SAGE_FORTRAN` is hardcoded into the script, such that later changing `SAGE_FORTRAN` has no effect.
You're certainly right that there are some issues here, but that's totally outside of the scope of this ticket.


---

Comment by jdemeyer created at 2012-04-11 16:18:28

Replying to [comment:20 leif]:
> The scripts could respect `TMP` and `TMPDIR` if set.
What's `TMP`?  I agree on `TMPDIR`, which is the standard way of specifying a temporary directory.

> On Cygwin `-o foo` will create `foo.exe`, so that should (also) be removed.
Fair enough.

>  Using `sed -n '/^[A-Z]/s/ //gp'` is much faster than `sed -n 's/ //g;/^[A-Z]/p'`.
Those two commands aren't equivalent.

> In `spkg/install`, there should be a way to bypass the installation of GCC.
You can set `SAGE_INSTALL_GCC=no`.


---

Comment by leif created at 2012-04-11 18:52:21

Replying to [comment:25 jdemeyer]:
> Replying to [comment:20 leif]:
> >  Using `sed -n '/^[A-Z]/s/ //gp'` is much faster than `sed -n 's/ //g;/^[A-Z]/p'`.
> Thoase two commands aren't equivalent.

They of course aren't, but in our case have the same (desired) effect; mine is equivalent to what Dave did, while yours isn't.


---

Comment by jdemeyer created at 2012-04-13 09:18:20

Replying to [comment:26 leif]:
> Replying to [comment:25 jdemeyer]:
> > Replying to [comment:20 leif]:
> > >  Using `sed -n '/^[A-Z]/s/ //gp'` is much faster than `sed -n 's/ //g;/^[A-Z]/p'`.
> > Thoase two commands aren't equivalent.
> 
> They of course aren't, but in our case have the same (desired) effect; mine is equivalent to what Dave did, while yours isn't.
Did you even *try* those commands before saying such non-sense?


---

Comment by leif created at 2012-04-13 13:46:29

Replying to [comment:27 jdemeyer]:
> Replying to [comment:26 leif]:
> > Replying to [comment:25 jdemeyer]:
> > > Replying to [comment:20 leif]:
> > > >  Using `sed -n '/^[A-Z]/s/ //gp'` is much faster than `sed -n 's/ //g;/^[A-Z]/p'`.
> > > Those two commands aren't equivalent.
> > 
> > They of course aren't, but in our case have the same (desired) effect; mine is equivalent to what Dave did, while yours isn't.
> Did you even *try* those commands before saying such non-sense?

I apparently had trailing spaces on the lines with compiler names...


```sh
sed -n '/^[A-Z]/s/[ ]*//gp'
```

does it, although we shouldn't have spaces on these lines anyway (in which case the substitution of course would be superfluous).


---

Comment by leif created at 2012-04-13 14:32:08

Replying to [comment:17 leif]:
> If `SAGE_DEBUG=yes`, `-O0` should be *ap*pended to `CFLAGS`, as it was.

This is still in the diff; haven't downloaded the new spkg (yet).


---

Comment by malb created at 2012-04-13 20:34:25

I have based the new SPKG at #12841 on http://boxen.math.washington.edu/home/jdemeyer/spkg/libm4rie-20111004.p3.spkg. Additionally, I changed spkg-install to append not prepend -O0.


---

Comment by jdemeyer created at 2012-04-14 11:48:48

New version of [attachment:12821_testcc.patch] needs review.

I disagree about appending `-O0`.  I think the user's `CFLAGS` should always override the SPKG's `CFLAGS` without exceptions.  What if the user for some reason wants `--enable-debug` but still `-O2`?

In any case, the following would be very inconsistent:

```sh
if [ "x$SAGE_DEBUG" = "xyes" ]; then
   CFLAGS="$CFLAGS -O0"
   ENABLE_DEBUG="--enable-debug"
else
   CFLAGS="-O2 $CFLAGS"
   ENABLE_DEBUG=""
fi
```



---

Comment by jdemeyer created at 2012-05-02 18:07:21

Still needs review...


---

Comment by ohanar created at 2012-05-25 00:21:38

The patched version of `testcflags.sh` always produces an empty list of cflags for me. My guess is that it is due to `d` being undefined in the following block of code:

```C
unsigned long double_to_ulong() 
{ 
    return (unsigned long)d; 
}
```



---

Comment by ohanar created at 2012-05-25 00:21:38

Changing status from needs_review to needs_work.


---

Attachment


---

Comment by jdemeyer created at 2012-05-25 05:05:08

Of course, I don't know how I missed that...

Fixed.


---

Comment by jdemeyer created at 2012-05-25 05:05:08

Changing status from needs_work to needs_review.


---

Comment by ohanar created at 2012-05-25 05:13:20

Changing keywords from "" to "sd40.5".


---

Comment by ohanar created at 2012-05-25 05:13:20

Ok, looks good and works well.

To note, this is not a great test for cflags. For example, clang only throws warnings to bad compiler flags, it does not error.


---

Comment by ohanar created at 2012-05-25 05:13:20

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-05-26 05:30:42

Replying to [comment:35 ohanar]:
> For example, clang only throws warnings to bad compiler flags, it does not error.
That's stupid:

```
bsd:~ jdemeyer$ clang -march=foobar foo.c -c -o foo.o
'foobar' is not a recognized processor for this target (ignoring processor)
bsd:~ jdemeyer$ echo $?
0
```


This could mean that MPIR for example might produce very suboptimal code because it _thinks_ that `-march=foo` is supported when it's not.


---

Comment by jdemeyer created at 2012-06-02 12:14:44

Resolution: fixed
