# Issue 32118: Bug in multiple tensor contractions

Issue created by migration from https://trac.sagemath.org/ticket/32355

Original creator: egourgoulhon

Original creation time: 2021-08-10 08:40:41

CC:  tscrim @mjungmath mkoeppe

Keywords: tensor contraction

Tensor contractions on multiple indices give wrong results when the index positions in each tensor do not have the same order. For instance, let us consider

```
sage: M = Manifold(2, 'M')                                                                          
sage: X.<x,y> = M.chart()                                                                           
sage: a = M.multivector_field(2)                                                                    
sage: a[0,1] = 1                                                                                    
sage: b = M.diff_form(2)                                                                            
sage: b[0,1] = 1                                                                                    
```

The double contraction a<sup>ij</sup> b<sub>ij</sub> is obtained via

```
sage: a.contract(0, 1, b, 0, 1).expr()                                                              
2
sage: (a['^ij']*b['_ij']).expr()  # equivalent to above                                                                 
2
```

which is correct. However, asking for the double contraction a<sup>ij</sup> b<sub>ji</sub> 
leads to 

```
sage: a.contract(0, 1, b, 1, 0).expr()  
2
sage: (a['^ij']*b['_ji']).expr()  # equivalent to above                                                                     
2
}}}                                                          
which is obviously wrong: the result should be -2, since b is antisymmetric.

This bug has been reported in https://ask.sagemath.org/question/58379.


---

Comment by egourgoulhon created at 2021-08-10 09:09:19

The culprit is line 2187 of `src/sage/tensor/modules/comp.py`:

```
    for ind in comp_for_contr.index_generator():
        res += self[[ind]] * other[[ind]]
```

`ind` should be reordered before being passed to `other[This is the Trac macro *...* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#...-macro)`.


---

Comment by egourgoulhon created at 2021-08-12 14:00:54

The bug is fixed in the above branch. Some slight clean up of the code for parallelized contractions has also been performed.
----
New commits:


---

Comment by egourgoulhon created at 2021-08-12 14:00:54

Changing status from new to needs_review.


---

Comment by @mjungmath created at 2021-08-12 18:06:22

Here are some comments.

- I think you don't need to initialize a new component in

   {{{#!python
             comp_for_contr = Components(self._ring, self._frame, ncontr,
                                         start_index=self._sindex)
   }}}

   and you can use `self.index_generator()` right away, no?

- What about this?

   {{{#!diff
-            for ind_s in comp_for_contr.index_generator():
-                ind_o = [None for i in range(ncontr)]
-                for pos_s, pos_o in contractions:
-                    ind_o[pos_o] = ind_s[pos_s]
-                ind_pairs.append((ind_s, ind_o))
+            for ind_s in self.index_generator():
+                ind_o = [ind_s[pos_s] for pos_s, _ in sorted(contractions, key=itemgetter(1))]
+                ind_pairs.append((ind_s, ind_o))
   }}}

   You could also turn the outer for-loop into a list comprehension which would be faster but I reckon less well readable.


---

Comment by git created at 2021-08-13 12:39:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2021-08-13 12:48:21

Replying to [comment:5 gh-mjungmath]:
> Here are some comments.

Thanks for taking a look into this.

> 
> - I think you don't need to initialize a new component in
> 
>    {{{#!python
>              comp_for_contr = Components(self._ring, self._frame, ncontr,
>                                          start_index=self._sindex)
>    }}}
> 
>    and you can use `self.index_generator()` right away, no?
> 

Yes indeed! (this is needed for the generic case, but not for the specific case of a scalar output). The latest commit implement this change.

> - What about this?
> 
>    {{{#!diff
> -            for ind_s in comp_for_contr.index_generator():
> -                ind_o = [None for i in range(ncontr)]
> -                for pos_s, pos_o in contractions:
> -                    ind_o[pos_o] = ind_s[pos_s]
> -                ind_pairs.append((ind_s, ind_o))
> +            for ind_s in self.index_generator():
> +                ind_o = [ind_s[pos_s] for pos_s, _ in sorted(contractions, key=itemgetter(1))]
> +                ind_pairs.append((ind_s, ind_o))
>    }}}
> 
I would prefer to keep the original version, since it is more efficient from a computational point of view: there is no need to sort a list. Granted: in most use cases, the list contains only a few elements and sorting shall be fast. So it is more a matter of taste...


---

Comment by @mjungmath created at 2021-08-13 13:20:28

Replying to [comment:7 egourgoulhon]:
> I would prefer to keep the original version, since it is more efficient from a computational point of view: there is no need to sort a list. Granted: in most use cases, the list contains only a few elements and sorting shall be fast. So it is more a matter of taste...

You're right, this is faster! Then I still have one last comment:


```diff
-                ind_o = [None for i in range(ncontr)]
+                ind_o = [None] * ncontr
```


This is indeed faster.

If that is done, and patchbot is happy -> positive review.


---

Comment by git created at 2021-08-14 08:38:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2021-08-14 08:40:05

Replying to [comment:8 gh-mjungmath]:
Then I still have one last comment:
> 
> {{{#!diff
> -                ind_o = [None for i in range(ncontr)]
> +                ind_o = [None] * ncontr
> }}}
> 
Done in the above commit.


---

Comment by @mjungmath created at 2021-08-15 21:51:13

Changing status from needs_review to positive_review.


---

Comment by egourgoulhon created at 2021-08-16 14:45:02

Thank you for the review!


---

Comment by vbraun created at 2021-09-07 20:52:15

Resolution: fixed
