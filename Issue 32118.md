# Issue 32118: Bug in multiple tensor contractions

archive/issues_032118.json:
```json
{
    "body": "CC:  tscrim @mjungmath mkoeppe\n\nKeywords: tensor contraction\n\nTensor contractions on multiple indices give wrong results when the index positions in each tensor do not have the same order. For instance, let us consider\n\n```\nsage: M = Manifold(2, 'M')                                                                          \nsage: X.<x,y> = M.chart()                                                                           \nsage: a = M.multivector_field(2)                                                                    \nsage: a[0,1] = 1                                                                                    \nsage: b = M.diff_form(2)                                                                            \nsage: b[0,1] = 1                                                                                    \n```\n\nThe double contraction a<sup>ij</sup> b<sub>ij</sub> is obtained via\n\n```\nsage: a.contract(0, 1, b, 0, 1).expr()                                                              \n2\nsage: (a['^ij']*b['_ij']).expr()  # equivalent to above                                                                 \n2\n```\n\nwhich is correct. However, asking for the double contraction a<sup>ij</sup> b<sub>ji</sub> \nleads to \n\n```\nsage: a.contract(0, 1, b, 1, 0).expr()  \n2\nsage: (a['^ij']*b['_ji']).expr()  # equivalent to above                                                                     \n2\n```\n                                                          \nwhich is obviously wrong: the result should be -2, since b is antisymmetric.\n\nThis bug has been reported in https://ask.sagemath.org/question/58379.\n\nIssue created by migration from https://trac.sagemath.org/ticket/32355\n\n",
    "created_at": "2021-08-10T08:40:41Z",
    "labels": [
        "manifolds",
        "major",
        "bug"
    ],
    "title": "Bug in multiple tensor contractions",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32118",
    "user": "egourgoulhon"
}
```
CC:  tscrim @mjungmath mkoeppe

Keywords: tensor contraction

Tensor contractions on multiple indices give wrong results when the index positions in each tensor do not have the same order. For instance, let us consider

```
sage: M = Manifold(2, 'M')                                                                          
sage: X.<x,y> = M.chart()                                                                           
sage: a = M.multivector_field(2)                                                                    
sage: a[0,1] = 1                                                                                    
sage: b = M.diff_form(2)                                                                            
sage: b[0,1] = 1                                                                                    
```

The double contraction a<sup>ij</sup> b<sub>ij</sub> is obtained via

```
sage: a.contract(0, 1, b, 0, 1).expr()                                                              
2
sage: (a['^ij']*b['_ij']).expr()  # equivalent to above                                                                 
2
```

which is correct. However, asking for the double contraction a<sup>ij</sup> b<sub>ji</sub> 
leads to 

```
sage: a.contract(0, 1, b, 1, 0).expr()  
2
sage: (a['^ij']*b['_ji']).expr()  # equivalent to above                                                                     
2
```
                                                          
which is obviously wrong: the result should be -2, since b is antisymmetric.

This bug has been reported in https://ask.sagemath.org/question/58379.

Issue created by migration from https://trac.sagemath.org/ticket/32355





---

archive/issue_comments_458650.json:
```json
{
    "body": "The culprit is line 2187 of `src/sage/tensor/modules/comp.py`:\n\n```\n    for ind in comp_for_contr.index_generator():\n        res += self[[ind]] * other[[ind]]\n```\n\n`ind` should be reordered before being passed to `other[This is the Trac macro *...* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#...-macro)`.",
    "created_at": "2021-08-10T09:09:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32118#issuecomment-458650",
    "user": "egourgoulhon"
}
```

The culprit is line 2187 of `src/sage/tensor/modules/comp.py`:

```
    for ind in comp_for_contr.index_generator():
        res += self[[ind]] * other[[ind]]
```

`ind` should be reordered before being passed to `other[This is the Trac macro *...* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#...-macro)`.



---

archive/issue_comments_458651.json:
```json
{
    "body": "The bug is fixed in the above branch. Some slight clean up of the code for parallelized contractions has also been performed.\n----\nNew commits:",
    "created_at": "2021-08-12T14:00:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32118#issuecomment-458651",
    "user": "egourgoulhon"
}
```

The bug is fixed in the above branch. Some slight clean up of the code for parallelized contractions has also been performed.
----
New commits:



---

archive/issue_comments_458652.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-08-12T14:00:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32118#issuecomment-458652",
    "user": "egourgoulhon"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_458653.json:
```json
{
    "body": "Here are some comments.\n\n- I think you don't need to initialize a new component in\n\n   {{{#!python\n             comp_for_contr = Components(self._ring, self._frame, ncontr,\n                                         start_index=self._sindex)\n   }}}\n\n   and you can use `self.index_generator()` right away, no?\n\n- What about this?\n\n   {{{#!diff\n-            for ind_s in comp_for_contr.index_generator():\n-                ind_o = [None for i in range(ncontr)]\n-                for pos_s, pos_o in contractions:\n-                    ind_o[pos_o] = ind_s[pos_s]\n-                ind_pairs.append((ind_s, ind_o))\n+            for ind_s in self.index_generator():\n+                ind_o = [ind_s[pos_s] for pos_s, _ in sorted(contractions, key=itemgetter(1))]\n+                ind_pairs.append((ind_s, ind_o))\n   }}}\n\n   You could also turn the outer for-loop into a list comprehension which would be faster but I reckon less well readable.",
    "created_at": "2021-08-12T18:06:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32118#issuecomment-458653",
    "user": "@mjungmath"
}
```

Here are some comments.

- I think you don't need to initialize a new component in

   {{{#!python
             comp_for_contr = Components(self._ring, self._frame, ncontr,
                                         start_index=self._sindex)
   }}}

   and you can use `self.index_generator()` right away, no?

- What about this?

   {{{#!diff
-            for ind_s in comp_for_contr.index_generator():
-                ind_o = [None for i in range(ncontr)]
-                for pos_s, pos_o in contractions:
-                    ind_o[pos_o] = ind_s[pos_s]
-                ind_pairs.append((ind_s, ind_o))
+            for ind_s in self.index_generator():
+                ind_o = [ind_s[pos_s] for pos_s, _ in sorted(contractions, key=itemgetter(1))]
+                ind_pairs.append((ind_s, ind_o))
   }}}

   You could also turn the outer for-loop into a list comprehension which would be faster but I reckon less well readable.



---

archive/issue_comments_458654.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-13T12:39:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32118#issuecomment-458654",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_458655.json:
```json
{
    "body": "Replying to [comment:5 gh-mjungmath]:\n> Here are some comments.\n\nThanks for taking a look into this.\n\n> \n> - I think you don't need to initialize a new component in\n> \n>    {{{#!python\n>              comp_for_contr = Components(self._ring, self._frame, ncontr,\n>                                          start_index=self._sindex)\n>    }}}\n> \n>    and you can use `self.index_generator()` right away, no?\n> \n\nYes indeed! (this is needed for the generic case, but not for the specific case of a scalar output). The latest commit implement this change.\n\n> - What about this?\n> \n>    {{{#!diff\n> -            for ind_s in comp_for_contr.index_generator():\n> -                ind_o = [None for i in range(ncontr)]\n> -                for pos_s, pos_o in contractions:\n> -                    ind_o[pos_o] = ind_s[pos_s]\n> -                ind_pairs.append((ind_s, ind_o))\n> +            for ind_s in self.index_generator():\n> +                ind_o = [ind_s[pos_s] for pos_s, _ in sorted(contractions, key=itemgetter(1))]\n> +                ind_pairs.append((ind_s, ind_o))\n>    }}}\n> \nI would prefer to keep the original version, since it is more efficient from a computational point of view: there is no need to sort a list. Granted: in most use cases, the list contains only a few elements and sorting shall be fast. So it is more a matter of taste...",
    "created_at": "2021-08-13T12:48:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32118#issuecomment-458655",
    "user": "egourgoulhon"
}
```

Replying to [comment:5 gh-mjungmath]:
> Here are some comments.

Thanks for taking a look into this.

> 
> - I think you don't need to initialize a new component in
> 
>    {{{#!python
>              comp_for_contr = Components(self._ring, self._frame, ncontr,
>                                          start_index=self._sindex)
>    }}}
> 
>    and you can use `self.index_generator()` right away, no?
> 

Yes indeed! (this is needed for the generic case, but not for the specific case of a scalar output). The latest commit implement this change.

> - What about this?
> 
>    {{{#!diff
> -            for ind_s in comp_for_contr.index_generator():
> -                ind_o = [None for i in range(ncontr)]
> -                for pos_s, pos_o in contractions:
> -                    ind_o[pos_o] = ind_s[pos_s]
> -                ind_pairs.append((ind_s, ind_o))
> +            for ind_s in self.index_generator():
> +                ind_o = [ind_s[pos_s] for pos_s, _ in sorted(contractions, key=itemgetter(1))]
> +                ind_pairs.append((ind_s, ind_o))
>    }}}
> 
I would prefer to keep the original version, since it is more efficient from a computational point of view: there is no need to sort a list. Granted: in most use cases, the list contains only a few elements and sorting shall be fast. So it is more a matter of taste...



---

archive/issue_comments_458656.json:
```json
{
    "body": "Replying to [comment:7 egourgoulhon]:\n> I would prefer to keep the original version, since it is more efficient from a computational point of view: there is no need to sort a list. Granted: in most use cases, the list contains only a few elements and sorting shall be fast. So it is more a matter of taste...\n\nYou're right, this is faster! Then I still have one last comment:\n\n\n```diff\n-                ind_o = [None for i in range(ncontr)]\n+                ind_o = [None] * ncontr\n```\n\n\nThis is indeed faster.\n\nIf that is done, and patchbot is happy -> positive review.",
    "created_at": "2021-08-13T13:20:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32118#issuecomment-458656",
    "user": "@mjungmath"
}
```

Replying to [comment:7 egourgoulhon]:
> I would prefer to keep the original version, since it is more efficient from a computational point of view: there is no need to sort a list. Granted: in most use cases, the list contains only a few elements and sorting shall be fast. So it is more a matter of taste...

You're right, this is faster! Then I still have one last comment:


```diff
-                ind_o = [None for i in range(ncontr)]
+                ind_o = [None] * ncontr
```


This is indeed faster.

If that is done, and patchbot is happy -> positive review.



---

archive/issue_comments_458657.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-14T08:38:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32118#issuecomment-458657",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_458658.json:
```json
{
    "body": "Replying to [comment:8 gh-mjungmath]:\nThen I still have one last comment:\n> \n> {{{#!diff\n> -                ind_o = [None for i in range(ncontr)]\n> +                ind_o = [None] * ncontr\n> }}}\n> \nDone in the above commit.",
    "created_at": "2021-08-14T08:40:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32118#issuecomment-458658",
    "user": "egourgoulhon"
}
```

Replying to [comment:8 gh-mjungmath]:
Then I still have one last comment:
> 
> {{{#!diff
> -                ind_o = [None for i in range(ncontr)]
> +                ind_o = [None] * ncontr
> }}}
> 
Done in the above commit.



---

archive/issue_comments_458659.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-08-15T21:51:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32118#issuecomment-458659",
    "user": "@mjungmath"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_458660.json:
```json
{
    "body": "Thank you for the review!",
    "created_at": "2021-08-16T14:45:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32118#issuecomment-458660",
    "user": "egourgoulhon"
}
```

Thank you for the review!



---

archive/issue_comments_458661.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-09-07T20:52:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32118#issuecomment-458661",
    "user": "vbraun"
}
```

Resolution: fixed
