# Issue 10155: Rename makefile to Makefile

Issue created by migration from https://trac.sagemath.org/ticket/10156

Original creator: jdemeyer

Original creation time: 2010-10-23 07:42:31

Assignee: tbd

CC:  jhpalmieri leif

Keywords: scripts makefile

See also #9799


---

Attachment

sagelib patch


---

Attachment

sage_scripts patch


---

Comment by leif created at 2010-10-23 11:56:02

The renaming is also done by #9433 IIRC.


---

Comment by leif created at 2010-10-23 13:29:57

I wonder if it's safer to use `[Mm]akefile` in the shell scripts. (The scripts calling Python functions rather than `os.system()` etc. would get more complicated of course.)

At least there seems to be a lack of error / consistency checking, as always...


---

Comment by leif created at 2010-10-23 13:29:57

Changing status from new to needs_review.


---

Comment by leif created at 2010-10-23 13:31:42

Patches look reasonable; I just don't know yet if they catch all instances.


---

Comment by jdemeyer created at 2010-10-23 15:56:50

If you thrust the author of the patch to do the test, I am doing the following:
 * building Sage from source with #9799, #10156, #10157 applied and makefile renamed to Makefile
 * making an sdist and a bdist from this built Sage
 * extract the sdist, make, make ptestlong
 * extract the bdist, make ptestlong

If all this works, I think that #10156 and #10157 are proven to work.


---

Comment by jdemeyer created at 2010-10-23 22:12:52

All builds and tests mentioned above worked with #9799, #10156, #10157 applied.


---

Comment by jdemeyer created at 2010-10-25 10:29:01

Replying to [comment:3 leif]:
> I wonder if it's safer to use `[Mm]akefile` in the shell scripts.

I don't see why.  If we really rename `makefile` to `Makefile`, there is no reason to use `[Mm]akefile`.


---

Comment by jdemeyer created at 2010-11-05 08:47:31

John or Leif: could you review this and #10157 please?  I think these patches have received sufficient testing to prove that they work.


---

Comment by jhpalmieri created at 2010-11-05 17:59:27

The Sage library patch looks fine. 

For the scripts patch, I haven't tested it at all, but what happens if you upgrade from a version of Sage with a file called "makefile"?  Will things break?  I don't think it's ever a good idea to run "sage-sdist" or "sage-bdist" from an upgraded version of Sage, but if someone does, what will happen?  Would it be a good idea to either use something like [Mm]akefile, as leif suggested, or do something like the following:

```sh
if [ -e makefile ]; then
   cp -$OPT makefile "$TMP"/Makefile
fi
```

(This is for sage-bdist, and you would use something similar in sage-sdist.)


---

Comment by leif created at 2010-11-05 18:38:58

Replying to [comment:10 jhpalmieri]:
> The Sage library patch looks fine. 
> 
> For the scripts patch, I haven't tested it at all, but what happens if you upgrade from a version of Sage with a file called "makefile"?  Will things break?

W.r.t. making new dists from an upgraded version, hopefully #9433 solves this... ;-)

(I don't know if you meant upgrading in general; this works for me. You just still have the old `makefile`.)


> I don't think it's ever a good idea to run "sage-sdist" or "sage-bdist" from an upgraded version of Sage [...]

Nobody should do this, currently.

We should perhaps just give an error message in that case (until #9433 is merged).


---

Comment by jdemeyer created at 2010-11-05 20:17:32

I don't understand the fine details of upgrading, but would it be possible to copy `makefile` to `Makefile` during the _upgrade_?


---

Comment by leif created at 2010-11-06 00:24:57

Replying to [comment:12 jdemeyer]:
> I don't understand the fine details of upgrading, but would it be possible to copy `makefile` to `Makefile` during the _upgrade_?

Of course. But I would _rename_ it because (POSIX) `make` gives `makefile` precedence over `Makefile` and we don't want to cause confusion.


---

Comment by jdemeyer created at 2010-11-07 10:56:15

Replying to [comment:13 leif]:
> Replying to [comment:12 jdemeyer]:
> > I don't understand the fine details of upgrading, but would it be possible to copy `makefile` to `Makefile` during the _upgrade_?
> 
> Of course. But I would _rename_ it because (POSIX) `make` gives `makefile` precedence over `Makefile` and we don't want to cause confusion.

On the other hand, if `makefile` and `Makefile` are identical files, it shouldn't matter.  It seems just dangerous to delete `makefile` during a Sage build/upgrade.

Can any of you implement this?


---

Comment by jdemeyer created at 2010-11-07 10:56:15

Changing status from needs_review to needs_work.


---

Comment by jhpalmieri created at 2010-11-09 19:00:13

Replying to [comment:14 jdemeyer]:
> Replying to [comment:13 leif]:
> > Replying to [comment:12 jdemeyer]:
> > > I don't understand the fine details of upgrading, but would it be possible to copy `makefile` to `Makefile` during the _upgrade_?
> > 
> > Of course. But I would _rename_ it because (POSIX) `make` gives `makefile` precedence over `Makefile` and we don't want to cause confusion.
> 
> On the other hand, if `makefile` and `Makefile` are identical files, it shouldn't matter.  It seems just dangerous to delete `makefile` during a Sage build/upgrade.

Note that on OS X, you can't have files called both "makefile" and "Makefile" in the same directory.  Also, "makefile" is not used at all during an upgrade, so it should be safe to rename it.

> Can any of you implement this?

It's taken care of by #9433.  If we want to implement it here, I think it should be done in the sage-upgrade script, after running "./install" and checking its exit status:

```diff
diff -r 4047e578febc sage-upgrade
--- a/sage-upgrade      Sat Oct 30 16:05:33 2010 -0700
+++ b/sage-upgrade      Tue Nov 09 10:57:40 2010 -0800
@@ -36,3 +36,13 @@
     exit 1
 fi
 
+cd "$SAGE_ROOT"
+
+if [ -f makefile ]; then
+    mv makefile Makefile
+fi
+
+if [ $? -ne 0 ]; then
+    echo "Error renaming 'makefile' to 'Makefile'.
+    exit 1
+fi
```

Another option would also check for the existence of 'Makefile' before doing the move:

```diff
diff -r 4047e578febc sage-upgrade
--- a/sage-upgrade      Sat Oct 30 16:05:33 2010 -0700
+++ b/sage-upgrade      Tue Nov 09 10:58:47 2010 -0800
@@ -36,3 +36,16 @@
     exit 1
 fi
 
+cd "$SAGE_ROOT"
+
+if [ -f makefile ]; then
+    if [ -f Makefile ]; then
+       mv Makefile Makefile.old
+    fi
+    mv makefile Makefile
+fi
+
+if [ $? -ne 0 ]; then
+    echo "Error renaming 'makefile' to 'Makefile'.
+    exit 1
+fi
```

Opinions either way?


---

Attachment

Additional scripts patch: rename makefile to Makefile during upgrade


---

Comment by jdemeyer created at 2010-11-10 18:58:24

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2010-11-11 01:15:14

The first two patches (10156_docs.patch and 10156_scripts.patch) get a positive review from me.

This doesn't work, probably my fault.  The issue is that the script "sage-upgrade" doesn't get upgraded in the process.  So I think moving makefile should happen at the end of the "install" script instead, since this gets downloaded before it gets run.  (In particular, upgrading didn't rename "makefile" when I tested it.)  Try this patch to "install" instead.


---

Attachment

the file spkg/install


---

Attachment

patch for 'install'


---

Comment by jhpalmieri created at 2010-11-11 02:18:30

Replying to [comment:18 jhpalmieri]:
> This doesn't work, probably my fault. 

By "this", I meant the third patch, 10156_upgrade.patch.


---

Comment by jhpalmieri created at 2010-11-11 04:40:23

For what it's worth, my change to "install" works for me when upgrading on both Mac OS X (with its odd case-sensitivity) and Solaris.  I tested upgrading from 4.5.3 (which had "makefile") and 4.6.1.alpha0 (which had "Makefile").


---

Comment by vbraun created at 2010-11-16 02:05:31

I successfully updated from sage-4.5.2 on Fedora 13 and the patch did go the extra mile to make sure that it doesn't break upgrades. I'll set it to positive review.


---

Comment by vbraun created at 2010-11-16 02:05:31

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2010-11-16 08:21:29

Resolution: fixed


---

Comment by drkirkby created at 2010-11-16 17:57:51

It looks to me there are still a few files that refer to `makefile`. Shall I create a ticket for these:


```
devel/sage-main/doc/output/latex/en/developer/developer.tex:Another way is to edit the file \code{makefile} in the top level Sage
devel/sage-main/doc/output/latex/en/developer/developer.tex:After saving all changes to \code{makefile}, we can parallel test with the
devel/sage-main/doc/output/latex/en/developer/developer.tex:these command, see the files \code{SAGE\_ROOT/makefile} and
devel/sage-main/doc/output/latex/en/developer/developer.tex:argument \code{-long}. See the file \code{SAGE\_ROOT/makefile} for further
devel/sage-main/doc/output/latex/en/developer/developer.tex:\code{SAGE\_ROOT/makefile} for further details.
devel/sage-main/doc/output/latex/en/developer/developer.tex:the file \code{SAGE\_ROOT/makefile} takes care of the unpacking,
devel/sage-main/doc/output/latex/en/developer/developer.tex:\code{\$SAGE\_ROOT/makefile} before using \code{ptestlong}). See
```



---

Comment by jdemeyer created at 2010-11-16 18:04:17

Replying to [comment:25 drkirkby]:
> It looks to me there are still a few files that refer to `makefile`. Shall I create a ticket for these:
> 
> {{{
> devel/sage-main/doc/output/latex/en/developer/developer.tex:Another way is to edit the file \code{makefile} in the top level Sage
> devel/sage-main/doc/output/latex/en/developer/developer.tex:After saving all changes to \code{makefile}, we can parallel test with the
> devel/sage-main/doc/output/latex/en/developer/developer.tex:these command, see the files \code{SAGE\_ROOT/makefile} and
> devel/sage-main/doc/output/latex/en/developer/developer.tex:argument \code{-long}. See the file \code{SAGE\_ROOT/makefile} for further
> devel/sage-main/doc/output/latex/en/developer/developer.tex:\code{SAGE\_ROOT/makefile} for further details.
> devel/sage-main/doc/output/latex/en/developer/developer.tex:the file \code{SAGE\_ROOT/makefile} takes care of the unpacking,
> devel/sage-main/doc/output/latex/en/developer/developer.tex:\code{\$SAGE\_ROOT/makefile} before using \code{ptestlong}). See
> }}}

These are all in the _output_ directory.  Could it be that you did not rebuild the pdf documentation after applying these tickets and are finding the old tex files?


---

Comment by drkirkby created at 2010-11-16 19:41:41

Replying to [comment:26 jdemeyer]:

> These are all in the _output_ directory.  Could it be that you did not rebuild the pdf documentation after applying these tickets and are finding the old tex files?

Yes, it is very possible. I'm just going to build Sage again from scratch, as I've messed around with various files. But I very much doubt I built the pdfs, so that explains it. 

Dave
