# Issue 17994: constructing matrices is very slow

archive/issues_017994.json:
```json
{
    "body": "CC:  ncohen\n\nThe problem is in the code which looks like the following\n\n```\ndef test1():\n    K = QuadraticField(2)\n    for _ in range(100):\n        i = randint(2,3)\n        j = randint(2,3)\n        m = matrix(K, i, j, range(i*j))\n```\n\nIt causes the various matrix spaces to rebuilt almost each time! If we compare with\n\n```\ndef test2():\n    K = QuadraticField(2)\n    M = {(i,j): MatrixSpace(K,i,j) for i in range(2,4) for j in range(2,4)}\n    for _ in range(100):\n        i = randint(2,3)\n        j = randint(2,3)\n        m = M[i,j](range(i*j))\n```\n\nthen we got\n\n```\nsage: %timeit test1()\n10 loops, best of 3: 55 ms per loop\nsage: %timeit test2()\n100 loops, best of 3: 6.49 ms per loop\n```\n\n\nThis is one of the reason why the creation of Polyhedron is so slow (see #18213).\n\nIssue created by migration from https://trac.sagemath.org/ticket/18231\n\n",
    "created_at": "2015-04-16T22:16:20Z",
    "labels": [
        "linear algebra",
        "major",
        "bug"
    ],
    "title": "constructing matrices is very slow",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17994",
    "user": "vdelecroix"
}
```
CC:  ncohen

The problem is in the code which looks like the following

```
def test1():
    K = QuadraticField(2)
    for _ in range(100):
        i = randint(2,3)
        j = randint(2,3)
        m = matrix(K, i, j, range(i*j))
```

It causes the various matrix spaces to rebuilt almost each time! If we compare with

```
def test2():
    K = QuadraticField(2)
    M = {(i,j): MatrixSpace(K,i,j) for i in range(2,4) for j in range(2,4)}
    for _ in range(100):
        i = randint(2,3)
        j = randint(2,3)
        m = M[i,j](range(i*j))
```

then we got

```
sage: %timeit test1()
10 loops, best of 3: 55 ms per loop
sage: %timeit test2()
100 loops, best of 3: 6.49 ms per loop
```


This is one of the reason why the creation of Polyhedron is so slow (see #18213).

Issue created by migration from https://trac.sagemath.org/ticket/18231





---

archive/issue_comments_242009.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-04-18T22:50:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17994#issuecomment-242009",
    "user": "vdelecroix"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_242010.json:
```json
{
    "body": "I only did some cleanup in `matrix_space.py` and `matrix_generic_dense.pyx`. And there is a substantial gain in speed! The tiny modification in #18213 to `NumberField.__cmp__` actually makes a much bigger difference.\n\nI did not solve the problem of the matrix space being rebuilt every time.\n----\nNew commits:",
    "created_at": "2015-04-18T22:50:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17994#issuecomment-242010",
    "user": "vdelecroix"
}
```

I only did some cleanup in `matrix_space.py` and `matrix_generic_dense.pyx`. And there is a substantial gain in speed! The tiny modification in #18213 to `NumberField.__cmp__` actually makes a much bigger difference.

I did not solve the problem of the matrix space being rebuilt every time.
----
New commits:



---

archive/issue_comments_242011.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-18T22:56:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17994#issuecomment-242011",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_242012.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-04-19T06:41:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17994#issuecomment-242012",
    "user": "ncohen"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_242013.json:
```json
{
    "body": "Hello Vincent,\n\nIn this branch you create functions, remove others, and change a lot of code. There is still a lot of guessing to do on the reviewer's part.\n\nIt would be really cool if you could be more verbose about what you do. Really.\n\nI began to read the first commit, and I have several more specific questions:\n\n- You modify a function which takes a `MonoidElement` as input, which you immeditely cast with `cdef Matrix right = _right`. Either it is a matrix and it should not read `MonoidElement` in the first place, or it is not a `Matrix` and you cannot cast it?..\n\n- This is cool and everything to gain miliseconds, but that's not a good way to write public code\n  {{{\n-        matrix.Matrix.__init__(self, parent)\n+        # the four lines below avoid the following call\n+        # matrix.Matrix.__init__(self, parent)\n+        self._parent = parent\n+        res._ncols  = parent.ncols()\n+        res._nrows  = parent.nrows()\n+        R = res._base_ring = parent.base_ring()\n  }}}\n  If the main constructor does not do what you want ty to change it. What if somebody adds a new parameter to matrix? The code has to be copy/pasted in every single function that did not want to call `__init__`?\n\n- Why?\n  {{{\n\n     cdef set_unsafe(self, Py_ssize_t i, Py_ssize_t j, value):\n-        Py_DECREF(<object>PyList_GET_ITEM(self._entries, i*self._ncols + j))\n-        Py_INCREF(value)\n-        PyList_SET_ITEM(self._entries, i*self._ncols + j, value)\n+        self._entries[i*self._ncols + j] = value\n \n     cdef get_unsafe(self, Py_ssize_t i, Py_ssize_t j):\n-        return <object>PyList_GET_ITEM(self._entries, i*self._ncols + j)\n+        return self._entries[i*self._ncols + j]\n  }}}\n\nNathann",
    "created_at": "2015-04-19T06:41:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17994#issuecomment-242013",
    "user": "ncohen"
}
```

Hello Vincent,

In this branch you create functions, remove others, and change a lot of code. There is still a lot of guessing to do on the reviewer's part.

It would be really cool if you could be more verbose about what you do. Really.

I began to read the first commit, and I have several more specific questions:

- You modify a function which takes a `MonoidElement` as input, which you immeditely cast with `cdef Matrix right = _right`. Either it is a matrix and it should not read `MonoidElement` in the first place, or it is not a `Matrix` and you cannot cast it?..

- This is cool and everything to gain miliseconds, but that's not a good way to write public code
  {{{
-        matrix.Matrix.__init__(self, parent)
+        # the four lines below avoid the following call
+        # matrix.Matrix.__init__(self, parent)
+        self._parent = parent
+        res._ncols  = parent.ncols()
+        res._nrows  = parent.nrows()
+        R = res._base_ring = parent.base_ring()
  }}}
  If the main constructor does not do what you want ty to change it. What if somebody adds a new parameter to matrix? The code has to be copy/pasted in every single function that did not want to call `__init__`?

- Why?
  {{{

     cdef set_unsafe(self, Py_ssize_t i, Py_ssize_t j, value):
-        Py_DECREF(<object>PyList_GET_ITEM(self._entries, i*self._ncols + j))
-        Py_INCREF(value)
-        PyList_SET_ITEM(self._entries, i*self._ncols + j, value)
+        self._entries[i*self._ncols + j] = value
 
     cdef get_unsafe(self, Py_ssize_t i, Py_ssize_t j):
-        return <object>PyList_GET_ITEM(self._entries, i*self._ncols + j)
+        return self._entries[i*self._ncols + j]
  }}}

Nathann



---

archive/issue_comments_242014.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-04-19T09:52:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17994#issuecomment-242014",
    "user": "vdelecroix"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_242015.json:
```json
{
    "body": "Hello Nathann,\n\nThanks for having a look.\n\nReplying to [comment:3 ncohen]:\n> In this branch you create functions, remove others, and change a lot of code. There is still a lot of guessing to do on the reviewer's part.\n>\n\n> It would be really cool if you could be more verbose about what you do. Really.\n\nI made a big effort to separate the commit at least! It is now in the description of the ticket.\n\n> I began to read the first commit, and I have several more specific questions:\n> \n> - You modify a function which takes a `MonoidElement` as input, which you immeditely cast with `cdef Matrix right = _right`. Either it is a matrix and it should not read `MonoidElement` in the first place, or it is not a `Matrix` and you cannot cast it?..\n\nNo choice. This is a cdef function defined in `structure.element.Element` and you can not change the signature in children classes. I thought it was more readable this way.\n\n> - This is cool and everything to gain miliseconds, but that's not a good way to write public code\n>   If the main constructor does not do what you want ty to change it. What if somebody adds a new parameter to matrix? The code has to be copy/pasted in every single function that did not want to call `__init__`?\n\nAll right. But then there is something wrong in the docstring of `matrix0.Matrix`\n\n```\n    def __init__(...):\n        ...\n        Subclasses of ``Matrix`` can safely skip calling\n        ``Matrix.__init__`` provided they take care of initializing these\n        attributes themselves.\n        ...\n```\n\n\n> - Why?\n\nAll this was just old Cython code at the time Cython was not able to understand `l[i]` when `l` is a `cdef list`.",
    "created_at": "2015-04-19T09:52:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17994#issuecomment-242015",
    "user": "vdelecroix"
}
```

Hello Nathann,

Thanks for having a look.

Replying to [comment:3 ncohen]:
> In this branch you create functions, remove others, and change a lot of code. There is still a lot of guessing to do on the reviewer's part.
>

> It would be really cool if you could be more verbose about what you do. Really.

I made a big effort to separate the commit at least! It is now in the description of the ticket.

> I began to read the first commit, and I have several more specific questions:
> 
> - You modify a function which takes a `MonoidElement` as input, which you immeditely cast with `cdef Matrix right = _right`. Either it is a matrix and it should not read `MonoidElement` in the first place, or it is not a `Matrix` and you cannot cast it?..

No choice. This is a cdef function defined in `structure.element.Element` and you can not change the signature in children classes. I thought it was more readable this way.

> - This is cool and everything to gain miliseconds, but that's not a good way to write public code
>   If the main constructor does not do what you want ty to change it. What if somebody adds a new parameter to matrix? The code has to be copy/pasted in every single function that did not want to call `__init__`?

All right. But then there is something wrong in the docstring of `matrix0.Matrix`

```
    def __init__(...):
        ...
        Subclasses of ``Matrix`` can safely skip calling
        ``Matrix.__init__`` provided they take care of initializing these
        attributes themselves.
        ...
```


> - Why?

All this was just old Cython code at the time Cython was not able to understand `l[i]` when `l` is a `cdef list`.



---

archive/issue_comments_242016.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-19T10:47:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17994#issuecomment-242016",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_242017.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-19T12:53:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17994#issuecomment-242017",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_242018.json:
```json
{
    "body": "Yoooooo !\n\n> I made a big effort to separate the commit at least! It is now in the description of the ticket.\n\nThanks\n\n> No choice. This is a cdef function defined in `structure.element.Element` and you can not change the signature in children classes. I thought it was more readable this way.\n\nOh, okay!\n\n> All right. But then there is something wrong in the docstring of `matrix0.Matrix`\n\nHmmmm.... Can you at least observe the difference? All that this `__init__` function does is precisely what you do. Can you measure this function call when your function copies lists around? `O_o`\n\n> All this was just old Cython code at the time Cython was not able to understand `l[i]` when `l` is a `cdef list`.\n\nOkay!\n\nNathann",
    "created_at": "2015-04-19T19:15:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17994#issuecomment-242018",
    "user": "ncohen"
}
```

Yoooooo !

> I made a big effort to separate the commit at least! It is now in the description of the ticket.

Thanks

> No choice. This is a cdef function defined in `structure.element.Element` and you can not change the signature in children classes. I thought it was more readable this way.

Oh, okay!

> All right. But then there is something wrong in the docstring of `matrix0.Matrix`

Hmmmm.... Can you at least observe the difference? All that this `__init__` function does is precisely what you do. Can you measure this function call when your function copies lists around? `O_o`

> All this was just old Cython code at the time Cython was not able to understand `l[i]` when `l` is a `cdef list`.

Okay!

Nathann



---

archive/issue_comments_242019.json:
```json
{
    "body": "Okay, I give up. Sorry, I just don't know these classes enough, I barely ever used them, I would do a terrible job as a reviewer.\n\nNathann",
    "created_at": "2015-04-19T19:19:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17994#issuecomment-242019",
    "user": "ncohen"
}
```

Okay, I give up. Sorry, I just don't know these classes enough, I barely ever used them, I would do a terrible job as a reviewer.

Nathann



---

archive/issue_comments_242020.json:
```json
{
    "body": "needs rebase, does not apply",
    "created_at": "2015-08-09T18:43:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17994#issuecomment-242020",
    "user": "chapoton"
}
```

needs rebase, does not apply



---

archive/issue_comments_242021.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-08-09T18:43:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17994#issuecomment-242021",
    "user": "chapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_242022.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2015-08-13T13:54:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17994#issuecomment-242022",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_242023.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-08-13T13:55:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17994#issuecomment-242023",
    "user": "vdelecroix"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_242024.json:
```json
{
    "body": "Whether to see if patchbot is happy.",
    "created_at": "2015-08-13T13:55:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17994#issuecomment-242024",
    "user": "vdelecroix"
}
```

Whether to see if patchbot is happy.



---

archive/issue_comments_242025.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-08-13T15:01:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17994#issuecomment-242025",
    "user": "vdelecroix"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_242026.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2015-08-13T15:06:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17994#issuecomment-242026",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_242027.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-08-13T15:06:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17994#issuecomment-242027",
    "user": "vdelecroix"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_242028.json:
```json
{
    "body": "I moved the first commit to another ticket (#19026).",
    "created_at": "2015-08-13T15:06:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17994#issuecomment-242028",
    "user": "vdelecroix"
}
```

I moved the first commit to another ticket (#19026).



---

archive/issue_comments_242029.json:
```json
{
    "body": "needs rebase",
    "created_at": "2015-09-11T06:44:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17994#issuecomment-242029",
    "user": "chapoton"
}
```

needs rebase



---

archive/issue_comments_242030.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-09-11T06:44:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17994#issuecomment-242030",
    "user": "chapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_242031.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-02-19T18:22:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17994#issuecomment-242031",
    "user": "mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_242032.json:
```json
{
    "body": "Outdated, this was fixed in #24742.\n\n\n```\nsage: %timeit test1()\n3.91 ms \u00b1 47.3 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\nsage: %timeit test2()\n3.03 ms \u00b1 19.4 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\n```\n",
    "created_at": "2022-02-19T18:22:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17994#issuecomment-242032",
    "user": "mkoeppe"
}
```

Outdated, this was fixed in #24742.


```
sage: %timeit test1()
3.91 ms ± 47.3 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
sage: %timeit test2()
3.03 ms ± 19.4 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
```




---

archive/issue_comments_242033.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-02-19T18:51:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17994#issuecomment-242033",
    "user": "vdelecroix"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_242034.json:
```json
{
    "body": "Resolution: duplicate",
    "created_at": "2022-02-25T10:34:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17994",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17994#issuecomment-242034",
    "user": "chapoton"
}
```

Resolution: duplicate
