# Issue 17994: constructing matrices is very slow

Issue created by migration from Trac.

Original creator: vdelecroix

Original creation time: 2015-04-16 22:16:20

CC:  ncohen

The problem is in the code which looks like the following

```
def test1():
    K = QuadraticField(2)
    for _ in range(100):
        i = randint(2,3)
        j = randint(2,3)
        m = matrix(K, i, j, range(i*j))
```

It causes the various matrix spaces to rebuilt almost each time! If we compare with

```
def test2():
    K = QuadraticField(2)
    M = {(i,j): MatrixSpace(K,i,j) for i in range(2,4) for j in range(2,4)}
    for _ in range(100):
        i = randint(2,3)
        j = randint(2,3)
        m = M[i,j](range(i*j))
```

then we got

```
sage: %timeit test1()
10 loops, best of 3: 55 ms per loop
sage: %timeit test2()
100 loops, best of 3: 6.49 ms per loop
```


This is one of the reason why the creation of Polyhedron is so slow (see #18213).


---

Comment by vdelecroix created at 2015-04-18 22:50:34

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2015-04-18 22:50:34

I only did some cleanup in `matrix_space.py` and `matrix_generic_dense.pyx`. And there is a substantial gain in speed! The tiny modification in #18213 to `NumberField.__cmp__` actually makes a much bigger difference.

I did not solve the problem of the matrix space being rebuilt every time.
----
New commits:


---

Comment by git created at 2015-04-18 22:56:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2015-04-19 06:41:15

Changing status from needs_review to needs_work.


---

Comment by ncohen created at 2015-04-19 06:41:15

Hello Vincent,

In this branch you create functions, remove others, and change a lot of code. There is still a lot of guessing to do on the reviewer's part.

It would be really cool if you could be more verbose about what you do. Really.

I began to read the first commit, and I have several more specific questions:

- You modify a function which takes a `MonoidElement` as input, which you immeditely cast with `cdef Matrix right = _right`. Either it is a matrix and it should not read `MonoidElement` in the first place, or it is not a `Matrix` and you cannot cast it?..

- This is cool and everything to gain miliseconds, but that's not a good way to write public code
  {{{
-        matrix.Matrix.__init__(self, parent)
+        # the four lines below avoid the following call
+        # matrix.Matrix.__init__(self, parent)
+        self._parent = parent
+        res._ncols  = parent.ncols()
+        res._nrows  = parent.nrows()
+        R = res._base_ring = parent.base_ring()
  }}}
  If the main constructor does not do what you want ty to change it. What if somebody adds a new parameter to matrix? The code has to be copy/pasted in every single function that did not want to call `__init__`?

- Why?
  {{{

     cdef set_unsafe(self, Py_ssize_t i, Py_ssize_t j, value):
-        Py_DECREF(<object>PyList_GET_ITEM(self._entries, i*self._ncols + j))
-        Py_INCREF(value)
-        PyList_SET_ITEM(self._entries, i*self._ncols + j, value)
+        self._entries[i*self._ncols + j] = value
 
     cdef get_unsafe(self, Py_ssize_t i, Py_ssize_t j):
-        return <object>PyList_GET_ITEM(self._entries, i*self._ncols + j)
+        return self._entries[i*self._ncols + j]
  }}}

Nathann


---

Comment by vdelecroix created at 2015-04-19 09:52:48

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2015-04-19 09:52:48

Hello Nathann,

Thanks for having a look.

Replying to [comment:3 ncohen]:
> In this branch you create functions, remove others, and change a lot of code. There is still a lot of guessing to do on the reviewer's part.
>

> It would be really cool if you could be more verbose about what you do. Really.

I made a big effort to separate the commit at least! It is now in the description of the ticket.

> I began to read the first commit, and I have several more specific questions:
> 
> - You modify a function which takes a `MonoidElement` as input, which you immeditely cast with `cdef Matrix right = _right`. Either it is a matrix and it should not read `MonoidElement` in the first place, or it is not a `Matrix` and you cannot cast it?..

No choice. This is a cdef function defined in `structure.element.Element` and you can not change the signature in children classes. I thought it was more readable this way.

> - This is cool and everything to gain miliseconds, but that's not a good way to write public code
>   If the main constructor does not do what you want ty to change it. What if somebody adds a new parameter to matrix? The code has to be copy/pasted in every single function that did not want to call `__init__`?

All right. But then there is something wrong in the docstring of `matrix0.Matrix`

```
    def __init__(...):
        ...
        Subclasses of ``Matrix`` can safely skip calling
        ``Matrix.__init__`` provided they take care of initializing these
        attributes themselves.
        ...
```


> - Why?

All this was just old Cython code at the time Cython was not able to understand `l[i]` when `l` is a `cdef list`.


---

Comment by git created at 2015-04-19 10:47:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-04-19 12:53:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2015-04-19 19:15:22

Yoooooo !

> I made a big effort to separate the commit at least! It is now in the description of the ticket.

Thanks

> No choice. This is a cdef function defined in `structure.element.Element` and you can not change the signature in children classes. I thought it was more readable this way.

Oh, okay!

> All right. But then there is something wrong in the docstring of `matrix0.Matrix`

Hmmmm.... Can you at least observe the difference? All that this `__init__` function does is precisely what you do. Can you measure this function call when your function copies lists around? `O_o`

> All this was just old Cython code at the time Cython was not able to understand `l[i]` when `l` is a `cdef list`.

Okay!

Nathann


---

Comment by ncohen created at 2015-04-19 19:19:51

Okay, I give up. Sorry, I just don't know these classes enough, I barely ever used them, I would do a terrible job as a reviewer.

Nathann


---

Comment by chapoton created at 2015-08-09 18:43:14

needs rebase, does not apply


---

Comment by chapoton created at 2015-08-09 18:43:14

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-08-13 13:54:24

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by vdelecroix created at 2015-08-13 13:55:37

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2015-08-13 13:55:37

Whether to see if patchbot is happy.


---

Comment by vdelecroix created at 2015-08-13 15:01:15

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-08-13 15:06:06

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by vdelecroix created at 2015-08-13 15:06:41

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2015-08-13 15:06:41

I moved the first commit to another ticket (#19026).


---

Comment by chapoton created at 2015-09-11 06:44:11

needs rebase


---

Comment by chapoton created at 2015-09-11 06:44:11

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2022-02-19 18:22:28

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-02-19 18:22:28

Outdated, this was fixed in #24742.


```
sage: %timeit test1()
3.91 ms ± 47.3 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
sage: %timeit test2()
3.03 ms ± 19.4 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
```



---

Comment by vdelecroix created at 2022-02-19 18:51:44

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2022-02-25 10:34:15

Resolution: duplicate
