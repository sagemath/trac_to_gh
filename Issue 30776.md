# Issue 30776: Remove unused optional extension

Issue created by migration from https://trac.sagemath.org/ticket/31013

Original creator: @tobiasdiez

Original creation time: 2020-12-05 18:36:48

CC:  mkoeppe fbissey

The code in `optional_extension` was mostly unused and is removed in this ticket (and similarly `extension.skip_build` was nowhere else set). 
The only still used method was `is_package_installed_and_updated` which is moved to `sage.misc.package` (where also a bit of typing info is added).


---

Comment by @tobiasdiez created at 2020-12-05 18:36:55

Changing status from new to needs_review.


---

Comment by git created at 2020-12-05 18:37:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-05 18:39:53

Can't make incompatible changes to the interface of a public function


---

Comment by mkoeppe created at 2020-12-05 18:44:21

(I'm referring to the `list_packages` function)


---

Comment by mkoeppe created at 2020-12-05 18:52:48

It's also conflicting with the changes in #30940 (which needs review)


---

Comment by git created at 2020-12-05 18:57:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-12-05 19:20:25

Replying to [comment:4 mkoeppe]:
> Can't make incompatible changes to the interface of a public function

So one cannot change public facing functions at all? What is the policy/strategy for this? Introduce a new method, say `list_packages_typed`?

> It's also conflicting with the changes in #30940 (which needs review)

I wouldn't say it's conflicting, just results in easy-to-resolve merge conflicts.


---

Comment by mkoeppe created at 2020-12-05 19:33:47

Replying to [comment:8 gh-tobiasdiez]:
> Replying to [comment:4 mkoeppe]:
> > Can't make incompatible changes to the interface of a public function
> 
> So one cannot change public facing functions at all? What is the policy/strategy for this? Introduce a new method, say `list_packages_typed`?

It could be a new function (with deprecation for the old one), or an optional argument that controls the return type, ...

But in this particular case, it would probably be good enough to just give the new class dictionary-like behavior so that user code can continue to access the slots like a dictionary. Possibly with deprecation warning.


---

Comment by git created at 2020-12-05 20:16:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-12-05 20:16:38

Replying to [comment:9 mkoeppe]:
> But in this particular case, it would probably be good enough to just give the new class dictionary-like behavior so that user code can continue to access the slots like a dictionary. Possibly with deprecation warning.
> 

That's a nice idea, implemented!


---

Comment by mkoeppe created at 2020-12-05 20:44:07

Instead of "string-based access", perhaps this should be called "dict-like access" in the deprecation messages?


---

Comment by mkoeppe created at 2020-12-06 00:20:00

I think in this change you need to use `is_installed()` instead

```
--- a/src/bin/sage-list-packages
+++ b/src/bin/sage-list-packages
@@ -91,16 +91,16 @@ else:
 if WARN:
     print(WARN)
 if args['installed_only']:
-    L = [pkg for pkg in L if pkg['installed']]
+    L = [pkg for pkg in L if pkg.installed]
 elif args['not_installed_only']:
-    L = [pkg for pkg in L if not pkg['installed']]
+    L = [pkg for pkg in L if not pkg.installed]
```



---

Comment by mkoeppe created at 2020-12-06 00:20:07

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Changing keywords from "" to "sd111".


---

Comment by git created at 2020-12-06 22:24:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-12-06 22:25:13

Replying to [comment:13 mkoeppe]:
> I think in this change you need to use `is_installed()` instead

Indeed, thanks!


---

Comment by @tobiasdiez created at 2020-12-06 22:25:13

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2020-12-06 22:25:43

Replying to [comment:16 mkoeppe]:
> Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111

I try to join, but I'm on vacation this week...


---

Comment by mkoeppe created at 2020-12-07 00:15:47

Needs rebase on latest beta


---

Comment by mkoeppe created at 2020-12-07 00:15:47

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-12-07 13:11:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-12-07 13:13:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-12-07 13:26:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-12-07 13:27:31

I've now rebased on top of develop and on #30940.


---

Comment by @tobiasdiez created at 2020-12-07 13:27:31

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-12-07 19:18:27

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-12-07 19:18:27

This branch is seriously messed up... best to squash some of the intermediate commits


---

Comment by @tobiasdiez created at 2020-12-07 19:28:43

I agree, everything should be squashed instead of merged for the final integration in `develop`/`master` - but that's going to happen anyway, right?


---

Comment by mkoeppe created at 2020-12-07 19:34:36

No, the branches of the tickets are merged as is, not squashed, by the release manager


---

Comment by git created at 2020-12-07 20:17:55

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @tobiasdiez created at 2020-12-07 20:19:54

Replying to [comment:28 mkoeppe]:
> No, the branches of the tickets are merged as is, not squashed, by the release manager

Ok, I got the impression they are squashed by looking at https://github.com/sagemath/sage/commits/develop. I've now squashed everything.


---

Comment by @tobiasdiez created at 2020-12-07 20:19:59

Changing status from needs_work to needs_review.


---

Comment by git created at 2020-12-07 20:29:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-07 23:34:29

The doctest of `__getitem__` is not formatted correctly


---

Comment by git created at 2020-12-07 23:41:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-12-07 23:42:44

Replying to [comment:33 mkoeppe]:
> The doctest of `__getitem__` is not formatted correctly

Hopefully fixed now. 

(doctest still don't run for me...e.g I now get RuntimeError: refusing to run doctests from the current directory '/mnt/d/Programming/sage' since untrusted users could put files in this directory, making it unsafe to run Sage code from)


---

Comment by mkoeppe created at 2020-12-08 01:14:23

Build fails for me

```
  [sagelib-9.3.beta3]   Configured with: --prefix=/Library/Developer/CommandLineTools/usr --with-gxx-include-dir=/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/include/c++/4.2.1
  [sagelib-9.3.beta3]   Discovering Python/Cython source code....
  [sagelib-9.3.beta3]   ************************************************************************
  [sagelib-9.3.beta3]   Traceback (most recent call last):
  [sagelib-9.3.beta3]     File "setup.py", line 60, in <module>
  [sagelib-9.3.beta3]       from sage.misc.package import is_package_installed_and_updated
  [sagelib-9.3.beta3]     File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/build/pkgs/sagelib/src/sage/misc/package.py", line 177, in <module>
  [sagelib-9.3.beta3]       class PackageInfo(NamedTuple):
  [sagelib-9.3.beta3]   RuntimeError: __class__ not set defining 'PackageInfo' as <class 'sage.misc.package.PackageInfo'>. Was __classcell__ propagated to type.__new__?
  [sagelib-9.3.beta3]   ************************************************************************
  [sagelib-9.3.beta3]   Error building the Sage library
  [sagelib-9.3.beta3]   ************************************************************************
```



---

Comment by mkoeppe created at 2020-12-08 01:14:23

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-12-08 09:48:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-12-08 09:57:04

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2020-12-08 09:57:04

Replying to [comment:36 mkoeppe]:
> Build fails for me

Should be fixed now.

Could you please have a look at #30901 and #30748. It's really awkward for me not be able to test my own changes. Thanks!


---

Comment by mkoeppe created at 2020-12-09 02:11:02


```
[sagelib-9.3.beta3] Discovering Python/Cython source code....
[sagelib-9.3.beta3] ************************************************************************
[sagelib-9.3.beta3] Traceback (most recent call last):
[sagelib-9.3.beta3]   File "setup.py", line 60, in <module>
[sagelib-9.3.beta3]     from sage.misc.package import is_package_installed_and_updated
[sagelib-9.3.beta3]   File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/build/pkgs/sagelib/src/sage/misc/package.py", line 434, in <module>
[sagelib-9.3.beta3]     all_packages = list_packages(local=True)
[sagelib-9.3.beta3]   File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/build/pkgs/sagelib/src/sage/misc/package.py", line 329, in list_packages
[sagelib-9.3.beta3]     pkg.name = p
[sagelib-9.3.beta3] AttributeError: can't set attribute
[sagelib-9.3.beta3] ************************************************************************
```



---

Comment by git created at 2020-12-09 09:57:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-12-09 10:01:20

Sorry should have tested it after the merge. Should work now.


---

Comment by @kliem created at 2020-12-09 19:24:24


```diff
-                deprecation(31013, "dict-like access is deprecated, use e.g `pkg.name` instead of `pkg[name]`")
+                deprecation(31013, "dict-like access is deprecated, use e.g `pkg.name` instead of `pkg['name']`")
```



---

Comment by @kliem created at 2020-12-09 20:52:43


```
Running doctests with ID 2020-12-09-21-48-42-bac7d593.
Git branch: test/31013
Using --optional=4ti2,build,debian,dochtml,e_antic,lidia,lrslib,mcqd,memlimit,normaliz,pip,pynormaliz,pyroaringbitmap,python_igraph,rubiks,sage,sage_spkg,speaklater,texttable     
Doctesting 1 file.
sage -t --random-seed=0 src/sage/misc/package.py
**********************************************************************
File "src/sage/misc/package.py", line 194, in sage.misc.package.PackageInfo
Failed example:
    package = PackageInfo("test_package")
Exception raised:
    Traceback (most recent call last):
      File "/srv/public/kliem/sage/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/srv/public/kliem/sage/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 1133, in compile_and_execute                                                    
        exec(compiled, globs)
      File "<doctest sage.misc.package.PackageInfo[0]>", line 1, in <module>
        package = PackageInfo("test_package")
    NameError: name 'PackageInfo' is not defined
**********************************************************************
File "src/sage/misc/package.py", line 195, in sage.misc.package.PackageInfo
Failed example:
    package["name"]
Exception raised:
    Traceback (most recent call last):
      File "/srv/public/kliem/sage/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/srv/public/kliem/sage/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 1133, in compile_and_execute                                                    
        exec(compiled, globs)
      File "<doctest sage.misc.package.PackageInfo[1]>", line 1, in <module>
        package["name"]
    NameError: name 'package' is not defined
**********************************************************************
File "src/sage/misc/package.py", line 199, in sage.misc.package.PackageInfo
Failed example:
    package[0]
Exception raised:
    Traceback (most recent call last):
      File "/srv/public/kliem/sage/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/srv/public/kliem/sage/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 1133, in compile_and_execute                                                    
        exec(compiled, globs)
      File "<doctest sage.misc.package.PackageInfo[2]>", line 1, in <module>
        package[Integer(0)]
    NameError: name 'package' is not defined
**********************************************************************
File "src/sage/misc/package.py", line 263, in sage.misc.package.pkg_sources
Failed example:
    sage_conf_info.installed # optional - build
Exception raised:
    Traceback (most recent call last):
      File "/srv/public/kliem/sage/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/srv/public/kliem/sage/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 1133, in compile_and_execute                                                    
        exec(compiled, globs)
      File "<doctest sage.misc.package.pkg_sources[5]>", line 1, in <module>
        sage_conf_info.installed # optional - build
    AttributeError: 'PackageInfo' object has no attribute 'installed'
**********************************************************************
File "src/sage/misc/package.py", line 413, in sage.misc.package.is_package_installed
Failed example:
    for pkg in list_packages(pkg_sources=('pip'), local=True):  # optional - build
        assert not is_package_installed(pkg), "pip package is installed: {}".format(pkg)
Exception raised:
    Traceback (most recent call last):
      File "/srv/public/kliem/sage/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/srv/public/kliem/sage/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 1133, in compile_and_execute                                                    
        exec(compiled, globs)
      File "<doctest sage.misc.package.is_package_installed[3]>", line 2, in <module>
        assert not is_package_installed(pkg), "pip package is installed: {}".format(pkg)
    AssertionError: pip package is installed: itsdangerous
**********************************************************************
3 items had failures:
   3 of   4 in sage.misc.package.PackageInfo
   1 of   5 in sage.misc.package.is_package_installed
   1 of   9 in sage.misc.package.pkg_sources
    [55 tests, 5 failures, 2.38 s]
----------------------------------------------------------------------
sage -t --random-seed=0 src/sage/misc/package.py  # 5 doctests failed
```


Everything else passes. Build as well.


---

Comment by @kliem created at 2020-12-09 20:52:43

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-12-10 17:45:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-10 17:47:26

I have fixed a few things but the assertion error remains to be fixed


---

Comment by mkoeppe created at 2020-12-16 23:51:47

Latest #30940 also needs to be merged


---

Comment by mkoeppe created at 2021-01-19 20:19:11

The dependency has been merged in 9.3.beta6. Needs rebase


---

Comment by git created at 2021-01-19 21:40:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-01-19 21:45:36

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2021-01-19 21:45:36

Locally, all tests pass for me now. So this should be ready for review.


---

Comment by mkoeppe created at 2021-01-30 23:16:11

Tests pass for me, too.


```
all_packages = list_packages(local=True)
```

It was fine to executed this code at module load time in `sage_setup.optional_extension`,  but I don't think it is good to do so at load time of `sage.misc.package`.

Also `is_package_installed_and_updated` would need documentation + test as it is moved to sagelib


---

Comment by mkoeppe created at 2021-01-30 23:16:11

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-02-02 17:12:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-02-02 17:13:55

> Also is_package_installed_and_updated would need documentation + test as it is moved to sagelib 
Ok done.

I've removed the caching completely, because this probably is best done at the level of `list_packages` anyway.


---

Comment by @tobiasdiez created at 2021-02-02 17:14:06

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-02-02 17:43:33

Removing caching will probably make `setup.py` somewhat slower, so I am not sure this is a good idea.


---

Comment by mkoeppe created at 2021-02-02 17:45:02

Perhaps it's best to split this ticket and only do the interface improvement for `list_packages` here.


---

Comment by mkoeppe created at 2021-02-10 20:28:53

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-02-12 00:32:39

Replying to [comment:55 mkoeppe]:
> Perhaps it's best to split this ticket 

... I have opened #31385 (Improve interface of `list_packages`)


---

Comment by @tobiasdiez created at 2021-02-12 08:56:06

Thanks!


---

Comment by mkoeppe created at 2021-03-15 22:07:04

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by git created at 2021-11-26 21:38:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-11-26 21:40:21

Rebased, so this is now ready for review.


---

Comment by @tobiasdiez created at 2021-11-26 21:40:21

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-12-18 19:53:12

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.


---

Comment by @tobiasdiez created at 2021-12-19 20:33:35

Yes, I would appreciate if this ticket could be reviewed!


---

Comment by git created at 2022-01-03 12:28:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2022-01-10 04:20:14

Thanks for copying me Matthias. I was aware of this ticket and I guess it will at least remove some pesky doctests. Otherwise it will just make me move some patch from one file to another.

`is_package_installed_and_updated` is one of those things I am patiently waiting for the modularisation of sage to kill. In the meantime I am patching an alternative mechanism anyway.


---

Comment by fbissey created at 2022-01-10 04:25:04

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2022-01-10 04:25:04

Other than that, if you copied me for the review, it all looks good and sensible to me.


---

Comment by @tobiasdiez created at 2022-01-10 12:46:44

Thanks for the review!


---

Comment by vbraun created at 2022-01-31 23:31:41

Resolution: fixed
