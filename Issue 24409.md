# Issue 24409: Add support for staged installations in packages that use sdh_pip_install

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2018-02-02 13:50:25

This implements #22509 for any Python packages that are installed with `sdh_pip_install`.  Passing `--root=` to pip is essentially the same as using `DESTDIR` with `make install`.

This required a few additional changes to a small handful of packages for them to work with staged installation.


---

Comment by embray created at 2018-02-02 13:50:41

Changing status from new to needs_review.


---

Comment by git created at 2018-03-26 11:18:46

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-03-26 11:20:35

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2018-05-12 19:57:40

merge failure on 8.3.b0


---

Comment by vdelecroix created at 2018-05-12 19:57:40

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-05-14 15:35:32

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-05-14 15:35:59

Rebased since its dependency #24645 has been satisfied.


---

Comment by embray created at 2018-05-14 15:35:59

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-05-15 14:44:58

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-05-15 14:44:58

What's up with `build/pkgs/widgetsnbextension/spkg-postinst`? That should just be removed.


---

Comment by jdemeyer created at 2018-05-15 14:46:13

For `sagenb`, why not keep

```
if [ ! -d mathjax ]; then
    echo >&2 "Error: Cannot symlink mathjax into the SageNB data directory."
    exit 1
fi
```

It seems like a useful sanity check.


---

Comment by embray created at 2018-05-15 14:59:39

Replying to [comment:8 jdemeyer]:
> What's up with `build/pkgs/widgetsnbextension/spkg-postinst`?

Let me check whether or not that was intended to be in this branch.

> That should just be removed.

I don't see how you can assert that without knowing what it is.


---

Comment by embray created at 2018-05-15 15:05:12

Replying to [comment:9 jdemeyer]:
> For `sagenb`, why not keep

You can see just above that it checks that the directory being symlinked exists before making the symlink.


---

Comment by jdemeyer created at 2018-05-15 15:22:21

Replying to [comment:11 embray]:
> You can see just above that it checks that the directory being symlinked exists before making the symlink.

It's not at all obvious to me that the check _before_ is equivalent to the `ln -s` succeeding. The check after is simpler and therefore safer.


---

Comment by jdemeyer created at 2018-05-15 15:25:50

Replying to [comment:10 embray]:
> I don't see how you can assert that without knowing what it is.

I know what it is because I wrote the original. The code which is in that `spkg-postinst` script used to be in `spkg-install` but it's no longer needed because of Jupyter improvements. At some point, you must have had a merge/rebase conflict with `spkg-install` and this left-over `spkg-postinst` script is fallout from that.


---

Comment by embray created at 2018-05-15 16:32:35

I see, you even removed the `jupyter nbextension` call a while ago (but probably after I first wrote this).  I believe you then, that it's no longer needed.


---

Comment by git created at 2018-05-16 09:53:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-05-16 09:53:51

Ok, I dropped the `spkg-postinst` for `widgetsnbextension` and updated the sagenb install.  I think this is better now.


---

Comment by embray created at 2018-05-16 09:53:51

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-05-16 10:41:36

For `sagenb`, you still removed the check for a working symlink. Why?


---

Comment by embray created at 2018-05-16 12:14:14

The symlink wouldn't resolve because this is being installed in DESTDIR.


---

Comment by jdemeyer created at 2018-05-16 15:01:25

The changes to Sphinx conflict with #24935. It is possible to just revert those?


---

Comment by embray created at 2018-05-16 15:13:33

Unfortunately they're necessary for the package to install correctly.  You could merge this into #24935.


---

Comment by saraedum created at 2018-06-01 23:40:25

Changing status from needs_review to needs_work.


---

Comment by saraedum created at 2018-06-01 23:40:25

there are merge conflicts


---

Comment by git created at 2018-06-02 15:11:47

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-06-02 15:12:17

Changing status from needs_work to needs_review.


---

Comment by embray created at 2018-06-02 15:12:17

I'm surprised this hasn't been merged yet.  It really ought to be.


---

Comment by git created at 2018-07-10 16:55:29

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-07-10 16:55:49

Here we go again...


---

Comment by saraedum created at 2018-07-11 13:55:34

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-07-15 09:47:47

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2018-07-15 09:47:47

See patchbot


---

Comment by embray created at 2018-07-16 10:09:00

Apparently I had asked Jeroen to make this a prerequisite to #24935 (after all, this ticket was opened first and had no reason to wait so long to be merged).  But he forgot about that or ignored it (and I likewise forgot about it).


---

Comment by git created at 2018-07-16 10:15:59

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-07-16 10:16:22

The `spkg-postinst` for Sphinx was simply no longer necessary so I removed it.


---

Comment by embray created at 2018-07-16 10:16:22

Changing status from needs_work to positive_review.


---

Comment by embray created at 2018-07-18 11:47:03

I believe this issue can reasonably be addressed for Sage 8.4.


---

Comment by vbraun created at 2018-07-30 08:19:38

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2018-07-30 08:19:38

You obviously didn't try to build Sage with the ticket

```
No record that 'sagenb' was ever installed; skipping uninstall
./spkg-install: line 33: syntax error near unexpected token `fi'
./spkg-install: line 33: `fi'
```



---

Comment by embray created at 2018-07-30 16:16:34

Replying to [comment:34 vbraun]:
> You obviously didn't try to build Sage with the ticket

That's a bit flippant.  Of course I built Sage with this ticket.  It's been opened for 6 months and has had to be rebased many times.  Perhaps there was a small merge error along the way.  But that's not as if it was never tested...


---

Comment by embray created at 2018-07-30 16:18:41

Also, the ticket doesn't bump the package versions of the affected packages, so you would only see the issue if rebuilding from scratch.  The "obviously" is pretty unnecessary.


---

Comment by git created at 2018-07-30 16:22:52

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-07-30 16:24:02

Changing status from needs_work to positive_review.


---

Comment by embray created at 2018-07-30 16:24:02

New commits:


---

Comment by vbraun created at 2018-08-05 08:43:12

Resolution: fixed
