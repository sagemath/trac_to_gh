# Issue 21530: Package libcurl (and curl) as a standard package

Issue created by migration from https://trac.sagemath.org/ticket/21767

Original creator: charpent

Original creation time: 2016-10-25 19:24:41

CC:  jpflori jdemeyer jhpalmieri vbraun

Keywords: r-project

Rationale : R (standard package) requires libcurl (and possibly the curl executable), but stopped to package it with version 3.3.0.

See [discussion](https://groups.google.com/forum/#!topic/sage-devel/9gun2Wo6zGM) on sage-devel.

Original tarball is [here](https://curl.haxx.se/download/curl-7.50.3.tar.gz)


---

Comment by charpent created at 2016-10-25 19:26:53

Plan :

* Create a package that builds and installs curl unconditionnally. Test that.
* Immediately after, patch it to add a detection of an usable systemwide version, and do not install if such a version is found.


---

Comment by charpent created at 2016-10-25 21:44:05

This initial packaging :
* builds with no error on top of 7.5beta0
* passes its own test suite successfully.

The resulting Sage passes testlong with no errors (not even transient, for a marvel...

Marking `needs_review`. See the thread on `sage-devel` for discussion of conditional installation.
----
New commits:


---

Comment by charpent created at 2016-10-25 21:44:05

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2016-10-26 07:22:43

Author name please...


---

Comment by jdemeyer created at 2016-10-26 07:22:43

Changing status from needs_review to needs_info.


---

Comment by jdemeyer created at 2016-10-26 07:27:14

I don't like this style of logging:

```
CC       libcurl_la-curl_gethostname.lo
```

I like to see the `gcc` command-line to figure out what is going on.

Usually, this can be changed by passing `V=1` to the `make` command line (see for example `build/pkgs/libfplll/spkg-install`)


---

Comment by jpflori created at 2016-10-26 10:25:45

Would be nice to have the standard pieces of code to check we are in a Sage shell and to apply potential patches.


---

Comment by jpflori created at 2016-10-26 10:25:45

Changing status from needs_info to needs_work.


---

Comment by charpent created at 2016-10-26 10:31:23

Replying to [comment:5 jdemeyer]:
> I don't like this style of logging:
> {{{
> CC       libcurl_la-curl_gethostname.lo
> }}}
> I like to see the `gcc` command-line to figure out what is going on.
> 
> Usually, this can be changed by passing `V=1` to the `make` command line (see for example `build/pkgs/libfplll/spkg-install`)

Doable. On your head be it...


---

Comment by charpent created at 2016-10-26 10:31:54

Replying to [comment:4 jdemeyer]:
> Author name please...

Done


---

Comment by charpent created at 2016-10-26 10:36:17

Replying to [comment:6 jpflori]:

Could you clarify :
> Would be nice to have the standard pieces of code to check we are in a Sage shell

??? What"'s that ?  A simple hint might be to `test ! X$SAGE_ROOT = X `, but you seem to have something more sophisticated in head.

> and to apply potential patches.

??? Clarification required. What are "potential patches" ?


---

Comment by jpflori created at 2016-10-26 11:13:10

Replying to [comment:9 charpent]:
> Replying to [comment:6 jpflori]:
> 
> Could you clarify :
> > Would be nice to have the standard pieces of code to check we are in a Sage shell
> 
> ??? What"'s that ?  A simple hint might be to `test ! X$SAGE_ROOT = X `, but you seem to have something more sophisticated in head.
https://github.com/sagemath/sage/blob/master/build/pkgs/ecl/spkg-install#L3

> 
> > and to apply potential patches.
> 
> ??? Clarification required. What are "potential patches" ?
https://github.com/sagemath/sage/blob/master/build/pkgs/ecl/spkg-install#L13


---

Comment by jdemeyer created at 2016-10-26 11:15:09

Replying to [comment:7 charpent]:
> Doable. On your head be it...

What do you mean with this?


---

Comment by jdemeyer created at 2016-10-26 11:15:50

Replying to [comment:10 jpflori]:
> https://github.com/sagemath/sage/blob/master/build/pkgs/ecl/spkg-install#L13

Please don't, see #20692 instead.


---

Comment by jdemeyer created at 2016-10-26 11:16:49

The package builds fine.


---

Comment by charpent created at 2016-10-26 11:52:45

Replying to [comment:11 jdemeyer]:
> Replying to [comment:7 charpent]:
> > Doable. On your head be it...
> 
> What do you mean with this?

Nothing rude, be assured ! (sorry if that sounded rude...). I just mean that I'm not very fond of miles-log logs, where the relevant information doesn't stand out (common problem with, for example, LaTeX).


---

Comment by git created at 2016-10-26 17:07:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by charpent created at 2016-10-26 17:25:25

Changing status from needs_work to needs_review.


---

Comment by charpent created at 2016-10-26 17:25:25

In this branch :
* Sage shell checking
* verbose compilation
* patching (and empty patches directory), [Sage Maintainer's Guide](http://doc.sagemath.org/html/en/developer/packaging.html#patching-sources) style.

This builds and passes the package's own test suite without errors ; the resulting Sage passes ptestlong with the usual transient error on `simplicial_complex.py`, which passes succesfully standalone.

Re: #20692 : This ticket has been in the works for 5 months and still depends on two other tickets. I'd rather not wait for it to be merged in Sage before getting the damn `curl` in Sage : `R` depends on it, and updating it begins to be a matter of some (slight) urgency : more and more `R` packages can no longer be installed under 2.4.2...  That doesn't mean I won't revise the way to patch things when #20692 is merged.

Anyway, the point is moot for now : there are *no* patches...

==>`needs_review`


---

Comment by jdemeyer created at 2016-10-26 17:31:33

Replying to [comment:14 charpent]:
> I just mean that I'm not very fond of miles-log logs, where the relevant information doesn't stand out

At least the relevant information *exists* in the log.


---

Comment by charpent created at 2016-10-26 17:48:35

Replying to [comment:17 jdemeyer]:
> Replying to [comment:14 charpent]:
> > I just mean that I'm not very fond of miles-log logs, where the relevant information doesn't stand out
> 
> At least the relevant information *exists* in the log.

Indeed. I can see your point : it's mainly a `grep` vs `vgrep` (non-)issue ; probably coming from our respective initial curricula (a surgeon (even a dental one) needs to see (literally) a lot of things at once ; details can (usually) wait. Hence my preference for breadth-first searches).


---

Comment by jpflori created at 2016-10-26 17:59:24

The HTTPS/openssl issue is still an issue.


---

Comment by jdemeyer created at 2016-10-26 18:01:02

Changing status from needs_review to needs_work.


---

Comment by jpflori created at 2016-10-26 18:16:30

Without patching I fear the only solution is to make curl and R optional.
Groumpf.


---

Comment by charpent created at 2016-10-26 19:04:21

Replying to [comment:20 jdemeyer]:

As compiled, curl supports https. You can check this with `curl-config --protocols`.

The issue raised by Volker is valid, but has little to do with the present issue (nor with R's update...).

Furthermore, I think we shouldn't try to solve locally a systemwide problem.


---

Comment by charpent created at 2016-10-26 19:05:27

Replying to [comment:21 jpflori]:
> Without patching I fear the only solution is to make curl and R optional.
> Groumpf.

Care to explain ? I'm a dentist of very little mind, and have trouble following you.


---

Comment by jpflori created at 2016-10-26 19:40:42

IIRC we cannot automatically install openssl bc of license issues...
Hence no https support in curl and then R does not want to build.


---

Comment by jpflori created at 2016-10-26 19:43:15

I guess you get https support because you have openssl and its headers installed.


---

Comment by jpflori created at 2016-10-26 19:44:00

And openssl is not a dependency of sage ATM.


---

Comment by charpent created at 2016-10-26 19:48:21

Replying to [comment:26 jpflori]:
> And openssl is not a dependency of sage ATM.

Therefore, the obvious solution is to add OpenSSL as a prerequisite to Sage. (easy patch : two words in the main README.md...).

Would *that* be a problem ?

Should we open a discussion on sage-devel ?


---

Comment by jhpalmieri created at 2016-10-26 20:08:50

Or add curl (with SSL support) as a prerequisite to Sage. How widely installed are `curl` and `OpenSSL`? OS X seems to include `curl` and `libcurl`, and also `libssl` (but is that the same as OpenSSL? or is it at least good enough?). What about the various linux distributions?


---

Comment by jdemeyer created at 2016-10-26 21:02:51

Replying to [comment:28 jhpalmieri]:
> Or add curl (with SSL support) as a prerequisite to Sage. How widely installed are `curl` and `OpenSSL`? OS X seems to include `curl` and `libcurl`, and also `libssl` (but is that the same as OpenSSL? or is it at least good enough?). What about the various linux distributions?

I would guess that `curl` itself is widely available, but maybe not with "development headers" that many distros package separately.


---

Comment by jdemeyer created at 2016-10-26 21:07:47

As I tried to explain [comment:12], please remove this patch block (especially given that there are no patches):

```
# Patch sources.
for patch in ../patches/*.patch; do
    [ -r "$patch" ] || continue  # Skip non-existing or non-readable patches
    patch -p1 <"$patch"
    if [ $? -ne 0 ]; then
        echo >&2 "Error applying '$patch'"
        exit 1
    fi
done
```



---

Comment by jdemeyer created at 2016-10-26 21:10:22

Replying to [comment:16 charpent]:
> I'd rather not wait for it to be merged in Sage before getting the damn `curl` in Sage

I never said that you need to depend on that ticket. If you remove the "patching" block, it will work with or without #20692.


---

Comment by git created at 2016-10-27 06:31:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by charpent created at 2016-10-27 06:33:12

Replying to [comment:32 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[81e3341](https://git.sagemath.org/sage.git/commit/?id=81e3341358690d10e8ec0d14e1d7e53b8b8bf16c)||`Removed patches handling.`||

Builds OK, passes its test suite.


---

Comment by charpent created at 2016-10-27 06:33:12

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2016-10-27 06:56:21

Changing status from needs_review to needs_work.


---

Comment by charpent created at 2016-10-27 07:08:56

Replying to [comment:34 jdemeyer]:

Care to explain ?


---

Comment by jdemeyer created at 2016-10-27 07:10:32

[comment:19]


---

Comment by jpflori created at 2016-10-27 07:42:10

Some old discussions that might enlighten you:
* https://groups.google.com/forum/#!searchin/sage-devel/openssl|sort:relevance/sage-devel/mbGbpRz96q0/8nsKRNyLs3oJ (OpenSSL license issue)
* https://groups.google.com/forum/#!searchin/sage-devel/openssl|sort:relevance/sage-devel/Jl11JxIb2E8/-1NrQmjbMKIJ (why GnuTLS which is GPL is not a drop in replacement)


---

Comment by jpflori created at 2016-10-27 09:50:16

Discussion at:
* https://groups.google.com/forum/#!topic/sage-devel/QaBdHSNJuKg


---

Comment by charpent created at 2016-10-27 10:30:56

Replying to [comment:38 jpflori]:
> Discussion at:
> * https://groups.google.com/forum/#!topic/sage-devel/QaBdHSNJuKg

Thanks for the heads-up. It's important, and I'm afraid that the full size of the problem hasn't yet been considered : the R ecosystem is much larger (by about 3-4 magnitudes) than some seem to think...


---

Comment by jpflori created at 2016-11-02 14:45:48

`@`Volker: I've added a fat mode to avoid a lot of stuff curl might be tempted to use.
I did not touch the SSL/TLS options. Should I?
----
New commits:


---

Comment by jpflori created at 2016-11-02 14:45:48

Changing status from needs_work to needs_review.


---

Comment by charpent created at 2016-11-20 20:36:40

I think that the (pseudo-)legal considerations which motivated last month's [saga](https://groups.google.com/forum/#!topic/sage-devel/QaBdHSNJuKg) leave us few options.

I looked a bit closer to the idea of using an `rpy2`-based new interface to an external `R`. This is doable, but not in the short term.

I am under the impression that the current (pexpect) interface won't work reliably with a system R (especially on "exotic" systems such as cygwin and the Mac). Therefore, depending on a systemwide installation for R is out of the question in the short term. We need an interim solution.

My current plan is :
* Mark this ticket (#21767) as invalid/won't fix, forthe (pseudo-)legal reasons discussed in the saga.
* Document in the REAME.md and various places in the [Installation guide](http://doc.sagemath.org/html/en/installation/index.html) that *Sage* depends on `libcurl` and building it depends on `libcurl`'s development files.
* Make `xz` (existing package) and `pcre` (proposed new package) standard packages (see #21744 and #21770 respectively).
* patch the `R install-spkg` to test for the existence and correct capabilities of libcurl before starting to install ; display an explicitly Sage-centered message and fail if not found / not correct.
* make `R` depend on `xz` and `pcre`

Only *after* this interim solution works, envision the much larger task of creating a new interface.

Jean-Pierre : I think that omitting `https` requirement for R is a *very* bad idea : I do not know how longer R users will be able to depend on http-only repositories ; and, as I said before, R practical use is highly dependent of access to the 9000+ R packages in existence.

Advice required. Do you think useful to open an new discussion on [sage-devel](https://groups.google.com/forum/#!forum/sage-devel) ?

Note 1 : the patchbot test of #21744 is marked "pending". What does that mean ?

Note 2 : the patchbot test of #21770 fails repeatedly due to thye source tarball being unavailable on Sage standard repositories. What should I do ? The (ftp) address of the original tarball is in the ticket's header.


---

Comment by git created at 2017-02-18 22:02:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by charpent created at 2017-02-18 22:06:22

After #22189, curl remains a valid solution. I took the opportunity to upgrade curl to 7.52.1

Still `needs_review`
----
New commits:


---

Comment by charpent created at 2017-02-19 04:48:28

Sage-7.6.beta4 + #20523 + #21767 (this patch) + #21770 passes ptestlong witht two transient errors :

```
----------------------------------------------------------------------
sage -t --long src/sage/homology/simplicial_set_morphism.py  # Bad exit: 2
sage -t --long src/sage/homology/simplicial_complex.py  # 1 doctest failed
----------------------------------------------------------------------
```

Both tests pass when run standalone.

This should close the R saga (for now) by allowing the current interfaces to work with R >= 3.3.x.

Still `needs_review`


---

Comment by charpent created at 2017-02-20 19:50:45

Set assignee to charpent.


---

Comment by charpent created at 2017-02-20 19:50:45

Merged in #20523. Acceptingthe ticket in order to mark it as invalid.


---

Comment by charpent created at 2017-02-20 19:51:43

I still can't mark it as invalid. Can someone with the right rights do this for me ?


---

Comment by charpent created at 2017-02-20 20:33:35

Replying to [comment:47 charpent]:
> I still can't mark it as invalid. Can someone with the right rights do this for me ?

After discussion of (potential) #20523 reviewers, I now think that this ticket should be kept, reviewed and validated. Pleas DON'T invalidate it.


---

Comment by jpflori created at 2017-03-14 12:33:26

`@`jeroen: I think we can merge this one ut it also entails that SSL becomes a Sage dependency. Any thought?


---

Comment by charpent created at 2017-03-14 12:47:43

Replying to [comment:49 jpflori]:
> `@`jeroen: I think we can merge this one ut it also entails that SSL becomes a Sage dependency. Any thought?

As per #22189 (already merged), SSL **IS** a Sage dependency. The point is therefore moot...


---

Comment by jdemeyer created at 2017-03-14 22:57:16

Replying to [comment:49 jpflori]:
> `@`jeroen: I think we can merge this one ut it also entails that SSL becomes a Sage dependency. Any thought?

I have mentioned before that I really would not like that...

So far, we have always been fixing packages requiring OpenSSL such that they would work without OpenSSL (with reduced functionality). I think that can and should be done for R also.


---

Comment by charpent created at 2017-03-15 06:53:57

Replying to [comment:51 jdemeyer]:
> Replying to [comment:49 jpflori]:
> > `@`jeroen: I think we can merge this one ut it also entails that SSL becomes a Sage dependency. Any thought?
> 
> I have mentioned before that I really would not like that...

But somehow failed to explain the reasons of your dislike.

> So far, we have always been fixing packages requiring OpenSSL such that they would work without OpenSSL (with reduced functionality).

And that's why Sage's pip, compiled on a VM without OpenSSL, is unusable. "Reduced functionality", indeed...

> I think that can and should be done for R also.

That should be done **upstream** :
* in R (the R Core Team introduced the SSL requirement with R 3.3 after having maintained an internal library for years...) ;
* in Python (which explicitly depends on OpenSSL).

But I really think that this is weather-fighting (and a rearguard fight, BTW). You still have to convince us that OpenSSL drawbacks (what are they ?) are worth committing a large part of our limited resources to work around it.


---

Comment by jdemeyer created at 2017-03-15 08:53:14

Replying to [comment:52 charpent]:
> But somehow failed to explain the reasons of your dislike.

It's simple: an extra dependency makes it harder to build Sage. So far, we tried hard in Sage to have a minimal set of dependencies: all dependencies to build Sage are either obviously needed (compilers, make, ...) or are installed by default on most typical operating systems (Python).


---

Comment by jdemeyer created at 2017-03-15 08:54:17

Replying to [comment:52 charpent]:
> * in Python (which explicitly depends on OpenSSL).

Python does not require OpenSSL, so I don't get your point.


---

Comment by jpflori created at 2017-03-15 09:11:20

Anyway, sorry for reviving this here as curl can build without ssl.
The issue is with R checking that curl supports ssl and I've posted a patch on the R ticket to remove that check.

`@`emmanuel: can you update curl to the latest upstream version?
Then I'll push the positive review button.


---

Comment by dimpase created at 2017-03-15 12:42:06

I'm currently checking that 7.53.1 works on OSX. I'll push the update as soon as I'm done.


---

Comment by git created at 2017-03-15 12:44:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-03-15 12:45:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2017-03-15 12:46:16

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2017-03-15 12:48:04

Changing status from positive_review to needs_review.


---

Comment by dimpase created at 2017-03-15 12:48:20

Changing status from needs_review to positive_review.


---

Comment by charpent created at 2017-03-15 14:42:52

Replying to [comment:61 dimpase]:

Спассибо, Димитри. Sorry for the delay : I wasn't available this morning.


---

Comment by dimpase created at 2017-03-16 10:07:26

I am on it.


---

Comment by dimpase created at 2017-03-16 10:07:26

Changing status from positive_review to needs_work.


---

Comment by git created at 2017-03-16 10:48:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2017-03-16 10:49:11

Changing status from needs_work to needs_review.


---

Comment by jpflori created at 2017-03-16 10:54:39

You don't export CC so are you sure it will be taken into account?


---

Comment by dimpase created at 2017-03-16 11:16:47

Replying to [comment:66 jpflori]:
> You don't export CC so are you sure it will be taken into account?

it is taken into account, sure. (I checked the log, etc). By the way, the same works in `r/spkg-install` - from where I stole this.


---

Comment by jpflori created at 2017-03-16 11:18:55

Changing status from needs_review to positive_review.


---

Comment by jpflori created at 2017-03-16 11:18:55

Then...


---

Comment by jpflori created at 2017-03-16 16:39:35

Changing keywords from "r-project" to "r-project, days85".


---

Comment by vbraun created at 2017-03-26 20:03:52

Followup at #22686


---

Comment by vbraun created at 2017-03-27 20:43:10

Resolution: fixed
