# Issue 10937: improve solve_mod performance

archive/issues_010937.json:
```json
{
    "body": "Assignee: @burcin\n\nCC:  @kcrisman\n\nCurrently `solve_mod(x^2==41, 100)` breaks this down into solving modulus `2^2 and 5^2`, but it doesn't do further reductions, so it actually loops over 4 and 25 possibilities directly.  This works well for small exponents:\n\n\n```\nsage: time solve_mod(x^2 == 41, 10^2) \nCPU times: user 0.01 s, sys: 0.00 s, total: 0.01 s Wall time: 0.01 s \n[(29,), (21,), (79,), (71,)] \n```\n\n\nbut performs poorly on larger ones, even if the primes involved are small:\n\n\n```\nsage: time solve_mod(x^2 == 41, 10^6)\nCPU times: user 0.86 s, sys: 0.01 s, total: 0.87 s Wall time: 0.99 s \n[(703821,), (452429,), (47571,), (796179,), (203821,), (952429,), (547571,), (296179,)]\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/11036\n\n",
    "created_at": "2011-03-26T02:27:49Z",
    "labels": [
        "component: symbolics",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.7.2",
    "title": "improve solve_mod performance",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10937",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```
Assignee: @burcin

CC:  @kcrisman

Currently `solve_mod(x^2==41, 100)` breaks this down into solving modulus `2^2 and 5^2`, but it doesn't do further reductions, so it actually loops over 4 and 25 possibilities directly.  This works well for small exponents:


```
sage: time solve_mod(x^2 == 41, 10^2) 
CPU times: user 0.01 s, sys: 0.00 s, total: 0.01 s Wall time: 0.01 s 
[(29,), (21,), (79,), (71,)] 
```


but performs poorly on larger ones, even if the primes involved are small:


```
sage: time solve_mod(x^2 == 41, 10^6)
CPU times: user 0.86 s, sys: 0.01 s, total: 0.87 s Wall time: 0.99 s 
[(703821,), (452429,), (47571,), (796179,), (203821,), (952429,), (547571,), (296179,)]
```


Issue created by migration from https://trac.sagemath.org/ticket/11036





---

archive/issue_comments_117513.json:
```json
{
    "body": "Agreed that this is a place we need better work.  It's been fairly low priority, as you can see.  Ideas?  Hensel's Lemma?",
    "created_at": "2011-03-26T03:03:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10937",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10937#issuecomment-117513",
    "user": "https://github.com/kcrisman"
}
```

Agreed that this is a place we need better work.  It's been fairly low priority, as you can see.  Ideas?  Hensel's Lemma?



---

archive/issue_comments_117514.json:
```json
{
    "body": "This patch doesn't attempt to do anything sophisticated, it simply reaches for the low-hanging fruit:\n\n(1) It modifies solve_mod_enumerate so that if the modulus is `5^100`, instead of iterating over `5^100` possibilities, it finds solutions mod 5, then uses those to find solutions mod `5^2`, etc. \n\n(2) It modifies solve_mod to short-circuit in some cases.\n\n(3) It also makes an unrelated change: currently solve_mod(x==1, 1) returns [()], but should probably return [(0,)].\n\nThe change has little effect for small moduli but wins easily on anything nontrivial:\n\n\n```\n#OLD \nsage: time solve_mod(x^2==41, 10^7)\nCPU times: user 4.21 s, sys: 0.05 s, total: 4.27 s\nWall time: 4.33 s\n[(3703821,), (1452429,), (3547571,), (1296179,), (8703821,), (6452429,), (8547571,), (6296179,)]\n```\n\n\n```\n# NEW \nsage: time solve_mod(x^2==41, 10^7)\nCPU times: user 0.04 s, sys: 0.00 s, total: 0.04 s\nWall time: 0.04 s\n[(3703821,), (1452429,), (3547571,), (1296179,), (8703821,), (6452429,), (8547571,), (6296179,)]\n```\n\n\nIt still behaves very badly for large primes, but a lot better than the current approach on powers of small primes.  This\nincludes my use case of powers of 10-- there was an OEIS sequence I was extending which I had to do manually because solve_mod was too slow, and it irritated me that Mma could do it quickly..\n\nBeyond the doctests I've tested it for small-coefficient univariate polynomials of order <= 5 with modulus <= 12, and for lots of random multivariate polynomials.  Tests were against a four-line brute force solver.  Probably I've missed something, though, so more tests would be appreciated!",
    "created_at": "2011-03-26T03:19:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10937",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10937#issuecomment-117514",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

This patch doesn't attempt to do anything sophisticated, it simply reaches for the low-hanging fruit:

(1) It modifies solve_mod_enumerate so that if the modulus is `5^100`, instead of iterating over `5^100` possibilities, it finds solutions mod 5, then uses those to find solutions mod `5^2`, etc. 

(2) It modifies solve_mod to short-circuit in some cases.

(3) It also makes an unrelated change: currently solve_mod(x==1, 1) returns [()], but should probably return [(0,)].

The change has little effect for small moduli but wins easily on anything nontrivial:


```
#OLD 
sage: time solve_mod(x^2==41, 10^7)
CPU times: user 4.21 s, sys: 0.05 s, total: 4.27 s
Wall time: 4.33 s
[(3703821,), (1452429,), (3547571,), (1296179,), (8703821,), (6452429,), (8547571,), (6296179,)]
```


```
# NEW 
sage: time solve_mod(x^2==41, 10^7)
CPU times: user 0.04 s, sys: 0.00 s, total: 0.04 s
Wall time: 0.04 s
[(3703821,), (1452429,), (3547571,), (1296179,), (8703821,), (6452429,), (8547571,), (6296179,)]
```


It still behaves very badly for large primes, but a lot better than the current approach on powers of small primes.  This
includes my use case of powers of 10-- there was an OEIS sequence I was extending which I had to do manually because solve_mod was too slow, and it irritated me that Mma could do it quickly..

Beyond the doctests I've tested it for small-coefficient univariate polynomials of order <= 5 with modulus <= 12, and for lots of random multivariate polynomials.  Tests were against a four-line brute force solver.  Probably I've missed something, though, so more tests would be appreciated!



---

archive/issue_comments_117515.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-03-26T03:21:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10937",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10937#issuecomment-117515",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_117516.json:
```json
{
    "body": "Attachment [trac_11036_improve_solve_mod_perf.patch](tarball://root/attachments/some-uuid/ticket11036/trac_11036_improve_solve_mod_perf.patch) by dsm created at 2011-03-26 03:33:20",
    "created_at": "2011-03-26T03:33:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10937",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10937#issuecomment-117516",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

Attachment [trac_11036_improve_solve_mod_perf.patch](tarball://root/attachments/some-uuid/ticket11036/trac_11036_improve_solve_mod_perf.patch) by dsm created at 2011-03-26 03:33:20



---

archive/issue_comments_117517.json:
```json
{
    "body": "[attachment:trac_11036_improve_solve_mod_perf.patch] does not apply to sage-4.7.1.alpha2 on sknet/taurus (x86_64-Linux-nehalem-fc):\n\n\n```\ntaurus% ./sage\n----------------------------------------------------------------------\n----------------------------------------------------------------------\n**********************************************************************\n*                                                                    *\n* Warning: this is a prerelease version, and it may be unstable.     *\n*                                                                    *\n**********************************************************************\nsage: hg_sage.apply(\"/home/mariah/trac_11036_improve_solve_mod_perf.patch\")\ncd \"/home/mariah/sage/sage-4.7.1.alpha2-x86_64-Linux-nehalem-fc-review-11036/devel/sage\" && hg status\ncd \"/home/mariah/sage/sage-4.7.1.alpha2-x86_64-Linux-nehalem-fc-review-11036/devel/sage\" && hg status\ncd \"/home/mariah/sage/sage-4.7.1.alpha2-x86_64-Linux-nehalem-fc-review-11036/devel/sage\" && hg import   \"/home/mariah/trac_11036_improve_solve_mod_perf.patch\"\napplying /home/mariah/trac_11036_improve_solve_mod_perf.patch\npatching file sage/symbolic/relation.py\nHunk #3 FAILED at 735\nHunk #4 succeeded at 810 with fuzz 2 (offset 44 lines).\nHunk #5 FAILED at 821\nHunk #6 FAILED at 830\n3 out of 6 hunks FAILED -- saving rejects to file sage/symbolic/relation.py.rej\nabort: patch failed to apply\nsage:\n```\n\n| Sage Version 4.7.1.alpha2, Release Date: 2011-06-07                |\n| Type notebook() for the GUI, and license() for information.        |\nPerhaps it needs to be rebased?",
    "created_at": "2011-06-15T17:36:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10937",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10937#issuecomment-117517",
    "user": "https://trac.sagemath.org/admin/accounts/users/mariah"
}
```

[attachment:trac_11036_improve_solve_mod_perf.patch] does not apply to sage-4.7.1.alpha2 on sknet/taurus (x86_64-Linux-nehalem-fc):


```
taurus% ./sage
----------------------------------------------------------------------
----------------------------------------------------------------------
**********************************************************************
*                                                                    *
* Warning: this is a prerelease version, and it may be unstable.     *
*                                                                    *
**********************************************************************
sage: hg_sage.apply("/home/mariah/trac_11036_improve_solve_mod_perf.patch")
cd "/home/mariah/sage/sage-4.7.1.alpha2-x86_64-Linux-nehalem-fc-review-11036/devel/sage" && hg status
cd "/home/mariah/sage/sage-4.7.1.alpha2-x86_64-Linux-nehalem-fc-review-11036/devel/sage" && hg status
cd "/home/mariah/sage/sage-4.7.1.alpha2-x86_64-Linux-nehalem-fc-review-11036/devel/sage" && hg import   "/home/mariah/trac_11036_improve_solve_mod_perf.patch"
applying /home/mariah/trac_11036_improve_solve_mod_perf.patch
patching file sage/symbolic/relation.py
Hunk #3 FAILED at 735
Hunk #4 succeeded at 810 with fuzz 2 (offset 44 lines).
Hunk #5 FAILED at 821
Hunk #6 FAILED at 830
3 out of 6 hunks FAILED -- saving rejects to file sage/symbolic/relation.py.rej
abort: patch failed to apply
sage:
```

| Sage Version 4.7.1.alpha2, Release Date: 2011-06-07                |
| Type notebook() for the GUI, and license() for information.        |
Perhaps it needs to be rebased?



---

archive/issue_comments_117518.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-06-15T17:36:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10937",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10937#issuecomment-117518",
    "user": "https://trac.sagemath.org/admin/accounts/users/mariah"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_117519.json:
```json
{
    "body": "I did a rebase but also have managed to mess up my 4.7.1.rc[01] builds while testing other tickets, so no guarantees...\n\nThe code seems to assume that the expressions is a polynomial (in one or more variables), so there should definitely be a more efficient way to do the enumeration of solutions modulo prime powers -- this should be a linear (algebra mod p) problem once the solutions mod p are known, right?",
    "created_at": "2011-08-02T16:08:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10937",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10937#issuecomment-117519",
    "user": "https://github.com/JohnCremona"
}
```

I did a rebase but also have managed to mess up my 4.7.1.rc[01] builds while testing other tickets, so no guarantees...

The code seems to assume that the expressions is a polynomial (in one or more variables), so there should definitely be a more efficient way to do the enumeration of solutions modulo prime powers -- this should be a linear (algebra mod p) problem once the solutions mod p are known, right?



---

archive/issue_comments_117520.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-08-02T16:08:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10937",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10937#issuecomment-117520",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_117521.json:
```json
{
    "body": "Changing keywords from \"\" to \"modular arithmetic\".",
    "created_at": "2011-08-02T16:08:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10937",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10937#issuecomment-117521",
    "user": "https://github.com/JohnCremona"
}
```

Changing keywords from "" to "modular arithmetic".



---

archive/issue_comments_117522.json:
```json
{
    "body": "Attachment [trac_11036-solve-mod.patch](tarball://root/attachments/some-uuid/ticket11036/trac_11036-solve-mod.patch) by @koffie created at 2011-08-23 00:00:56\n\nremoved a lot of bugs and refactored the patch",
    "created_at": "2011-08-23T00:00:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10937",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10937#issuecomment-117522",
    "user": "https://github.com/koffie"
}
```

Attachment [trac_11036-solve-mod.patch](tarball://root/attachments/some-uuid/ticket11036/trac_11036-solve-mod.patch) by @koffie created at 2011-08-23 00:00:56

removed a lot of bugs and refactored the patch



---

archive/issue_comments_117523.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-08-23T00:42:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10937",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10937#issuecomment-117523",
    "user": "https://github.com/haikona"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_117524.json:
```json
{
    "body": "Looks fine; can't find any bugs, tests work, speedups as advertised. Revised patch works with 4.7.2alpha2.",
    "created_at": "2011-08-23T00:42:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10937",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10937#issuecomment-117524",
    "user": "https://github.com/haikona"
}
```

Looks fine; can't find any bugs, tests work, speedups as advertised. Revised patch works with 4.7.2alpha2.



---

archive/issue_comments_117525.json:
```json
{
    "body": "If there were things I missed -- either preexisting bugs I didn't notice or bugs I introduced -- then we should probably add doctests to make sure they stay fixed.",
    "created_at": "2011-08-23T01:01:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10937",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10937#issuecomment-117525",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

If there were things I missed -- either preexisting bugs I didn't notice or bugs I introduced -- then we should probably add doctests to make sure they stay fixed.



---

archive/issue_comments_117526.json:
```json
{
    "body": "the bugs I fixed where all in the existing doctests, I don't know how you got the timings because the code wasn't working at all",
    "created_at": "2011-08-23T04:16:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10937",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10937#issuecomment-117526",
    "user": "https://github.com/koffie"
}
```

the bugs I fixed where all in the existing doctests, I don't know how you got the timings because the code wasn't working at all



---

archive/issue_comments_117527.json:
```json
{
    "body": "Changing keywords from \"modular arithmetic\" to \"modular arithmetic, sd32\".",
    "created_at": "2011-08-24T23:47:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10937",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10937#issuecomment-117527",
    "user": "https://github.com/williamstein"
}
```

Changing keywords from "modular arithmetic" to "modular arithmetic, sd32".



---

archive/issue_comments_117528.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-09-17T04:41:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10937",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10937#issuecomment-117528",
    "user": "https://github.com/nexttime"
}
```

Resolution: fixed



---

archive/issue_events_011052.json:
```json
{
    "actor": "@nexttime",
    "created_at": "2011-09-17T04:41:15Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/10937",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10937#event-11052"
}
```
