# Issue 27871: Py3: ValueError in graph_generators doctests with plantri optional package

archive/issues_027871.json:
```json
{
    "body": "CC:  dcoudert\n\nsage -i plantri\nsage -t --long src/sage/graphs/graph_generators.py\n\n\n```\n**********************************************************************\nFile \"src/sage/graphs/graph_generators.py\", line 1641, in sage.graphs.graph_generators.GraphGenerators.?\nFailed example:\n    for i in range(12, 23):                                             # optional plantri\n        L = len(list(graphs.triangulations(i, minimum_connectivity=5))) # optional plantri\n        print(\"{}   {:3d}\".format(i,L))                                 # optional plantri\nException raised:\n    Traceback (most recent call last):\n      File \"/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 681, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1105, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.graphs.graph_generators.GraphGenerators.?[7]>\", line 2, in <module>\n        L = len(list(graphs.triangulations(i, minimum_connectivity=Integer(5)))) # optional plantri\n      File \"/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/sage/graphs/graph_generators.py\", line 1746, in triangulations\n        for G in graphs._read_planar_code(sp.stdout):\n      File \"/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/sage/graphs/graph_generators.py\", line 1150, in _read_planar_code\n        G.set_embedding(embed_g)\n      File \"/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/sage/graphs/generic_graph.py\", line 2444, in set_embedding\n        self._check_embedding_validity(embedding, boolean=False)\n      File \"/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/sage/graphs/generic_graph.py\", line 2551, in _check_embedding_validity\n        raise ValueError(\"{} and {} are not neighbors but {} is in the list associated with {}\".format(u, v, u, v))\n    ValueError: 10 and 6 are not neighbors but 10 is in the list associated with 6\n**********************************************************************\nFile \"src/sage/graphs/graph_generators.py\", line 1673, in sage.graphs.graph_generators.GraphGenerators.?\nFailed example:\n    [len(g) for g in graphs.triangulations(9, minimum_degree=4, minimum_connectivity=3, dual=True)]  # optional plantri\nException raised:\n    Traceback (most recent call last):\n      File \"/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 681, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1105, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.graphs.graph_generators.GraphGenerators.?[11]>\", line 1, in <module>\n        [len(g) for g in graphs.triangulations(Integer(9), minimum_degree=Integer(4), minimum_connectivity=Integer(3), dual=True)]  # optional plantri\n      File \"<doctest sage.graphs.graph_generators.GraphGenerators.?[11]>\", line 1, in <listcomp>\n        [len(g) for g in graphs.triangulations(Integer(9), minimum_degree=Integer(4), minimum_connectivity=Integer(3), dual=True)]  # optional plantri\n      File \"/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/sage/graphs/graph_generators.py\", line 1746, in triangulations\n        for G in graphs._read_planar_code(sp.stdout):\n      File \"/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/sage/graphs/graph_generators.py\", line 1150, in _read_planar_code\n        G.set_embedding(embed_g)\n      File \"/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/sage/graphs/generic_graph.py\", line 2444, in set_embedding\n        self._check_embedding_validity(embedding, boolean=False)\n      File \"/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/sage/graphs/generic_graph.py\", line 2551, in _check_embedding_validity\n        raise ValueError(\"{} and {} are not neighbors but {} is in the list associated with {}\".format(u, v, u, v))\n    ValueError: 10 and 9 are not neighbors but 10 is in the list associated with 9\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/28108\n\n",
    "created_at": "2019-07-03T14:35:24Z",
    "labels": [
        "python3",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.9",
    "title": "Py3: ValueError in graph_generators doctests with plantri optional package",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27871",
    "user": "vklein"
}
```
CC:  dcoudert

sage -i plantri
sage -t --long src/sage/graphs/graph_generators.py


```
**********************************************************************
File "src/sage/graphs/graph_generators.py", line 1641, in sage.graphs.graph_generators.GraphGenerators.?
Failed example:
    for i in range(12, 23):                                             # optional plantri
        L = len(list(graphs.triangulations(i, minimum_connectivity=5))) # optional plantri
        print("{}   {:3d}".format(i,L))                                 # optional plantri
Exception raised:
    Traceback (most recent call last):
      File "/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1105, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.graph_generators.GraphGenerators.?[7]>", line 2, in <module>
        L = len(list(graphs.triangulations(i, minimum_connectivity=Integer(5)))) # optional plantri
      File "/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/sage/graphs/graph_generators.py", line 1746, in triangulations
        for G in graphs._read_planar_code(sp.stdout):
      File "/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/sage/graphs/graph_generators.py", line 1150, in _read_planar_code
        G.set_embedding(embed_g)
      File "/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/sage/graphs/generic_graph.py", line 2444, in set_embedding
        self._check_embedding_validity(embedding, boolean=False)
      File "/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/sage/graphs/generic_graph.py", line 2551, in _check_embedding_validity
        raise ValueError("{} and {} are not neighbors but {} is in the list associated with {}".format(u, v, u, v))
    ValueError: 10 and 6 are not neighbors but 10 is in the list associated with 6
**********************************************************************
File "src/sage/graphs/graph_generators.py", line 1673, in sage.graphs.graph_generators.GraphGenerators.?
Failed example:
    [len(g) for g in graphs.triangulations(9, minimum_degree=4, minimum_connectivity=3, dual=True)]  # optional plantri
Exception raised:
    Traceback (most recent call last):
      File "/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1105, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.graph_generators.GraphGenerators.?[11]>", line 1, in <module>
        [len(g) for g in graphs.triangulations(Integer(9), minimum_degree=Integer(4), minimum_connectivity=Integer(3), dual=True)]  # optional plantri
      File "<doctest sage.graphs.graph_generators.GraphGenerators.?[11]>", line 1, in <listcomp>
        [len(g) for g in graphs.triangulations(Integer(9), minimum_degree=Integer(4), minimum_connectivity=Integer(3), dual=True)]  # optional plantri
      File "/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/sage/graphs/graph_generators.py", line 1746, in triangulations
        for G in graphs._read_planar_code(sp.stdout):
      File "/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/sage/graphs/graph_generators.py", line 1150, in _read_planar_code
        G.set_embedding(embed_g)
      File "/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/sage/graphs/generic_graph.py", line 2444, in set_embedding
        self._check_embedding_validity(embedding, boolean=False)
      File "/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/sage/graphs/generic_graph.py", line 2551, in _check_embedding_validity
        raise ValueError("{} and {} are not neighbors but {} is in the list associated with {}".format(u, v, u, v))
    ValueError: 10 and 9 are not neighbors but 10 is in the list associated with 9
```


Issue created by migration from https://trac.sagemath.org/ticket/28108





---

archive/issue_comments_393647.json:
```json
{
    "body": "I did the following test, corresponding to the first failing doctest.\n\n```\nsage: def test(version=2):\n....:     import subprocess\n....:     command = \"plantri -m5c5 16\"\n....:     enc_kwargs = {} if version == 2 else {'encoding': 'latin-1'}\n....:     sp = subprocess.Popen(command, shell=True, stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE, close_fds=True,**enc_kwargs)\n....:     code_input = sp.stdout\n....:     print(code_input.read(15))\n....:     s = '[ '\n....:     s2 = '[ '\n....:     order = ord(code_input.read(1))\n....:     i = 0\n....:     while i < order:\n....:         c = code_input.read(1)\n....:         if not ord(c):\n....:             i += 1\n....:             s += ']  [ '\n....:             s2 += ']  [ '\n....:         else:\n....:             s += str(ord(c)) + ' '\n....:             s2 += c + ' '\n....:     print(s[:-3])\n....:     return s2[:-3]\n```\n\n\nwith Python 2, I get:\n\n```\nsage: test(2)\n>>planar_code<<\n[ 2 3 4 5 6 ]  [ 1 6 7 8 3 ]  [ 1 2 8 9 10 4 ]  [ 1 3 10 11 5 ]  [ 1 4 11 12 6 ]  [ 1 5 12 13 7 2 ]  [ 2 6 13 14 8 ]  [ 2 7 14 9 3 ]  [ 3 8 14 15 10 ]  [ 3 9 15 11 4 ]  [ 4 10 15 16 12 5 ]  [ 5 11 16 13 6 ]  [ 6 12 16 14 7 ]  [ 7 13 16 15 9 8 ]  [ 9 14 16 11 10 ]  [ 11 15 14 13 12 ] \n'[ \\x02 \\x03 \\x04 \\x05 \\x06 ]  [ \\x01 \\x06 \\x07 \\x08 \\x03 ]  [ \\x01 \\x02 \\x08 \\t \\n \\x04 ]  [ \\x01 \\x03 \\n \\x0b \\x05 ]  [ \\x01 \\x04 \\x0b \\x0c \\x06 ]  [ \\x01 \\x05 \\x0c \\r \\x07 \\x02 ]  [ \\x02 \\x06 \\r \\x0e \\x08 ]  [ \\x02 \\x07 \\x0e \\t \\x03 ]  [ \\x03 \\x08 \\x0e \\x0f \\n ]  [ \\x03 \\t \\x0f \\x0b \\x04 ]  [ \\x04 \\n \\x0f \\x10 \\x0c \\x05 ]  [ \\x05 \\x0b \\x10 \\r \\x06 ]  [ \\x06 \\x0c \\x10 \\x0e \\x07 ]  [ \\x07 \\r \\x10 \\x0f \\t \\x08 ]  [ \\t \\x0e \\x10 \\x0b \\n ]  [ \\x0b \\x0f \\x0e \\r \\x0c ] '\n```\n\n\nand with Python 3:\n\n```\nsage: test(3)\n>>planar_code<<\n[ 2 3 4 5 6 ]  [ 1 6 7 8 3 ]  [ 1 2 8 9 10 4 ]  [ 1 3 10 11 5 ]  [ 1 4 11 12 6 ]  [ 1 5 12 10 7 2 ]  [ 2 6 10 14 8 ]  [ 2 7 14 9 3 ]  [ 3 8 14 15 10 ]  [ 3 9 15 11 4 ]  [ 4 10 15 16 12 5 ]  [ 5 11 16 10 6 ]  [ 6 12 16 14 7 ]  [ 7 10 16 15 9 8 ]  [ 9 14 16 11 10 ]  [ 11 15 14 10 12 ] \n'[ \\x02 \\x03 \\x04 \\x05 \\x06 ]  [ \\x01 \\x06 \\x07 \\x08 \\x03 ]  [ \\x01 \\x02 \\x08 \\t \\n \\x04 ]  [ \\x01 \\x03 \\n \\x0b \\x05 ]  [ \\x01 \\x04 \\x0b \\x0c \\x06 ]  [ \\x01 \\x05 \\x0c \\n \\x07 \\x02 ]  [ \\x02 \\x06 \\n \\x0e \\x08 ]  [ \\x02 \\x07 \\x0e \\t \\x03 ]  [ \\x03 \\x08 \\x0e \\x0f \\n ]  [ \\x03 \\t \\x0f \\x0b \\x04 ]  [ \\x04 \\n \\x0f \\x10 \\x0c \\x05 ]  [ \\x05 \\x0b \\x10 \\n \\x06 ]  [ \\x06 \\x0c \\x10 \\x0e \\x07 ]  [ \\x07 \\n \\x10 \\x0f \\t \\x08 ]  [ \\t \\x0e \\x10 \\x0b \\n ]  [ \\x0b \\x0f \\x0e \\n \\x0c ] '\n```\n\n\nIf you check carefully, you can see that each occurence of `\\r` that you can find in the output with Python 2 is replaced by `\\n` in Python 3.  However, occurrences of `\\n` that we see in py2 are the same in py3.\n\nHave you already seen that ? Do you know what we can do ?",
    "created_at": "2019-08-14T14:03:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27871",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27871#issuecomment-393647",
    "user": "dcoudert"
}
```

I did the following test, corresponding to the first failing doctest.

```
sage: def test(version=2):
....:     import subprocess
....:     command = "plantri -m5c5 16"
....:     enc_kwargs = {} if version == 2 else {'encoding': 'latin-1'}
....:     sp = subprocess.Popen(command, shell=True, stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE, close_fds=True,**enc_kwargs)
....:     code_input = sp.stdout
....:     print(code_input.read(15))
....:     s = '[ '
....:     s2 = '[ '
....:     order = ord(code_input.read(1))
....:     i = 0
....:     while i < order:
....:         c = code_input.read(1)
....:         if not ord(c):
....:             i += 1
....:             s += ']  [ '
....:             s2 += ']  [ '
....:         else:
....:             s += str(ord(c)) + ' '
....:             s2 += c + ' '
....:     print(s[:-3])
....:     return s2[:-3]
```


with Python 2, I get:

```
sage: test(2)
>>planar_code<<
[ 2 3 4 5 6 ]  [ 1 6 7 8 3 ]  [ 1 2 8 9 10 4 ]  [ 1 3 10 11 5 ]  [ 1 4 11 12 6 ]  [ 1 5 12 13 7 2 ]  [ 2 6 13 14 8 ]  [ 2 7 14 9 3 ]  [ 3 8 14 15 10 ]  [ 3 9 15 11 4 ]  [ 4 10 15 16 12 5 ]  [ 5 11 16 13 6 ]  [ 6 12 16 14 7 ]  [ 7 13 16 15 9 8 ]  [ 9 14 16 11 10 ]  [ 11 15 14 13 12 ] 
'[ \x02 \x03 \x04 \x05 \x06 ]  [ \x01 \x06 \x07 \x08 \x03 ]  [ \x01 \x02 \x08 \t \n \x04 ]  [ \x01 \x03 \n \x0b \x05 ]  [ \x01 \x04 \x0b \x0c \x06 ]  [ \x01 \x05 \x0c \r \x07 \x02 ]  [ \x02 \x06 \r \x0e \x08 ]  [ \x02 \x07 \x0e \t \x03 ]  [ \x03 \x08 \x0e \x0f \n ]  [ \x03 \t \x0f \x0b \x04 ]  [ \x04 \n \x0f \x10 \x0c \x05 ]  [ \x05 \x0b \x10 \r \x06 ]  [ \x06 \x0c \x10 \x0e \x07 ]  [ \x07 \r \x10 \x0f \t \x08 ]  [ \t \x0e \x10 \x0b \n ]  [ \x0b \x0f \x0e \r \x0c ] '
```


and with Python 3:

```
sage: test(3)
>>planar_code<<
[ 2 3 4 5 6 ]  [ 1 6 7 8 3 ]  [ 1 2 8 9 10 4 ]  [ 1 3 10 11 5 ]  [ 1 4 11 12 6 ]  [ 1 5 12 10 7 2 ]  [ 2 6 10 14 8 ]  [ 2 7 14 9 3 ]  [ 3 8 14 15 10 ]  [ 3 9 15 11 4 ]  [ 4 10 15 16 12 5 ]  [ 5 11 16 10 6 ]  [ 6 12 16 14 7 ]  [ 7 10 16 15 9 8 ]  [ 9 14 16 11 10 ]  [ 11 15 14 10 12 ] 
'[ \x02 \x03 \x04 \x05 \x06 ]  [ \x01 \x06 \x07 \x08 \x03 ]  [ \x01 \x02 \x08 \t \n \x04 ]  [ \x01 \x03 \n \x0b \x05 ]  [ \x01 \x04 \x0b \x0c \x06 ]  [ \x01 \x05 \x0c \n \x07 \x02 ]  [ \x02 \x06 \n \x0e \x08 ]  [ \x02 \x07 \x0e \t \x03 ]  [ \x03 \x08 \x0e \x0f \n ]  [ \x03 \t \x0f \x0b \x04 ]  [ \x04 \n \x0f \x10 \x0c \x05 ]  [ \x05 \x0b \x10 \n \x06 ]  [ \x06 \x0c \x10 \x0e \x07 ]  [ \x07 \n \x10 \x0f \t \x08 ]  [ \t \x0e \x10 \x0b \n ]  [ \x0b \x0f \x0e \n \x0c ] '
```


If you check carefully, you can see that each occurence of `\r` that you can find in the output with Python 2 is replaced by `\n` in Python 3.  However, occurrences of `\n` that we see in py2 are the same in py3.

Have you already seen that ? Do you know what we can do ?



---

archive/issue_comments_393648.json:
```json
{
    "body": "Got it !\n\nI tried adding this fix inside method `_read_planar_code` but it breaks the doctest of that method as `StringIO` has no method `reconfigure`.\n\nI also added the fix to the methods using `buckygen` and `benzene`.",
    "created_at": "2019-08-15T09:21:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27871",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27871#issuecomment-393648",
    "user": "dcoudert"
}
```

Got it !

I tried adding this fix inside method `_read_planar_code` but it breaks the doctest of that method as `StringIO` has no method `reconfigure`.

I also added the fix to the methods using `buckygen` and `benzene`.



---

archive/issue_comments_393649.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-08-15T09:21:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27871",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27871#issuecomment-393649",
    "user": "dcoudert"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_393650.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-08-15T09:31:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27871",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27871#issuecomment-393650",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_393651.json:
```json
{
    "body": "While testing the fix with `benzene`, I realized it needs the same fix than what was done in #27948 for `plantri`. I also did it for `buckygen`. This way, all tests pass for method `fusenes` (using `benzene`).\n\nHowever, I'm unable to install `buckygen` and so to test method `fullerenes`.",
    "created_at": "2019-08-15T09:36:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27871",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27871#issuecomment-393651",
    "user": "dcoudert"
}
```

While testing the fix with `benzene`, I realized it needs the same fix than what was done in #27948 for `plantri`. I also did it for `buckygen`. This way, all tests pass for method `fusenes` (using `benzene`).

However, I'm unable to install `buckygen` and so to test method `fullerenes`.



---

archive/issue_comments_393652.json:
```json
{
    "body": "`e9af570` fix the 15 doctests errors. Looks good to me.",
    "created_at": "2019-08-19T14:26:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27871",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27871#issuecomment-393652",
    "user": "vklein"
}
```

`e9af570` fix the 15 doctests errors. Looks good to me.



---

archive/issue_comments_393653.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-08-19T14:26:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27871",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27871#issuecomment-393653",
    "user": "vklein"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_393654.json:
```json
{
    "body": "Thanks.",
    "created_at": "2019-08-19T15:19:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27871",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27871#issuecomment-393654",
    "user": "dcoudert"
}
```

Thanks.



---

archive/issue_comments_393655.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-08-20T22:28:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27871",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27871#issuecomment-393655",
    "user": "vbraun"
}
```

Resolution: fixed
