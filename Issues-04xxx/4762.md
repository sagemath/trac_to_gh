# Issue 4762: [with patch, with positive review] Odd error message for congruence subgroups

archive/issues_004762.json:
```json
{
    "body": "I was looking at generators of various different congruence subgroups, and got the following error:\n\n```\nsage: Gamma0(5).generators()[0]\n\n[1 1]\n[0 1]\n\nsage: Gamma0(5).generators()[0] in Gamma0(7)\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n\n/home/ljpk/<ipython console> in <module>()\n\n/home/was/s/local/lib/python2.5/site-packages/sage/groups/group.so in sage.groups.group.Group.__contains__ (sage/groups/group.c:1034)()\n\n/home/was/s/local/lib/python2.5/site-packages/sage/modular/congroup.pyc in __call__(self, x, check)\n   1654         if isinstance(x, CongruenceSubgroupElement) and x.parent() == self:\n   1655             return x\n-> 1656         x = CongruenceSubgroupElement(self, x, check=check)\n   1657         if not check:\n   1658             return x\n\n/home/was/s/local/lib/python2.5/site-packages/sage/modular/congroup_element.pyc in __init__(self, parent, x, check)\n     46             if not congroup.is_CongruenceSubgroup(parent):\n     47                 raise TypeError, \"parent (= %s) must be a congruence subgroup\"%parent\n---> 48             x = M2Z(x)\n     49             if x.determinant() != 1:\n     50                 raise ValueError, \"matrix must have determinant 1\"\n\n/home/was/s/local/lib/python2.5/site-packages/sage/matrix/matrix_space.pyc in __call__(self, entries, coerce, copy, rows)\n    306             entries = 0\n    307\n--> 308         if entries == 0 and hasattr(self, '__zero_matrix'):\n    309             return self.zero_matrix()\n    310\n\n/home/was/s/local/lib/python2.5/site-packages/sage/structure/element.so in sage.structure.element.Element.__richcmp__ (sage/structure/element.c:5247)()\n\n/home/was/s/local/lib/python2.5/site-packages/sage/structure/element.so in sage.structure.element.Element._richcmp (sage/structure/element.c:4954)()\n\n/home/was/s/local/lib/python2.5/site-packages/sage/modular/congroup.pyc in __call__(self, x, check)\n   1654         if isinstance(x, CongruenceSubgroupElement) and x.parent() == self:\n   1655             return x\n-> 1656         x = CongruenceSubgroupElement(self, x, check=check)\n   1657         if not check:\n   1658             return x\n\n/home/was/s/local/lib/python2.5/site-packages/sage/modular/congroup_element.pyc in __init__(self, parent, x, check)\n     48             x = M2Z(x)\n     49             if x.determinant() != 1:\n---> 50                 raise ValueError, \"matrix must have determinant 1\"\n     51             x.set_immutable()\n     52\n\nValueError: matrix must have determinant 1\n```\n\nIt might be correct not to allow coercions from one congruence subgroup to another, but the matrix *does* have determinant 1, so the error message should be changed to one that is more suitable.\n\nAssignee: @craigcitro\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/4762\n\n",
    "closed_at": "2009-01-23T10:26:49Z",
    "created_at": "2008-12-11T19:43:52Z",
    "labels": [
        "component: modular forms",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-3.3",
    "title": "[with patch, with positive review] Odd error message for congruence subgroups",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/4762",
    "user": "https://trac.sagemath.org/admin/accounts/users/ljpk"
}
```
I was looking at generators of various different congruence subgroups, and got the following error:

```
sage: Gamma0(5).generators()[0]

[1 1]
[0 1]

sage: Gamma0(5).generators()[0] in Gamma0(7)
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)

/home/ljpk/<ipython console> in <module>()

/home/was/s/local/lib/python2.5/site-packages/sage/groups/group.so in sage.groups.group.Group.__contains__ (sage/groups/group.c:1034)()

/home/was/s/local/lib/python2.5/site-packages/sage/modular/congroup.pyc in __call__(self, x, check)
   1654         if isinstance(x, CongruenceSubgroupElement) and x.parent() == self:
   1655             return x
-> 1656         x = CongruenceSubgroupElement(self, x, check=check)
   1657         if not check:
   1658             return x

/home/was/s/local/lib/python2.5/site-packages/sage/modular/congroup_element.pyc in __init__(self, parent, x, check)
     46             if not congroup.is_CongruenceSubgroup(parent):
     47                 raise TypeError, "parent (= %s) must be a congruence subgroup"%parent
---> 48             x = M2Z(x)
     49             if x.determinant() != 1:
     50                 raise ValueError, "matrix must have determinant 1"

/home/was/s/local/lib/python2.5/site-packages/sage/matrix/matrix_space.pyc in __call__(self, entries, coerce, copy, rows)
    306             entries = 0
    307
--> 308         if entries == 0 and hasattr(self, '__zero_matrix'):
    309             return self.zero_matrix()
    310

/home/was/s/local/lib/python2.5/site-packages/sage/structure/element.so in sage.structure.element.Element.__richcmp__ (sage/structure/element.c:5247)()

/home/was/s/local/lib/python2.5/site-packages/sage/structure/element.so in sage.structure.element.Element._richcmp (sage/structure/element.c:4954)()

/home/was/s/local/lib/python2.5/site-packages/sage/modular/congroup.pyc in __call__(self, x, check)
   1654         if isinstance(x, CongruenceSubgroupElement) and x.parent() == self:
   1655             return x
-> 1656         x = CongruenceSubgroupElement(self, x, check=check)
   1657         if not check:
   1658             return x

/home/was/s/local/lib/python2.5/site-packages/sage/modular/congroup_element.pyc in __init__(self, parent, x, check)
     48             x = M2Z(x)
     49             if x.determinant() != 1:
---> 50                 raise ValueError, "matrix must have determinant 1"
     51             x.set_immutable()
     52

ValueError: matrix must have determinant 1
```

It might be correct not to allow coercions from one congruence subgroup to another, but the matrix *does* have determinant 1, so the error message should be changed to one that is more suitable.

Assignee: @craigcitro

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/4762





---

archive/issue_comments_039198.json:
```json
{
    "body": "<a id='comment:1'></a>This error message also comes up for groups which genuinely are subgroups of one another:\n\n```\nsage: Gamma0(2).is_subgroup(SL2Z)\nTrue\nsage: Gamma0(2)([1,0,0,1]) in SL2Z\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n\n/home/ljpk/congroup_upper.py in <module>()\n----> 1\n      2\n      3\n      4\n      5\n\n/home/was/s/local/lib/python2.5/site-packages/sage/groups/group.so in sage.groups.group.Group.__contains__ (sage/groups/group.c:1034)()\n     46\n     47\n---> 48\n     49\n     50\n\n/home/was/s/local/lib/python2.5/site-packages/sage/modular/congroup.pyc in __call__(self, x, check)\n   1654         if isinstance(x, CongruenceSubgroupElement) and x.parent() == self:\n   1655             return x\n-> 1656         x = CongruenceSubgroupElement(self, x, check=check)\n   1657         if not check:\n   1658             return x\n\n/home/was/s/local/lib/python2.5/site-packages/sage/modular/congroup_element.pyc in __init__(self, parent, x, check)\n     46             if not congroup.is_CongruenceSubgroup(parent):\n     47                 raise TypeError, \"parent (= %s) must be a congruence subgroup\"%parent\n---> 48             x = M2Z(x)\n     49             if x.determinant() != 1:\n     50                 raise ValueError, \"matrix must have determinant 1\"\n\n/home/was/s/local/lib/python2.5/site-packages/sage/matrix/matrix_space.pyc in __call__(self, entries, coerce, copy, rows)\n    306             entries = 0\n    307\n--> 308         if entries == 0 and hasattr(self, '__zero_matrix'):\n    309             return self.zero_matrix()\n    310\n\n/home/was/s/local/lib/python2.5/site-packages/sage/structure/element.so in sage.structure.element.Element.__richcmp__ (sage/structure/element.c:5247)()\n    556\n    557\n--> 558\n    559\n    560\n\n/home/was/s/local/lib/python2.5/site-packages/sage/structure/element.so in sage.structure.element.Element._richcmp (sage/structure/element.c:4954)()\n    516\n    517\n--> 518\n    519\n    520\n\n/home/was/s/local/lib/python2.5/site-packages/sage/modular/congroup.pyc in __call__(self, x, check)\n   1654         if isinstance(x, CongruenceSubgroupElement) and x.parent() == self:\n   1655             return x\n-> 1656         x = CongruenceSubgroupElement(self, x, check=check)\n   1657         if not check:\n   1658             return x\n\n/home/was/s/local/lib/python2.5/site-packages/sage/modular/congroup_element.pyc in __init__(self, parent, x, check)\n     48             x = M2Z(x)\n     49             if x.determinant() != 1:\n---> 50                 raise ValueError, \"matrix must have determinant 1\"\n     51             x.set_immutable()\n     52\n\nValueError: matrix must have determinant 1\n\n```",
    "created_at": "2008-12-12T12:21:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4762#issuecomment-39198",
    "user": "https://trac.sagemath.org/admin/accounts/users/ljpk"
}
```

<a id='comment:1'></a>This error message also comes up for groups which genuinely are subgroups of one another:

```
sage: Gamma0(2).is_subgroup(SL2Z)
True
sage: Gamma0(2)([1,0,0,1]) in SL2Z
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)

/home/ljpk/congroup_upper.py in <module>()
----> 1
      2
      3
      4
      5

/home/was/s/local/lib/python2.5/site-packages/sage/groups/group.so in sage.groups.group.Group.__contains__ (sage/groups/group.c:1034)()
     46
     47
---> 48
     49
     50

/home/was/s/local/lib/python2.5/site-packages/sage/modular/congroup.pyc in __call__(self, x, check)
   1654         if isinstance(x, CongruenceSubgroupElement) and x.parent() == self:
   1655             return x
-> 1656         x = CongruenceSubgroupElement(self, x, check=check)
   1657         if not check:
   1658             return x

/home/was/s/local/lib/python2.5/site-packages/sage/modular/congroup_element.pyc in __init__(self, parent, x, check)
     46             if not congroup.is_CongruenceSubgroup(parent):
     47                 raise TypeError, "parent (= %s) must be a congruence subgroup"%parent
---> 48             x = M2Z(x)
     49             if x.determinant() != 1:
     50                 raise ValueError, "matrix must have determinant 1"

/home/was/s/local/lib/python2.5/site-packages/sage/matrix/matrix_space.pyc in __call__(self, entries, coerce, copy, rows)
    306             entries = 0
    307
--> 308         if entries == 0 and hasattr(self, '__zero_matrix'):
    309             return self.zero_matrix()
    310

/home/was/s/local/lib/python2.5/site-packages/sage/structure/element.so in sage.structure.element.Element.__richcmp__ (sage/structure/element.c:5247)()
    556
    557
--> 558
    559
    560

/home/was/s/local/lib/python2.5/site-packages/sage/structure/element.so in sage.structure.element.Element._richcmp (sage/structure/element.c:4954)()
    516
    517
--> 518
    519
    520

/home/was/s/local/lib/python2.5/site-packages/sage/modular/congroup.pyc in __call__(self, x, check)
   1654         if isinstance(x, CongruenceSubgroupElement) and x.parent() == self:
   1655             return x
-> 1656         x = CongruenceSubgroupElement(self, x, check=check)
   1657         if not check:
   1658             return x

/home/was/s/local/lib/python2.5/site-packages/sage/modular/congroup_element.pyc in __init__(self, parent, x, check)
     48             x = M2Z(x)
     49             if x.determinant() != 1:
---> 50                 raise ValueError, "matrix must have determinant 1"
     51             x.set_immutable()
     52

ValueError: matrix must have determinant 1

```



---

archive/issue_comments_039199.json:
```json
{
    "body": "Attachment [trac_4762.patch](tarball://root/attachments/some-uuid/ticket4762/trac_4762.patch) by @aghitza created at 2008-12-14 00:00:21",
    "created_at": "2008-12-14T00:00:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4762#issuecomment-39199",
    "user": "https://github.com/aghitza"
}
```

Attachment [trac_4762.patch](tarball://root/attachments/some-uuid/ticket4762/trac_4762.patch) by @aghitza created at 2008-12-14 00:00:21



---

archive/issue_comments_039200.json:
```json
{
    "body": "<a id='comment:2'></a>This is due to two underlying problems:\n\n* coercing an element of a congruence subgroup into the set of 2x2 integer matrices is broken\n* if g is an element of a congruence subgroup, testing g == 0 is broken\n\nThe attached patch fixes both issues.  Note that if CongruenceSubgroup were to inherit from MatrixGroup (which it probably should?), then the first problem would just go away.",
    "created_at": "2008-12-14T00:01:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4762#issuecomment-39200",
    "user": "https://github.com/aghitza"
}
```

<a id='comment:2'></a>This is due to two underlying problems:

* coercing an element of a congruence subgroup into the set of 2x2 integer matrices is broken
* if g is an element of a congruence subgroup, testing g == 0 is broken

The attached patch fixes both issues.  Note that if CongruenceSubgroup were to inherit from MatrixGroup (which it probably should?), then the first problem would just go away.



---

archive/issue_comments_039201.json:
```json
{
    "body": "<a id='comment:3'></a>Patch looks good, but there are still some troubles in the code. Here's an example:\n\n```\nsage: G = Gamma0(5)\n\nsage: G.0 in SL2Z\nERROR: An unexpected error occurred while tokenizing input\nThe following traceback may be corrupted or invalid\nThe error message is: ('EOF in multi-line statement', (131, 0))\n\n---------------------------------------------------------------------------\nAttributeError                            Traceback (most recent call last)\n\n/Users/craigcitro/.sage/temp/sharma.local/18290/_Users_craigcitro__sage_init_sage_0.py in <module>()\n----> 1 \n      2 \n      3 \n      4 \n      5 \n\n/sage/local/lib/python2.5/site-packages/sage/groups/group.so in sage.groups.group.Group.__contains__ (sage/groups/group.c:1034)()\n     46 \n     47 \n---> 48 \n     49 \n     50 \n\n/sage/local/lib/python2.5/site-packages/sage/modular/congroup.pyc in __call__(self, x, check)\n   1665         if isinstance(x, CongruenceSubgroupElement) and x.parent() == self:\n   1666             return x\n-> 1667         x = CongruenceSubgroupElement(self, x, check=check)\n   1668         if not check:\n   1669             return x\n\n/sage/local/lib/python2.5/site-packages/sage/modular/congroup_element.pyc in __init__(self, parent, x, check)\n     49             if x.determinant() != 1:\n     50                 raise TypeError, \"matrix must have determinant 1\"\n---> 51             x.set_immutable()\n     52 \n     53         MultiplicativeGroupElement.__init__(self, parent)\n\n/sage/local/lib/python2.5/site-packages/sage/matrix/matrix0.so in sage.matrix.matrix0.Matrix.set_immutable (sage/matrix/matrix0.c:3464)()\n    407 \n    408 \n--> 409 \n    410 \n    411 \n\nAttributeError: 'NoneType' object has no attribute 'set_immutable'\n\nsage:\n```\n\nI'm",
    "created_at": "2008-12-16T06:54:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4762#issuecomment-39201",
    "user": "https://github.com/craigcitro"
}
```

<a id='comment:3'></a>Patch looks good, but there are still some troubles in the code. Here's an example:

```
sage: G = Gamma0(5)

sage: G.0 in SL2Z
ERROR: An unexpected error occurred while tokenizing input
The following traceback may be corrupted or invalid
The error message is: ('EOF in multi-line statement', (131, 0))

---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)

/Users/craigcitro/.sage/temp/sharma.local/18290/_Users_craigcitro__sage_init_sage_0.py in <module>()
----> 1 
      2 
      3 
      4 
      5 

/sage/local/lib/python2.5/site-packages/sage/groups/group.so in sage.groups.group.Group.__contains__ (sage/groups/group.c:1034)()
     46 
     47 
---> 48 
     49 
     50 

/sage/local/lib/python2.5/site-packages/sage/modular/congroup.pyc in __call__(self, x, check)
   1665         if isinstance(x, CongruenceSubgroupElement) and x.parent() == self:
   1666             return x
-> 1667         x = CongruenceSubgroupElement(self, x, check=check)
   1668         if not check:
   1669             return x

/sage/local/lib/python2.5/site-packages/sage/modular/congroup_element.pyc in __init__(self, parent, x, check)
     49             if x.determinant() != 1:
     50                 raise TypeError, "matrix must have determinant 1"
---> 51             x.set_immutable()
     52 
     53         MultiplicativeGroupElement.__init__(self, parent)

/sage/local/lib/python2.5/site-packages/sage/matrix/matrix0.so in sage.matrix.matrix0.Matrix.set_immutable (sage/matrix/matrix0.c:3464)()
    407 
    408 
--> 409 
    410 
    411 

AttributeError: 'NoneType' object has no attribute 'set_immutable'

sage:
```

I'm



---

archive/issue_comments_039202.json:
```json
{
    "body": "<a id='comment:4'></a>I'm attaching an additional patch that fixes the issue reported by Craig, and doctests it.",
    "created_at": "2008-12-20T12:58:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4762#issuecomment-39202",
    "user": "https://github.com/aghitza"
}
```

<a id='comment:4'></a>I'm attaching an additional patch that fixes the issue reported by Craig, and doctests it.



---

archive/issue_comments_039203.json:
```json
{
    "body": "apply after the previous patch",
    "created_at": "2008-12-20T12:58:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4762#issuecomment-39203",
    "user": "https://github.com/aghitza"
}
```

apply after the previous patch



---

archive/issue_comments_039204.json:
```json
{
    "body": "<a id='comment:5'></a>Attachment [trac_4762_fix.patch](tarball://root/attachments/some-uuid/ticket4762/trac_4762_fix.patch) by @ncalexan created at 2009-01-21 08:00:19\n\nThis is fine by me, but the congruence subgroup code really needs to be migrated to the new coercion model -- see #5048.",
    "created_at": "2009-01-21T08:00:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4762#issuecomment-39204",
    "user": "https://github.com/ncalexan"
}
```

<a id='comment:5'></a>Attachment [trac_4762_fix.patch](tarball://root/attachments/some-uuid/ticket4762/trac_4762_fix.patch) by @ncalexan created at 2009-01-21 08:00:19

This is fine by me, but the congruence subgroup code really needs to be migrated to the new coercion model -- see #5048.



---

archive/issue_comments_039205.json:
```json
{
    "body": "<a id='comment:6'></a>Merged in Sage 3.3.alpha1\n\nCheers,\n\nMichael",
    "created_at": "2009-01-23T10:26:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4762#issuecomment-39205",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:6'></a>Merged in Sage 3.3.alpha1

Cheers,

Michael



---

archive/issue_events_010890.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2009-01-23T10:26:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/4762",
    "milestone": "sage-3.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4762#event-10890"
}
```



---

archive/issue_events_010891.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2009-01-23T10:26:49Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/4762",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4762#event-10891"
}
```



---

archive/issue_comments_039206.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2009-01-23T10:26:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4762#issuecomment-39206",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

Resolution: fixed
