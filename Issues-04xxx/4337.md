# Issue 4337: modular forms -- compute action of Hecke operators on Gamma_1(N) modular forms

archive/issues_004337.json:
```json
{
    "body": "\n```\nsage: ModularForms(Gamma1(11),2).hecke_matrix(2)\nboom!\n```\n\nand a genuine bug:\n\n```\nsage: ModularForms(GammaH(11, [2]),2).hecke_matrix(2)\n---------------------------------------------------------------------------\nRuntimeError                              Traceback (most recent call last)\n...\nRuntimeError: maximum recursion depth exceeded in cmp\n```\n\n**Assignee:** @loefflerd\n\n**Author:** David Loeffler\n\n**Reviewer:** Craig Citro\n\n**Merged:** 4.0.alpha0\n\nIssue created by migration from https://trac.sagemath.org/ticket/4337\n\n",
    "closed_at": "2009-05-11T07:47:10Z",
    "created_at": "2008-10-22T17:46:16Z",
    "labels": [
        "component: modular forms",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.0",
    "title": "modular forms -- compute action of Hecke operators on Gamma_1(N) modular forms",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/4337",
    "user": "https://github.com/williamstein"
}
```

```
sage: ModularForms(Gamma1(11),2).hecke_matrix(2)
boom!
```

and a genuine bug:

```
sage: ModularForms(GammaH(11, [2]),2).hecke_matrix(2)
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
...
RuntimeError: maximum recursion depth exceeded in cmp
```

**Assignee:** @loefflerd

**Author:** David Loeffler

**Reviewer:** Craig Citro

**Merged:** 4.0.alpha0

Issue created by migration from https://trac.sagemath.org/ticket/4337





---

archive/attachments_004636.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_4337.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket4337/trac_4337.patch",
    "created_at": "2009-05-05T16:42:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4337",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/loefflerd"
}
```



---

archive/issue_comments_033141.json:
```json
{
    "body": "patch against 3.4.2.final",
    "created_at": "2009-05-05T16:42:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4337",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4337#issuecomment-33141",
    "user": "https://github.com/loefflerd"
}
```

patch against 3.4.2.final



---

archive/issue_comments_033142.json:
```json
{
    "body": "**Changing assignee** from @craigcitro to @loefflerd.",
    "created_at": "2009-05-05T16:49:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4337",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4337#issuecomment-33142",
    "user": "https://github.com/loefflerd"
}
```

**Changing assignee** from @craigcitro to @loefflerd.



---

archive/issue_comments_033143.json:
```json
{
    "body": "<a id='comment:1'></a>\nI believe I've fixed the Gamma1 bug; I've checked the algorithm by comparing the output with the obvious algorithm of summing over the character spaces for all characters of the given modulus, and it seems to agree (and it's a lot quicker). \n\nThe GammaH one is more deep-rooted -- just about nothing works for spaces of GammaH forms, not even the basis() method. I've inserted a dummy routine that raises a NotImplementedError at an appropriate place, which is better than the current infinite loop. It will be easy to add computation of Hecke ops for modular forms for GammaH once we have them for the corresponding spaces of modular symbols.",
    "created_at": "2009-05-05T16:49:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4337",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4337#issuecomment-33143",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:1'></a>
I believe I've fixed the Gamma1 bug; I've checked the algorithm by comparing the output with the obvious algorithm of summing over the character spaces for all characters of the given modulus, and it seems to agree (and it's a lot quicker). 

The GammaH one is more deep-rooted -- just about nothing works for spaces of GammaH forms, not even the basis() method. I've inserted a dummy routine that raises a NotImplementedError at an appropriate place, which is better than the current infinite loop. It will be easy to add computation of Hecke ops for modular forms for GammaH once we have them for the corresponding spaces of modular symbols.



---

archive/issue_comments_033144.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2009-05-05T16:49:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4337",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4337#issuecomment-33144",
    "user": "https://github.com/loefflerd"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_033145.json:
```json
{
    "body": "**Changing status** from new to assigned.",
    "created_at": "2009-05-05T16:49:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4337",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4337#issuecomment-33145",
    "user": "https://github.com/loefflerd"
}
```

**Changing status** from new to assigned.



---

archive/attachments_004637.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_4337_pt2.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket4337/trac_4337_pt2.patch",
    "created_at": "2009-05-08T06:51:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4337",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/craigcitro"
}
```



---

archive/issue_comments_033146.json:
```json
{
    "body": "",
    "created_at": "2009-05-08T06:51:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4337",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4337#issuecomment-33146",
    "user": "https://github.com/craigcitro"
}
```





---

archive/issue_events_012479.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/4337",
    "rename": {
        "from": "modular forms -- compute action of Hecke operators on Gamma_1(N) modular forms",
        "to": "[with patch, with positive review, with referee's patch] modular forms -- compute action of Hecke operators on Gamma_1(N) modular forms"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4337#event-12479"
}
```



---

archive/issue_comments_033147.json:
```json
{
    "body": "<a id='comment:2'></a>\nThis looks really good. Positive review! Here are my comments:\n\n* I'm really happy to see that this code is written! I'm very happy with how all the code works. This is actually functionality that Magma doesn't even have. Bravo, David!\n\n* I moved a few bits of code around, and did a few things to make the code run faster. On the (few) benchmarks I was running, I got a factor of 2 speedup for `_compute_hecke_matrix` on cuspidal subspaces, and about 1.5 on the Eisenstein part. (There's more post-processing to be done in the Eisenstein case.)\n\n* Unfortunately, this algorithm gets slow pretty fast. For instance, trying to compute the Hecke operators on something like `ModularForms(Gamma1(48),4)` is just hopeless in this case. We should try to talk about what else we could do that might scale a little better. But we **definitely** want this merged first!\n\nDavid, I've added a few changes in my referee patch -- could you look over the changes and make sure you're okay with them? Most of it is just cleanup; the only change I'd really demand is renaming the variable you called `QQ`, since I think it's pretty confusing to have a local variable named `QQ`, even if it's going to be the global `QQ` 99% of the time.",
    "created_at": "2009-05-08T06:58:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4337",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4337#issuecomment-33147",
    "user": "https://github.com/craigcitro"
}
```

<a id='comment:2'></a>
This looks really good. Positive review! Here are my comments:

* I'm really happy to see that this code is written! I'm very happy with how all the code works. This is actually functionality that Magma doesn't even have. Bravo, David!

* I moved a few bits of code around, and did a few things to make the code run faster. On the (few) benchmarks I was running, I got a factor of 2 speedup for `_compute_hecke_matrix` on cuspidal subspaces, and about 1.5 on the Eisenstein part. (There's more post-processing to be done in the Eisenstein case.)

* Unfortunately, this algorithm gets slow pretty fast. For instance, trying to compute the Hecke operators on something like `ModularForms(Gamma1(48),4)` is just hopeless in this case. We should try to talk about what else we could do that might scale a little better. But we **definitely** want this merged first!

David, I've added a few changes in my referee patch -- could you look over the changes and make sure you're okay with them? Most of it is just cleanup; the only change I'd really demand is renaming the variable you called `QQ`, since I think it's pretty confusing to have a local variable named `QQ`, even if it's going to be the global `QQ` 99% of the time.



---

archive/issue_events_012480.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/4337",
    "rename": {
        "from": "[with patch, with positive review, with referee's patch] modular forms -- compute action of Hecke operators on Gamma_1(N) modular forms",
        "to": "modular forms -- compute action of Hecke operators on Gamma_1(N) modular forms"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4337#event-12480"
}
```



---

archive/issue_comments_033148.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2009-05-08T09:56:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4337",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4337#issuecomment-33148",
    "user": "https://github.com/loefflerd"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_033149.json:
```json
{
    "body": "<a id='comment:3'></a>\nThanks for reviewing this. I'd actually never come across the python \"for/else\" syntax before; it's a neat trick, I'll have to remember it. I'm happy with the changes you propose.\n\nUnfortunately, I've realised that there *is* a problem in my patch: in trying to prevent the infinite loop for GammaH, I've broken something else. The loop comes up because the default behaviour for the generic cuspidal submodule class is to get its q-expansions from its ambient space; and the generic ambient space class gets its q-expansions from its ambient modules.\n\nNow, for *most* derived classes it's the cuspidal and eisenstein subs that have this overridden, but for the \"ambient_R\" class, it's the ambient space that overrides it. So my patch breaks calculation of q-expansion bases -- and consequently everything else -- for forms over a non-minimal base ring.\n\nSo here's a third patch, which fixes this and adds a doctest.\n\nDavid",
    "created_at": "2009-05-08T09:56:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4337",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4337#issuecomment-33149",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:3'></a>
Thanks for reviewing this. I'd actually never come across the python "for/else" syntax before; it's a neat trick, I'll have to remember it. I'm happy with the changes you propose.

Unfortunately, I've realised that there *is* a problem in my patch: in trying to prevent the infinite loop for GammaH, I've broken something else. The loop comes up because the default behaviour for the generic cuspidal submodule class is to get its q-expansions from its ambient space; and the generic ambient space class gets its q-expansions from its ambient modules.

Now, for *most* derived classes it's the cuspidal and eisenstein subs that have this overridden, but for the "ambient_R" class, it's the ambient space that overrides it. So my patch breaks calculation of q-expansion bases -- and consequently everything else -- for forms over a non-minimal base ring.

So here's a third patch, which fixes this and adds a doctest.

David



---

archive/issue_comments_033150.json:
```json
{
    "body": "<a id='comment:4'></a>\nI think something is wrong with the third patch? trac tells me it's 225 bytes, which seems unlikely. Can you re-upload it?",
    "created_at": "2009-05-08T10:01:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4337",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4337#issuecomment-33150",
    "user": "https://github.com/craigcitro"
}
```

<a id='comment:4'></a>
I think something is wrong with the third patch? trac tells me it's 225 bytes, which seems unlikely. Can you re-upload it?



---

archive/attachments_004638.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_4337_pt3.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket4337/trac_4337_pt3.patch",
    "created_at": "2009-05-08T10:07:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4337",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/loefflerd"
}
```



---

archive/issue_comments_033151.json:
```json
{
    "body": "",
    "created_at": "2009-05-08T10:07:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4337",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4337#issuecomment-33151",
    "user": "https://github.com/loefflerd"
}
```





---

archive/issue_comments_033152.json:
```json
{
    "body": "<a id='comment:5'></a>\nOops, I forgot to qrefresh before I exported. Here it is.",
    "created_at": "2009-05-08T10:08:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4337",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4337#issuecomment-33152",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:5'></a>
Oops, I forgot to qrefresh before I exported. Here it is.



---

archive/issue_comments_033153.json:
```json
{
    "body": "<a id='comment:6'></a>\nNice catch! I'm happy with the `_R`-related changes ... positive review! (I was apparently sloppy while reviewing and only worked over `QQ` ... I'm glad you were experimenting with quadratic imaginary fields!)",
    "created_at": "2009-05-08T10:12:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4337",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4337#issuecomment-33153",
    "user": "https://github.com/craigcitro"
}
```

<a id='comment:6'></a>
Nice catch! I'm happy with the `_R`-related changes ... positive review! (I was apparently sloppy while reviewing and only worked over `QQ` ... I'm glad you were experimenting with quadratic imaginary fields!)



---

archive/issue_comments_033154.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2009-05-08T10:12:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4337",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4337#issuecomment-33154",
    "user": "https://github.com/craigcitro"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_033155.json:
```json
{
    "body": "<a id='comment:7'></a>\nLooks like you weren't the only one that was sloppy: neither of us ran a full doctest cycle, so neither of us spotted the fact that this causes a doctest failure in William's Bordeaux lectures. One of those specifically states, with a doctest to prove it, that computing Hecke matrices for Gamma1(N) raises a `NotImplementedError`.",
    "created_at": "2009-05-11T07:04:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4337",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4337#issuecomment-33155",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:7'></a>
Looks like you weren't the only one that was sloppy: neither of us ran a full doctest cycle, so neither of us spotted the fact that this causes a doctest failure in William's Bordeaux lectures. One of those specifically states, with a doctest to prove it, that computing Hecke matrices for Gamma1(N) raises a `NotImplementedError`.



---

archive/attachments_004639.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_4337_docfix.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket4337/trac_4337_docfix.patch",
    "created_at": "2009-05-11T07:06:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4337",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/loefflerd"
}
```



---

archive/issue_comments_033156.json:
```json
{
    "body": "apply over previous three",
    "created_at": "2009-05-11T07:06:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4337",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4337#issuecomment-33156",
    "user": "https://github.com/loefflerd"
}
```

apply over previous three



---

archive/issue_comments_033157.json:
```json
{
    "body": "<a id='comment:8'></a>\nMerged all four patches in Sage 4.0.alpha0.\n\nCheers,\n\nMichael",
    "created_at": "2009-05-11T07:47:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4337",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4337#issuecomment-33157",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:8'></a>
Merged all four patches in Sage 4.0.alpha0.

Cheers,

Michael



---

archive/issue_events_012481.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2009-05-11T07:47:10Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/4337",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4337#event-12481"
}
```



---

archive/issue_comments_033158.json:
```json
{
    "body": "**Author:** David Loeffler",
    "created_at": "2009-06-07T09:16:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4337",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4337#issuecomment-33158",
    "user": "https://github.com/loefflerd"
}
```

**Author:** David Loeffler



---

archive/issue_comments_033159.json:
```json
{
    "body": "**Reviewer:** Craig Citro",
    "created_at": "2009-06-07T09:16:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4337",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4337#issuecomment-33159",
    "user": "https://github.com/loefflerd"
}
```

**Reviewer:** Craig Citro



---

archive/issue_comments_033160.json:
```json
{
    "body": "**Merged:** 4.0.alpha0",
    "created_at": "2009-06-07T09:16:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4337",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4337#issuecomment-33160",
    "user": "https://github.com/loefflerd"
}
```

**Merged:** 4.0.alpha0
