# Issue 4336: Bug in handling attached pyx-files

archive/issues_004336.json:
```json
{
    "body": "I attached a pyx-file:\n\n```\nsage: attach f5.pyx\nCompiling /home/king/Projekte/f5/f5.pyx...\n```\n\nThen I changed the file on the disk, and pressed the `Enter` key in Sage. This should result in a recompilation of `f5.pyx`, but instead I got this traceback:\n\n```\nsage:\nCompiling /home/king/Projekte/f5/f5.pyx...\n---------------------------------------------------------------------------\nUnboundLocalError                         Traceback (most recent call last)\n\n/home/king/SAGE/devel/sage-3.1.4/local/lib/python2.5/site-packages/sage/misc/interpreter.pyc in sage_prefilter(self, block, continuation)\n    394         for i in range(len(B)):\n    395             L = B[i]\n--> 396             M = do_prefilter_paste(L, continuation or (not first))\n    397             first = False\n    398             # The L[:len(L)-len(L.lstrip())]  business here preserves\n\n/home/king/SAGE/devel/sage-3.1.4/local/lib/python2.5/site-packages/sage/misc/interpreter.pyc in do_prefilter_paste(line, continuation)\n    190                         _ip.runlines('%%run -i \"%s\"'%preparse_file_named(F))\n    191                     elif F.endswith('.spyx') or F.endswith('.pyx'):\n--> 192                         X = load_cython(F)\n    193                         __IPYTHON__.push(X)\n    194                     else:\n\n/home/king/SAGE/devel/sage-3.1.4/local/lib/python2.5/site-packages/sage/misc/interpreter.pyc in load_cython(name)\n    340     cur = os.path.abspath(os.curdir)\n    341     try:\n--> 342         mod, dir  = cython.cython(name, compile_message=True, use_cache=True)\n    343     except (IOError, OSError, RuntimeError), msg:\n    344         print \"Error compiling cython file:\\n%s\"%msg\n\n/home/king/SAGE/devel/sage-3.1.4/local/lib/python2.5/site-packages/sage/misc/cython.pyc in cython(filename, verbose, compile_message, use_cache, create_local_c_file, annotate, sage_namespace, create_local_so_file)\n    311                                         for fname in additional_source_files])\n    312\n--> 313     pyx = '%s/%s.pyx'%(build_dir, name)\n    314     open(pyx,'w').write(F)\n    315     setup=\"\"\"\n\nUnboundLocalError: local variable 'name' referenced before assignment\n```\n\nAfterwards, leaving Sage was impossible using `quit` -- I got the same traceback again and had to quit with `Ctrl-D`.\n\nI think the problem is in lines 299-311 of `cython.py`, which is\n\n```\n    if create_local_so_file:\n        name = base\n    else:\n        global sequence_number\n        if not sequence_number.has_key(base):\n            sequence_number[base] = 0\n            name = '%s_%s'%(base, sequence_number[base])\n\n            # increment the sequence number so will use a different one next time.\n            sequence_number[base] += 1\n\n    additional_source_files = \",\".join([\"'\"+os.path.abspath(os.curdir)+\"/\"+fname+\"'\" \\\n                                        for fname in additional_source_files])\n```\n\nIf I'm not mistaken, there is a wrong indentation, and it should be\n\n```\n    if create_local_so_file:\n        name = base\n    else:\n        global sequence_number\n        if not sequence_number.has_key(base):\n            sequence_number[base] = 0\n        name = '%s_%s'%(base, sequence_number[base])\n\n        # increment the sequence number so will use a different one next time.\n        sequence_number[base] += 1\n\n    additional_source_files = \",\".join([\"'\"+os.path.abspath(os.curdir)+\"/\"+fname+\"'\" \\\n                                        for fname in additional_source_files])\n```\n\nProblem 1: I have no idea how I can force Sage to use the modified `cython.py`, hence I can not test my changes. \n\nProblem 2: `hg_sage.commit()` did not work, since it claimed that nothing was changed (although `cython.py` did change). So, no patch.\n\nCan you give me a solution to Problems 1 and 2? And does my suggested solution works?\nCheers\n      Simon\n\n\n**Assignee:** cwitty\n\n**CC:**  @robertwb\n\n**Keywords:** attachments, cython\n\nIssue created by migration from https://trac.sagemath.org/ticket/4336\n\n",
    "closed_at": "2008-10-27T02:54:27Z",
    "created_at": "2008-10-22T16:36:08Z",
    "labels": [
        "component: misc",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-3.2",
    "title": "Bug in handling attached pyx-files",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/4336",
    "user": "https://github.com/simon-king-jena"
}
```
I attached a pyx-file:

```
sage: attach f5.pyx
Compiling /home/king/Projekte/f5/f5.pyx...
```

Then I changed the file on the disk, and pressed the `Enter` key in Sage. This should result in a recompilation of `f5.pyx`, but instead I got this traceback:

```
sage:
Compiling /home/king/Projekte/f5/f5.pyx...
---------------------------------------------------------------------------
UnboundLocalError                         Traceback (most recent call last)

/home/king/SAGE/devel/sage-3.1.4/local/lib/python2.5/site-packages/sage/misc/interpreter.pyc in sage_prefilter(self, block, continuation)
    394         for i in range(len(B)):
    395             L = B[i]
--> 396             M = do_prefilter_paste(L, continuation or (not first))
    397             first = False
    398             # The L[:len(L)-len(L.lstrip())]  business here preserves

/home/king/SAGE/devel/sage-3.1.4/local/lib/python2.5/site-packages/sage/misc/interpreter.pyc in do_prefilter_paste(line, continuation)
    190                         _ip.runlines('%%run -i "%s"'%preparse_file_named(F))
    191                     elif F.endswith('.spyx') or F.endswith('.pyx'):
--> 192                         X = load_cython(F)
    193                         __IPYTHON__.push(X)
    194                     else:

/home/king/SAGE/devel/sage-3.1.4/local/lib/python2.5/site-packages/sage/misc/interpreter.pyc in load_cython(name)
    340     cur = os.path.abspath(os.curdir)
    341     try:
--> 342         mod, dir  = cython.cython(name, compile_message=True, use_cache=True)
    343     except (IOError, OSError, RuntimeError), msg:
    344         print "Error compiling cython file:\n%s"%msg

/home/king/SAGE/devel/sage-3.1.4/local/lib/python2.5/site-packages/sage/misc/cython.pyc in cython(filename, verbose, compile_message, use_cache, create_local_c_file, annotate, sage_namespace, create_local_so_file)
    311                                         for fname in additional_source_files])
    312
--> 313     pyx = '%s/%s.pyx'%(build_dir, name)
    314     open(pyx,'w').write(F)
    315     setup="""

UnboundLocalError: local variable 'name' referenced before assignment
```

Afterwards, leaving Sage was impossible using `quit` -- I got the same traceback again and had to quit with `Ctrl-D`.

I think the problem is in lines 299-311 of `cython.py`, which is

```
    if create_local_so_file:
        name = base
    else:
        global sequence_number
        if not sequence_number.has_key(base):
            sequence_number[base] = 0
            name = '%s_%s'%(base, sequence_number[base])

            # increment the sequence number so will use a different one next time.
            sequence_number[base] += 1

    additional_source_files = ",".join(["'"+os.path.abspath(os.curdir)+"/"+fname+"'" \
                                        for fname in additional_source_files])
```

If I'm not mistaken, there is a wrong indentation, and it should be

```
    if create_local_so_file:
        name = base
    else:
        global sequence_number
        if not sequence_number.has_key(base):
            sequence_number[base] = 0
        name = '%s_%s'%(base, sequence_number[base])

        # increment the sequence number so will use a different one next time.
        sequence_number[base] += 1

    additional_source_files = ",".join(["'"+os.path.abspath(os.curdir)+"/"+fname+"'" \
                                        for fname in additional_source_files])
```

Problem 1: I have no idea how I can force Sage to use the modified `cython.py`, hence I can not test my changes. 

Problem 2: `hg_sage.commit()` did not work, since it claimed that nothing was changed (although `cython.py` did change). So, no patch.

Can you give me a solution to Problems 1 and 2? And does my suggested solution works?
Cheers
      Simon


**Assignee:** cwitty

**CC:**  @robertwb

**Keywords:** attachments, cython

Issue created by migration from https://trac.sagemath.org/ticket/4336





---

archive/issue_comments_033132.json:
```json
{
    "body": "<a id='comment:1'></a>\nAdded RobertWB to the CC since he worked on the Cython recompilation patch. \n\nSimon: Are you sure you edited the right cython.py - there are several copies in the tree.\n\nCheers,\n\nMichael",
    "created_at": "2008-10-22T19:10:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4336#issuecomment-33132",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:1'></a>
Added RobertWB to the CC since he worked on the Cython recompilation patch. 

Simon: Are you sure you edited the right cython.py - there are several copies in the tree.

Cheers,

Michael



---

archive/issue_comments_033133.json:
```json
{
    "body": "<a id='comment:2'></a>\nDear Michael,\n\nReplying to [mabshoff](#comment%3A1):\n> Simon: Are you sure you edited the right cython.py - there are several copies in the tree.\n\n\nI chose local/lib/python2.5/site-packages/sage/misc/cython.py\n\nWhich should I take instead?",
    "created_at": "2008-10-22T19:15:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4336#issuecomment-33133",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:2'></a>
Dear Michael,

Replying to [mabshoff](#comment%3A1):
> Simon: Are you sure you edited the right cython.py - there are several copies in the tree.


I chose local/lib/python2.5/site-packages/sage/misc/cython.py

Which should I take instead?



---

archive/issue_comments_033134.json:
```json
{
    "body": "<a id='comment:3'></a>\nReplying to [SimonKing](#comment%3A2):\n> Dear Michael,\n> \n> Replying to [mabshoff](#comment%3A1):\n> > Simon: Are you sure you edited the right cython.py - there are several copies in the tree.\n\n> \n> I chose local/lib/python2.5/site-packages/sage/misc/cython.py\n> \n> Which should I take instead?\n\n\nTake the one in $SAGE_ROOT/devel/sage/..\n\nCheers,\n\nMichael",
    "created_at": "2008-10-22T19:19:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4336#issuecomment-33134",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:3'></a>
Replying to [SimonKing](#comment%3A2):
> Dear Michael,
> 
> Replying to [mabshoff](#comment%3A1):
> > Simon: Are you sure you edited the right cython.py - there are several copies in the tree.

> 
> I chose local/lib/python2.5/site-packages/sage/misc/cython.py
> 
> Which should I take instead?


Take the one in $SAGE_ROOT/devel/sage/..

Cheers,

Michael



---

archive/issue_comments_033135.json:
```json
{
    "body": "<a id='comment:4'></a>\nDear Michael, dear Robert,\n\nReplying to [mabshoff](#comment%3A3):\n> > Which should I take instead?\n\n> \n> Take the one in $SAGE_ROOT/devel/sage/..\n\n\nDid already. It works, the traceback disappears. Patch'll follow!\n\nCheers,\n    Simon",
    "created_at": "2008-10-22T19:25:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4336#issuecomment-33135",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:4'></a>
Dear Michael, dear Robert,

Replying to [mabshoff](#comment%3A3):
> > Which should I take instead?

> 
> Take the one in $SAGE_ROOT/devel/sage/..


Did already. It works, the traceback disappears. Patch'll follow!

Cheers,
    Simon



---

archive/attachments_004635.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "attach_bugfix.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket4336/attach_bugfix.patch",
    "created_at": "2008-10-22T19:27:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4336",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/simon-king-jena"
}
```



---

archive/issue_comments_033136.json:
```json
{
    "body": "Fixes a bug that occurs when an attached .pyx file is changed",
    "created_at": "2008-10-22T19:27:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4336#issuecomment-33136",
    "user": "https://github.com/simon-king-jena"
}
```

Fixes a bug that occurs when an attached .pyx file is changed



---

archive/issue_events_012476.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/4336",
    "rename": {
        "from": "[with suggested solution] Bug in handling attached pyx-files",
        "to": "Bug in handling attached pyx-files"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4336#event-12476"
}
```



---

archive/issue_comments_033137.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2008-10-22T19:28:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4336#issuecomment-33137",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_033138.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2008-10-27T02:25:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4336#issuecomment-33138",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_events_012477.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2008-10-27T02:25:22Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/4336",
    "milestone": "sage-3.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4336#event-12477"
}
```



---

archive/issue_comments_033139.json:
```json
{
    "body": "<a id='comment:6'></a>\nSimon's patch is correct. This was actually broken by the patch in #4238.\n\nCheers,\n\nMichael",
    "created_at": "2008-10-27T02:25:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4336#issuecomment-33139",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:6'></a>
Simon's patch is correct. This was actually broken by the patch in #4238.

Cheers,

Michael



---

archive/issue_comments_033140.json:
```json
{
    "body": "<a id='comment:7'></a>\nMerged in Sage 3.2.alpha1",
    "created_at": "2008-10-27T02:54:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4336#issuecomment-33140",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:7'></a>
Merged in Sage 3.2.alpha1



---

archive/issue_events_012478.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2008-10-27T02:54:27Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/4336",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4336#event-12478"
}
```
