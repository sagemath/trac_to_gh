# Issue 4671: sage-3.2.1 startup time: do not import twisted on startup

archive/issues_004671.json:
```json
{
    "body": "On OS X the Sage startup time is horrible.  Doing sage -startuptime yields:\n\n```\n## Slowest (including children)\n1.604 sage.all (None)\n0.453 sage.server.all (sage.all)\n0.449 notebook.all (sage.server.all)\n0.445 notebook_object (notebook.all)\n0.441 notebook (notebook_object)\n0.352 worksheet (notebook)\n0.345 twist (worksheet)\n0.329 sage.misc.all (sage.all)\n0.246 twisted.web2 (twist)\n0.125 sage_timeit_class (sage.misc.all)\n0.125 sage_timeit (sage_timeit_class)\n```\n\nI'm pretty suspicious, because the twisted stuff does *not* have to be imported at all for Sage to startup and in fact I put a lot of effort into making sure they don't (it's really annoying that they are suddenly being imported again!)\n\nThe tiny attached patch just moves a few imports and for me on OS X reduces the startup time of Sage from about 1.64 to 1.273.  It also includes a doctest that makes sure twisted will *never* get imported on startup by default.\n\n\n\n**Assignee:** boothby\n\nIssue created by migration from https://trac.sagemath.org/ticket/4671\n\n",
    "closed_at": "2008-12-21T21:30:58Z",
    "created_at": "2008-12-02T05:24:14Z",
    "labels": [
        "component: notebook",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-3.2.3",
    "title": "sage-3.2.1 startup time: do not import twisted on startup",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/4671",
    "user": "https://github.com/williamstein"
}
```
On OS X the Sage startup time is horrible.  Doing sage -startuptime yields:

```
## Slowest (including children)
1.604 sage.all (None)
0.453 sage.server.all (sage.all)
0.449 notebook.all (sage.server.all)
0.445 notebook_object (notebook.all)
0.441 notebook (notebook_object)
0.352 worksheet (notebook)
0.345 twist (worksheet)
0.329 sage.misc.all (sage.all)
0.246 twisted.web2 (twist)
0.125 sage_timeit_class (sage.misc.all)
0.125 sage_timeit (sage_timeit_class)
```

I'm pretty suspicious, because the twisted stuff does *not* have to be imported at all for Sage to startup and in fact I put a lot of effort into making sure they don't (it's really annoying that they are suddenly being imported again!)

The tiny attached patch just moves a few imports and for me on OS X reduces the startup time of Sage from about 1.64 to 1.273.  It also includes a doctest that makes sure twisted will *never* get imported on startup by default.



**Assignee:** boothby

Issue created by migration from https://trac.sagemath.org/ticket/4671





---

archive/attachments_005177.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_4671.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket4671/trac_4671.patch",
    "created_at": "2008-12-02T05:24:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4671",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/williamstein"
}
```



---

archive/issue_comments_037123.json:
```json
{
    "body": "",
    "created_at": "2008-12-02T05:24:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4671#issuecomment-37123",
    "user": "https://github.com/williamstein"
}
```





---

archive/issue_comments_037124.json:
```json
{
    "body": "<a id='comment:1'></a>\nLooks good to me.",
    "created_at": "2008-12-02T07:42:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4671#issuecomment-37124",
    "user": "https://github.com/mwhansen"
}
```

<a id='comment:1'></a>
Looks good to me.



---

archive/issue_comments_037125.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2008-12-02T07:42:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4671#issuecomment-37125",
    "user": "https://github.com/mwhansen"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_events_013532.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/4671",
    "rename": {
        "from": "sage-3.2.1 startup time: it sucks again",
        "to": "sage-3.2.1 startup time: do not import twisted on startup"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4671#event-13532"
}
```



---

archive/issue_comments_037126.json:
```json
{
    "body": "**Changing status** from positive_review to positive_review.",
    "created_at": "2008-12-03T07:30:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4671#issuecomment-37126",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

**Changing status** from positive_review to positive_review.



---

archive/issue_comments_037127.json:
```json
{
    "body": "<a id='comment:3'></a>\nBad mhansen: This patch breaks pickling all over the combinat tree:\n\n```\n\tsage -t -long devel/sage/sage/combinat/root_system/weight_space.py # 1 doctests failed\n\tsage -t -long devel/sage/sage/combinat/root_system/type_reducible.py # 1 doctests failed\n\tsage -t -long devel/sage/sage/combinat/root_system/type_dual.py # 1 doctests failed\n\tsage -t -long devel/sage/sage/combinat/root_system/type_G.py # 1 doctests failed\n\tsage -t -long devel/sage/sage/combinat/root_system/type_F.py # 1 doctests failed\n\tsage -t -long devel/sage/sage/combinat/root_system/type_E.py # 1 doctests failed\n\tsage -t -long devel/sage/sage/combinat/root_system/type_A.py # 1 doctests failed\n\tsage -t -long devel/sage/sage/combinat/root_system/root_space.py # 1 doctests failed\n\tsage -t -long devel/sage/sage/combinat/root_system/root_system.py # 3 doctests failed\n\tsage -t -long devel/sage/sage/combinat/root_system/dynkin_diagram.py # 1 doctests failed\n\tsage -t -long devel/sage/sage/combinat/root_system/cartan_type.py # 2 doctests failed\n\tsage -t -long devel/sage/sage/combinat/root_system/ambient_space.py # 1 doctests failed\n\tsage -t -long devel/sage/sage/combinat/crystals/tensor_product.py # 4 doctests failed\n\tsage -t -long devel/sage/sage/combinat/crystals/spins.py # 2 doctests failed\n\tsage -t -long devel/sage/sage/combinat/crystals/letters.py # 1 doctests failed\n\tsage -t -long devel/sage/sage/combinat/sloane_functions.py # 1 doctests failed\n\tsage -t -long devel/sage/sage/combinat/root_system/weyl_group.py # 2 doctests failed\n\tsage -t -long devel/sage/sage/combinat/root_system/weyl_characters.py # 4 doctests failed\n```\nProbably a trivial problem, but \"needs work\" nonetheless :p\n\nCheers,\n\nMichael",
    "created_at": "2008-12-03T08:53:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4671#issuecomment-37127",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:3'></a>
Bad mhansen: This patch breaks pickling all over the combinat tree:

```
	sage -t -long devel/sage/sage/combinat/root_system/weight_space.py # 1 doctests failed
	sage -t -long devel/sage/sage/combinat/root_system/type_reducible.py # 1 doctests failed
	sage -t -long devel/sage/sage/combinat/root_system/type_dual.py # 1 doctests failed
	sage -t -long devel/sage/sage/combinat/root_system/type_G.py # 1 doctests failed
	sage -t -long devel/sage/sage/combinat/root_system/type_F.py # 1 doctests failed
	sage -t -long devel/sage/sage/combinat/root_system/type_E.py # 1 doctests failed
	sage -t -long devel/sage/sage/combinat/root_system/type_A.py # 1 doctests failed
	sage -t -long devel/sage/sage/combinat/root_system/root_space.py # 1 doctests failed
	sage -t -long devel/sage/sage/combinat/root_system/root_system.py # 3 doctests failed
	sage -t -long devel/sage/sage/combinat/root_system/dynkin_diagram.py # 1 doctests failed
	sage -t -long devel/sage/sage/combinat/root_system/cartan_type.py # 2 doctests failed
	sage -t -long devel/sage/sage/combinat/root_system/ambient_space.py # 1 doctests failed
	sage -t -long devel/sage/sage/combinat/crystals/tensor_product.py # 4 doctests failed
	sage -t -long devel/sage/sage/combinat/crystals/spins.py # 2 doctests failed
	sage -t -long devel/sage/sage/combinat/crystals/letters.py # 1 doctests failed
	sage -t -long devel/sage/sage/combinat/sloane_functions.py # 1 doctests failed
	sage -t -long devel/sage/sage/combinat/root_system/weyl_group.py # 2 doctests failed
	sage -t -long devel/sage/sage/combinat/root_system/weyl_characters.py # 4 doctests failed
```
Probably a trivial problem, but "needs work" nonetheless :p

Cheers,

Michael



---

archive/issue_comments_037128.json:
```json
{
    "body": "**Changing status** from positive_review to needs_work.",
    "created_at": "2008-12-03T08:53:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4671#issuecomment-37128",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

**Changing status** from positive_review to needs_work.



---

archive/issue_comments_037129.json:
```json
{
    "body": "<a id='comment:4'></a>\nThis is really really weird.  The *only* thing I change is to remove two instances of \"import twist\" in the notebook code.  The *only* doctests in the whole Sage tree that break are those combinat pickles.  Absolutely nothing else breaks (I just tested this).  If one tries them by hand on the command line they break, but if one does\n\n```\n  sage: import sage.server.notebook.twist\n```\nthen they suddenly work. \n\nAnd those tests are not just pickle tests that fail.\n\nMike -- can you think of anything that combinat code uses that might somehow have something to do with twisted or twist.py being imported?",
    "created_at": "2008-12-04T21:14:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4671#issuecomment-37129",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:4'></a>
This is really really weird.  The *only* thing I change is to remove two instances of "import twist" in the notebook code.  The *only* doctests in the whole Sage tree that break are those combinat pickles.  Absolutely nothing else breaks (I just tested this).  If one tries them by hand on the command line they break, but if one does

```
  sage: import sage.server.notebook.twist
```
then they suddenly work. 

And those tests are not just pickle tests that fail.

Mike -- can you think of anything that combinat code uses that might somehow have something to do with twisted or twist.py being imported?



---

archive/attachments_005178.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_4671-2.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket4671/trac_4671-2.patch",
    "created_at": "2008-12-16T17:15:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4671",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/mwhansen"
}
```



---

archive/issue_comments_037130.json:
```json
{
    "body": "",
    "created_at": "2008-12-16T17:15:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4671#issuecomment-37130",
    "user": "https://github.com/mwhansen"
}
```





---

archive/issue_comments_037131.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2008-12-16T17:17:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4671#issuecomment-37131",
    "user": "https://github.com/mwhansen"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_037132.json:
```json
{
    "body": "<a id='comment:5'></a>\nI've put up a new patch which imports twisted.persisted.styles, but still make startup time way faster.\n\n```\n<mhansen> No\n<mhansen> I still have no idea why it's happening.\n<mhansen> And I found it.  [08:40]\n<mhansen> Twisted has some code in twisted.persistant.styles that allows you\n          to pickle things that aren't picklable normally.  [08:42]\n<mhansen> Importing just that takes .110s on my machine while doing import\n          twist takes 0.675s.  [08:48]\n<mhansen> Doing so causes wstein|afk's doctest to fail.  [08:49]\n<wstein|afk> mhansen -- importing twisted.persistant.styles and changing my\n             doctest is a good solution.  [09:02]\n```",
    "created_at": "2008-12-16T17:17:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4671#issuecomment-37132",
    "user": "https://github.com/mwhansen"
}
```

<a id='comment:5'></a>
I've put up a new patch which imports twisted.persisted.styles, but still make startup time way faster.

```
<mhansen> No
<mhansen> I still have no idea why it's happening.
<mhansen> And I found it.  [08:40]
<mhansen> Twisted has some code in twisted.persistant.styles that allows you
          to pickle things that aren't picklable normally.  [08:42]
<mhansen> Importing just that takes .110s on my machine while doing import
          twist takes 0.675s.  [08:48]
<mhansen> Doing so causes wstein|afk's doctest to fail.  [08:49]
<wstein|afk> mhansen -- importing twisted.persistant.styles and changing my
             doctest is a good solution.  [09:02]
```



---

archive/issue_events_013533.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2008-12-21T11:02:23Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/4671",
    "milestone": "sage-3.2.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4671#event-13533"
}
```



---

archive/issue_comments_037133.json:
```json
{
    "body": "<a id='comment:6'></a>\nWe should attempt to get this into 3.2.3.\n\nCheers,\n\nMichael",
    "created_at": "2008-12-21T11:02:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4671#issuecomment-37133",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:6'></a>
We should attempt to get this into 3.2.3.

Cheers,

Michael



---

archive/issue_comments_037134.json:
```json
{
    "body": "<a id='comment:7'></a>\nThe patch trac_4671-2.patch fixes the picklig issue and reduces the startup time significantly. Positive review.\n\nCheers,\n\nMichael",
    "created_at": "2008-12-21T21:30:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4671#issuecomment-37134",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:7'></a>
The patch trac_4671-2.patch fixes the picklig issue and reduces the startup time significantly. Positive review.

Cheers,

Michael



---

archive/issue_comments_037135.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2008-12-21T21:30:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4671#issuecomment-37135",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_events_013534.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2008-12-21T21:30:58Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/4671",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4671#event-13534"
}
```



---

archive/issue_comments_037136.json:
```json
{
    "body": "<a id='comment:8'></a>\nMerged in Sage 3.2.3.alpha0",
    "created_at": "2008-12-21T21:30:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4671#issuecomment-37136",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:8'></a>
Merged in Sage 3.2.3.alpha0
