# Issue 4974: [with patch, positive review] eliminate normalize_slice in favor of a standard Python idiom

archive/issues_004974.json:
```json
{
    "body": "Also, it would be good to optimize it if possible.\n\n```\n[04:21] <craigcitro> yeah, file a ticket for that and assign it to me.\n[04:21] <jason-> (couldn't get cimport to work...)\n[04:22] <craigcitro> well, the pari gen.pyx probably wasn't the best place for that function\n[04:22] <craigcitro> so it needs to be moved anyway\n```\n\n\nAssignee: @craigcitro\n\nCC:  @jasongrout\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/4974\n\n",
    "closed_at": "2009-01-18T15:49:40Z",
    "created_at": "2009-01-14T10:27:30Z",
    "labels": [
        "component: misc",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-3.3",
    "title": "[with patch, positive review] eliminate normalize_slice in favor of a standard Python idiom",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/4974",
    "user": "https://github.com/jasongrout"
}
```
Also, it would be good to optimize it if possible.

```
[04:21] <craigcitro> yeah, file a ticket for that and assign it to me.
[04:21] <jason-> (couldn't get cimport to work...)
[04:22] <craigcitro> well, the pari gen.pyx probably wasn't the best place for that function
[04:22] <craigcitro> so it needs to be moved anyway
```


Assignee: @craigcitro

CC:  @jasongrout

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/4974





---

archive/issue_comments_038818.json:
```json
{
    "body": "<a id='comment:1'></a>patch not necessarily ready for review yet.",
    "created_at": "2009-01-14T10:52:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4974",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4974#issuecomment-38818",
    "user": "https://github.com/craigcitro"
}
```

<a id='comment:1'></a>patch not necessarily ready for review yet.



---

archive/issue_comments_038819.json:
```json
{
    "body": "<a id='comment:2'></a>I think this is good to go.",
    "created_at": "2009-01-14T11:54:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4974",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4974#issuecomment-38819",
    "user": "https://github.com/craigcitro"
}
```

<a id='comment:2'></a>I think this is good to go.



---

archive/issue_comments_038820.json:
```json
{
    "body": "Changing status from new to assigned.",
    "created_at": "2009-01-14T11:54:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4974",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4974#issuecomment-38820",
    "user": "https://github.com/craigcitro"
}
```

Changing status from new to assigned.



---

archive/issue_comments_038821.json:
```json
{
    "body": "<a id='comment:3'></a>Some questions/remarks.\nShouldn't the following always be true ? (at least this is what I understand from the docstring)\n\n```python\nnormalize_slice( s , size_list) == range(size_list)[s.start:s.stop:s.step]\n```\n\nIf no (which is the case actually) this looks quite incoherent to me;\nif yes, is there a reason not to rewrite this fonction as a one liner?",
    "created_at": "2009-01-14T13:33:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4974",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4974#issuecomment-38821",
    "user": "https://trac.sagemath.org/admin/accounts/users/ylchapuy"
}
```

<a id='comment:3'></a>Some questions/remarks.
Shouldn't the following always be true ? (at least this is what I understand from the docstring)

```python
normalize_slice( s , size_list) == range(size_list)[s.start:s.stop:s.step]
```

If no (which is the case actually) this looks quite incoherent to me;
if yes, is there a reason not to rewrite this fonction as a one liner?



---

archive/issue_comments_038822.json:
```json
{
    "body": "<a id='comment:4'></a>forget the one liner thing it's obviously a bad idea",
    "created_at": "2009-01-14T13:47:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4974",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4974#issuecomment-38822",
    "user": "https://trac.sagemath.org/admin/accounts/users/ylchapuy"
}
```

<a id='comment:4'></a>forget the one liner thing it's obviously a bad idea



---

archive/issue_comments_038823.json:
```json
{
    "body": "<a id='comment:5'></a>Wait, so disregarding whether or not we'd want to implement things that way -- are you still saying there are cases where that isn't true?",
    "created_at": "2009-01-14T18:15:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4974",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4974#issuecomment-38823",
    "user": "https://github.com/craigcitro"
}
```

<a id='comment:5'></a>Wait, so disregarding whether or not we'd want to implement things that way -- are you still saying there are cases where that isn't true?



---

archive/issue_comments_038824.json:
```json
{
    "body": "<a id='comment:6'></a>There is an inconsistency with standard python:\n\n```\n[12:12] <jason-> sage.misc.misc_c.normalize_slice(slice(2,None,-1),3)\n[12:12] <jason-> gives me 2\n[12:12] <jason-> but \n[12:12] <jason-> sage: range(3)[2::-1]\n[12:12] <jason-> [2, 1, 0]\n```",
    "created_at": "2009-01-14T18:23:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4974",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4974#issuecomment-38824",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:6'></a>There is an inconsistency with standard python:

```
[12:12] <jason-> sage.misc.misc_c.normalize_slice(slice(2,None,-1),3)
[12:12] <jason-> gives me 2
[12:12] <jason-> but 
[12:12] <jason-> sage: range(3)[2::-1]
[12:12] <jason-> [2, 1, 0]
```



---

archive/issue_comments_038825.json:
```json
{
    "body": "<a id='comment:7'></a>Jason Grout just brought up an example in IRC where exactly that would happen. Here's a case:\n\n```\nsage: range(3)[2::-1]\n[2, 1, 0]\n```\n\n`normalize_slice` will **not** return that, since it interprets a missing `stop` to be equal to `size`. This isn't documented as part of the Python semantics, but I think we should switch it to behave the same way regardless. (Also, it'll be easy to implement.)\n\nThis is now `needs work` until I change this.",
    "created_at": "2009-01-14T18:25:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4974",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4974#issuecomment-38825",
    "user": "https://github.com/craigcitro"
}
```

<a id='comment:7'></a>Jason Grout just brought up an example in IRC where exactly that would happen. Here's a case:

```
sage: range(3)[2::-1]
[2, 1, 0]
```

`normalize_slice` will **not** return that, since it interprets a missing `stop` to be equal to `size`. This isn't documented as part of the Python semantics, but I think we should switch it to behave the same way regardless. (Also, it'll be easy to implement.)

This is now `needs work` until I change this.



---

archive/issue_comments_038826.json:
```json
{
    "body": "<a id='comment:8'></a>Another case brought up by Jason Grout:\n\n```\nsage: range(5)[-6:]\n[0, 1, 2, 3, 4]\n```",
    "created_at": "2009-01-14T18:30:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4974",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4974#issuecomment-38826",
    "user": "https://github.com/craigcitro"
}
```

<a id='comment:8'></a>Another case brought up by Jason Grout:

```
sage: range(5)[-6:]
[0, 1, 2, 3, 4]
```



---

archive/issue_comments_038827.json:
```json
{
    "body": "<a id='comment:9'></a>and another one from the docstring...\n\n```\nsage: range(20)[5:8:-1]\n[]\n```",
    "created_at": "2009-01-14T19:36:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4974",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4974#issuecomment-38827",
    "user": "https://trac.sagemath.org/admin/accounts/users/ylchapuy"
}
```

<a id='comment:9'></a>and another one from the docstring...

```
sage: range(20)[5:8:-1]
[]
```



---

archive/issue_comments_038828.json:
```json
{
    "body": "<a id='comment:10'></a>Attachment [normalize_size.patch](tarball://root/attachments/some-uuid/ticket4974/normalize_size.patch) by @jasongrout created at 2009-01-14 20:37:02\n\napply normalize_size.patch on top of previous patch.  This corrects all errors pointed out above and I believe is faster and simpler as well.",
    "created_at": "2009-01-14T20:37:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4974",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4974#issuecomment-38828",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:10'></a>Attachment [normalize_size.patch](tarball://root/attachments/some-uuid/ticket4974/normalize_size.patch) by @jasongrout created at 2009-01-14 20:37:02

apply normalize_size.patch on top of previous patch.  This corrects all errors pointed out above and I believe is faster and simpler as well.



---

archive/issue_comments_038829.json:
```json
{
    "body": "<a id='comment:11'></a>A lot better, but there are still bugs.\n\nI would recommand to try something like this to test extensively:\n\n```python\ndef safe_norm(i,j,k,l):\n    try:\n        return sage.misc.misc_c.normalize_slice(slice(i,j,k),l)\n    except ValueError:\n        return \"error\"\n\ndef safe_range(i,j,k,l):\n    try:\n        return range(l)[i:j:k]\n    except ValueError:\n        return \"error\"\n\nd=[-5,-4,-3,-2,-1,0,-1,-2,-3,-4,-5,None]\nld=len(d)-1\nfor r in xrange(500):\n    i=d[randint(0,ld)]\n    j=d[randint(0,ld)]\n    k=d[randint(0,ld)]\n    l=randint(-8,8)\n    r1=safe_norm(i,j,k,l)\n    r2=safe_range(i,j,k,l)\n    if not r1==r2:\n        print i,j,k,l,r1,r2\n```",
    "created_at": "2009-01-14T23:01:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4974",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4974#issuecomment-38829",
    "user": "https://trac.sagemath.org/admin/accounts/users/ylchapuy"
}
```

<a id='comment:11'></a>A lot better, but there are still bugs.

I would recommand to try something like this to test extensively:

```python
def safe_norm(i,j,k,l):
    try:
        return sage.misc.misc_c.normalize_slice(slice(i,j,k),l)
    except ValueError:
        return "error"

def safe_range(i,j,k,l):
    try:
        return range(l)[i:j:k]
    except ValueError:
        return "error"

d=[-5,-4,-3,-2,-1,0,-1,-2,-3,-4,-5,None]
ld=len(d)-1
for r in xrange(500):
    i=d[randint(0,ld)]
    j=d[randint(0,ld)]
    k=d[randint(0,ld)]
    l=randint(-8,8)
    r1=safe_norm(i,j,k,l)
    r2=safe_range(i,j,k,l)
    if not r1==r2:
        print i,j,k,l,r1,r2
```



---

archive/issue_comments_038830.json:
```json
{
    "body": "draft for the future patch",
    "created_at": "2009-01-15T01:43:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4974",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4974#issuecomment-38830",
    "user": "https://trac.sagemath.org/admin/accounts/users/ylchapuy"
}
```

draft for the future patch



---

archive/issue_comments_038831.json:
```json
{
    "body": "<a id='comment:12'></a>Attachment [normalize_slice.draft](tarball://root/attachments/some-uuid/ticket4974/normalize_slice.draft) by ylchapuy created at 2009-01-15 01:44:07\n\nI have no clean install of sage to do the real patch, but I hope it helps...",
    "created_at": "2009-01-15T01:44:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4974",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4974#issuecomment-38831",
    "user": "https://trac.sagemath.org/admin/accounts/users/ylchapuy"
}
```

<a id='comment:12'></a>Attachment [normalize_slice.draft](tarball://root/attachments/some-uuid/ticket4974/normalize_slice.draft) by ylchapuy created at 2009-01-15 01:44:07

I have no clean install of sage to do the real patch, but I hope it helps...



---

archive/issue_comments_038832.json:
```json
{
    "body": "<a id='comment:13'></a>ylchapuy: nice.  I like how you avoided the redundant comparisons in my code.  \n\nIn scanning through your code, it has a few places where the stuff following the +=size lines should be taken out of the body of the if statement and placed after the if statement instead.",
    "created_at": "2009-01-15T04:17:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4974",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4974#issuecomment-38832",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:13'></a>ylchapuy: nice.  I like how you avoided the redundant comparisons in my code.  

In scanning through your code, it has a few places where the stuff following the +=size lines should be taken out of the body of the if statement and placed after the if statement instead.



---

archive/issue_comments_038833.json:
```json
{
    "body": "<a id='comment:14'></a>Okay, I think this makes all of this work redundant.  Equivalent functionality (and mostly equivalent or faster times) are found in the implementation:\n\n```\nrange(*s.indices(size))\n```\n\nwhere s is the slice, size is the size of list.",
    "created_at": "2009-01-15T04:40:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4974",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4974#issuecomment-38833",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:14'></a>Okay, I think this makes all of this work redundant.  Equivalent functionality (and mostly equivalent or faster times) are found in the implementation:

```
range(*s.indices(size))
```

where s is the slice, size is the size of list.



---

archive/issue_comments_038834.json:
```json
{
    "body": "<a id='comment:15'></a>There are several nice things about the above.  First, python handles all of the weird corner cases so that everything is consistent.  Second, you can use xrange to get an iterator over the indices instead of the list.  Third, you avoid one more function call.",
    "created_at": "2009-01-15T04:43:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4974",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4974#issuecomment-38834",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:15'></a>There are several nice things about the above.  First, python handles all of the weird corner cases so that everything is consistent.  Second, you can use xrange to get an iterator over the indices instead of the list.  Third, you avoid one more function call.



---

archive/issue_comments_038835.json:
```json
{
    "body": "<a id='comment:16'></a>And fourth, it does more error checking than we were doing (dealing with unnecessarily large size, etc) ...\n\nI think we should do this. One question: should we keep all our doctests? It's like documentation for how you can use slices, which doesn't seem to appear elsewhere. :)",
    "created_at": "2009-01-15T04:46:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4974",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4974#issuecomment-38835",
    "user": "https://github.com/craigcitro"
}
```

<a id='comment:16'></a>And fourth, it does more error checking than we were doing (dealing with unnecessarily large size, etc) ...

I think we should do this. One question: should we keep all our doctests? It's like documentation for how you can use slices, which doesn't seem to appear elsewhere. :)



---

archive/issue_comments_038836.json:
```json
{
    "body": "Attachment [trac-4974.patch](tarball://root/attachments/some-uuid/ticket4974/trac-4974.patch) by @craigcitro created at 2009-01-15 05:50:38",
    "created_at": "2009-01-15T05:50:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4974",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4974#issuecomment-38836",
    "user": "https://github.com/craigcitro"
}
```

Attachment [trac-4974.patch](tarball://root/attachments/some-uuid/ticket4974/trac-4974.patch) by @craigcitro created at 2009-01-15 05:50:38



---

archive/issue_comments_038837.json:
```json
{
    "body": "<a id='comment:17'></a>What Jason says above is exactly right -- there's no point trying to outdo Python, because it already is quite fast, and does all this for us. Plus, we can't miss corner cases this way. \n\nUltimately, things could get faster with nice Cython support for slices. This isn't wildly pressing, but it should be easy to implement.\n\nApply only the newest `trac-4974.patch`. This patch simply removes `normalize_slice`.\n\nWe should make a note about using this for slices somewhere -- apparently, `range(*s.indices(size))` is a standard Python idiom (it's in **Python in a Nutshell**), so we should use it more.",
    "created_at": "2009-01-15T05:53:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4974",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4974#issuecomment-38837",
    "user": "https://github.com/craigcitro"
}
```

<a id='comment:17'></a>What Jason says above is exactly right -- there's no point trying to outdo Python, because it already is quite fast, and does all this for us. Plus, we can't miss corner cases this way. 

Ultimately, things could get faster with nice Cython support for slices. This isn't wildly pressing, but it should be easy to implement.

Apply only the newest `trac-4974.patch`. This patch simply removes `normalize_slice`.

We should make a note about using this for slices somewhere -- apparently, `range(*s.indices(size))` is a standard Python idiom (it's in **Python in a Nutshell**), so we should use it more.



---

archive/issue_comments_038838.json:
```json
{
    "body": "<a id='comment:18'></a>+1 to the code cruft removal and adoption of standard python constructs.  I'm opening another ticket to add information about slices to the developer guide.\n\nThis patch applies and doctests pass in the file.",
    "created_at": "2009-01-15T06:10:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4974",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4974#issuecomment-38838",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:18'></a>+1 to the code cruft removal and adoption of standard python constructs.  I'm opening another ticket to add information about slices to the developer guide.

This patch applies and doctests pass in the file.



---

archive/issue_events_011503.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2009-01-18T15:49:40Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/4974",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4974#event-11503"
}
```



---

archive/issue_comments_038839.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2009-01-18T15:49:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4974",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4974#issuecomment-38839",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

Resolution: fixed



---

archive/issue_comments_038840.json:
```json
{
    "body": "<a id='comment:19'></a>Merge trac-4974.patch in Sage 3.3.alpha0",
    "created_at": "2009-01-18T15:49:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4974",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4974#issuecomment-38840",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:19'></a>Merge trac-4974.patch in Sage 3.3.alpha0
