# Issue 4964: [with patch, with positive review] Add Weil pairing to Sage

archive/issues_004964.json:
```json
{
    "body": "Add at first (mollerhansen's) Weil pairing implementation on EC points and in this way laying out a framework for pairings in general. \n\nIn future: \n* this Weil pairing implementation should be replaced by a more effective implementation.\n* other pairings could be implemented/wrapped using same framework.\n\nAssignee: mollerhansen\n\nKeywords: pairing, elliptic curve\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/4964\n\n",
    "closed_at": "2009-02-08T02:00:54Z",
    "created_at": "2009-01-11T17:54:28Z",
    "labels": [
        "component: algebraic geometry",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-3.3",
    "title": "[with patch, with positive review] Add Weil pairing to Sage",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/4964",
    "user": "https://trac.sagemath.org/admin/accounts/users/dmhansen"
}
```
Add at first (mollerhansen's) Weil pairing implementation on EC points and in this way laying out a framework for pairings in general. 

In future: 
* this Weil pairing implementation should be replaced by a more effective implementation.
* other pairings could be implemented/wrapped using same framework.

Assignee: mollerhansen

Keywords: pairing, elliptic curve

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/4964





---

archive/issue_events_011472.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/dmhansen",
    "created_at": "2009-01-25T16:50:06Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/4964",
    "milestone": "sage-3.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4964#event-11472"
}
```



---

archive/issue_events_011473.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/dmhansen",
    "created_at": "2009-01-25T16:50:06Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/4964",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4964#event-11473"
}
```



---

archive/issue_comments_041008.json:
```json
{
    "body": "<a id='comment:1'></a>Have checked in patch for elliptic_points.py.\nDon't know how much of a framework there is yet.",
    "created_at": "2009-01-25T16:50:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4964",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4964#issuecomment-41008",
    "user": "https://trac.sagemath.org/admin/accounts/users/dmhansen"
}
```

<a id='comment:1'></a>Have checked in patch for elliptic_points.py.
Don't know how much of a framework there is yet.



---

archive/issue_comments_041009.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2009-01-25T16:50:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4964",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4964#issuecomment-41009",
    "user": "https://trac.sagemath.org/admin/accounts/users/dmhansen"
}
```

Resolution: fixed



---

archive/issue_comments_041010.json:
```json
{
    "body": "<a id='comment:2'></a>How can this ticket be closed when there is no patch here?  Is there a patch somewhere else?  If so, where?!",
    "created_at": "2009-01-25T17:35:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4964",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4964#issuecomment-41010",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:2'></a>How can this ticket be closed when there is no patch here?  Is there a patch somewhere else?  If so, where?!



---

archive/issue_comments_041011.json:
```json
{
    "body": "<a id='comment:3'></a>I am reopening this since David wrongly thought that committing his changes was all that was needed.  He will upload a patch sometime soon.",
    "created_at": "2009-01-25T18:25:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4964",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4964#issuecomment-41011",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:3'></a>I am reopening this since David wrongly thought that committing his changes was all that was needed.  He will upload a patch sometime soon.



---

archive/issue_comments_041012.json:
```json
{
    "body": "Resolution changed from fixed to ",
    "created_at": "2009-01-25T18:25:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4964",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4964#issuecomment-41012",
    "user": "https://github.com/JohnCremona"
}
```

Resolution changed from fixed to 



---

archive/issue_comments_041013.json:
```json
{
    "body": "Changing status from closed to reopened.",
    "created_at": "2009-01-25T18:25:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4964",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4964#issuecomment-41013",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from closed to reopened.



---

archive/issue_events_011474.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2009-01-25T18:25:09Z",
    "event": "reopened",
    "issue": "https://github.com/sagemath/sagetest/issues/4964",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4964#event-11474"
}
```



---

archive/issue_comments_041014.json:
```json
{
    "body": "Description changed:\n``````diff\n\n``````\n",
    "created_at": "2009-01-25T20:07:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4964",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4964#issuecomment-41014",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

Description changed:
``````diff

``````




---

archive/issue_comments_041015.json:
```json
{
    "body": "<a id='comment:6'></a>This looks pretty good to me though I have not done any detailed testing, I only looked at the code.\n\nI have one suggestion which should speed this up whenever the actual orders of P or Q are strictly less than n:  find the orders of P and Q, say m1 and m2.  (The generic function order_from_multiple might be useful here.)   Let d=gcd(m1,m2).  Then it is clear that the result is a d'th root of unity, and it can be computed by taking the pairing of (m1/d)*P and (m2/d)*Q.  [Proof: exercise.]  This would save a lot when d is much less than n.\n\nI also have a question: rather than wait for a division by zero error to catch dependent input, why not do a discrete log calculation to test this?  Maybe that's much slower for large n;  it would be nice to have this decision justified.\n\nSorry, that's all I have time for just now.",
    "created_at": "2009-01-25T22:26:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4964",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4964#issuecomment-41015",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:6'></a>This looks pretty good to me though I have not done any detailed testing, I only looked at the code.

I have one suggestion which should speed this up whenever the actual orders of P or Q are strictly less than n:  find the orders of P and Q, say m1 and m2.  (The generic function order_from_multiple might be useful here.)   Let d=gcd(m1,m2).  Then it is clear that the result is a d'th root of unity, and it can be computed by taking the pairing of (m1/d)*P and (m2/d)*Q.  [Proof: exercise.]  This would save a lot when d is much less than n.

I also have a question: rather than wait for a division by zero error to catch dependent input, why not do a discrete log calculation to test this?  Maybe that's much slower for large n;  it would be nice to have this decision justified.

Sorry, that's all I have time for just now.



---

archive/issue_comments_041016.json:
```json
{
    "body": "<a id='comment:7'></a>> I have one suggestion which should speed this up whenever the actual orders of P or Q are strictly less than n:  find the orders of P and Q, say m1 and m2.  (The generic function order_from_multiple might be useful here.)   Let d=gcd(m1,m2).  Then it is clear that the result is a d'th root of unity, and it can be computed by taking the pairing of (m1/d)*P and (m2/d)*Q.  [Proof: exercise.]  This would save a lot when d is much less than n.\n\n\nYes, I agree - for now the only thing implemented is for points of order n, I check that they both are of order n, which actually will take some time for large n. There is definitely room for improvement here! \n\n> I also have a question: rather than wait for a division by zero error to catch dependent input, why not do a discrete log calculation to test this?  Maybe that's much slower for large n;  it would be nice to have this decision justified.\n\n\nWell, it is much slower for large n to do discrete log computations. Wrt. to time complexity then I do not think we can do better since the miller algorithm runs in linear time in the number of bits in the input n.\n\nYou're right the above argument should be noted in the code.\n\nReplying to [comment:6 cremona]:\n> This looks pretty good to me though I have not done any detailed testing, I only looked at the code.\n> \n> I have one suggestion which should speed this up whenever the actual orders of P or Q are strictly less than n:  find the orders of P and Q, say m1 and m2.  (The generic function order_from_multiple might be useful here.)   Let d=gcd(m1,m2).  Then it is clear that the result is a d'th root of unity, and it can be computed by taking the pairing of (m1/d)*P and (m2/d)*Q.  [Proof: exercise.]  This would save a lot when d is much less than n.\n> \n> I also have a question: rather than wait for a division by zero error to catch dependent input, why not do a discrete log calculation to test this?  Maybe that's much slower for large n;  it would be nice to have this decision justified.\n> \n> Sorry, that's all I have time for just now.",
    "created_at": "2009-01-25T22:47:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4964",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4964#issuecomment-41016",
    "user": "https://trac.sagemath.org/admin/accounts/users/dmhansen"
}
```

<a id='comment:7'></a>> I have one suggestion which should speed this up whenever the actual orders of P or Q are strictly less than n:  find the orders of P and Q, say m1 and m2.  (The generic function order_from_multiple might be useful here.)   Let d=gcd(m1,m2).  Then it is clear that the result is a d'th root of unity, and it can be computed by taking the pairing of (m1/d)*P and (m2/d)*Q.  [Proof: exercise.]  This would save a lot when d is much less than n.


Yes, I agree - for now the only thing implemented is for points of order n, I check that they both are of order n, which actually will take some time for large n. There is definitely room for improvement here! 

> I also have a question: rather than wait for a division by zero error to catch dependent input, why not do a discrete log calculation to test this?  Maybe that's much slower for large n;  it would be nice to have this decision justified.


Well, it is much slower for large n to do discrete log computations. Wrt. to time complexity then I do not think we can do better since the miller algorithm runs in linear time in the number of bits in the input n.

You're right the above argument should be noted in the code.

Replying to [comment:6 cremona]:
> This looks pretty good to me though I have not done any detailed testing, I only looked at the code.
> 
> I have one suggestion which should speed this up whenever the actual orders of P or Q are strictly less than n:  find the orders of P and Q, say m1 and m2.  (The generic function order_from_multiple might be useful here.)   Let d=gcd(m1,m2).  Then it is clear that the result is a d'th root of unity, and it can be computed by taking the pairing of (m1/d)*P and (m2/d)*Q.  [Proof: exercise.]  This would save a lot when d is much less than n.
> 
> I also have a question: rather than wait for a division by zero error to catch dependent input, why not do a discrete log calculation to test this?  Maybe that's much slower for large n;  it would be nice to have this decision justified.
> 
> Sorry, that's all I have time for just now.



---

archive/issue_comments_041017.json:
```json
{
    "body": "<a id='comment:8'></a>I succesfully applied the patch to 3.3.alpha3 and the doctests pass.  But the first example I tried crashed:\n\n```\nsage: F.<a>=GF(19^4)\nsage: E=EllipticCurve(F,[-1,0])\nsage: P,Q=E.gens()\nsage: P.order(), Q.order()\n(360, 360)\n# Check that P and Q really are independent:\nsage: linear_relation(P,Q,'+')\n(0, 360)\nsage: P.weil_pairing(Q,360)\n---------------------------------------------------------------------------\nPariError                                 Traceback (most recent call last)\n...\nPariError: impossible inverse modulo:  (36)\n```\nSo pari (which does the underlying field arithmetic) has tried to divide by zero.\n\nThe comments in the code suggest that (1) run-time errors only happen when the points are independent, and (2) these are caught.  So here is a counterexample to both.\n\nIs there a typo in the code perhaps?",
    "created_at": "2009-02-01T18:25:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4964",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4964#issuecomment-41017",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:8'></a>I succesfully applied the patch to 3.3.alpha3 and the doctests pass.  But the first example I tried crashed:

```
sage: F.<a>=GF(19^4)
sage: E=EllipticCurve(F,[-1,0])
sage: P,Q=E.gens()
sage: P.order(), Q.order()
(360, 360)
# Check that P and Q really are independent:
sage: linear_relation(P,Q,'+')
(0, 360)
sage: P.weil_pairing(Q,360)
---------------------------------------------------------------------------
PariError                                 Traceback (most recent call last)
...
PariError: impossible inverse modulo:  (36)
```
So pari (which does the underlying field arithmetic) has tried to divide by zero.

The comments in the code suggest that (1) run-time errors only happen when the points are independent, and (2) these are caught.  So here is a counterexample to both.

Is there a typo in the code perhaps?



---

archive/issue_comments_041018.json:
```json
{
    "body": "<a id='comment:9'></a>> Is there a typo in the code perhaps?\n\n\nWell, I kinda hope that there is, since otherwise it would be a larger problem. \nDebugging time! I'll try to figure it out, then i'll put up a new patch and notify you. Thanks for your review.",
    "created_at": "2009-02-01T19:21:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4964",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4964#issuecomment-41018",
    "user": "https://trac.sagemath.org/admin/accounts/users/dmhansen"
}
```

<a id='comment:9'></a>> Is there a typo in the code perhaps?


Well, I kinda hope that there is, since otherwise it would be a larger problem. 
Debugging time! I'll try to figure it out, then i'll put up a new patch and notify you. Thanks for your review.



---

archive/issue_comments_041019.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:9 dmhansen]:\n> > Is there a typo in the code perhaps?\n\n> \n> Well, I kinda hope that there is, since otherwise it would be a larger problem. \n> Debugging time! I'll try to figure it out, then i'll put up a new patch and notify you. Thanks for your review.\n\n\nI cannot see the problem myself.  The _line_() code looks fine.  _miller_() looks good, and when the points are independent I don't see how you would ever get 0 from one of the _line() calls.  [One piece of debugging would be to make sure that _line_() never returns zero, perhaps).\n\nTwo more comments:  in _miller_(), you should perhaps initialize t to self.base_ring()(1) and not just 1.  Secondly, this code would apply just as well to points of finite order over any field, so you should move the whole block of code so that the functions are members of EllipticCurvePoint_field and not of the sub-class EllipticCurvePoint_finite_field.",
    "created_at": "2009-02-01T20:31:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4964",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4964#issuecomment-41019",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:10'></a>Replying to [comment:9 dmhansen]:
> > Is there a typo in the code perhaps?

> 
> Well, I kinda hope that there is, since otherwise it would be a larger problem. 
> Debugging time! I'll try to figure it out, then i'll put up a new patch and notify you. Thanks for your review.


I cannot see the problem myself.  The _line_() code looks fine.  _miller_() looks good, and when the points are independent I don't see how you would ever get 0 from one of the _line() calls.  [One piece of debugging would be to make sure that _line_() never returns zero, perhaps).

Two more comments:  in _miller_(), you should perhaps initialize t to self.base_ring()(1) and not just 1.  Secondly, this code would apply just as well to points of finite order over any field, so you should move the whole block of code so that the functions are members of EllipticCurvePoint_field and not of the sub-class EllipticCurvePoint_finite_field.



---

archive/issue_comments_041020.json:
```json
{
    "body": "<a id='comment:11'></a>> I cannot see the problem myself.  The _line_() code looks fine.  _miller_() looks good, and when the points are independent I don't see how you would ever get 0 from one of the _line() calls.  [One piece of debugging would be to make sure that _line_() never returns zero, perhaps).\n\n\nThere was definetly a zero division when computing the slope in case P=Q\\neqO in the _line_ function. Problem was that after refactoring my own code and putting it nicely into sage I forgot the subcase P=Q\\neqO x1=x2. So the zero came from the vertical slope not being handled seperatly.\n\nI then tried your test and I wondered why \n\n```\nsage: P.weil_pairing(Q,360).multiplicative_order()\n181\nsage: P.order()\n360\nsage: 180*P\n(0 : 0 : 1)\n```\nI will make a bug report on it. \n\n> Two more comments:  in _miller_(), you should perhaps initialize t to self.base_ring()(1) and not just 1.  Secondly, this code would apply just as well to points of finite order over any field, so you should move the whole block of code so that the functions are members of EllipticCurvePoint_field and not of the sub-class EllipticCurvePoint_finite_field.\n\n\nI think I will do this in the next iteration together with your suggestion on saving time by precomputing the d=gcd(m1,m2) and doing the pairing of (m1/d)*P and (m2/d)*Q. I'm a bit pressured on time this month and I think that the next iteration will require some more extensive tests.",
    "created_at": "2009-02-06T10:19:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4964",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4964#issuecomment-41020",
    "user": "https://trac.sagemath.org/admin/accounts/users/dmhansen"
}
```

<a id='comment:11'></a>> I cannot see the problem myself.  The _line_() code looks fine.  _miller_() looks good, and when the points are independent I don't see how you would ever get 0 from one of the _line() calls.  [One piece of debugging would be to make sure that _line_() never returns zero, perhaps).


There was definetly a zero division when computing the slope in case P=Q\neqO in the _line_ function. Problem was that after refactoring my own code and putting it nicely into sage I forgot the subcase P=Q\neqO x1=x2. So the zero came from the vertical slope not being handled seperatly.

I then tried your test and I wondered why 

```
sage: P.weil_pairing(Q,360).multiplicative_order()
181
sage: P.order()
360
sage: 180*P
(0 : 0 : 1)
```
I will make a bug report on it. 

> Two more comments:  in _miller_(), you should perhaps initialize t to self.base_ring()(1) and not just 1.  Secondly, this code would apply just as well to points of finite order over any field, so you should move the whole block of code so that the functions are members of EllipticCurvePoint_field and not of the sub-class EllipticCurvePoint_finite_field.


I think I will do this in the next iteration together with your suggestion on saving time by precomputing the d=gcd(m1,m2) and doing the pairing of (m1/d)*P and (m2/d)*Q. I'm a bit pressured on time this month and I think that the next iteration will require some more extensive tests.



---

archive/issue_comments_041021.json:
```json
{
    "body": "<a id='comment:12'></a>> I will make a bug report on it. \n\n\nNo I won't. The sage output is ok. \nSorry it's a bit early in the morning. weil pairing result must then be wrong.. Think it's a bit to early in the morning to be doing this.",
    "created_at": "2009-02-06T10:28:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4964",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4964#issuecomment-41021",
    "user": "https://trac.sagemath.org/admin/accounts/users/dmhansen"
}
```

<a id='comment:12'></a>> I will make a bug report on it. 


No I won't. The sage output is ok. 
Sorry it's a bit early in the morning. weil pairing result must then be wrong.. Think it's a bit to early in the morning to be doing this.



---

archive/issue_comments_041022.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:12 dmhansen]:\n> > I will make a bug report on it. \n\n> \n> No I won't. The sage output is ok. \n> Sorry it's a bit early in the morning. weil pairing result must then be wrong.. Think it's a bit to early in the morning to be doing this.\n\n\nAgreed: (0:0:1) has order 2, so that's consistent!  john",
    "created_at": "2009-02-06T10:31:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4964",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4964#issuecomment-41022",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:13'></a>Replying to [comment:12 dmhansen]:
> > I will make a bug report on it. 

> 
> No I won't. The sage output is ok. 
> Sorry it's a bit early in the morning. weil pairing result must then be wrong.. Think it's a bit to early in the morning to be doing this.


Agreed: (0:0:1) has order 2, so that's consistent!  john



---

archive/issue_comments_041023.json:
```json
{
    "body": "Attachment [trac_4964.patch](tarball://root/attachments/some-uuid/ticket4964/trac_4964.patch) by dmhansen created at 2009-02-06 14:16:56\n\nSage Version 3.2.3, Release Date: 2009-01-05",
    "created_at": "2009-02-06T14:16:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4964",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4964#issuecomment-41023",
    "user": "https://trac.sagemath.org/admin/accounts/users/dmhansen"
}
```

Attachment [trac_4964.patch](tarball://root/attachments/some-uuid/ticket4964/trac_4964.patch) by dmhansen created at 2009-02-06 14:16:56

Sage Version 3.2.3, Release Date: 2009-01-05



---

archive/issue_comments_041024.json:
```json
{
    "body": "<a id='comment:14'></a>New patch is up. I kept the pairing down in the ElliptiCurvePoint_finite_field class. In future this should be moved up into more general class with possible improvements noted in the above comments. Also the Modified Tate pairing, should be fairly straight forward to implement now.",
    "created_at": "2009-02-06T14:21:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4964",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4964#issuecomment-41024",
    "user": "https://trac.sagemath.org/admin/accounts/users/dmhansen"
}
```

<a id='comment:14'></a>New patch is up. I kept the pairing down in the ElliptiCurvePoint_finite_field class. In future this should be moved up into more general class with possible improvements noted in the above comments. Also the Modified Tate pairing, should be fairly straight forward to implement now.



---

archive/issue_comments_041025.json:
```json
{
    "body": "<a id='comment:17'></a>Attachment [trac_4964a.patch](tarball://root/attachments/some-uuid/ticket4964/trac_4964a.patch) by @JohnCremona created at 2009-02-07 15:42:40\n\nThe revised patch fixes the bug.  I have taken the liberty of adding my patch trac_4964a.patch (to be applied after trac_4964.patch) which does the following:\n\n1. Adds a doctest to show that the bug I reported is fixed.\n2.  Moves the functions to the class EllipticCurvePoint_field, as I originally suggested, since this works perfectly well!\n3. Illustrate my point in 2 by adding a docest computing a 5th order Weil pairing over the 5th cyclotomic field.\n4. Edited the documentation about the implementation only applying when both points have the same order n, since in fact the only condition is that n*P=n*Q=0, i.e. that they are both in E[n], so the function could be applied to any two torsion points provided that n is a common multiple of their orders.\n\nIf dmhansen is happy with these adjustments then I am happy with the (combined) patch, so I am optimistically giving it a positive review.  Ideally, a 3rd party would take a look too.",
    "created_at": "2009-02-07T15:42:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4964",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4964#issuecomment-41025",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:17'></a>Attachment [trac_4964a.patch](tarball://root/attachments/some-uuid/ticket4964/trac_4964a.patch) by @JohnCremona created at 2009-02-07 15:42:40

The revised patch fixes the bug.  I have taken the liberty of adding my patch trac_4964a.patch (to be applied after trac_4964.patch) which does the following:

1. Adds a doctest to show that the bug I reported is fixed.
2.  Moves the functions to the class EllipticCurvePoint_field, as I originally suggested, since this works perfectly well!
3. Illustrate my point in 2 by adding a docest computing a 5th order Weil pairing over the 5th cyclotomic field.
4. Edited the documentation about the implementation only applying when both points have the same order n, since in fact the only condition is that n*P=n*Q=0, i.e. that they are both in E[n], so the function could be applied to any two torsion points provided that n is a common multiple of their orders.

If dmhansen is happy with these adjustments then I am happy with the (combined) patch, so I am optimistically giving it a positive review.  Ideally, a 3rd party would take a look too.



---

archive/issue_events_011475.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2009-02-07T15:42:40Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/4964",
    "milestone": "sage-3.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4964#event-11475"
}
```



---

archive/issue_events_011476.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2009-02-07T15:42:40Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/4964",
    "milestone": "sage-3.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4964#event-11476"
}
```



---

archive/issue_comments_041026.json:
```json
{
    "body": "<a id='comment:18'></a>>    1. Adds a doctest to show that the bug I reported is fixed.\n\n\n- Great! I also made a similar doc test using your example to test the _miller_ unction implementation, so now we should be covered.\n\n>    2.  Moves the functions to the class EllipticCurvePoint_field, as I originally suggested, since this works perfectly well!\n>    3. Illustrate my point in 2 by adding a docest computing a 5th order Weil pairing over the 5th cyclotomic field.\n\n\n- This is really good. Thank you a lot, really cool that it just generalizes without any problems. \n\n>    4. Edited the documentation about the implementation only applying when both points have the same order n, since in fact the only condition is that n*P=n*Q=0, i.e. that they are both in E[n], so the function could be applied to any two torsion points provided that n is a common multiple of their orders.\n\n\n- I agree. That's an important point to include. \n\n> If dmhansen is happy with these adjustments then I am happy with the (combined) patch, so I am optimistically giving it a positive review.  Ideally, a 3rd party would take a look too.\n\n\nI am very happy with the changes and yes it would be nice to get a 3rd party review.",
    "created_at": "2009-02-07T16:02:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4964",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4964#issuecomment-41026",
    "user": "https://trac.sagemath.org/admin/accounts/users/dmhansen"
}
```

<a id='comment:18'></a>>    1. Adds a doctest to show that the bug I reported is fixed.


- Great! I also made a similar doc test using your example to test the _miller_ unction implementation, so now we should be covered.

>    2.  Moves the functions to the class EllipticCurvePoint_field, as I originally suggested, since this works perfectly well!
>    3. Illustrate my point in 2 by adding a docest computing a 5th order Weil pairing over the 5th cyclotomic field.


- This is really good. Thank you a lot, really cool that it just generalizes without any problems. 

>    4. Edited the documentation about the implementation only applying when both points have the same order n, since in fact the only condition is that n*P=n*Q=0, i.e. that they are both in E[n], so the function could be applied to any two torsion points provided that n is a common multiple of their orders.


- I agree. That's an important point to include. 

> If dmhansen is happy with these adjustments then I am happy with the (combined) patch, so I am optimistically giving it a positive review.  Ideally, a 3rd party would take a look too.


I am very happy with the changes and yes it would be nice to get a 3rd party review.



---

archive/issue_comments_041027.json:
```json
{
    "body": "Attachment [trac_4964b.patch](tarball://root/attachments/some-uuid/ticket4964/trac_4964b.patch) by @JohnCremona created at 2009-02-07 17:17:05\n\nApply after previous two.",
    "created_at": "2009-02-07T17:17:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4964",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4964#issuecomment-41027",
    "user": "https://github.com/JohnCremona"
}
```

Attachment [trac_4964b.patch](tarball://root/attachments/some-uuid/ticket4964/trac_4964b.patch) by @JohnCremona created at 2009-02-07 17:17:05

Apply after previous two.



---

archive/issue_comments_041028.json:
```json
{
    "body": "<a id='comment:19'></a>Thanks.  Encouraged, I added the other thing which I suggested earlier, which ensures that the hard computation (of the Miller functions) is only done to order gcd(|P|,|Q|).  In case the orders of P and Q are not known, it computes the order using the information that it divides n (otherwise it would use the group order, but that might be a lot larger than n).  Some testing showed that this did speed up the function.\n\nI'm asking for a new reviewer on sage-nt now.",
    "created_at": "2009-02-07T17:17:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4964",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4964#issuecomment-41028",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:19'></a>Thanks.  Encouraged, I added the other thing which I suggested earlier, which ensures that the hard computation (of the Miller functions) is only done to order gcd(|P|,|Q|).  In case the orders of P and Q are not known, it computes the order using the information that it divides n (otherwise it would use the group order, but that might be a lot larger than n).  Some testing showed that this did speed up the function.

I'm asking for a new reviewer on sage-nt now.



---

archive/issue_comments_041029.json:
```json
{
    "body": "<a id='comment:20'></a>Merged all three patches in Sage 3.3.alpha6. Doctests do pass, but if another reviewer looks at this again it would be good.\n\nCheers,\n\nMichael",
    "created_at": "2009-02-08T02:00:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4964",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4964#issuecomment-41029",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:20'></a>Merged all three patches in Sage 3.3.alpha6. Doctests do pass, but if another reviewer looks at this again it would be good.

Cheers,

Michael



---

archive/issue_events_011477.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2009-02-08T02:00:54Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/4964",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4964#event-11477"
}
```



---

archive/issue_comments_041030.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2009-02-08T02:00:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4964",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4964#issuecomment-41030",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

Resolution: fixed



---

archive/issue_comments_041031.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [comment:20 mabshoff]:\n> Merged all three patches in Sage 3.3.alpha6. Doctests do pass, but if another reviewer looks at this again it would be good.\n> \n> Cheers,\n> \n> Michael\n\n\nThanks, Michael!  John",
    "created_at": "2009-02-08T10:16:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4964",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4964#issuecomment-41031",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:21'></a>Replying to [comment:20 mabshoff]:
> Merged all three patches in Sage 3.3.alpha6. Doctests do pass, but if another reviewer looks at this again it would be good.
> 
> Cheers,
> 
> Michael


Thanks, Michael!  John
