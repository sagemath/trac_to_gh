# Issue 4975: Sage 3.2.2 chokes on utf-8 encoded files

archive/issues_004975.json:
```json
{
    "assignees": [
        "https://github.com/mwhansen"
    ],
    "body": "I just downloaded sage 3.2.2 and found it to choke on utf-8 encoded source files (for comparison, sage 3.0 handles them properly). My bet is that some problem happened during integration of issue 2637. Tested using sage-3.2.2-ubuntu32bit-intel-i686-Linux binary distribution.\n\nTake the file like:\n\n```\n# -*- coding: utf-8 -*-\n\n\"\"\"\nZa\u017c\u00f3\u0142\u0107 g\u0119\u015bl\u0105 ja\u017a\u0144\n\"\"\"\n\nprint 1\n```\n\nand try:\n\n```\n$ sage test.sage\n```\n\nResult:\n\n```\n  File \"test.py\", line 6\nSyntaxError: Non-ASCII character '\\xc5' in file test.py on line 7, but no encoding declared; see http://www.python.org/peps/pep-0263.html for details\n```\n\nProduced file:\n\n```\n# This file was *autogenerated* from the file test.sage.\nfrom sage.all_cmdline import *   # import sage library\n_sage_const_1 = Integer(Integer(1))# -*- coding: utf-8 -*-\n\n\"\"\"\nZa\u017c\u00f3\u0142\u0107 g\u0119\u015bl\u0105 ja\u017a\u0144\n\"\"\"\n\nprint _sage_const_1\n```\n\nComponent: **user interface**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/4975_\n\n",
    "closed_at": "2009-01-19T11:05:12Z",
    "created_at": "2009-01-14T17:03:31Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20user%20interface",
        "https://github.com/sagemath/sage/labels/p%3A%20critical%20/%202",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-3.3",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Sage 3.2.2 chokes on utf-8 encoded files",
    "type": "issue",
    "updated_at": "2009-01-19T11:09:36Z",
    "url": "https://github.com/sagemath/sage/issues/4975",
    "user": "https://github.com/sagetrac-mkasperski"
}
```
I just downloaded sage 3.2.2 and found it to choke on utf-8 encoded source files (for comparison, sage 3.0 handles them properly). My bet is that some problem happened during integration of issue 2637. Tested using sage-3.2.2-ubuntu32bit-intel-i686-Linux binary distribution.

Take the file like:

```
# -*- coding: utf-8 -*-

"""
Zażółć gęślą jaźń
"""

print 1
```

and try:

```
$ sage test.sage
```

Result:

```
  File "test.py", line 6
SyntaxError: Non-ASCII character '\xc5' in file test.py on line 7, but no encoding declared; see http://www.python.org/peps/pep-0263.html for details
```

Produced file:

```
# This file was *autogenerated* from the file test.sage.
from sage.all_cmdline import *   # import sage library
_sage_const_1 = Integer(Integer(1))# -*- coding: utf-8 -*-

"""
Zażółć gęślą jaźń
"""

print _sage_const_1
```

Component: **user interface**

_Issue created by migration from https://trac.sagemath.org/ticket/4975_





---

archive/issue_events_057233.json:
```json
{
    "actor": "https://github.com/sagetrac-mkasperski",
    "created_at": "2009-01-14T17:03:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20user%20interface",
    "label_color": "0000b0",
    "label_name": "c: user interface",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4975#event-57233"
}
```



---

archive/issue_events_057234.json:
```json
{
    "actor": "https://github.com/sagetrac-mkasperski",
    "created_at": "2009-01-14T17:03:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20minor%20/%204",
    "label_color": "ffe799",
    "label_name": "p: minor / 4",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4975#event-57234"
}
```



---

archive/issue_events_057235.json:
```json
{
    "actor": "https://github.com/sagetrac-mkasperski",
    "created_at": "2009-01-14T17:03:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4975#event-57235"
}
```



---

archive/issue_events_057236.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-01-14T17:03:31Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "subject": "https://github.com/sagetrac-mkasperski",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4975#event-57236"
}
```



---

archive/issue_events_057237.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-01-15T02:01:55Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "milestone_number": null,
    "milestone_title": "sage-3.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4975#event-57237"
}
```



---

archive/issue_events_057238.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-01-15T02:01:55Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20minor%20/%204",
    "label_color": "ffe799",
    "label_name": "p: minor / 4",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4975#event-57238"
}
```



---

archive/issue_events_057239.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-01-15T02:01:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20critical%20/%202",
    "label_color": "ff7700",
    "label_name": "p: critical / 2",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4975#event-57239"
}
```



---

archive/issue_comments_030252.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nAttachment: **[trac_4975.patch.gz](https://github.com/sagemath/sage/files/ticket4975/trac_4975.patch.gz)**\n\nI've attached a patch for the scripts directory which fixes this.",
    "created_at": "2009-01-19T10:26:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4975#issuecomment-30252",
    "user": "https://github.com/mwhansen"
}
```

<div id="comment:2" align="right">comment:2</div>

Attachment: **[trac_4975.patch.gz](https://github.com/sagemath/sage/files/ticket4975/trac_4975.patch.gz)**

I've attached a patch for the scripts directory which fixes this.



---

archive/issue_events_057240.json:
```json
{
    "actor": "https://github.com/mwhansen",
    "created_at": "2009-01-19T10:26:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4975#event-57240"
}
```



---

archive/issue_events_057241.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-01-19T10:26:44Z",
    "event": "unassigned",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "subject": "https://github.com/mwhansen",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4975#event-57241"
}
```



---

archive/issue_events_057242.json:
```json
{
    "actor": "https://github.com/mwhansen",
    "created_at": "2009-01-19T10:26:44Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "subject": "https://github.com/mwhansen",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4975#event-57242"
}
```



---

archive/issue_comments_030253.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nNice fix. Positive review.\n\nWe might want to think about writing some tests for the various sage scripts, but this is not subject to this ticket.\n\nCheers,\n\nMichael",
    "created_at": "2009-01-19T10:39:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4975#issuecomment-30253",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:3" align="right">comment:3</div>

Nice fix. Positive review.

We might want to think about writing some tests for the various sage scripts, but this is not subject to this ticket.

Cheers,

Michael



---

archive/issue_events_057243.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-01-19T10:39:09Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4975#event-57243"
}
```



---

archive/issue_events_057244.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-01-19T10:39:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4975#event-57244"
}
```



---

archive/issue_comments_030254.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nMerged in Sage 3.3.alpha0",
    "created_at": "2009-01-19T10:39:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4975#issuecomment-30254",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:4" align="right">comment:4</div>

Merged in Sage 3.3.alpha0



---

archive/issue_events_057245.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-01-19T10:39:23Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4975#event-57245"
}
```



---

archive/issue_events_057246.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-01-19T10:39:23Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4975#event-57246"
}
```



---

archive/issue_events_057247.json:
```json
{
    "actor": "https://github.com/sagetrac-mkasperski",
    "created_at": "2009-01-19T10:52:44Z",
    "event": "reopened",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4975#event-57247"
}
```



---

archive/issue_comments_030255.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nI can confirm that applying this patch on 3.2.2 resolves the problem I initially reported\n(cd ..../sage-3.2.2-ubuntu32bit-intel-i686-Linux/local/bin;\n patch -p1 < .../trac_4975.patch)\n\nStill, something is wrong. The following file is handled properly:\n\n```\n# -*- coding: utf-8 -*-\n\n\"\"\"\nZa\u017c\u00f3\u0142\u0107 g\u0119\u015bl\u0105 ja\u017a\u0144\n\"\"\"\n\nprint 1\nprint u\"Za\u017c\u00f3\u0142\u0107 g\u0119\u015bl\u0105 ja\u017a\u0144\"\n```\n\nbut if you comment out `print 1`:\n\n```\n# -*- coding: utf-8 -*-\n\n\"\"\"\nZa\u017c\u00f3\u0142\u0107 g\u0119\u015bl\u0105 ja\u017a\u0144\"\n\"\"\"\n\nprint u\"Za\u017c\u00f3\u0142\u0107 g\u0119\u015bl\u0105 ja\u017a\u0144\"\n```\n\nit fails again:\n\n```\nsage test2.sage\n  File \"test2.py\", line 3\nSyntaxError: Non-ASCII character '\\xc5' in file test2.py on line 4, but no encoding declared; see http://www.python.org/peps/pep-0263.html for details\n```\n\nWhat is interesting, removing any of elements (either a \"\"\" string, or print) makes the problem to disappear.\n\nHere is .py generated from the file above:\n\n```\n\n\"\"\"\nZa\u017c\u00f3\u0142\u0107 g\u0119\u015bl\u0105 ja\u017a\u0144\"\n\"\"\"\n# -*- coding: utf-8 -*-\n# This file was *autogenerated* from the file test2.sage.\nfrom sage.all_cmdline import *   # import sage library\n\nprint u\"Za\u017c\u00f3\u0142\u0107 g\u0119\u015bl\u0105 ja\u017a\u0144\"\n```",
    "created_at": "2009-01-19T10:52:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4975#issuecomment-30255",
    "user": "https://github.com/sagetrac-mkasperski"
}
```

<div id="comment:5" align="right">comment:5</div>

I can confirm that applying this patch on 3.2.2 resolves the problem I initially reported
(cd ..../sage-3.2.2-ubuntu32bit-intel-i686-Linux/local/bin;
 patch -p1 < .../trac_4975.patch)

Still, something is wrong. The following file is handled properly:

```
# -*- coding: utf-8 -*-

"""
Zażółć gęślą jaźń
"""

print 1
print u"Zażółć gęślą jaźń"
```

but if you comment out `print 1`:

```
# -*- coding: utf-8 -*-

"""
Zażółć gęślą jaźń"
"""

print u"Zażółć gęślą jaźń"
```

it fails again:

```
sage test2.sage
  File "test2.py", line 3
SyntaxError: Non-ASCII character '\xc5' in file test2.py on line 4, but no encoding declared; see http://www.python.org/peps/pep-0263.html for details
```

What is interesting, removing any of elements (either a """ string, or print) makes the problem to disappear.

Here is .py generated from the file above:

```

"""
Zażółć gęślą jaźń"
"""
# -*- coding: utf-8 -*-
# This file was *autogenerated* from the file test2.sage.
from sage.all_cmdline import *   # import sage library

print u"Zażółć gęślą jaźń"
```



---

archive/issue_comments_030256.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nHaving taken a look at the source, it seems that the problem happens here:\n\n```\n    insert = '%s%s%s.\\nfrom sage.all_cmdline import *   # import sage library\\n'%(coding, AUTOGEN_MSG, f)\n    i = find_position_right_after_module_docstring(G)\n    G = G[:i] + insert + G[i:]\n```\n\nas you see, if sage detects module docstring, it adds coding AFTER IT",
    "created_at": "2009-01-19T10:57:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4975#issuecomment-30256",
    "user": "https://github.com/sagetrac-mkasperski"
}
```

<div id="comment:6" align="right">comment:6</div>

Having taken a look at the source, it seems that the problem happens here:

```
    insert = '%s%s%s.\nfrom sage.all_cmdline import *   # import sage library\n'%(coding, AUTOGEN_MSG, f)
    i = find_position_right_after_module_docstring(G)
    G = G[:i] + insert + G[i:]
```

as you see, if sage detects module docstring, it adds coding AFTER IT



---

archive/issue_comments_030257.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nAnd here is how I would rewrite those lines:\n\n```\n    if coding:\n       G = coding + G\n    insert = '%s%s.\\nfrom sage.all_cmdline import *   # import sage library\\n'%(AUTOGEN_MSG, f)\n    i = find_position_right_after_module_docstring(G)\n    G = G[:i] + insert + G[i:]\n```\n\n(sorry for no formal patch but I am not sure against what to make it)",
    "created_at": "2009-01-19T10:59:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4975#issuecomment-30257",
    "user": "https://github.com/sagetrac-mkasperski"
}
```

<div id="comment:7" align="right">comment:7</div>

And here is how I would rewrite those lines:

```
    if coding:
       G = coding + G
    insert = '%s%s.\nfrom sage.all_cmdline import *   # import sage library\n'%(AUTOGEN_MSG, f)
    i = find_position_right_after_module_docstring(G)
    G = G[:i] + insert + G[i:]
```

(sorry for no formal patch but I am not sure against what to make it)



---

archive/issue_comments_030258.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nAttachment: **[trac_4975-2.patch.gz](https://github.com/sagemath/sage/files/ticket4975/trac_4975-2.patch.gz)**\n\nHeh, I didn't even notice that line :-)  I put up a patch which applies on top of the last one.",
    "created_at": "2009-01-19T11:01:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4975#issuecomment-30258",
    "user": "https://github.com/mwhansen"
}
```

<div id="comment:8" align="right">comment:8</div>

Attachment: **[trac_4975-2.patch.gz](https://github.com/sagemath/sage/files/ticket4975/trac_4975-2.patch.gz)**

Heh, I didn't even notice that line :-)  I put up a patch which applies on top of the last one.



---

archive/issue_comments_030259.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nPlease do not reopen merged tickets. The issue you reported has been fixed. If you found more problems these will be addressed via the new ticket.\n\nCheers,\n\nMichael",
    "created_at": "2009-01-19T11:05:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4975#issuecomment-30259",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:9" align="right">comment:9</div>

Please do not reopen merged tickets. The issue you reported has been fixed. If you found more problems these will be addressed via the new ticket.

Cheers,

Michael



---

archive/issue_events_057248.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-01-19T11:05:12Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4975#event-57248"
}
```



---

archive/issue_comments_030260.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nOops, I missed a couple of the last messages and I will apply Mike's second patch. But my remark still applies.\n\nCheers,\n\nMichael",
    "created_at": "2009-01-19T11:06:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4975#issuecomment-30260",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:10" align="right">comment:10</div>

Oops, I missed a couple of the last messages and I will apply Mike's second patch. But my remark still applies.

Cheers,

Michael



---

archive/issue_comments_030261.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nMerged trac_4975-2.patch in Sage 3.3.alpha0.\n\nCheers,\n\nMichael",
    "created_at": "2009-01-19T11:09:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4975#issuecomment-30261",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:11" align="right">comment:11</div>

Merged trac_4975-2.patch in Sage 3.3.alpha0.

Cheers,

Michael
