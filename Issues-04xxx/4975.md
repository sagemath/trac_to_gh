# Issue 4975: Sage 3.2.2 chokes on utf-8 encoded files

archive/issues_004975.json:
```json
{
    "assignees": [],
    "body": "I just downloaded sage 3.2.2 and found it to choke on utf-8 encoded source files (for comparison, sage 3.0 handles them properly). My bet is that some problem happened during integration of issue 2637. Tested using sage-3.2.2-ubuntu32bit-intel-i686-Linux binary distribution.\n\nTake the file like:\n\n```\n# -*- coding: utf-8 -*-\n\n\"\"\"\nZa\u017c\u00f3\u0142\u0107 g\u0119\u015bl\u0105 ja\u017a\u0144\n\"\"\"\n\nprint 1\n```\n\nand try:\n\n```\n$ sage test.sage\n```\n\nResult:\n\n```\n  File \"test.py\", line 6\nSyntaxError: Non-ASCII character '\\xc5' in file test.py on line 7, but no encoding declared; see http://www.python.org/peps/pep-0263.html for details\n```\n\nProduced file:\n\n```\n# This file was *autogenerated* from the file test.sage.\nfrom sage.all_cmdline import *   # import sage library\n_sage_const_1 = Integer(Integer(1))# -*- coding: utf-8 -*-\n\n\"\"\"\nZa\u017c\u00f3\u0142\u0107 g\u0119\u015bl\u0105 ja\u017a\u0144\n\"\"\"\n\nprint _sage_const_1\n```\n\nAssignee: **@mwhansen**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/4975_\n\n",
    "closed_at": "2009-01-19T11:05:12Z",
    "created_at": "2009-01-14T17:03:31Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20user%20interface",
        "https://github.com/sagemath/sage/labels/p2%20%E2%80%93%20critical",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-3.3",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Sage 3.2.2 chokes on utf-8 encoded files",
    "type": "issue",
    "updated_at": "2009-01-19T11:09:36Z",
    "url": "https://github.com/sagemath/sage/issues/4975",
    "user": "https://github.com/sagetrac-mkasperski"
}
```
I just downloaded sage 3.2.2 and found it to choke on utf-8 encoded source files (for comparison, sage 3.0 handles them properly). My bet is that some problem happened during integration of issue 2637. Tested using sage-3.2.2-ubuntu32bit-intel-i686-Linux binary distribution.

Take the file like:

```
# -*- coding: utf-8 -*-

"""
Zażółć gęślą jaźń
"""

print 1
```

and try:

```
$ sage test.sage
```

Result:

```
  File "test.py", line 6
SyntaxError: Non-ASCII character '\xc5' in file test.py on line 7, but no encoding declared; see http://www.python.org/peps/pep-0263.html for details
```

Produced file:

```
# This file was *autogenerated* from the file test.sage.
from sage.all_cmdline import *   # import sage library
_sage_const_1 = Integer(Integer(1))# -*- coding: utf-8 -*-

"""
Zażółć gęślą jaźń
"""

print _sage_const_1
```

Assignee: **@mwhansen**

_Issue created by migration from https://trac.sagemath.org/ticket/4975_





---

archive/issue_events_051677.json:
```json
{
    "actor": "https://github.com/sagetrac-mkasperski",
    "created_at": "2009-01-14T17:03:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20user%20interface",
    "label_color": "000080",
    "label_name": "component: user interface",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4975#event-51677"
}
```



---

archive/issue_events_051678.json:
```json
{
    "actor": "https://github.com/sagetrac-mkasperski",
    "created_at": "2009-01-14T17:03:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "label": "https://github.com/sagemath/sage/labels/p4%20%E2%80%93%20minor",
    "label_color": "ffe799",
    "label_name": "p4 \u2013 minor",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4975#event-51678"
}
```



---

archive/issue_events_051679.json:
```json
{
    "actor": "https://github.com/sagetrac-mkasperski",
    "created_at": "2009-01-14T17:03:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4975#event-51679"
}
```



---

archive/issue_events_051680.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-01-15T02:01:55Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "milestone_number": null,
    "milestone_title": "sage-3.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4975#event-51680"
}
```



---

archive/issue_events_051681.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-01-15T02:01:55Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "label": "https://github.com/sagemath/sage/labels/p4%20%E2%80%93%20minor",
    "label_color": "ffe799",
    "label_name": "p4 \u2013 minor",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4975#event-51681"
}
```



---

archive/issue_events_051682.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-01-15T02:01:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "label": "https://github.com/sagemath/sage/labels/p2%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4975#event-51682"
}
```



---

archive/issue_comments_031429.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">Comment 2</div>\n\nAttachment: **[trac_4975.patch.gz](https://github.com/sagemath/sage/files/ticket4975/trac_4975.patch.gz)**\n\nI've attached a patch for the scripts directory which fixes this.",
    "created_at": "2009-01-19T10:26:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4975#issuecomment-31429",
    "user": "https://github.com/mwhansen"
}
```

<div id="comment:2" align="right">Comment 2</div>

Attachment: **[trac_4975.patch.gz](https://github.com/sagemath/sage/files/ticket4975/trac_4975.patch.gz)**

I've attached a patch for the scripts directory which fixes this.



---

archive/issue_events_051683.json:
```json
{
    "actor": "https://github.com/mwhansen",
    "created_at": "2009-01-19T10:26:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4975#event-51683"
}
```



---

archive/issue_comments_031430.json:
```json
{
    "body": "Changed assignee from **@williamstein** to **@mwhansen**",
    "created_at": "2009-01-19T10:26:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4975#issuecomment-31430",
    "user": "https://github.com/mwhansen"
}
```

Changed assignee from **@williamstein** to **@mwhansen**



---

archive/issue_comments_031431.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">Comment 3</div>\n\nNice fix. Positive review.\n\nWe might want to think about writing some tests for the various sage scripts, but this is not subject to this ticket.\n\nCheers,\n\nMichael",
    "created_at": "2009-01-19T10:39:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4975#issuecomment-31431",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:3" align="right">Comment 3</div>

Nice fix. Positive review.

We might want to think about writing some tests for the various sage scripts, but this is not subject to this ticket.

Cheers,

Michael



---

archive/issue_events_051684.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-01-19T10:39:09Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4975#event-51684"
}
```



---

archive/issue_events_051685.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-01-19T10:39:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4975#event-51685"
}
```



---

archive/issue_comments_031432.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">Comment 4</div>\n\nMerged in Sage 3.3.alpha0",
    "created_at": "2009-01-19T10:39:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4975#issuecomment-31432",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:4" align="right">Comment 4</div>

Merged in Sage 3.3.alpha0



---

archive/issue_events_051686.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-01-19T10:39:23Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4975#event-51686"
}
```



---

archive/issue_events_051687.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-01-19T10:39:23Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4975#event-51687"
}
```



---

archive/issue_comments_031433.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">Comment 5</div>\n\nI can confirm that applying this patch on 3.2.2 resolves the problem I initially reported\n(cd ..../sage-3.2.2-ubuntu32bit-intel-i686-Linux/local/bin;\n patch -p1 < .../trac_4975.patch)\n\nStill, something is wrong. The following file is handled properly:\n\n```\n# -*- coding: utf-8 -*-\n\n\"\"\"\nZa\u017c\u00f3\u0142\u0107 g\u0119\u015bl\u0105 ja\u017a\u0144\n\"\"\"\n\nprint 1\nprint u\"Za\u017c\u00f3\u0142\u0107 g\u0119\u015bl\u0105 ja\u017a\u0144\"\n```\n\nbut if you comment out `print 1`:\n\n```\n# -*- coding: utf-8 -*-\n\n\"\"\"\nZa\u017c\u00f3\u0142\u0107 g\u0119\u015bl\u0105 ja\u017a\u0144\"\n\"\"\"\n\nprint u\"Za\u017c\u00f3\u0142\u0107 g\u0119\u015bl\u0105 ja\u017a\u0144\"\n```\n\nit fails again:\n\n```\nsage test2.sage\n  File \"test2.py\", line 3\nSyntaxError: Non-ASCII character '\\xc5' in file test2.py on line 4, but no encoding declared; see http://www.python.org/peps/pep-0263.html for details\n```\n\nWhat is interesting, removing any of elements (either a \"\"\" string, or print) makes the problem to disappear.\n\nHere is .py generated from the file above:\n\n```\n\n\"\"\"\nZa\u017c\u00f3\u0142\u0107 g\u0119\u015bl\u0105 ja\u017a\u0144\"\n\"\"\"\n# -*- coding: utf-8 -*-\n# This file was *autogenerated* from the file test2.sage.\nfrom sage.all_cmdline import *   # import sage library\n\nprint u\"Za\u017c\u00f3\u0142\u0107 g\u0119\u015bl\u0105 ja\u017a\u0144\"\n```",
    "created_at": "2009-01-19T10:52:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4975#issuecomment-31433",
    "user": "https://github.com/sagetrac-mkasperski"
}
```

<div id="comment:5" align="right">Comment 5</div>

I can confirm that applying this patch on 3.2.2 resolves the problem I initially reported
(cd ..../sage-3.2.2-ubuntu32bit-intel-i686-Linux/local/bin;
 patch -p1 < .../trac_4975.patch)

Still, something is wrong. The following file is handled properly:

```
# -*- coding: utf-8 -*-

"""
Zażółć gęślą jaźń
"""

print 1
print u"Zażółć gęślą jaźń"
```

but if you comment out `print 1`:

```
# -*- coding: utf-8 -*-

"""
Zażółć gęślą jaźń"
"""

print u"Zażółć gęślą jaźń"
```

it fails again:

```
sage test2.sage
  File "test2.py", line 3
SyntaxError: Non-ASCII character '\xc5' in file test2.py on line 4, but no encoding declared; see http://www.python.org/peps/pep-0263.html for details
```

What is interesting, removing any of elements (either a """ string, or print) makes the problem to disappear.

Here is .py generated from the file above:

```

"""
Zażółć gęślą jaźń"
"""
# -*- coding: utf-8 -*-
# This file was *autogenerated* from the file test2.sage.
from sage.all_cmdline import *   # import sage library

print u"Zażółć gęślą jaźń"
```



---

archive/issue_comments_031434.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">Comment 6</div>\n\nHaving taken a look at the source, it seems that the problem happens here:\n\n```\n    insert = '%s%s%s.\\nfrom sage.all_cmdline import *   # import sage library\\n'%(coding, AUTOGEN_MSG, f)\n    i = find_position_right_after_module_docstring(G)\n    G = G[:i] + insert + G[i:]\n```\n\nas you see, if sage detects module docstring, it adds coding AFTER IT",
    "created_at": "2009-01-19T10:57:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4975#issuecomment-31434",
    "user": "https://github.com/sagetrac-mkasperski"
}
```

<div id="comment:6" align="right">Comment 6</div>

Having taken a look at the source, it seems that the problem happens here:

```
    insert = '%s%s%s.\nfrom sage.all_cmdline import *   # import sage library\n'%(coding, AUTOGEN_MSG, f)
    i = find_position_right_after_module_docstring(G)
    G = G[:i] + insert + G[i:]
```

as you see, if sage detects module docstring, it adds coding AFTER IT



---

archive/issue_comments_031435.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">Comment 7</div>\n\nAnd here is how I would rewrite those lines:\n\n```\n    if coding:\n       G = coding + G\n    insert = '%s%s.\\nfrom sage.all_cmdline import *   # import sage library\\n'%(AUTOGEN_MSG, f)\n    i = find_position_right_after_module_docstring(G)\n    G = G[:i] + insert + G[i:]\n```\n\n(sorry for no formal patch but I am not sure against what to make it)",
    "created_at": "2009-01-19T10:59:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4975#issuecomment-31435",
    "user": "https://github.com/sagetrac-mkasperski"
}
```

<div id="comment:7" align="right">Comment 7</div>

And here is how I would rewrite those lines:

```
    if coding:
       G = coding + G
    insert = '%s%s.\nfrom sage.all_cmdline import *   # import sage library\n'%(AUTOGEN_MSG, f)
    i = find_position_right_after_module_docstring(G)
    G = G[:i] + insert + G[i:]
```

(sorry for no formal patch but I am not sure against what to make it)



---

archive/issue_comments_031436.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">Comment 8</div>\n\nAttachment: **[trac_4975-2.patch.gz](https://github.com/sagemath/sage/files/ticket4975/trac_4975-2.patch.gz)**\n\nHeh, I didn't even notice that line :-)  I put up a patch which applies on top of the last one.",
    "created_at": "2009-01-19T11:01:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4975#issuecomment-31436",
    "user": "https://github.com/mwhansen"
}
```

<div id="comment:8" align="right">Comment 8</div>

Attachment: **[trac_4975-2.patch.gz](https://github.com/sagemath/sage/files/ticket4975/trac_4975-2.patch.gz)**

Heh, I didn't even notice that line :-)  I put up a patch which applies on top of the last one.



---

archive/issue_comments_031437.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">Comment 9</div>\n\nPlease do not reopen merged tickets. The issue you reported has been fixed. If you found more problems these will be addressed via the new ticket.\n\nCheers,\n\nMichael",
    "created_at": "2009-01-19T11:05:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4975#issuecomment-31437",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:9" align="right">Comment 9</div>

Please do not reopen merged tickets. The issue you reported has been fixed. If you found more problems these will be addressed via the new ticket.

Cheers,

Michael



---

archive/issue_events_051688.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-01-19T11:05:12Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4975#event-51688"
}
```



---

archive/issue_comments_031438.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">Comment 10</div>\n\nOops, I missed a couple of the last messages and I will apply Mike's second patch. But my remark still applies.\n\nCheers,\n\nMichael",
    "created_at": "2009-01-19T11:06:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4975#issuecomment-31438",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:10" align="right">Comment 10</div>

Oops, I missed a couple of the last messages and I will apply Mike's second patch. But my remark still applies.

Cheers,

Michael



---

archive/issue_comments_031439.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">Comment 11</div>\n\nMerged trac_4975-2.patch in Sage 3.3.alpha0.\n\nCheers,\n\nMichael",
    "created_at": "2009-01-19T11:09:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4975#issuecomment-31439",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:11" align="right">Comment 11</div>

Merged trac_4975-2.patch in Sage 3.3.alpha0.

Cheers,

Michael
