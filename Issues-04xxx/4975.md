# Issue 4975: [with patch, positive review] Sage 3.2.2 chokes on utf-8 encoded files

archive/issues_004975.json:
```json
{
    "body": "I just downloaded sage 3.2.2 and found it to choke on utf-8 encoded source files (for comparison, sage 3.0 handles them properly). My bet is that some problem happened during integration of issue 2637. Tested using sage-3.2.2-ubuntu32bit-intel-i686-Linux binary distribution.\n\nTake the file like:\n\n```\n# -*- coding: utf-8 -*-\n\n\"\"\"\nZa\u017c\u00f3\u0142\u0107 g\u0119\u015bl\u0105 ja\u017a\u0144\n\"\"\"\n\nprint 1\n```\n\nand try:\n\n```\n$ sage test.sage\n```\n\nResult:\n\n```\n  File \"test.py\", line 6\nSyntaxError: Non-ASCII character '\\xc5' in file test.py on line 7, but no encoding declared; see http://www.python.org/peps/pep-0263.html for details\n```\n\nProduced file:\n\n```\n# This file was *autogenerated* from the file test.sage.\nfrom sage.all_cmdline import *   # import sage library\n_sage_const_1 = Integer(Integer(1))# -*- coding: utf-8 -*-\n\n\"\"\"\nZa\u017c\u00f3\u0142\u0107 g\u0119\u015bl\u0105 ja\u017a\u0144\n\"\"\"\n\nprint _sage_const_1\n```\n\nAssignee: @mwhansen\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/4975\n\n",
    "closed_at": "2009-01-19T11:05:12Z",
    "created_at": "2009-01-14T17:03:31Z",
    "labels": [
        "component: user interface",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-3.3",
    "title": "[with patch, positive review] Sage 3.2.2 chokes on utf-8 encoded files",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/4975",
    "user": "https://trac.sagemath.org/admin/accounts/users/mkasperski"
}
```
I just downloaded sage 3.2.2 and found it to choke on utf-8 encoded source files (for comparison, sage 3.0 handles them properly). My bet is that some problem happened during integration of issue 2637. Tested using sage-3.2.2-ubuntu32bit-intel-i686-Linux binary distribution.

Take the file like:

```
# -*- coding: utf-8 -*-

"""
Zażółć gęślą jaźń
"""

print 1
```

and try:

```
$ sage test.sage
```

Result:

```
  File "test.py", line 6
SyntaxError: Non-ASCII character '\xc5' in file test.py on line 7, but no encoding declared; see http://www.python.org/peps/pep-0263.html for details
```

Produced file:

```
# This file was *autogenerated* from the file test.sage.
from sage.all_cmdline import *   # import sage library
_sage_const_1 = Integer(Integer(1))# -*- coding: utf-8 -*-

"""
Zażółć gęślą jaźń
"""

print _sage_const_1
```

Assignee: @mwhansen

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/4975





---

archive/issue_events_011504.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2009-01-15T02:01:55Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/4975",
    "milestone": "sage-3.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4975#event-11504"
}
```



---

archive/issue_comments_037848.json:
```json
{
    "body": "Changing priority from minor to critical.",
    "created_at": "2009-01-15T02:01:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4975#issuecomment-37848",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

Changing priority from minor to critical.



---

archive/issue_comments_037849.json:
```json
{
    "body": "Changing status from new to assigned.",
    "created_at": "2009-01-19T10:26:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4975#issuecomment-37849",
    "user": "https://github.com/mwhansen"
}
```

Changing status from new to assigned.



---

archive/issue_comments_037850.json:
```json
{
    "body": "<a id='comment:2'></a>Attachment [trac_4975.patch](tarball://root/attachments/some-uuid/ticket4975/trac_4975.patch) by @mwhansen created at 2009-01-19 10:26:44\n\nI've attached a patch for the scripts directory which fixes this.",
    "created_at": "2009-01-19T10:26:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4975#issuecomment-37850",
    "user": "https://github.com/mwhansen"
}
```

<a id='comment:2'></a>Attachment [trac_4975.patch](tarball://root/attachments/some-uuid/ticket4975/trac_4975.patch) by @mwhansen created at 2009-01-19 10:26:44

I've attached a patch for the scripts directory which fixes this.



---

archive/issue_comments_037851.json:
```json
{
    "body": "Changing assignee from @williamstein to @mwhansen.",
    "created_at": "2009-01-19T10:26:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4975#issuecomment-37851",
    "user": "https://github.com/mwhansen"
}
```

Changing assignee from @williamstein to @mwhansen.



---

archive/issue_comments_037852.json:
```json
{
    "body": "<a id='comment:3'></a>Nice fix. Positive review.\n\nWe might want to think about writing some tests for the various sage scripts, but this is not subject to this ticket.\n\nCheers,\n\nMichael",
    "created_at": "2009-01-19T10:39:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4975#issuecomment-37852",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:3'></a>Nice fix. Positive review.

We might want to think about writing some tests for the various sage scripts, but this is not subject to this ticket.

Cheers,

Michael



---

archive/issue_comments_037853.json:
```json
{
    "body": "<a id='comment:4'></a>Merged in Sage 3.3.alpha0",
    "created_at": "2009-01-19T10:39:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4975#issuecomment-37853",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:4'></a>Merged in Sage 3.3.alpha0



---

archive/issue_events_011505.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2009-01-19T10:39:23Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/4975",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4975#event-11505"
}
```



---

archive/issue_comments_037854.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2009-01-19T10:39:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4975#issuecomment-37854",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

Resolution: fixed



---

archive/issue_comments_037855.json:
```json
{
    "body": "Resolution changed from fixed to ",
    "created_at": "2009-01-19T10:52:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4975#issuecomment-37855",
    "user": "https://trac.sagemath.org/admin/accounts/users/mkasperski"
}
```

Resolution changed from fixed to 



---

archive/issue_comments_037856.json:
```json
{
    "body": "Changing status from closed to reopened.",
    "created_at": "2009-01-19T10:52:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4975#issuecomment-37856",
    "user": "https://trac.sagemath.org/admin/accounts/users/mkasperski"
}
```

Changing status from closed to reopened.



---

archive/issue_events_011506.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mkasperski",
    "created_at": "2009-01-19T10:52:44Z",
    "event": "reopened",
    "issue": "https://github.com/sagemath/sagetest/issues/4975",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4975#event-11506"
}
```



---

archive/issue_comments_037857.json:
```json
{
    "body": "<a id='comment:5'></a>I can confirm that applying this patch on 3.2.2 resolves the problem I initially reported\n(cd ..../sage-3.2.2-ubuntu32bit-intel-i686-Linux/local/bin;\n patch -p1 < .../trac_4975.patch)\n\nStill, something is wrong. The following file is handled properly:\n\n```\n# -*- coding: utf-8 -*-\n\n\"\"\"\nZa\u017c\u00f3\u0142\u0107 g\u0119\u015bl\u0105 ja\u017a\u0144\n\"\"\"\n\nprint 1\nprint u\"Za\u017c\u00f3\u0142\u0107 g\u0119\u015bl\u0105 ja\u017a\u0144\"\n```\n\nbut if you comment out `print 1`:\n\n```\n# -*- coding: utf-8 -*-\n\n\"\"\"\nZa\u017c\u00f3\u0142\u0107 g\u0119\u015bl\u0105 ja\u017a\u0144\"\n\"\"\"\n\nprint u\"Za\u017c\u00f3\u0142\u0107 g\u0119\u015bl\u0105 ja\u017a\u0144\"\n```\n\nit fails again:\n\n```\nsage test2.sage\n  File \"test2.py\", line 3\nSyntaxError: Non-ASCII character '\\xc5' in file test2.py on line 4, but no encoding declared; see http://www.python.org/peps/pep-0263.html for details\n```\n\nWhat is interesting, removing any of elements (either a \"\"\" string, or print) makes the problem to disappear.\n\nHere is .py generated from the file above:\n\n```\n\n\"\"\"\nZa\u017c\u00f3\u0142\u0107 g\u0119\u015bl\u0105 ja\u017a\u0144\"\n\"\"\"\n# -*- coding: utf-8 -*-\n# This file was *autogenerated* from the file test2.sage.\nfrom sage.all_cmdline import *   # import sage library\n\nprint u\"Za\u017c\u00f3\u0142\u0107 g\u0119\u015bl\u0105 ja\u017a\u0144\"\n```",
    "created_at": "2009-01-19T10:52:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4975#issuecomment-37857",
    "user": "https://trac.sagemath.org/admin/accounts/users/mkasperski"
}
```

<a id='comment:5'></a>I can confirm that applying this patch on 3.2.2 resolves the problem I initially reported
(cd ..../sage-3.2.2-ubuntu32bit-intel-i686-Linux/local/bin;
 patch -p1 < .../trac_4975.patch)

Still, something is wrong. The following file is handled properly:

```
# -*- coding: utf-8 -*-

"""
Zażółć gęślą jaźń
"""

print 1
print u"Zażółć gęślą jaźń"
```

but if you comment out `print 1`:

```
# -*- coding: utf-8 -*-

"""
Zażółć gęślą jaźń"
"""

print u"Zażółć gęślą jaźń"
```

it fails again:

```
sage test2.sage
  File "test2.py", line 3
SyntaxError: Non-ASCII character '\xc5' in file test2.py on line 4, but no encoding declared; see http://www.python.org/peps/pep-0263.html for details
```

What is interesting, removing any of elements (either a """ string, or print) makes the problem to disappear.

Here is .py generated from the file above:

```

"""
Zażółć gęślą jaźń"
"""
# -*- coding: utf-8 -*-
# This file was *autogenerated* from the file test2.sage.
from sage.all_cmdline import *   # import sage library

print u"Zażółć gęślą jaźń"
```



---

archive/issue_comments_037858.json:
```json
{
    "body": "<a id='comment:6'></a>Having taken a look at the source, it seems that the problem happens here:\n\n```\n    insert = '%s%s%s.\\nfrom sage.all_cmdline import *   # import sage library\\n'%(coding, AUTOGEN_MSG, f)\n    i = find_position_right_after_module_docstring(G)\n    G = G[:i] + insert + G[i:]\n```\n\nas you see, if sage detects module docstring, it adds coding AFTER IT",
    "created_at": "2009-01-19T10:57:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4975#issuecomment-37858",
    "user": "https://trac.sagemath.org/admin/accounts/users/mkasperski"
}
```

<a id='comment:6'></a>Having taken a look at the source, it seems that the problem happens here:

```
    insert = '%s%s%s.\nfrom sage.all_cmdline import *   # import sage library\n'%(coding, AUTOGEN_MSG, f)
    i = find_position_right_after_module_docstring(G)
    G = G[:i] + insert + G[i:]
```

as you see, if sage detects module docstring, it adds coding AFTER IT



---

archive/issue_comments_037859.json:
```json
{
    "body": "<a id='comment:7'></a>And here is how I would rewrite those lines:\n\n```\n    if coding:\n       G = coding + G\n    insert = '%s%s.\\nfrom sage.all_cmdline import *   # import sage library\\n'%(AUTOGEN_MSG, f)\n    i = find_position_right_after_module_docstring(G)\n    G = G[:i] + insert + G[i:]\n```\n\n(sorry for no formal patch but I am not sure against what to make it)",
    "created_at": "2009-01-19T10:59:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4975#issuecomment-37859",
    "user": "https://trac.sagemath.org/admin/accounts/users/mkasperski"
}
```

<a id='comment:7'></a>And here is how I would rewrite those lines:

```
    if coding:
       G = coding + G
    insert = '%s%s.\nfrom sage.all_cmdline import *   # import sage library\n'%(AUTOGEN_MSG, f)
    i = find_position_right_after_module_docstring(G)
    G = G[:i] + insert + G[i:]
```

(sorry for no formal patch but I am not sure against what to make it)



---

archive/issue_comments_037860.json:
```json
{
    "body": "<a id='comment:8'></a>Attachment [trac_4975-2.patch](tarball://root/attachments/some-uuid/ticket4975/trac_4975-2.patch) by @mwhansen created at 2009-01-19 11:01:46\n\nHeh, I didn't even notice that line :-)  I put up a patch which applies on top of the last one.",
    "created_at": "2009-01-19T11:01:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4975#issuecomment-37860",
    "user": "https://github.com/mwhansen"
}
```

<a id='comment:8'></a>Attachment [trac_4975-2.patch](tarball://root/attachments/some-uuid/ticket4975/trac_4975-2.patch) by @mwhansen created at 2009-01-19 11:01:46

Heh, I didn't even notice that line :-)  I put up a patch which applies on top of the last one.



---

archive/issue_comments_037861.json:
```json
{
    "body": "<a id='comment:9'></a>Please do not reopen merged tickets. The issue you reported has been fixed. If you found more problems these will be addressed via the new ticket.\n\nCheers,\n\nMichael",
    "created_at": "2009-01-19T11:05:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4975#issuecomment-37861",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:9'></a>Please do not reopen merged tickets. The issue you reported has been fixed. If you found more problems these will be addressed via the new ticket.

Cheers,

Michael



---

archive/issue_comments_037862.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2009-01-19T11:05:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4975#issuecomment-37862",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

Resolution: fixed



---

archive/issue_events_011507.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2009-01-19T11:05:12Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/4975",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4975#event-11507"
}
```



---

archive/issue_comments_037863.json:
```json
{
    "body": "<a id='comment:10'></a>Oops, I missed a couple of the last messages and I will apply Mike's second patch. But my remark still applies.\n\nCheers,\n\nMichael",
    "created_at": "2009-01-19T11:06:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4975#issuecomment-37863",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:10'></a>Oops, I missed a couple of the last messages and I will apply Mike's second patch. But my remark still applies.

Cheers,

Michael



---

archive/issue_comments_037864.json:
```json
{
    "body": "<a id='comment:11'></a>Merged trac_4975-2.patch in Sage 3.3.alpha0.\n\nCheers,\n\nMichael",
    "created_at": "2009-01-19T11:09:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4975#issuecomment-37864",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:11'></a>Merged trac_4975-2.patch in Sage 3.3.alpha0.

Cheers,

Michael
