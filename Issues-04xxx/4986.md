# Issue 4986: [with patch, do not review] import audit class to sage/all.py

archive/issues_004986.json:
```json
{
    "body": "It is currently way to easy to introduce circular imports in Sage, and a mess to try and hunt time down. An order in which things are imported is found in sage.all, but due to the cascade of imports in sage.misc (and elsewhere) this is not an accurate representation of what actually happens. This could stand to be cleaned up a lot. Ideally, little/none of sage.foo.* should be used before sage.foo.all is imported. \n\nThis patch prints out imports as they happen, and where they're initiated. \n\nAssignee: mabshoff\n\nCC:  @craigcitro @nexttime @kcrisman\n\nStatus: needs_work\n\nAuthor: Robert Bradshaw\n\nIssue created by migration from https://trac.sagemath.org/ticket/4986\n\n",
    "created_at": "2009-01-16T04:04:46Z",
    "labels": [
        "component: performance"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-wishlist",
    "title": "[with patch, do not review] import audit class to sage/all.py",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/4986",
    "user": "https://github.com/robertwb"
}
```
It is currently way to easy to introduce circular imports in Sage, and a mess to try and hunt time down. An order in which things are imported is found in sage.all, but due to the cascade of imports in sage.misc (and elsewhere) this is not an accurate representation of what actually happens. This could stand to be cleaned up a lot. Ideally, little/none of sage.foo.* should be used before sage.foo.all is imported. 

This patch prints out imports as they happen, and where they're initiated. 

Assignee: mabshoff

CC:  @craigcitro @nexttime @kcrisman

Status: needs_work

Author: Robert Bradshaw

Issue created by migration from https://trac.sagemath.org/ticket/4986





---

archive/issue_comments_040366.json:
```json
{
    "body": "<a id='comment:1'></a>\nI guess the patch isn't posted yet, but this seems like \"sage -startuptime\" which prints out imports as they occur.",
    "created_at": "2009-01-16T04:14:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4986#issuecomment-40366",
    "user": "https://github.com/mwhansen"
}
```

<a id='comment:1'></a>
I guess the patch isn't posted yet, but this seems like "sage -startuptime" which prints out imports as they occur.



---

archive/issue_comments_040367.json:
```json
{
    "body": "Attachment [import-audit.patch](tarball://root/attachments/some-uuid/ticket4986/import-audit.patch) by @robertwb created at 2009-01-16 04:16:30",
    "created_at": "2009-01-16T04:16:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4986#issuecomment-40367",
    "user": "https://github.com/robertwb"
}
```

Attachment [import-audit.patch](tarball://root/attachments/some-uuid/ticket4986/import-audit.patch) by @robertwb created at 2009-01-16 04:16:30



---

archive/issue_comments_040368.json:
```json
{
    "body": "<a id='comment:2'></a>\nYes, it is a lot like sage -startuptime. One difference is that it prints out where each import is coming from, and also filters based on whether or not the corresponding *.all module has been loaded.",
    "created_at": "2009-01-16T04:17:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4986#issuecomment-40368",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:2'></a>
Yes, it is a lot like sage -startuptime. One difference is that it prints out where each import is coming from, and also filters based on whether or not the corresponding *.all module has been loaded.



---

archive/issue_events_019322.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2009-01-16T06:39:29Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/4986",
    "milestone": "sage-3.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4986#event-19322"
}
```



---

archive/issue_events_019323.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/4986",
    "rename": {
        "from": "import audit",
        "to": "[with patch, needs review] import audit class to sage/all.py"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4986#event-19323"
}
```



---

archive/issue_events_019324.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/4986",
    "rename": {
        "from": "[with patch, needs review] import audit class to sage/all.py",
        "to": "[with patch, do not review] import audit class to sage/all.py"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4986#event-19324"
}
```



---

archive/issue_events_019325.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2009-01-16T07:31:40Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/4986",
    "milestone": "sage-3.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4986#event-19325"
}
```



---

archive/issue_events_019326.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2009-01-16T07:31:40Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/4986",
    "milestone": "sage-wishlist",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4986#event-19326"
}
```



---

archive/issue_comments_040369.json:
```json
{
    "body": "<a id='comment:4'></a>\nTo clarify, this patch should not be applied (unless we want the info to come up with every startup, or only enable it with a flag). Also, the work has not been done, What is attached is just a diagnostic tool.",
    "created_at": "2009-01-16T07:31:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4986#issuecomment-40369",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:4'></a>
To clarify, this patch should not be applied (unless we want the info to come up with every startup, or only enable it with a flag). Also, the work has not been done, What is attached is just a diagnostic tool.



---

archive/issue_comments_040370.json:
```json
{
    "body": "Changing upstream from \"\" to \"N/A\"",
    "created_at": "2011-08-21T01:37:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4986#issuecomment-40370",
    "user": "https://github.com/nexttime"
}
```

Changing upstream from "" to "N/A"



---

archive/issue_comments_040371.json:
```json
{
    "body": "Changing author from \"\" to \"Robert Bradshaw\"",
    "created_at": "2011-08-21T01:37:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4986#issuecomment-40371",
    "user": "https://github.com/nexttime"
}
```

Changing author from "" to "Robert Bradshaw"



---

archive/issue_comments_040372.json:
```json
{
    "body": "<a id='comment:6'></a>\nIn case anything should happen here...",
    "created_at": "2011-08-21T01:37:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4986#issuecomment-40372",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:6'></a>
In case anything should happen here...



---

archive/issue_comments_040373.json:
```json
{
    "body": "<a id='comment:7'></a>\nDitto.",
    "created_at": "2011-08-21T04:15:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4986#issuecomment-40373",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:7'></a>
Ditto.



---

archive/issue_comments_040374.json:
```json
{
    "body": "<a id='comment:8'></a>\nReplying to [kcrisman](#comment%3A7):\n> Ditto.\n\n\nRe: sage-devel thread: I was wondering what you were waiting for.\n\n(Haven't tested the patch here; I think you won't be able to print PARI's variables with this method anyway, at least not easily.)\n\nNote that you can inject code into the C files generated by Cython, e.g. with your favourite friend `sed`, especially into the functions called upon module initialization:\n\n```sh\n$ cd devel/sage/sage/rings\n$ sed -i -e '/^PyMODINIT_FUNC PyInit_.*(void)$/,+3s/^{$/{\\n  printf(\"Hello!\\\\n\");\\n/' real_mpfr.c\n$ ../../../../sage -br\n----------------------------------------------------------\nsage: Building and installing modified Sage library files.\n...\nbuilding 'sage.rings.real_mpfr' extension\nExecute 1 commands (using 1 threads)\n...\n----------------------------------------------------------------------\n----------------------------------------------------------------------\n**********************************************************************\n*                                                                    *\n* Warning: this is a prerelease version, and it may be unstable.     *\n*                                                                    *\n**********************************************************************\nHello!\nsage: \n```\n(This example is of course quite specific to the current layout of the C code generated by Cython. Also, for simplicity I've used the less portable `-i` option.)\n| Sage Version 4.7.2.alpha1, Release Date: 2011-08-17                |\n| Type notebook() for the GUI, and license() for information.        |\n\nJust a \"proof of concept\"; I can write an appropriate shell script for your debugging purpose once I've found the relevant ticket... ;-)",
    "created_at": "2011-08-21T06:11:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4986#issuecomment-40374",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:8'></a>
Replying to [kcrisman](#comment%3A7):
> Ditto.


Re: sage-devel thread: I was wondering what you were waiting for.

(Haven't tested the patch here; I think you won't be able to print PARI's variables with this method anyway, at least not easily.)

Note that you can inject code into the C files generated by Cython, e.g. with your favourite friend `sed`, especially into the functions called upon module initialization:

```sh
$ cd devel/sage/sage/rings
$ sed -i -e '/^PyMODINIT_FUNC PyInit_.*(void)$/,+3s/^{$/{\n  printf("Hello!\\n");\n/' real_mpfr.c
$ ../../../../sage -br
----------------------------------------------------------
sage: Building and installing modified Sage library files.
...
building 'sage.rings.real_mpfr' extension
Execute 1 commands (using 1 threads)
...
----------------------------------------------------------------------
----------------------------------------------------------------------
**********************************************************************
*                                                                    *
* Warning: this is a prerelease version, and it may be unstable.     *
*                                                                    *
**********************************************************************
Hello!
sage: 
```
(This example is of course quite specific to the current layout of the C code generated by Cython. Also, for simplicity I've used the less portable `-i` option.)
| Sage Version 4.7.2.alpha1, Release Date: 2011-08-17                |
| Type notebook() for the GUI, and license() for information.        |

Just a "proof of concept"; I can write an appropriate shell script for your debugging purpose once I've found the relevant ticket... ;-)
