# Issue 4571: [with patch, positive review] merge sage's numpy.pxd with the cython numpy.pxd

archive/issues_004571.json:
```json
{
    "body": "\n```\n[15:53] <robertwb> yep, we should merge them\n```\n\n\n\nAssignee: mabshoff\n\nCC:  @robertwb dagss\n\nResolution: fixed\n\nAuthor: Robert Bradshaw, Dag Sverre Seljebotn\n\nReviewer: Robert Bradshaw, Dag Sverre Seljebotn, Minh Van Nguyen\n\nMerged: Sage 4.1.1.alpha1\n\nIssue created by migration from https://trac.sagemath.org/ticket/4571\n\n",
    "closed_at": "2009-07-25T15:45:02Z",
    "created_at": "2008-11-20T21:56:56Z",
    "labels": [
        "component: numerical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.1.1",
    "title": "[with patch, positive review] merge sage's numpy.pxd with the cython numpy.pxd",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/4571",
    "user": "https://github.com/jasongrout"
}
```

```
[15:53] <robertwb> yep, we should merge them
```



Assignee: mabshoff

CC:  @robertwb dagss

Resolution: fixed

Author: Robert Bradshaw, Dag Sverre Seljebotn

Reviewer: Robert Bradshaw, Dag Sverre Seljebotn, Minh Van Nguyen

Merged: Sage 4.1.1.alpha1

Issue created by migration from https://trac.sagemath.org/ticket/4571





---

archive/issue_comments_037129.json:
```json
{
    "body": "<a id='comment:1'></a>\nSee http://trac.cython.org/cython_trac/ticket/339",
    "created_at": "2009-06-28T09:00:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4571#issuecomment-37129",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:1'></a>
See http://trac.cython.org/cython_trac/ticket/339



---

archive/issue_comments_037130.json:
```json
{
    "body": "Attachment [4571-numpy-pxd.patch](tarball://root/attachments/some-uuid/ticket4571/4571-numpy-pxd.patch) by @robertwb created at 2009-06-28 09:02:02",
    "created_at": "2009-06-28T09:02:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4571#issuecomment-37130",
    "user": "https://github.com/robertwb"
}
```

Attachment [4571-numpy-pxd.patch](tarball://root/attachments/some-uuid/ticket4571/4571-numpy-pxd.patch) by @robertwb created at 2009-06-28 09:02:02



---

archive/issue_comments_037131.json:
```json
{
    "body": "<a id='comment:3'></a>\nPreliminary patch, need a new Cython spkg for it to work all the way.",
    "created_at": "2009-06-28T09:02:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4571#issuecomment-37131",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:3'></a>
Preliminary patch, need a new Cython spkg for it to work all the way.



---

archive/issue_comments_037132.json:
```json
{
    "body": "<a id='comment:4'></a>\nAttachment [4571-more-fixes.patch](tarball://root/attachments/some-uuid/ticket4571/4571-more-fixes.patch) by dagss created at 2009-07-07 15:54:38\n\nHere are some more fixes. With this, and the latest state of the\n\nhttp://hg.cython.org/cython\n\nrepo, all the relevant tests seem to pass. I do get two failures (due to Cython upgrade? something else?), see test.log in\n\n/home/dagss/sage-4.0.2-sage.math.washington.edu-x86_64-Linux\n\nOnce this works let's tag http://hg.cython.org/cython as 0.11.2.1 for #6438?",
    "created_at": "2009-07-07T15:54:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4571#issuecomment-37132",
    "user": "https://trac.sagemath.org/admin/accounts/users/dagss"
}
```

<a id='comment:4'></a>
Attachment [4571-more-fixes.patch](tarball://root/attachments/some-uuid/ticket4571/4571-more-fixes.patch) by dagss created at 2009-07-07 15:54:38

Here are some more fixes. With this, and the latest state of the

http://hg.cython.org/cython

repo, all the relevant tests seem to pass. I do get two failures (due to Cython upgrade? something else?), see test.log in

/home/dagss/sage-4.0.2-sage.math.washington.edu-x86_64-Linux

Once this works let's tag http://hg.cython.org/cython as 0.11.2.1 for #6438?



---

archive/issue_comments_037133.json:
```json
{
    "body": "<a id='comment:5'></a>\nNote (re: discussion on Cython ML) that shape in numpy.pxd is still a field, long story (well, it is performance critical), and I shouldn't change it.",
    "created_at": "2009-07-07T15:57:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4571#issuecomment-37133",
    "user": "https://trac.sagemath.org/admin/accounts/users/dagss"
}
```

<a id='comment:5'></a>
Note (re: discussion on Cython ML) that shape in numpy.pxd is still a field, long story (well, it is performance critical), and I shouldn't change it.



---

archive/issue_comments_037134.json:
```json
{
    "body": "<a id='comment:6'></a>\nAnother quick comment: With this, full Cython/NumPy functionality is available from the notebook and works well.",
    "created_at": "2009-07-07T16:09:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4571#issuecomment-37134",
    "user": "https://trac.sagemath.org/admin/accounts/users/dagss"
}
```

<a id='comment:6'></a>
Another quick comment: With this, full Cython/NumPy functionality is available from the notebook and works well.



---

archive/issue_comments_037135.json:
```json
{
    "body": "<a id='comment:7'></a>\nThose errors seem completely unrelated, I'll see if I get them too. Other than that, it looks really good. \n\nI've used Cython + NumPy from the notebook before, as long as you weren't in sage.ext then \"cimport numpy\" worked as expected (though there was a point where it didn't).",
    "created_at": "2009-07-09T08:50:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4571#issuecomment-37135",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:7'></a>
Those errors seem completely unrelated, I'll see if I get them too. Other than that, it looks really good. 

I've used Cython + NumPy from the notebook before, as long as you weren't in sage.ext then "cimport numpy" worked as expected (though there was a point where it didn't).



---

archive/issue_comments_037136.json:
```json
{
    "body": "<a id='comment:8'></a>\nHmm... I also got \n\n```\nThe following tests failed:\n\n        sage -t -long devel/sage-main/sage/rings/polynomial/polynomial_template.pxi # 1 doctests failed\n        sage -t -long devel/sage-main/sage/interfaces/sage0.py # 1 doctests failed\n\n```",
    "created_at": "2009-07-21T20:52:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4571#issuecomment-37136",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:8'></a>
Hmm... I also got 

```
The following tests failed:

        sage -t -long devel/sage-main/sage/rings/polynomial/polynomial_template.pxi # 1 doctests failed
        sage -t -long devel/sage-main/sage/interfaces/sage0.py # 1 doctests failed

```



---

archive/issue_comments_037137.json:
```json
{
    "body": "Changing component from build to numerical.",
    "created_at": "2009-07-22T14:19:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4571#issuecomment-37137",
    "user": "https://github.com/robertwb"
}
```

Changing component from build to numerical.



---

archive/issue_comments_037138.json:
```json
{
    "body": "<a id='comment:9'></a>\nLooks good. The single doctest failure was minor, fixed in #6438.",
    "created_at": "2009-07-22T14:19:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4571#issuecomment-37138",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:9'></a>
Looks good. The single doctest failure was minor, fixed in #6438.



---

archive/issue_comments_037139.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Robert Bradshaw, Dag Sverre Seljebotn\"",
    "created_at": "2009-07-22T16:17:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4571#issuecomment-37139",
    "user": "https://trac.sagemath.org/admin/accounts/users/mvngu"
}
```

Changing reviewer from "" to "Robert Bradshaw, Dag Sverre Seljebotn"



---

archive/issue_comments_037140.json:
```json
{
    "body": "Changing author from \"\" to \"Robert Bradshaw, Dag Sverre Seljebotn\"",
    "created_at": "2009-07-22T16:17:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4571#issuecomment-37140",
    "user": "https://trac.sagemath.org/admin/accounts/users/mvngu"
}
```

Changing author from "" to "Robert Bradshaw, Dag Sverre Seljebotn"



---

archive/issue_comments_037141.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [dagss](#comment%3A4):\n> Here are some more fixes. With this, and the latest state of the\n\n<SNIP>\n\n\nThe patch `4571-more-fixes.patch` doesn't contain a commit message and your username is not on the patch. Your username should follow the format:\n\n```\nFull Name <email@somewhere.com>\n```\nThe username makes it easy to identify the patch, when it is committed, as your contribution.",
    "created_at": "2009-07-22T16:21:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4571#issuecomment-37141",
    "user": "https://trac.sagemath.org/admin/accounts/users/mvngu"
}
```

<a id='comment:11'></a>
Replying to [dagss](#comment%3A4):
> Here are some more fixes. With this, and the latest state of the

<SNIP>


The patch `4571-more-fixes.patch` doesn't contain a commit message and your username is not on the patch. Your username should follow the format:

```
Full Name <email@somewhere.com>
```
The username makes it easy to identify the patch, when it is committed, as your contribution.



---

archive/issue_comments_037142.json:
```json
{
    "body": "<a id='comment:12'></a>\nWith both patches applied in the following order:\n1. `4571-numpy-pxd.patch`\n2. `4571-more-fixes.patch`\nI see the following build failure:\n\n```\n[mvngu@sage sage-4.1.1.alpha0]$ ./sage -br main\n\n----------------------------------------------------------\nsage: Building and installing modified Sage library files.\n\n\nInstalling c_lib\nscons: `install' is up to date.\nUpdating Cython code....\nBuilding modified file sage/finance/time_series.pyx.\nBuilding modified file sage/matrix/change_ring.pyx.\nBuilding modified file sage/matrix/matrix_complex_double_dense.pyx.\nBuilding modified file sage/matrix/matrix_double_dense.pyx.\nBuilding modified file sage/matrix/matrix_real_double_dense.pyx.\nBuilding modified file sage/modules/vector_complex_double_dense.pyx.\nBuilding modified file sage/modules/vector_double_dense.pyx.\nBuilding modified file sage/modules/vector_real_double_dense.pyx.\nBuilding sage/rings/polynomial/real_roots.pyx because it depends on sage/modules/vector_double_dense.pxd.\nBuilding sage/stats/hmm/chmm.pyx because it depends on sage/matrix/matrix_double_dense.pxd.\nBuilding sage/stats/hmm/hmm.pyx because it depends on sage/matrix/matrix_double_dense.pxd.\npython `which cython` --embed-positions --incref-local-binop -I/scratch/mvngu/release/sage-4.1.1.alpha0/devel/sage-main -o sage/finance/time_series.c sage/finance/time_series.pyx\nwarning: /scratch/mvngu/release/sage-4.1.1.alpha0/devel/sage-main/sage/finance/time_series.pyx:1722:24: cdef variable 'j' declared after it is used\n\nError converting Pyrex file to C:\n------------------------------------------------------------\n...\n            [20.0000, -3.0000, 4.5000, -2.0000]\n        \"\"\"\n        cnumpy.import_array() #This must be called before using the numpy C/api or you will get segfault\n        cdef cnumpy.npy_intp dims[1]\n        dims[0] = self._length\n        cdef cnumpy.ndarray n = cnumpy.PyArray_SimpleNewFromData(1, dims, cnumpy.NPY_DOUBLE, self._values)\n                                                                       ^\n------------------------------------------------------------\n\n/scratch/mvngu/release/sage-4.1.1.alpha0/devel/sage-main/sage/finance/time_series.pyx:1862:72: Cannot convert 'numpy.npy_intp [1]' to Python object\n\nError converting Pyrex file to C:\n------------------------------------------------------------\n...\n            [20.0000, -3.0000, 4.5000, -2.0000]\n        \"\"\"\n        cnumpy.import_array() #This must be called before using the numpy C/api or you will get segfault\n        cdef cnumpy.npy_intp dims[1]\n        dims[0] = self._length\n        cdef cnumpy.ndarray n = cnumpy.PyArray_SimpleNewFromData(1, dims, cnumpy.NPY_DOUBLE, self._values)\n                                                                                                ^\n------------------------------------------------------------\n\n/scratch/mvngu/release/sage-4.1.1.alpha0/devel/sage-main/sage/finance/time_series.pyx:1862:97: Cannot convert 'double *' to Python object\nError running command, failed with status 256.\nsage: There was an error installing modified sage library code.\n```",
    "created_at": "2009-07-23T02:23:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4571#issuecomment-37142",
    "user": "https://trac.sagemath.org/admin/accounts/users/mvngu"
}
```

<a id='comment:12'></a>
With both patches applied in the following order:
1. `4571-numpy-pxd.patch`
2. `4571-more-fixes.patch`
I see the following build failure:

```
[mvngu@sage sage-4.1.1.alpha0]$ ./sage -br main

----------------------------------------------------------
sage: Building and installing modified Sage library files.


Installing c_lib
scons: `install' is up to date.
Updating Cython code....
Building modified file sage/finance/time_series.pyx.
Building modified file sage/matrix/change_ring.pyx.
Building modified file sage/matrix/matrix_complex_double_dense.pyx.
Building modified file sage/matrix/matrix_double_dense.pyx.
Building modified file sage/matrix/matrix_real_double_dense.pyx.
Building modified file sage/modules/vector_complex_double_dense.pyx.
Building modified file sage/modules/vector_double_dense.pyx.
Building modified file sage/modules/vector_real_double_dense.pyx.
Building sage/rings/polynomial/real_roots.pyx because it depends on sage/modules/vector_double_dense.pxd.
Building sage/stats/hmm/chmm.pyx because it depends on sage/matrix/matrix_double_dense.pxd.
Building sage/stats/hmm/hmm.pyx because it depends on sage/matrix/matrix_double_dense.pxd.
python `which cython` --embed-positions --incref-local-binop -I/scratch/mvngu/release/sage-4.1.1.alpha0/devel/sage-main -o sage/finance/time_series.c sage/finance/time_series.pyx
warning: /scratch/mvngu/release/sage-4.1.1.alpha0/devel/sage-main/sage/finance/time_series.pyx:1722:24: cdef variable 'j' declared after it is used

Error converting Pyrex file to C:
------------------------------------------------------------
...
            [20.0000, -3.0000, 4.5000, -2.0000]
        """
        cnumpy.import_array() #This must be called before using the numpy C/api or you will get segfault
        cdef cnumpy.npy_intp dims[1]
        dims[0] = self._length
        cdef cnumpy.ndarray n = cnumpy.PyArray_SimpleNewFromData(1, dims, cnumpy.NPY_DOUBLE, self._values)
                                                                       ^
------------------------------------------------------------

/scratch/mvngu/release/sage-4.1.1.alpha0/devel/sage-main/sage/finance/time_series.pyx:1862:72: Cannot convert 'numpy.npy_intp [1]' to Python object

Error converting Pyrex file to C:
------------------------------------------------------------
...
            [20.0000, -3.0000, 4.5000, -2.0000]
        """
        cnumpy.import_array() #This must be called before using the numpy C/api or you will get segfault
        cdef cnumpy.npy_intp dims[1]
        dims[0] = self._length
        cdef cnumpy.ndarray n = cnumpy.PyArray_SimpleNewFromData(1, dims, cnumpy.NPY_DOUBLE, self._values)
                                                                                                ^
------------------------------------------------------------

/scratch/mvngu/release/sage-4.1.1.alpha0/devel/sage-main/sage/finance/time_series.pyx:1862:97: Cannot convert 'double *' to Python object
Error running command, failed with status 256.
sage: There was an error installing modified sage library code.
```



---

archive/issue_comments_037143.json:
```json
{
    "body": "<a id='comment:13'></a>\nLooks like it'll have to be rebased, worked fine on vanilla 4.1. Where's the .tar on sage.math?",
    "created_at": "2009-07-23T08:50:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4571#issuecomment-37143",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:13'></a>
Looks like it'll have to be rebased, worked fine on vanilla 4.1. Where's the .tar on sage.math?



---

archive/issue_comments_037144.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [robertwb](#comment%3A13):\n> Looks like it'll have to be rebased, worked fine on vanilla 4.1. Where's the .tar on sage.math? \n\nSource and binary versions are up at\n\nhttp://sage.math.washington.edu/home/mvngu/release/sage-4.1.1.alpha0.tar\n\n\nhttp://sage.math.washington.edu/home/mvngu/release/sage-4.1.1.alpha0-sage.math.washignton.edu-x86_64-Linux.tar.gz",
    "created_at": "2009-07-23T08:53:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4571#issuecomment-37144",
    "user": "https://trac.sagemath.org/admin/accounts/users/mvngu"
}
```

<a id='comment:14'></a>
Replying to [robertwb](#comment%3A13):
> Looks like it'll have to be rebased, worked fine on vanilla 4.1. Where's the .tar on sage.math? 

Source and binary versions are up at

http://sage.math.washington.edu/home/mvngu/release/sage-4.1.1.alpha0.tar


http://sage.math.washington.edu/home/mvngu/release/sage-4.1.1.alpha0-sage.math.washignton.edu-x86_64-Linux.tar.gz



---

archive/issue_comments_037145.json:
```json
{
    "body": "<a id='comment:15'></a>\nWorks fine form me. sage-4.1.1.alpha0-sage.math.washignton.edu-x86_64-Linux.tar.gz + #6438 + #4571. Are you sure applied the latest Cython spkg first? 4.1.1.alpha0 doesn't seem to have it.",
    "created_at": "2009-07-25T12:07:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4571#issuecomment-37145",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:15'></a>
Works fine form me. sage-4.1.1.alpha0-sage.math.washignton.edu-x86_64-Linux.tar.gz + #6438 + #4571. Are you sure applied the latest Cython spkg first? 4.1.1.alpha0 doesn't seem to have it.



---

archive/issue_comments_037146.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2009-07-25T15:45:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4571#issuecomment-37146",
    "user": "https://trac.sagemath.org/admin/accounts/users/mvngu"
}
```

Resolution: fixed



---

archive/issue_comments_037147.json:
```json
{
    "body": "Changing reviewer from \"Robert Bradshaw, Dag Sverre Seljebotn\" to \"Robert Bradshaw, Dag Sverre Seljebotn, Minh Van Nguyen\"",
    "created_at": "2009-07-25T15:45:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4571#issuecomment-37147",
    "user": "https://trac.sagemath.org/admin/accounts/users/mvngu"
}
```

Changing reviewer from "Robert Bradshaw, Dag Sverre Seljebotn" to "Robert Bradshaw, Dag Sverre Seljebotn, Minh Van Nguyen"



---

archive/issue_events_010408.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mvngu",
    "created_at": "2009-07-25T15:45:02Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/4571",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4571#event-10408"
}
```



---

archive/issue_comments_037148.json:
```json
{
    "body": "<a id='comment:17'></a>\ndagss: The patch `4571-more-fixes.patch` doesn't contain your username. I'm committing it in your name. Merged in this order\n1. the SPKG at #6438\n2. `4571-numpy-pxd.patch`\n3. `4571-more-fixes.patch`",
    "created_at": "2009-07-25T15:45:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4571#issuecomment-37148",
    "user": "https://trac.sagemath.org/admin/accounts/users/mvngu"
}
```

<a id='comment:17'></a>
dagss: The patch `4571-more-fixes.patch` doesn't contain your username. I'm committing it in your name. Merged in this order
1. the SPKG at #6438
2. `4571-numpy-pxd.patch`
3. `4571-more-fixes.patch`



---

archive/issue_comments_037149.json:
```json
{
    "body": "Changing merged from \"\" to \"Sage 4.1.1.alpha1\"",
    "created_at": "2009-07-25T15:45:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4571",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4571#issuecomment-37149",
    "user": "https://trac.sagemath.org/admin/accounts/users/mvngu"
}
```

Changing merged from "" to "Sage 4.1.1.alpha1"
