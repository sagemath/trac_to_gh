# Issue 4968: implement fast linear algebra modulo n < 2^31

archive/issues_004968.json:
```json
{
    "body": "The switch would allow to cover larger primes with the specialised code (and I currently work with primes ~ 2<sup>32</sup>).\n\nThe switch requires changing all mentions of `int` to `long` and probably implementing `arith_long`.\n\nDepends on #10281\n\n**Assignee:** @williamstein\n\n**CC:**  @simon-king-jena mraum\n\nIssue created by migration from https://trac.sagemath.org/ticket/4968\n\n",
    "created_at": "2009-01-12T16:54:43Z",
    "labels": [
        "component: linear algebra",
        "enhancement",
        "wishlist",
        "needs info"
    ],
    "title": "implement fast linear algebra modulo n < 2^31",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/4968",
    "user": "https://github.com/malb"
}
```
The switch would allow to cover larger primes with the specialised code (and I currently work with primes ~ 2<sup>32</sup>).

The switch requires changing all mentions of `int` to `long` and probably implementing `arith_long`.

Depends on #10281

**Assignee:** @williamstein

**CC:**  @simon-king-jena mraum

Issue created by migration from https://trac.sagemath.org/ticket/4968





---

archive/issue_comments_031322.json:
```json
{
    "body": "Replying to [ticket:4968 malb]:\n\n> The switch requires changing all mentions of `int` to `long` and probably implementing `arith_long`.\n\nI am not sure using long here is a good idea since on various platforms we want to support sizeof(long) == sizeof (int). You might want to replace it by some typedef so we can make it long long on those platforms.\n\nCheers,\n\nMichael",
    "created_at": "2009-01-12T17:33:34Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31322",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

Replying to [ticket:4968 malb]:

> The switch requires changing all mentions of `int` to `long` and probably implementing `arith_long`.

I am not sure using long here is a good idea since on various platforms we want to support sizeof(long) == sizeof (int). You might want to replace it by some typedef so we can make it long long on those platforms.

Cheers,

Michael



---

archive/issue_comments_031323.json:
```json
{
    "body": "<a id='comment:2'></a>\n> I am not sure using long here is a good idea since on various platforms we want to\n> support sizeof(long) == sizeof (int). You might want to replace it by some typedef\n> so we can make it long long on those platforms.\n\nIs your point that the maximum prime for which we use `Matrix_modn_dense` shouldn't vary across platforms? I didn't think of it before, I can see why this would be desirable. How about \"long long\" across the board?",
    "created_at": "2009-01-12T21:58:03Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31323",
    "user": "https://github.com/malb"
}
```

<a id='comment:2'></a>
> I am not sure using long here is a good idea since on various platforms we want to
> support sizeof(long) == sizeof (int). You might want to replace it by some typedef
> so we can make it long long on those platforms.

Is your point that the maximum prime for which we use `Matrix_modn_dense` shouldn't vary across platforms? I didn't think of it before, I can see why this would be desirable. How about "long long" across the board?



---

archive/issue_comments_031324.json:
```json
{
    "body": "<a id='comment:3'></a>\n> How about \"long long\" across the board? \n\nWon't that have negative implications. For example, on a 32-bit machine all matrices will take twice as much memory to store, and all arithmetic will be an order of magnitude slower.  That certainly wouldn't make me happy!\n\n\n```\n%cython\ndef foo(n):\n    cdef long long i = 10, j = 10093, k\n    cdef int z\n    for z in range(n):\n        k += i*j\n    return k\n///\n```\n\n```\n%cython\ndef bar(n):\n    cdef int i = 10, j = 10093, k\n    cdef int z\n    for z in range(n):\n        k += i*j\n    return k\n///\n```\n\n```\ntime foo(10^8)\n///\n\n587410688573299048L\nCPU time: 0.29 s,  Wall time: 0.29 s\n```\n\n```\ntime bar(10^8)\n///\n\n-171048080\nCPU time: 0.04 s,  Wall time: 0.04 s\n```\n\n```\n0.29/0.04\n///\n\n7.25000000000000\n```",
    "created_at": "2009-01-13T14:49:34Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31324",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:3'></a>
> How about "long long" across the board? 

Won't that have negative implications. For example, on a 32-bit machine all matrices will take twice as much memory to store, and all arithmetic will be an order of magnitude slower.  That certainly wouldn't make me happy!


```
%cython
def foo(n):
    cdef long long i = 10, j = 10093, k
    cdef int z
    for z in range(n):
        k += i*j
    return k
///
```

```
%cython
def bar(n):
    cdef int i = 10, j = 10093, k
    cdef int z
    for z in range(n):
        k += i*j
    return k
///
```

```
time foo(10^8)
///

587410688573299048L
CPU time: 0.29 s,  Wall time: 0.29 s
```

```
time bar(10^8)
///

-171048080
CPU time: 0.04 s,  Wall time: 0.04 s
```

```
0.29/0.04
///

7.25000000000000
```



---

archive/issue_comments_031325.json:
```json
{
    "body": "<a id='comment:4'></a>\nReplying to [@williamstein](#comment%3A3):\n> > How about \"long long\" across the board? \n\n> \n> Won't that have negative implications. For example, on a 32-bit machine all matrices will take twice as much memory to store, and all arithmetic will be an order of magnitude slower.  That certainly wouldn't make me happy!\n\nWell, assuming we will transparently switch over to another implementation (using gmpz's for example) we should use the \"fast\" integer type, i.e. 32 bit ints and a 64 bit int type on 64 bit boxen. But my original point remains: On \n\n* 64 bit Solaris\n* 64 bit Windows\n\nsizeof(long) == sizeof(int) == 4, so using either a C99 type or some platform dependent typedef is what we need here to get optimum performance on all 64 bit platforms. Since we are already requiring C99 due to FLINT we might as well go for that solution.\n\nCheers,\n\nMichael",
    "created_at": "2009-01-13T15:00:43Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31325",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:4'></a>
Replying to [@williamstein](#comment%3A3):
> > How about "long long" across the board? 

> 
> Won't that have negative implications. For example, on a 32-bit machine all matrices will take twice as much memory to store, and all arithmetic will be an order of magnitude slower.  That certainly wouldn't make me happy!

Well, assuming we will transparently switch over to another implementation (using gmpz's for example) we should use the "fast" integer type, i.e. 32 bit ints and a 64 bit int type on 64 bit boxen. But my original point remains: On 

* 64 bit Solaris
* 64 bit Windows

sizeof(long) == sizeof(int) == 4, so using either a C99 type or some platform dependent typedef is what we need here to get optimum performance on all 64 bit platforms. Since we are already requiring C99 due to FLINT we might as well go for that solution.

Cheers,

Michael



---

archive/issue_comments_031326.json:
```json
{
    "body": "<a id='comment:5'></a>\nI don't know what `arith_long` is, but the `long_extras` module of FLINT might help here.",
    "created_at": "2009-01-15T12:59:23Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31326",
    "user": "https://github.com/burcin"
}
```

<a id='comment:5'></a>
I don't know what `arith_long` is, but the `long_extras` module of FLINT might help here.



---

archive/issue_comments_031327.json:
```json
{
    "body": "<a id='comment:7'></a>\nI'd say this is now a duplicate? of #4260 and should be closed?",
    "created_at": "2011-08-30T15:57:17Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31327",
    "user": "https://github.com/malb"
}
```

<a id='comment:7'></a>
I'd say this is now a duplicate? of #4260 and should be closed?



---

archive/issue_comments_031328.json:
```json
{
    "body": "<a id='comment:8'></a>\n#4260 doesn't cover your request of modulus > 2<sup>32</sup> from the ticket description. Maximum modulus there is 2<sup>23</sup>.\n\nWe could use the template class from #4260 to provide a matrix class using `long long`s.",
    "created_at": "2011-09-22T00:48:57Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31328",
    "user": "https://github.com/burcin"
}
```

<a id='comment:8'></a>
#4260 doesn't cover your request of modulus > 2<sup>32</sup> from the ticket description. Maximum modulus there is 2<sup>23</sup>.

We could use the template class from #4260 to provide a matrix class using `long long`s.



---

archive/issue_events_030343.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2012-03-23T02:11:16Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "rename": {
        "from": "switch Matrix_modn_dense from ints to CPU longs",
        "to": "implement fast linear algebra modulo n < 2^31"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4968#event-30343"
}
```



---

archive/issue_comments_031329.json:
```json
{
    "body": "**Dependencies:** #10281",
    "created_at": "2012-03-23T02:15:04Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31329",
    "user": "https://github.com/williamstein"
}
```

**Dependencies:** #10281



---

archive/issue_events_030344.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2012-03-23T02:15:04Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4968#event-30344"
}
```



---

archive/issue_comments_031330.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [@burcin](#comment%3A8):\n> #4260 doesn't cover your request of modulus > 2<sup>32</sup> from the ticket description. Maximum modulus there is 2<sup>23</sup>.\n> \n> We could use the template class from #4260 to provide a matrix class using `long long`s.\n\nI elected not to do this because:\n\n* the template class is very, very heavily tied to linbox, and disentangling that seemed insane.  We can't use linbox anyways for primes above 2^23.\n\n* much of the work in writing this patch was spent writing a lot of really good tests that truly exercise the new functionality, and in debugging and properly using the old Strassen code for matrix multiplication and echelon forms.    None of that would have been made better by using the template.",
    "created_at": "2012-03-23T02:15:04Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31330",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:11'></a>
Replying to [@burcin](#comment%3A8):
> #4260 doesn't cover your request of modulus > 2<sup>32</sup> from the ticket description. Maximum modulus there is 2<sup>23</sup>.
> 
> We could use the template class from #4260 to provide a matrix class using `long long`s.

I elected not to do this because:

* the template class is very, very heavily tied to linbox, and disentangling that seemed insane.  We can't use linbox anyways for primes above 2^23.

* much of the work in writing this patch was spent writing a lot of really good tests that truly exercise the new functionality, and in debugging and properly using the old Strassen code for matrix multiplication and echelon forms.    None of that would have been made better by using the template.



---

archive/issue_comments_031331.json:
```json
{
    "body": "<a id='comment:12'></a>\nmatrix_window_modn_dense_uint64.pyx looks an awfully lot like matrix_window_modn_dense.pyx (and the same could be said of the non-window files), is there any reason to keep both?",
    "created_at": "2012-03-23T07:16:31Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31331",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:12'></a>
matrix_window_modn_dense_uint64.pyx looks an awfully lot like matrix_window_modn_dense.pyx (and the same could be said of the non-window files), is there any reason to keep both?



---

archive/issue_comments_031332.json:
```json
{
    "body": "<a id='comment:13'></a>\nWilliam, are you still working on this code? I was about to start reviewing but then saw that you didn't reply to Robert's comment, hence wondering how high priority it is for you at the moment.",
    "created_at": "2012-04-18T18:47:53Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31332",
    "user": "https://github.com/malb"
}
```

<a id='comment:13'></a>
William, are you still working on this code? I was about to start reviewing but then saw that you didn't reply to Robert's comment, hence wondering how high priority it is for you at the moment.



---

archive/issue_comments_031333.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [@malb](#comment%3A13):\n> William, are you still working on this code? I was about to start reviewing but then saw that you didn't reply to Robert's comment, hence wondering how high priority it is for you at the moment.\n\nYes!  Please review!   Regarding robert's comment -- No, there is no reason to keep both.  But maybe I can put all the cleanup in another patch, just in case there is a reason.   Just to keep things simple.  \n\nI care very much about this code.",
    "created_at": "2012-04-18T19:30:14Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31333",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:14'></a>
Replying to [@malb](#comment%3A13):
> William, are you still working on this code? I was about to start reviewing but then saw that you didn't reply to Robert's comment, hence wondering how high priority it is for you at the moment.

Yes!  Please review!   Regarding robert's comment -- No, there is no reason to keep both.  But maybe I can put all the cleanup in another patch, just in case there is a reason.   Just to keep things simple.  

I care very much about this code.



---

archive/issue_comments_031334.json:
```json
{
    "body": "apply only this patch",
    "created_at": "2012-04-19T08:34:10Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31334",
    "user": "https://github.com/robertwb"
}
```

apply only this patch



---

archive/attachments_005787.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "4968-squashed.patch",
    "asset_url": "tarball://root/attachments/ticket4968/4968-squashed.patch",
    "created_at": "2012-04-19T08:37:41Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket4968/4968-squashed.patch",
    "user": "https://github.com/robertwb"
}
```



---

archive/issue_comments_031335.json:
```json
{
    "body": "<a id='comment:15'></a>\n**Attachment:** [4968-squashed.patch](https://github.com/sagemath/sage/files/ticket4968/4968-squashed.patch)\n\nI've squashed this into just changing matrix_modn_dense directly, which should make it both easier to see the changes and avoid adding a (modified) second copy of everything.",
    "created_at": "2012-04-19T08:37:41Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31335",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:15'></a>
**Attachment:** [4968-squashed.patch](https://github.com/sagemath/sage/files/ticket4968/4968-squashed.patch)

I've squashed this into just changing matrix_modn_dense directly, which should make it both easier to see the changes and avoid adding a (modified) second copy of everything.



---

archive/issue_comments_031336.json:
```json
{
    "body": "<a id='comment:16'></a>\nIt's also rebased on top of sage-5.0.beta15.",
    "created_at": "2012-04-19T08:38:08Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31336",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:16'></a>
It's also rebased on top of sage-5.0.beta15.



---

archive/issue_events_030345.json:
```json
{
    "actor": "https://github.com/malb",
    "created_at": "2012-04-19T20:23:58Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4968#event-30345"
}
```



---

archive/issue_events_030346.json:
```json
{
    "actor": "https://github.com/malb",
    "created_at": "2012-04-19T20:23:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4968#event-30346"
}
```



---

archive/issue_comments_031337.json:
```json
{
    "body": "<a id='comment:17'></a>\n**32-bit vs 64-bit**\n\n* I think there is a bit of confusion about 32-bit vs. 64-bit in the patch, or at least I am confused. If I understand correctly, then `ctypedef unsigned long uint_fast64_t` is used to define the data type of the matrix. However, `unsigned long` is not necessarily 64-bit, on 32-bit machines it may be 32-bit. Arithmetic uses `long long` which is at least 64-bit. So either the datatype should not mention 64 bits or should be moved over to e.g. `uint64_t` or `unsigned long long` (which doesn't exist in older C++ standards FWIW). Once this is fixed there seem to be a few places like: \"Reduce the integer matrix modulo a positive machine size integer.\" and \"stored as a 64-bit unsigned int\" which might need adapting too.  \n\n* I am not sure about this code:\n\n```python\n  if use_32bit_type(p): \n        raise RuntimeError, \"BUG: p (=%s) is too small to use this matrix type\"%p \n```\n  Why raise an error? Of course, the LinBox matrices take care of that by default, I am just confused by this. Also, this seems to contradict with \"If the prime is small enough to fit in a byte\" later.\n\n* I assume this `long long` vs `unsigned long long` is the reason for restricting the modulus to 2<sup>31</sup>?\n\n**mod_int vs. mod_int_uint64**\n\n* I think Robert's merge introduced a bug in pickling. We are at version 10 of pickling for `Matrix_modn_dense` but William started counting at zero again for his new type. Now that we're back to the old type, we shouldn't check for `version == 0`.\n\n**Other stuff**\n\n* \"TODO: should free up memory allocated so far -- this would leak otherwise, in exactly a situation where a *lot* leaks\" Shouldn't this be fixed?\n\n* Of course, far from mandatory but couldn't we -- while we are at it -- not also fix those `raise OverflowError, string` to read `raise OverflowError(string)` which is Python3 style (?)\n\n* performance: it seems picking a bigger Strassen cutoff would be quite beneficial:\n\n```\nsage: A = random_matrix(GF(previous_prime(2^24)),1000,1000)\nsage: %time A*A                               \nCPU times: user 2.67 s, sys: 0.00 s, total: 2.68 s\nWall time: 2.69 s\n1000 x 1000 dense matrix over Finite Field of size 16777213\nsage: %time A._multiply_strassen(A,100)                    \nCPU times: user 1.12 s, sys: 0.00 s, total: 1.12 s\nWall time: 1.13 s\n1000 x 1000 dense matrix over Finite Field of size 16777213\n```",
    "created_at": "2012-04-19T20:23:58Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31337",
    "user": "https://github.com/malb"
}
```

<a id='comment:17'></a>
**32-bit vs 64-bit**

* I think there is a bit of confusion about 32-bit vs. 64-bit in the patch, or at least I am confused. If I understand correctly, then `ctypedef unsigned long uint_fast64_t` is used to define the data type of the matrix. However, `unsigned long` is not necessarily 64-bit, on 32-bit machines it may be 32-bit. Arithmetic uses `long long` which is at least 64-bit. So either the datatype should not mention 64 bits or should be moved over to e.g. `uint64_t` or `unsigned long long` (which doesn't exist in older C++ standards FWIW). Once this is fixed there seem to be a few places like: "Reduce the integer matrix modulo a positive machine size integer." and "stored as a 64-bit unsigned int" which might need adapting too.  

* I am not sure about this code:

```python
  if use_32bit_type(p): 
        raise RuntimeError, "BUG: p (=%s) is too small to use this matrix type"%p 
```
  Why raise an error? Of course, the LinBox matrices take care of that by default, I am just confused by this. Also, this seems to contradict with "If the prime is small enough to fit in a byte" later.

* I assume this `long long` vs `unsigned long long` is the reason for restricting the modulus to 2<sup>31</sup>?

**mod_int vs. mod_int_uint64**

* I think Robert's merge introduced a bug in pickling. We are at version 10 of pickling for `Matrix_modn_dense` but William started counting at zero again for his new type. Now that we're back to the old type, we shouldn't check for `version == 0`.

**Other stuff**

* "TODO: should free up memory allocated so far -- this would leak otherwise, in exactly a situation where a *lot* leaks" Shouldn't this be fixed?

* Of course, far from mandatory but couldn't we -- while we are at it -- not also fix those `raise OverflowError, string` to read `raise OverflowError(string)` which is Python3 style (?)

* performance: it seems picking a bigger Strassen cutoff would be quite beneficial:

```
sage: A = random_matrix(GF(previous_prime(2^24)),1000,1000)
sage: %time A*A                               
CPU times: user 2.67 s, sys: 0.00 s, total: 2.68 s
Wall time: 2.69 s
1000 x 1000 dense matrix over Finite Field of size 16777213
sage: %time A._multiply_strassen(A,100)                    
CPU times: user 1.12 s, sys: 0.00 s, total: 1.12 s
Wall time: 1.13 s
1000 x 1000 dense matrix over Finite Field of size 16777213
```



---

archive/issue_comments_031338.json:
```json
{
    "body": "<a id='comment:18'></a>\nThe unsigned long thing seems OK (int_fast64_t is a C type, defined in stdint.h). For consistency it would be good if MAX_MODULUS was INTEGER_MOD_INT64_LIMIT to be found in sage/rings/finite_rings/stdint.h this is less by one. In integer_mod.pyx the modulus is tested using <= and in the patch < is used.\n\nApart from this I more or less agree with all points made previously. If you don't see a good reason to change the Strassen cutoff, I would leave it at is. File a new ticket instead. We should optimize it, but changing it based on one observation is daring.\n\nHonestly, I am against the if use_32bit_type(p) test. The matrix works perfectly for such p. Even thought it shouldn't be called, it may be called.\n\nIf anybody has time to make the changes, I will test it within the next two weeks and it will have a positive review.",
    "created_at": "2012-04-26T11:32:20Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31338",
    "user": "https://trac.sagemath.org/admin/accounts/users/mraum"
}
```

<a id='comment:18'></a>
The unsigned long thing seems OK (int_fast64_t is a C type, defined in stdint.h). For consistency it would be good if MAX_MODULUS was INTEGER_MOD_INT64_LIMIT to be found in sage/rings/finite_rings/stdint.h this is less by one. In integer_mod.pyx the modulus is tested using <= and in the patch < is used.

Apart from this I more or less agree with all points made previously. If you don't see a good reason to change the Strassen cutoff, I would leave it at is. File a new ticket instead. We should optimize it, but changing it based on one observation is daring.

Honestly, I am against the if use_32bit_type(p) test. The matrix works perfectly for such p. Even thought it shouldn't be called, it may be called.

If anybody has time to make the changes, I will test it within the next two weeks and it will have a positive review.



---

archive/issue_comments_031339.json:
```json
{
    "body": "<a id='comment:19'></a>\nReplying to [mraum](#comment%3A18):\n> The unsigned long thing seems OK (int_fast64_t is a C type, defined in stdint.h). For consistency it would be good if MAX_MODULUS was INTEGER_MOD_INT64_LIMIT to be found in sage/rings/finite_rings/stdint.h this is less by one. In integer_mod.pyx the modulus is tested using <= and in the patch < is used.\n\nYou are right, I got confused about Cython ctypdefs. \"unsigned long\" does not appear in a meaningful way in the generated C files. Sorry for the noise. Still, the documentation is wrong in various places and should be fixed (machine sized ints).\n \n> Apart from this I more or less agree with all points made previously. If you don't see a good reason to change the Strassen cutoff, I would leave it at is. File a new ticket instead. We should optimize it, but changing it based on one observation is daring.\n\nFair enough, so let's make more observations. This code is about performance. I am not saying: let's run a comprehensive optimisation suite but not at least trying to use cutoffs which make the code reasonable fast seems wrong.",
    "created_at": "2012-04-26T11:43:48Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31339",
    "user": "https://github.com/malb"
}
```

<a id='comment:19'></a>
Replying to [mraum](#comment%3A18):
> The unsigned long thing seems OK (int_fast64_t is a C type, defined in stdint.h). For consistency it would be good if MAX_MODULUS was INTEGER_MOD_INT64_LIMIT to be found in sage/rings/finite_rings/stdint.h this is less by one. In integer_mod.pyx the modulus is tested using <= and in the patch < is used.

You are right, I got confused about Cython ctypdefs. "unsigned long" does not appear in a meaningful way in the generated C files. Sorry for the noise. Still, the documentation is wrong in various places and should be fixed (machine sized ints).
 
> Apart from this I more or less agree with all points made previously. If you don't see a good reason to change the Strassen cutoff, I would leave it at is. File a new ticket instead. We should optimize it, but changing it based on one observation is daring.

Fair enough, so let's make more observations. This code is about performance. I am not saying: let's run a comprehensive optimisation suite but not at least trying to use cutoffs which make the code reasonable fast seems wrong.



---

archive/issue_comments_031340.json:
```json
{
    "body": "<a id='comment:20'></a>\nI don't think this code is about performance. The new code will only be used in cases that were not available previously (see the cases treated in matrix_int_dense). This is why I would like to separate this patch and the optimization.\n\nAlso, please keep in mind, that not only William is desperate for having Sage use larger moduli (me certainly, John and his student recently posted on sage-devel, and most likely many more).",
    "created_at": "2012-04-26T11:50:34Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31340",
    "user": "https://trac.sagemath.org/admin/accounts/users/mraum"
}
```

<a id='comment:20'></a>
I don't think this code is about performance. The new code will only be used in cases that were not available previously (see the cases treated in matrix_int_dense). This is why I would like to separate this patch and the optimization.

Also, please keep in mind, that not only William is desperate for having Sage use larger moduli (me certainly, John and his student recently posted on sage-devel, and most likely many more).



---

archive/issue_comments_031341.json:
```json
{
    "body": "<a id='comment:21'></a>\nReplying to [mraum](#comment%3A20):\n> I don't think this code is about performance. The new code will only be used in cases that were not available previously (see the cases treated in matrix_int_dense). This is why I would like to separate this patch and the optimization.\n\nSage can compute with larger primes it's just terribly slow, this patch fixes that.\n\n> Also, please keep in mind, that not only William is desperate for having Sage use larger moduli (me certainly, John and his student recently posted on sage-devel, and most likely many more).\n\nFair enough. I am not asking anyone to spend days and days improving the performance, but I am asking those who care about this patch to spend 10 minutes to test various cutoff parameters so that we have a reasonable default. If there are that many people who care about this, this should be easy.",
    "created_at": "2012-04-26T12:07:40Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31341",
    "user": "https://github.com/malb"
}
```

<a id='comment:21'></a>
Replying to [mraum](#comment%3A20):
> I don't think this code is about performance. The new code will only be used in cases that were not available previously (see the cases treated in matrix_int_dense). This is why I would like to separate this patch and the optimization.

Sage can compute with larger primes it's just terribly slow, this patch fixes that.

> Also, please keep in mind, that not only William is desperate for having Sage use larger moduli (me certainly, John and his student recently posted on sage-devel, and most likely many more).

Fair enough. I am not asking anyone to spend days and days improving the performance, but I am asking those who care about this patch to spend 10 minutes to test various cutoff parameters so that we have a reasonable default. If there are that many people who care about this, this should be easy.



---

archive/issue_comments_031342.json:
```json
{
    "body": "<a id='comment:22'></a>\nI acknowledge that we really see this ticket from different perspectives.\n\nWould you be so kind and run some of the test that you think give a reasonable cutoff? If you post the commands, I can run them myself (on AMD and Intel). Based on this we can choose one.",
    "created_at": "2012-04-27T10:24:39Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31342",
    "user": "https://trac.sagemath.org/admin/accounts/users/mraum"
}
```

<a id='comment:22'></a>
I acknowledge that we really see this ticket from different perspectives.

Would you be so kind and run some of the test that you think give a reasonable cutoff? If you post the commands, I can run them myself (on AMD and Intel). Based on this we can choose one.



---

archive/issue_comments_031343.json:
```json
{
    "body": "<a id='comment:23'></a>\nI'd say just running\n\n```\nsage: A = random_matrix(GF(previous_prime(2^24)),1000,1000)\nsage: B = random_matrix(GF(previous_prime(2^24)),1000,1000)\nsage: %time A._multiply_strassen(B, 20)\nsage: %time A._multiply_strassen(B, 50)\nsage: %time A._multiply_strassen(B,100)\nsage: %time A._multiply_strassen(B,150)\nsage: %time A._multiply_strassen(B,200)\n```\n\nshould probably do the trick. I posted timings on my machine above. I'll run some timings on other machines as well.\n\nI'm really not suggesting to spend hours and hours on this, just that we should pick a decent default value, i.e., my impression is that 20 is bad on most machines. I might be wrong though.",
    "created_at": "2012-04-27T10:38:53Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31343",
    "user": "https://github.com/malb"
}
```

<a id='comment:23'></a>
I'd say just running

```
sage: A = random_matrix(GF(previous_prime(2^24)),1000,1000)
sage: B = random_matrix(GF(previous_prime(2^24)),1000,1000)
sage: %time A._multiply_strassen(B, 20)
sage: %time A._multiply_strassen(B, 50)
sage: %time A._multiply_strassen(B,100)
sage: %time A._multiply_strassen(B,150)
sage: %time A._multiply_strassen(B,200)
```

should probably do the trick. I posted timings on my machine above. I'll run some timings on other machines as well.

I'm really not suggesting to spend hours and hours on this, just that we should pick a decent default value, i.e., my impression is that 20 is bad on most machines. I might be wrong though.



---

archive/issue_comments_031344.json:
```json
{
    "body": "<a id='comment:24'></a>\nI'm completely with mraum here.  In fact I have run tests like you suggest to set the current parameters.  You'll find optimal parameters differ *dramatically* depending on the computer and the OS... e.g., Mac OS X could be totally different than one linux; Intel versus AMD, etc.   I can see almost no point in doing what you suggest above.  Either do things right (with a database for many machines), or leave it.",
    "created_at": "2012-04-27T11:15:22Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31344",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:24'></a>
I'm completely with mraum here.  In fact I have run tests like you suggest to set the current parameters.  You'll find optimal parameters differ *dramatically* depending on the computer and the OS... e.g., Mac OS X could be totally different than one linux; Intel versus AMD, etc.   I can see almost no point in doing what you suggest above.  Either do things right (with a database for many machines), or leave it.



---

archive/issue_comments_031345.json:
```json
{
    "body": "<a id='comment:25'></a>\nsage.math:\n\n**24 bits**\n\n```\nsage: %time _ = A._multiply_strassen(B, 20)\nCPU times: user 3.31 s, sys: 0.01 s, total: 3.32 s\nWall time: 3.32 s\n\nsage: %time _ = A._multiply_strassen(B, 50)\nCPU times: user 2.02 s, sys: 0.03 s, total: 2.05 s\nWall time: 2.04 s\n\nsage: %time _ = A._multiply_strassen(B,100)\nCPU times: user 1.90 s, sys: 0.01 s, total: 1.91 s\nWall time: 1.91 s\n```\n\n** 31 bits **\n\n```\nsage: %time _ = A._multiply_strassen(B,20)\nCPU times: user 4.06 s, sys: 0.00 s, total: 4.06 s\nWall time: 4.05 s\nsage: %time _ = A._multiply_strassen(B,50)\nCPU times: user 2.95 s, sys: 0.00 s, total: 2.95 s\nWall time: 2.95 s\n\nsage: %time _ = A._multiply_strassen(B,100)\nCPU times: user 3.00 s, sys: 0.00 s, total: 3.00 s\nWall time: 3.00 s\n\nsage: %time _ = A._multiply_strassen(B,200)\nCPU times: user 3.20 s, sys: 0.00 s, total: 3.20 s\nWall time: 3.20 s\n```",
    "created_at": "2012-04-27T11:18:22Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31345",
    "user": "https://github.com/malb"
}
```

<a id='comment:25'></a>
sage.math:

**24 bits**

```
sage: %time _ = A._multiply_strassen(B, 20)
CPU times: user 3.31 s, sys: 0.01 s, total: 3.32 s
Wall time: 3.32 s

sage: %time _ = A._multiply_strassen(B, 50)
CPU times: user 2.02 s, sys: 0.03 s, total: 2.05 s
Wall time: 2.04 s

sage: %time _ = A._multiply_strassen(B,100)
CPU times: user 1.90 s, sys: 0.01 s, total: 1.91 s
Wall time: 1.91 s
```

** 31 bits **

```
sage: %time _ = A._multiply_strassen(B,20)
CPU times: user 4.06 s, sys: 0.00 s, total: 4.06 s
Wall time: 4.05 s
sage: %time _ = A._multiply_strassen(B,50)
CPU times: user 2.95 s, sys: 0.00 s, total: 2.95 s
Wall time: 2.95 s

sage: %time _ = A._multiply_strassen(B,100)
CPU times: user 3.00 s, sys: 0.00 s, total: 3.00 s
Wall time: 3.00 s

sage: %time _ = A._multiply_strassen(B,200)
CPU times: user 3.20 s, sys: 0.00 s, total: 3.20 s
Wall time: 3.20 s
```



---

archive/issue_comments_031346.json:
```json
{
    "body": "<a id='comment:26'></a>\nReplying to [@williamstein](#comment%3A24):\n> I'm completely with mraum here.  In fact I have run tests like you suggest to set the current parameters.  You'll find optimal parameters differ *dramatically* depending on the computer and the OS... e.g., Mac OS X could be totally different than one linux; Intel versus AMD, etc.   I can see almost no point in doing what you suggest above.  Either do things right (with a database for many machines), or leave it.\n\nI find it odd to claim this before even trying (perhaps you did and I missed that though).",
    "created_at": "2012-04-27T11:19:54Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31346",
    "user": "https://github.com/malb"
}
```

<a id='comment:26'></a>
Replying to [@williamstein](#comment%3A24):
> I'm completely with mraum here.  In fact I have run tests like you suggest to set the current parameters.  You'll find optimal parameters differ *dramatically* depending on the computer and the OS... e.g., Mac OS X could be totally different than one linux; Intel versus AMD, etc.   I can see almost no point in doing what you suggest above.  Either do things right (with a database for many machines), or leave it.

I find it odd to claim this before even trying (perhaps you did and I missed that though).



---

archive/issue_comments_031347.json:
```json
{
    "body": "<a id='comment:27'></a>\n> I find it odd to claim this before even trying (perhaps you did and I missed that though).\n\nI did a lot of timings like the above on my laptop when writing this patch...",
    "created_at": "2012-04-27T11:55:29Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31347",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:27'></a>
> I find it odd to claim this before even trying (perhaps you did and I missed that though).

I did a lot of timings like the above on my laptop when writing this patch...



---

archive/issue_comments_031348.json:
```json
{
    "body": "<a id='comment:28'></a>\nSo, was 20 a good on your laptop (I am asking because the 20 cutoff is older than your patch).\n\nFWIW I'll try this on bsd.math and cicero.skynet. If those too suggest to increase the cutoff to > 20, I suggest we do that. If only bsd.math and sage.math agree, I'd still say it's worth increasing the limit, because these are more mainstream machines than cicero.skynet.",
    "created_at": "2012-04-27T11:59:24Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31348",
    "user": "https://github.com/malb"
}
```

<a id='comment:28'></a>
So, was 20 a good on your laptop (I am asking because the 20 cutoff is older than your patch).

FWIW I'll try this on bsd.math and cicero.skynet. If those too suggest to increase the cutoff to > 20, I suggest we do that. If only bsd.math and sage.math agree, I'd still say it's worth increasing the limit, because these are more mainstream machines than cicero.skynet.



---

archive/issue_comments_031349.json:
```json
{
    "body": "<a id='comment:29'></a>\nBtw. it seems something went wrong with the quashing, there are still mentions of `_uint64` in the patch.",
    "created_at": "2012-04-28T14:08:30Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31349",
    "user": "https://github.com/malb"
}
```

<a id='comment:29'></a>
Btw. it seems something went wrong with the quashing, there are still mentions of `_uint64` in the patch.



---

archive/issue_comments_031350.json:
```json
{
    "body": "<a id='comment:30'></a>\n**bsd.math**\n\n```\nsage: A = random_matrix(GF(previous_prime(2^24)),1000,1000)\nsage: B = random_matrix(GF(previous_prime(2^24)),1000,1000)\nsage: %time _ = A._multiply_strassen(B, 20)\nCPU times: user 2.87 s, sys: 0.01 s, total: 2.88 s\nWall time: 2.88 s\n\nsage: %time _ = A._multiply_strassen(B, 50)\nCPU times: user 1.47 s, sys: 0.01 s, total: 1.47 s\nWall time: 1.47 s\n\nsage: %time _ = A._multiply_strassen(B,100)\nCPU times: user 1.24 s, sys: 0.01 s, total: 1.24 s\nWall time: 1.24 s\n\nsage:  %time _ = A._multiply_strassen(B,150)\nCPU times: user 1.16 s, sys: 0.01 s, total: 1.17 s\nWall time: 1.17 s\n\nsage: %time _ = A._multiply_strassen(B,200)\nCPU times: user 1.16 s, sys: 0.01 s, total: 1.17 s\nWall time: 1.17 s\n```\n\n```\nsage: A = random_matrix(GF(previous_prime(2^31)),1000,1000)\nsage: B = random_matrix(GF(previous_prime(2^31)),1000,1000)\n\nsage: %time A._multiply_strassen(B, 20)\nCPU times: user 3.72 s, sys: 0.00 s, total: 3.72 s\nWall time: 3.72 s\n1000 x 1000 dense matrix over Finite Field of size 2147483647\n\nsage: %time _ = A._multiply_strassen(B, 50)\nCPU times: user 2.55 s, sys: 0.01 s, total: 2.55 s\nWall time: 2.55 s\n\nsage: %time _ = A._multiply_strassen(B,100)\nCPU times: user 2.53 s, sys: 0.01 s, total: 2.54 s\nWall time: 2.54 s\n\nsage: %time _ = A._multiply_strassen(B,150)\nCPU times: user 2.68 s, sys: 0.00 s, total: 2.69 s\nWall time: 2.69 s\n\nsage: %time _ = A._multiply_strassen(B,200)\nCPU times: user 2.68 s, sys: 0.00 s, total: 2.69 s\nWall time: 2.69 s\n```\n\nSo 100 is much better than 20, but not necessarily optimal.",
    "created_at": "2012-04-28T14:14:44Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31350",
    "user": "https://github.com/malb"
}
```

<a id='comment:30'></a>
**bsd.math**

```
sage: A = random_matrix(GF(previous_prime(2^24)),1000,1000)
sage: B = random_matrix(GF(previous_prime(2^24)),1000,1000)
sage: %time _ = A._multiply_strassen(B, 20)
CPU times: user 2.87 s, sys: 0.01 s, total: 2.88 s
Wall time: 2.88 s

sage: %time _ = A._multiply_strassen(B, 50)
CPU times: user 1.47 s, sys: 0.01 s, total: 1.47 s
Wall time: 1.47 s

sage: %time _ = A._multiply_strassen(B,100)
CPU times: user 1.24 s, sys: 0.01 s, total: 1.24 s
Wall time: 1.24 s

sage:  %time _ = A._multiply_strassen(B,150)
CPU times: user 1.16 s, sys: 0.01 s, total: 1.17 s
Wall time: 1.17 s

sage: %time _ = A._multiply_strassen(B,200)
CPU times: user 1.16 s, sys: 0.01 s, total: 1.17 s
Wall time: 1.17 s
```

```
sage: A = random_matrix(GF(previous_prime(2^31)),1000,1000)
sage: B = random_matrix(GF(previous_prime(2^31)),1000,1000)

sage: %time A._multiply_strassen(B, 20)
CPU times: user 3.72 s, sys: 0.00 s, total: 3.72 s
Wall time: 3.72 s
1000 x 1000 dense matrix over Finite Field of size 2147483647

sage: %time _ = A._multiply_strassen(B, 50)
CPU times: user 2.55 s, sys: 0.01 s, total: 2.55 s
Wall time: 2.55 s

sage: %time _ = A._multiply_strassen(B,100)
CPU times: user 2.53 s, sys: 0.01 s, total: 2.54 s
Wall time: 2.54 s

sage: %time _ = A._multiply_strassen(B,150)
CPU times: user 2.68 s, sys: 0.00 s, total: 2.69 s
Wall time: 2.69 s

sage: %time _ = A._multiply_strassen(B,200)
CPU times: user 2.68 s, sys: 0.00 s, total: 2.69 s
Wall time: 2.69 s
```

So 100 is much better than 20, but not necessarily optimal.



---

archive/issue_comments_031351.json:
```json
{
    "body": "<a id='comment:31'></a>\n**Cicero** is less conclusive as it's too loaded for benchmarketing. Anyway, here are the numbers:\n\n**2<sup>24</sup>**\n\n```\nsage: A = random_matrix(GF(previous_prime(2^24)),1000,1000)\nsage: B = random_matrix(GF(previous_prime(2^24)),1000,1000)\n\nsage: %time _ = A._multiply_strassen(B, 20)\nCPU times: user 25.93 s, sys: 0.03 s, total: 25.95 s\nWall time: 85.44 s\n\nsage: %time _ = A._multiply_strassen(B, 50)\nCPU times: user 21.48 s, sys: 0.04 s, total: 21.52 s\nWall time: 68.51 s\n\nsage: %time _ = A._multiply_strassen(B,100)\nCPU times: user 21.99 s, sys: 0.11 s, total: 22.09 s\nWall time: 70.36 s\n\nsage: %time _ = A._multiply_strassen(B,150)\nCPU times: user 23.95 s, sys: 0.05 s, total: 24.01 s\nWall time: 76.56 s\n```\n\n**2^31**\n\n```\nsage: A = random_matrix(GF(previous_prime(2^31)),1000,1000)\nsage: B = random_matrix(GF(previous_prime(2^31)),1000,1000)\nsage: %time _ = A._multiply_strassen(B, 20)\nCPU times: user 25.93 s, sys: 0.08 s, total: 26.00 s\nWall time: 83.17 s\n\nsage: %time _ = A._multiply_strassen(B, 50)\nCPU times: user 21.47 s, sys: 0.06 s, total: 21.53 s\nWall time: 68.69 s\n\nsage: %time _ = A._multiply_strassen(B,100)\nCPU times: user 22.02 s, sys: 0.06 s, total: 22.08 s\nWall time: 70.31 s\n\nsage: %time _ = A._multiply_strassen(B,150)\nCPU times: user 23.92 s, sys: 0.14 s, total: 24.06 s\nWall time: 76.67 s\n```\n\n*What I take away from these numbers:* increasing the default cutoff from 20 to 100 makes Sage  twice as fast on some mainstream architectures (64-bit Linux, Xeon), about 1.7x faster on others (64-bit OSX) and probably slightly faster on less mainstream architectures (32-bit Linux on Pentium4). Am I missing something here?",
    "created_at": "2012-04-29T14:19:11Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31351",
    "user": "https://github.com/malb"
}
```

<a id='comment:31'></a>
**Cicero** is less conclusive as it's too loaded for benchmarketing. Anyway, here are the numbers:

**2<sup>24</sup>**

```
sage: A = random_matrix(GF(previous_prime(2^24)),1000,1000)
sage: B = random_matrix(GF(previous_prime(2^24)),1000,1000)

sage: %time _ = A._multiply_strassen(B, 20)
CPU times: user 25.93 s, sys: 0.03 s, total: 25.95 s
Wall time: 85.44 s

sage: %time _ = A._multiply_strassen(B, 50)
CPU times: user 21.48 s, sys: 0.04 s, total: 21.52 s
Wall time: 68.51 s

sage: %time _ = A._multiply_strassen(B,100)
CPU times: user 21.99 s, sys: 0.11 s, total: 22.09 s
Wall time: 70.36 s

sage: %time _ = A._multiply_strassen(B,150)
CPU times: user 23.95 s, sys: 0.05 s, total: 24.01 s
Wall time: 76.56 s
```

**2^31**

```
sage: A = random_matrix(GF(previous_prime(2^31)),1000,1000)
sage: B = random_matrix(GF(previous_prime(2^31)),1000,1000)
sage: %time _ = A._multiply_strassen(B, 20)
CPU times: user 25.93 s, sys: 0.08 s, total: 26.00 s
Wall time: 83.17 s

sage: %time _ = A._multiply_strassen(B, 50)
CPU times: user 21.47 s, sys: 0.06 s, total: 21.53 s
Wall time: 68.69 s

sage: %time _ = A._multiply_strassen(B,100)
CPU times: user 22.02 s, sys: 0.06 s, total: 22.08 s
Wall time: 70.31 s

sage: %time _ = A._multiply_strassen(B,150)
CPU times: user 23.92 s, sys: 0.14 s, total: 24.06 s
Wall time: 76.67 s
```

*What I take away from these numbers:* increasing the default cutoff from 20 to 100 makes Sage  twice as fast on some mainstream architectures (64-bit Linux, Xeon), about 1.7x faster on others (64-bit OSX) and probably slightly faster on less mainstream architectures (32-bit Linux on Pentium4). Am I missing something here?



---

archive/attachments_005788.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "4968-review.patch",
    "asset_url": "tarball://root/attachments/ticket4968/4968-review.patch",
    "created_at": "2012-05-01T09:35:09Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket4968/4968-review.patch",
    "user": "https://trac.sagemath.org/admin/accounts/users/mraum"
}
```



---

archive/issue_comments_031352.json:
```json
{
    "body": "**Attachment:** [4968-review.patch](https://github.com/sagemath/sage/files/ticket4968/4968-review.patch)",
    "created_at": "2012-05-01T09:35:09Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31352",
    "user": "https://trac.sagemath.org/admin/accounts/users/mraum"
}
```

**Attachment:** [4968-review.patch](https://github.com/sagemath/sage/files/ticket4968/4968-review.patch)



---

archive/issue_comments_031353.json:
```json
{
    "body": "<a id='comment:32'></a>\nI made this work; Only very few points had been overseen when squashing.\n\nI changed the cutoff back to 100. Since William and I both think one should do it properly or not at all, I thought it would be best to keep the old cutoff. This had been 100. The biggest advantage from my perspective is that the release manager will have to deal with one change only (32 -> 64bit) and not with two, when investigating potential speed regressions. Not that I found any, but there are more exotic architectures than mine.",
    "created_at": "2012-05-01T09:38:36Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31353",
    "user": "https://trac.sagemath.org/admin/accounts/users/mraum"
}
```

<a id='comment:32'></a>
I made this work; Only very few points had been overseen when squashing.

I changed the cutoff back to 100. Since William and I both think one should do it properly or not at all, I thought it would be best to keep the old cutoff. This had been 100. The biggest advantage from my perspective is that the release manager will have to deal with one change only (32 -> 64bit) and not with two, when investigating potential speed regressions. Not that I found any, but there are more exotic architectures than mine.



---

archive/issue_comments_031354.json:
```json
{
    "body": "<a id='comment:33'></a>\nReplying to [mraum](#comment%3A32):\n> I changed the cutoff back to 100. Since William and I both think one should do it properly or not at all, I thought it would be best to keep the old cutoff. This had been 100. \n\nFair enough, 100 is what I was arguing for regardless. But I have to say being so blatantly ignored leaves a bitter aftertaste. Anyway, it seems to you have this patch covered, I won't intervene any more.",
    "created_at": "2012-05-01T09:52:06Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31354",
    "user": "https://github.com/malb"
}
```

<a id='comment:33'></a>
Replying to [mraum](#comment%3A32):
> I changed the cutoff back to 100. Since William and I both think one should do it properly or not at all, I thought it would be best to keep the old cutoff. This had been 100. 

Fair enough, 100 is what I was arguing for regardless. But I have to say being so blatantly ignored leaves a bitter aftertaste. Anyway, it seems to you have this patch covered, I won't intervene any more.



---

archive/issue_comments_031355.json:
```json
{
    "body": "<a id='comment:34'></a>\nPlease, don't take it like that. I was happy to see that your suggestion and the old cutoff were the same. But consider us changing this and the underlying implementation in parallel. What would the release manager do if regressions showed up. I would unmerge the whole thing (and we would feel like stealing his time). This way you can open a new ticket and do the optimization independently.",
    "created_at": "2012-05-01T18:45:24Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31355",
    "user": "https://trac.sagemath.org/admin/accounts/users/mraum"
}
```

<a id='comment:34'></a>
Please, don't take it like that. I was happy to see that your suggestion and the old cutoff were the same. But consider us changing this and the underlying implementation in parallel. What would the release manager do if regressions showed up. I would unmerge the whole thing (and we would feel like stealing his time). This way you can open a new ticket and do the optimization independently.



---

archive/issue_events_030347.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mraum",
    "created_at": "2012-05-01T18:45:24Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4968#event-30347"
}
```



---

archive/issue_events_030348.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mraum",
    "created_at": "2012-05-01T18:45:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4968#event-30348"
}
```



---

archive/issue_comments_031356.json:
```json
{
    "body": "<a id='comment:35'></a>\nBy the way, doctesting this patch left several (5-10) python processes running on a patchbot for more than 13 hours, which is probably abnormal...",
    "created_at": "2012-05-20T06:18:54Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31356",
    "user": "https://github.com/kini"
}
```

<a id='comment:35'></a>
By the way, doctesting this patch left several (5-10) python processes running on a patchbot for more than 13 hours, which is probably abnormal...



---

archive/issue_comments_031357.json:
```json
{
    "body": "<a id='comment:36'></a>\nI'm reviewing the linbox update (#12883), where malb removed linbox-stuff from `matrix_modn_dense.py`. This might conflict with this ticket's patch but, I think, only in a trivial way. If I got this wrong then please let me know.",
    "created_at": "2012-06-18T16:00:30Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31357",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:36'></a>
I'm reviewing the linbox update (#12883), where malb removed linbox-stuff from `matrix_modn_dense.py`. This might conflict with this ticket's patch but, I think, only in a trivial way. If I got this wrong then please let me know.



---

archive/issue_comments_031358.json:
```json
{
    "body": "<a id='comment:37'></a>\nThis ticket is in needs_review since three years... putting it into needs_info status, since obviously sagemath has move forward in the intervening time.",
    "created_at": "2015-03-11T16:22:01Z",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4968#issuecomment-31358",
    "user": "https://trac.sagemath.org/admin/accounts/users/Snark"
}
```

<a id='comment:37'></a>
This ticket is in needs_review since three years... putting it into needs_info status, since obviously sagemath has move forward in the intervening time.



---

archive/issue_events_030349.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/Snark",
    "created_at": "2015-03-11T16:22:01Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4968#event-30349"
}
```



---

archive/issue_events_030350.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/Snark",
    "created_at": "2015-03-11T16:22:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4968",
    "label": "needs info",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4968#event-30350"
}
```
