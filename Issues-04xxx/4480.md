# Issue 4480: [with new patch, positive review] cython dependancy checking is too slow

archive/issues_004480.json:
```json
{
    "body": "The attached patch builds the entire dependency tree from scratch in 0.6 seconds, and caches it to disk so subsequent dependency checking takes 0.05 seconds to verify. \n\nAssignee: @craigcitro\n\nCC:  @tornaria\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/4480\n\n",
    "closed_at": "2008-11-14T04:02:40Z",
    "created_at": "2008-11-09T12:45:56Z",
    "labels": [
        "component: build",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-3.2",
    "title": "[with new patch, positive review] cython dependancy checking is too slow",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/4480",
    "user": "https://github.com/robertwb"
}
```
The attached patch builds the entire dependency tree from scratch in 0.6 seconds, and caches it to disk so subsequent dependency checking takes 0.05 seconds to verify. 

Assignee: @craigcitro

CC:  @tornaria

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/4480





---

archive/issue_comments_033027.json:
```json
{
    "body": "Attachment [4480-cython-deps.patch](tarball://root/attachments/some-uuid/ticket4480/4480-cython-deps.patch) by @robertwb created at 2008-11-09 13:07:50",
    "created_at": "2008-11-09T13:07:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4480#issuecomment-33027",
    "user": "https://github.com/robertwb"
}
```

Attachment [4480-cython-deps.patch](tarball://root/attachments/some-uuid/ticket4480/4480-cython-deps.patch) by @robertwb created at 2008-11-09 13:07:50



---

archive/issue_comments_033028.json:
```json
{
    "body": "<a id='comment:1'></a>So Gonzalo and I are in the middle of writing the build process in `setup.py`. Luckily, the business of finding includes is the one piece of code we were reusing! So I'll review/merge this into our patch once we're done, which should be today.",
    "created_at": "2008-11-09T16:08:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4480#issuecomment-33028",
    "user": "https://github.com/craigcitro"
}
```

<a id='comment:1'></a>So Gonzalo and I are in the middle of writing the build process in `setup.py`. Luckily, the business of finding includes is the one piece of code we were reusing! So I'll review/merge this into our patch once we're done, which should be today.



---

archive/issue_comments_033029.json:
```json
{
    "body": "<a id='comment:2'></a>Attachment [trac-4480-rc0.patch](tarball://root/attachments/some-uuid/ticket4480/trac-4480-rc0.patch) by @craigcitro created at 2008-11-13 13:42:14\n\nHere we go! So this patch applies on top of `rc0` + the patch at #4500, because it was a needed fix. With this patch in, we've got it all: fast cached dependency checking, parallel calls to Cython, and dozens of small improvements to the build system thrown in, too. I also reorganized `setup.py` and created a `module_list.py` to have the list of extension modules. \n\nRobert, I've looked at (probably every line of) your code which is now in here -- can you review the rest? I did make small changes to one or two of your functions; in particular, `parse_deps`, I think.\n\nI've run it through some paces, but I'm happy to fix any bugs that pop up.\n\nCredit should go to Rob, Gonzalo, and me.",
    "created_at": "2008-11-13T13:42:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4480#issuecomment-33029",
    "user": "https://github.com/craigcitro"
}
```

<a id='comment:2'></a>Attachment [trac-4480-rc0.patch](tarball://root/attachments/some-uuid/ticket4480/trac-4480-rc0.patch) by @craigcitro created at 2008-11-13 13:42:14

Here we go! So this patch applies on top of `rc0` + the patch at #4500, because it was a needed fix. With this patch in, we've got it all: fast cached dependency checking, parallel calls to Cython, and dozens of small improvements to the build system thrown in, too. I also reorganized `setup.py` and created a `module_list.py` to have the list of extension modules. 

Robert, I've looked at (probably every line of) your code which is now in here -- can you review the rest? I did make small changes to one or two of your functions; in particular, `parse_deps`, I think.

I've run it through some paces, but I'm happy to fix any bugs that pop up.

Credit should go to Rob, Gonzalo, and me.



---

archive/issue_comments_033030.json:
```json
{
    "body": "Changing status from new to assigned.",
    "created_at": "2008-11-13T13:42:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4480#issuecomment-33030",
    "user": "https://github.com/craigcitro"
}
```

Changing status from new to assigned.



---

archive/issue_comments_033031.json:
```json
{
    "body": "Changing assignee from mabshoff to @craigcitro.",
    "created_at": "2008-11-13T13:42:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4480#issuecomment-33031",
    "user": "https://github.com/craigcitro"
}
```

Changing assignee from mabshoff to @craigcitro.



---

archive/issue_events_010131.json:
```json
{
    "actor": "https://github.com/craigcitro",
    "created_at": "2008-11-13T13:42:25Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/4480",
    "milestone": "sage-3.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4480#event-10131"
}
```



---

archive/issue_comments_033032.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2008-11-13T13:42:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4480#issuecomment-33032",
    "user": "https://github.com/craigcitro"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_033033.json:
```json
{
    "body": "<a id='comment:4'></a>I am giving a positive review to all the changes that move the extensions to the new file. But we need a formal review for Robert's changes and since Craig was involved here, too, I am not so sure who would review what portion of those.\n\nI am testing a vanilla tree with the fixes here and #4500 applied, so I should be able to at least see if everything works as expected when combining all pieces into a virgin  build.\n\nThoughts?\n\nCheers,\n\nMichael",
    "created_at": "2008-11-13T16:43:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4480#issuecomment-33033",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:4'></a>I am giving a positive review to all the changes that move the extensions to the new file. But we need a formal review for Robert's changes and since Craig was involved here, too, I am not so sure who would review what portion of those.

I am testing a vanilla tree with the fixes here and #4500 applied, so I should be able to at least see if everything works as expected when combining all pieces into a virgin  build.

Thoughts?

Cheers,

Michael



---

archive/issue_comments_033034.json:
```json
{
    "body": "<a id='comment:5'></a>I'll look at this today. I only apply the last patch, right?",
    "created_at": "2008-11-13T18:03:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4480#issuecomment-33034",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:5'></a>I'll look at this today. I only apply the last patch, right?



---

archive/issue_comments_033035.json:
```json
{
    "body": "<a id='comment:6'></a>Yes, but you should also apply \n\nhttp://trac.sagemath.org/sage_trac/attachment/ticket/4500/trac-4500.patch\n\nin this context. I found an issue when building from vanilla with both the last patch here and trac-4500.patch applied and there is an issue that I mentioned on the other ticket with a work around fix, but I am not sure if it is the correct fix. It does work, but that does not mean that it is either elegant or proper.\n\nCheers,\n\nMichael",
    "created_at": "2008-11-13T18:05:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4480#issuecomment-33035",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:6'></a>Yes, but you should also apply 

http://trac.sagemath.org/sage_trac/attachment/ticket/4500/trac-4500.patch

in this context. I found an issue when building from vanilla with both the last patch here and trac-4500.patch applied and there is an issue that I mentioned on the other ticket with a work around fix, but I am not sure if it is the correct fix. It does work, but that does not mean that it is either elegant or proper.

Cheers,

Michael



---

archive/issue_comments_033036.json:
```json
{
    "body": "<a id='comment:7'></a>It looks good to me...this is a much needed cleanup! \n\nI think mabshoff's fix proposed #4500 is good, and should also be applied.",
    "created_at": "2008-11-13T22:27:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4480#issuecomment-33036",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:7'></a>It looks good to me...this is a much needed cleanup! 

I think mabshoff's fix proposed #4500 is good, and should also be applied.



---

archive/issue_comments_033037.json:
```json
{
    "body": "<a id='comment:8'></a>Ditto on mabshoff's fix at #4500.",
    "created_at": "2008-11-13T22:36:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4480#issuecomment-33037",
    "user": "https://github.com/craigcitro"
}
```

<a id='comment:8'></a>Ditto on mabshoff's fix at #4500.



---

archive/issue_comments_033038.json:
```json
{
    "body": "<a id='comment:9'></a>In addition to mabshoff's fix at #4500, I think we should add the following:\n\n```\ndiff -r c543000d6447 setup.py\n--- a/setup.py  Thu Nov 13 05:32:07 2008 -0800\n+++ b/setup.py  Thu Nov 13 16:26:41 2008 -0800\n@@ -13,11 +13,11 @@\n else:\n     sdist = False\n \n-# uncomment to turn warnings off\n-# import distutils.sysconfig\n-# NO_WARN = True\n-# if NO_WARN and distutils.sysconfig.get_config_var('CC').startswith(\"gcc\"):\n-#     extra_compile_args = ['-w']\n+# comment these four lines out to turn on warnings from gcc\n+import distutils.sysconfig\n+NO_WARN = True\n+if NO_WARN and distutils.sysconfig.get_config_var('CC').startswith(\"gcc\"):\n+    extra_compile_args = ['-w']\n \n if not os.environ.has_key('SAGE_ROOT'):\n     print \"    ERROR: The environment variable SAGE_ROOT must be defined.\"\n```\n\nThis just turns warnings back off -- as William points out, it's a lot of output for the unsuspecting. Michael and I had discussed this when we changed it, and it would be good to sit down and actually look at the warnings once to see if anything interesting is being turned up. In the interim, though, let's not spam. ;)",
    "created_at": "2008-11-14T00:31:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4480#issuecomment-33038",
    "user": "https://github.com/craigcitro"
}
```

<a id='comment:9'></a>In addition to mabshoff's fix at #4500, I think we should add the following:

```
diff -r c543000d6447 setup.py
--- a/setup.py  Thu Nov 13 05:32:07 2008 -0800
+++ b/setup.py  Thu Nov 13 16:26:41 2008 -0800
@@ -13,11 +13,11 @@
 else:
     sdist = False
 
-# uncomment to turn warnings off
-# import distutils.sysconfig
-# NO_WARN = True
-# if NO_WARN and distutils.sysconfig.get_config_var('CC').startswith("gcc"):
-#     extra_compile_args = ['-w']
+# comment these four lines out to turn on warnings from gcc
+import distutils.sysconfig
+NO_WARN = True
+if NO_WARN and distutils.sysconfig.get_config_var('CC').startswith("gcc"):
+    extra_compile_args = ['-w']
 
 if not os.environ.has_key('SAGE_ROOT'):
     print "    ERROR: The environment variable SAGE_ROOT must be defined."
```

This just turns warnings back off -- as William points out, it's a lot of output for the unsuspecting. Michael and I had discussed this when we changed it, and it would be good to sit down and actually look at the warnings once to see if anything interesting is being turned up. In the interim, though, let's not spam. ;)



---

archive/issue_comments_033039.json:
```json
{
    "body": "<a id='comment:10'></a>I'm OK with that.",
    "created_at": "2008-11-14T01:17:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4480#issuecomment-33039",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:10'></a>I'm OK with that.



---

archive/issue_comments_033040.json:
```json
{
    "body": "<a id='comment:11'></a>Can somebody post a cumulative patch here?\n\nCheers,\n\nMichael",
    "created_at": "2008-11-14T03:38:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4480#issuecomment-33040",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:11'></a>Can somebody post a cumulative patch here?

Cheers,

Michael



---

archive/issue_events_010132.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2008-11-14T04:02:40Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/4480",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4480#event-10132"
}
```



---

archive/issue_comments_033041.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2008-11-14T04:02:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4480#issuecomment-33041",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

Resolution: fixed



---

archive/issue_comments_033042.json:
```json
{
    "body": "<a id='comment:12'></a>Attachment [trac-4480-cumulative.patch](tarball://root/attachments/some-uuid/ticket4480/trac-4480-cumulative.patch) by mabshoff created at 2008-11-14 04:02:40\n\nMerged trac-4480-cumulative.patch in Sage 3.2.rc1",
    "created_at": "2008-11-14T04:02:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4480#issuecomment-33042",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:12'></a>Attachment [trac-4480-cumulative.patch](tarball://root/attachments/some-uuid/ticket4480/trac-4480-cumulative.patch) by mabshoff created at 2008-11-14 04:02:40

Merged trac-4480-cumulative.patch in Sage 3.2.rc1



---

archive/issue_comments_033043.json:
```json
{
    "body": "okay, maybe it only feels like part 18. :)",
    "created_at": "2008-11-14T05:02:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4480#issuecomment-33043",
    "user": "https://github.com/craigcitro"
}
```

okay, maybe it only feels like part 18. :)



---

archive/issue_comments_033044.json:
```json
{
    "body": "<a id='comment:13'></a>Attachment [trac-4480-pt18.patch](tarball://root/attachments/some-uuid/ticket4480/trac-4480-pt18.patch) by mabshoff created at 2008-11-14 05:24:29\n\nMerged trac-4480-pt18.patch in Sage 3.2.rc1.\n\nThanks Craig.\n\nCheers,\n\nMichael",
    "created_at": "2008-11-14T05:24:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4480",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4480#issuecomment-33044",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:13'></a>Attachment [trac-4480-pt18.patch](tarball://root/attachments/some-uuid/ticket4480/trac-4480-pt18.patch) by mabshoff created at 2008-11-14 05:24:29

Merged trac-4480-pt18.patch in Sage 3.2.rc1.

Thanks Craig.

Cheers,

Michael
