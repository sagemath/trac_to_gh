# Issue 4620: setup.py: if the cythonization fails then next "sage -b" starts to build extensions

archive/issues_004620.json:
```json
{
    "assignees": [],
    "body": "This is with 3.2.1.alpha1-current. To reproduce do a \"sage -ba\" and have a Cython process fail. Then the next \"sage -b\" will not pick up with the Cythonization again, but start building extensions.\n\nDeleting .cython_deps does not fix the problem.\n\nCheers,\n\nMichael\n\n**Assignee:** @craigcitro\n\nIssue created by migration from https://trac.sagemath.org/ticket/4620\n\n",
    "closed_at": "2008-11-26T09:35:20Z",
    "created_at": "2008-11-25T23:19:49Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20build",
        "https://github.com/sagemath/sage/labels/blocker",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-3.2.1",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "setup.py: if the cythonization fails then next \"sage -b\" starts to build extensions",
    "type": "issue",
    "updated_at": "2008-11-26T09:35:20Z",
    "url": "https://github.com/sagemath/sage/issues/4620",
    "user": "https://github.com/sagetrac-mabshoff"
}
```
This is with 3.2.1.alpha1-current. To reproduce do a "sage -ba" and have a Cython process fail. Then the next "sage -b" will not pick up with the Cythonization again, but start building extensions.

Deleting .cython_deps does not fix the problem.

Cheers,

Michael

**Assignee:** @craigcitro

Issue created by migration from https://trac.sagemath.org/ticket/4620





---

archive/issue_events_043234.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-11-25T23:19:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/4620",
    "milestone_number": null,
    "milestone_title": "sage-3.2.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4620#event-43234"
}
```



---

archive/issue_events_043235.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-11-25T23:19:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4620",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20build",
    "label_color": "08517b",
    "label_name": "component: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4620#event-43235"
}
```



---

archive/issue_events_043236.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-11-25T23:19:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4620",
    "label": "https://github.com/sagemath/sage/labels/blocker",
    "label_color": "ff0000",
    "label_name": "blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4620#event-43236"
}
```



---

archive/issue_events_043237.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-11-25T23:19:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4620",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "008080",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4620#event-43237"
}
```



---

archive/issue_comments_028671.json:
```json
{
    "body": "**Attachment:** [trac-4620.patch.gz](https://github.com/sagemath/sage/files/ticket4620/trac-4620.patch.gz)",
    "created_at": "2008-11-26T08:45:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4620#issuecomment-28671",
    "user": "https://github.com/craigcitro"
}
```

**Attachment:** [trac-4620.patch.gz](https://github.com/sagemath/sage/files/ticket4620/trac-4620.patch.gz)



---

archive/issue_events_043238.json:
```json
{
    "actor": "https://github.com/craigcitro",
    "created_at": "2008-11-26T08:49:30Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4620",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4620#event-43238"
}
```



---

archive/issue_comments_028672.json:
```json
{
    "body": "<a id='comment:1'>**Comment 1:**</a>\nThe attached patch fixes the issue. The problem was that we were copying the files at one point in the code, and then running Cython later. Of course, if Cython failed, the code was still copied, which meant it would pass a timestamp comparison on later builds. The patch fixes this by only copying once the file is successfully built. \n\nIn addition, it slightly expands the capabilities of William's parallel build code: now, in addition to accepting strings, it accepts pairs of the form `[f, v]`, and calls `f(v)`. The previous code did this with `f` always being `run_command`.",
    "created_at": "2008-11-26T08:49:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4620#issuecomment-28672",
    "user": "https://github.com/craigcitro"
}
```

<a id='comment:1'>**Comment 1:**</a>
The attached patch fixes the issue. The problem was that we were copying the files at one point in the code, and then running Cython later. Of course, if Cython failed, the code was still copied, which meant it would pass a timestamp comparison on later builds. The patch fixes this by only copying once the file is successfully built. 

In addition, it slightly expands the capabilities of William's parallel build code: now, in addition to accepting strings, it accepts pairs of the form `[f, v]`, and calls `f(v)`. The previous code did this with `f` always being `run_command`.



---

archive/issue_events_043239.json:
```json
{
    "actor": "https://github.com/craigcitro",
    "created_at": "2008-11-26T08:49:30Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/4620",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4620#event-43239"
}
```



---

archive/issue_events_043240.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-11-26T09:35:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4620",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4620#event-43240"
}
```



---

archive/issue_comments_028673.json:
```json
{
    "body": "<a id='comment:2'>**Comment 2:**</a>\nNice work. Thanks for fixing this quickly.\n\nCheers,\n\nMichael",
    "created_at": "2008-11-26T09:35:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4620#issuecomment-28673",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<a id='comment:2'>**Comment 2:**</a>
Nice work. Thanks for fixing this quickly.

Cheers,

Michael



---

archive/issue_comments_028674.json:
```json
{
    "body": "<a id='comment:3'>**Comment 3:**</a>\nMerged in Sage 3.2.1.alpha1",
    "created_at": "2008-11-26T09:35:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4620#issuecomment-28674",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<a id='comment:3'>**Comment 3:**</a>
Merged in Sage 3.2.1.alpha1



---

archive/issue_events_043241.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-11-26T09:35:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/4620",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4620#event-43241"
}
```



---

archive/issue_events_043242.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-11-26T09:35:20Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/4620",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4620#event-43242"
}
```
