# Issue 4302: improve modular composition in GF(2)[x] and GF(2)[x]

archive/issues_004302.json:
```json
{
    "assignees": [],
    "body": "Here is a toy implementation of polynomial modular composition over GF(2). It implements\nBrent-Kung's Algorithm 2.1 (Fast Algorithms for Manipulation Formal Power Series, JACM 1978).\n\n```\n# compute f(g) mod h\ndef ModularComposition(f,g,h,k=None):\n    print \"enter ModularComposition\", f.degree(), g.degree(), h.degree()\n    t = cputime()\n    R = h.parent()\n    n = h.degree()\n    if k is None:\n        k = ceil(Integer(n+1).sqrt_approx())\n    l = ceil((f.degree() + 1) / k)\n    # first compute g^j mod h, 2 <= j < k\n    G = Matrix(GF(2),n,k)\n    gpow = R(1)\n    for j in range(0, k):\n        # gpow = g^j mod h\n        row = gpow.coeffs()\n        if len(row)<n:\n            row.extend([R(0) for _ in range(n - len(row))])\n        G.set_column(j, row)\n        gpow = (gpow * g) % h # we'll need g^k below\n    print \"Creating G took\", cputime(t)\n    t = cputime()\n    # split f in chunks of degree < k\n    F = Matrix(GF(2),k,l)\n    row = f.coeffs()\n    if len(row)<k*l:\n            row.extend([R(0) for _ in range(k*l - len(row))])\n    for j in range(0, l):\n        F.set_column(j, row[j*k:j*k+k])\n    print \"Creating F took\", cputime(t)\n    t = cputime()\n    H = G * F # this is the most time-computing step, but M4RI is fast!\n    print \"Computing H took\", cputime(t)\n    t = cputime()\n    # H is a n x l matrix\n    # now H[i,j] = sum(G[i,m]*F[m,j], m=0..k-1)\n    #            = sum(g^m[i] * f[j*k+m], m=0..k-1)\n    # where g^m[i] is the coefficient of degree i in g^m\n    # and f[j*k+m] is the coefficient of degree j*k+m in f\n    # thus f[j*k+m]*g^m[i] should be multiplied by g^(j*k)\n    # gpow = (g^k) % h\n    x = h.variables()[0]\n    res = R(0)\n    j = l - 1\n    H = H.transpose()\n    while j >= 0:\n        res = (res * gpow) % h\n        # res = res + R([H[j,i] for i in range(0,n)])\n        res = res + R(H.submatrix(j,0,1,n).list())\n        j = j - 1\n    print \"Forming result took\", cputime(t)\n    sys.stdout.flush()\n    return res\n\n# computes x^(2^r) mod f\ndef ModCompPower (f, r):\n    l = r.digits()\n    l.reverse()\n    n = len(l)\n    g = f.variables()[0]\n    for i in range(n):\n        g = ModularComposition(g,g,f)\n        if l[i] == 1:\n           g = (g * g) % f\n    return g\n```\nThe following benchmark gives on a 2.4Ghz Core 2:\n\n```\nsage: r=1279\nsage: time a = ModCompPower(R(x^r+x+1), r)\nenter ModularComposition 1 1 1279\n   Creating G took 3.948399\n   Creating F took 0.00299900000005\n   Computing H took 0.000999999999976\n   Forming result took 0.0169980000001\nenter ModularComposition 2 2 1279\n   Creating G took 3.896408\n   Creating F took 0.004999\n   Computing H took 0.0\n   Forming result took 0.018997\nenter ModularComposition 4 4 1279\n   Creating G took 3.802422\n   Creating F took 0.00300000000004\n   Computing H took 0.000999999999976\n   Forming result took 0.018997\nenter ModularComposition 16 16 1279\n   Creating G took 3.208512\n   Creating F took 0.00299900000005\n   Computing H took 0.0\n   Forming result took 0.0169979999999\nenter ModularComposition 512 512 1279\n   Creating G took 2.413633\n   Creating F took 0.004999\n   Computing H took 0.00100000000009\n   Forming result took 0.307953\nenter ModularComposition 1202 1202 1279\n   Creating G took 0.895864\n   Creating F took 0.00999899999999\n   Computing H took 0.0\n   Forming result took 0.787879\nenter ModularComposition 1272 1272 1279\n   Creating G took 0.528921\n   Creating F took 0.009997\n   Computing H took 0.000999999999976\n   Forming result took 0.633905\nenter ModularComposition 1275 1275 1279\n   Creating G took 0.474927\n   Creating F took 0.00899800000002\n   Computing H took 0.000999999999976\n   Forming result took 0.630905\nenter ModularComposition 1278 1278 1279\n   Creating G took 0.533918\n   Creating F took 0.00799899999993\n   Computing H took 0.0\n   Forming result took 0.631904\nenter ModularComposition 1277 1277 1279\n   Creating G took 0.482927\n   Creating F took 0.00599899999997\n   Computing H took 0.000999999999976\n   Forming result took 0.609907\nenter ModularComposition 1277 1277 1279\n   Creating G took 0.563913\n   Creating F took 0.00899900000002\n   Computing H took 0.0\n   Forming result took 0.602908\nCPU times: user 24.37 s, sys: 0.79 s, total: 25.16 s\nWall time: 27.67 s\n```\nSeveral remarks:\n* the time spent in M4RI (Computing H) is negligible;\n* the time spent in \"Creating G\" and \"Forming result\" is large,\n and is even larger when the inputs have small degree! Something strange happens here.\n\nAs a comparison, on the same machine, Magma V2.14-8 takes only 0.02s with the following code:\n\n```\nR<x> := PolynomialRing(GF(2));\n\n/* computes x^(2^r) mod f */\nModCompPower := function(f, r)\n   l := [];\n   t := r;\n   while t ne 0 do\n      l := Append(l, t mod 2);\n      t := t div 2;\n   end while;\n   g := x;\n   for i := #l to 1 by -1 do\n      g := ModularComposition(g,g,f);\n      if l[i] eq 1 then\n         g := Modexp(g,2,f);\n      end if;\n   end for;\n   return g;\nend function;\n\n> r:=1279; time a:=ModCompPower(x^r+x+1, r);\nTime: 0.020\n```\nThe challenge is to do better than Magma within Sage.\n\n**CC:**  @robertwb @zimmermann6 @malb\n\nIssue created by migration from https://trac.sagemath.org/ticket/4302\n\n",
    "closed_at": "2008-10-26T00:51:43Z",
    "created_at": "2008-10-15T16:36:18Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20basic%20arithmetic"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-3.2",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "improve modular composition in GF(2)[x] and GF(2)[x]",
    "type": "issue",
    "updated_at": "2008-10-26T00:51:43Z",
    "url": "https://github.com/sagemath/sage/issues/4302",
    "user": "https://github.com/zimmermann6"
}
```
Here is a toy implementation of polynomial modular composition over GF(2). It implements
Brent-Kung's Algorithm 2.1 (Fast Algorithms for Manipulation Formal Power Series, JACM 1978).

```
# compute f(g) mod h
def ModularComposition(f,g,h,k=None):
    print "enter ModularComposition", f.degree(), g.degree(), h.degree()
    t = cputime()
    R = h.parent()
    n = h.degree()
    if k is None:
        k = ceil(Integer(n+1).sqrt_approx())
    l = ceil((f.degree() + 1) / k)
    # first compute g^j mod h, 2 <= j < k
    G = Matrix(GF(2),n,k)
    gpow = R(1)
    for j in range(0, k):
        # gpow = g^j mod h
        row = gpow.coeffs()
        if len(row)<n:
            row.extend([R(0) for _ in range(n - len(row))])
        G.set_column(j, row)
        gpow = (gpow * g) % h # we'll need g^k below
    print "Creating G took", cputime(t)
    t = cputime()
    # split f in chunks of degree < k
    F = Matrix(GF(2),k,l)
    row = f.coeffs()
    if len(row)<k*l:
            row.extend([R(0) for _ in range(k*l - len(row))])
    for j in range(0, l):
        F.set_column(j, row[j*k:j*k+k])
    print "Creating F took", cputime(t)
    t = cputime()
    H = G * F # this is the most time-computing step, but M4RI is fast!
    print "Computing H took", cputime(t)
    t = cputime()
    # H is a n x l matrix
    # now H[i,j] = sum(G[i,m]*F[m,j], m=0..k-1)
    #            = sum(g^m[i] * f[j*k+m], m=0..k-1)
    # where g^m[i] is the coefficient of degree i in g^m
    # and f[j*k+m] is the coefficient of degree j*k+m in f
    # thus f[j*k+m]*g^m[i] should be multiplied by g^(j*k)
    # gpow = (g^k) % h
    x = h.variables()[0]
    res = R(0)
    j = l - 1
    H = H.transpose()
    while j >= 0:
        res = (res * gpow) % h
        # res = res + R([H[j,i] for i in range(0,n)])
        res = res + R(H.submatrix(j,0,1,n).list())
        j = j - 1
    print "Forming result took", cputime(t)
    sys.stdout.flush()
    return res

# computes x^(2^r) mod f
def ModCompPower (f, r):
    l = r.digits()
    l.reverse()
    n = len(l)
    g = f.variables()[0]
    for i in range(n):
        g = ModularComposition(g,g,f)
        if l[i] == 1:
           g = (g * g) % f
    return g
```
The following benchmark gives on a 2.4Ghz Core 2:

```
sage: r=1279
sage: time a = ModCompPower(R(x^r+x+1), r)
enter ModularComposition 1 1 1279
   Creating G took 3.948399
   Creating F took 0.00299900000005
   Computing H took 0.000999999999976
   Forming result took 0.0169980000001
enter ModularComposition 2 2 1279
   Creating G took 3.896408
   Creating F took 0.004999
   Computing H took 0.0
   Forming result took 0.018997
enter ModularComposition 4 4 1279
   Creating G took 3.802422
   Creating F took 0.00300000000004
   Computing H took 0.000999999999976
   Forming result took 0.018997
enter ModularComposition 16 16 1279
   Creating G took 3.208512
   Creating F took 0.00299900000005
   Computing H took 0.0
   Forming result took 0.0169979999999
enter ModularComposition 512 512 1279
   Creating G took 2.413633
   Creating F took 0.004999
   Computing H took 0.00100000000009
   Forming result took 0.307953
enter ModularComposition 1202 1202 1279
   Creating G took 0.895864
   Creating F took 0.00999899999999
   Computing H took 0.0
   Forming result took 0.787879
enter ModularComposition 1272 1272 1279
   Creating G took 0.528921
   Creating F took 0.009997
   Computing H took 0.000999999999976
   Forming result took 0.633905
enter ModularComposition 1275 1275 1279
   Creating G took 0.474927
   Creating F took 0.00899800000002
   Computing H took 0.000999999999976
   Forming result took 0.630905
enter ModularComposition 1278 1278 1279
   Creating G took 0.533918
   Creating F took 0.00799899999993
   Computing H took 0.0
   Forming result took 0.631904
enter ModularComposition 1277 1277 1279
   Creating G took 0.482927
   Creating F took 0.00599899999997
   Computing H took 0.000999999999976
   Forming result took 0.609907
enter ModularComposition 1277 1277 1279
   Creating G took 0.563913
   Creating F took 0.00899900000002
   Computing H took 0.0
   Forming result took 0.602908
CPU times: user 24.37 s, sys: 0.79 s, total: 25.16 s
Wall time: 27.67 s
```
Several remarks:
* the time spent in M4RI (Computing H) is negligible;
* the time spent in "Creating G" and "Forming result" is large,
 and is even larger when the inputs have small degree! Something strange happens here.

As a comparison, on the same machine, Magma V2.14-8 takes only 0.02s with the following code:

```
R<x> := PolynomialRing(GF(2));

/* computes x^(2^r) mod f */
ModCompPower := function(f, r)
   l := [];
   t := r;
   while t ne 0 do
      l := Append(l, t mod 2);
      t := t div 2;
   end while;
   g := x;
   for i := #l to 1 by -1 do
      g := ModularComposition(g,g,f);
      if l[i] eq 1 then
         g := Modexp(g,2,f);
      end if;
   end for;
   return g;
end function;

> r:=1279; time a:=ModCompPower(x^r+x+1, r);
Time: 0.020
```
The challenge is to do better than Magma within Sage.

**CC:**  @robertwb @zimmermann6 @malb

Issue created by migration from https://trac.sagemath.org/ticket/4302





---

archive/issue_events_039497.json:
```json
{
    "actor": "https://github.com/zimmermann6",
    "created_at": "2008-10-15T16:36:18Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "milestone_number": null,
    "milestone_title": "sage-3.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4302#event-39497"
}
```



---

archive/issue_events_039498.json:
```json
{
    "actor": "https://github.com/zimmermann6",
    "created_at": "2008-10-15T16:36:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20basic%20arithmetic",
    "label_color": "08517b",
    "label_name": "component: basic arithmetic",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4302#event-39498"
}
```



---

archive/issue_events_039499.json:
```json
{
    "actor": "https://github.com/malb",
    "created_at": "2008-10-17T01:00:25Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "rename": {
        "from": "[challenge] improve modular composition in GF(2)[x]",
        "to": "improve modular composition in GF(2)[x]"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4302#event-39499"
}
```



---

archive/issue_events_039500.json:
```json
{
    "actor": "https://github.com/malb",
    "created_at": "2008-10-17T01:00:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4302#event-39500"
}
```



---

archive/issue_comments_025720.json:
```json
{
    "body": "<a id='comment:2'></a>\nCCing Robert because the patch implements his template idea.",
    "created_at": "2008-10-17T01:01:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4302#issuecomment-25720",
    "user": "https://github.com/malb"
}
```

<a id='comment:2'></a>
CCing Robert because the patch implements his template idea.



---

archive/issue_comments_025721.json:
```json
{
    "body": "<a id='comment:3'></a>\nThis is what I sent to Paul earlier about the patch\n\n>I've improved said implementation on my train ride after Sage Days. The result \n>is faster than Magma but only competitive with NTL. It seems NTL is already \n>faster than Magma for this problem and that the runtime is dominated by the \n>construction of the matrices (ntl.GF2X arithmetic mainly) and the recovery of \n>the result (ntl.GF2X arithmetic mainly). There is room for improvements \n>w.r.t. the conversion between ntl.GF2X and M4RI but I didn't bother yet \n>because ntl.GF2X arithmetic seems to be the main bottleneck for now. Note \n>that matrix multiplication takes up only a tiny fraction of the overall \n>runtime, it is almost negligible. \n>\n>Maybe, once we switch to the GF2X library things will look different enough to \n>motivate a better tuned conversion routine?\n\n```\nf = R.random_element(30000)\ng = R.random_element(30000)\nh = R.random_element(30000*10)\n```\n\n```\n%time \nset_verbose(1)\n_ = f.modular_composition(g,h)\nverbose 1 (1: , <module>) G 548 x 299999 16.331 s\nverbose 1 (1: , <module>) F 55 x 548 0.000 s\nverbose 1 (1: , <module>) H 55 x 299999 0.230 s\nverbose 1 (1: , <module>) Res 6.359 s\nCPU time: 22.98 s,  Wall time: 23.42 s\n```\n\n```\n%time _ = f.modular_composition(g,h,'ntl')\nverbose 1 (1: , <module>) NTL 23.998 s\nCPU time: 24.07 s,  Wall time: 24.72 s\n```\n\n```\nfm = f._magma_()\ngm = g._magma_()\nhm = h._magma_()\nt = magma.cputime()\n_ = fm.ModularComposition(gm,hm)\nmagma.cputime(t)\n83.810000000000002\n```",
    "created_at": "2008-10-17T01:05:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4302#issuecomment-25721",
    "user": "https://github.com/malb"
}
```

<a id='comment:3'></a>
This is what I sent to Paul earlier about the patch

>I've improved said implementation on my train ride after Sage Days. The result 
>is faster than Magma but only competitive with NTL. It seems NTL is already 
>faster than Magma for this problem and that the runtime is dominated by the 
>construction of the matrices (ntl.GF2X arithmetic mainly) and the recovery of 
>the result (ntl.GF2X arithmetic mainly). There is room for improvements 
>w.r.t. the conversion between ntl.GF2X and M4RI but I didn't bother yet 
>because ntl.GF2X arithmetic seems to be the main bottleneck for now. Note 
>that matrix multiplication takes up only a tiny fraction of the overall 
>runtime, it is almost negligible. 
>
>Maybe, once we switch to the GF2X library things will look different enough to 
>motivate a better tuned conversion routine?

```
f = R.random_element(30000)
g = R.random_element(30000)
h = R.random_element(30000*10)
```

```
%time 
set_verbose(1)
_ = f.modular_composition(g,h)
verbose 1 (1: , <module>) G 548 x 299999 16.331 s
verbose 1 (1: , <module>) F 55 x 548 0.000 s
verbose 1 (1: , <module>) H 55 x 299999 0.230 s
verbose 1 (1: , <module>) Res 6.359 s
CPU time: 22.98 s,  Wall time: 23.42 s
```

```
%time _ = f.modular_composition(g,h,'ntl')
verbose 1 (1: , <module>) NTL 23.998 s
CPU time: 24.07 s,  Wall time: 24.72 s
```

```
fm = f._magma_()
gm = g._magma_()
hm = h._magma_()
t = magma.cputime()
_ = fm.ModularComposition(gm,hm)
magma.cputime(t)
83.810000000000002
```



---

archive/issue_comments_025722.json:
```json
{
    "body": "<a id='comment:4'></a>\nMartin, I have problems trying your patch to 3.1.3:\n\n```\nBuilding sage/rings/polynomial/polynomial_gf2x.cpp because it depends on sage/rings/polynomial/polynomial_gf2x.pyx.\npython2.5 `which cython` --embed-positions --incref-local-binop -I/usr/local/sage-3.1.3/sage/devel/sage-main -o sage/rings/polynomial/polynomial_gf2x.cpp sage/rings/polynomial/polynomial_gf2x.pyx\n\nError converting Pyrex file to C:\n------------------------------------------------------------\n...\nfrom sage.libs.ntl.ntl_GF2_decl cimport GF2_c\nfrom sage.libs.ntl.ntl_ZZ_decl cimport ZZ_c\n^\n------------------------------------------------------------\n```\nShould I apply other patches before?",
    "created_at": "2008-10-17T06:33:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4302#issuecomment-25722",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:4'></a>
Martin, I have problems trying your patch to 3.1.3:

```
Building sage/rings/polynomial/polynomial_gf2x.cpp because it depends on sage/rings/polynomial/polynomial_gf2x.pyx.
python2.5 `which cython` --embed-positions --incref-local-binop -I/usr/local/sage-3.1.3/sage/devel/sage-main -o sage/rings/polynomial/polynomial_gf2x.cpp sage/rings/polynomial/polynomial_gf2x.pyx

Error converting Pyrex file to C:
------------------------------------------------------------
...
from sage.libs.ntl.ntl_GF2_decl cimport GF2_c
from sage.libs.ntl.ntl_ZZ_decl cimport ZZ_c
^
------------------------------------------------------------
```
Should I apply other patches before?



---

archive/issue_comments_025723.json:
```json
{
    "body": "<a id='comment:5'></a>\nooop, I forgot to mention that this patch depends on #4304",
    "created_at": "2008-10-17T09:31:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4302#issuecomment-25723",
    "user": "https://github.com/malb"
}
```

<a id='comment:5'></a>
ooop, I forgot to mention that this patch depends on #4304



---

archive/issue_comments_025724.json:
```json
{
    "body": "<a id='comment:6'></a>\nI have applied both patches, and done sage -br, but modular_composition is not defined (with sage-3.1.4):\n\n```\nsage: R=PolynomialRing(GF(2),x)\nsage: f=x^2+1\nsage: f.modular_composition\n---------------------------------------------------------------------------\nAttributeError                            Traceback (most recent call last)\n\n/users/cacao/zimmerma/.sage/temp/achille.loria.fr/7660/_users_cacao_zimmerma__sage_init_sage_0.py in <module>()\n----> 1 \n      2 \n      3 \n      4 \n      5 \n\nAttributeError: 'SymbolicArithmetic' object has no attribute 'modular_composition'\n```",
    "created_at": "2008-10-17T11:16:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4302#issuecomment-25724",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:6'></a>
I have applied both patches, and done sage -br, but modular_composition is not defined (with sage-3.1.4):

```
sage: R=PolynomialRing(GF(2),x)
sage: f=x^2+1
sage: f.modular_composition
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)

/users/cacao/zimmerma/.sage/temp/achille.loria.fr/7660/_users_cacao_zimmerma__sage_init_sage_0.py in <module>()
----> 1 
      2 
      3 
      4 
      5 

AttributeError: 'SymbolicArithmetic' object has no attribute 'modular_composition'
```



---

archive/issue_comments_025725.json:
```json
{
    "body": "<a id='comment:7'></a>\nHi, you didn't declare 'x' to be a polynomial over GF(2). Try:\n\n```\nsage: P.<x> = PolynomialRing(GF(2))\n```",
    "created_at": "2008-10-17T11:28:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4302#issuecomment-25725",
    "user": "https://github.com/malb"
}
```

<a id='comment:7'></a>
Hi, you didn't declare 'x' to be a polynomial over GF(2). Try:

```
sage: P.<x> = PolynomialRing(GF(2))
```



---

archive/issue_comments_025726.json:
```json
{
    "body": "<a id='comment:8'></a>\nYes I did (but did forget to copy/paste it):\n\n```\n----------------------------------------------------------------------\n| SAGE Version 3.1.4, Release Date: 2008-10-16                       |\n| Type notebook() for the GUI, and license() for information.        |\n----------------------------------------------------------------------\n\nsage: P.<x> = PolynomialRing(GF(2))\nsage: f=x^2+1\nsage: f.modular_composition() \n---------------------------------------------------------------------------\nAttributeError                            Traceback (most recent call last)\n\n/users/cacao/zimmerma/.sage/temp/achille.loria.fr/8623/_users_cacao_zimmerma__sage_init_sage_0.py in <module>()\n----> 1 \n      2 \n      3 \n      4 \n      5 \n```\nMaybe it is because I applied the current patch before that of #4304. However, I just did \"touch\" on all\nfiles from the current patch, then \"sage -br\" again, and I still get the above.",
    "created_at": "2008-10-17T12:24:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4302#issuecomment-25726",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:8'></a>
Yes I did (but did forget to copy/paste it):

```
----------------------------------------------------------------------
| SAGE Version 3.1.4, Release Date: 2008-10-16                       |
| Type notebook() for the GUI, and license() for information.        |
----------------------------------------------------------------------

sage: P.<x> = PolynomialRing(GF(2))
sage: f=x^2+1
sage: f.modular_composition() 
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)

/users/cacao/zimmerma/.sage/temp/achille.loria.fr/8623/_users_cacao_zimmerma__sage_init_sage_0.py in <module>()
----> 1 
      2 
      3 
      4 
      5 
```
Maybe it is because I applied the current patch before that of #4304. However, I just did "touch" on all
files from the current patch, then "sage -br" again, and I still get the above.



---

archive/issue_comments_025727.json:
```json
{
    "body": "<a id='comment:9'></a>\nMaybe you can start with vanilla 3.1.3 again (rm spkgs/installed/sage-3.1.3.spkg; make) and apply the patches again in order? Is there a file called polynomial_gf2x.pyx in sage/rings/polynomial ? I'll be afk for a couple of days btw.",
    "created_at": "2008-10-17T12:33:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4302#issuecomment-25727",
    "user": "https://github.com/malb"
}
```

<a id='comment:9'></a>
Maybe you can start with vanilla 3.1.3 again (rm spkgs/installed/sage-3.1.3.spkg; make) and apply the patches again in order? Is there a file called polynomial_gf2x.pyx in sage/rings/polynomial ? I'll be afk for a couple of days btw.



---

archive/issue_comments_025728.json:
```json
{
    "body": "<a id='comment:10'></a>\nI did start from vanilla 3.1.3 again, applied the patches in the right order, but still get the\nsame error:\n\n```\n----------------------------------------------------------------------\n| SAGE Version 3.1.4, Release Date: 2008-10-16                       |\n| Type notebook() for the GUI, and license() for information.        |\n----------------------------------------------------------------------\n\nsage: P.<x> = PolynomialRing(GF(2), x)\nsage: f = x^7 + x + 1\nsage: f.modular_composition()\n---------------------------------------------------------------------------\nAttributeError                            Traceback (most recent call last)\n\n/users/cacao/zimmerma/.sage/temp/achille.loria.fr/16284/_users_cacao_zimmerma__sage_init_sage_0.py in <module>()\n----> 1 \n      2 \n      3 \n      4 \n      5 \n\nAttributeError: 'sage.rings.polynomial.polynomial_modn_dense_ntl.Po' object has no attribute 'modular_composition'\n```\nIn particular I don't see a \"modular_composition\" method for polynomial_modn_dense_ntl,\nbut only for Polynomial_GF2X, and polynomial_modn_dense_ntl, does not seem to inherit from\nPolynomial_GF2X:\n\n```\nsage: type(f)\n<type 'sage.rings.polynomial.polynomial_modn_dense_ntl.Polynomial_dense_mod_p'>\n```\nHow can I define an object of type Polynomial_GF2X? Can someone reproduce Martin's results?",
    "created_at": "2008-10-17T19:29:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4302#issuecomment-25728",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:10'></a>
I did start from vanilla 3.1.3 again, applied the patches in the right order, but still get the
same error:

```
----------------------------------------------------------------------
| SAGE Version 3.1.4, Release Date: 2008-10-16                       |
| Type notebook() for the GUI, and license() for information.        |
----------------------------------------------------------------------

sage: P.<x> = PolynomialRing(GF(2), x)
sage: f = x^7 + x + 1
sage: f.modular_composition()
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)

/users/cacao/zimmerma/.sage/temp/achille.loria.fr/16284/_users_cacao_zimmerma__sage_init_sage_0.py in <module>()
----> 1 
      2 
      3 
      4 
      5 

AttributeError: 'sage.rings.polynomial.polynomial_modn_dense_ntl.Po' object has no attribute 'modular_composition'
```
In particular I don't see a "modular_composition" method for polynomial_modn_dense_ntl,
but only for Polynomial_GF2X, and polynomial_modn_dense_ntl, does not seem to inherit from
Polynomial_GF2X:

```
sage: type(f)
<type 'sage.rings.polynomial.polynomial_modn_dense_ntl.Polynomial_dense_mod_p'>
```
How can I define an object of type Polynomial_GF2X? Can someone reproduce Martin's results?



---

archive/issue_comments_025729.json:
```json
{
    "body": "<a id='comment:12'></a>\nFYI: With this patch and its dependency applied I get the following failures:\n\n```\n\tsage -t -long devel/sage/sage/schemes/elliptic_curves/padics.py # 1 doctests failed\n\tsage -t -long devel/sage/sage/schemes/elliptic_curves/ell_generic.py # 1 doctests failed\n\tsage -t -long devel/sage/sage/modular/modform/j_invariant.py # 1 doctests failed\n\tsage -t -long devel/sage/sage/libs/ntl/ntl_GF2X_linkage.pxi # 1 doctests failed\n\tsage -t -long devel/sage/sage/libs/ntl/ntl_GF2X.pyx # 1 doctests failed\n```\nI am now testing only #4304 to see if the problem is this or the other patch.\n\nCheers,\n\nMichael",
    "created_at": "2008-10-17T22:39:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4302#issuecomment-25729",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<a id='comment:12'></a>
FYI: With this patch and its dependency applied I get the following failures:

```
	sage -t -long devel/sage/sage/schemes/elliptic_curves/padics.py # 1 doctests failed
	sage -t -long devel/sage/sage/schemes/elliptic_curves/ell_generic.py # 1 doctests failed
	sage -t -long devel/sage/sage/modular/modform/j_invariant.py # 1 doctests failed
	sage -t -long devel/sage/sage/libs/ntl/ntl_GF2X_linkage.pxi # 1 doctests failed
	sage -t -long devel/sage/sage/libs/ntl/ntl_GF2X.pyx # 1 doctests failed
```
I am now testing only #4304 to see if the problem is this or the other patch.

Cheers,

Michael



---

archive/issue_comments_025730.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -130,10 +130,10 @@\n CPU times: user 24.37 s, sys: 0.79 s, total: 25.16 s\n Wall time: 27.67 s\n ```\n-Several remarks: (a) the time spent in M4RI (Computing H) is negligible;\n-                 (b) the time spent in \"Creating G\" and \"Forming result\" is large,\n-                     and is even larger when the inputs have small degree!\n-                     Something strange happens here.\n+Several remarks:\n+* the time spent in M4RI (Computing H) is negligible;\n+* the time spent in \"Creating G\" and \"Forming result\" is large,\n+ and is even larger when the inputs have small degree! Something strange happens here.\n \n As a comparison, on the same machine, Magma V2.14-8 takes only 0.02s with the following code:\n \n``````\n",
    "created_at": "2008-10-17T22:41:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4302#issuecomment-25730",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -130,10 +130,10 @@
 CPU times: user 24.37 s, sys: 0.79 s, total: 25.16 s
 Wall time: 27.67 s
 ```
-Several remarks: (a) the time spent in M4RI (Computing H) is negligible;
-                 (b) the time spent in "Creating G" and "Forming result" is large,
-                     and is even larger when the inputs have small degree!
-                     Something strange happens here.
+Several remarks:
+* the time spent in M4RI (Computing H) is negligible;
+* the time spent in "Creating G" and "Forming result" is large,
+ and is even larger when the inputs have small degree! Something strange happens here.
 
 As a comparison, on the same machine, Magma V2.14-8 takes only 0.02s with the following code:
 
``````




---

archive/issue_events_039501.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-10-17T23:18:57Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4302#event-39501"
}
```



---

archive/issue_events_039502.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-10-17T23:18:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4302#event-39502"
}
```



---

archive/issue_comments_025731.json:
```json
{
    "body": "<a id='comment:14'></a>\n#4304 by itself is fine, so this one needs work.\n\nCheers,\n\nMichael",
    "created_at": "2008-10-17T23:18:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4302#issuecomment-25731",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<a id='comment:14'></a>
#4304 by itself is fine, so this one needs work.

Cheers,

Michael



---

archive/issue_comments_025732.json:
```json
{
    "body": "<a id='comment:15'></a>\nHi, I started from a vanilla 3.1.3 as follows\n\n```\nmalb@road:~/SAGE/devel/sage$ hg qinit\nmalb@road:~/SAGE/devel/sage$ hg qimport ntl_decl_refactor.patch\nadding ntl_decl_refactor.patch to series file\nmalb@road:~/SAGE/devel/sage$ hg qpush\napplying ntl_decl_refactor.patch\npatching file sage/rings/polynomial/polynomial_modn_dense_ntl.pyx\nHunk #4 succeeded at 1277 with fuzz 2 (offset 0 lines).\nNow at: ntl_decl_refactor.patch\nmalb@road:~/SAGE/devel/sage$ hg qimport polynomial_gf2x.patch\nadding polynomial_gf2x.patch to series file\nmalb@road:~/SAGE/devel/sage$ hg qpush\napplying polynomial_gf2x.patch\nNow at: polynomial_gf2x.patch\nmalb@road:~/SAGE/devel/sage$ sage -b\n```\n\nafterwars I do have the modular_composition function available. I'll address the doctest failures as soon as possible if noone else beats me to it.",
    "created_at": "2008-10-18T01:15:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4302#issuecomment-25732",
    "user": "https://github.com/malb"
}
```

<a id='comment:15'></a>
Hi, I started from a vanilla 3.1.3 as follows

```
malb@road:~/SAGE/devel/sage$ hg qinit
malb@road:~/SAGE/devel/sage$ hg qimport ntl_decl_refactor.patch
adding ntl_decl_refactor.patch to series file
malb@road:~/SAGE/devel/sage$ hg qpush
applying ntl_decl_refactor.patch
patching file sage/rings/polynomial/polynomial_modn_dense_ntl.pyx
Hunk #4 succeeded at 1277 with fuzz 2 (offset 0 lines).
Now at: ntl_decl_refactor.patch
malb@road:~/SAGE/devel/sage$ hg qimport polynomial_gf2x.patch
adding polynomial_gf2x.patch to series file
malb@road:~/SAGE/devel/sage$ hg qpush
applying polynomial_gf2x.patch
Now at: polynomial_gf2x.patch
malb@road:~/SAGE/devel/sage$ sage -b
```

afterwars I do have the modular_composition function available. I'll address the doctest failures as soon as possible if noone else beats me to it.



---

archive/issue_comments_025733.json:
```json
{
    "body": "<a id='comment:16'></a>\nReplying to [@malb](#comment%3A15):\n> Hi, I started from a vanilla 3.1.3 as follows [...]\n\nMartin, starting from 3.1.4 (which should be ok), I cannot reproduce what you did:\n\n```\nachille% pwd\n/usr/local/sage-3.1.4/sage/devel/sage-main\nachille% hg qinit\nhg: unknown command 'qinit'\nMercurial Distributed SCM\n\nbasic commands:\n\n add        add the specified files on the next commit\n annotate   show changeset information per file line\n clone      make a copy of an existing repository\n commit     commit the specified files or all outstanding changes\n diff       diff repository (or selected files)\n export     dump the header and diffs for one or more changesets\n init       create a new repository in the given directory\n log        show revision history of entire repository or files\n merge      merge working directory with another revision\n parents    show the parents of the working dir or revision\n pull       pull changes from the specified source\n push       push changes to the specified destination\n remove     remove the specified files on the next commit\n serve      export the repository via HTTP\n status     show changed files in the working directory\n update     update working directory\n\nuse \"hg help\" for the full list of commands or \"hg -v\" for details\nachille% hg --version\nMercurial Distributed SCM (version 1.0.2)\n\nCopyright (C) 2005-2008 Matt Mackall <mpm@selenic.com> and others\nThis is free software; see the source for copying conditions. There is NO\nwarranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n```",
    "created_at": "2008-10-18T08:04:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4302#issuecomment-25733",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:16'></a>
Replying to [@malb](#comment%3A15):
> Hi, I started from a vanilla 3.1.3 as follows [...]

Martin, starting from 3.1.4 (which should be ok), I cannot reproduce what you did:

```
achille% pwd
/usr/local/sage-3.1.4/sage/devel/sage-main
achille% hg qinit
hg: unknown command 'qinit'
Mercurial Distributed SCM

basic commands:

 add        add the specified files on the next commit
 annotate   show changeset information per file line
 clone      make a copy of an existing repository
 commit     commit the specified files or all outstanding changes
 diff       diff repository (or selected files)
 export     dump the header and diffs for one or more changesets
 init       create a new repository in the given directory
 log        show revision history of entire repository or files
 merge      merge working directory with another revision
 parents    show the parents of the working dir or revision
 pull       pull changes from the specified source
 push       push changes to the specified destination
 remove     remove the specified files on the next commit
 serve      export the repository via HTTP
 status     show changed files in the working directory
 update     update working directory

use "hg help" for the full list of commands or "hg -v" for details
achille% hg --version
Mercurial Distributed SCM (version 1.0.2)

Copyright (C) 2005-2008 Matt Mackall <mpm@selenic.com> and others
This is free software; see the source for copying conditions. There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
```



---

archive/issue_comments_025734.json:
```json
{
    "body": "<a id='comment:17'></a>\nHi Paul,\n\nIt seems that Mercurial queues are not enabled on your machine.  Try adding the following lines to the file .hgrc in your home directory:\n\n```\n[extensions]\nhgext.mq =\n```",
    "created_at": "2008-10-18T08:17:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4302#issuecomment-25734",
    "user": "https://github.com/aghitza"
}
```

<a id='comment:17'></a>
Hi Paul,

It seems that Mercurial queues are not enabled on your machine.  Try adding the following lines to the file .hgrc in your home directory:

```
[extensions]
hgext.mq =
```



---

archive/issue_comments_025735.json:
```json
{
    "body": "<a id='comment:18'></a>\nOr, this should be equivalent:\n\n```\nmalb@road:~/SAGE/devel/sage$ hg import ntl_decl_refactor.patch\nmalb@road:~/SAGE/devel/sage$ hg import polynomial_gf2x.patch\nmalb@road:~/SAGE/devel/sage$ sage -b\n```",
    "created_at": "2008-10-18T08:21:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4302#issuecomment-25735",
    "user": "https://github.com/malb"
}
```

<a id='comment:18'></a>
Or, this should be equivalent:

```
malb@road:~/SAGE/devel/sage$ hg import ntl_decl_refactor.patch
malb@road:~/SAGE/devel/sage$ hg import polynomial_gf2x.patch
malb@road:~/SAGE/devel/sage$ sage -b
```



---

archive/issue_comments_025736.json:
```json
{
    "body": "<a id='comment:19'></a>\nReplying to [@malb](#comment%3A18):\n> Or, this should be equivalent:\n> \n> ```\n> malb@road:~/SAGE/devel/sage$ hg import ntl_decl_refactor.patch\n> malb@road:~/SAGE/devel/sage$ hg import polynomial_gf2x.patch\n> malb@road:~/SAGE/devel/sage$ sage -b\n> ```\n\nthis is basically what I had done before (but from within sage, and with sage -b inbetween).\nNevertheless, I did exactly that with 3.1.4:\n\n```\nachille% pwd\n/usr/local/sage-3.1.4/sage/devel/sage-main\nachille% hg import /tmp/ntl_decl_refactor.patch\napplying /tmp/ntl_decl_refactor.patch\npatching file sage/rings/polynomial/polynomial_modn_dense_ntl.pyx\nHunk #4 succeeded at 1277 with fuzz 2 (offset 0 lines).\nachille% hg import /tmp/polynomial_gf2x.patch\napplying /tmp/polynomial_gf2x.patch\nachille% sage -b\n...\nreal    33m24.231s\nuser    32m25.750s\nsys     0m37.831s\nachille% sage\n----------------------------------------------------------------------\n| SAGE Version 3.1.4, Release Date: 2008-10-16                       |\n| Type notebook() for the GUI, and license() for information.        |\n----------------------------------------------------------------------\n\nsage: P.<x> = PolynomialRing(GF(2))\nsage: f=x^7+x+1\nsage: f.modular_composition()\n---------------------------------------------------------------------------\nAttributeError                            Traceback (most recent call last)\n\n/users/cacao/zimmerma/.sage/temp/achille.loria.fr/11076/_users_cacao_zimmerma__\\\nsage_init_sage_0.py in <module>()\n----> 1\n      2\n      3\n      4\n      5\n\nAttributeError: 'sage.rings.polynomial.polynomial_modn_dense_ntl.Po' object has\\\n no attribute 'modular_composition'\n```\nIs it possible that the problem happens because I am not in the original build directory,\nbut in the directory where I did \"make install\"? However I have successfully applied several\npatches in this way before.\n\nWhat else can I do to identify the problem on my side?",
    "created_at": "2008-10-18T09:47:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4302#issuecomment-25736",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:19'></a>
Replying to [@malb](#comment%3A18):
> Or, this should be equivalent:
> 
> ```
> malb@road:~/SAGE/devel/sage$ hg import ntl_decl_refactor.patch
> malb@road:~/SAGE/devel/sage$ hg import polynomial_gf2x.patch
> malb@road:~/SAGE/devel/sage$ sage -b
> ```

this is basically what I had done before (but from within sage, and with sage -b inbetween).
Nevertheless, I did exactly that with 3.1.4:

```
achille% pwd
/usr/local/sage-3.1.4/sage/devel/sage-main
achille% hg import /tmp/ntl_decl_refactor.patch
applying /tmp/ntl_decl_refactor.patch
patching file sage/rings/polynomial/polynomial_modn_dense_ntl.pyx
Hunk #4 succeeded at 1277 with fuzz 2 (offset 0 lines).
achille% hg import /tmp/polynomial_gf2x.patch
applying /tmp/polynomial_gf2x.patch
achille% sage -b
...
real    33m24.231s
user    32m25.750s
sys     0m37.831s
achille% sage
----------------------------------------------------------------------
| SAGE Version 3.1.4, Release Date: 2008-10-16                       |
| Type notebook() for the GUI, and license() for information.        |
----------------------------------------------------------------------

sage: P.<x> = PolynomialRing(GF(2))
sage: f=x^7+x+1
sage: f.modular_composition()
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)

/users/cacao/zimmerma/.sage/temp/achille.loria.fr/11076/_users_cacao_zimmerma__\
sage_init_sage_0.py in <module>()
----> 1
      2
      3
      4
      5

AttributeError: 'sage.rings.polynomial.polynomial_modn_dense_ntl.Po' object has\
 no attribute 'modular_composition'
```
Is it possible that the problem happens because I am not in the original build directory,
but in the directory where I did "make install"? However I have successfully applied several
patches in this way before.

What else can I do to identify the problem on my side?



---

archive/issue_comments_025737.json:
```json
{
    "body": "<a id='comment:20'></a>\nAfter fixing my relocation problems (#4317) I was able to reproduce Martin's timings.\n\nThe attached trac_4302_doctest1.patch fixes the doctest failure in ntl_GF2X_linkage.pxi.\nUnfortunately I don't know how to fix the other ones.",
    "created_at": "2008-10-18T15:42:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4302#issuecomment-25737",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:20'></a>
After fixing my relocation problems (#4317) I was able to reproduce Martin's timings.

The attached trac_4302_doctest1.patch fixes the doctest failure in ntl_GF2X_linkage.pxi.
Unfortunately I don't know how to fix the other ones.



---

archive/issue_comments_025738.json:
```json
{
    "body": "**Attachment:** [4302_speedup1.patch.gz](https://github.com/sagemath/sage/files/ticket4302/4302_speedup1.patch.gz)",
    "created_at": "2008-10-18T16:48:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4302#issuecomment-25738",
    "user": "https://github.com/zimmermann6"
}
```

**Attachment:** [4302_speedup1.patch.gz](https://github.com/sagemath/sage/files/ticket4302/4302_speedup1.patch.gz)



---

archive/issue_comments_025739.json:
```json
{
    "body": "<a id='comment:21'></a>\nThe attached 4302_speedup1.patch should speed up the computation of the G matrix, however it does speed it down instead (I had previous timings similar to those of Martin above):\n\n```\nsage: R.<x>=GF(2)[]\nsage: f = R.random_element(30000)\nsage: g = R.random_element(30000)\nsage: h = R.random_element(30000*10)\nsage: set_verbose(1)\nsage: time _ = f.modular_composition(g,h)\nverbose 1 (<module>) G 548 x 300000 33.128 s\nverbose 1 (<module>) F 55 x 548 0.001 s\nverbose 1 (<module>) H 55 x 300000 0.265 s\nverbose 1 (<module>) Res 6.406 s\nCPU times: user 39.79 s, sys: 0.07 s, total: 39.86 s\n```\nEither GF2X_SqrMod_pre is slower than GF2X_MulMod_pre, or I did something stupid. Could somebody look at my patch?",
    "created_at": "2008-10-18T16:58:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4302#issuecomment-25739",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:21'></a>
The attached 4302_speedup1.patch should speed up the computation of the G matrix, however it does speed it down instead (I had previous timings similar to those of Martin above):

```
sage: R.<x>=GF(2)[]
sage: f = R.random_element(30000)
sage: g = R.random_element(30000)
sage: h = R.random_element(30000*10)
sage: set_verbose(1)
sage: time _ = f.modular_composition(g,h)
verbose 1 (<module>) G 548 x 300000 33.128 s
verbose 1 (<module>) F 55 x 548 0.001 s
verbose 1 (<module>) H 55 x 300000 0.265 s
verbose 1 (<module>) Res 6.406 s
CPU times: user 39.79 s, sys: 0.07 s, total: 39.86 s
```
Either GF2X_SqrMod_pre is slower than GF2X_MulMod_pre, or I did something stupid. Could somebody look at my patch?



---

archive/issue_comments_025740.json:
```json
{
    "body": "<a id='comment:22'></a>\nIn fact with the following benchmark 4302_speedup1.patch gives a speedup (ModCompPower is defined\nabove).\n\nWithout 4302_speedup1.patch:\n\n```\nsage: r=132049\nsage: time a=ModCompPower(x^r+x+1, r)\n100.6397\n```\nWith 4302_speedup1.patch:\n\n```\nsage: time a=ModCompPower(x^r+x+1, r)\n82.144512\n```\nWith NTL:\n\n```\nsage: time a=ModCompPower(x^r+x+1, r, algorithm='ntl')\n86.219893\n```",
    "created_at": "2008-10-18T20:54:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4302#issuecomment-25740",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:22'></a>
In fact with the following benchmark 4302_speedup1.patch gives a speedup (ModCompPower is defined
above).

Without 4302_speedup1.patch:

```
sage: r=132049
sage: time a=ModCompPower(x^r+x+1, r)
100.6397
```
With 4302_speedup1.patch:

```
sage: time a=ModCompPower(x^r+x+1, r)
82.144512
```
With NTL:

```
sage: time a=ModCompPower(x^r+x+1, r, algorithm='ntl')
86.219893
```



---

archive/issue_comments_025741.json:
```json
{
    "body": "<a id='comment:23'></a>\nI fixed most doctest failures except one:\n\n```\nsage -t  elliptic_curves/ell_generic.py\nFile \"/home/malb/SAGE/tmp/ell_generic.py\", line 2135:\n    sage: [ len(EllipticCurve(GF(q,'a')(0)).automorphisms()) for q in [2,4,3,9,5,25,7,49]]\nException raised:\n...\nTypeError: unsupported operand parent(s) for '-': 'Univariate Polynomial Ring in x over Finite Field of size 2' and 'Finite Field of size 2'\n```\n\nMy trouble is, that it works from the command line:\n\n```\nsage: [ len(EllipticCurve(GF(q,'a')(0)).automorphisms()) for q in [2,4,3,9,5,25,7,49]]\n[2, 24, 2, 12, 2, 6, 6, 6]\n```\n\nRobert, could that be related to some caching of coercion maps?",
    "created_at": "2008-10-19T14:45:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4302#issuecomment-25741",
    "user": "https://github.com/malb"
}
```

<a id='comment:23'></a>
I fixed most doctest failures except one:

```
sage -t  elliptic_curves/ell_generic.py
File "/home/malb/SAGE/tmp/ell_generic.py", line 2135:
    sage: [ len(EllipticCurve(GF(q,'a')(0)).automorphisms()) for q in [2,4,3,9,5,25,7,49]]
Exception raised:
...
TypeError: unsupported operand parent(s) for '-': 'Univariate Polynomial Ring in x over Finite Field of size 2' and 'Finite Field of size 2'
```

My trouble is, that it works from the command line:

```
sage: [ len(EllipticCurve(GF(q,'a')(0)).automorphisms()) for q in [2,4,3,9,5,25,7,49]]
[2, 24, 2, 12, 2, 6, 6, 6]
```

Robert, could that be related to some caching of coercion maps?



---

archive/issue_comments_025742.json:
```json
{
    "body": "<a id='comment:24'></a>\nThe patch includes Paul's doctest fix but not his speed-improvement, so apply that after the `polynomial_gf2x.patch`.",
    "created_at": "2008-10-19T14:46:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4302#issuecomment-25742",
    "user": "https://github.com/malb"
}
```

<a id='comment:24'></a>
The patch includes Paul's doctest fix but not his speed-improvement, so apply that after the `polynomial_gf2x.patch`.



---

archive/issue_comments_025743.json:
```json
{
    "body": "fixes all known doctest failures",
    "created_at": "2008-10-19T15:16:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4302#issuecomment-25743",
    "user": "https://github.com/malb"
}
```

fixes all known doctest failures



---

archive/issue_events_039503.json:
```json
{
    "actor": "https://github.com/malb",
    "created_at": "2008-10-19T15:18:59Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "rename": {
        "from": "improve modular composition in GF(2)[x]",
        "to": "improve modular composition in GF(2)[x] and GF(2)[x]"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4302#event-39503"
}
```



---

archive/issue_events_039504.json:
```json
{
    "actor": "https://github.com/malb",
    "created_at": "2008-10-19T15:18:59Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4302#event-39504"
}
```



---

archive/issue_events_039505.json:
```json
{
    "actor": "https://github.com/malb",
    "created_at": "2008-10-19T15:18:59Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4302#event-39505"
}
```



---

archive/issue_comments_025744.json:
```json
{
    "body": "<a id='comment:25'></a>\n**Attachment:** [polynomial_gf2x.patch.gz](https://github.com/sagemath/sage/files/ticket4302/polynomial_gf2x.patch.gz)\n\nthe updated patch fixes all known doctest failures. The failure was caused by the fact that two GF(2) objects existed such that `x.parent() is parent` wasn't true anymore. Apply Paul's performance patch after `polynomial_gf2x.patch`",
    "created_at": "2008-10-19T15:18:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4302#issuecomment-25744",
    "user": "https://github.com/malb"
}
```

<a id='comment:25'></a>
**Attachment:** [polynomial_gf2x.patch.gz](https://github.com/sagemath/sage/files/ticket4302/polynomial_gf2x.patch.gz)

the updated patch fixes all known doctest failures. The failure was caused by the fact that two GF(2) objects existed such that `x.parent() is parent` wasn't true anymore. Apply Paul's performance patch after `polynomial_gf2x.patch`



---

archive/issue_comments_025745.json:
```json
{
    "body": "<a id='comment:26'></a>\n#4328 seems to be caused by this patch.\n\nCheers,\n\nMichael",
    "created_at": "2008-10-20T12:07:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4302#issuecomment-25745",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<a id='comment:26'></a>
#4328 seems to be caused by this patch.

Cheers,

Michael



---

archive/issue_comments_025746.json:
```json
{
    "body": "<a id='comment:27'></a>\nReplying to [mabshoff](#comment%3A26):\n> #4328 seems to be caused by this patch.\n\nI think that was caused by an older version of the patch.",
    "created_at": "2008-10-20T13:24:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4302#issuecomment-25746",
    "user": "https://github.com/malb"
}
```

<a id='comment:27'></a>
Replying to [mabshoff](#comment%3A26):
> #4328 seems to be caused by this patch.

I think that was caused by an older version of the patch.



---

archive/issue_comments_025747.json:
```json
{
    "body": "<a id='comment:28'></a>\nbtw. Robert I think passing `object parent` to `celement_foo()` is not a good choice because it assumes structure on `parent`, e.g. what would one cast to for C attribute access? I'd say it should be a cparent which is some sort of C struct defined in the linkage pxi files? But this can wait until after this patch is applied (because GF2X ignores the parent anyway).",
    "created_at": "2008-10-20T16:11:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4302#issuecomment-25747",
    "user": "https://github.com/malb"
}
```

<a id='comment:28'></a>
btw. Robert I think passing `object parent` to `celement_foo()` is not a good choice because it assumes structure on `parent`, e.g. what would one cast to for C attribute access? I'd say it should be a cparent which is some sort of C struct defined in the linkage pxi files? But this can wait until after this patch is applied (because GF2X ignores the parent anyway).



---

archive/issue_comments_025748.json:
```json
{
    "body": "<a id='comment:29'></a>\nYep, perhaps something other than parent would be good to pass, though that would make writing the generic classes more complicated. It would also be handy to have generic wrap/unwrap methods that go to and from the native type to a Sage object.",
    "created_at": "2008-10-21T15:12:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4302#issuecomment-25748",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:29'></a>
Yep, perhaps something other than parent would be good to pass, though that would make writing the generic classes more complicated. It would also be handy to have generic wrap/unwrap methods that go to and from the native type to a Sage object.



---

archive/issue_events_039506.json:
```json
{
    "actor": "https://github.com/zimmermann6",
    "created_at": "2008-10-23T11:07:12Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4302#event-39506"
}
```



---

archive/issue_events_039507.json:
```json
{
    "actor": "https://github.com/zimmermann6",
    "created_at": "2008-10-23T11:07:12Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4302#event-39507"
}
```



---

archive/issue_comments_025749.json:
```json
{
    "body": "<a id='comment:30'></a>\nI did apply polynomial_gf2x.patch on a vanilla 3.1.4, after having applied the patch from #4304.\nI can reproduce Martin's timings, and I checked that all the doctests above are ok now. Thus I give\na positive review for that patch.\n\nOf course somebody should review my own patch, or should we create a separate ticket, so that we can include\nMartin's patch?",
    "created_at": "2008-10-23T11:07:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4302#issuecomment-25749",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:30'></a>
I did apply polynomial_gf2x.patch on a vanilla 3.1.4, after having applied the patch from #4304.
I can reproduce Martin's timings, and I checked that all the doctests above are ok now. Thus I give
a positive review for that patch.

Of course somebody should review my own patch, or should we create a separate ticket, so that we can include
Martin's patch?



---

archive/issue_comments_025750.json:
```json
{
    "body": "<a id='comment:31'></a>\nPaul, I can review your patch. No need to open another ticket.",
    "created_at": "2008-10-23T13:48:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4302#issuecomment-25750",
    "user": "https://github.com/malb"
}
```

<a id='comment:31'></a>
Paul, I can review your patch. No need to open another ticket.



---

archive/issue_comments_025751.json:
```json
{
    "body": "<a id='comment:32'></a>\nPaul's patch applies cleanly and doctests pass in the rings subdirectory. **positive review**",
    "created_at": "2008-10-24T23:26:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4302#issuecomment-25751",
    "user": "https://github.com/malb"
}
```

<a id='comment:32'></a>
Paul's patch applies cleanly and doctests pass in the rings subdirectory. **positive review**



---

archive/issue_comments_025752.json:
```json
{
    "body": "<a id='comment:33'></a>\nMerged both patches in Sage 3.2.alpha1",
    "created_at": "2008-10-26T00:51:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4302#issuecomment-25752",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<a id='comment:33'></a>
Merged both patches in Sage 3.2.alpha1



---

archive/issue_events_039508.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-10-26T00:51:43Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4302#event-39508"
}
```



---

archive/issue_events_039509.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-10-26T00:51:43Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/4302",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4302#event-39509"
}
```
