# Issue 4681: [with patches, positive review] General Smith normal form implementation

archive/issues_004681.json:
```json
{
    "body": "Smith form is a useful canonical form for matrices over a PID. Sage already has it for ZZ. I've coded up a very basic implementation that should work over any PID Sage knows about (although it is not fast).\n\n**Note**: This ticket should also fix #3068\n\nAssignee: @loefflerd\n\nCC:  @ncalexan\n\nKeywords: matrix, smith normal form\n\nResolution: fixed\n\nAuthor: David Loeffler\n\nReviewer: William Stein, Nick Alexander\n\nMerged: 3.2.2.alpha1\n\nIssue created by migration from https://trac.sagemath.org/ticket/4681\n\n",
    "closed_at": "2008-12-10T11:25:53Z",
    "created_at": "2008-12-03T00:01:47Z",
    "labels": [
        "component: linear algebra"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-3.2.2",
    "title": "[with patches, positive review] General Smith normal form implementation",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/4681",
    "user": "https://github.com/loefflerd"
}
```
Smith form is a useful canonical form for matrices over a PID. Sage already has it for ZZ. I've coded up a very basic implementation that should work over any PID Sage knows about (although it is not fast).

**Note**: This ticket should also fix #3068

Assignee: @loefflerd

CC:  @ncalexan

Keywords: matrix, smith normal form

Resolution: fixed

Author: David Loeffler

Reviewer: William Stein, Nick Alexander

Merged: 3.2.2.alpha1

Issue created by migration from https://trac.sagemath.org/ticket/4681





---

archive/issue_comments_038289.json:
```json
{
    "body": "Changing status from new to assigned.",
    "created_at": "2008-12-03T00:05:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4681#issuecomment-38289",
    "user": "https://github.com/loefflerd"
}
```

Changing status from new to assigned.



---

archive/issue_comments_038290.json:
```json
{
    "body": "<a id='comment:1'></a>The above patch is based on sage 3.2.1. It adds the basic algorithm, plus some minor fiddlings needed to get the examples to work :-)",
    "created_at": "2008-12-03T00:05:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4681#issuecomment-38290",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:1'></a>The above patch is based on sage 3.2.1. It adds the basic algorithm, plus some minor fiddlings needed to get the examples to work :-)



---

archive/issue_comments_038291.json:
```json
{
    "body": "<a id='comment:2'></a>I just glanced at this; could you put in doctests for the additive_order function?",
    "created_at": "2008-12-03T19:28:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4681#issuecomment-38291",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:2'></a>I just glanced at this; could you put in doctests for the additive_order function?



---

archive/issue_comments_038292.json:
```json
{
    "body": "<a id='comment:3'></a>Attachment [4681-smithform.patch](tarball://root/attachments/some-uuid/ticket4681/4681-smithform.patch) by @loefflerd created at 2008-12-03 20:35:27\n\nI've done a new patch (replacing the old one) which includes a doctest; sorry for the omission.",
    "created_at": "2008-12-03T20:35:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4681#issuecomment-38292",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:3'></a>Attachment [4681-smithform.patch](tarball://root/attachments/some-uuid/ticket4681/4681-smithform.patch) by @loefflerd created at 2008-12-03 20:35:27

I've done a new patch (replacing the old one) which includes a doctest; sorry for the omission.



---

archive/issue_comments_038293.json:
```json
{
    "body": "<a id='comment:4'></a>THANK YOU!  I've been wanting somebody to do this right (even if slow) forever... and at least two students have tried and failed before, so I'm really glad you did this.",
    "created_at": "2008-12-04T22:11:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4681#issuecomment-38293",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:4'></a>THANK YOU!  I've been wanting somebody to do this right (even if slow) forever... and at least two students have tried and failed before, so I'm really glad you did this.



---

archive/issue_comments_038294.json:
```json
{
    "body": "<a id='comment:5'></a>I noticed that this docstring is slightly wrong.  The m and y are confused:\n\n```\n \t4669\tdef _smith_augment(x, m): \n \t4670\t    r\"\"\" For internal use by the smith_form routine. Given scalar x and matrix \n \t4671\t    y, construct the block-diagonal matrix [x,0 ; 0, y]. \n```",
    "created_at": "2008-12-05T07:06:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4681#issuecomment-38294",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:5'></a>I noticed that this docstring is slightly wrong.  The m and y are confused:

```
 	4669	def _smith_augment(x, m): 
 	4670	    r""" For internal use by the smith_form routine. Given scalar x and matrix 
 	4671	    y, construct the block-diagonal matrix [x,0 ; 0, y]. 
```



---

archive/issue_comments_038295.json:
```json
{
    "body": "Attachment [4681-smithform.2.patch](tarball://root/attachments/some-uuid/ticket4681/4681-smithform.2.patch) by @loefflerd created at 2008-12-05 11:36:49",
    "created_at": "2008-12-05T11:36:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4681#issuecomment-38295",
    "user": "https://github.com/loefflerd"
}
```

Attachment [4681-smithform.2.patch](tarball://root/attachments/some-uuid/ticket4681/4681-smithform.2.patch) by @loefflerd created at 2008-12-05 11:36:49



---

archive/issue_comments_038296.json:
```json
{
    "body": "<a id='comment:6'></a>On reflection I realised that my \"_smith_augment\" function was a waste of space anyway as the same job can be done using the existing \"block_sum\" method from matrix1.py. I've added a new version of the patch, which replaces the old one (I forgot to tick the replace box in the trac upload page).",
    "created_at": "2008-12-05T11:40:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4681#issuecomment-38296",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:6'></a>On reflection I realised that my "_smith_augment" function was a waste of space anyway as the same job can be done using the existing "block_sum" method from matrix1.py. I've added a new version of the patch, which replaces the old one (I forgot to tick the replace box in the trac upload page).



---

archive/issue_comments_038297.json:
```json
{
    "body": "<a id='comment:7'></a>I read the code, which looks fine.  The doctests pass.  This test passes:\n\n```\nfor i in range(10):\n   print i\n   a = random_matrix(ZZ[sqrt(-1)],7)\n   d,u,v = a.smith_form()\n   assert u*a*v == d\n   assert u.det() == 1\n   assert v.det() == 1\n```\n\nThis fails pretty quickly, but it's not the fault of this code:\n\n```\nK.<a>=NumberField(x^3-2)\nprint \"h = \", K.class_number()\nfor i in range(10):\n   print i\n   a = random_matrix(K,3)\n   d,u,v = a.smith_form()\n   assert u*a*v == d\n   assert u.det() == 1\n   assert v.det() == 1\n...\n\nTraceback (most recent call last):       d,u,v = a.smith_form()\n\n  File \"element.pyx\", line 1269, in sage.structure.element.CommutativeRingElement.inverse_mod (sage/structure/element.c:10039)\nNotImplementedError\n```\n\nIt's the fault of other stuff missing in Sage.\n\nAnother thing -- in matrices over ZZ there is a smith_form function, and it's inputs, etc., are *not* consistent with the above.  It doesn't have a transformation option - instead it always gives the transformation matrices.  However, it also says to use the function \"elementary_divisors\" to get the diagonal entries.   I attached a patch that fixes this by making the sage integer matrix snf have the same interface as the generic one. \n\nThe definition of smith_form between your new code and Sage's code (which relies on pari) is inconsistent (see below).  This needs to be somehow resolved.  I haven't done this yet at all.\n\n```\nsage: a = matrix(ZZ,3,[1..9]); a\n\n[1 2 3]\n[4 5 6]\n[7 8 9]\nsage: a.smith_form()\n\n([0 0 0]\n[0 3 0]\n[0 0 1],\n [ 1 -2  1]\n[ 0 -1  1]\n[ 0  2 -1],\n [ 1  2 -1]\n[-2 -1  1]\n[ 1  0  0])\nsage: a.smith_form(transformation=False)\n\n[0 0 0]\n[0 3 0]\n[0 0 1]\nsage: a = matrix(ZZ[i],3,[1..9]); a\n\n[1 2 3]\n[4 5 6]\n[7 8 9]\nsage: a.smith_form(transformation=False)\n\n[ 1  0  0]\n[ 0 -3  0]\n[ 0  0  0]\n```\n\nTo get this into Sage, please:\n* review my matrix_integer_dense patch\n* decide on what to do about the inconsistency between sage/pari/your code.",
    "created_at": "2008-12-07T00:12:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4681#issuecomment-38297",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:7'></a>I read the code, which looks fine.  The doctests pass.  This test passes:

```
for i in range(10):
   print i
   a = random_matrix(ZZ[sqrt(-1)],7)
   d,u,v = a.smith_form()
   assert u*a*v == d
   assert u.det() == 1
   assert v.det() == 1
```

This fails pretty quickly, but it's not the fault of this code:

```
K.<a>=NumberField(x^3-2)
print "h = ", K.class_number()
for i in range(10):
   print i
   a = random_matrix(K,3)
   d,u,v = a.smith_form()
   assert u*a*v == d
   assert u.det() == 1
   assert v.det() == 1
...

Traceback (most recent call last):       d,u,v = a.smith_form()

  File "element.pyx", line 1269, in sage.structure.element.CommutativeRingElement.inverse_mod (sage/structure/element.c:10039)
NotImplementedError
```

It's the fault of other stuff missing in Sage.

Another thing -- in matrices over ZZ there is a smith_form function, and it's inputs, etc., are *not* consistent with the above.  It doesn't have a transformation option - instead it always gives the transformation matrices.  However, it also says to use the function "elementary_divisors" to get the diagonal entries.   I attached a patch that fixes this by making the sage integer matrix snf have the same interface as the generic one. 

The definition of smith_form between your new code and Sage's code (which relies on pari) is inconsistent (see below).  This needs to be somehow resolved.  I haven't done this yet at all.

```
sage: a = matrix(ZZ,3,[1..9]); a

[1 2 3]
[4 5 6]
[7 8 9]
sage: a.smith_form()

([0 0 0]
[0 3 0]
[0 0 1],
 [ 1 -2  1]
[ 0 -1  1]
[ 0  2 -1],
 [ 1  2 -1]
[-2 -1  1]
[ 1  0  0])
sage: a.smith_form(transformation=False)

[0 0 0]
[0 3 0]
[0 0 1]
sage: a = matrix(ZZ[i],3,[1..9]); a

[1 2 3]
[4 5 6]
[7 8 9]
sage: a.smith_form(transformation=False)

[ 1  0  0]
[ 0 -3  0]
[ 0  0  0]
```

To get this into Sage, please:
* review my matrix_integer_dense patch
* decide on what to do about the inconsistency between sage/pari/your code.



---

archive/issue_comments_038298.json:
```json
{
    "body": "<a id='comment:8'></a>Attachment [trac_4681-smithform_integer.patch](tarball://root/attachments/some-uuid/ticket4681/trac_4681-smithform_integer.patch) by @loefflerd created at 2008-12-08 12:55:12\n\nHmm. On reflection, perhaps the way the Sage code was already doing it is the right way: smith_form should always return the transformation matrix, and elementary_divisors should be provided separately.\n\nThis seems more logical to me, because one can define analogues of elementary divisors over any Dedekind domain, but the result is a list of ideals rather than of elements and thus there is no analogue of the transformation matrix. PARI/GP has a function that does this over rings of integers of a general number field. Also, even over ZZ where the transformation matrices do make sense there are some fast algorithms for elementary divisors that don't give them.\n\nAs for the inconsistency of ordering the results, I've called for a quick straw poll on sage-devel.\n\nThe other issue is one of sign. Conventionally elementary divisors are always *nonnegative* integers; one wouldn't want to calculate the invariants of a finitely generated abelian group and be told that it had a direct summand that was cyclic of order -5. But for general PID's there's no canonical choice of sign for the generator of an ideal. I'm sure nobody will actually be all that bothered by this, but I will drop the insistence that U and V have det 1 and replace it with the insistence that the d_i are >= 0, even though this is pretty meaningless.\n\nIncidentally, I just realised the doctests don't pass! I added an is_noetherian method for number field orders, but didn't notice that there is a doctest in sage/rings/ring.pyx that is actually broken by this -- it creates an order, calls is_noetherian() on it and insists that the result should be NotImplementedError. I will fix this.",
    "created_at": "2008-12-08T12:55:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4681#issuecomment-38298",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:8'></a>Attachment [trac_4681-smithform_integer.patch](tarball://root/attachments/some-uuid/ticket4681/trac_4681-smithform_integer.patch) by @loefflerd created at 2008-12-08 12:55:12

Hmm. On reflection, perhaps the way the Sage code was already doing it is the right way: smith_form should always return the transformation matrix, and elementary_divisors should be provided separately.

This seems more logical to me, because one can define analogues of elementary divisors over any Dedekind domain, but the result is a list of ideals rather than of elements and thus there is no analogue of the transformation matrix. PARI/GP has a function that does this over rings of integers of a general number field. Also, even over ZZ where the transformation matrices do make sense there are some fast algorithms for elementary divisors that don't give them.

As for the inconsistency of ordering the results, I've called for a quick straw poll on sage-devel.

The other issue is one of sign. Conventionally elementary divisors are always *nonnegative* integers; one wouldn't want to calculate the invariants of a finitely generated abelian group and be told that it had a direct summand that was cyclic of order -5. But for general PID's there's no canonical choice of sign for the generator of an ideal. I'm sure nobody will actually be all that bothered by this, but I will drop the insistence that U and V have det 1 and replace it with the insistence that the d_i are >= 0, even though this is pretty meaningless.

Incidentally, I just realised the doctests don't pass! I added an is_noetherian method for number field orders, but didn't notice that there is a doctest in sage/rings/ring.pyx that is actually broken by this -- it creates an order, calls is_noetherian() on it and insists that the result should be NotImplementedError. I will fix this.



---

archive/issue_comments_038299.json:
```json
{
    "body": "New patch, against 3.2.2.alpha0",
    "created_at": "2008-12-08T16:24:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4681#issuecomment-38299",
    "user": "https://github.com/loefflerd"
}
```

New patch, against 3.2.2.alpha0



---

archive/issue_comments_038300.json:
```json
{
    "body": "<a id='comment:9'></a>Attachment [4681-smithform-consistent.patch](tarball://root/attachments/some-uuid/ticket4681/4681-smithform-consistent.patch) by @loefflerd created at 2008-12-08 16:50:50\n\n(cc'ed to ncalexan as symplectic_basis is his territory)\n\nNobody's objected violently to the change yet on sage-devel, so the following patch changes SNF over ZZ, to put 1's first and 0's last. (Also, when M is non-square it puts the nonzero entries in the [i,i] diagonal, not on some shifted diagonal ending in the bottom corner like the previous code did -- I found that rather inconvenient.)\n\nAs I suggested above, I've changed the call syntax over a general ring to be consistent with the existing code over ZZ, so I got rid of the \"transformation=True\" argument and added an extra function \"elementary_divisors\" which returns the diagonal entries of M. This can be overridden later, if anyone feels like implementing a fast algorithm for elementary divisors for more general rings.\n\nI've also fixed up \"symplectic_basis\" to be consistent with the new \"smith_form\"; it doesn't explicitly use smith_form, but the conventions for the output are chosen for consistency with smith_form, so I've changed them in tandem. (ncalexan: is this OK with you?)\n\nI didn't actually make it choose ideal representatives that compare as >= 0 -- I decided I couldn't bear to fix such a horrible convention. This means that if R is a general PID, coercing integer matrices from ZZ to R doesn't quite commute with Smith form, but I don't see why one should expect it to.",
    "created_at": "2008-12-08T16:50:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4681#issuecomment-38300",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:9'></a>Attachment [4681-smithform-consistent.patch](tarball://root/attachments/some-uuid/ticket4681/4681-smithform-consistent.patch) by @loefflerd created at 2008-12-08 16:50:50

(cc'ed to ncalexan as symplectic_basis is his territory)

Nobody's objected violently to the change yet on sage-devel, so the following patch changes SNF over ZZ, to put 1's first and 0's last. (Also, when M is non-square it puts the nonzero entries in the [i,i] diagonal, not on some shifted diagonal ending in the bottom corner like the previous code did -- I found that rather inconvenient.)

As I suggested above, I've changed the call syntax over a general ring to be consistent with the existing code over ZZ, so I got rid of the "transformation=True" argument and added an extra function "elementary_divisors" which returns the diagonal entries of M. This can be overridden later, if anyone feels like implementing a fast algorithm for elementary divisors for more general rings.

I've also fixed up "symplectic_basis" to be consistent with the new "smith_form"; it doesn't explicitly use smith_form, but the conventions for the output are chosen for consistency with smith_form, so I've changed them in tandem. (ncalexan: is this OK with you?)

I didn't actually make it choose ideal representatives that compare as >= 0 -- I decided I couldn't bear to fix such a horrible convention. This means that if R is a general PID, coercing integer matrices from ZZ to R doesn't quite commute with Smith form, but I don't see why one should expect it to.



---

archive/issue_comments_038301.json:
```json
{
    "body": "fixes broken docstring + handling of empty matrices",
    "created_at": "2008-12-08T18:08:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4681#issuecomment-38301",
    "user": "https://github.com/loefflerd"
}
```

fixes broken docstring + handling of empty matrices



---

archive/issue_comments_038302.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,3 @@\n Smith form is a useful canonical form for matrices over a PID. Sage already has it for ZZ. I've coded up a very basic implementation that should work over any PID Sage knows about (although it is not fast).\n+\n+**Note**: This ticket should also fix #3068\n``````\n",
    "created_at": "2008-12-08T18:09:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4681#issuecomment-38302",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,3 @@
 Smith form is a useful canonical form for matrices over a PID. Sage already has it for ZZ. I've coded up a very basic implementation that should work over any PID Sage knows about (although it is not fast).
+
+**Note**: This ticket should also fix #3068
``````




---

archive/issue_comments_038303.json:
```json
{
    "body": "<a id='comment:10'></a>Attachment [4681-docstringfix.patch](tarball://root/attachments/some-uuid/ticket4681/4681-docstringfix.patch) by mabshoff created at 2008-12-08 18:09:48",
    "created_at": "2008-12-08T18:09:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4681#issuecomment-38303",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:10'></a>Attachment [4681-docstringfix.patch](tarball://root/attachments/some-uuid/ticket4681/4681-docstringfix.patch) by mabshoff created at 2008-12-08 18:09:48



---

archive/issue_comments_038304.json:
```json
{
    "body": "<a id='comment:11'></a>Just realised that (a) I missed the fact that there is a doctest for symplectic_basis in matrix2.pyx and (b) there is an open ticket #3068 regarding Smith form of empty matrices. I've added a tiny patchlet that fixes both things.",
    "created_at": "2008-12-08T18:13:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4681#issuecomment-38304",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:11'></a>Just realised that (a) I missed the fact that there is a doctest for symplectic_basis in matrix2.pyx and (b) there is an open ticket #3068 regarding Smith form of empty matrices. I've added a tiny patchlet that fixes both things.



---

archive/issue_comments_038305.json:
```json
{
    "body": "<a id='comment:12'></a>Hi, I can't figure out what patches are supposed to work.\n\nIf I apply 4681-smithform-consistent.patch and then 4681-docstringfix.patch, everything works on sage.math but not on my home machine -- there is no inverse_mod for the maximal order elements in question.  Can you clarify?  Do I need some other patches from other tickets?\n\nBTW, I am fine with the changes you made to symplectic_basis.",
    "created_at": "2008-12-09T21:25:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4681#issuecomment-38305",
    "user": "https://github.com/ncalexan"
}
```

<a id='comment:12'></a>Hi, I can't figure out what patches are supposed to work.

If I apply 4681-smithform-consistent.patch and then 4681-docstringfix.patch, everything works on sage.math but not on my home machine -- there is no inverse_mod for the maximal order elements in question.  Can you clarify?  Do I need some other patches from other tickets?

BTW, I am fine with the changes you made to symplectic_basis.



---

archive/issue_comments_038306.json:
```json
{
    "body": "<a id='comment:13'></a>I see that it requires 4537.  I'll apply that and test again.",
    "created_at": "2008-12-09T21:34:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4681#issuecomment-38306",
    "user": "https://github.com/ncalexan"
}
```

<a id='comment:13'></a>I see that it requires 4537.  I'll apply that and test again.



---

archive/issue_comments_038307.json:
```json
{
    "body": "<a id='comment:14'></a>Works for me, and the code is fairly straight forward.  It also fixes (and doctests) 3068.  Apply only the final two patches.",
    "created_at": "2008-12-09T21:39:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4681#issuecomment-38307",
    "user": "https://github.com/ncalexan"
}
```

<a id='comment:14'></a>Works for me, and the code is fairly straight forward.  It also fixes (and doctests) 3068.  Apply only the final two patches.



---

archive/issue_comments_038308.json:
```json
{
    "body": "Attachment [4681-more-doctests.patch](tarball://root/attachments/some-uuid/ticket4681/4681-more-doctests.patch) by @loefflerd created at 2008-12-09 21:53:50\n\napply after previous two patches",
    "created_at": "2008-12-09T21:53:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4681#issuecomment-38308",
    "user": "https://github.com/loefflerd"
}
```

Attachment [4681-more-doctests.patch](tarball://root/attachments/some-uuid/ticket4681/4681-more-doctests.patch) by @loefflerd created at 2008-12-09 21:53:50

apply after previous two patches



---

archive/issue_comments_038309.json:
```json
{
    "body": "<a id='comment:15'></a>Actually, after your comments on sage-devel, regarding the lack of doctests over base rings other than number field orders, I have done a third patch adding these. I meant to upload this yesterday but trac was down at the time. It also now raises an error over non-exact base rings, because I tested it with a 2x2 random matrix over CC and it got stuck in an infinite loop; and it always chooses 1 as a generator of the unit ideal so the results look nicer over fields. See the above third patch, to be applied on top of the previous two.\n\nApologies for the profusion of patches!",
    "created_at": "2008-12-09T21:58:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4681#issuecomment-38309",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:15'></a>Actually, after your comments on sage-devel, regarding the lack of doctests over base rings other than number field orders, I have done a third patch adding these. I meant to upload this yesterday but trac was down at the time. It also now raises an error over non-exact base rings, because I tested it with a 2x2 random matrix over CC and it got stuck in an infinite loop; and it always chooses 1 as a generator of the unit ideal so the results look nicer over fields. See the above third patch, to be applied on top of the previous two.

Apologies for the profusion of patches!



---

archive/issue_comments_038310.json:
```json
{
    "body": "<a id='comment:16'></a>Looks good to me.",
    "created_at": "2008-12-10T02:06:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4681#issuecomment-38310",
    "user": "https://github.com/ncalexan"
}
```

<a id='comment:16'></a>Looks good to me.



---

archive/issue_comments_038311.json:
```json
{
    "body": "<a id='comment:17'></a>Unfortunately there is a slight reject for trac_4681_part1_smithform-consistent.patch:\n\n```\nsage-3.2.2.alpha1/devel/sage$ patch -p1 < trac_4681_part1_smithform-consistent.patch \npatching file sage/matrix/matrix2.pyx\nHunk #1 FAILED at 4549.\n1 out of 1 hunk FAILED -- saving rejects to file sage/matrix/matrix2.pyx.rej\npatching file sage/matrix/matrix_integer_dense.pyx\npatching file sage/matrix/symplectic_basis.py\npatching file sage/modular/etaproducts.py\npatching file sage/rings/number_field/number_field_element.pyx\npatching file sage/rings/number_field/number_field_ideal.py\npatching file sage/rings/number_field/order.py\npatching file sage/rings/polynomial/polynomial_element.pyx\npatching file sage/rings/ring.pyx\n```\n\n3.2.2.alpha1 should be out in a couple hours, so please rebase. For the record: I want to apply\n\n* trac_4681_part1_smithform-consistent.patch\n* 4681-docstringfix.patch\n* 4681-more-doctests.patch\n\nCheers,\n\nMichael",
    "created_at": "2008-12-10T07:23:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4681#issuecomment-38311",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:17'></a>Unfortunately there is a slight reject for trac_4681_part1_smithform-consistent.patch:

```
sage-3.2.2.alpha1/devel/sage$ patch -p1 < trac_4681_part1_smithform-consistent.patch 
patching file sage/matrix/matrix2.pyx
Hunk #1 FAILED at 4549.
1 out of 1 hunk FAILED -- saving rejects to file sage/matrix/matrix2.pyx.rej
patching file sage/matrix/matrix_integer_dense.pyx
patching file sage/matrix/symplectic_basis.py
patching file sage/modular/etaproducts.py
patching file sage/rings/number_field/number_field_element.pyx
patching file sage/rings/number_field/number_field_ideal.py
patching file sage/rings/number_field/order.py
patching file sage/rings/polynomial/polynomial_element.pyx
patching file sage/rings/ring.pyx
```

3.2.2.alpha1 should be out in a couple hours, so please rebase. For the record: I want to apply

* trac_4681_part1_smithform-consistent.patch
* 4681-docstringfix.patch
* 4681-more-doctests.patch

Cheers,

Michael



---

archive/issue_comments_038312.json:
```json
{
    "body": "<a id='comment:18'></a>Looks like it's clashing with trac_4493_matrix-derivative.patch -- nothing else in release-cycles-3.2.2/alpha1 seems to change matrix2.pyx. I'll rebase it around that, and combine the three patches into one at the same time.",
    "created_at": "2008-12-10T10:20:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4681#issuecomment-38312",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:18'></a>Looks like it's clashing with trac_4493_matrix-derivative.patch -- nothing else in release-cycles-3.2.2/alpha1 seems to change matrix2.pyx. I'll rebase it around that, and combine the three patches into one at the same time.



---

archive/issue_comments_038313.json:
```json
{
    "body": "<a id='comment:19'></a>Replying to [comment:18 davidloeffler]:\n\nHi David,\n\n> Looks like it's clashing with trac_4493_matrix-derivative.patch -- nothing else in release-cycles-3.2.2/alpha1 seems to change matrix2.pyx. I'll rebase it around that, and combine the three patches into one at the same time.\n\n\nExcellent, I can wait a couple hours before doing alpha1 since I can work on some other fixes in the meantime. Note that you can test if your patch applies to my current merge tree at\n\n\n  /scratch/mabshoff/release-cycle/sage-3.2.2.alpha1/devel/sage\n\nby running \"patch -p1 --dry-run < foo.patch\" from inside that directory on sage.math.\n\nCheers,\n\nMichael",
    "created_at": "2008-12-10T10:24:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4681#issuecomment-38313",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:19'></a>Replying to [comment:18 davidloeffler]:

Hi David,

> Looks like it's clashing with trac_4493_matrix-derivative.patch -- nothing else in release-cycles-3.2.2/alpha1 seems to change matrix2.pyx. I'll rebase it around that, and combine the three patches into one at the same time.


Excellent, I can wait a couple hours before doing alpha1 since I can work on some other fixes in the meantime. Note that you can test if your patch applies to my current merge tree at


  /scratch/mabshoff/release-cycle/sage-3.2.2.alpha1/devel/sage

by running "patch -p1 --dry-run < foo.patch" from inside that directory on sage.math.

Cheers,

Michael



---

archive/issue_comments_038314.json:
```json
{
    "body": "Replaces all previous patches, rebased to apply over the top of #4493",
    "created_at": "2008-12-10T11:01:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4681#issuecomment-38314",
    "user": "https://github.com/loefflerd"
}
```

Replaces all previous patches, rebased to apply over the top of #4493



---

archive/issue_comments_038315.json:
```json
{
    "body": "<a id='comment:20'></a>Attachment [4681-smithform-all.patch](tarball://root/attachments/some-uuid/ticket4681/4681-smithform-all.patch) by @loefflerd created at 2008-12-10 11:03:38\n\nHere is the rebased combined patch. I've checked on sage.math as you suggest and it applies OK to the current merge tree.",
    "created_at": "2008-12-10T11:03:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4681#issuecomment-38315",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:20'></a>Attachment [4681-smithform-all.patch](tarball://root/attachments/some-uuid/ticket4681/4681-smithform-all.patch) by @loefflerd created at 2008-12-10 11:03:38

Here is the rebased combined patch. I've checked on sage.math as you suggest and it applies OK to the current merge tree.



---

archive/issue_comments_038316.json:
```json
{
    "body": "<a id='comment:21'></a>Thanks David,\n\nit does indeed apply cleanly and I am doctesting it now.\n\nCheers,\n\nMichael",
    "created_at": "2008-12-10T11:09:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4681#issuecomment-38316",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:21'></a>Thanks David,

it does indeed apply cleanly and I am doctesting it now.

Cheers,

Michael



---

archive/issue_events_010720.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2008-12-10T11:25:53Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/4681",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4681#event-10720"
}
```



---

archive/issue_comments_038317.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2008-12-10T11:25:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4681#issuecomment-38317",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

Resolution: fixed



---

archive/issue_comments_038318.json:
```json
{
    "body": "<a id='comment:22'></a>Merged 4681-smithform-all.patch in Sage 3.2.2.alpha1.\n\nAll doctest including -long pass\n\nCheers,\n\nMichael",
    "created_at": "2008-12-10T11:25:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4681#issuecomment-38318",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:22'></a>Merged 4681-smithform-all.patch in Sage 3.2.2.alpha1.

All doctest including -long pass

Cheers,

Michael



---

archive/issue_comments_038319.json:
```json
{
    "body": "Changing merged from \"\" to \"3.2.2.alpha1\"",
    "created_at": "2009-06-07T09:37:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4681#issuecomment-38319",
    "user": "https://github.com/loefflerd"
}
```

Changing merged from "" to "3.2.2.alpha1"



---

archive/issue_comments_038320.json:
```json
{
    "body": "Changing reviewer from \"\" to \"William Stein, Nick Alexander\"",
    "created_at": "2009-06-07T09:37:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4681#issuecomment-38320",
    "user": "https://github.com/loefflerd"
}
```

Changing reviewer from "" to "William Stein, Nick Alexander"



---

archive/issue_comments_038321.json:
```json
{
    "body": "Changing author from \"\" to \"David Loeffler\"",
    "created_at": "2009-06-07T09:37:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4681#issuecomment-38321",
    "user": "https://github.com/loefflerd"
}
```

Changing author from "" to "David Loeffler"
