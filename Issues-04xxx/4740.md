# Issue 4740: avoid creating unneeded homsets when coercing

archive/issues_004740.json:
```json
{
    "assignees": [
        "https://github.com/robertwb"
    ],
    "body": "Burcin reported at #4639:\n\n```\nsage: F = GF(13)\nsage: get_memory_usage()\n708.02734375\nsage: for _ in xrange(10000):\n....:     t = F.coerce(F(234234))\n....:     \nsage: get_memory_usage()\n728.15234375\nsage: for _ in xrange(100000):\n    t = F.coerce(F(234234))\n....:     \nsage: get_memory_usage()\n932.3125\nsage: for _ in xrange(100000):\n    t = F.coerce(F(234234))\n....:     \nsage: get_memory_usage()\n1136.35546875\n```\nSince the patch by RobertWB at that ticket fixes the issue Burcin reported, but not the original one I am moving it over to this ticket.\n\nCheers,\n\nMichael\n\n__Apply__\n\n[attachment: trac4740-cache_coerce_from_self.patch\u200b](https://github.com/sagemath/sage/files/ticket4740/572d72e1891f521bd1f386f06f12be65.gz)\n\nDepends on #14519\n\nCC:  @burcin @robertwb @simon-king-jena\n\nReviewer: **Mike Hansen**\n\nAuthor: **Simon King**\n\nMerged: **sage-5.12.beta3**\n\nComponent: **memleak**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/4740_\n\n",
    "closed_at": "2013-08-20T12:56:42Z",
    "created_at": "2008-12-08T11:23:21Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/memleak",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.12",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "avoid creating unneeded homsets when coercing",
    "type": "issue",
    "updated_at": "2013-08-20T12:56:42Z",
    "url": "https://github.com/sagemath/sage/issues/4740",
    "user": "https://github.com/sagetrac-mabshoff"
}
```
Burcin reported at #4639:

```
sage: F = GF(13)
sage: get_memory_usage()
708.02734375
sage: for _ in xrange(10000):
....:     t = F.coerce(F(234234))
....:     
sage: get_memory_usage()
728.15234375
sage: for _ in xrange(100000):
    t = F.coerce(F(234234))
....:     
sage: get_memory_usage()
932.3125
sage: for _ in xrange(100000):
    t = F.coerce(F(234234))
....:     
sage: get_memory_usage()
1136.35546875
```
Since the patch by RobertWB at that ticket fixes the issue Burcin reported, but not the original one I am moving it over to this ticket.

Cheers,

Michael

__Apply__

[attachment: trac4740-cache_coerce_from_self.patch​](https://github.com/sagemath/sage/files/ticket4740/572d72e1891f521bd1f386f06f12be65.gz)

Depends on #14519

CC:  @burcin @robertwb @simon-king-jena

Reviewer: **Mike Hansen**

Author: **Simon King**

Merged: **sage-5.12.beta3**

Component: **memleak**

_Issue created by migration from https://trac.sagemath.org/ticket/4740_





---

archive/issue_events_053990.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-12-08T11:23:21Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "milestone_number": null,
    "milestone_title": "sage-3.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-53990"
}
```



---

archive/issue_events_053991.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-12-08T11:23:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "label": "https://github.com/sagemath/sage/labels/memleak",
    "label_color": "d73a4a",
    "label_name": "memleak",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-53991"
}
```



---

archive/issue_events_053992.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-12-08T11:23:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-53992"
}
```



---

archive/issue_events_053993.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-12-08T11:23:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-53993"
}
```



---

archive/issue_events_053994.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-12-08T11:23:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-53994"
}
```



---

archive/issue_events_053995.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2008-12-08T11:23:21Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "subject": "https://github.com/sagetrac-mabshoff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-53995"
}
```



---

archive/issue_comments_028462.json:
```json
{
    "body": "Attachment: **[trac_4740_coerce-leak.patch.gz](https://github.com/sagemath/sage/files/ticket4740/trac_4740_coerce-leak.patch.gz)**\n\nPatch by RobertWB, originally from #4639",
    "created_at": "2008-12-08T11:25:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4740#issuecomment-28462",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

Attachment: **[trac_4740_coerce-leak.patch.gz](https://github.com/sagemath/sage/files/ticket4740/trac_4740_coerce-leak.patch.gz)**

Patch by RobertWB, originally from #4639



---

archive/issue_events_053996.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-12-08T11:28:57Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-53996"
}
```



---

archive/issue_events_053997.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-12-08T11:28:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-53997"
}
```



---

archive/issue_comments_028463.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nPatch by RobertWB, review by William. \n\nCheers,\n\nMichael",
    "created_at": "2008-12-08T11:28:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4740#issuecomment-28463",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:1" align="right">comment:1</div>

Patch by RobertWB, review by William. 

Cheers,

Michael



---

archive/issue_comments_028464.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nThis patch causes a failure with the pickle jar:\n\n```\n**********************************************************************\nFile \"/scratch/mabshoff/release-cycle/sage-3.2.2.alpha1/devel/sage/sage/structure/sage_object.pyx\", line 371, in __main__.example_16\nFailed example:\n    sage.structure.sage_object.unpickle_all(std)###line 682:_sage_    >>> sage.structure.sage_object.unpickle_all(std)\nExpected:\n    doctest:...: DeprecationWarning: Your data is stored in an old format. Please use the save() function to store your data in a more recent format.\n    Successfully unpickled ... objects.\n    Failed to unpickle 0 objects.\nGot:\n    doctest:1172: DeprecationWarning: Your data is stored in an old format. Please use the save() function to store your data in a more recent format.\n    ** failed:  _class__sage_rings_finite_field_morphism_FiniteFieldHomset__.sobj\n    Failed:\n    _class__sage_rings_finite_field_morphism_FiniteFieldHomset__.sobj\n    Successfully unpickled 453 objects.\n    Failed to unpickle 1 objects.\n**********************************************************************\n1 items had failures:\n   1 of   7 in __main__.example_16\n```\n\nCheers,\n\nMichael",
    "created_at": "2008-12-08T11:52:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4740#issuecomment-28464",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:2" align="right">comment:2</div>

This patch causes a failure with the pickle jar:

```
**********************************************************************
File "/scratch/mabshoff/release-cycle/sage-3.2.2.alpha1/devel/sage/sage/structure/sage_object.pyx", line 371, in __main__.example_16
Failed example:
    sage.structure.sage_object.unpickle_all(std)###line 682:_sage_    >>> sage.structure.sage_object.unpickle_all(std)
Expected:
    doctest:...: DeprecationWarning: Your data is stored in an old format. Please use the save() function to store your data in a more recent format.
    Successfully unpickled ... objects.
    Failed to unpickle 0 objects.
Got:
    doctest:1172: DeprecationWarning: Your data is stored in an old format. Please use the save() function to store your data in a more recent format.
    ** failed:  _class__sage_rings_finite_field_morphism_FiniteFieldHomset__.sobj
    Failed:
    _class__sage_rings_finite_field_morphism_FiniteFieldHomset__.sobj
    Successfully unpickled 453 objects.
    Failed to unpickle 1 objects.
**********************************************************************
1 items had failures:
   1 of   7 in __main__.example_16
```

Cheers,

Michael



---

archive/issue_events_053998.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-12-08T11:52:40Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-53998"
}
```



---

archive/issue_events_053999.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-12-08T11:52:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-53999"
}
```



---

archive/issue_comments_028465.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nOnce the pickling issue is fixed this should go in.\n\nCheers,\n\nMichael",
    "created_at": "2008-12-15T18:42:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4740#issuecomment-28465",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:3" align="right">comment:3</div>

Once the pickling issue is fixed this should go in.

Cheers,

Michael



---

archive/issue_events_054000.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-12-15T18:42:48Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-54000"
}
```



---

archive/issue_events_054001.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-12-15T18:42:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20blocker%20/%201",
    "label_color": "ff0000",
    "label_name": "p: blocker / 1",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-54001"
}
```



---

archive/issue_events_054002.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-12-15T18:42:48Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "milestone_number": null,
    "milestone_title": "sage-3.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-54002"
}
```



---

archive/issue_events_054003.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-12-15T18:42:48Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "milestone_number": null,
    "milestone_title": "sage-3.2.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-54003"
}
```



---

archive/issue_events_054004.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-12-21T00:53:34Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "milestone_number": null,
    "milestone_title": "sage-3.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-54004"
}
```



---

archive/issue_events_054005.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-12-21T00:53:34Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "milestone_number": null,
    "milestone_title": "sage-3.2.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-54005"
}
```



---

archive/issue_comments_028466.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nRobert,\n\nthe leak seems to be gone in 3.2.2:\n\n```\n----------------------------------------------------------------------\n| Sage Version 3.2.2, Release Date: 2008-12-18                       |\n| Type notebook() for the GUI, and license() for information.        |\n----------------------------------------------------------------------\nsage: F = GF(13)\nsage: get_memory_usage()\n689.02734375\nsage: for _ in xrange(10000):\n....:     t = F.coerce(F(234234))\n....:     \nsage: get_memory_usage()\n689.02734375\nsage: for _ in xrange(100000):\n....:     t = F.coerce(F(234234))\n....:     \nsage: get_memory_usage()\n689.02734375\nsage: for _ in xrange(100000):\n....:     t = F.coerce(F(234234))\n....:     \nsage: get_memory_usage()\n689.02734375\nsage: \n```\nShould we close this ticket as won't fix or is the patch her still relevant? In that case we should update the ticket to reflect the actual issue being fixed here.\n\nCheers,\n\nMichael",
    "created_at": "2008-12-21T00:53:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4740#issuecomment-28466",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:4" align="right">comment:4</div>

Robert,

the leak seems to be gone in 3.2.2:

```
----------------------------------------------------------------------
| Sage Version 3.2.2, Release Date: 2008-12-18                       |
| Type notebook() for the GUI, and license() for information.        |
----------------------------------------------------------------------
sage: F = GF(13)
sage: get_memory_usage()
689.02734375
sage: for _ in xrange(10000):
....:     t = F.coerce(F(234234))
....:     
sage: get_memory_usage()
689.02734375
sage: for _ in xrange(100000):
....:     t = F.coerce(F(234234))
....:     
sage: get_memory_usage()
689.02734375
sage: for _ in xrange(100000):
....:     t = F.coerce(F(234234))
....:     
sage: get_memory_usage()
689.02734375
sage: 
```
Should we close this ticket as won't fix or is the patch her still relevant? In that case we should update the ticket to reflect the actual issue being fixed here.

Cheers,

Michael



---

archive/issue_events_054006.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2008-12-21T09:57:41Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20blocker%20/%201",
    "label_color": "ff0000",
    "label_name": "p: blocker / 1",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-54006"
}
```



---

archive/issue_events_054007.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2008-12-21T09:57:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-54007"
}
```



---

archive/issue_comments_028467.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nThe patch is still relevant here. What is going on is every time coerce is called, a new homset is created. Creating a new homset doesn't leak anymore, but it's still sub-optimal. \n\nI don't know that I'll have time to look into this anytime soon, but it's not a blocker anymore as the leak is solved elsewhere.",
    "created_at": "2008-12-21T09:57:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4740#issuecomment-28467",
    "user": "https://github.com/robertwb"
}
```

<div id="comment:5" align="right">comment:5</div>

The patch is still relevant here. What is going on is every time coerce is called, a new homset is created. Creating a new homset doesn't leak anymore, but it's still sub-optimal. 

I don't know that I'll have time to look into this anytime soon, but it's not a blocker anymore as the leak is solved elsewhere.



---

archive/issue_events_054008.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2008-12-21T09:57:41Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "milestone_number": null,
    "milestone_title": "sage-3.2.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-54008"
}
```



---

archive/issue_events_054009.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2008-12-21T09:57:41Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "milestone_number": null,
    "milestone_title": "sage-3.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-54009"
}
```



---

archive/issue_comments_028468.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nok, \n\nI renamed the ticket then.\n\nCheers,\n\nMichael",
    "created_at": "2008-12-21T09:59:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4740#issuecomment-28468",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:6" align="right">comment:6</div>

ok, 

I renamed the ticket then.

Cheers,

Michael



---

archive/issue_events_054010.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-12-21T09:59:53Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "title_is": "avoid creating unneeded homsets when coercing",
    "title_was": "Fix memory leak in finite field coercion",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-54010"
}
```



---

archive/issue_comments_028469.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nHi Robert,\n\naccidentally I found this rather old ticket.\n\nReplying to [@robertwb](#comment:5):\n> The patch is still relevant here. What is going on is every time coerce is called, a new homset is created. Creating a new homset doesn't leak anymore, but it's still sub-optimal. \n\nIs this still the case? In what situation is the homset created? Is it not cached? In what files does it occur?\n\nCheers,\nSimon",
    "created_at": "2010-06-14T08:30:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4740#issuecomment-28469",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:7" align="right">comment:7</div>

Hi Robert,

accidentally I found this rather old ticket.

Replying to [@robertwb](#comment:5):
> The patch is still relevant here. What is going on is every time coerce is called, a new homset is created. Creating a new homset doesn't leak anymore, but it's still sub-optimal. 

Is this still the case? In what situation is the homset created? Is it not cached? In what files does it occur?

Cheers,
Simon



---

archive/issue_comments_028470.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nI also found this ticket. It could be very well that this is still causing memory leaks. Look for example at the reference chain that is keeping ModularSymbols alive at #10548",
    "created_at": "2011-01-08T01:00:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4740#issuecomment-28470",
    "user": "https://github.com/koffie"
}
```

<div id="comment:8" align="right">comment:8</div>

I also found this ticket. It could be very well that this is still causing memory leaks. Look for example at the reference chain that is keeping ModularSymbols alive at #10548



---

archive/issue_comments_028471.json:
```json
{
    "body": "Author: **Mike Hansen**",
    "created_at": "2013-07-22T15:10:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4740#issuecomment-28471",
    "user": "https://github.com/mwhansen"
}
```

Author: **Mike Hansen**



---

archive/issue_events_054011.json:
```json
{
    "actor": "https://github.com/mwhansen",
    "created_at": "2013-07-22T15:10:29Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-54011"
}
```



---

archive/issue_events_054012.json:
```json
{
    "actor": "https://github.com/mwhansen",
    "created_at": "2013-07-22T15:10:29Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-54012"
}
```



---

archive/issue_comments_028472.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nI think homesets are still created each time.  We could try the following patch which does fix the issue.  The timings also improved:\n\nBefore:\n\n```\nsage: %timeit t = F.coerce(F(234234))\n10000 loops, best of 3: 197 us per loop\n```\n\nAfter:\n\n```\nsage: %timeit t = F.coerce(F(234234))\n10000 loops, best of 3: 23.4 us per loop\n```\n\nSimon -- see any issues here?",
    "created_at": "2013-07-22T15:10:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4740#issuecomment-28472",
    "user": "https://github.com/mwhansen"
}
```

<div id="comment:9" align="right">comment:9</div>

I think homesets are still created each time.  We could try the following patch which does fix the issue.  The timings also improved:

Before:

```
sage: %timeit t = F.coerce(F(234234))
10000 loops, best of 3: 197 us per loop
```

After:

```
sage: %timeit t = F.coerce(F(234234))
10000 loops, best of 3: 23.4 us per loop
```

Simon -- see any issues here?



---

archive/issue_comments_028473.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nAttachment: **[trac_4740.patch.gz](https://github.com/sagemath/sage/files/ticket4740/trac_4740.patch.gz)**\n\nApply trac_4740.patch",
    "created_at": "2013-07-22T15:11:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4740#issuecomment-28473",
    "user": "https://github.com/mwhansen"
}
```

<div id="comment:11" align="right">comment:11</div>

Attachment: **[trac_4740.patch.gz](https://github.com/sagemath/sage/files/ticket4740/trac_4740.patch.gz)**

Apply trac_4740.patch



---

archive/issue_events_054013.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-07-22T16:40:25Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-54013"
}
```



---

archive/issue_events_054014.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-07-22T16:40:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-54014"
}
```



---

archive/issue_comments_028474.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@mwhansen](#comment:9):\n> Simon -- see any issues here?\n\nYes, and a quite severe issue.\n\nThe problem is, as often, unique versus non-unique parent structures. For coercion, we need that the domain and codomain of a coercion from A to B are not just equal but identical to A and B. But with `UniqueRepresentation`, the given input arguments are compared by equality, not by identity. That's why it was a conscious decision to use `TripleDict` for caching homsets.\n\nThe cache is provided by the `Hom()` function in sage.categories.homset. If homsets are really created over and over again, then there seems to be a rogue call to `Homset(...)`. The solution is not to make `Homset` a cached class, but to call the `Hom()` function instead.",
    "created_at": "2013-07-22T16:40:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4740#issuecomment-28474",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@mwhansen](#comment:9):
> Simon -- see any issues here?

Yes, and a quite severe issue.

The problem is, as often, unique versus non-unique parent structures. For coercion, we need that the domain and codomain of a coercion from A to B are not just equal but identical to A and B. But with `UniqueRepresentation`, the given input arguments are compared by equality, not by identity. That's why it was a conscious decision to use `TripleDict` for caching homsets.

The cache is provided by the `Hom()` function in sage.categories.homset. If homsets are really created over and over again, then there seems to be a rogue call to `Homset(...)`. The solution is not to make `Homset` a cached class, but to call the `Hom()` function instead.



---

archive/issue_comments_028475.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nPS: For the same reason I don't like Robert's original patch.\n\nI think we should first find out where the homset constructor is called when Hom should be called instead.",
    "created_at": "2013-07-22T16:44:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4740#issuecomment-28475",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:13" align="right">comment:13</div>

PS: For the same reason I don't like Robert's original patch.

I think we should first find out where the homset constructor is called when Hom should be called instead.



---

archive/issue_comments_028476.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nInteresting. I found the following, by inserting a print statement into `Homset.__init__`:\n\n```\nsage: F = GF(13)\nsage: x = F(234234)\ncalling Homset Integer Ring Finite Field of size 13 Category of euclidean domains\nsage: x = F(234234)   # the homset is created only once, which is fine\nsage: t = F.coerce(F(234234))   # there is a homset created...\ncalling Homset Finite Field of size 13 Finite Field of size 13 Category of rings\nsage: t = F.coerce(F(234234))   # ... repeatedly\ncalling Homset Finite Field of size 13 Finite Field of size 13 Category of rings\nsage: t = F.coerce(F(234234))\ncalling Homset Finite Field of size 13 Finite Field of size 13 Category of rings\nsage: I = F.coerce_map_from(F)  # creating a coerce map, the homset is created again, but...\ncalling Homset Finite Field of size 13 Finite Field of size 13 Category of rings\nsage: t = F.coerce(F(234234))   # ... now the problem is fixed!\nsage: t = F.coerce(F(234234))\n```\n\nThis seems to suggest that\n1. `F.coerce` seems to use a cached coerce map from F to F, but if it isn't cached, it would create the coerce map repeatedly.\n2. It re-creates the coercion map such that the parent of the coercion map is re-created as well.",
    "created_at": "2013-07-22T16:53:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4740#issuecomment-28476",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:14" align="right">comment:14</div>

Interesting. I found the following, by inserting a print statement into `Homset.__init__`:

```
sage: F = GF(13)
sage: x = F(234234)
calling Homset Integer Ring Finite Field of size 13 Category of euclidean domains
sage: x = F(234234)   # the homset is created only once, which is fine
sage: t = F.coerce(F(234234))   # there is a homset created...
calling Homset Finite Field of size 13 Finite Field of size 13 Category of rings
sage: t = F.coerce(F(234234))   # ... repeatedly
calling Homset Finite Field of size 13 Finite Field of size 13 Category of rings
sage: t = F.coerce(F(234234))
calling Homset Finite Field of size 13 Finite Field of size 13 Category of rings
sage: I = F.coerce_map_from(F)  # creating a coerce map, the homset is created again, but...
calling Homset Finite Field of size 13 Finite Field of size 13 Category of rings
sage: t = F.coerce(F(234234))   # ... now the problem is fixed!
sage: t = F.coerce(F(234234))
```

This seems to suggest that
1. `F.coerce` seems to use a cached coerce map from F to F, but if it isn't cached, it would create the coerce map repeatedly.
2. It re-creates the coercion map such that the parent of the coercion map is re-created as well.



---

archive/issue_comments_028477.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nI just tried to use `trace(\"F.coerce(x)\")` to see what happens. And now, it seems to me that `Hom()` is called as it should---but its cache is broken, for a reason that I don't understand.",
    "created_at": "2013-07-22T17:13:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4740#issuecomment-28477",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:15" align="right">comment:15</div>

I just tried to use `trace("F.coerce(x)")` to see what happens. And now, it seems to me that `Hom()` is called as it should---but its cache is broken, for a reason that I don't understand.



---

archive/issue_comments_028478.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nI found the problem!!\n\nThe homset is stored in the cache, but it is then immediately erased again. Apparently, a strong reference to the homset is missing.",
    "created_at": "2013-07-22T17:21:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4740#issuecomment-28478",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:16" align="right">comment:16</div>

I found the problem!!

The homset is stored in the cache, but it is then immediately erased again. Apparently, a strong reference to the homset is missing.



---

archive/issue_comments_028479.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nNext observation: If one creates\n\n```\nsage: I = F.coerce_map_from(F)\n```\nand then does `del I`, the homset is again erased from the cache.\n\nBut this must not happen! Namely, `F.coerce_map_from(...)` is supposed to use a cache. Granted, the cache is again using weak keys (via `MonoDict`), but as long as `F` is kept in memory, the coercion from F to F must not vanish.",
    "created_at": "2013-07-22T17:26:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4740#issuecomment-28479",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:17" align="right">comment:17</div>

Next observation: If one creates

```
sage: I = F.coerce_map_from(F)
```
and then does `del I`, the homset is again erased from the cache.

But this must not happen! Namely, `F.coerce_map_from(...)` is supposed to use a cache. Granted, the cache is again using weak keys (via `MonoDict`), but as long as `F` is kept in memory, the coercion from F to F must not vanish.



---

archive/issue_comments_028480.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nLook at the following snippet from `Parent.coerce_map_from(self,S)`:\n\n```python\n        if S == self:\n            # non-unique parents\n            if unique_parent_warnings:\n                print \"Warning: non-unique parents %s\"%(type(S))\n            return self._generic_convert_map(S)\n```\n`self._generic_convert_map(S)` does not do caching.\n\nHence, the general problem is: A coercion from self to self will never be cached.",
    "created_at": "2013-07-22T17:34:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4740#issuecomment-28480",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:18" align="right">comment:18</div>

Look at the following snippet from `Parent.coerce_map_from(self,S)`:

```python
        if S == self:
            # non-unique parents
            if unique_parent_warnings:
                print "Warning: non-unique parents %s"%(type(S))
            return self._generic_convert_map(S)
```
`self._generic_convert_map(S)` does not do caching.

Hence, the general problem is: A coercion from self to self will never be cached.



---

archive/issue_comments_028481.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nI see two potential solutions, and the \"info\" I am seeking is: What would you prefer?\n\nWe could\n\n1. let `F.coerce_map_from(F)` use the cache (I think this is what I would prefer), or\n2. let `F.coerce(x)` avoid creating a morphism, if the parent of x is F.\n\nIt might even make sense to do both, 2. for efficiency.",
    "created_at": "2013-07-22T17:37:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4740#issuecomment-28481",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:19" align="right">comment:19</div>

I see two potential solutions, and the "info" I am seeking is: What would you prefer?

We could

1. let `F.coerce_map_from(F)` use the cache (I think this is what I would prefer), or
2. let `F.coerce(x)` avoid creating a morphism, if the parent of x is F.

It might even make sense to do both, 2. for efficiency.



---

archive/issue_events_054015.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-07-22T17:37:30Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-54015"
}
```



---

archive/issue_events_054016.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-07-22T17:37:30Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-54016"
}
```



---

archive/issue_comments_028482.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nI didn't notice that `self.coerce_map_from(S)` also has a special case when `S is self`. However, the result is again not cached.\n\n```python\n        if S is self:\n            from sage.categories.homset import Hom\n            return Hom(self, self).identity()\n```",
    "created_at": "2013-07-22T18:06:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4740#issuecomment-28482",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:20" align="right">comment:20</div>

I didn't notice that `self.coerce_map_from(S)` also has a special case when `S is self`. However, the result is again not cached.

```python
        if S is self:
            from sage.categories.homset import Hom
            return Hom(self, self).identity()
```



---

archive/issue_comments_028483.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nReplying to [@simon-king-jena](#comment:19):\n> 2. let `F.coerce(x)` avoid creating a morphism, if the parent of x is F.\n\nHm. On second thought, do we really want that `F.coerce(x) is x`? I guess it is better to preserve the current behaviour and return a copy of x.",
    "created_at": "2013-07-22T18:11:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4740#issuecomment-28483",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:21" align="right">comment:21</div>

Replying to [@simon-king-jena](#comment:19):
> 2. let `F.coerce(x)` avoid creating a morphism, if the parent of x is F.

Hm. On second thought, do we really want that `F.coerce(x) is x`? I guess it is better to preserve the current behaviour and return a copy of x.



---

archive/issue_comments_028484.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -25,3 +25,7 @@\n Cheers,\n \n Michael\n+\n+__Apply__\n+\n+- [attachment: trac4740-cache_coerce_from_self.patch\u200b](https://github.com/sagemath/sage/files/ticket4740/572d72e1891f521bd1f386f06f12be65.gz)\n``````\n",
    "created_at": "2013-07-22T18:25:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4740#issuecomment-28484",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -25,3 +25,7 @@
 Cheers,
 
 Michael
+
+__Apply__
+
+- [attachment: trac4740-cache_coerce_from_self.patch​](https://github.com/sagemath/sage/files/ticket4740/572d72e1891f521bd1f386f06f12be65.gz)
``````




---

archive/issue_comments_028485.json:
```json
{
    "body": "Changed author from **Mike Hansen** to **Simon King**",
    "created_at": "2013-07-22T18:25:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4740#issuecomment-28485",
    "user": "https://github.com/simon-king-jena"
}
```

Changed author from **Mike Hansen** to **Simon King**



---

archive/issue_events_054017.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-07-22T18:25:29Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-54017"
}
```



---

archive/issue_events_054018.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-07-22T18:25:29Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-54018"
}
```



---

archive/issue_comments_028486.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nWhat do people think about the patch that I just attached?\n\nWe now have\n\n```\nsage: F = GF(13)\nsage: F.coerce_map_from(F) is F.coerce_map_from(F)\nTrue\nsage: x = F(234234)\nsage: %timeit t = F.coerce(x)\n1000000 loops, best of 3: 862 ns per loop\n```\nand used to have\n\n```\nsage: F = GF(13)\nsage: F.coerce_map_from(F) is F.coerce_map_from(F)\nFalse\nsage: x = F(234234)\nsage: %timeit t = F.coerce(x)\n10000 loops, best of 3: 132 us per loop\n```\n\nApply trac4740-cache_coerce_from_self.patch\u200b",
    "created_at": "2013-07-22T18:25:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4740#issuecomment-28486",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:22" align="right">comment:22</div>

What do people think about the patch that I just attached?

We now have

```
sage: F = GF(13)
sage: F.coerce_map_from(F) is F.coerce_map_from(F)
True
sage: x = F(234234)
sage: %timeit t = F.coerce(x)
1000000 loops, best of 3: 862 ns per loop
```
and used to have

```
sage: F = GF(13)
sage: F.coerce_map_from(F) is F.coerce_map_from(F)
False
sage: x = F(234234)
sage: %timeit t = F.coerce(x)
10000 loops, best of 3: 132 us per loop
```

Apply trac4740-cache_coerce_from_self.patch​



---

archive/issue_comments_028487.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nPS: The memleak in the ticket description has already been fixed elsewhere, this is now only about efficiency.",
    "created_at": "2013-07-22T18:27:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4740#issuecomment-28487",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:23" align="right">comment:23</div>

PS: The memleak in the ticket description has already been fixed elsewhere, this is now only about efficiency.



---

archive/issue_comments_028488.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -28,4 +28,4 @@\n \n __Apply__\n \n-- [attachment: trac4740-cache_coerce_from_self.patch\u200b](https://github.com/sagemath/sage/files/ticket4740/572d72e1891f521bd1f386f06f12be65.gz)\n+[attachment: trac4740-cache_coerce_from_self.patch\u200b](https://github.com/sagemath/sage/files/ticket4740/572d72e1891f521bd1f386f06f12be65.gz)\n``````\n",
    "created_at": "2013-07-22T19:11:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4740#issuecomment-28488",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -28,4 +28,4 @@
 
 __Apply__
 
-- [attachment: trac4740-cache_coerce_from_self.patch​](https://github.com/sagemath/sage/files/ticket4740/572d72e1891f521bd1f386f06f12be65.gz)
+[attachment: trac4740-cache_coerce_from_self.patch​](https://github.com/sagemath/sage/files/ticket4740/572d72e1891f521bd1f386f06f12be65.gz)
``````




---

archive/issue_comments_028489.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nIt seems that the patchbot tries to apply both patches. Trying to get it right:\n\nApply trac4740-cache_coerce_from_self.patch\u200b",
    "created_at": "2013-07-22T19:11:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4740#issuecomment-28489",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:24" align="right">comment:24</div>

It seems that the patchbot tries to apply both patches. Trying to get it right:

Apply trac4740-cache_coerce_from_self.patch​



---

archive/issue_comments_028490.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nFor the record: All tests pass, and I really don't see why the patchbot is trying to apply *two* patches.",
    "created_at": "2013-07-22T20:07:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4740#issuecomment-28490",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:25" align="right">comment:25</div>

For the record: All tests pass, and I really don't see why the patchbot is trying to apply *two* patches.



---

archive/issue_comments_028491.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nYour changes look good to me.  I knew the patch I posted was probably dodgy, but you'd be the one who'd have the best grasp on it.\n\nThanks!",
    "created_at": "2013-07-23T00:16:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4740#issuecomment-28491",
    "user": "https://github.com/mwhansen"
}
```

<div id="comment:26" align="right">comment:26</div>

Your changes look good to me.  I knew the patch I posted was probably dodgy, but you'd be the one who'd have the best grasp on it.

Thanks!



---

archive/issue_events_054019.json:
```json
{
    "actor": "https://github.com/mwhansen",
    "created_at": "2013-07-23T00:16:38Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-54019"
}
```



---

archive/issue_events_054020.json:
```json
{
    "actor": "https://github.com/mwhansen",
    "created_at": "2013-07-23T00:16:38Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-54020"
}
```



---

archive/issue_comments_028492.json:
```json
{
    "body": "Reviewer: **Mike Hansen**",
    "created_at": "2013-07-23T00:16:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4740#issuecomment-28492",
    "user": "https://github.com/mwhansen"
}
```

Reviewer: **Mike Hansen**



---

archive/issue_events_054021.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-07-24T06:26:16Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "milestone_number": null,
    "milestone_title": "sage-5.11",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-54021"
}
```



---

archive/issue_events_054022.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-07-24T06:26:16Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "milestone_number": null,
    "milestone_title": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-54022"
}
```



---

archive/issue_events_054023.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-16T21:37:56Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-54023"
}
```



---

archive/issue_events_054024.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-16T21:37:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-54024"
}
```



---

archive/issue_comments_028493.json:
```json
{
    "body": "Dependencies: **#14519**",
    "created_at": "2013-08-16T21:37:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4740#issuecomment-28493",
    "user": "https://github.com/jdemeyer"
}
```

Dependencies: **#14519**



---

archive/issue_comments_028494.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nThis needs to be rebased to sage-5.12.beta0 + #14516 + #14519.",
    "created_at": "2013-08-16T21:37:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4740#issuecomment-28494",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:28" align="right">comment:28</div>

This needs to be rebased to sage-5.12.beta0 + #14516 + #14519.



---

archive/issue_comments_028495.json:
```json
{
    "body": "Attachment: **[trac4740-cache_coerce_from_self.patch.gz](https://github.com/sagemath/sage/files/ticket4740/trac4740-cache_coerce_from_self.patch.gz)**\n\nCache coercion from self to self",
    "created_at": "2013-08-17T07:51:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4740#issuecomment-28495",
    "user": "https://github.com/simon-king-jena"
}
```

Attachment: **[trac4740-cache_coerce_from_self.patch.gz](https://github.com/sagemath/sage/files/ticket4740/trac4740-cache_coerce_from_self.patch.gz)**

Cache coercion from self to self



---

archive/issue_comments_028496.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nDone! The only change concerns the new syntax for debug options. I guess I may revert to \"positive review\".\n\nApply trac4740-cache_coerce_from_self.patch\u200b",
    "created_at": "2013-08-17T07:53:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4740#issuecomment-28496",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:29" align="right">comment:29</div>

Done! The only change concerns the new syntax for debug options. I guess I may revert to "positive review".

Apply trac4740-cache_coerce_from_self.patch​



---

archive/issue_events_054025.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-08-17T07:53:02Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-54025"
}
```



---

archive/issue_events_054026.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-08-17T07:53:02Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-54026"
}
```



---

archive/issue_comments_028497.json:
```json
{
    "body": "Merged: **sage-5.12.beta3**",
    "created_at": "2013-08-20T12:56:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4740#issuecomment-28497",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-5.12.beta3**



---

archive/issue_events_054027.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-20T12:56:42Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-54027"
}
```



---

archive/issue_events_054028.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-20T12:56:42Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/4740",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4740#event-54028"
}
```
