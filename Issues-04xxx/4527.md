# Issue 4527: [with positive review] Exception in 'sage.matrix.matrix_integer_dense.Matrix_integer_dense._hnf_modn_impl'

archive/issues_004527.json:
```json
{
    "body": "Hi, \n\nthe following code raises an exception that crashes sage on my computer:\n\n```\ncond=206\nJ=J0(206)\nD=J.new_subvariety().decomposition()\nJp=J.old_subvariety(2)\nJpc=Jp.cuspidal_subgroup()\nAc=D[3].cuspidal_subgroup()\nAc.intersection(Jpc)\n```\n\nThe error I get (running it through the notebook) is\n\n```\nException  in\n'sage.matrix.matrix_integer_dense.Matrix_integer_dense._hnf_modn_impl'\nignored\n\n\n------------------------------------------------------------\nUnhandled SIGSEGV: A segmentation fault occured in SAGE.\nThis probably occured because a *compiled* component\nof SAGE has a bug in it (typically accessing invalid memory)\nor is not properly wrapped with _sig_on, _sig_off.\nYou might want to run SAGE under gdb with 'sage -gdb' to debug this.\nSAGE will now terminate (sorry).\n------------------------------------------------------------\n\n```\n\nThis seems very sensitive to the set of inputs, but it is consistent on my computer.\nI'm running sage 3.1.4 (release date 2008-10-20), on mandriva, compiled with gcc 4.2.2 20071128.\n\nSoroosh\n\n**Assignee:** @craigcitro\n\n**Keywords:** segfault\n\n**Resolution:** fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/4527\n\n",
    "closed_at": "2008-11-15T09:52:46Z",
    "created_at": "2008-11-14T20:13:29Z",
    "labels": [
        "component: modular forms",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-3.2",
    "title": "[with positive review] Exception in 'sage.matrix.matrix_integer_dense.Matrix_integer_dense._hnf_modn_impl'",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/4527",
    "user": "https://github.com/syazdani77"
}
```
Hi, 

the following code raises an exception that crashes sage on my computer:

```
cond=206
J=J0(206)
D=J.new_subvariety().decomposition()
Jp=J.old_subvariety(2)
Jpc=Jp.cuspidal_subgroup()
Ac=D[3].cuspidal_subgroup()
Ac.intersection(Jpc)
```

The error I get (running it through the notebook) is

```
Exception  in
'sage.matrix.matrix_integer_dense.Matrix_integer_dense._hnf_modn_impl'
ignored


------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occured in SAGE.
This probably occured because a *compiled* component
of SAGE has a bug in it (typically accessing invalid memory)
or is not properly wrapped with _sig_on, _sig_off.
You might want to run SAGE under gdb with 'sage -gdb' to debug this.
SAGE will now terminate (sorry).
------------------------------------------------------------

```

This seems very sensitive to the set of inputs, but it is consistent on my computer.
I'm running sage 3.1.4 (release date 2008-10-20), on mandriva, compiled with gcc 4.2.2 20071128.

Soroosh

**Assignee:** @craigcitro

**Keywords:** segfault

**Resolution:** fixed

Issue created by migration from https://trac.sagemath.org/ticket/4527





---

archive/issue_events_013422.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2008-11-14T20:22:20Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/4527",
    "milestone": "sage-3.2.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4527#event-13422"
}
```



---

archive/issue_comments_039492.json:
```json
{
    "body": "**Changing keywords** from \"\" to \"segfault\".",
    "created_at": "2008-11-14T20:22:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4527",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4527#issuecomment-39492",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

**Changing keywords** from "" to "segfault".



---

archive/issue_comments_039493.json:
```json
{
    "body": "<a id='comment:1'></a>\nI can reproduce this with the latest and greatest Sage. Gdb says:\n\n```\n----------------------------------------------------------------------\n----------------------------------------------------------------------\n/scratch/mabshoff/release-cycle/sage-3.2.rc1/local/bin/sage-ipython\nGNU gdb 6.4.90-debian\nCopyright (C) 2006 Free Software Foundation, Inc.\nGDB is free software, covered by the GNU General Public License, and you are\nwelcome to change it and/or distribute copies of it under certain conditions.\nType \"show copying\" to see the conditions.\nThere is absolutely no warranty for GDB.  Type \"show warranty\" for details.\nThis GDB was configured as \"x86_64-linux-gnu\"...Using host libthread_db library \"/lib/libthread_db.so.1\".\n| Sage Version 3.2.rc0, Release Date: 2008-11-10                     |\n| Type notebook() for the GUI, and license() for information.        |\n\n[Thread debugging using libthread_db enabled]\n[New Thread 47755945320288 (LWP 13573)]\nPython 2.5.2 (r252:60911, Nov 10 2008, 22:40:35) \n[GCC 4.1.2 20061115 (prerelease) (Debian 4.1.1-21)] on linux2\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n\nsage: cond=206\nsage: J=J0(206)\nsage: D=J.new_subvariety().decomposition()\nsage: Jp=J.old_subvariety(2)\nsage: Jpc=Jp.cuspidal_subgroup()\nsage: Ac=D[3].cuspidal_subgroup()\nsage: Ac.intersection(Jpc)\nException  in 'sage.matrix.matrix_integer_dense.Matrix_integer_dense._hnf_modn_impl' ignored\n\nProgram received signal SIGSEGV, Segmentation fault.\n[Switching to Thread 47755945320288 (LWP 13573)]\n0x00002b6f1c26f88d in __pyx_f_4sage_6matrix_20matrix_integer_dense_20Matrix_integer_dense__hnf_modn (\n    __pyx_v_self=0x2b6f2485a560, __pyx_v_res=0x2b6f2485a830, __pyx_v_det=<value optimized out>)\n    at sage/matrix/matrix_integer_dense.c:26964\n26964\t      mpz_init_set_si(((__pyx_v_res->_matrix[__pyx_v_i])[__pyx_v_j]), (__pyx_v_res_l[__pyx_v_k]));\n(gdb) bt\n#0  0x00002b6f1c26f88d in __pyx_f_4sage_6matrix_20matrix_integer_dense_20Matrix_integer_dense__hnf_modn (\n    __pyx_v_self=0x2b6f2485a560, __pyx_v_res=0x2b6f2485a830, __pyx_v_det=<value optimized out>)\n    at sage/matrix/matrix_integer_dense.c:26964\n#1  0x00002b6f1c2ac2e7 in __pyx_pf_4sage_6matrix_20matrix_integer_dense_20Matrix_integer_dense__hnf_mod (\n    __pyx_v_self=0x2b6f2485a560, __pyx_v_D=0x7451450) at sage/matrix/matrix_integer_dense.c:26853\n#2  0x0000000000484afc in PyEval_EvalFrameEx (f=0xd7283d0, throwflag=<value optimized out>) at Python/ceval.c:3561\n#3  0x0000000000486182 in PyEval_EvalCodeEx (co=0x2b6f0cf973f0, globals=<value optimized out>, \n    locals=<value optimized out>, args=0x2b6f11211d80, argcount=1, kws=0xd770a78, kwcount=1, defs=0x0, defcount=0, \n    closure=0x0) at Python/ceval.c:2836\n#4  0x0000000000484347 in PyEval_EvalFrameEx (f=0xd770810, throwflag=<value optimized out>) at Python/ceval.c:3669\n#5  0x0000000000486182 in PyEval_EvalCodeEx (co=0x2b6f0c8afe40, globals=<value optimized out>, \n    locals=<value optimized out>, args=0x2b6f11211d80, argcount=1, kws=0xd6fd708, kwcount=2, defs=0x0, defcount=0, \n    closure=0x0) at Python/ceval.c:2836\n<SNIP>\n```\n\nI am running the computation under valgrind now if it catches anything.\n\nCheers,\n\nMichael",
    "created_at": "2008-11-14T20:22:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4527",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4527#issuecomment-39493",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:1'></a>
I can reproduce this with the latest and greatest Sage. Gdb says:

```
----------------------------------------------------------------------
----------------------------------------------------------------------
/scratch/mabshoff/release-cycle/sage-3.2.rc1/local/bin/sage-ipython
GNU gdb 6.4.90-debian
Copyright (C) 2006 Free Software Foundation, Inc.
GDB is free software, covered by the GNU General Public License, and you are
welcome to change it and/or distribute copies of it under certain conditions.
Type "show copying" to see the conditions.
There is absolutely no warranty for GDB.  Type "show warranty" for details.
This GDB was configured as "x86_64-linux-gnu"...Using host libthread_db library "/lib/libthread_db.so.1".
| Sage Version 3.2.rc0, Release Date: 2008-11-10                     |
| Type notebook() for the GUI, and license() for information.        |

[Thread debugging using libthread_db enabled]
[New Thread 47755945320288 (LWP 13573)]
Python 2.5.2 (r252:60911, Nov 10 2008, 22:40:35) 
[GCC 4.1.2 20061115 (prerelease) (Debian 4.1.1-21)] on linux2
Type "help", "copyright", "credits" or "license" for more information.

sage: cond=206
sage: J=J0(206)
sage: D=J.new_subvariety().decomposition()
sage: Jp=J.old_subvariety(2)
sage: Jpc=Jp.cuspidal_subgroup()
sage: Ac=D[3].cuspidal_subgroup()
sage: Ac.intersection(Jpc)
Exception  in 'sage.matrix.matrix_integer_dense.Matrix_integer_dense._hnf_modn_impl' ignored

Program received signal SIGSEGV, Segmentation fault.
[Switching to Thread 47755945320288 (LWP 13573)]
0x00002b6f1c26f88d in __pyx_f_4sage_6matrix_20matrix_integer_dense_20Matrix_integer_dense__hnf_modn (
    __pyx_v_self=0x2b6f2485a560, __pyx_v_res=0x2b6f2485a830, __pyx_v_det=<value optimized out>)
    at sage/matrix/matrix_integer_dense.c:26964
26964	      mpz_init_set_si(((__pyx_v_res->_matrix[__pyx_v_i])[__pyx_v_j]), (__pyx_v_res_l[__pyx_v_k]));
(gdb) bt
#0  0x00002b6f1c26f88d in __pyx_f_4sage_6matrix_20matrix_integer_dense_20Matrix_integer_dense__hnf_modn (
    __pyx_v_self=0x2b6f2485a560, __pyx_v_res=0x2b6f2485a830, __pyx_v_det=<value optimized out>)
    at sage/matrix/matrix_integer_dense.c:26964
#1  0x00002b6f1c2ac2e7 in __pyx_pf_4sage_6matrix_20matrix_integer_dense_20Matrix_integer_dense__hnf_mod (
    __pyx_v_self=0x2b6f2485a560, __pyx_v_D=0x7451450) at sage/matrix/matrix_integer_dense.c:26853
#2  0x0000000000484afc in PyEval_EvalFrameEx (f=0xd7283d0, throwflag=<value optimized out>) at Python/ceval.c:3561
#3  0x0000000000486182 in PyEval_EvalCodeEx (co=0x2b6f0cf973f0, globals=<value optimized out>, 
    locals=<value optimized out>, args=0x2b6f11211d80, argcount=1, kws=0xd770a78, kwcount=1, defs=0x0, defcount=0, 
    closure=0x0) at Python/ceval.c:2836
#4  0x0000000000484347 in PyEval_EvalFrameEx (f=0xd770810, throwflag=<value optimized out>) at Python/ceval.c:3669
#5  0x0000000000486182 in PyEval_EvalCodeEx (co=0x2b6f0c8afe40, globals=<value optimized out>, 
    locals=<value optimized out>, args=0x2b6f11211d80, argcount=1, kws=0xd6fd708, kwcount=2, defs=0x0, defcount=0, 
    closure=0x0) at Python/ceval.c:2836
<SNIP>
```

I am running the computation under valgrind now if it catches anything.

Cheers,

Michael



---

archive/issue_comments_039494.json:
```json
{
    "body": "**Changing assignee** from tbd to @craigcitro.",
    "created_at": "2008-11-14T20:22:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4527",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4527#issuecomment-39494",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

**Changing assignee** from tbd to @craigcitro.



---

archive/issue_comments_039495.json:
```json
{
    "body": "this should fix it.  the main bug was an off by a factor of two overflow.",
    "created_at": "2008-11-15T01:32:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4527",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4527#issuecomment-39495",
    "user": "https://github.com/williamstein"
}
```

this should fix it.  the main bug was an off by a factor of two overflow.



---

archive/issue_comments_039496.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2008-11-15T01:32:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4527",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4527#issuecomment-39496",
    "user": "https://github.com/williamstein"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_039497.json:
```json
{
    "body": "<a id='comment:2'></a>\nAttachment [sage-4527.patch](tarball://root/attachments/some-uuid/ticket4527/sage-4527.patch) by @williamstein created at 2008-11-15 01:32:26",
    "created_at": "2008-11-15T01:32:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4527",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4527#issuecomment-39497",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:2'></a>
Attachment [sage-4527.patch](tarball://root/attachments/some-uuid/ticket4527/sage-4527.patch) by @williamstein created at 2008-11-15 01:32:26



---

archive/issue_events_013423.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2008-11-15T07:22:44Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/4527",
    "milestone": "sage-3.2.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4527#event-13423"
}
```



---

archive/issue_events_013424.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2008-11-15T07:22:44Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/4527",
    "milestone": "sage-3.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4527#event-13424"
}
```



---

archive/issue_comments_039498.json:
```json
{
    "body": "<a id='comment:3'></a>\nWith the patch applied:\n\n```\nmabshoff@sage:/scratch/mabshoff/release-cycle/sage-3.2.rc1$ ./sage\n----------------------------------------------------------------------\n----------------------------------------------------------------------\n| Sage Version 3.2.rc0, Release Date: 2008-11-10                     |\n| Type notebook() for the GUI, and license() for information.        |\n\nsage: cond=206\nsage: J=J0(206)\nsage: D=J.new_subvariety().decomposition()\nsage: Jp=J.old_subvariety(2)\nsage: Jpc=Jp.cuspidal_subgroup()\nsage: Ac=D[3].cuspidal_subgroup()\nsage: Ac.intersection(Jpc)\nFinite subgroup with invariants [] over QQ of Simple abelian subvariety 206d(1,206) of dimension 4 of J0(206)\n```\nI am currently running doctests.\n\nCheers,\n\nMichael",
    "created_at": "2008-11-15T07:22:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4527",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4527#issuecomment-39498",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:3'></a>
With the patch applied:

```
mabshoff@sage:/scratch/mabshoff/release-cycle/sage-3.2.rc1$ ./sage
----------------------------------------------------------------------
----------------------------------------------------------------------
| Sage Version 3.2.rc0, Release Date: 2008-11-10                     |
| Type notebook() for the GUI, and license() for information.        |

sage: cond=206
sage: J=J0(206)
sage: D=J.new_subvariety().decomposition()
sage: Jp=J.old_subvariety(2)
sage: Jpc=Jp.cuspidal_subgroup()
sage: Ac=D[3].cuspidal_subgroup()
sage: Ac.intersection(Jpc)
Finite subgroup with invariants [] over QQ of Simple abelian subvariety 206d(1,206) of dimension 4 of J0(206)
```
I am currently running doctests.

Cheers,

Michael



---

archive/issue_comments_039499.json:
```json
{
    "body": "<a id='comment:4'></a>\nWith the patch applied doctests with \"-long\" pass. Note that the example posted that exposes the problem takes about 30 seconds CPU time, so we should add it as a \"#long time\" example unless someone comes up with a shorter one.\n\nCheers,\n\nMichael",
    "created_at": "2008-11-15T07:47:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4527",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4527#issuecomment-39499",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:4'></a>
With the patch applied doctests with "-long" pass. Note that the example posted that exposes the problem takes about 30 seconds CPU time, so we should add it as a "#long time" example unless someone comes up with a shorter one.

Cheers,

Michael



---

archive/issue_comments_039500.json:
```json
{
    "body": "<a id='comment:5'></a>\nAttachment [trac-4527-doc.patch](tarball://root/attachments/some-uuid/ticket4527/trac-4527-doc.patch) by @craigcitro created at 2008-11-15 09:02:01\n\nLooks good. I added a doctest based on Soroosh's original example in the extra patch above.",
    "created_at": "2008-11-15T09:02:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4527",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4527#issuecomment-39500",
    "user": "https://github.com/craigcitro"
}
```

<a id='comment:5'></a>
Attachment [trac-4527-doc.patch](tarball://root/attachments/some-uuid/ticket4527/trac-4527-doc.patch) by @craigcitro created at 2008-11-15 09:02:01

Looks good. I added a doctest based on Soroosh's original example in the extra patch above.



---

archive/issue_events_013425.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/4527",
    "rename": {
        "from": "Exception in 'sage.matrix.matrix_integer_dense.Matrix_integer_dense._hnf_modn_impl'",
        "to": "[with positive review] Exception in 'sage.matrix.matrix_integer_dense.Matrix_integer_dense._hnf_modn_impl'"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4527#event-13425"
}
```



---

archive/issue_events_013426.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2008-11-15T09:52:46Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/4527",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4527#event-13426"
}
```



---

archive/issue_comments_039501.json:
```json
{
    "body": "<a id='comment:6'></a>\nMerged in Sage 3.2.rc1",
    "created_at": "2008-11-15T09:52:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4527",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4527#issuecomment-39501",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:6'></a>
Merged in Sage 3.2.rc1



---

archive/issue_comments_039502.json:
```json
{
    "body": "**Resolution:** fixed",
    "created_at": "2008-11-15T09:52:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4527",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4527#issuecomment-39502",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

**Resolution:** fixed



---

archive/issue_comments_039503.json:
```json
{
    "body": "**Upstream:** N/A",
    "created_at": "2015-09-06T15:58:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4527",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4527#issuecomment-39503",
    "user": "https://github.com/fchapoton"
}
```

**Upstream:** N/A



---

archive/issue_comments_039504.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -15,8 +15,6 @@\n The error I get (running it through the notebook) is\n \n ```\n-          \t\n-\n Exception  in\n 'sage.matrix.matrix_integer_dense.Matrix_integer_dense._hnf_modn_impl'\n ignored\n``````\n",
    "created_at": "2015-09-06T15:58:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4527",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4527#issuecomment-39504",
    "user": "https://github.com/fchapoton"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -15,8 +15,6 @@
 The error I get (running it through the notebook) is
 
 ```
-          	
-
 Exception  in
 'sage.matrix.matrix_integer_dense.Matrix_integer_dense._hnf_modn_impl'
 ignored
``````

