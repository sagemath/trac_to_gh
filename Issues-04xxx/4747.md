# Issue 4747: add custom hash function for cusps.

archive/issues_004747.json:
```json
{
    "body": "This speeds up hash(c) for c a cusp by a lot.\n\n**Assignee:** @williamstein\n\nIssue created by migration from https://trac.sagemath.org/ticket/4747\n\n",
    "closed_at": "2008-12-14T20:07:57Z",
    "created_at": "2008-12-09T21:59:30Z",
    "labels": [
        "component: number theory",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-3.2.2",
    "title": "add custom hash function for cusps.",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/4747",
    "user": "https://github.com/williamstein"
}
```
This speeds up hash(c) for c a cusp by a lot.

**Assignee:** @williamstein

Issue created by migration from https://trac.sagemath.org/ticket/4747





---

archive/attachments_005298.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_4747.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket4747/trac_4747.patch",
    "created_at": "2008-12-09T22:00:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4747",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/williamstein"
}
```



---

archive/issue_comments_037972.json:
```json
{
    "body": "",
    "created_at": "2008-12-09T22:00:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4747#issuecomment-37972",
    "user": "https://github.com/williamstein"
}
```





---

archive/issue_events_013755.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/4747",
    "rename": {
        "from": "add custom hash function for cusps.",
        "to": "[with review] add custom hash function for cusps."
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4747#event-13755"
}
```



---

archive/issue_comments_037973.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2008-12-09T22:21:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4747#issuecomment-37973",
    "user": "https://github.com/JohnCremona"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_037974.json:
```json
{
    "body": "<a id='comment:1'></a>\nPatch applies fine and test ok on 32-bit but on 64-bit I get this:\n\n```\nsage -t  \"sage-3.2.1.rc0/devel/sage-hash/sage/modular/cusps.py\"**********************************************************************\nFile \"/home/jec/sage-3.2.1.rc0/devel/sage-hash/sage/modular/cusps.py\", line 319:\n    sage: hash(Cusp(1/3))\nExpected:\n    3713081631933328131    \nGot:\n    163512108431620420\n**********************************************************************\nFile \"/home/jec/sage-3.2.1.rc0/devel/sage-hash/sage/modular/cusps.py\", line 322:\n    sage: hash(Cusp(oo))\nExpected:\n    3713081631936575706    \nGot:\n    6982220252595711780\n**********************************************************************\n```\n\nI am amazed at the effect this has on the speed.  Hashing is not something I ever think about, but clearly I should!",
    "created_at": "2008-12-09T22:21:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4747#issuecomment-37974",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:1'></a>
Patch applies fine and test ok on 32-bit but on 64-bit I get this:

```
sage -t  "sage-3.2.1.rc0/devel/sage-hash/sage/modular/cusps.py"**********************************************************************
File "/home/jec/sage-3.2.1.rc0/devel/sage-hash/sage/modular/cusps.py", line 319:
    sage: hash(Cusp(1/3))
Expected:
    3713081631933328131    
Got:
    163512108431620420
**********************************************************************
File "/home/jec/sage-3.2.1.rc0/devel/sage-hash/sage/modular/cusps.py", line 322:
    sage: hash(Cusp(oo))
Expected:
    3713081631936575706    
Got:
    6982220252595711780
**********************************************************************
```

I am amazed at the effect this has on the speed.  Hashing is not something I ever think about, but clearly I should!



---

archive/issue_comments_037975.json:
```json
{
    "body": "<a id='comment:2'></a>\nJohn -- is there any chance you forgot to do a `sage -b` before testing this patch? I'm only suspicious because the incorrect values getting returned are exactly the values that `hash(Cusp(1/3))` and `hash(Cusp(oo))` returned **before** the patch ...",
    "created_at": "2008-12-14T08:05:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4747#issuecomment-37975",
    "user": "https://github.com/craigcitro"
}
```

<a id='comment:2'></a>
John -- is there any chance you forgot to do a `sage -b` before testing this patch? I'm only suspicious because the incorrect values getting returned are exactly the values that `hash(Cusp(1/3))` and `hash(Cusp(oo))` returned **before** the patch ...



---

archive/issue_comments_037976.json:
```json
{
    "body": "<a id='comment:3'></a>\nReplying to [craigcitro](#comment%3A2):\n> John -- is there any chance you forgot to do a `sage -b` before testing this patch? I'm only suspicious because the incorrect values getting returned are exactly the values that `hash(Cusp(1/3))` and `hash(Cusp(oo))` returned **before** the patch ...\n\n\nMay be.  I'll try again.",
    "created_at": "2008-12-14T11:02:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4747#issuecomment-37976",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:3'></a>
Replying to [craigcitro](#comment%3A2):
> John -- is there any chance you forgot to do a `sage -b` before testing this patch? I'm only suspicious because the incorrect values getting returned are exactly the values that `hash(Cusp(1/3))` and `hash(Cusp(oo))` returned **before** the patch ...


May be.  I'll try again.



---

archive/issue_comments_037977.json:
```json
{
    "body": "<a id='comment:4'></a>\nWilliam was right.  Sorry!",
    "created_at": "2008-12-14T14:39:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4747#issuecomment-37977",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:4'></a>
William was right.  Sorry!



---

archive/issue_events_013756.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/4747",
    "rename": {
        "from": "[with review] add custom hash function for cusps.",
        "to": "add custom hash function for cusps."
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4747#event-13756"
}
```



---

archive/issue_comments_037978.json:
```json
{
    "body": "**Changing status** from needs_work to positive_review.",
    "created_at": "2008-12-14T14:39:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4747#issuecomment-37978",
    "user": "https://github.com/JohnCremona"
}
```

**Changing status** from needs_work to positive_review.



---

archive/issue_events_013757.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2008-12-14T17:39:43Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/4747",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4747#event-13757"
}
```



---

archive/issue_comments_037979.json:
```json
{
    "body": "<a id='comment:5'></a>\nMerged in Sage 3.2.2.rc0",
    "created_at": "2008-12-14T17:39:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4747#issuecomment-37979",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:5'></a>
Merged in Sage 3.2.2.rc0



---

archive/issue_comments_037980.json:
```json
{
    "body": "<a id='comment:6'></a>\nThis patch causes the following doctest failures:\n\n```\nsage -t -long \"devel/sage/sage/modular/congroup.py\"\n**********************************************************************\nFile \"/scratch/mabshoff/release-cycle/sage-3.2.2.rc0/devel/sage/sage/modular/congroup.py\", line 540, in __main__.example_25\nFailed example:\n    Gamma0(Integer(36)).cusps()###line 514:_sage_    >>> Gamma0(36).cusps()\nExpected:\n    {1/6, 1/4, 1/3, 1/2, 1/9, 0, 1/18, 5/12, Infinity, 1/12, 2/3, 5/6}\nGot:\n    {1/2, 0, 1/3, 1/12, 5/6, 5/12, 1/4, 1/18, 1/6, 1/9, 2/3, Infinity}\n**********************************************************************\nFile \"/scratch/mabshoff/release-cycle/sage-3.2.2.rc0/devel/sage/sage/modular/congroup.py\", line 1064, in __main__.example_48\nFailed example:\n    Gamma1(Integer(5))._find_cusps()###line 1283:_sage_    >>> Gamma1(5)._find_cusps()Expected:\n    {0, Infinity, 1/2, 2/5}\nGot:    {0, 1/2, Infinity, 2/5}\n**********************************************************************\nFile \"/scratch/mabshoff/release-cycle/sage-3.2.2.rc0/devel/sage/sage/modular/congroup.py\", line 1066, in __main__.example_48\nFailed example:\n    Gamma1(Integer(35))._find_cusps()###line 1285:_sage_    >>> Gamma1(35)._find_cusps()\nExpected:\n    {3/35, 9/10, 9/14, 11/35, 3/14, 9/35, 3/10, 11/14, 8/35, 4/7, 8/15, Infinity, 13/14, 16/35, 13/35, 0, 4/15, 1/13, 2/35, 1/11, 1/10, 1/17, 1/1\n6, 1/15, 1/14, 1/7, 1/6, 1/5, 1/4, 1/3, 1/2, 6/35, 1/9, 1/8, 6/7, 3/5, 3/7, 7/10, 4/35, 2/5, 17/35, 2/7, 5/7, 1/12, 4/5, 5/14, 12/35, 2/15}\nGot:\n    {4/7, 1/3, 3/35, 16/35, 1/17, 1/15, 6/35, 1/6, 11/14, 3/7, 2/5, 1/11, 4/35, 3/14, 1/2, 6/7, 3/10, 1/14, 1/5, 2/35, 7/10, 5/7, 1/10, 8/15, 0, \n9/14, 13/35, 4/5, 1/13, 1/4, 11/35, 9/10, 1/9, 8/35, Infinity, 12/35, 3/5, 2/7, 1/12, 13/14, 4/15, 9/35, 5/14, 1/8, 17/35, 1/7, 2/15, 1/16}\n**********************************************************************\nFile \"/scratch/mabshoff/release-cycle/sage-3.2.2.rc0/devel/sage/sage/modular/congroup.py\", line 1397, in __main__.example_65\nFailed example:\n    Gamma0(Integer(90))._find_cusps()###line 1681:_sage_    >>> Gamma0(90)._find_cusps()\nExpected:\n    {1/6, 1/5, 1/3, 1/2, 11/30, 1/9, 2/3, 1/30, Infinity, 5/6, 1/45, 0, 1/18, 1/10, 1/15, 2/15}\nGot:\n    {0, 1/3, 11/30, 5/6, 1/15, 1/10, 2/3, 1/9, Infinity, 1/2, 1/45, 1/18, 1/5, 2/15, 1/6, 1/30}\n**********************************************************************\n```\n\nThoughts? \n\nCheers,\n\nMichael",
    "created_at": "2008-12-14T18:14:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4747#issuecomment-37980",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:6'></a>
This patch causes the following doctest failures:

```
sage -t -long "devel/sage/sage/modular/congroup.py"
**********************************************************************
File "/scratch/mabshoff/release-cycle/sage-3.2.2.rc0/devel/sage/sage/modular/congroup.py", line 540, in __main__.example_25
Failed example:
    Gamma0(Integer(36)).cusps()###line 514:_sage_    >>> Gamma0(36).cusps()
Expected:
    {1/6, 1/4, 1/3, 1/2, 1/9, 0, 1/18, 5/12, Infinity, 1/12, 2/3, 5/6}
Got:
    {1/2, 0, 1/3, 1/12, 5/6, 5/12, 1/4, 1/18, 1/6, 1/9, 2/3, Infinity}
**********************************************************************
File "/scratch/mabshoff/release-cycle/sage-3.2.2.rc0/devel/sage/sage/modular/congroup.py", line 1064, in __main__.example_48
Failed example:
    Gamma1(Integer(5))._find_cusps()###line 1283:_sage_    >>> Gamma1(5)._find_cusps()Expected:
    {0, Infinity, 1/2, 2/5}
Got:    {0, 1/2, Infinity, 2/5}
**********************************************************************
File "/scratch/mabshoff/release-cycle/sage-3.2.2.rc0/devel/sage/sage/modular/congroup.py", line 1066, in __main__.example_48
Failed example:
    Gamma1(Integer(35))._find_cusps()###line 1285:_sage_    >>> Gamma1(35)._find_cusps()
Expected:
    {3/35, 9/10, 9/14, 11/35, 3/14, 9/35, 3/10, 11/14, 8/35, 4/7, 8/15, Infinity, 13/14, 16/35, 13/35, 0, 4/15, 1/13, 2/35, 1/11, 1/10, 1/17, 1/1
6, 1/15, 1/14, 1/7, 1/6, 1/5, 1/4, 1/3, 1/2, 6/35, 1/9, 1/8, 6/7, 3/5, 3/7, 7/10, 4/35, 2/5, 17/35, 2/7, 5/7, 1/12, 4/5, 5/14, 12/35, 2/15}
Got:
    {4/7, 1/3, 3/35, 16/35, 1/17, 1/15, 6/35, 1/6, 11/14, 3/7, 2/5, 1/11, 4/35, 3/14, 1/2, 6/7, 3/10, 1/14, 1/5, 2/35, 7/10, 5/7, 1/10, 8/15, 0, 
9/14, 13/35, 4/5, 1/13, 1/4, 11/35, 9/10, 1/9, 8/35, Infinity, 12/35, 3/5, 2/7, 1/12, 13/14, 4/15, 9/35, 5/14, 1/8, 17/35, 1/7, 2/15, 1/16}
**********************************************************************
File "/scratch/mabshoff/release-cycle/sage-3.2.2.rc0/devel/sage/sage/modular/congroup.py", line 1397, in __main__.example_65
Failed example:
    Gamma0(Integer(90))._find_cusps()###line 1681:_sage_    >>> Gamma0(90)._find_cusps()
Expected:
    {1/6, 1/5, 1/3, 1/2, 11/30, 1/9, 2/3, 1/30, Infinity, 5/6, 1/45, 0, 1/18, 1/10, 1/15, 2/15}
Got:
    {0, 1/3, 11/30, 5/6, 1/15, 1/10, 2/3, 1/9, Infinity, 1/2, 1/45, 1/18, 1/5, 2/15, 1/6, 1/30}
**********************************************************************
```

Thoughts? 

Cheers,

Michael



---

archive/issue_comments_037981.json:
```json
{
    "body": "<a id='comment:7'></a>\nReopened for now due to non-trivial doctest failure.\n\nCheers,\n\nMichael",
    "created_at": "2008-12-14T18:18:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4747#issuecomment-37981",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:7'></a>
Reopened for now due to non-trivial doctest failure.

Cheers,

Michael



---

archive/issue_comments_037982.json:
```json
{
    "body": "**Changing status** from closed to reopened.",
    "created_at": "2008-12-14T18:18:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4747#issuecomment-37982",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

**Changing status** from closed to reopened.



---

archive/issue_comments_037983.json:
```json
{
    "body": "**Changing status** from positive_review to needs_work.",
    "created_at": "2008-12-14T18:20:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4747#issuecomment-37983",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

**Changing status** from positive_review to needs_work.



---

archive/issue_comments_037984.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [mabshoff](#comment%3A8):\nThe change in hash function means that sets of cusps will be ordered differently.  I'll check visually that the sets have not changed;  assuming that is the case I'll just adjust the doctests to agree with the new output order.",
    "created_at": "2008-12-14T18:59:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4747#issuecomment-37984",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:9'></a>
Replying to [mabshoff](#comment%3A8):
The change in hash function means that sets of cusps will be ordered differently.  I'll check visually that the sets have not changed;  assuming that is the case I'll just adjust the doctests to agree with the new output order.



---

archive/attachments_005299.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac-4747-doctest.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket4747/trac-4747-doctest.patch",
    "created_at": "2008-12-14T19:10:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4747",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/JohnCremona"
}
```



---

archive/issue_comments_037985.json:
```json
{
    "body": "",
    "created_at": "2008-12-14T19:10:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4747#issuecomment-37985",
    "user": "https://github.com/JohnCremona"
}
```





---

archive/issue_comments_037986.json:
```json
{
    "body": "<a id='comment:10'></a>\nNew patch fixes the problem.",
    "created_at": "2008-12-14T19:10:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4747#issuecomment-37986",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:10'></a>
New patch fixes the problem.



---

archive/issue_comments_037987.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2008-12-14T19:10:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4747#issuecomment-37987",
    "user": "https://github.com/JohnCremona"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_037988.json:
```json
{
    "body": "<a id='comment:11'></a>\nLooks good.",
    "created_at": "2008-12-14T19:40:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4747#issuecomment-37988",
    "user": "https://github.com/craigcitro"
}
```

<a id='comment:11'></a>
Looks good.



---

archive/issue_comments_037989.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2008-12-14T19:40:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4747#issuecomment-37989",
    "user": "https://github.com/craigcitro"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_037990.json:
```json
{
    "body": "<a id='comment:12'></a>\nMerged in Sage 3.2.2.rc0",
    "created_at": "2008-12-14T20:07:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4747#issuecomment-37990",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:12'></a>
Merged in Sage 3.2.2.rc0



---

archive/issue_events_013758.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2008-12-14T20:07:57Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/4747",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4747#event-13758"
}
```
