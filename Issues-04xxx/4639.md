# Issue 4639: bad memory leak with exponentiation

archive/issues_004639.json:
```json
{
    "assignees": [],
    "body": "<div id=\"comment:0\"></div>\n\nI think that the following example speaks for itself. (This was on an x86, 32 bit, running Ubuntu.)\n\nAlso, I believe that these examples had no problems in sage 3.0.2.\n\n```\nbober@bober:~/math/tests$ sage\n----------------------------------------------------------------------\n| Sage Version 3.2, Release Date: 2008-11-20                         |\n| Type notebook() for the GUI, and license() for information.        |\n----------------------------------------------------------------------\n\nsage: get_memory_usage()\n114.5546875\nsage: for z in xrange(10000):\n   ...:     a = 3^i\n   ...:     \nsage: get_memory_usage()\n121.4375\nsage: for z in xrange(10000):\n    a = 3^CC.0\n   ...:     \nsage: get_memory_usage()\n128.96484375\nsage: for z in xrange(10000):\n    a = 3.0^CC.0\n   ...:     \nsage: get_memory_usage()\n187.36328125\nsage: var('t')\nt\nsage: for z in xrange(10000):\n    a = 3.0^t\n   ....:     \nsage: get_memory_usage()\n231.4609375\nsage: #But, integer^integer is OK:\nsage: for z in xrange(10000):\n    a = 3^3\n   ....:     \nsage: get_memory_usage\n<function get_memory_usage at 0x8415f0c>\nsage: get_memory_usage()\n231.58984375\nsage: for z in xrange(10000):\n    a = 3^3\n   ....:     \nsage: get_memory_usage()\n231.58984375\nsage: for z in xrange(10000):\n    a = 3.0^CC.0\n   ....:     \nsaget_memory_usage()\n290.1640625\nsage: for z in xrange(10000):\n    a = CC.0^CC.0\n   ....:     \nsage: get_memory_usage()\n290.1640625\n```\n\nCC:  @robertwb\n\nComponent: **basic arithmetic**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/4639_\n\n",
    "closed_at": "2008-12-17T14:01:23Z",
    "created_at": "2008-11-27T19:06:08Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20basic%20arithmetic",
        "https://github.com/sagemath/sage/labels/p%3A%20blocker%20/%201",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-3.2.2",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "bad memory leak with exponentiation",
    "type": "issue",
    "updated_at": "2008-12-17T14:01:23Z",
    "url": "https://github.com/sagemath/sage/issues/4639",
    "user": "https://github.com/sagetrac-bober"
}
```
<div id="comment:0"></div>

I think that the following example speaks for itself. (This was on an x86, 32 bit, running Ubuntu.)

Also, I believe that these examples had no problems in sage 3.0.2.

```
bober@bober:~/math/tests$ sage
----------------------------------------------------------------------
| Sage Version 3.2, Release Date: 2008-11-20                         |
| Type notebook() for the GUI, and license() for information.        |
----------------------------------------------------------------------

sage: get_memory_usage()
114.5546875
sage: for z in xrange(10000):
   ...:     a = 3^i
   ...:     
sage: get_memory_usage()
121.4375
sage: for z in xrange(10000):
    a = 3^CC.0
   ...:     
sage: get_memory_usage()
128.96484375
sage: for z in xrange(10000):
    a = 3.0^CC.0
   ...:     
sage: get_memory_usage()
187.36328125
sage: var('t')
t
sage: for z in xrange(10000):
    a = 3.0^t
   ....:     
sage: get_memory_usage()
231.4609375
sage: #But, integer^integer is OK:
sage: for z in xrange(10000):
    a = 3^3
   ....:     
sage: get_memory_usage
<function get_memory_usage at 0x8415f0c>
sage: get_memory_usage()
231.58984375
sage: for z in xrange(10000):
    a = 3^3
   ....:     
sage: get_memory_usage()
231.58984375
sage: for z in xrange(10000):
    a = 3.0^CC.0
   ....:     
saget_memory_usage()
290.1640625
sage: for z in xrange(10000):
    a = CC.0^CC.0
   ....:     
sage: get_memory_usage()
290.1640625
```

CC:  @robertwb

Component: **basic arithmetic**

_Issue created by migration from https://trac.sagemath.org/ticket/4639_





---

archive/issue_events_052619.json:
```json
{
    "actor": "https://github.com/sagetrac-bober",
    "created_at": "2008-11-27T19:06:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20basic%20arithmetic",
    "label_color": "0000ff",
    "label_name": "c: basic arithmetic",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4639#event-52619"
}
```



---

archive/issue_events_052620.json:
```json
{
    "actor": "https://github.com/sagetrac-bober",
    "created_at": "2008-11-27T19:06:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20critical%20/%202",
    "label_color": "ff7700",
    "label_name": "p: critical / 2",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4639#event-52620"
}
```



---

archive/issue_events_052621.json:
```json
{
    "actor": "https://github.com/sagetrac-bober",
    "created_at": "2008-11-27T19:06:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4639#event-52621"
}
```



---

archive/issue_comments_027708.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nThis is indeed a grave bug.\n\nCheers,\n\nMichael",
    "created_at": "2008-11-27T19:23:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4639#issuecomment-27708",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:1" align="right">comment:1</div>

This is indeed a grave bug.

Cheers,

Michael



---

archive/issue_events_052622.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-11-27T19:23:22Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20critical%20/%202",
    "label_color": "ff7700",
    "label_name": "p: critical / 2",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4639#event-52622"
}
```



---

archive/issue_events_052623.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-11-27T19:23:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20blocker%20/%201",
    "label_color": "ff0000",
    "label_name": "p: blocker / 1",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4639#event-52623"
}
```



---

archive/issue_events_052624.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-11-27T19:23:22Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "milestone_number": null,
    "milestone_title": "sage-3.2.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4639#event-52624"
}
```



---

archive/issue_comments_027709.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nHmm, \n\nBurcin and I have been looking at code he has been writing and there seems to be a caching issue with the coercion system. Now, I don't want to outright blame coercion here without any hard evidence, but the timing (3.0.2 to now) suggests that it could be involved here. So let's add robertwb to the CC and see if he can come up with anything. I will collect some evidence and hopefully someone else will take over.\n\nCheers,\n\nMichael",
    "created_at": "2008-11-28T02:31:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4639#issuecomment-27709",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:2" align="right">comment:2</div>

Hmm, 

Burcin and I have been looking at code he has been writing and there seems to be a caching issue with the coercion system. Now, I don't want to outright blame coercion here without any hard evidence, but the timing (3.0.2 to now) suggests that it could be involved here. So let's add robertwb to the CC and see if he can come up with anything. I will collect some evidence and hopefully someone else will take over.

Cheers,

Michael



---

archive/issue_comments_027710.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nBurcin about his code, not the problem reported here:\n\n```\n[6:36pm] burcin: hmm.. I think I found the problem..\n[6:36pm] burcin: still vague though\n[6:36pm] mabshoff: burcin: I CCed RobertWB on that existing leak ticket with the exponentiation and hopefully he will just post a one line patch.\n[6:36pm] mabshoff: Ok \n[6:36pm] burcin: I was being a good coercion user and called .coerce()\n[6:36pm] burcin: if I just use the __call__ on the parent, things work much much faster\n[6:36pm] mabshoff: And it doesn't leak?\n[6:37pm] burcin: I am guessing that the leak also goes away.. because this example ate more than 2gb memory with the leak\n[6:37pm] mabshoff: yeah\n```",
    "created_at": "2008-11-28T02:40:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4639#issuecomment-27710",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:3" align="right">comment:3</div>

Burcin about his code, not the problem reported here:

```
[6:36pm] burcin: hmm.. I think I found the problem..
[6:36pm] burcin: still vague though
[6:36pm] mabshoff: burcin: I CCed RobertWB on that existing leak ticket with the exponentiation and hopefully he will just post a one line patch.
[6:36pm] mabshoff: Ok 
[6:36pm] burcin: I was being a good coercion user and called .coerce()
[6:36pm] burcin: if I just use the __call__ on the parent, things work much much faster
[6:36pm] mabshoff: And it doesn't leak?
[6:37pm] burcin: I am guessing that the leak also goes away.. because this example ate more than 2gb memory with the leak
[6:37pm] mabshoff: yeah
```



---

archive/issue_comments_027711.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nHere is my leak:\n\n```\nsage: F = GF(13)\nsage: get_memory_usage()\n708.02734375\nsage: for _ in xrange(10000):\n....:     t = F.coerce(F(234234))\n....:     \nsage: get_memory_usage()\n728.15234375\nsage: for _ in xrange(100000):\n    t = F.coerce(F(234234))\n....:     \nsage: get_memory_usage()\n932.3125\nsage: for _ in xrange(100000):\n    t = F.coerce(F(234234))\n....:     \nsage: get_memory_usage()\n1136.35546875\n```",
    "created_at": "2008-11-28T02:51:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4639#issuecomment-27711",
    "user": "https://github.com/burcin"
}
```

<div id="comment:4" align="right">comment:4</div>

Here is my leak:

```
sage: F = GF(13)
sage: get_memory_usage()
708.02734375
sage: for _ in xrange(10000):
....:     t = F.coerce(F(234234))
....:     
sage: get_memory_usage()
728.15234375
sage: for _ in xrange(100000):
    t = F.coerce(F(234234))
....:     
sage: get_memory_usage()
932.3125
sage: for _ in xrange(100000):
    t = F.coerce(F(234234))
....:     
sage: get_memory_usage()
1136.35546875
```



---

archive/issue_events_052625.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-11-28T21:35:49Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "milestone_number": null,
    "milestone_title": "sage-3.2.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4639#event-52625"
}
```



---

archive/issue_events_052626.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-11-28T21:35:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "milestone_number": null,
    "milestone_title": "sage-3.2.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4639#event-52626"
}
```



---

archive/issue_comments_027712.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nThis ticket might also cause #4631.\n\nCheers,\n\nMichael",
    "created_at": "2008-11-28T21:35:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4639#issuecomment-27712",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:5" align="right">comment:5</div>

This ticket might also cause #4631.

Cheers,

Michael



---

archive/issue_events_052627.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-12-02T05:21:51Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "milestone_number": null,
    "milestone_title": "sage-3.2.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4639#event-52627"
}
```



---

archive/issue_events_052628.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-12-02T05:21:51Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "milestone_number": null,
    "milestone_title": "sage-3.2.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4639#event-52628"
}
```



---

archive/issue_comments_027713.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nHere's the bug: \n\n```\nsage: sage: get_memory_usage()\n'465M'\nsage: for _ in xrange(10000): t = Hom(QQ, QQ)\n....: \nsage: sage: get_memory_usage()\n'476M'\nsage: Hom(QQ, QQ) is Hom(QQ, QQ)\nFalse\n```",
    "created_at": "2008-12-02T12:04:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4639#issuecomment-27713",
    "user": "https://github.com/robertwb"
}
```

<div id="comment:7" align="right">comment:7</div>

Here's the bug: 

```
sage: sage: get_memory_usage()
'465M'
sage: for _ in xrange(10000): t = Hom(QQ, QQ)
....: 
sage: sage: get_memory_usage()
'476M'
sage: Hom(QQ, QQ) is Hom(QQ, QQ)
False
```



---

archive/issue_comments_027714.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nHi Robert,\n\ndo you want me to valgrind here or are you already on top of this?\n\nCheers,\n\nMichael",
    "created_at": "2008-12-02T15:49:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4639#issuecomment-27714",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:8" align="right">comment:8</div>

Hi Robert,

do you want me to valgrind here or are you already on top of this?

Cheers,

Michael



---

archive/issue_comments_027715.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nI think I can dig further, this is just as far as I got last night. It's probably a caching, not malloc, issue.",
    "created_at": "2008-12-02T19:50:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4639#issuecomment-27715",
    "user": "https://github.com/robertwb"
}
```

<div id="comment:9" align="right">comment:9</div>

I think I can dig further, this is just as far as I got last night. It's probably a caching, not malloc, issue.



---

archive/issue_comments_027716.json:
```json
{
    "body": "Attachment: **[4639-coerce-leak.patch.gz](https://github.com/sagemath/sage/files/ticket4639/4639-coerce-leak.patch.gz)**\n\nthis fixes the leak in coerce, not in exponentiation",
    "created_at": "2008-12-02T22:25:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4639#issuecomment-27716",
    "user": "https://github.com/robertwb"
}
```

Attachment: **[4639-coerce-leak.patch.gz](https://github.com/sagemath/sage/files/ticket4639/4639-coerce-leak.patch.gz)**

this fixes the leak in coerce, not in exponentiation



---

archive/issue_comments_027717.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nBetter caching for homsets fixes the leak for coercion.",
    "created_at": "2008-12-02T22:25:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4639#issuecomment-27717",
    "user": "https://github.com/robertwb"
}
```

<div id="comment:10" align="right">comment:10</div>

Better caching for homsets fixes the leak for coercion.



---

archive/issue_events_052629.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-12-02T22:42:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4639#event-52629"
}
```



---

archive/issue_comments_027718.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nMaybe we should move the problem with exponentiation to another ticket if it proves difficult to fix so we can get the coercion fix in. I am doctesting this now, but I will hold on a merge until we have gotten #3623 and #4276 in.\n\nCheers,\n\nMichael",
    "created_at": "2008-12-02T22:43:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4639#issuecomment-27718",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:12" align="right">comment:12</div>

Maybe we should move the problem with exponentiation to another ticket if it proves difficult to fix so we can get the coercion fix in. I am doctesting this now, but I will hold on a merge until we have gotten #3623 and #4276 in.

Cheers,

Michael



---

archive/issue_comments_027719.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nThe patch RobertWB posted does pass doctesting.\n\nCheers,\n\nMichael",
    "created_at": "2008-12-03T00:05:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4639#issuecomment-27719",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:13" align="right">comment:13</div>

The patch RobertWB posted does pass doctesting.

Cheers,

Michael



---

archive/issue_comments_027720.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\n#4683 might be a dupe of this ticket.\n\nCheers,\n\nMichael",
    "created_at": "2008-12-03T01:16:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4639#issuecomment-27720",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:14" align="right">comment:14</div>

#4683 might be a dupe of this ticket.

Cheers,

Michael



---

archive/issue_comments_027721.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nI've read the patch and give it a positive review.  But the patch doesn't resolve the ticket, as Robert points out.   So after applying the patch, I guess you have to open a new ticket?  Or???  \n\nAnyway -- don't just randomly close this ticket after applying the patch...",
    "created_at": "2008-12-06T22:33:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4639#issuecomment-27721",
    "user": "https://github.com/williamstein"
}
```

<div id="comment:15" align="right">comment:15</div>

I've read the patch and give it a positive review.  But the patch doesn't resolve the ticket, as Robert points out.   So after applying the patch, I guess you have to open a new ticket?  Or???  

Anyway -- don't just randomly close this ticket after applying the patch...



---

archive/issue_events_052630.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2008-12-06T22:33:04Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4639#event-52630"
}
```



---

archive/issue_events_052631.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2008-12-06T22:33:04Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4639#event-52631"
}
```



---

archive/issue_comments_027722.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nI have deleted the patch and moved it to its own ticket at #4740 since it does not fix the original problem reported. \n\nCheers,\n\nMichael",
    "created_at": "2008-12-08T11:26:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4639#issuecomment-27722",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:16" align="right">comment:16</div>

I have deleted the patch and moved it to its own ticket at #4740 since it does not fix the original problem reported. 

Cheers,

Michael



---

archive/issue_comments_027723.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nAn interesting test point: \n\n```\nclass TestParent(Parent):\n    def __init__(self):\n        self._populate_coercion_lists_()\n    def _has_coerce_map_from_(self, X):\n        return True\n    def _element_constructor_(self, x):\n        raise TypeError\n```\n\nNow this leaks\n\n```\n%python\n\nfrom sage.all import get_memory_usage\n\ndef test(R, S):\n    mor = S.convert_map_from(R)\n    print get_memory_usage()\n    for i in range(10000):\n        try:\n            mor = S.convert_map_from(R)\n            a = mor._call_(R.gen())\n        except:\n            pass\n    print get_memory_usage()\n```\n\nBut this doesn't \n\n```\n%cython\n\nfrom sage.all import get_memory_usage\n\ndef test(R, S):\n    mor = S.convert_map_from(R)\n    print get_memory_usage()\n    for i in range(10000):\n        try:\n            mor = S.convert_map_from(R)\n            a = mor._call_(R.gen())\n        except:\n            pass\n    print get_memory_usage()\n```\n\nThe *only* difference here is Python vs. Cython (leaking in the Python case).",
    "created_at": "2008-12-14T05:51:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4639#issuecomment-27723",
    "user": "https://github.com/robertwb"
}
```

<div id="comment:17" align="right">comment:17</div>

An interesting test point: 

```
class TestParent(Parent):
    def __init__(self):
        self._populate_coercion_lists_()
    def _has_coerce_map_from_(self, X):
        return True
    def _element_constructor_(self, x):
        raise TypeError
```

Now this leaks

```
%python

from sage.all import get_memory_usage

def test(R, S):
    mor = S.convert_map_from(R)
    print get_memory_usage()
    for i in range(10000):
        try:
            mor = S.convert_map_from(R)
            a = mor._call_(R.gen())
        except:
            pass
    print get_memory_usage()
```

But this doesn't 

```
%cython

from sage.all import get_memory_usage

def test(R, S):
    mor = S.convert_map_from(R)
    print get_memory_usage()
    for i in range(10000):
        try:
            mor = S.convert_map_from(R)
            a = mor._call_(R.gen())
        except:
            pass
    print get_memory_usage()
```

The *only* difference here is Python vs. Cython (leaking in the Python case).



---

archive/issue_comments_027724.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nAnd running \n\n```\ntest(TestParent(), ZZ['x']) # python\n638M\n640M\n```\n\n\n```\ntest(TestParent(), ZZ['x']) # cython\n640M\n640M\n```\n\nIt feels like something is getting cached in an exception.",
    "created_at": "2008-12-14T05:55:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4639#issuecomment-27724",
    "user": "https://github.com/robertwb"
}
```

<div id="comment:18" align="right">comment:18</div>

And running 

```
test(TestParent(), ZZ['x']) # python
638M
640M
```


```
test(TestParent(), ZZ['x']) # cython
640M
640M
```

It feels like something is getting cached in an exception.



---

archive/issue_comments_027725.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nI am almost sure the above is what's going wrong, and it gets invoked by __call__. \n\nguppy gives a total of 40420 bytes on these runs... and nothing new after repeated runs (despite get_memory_usage going up and up). However, the memory still goes up. Mabshoff, could you valgrind this and see if anything suspicious comes up? Perhaps up the loop to 100000, or diff the run from Python with that from Cython, to make it more clear where the error is...",
    "created_at": "2008-12-14T06:30:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4639#issuecomment-27725",
    "user": "https://github.com/robertwb"
}
```

<div id="comment:19" align="right">comment:19</div>

I am almost sure the above is what's going wrong, and it gets invoked by __call__. 

guppy gives a total of 40420 bytes on these runs... and nothing new after repeated runs (despite get_memory_usage going up and up). However, the memory still goes up. Mabshoff, could you valgrind this and see if anything suspicious comes up? Perhaps up the loop to 100000, or diff the run from Python with that from Cython, to make it more clear where the error is...



---

archive/issue_comments_027726.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nWill do. Any news on the pickle failure for #4740?\n\nCheers,\n\nMichael",
    "created_at": "2008-12-14T06:33:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4639#issuecomment-27726",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:20" align="right">comment:20</div>

Will do. Any news on the pickle failure for #4740?

Cheers,

Michael



---

archive/issue_comments_027727.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nThis is a Cython error, not a coercion error. When something is returned from within a try block, it appears the (cached) exception is not released. \n\n```\n%cython\ndef foo():\n    try:\n        return None\n    except:\n        pass\n```\n\n```\n%python\ndef test():\n    print get_memory_usage()\n    for i in range(100000):\n        try:\n            foo()\n            raise TypeError\n        except TypeError:\n            pass\n    print get_memory_usage()\n```\n\nNow `test()` will leak.",
    "created_at": "2008-12-14T09:01:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4639#issuecomment-27727",
    "user": "https://github.com/robertwb"
}
```

<div id="comment:21" align="right">comment:21</div>

This is a Cython error, not a coercion error. When something is returned from within a try block, it appears the (cached) exception is not released. 

```
%cython
def foo():
    try:
        return None
    except:
        pass
```

```
%python
def test():
    print get_memory_usage()
    for i in range(100000):
        try:
            foo()
            raise TypeError
        except TypeError:
            pass
    print get_memory_usage()
```

Now `test()` will leak.



---

archive/issue_comments_027728.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nInstall cython-0.10.3.spkg at http://sage.math.washington.edu/home/robertwb/cython/ , which contains a fix to http://trac.cython.org/cython_trac/ticket/162 and I think is the underlying cause here (and probably elsewhere).",
    "created_at": "2008-12-14T11:28:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4639#issuecomment-27728",
    "user": "https://github.com/robertwb"
}
```

<div id="comment:22" align="right">comment:22</div>

Install cython-0.10.3.spkg at http://sage.math.washington.edu/home/robertwb/cython/ , which contains a fix to http://trac.cython.org/cython_trac/ticket/162 and I think is the underlying cause here (and probably elsewhere).



---

archive/issue_comments_027729.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nThe new Cython.spkg reduces the leak significantly:\nWithout:\n\n```\nsage: get_memory_usage()\n417.98828125\nsage: for z in xrange(10000):\n....:     a = 3.0^CC.0\n....:     \nsage: get_memory_usage()\n509.26171875\n```\nWith:\n\n```\nsage: get_memory_usage()\n416.19140625\nsage: \nsage: for z in xrange(10000):\n....:     a = 3.0^CC.0\n....:     \nsage: get_memory_usage()\n437.97265625\n```\nBut unfortunately it doesn't fix it completely:\n\n```\nsage: get_memory_usage()\n416.19140625\nsage: \nsage: for z in xrange(10000):\n....:     a = 3.0^CC.0\n....:     \nsage: get_memory_usage()\n437.97265625\nsage: for z in xrange(10000):\n    a = 3.0^CC.0\n....:     \nsage: get_memory_usage()\n459.99609375\n```\nConsequently I will split the Cython.spkg from this ticket.\n\nCheers,\n\nMichael",
    "created_at": "2008-12-14T15:53:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4639#issuecomment-27729",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:23" align="right">comment:23</div>

The new Cython.spkg reduces the leak significantly:
Without:

```
sage: get_memory_usage()
417.98828125
sage: for z in xrange(10000):
....:     a = 3.0^CC.0
....:     
sage: get_memory_usage()
509.26171875
```
With:

```
sage: get_memory_usage()
416.19140625
sage: 
sage: for z in xrange(10000):
....:     a = 3.0^CC.0
....:     
sage: get_memory_usage()
437.97265625
```
But unfortunately it doesn't fix it completely:

```
sage: get_memory_usage()
416.19140625
sage: 
sage: for z in xrange(10000):
....:     a = 3.0^CC.0
....:     
sage: get_memory_usage()
437.97265625
sage: for z in xrange(10000):
    a = 3.0^CC.0
....:     
sage: get_memory_usage()
459.99609375
```
Consequently I will split the Cython.spkg from this ticket.

Cheers,

Michael



---

archive/issue_comments_027730.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nFor the record: The cython.spkg upgrade to 0.10.3 is #4798.\n\nCheers,\n\nMichael",
    "created_at": "2008-12-14T17:41:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4639#issuecomment-27730",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:24" align="right">comment:24</div>

For the record: The cython.spkg upgrade to 0.10.3 is #4798.

Cheers,

Michael



---

archive/issue_comments_027731.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nThis is the bug that will never die... I'll keep looking at that last case.",
    "created_at": "2008-12-15T18:30:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4639#issuecomment-27731",
    "user": "https://github.com/robertwb"
}
```

<div id="comment:25" align="right">comment:25</div>

This is the bug that will never die... I'll keep looking at that last case.



---

archive/issue_events_052632.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-12-15T18:43:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "milestone_number": null,
    "milestone_title": "sage-3.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4639#event-52632"
}
```



---

archive/issue_events_052633.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-12-15T18:43:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "milestone_number": null,
    "milestone_title": "sage-3.2.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4639#event-52633"
}
```



---

archive/issue_comments_027732.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nIf there ever was a blocker for 3.2.2 :)\n\nCheers,\n\nMichael",
    "created_at": "2008-12-15T18:43:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4639#issuecomment-27732",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:26" align="right">comment:26</div>

If there ever was a blocker for 3.2.2 :)

Cheers,

Michael



---

archive/issue_comments_027733.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nAnother data point.\n\nI took the example from #4683 (Michael, it was argued that #4683 is a duplicate).\n\n```\nsage: get_memory_usage()\n704.5390625\nsage: v = [CDF(i)^2 for n in range(50000)]\nsage: get_memory_usage()\n803.67578125\n...\nsage: get_memory_usage()\n1093.203125\nsage: del v\nsage: get_memory_usage()\n1093.203125\nsage: v = [CDF(i)^2 for n in range(50000)]\nsage: get_memory_usage()\n1183.86328125\nsage: del v\nsage: get_memory_usage()\n1183.86328125\nsage: v=1\nsage: get_memory_usage()\n1183.86328125\n...\nsage: v = [CDF(i)^2 for n in range(50000)]\nsage: get_memory_usage()\n1279.55078125\nsage: w = deepcopy(v)\nsage: get_memory_usage()\n1295.18359375\nsage: del w\nsage: get_memory_usage()\n1295.18359375\n```\n\nTherefore it seems to me that the problem is not exponentiation but a failure in deallocation.",
    "created_at": "2008-12-16T13:16:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4639#issuecomment-27733",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:27" align="right">comment:27</div>

Another data point.

I took the example from #4683 (Michael, it was argued that #4683 is a duplicate).

```
sage: get_memory_usage()
704.5390625
sage: v = [CDF(i)^2 for n in range(50000)]
sage: get_memory_usage()
803.67578125
...
sage: get_memory_usage()
1093.203125
sage: del v
sage: get_memory_usage()
1093.203125
sage: v = [CDF(i)^2 for n in range(50000)]
sage: get_memory_usage()
1183.86328125
sage: del v
sage: get_memory_usage()
1183.86328125
sage: v=1
sage: get_memory_usage()
1183.86328125
...
sage: v = [CDF(i)^2 for n in range(50000)]
sage: get_memory_usage()
1279.55078125
sage: w = deepcopy(v)
sage: get_memory_usage()
1295.18359375
sage: del w
sage: get_memory_usage()
1295.18359375
```

Therefore it seems to me that the problem is not exponentiation but a failure in deallocation.



---

archive/issue_comments_027734.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nAttachment: **[4639-parent-memleak.patch.gz](https://github.com/sagemath/sage/files/ticket4639/4639-parent-memleak.patch.gz)**\n\nI believe I have located and resolved the issue. After tracing through all kinds of coercion and homset code, and reading tons of Cython code looking for memory leaks, it turns out that this was caused by all Parents ever created being cached due to old debugging code. (Wow, wish I'd looked there first! :)\n\nSome old, unnecessary code has been removed from the generic `__call__` method as well.",
    "created_at": "2008-12-16T20:29:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4639#issuecomment-27734",
    "user": "https://github.com/robertwb"
}
```

<div id="comment:28" align="right">comment:28</div>

Attachment: **[4639-parent-memleak.patch.gz](https://github.com/sagemath/sage/files/ticket4639/4639-parent-memleak.patch.gz)**

I believe I have located and resolved the issue. After tracing through all kinds of coercion and homset code, and reading tons of Cython code looking for memory leaks, it turns out that this was caused by all Parents ever created being cached due to old debugging code. (Wow, wish I'd looked there first! :)

Some old, unnecessary code has been removed from the generic `__call__` method as well.



---

archive/issue_comments_027735.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nNice! I am testing away at the moment :)\n\nCheers,\n\nMichael",
    "created_at": "2008-12-16T20:35:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4639#issuecomment-27735",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:29" align="right">comment:29</div>

Nice! I am testing away at the moment :)

Cheers,

Michael



---

archive/issue_events_052634.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-12-16T20:35:59Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4639#event-52634"
}
```



---

archive/issue_events_052635.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-12-16T20:35:59Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4639#event-52635"
}
```



---

archive/issue_comments_027736.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nThis does indeed fix the issue for me:\n\n```\n----------------------------------------------------------------------\n| Sage Version 3.2.2.rc0, Release Date: 2008-12-15                   |\n| Type notebook() for the GUI, and license() for information.        |\n----------------------------------------------------------------------\nsage: get_memory_usage()\n416.21484375\nsage: for z in xrange(10000):\n....:     a = 3.0^CC.0\n....:     \nsage: get_memory_usage()\n416.21484375\nsage: for z in xrange(10000):\n    a = 3.0^CC.0\n....:     \nsage: get_memory_usage()\n416.21484375\n```\nDoctesting now ...\n\nCheers,\n\nMichael",
    "created_at": "2008-12-16T20:38:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4639#issuecomment-27736",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:30" align="right">comment:30</div>

This does indeed fix the issue for me:

```
----------------------------------------------------------------------
| Sage Version 3.2.2.rc0, Release Date: 2008-12-15                   |
| Type notebook() for the GUI, and license() for information.        |
----------------------------------------------------------------------
sage: get_memory_usage()
416.21484375
sage: for z in xrange(10000):
....:     a = 3.0^CC.0
....:     
sage: get_memory_usage()
416.21484375
sage: for z in xrange(10000):
    a = 3.0^CC.0
....:     
sage: get_memory_usage()
416.21484375
```
Doctesting now ...

Cheers,

Michael



---

archive/issue_events_052636.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-12-17T03:28:13Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4639#event-52636"
}
```



---

archive/issue_events_052637.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-12-17T03:28:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4639#event-52637"
}
```



---

archive/issue_comments_027737.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nPositive review for 4639-parent-memleak.patch - w00t\n\nCheers,\n\nMichael",
    "created_at": "2008-12-17T03:28:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4639#issuecomment-27737",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:31" align="right">comment:31</div>

Positive review for 4639-parent-memleak.patch - w00t

Cheers,

Michael



---

archive/issue_events_052638.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-12-17T14:01:23Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4639#event-52638"
}
```



---

archive/issue_events_052639.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-12-17T14:01:23Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/4639#event-52639"
}
```



---

archive/issue_comments_027738.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nMerged in Sage 3.2.2.rc1",
    "created_at": "2008-12-17T14:01:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/4639",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/4639#issuecomment-27738",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<div id="comment:32" align="right">comment:32</div>

Merged in Sage 3.2.2.rc1
