# Issue 31301: i386: openssl attempts 64-bit build and fails

Issue created by migration from https://trac.sagemath.org/ticket/31538

Original creator: mkoeppe

Original creation time: 2021-03-22 21:55:46

CC:  tmonteil dimpase vbraun

For example on `ubuntu-bionic-i386-minimal` https://github.com/mkoeppe/sage/runs/2161532075

```
make depend && make _build_sw
gcc  -I. -Iinclude -Iapps/include  -fPIC -pthread -m64 -Wa,--noexecstack -O2 -g -march=native -DOPENSSL_USE_NODELETE -DL_ENDIAN -DOPENSSL_PIC -DOPENSSLDIR="\"/sage/local/openssl\"" -DENGINESDIR="\"/sage/local/lib64/engines-3\"" -DMODULESDIR="\"/sage/local/lib64/ossl-modules\"" -DOPENSSL_BUILDING_OPENSSL -DNDEBUG  -MMD -MF apps/lib/libapps-lib-app_params.d.tmp -MT apps/lib/libapps-lib-app_params.o -c -o apps/lib/libapps-lib-app_params.o apps/lib/app_params.c
In file included from /usr/lib/gcc/i686-linux-gnu/7/include-fixed/limits.h:194:0,
                 from /usr/lib/gcc/i686-linux-gnu/7/include-fixed/syslimits.h:7,
                 from /usr/lib/gcc/i686-linux-gnu/7/include-fixed/limits.h:34,
                 from ./e_os.h:13,
                 from apps/include/apps.h:13,
                 from apps/lib/app_params.c:10:
/usr/include/limits.h:26:10: fatal error: bits/libc-header-start.h: No such file or directory
 #include <bits/libc-header-start.h>
          ^~~~~~~~~~~~~~~~~~~~~~~~~~
```



---

Comment by mkoeppe created at 2021-03-22 22:23:48

This is from a virtualized build using Docker, not a real 386. 
openssl chooses a 64-bit build based on `uname`, which is wrong. Instead we need to check the target ABI of the configured `CC`, similar to what we do in `build/pkgs/gmp/spkg-install.in` (or just use `$CC -dumpmachine` and pattern match...)


---

Comment by mkoeppe created at 2021-03-22 23:43:33

New commits:


---

Comment by mkoeppe created at 2021-03-22 23:43:33

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-03-22 23:52:03

We should also update the tested 32-bit platforms. `ubuntu-focal-i386-standard` consistently fails - lots of missing packages (https://github.com/mkoeppe/sage/runs/2170889217).
"Upgrades on i386: Users of the i386 architecture will not be presented with an upgrade to Ubuntu 20.04 LTS. Support for i386 as a host architecture was dropped in 19.10." (https://wiki.ubuntu.com/FocalFossa/ReleaseNotes)


---

Comment by mkoeppe created at 2021-03-23 03:58:39

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-03-23 04:36:56

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-03-23 17:56:58

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-03-23 23:55:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-03-24 00:44:47

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-03-24 01:09:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-03-24 02:07:02

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-03-24 15:53:23

Ready for review. As https://github.com/mkoeppe/sage/actions/runs/681629845 shows, the build errors are fixed and the build runs successfully for all 32-bit platforms (updated in #31541) until the 6-hour time limit is reached.


---

Comment by dimpase created at 2021-03-24 19:06:00

I tested on 32-bit, it all works.


---

Comment by dimpase created at 2021-03-24 19:06:00

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-03-24 19:11:57

Thanks!


---

Comment by mkoeppe created at 2021-03-29 23:54:39

Setting priority to blocker to bring this ticket to the attention of the release bot.


---

Comment by mkoeppe created at 2021-03-29 23:54:39

Changing priority from critical to blocker.


---

Comment by vbraun created at 2021-04-01 19:45:07

Resolution: fixed
