# Issue 21658: Better metaclass inference in dynamic classes

Issue created by migration from https://trac.sagemath.org/ticket/21895

Original creator: saraedum

Original creation time: 2016-11-18 04:35:03

CC:  nthiery roed

Keywords: metaclass

When creating a dynamic class, (e.g., when creating an object in a category,) the following code is used to figure out the metaclass:

```
metaclass = DynamicMetaclass
# The metaclass of a class must derive from the metaclasses of its
# bases. The following handles the case where one of the base
# classes is a known Sage metaclass.  This approach won't scale
# well if we start using metaclasses seriously in Sage.
for base in bases:
    if isinstance(base, InheritComparisonClasscallMetaclass):
        metaclass = DynamicInheritComparisonClasscallMetaclass
    elif isinstance(base, ClasscallMetaclass):
        metaclass = DynamicClasscallMetaclass
    elif isinstance(base, InheritComparisonMetaclass):
metaclass = DynamicInheritComparisonMetaclass
```

This does not work if two bases have conflicting metaclasses, say `InheritComparisonMetaclass` and `ClasscallMetaclass`. As a result, one can currently not let a subclass of `Morphism` (which is a `InheritComparisonMetaclass`) inherit from `UniqueRepresentation` (a `ClasscallMetaclass`).


---

Comment by saraedum created at 2016-11-18 04:57:13

I fixed a real world problem that hit me when working on #21879 to showcase that this really works. I could also split this off into a different ticket and create a more artificial doctest for this, if the reviewer wants me to.
----
New commits:


---

Comment by saraedum created at 2016-11-18 05:00:20

nthiery: I believe that you wrote the code that I quote in the summary?


---

Comment by saraedum created at 2016-11-18 05:00:31

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2016-11-18 09:35:14

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2016-11-18 09:35:14

Replying to [comment:2 saraedum]:
> I fixed a real world problem that hit me when working on #21879 to showcase that this really works. I could also split this off into a different ticket and create a more artificial doctest for this, if the reviewer wants me to.

Please add such a doctest!


---

Comment by jdemeyer created at 2016-11-18 09:36:49

And I would also recommend to split off the changes which are unrelated to the topic of this ticket (the changes to `AlgebraMorphism` for example).


---

Comment by git created at 2016-11-28 07:58:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2016-11-28 07:58:49

Changing status from needs_work to needs_review.


---

Comment by saraedum created at 2016-11-28 07:58:49

New commits:
----
New commits:


---

Comment by jdemeyer created at 2016-11-28 09:29:15

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2016-11-28 09:29:15

1. Compare classes with `is` instead of `==`.

2. Move the changes to `generic_basis_code.py` to a new ticket.


---

Comment by git created at 2016-11-28 09:44:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2016-11-28 09:44:20

New commits:
----
New commits:


---

Comment by saraedum created at 2016-11-28 09:44:20

Changing status from needs_work to needs_review.


---

Comment by saraedum created at 2016-11-28 09:46:35

I dropped the other change since I do not care for that particular case.


---

Comment by jdemeyer created at 2016-11-28 15:06:03

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-11-29 23:20:43

Resolution: fixed
