# Issue 17059: Update autotools to 20141105

Issue created by migration from https://trac.sagemath.org/ticket/17296

Original creator: jpflori

Original creation time: 2014-11-05 16:22:28

CC:  jdemeyer

Some included software was updated since our last update.
In particular the new libtool 2.4.3 needs specific care as it uses pieces from gnulib.

Texinfo is NOT updated to 5.x as these new versions errors out when building old software.


---

Comment by jpflori created at 2014-11-05 16:30:25

Changing status from new to needs_review.


---

Comment by jpflori created at 2014-11-05 16:30:25

New commits:


---

Comment by git created at 2014-11-05 16:42:04

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2014-11-05 19:18:19

What is the reason for changing

```
source bootstrap.sh
```

to

```
./bootstrap.sh
```


And did you manually change the make rules for `$(SAGE_LOCAL)/automake-1.11.3`? The line continuations looks different.


---

Comment by jdemeyer created at 2014-11-05 19:18:19

Changing status from needs_review to needs_work.


---

Comment by jpflori created at 2014-11-06 10:07:24

Replying to [comment:4 jdemeyer]:
> What is the reason for changing
> {{{
> source bootstrap.sh
> }}}
> to
> {{{
> ./bootstrap.sh
> }}}
My bad, i was playing around and ending up with half broken versions of Sage's autotools and that was a temporary fix for me to use system wide stuff.
I'll put the `source` version back in.
> 
> And did you manually change the make rules for `$(SAGE_LOCAL)/automake-1.11.3`? The line continuations looks different.
I don't think so.
I'll regenerate everything anyway.


---

Comment by jdemeyer created at 2014-11-06 10:30:55

I'm also wondering why you made this change:

```diff
-if ! env "AUTOCONF_VERSION=2.62" autoconf --version | grep >/dev/null '2[.]62'; then
+if ! env "AUTOCONF_VERSION=2.59" autoconf --version | grep >/dev/null '2[.]59'; then
```


The number "2.62" was specifically chosen as being a "rare" version, not many operating systems come with that version by default. The version 2.59 is much more widely used, leading to more chances of a false positive.


---

Comment by jpflori created at 2014-11-06 10:32:51

Replying to [comment:6 jdemeyer]:
> I'm also wondering why you made this change:
> {{{
> #!diff
> -if ! env "AUTOCONF_VERSION=2.62" autoconf --version | grep >/dev/null '2[.]62'; then
> +if ! env "AUTOCONF_VERSION=2.59" autoconf --version | grep >/dev/null '2[.]59'; then
> }}}
> 
> The number "2.62" was specifically chosen as being a "rare" version, not many operating systems come with that version by default. The version 2.59 is much more widely used, leading to more chances of a false positive.
Oh, I thought I went the other way around and changed 59 by 62 for my own testing...
I'll fix that as well.
I must admit I did not have the time to check the full diff myself yet.


---

Comment by jdemeyer created at 2014-11-06 10:43:36

Just to satisfy my curiosity, I'm counting the `autoconf` version numbers of all `configure` files in all Sage packages:

```
2.13: 7
2.50: 0
2.51: 0
2.52: 3
2.53: 0
2.54: 0
2.55: 0
2.56: 0
2.57: 1
2.58: 0
2.59: 5
2.60: 0
2.61: 3
2.62: 0
2.63: 4
2.64: 30
2.65: 0
2.66: 0
2.67: 1
2.68: 25
2.69: 37
```


This should give a very rough idea how popular various `autoconf` versions are.


---

Comment by jpflori created at 2014-11-06 10:47:31

Also note that I fear that the latest libtool bootstrap script must connect to the internet by default to clone the gnulib directory.
I'll try to check if that can be avoided...


---

Comment by jpflori created at 2014-11-06 10:52:55

(Hopefully copying the gnulib repo cloned by spkg-src into the libtool build dir may be enough, that's just wishful thinking at the moment as I did not test it.)


---

Comment by jpflori created at 2014-11-06 10:58:21

I guess we have

```
    opt_gnulib_srcdir=$GNULIB_SRCDIR
    opt_skip_git=false
```

to play with.


---

Comment by jpflori created at 2014-11-06 13:37:50

Ok, now I remember why I removed the source thing.
The libtool 2.4.3 bootstrap script needs libtoolize, wand with source it points to the not yet available libtool 2.4.3.


---

Comment by jpflori created at 2014-11-06 16:19:22

Ok we have an issue with `gnulib` and using `source`:

```
# Override the default configuration, if necessary.
# Make sure that bootstrap.conf is sourced from the current directory
# if we were invoked as "sh bootstrap".
case $0 in
  */*) test -r "$0.conf" && . "$0.conf" ;;
  *) test -r "$0.conf" && . ./"$0.conf" ;;
esac
```

Note that if `source` is used `$0` is `/bin/bash`.

Anyway, is using `source` really mandatory?
All needed vars should be exported, aren't they?


---

Comment by jdemeyer created at 2014-11-06 16:32:56

The reason for `source` is the `set -e`. Older `bootstrap` scripts sometimes fail ungracefully if `set -e` is not given, braking stuff badly.


---

Comment by jpflori created at 2014-11-06 16:35:42

Ok, then I'll leave `source` in if using some heuristic it does not seem `gnulib` is used.


---

Comment by git created at 2014-11-06 16:53:17

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jpflori created at 2014-11-06 16:54:27

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2014-11-11 11:25:47

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2014-11-11 11:25:47

I dislike the `bootstrap_launch`/`bootstrap_opts` solution. I would much rather prefer something like

```sh
# Figure out how to bootstrap
if [ -f configure ]; then
    bootstrap=
elif [ -d gnulib ]; then
    bootstrap="bash bootstrap --skip-git --skip-po --gnulib-srcdir=../../src/gnulib && "
elif [ -f bootstrap.sh ]; then
    bootstrap="bash -c 'set -e; source bootstrap.sh' && "
elif [ -f bootstrap ]; then
    bootstrap="bash -c 'set -e; source bootstrap' && "
else
    bootstrap="autoreconf -i -I m4 && "
fi
```



---

Comment by jdemeyer created at 2014-11-11 11:26:44

If you really want to keep the `bootstrap_launch` logic, the whole string `bash -c 'set -e; source ` should all be part of `bootstrap_launch`.


---

Comment by git created at 2014-11-12 00:16:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2014-11-12 00:17:09

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2014-11-12 22:02:20

While running `spkg-src` I get

```
Cloning into 'gnulib'...
fatal: unable to connect to git.sv.gnu.org:
git.sv.gnu.org[0: 140.186.70.72]: errno=Connection refused
```


I assume this is a temporary problem, I still would like to try it so I'll wait a while and try again.


---

Comment by jdemeyer created at 2014-11-12 22:04:04

The diff looks good now by the way, so it's just a matter of testing the package.

Do you know of anything which requires libtool 2.4.3?


---

Comment by jpflori created at 2014-11-13 09:14:04

Replying to [comment:23 jdemeyer]:
> The diff looks good now by the way, so it's just a matter of testing the package.
> 
> Do you know of anything which requires libtool 2.4.3?
Not really, actually I wanted this for autoreconfiguring GLPK using your scripts, but it seems GLPK used an obscure revision of libtool between 2.4.2 and 2.4.3.


---

Comment by vbraun created at 2014-11-21 22:29:26

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-11-21 22:29:26

OSX 10.10 needs libtool 2.4.3... I'm going to set this to positive review before the 2.4.4 release in a few days.


---

Comment by vbraun created at 2014-11-23 19:59:53

Resolution: fixed
