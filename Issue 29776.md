# Issue 29776: src/bin/sage-env: Make sure SAGE_SCRIPTS_DIR is at the beginning of the PATH

archive/issues_029776.json:
```json
{
    "body": "CC:  mjo jhpalmieri\n\nFollow-up from #25486 (Discover `SAGE_SCRIPTS_DIR` to make `$SAGE_LOCAL/bin/sage` work from any directory, in an environment without `SAGE_*` variables).\n\nWe make sure that `$SAGE_SCRIPTS_DIR` appears at the beginning of the `PATH`.  For virtual environments such as those set up by tox (#29950), this may be different from and should take precedence over `$SAGE_LOCAL/bin`.  This will ensure that the correct copy of auxiliary scripts such as `sage-eval` is invoked by `sage`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/30013\n\n",
    "created_at": "2020-06-29T00:09:51Z",
    "labels": [
        "scripts",
        "major",
        "enhancement"
    ],
    "title": "src/bin/sage-env: Make sure SAGE_SCRIPTS_DIR is at the beginning of the PATH",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29776",
    "user": "mkoeppe"
}
```
CC:  mjo jhpalmieri

Follow-up from #25486 (Discover `SAGE_SCRIPTS_DIR` to make `$SAGE_LOCAL/bin/sage` work from any directory, in an environment without `SAGE_*` variables).

We make sure that `$SAGE_SCRIPTS_DIR` appears at the beginning of the `PATH`.  For virtual environments such as those set up by tox (#29950), this may be different from and should take precedence over `$SAGE_LOCAL/bin`.  This will ensure that the correct copy of auxiliary scripts such as `sage-eval` is invoked by `sage`.

Issue created by migration from https://trac.sagemath.org/ticket/30013





---

archive/issue_comments_422996.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-13T03:58:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29776#issuecomment-422996",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_422997.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-13T04:13:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29776#issuecomment-422997",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_422998.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-13T05:25:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29776#issuecomment-422998",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_422999.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-13T05:47:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29776#issuecomment-422999",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_423000.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-11-13T05:49:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29776#issuecomment-423000",
    "user": "mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_423001.json:
```json
{
    "body": "Using the new script `sage-venv-config` is probably overkill.\nIf #30888 resolves the symlink of $0, we could just infer the `SAGE_VENV` from its directory.",
    "created_at": "2020-11-13T05:49:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29776#issuecomment-423001",
    "user": "mkoeppe"
}
```

Using the new script `sage-venv-config` is probably overkill.
If #30888 resolves the symlink of $0, we could just infer the `SAGE_VENV` from its directory.



---

archive/issue_comments_423002.json:
```json
{
    "body": "Replying to [comment:15 mkoeppe]:\n> Using the new script `sage-venv-config` is probably overkill.\n> If #30888 resolves the symlink of $0, we could just infer the `SAGE_VENV` from its directory.\n\nWhy do you actually need go through the trouble of determining `SAGE_VENV` in some shell scripts? Isn't it enough to use `SAGE_VENV = sys.prefix` (which is already done in `env.py`)?",
    "created_at": "2020-11-13T09:14:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29776#issuecomment-423002",
    "user": "@tobiasdiez"
}
```

Replying to [comment:15 mkoeppe]:
> Using the new script `sage-venv-config` is probably overkill.
> If #30888 resolves the symlink of $0, we could just infer the `SAGE_VENV` from its directory.

Why do you actually need go through the trouble of determining `SAGE_VENV` in some shell scripts? Isn't it enough to use `SAGE_VENV = sys.prefix` (which is already done in `env.py`)?



---

archive/issue_comments_423003.json:
```json
{
    "body": "Replying to [comment:17 gh-tobiasdiez]:\n> Replying to [comment:15 mkoeppe]:\n> > Using the new script `sage-venv-config` is probably overkill.\n> > If #30888 resolves the symlink of $0, we could just infer the `SAGE_VENV` from its directory.\n> \n> Why do you actually need go through the trouble of determining `SAGE_VENV` in some shell scripts? Isn't it enough to use `SAGE_VENV = sys.prefix` (which is already done in `env.py`)?\n\nYes, for all Python scripts, `sys.prefix` does the right thing. But `sage` is a shell script (changing that would be outside of the scope of this ticket) and so we have to go through some extra trouble to determine this value in order to set PATH correctly.",
    "created_at": "2020-11-13T16:42:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29776#issuecomment-423003",
    "user": "mkoeppe"
}
```

Replying to [comment:17 gh-tobiasdiez]:
> Replying to [comment:15 mkoeppe]:
> > Using the new script `sage-venv-config` is probably overkill.
> > If #30888 resolves the symlink of $0, we could just infer the `SAGE_VENV` from its directory.
> 
> Why do you actually need go through the trouble of determining `SAGE_VENV` in some shell scripts? Isn't it enough to use `SAGE_VENV = sys.prefix` (which is already done in `env.py`)?

Yes, for all Python scripts, `sys.prefix` does the right thing. But `sage` is a shell script (changing that would be outside of the scope of this ticket) and so we have to go through some extra trouble to determine this value in order to set PATH correctly.



---

archive/issue_comments_423004.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-11-20T08:27:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29776#issuecomment-423004",
    "user": "dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_423005.json:
```json
{
    "body": "lgtm",
    "created_at": "2020-11-20T08:27:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29776#issuecomment-423005",
    "user": "dimpase"
}
```

lgtm



---

archive/issue_comments_423006.json:
```json
{
    "body": "Thanks!",
    "created_at": "2020-11-20T19:12:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29776#issuecomment-423006",
    "user": "mkoeppe"
}
```

Thanks!



---

archive/issue_comments_423007.json:
```json
{
    "body": "Changing keywords from \"\" to \"sd111\".",
    "created_at": "2020-12-11T06:21:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29776#issuecomment-423007",
    "user": "mkoeppe"
}
```

Changing keywords from "" to "sd111".



---

archive/issue_comments_423008.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-12-13T20:30:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29776#issuecomment-423008",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_423009.json:
```json
{
    "body": "This breaks if `sage_conf` is not installed, because VERSION is defined there\n\n```\nTraceback (most recent call last):\n  File \"/usr/bin/sage-venv-config\", line 29, in <module>\n    _main()\n  File \"/usr/bin/sage-venv-config\", line 17, in _main\n    version='%(prog)s ' + VERSION)\nNameError: name 'VERSION' is not defined\n```\n\nIf this is really intended and sage_conf is now mandatory, then ImportError from sage_conf shouldn't be trapped. But I hope it can still be possible to support `sage_conf`-less systems.",
    "created_at": "2020-12-15T18:35:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29776#issuecomment-423009",
    "user": "arojas"
}
```

This breaks if `sage_conf` is not installed, because VERSION is defined there

```
Traceback (most recent call last):
  File "/usr/bin/sage-venv-config", line 29, in <module>
    _main()
  File "/usr/bin/sage-venv-config", line 17, in _main
    version='%(prog)s ' + VERSION)
NameError: name 'VERSION' is not defined
```

If this is really intended and sage_conf is now mandatory, then ImportError from sage_conf shouldn't be trapped. But I hope it can still be possible to support `sage_conf`-less systems.



---

archive/issue_comments_423010.json:
```json
{
    "body": "`sage_conf` is still intended to be optional - this is a regression, patches welcome",
    "created_at": "2020-12-15T18:38:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29776#issuecomment-423010",
    "user": "mkoeppe"
}
```

`sage_conf` is still intended to be optional - this is a regression, patches welcome



---

archive/issue_comments_423011.json:
```json
{
    "body": "OK, glad to hear - so what should we do if there's no sage_conf? don't add the `--version`argument? get the version from somewhere else (where)?",
    "created_at": "2020-12-15T19:13:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29776#issuecomment-423011",
    "user": "arojas"
}
```

OK, glad to hear - so what should we do if there's no sage_conf? don't add the `--version`argument? get the version from somewhere else (where)?



---

archive/issue_comments_423012.json:
```json
{
    "body": "I have created #31058 for this",
    "created_at": "2020-12-16T01:42:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29776#issuecomment-423012",
    "user": "mkoeppe"
}
```

I have created #31058 for this
