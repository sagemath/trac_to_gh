# Issue 18226: matrix_plot broken in Sage 6.7

archive/issues_018226.json:
```json
{
    "body": "CC:  @kcrisman\n\nThe command `matrix_plot(identity_matrix(3))` does not work in Sage 6.7: it produces just a vertical axis. See https://groups.google.com/d/msg/sage-support/mDaQWuqi9bg/g571Ij8_C8kJ.\n\nIssue created by migration from https://trac.sagemath.org/ticket/18463\n\n",
    "created_at": "2015-05-21T01:45:47Z",
    "labels": [
        "component: graphics",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.8",
    "title": "matrix_plot broken in Sage 6.7",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18226",
    "user": "https://github.com/jhpalmieri"
}
```
CC:  @kcrisman

The command `matrix_plot(identity_matrix(3))` does not work in Sage 6.7: it produces just a vertical axis. See https://groups.google.com/d/msg/sage-support/mDaQWuqi9bg/g571Ij8_C8kJ.

Issue created by migration from https://trac.sagemath.org/ticket/18463





---

archive/issue_comments_245880.json:
```json
{
    "body": "Ok, the root of the problem is in the `get_minmax_data` method of `MatrixPlot`.  This deliberately flips the y axis so that \"the picture looks correct.\", but it confounds the `_limit_output_aspect_ratio` method of `Graphics` which expects ymax-ymin to be positive.  I see a bunch of choices\n\n1) We can have `output_aspect` be the absolute value of what it is now.  This works but this leaves `ymax < ymin` ready to bite someone else who expects min < max.\n\n2) We can display matrices upside down.  This seems unreasonable.\n\n3) We can flip the xy_data_array in the Matrix plot constructor.  This feels wrongish, it means making a copy of the array.\n\nTo me 1 seems the best choice, but I am not familiar enough with the Graphics object to be comfortable with it.\n\nHope this helps",
    "created_at": "2015-05-21T22:13:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18226",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18226#issuecomment-245880",
    "user": "https://github.com/deinst"
}
```

Ok, the root of the problem is in the `get_minmax_data` method of `MatrixPlot`.  This deliberately flips the y axis so that "the picture looks correct.", but it confounds the `_limit_output_aspect_ratio` method of `Graphics` which expects ymax-ymin to be positive.  I see a bunch of choices

1) We can have `output_aspect` be the absolute value of what it is now.  This works but this leaves `ymax < ymin` ready to bite someone else who expects min < max.

2) We can display matrices upside down.  This seems unreasonable.

3) We can flip the xy_data_array in the Matrix plot constructor.  This feels wrongish, it means making a copy of the array.

To me 1 seems the best choice, but I am not familiar enough with the Graphics object to be comfortable with it.

Hope this helps



---

archive/issue_comments_245881.json:
```json
{
    "body": "IMHO 3) is the right thing to do. Any hacks with setting xmin > xmax are just going to bite you later, e.g.\n\n```\nsage: matrix_plot(identity_matrix(4)) + plot(x)\n```\n\nhas arguably always been broken...",
    "created_at": "2015-05-21T23:13:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18226",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18226#issuecomment-245881",
    "user": "https://github.com/vbraun"
}
```

IMHO 3) is the right thing to do. Any hacks with setting xmin > xmax are just going to bite you later, e.g.

```
sage: matrix_plot(identity_matrix(4)) + plot(x)
```

has arguably always been broken...



---

archive/issue_comments_245882.json:
```json
{
    "body": "True but I don't know that anyone who implemented matrix plotting really expected it to be joined with any other plots.   Volker is probably right on this.",
    "created_at": "2015-05-22T01:52:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18226",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18226#issuecomment-245882",
    "user": "https://github.com/kcrisman"
}
```

True but I don't know that anyone who implemented matrix plotting really expected it to be joined with any other plots.   Volker is probably right on this.



---

archive/issue_comments_245883.json:
```json
{
    "body": "Y'all are of course correct.\n\nI have implemented a patch, but it is late and so I'll wait till I'm awake before pushing.\n\nI did notice that the handling of sparse matrices is weird: \n\n\n```\nsage: i = identity_matrix(10,sparse=True)\nsage: matrix_plot(i, aspect_ratio='automatic')\n```\n\n\nNot exactly wrong, but unexpected.  The reason I bring this up is that the `MatrixPlot` constructor accepts scipy sparse matrices in addition to things that act like lists of lists (the advertised interface).  These need to be flipped a bit differently, and while testing that I noticed that the display looked wrong.",
    "created_at": "2015-05-22T04:28:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18226",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18226#issuecomment-245883",
    "user": "https://github.com/deinst"
}
```

Y'all are of course correct.

I have implemented a patch, but it is late and so I'll wait till I'm awake before pushing.

I did notice that the handling of sparse matrices is weird: 


```
sage: i = identity_matrix(10,sparse=True)
sage: matrix_plot(i, aspect_ratio='automatic')
```


Not exactly wrong, but unexpected.  The reason I bring this up is that the `MatrixPlot` constructor accepts scipy sparse matrices in addition to things that act like lists of lists (the advertised interface).  These need to be flipped a bit differently, and while testing that I noticed that the display looked wrong.



---

archive/issue_comments_245884.json:
```json
{
    "body": "Looking through the `matplotlib` method of the `Graphics` object, I see that the `matplotlib` method expects `ymin > ymax` to occur.\n\nThe problem with flipping the data is that the default tick labels on the frame end up the reverse of what they should be.  It may be possible to get the ticks reversed simply while dealing with the possibility that the default ticks have been overridden in the options, but I don't see it.\n\nIn view of the `matplotlib` method, I'm leaning back in favor of option 1, just taking the absolute value of the `output_aspect`.",
    "created_at": "2015-05-22T15:34:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18226",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18226#issuecomment-245884",
    "user": "https://github.com/deinst"
}
```

Looking through the `matplotlib` method of the `Graphics` object, I see that the `matplotlib` method expects `ymin > ymax` to occur.

The problem with flipping the data is that the default tick labels on the frame end up the reverse of what they should be.  It may be possible to get the ticks reversed simply while dealing with the possibility that the default ticks have been overridden in the options, but I don't see it.

In view of the `matplotlib` method, I'm leaning back in favor of option 1, just taking the absolute value of the `output_aspect`.



---

archive/issue_comments_245885.json:
```json
{
    "body": "> Looking through the `matplotlib` method of the `Graphics` object, I see that the `matplotlib` method expects `ymin > ymax` to occur.\nOr rather, it allows for that case and then flips things, if I recall correctly.  \n>  This works but this leaves ymax < ymin ready to bite someone else who expects min < max.\nCan you give a concrete example of this kind of \"user error\"?  That might help us decide on an option.",
    "created_at": "2015-05-22T15:37:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18226",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18226#issuecomment-245885",
    "user": "https://github.com/kcrisman"
}
```

> Looking through the `matplotlib` method of the `Graphics` object, I see that the `matplotlib` method expects `ymin > ymax` to occur.
Or rather, it allows for that case and then flips things, if I recall correctly.  
>  This works but this leaves ymax < ymin ready to bite someone else who expects min < max.
Can you give a concrete example of this kind of "user error"?  That might help us decide on an option.



---

archive/issue_comments_245886.json:
```json
{
    "body": "Replying to [comment:8 kcrisman]:\n> > Looking through the `matplotlib` method of the `Graphics` object, I see that the `matplotlib` method expects `ymin > ymax` to occur.\n> Or rather, it allows for that case and then flips things, if I recall correctly.  \n\nYes, sort of.  If `ymax < ymin` the labels on the y axis will go from top to bottom.  Everything seems to work exactly as  if `ymin` and `ymax` were in the right order except that  (and the `_limit_output_aspect_ratio` method).\n\n> >  This works but this leaves ymax < ymin ready to bite someone else who expects min < max.\n> Can you give a concrete example of this kind of \"user error\"?  That might help us decide on an option.\n\nI did not mean a \"user error\", I meant a \"developer error\", identical to the error that precipitated this bug.  (As I suspect the set of most regular sage users overlaps considerably with the community of sage developers, this may only be a semantic difference.)  When I see two variables named `xmin` and `xmax`, I assume that `xmin < xmax` and program accordingly.\n\nI am not sure how all of this interacts with sums of plots, which was Volker's point.",
    "created_at": "2015-05-22T17:48:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18226",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18226#issuecomment-245886",
    "user": "https://github.com/deinst"
}
```

Replying to [comment:8 kcrisman]:
> > Looking through the `matplotlib` method of the `Graphics` object, I see that the `matplotlib` method expects `ymin > ymax` to occur.
> Or rather, it allows for that case and then flips things, if I recall correctly.  

Yes, sort of.  If `ymax < ymin` the labels on the y axis will go from top to bottom.  Everything seems to work exactly as  if `ymin` and `ymax` were in the right order except that  (and the `_limit_output_aspect_ratio` method).

> >  This works but this leaves ymax < ymin ready to bite someone else who expects min < max.
> Can you give a concrete example of this kind of "user error"?  That might help us decide on an option.

I did not mean a "user error", I meant a "developer error", identical to the error that precipitated this bug.  (As I suspect the set of most regular sage users overlaps considerably with the community of sage developers, this may only be a semantic difference.)  When I see two variables named `xmin` and `xmax`, I assume that `xmin < xmax` and program accordingly.

I am not sure how all of this interacts with sums of plots, which was Volker's point.



---

archive/issue_comments_245887.json:
```json
{
    "body": "Now that I dumped the code, I suspect that the flipping should be done in `_render_in_subplot`.  Oh, well.\n\nAnyway, this sort of works (the y axis labels are wrong), but it is better than collapsing the image to just the y-axis.\n----\nNew commits:",
    "created_at": "2015-05-22T18:50:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18226",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18226#issuecomment-245887",
    "user": "https://github.com/deinst"
}
```

Now that I dumped the code, I suspect that the flipping should be done in `_render_in_subplot`.  Oh, well.

Anyway, this sort of works (the y axis labels are wrong), but it is better than collapsing the image to just the y-axis.
----
New commits:



---

archive/issue_comments_245888.json:
```json
{
    "body": "The 2-d graphics stuff is in some pretty bad shape altogether, it defintitely needs to be refactored into something maintainable. Very high up in the list is some dedicated class for 2d boxes instead of passing a dictionary around and praying that nobody mutates it. That could also easily handle min/max vs left/right/top/bottom issues if we want to allow different orientations. Though AFAIK matplotlib only allows you to flip the overall axes, which seems like a better interface to me (i.e. have plot options to flip x and y axis)",
    "created_at": "2015-05-22T19:00:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18226",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18226#issuecomment-245888",
    "user": "https://github.com/vbraun"
}
```

The 2-d graphics stuff is in some pretty bad shape altogether, it defintitely needs to be refactored into something maintainable. Very high up in the list is some dedicated class for 2d boxes instead of passing a dictionary around and praying that nobody mutates it. That could also easily handle min/max vs left/right/top/bottom issues if we want to allow different orientations. Though AFAIK matplotlib only allows you to flip the overall axes, which seems like a better interface to me (i.e. have plot options to flip x and y axis)



---

archive/issue_comments_245889.json:
```json
{
    "body": "needs review?",
    "created_at": "2015-05-23T22:40:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18226",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18226#issuecomment-245889",
    "user": "https://github.com/vbraun"
}
```

needs review?



---

archive/issue_comments_245890.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-05-24T15:14:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18226",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18226#issuecomment-245890",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_245891.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-05-24T15:18:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18226",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18226#issuecomment-245891",
    "user": "https://github.com/deinst"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_245892.json:
```json
{
    "body": "Ok,  this is a cleaner way to do things.  The labels are still wrong unless you specify origin='lower'.  I'm going to put this to needs review even though it is only a partial fix.",
    "created_at": "2015-05-24T15:18:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18226",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18226#issuecomment-245892",
    "user": "https://github.com/deinst"
}
```

Ok,  this is a cleaner way to do things.  The labels are still wrong unless you specify origin='lower'.  I'm going to put this to needs review even though it is only a partial fix.



---

archive/issue_comments_245893.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2015-06-04T16:53:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18226",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18226#issuecomment-245893",
    "user": "https://github.com/williamstein"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_245894.json:
```json
{
    "body": "I'm getting random SageMathCloud users hitting this.  I applied this commit there, and also the code works and looks OK.",
    "created_at": "2015-06-04T17:28:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18226",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18226#issuecomment-245894",
    "user": "https://github.com/williamstein"
}
```

I'm getting random SageMathCloud users hitting this.  I applied this commit there, and also the code works and looks OK.



---

archive/issue_comments_245895.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-06-04T17:28:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18226",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18226#issuecomment-245895",
    "user": "https://github.com/williamstein"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_245896.json:
```json
{
    "body": "Are labels 'good enough', as comment:15 implies they might not be?",
    "created_at": "2015-06-04T17:37:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18226",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18226#issuecomment-245896",
    "user": "https://github.com/kcrisman"
}
```

Are labels 'good enough', as comment:15 implies they might not be?



---

archive/issue_comments_245897.json:
```json
{
    "body": "Replying to [comment:18 kcrisman]:\n> Are labels 'good enough', as comment:15 implies they might not be?\n\nThe labels on the tic marks on the y axis are the opposite of what they should be.  This might be irksome, but I suspect that most people would find it a minor annoyance, if they even notice, while having no matrix plot is a major annoyance.  It is worth filing another bug about the y axis labels, and I will do that.",
    "created_at": "2015-06-04T17:58:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18226",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18226#issuecomment-245897",
    "user": "https://github.com/deinst"
}
```

Replying to [comment:18 kcrisman]:
> Are labels 'good enough', as comment:15 implies they might not be?

The labels on the tic marks on the y axis are the opposite of what they should be.  This might be irksome, but I suspect that most people would find it a minor annoyance, if they even notice, while having no matrix plot is a major annoyance.  It is worth filing another bug about the y axis labels, and I will do that.



---

archive/issue_comments_245898.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2015-06-04T18:48:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18226",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18226#issuecomment-245898",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_245899.json:
```json
{
    "body": "Reviewer name is missing",
    "created_at": "2015-06-04T18:48:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18226",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18226#issuecomment-245899",
    "user": "https://github.com/vbraun"
}
```

Reviewer name is missing



---

archive/issue_comments_245900.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2015-06-04T18:50:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18226",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18226#issuecomment-245900",
    "user": "https://github.com/williamstein"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_245901.json:
```json
{
    "body": "> > Are labels 'good enough', as comment:15 implies they might not be?\n> \n> The labels on the tic marks on the y axis are the opposite of what they should be.  This might be irksome, but I suspect that most people would find it a minor annoyance, if they even notice, while having no matrix plot is a major annoyance.  It is worth filing another bug about the y axis labels, and I will do that.\n\nAs it happens, this is then a regression too.  I actually do use matrix plots in class relatively often, and it's critically important that the y axes are labeled correctly (I'm not making it up!).  Please cc: me on that new ticket and make it a blocker or critical too - I have not had time to look at this ticket properly but next week can set aside some time to look at that.",
    "created_at": "2015-06-04T21:07:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18226",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18226#issuecomment-245901",
    "user": "https://github.com/kcrisman"
}
```

> > Are labels 'good enough', as comment:15 implies they might not be?
> 
> The labels on the tic marks on the y axis are the opposite of what they should be.  This might be irksome, but I suspect that most people would find it a minor annoyance, if they even notice, while having no matrix plot is a major annoyance.  It is worth filing another bug about the y axis labels, and I will do that.

As it happens, this is then a regression too.  I actually do use matrix plots in class relatively often, and it's critically important that the y axes are labeled correctly (I'm not making it up!).  Please cc: me on that new ticket and make it a blocker or critical too - I have not had time to look at this ticket properly but next week can set aside some time to look at that.



---

archive/issue_events_017467.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-06-04T22:46:24Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/18226",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18226#event-17467"
}
```



---

archive/issue_comments_245902.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-06-04T22:46:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18226",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18226#issuecomment-245902",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_245903.json:
```json
{
    "body": "For reference: #18612 is the followup ticket.",
    "created_at": "2015-06-22T20:56:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18226",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18226#issuecomment-245903",
    "user": "https://github.com/kcrisman"
}
```

For reference: #18612 is the followup ticket.
