# Issue 18226: matrix_plot broken in Sage 6.7

Issue created by migration from https://trac.sagemath.org/ticket/18463

Original creator: jhpalmieri

Original creation time: 2015-05-21 01:45:47

CC:  kcrisman

The command `matrix_plot(identity_matrix(3))` does not work in Sage 6.7: it produces just a vertical axis. See https://groups.google.com/d/msg/sage-support/mDaQWuqi9bg/g571Ij8_C8kJ.


---

Comment by deinst created at 2015-05-21 22:13:35

Ok, the root of the problem is in the `get_minmax_data` method of `MatrixPlot`.  This deliberately flips the y axis so that "the picture looks correct.", but it confounds the `_limit_output_aspect_ratio` method of `Graphics` which expects ymax-ymin to be positive.  I see a bunch of choices

1) We can have `output_aspect` be the absolute value of what it is now.  This works but this leaves `ymax < ymin` ready to bite someone else who expects min < max.

2) We can display matrices upside down.  This seems unreasonable.

3) We can flip the xy_data_array in the Matrix plot constructor.  This feels wrongish, it means making a copy of the array.

To me 1 seems the best choice, but I am not familiar enough with the Graphics object to be comfortable with it.

Hope this helps


---

Comment by vbraun created at 2015-05-21 23:13:20

IMHO 3) is the right thing to do. Any hacks with setting xmin > xmax are just going to bite you later, e.g.

```
sage: matrix_plot(identity_matrix(4)) + plot(x)
```

has arguably always been broken...


---

Comment by kcrisman created at 2015-05-22 01:52:25

True but I don't know that anyone who implemented matrix plotting really expected it to be joined with any other plots.   Volker is probably right on this.


---

Comment by deinst created at 2015-05-22 04:28:25

Y'all are of course correct.

I have implemented a patch, but it is late and so I'll wait till I'm awake before pushing.

I did notice that the handling of sparse matrices is weird: 


```
sage: i = identity_matrix(10,sparse=True)
sage: matrix_plot(i, aspect_ratio='automatic')
```


Not exactly wrong, but unexpected.  The reason I bring this up is that the `MatrixPlot` constructor accepts scipy sparse matrices in addition to things that act like lists of lists (the advertised interface).  These need to be flipped a bit differently, and while testing that I noticed that the display looked wrong.


---

Comment by deinst created at 2015-05-22 15:34:14

Looking through the `matplotlib` method of the `Graphics` object, I see that the `matplotlib` method expects `ymin > ymax` to occur.

The problem with flipping the data is that the default tick labels on the frame end up the reverse of what they should be.  It may be possible to get the ticks reversed simply while dealing with the possibility that the default ticks have been overridden in the options, but I don't see it.

In view of the `matplotlib` method, I'm leaning back in favor of option 1, just taking the absolute value of the `output_aspect`.


---

Comment by kcrisman created at 2015-05-22 15:37:18

> Looking through the `matplotlib` method of the `Graphics` object, I see that the `matplotlib` method expects `ymin > ymax` to occur.
Or rather, it allows for that case and then flips things, if I recall correctly.  
>  This works but this leaves ymax < ymin ready to bite someone else who expects min < max.
Can you give a concrete example of this kind of "user error"?  That might help us decide on an option.


---

Comment by deinst created at 2015-05-22 17:48:22

Replying to [comment:8 kcrisman]:
> > Looking through the `matplotlib` method of the `Graphics` object, I see that the `matplotlib` method expects `ymin > ymax` to occur.
> Or rather, it allows for that case and then flips things, if I recall correctly.  

Yes, sort of.  If `ymax < ymin` the labels on the y axis will go from top to bottom.  Everything seems to work exactly as  if `ymin` and `ymax` were in the right order except that  (and the `_limit_output_aspect_ratio` method).

> >  This works but this leaves ymax < ymin ready to bite someone else who expects min < max.
> Can you give a concrete example of this kind of "user error"?  That might help us decide on an option.

I did not mean a "user error", I meant a "developer error", identical to the error that precipitated this bug.  (As I suspect the set of most regular sage users overlaps considerably with the community of sage developers, this may only be a semantic difference.)  When I see two variables named `xmin` and `xmax`, I assume that `xmin < xmax` and program accordingly.

I am not sure how all of this interacts with sums of plots, which was Volker's point.


---

Comment by deinst created at 2015-05-22 18:50:06

Now that I dumped the code, I suspect that the flipping should be done in `_render_in_subplot`.  Oh, well.

Anyway, this sort of works (the y axis labels are wrong), but it is better than collapsing the image to just the y-axis.
----
New commits:


---

Comment by vbraun created at 2015-05-22 19:00:52

The 2-d graphics stuff is in some pretty bad shape altogether, it defintitely needs to be refactored into something maintainable. Very high up in the list is some dedicated class for 2d boxes instead of passing a dictionary around and praying that nobody mutates it. That could also easily handle min/max vs left/right/top/bottom issues if we want to allow different orientations. Though AFAIK matplotlib only allows you to flip the overall axes, which seems like a better interface to me (i.e. have plot options to flip x and y axis)


---

Comment by vbraun created at 2015-05-23 22:40:01

needs review?


---

Comment by git created at 2015-05-24 15:14:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by deinst created at 2015-05-24 15:18:50

Changing status from new to needs_review.


---

Comment by deinst created at 2015-05-24 15:18:50

Ok,  this is a cleaner way to do things.  The labels are still wrong unless you specify origin='lower'.  I'm going to put this to needs review even though it is only a partial fix.


---

Comment by was created at 2015-06-04 16:53:43

Changing priority from critical to blocker.


---

Comment by was created at 2015-06-04 17:28:29

I'm getting random SageMathCloud users hitting this.  I applied this commit there, and also the code works and looks OK.


---

Comment by was created at 2015-06-04 17:28:29

Changing status from needs_review to positive_review.


---

Comment by kcrisman created at 2015-06-04 17:37:22

Are labels 'good enough', as comment:15 implies they might not be?


---

Comment by deinst created at 2015-06-04 17:58:20

Replying to [comment:18 kcrisman]:
> Are labels 'good enough', as comment:15 implies they might not be?

The labels on the tic marks on the y axis are the opposite of what they should be.  This might be irksome, but I suspect that most people would find it a minor annoyance, if they even notice, while having no matrix plot is a major annoyance.  It is worth filing another bug about the y axis labels, and I will do that.


---

Comment by vbraun created at 2015-06-04 18:48:21

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2015-06-04 18:48:21

Reviewer name is missing


---

Comment by was created at 2015-06-04 18:50:41

Changing status from needs_work to positive_review.


---

Comment by kcrisman created at 2015-06-04 21:07:34

> > Are labels 'good enough', as comment:15 implies they might not be?
> 
> The labels on the tic marks on the y axis are the opposite of what they should be.  This might be irksome, but I suspect that most people would find it a minor annoyance, if they even notice, while having no matrix plot is a major annoyance.  It is worth filing another bug about the y axis labels, and I will do that.

As it happens, this is then a regression too.  I actually do use matrix plots in class relatively often, and it's critically important that the y axes are labeled correctly (I'm not making it up!).  Please cc: me on that new ticket and make it a blocker or critical too - I have not had time to look at this ticket properly but next week can set aside some time to look at that.


---

Comment by vbraun created at 2015-06-04 22:46:24

Resolution: fixed


---

Comment by kcrisman created at 2015-06-22 20:56:42

For reference: #18612 is the followup ticket.
