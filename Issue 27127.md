# Issue 27127: cannot multiply multivariate polynomial ring and vector

archive/issues_027127.json:
```json
{
    "body": "CC:  tscrim yzh @kliem\n\n\n```\nsage: R = PolynomialRing(QQ, 't', 1); t = R.gen()\nsage: (t/2) * vector([1,2])\n```\n\nresults in a\n\n```\nTypeError: unsupported operand parent(s) for *: 'Multivariate Polynomial Ring in t over Rational Field' and 'Ambient free module of rank 2 over the principal ideal domain Integer Ring'\n```\n\n\nInterestingly, for a \"true\" univariate polynomial ring it works:\n\n```\nsage: (t/2) * vector([1,2])\n(1/2*t, t)\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/27364\n\n",
    "created_at": "2019-02-26T14:14:17Z",
    "labels": [
        "coercion",
        "major",
        "bug"
    ],
    "title": "cannot multiply multivariate polynomial ring and vector",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27127",
    "user": "dkrenn"
}
```
CC:  tscrim yzh @kliem


```
sage: R = PolynomialRing(QQ, 't', 1); t = R.gen()
sage: (t/2) * vector([1,2])
```

results in a

```
TypeError: unsupported operand parent(s) for *: 'Multivariate Polynomial Ring in t over Rational Field' and 'Ambient free module of rank 2 over the principal ideal domain Integer Ring'
```


Interestingly, for a "true" univariate polynomial ring it works:

```
sage: (t/2) * vector([1,2])
(1/2*t, t)
```


Issue created by migration from https://trac.sagemath.org/ticket/27364





---

archive/issue_comments_382077.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2019-02-28T12:39:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27127#issuecomment-382077",
    "user": "dkrenn"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_382078.json:
```json
{
    "body": "Current fix indeed fixes the problem but introduces new problems:\n\n```\nsage: R = PolynomialRing(ZZ, 'x', 500)\nsage: S = PolynomialRing(GF(5), 'x', 200)\nsage: R.gen(0) + S.gen(0)\n```\n\nThe last line takes a second or so without patch, but ages (I've\ninterrupted after two minutes) with the change above. RunSnakeRun says\nthat most of the time is spent in\n\n```\nmethod '_coerce_' of 'sage.structure.parent_old.Parent'\n```\n\nThis is also not what we'd like. So what should we do now?\n----\nNew commits:",
    "created_at": "2019-02-28T12:39:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27127#issuecomment-382078",
    "user": "dkrenn"
}
```

Current fix indeed fixes the problem but introduces new problems:

```
sage: R = PolynomialRing(ZZ, 'x', 500)
sage: S = PolynomialRing(GF(5), 'x', 200)
sage: R.gen(0) + S.gen(0)
```

The last line takes a second or so without patch, but ages (I've
interrupted after two minutes) with the change above. RunSnakeRun says
that most of the time is spent in

```
method '_coerce_' of 'sage.structure.parent_old.Parent'
```

This is also not what we'd like. So what should we do now?
----
New commits:



---

archive/issue_comments_382079.json:
```json
{
    "body": "Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)",
    "created_at": "2019-03-25T10:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27127#issuecomment-382079",
    "user": "embray"
}
```

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)



---

archive/issue_comments_382080.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-03-28T13:57:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27127#issuecomment-382080",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_382081.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2019-03-28T13:58:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27127#issuecomment-382081",
    "user": "dkrenn"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_382082.json:
```json
{
    "body": "Replying to [comment:5 dkrenn]:\n> RunSnakeRun says\n> that most of the time is spent in\n> {{{\n> method '_coerce_' of 'sage.structure.parent_old.Parent'\n> }}}\n> This is also not what we'd like. So what should we do now?\n\nThe current branch patches `__call__` so that `_coerce_` is not called that often. #25558 might change everything, but this seems somehow more out of reach.",
    "created_at": "2019-03-28T13:59:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27127#issuecomment-382082",
    "user": "dkrenn"
}
```

Replying to [comment:5 dkrenn]:
> RunSnakeRun says
> that most of the time is spent in
> {{{
> method '_coerce_' of 'sage.structure.parent_old.Parent'
> }}}
> This is also not what we'd like. So what should we do now?

The current branch patches `__call__` so that `_coerce_` is not called that often. #25558 might change everything, but this seems somehow more out of reach.



---

archive/issue_comments_382083.json:
```json
{
    "body": "\n```\n+            #from sage.structure.element import parent\n+            #print(self, '__call__')\n+            #print('    ', x, parent(x))\n```\n",
    "created_at": "2019-04-18T20:23:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27127#issuecomment-382083",
    "user": "vdelecroix"
}
```


```
+            #from sage.structure.element import parent
+            #print(self, '__call__')
+            #print('    ', x, parent(x))
```




---

archive/issue_comments_382084.json:
```json
{
    "body": "As far as I understand, zero and one are already cached from `sage/rings/rings.py`\n\n```\nsage: R = QQ['x','y']\nsage: R.zero() is R.zero()\nTrue\nsage: R.one() is R.one()\nTrue\n```\n",
    "created_at": "2019-04-18T20:24:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27127#issuecomment-382084",
    "user": "vdelecroix"
}
```

As far as I understand, zero and one are already cached from `sage/rings/rings.py`

```
sage: R = QQ['x','y']
sage: R.zero() is R.zero()
True
sage: R.one() is R.one()
True
```




---

archive/issue_comments_382085.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-04-18T20:25:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27127#issuecomment-382085",
    "user": "vdelecroix"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_382086.json:
```json
{
    "body": "Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).",
    "created_at": "2019-06-14T14:50:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27127#issuecomment-382086",
    "user": "embray"
}
```

Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).



---

archive/issue_comments_382087.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2019-12-30T14:48:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27127#issuecomment-382087",
    "user": "embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_comments_382088.json:
```json
{
    "body": "Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.",
    "created_at": "2020-04-14T19:41:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27127#issuecomment-382088",
    "user": "mkoeppe"
}
```

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.



---

archive/issue_comments_382089.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27127#issuecomment-382089",
    "user": "mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_382090.json:
```json
{
    "body": "Clean merge with current develop\n----\nNew commits:",
    "created_at": "2021-04-13T17:25:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27127#issuecomment-382090",
    "user": "mkoeppe"
}
```

Clean merge with current develop
----
New commits:



---

archive/issue_comments_382091.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-13T17:29:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27127#issuecomment-382091",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_382092.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-04-13T18:01:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27127#issuecomment-382092",
    "user": "mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_382093.json:
```json
{
    "body": "Replying to [comment:11 vdelecroix]:\n> As far as I understand, zero and one are already cached from `sage/rings/rings.py`\n> {{{\n> sage: R = QQ['x','y']\n> sage: R.zero() is R.zero()\n> True\n> sage: R.one() is R.one()\n> True\n> }}}\n\nNevertheless, this code for caching 0 and 1 does make things a bit faster.\nOn my machine, `%time R.gen(0) + S.gen(0)` gives 9.6 s, but taking out the caching it's 12.6 s.",
    "created_at": "2021-04-13T18:01:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27127#issuecomment-382093",
    "user": "mkoeppe"
}
```

Replying to [comment:11 vdelecroix]:
> As far as I understand, zero and one are already cached from `sage/rings/rings.py`
> {{{
> sage: R = QQ['x','y']
> sage: R.zero() is R.zero()
> True
> sage: R.one() is R.one()
> True
> }}}

Nevertheless, this code for caching 0 and 1 does make things a bit faster.
On my machine, `%time R.gen(0) + S.gen(0)` gives 9.6 s, but taking out the caching it's 12.6 s.



---

archive/issue_comments_382094.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-04-15T07:41:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27127#issuecomment-382094",
    "user": "vdelecroix"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_382095.json:
```json
{
    "body": "There are several doctest failures. Among them we see that the pushout **wrongly** changes some `Univariate` to `Multivariate`.\n\n```\nFile \"src/sage/categories/pushout.py\", line 3772, in sage.categories.pushout.pushout\nFailed example:\n    pushout(ZZ['x,y,z'], Frac(ZZ['x'])['y'])\nExpected:\n    Multivariate Polynomial Ring in y, z over Fraction Field of Univariate Polynomial Ring in x over Integer Ring\nGot:\n    Multivariate Polynomial Ring in y, z over Fraction Field of Multivariate Polynomial Ring in x over Integer Ring\n```\n\nAbove the action of `ZZ[x,y,z]` on `ZZ(x)[y]` is `ZZ(x)[y,z]` in both situations. However, I think that the `ZZ(x)` **must not** change. It would be good to test this pushout with `ZZ(x)` in different forms\n- univariate `PolynomialRing(ZZ, 'x')`\n- univariate NTL `PolynomialRing(ZZ, 'x', implementation='NTL')`\n- multivariate `PolynomialRing(ZZ, ['x'], 1))`.\n\nIn this second example it is unclear what is best.\n\n```\nFile \"src/sage/categories/pushout.py\", line 3778, in sage.categories.pushout.pushout\nFailed example:\n    pushout(QQ['x,y'], ZZ[['x']])\nExpected:\n    Univariate Polynomial Ring in y over Power Series Ring in x over Rational Field\nGot:\n    Multivariate Polynomial Ring in y over Power Series Ring in x over Rational Field\n```\n\nThe action of `QQ[x,y]` on `ZZ[This is the Trac macro *x* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#x-macro)` does correctly produce `QQ[y][This is the Trac macro *x* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#x-macro)` in both situations. Since `QQ[x,y] -> QQ[y]` drops a variable it is unclear to me if there is a best answer.",
    "created_at": "2021-04-15T07:41:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27127#issuecomment-382095",
    "user": "vdelecroix"
}
```

There are several doctest failures. Among them we see that the pushout **wrongly** changes some `Univariate` to `Multivariate`.

```
File "src/sage/categories/pushout.py", line 3772, in sage.categories.pushout.pushout
Failed example:
    pushout(ZZ['x,y,z'], Frac(ZZ['x'])['y'])
Expected:
    Multivariate Polynomial Ring in y, z over Fraction Field of Univariate Polynomial Ring in x over Integer Ring
Got:
    Multivariate Polynomial Ring in y, z over Fraction Field of Multivariate Polynomial Ring in x over Integer Ring
```

Above the action of `ZZ[x,y,z]` on `ZZ(x)[y]` is `ZZ(x)[y,z]` in both situations. However, I think that the `ZZ(x)` **must not** change. It would be good to test this pushout with `ZZ(x)` in different forms
- univariate `PolynomialRing(ZZ, 'x')`
- univariate NTL `PolynomialRing(ZZ, 'x', implementation='NTL')`
- multivariate `PolynomialRing(ZZ, ['x'], 1))`.

In this second example it is unclear what is best.

```
File "src/sage/categories/pushout.py", line 3778, in sage.categories.pushout.pushout
Failed example:
    pushout(QQ['x,y'], ZZ[['x']])
Expected:
    Univariate Polynomial Ring in y over Power Series Ring in x over Rational Field
Got:
    Multivariate Polynomial Ring in y over Power Series Ring in x over Rational Field
```

The action of `QQ[x,y]` on `ZZ[This is the Trac macro *x* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#x-macro)` does correctly produce `QQ[y][This is the Trac macro *x* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#x-macro)` in both situations. Since `QQ[x,y] -> QQ[y]` drops a variable it is unclear to me if there is a best answer.



---

archive/issue_comments_382096.json:
```json
{
    "body": "Related: it is desirable that the string representation of multivariate polynomial rings make visible the implementation. Currently we have\n\n```\nsage: PolynomialRing(ZZ, ['x', 'y'], 2, implementation='generic')\nMultivariate Polynomial Ring in x, y over Integer Ring\nsage: PolynomialRing(ZZ, ['x', 'y'], 2, implementation='singular')\nMultivariate Polynomial Ring in x, y over Integer Ring\n```\n\nBut it would be better as\n\n```\nsage: PolynomialRing(ZZ, ['x', 'y'], 2, implementation='generic')\nMultivariate Polynomial Ring in x, y over Integer Ring (using generic implementation)\nsage: PolynomialRing(ZZ, ['x', 'y'], 2, implementation='singular')\nMultivariate Polynomial Ring in x, y over Integer Ring\n```\n\nIdeally (as for univariate polynomials and matrices) the default implementation would show nothing.",
    "created_at": "2021-04-15T07:50:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27127#issuecomment-382096",
    "user": "vdelecroix"
}
```

Related: it is desirable that the string representation of multivariate polynomial rings make visible the implementation. Currently we have

```
sage: PolynomialRing(ZZ, ['x', 'y'], 2, implementation='generic')
Multivariate Polynomial Ring in x, y over Integer Ring
sage: PolynomialRing(ZZ, ['x', 'y'], 2, implementation='singular')
Multivariate Polynomial Ring in x, y over Integer Ring
```

But it would be better as

```
sage: PolynomialRing(ZZ, ['x', 'y'], 2, implementation='generic')
Multivariate Polynomial Ring in x, y over Integer Ring (using generic implementation)
sage: PolynomialRing(ZZ, ['x', 'y'], 2, implementation='singular')
Multivariate Polynomial Ring in x, y over Integer Ring
```

Ideally (as for univariate polynomials and matrices) the default implementation would show nothing.



---

archive/issue_comments_382097.json:
```json
{
    "body": "The construction functor should take into account the implementation. Please fix and add the doctest\n\n```\nsage: TT = PolynomialRing(QQ, 't', 2, implementation='generic')\nsage: F, R = TT.construction()\nsage: F(R) is TT  # bug: returns False\nTrue\n```\n",
    "created_at": "2021-04-15T07:51:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27127#issuecomment-382097",
    "user": "vdelecroix"
}
```

The construction functor should take into account the implementation. Please fix and add the doctest

```
sage: TT = PolynomialRing(QQ, 't', 2, implementation='generic')
sage: F, R = TT.construction()
sage: F(R) is TT  # bug: returns False
True
```




---

archive/issue_comments_382098.json:
```json
{
    "body": "The construction is similarly broken on univariate polynomials\n\n```\nsage: T = PolynomialRing(ZZ, 'x')\nsage: F, R = T.construction()\nsage: F(R) is T\nTrue\nsage: T = PolynomialRing(ZZ, 'x', implementation='NTL')\nsage: F, R = T.construction()\nsage: F(R) is T  # bug: returns False\nTrue\n```\n",
    "created_at": "2021-04-15T07:55:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27127#issuecomment-382098",
    "user": "vdelecroix"
}
```

The construction is similarly broken on univariate polynomials

```
sage: T = PolynomialRing(ZZ, 'x')
sage: F, R = T.construction()
sage: F(R) is T
True
sage: T = PolynomialRing(ZZ, 'x', implementation='NTL')
sage: F, R = T.construction()
sage: F(R) is T  # bug: returns False
True
```




---

archive/issue_comments_382099.json:
```json
{
    "body": "#31668 is adding lots of these tests via the `_test_construction` method.",
    "created_at": "2021-04-15T15:30:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27127#issuecomment-382099",
    "user": "mkoeppe"
}
```

#31668 is adding lots of these tests via the `_test_construction` method.



---

archive/issue_comments_382100.json:
```json
{
    "body": "Replying to [comment:29 mkoeppe]:\n> #31668 is adding lots of these tests via the `_test_construction` method.\n\nnice!",
    "created_at": "2021-04-15T15:32:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27127#issuecomment-382100",
    "user": "vdelecroix"
}
```

Replying to [comment:29 mkoeppe]:
> #31668 is adding lots of these tests via the `_test_construction` method.

nice!



---

archive/issue_comments_382101.json:
```json
{
    "body": "Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27127#issuecomment-382101",
    "user": "mkoeppe"
}
```

Setting a new milestone for this ticket based on a cursory review.
