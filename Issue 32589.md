# Issue 32589: scalar-multiplication endomorphisms of elliptic curves

archive/issues_032589.json:
```json
{
    "body": "CC:  @defeo @JohnCremona @tscrim @videlec @fchapoton @kwankyu\n\nThis ticket will add `EllipticCurveHom_scalar`, a new class encapsulating scalar multiplications on elliptic curves. This serves two main purposes:\n\n1. It solves one of the motivations behind #8014 (faster `multiplication_by_m_isogeny`).\n2. Wrapping scalar multiplications as an `EllipticCurveHom` is an important step towards implementing endomorphism rings (see #7368).\n\nIssue created by migration from https://trac.sagemath.org/ticket/32826\n\n",
    "created_at": "2021-11-05T06:14:29Z",
    "labels": [
        "component: elliptic curves"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "scalar-multiplication endomorphisms of elliptic curves",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32589",
    "user": "https://github.com/yyyyx4"
}
```
CC:  @defeo @JohnCremona @tscrim @videlec @fchapoton @kwankyu

This ticket will add `EllipticCurveHom_scalar`, a new class encapsulating scalar multiplications on elliptic curves. This serves two main purposes:

1. It solves one of the motivations behind #8014 (faster `multiplication_by_m_isogeny`).
2. Wrapping scalar multiplications as an `EllipticCurveHom` is an important step towards implementing endomorphism rings (see #7368).

Issue created by migration from https://trac.sagemath.org/ticket/32826





---

archive/issue_comments_464215.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-11-05T06:33:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32589#issuecomment-464215",
    "user": "https://github.com/yyyyx4"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_464216.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2021-11-05T06:33:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32589#issuecomment-464216",
    "user": "https://github.com/yyyyx4"
}
```

Last 10 new commits:



---

archive/issue_comments_464217.json:
```json
{
    "body": "This is a great idea.  Why not just call these endomorphisms, i.e. call the class something like EllipticCurveEndomorphism instead of EllipticCurveHom_scalar?  I don' know if there is a plan to late include more general endomorphisms (CM in char. 0, and both the ordinary and supersingular possibilities in char.p), but even if we are not going to implement those now, we could set it up to that the class EllipticCurveEndomorphism exists and (say) EllipticCurveScalarEndomorphism is a subclass doing what this class EllipticCurveHom_scalar does.",
    "created_at": "2021-11-05T09:29:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32589#issuecomment-464217",
    "user": "https://github.com/JohnCremona"
}
```

This is a great idea.  Why not just call these endomorphisms, i.e. call the class something like EllipticCurveEndomorphism instead of EllipticCurveHom_scalar?  I don' know if there is a plan to late include more general endomorphisms (CM in char. 0, and both the ordinary and supersingular possibilities in char.p), but even if we are not going to implement those now, we could set it up to that the class EllipticCurveEndomorphism exists and (say) EllipticCurveScalarEndomorphism is a subclass doing what this class EllipticCurveHom_scalar does.



---

archive/issue_comments_464218.json:
```json
{
    "body": "Thank you, that's a very good remark! I can see that there are several ways to \"slice up\" the space of objects we're trying to model here. My reasoning was the following (very much up for discussion):\n\n- There's no real reason to separate isogenies and endomorphisms at this level \u2014 they can all be child classes of `EllipticCurveHom` with a common interface. Some `EllipticCurveHom`s are of course endomorphisms, but we don't have to treat them specially. (Note: `.is_endomorphism()` already works.)\n- On the level of those maps, we can easily implement formal compositions (#32744) and sums (to be done). Multiplication in the endomorphism ring \"just works\", as does composing endomorphisms with isogenies (thus, we prevent incompatibilities like we've been having with isomorphisms; cf. #32388, #32502).\n- The parent object of any `EllipticCurveHom` should be a hom-module that knows about the domain and codomain curve, regardless of what kind of `EllipticCurveHom` implementation it is. Of course, some of those hom-modules will be closed under composition, but again we don't have to do anything special here. (Side effect: Composing isogenies `E -> E' -> E` won't require any special treatment either.)\n- Now, none of these objects knows a lot about its own structure. This mandates the last ingredient: An `EndomorphismRing` object that encapsulates both the algebraic view of an endomorphism ring (i.e., a quadratic order or a quaternion order) *and* a mapping of the generators of that abstract ring to explicit `EllipticCurveHom`s. With that, we can first use all the tools available for quadratic fields and quaternion algebras in the abstract world, then \"project down\" the situation to the corresponding maps on curves. (At least in principle, it should be possible to handle these translations almost seamlessly by overloading some methods.)\n- Note that such a ring of endomorphisms need not be *the* (full) ring of endomorphisms: Subrings that could prove useful (especially for big instances where we cannot always compute the full endomorphism ring) include the Frobenius order, or some rank-2 subring of a quaternionic endomorphism ring.\n\nI imagine that this design will make it *relatively* straightforward to implement things like computing endomorphism rings (#31851), or embedding a bunch of explicitly given `EllipticCurveHom`s into an abstract quadratic or quaternionic order to see the relations between them.\n\nLet me know if this makes sense. :-)",
    "created_at": "2021-11-05T15:53:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32589#issuecomment-464218",
    "user": "https://github.com/yyyyx4"
}
```

Thank you, that's a very good remark! I can see that there are several ways to "slice up" the space of objects we're trying to model here. My reasoning was the following (very much up for discussion):

- There's no real reason to separate isogenies and endomorphisms at this level — they can all be child classes of `EllipticCurveHom` with a common interface. Some `EllipticCurveHom`s are of course endomorphisms, but we don't have to treat them specially. (Note: `.is_endomorphism()` already works.)
- On the level of those maps, we can easily implement formal compositions (#32744) and sums (to be done). Multiplication in the endomorphism ring "just works", as does composing endomorphisms with isogenies (thus, we prevent incompatibilities like we've been having with isomorphisms; cf. #32388, #32502).
- The parent object of any `EllipticCurveHom` should be a hom-module that knows about the domain and codomain curve, regardless of what kind of `EllipticCurveHom` implementation it is. Of course, some of those hom-modules will be closed under composition, but again we don't have to do anything special here. (Side effect: Composing isogenies `E -> E' -> E` won't require any special treatment either.)
- Now, none of these objects knows a lot about its own structure. This mandates the last ingredient: An `EndomorphismRing` object that encapsulates both the algebraic view of an endomorphism ring (i.e., a quadratic order or a quaternion order) *and* a mapping of the generators of that abstract ring to explicit `EllipticCurveHom`s. With that, we can first use all the tools available for quadratic fields and quaternion algebras in the abstract world, then "project down" the situation to the corresponding maps on curves. (At least in principle, it should be possible to handle these translations almost seamlessly by overloading some methods.)
- Note that such a ring of endomorphisms need not be *the* (full) ring of endomorphisms: Subrings that could prove useful (especially for big instances where we cannot always compute the full endomorphism ring) include the Frobenius order, or some rank-2 subring of a quaternionic endomorphism ring.

I imagine that this design will make it *relatively* straightforward to implement things like computing endomorphism rings (#31851), or embedding a bunch of explicitly given `EllipticCurveHom`s into an abstract quadratic or quaternionic order to see the relations between them.

Let me know if this makes sense. :-)



---

archive/issue_comments_464219.json:
```json
{
    "body": "It makes perfect sense -- I am very happy to see all this being implemented (or at least some of it), and not by me!",
    "created_at": "2021-11-05T16:22:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32589#issuecomment-464219",
    "user": "https://github.com/JohnCremona"
}
```

It makes perfect sense -- I am very happy to see all this being implemented (or at least some of it), and not by me!



---

archive/issue_events_086816.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:53:12Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32589",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32589#event-86816"
}
```



---

archive/issue_comments_464220.json:
```json
{
    "body": "Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.",
    "created_at": "2021-12-18T19:53:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32589#issuecomment-464220",
    "user": "https://github.com/mkoeppe"
}
```

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.



---

archive/issue_comments_464221.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-21T08:07:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32589#issuecomment-464221",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_464222.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-21T11:20:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32589#issuecomment-464222",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_464223.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-26T05:36:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32589#issuecomment-464223",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_464224.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-21T05:54:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32589#issuecomment-464224",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_events_086817.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-17T19:59:27Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32589",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32589#event-86817"
}
```



---

archive/issue_events_086818.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-17T19:59:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32589",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32589#event-86818"
}
```



---

archive/issue_comments_464225.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-05-17T07:28:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32589#issuecomment-464225",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_464226.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-05-23T08:33:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32589#issuecomment-464226",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_464227.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-07-26T14:10:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32589#issuecomment-464227",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_events_086819.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32589",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32589#event-86819"
}
```



---

archive/issue_events_086820.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32589",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32589#event-86820"
}
```



---

archive/issue_comments_464228.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-25T10:22:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32589#issuecomment-464228",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_464229.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-10-17T15:59:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32589#issuecomment-464229",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_464230.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-10-17T21:26:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32589#issuecomment-464230",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_464231.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-11-08T14:53:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32589#issuecomment-464231",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_464232.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-12-21T08:30:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32589#issuecomment-464232",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_464233.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-12-22T05:39:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32589#issuecomment-464233",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_464234.json:
```json
{
    "body": "I've been constantly rebasing this branch for more than a year now\u2009\u2014\u2009not trying to be annoying, but is there a chance we could finally get it merged?\n\nI'd like to build more functionality on top of this (and #33915), but dragging around a bunch of unmerged tickets as dependencies slows down any development effort considerably.",
    "created_at": "2022-12-22T05:55:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32589#issuecomment-464234",
    "user": "https://github.com/yyyyx4"
}
```

I've been constantly rebasing this branch for more than a year now — not trying to be annoying, but is there a chance we could finally get it merged?

I'd like to build more functionality on top of this (and #33915), but dragging around a bunch of unmerged tickets as dependencies slows down any development effort considerably.



---

archive/issue_comments_464235.json:
```json
{
    "body": "I see that I looked at this in some detail a year ago, so I will do so again.",
    "created_at": "2022-12-22T09:02:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32589#issuecomment-464235",
    "user": "https://github.com/JohnCremona"
}
```

I see that I looked at this in some detail a year ago, so I will do so again.



---

archive/issue_comments_464236.json:
```json
{
    "body": "Some minor (and quick) suggestions, as this looks very good.\n\nIn the `scaling_factor()` method you return `self._m` which is an integer (in ZZ), but I think you should coerce it into the base field.\n\nHaving done this you can simplify `is_separable()` and `is_injective()` to a check that `scaling_factor()` is nonzero.  For this reason it might be a good idea to store the image of m in the base field as well as m itself, on construction.\n\nDo this and you'll get a positive review!",
    "created_at": "2022-12-22T09:19:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32589#issuecomment-464236",
    "user": "https://github.com/JohnCremona"
}
```

Some minor (and quick) suggestions, as this looks very good.

In the `scaling_factor()` method you return `self._m` which is an integer (in ZZ), but I think you should coerce it into the base field.

Having done this you can simplify `is_separable()` and `is_injective()` to a check that `scaling_factor()` is nonzero.  For this reason it might be a good idea to store the image of m in the base field as well as m itself, on construction.

Do this and you'll get a positive review!



---

archive/issue_comments_464237.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-12-22T09:45:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32589#issuecomment-464237",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_464238.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-12-22T10:00:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32589#issuecomment-464238",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_464239.json:
```json
{
    "body": "Thanks a lot for reviewing this (indeed rather long) patch!\n\nReplying to [comment:26 John Cremona]:\n> In the `scaling_factor()` method you return `self._m` which is an integer (in ZZ), but I think you should coerce it into the base field.\n\n\nIndeed, well spotted.\n\n> Having done this you can simplify `is_separable()` and `is_injective()` to a check that `scaling_factor()` is nonzero.\n\n\nI agree for `.is_separable()`, but it seems that `.is_injective()` is not expressible in terms of the scaling factor alone: For supersingular curves `[p]` is purely inseparable (i.e., injective), but `[kp]` has nontrivial kernel whenever `k>1` is not a power of `p`, while of course every multiple of `[p]` has the same scaling factor `0`. So I kept the previous implementation of `.is_injective()`.",
    "created_at": "2022-12-22T10:06:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32589#issuecomment-464239",
    "user": "https://github.com/yyyyx4"
}
```

Thanks a lot for reviewing this (indeed rather long) patch!

Replying to [comment:26 John Cremona]:
> In the `scaling_factor()` method you return `self._m` which is an integer (in ZZ), but I think you should coerce it into the base field.


Indeed, well spotted.

> Having done this you can simplify `is_separable()` and `is_injective()` to a check that `scaling_factor()` is nonzero.


I agree for `.is_separable()`, but it seems that `.is_injective()` is not expressible in terms of the scaling factor alone: For supersingular curves `[p]` is purely inseparable (i.e., injective), but `[kp]` has nontrivial kernel whenever `k>1` is not a power of `p`, while of course every multiple of `[p]` has the same scaling factor `0`. So I kept the previous implementation of `.is_injective()`.



---

archive/issue_comments_464240.json:
```json
{
    "body": "You are right, of course.  When we have `separable_degree()` and `inseparable_degree()` we can just return `separable_degree()==1` for `is_injective()`, since the size of the kernel (over the algebraic closure and not meaning the fancy scheme-theoretic kernel!) is the separable degree.",
    "created_at": "2022-12-22T11:17:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32589#issuecomment-464240",
    "user": "https://github.com/JohnCremona"
}
```

You are right, of course.  When we have `separable_degree()` and `inseparable_degree()` we can just return `separable_degree()==1` for `is_injective()`, since the size of the kernel (over the algebraic closure and not meaning the fancy scheme-theoretic kernel!) is the separable degree.
