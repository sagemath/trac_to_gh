# Issue 25117: Allow extension of include_directories

Issue created by migration from https://trac.sagemath.org/ticket/25354

Original creator: @timokau

Original creation time: 2018-05-13 14:05:32

Keywords: packaging

Since in `nix` every python package is in its own directory (as opposed to all python packages being in the python directory), I need to add the cysignals dir to include_directories.

Debian [adds](https://salsa.debian.org/science-team/sagemath/blob/58bbba93a807ca2933ca317501d093a1bb4b84db/debian/patches/d0-libgap-sage.patch#L84) a custom libgap path.

This patch makes it possible to extend the `include_directories` by setting a `PATH`-like, colon seperated environment variable `SAGE_INCLUDE_DIRECTORIES`.


---

Comment by @timokau created at 2018-05-13 14:05:45

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2018-06-06 15:11:53

Replying to [ticket:25354 gh-timokau]:
> Since in nix every python package is in its own directory (as opposed to all python packages being in the python directory)

So how does this work? Are all those directories then added to `sys.path`?

I have some doubts about your patch because it should just work even if cysignals is installed in a different directory. So I'd like to see exactly what fails when you don't add any new include directories.


---

Comment by jdemeyer created at 2018-06-06 15:11:53

Changing status from needs_review to needs_info.


---

Comment by @timokau created at 2018-06-06 15:33:36

Replying to [comment:2 jdemeyer]:
> Replying to [ticket:25354 gh-timokau]:
> > Since in nix every python package is in its own directory (as opposed to all python packages being in the python directory)
> 
> So how does this work? Are all those directories then added to `sys.path`?

For simple python packages yes. A wrapper script is generated that adds all dependencies to `sys.path`. If non-python software depends on python packages, its also possible to generate a python environment with those dependencies. A python environment is a symlink tree with the python interpreter and all the specified packages symlinked together.

More info: https://nixos.org/nixpkgs/manual/#building-packages-and-applications

> I have some doubts about your patch because it should just work even if cysignals is installed in a different directory. So I'd like to see exactly what fails when you don't add any new include directories.

Now that I think about it its a bit weird, because I chose the second (symlink tree) option for sage (necessary because sage interfaces with the `python` binary). Even if my use-case didn't exist, there would still be the debian use case.

I don't have any build results cached, so I'll have to do a full rebuild to find the exact error. So that'll take a while.


---

Comment by jdemeyer created at 2018-06-07 05:30:42

To clarify: whenever the cysignals directory is on `sys.path`, everything _should_ work. If it breaks anyway, there is a genuine bug somewhere which should be fixed (not by adding an include directory, but by fixing the actual issue).


---

Comment by @timokau created at 2018-06-07 14:44:28

This is the (only) failure:



```
Failed example:
    cython('include "sage/ext/stdsage.pxi"')
Exception raised:
    Traceback (most recent call last):
      File "/nix/store/4fvny8rrc3cmj94gz6h6vb0skyslfx34-python-2.7.14-env/lib/python2.7/site-packages/sage/doctest/for>
        self.compile_and_execute(example, compiler, test.globs)
      File "/nix/store/4fvny8rrc3cmj94gz6h6vb0skyslfx34-python-2.7.14-env/lib/python2.7/site-packages/sage/doctest/for>
        exec(compiled, globs)
      File "<doctest sage.ext.stdsage[0]>", line 1, in <module>
        cython('include "sage/ext/stdsage.pxi"')
      File "sage/misc/lazy_import.pyx", line 354, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/>
        return self.get_object()(*args, **kwds)
      File "/nix/store/4fvny8rrc3cmj94gz6h6vb0skyslfx34-python-2.7.14-env/lib/python2.7/site-packages/sage/misc/cython>
        return cython_import_all(tmpfile, get_globals(), **kwds)
      File "/nix/store/4fvny8rrc3cmj94gz6h6vb0skyslfx34-python-2.7.14-env/lib/python2.7/site-packages/sage/misc/cython>
        m = cython_import(filename, **kwds)
      File "/nix/store/4fvny8rrc3cmj94gz6h6vb0skyslfx34-python-2.7.14-env/lib/python2.7/site-packages/sage/misc/cython>
        name, build_dir = cython(filename, **kwds)
      File "/nix/store/4fvny8rrc3cmj94gz6h6vb0skyslfx34-python-2.7.14-env/lib/python2.7/site-packages/sage/misc/cython>
        use_listing_file=True)
      File "/nix/store/4fvny8rrc3cmj94gz6h6vb0skyslfx34-python-2.7.14-env/lib/python2.7/site-packages/Cython/Build/Dep>
        aliases=aliases)
      File "/nix/store/4fvny8rrc3cmj94gz6h6vb0skyslfx34-python-2.7.14-env/lib/python2.7/site-packages/Cython/Build/Dep>
        kwds = deps.distutils_info(file, aliases, base).values
      File "/nix/store/4fvny8rrc3cmj94gz6h6vb0skyslfx34-python-2.7.14-env/lib/python2.7/site-packages/Cython/Build/Dep>
        return (self.transitive_merge(filename, self.distutils_info0, DistutilsInfo.merge)
      File "/nix/store/4fvny8rrc3cmj94gz6h6vb0skyslfx34-python-2.7.14-env/lib/python2.7/site-packages/Cython/Build/Dep>
        node, extract, merge, seen, {}, self.cimported_files)[0]
      File "/nix/store/4fvny8rrc3cmj94gz6h6vb0skyslfx34-python-2.7.14-env/lib/python2.7/site-packages/Cython/Build/Dep>
        deps = extract(node)
      File "/nix/store/4fvny8rrc3cmj94gz6h6vb0skyslfx34-python-2.7.14-env/lib/python2.7/site-packages/Cython/Build/Dep>
        cimports, externs, incdirs = self.cimports_externs_incdirs(filename)
      File "/nix/store/4fvny8rrc3cmj94gz6h6vb0skyslfx34-python-2.7.14-env/lib/python2.7/site-packages/Cython/Utils.py">
        res = cache[args] = f(self, *args)
      File "/nix/store/4fvny8rrc3cmj94gz6h6vb0skyslfx34-python-2.7.14-env/lib/python2.7/site-packages/Cython/Build/Dep>
        for include in self.included_files(filename):
      File "/nix/store/4fvny8rrc3cmj94gz6h6vb0skyslfx34-python-2.7.14-env/lib/python2.7/site-packages/Cython/Utils.py">
        res = cache[args] = f(self, *args)
      File "/nix/store/4fvny8rrc3cmj94gz6h6vb0skyslfx34-python-2.7.14-env/lib/python2.7/site-packages/Cython/Build/Dep>
        all.update(self.included_files(include_path))
      File "/nix/store/4fvny8rrc3cmj94gz6h6vb0skyslfx34-python-2.7.14-env/lib/python2.7/site-packages/Cython/Utils.py">
        res = cache[args] = f(self, *args)
      File "/nix/store/4fvny8rrc3cmj94gz6h6vb0skyslfx34-python-2.7.14-env/lib/python2.7/site-packages/Cython/Build/Dep>
        include_path = self.context.find_include_file(include, None)
      File "/nix/store/4fvny8rrc3cmj94gz6h6vb0skyslfx34-python-2.7.14-env/lib/python2.7/site-packages/Cython/Compiler/>
        error(pos, "'%s' not found" % filename)
      File "/nix/store/4fvny8rrc3cmj94gz6h6vb0skyslfx34-python-2.7.14-env/lib/python2.7/site-packages/Cython/Compiler/>
        raise InternalError(message)
    InternalError: Internal compiler error: 'cysignals/memory.pxi' not found

```



---

Comment by @timokau created at 2018-06-07 14:45:02

Replying to [comment:4 jdemeyer]:
> To clarify: whenever the cysignals directory is on `sys.path`, everything _should_ work. If it breaks anyway, there is a genuine bug somewhere which should be fixed (not by adding an include directory, but by fixing the actual issue).

Yes, but in this case the cysignals directory is not in `sys.path`.


---

Comment by jdemeyer created at 2018-06-07 15:04:39

Replying to [comment:5 gh-timokau]:
> This is the (only) failure:

That's a test for a deprecated file, so you might as well ignore that failure. It's not worth the effort to fix it.

If that's your only motivation for this ticket, I prefer to close this as "wontfix".


---

Comment by jdemeyer created at 2018-06-07 15:12:18

Does #25531 fix your problem?


---

Comment by @timokau created at 2018-06-07 18:05:48

Replying to [comment:7 jdemeyer]:
> Replying to [comment:5 gh-timokau]:
> > This is the (only) failure:
> 
> That's a test for a deprecated file, so you might as well ignore that failure. It's not worth the effort to fix it.

I'd rather not start ignoring test failures. Its easy to miss new ones that way.

> If that's your only motivation for this ticket, I prefer to close this as "wontfix".

Well there is still the debian use case. Depends on what the debian maintainers want.

Replying to [comment:8 jdemeyer]:
> Does #25531 fix your problem?

It should (haven't tried yet, but I don't see why not) fix the test failure. Is the cysignals include dir really not needed anywhere else except in that test? If so, that fixes my problem.


---

Comment by jdemeyer created at 2018-06-07 19:15:35

Replying to [comment:9 gh-timokau]:
> I'd rather not start ignoring test failures. Its easy to miss new ones that way.

I didn't literally mean just ignoring it. But you could for example add a patch to nixos to remove that test.


---

Comment by jdemeyer created at 2018-06-07 19:20:28

Replying to [comment:9 gh-timokau]:
> Is the cysignals include dir really not needed anywhere else except in that test?

I don't think so because Cython uses `sys.path` to resolve `cimport` statements. It's only `include` statements which are problematic, but the `.pxi` files are deprecated so `include` should not be used.


---

Comment by @timokau created at 2018-06-07 20:39:20

Replying to [comment:10 jdemeyer]:
> Replying to [comment:9 gh-timokau]:
> > I'd rather not start ignoring test failures. Its easy to miss new ones that way.
> 
> I didn't literally mean just ignoring it. But you could for example add a patch to nixos to remove that test.

If I needed to patch sage anyways, I might as well add the include.

Replying to [comment:11 jdemeyer]:
> Replying to [comment:9 gh-timokau]:
> > Is the cysignals include dir really not needed anywhere else except in that test?
> 
> I don't think so because Cython uses `sys.path` to resolve `cimport` statements. It's only `include` statements which are problematic, but the `.pxi` files are deprecated so `include` should not be used.

Great, thanks! Doctests succeed with #25531 applied. Then I don't need this change for nixos anymore. I still think it would be nice for debian and just nice-to-have in general, but if you disagree I don't mind if you close this.


---

Comment by jdemeyer created at 2018-06-08 08:13:38

Resolution: wontfix


---

Comment by jdemeyer created at 2018-06-08 08:13:38

Replying to [comment:12 gh-timokau]:
> I still think it would be nice for debian and just nice-to-have in general, but if you disagree I don't mind if you close this.

I'll close this for now. If another use case comes up, we can always reconsider.
