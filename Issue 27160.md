# Issue 27160: upgrade to twisted 18.9.0

Issue created by migration from https://trac.sagemath.org/ticket/27397

Original creator: chapoton

Original creation time: 2019-03-02 11:40:03

CC:  embray jdemeyer fbissey

Keywords: upgrade

This could help to tun sagenb with python3


---

Comment by chapoton created at 2019-03-02 11:44:21

New commits:


---

Comment by chapoton created at 2019-03-02 11:44:21

Changing status from new to needs_review.


---

Comment by chapoton created at 2019-03-02 12:16:55

Strangely, this does not seem to install all files (on a python3-built sage)

For example, twisted.mail.relaymanager is not installed...

Help! What is happening?


---

Comment by fbissey created at 2019-03-02 22:07:49

Actually the gentoo ebuild seems to have a similar behavior, python2.7 has way more file installed than python3.6. It appears to be the default, not sure if that's bad yet.


---

Comment by chapoton created at 2019-03-03 08:09:28

Could this be related to different levels of compatibility of twisted with respect to different versions of py3 (3.3, 3.4, 3.5, 3.6, etc)

Because it seems that `twisted.mail.smtp` gets installed with the branch here, whereas it was not with our current version of twisted.


---

Comment by chapoton created at 2019-03-03 15:29:12

Note: the same lack of installed files happens when twisted is installed on top of the system (ubuntu 18.10) python3.


---

Comment by slelievre created at 2019-03-04 23:30:12

The [Twisted home page](https://twistedmatrix.com/trac/) makes very moderate claims to Python 3 support:

> Twisted runs on Python 2 and an ever growing subset also works with Python 3.


---

Comment by slelievre created at 2019-03-04 23:30:12

Changing keywords from "upgrade" to "upgrade, twisted".


---

Comment by slelievre created at 2019-03-04 23:30:12

Changing type from PLEASE CHANGE to enhancement.


---

Comment by slelievre created at 2019-03-04 23:34:21

That said, the [news item for Twisted 18.9.0](https://github.com/twisted/twisted/blob/trunk/NEWS.rst) mentions

> Python 3.7 is now supported


---

Comment by slelievre created at 2019-03-05 04:02:56

The [pull request about Python 3.7 support](https://github.com/twisted/twisted/pull/1071/files) still says:

> Python 2.7 (full functionality) or 3.4/3.5/3.6/3.7 (subset of functionality)


---

Comment by chapoton created at 2019-03-05 07:49:49

There is a list of "non ported modules" here:

https://github.com/twisted/twisted/blob/trunk/src/twisted/python/_setup.py

and this controls what is installed on python3.

We need relaymanager and all its depencies...


---

Comment by embray created at 2019-03-05 15:23:09

Is this just for sagenb?  I'd suggest not supporting it on Python 3 at all (I know you've done a lot of work towards getting that working anyways but I'm not sure it's worth all the trouble since it's being deprecated anyways).

At the very least, maybe it can be missing some functionality (with appropriate warnings given).


---

Comment by chapoton created at 2019-03-05 15:25:47

yes, this is just for sagenb. It currently fails to start because of these 2 missing modules of twisted.mail.  I remember that a brute force removal of these imports allow the notebook to start, but it looked ugly for some reason.

I will not push hard for this ticket, but maybe we were almost there.. Sigh..


---

Comment by embray created at 2019-03-05 15:45:56

I guess you could do something like


```
try:
    import twisted.mail
    HAVE_TWISTED_MAIL = True
except ImportError:
    HAVE_TWISTED_MAIL = False
    if <twisted version <= whatever>:
        # This is an actual error since an older Twisted version should have this
        raise
```


and later


```
if HAVE_TWISTED_MAIL:
    <do the thing>
else:
    warnings.warn("<this functionality is no longer supported, sagenb is deprecated, blah blah blah>")
```


I haven't looked at the relevant code though so I don't know how straightforward that would be in practice.


---

Comment by embray created at 2019-03-25 10:56:15

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)


---

Comment by chapoton created at 2019-04-28 08:05:25

Changing status from needs_review to needs_work.


---

Comment by embray created at 2019-06-14 14:50:27

Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).


---

Comment by chapoton created at 2019-11-02 17:24:06

Is there any volunteer to try this and sagenb with sage running python 3 ?


---

Comment by chapoton created at 2019-11-02 17:24:06

Changing status from needs_work to needs_info.


---

Comment by git created at 2019-11-02 17:31:01

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2019-11-02 17:41:58

I had to do

```
sage -pip install --upgrade incremental
```

----
New commits:


---

Comment by chapoton created at 2019-11-02 17:47:36

and then

```
sage -pip install constantly
```

But sagenb still fails as before. So no real hope to make it work under py3.


---

Comment by embray created at 2020-01-06 14:10:03

Ticket retargeted after milestone closed


---

Comment by chapoton created at 2020-03-18 07:59:26

given #29320, I propose to close this one as invalid


---

Comment by chapoton created at 2020-03-18 07:59:26

Changing status from needs_info to needs_review.


---

Comment by fbissey created at 2020-03-18 08:01:06

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2020-03-18 08:01:06

With pleasure.


---

Comment by chapoton created at 2020-03-18 08:20:09

Resolution: invalid
