# Issue 19134: Install Jupyter kernel spec in $SAGE_LOCAL

Issue created by migration from https://trac.sagemath.org/ticket/19371

Original creator: jdemeyer

Original creation time: 2015-10-08 07:32:46

Instead of installing the Jupyter kernel spec file in the user's home directory, we should install it in `$SAGE_LOCAL` (a "system" install). We should also not use versions to avoid this:

```
$ ls -l ~/.local/share/jupyter/kernels/
total 12
drwx------ 2 jdemeyer jdemeyer 4096 Sep 24 18:05 sage_6_9_beta7
drwx------ 2 jdemeyer jdemeyer 4096 Oct  7 22:41 sage_6_9_rc0
drwx------ 2 jdemeyer jdemeyer 4096 Oct  7 22:04 sage_6_9_rc3
```



---

Comment by jdemeyer created at 2015-10-08 09:43:55

New commits:


---

Comment by jdemeyer created at 2015-10-08 09:43:55

Changing status from new to needs_review.


---

Comment by egourgoulhon created at 2015-10-08 13:45:25

Looks good to me.
But it would be nice if someone more expert on Jupyter gives a look too.


---

Comment by egourgoulhon created at 2015-10-08 13:45:25

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2015-10-08 13:52:25

Changing priority from major to blocker.


---

Comment by fbissey created at 2015-10-08 22:33:43

You are concerned with multiple `SageMath` installs I am more concerned with global install for multiple users (SMC and sage-on-gentoo) and I am not sure about that change. It gives me problem on install at the moment because it violates sandbox rules of packaging. It's more the fault of `jupyter_core` for not giving me a way of over-ridding `ENV_JUPYTER_PATH` than yours.

But I am more worried about the fact that on a global install people won't be able to touch that directory. If you don't need to put anything else in it at "user runtime" great. If not we are in a big no situation as far as I am concerned (and William will almost certainly not be happy either).

As for running multiple `SageMath` install side by side without bad interactions from the content of `~/.sage` you can always define `DOTSAGE`. A bit inconvenient (unless you version it inside of `sage`) but it works.


---

Comment by jdemeyer created at 2015-10-09 07:36:04

Replying to [comment:6 fbissey]:
> It gives me problem on install at the moment because it violates sandbox rules of packaging.
I think you need to explain this more. The only possible issue I can see is that maybe the directory `ENV_JUPYTER_PATH[0]` is the "wrong" place in your Sage-on-Gentoo setup.

If `ENV_JUPYTER_PATH[0]` is some directory inside `$SAGE_LOCAL` (which it should be), I don't see why installing this one particular file in `$SAGE_LOCAL` is any different from installing the huge number of other files in `$SAGE_LOCAL`...

> But I am more worried about the fact that on a global install people won't be able to touch that directory. If you don't need to put anything else in it at "user runtime" great.
We do not need to put anything else in that directory at runtime. Why do you think we do?


---

Comment by fbissey created at 2015-10-09 07:55:59

Replying to [comment:7 jdemeyer]:
> Replying to [comment:6 fbissey]:
> > It gives me problem on install at the moment because it violates sandbox rules of packaging.
> I think you need to explain this more. The only possible issue I can see is that maybe the directory `ENV_JUPYTER_PATH[0]` is the "wrong" place in your Sage-on-Gentoo setup.

`ENV_JUPYTER_PATH` is defined as `os.path.join(sys.prefix, 'share', 'jupyter')` which translates as `/usr/share/jupyter` (or `$SAGE_LOCAL/share/jupyter`) in concrete terms. The problem is the sage installation procedure is now trying to create and write files out of the sandbox. 

Proper packaging in the sense of rpm, deb and most other doesn't allow you to write in the "live" system. Things are installed and written in a sandbox space and then copied (merged) to the system. Because of the way Andrew wrote `env.py` (and I was grateful to him for that) I can set most `SAGE_*` variables so sage will write things in my sandbox. If `jupyter_core` was allowing me to over-ride `ENV_JUPYTER_PATH` I could set in the appropriate place in the sandbox and it would be merged in the right place.

> 
> If `ENV_JUPYTER_PATH[0]` is some directory inside `$SAGE_LOCAL` (which it should be), I don't see why installing this one particular file in `$SAGE_LOCAL` is any different from installing the huge number of other files in `$SAGE_LOCAL`...
> 

`sys.prefix` is `SAGE_LOCAL`, actually even in `sage-on-gentoo`, the difference is that you don't protect your live prefix during build.

> > But I am more worried about the fact that on a global install people won't be able to touch that directory. If you don't need to put anything else in it at "user runtime" great.
> We do not need to put anything else in that directory at runtime. Why do you think we do?

Because I am uncertain of how it works. You are obviously creating something there as place holder but it was possibly silly of me.


---

Comment by jdemeyer created at 2015-10-09 07:59:45

Replying to [comment:8 fbissey]:
> `sys.prefix` is `SAGE_LOCAL`, actually even in `sage-on-gentoo`

So, if `sys.prefix` is `$SAGE_LOCAL` and you can set `$SAGE_LOCAL` to whatever you want, then I don't see the problem.

> the difference is that you don't protect your live prefix during build.
I have absolutely no idea what this sentence means.


---

Comment by jdemeyer created at 2015-10-09 08:01:41

Replying to [comment:8 fbissey]:
> Because I am uncertain of how it works.
It's really just one configuration file. That's the whole thing I don't understand: what makes this _one particular file_ so special? You apparently manage to install all of Sage, but not this _one particular file_?


---

Comment by fbissey created at 2015-10-09 08:18:37

Two things:
* the fact that `sys.prefix` is `SAGE_LOCAL` is incidental, it doesn't have to be. 
* Once `jupyter_core` is in place it doesn't matter what I set `SAGE_LOCAL` to, it doesn't change the value of `sys.prefix` `jupyter_core` or rather `python` is reporting.

The install procedure for sage is now trying to create `/usr/share/jupyter/kernels/sagemath` and any missing directory. rpm, deb and ebuild do not allow you to do that directly. You install `$SOMESANDBOX/usr/share/jupyter/kernels/sagemath` and later you merge into the live system. That's what `DESTDIR` is for in autotools, you set `DESTDIR=$SOMESANDBOX` and things magically install in the sandbox.

Now my main concern was the potential for user to do something to `{/usr,$SAGE_LOCAL}/share/jupyter/kernels/sagemath` which would be problematic for multi-user install. It is unfounded. The rest is an upstream problem and we can stop debating packaging tech in this ticket.


---

Comment by jdemeyer created at 2015-10-09 08:22:41

Replying to [comment:11 fbissey]:
> You install `$SOMESANDBOX/usr/share/jupyter/kernels/sagemath` and later you merge into the live system. That's what `DESTDIR` is for in autotools, you set `DESTDIR=$SOMESANDBOX` and things magically install in the sandbox.

Right, and how does this work with `distutils`? I assume (but I might be wrong) that distutils also uses `sys.prefix` to determine where to install stuff.


---

Comment by jdemeyer created at 2015-10-09 08:26:00

Replying to [comment:11 fbissey]:
> The rest is an upstream problem and we can stop debating packaging tech in this ticket.
It happens that I am [debating packaging tech with upstream](https://github.com/jupyter/jupyter_client/pull/75), so I'd like to understand your issue.


---

Comment by fbissey created at 2015-10-09 08:38:40

Replying to [comment:13 jdemeyer]:
> Replying to [comment:11 fbissey]:
> > The rest is an upstream problem and we can stop debating packaging tech in this ticket.
> It happens that I am [debating packaging tech with upstream](https://github.com/jupyter/jupyter_client/pull/75), so I'd like to understand your issue.

I have just read it ( before seeing your comment here). It is a bit messy but thinking more about it there must a bug of some kind. `distutils` as used from within portage should set a sandboxed `prefix`, therefore `sys.prefix` should point to a sandboxed location, so something is wrong there.


---

Comment by fbissey created at 2015-10-09 09:48:38

I know what the problem is. We have three phases in order: build, test (optional) and install. Only the install phase is run with a prefix, this is the only time when it should be necessary. But the installation of the jupyter kernel is attempted during the build phase. So from my point of view that bit has to be restricted to install time.


---

Comment by jdemeyer created at 2015-10-09 11:45:11

Changing status from positive_review to needs_work.


---

Comment by git created at 2015-10-09 12:56:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-10-09 13:09:10

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-10-09 15:45:17

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-10-09 15:45:17

I think we need to uncouple the IPython from the kernel spec installation.


---

Comment by jdemeyer created at 2015-10-09 17:44:20

Changing priority from blocker to major.


---

Comment by jdemeyer created at 2015-10-09 17:44:20

Since this turns out to be a lot trickier than I initially thought, this should not be a 6.9 blocker. Which means that we need to unrebase #19374.


---

Comment by fbissey created at 2015-10-09 20:26:03

Thank you for taking my concern on board.


---

Comment by git created at 2015-10-11 10:01:47

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2015-10-11 10:29:50

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-10-11 10:49:12

Changing status from needs_work to needs_review.


---

Comment by egourgoulhon created at 2015-10-11 16:57:44

Sorry I'm afraid I cannot review this one (don't feel competent about it).


---

Comment by charpent created at 2015-10-15 14:36:03

I had a problem on an Ubuntu machine wher I could get MathJax in sheets created in my home directory but nowhere else.

I checked the present patch and recompiled :
1. It seems to solve my Ubuntu-specific problem
2. It passes ptestlong.

Is that enough for a positive review ?


---

Comment by jdemeyer created at 2015-10-15 14:41:20

Replying to [comment:29 charpent]:
> Is that enough for a positive review ?

Who are you asking? Essentially, that's up to you to decide.


---

Comment by jdemeyer created at 2015-10-15 14:42:57

Note that this depends on #19373. So, it would be nice if you could also review that.


---

Comment by charpent created at 2015-10-15 14:59:57

Replying to [comment:31 jdemeyer]:
> Note that this depends on #19373. So, it would be nice if you could also review that.

Is this dependance somehow managed by git ?

In other terms, when I checked #19371 out, did that also applied #19373 ?

If so, that means that my tests show that (#19371+#19373) passes ptestlong. I cannot speak for a Jupyter hub, since I don't have such a beast in my zoo...

Otherwise, I'll have to check out #19373 and merge both branches, then recompile and ptestlong (about 4 hours on my Ubuntu netbook...).

Or would it be enough to positively review #19371, and leave #19373 to someone equipped to do so ?


---

Comment by jdemeyer created at 2015-10-15 15:05:01

Replying to [comment:32 charpent]:
> In other terms, when I checked #19371 out, did that also applied #19373 ?
Yes, this branch here is based on #19373.

> If so, that means that my tests show that (#19371+#19373) passes ptestlong.
Indeed.


---

Comment by charpent created at 2015-10-15 15:23:00

Changing status from needs_review to positive_review.


---

Comment by charpent created at 2015-10-15 15:23:00

Replying to [comment:33 jdemeyer]:
> Replying to [comment:32 charpent]:
> > In other terms, when I checked #19371 out, did that also applied #19373 ?
> Yes, this branch here is based on #19373.
> 
> > If so, that means that my tests show that (#19371+#19373) passes ptestlong.
> Indeed.

OK. I give a positive review to #19371. I'll leave to someone having the possibility to really test #19373 the responsibility of validating it.


---

Comment by vbraun created at 2015-10-18 19:11:25

Resolution: fixed
