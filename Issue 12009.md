# Issue 12009: random_DAG does not terminate on it's default inputs

Issue created by migration from Trac.

Original creator: mderickx

Original creation time: 2011-12-18 16:02:41

Assignee: tbd

Try:


```
random_DAG(5)
```


it will run forever!


---

Comment by bbanu created at 2011-12-19 02:42:12

Replying to [ticket:12181 mderickx]:
> Try:
> 
> {{{
> random_DAG(5)
> }}}
> 
> it will run forever!


---

Comment by bbanu created at 2011-12-19 02:43:14

Replying to [ticket:12181 mderickx]:
> Try:
> 
> {{{
> random_DAG(5)
> }}}
> 
> it will run forever!
> 
> It appears it is stuck in /local/lib/python2.6/site-packages/sage/sandpiles/sandpile.pyc at
>    4904             for j in range(i):
> -> 4905                 if p > random():
> This is the same behavior as 
> {{{
> random_DAG(5, 0)
> }}}
> 
> It appears p=1/2 from the definition of random_DAG is evaluated to 0 (so there are no possible connections), hence p = 0.5 should fix it.


---

Comment by bbanu created at 2011-12-19 02:44:33

It appears it is stuck in /local/lib/python2.6/site-packages/sage/sandpiles/sandpile.pyc at

   4904             for j in range(i):
-> 4905                 if p > random():

This is the same behavior as 

```
random_DAG(5, 0)
```


It appears p=1/2 from the definition of random_DAG is evaluated to 0 (so there are no possible connections), hence p = 0.5 should fix it.


---

Comment by zimmerma created at 2011-12-19 11:50:33

even the following runs forever:

```
sage: random_DAG(1)
```

Paul


---

Comment by dsm created at 2012-02-13 07:32:43

Changing status from new to needs_review.


---

Comment by dsm created at 2012-02-13 07:32:43

random_digraph had the same issue (as did, to a lesser degree, one of the positioning dictionaries.)  Patch attached.


---

Comment by chapoton created at 2012-04-30 11:20:39

Changing component from PLEASE CHANGE to graph theory.


---

Comment by chapoton created at 2012-04-30 11:20:39

Changing keywords from "" to "random digraph".


---

Comment by chapoton created at 2012-04-30 15:08:54

Changing status from needs_review to needs_info.


---

Comment by chapoton created at 2012-04-30 15:08:54

Can you please check what happens, with your patch applied, to the command

sage: random_DAG(5,p=0)

I suspect that the problem is not only the fact that 1/2=0, but also that the program fails when p=0.


---

Comment by chapoton created at 2012-04-30 15:24:34

Indeed, the algorithm is an infinite loop when p=0.

What behaviour should be expected for p=0 ?

Maybe one should add an assumption : 

assert p>0 and p<1, "The probability p=%s should satisfy 0<p<1." %p


---

Comment by chapoton created at 2012-06-05 18:45:31

Changing status from needs_info to needs_review.


---

Comment by chapoton created at 2012-06-05 18:45:39

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2012-06-08 13:58:38

I have made a modified patch, which checks that p>0.

apply only trac_12181_random_dag-fc.patch


---

Comment by chapoton created at 2012-06-08 13:58:38

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2012-07-23 12:38:27

apply only trac_12181_random_dag-fc.2.patch

new patch, with better doc only


---

Comment by dcoudert created at 2012-08-04 11:09:05

Changing status from needs_review to needs_work.


---

Comment by dcoudert created at 2012-08-04 11:09:05

Hello,

The patch needs further improvements.

1) The test on p should be improved since I can give p=2 without error. For instance,

```
if p < 0 or p > 1:
   raise ValueError('The parameter p must be in [0..1].')
```


2) A test is needed for parameter weight_max:

```
sage: random_DAG(5, .5, -1)
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
...
...
ValueError: empty range for randrange() (1,0, -1)
```

and

```
sage: random_DAG(5, .5, .5)
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
...
...
ValueError: non-integer stop for randrange()
```


3) It should be clearly indicated in the documentation that the function returns a dictionary storing the edges of the DAG.

4) The resulting number of vertices is not n but n+1:

```
sage: d = DiGraph(random_DAG(5, .5))
sage: d
Digraph on 6 vertices
```


5) I don't understand why this digraph generator is not part of ```sage.graphs.digraph_generators.py```. The function could have an optional parameter to return a dictionary instead of a digraph if relevant.


---

Comment by chapoton created at 2012-08-04 18:29:49

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2012-08-04 18:29:49

new patch. 

I have made all the required changes, except for the last point. It is certainly true that the procedure could be moved, and changed to return a digraph. I would rather let that for another ticket..

apply only trac_12181_random_dag-fc.patch


---

Comment by dcoudert created at 2012-08-04 23:31:24

This is much better.

- The instruction `weight_max=ZZ(weight_max)` is before the test on weights. Is this what you expect?

```
sage: random_DAG(5,.5,1.5)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
...
TypeError: Attempt to coerce non-integral RealNumber to Integer
```


- The output is not only a dictionary but a dictionary of dictionary. You should perhaps add a warning comment since the space requirement for large values of n could be too high. I don't know the usual size of the DAG used in this context.

- I'm unable to build/find the documentation. Are you able to build it?

- I agree that moving this function into digraphs_generator could be done as part of another patch. It should in particular have an optional argument allowing to have multiple sinks (and so avoiding the while loop). With current setting, I'm not sure that the average number of arcs is ``p*n``.


---

Comment by chapoton created at 2012-08-05 07:48:55

> - The instruction `weight_max=ZZ(weight_max)` is before the test on weights. Is this what you expect?
> {{{
> sage: random_DAG(5,.5,1.5)
> ---------------------------------------------------------------------------
> TypeError                                 Traceback (most recent call last)
> ...
> TypeError: Attempt to coerce non-integral RealNumber to Integer
> }}}

Yes, indeed. Well, this seems to be a reasonable way to ensure that the input is of correct type, as specified in the documentation. The problem is that one should accept both *int* and *Integers* as third argument. This is the case with what I have written, which tries to coerce to Integers.


 
> - The output is not only a dictionary but a dictionary of dictionary. You should perhaps add a warning comment since the space requirement for large values of n could be too high. I don't know the usual size of the DAG used in this context.

Well, a dictionary of dictionaries is a dictionary, isn't it ? And by the way, I have not found any place in the sources of Sage where this procedure is used.


> - I'm unable to build/find the documentation. Are you able to build it?

Sorry, I do not understand this remark. I have only tried the doc in a terminal. Should I try it in the notebook too ? Should I do something else ? Could you pinpoint a specific problem ?


> - I agree that moving this function into digraphs_generator could be done as part of another patch. It should in particular have an optional argument allowing to have multiple sinks (and so avoiding the while loop). With current setting, I'm not sure that the average number of arcs is ``p*n``.

Well, this ticket is here to solve a specific problem, and the rest can be postponed to some other ticket.


---

Comment by chapoton created at 2012-08-05 09:41:20

There is now a mismatch between doc and tests : should we allow p to be equal to 1 or not ?


---

Comment by dcoudert created at 2012-08-05 10:35:14

That's right, you should change the test to

```
assert 0 < p and p <= 1, "The parameter p must satisfy 0 < p <= 1."
```

You don't have the change the rest of the code since the `random()` function returns a value strictly less than 1.

Concerning the documentation. For (almost?) all modules, you can find the functions in the reference manual of sage (http://www.sagemath.org/doc/reference/). Then, when testing a patch, we use the command
`sage -docbuild reference html`
to build the reference manual including patch's changes. Same for `thematic_tutorials` if any.

However, the sandpile model is not included in the reference manual.
I have open a new ticket to address this issue (#13342).


So, you have to:
- change the test on p
- change the commit message of this patch. It is currently

```
#12181 bug in random digraphs with probability zero
```

It should be something like

```
trac #12181 -- Fix bugs with the input parameters of the random_DAG function
```



---

Comment by chapoton created at 2012-08-05 16:23:17

Changes done in the new version of the patch


---

Comment by dcoudert created at 2012-08-05 20:08:37

For me the patch is OK now.


---

Comment by dcoudert created at 2012-08-05 20:08:37

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-08-06 13:09:38

I strongly suggest against using `assert` statements for error checking (bad input should throw `ValueError`, not `AssertionError`). Also, add doctests for this bad input.


---

Comment by jdemeyer created at 2012-08-06 13:09:38

Changing status from positive_review to needs_work.


---

Attachment


---

Comment by chapoton created at 2012-08-08 15:32:33

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2012-08-08 15:32:33

New patch, with suggested changes made.


---

Comment by dcoudert created at 2012-08-08 23:34:05

Changing status from needs_review to positive_review.


---

Comment by dcoudert created at 2012-08-08 23:34:05

For me the patch is fine (install, long tests, etc.).


---

Comment by jdemeyer created at 2012-08-14 07:02:37

Resolution: fixed
