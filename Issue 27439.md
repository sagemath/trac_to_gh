# Issue 27439: sage miscompiles with gcc9

archive/issues_027439.json:
```json
{
    "body": "CC:  @kiwifb\n\nKeywords: gcc, openblas, brial\n\n`gcc-9` is due out in late April/early May 2019. With the current `gcc-9` snapshot, `sage` has issues where it miscompiles.\n\nThere seem to be two sets of issues:\n\n1. `openblas-0.3.5` doesn't compile correctly with `gcc-9`. This makes lots of errors occur if `SAGE_CHECK=\"yes\"` (in `openblas` and other packages that depend on it) and makes `make testlong` output lots of errors and eventually just hang. As of writing (2019/04/16), this seems to be fixed in upstream git.\n\n2. Something seems to go wrong with `brial` or something related. `make testlong` has errors on the following files:\n\n```\nsage -t --long --warn-long 31.0 src/sage/crypto/mq/sr.py  # Killed due to abort\nsage -t --long --warn-long 31.0 src/sage/rings/polynomial/multi_polynomial_sequence.py  # Killed due to abort\nsage -t --long --warn-long 31.0 src/sage/rings/polynomial/pbori.pyx  # Killed due to abort\n```\n\n\nAs a minor issue, with `SAGE_CHECK=\"yes\"`, `make` doesn't seem to stop after compiling `openblas`, despite many tests failing.\n\nIssue created by migration from https://trac.sagemath.org/ticket/27676\n\n",
    "created_at": "2019-04-16T09:30:05Z",
    "labels": [
        "packages: standard",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "sage miscompiles with gcc9",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27439",
    "user": "@Konrad127123"
}
```
CC:  @kiwifb

Keywords: gcc, openblas, brial

`gcc-9` is due out in late April/early May 2019. With the current `gcc-9` snapshot, `sage` has issues where it miscompiles.

There seem to be two sets of issues:

1. `openblas-0.3.5` doesn't compile correctly with `gcc-9`. This makes lots of errors occur if `SAGE_CHECK="yes"` (in `openblas` and other packages that depend on it) and makes `make testlong` output lots of errors and eventually just hang. As of writing (2019/04/16), this seems to be fixed in upstream git.

2. Something seems to go wrong with `brial` or something related. `make testlong` has errors on the following files:

```
sage -t --long --warn-long 31.0 src/sage/crypto/mq/sr.py  # Killed due to abort
sage -t --long --warn-long 31.0 src/sage/rings/polynomial/multi_polynomial_sequence.py  # Killed due to abort
sage -t --long --warn-long 31.0 src/sage/rings/polynomial/pbori.pyx  # Killed due to abort
```


As a minor issue, with `SAGE_CHECK="yes"`, `make` doesn't seem to stop after compiling `openblas`, despite many tests failing.

Issue created by migration from https://trac.sagemath.org/ticket/27676





---

archive/issue_comments_386806.json:
```json
{
    "body": "Attachment [openblas-0.3.5.p1.log.gz](tarball://root/attachments/some-uuid/ticket27676/openblas-0.3.5.p1.log.gz) by @Konrad127123 created at 2019-04-16 09:35:27\n\nTest suite output of `openblas` with `gcc-9`",
    "created_at": "2019-04-16T09:35:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386806",
    "user": "@Konrad127123"
}
```

Attachment [openblas-0.3.5.p1.log.gz](tarball://root/attachments/some-uuid/ticket27676/openblas-0.3.5.p1.log.gz) by @Konrad127123 created at 2019-04-16 09:35:27

Test suite output of `openblas` with `gcc-9`



---

archive/issue_comments_386807.json:
```json
{
    "body": "Attachment [testlong.log.gz](tarball://root/attachments/some-uuid/ticket27676/testlong.log.gz) by @Konrad127123 created at 2019-04-16 09:36:25\n\n`make testlong` output with `gcc-9` and `openblas` from upstream git.",
    "created_at": "2019-04-16T09:36:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386807",
    "user": "@Konrad127123"
}
```

Attachment [testlong.log.gz](tarball://root/attachments/some-uuid/ticket27676/testlong.log.gz) by @Konrad127123 created at 2019-04-16 09:36:25

`make testlong` output with `gcc-9` and `openblas` from upstream git.



---

archive/issue_comments_386808.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-04-16T09:43:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386808",
    "user": "@kiwifb"
}
```

New commits:



---

archive/issue_comments_386809.json:
```json
{
    "body": "FYI: The branch currently attached to this ticket is to help with testing/investigating. It's not an attempt to fix the bugs.",
    "created_at": "2019-04-16T09:52:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386809",
    "user": "@Konrad127123"
}
```

FYI: The branch currently attached to this ticket is to help with testing/investigating. It's not an attempt to fix the bugs.



---

archive/issue_comments_386810.json:
```json
{
    "body": "Attachment [sr.txt.gz](tarball://root/attachments/some-uuid/ticket27676/sr.txt.gz) by @Konrad127123 created at 2019-04-16 10:08:50\n\nOutput of `sage -t --long --warn-long 31.0 src/sage/crypto/mq/sr.py` run standalone",
    "created_at": "2019-04-16T10:08:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386810",
    "user": "@Konrad127123"
}
```

Attachment [sr.txt.gz](tarball://root/attachments/some-uuid/ticket27676/sr.txt.gz) by @Konrad127123 created at 2019-04-16 10:08:50

Output of `sage -t --long --warn-long 31.0 src/sage/crypto/mq/sr.py` run standalone



---

archive/issue_comments_386811.json:
```json
{
    "body": "Output of `sage -t --long --warn-long 31.0 src/sage/rings/polynomial/multi_polynomial_sequence.py` run standalone",
    "created_at": "2019-04-16T10:09:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386811",
    "user": "@Konrad127123"
}
```

Output of `sage -t --long --warn-long 31.0 src/sage/rings/polynomial/multi_polynomial_sequence.py` run standalone



---

archive/issue_comments_386812.json:
```json
{
    "body": "Attachment [multi_polynomial_sequence.txt.gz](tarball://root/attachments/some-uuid/ticket27676/multi_polynomial_sequence.txt.gz) by @Konrad127123 created at 2019-04-16 10:09:55\n\nOutput of `sage -t --long --warn-long 31.0 src/sage/rings/polynomial/pbori.pyx` run standalone",
    "created_at": "2019-04-16T10:09:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386812",
    "user": "@Konrad127123"
}
```

Attachment [multi_polynomial_sequence.txt.gz](tarball://root/attachments/some-uuid/ticket27676/multi_polynomial_sequence.txt.gz) by @Konrad127123 created at 2019-04-16 10:09:55

Output of `sage -t --long --warn-long 31.0 src/sage/rings/polynomial/pbori.pyx` run standalone



---

archive/issue_comments_386813.json:
```json
{
    "body": "Attachment [pbori.txt.gz](tarball://root/attachments/some-uuid/ticket27676/pbori.txt.gz) by @dimpase created at 2019-05-16 09:00:30\n\nWith `ModuleNotFoundError: No module named 'Cython'`, as seen in the logs, all bets are off.\n\nI tried gcc 9.1 (from Gentoo) and got a lot of \"Bad exit\" in tests from memory overflows.",
    "created_at": "2019-05-16T09:00:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386813",
    "user": "@dimpase"
}
```

Attachment [pbori.txt.gz](tarball://root/attachments/some-uuid/ticket27676/pbori.txt.gz) by @dimpase created at 2019-05-16 09:00:30

With `ModuleNotFoundError: No module named 'Cython'`, as seen in the logs, all bets are off.

I tried gcc 9.1 (from Gentoo) and got a lot of "Bad exit" in tests from memory overflows.



---

archive/issue_comments_386814.json:
```json
{
    "body": "Have you run any tests on individual packages? I would expect a few things to come from individual packages.",
    "created_at": "2019-05-16T22:32:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386814",
    "user": "@kiwifb"
}
```

Have you run any tests on individual packages? I would expect a few things to come from individual packages.



---

archive/issue_comments_386815.json:
```json
{
    "body": "Maybe we can upgrade to the released openblas 0.3.6 on a separate ticket to get that out of the way",
    "created_at": "2019-05-18T10:52:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386815",
    "user": "@vbraun"
}
```

Maybe we can upgrade to the released openblas 0.3.6 on a separate ticket to get that out of the way



---

archive/issue_comments_386816.json:
```json
{
    "body": "This is now 27847",
    "created_at": "2019-05-18T10:57:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386816",
    "user": "@vbraun"
}
```

This is now 27847



---

archive/issue_comments_386817.json:
```json
{
    "body": "With #27847 only the following failures remain\n\n```\nsage -t --long src/sage/crypto/mq/sr.py  # Killed due to abort\nsage -t --long src/sage/rings/polynomial/multi_polynomial_sequence.py  # Killed due to abort\nsage -t --long src/sage/rings/polynomial/pbori.pyx  # Killed due to abort\n```\n",
    "created_at": "2019-05-18T22:50:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386817",
    "user": "@vbraun"
}
```

With #27847 only the following failures remain

```
sage -t --long src/sage/crypto/mq/sr.py  # Killed due to abort
sage -t --long src/sage/rings/polynomial/multi_polynomial_sequence.py  # Killed due to abort
sage -t --long src/sage/rings/polynomial/pbori.pyx  # Killed due to abort
```




---

archive/issue_comments_386818.json:
```json
{
    "body": "That's less than I have in sage-on-gentoo but I haven't rebuilt everything yet. But there is really a track leading to pbori not sure if it is just the sage interface or brial itself. brial passes its own testsuite with gcc-9.1 that's already something but not necessarilly conclusive that it is all on sage-side.\n\nFrom what Steve Trogdon posted to me\n\n```\nCython backtrace\n----------------\n#0  0x00007fe418a5fd80 in __waitpid () at /storage/strogdon/gentoo-rap/var/tmp/portage/sys-libs/glibc-2.29-r2/work/glibc-2.29/nptl/../sysdeps/unix/sysv/linux/waitpid.c:30\n#1  0x00007fe4104374eb in print_enhanced_backtrace () at /storage/strogdon/gentoo-rap/var/tmp/portage/dev-python/cysignals-1.10.2/work/cysignals-1.10.2/build/src/cysignals/implementation.c:563\n#2  0x00007fe410437687 in sigdie () at /storage/strogdon/gentoo-rap/var/tmp/portage/dev-python/cysignals-1.10.2/work/cysignals-1.10.2/build/src/cysignals/implementation.c:589\n#3  0x00007fe410436a0e in sigdie_for_sig () at /storage/strogdon/gentoo-rap/var/tmp/portage/dev-python/cysignals-1.10.2/work/cysignals-1.10.2/build/src/cysignals/implementation.c:160\n#4  0x00007fe410436ba6 in cysigs_signal_handler () at /storage/strogdon/gentoo-rap/var/tmp/portage/dev-python/cysignals-1.10.2/work/cysignals-1.10.2/build/src/cysignals/implementation.c:262\n#5  0x00007fe4190cea30 in __restore_rt ()\n#6  0x00007fe4186b6330 in __GI_raise () at /storage/strogdon/gentoo-rap/var/tmp/portage/sys-libs/glibc-2.29-r2/work/glibc-2.29/signal/../sysdeps/unix/sysv/linux/raise.c:50\n#7  0x00007fe41869f7a4 in __GI_abort () at /storage/strogdon/gentoo-rap/var/tmp/portage/sys-libs/glibc-2.29-r2/work/glibc-2.29/stdlib/abort.c:79\n#8  0x00007fe401744d20 in __gnu_cxx::__verbose_terminate_handler () at /storage/strogdon/gentoo-rap/var/tmp/portage/sys-devel/gcc-9.1.0/work/gcc-9.1.0/libstdc++-v3/libsupc++/vterminate.cc:95\n#9  0x00007fe401742dc0 in __cxxabiv1::__terminate () at /storage/strogdon/gentoo-rap/var/tmp/portage/sys-devel/gcc-9.1.0/work/gcc-9.1.0/libstdc++-v3/libsupc++/eh_terminate.cc:47\n#10 0x00007fe401742e00 in std::terminate () at /storage/strogdon/gentoo-rap/var/tmp/portage/sys-devel/gcc-9.1.0/work/gcc-9.1.0/libstdc++-v3/libsupc++/eh_terminate.cc:57\n#11 0x00007fe401743000 in __cxxabiv1::__cxa_throw () at /storage/strogdon/gentoo-rap/var/tmp/portage/sys-devel/gcc-9.1.0/work/gcc-9.1.0/libstdc++-v3/libsupc++/eh_throw.cc:95\n#12 0x00007fe401715ac6 in std::__throw_length_error () at /storage/strogdon/gentoo-rap/var/tmp/portage/sys-devel/gcc-9.1.0/work/gcc-9.1.0/libstdc++-v3/src/c++11/functexcept.cc:78\n#13 0x00007fe3aa2e6ea2 in std::deque<polybori::CCuddNavigator, std::allocator<polybori::CCuddNavigator> >::_M_new_elements_at_back () at /storage/strogdon/gentoo-rap/usr/lib64/gcc/x86_64-pc-linux-gnu/9.1.0/include/g++-v9/bits/stl_deque.h:2191\n  2186           *  Makes sure the _M_map has space for new nodes.  Does not\n  2187           *  actually add the nodes.  Can invalidate _M_map pointers.\n  2188           *  (And consequently, %deque iterators.)\n  2189           */\n  2190          void\n> 2191          _M_reserve_map_at_back(size_type __nodes_to_add = 1)\n  2192          {\n  2193          if (__nodes_to_add + 1 > this->_M_impl._M_map_size\n  2194              - (this->_M_impl._M_finish._M_node - this->_M_impl._M_map))\n  2195            _M_reallocate_map(__nodes_to_add, false);\n```\n\nI'd say there is something to fix in Cudd inside brial.",
    "created_at": "2019-05-18T23:22:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386818",
    "user": "@kiwifb"
}
```

That's less than I have in sage-on-gentoo but I haven't rebuilt everything yet. But there is really a track leading to pbori not sure if it is just the sage interface or brial itself. brial passes its own testsuite with gcc-9.1 that's already something but not necessarilly conclusive that it is all on sage-side.

From what Steve Trogdon posted to me

```
Cython backtrace
----------------
#0  0x00007fe418a5fd80 in __waitpid () at /storage/strogdon/gentoo-rap/var/tmp/portage/sys-libs/glibc-2.29-r2/work/glibc-2.29/nptl/../sysdeps/unix/sysv/linux/waitpid.c:30
#1  0x00007fe4104374eb in print_enhanced_backtrace () at /storage/strogdon/gentoo-rap/var/tmp/portage/dev-python/cysignals-1.10.2/work/cysignals-1.10.2/build/src/cysignals/implementation.c:563
#2  0x00007fe410437687 in sigdie () at /storage/strogdon/gentoo-rap/var/tmp/portage/dev-python/cysignals-1.10.2/work/cysignals-1.10.2/build/src/cysignals/implementation.c:589
#3  0x00007fe410436a0e in sigdie_for_sig () at /storage/strogdon/gentoo-rap/var/tmp/portage/dev-python/cysignals-1.10.2/work/cysignals-1.10.2/build/src/cysignals/implementation.c:160
#4  0x00007fe410436ba6 in cysigs_signal_handler () at /storage/strogdon/gentoo-rap/var/tmp/portage/dev-python/cysignals-1.10.2/work/cysignals-1.10.2/build/src/cysignals/implementation.c:262
#5  0x00007fe4190cea30 in __restore_rt ()
#6  0x00007fe4186b6330 in __GI_raise () at /storage/strogdon/gentoo-rap/var/tmp/portage/sys-libs/glibc-2.29-r2/work/glibc-2.29/signal/../sysdeps/unix/sysv/linux/raise.c:50
#7  0x00007fe41869f7a4 in __GI_abort () at /storage/strogdon/gentoo-rap/var/tmp/portage/sys-libs/glibc-2.29-r2/work/glibc-2.29/stdlib/abort.c:79
#8  0x00007fe401744d20 in __gnu_cxx::__verbose_terminate_handler () at /storage/strogdon/gentoo-rap/var/tmp/portage/sys-devel/gcc-9.1.0/work/gcc-9.1.0/libstdc++-v3/libsupc++/vterminate.cc:95
#9  0x00007fe401742dc0 in __cxxabiv1::__terminate () at /storage/strogdon/gentoo-rap/var/tmp/portage/sys-devel/gcc-9.1.0/work/gcc-9.1.0/libstdc++-v3/libsupc++/eh_terminate.cc:47
#10 0x00007fe401742e00 in std::terminate () at /storage/strogdon/gentoo-rap/var/tmp/portage/sys-devel/gcc-9.1.0/work/gcc-9.1.0/libstdc++-v3/libsupc++/eh_terminate.cc:57
#11 0x00007fe401743000 in __cxxabiv1::__cxa_throw () at /storage/strogdon/gentoo-rap/var/tmp/portage/sys-devel/gcc-9.1.0/work/gcc-9.1.0/libstdc++-v3/libsupc++/eh_throw.cc:95
#12 0x00007fe401715ac6 in std::__throw_length_error () at /storage/strogdon/gentoo-rap/var/tmp/portage/sys-devel/gcc-9.1.0/work/gcc-9.1.0/libstdc++-v3/src/c++11/functexcept.cc:78
#13 0x00007fe3aa2e6ea2 in std::deque<polybori::CCuddNavigator, std::allocator<polybori::CCuddNavigator> >::_M_new_elements_at_back () at /storage/strogdon/gentoo-rap/usr/lib64/gcc/x86_64-pc-linux-gnu/9.1.0/include/g++-v9/bits/stl_deque.h:2191
  2186           *  Makes sure the _M_map has space for new nodes.  Does not
  2187           *  actually add the nodes.  Can invalidate _M_map pointers.
  2188           *  (And consequently, %deque iterators.)
  2189           */
  2190          void
> 2191          _M_reserve_map_at_back(size_type __nodes_to_add = 1)
  2192          {
  2193          if (__nodes_to_add + 1 > this->_M_impl._M_map_size
  2194              - (this->_M_impl._M_finish._M_node - this->_M_impl._M_map))
  2195            _M_reallocate_map(__nodes_to_add, false);
```

I'd say there is something to fix in Cudd inside brial.



---

archive/issue_comments_386819.json:
```json
{
    "body": "I should have posted this elsewhere.",
    "created_at": "2019-05-19T03:56:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386819",
    "user": "@strogdon"
}
```

I should have posted this elsewhere.



---

archive/issue_comments_386820.json:
```json
{
    "body": "Brial testsuite passes for me, too (gcc 9.1.1 / Fedora 30)",
    "created_at": "2019-05-19T12:49:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386820",
    "user": "@vbraun"
}
```

Brial testsuite passes for me, too (gcc 9.1.1 / Fedora 30)



---

archive/issue_comments_386821.json:
```json
{
    "body": "I think the culprit is in a higher stack frame, presumably std::deque runs out of memory because an invalid size is passed in. In particular, this looks fishy:\n\n```\n#10 pbori_cuddInitCache (unique=unique@entry=0x7f8185b293f0, \n    cacheSize=cacheSize@entry=262144, maxCacheSize=699050, \n    maxCacheSize@entry=<error reading variable: DW_OP_const_type has different sizes for type and data>) at cuddCache.c:152\n        i = <optimized out>\n        logSize = 18\n        mem = <optimized out>\n        offset = <optimized out>\n        __PRETTY_FUNCTION__ = \"pbori_cuddInitCache\"\n```\n",
    "created_at": "2019-05-19T13:08:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386821",
    "user": "@vbraun"
}
```

I think the culprit is in a higher stack frame, presumably std::deque runs out of memory because an invalid size is passed in. In particular, this looks fishy:

```
#10 pbori_cuddInitCache (unique=unique@entry=0x7f8185b293f0, 
    cacheSize=cacheSize@entry=262144, maxCacheSize=699050, 
    maxCacheSize@entry=<error reading variable: DW_OP_const_type has different sizes for type and data>) at cuddCache.c:152
        i = <optimized out>
        logSize = 18
        mem = <optimized out>
        offset = <optimized out>
        __PRETTY_FUNCTION__ = "pbori_cuddInitCache"
```




---

archive/issue_comments_386822.json:
```json
{
    "body": "There is quite a fat memory leak, e.g.\n\n```\nsage: for i in range(300):\n....:     B = BooleanPolynomialRing(5,'x{}'.format(i))\n```\n\neats 5GB. Changing the memory limit, e.g.\n\n```\n./sage -t --memlimit=2000 src/sage/rings/polynomial/pbori.pyx\n```\n\nchanges where the error occurs",
    "created_at": "2019-05-19T14:43:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386822",
    "user": "@vbraun"
}
```

There is quite a fat memory leak, e.g.

```
sage: for i in range(300):
....:     B = BooleanPolynomialRing(5,'x{}'.format(i))
```

eats 5GB. Changing the memory limit, e.g.

```
./sage -t --memlimit=2000 src/sage/rings/polynomial/pbori.pyx
```

changes where the error occurs



---

archive/issue_comments_386823.json:
```json
{
    "body": "Disabling the memlimit lets me complete\n\n```\nsage -t --memlimit=0 src/sage/rings/polynomial/pbori.pyx\n```\n\nbut does eat much more memory than before. Doing it with the other tests eats all available memory",
    "created_at": "2019-05-19T17:14:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386823",
    "user": "@vbraun"
}
```

Disabling the memlimit lets me complete

```
sage -t --memlimit=0 src/sage/rings/polynomial/pbori.pyx
```

but does eat much more memory than before. Doing it with the other tests eats all available memory



---

archive/issue_comments_386824.json:
```json
{
    "body": "Did you try going from -std=gnu++11 to -std=c++11 ? This can be done by\napplying \n\n```diff\n--- a/build/pkgs/gcc/spkg-configure.m4\n+++ b/build/pkgs/gcc/spkg-configure.m4\n@@ -94,7 +94,7 @@ SAGE_SPKG_CONFIGURE([gcc], [\n         IS_REALLY_GCC=yes\n     fi\n \n-    AX_CXX_COMPILE_STDCXX_11([], optional)\n+    AX_CXX_COMPILE_STDCXX_11([noext], optional)\n     if test $HAVE_CXX11 != 1; then\n         SAGE_MUST_INSTALL_GCC([your C++ compiler does not support C++11])\n     fi\n```\n",
    "created_at": "2019-05-19T18:07:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386824",
    "user": "@dimpase"
}
```

Did you try going from -std=gnu++11 to -std=c++11 ? This can be done by
applying 

```diff
--- a/build/pkgs/gcc/spkg-configure.m4
+++ b/build/pkgs/gcc/spkg-configure.m4
@@ -94,7 +94,7 @@ SAGE_SPKG_CONFIGURE([gcc], [
         IS_REALLY_GCC=yes
     fi
 
-    AX_CXX_COMPILE_STDCXX_11([], optional)
+    AX_CXX_COMPILE_STDCXX_11([noext], optional)
     if test $HAVE_CXX11 != 1; then
         SAGE_MUST_INSTALL_GCC([your C++ compiler does not support C++11])
     fi
```




---

archive/issue_comments_386825.json:
```json
{
    "body": "as well, our boost (and pbori uses it) is 2.5 y.o. version 1.66, while the current one is 1.70.",
    "created_at": "2019-05-19T18:19:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386825",
    "user": "@dimpase"
}
```

as well, our boost (and pbori uses it) is 2.5 y.o. version 1.66, while the current one is 1.70.



---

archive/issue_comments_386826.json:
```json
{
    "body": "Brial's reference counting implementation miscompiles with gcc9, and the branch where the refcount falls back to zero is never executed. Hence the ram usage ballooning. I've opened an upstream bug:\n\nhttps://gcc.gnu.org/bugzilla/show_bug.cgi?id=90535",
    "created_at": "2019-05-19T20:11:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386826",
    "user": "@vbraun"
}
```

Brial's reference counting implementation miscompiles with gcc9, and the branch where the refcount falls back to zero is never executed. Hence the ram usage ballooning. I've opened an upstream bug:

https://gcc.gnu.org/bugzilla/show_bug.cgi?id=90535



---

archive/issue_comments_386827.json:
```json
{
    "body": "it is insane that this kind of address arithmetic is invalid C, as they imply on the ticket. Where is it said in the standard?",
    "created_at": "2019-05-19T20:40:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386827",
    "user": "@dimpase"
}
```

it is insane that this kind of address arithmetic is invalid C, as they imply on the ticket. Where is it said in the standard?



---

archive/issue_comments_386828.json:
```json
{
    "body": "I don't think they imply this is invalid C. But this is fairly rare occurrence and, if I am reading correctly, accounting for it everywhere means some optimisation opportunities are lost. As you'll note, Volker said the example works at `-O0`. This is from GNU gcc devs from whom I learned that pessimized  was a word (at least they use it).\n\nI should be able to do a micro release of brial to include that option this week. PR welcome if you feel faster. I may also check if I can safely update the `cudd` code in brial to a more recent version. It may be that newer `cudd` doesn't exhibit the problem. \n\n`@`Volker in which brial file does the incriminated code occur?",
    "created_at": "2019-05-19T20:56:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386828",
    "user": "@kiwifb"
}
```

I don't think they imply this is invalid C. But this is fairly rare occurrence and, if I am reading correctly, accounting for it everywhere means some optimisation opportunities are lost. As you'll note, Volker said the example works at `-O0`. This is from GNU gcc devs from whom I learned that pessimized  was a word (at least they use it).

I should be able to do a micro release of brial to include that option this week. PR welcome if you feel faster. I may also check if I can safely update the `cudd` code in brial to a more recent version. It may be that newer `cudd` doesn't exhibit the problem. 

`@`Volker in which brial file does the incriminated code occur?



---

archive/issue_comments_386829.json:
```json
{
    "body": "OK, if they willingly mis-compile valid code for the sake of optimisation, they should at least print fat warnings about code branches they discard...",
    "created_at": "2019-05-19T21:07:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386829",
    "user": "@dimpase"
}
```

OK, if they willingly mis-compile valid code for the sake of optimisation, they should at least print fat warnings about code branches they discard...



---

archive/issue_comments_386830.json:
```json
{
    "body": "Replying to [comment:21 fbissey]:\n> ...\n>\n> I should be able to do a micro release of brial to include that option this week. PR welcome if you feel faster. I may also check if I can safely update the `cudd` code in brial to a more recent version. It may be that newer `cudd` doesn't exhibit the problem. \n> ...\n> \nPerhaps I misunderstand but my s-o-g `brial` build uses `-O0`; in fact, the system is built that way. And the tests still fail.",
    "created_at": "2019-05-19T21:13:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386830",
    "user": "@strogdon"
}
```

Replying to [comment:21 fbissey]:
> ...
>
> I should be able to do a micro release of brial to include that option this week. PR welcome if you feel faster. I may also check if I can safely update the `cudd` code in brial to a more recent version. It may be that newer `cudd` doesn't exhibit the problem. 
> ...
> 
Perhaps I misunderstand but my s-o-g `brial` build uses `-O0`; in fact, the system is built that way. And the tests still fail.



---

archive/issue_comments_386831.json:
```json
{
    "body": "OK, Volker's example works at -O0 may be our real life code is a bit more complicated. Could you compile brial with `-fno-delete-null-pointer-checks` in the CFLAGS (and CXXFLAGS too for good measure).",
    "created_at": "2019-05-19T21:17:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386831",
    "user": "@kiwifb"
}
```

OK, Volker's example works at -O0 may be our real life code is a bit more complicated. Could you compile brial with `-fno-delete-null-pointer-checks` in the CFLAGS (and CXXFLAGS too for good measure).



---

archive/issue_comments_386832.json:
```json
{
    "body": "Replying to [comment:24 fbissey]:\n> OK, Volker's example works at -O0 may be our real life code is a bit more complicated. Could you compile brial with `-fno-delete-null-pointer-checks` in the CFLAGS (and CXXFLAGS too for good measure).\n\nI still get the 3 failures, `brial` built with\n\n```\nCFLAGS=\"-march=native -O0 -fno-delete-null-pointer-checks -pipe -g -ggdb\"\nCXXFLAGS=\"${CFLAGS}\"\n```\n",
    "created_at": "2019-05-19T21:35:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386832",
    "user": "@strogdon"
}
```

Replying to [comment:24 fbissey]:
> OK, Volker's example works at -O0 may be our real life code is a bit more complicated. Could you compile brial with `-fno-delete-null-pointer-checks` in the CFLAGS (and CXXFLAGS too for good measure).

I still get the 3 failures, `brial` built with

```
CFLAGS="-march=native -O0 -fno-delete-null-pointer-checks -pipe -g -ggdb"
CXXFLAGS="${CFLAGS}"
```




---

archive/issue_comments_386833.json:
```json
{
    "body": "Reading more into this, C++11 Standard 5.7.5 says that pointer arithmetic on a pointer that is not pointing into an element of an array is undefined behavior. So in particular the compiler is free to assume that `--ptr` cannot be NULL, since you can't have allocated an array that starts at 0x1. \n\nThe offending code is \n\n```\n/// Release current pointer by decrementing reference counting\ninline void \nintrusive_ptr_release(PBORI_PREFIX(DdManager)* ptr) {\n   if (!(--(ptr->hooks))) {\n \n    PBORI_ASSERT(PBORI_PREFIX(Cudd_CheckZeroRef)(ptr) == 0);\n    PBORI_PREFIX(Cudd_Quit)(ptr);\n  }\n}\n```\n\nReally we should just change `DdManager.hooks` to be an `std::size_t` instead of `char*`, why on earth are you using pointer arithmetic to count in the first place. I think thats going to be a simple change since its only used in one or two places.\n\nThese are inlined headers so you also need to rebuild the sage library....",
    "created_at": "2019-05-19T22:09:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386833",
    "user": "@vbraun"
}
```

Reading more into this, C++11 Standard 5.7.5 says that pointer arithmetic on a pointer that is not pointing into an element of an array is undefined behavior. So in particular the compiler is free to assume that `--ptr` cannot be NULL, since you can't have allocated an array that starts at 0x1. 

The offending code is 

```
/// Release current pointer by decrementing reference counting
inline void 
intrusive_ptr_release(PBORI_PREFIX(DdManager)* ptr) {
   if (!(--(ptr->hooks))) {
 
    PBORI_ASSERT(PBORI_PREFIX(Cudd_CheckZeroRef)(ptr) == 0);
    PBORI_PREFIX(Cudd_Quit)(ptr);
  }
}
```

Really we should just change `DdManager.hooks` to be an `std::size_t` instead of `char*`, why on earth are you using pointer arithmetic to count in the first place. I think thats going to be a simple change since its only used in one or two places.

These are inlined headers so you also need to rebuild the sage library....



---

archive/issue_comments_386834.json:
```json
{
    "body": "Indeed, this succeeds for me:\n\n```\nexport CFLAGS='-fno-delete-null-pointer-checks'\nexport CXXFLAGS='-fno-delete-null-pointer-checks'\n./sage -p brial\ntouch src/sage/rings/polynomial/pbori.pyx \n./sage -b\n./sage -t --long src/sage/rings/polynomial/pbori.pyx\n./sage -t --long src/sage/crypto/mq/sr.py\n./sage -t --long src/sage/rings/polynomial/multi_polynomial_sequence.py\n```\n",
    "created_at": "2019-05-19T22:16:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386834",
    "user": "@vbraun"
}
```

Indeed, this succeeds for me:

```
export CFLAGS='-fno-delete-null-pointer-checks'
export CXXFLAGS='-fno-delete-null-pointer-checks'
./sage -p brial
touch src/sage/rings/polynomial/pbori.pyx 
./sage -b
./sage -t --long src/sage/rings/polynomial/pbori.pyx
./sage -t --long src/sage/crypto/mq/sr.py
./sage -t --long src/sage/rings/polynomial/multi_polynomial_sequence.py
```




---

archive/issue_comments_386835.json:
```json
{
    "body": "OK I thought it was in the C code from Cudd. But this is the C++ interface to Cudd from brial. That code is in `libbrial/include/polybori/rings/CCuddInterface.h`. There is some more suspicious code in `libbrial/include/polybori/rings/CCuddCore.h`\n\n```\n/// Release this by decrementing reference counting\n  refcount_type release() {\n    return (--ref);\n  }\n```\n",
    "created_at": "2019-05-19T22:20:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386835",
    "user": "@kiwifb"
}
```

OK I thought it was in the C code from Cudd. But this is the C++ interface to Cudd from brial. That code is in `libbrial/include/polybori/rings/CCuddInterface.h`. There is some more suspicious code in `libbrial/include/polybori/rings/CCuddCore.h`

```
/// Release this by decrementing reference counting
  refcount_type release() {
    return (--ref);
  }
```




---

archive/issue_comments_386836.json:
```json
{
    "body": "`refcount_type` is just a typedef for `std::size_t` so thats perfect.\n\nSince we don't want to change the `DdManager` struct I guess we have to allocate a value for `DdManager.hooks`.",
    "created_at": "2019-05-19T22:29:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386836",
    "user": "@vbraun"
}
```

`refcount_type` is just a typedef for `std::size_t` so thats perfect.

Since we don't want to change the `DdManager` struct I guess we have to allocate a value for `DdManager.hooks`.



---

archive/issue_comments_386837.json:
```json
{
    "body": "If you send a pull request I can make a quick release of brial.",
    "created_at": "2019-05-19T22:38:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386837",
    "user": "@kiwifb"
}
```

If you send a pull request I can make a quick release of brial.



---

archive/issue_comments_386838.json:
```json
{
    "body": "Replying to [comment:27 vbraun]:\n> Indeed, this succeeds for me:\n> {{{\n> export CFLAGS='-fno-delete-null-pointer-checks'\n> export CXXFLAGS='-fno-delete-null-pointer-checks'\n> ./sage -p brial\n> touch src/sage/rings/polynomial/pbori.pyx \n> ./sage -b\n> ./sage -t --long src/sage/rings/polynomial/pbori.pyx\n> ./sage -t --long src/sage/crypto/mq/sr.py\n> ./sage -t --long src/sage/rings/polynomial/multi_polynomial_sequence.py\n> }}}\nOK, rebuilding Sage also with the new CFLAGS does work here. I never thought about the headers.",
    "created_at": "2019-05-19T23:22:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386838",
    "user": "@strogdon"
}
```

Replying to [comment:27 vbraun]:
> Indeed, this succeeds for me:
> {{{
> export CFLAGS='-fno-delete-null-pointer-checks'
> export CXXFLAGS='-fno-delete-null-pointer-checks'
> ./sage -p brial
> touch src/sage/rings/polynomial/pbori.pyx 
> ./sage -b
> ./sage -t --long src/sage/rings/polynomial/pbori.pyx
> ./sage -t --long src/sage/crypto/mq/sr.py
> ./sage -t --long src/sage/rings/polynomial/multi_polynomial_sequence.py
> }}}
OK, rebuilding Sage also with the new CFLAGS does work here. I never thought about the headers.



---

archive/issue_comments_386839.json:
```json
{
    "body": "By the way, perhaps it's time to drop gcc 4. Indeed, 4.9.4 was the last 4.* release, and it happened in 2016.",
    "created_at": "2019-05-20T12:21:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386839",
    "user": "@dimpase"
}
```

By the way, perhaps it's time to drop gcc 4. Indeed, 4.9.4 was the last 4.* release, and it happened in 2016.



---

archive/issue_comments_386840.json:
```json
{
    "body": "I am now using the following if gcc-9.1 is present in sage-on-gentoo\n\n```diff\ndiff --git a/sage/libs/polybori/decl.pxd b/sage/libs/polybori/decl.pxd\nindex dd6a3aa..edb7bb7 100644\n--- a/sage/libs/polybori/decl.pxd\n+++ b/sage/libs/polybori/decl.pxd\n@@ -1,5 +1,5 @@\n # distutils: language = c++\n-# distutils: extra_compile_args = -std=c++11\n+# distutils: extra_compile_args = -std=c++11 -fno-delete-null-pointer-checks\n \n from libcpp.string cimport string as std_string\n from libcpp.vector cimport vector\n```\n\nIt is possibly over-broad.",
    "created_at": "2019-05-21T21:20:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386840",
    "user": "@kiwifb"
}
```

I am now using the following if gcc-9.1 is present in sage-on-gentoo

```diff
diff --git a/sage/libs/polybori/decl.pxd b/sage/libs/polybori/decl.pxd
index dd6a3aa..edb7bb7 100644
--- a/sage/libs/polybori/decl.pxd
+++ b/sage/libs/polybori/decl.pxd
@@ -1,5 +1,5 @@
 # distutils: language = c++
-# distutils: extra_compile_args = -std=c++11
+# distutils: extra_compile_args = -std=c++11 -fno-delete-null-pointer-checks
 
 from libcpp.string cimport string as std_string
 from libcpp.vector cimport vector
```

It is possibly over-broad.



---

archive/issue_comments_386841.json:
```json
{
    "body": "PR at https://github.com/BRiAl/BRiAl/pull/35",
    "created_at": "2019-06-05T21:54:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386841",
    "user": "@vbraun"
}
```

PR at https://github.com/BRiAl/BRiAl/pull/35



---

archive/issue_comments_386842.json:
```json
{
    "body": "New brial release [https://github.com/BRiAl/BRiAl/releases/download/1.2.5/brial-1.2.5.tar.bz2](https://github.com/BRiAl/BRiAl/releases/download/1.2.5/brial-1.2.5.tar.bz2) with the PR included. Do we create a separate ticket for the upgrade?",
    "created_at": "2019-06-06T00:10:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386842",
    "user": "@kiwifb"
}
```

New brial release [https://github.com/BRiAl/BRiAl/releases/download/1.2.5/brial-1.2.5.tar.bz2](https://github.com/BRiAl/BRiAl/releases/download/1.2.5/brial-1.2.5.tar.bz2) with the PR included. Do we create a separate ticket for the upgrade?



---

archive/issue_comments_386843.json:
```json
{
    "body": "Please do make a ticket for that!",
    "created_at": "2019-06-06T22:38:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386843",
    "user": "@vbraun"
}
```

Please do make a ticket for that!



---

archive/issue_comments_386844.json:
```json
{
    "body": "#27942 is ready for review for brial.",
    "created_at": "2019-06-06T22:48:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386844",
    "user": "@kiwifb"
}
```

#27942 is ready for review for brial.



---

archive/issue_comments_386845.json:
```json
{
    "body": "As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).",
    "created_at": "2019-06-14T14:55:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386845",
    "user": "@embray"
}
```

As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).



---

archive/issue_comments_386846.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-08-08T00:16:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386846",
    "user": "@kiwifb"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_386847.json:
```json
{
    "body": "I think we pretty much fixed this by opening separate tickets for each separate problems. So now, this meta ticket should be closed.",
    "created_at": "2019-08-08T00:16:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386847",
    "user": "@kiwifb"
}
```

I think we pretty much fixed this by opening separate tickets for each separate problems. So now, this meta ticket should be closed.



---

archive/issue_comments_386848.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-08-11T02:58:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386848",
    "user": "@strogdon"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_386849.json:
```json
{
    "body": "I agree.",
    "created_at": "2019-08-11T02:58:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386849",
    "user": "@strogdon"
}
```

I agree.



---

archive/issue_comments_386850.json:
```json
{
    "body": "Resolution: wontfix",
    "created_at": "2019-08-12T08:50:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27439#issuecomment-386850",
    "user": "@embray"
}
```

Resolution: wontfix
