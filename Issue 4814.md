# Issue 4814: serious bug in Sage/GMP-ECM interface

archive/issues_004814.json:
```json
{
    "body": "Assignee: @williamstein\n\n\n```\n\n\nOn Tue, Dec 16, 2008 at 12:50 AM, achrzesz <achrzesz@wp.pl> wrote:\n>\n> Hallo,\n> I'm wondering what goes  wrong with tis:\n>\n> (sage 3.2 compiled from sources, ubuntu 8.04, quad core 2.4 GHz)\n>\n>\n> sage: for k in range(14,21):\n> ....:     f=2^2^k+1;w=ecm.find_factor(f);[w[0],prod(w)==f]\n> ....:\n> [2, False]\n> [523923, False]\n> [1901173, False]\n> [2, False]\n> [2, False]\n> [30539, False]\n> [2, False]\n>\n> Are the exponents to big?\n>\n> Andrzej Chrzeszczyk\n\nYes, I think there must be a hard limit on the input line for GMP-ECM.    If I try the first number directly on the command line, it says \"Factor found in step 1: 2\".  However the first number is *odd*, so 2 can't be a factor!\nWhat's really happening is that GMP-ECM is ignoring everything after the first 4095 digits when I paste the input in.\n\necm 10000000 100000\nGMP-ECM 6.1.3 [powered by GMP 4.2.1] [ECM]\n118973149535723176508575932662800713076344468709651023747267482123326135818048368690448859547261203991511543748483930925889766738130868742627452469834156500608087163436600489752214325161953144684595234570948213584703664746483098478471428096784561413847604433840488612290528685531323615869599988579010635701812081536332078096432371275716429061340687520241736532395026788008906751737227061083564754575578079343162221345190381785963069031134385065753936064964519328317829176765896540528511355613436979328172588801590841467528983253806341923488859989898062311402512167447205187243932132319840294270534136695127473901459381689828899444517340036461792837713807441134579184857359507717043764419174388964488537768473832224060823907906139947567533473978401649174262148522901484767233597789715839733422634973481144165307775825098892603089478960467615310425726014180682302758800344195145532770159807128158959716941396560843950498317125506228202662620004804214980820000206099343368123762385788062747972707287748283843870504803416463333701338540599804070190866238730160501818826257372376627924079893171770880790174026540793097641964887786960401751769193868798808800894425125882696968836419413394578015784436494605271365545490632718742853189510027869511932349680870363043619392759269234482081283429736447868686206416904245855513653205505050818989186684686379991764754729137157350070101519755909745304003303152068351821649419563669607774811059828490134361146921427412181049507797927555664516498385006205106651708464736946403664056933946483717218335295687391204264000361161878927819571005209456276130670355184033011064510199543516762668866962776382060434248035790641535421273294675607300690708887049612505006815665925276129766406549834749266179882406231221040927458456558726484641765016012317587403472626195728908146619765155383074442470969863475362777035622712614505254912522944804014911479568135987596851280857524427187145545408489498615502079480698093921565805531916564168110596645415995147690858312972150329881658514207306148088802176981833841712939687837145957584605258314292844724970369854812529577592093645002265142724994958070820396608284755092189115213332104801197388363657782553332598885215632543933502131531213408139045102125536370790349591696312592420116787719010893525591453948821689711794326937360863907447279275111671512710639642508135355313721355289053980260297864531979510097643293909192466022887891290065421011828729829870738215971718456954051540302917330729245439178956867421964076145117360061775218699191336683703388720158207162586824713310451331509727471344272834060664289040649663610444321775281122747002916285809372770104964649954022098398193278661320425422646424368961010742992319763868154583756177353556898453605362723442427710576092486402378162966552631491090696048807347521700512113631187043992576250866603256621375041669571991967422321060672472137347123402161354071218823990970197194394434748031421790388631776777992153989217733434436890755031880083354685234437032708928414750164058944848200125423738668007445734191093377489195968101651606910614990557242581089558693883306749020490036862416630196855300568704028509545048484007352864382657040376715728651238025510995451885701347658818930000413884971588313986607154757481647672763511643546280440111271139252918057079419342268681835321279906897224769719147426815791219597379419280729888695236110088026425880132092804001192815397080113074133955000329901592497825993697435872628614398052011245436927111408374791900780340659632135341700406886944340547214067596364099740500922580350567272646509550626733926889242436456189766190689842418677049103534408039924832709791171288114017038418205860161475828420075018350032935849969186406659053966070906953738160188767904665775965458800193711777134469832642879262289433801611244553353944708746204976340914754209924881552139592938800771117201789489779370660427348098516102881545878791116097911342243355754917090544202639727569528320730533184541999074934781052400619419720059165214786719369625433786498160383314635420170062881794717751811521767435201651117234772772707522005617774821892859715834674454[[I hear bings as all further digits are ignored]]\nInput number has 4095 digits\n********** Factor found in step 1: 2\nFound probable prime factor of  1 digits: 2\nComposite cofactor 59486574767861588254287966331400356538172234354825511873633741061663067909024184345224429773630601995755771874241965462944883369065434371313726234917078250304043581718300244876107162580976572342297617285474106792351832373241549239235714048392280706923802216920244306145264342765661807934799994289505317850906040768166039048216185637858214530670343760120868266197513394004453375868613530541782377287789039671581110672595190892981534515567192532876968032482259664158914588382948270264255677806718489664086294400795420733764491626903170961744429994949031155701256083723602593621966066159920147135267068347563736950729690844914449722258670018230896418856903720567289592428679753858521882209587194482244268884236916112030411953953069973783766736989200824587131074261450742383616798894857919866711317486740572082653887912549446301544739480233807655212863007090341151379400172097572766385079903564079479858470698280421975249158562753114101331310002402107490410000103049671684061881192894031373986353643874141921935252401708231666850669270299902035095433119365080250909413128686188313962039946585885440395087013270396548820982443893480200875884596934399404400447212562941348484418209706697289007892218247302635682772745316359371426594755013934755966174840435181521809696379634617241040641714868223934343103208452122927756826602752525409494593342343189995882377364568578675035050759877954872652001651576034175910824709781834803887405529914245067180573460713706090524753898963777832258249192503102553325854232368473201832028466973241858609167647843695602132000180580939463909785502604728138065335177592016505532255099771758381334433481388191030217124017895320767710636647337803650345354443524806252503407832962638064883203274917374633089941203115610520463729228279363242320882508006158793701736313097864454073309882577691537221235484931737681388517811356307252627456261472402007455739784067993798425640428762213593572772704244749307751039740349046960782902765958282084055298322707997573845429156486075164940829257103653074044401088490916920856469843918572978792302629157146422362485184927406264788796046822501132571362497479035410198304142377546094557606666052400598694181828891276666299442607816271966751065765606704069522551062768185395174795848156296210058393859505446762795726974410844855897163468680431953723639637555835756355319821254067677656860677644526990130148932265989755048821646954596233011443945645032710505914364914935369107985859228477025770151458665364622719589478433710982038072558680030887609349595668341851694360079103581293412356655225665754863735672136417030332144520324831805222160887640561373501458142904686385052482324977011049199096639330660212711323212184480505371496159881934077291878088676778449226802681361721213855288046243201189081483276315745545348024403673760850256056815593521996288125433301628310687520834785995983711160530336236068673561701080677035609411995485098597197217374015710895194315888388996076994608866717218445377515940041677342617218516354464207375082029472424100062711869334003722867095546688744597984050825803455307495278621290544779346941653374510245018431208315098427650284352014254772524242003676432191328520188357864325619012755497725942850673829409465000206942485794156993303577378740823836381755821773140220055635569626459028539709671134340917660639953448612384859573713407895609798689709640364944347618055044013212940066046402000596407698540056537066977500164950796248912996848717936314307199026005622718463555704187395950390170329816067670850203443472170273607033798182049870250461290175283636323254775313366963444621218228094883095344921209338524551767204019962416354895585644057008519209102930080737914210037509175016467924984593203329526983035453476869080094383952332887982729400096855888567234916321439631144716900805622276676972354373102488170457377104962440776069796469400385558600894744889685330213674049258051440772939395558048955671121677877458545272101319863784764160365266592270999537467390526200309709860029582607393359684812716893249080191657317710085031440897358875905760883717600825558617386386353761002808887410946429857917337227 has 4094 digits\n\nHowever, note that \n\nsage: len(str(f))\n4933\n\nPaul -- does GMP-ECM have a by-design hard limit of 4095 digits?   If so, then we have to give an error message from Sage immediately (raise a ValueError).  If not, how do we get around the command line 4095 digit limit?\n\nNote to self -- the function find_factor in Sage absolutely should have had a built-in consistency check that everything found was really a factor.  It can't hurt to do that, and may have caught problems like this earlier. \n\n -- William\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/4814\n\n",
    "created_at": "2008-12-16T15:19:39Z",
    "labels": [
        "component: interfaces",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-3.2.3",
    "title": "serious bug in Sage/GMP-ECM interface",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/4814",
    "user": "https://github.com/williamstein"
}
```
Assignee: @williamstein


```


On Tue, Dec 16, 2008 at 12:50 AM, achrzesz <achrzesz@wp.pl> wrote:
>
> Hallo,
> I'm wondering what goes  wrong with tis:
>
> (sage 3.2 compiled from sources, ubuntu 8.04, quad core 2.4 GHz)
>
>
> sage: for k in range(14,21):
> ....:     f=2^2^k+1;w=ecm.find_factor(f);[w[0],prod(w)==f]
> ....:
> [2, False]
> [523923, False]
> [1901173, False]
> [2, False]
> [2, False]
> [30539, False]
> [2, False]
>
> Are the exponents to big?
>
> Andrzej Chrzeszczyk

Yes, I think there must be a hard limit on the input line for GMP-ECM.    If I try the first number directly on the command line, it says "Factor found in step 1: 2".  However the first number is *odd*, so 2 can't be a factor!
What's really happening is that GMP-ECM is ignoring everything after the first 4095 digits when I paste the input in.

ecm 10000000 100000
GMP-ECM 6.1.3 [powered by GMP 4.2.1] [ECM]
118973149535723176508575932662800713076344468709651023747267482123326135818048368690448859547261203991511543748483930925889766738130868742627452469834156500608087163436600489752214325161953144684595234570948213584703664746483098478471428096784561413847604433840488612290528685531323615869599988579010635701812081536332078096432371275716429061340687520241736532395026788008906751737227061083564754575578079343162221345190381785963069031134385065753936064964519328317829176765896540528511355613436979328172588801590841467528983253806341923488859989898062311402512167447205187243932132319840294270534136695127473901459381689828899444517340036461792837713807441134579184857359507717043764419174388964488537768473832224060823907906139947567533473978401649174262148522901484767233597789715839733422634973481144165307775825098892603089478960467615310425726014180682302758800344195145532770159807128158959716941396560843950498317125506228202662620004804214980820000206099343368123762385788062747972707287748283843870504803416463333701338540599804070190866238730160501818826257372376627924079893171770880790174026540793097641964887786960401751769193868798808800894425125882696968836419413394578015784436494605271365545490632718742853189510027869511932349680870363043619392759269234482081283429736447868686206416904245855513653205505050818989186684686379991764754729137157350070101519755909745304003303152068351821649419563669607774811059828490134361146921427412181049507797927555664516498385006205106651708464736946403664056933946483717218335295687391204264000361161878927819571005209456276130670355184033011064510199543516762668866962776382060434248035790641535421273294675607300690708887049612505006815665925276129766406549834749266179882406231221040927458456558726484641765016012317587403472626195728908146619765155383074442470969863475362777035622712614505254912522944804014911479568135987596851280857524427187145545408489498615502079480698093921565805531916564168110596645415995147690858312972150329881658514207306148088802176981833841712939687837145957584605258314292844724970369854812529577592093645002265142724994958070820396608284755092189115213332104801197388363657782553332598885215632543933502131531213408139045102125536370790349591696312592420116787719010893525591453948821689711794326937360863907447279275111671512710639642508135355313721355289053980260297864531979510097643293909192466022887891290065421011828729829870738215971718456954051540302917330729245439178956867421964076145117360061775218699191336683703388720158207162586824713310451331509727471344272834060664289040649663610444321775281122747002916285809372770104964649954022098398193278661320425422646424368961010742992319763868154583756177353556898453605362723442427710576092486402378162966552631491090696048807347521700512113631187043992576250866603256621375041669571991967422321060672472137347123402161354071218823990970197194394434748031421790388631776777992153989217733434436890755031880083354685234437032708928414750164058944848200125423738668007445734191093377489195968101651606910614990557242581089558693883306749020490036862416630196855300568704028509545048484007352864382657040376715728651238025510995451885701347658818930000413884971588313986607154757481647672763511643546280440111271139252918057079419342268681835321279906897224769719147426815791219597379419280729888695236110088026425880132092804001192815397080113074133955000329901592497825993697435872628614398052011245436927111408374791900780340659632135341700406886944340547214067596364099740500922580350567272646509550626733926889242436456189766190689842418677049103534408039924832709791171288114017038418205860161475828420075018350032935849969186406659053966070906953738160188767904665775965458800193711777134469832642879262289433801611244553353944708746204976340914754209924881552139592938800771117201789489779370660427348098516102881545878791116097911342243355754917090544202639727569528320730533184541999074934781052400619419720059165214786719369625433786498160383314635420170062881794717751811521767435201651117234772772707522005617774821892859715834674454[[I hear bings as all further digits are ignored]]
Input number has 4095 digits
********** Factor found in step 1: 2
Found probable prime factor of  1 digits: 2
Composite cofactor 59486574767861588254287966331400356538172234354825511873633741061663067909024184345224429773630601995755771874241965462944883369065434371313726234917078250304043581718300244876107162580976572342297617285474106792351832373241549239235714048392280706923802216920244306145264342765661807934799994289505317850906040768166039048216185637858214530670343760120868266197513394004453375868613530541782377287789039671581110672595190892981534515567192532876968032482259664158914588382948270264255677806718489664086294400795420733764491626903170961744429994949031155701256083723602593621966066159920147135267068347563736950729690844914449722258670018230896418856903720567289592428679753858521882209587194482244268884236916112030411953953069973783766736989200824587131074261450742383616798894857919866711317486740572082653887912549446301544739480233807655212863007090341151379400172097572766385079903564079479858470698280421975249158562753114101331310002402107490410000103049671684061881192894031373986353643874141921935252401708231666850669270299902035095433119365080250909413128686188313962039946585885440395087013270396548820982443893480200875884596934399404400447212562941348484418209706697289007892218247302635682772745316359371426594755013934755966174840435181521809696379634617241040641714868223934343103208452122927756826602752525409494593342343189995882377364568578675035050759877954872652001651576034175910824709781834803887405529914245067180573460713706090524753898963777832258249192503102553325854232368473201832028466973241858609167647843695602132000180580939463909785502604728138065335177592016505532255099771758381334433481388191030217124017895320767710636647337803650345354443524806252503407832962638064883203274917374633089941203115610520463729228279363242320882508006158793701736313097864454073309882577691537221235484931737681388517811356307252627456261472402007455739784067993798425640428762213593572772704244749307751039740349046960782902765958282084055298322707997573845429156486075164940829257103653074044401088490916920856469843918572978792302629157146422362485184927406264788796046822501132571362497479035410198304142377546094557606666052400598694181828891276666299442607816271966751065765606704069522551062768185395174795848156296210058393859505446762795726974410844855897163468680431953723639637555835756355319821254067677656860677644526990130148932265989755048821646954596233011443945645032710505914364914935369107985859228477025770151458665364622719589478433710982038072558680030887609349595668341851694360079103581293412356655225665754863735672136417030332144520324831805222160887640561373501458142904686385052482324977011049199096639330660212711323212184480505371496159881934077291878088676778449226802681361721213855288046243201189081483276315745545348024403673760850256056815593521996288125433301628310687520834785995983711160530336236068673561701080677035609411995485098597197217374015710895194315888388996076994608866717218445377515940041677342617218516354464207375082029472424100062711869334003722867095546688744597984050825803455307495278621290544779346941653374510245018431208315098427650284352014254772524242003676432191328520188357864325619012755497725942850673829409465000206942485794156993303577378740823836381755821773140220055635569626459028539709671134340917660639953448612384859573713407895609798689709640364944347618055044013212940066046402000596407698540056537066977500164950796248912996848717936314307199026005622718463555704187395950390170329816067670850203443472170273607033798182049870250461290175283636323254775313366963444621218228094883095344921209338524551767204019962416354895585644057008519209102930080737914210037509175016467924984593203329526983035453476869080094383952332887982729400096855888567234916321439631144716900805622276676972354373102488170457377104962440776069796469400385558600894744889685330213674049258051440772939395558048955671121677877458545272101319863784764160365266592270999537467390526200309709860029582607393359684812716893249080191657317710085031440897358875905760883717600825558617386386353761002808887410946429857917337227 has 4094 digits

However, note that 

sage: len(str(f))
4933

Paul -- does GMP-ECM have a by-design hard limit of 4095 digits?   If so, then we have to give an error message from Sage immediately (raise a ValueError).  If not, how do we get around the command line 4095 digit limit?

Note to self -- the function find_factor in Sage absolutely should have had a built-in consistency check that everything found was really a factor.  It can't hurt to do that, and may have caught problems like this earlier. 

 -- William
```


Issue created by migration from https://trac.sagemath.org/ticket/4814





---

archive/issue_comments_036423.json:
```json
{
    "body": "Attachment [trac_4814.patch](tarball://root/attachments/some-uuid/ticket4814/trac_4814.patch) by @williamstein created at 2008-12-16 15:42:54",
    "created_at": "2008-12-16T15:42:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4814#issuecomment-36423",
    "user": "https://github.com/williamstein"
}
```

Attachment [trac_4814.patch](tarball://root/attachments/some-uuid/ticket4814/trac_4814.patch) by @williamstein created at 2008-12-16 15:42:54



---

archive/issue_comments_036424.json:
```json
{
    "body": "It's OK as it stands, but I'm not sure that it's the right \"quick hack\" fix.\n\nThe problem is the hard-coded \"4095\": I don't think that it's the correct value, and it's possible the choke point could come earlier (although I believe that this would be unlikely; it's not likely unless the system is low on resources for handling tty input).\n\nThe proper \"quick hack\" fix is elusive :-}\n\nWhy not cut it back, say to 2047?",
    "created_at": "2008-12-16T16:05:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4814#issuecomment-36424",
    "user": "https://trac.sagemath.org/admin/accounts/users/justin"
}
```

It's OK as it stands, but I'm not sure that it's the right "quick hack" fix.

The problem is the hard-coded "4095": I don't think that it's the correct value, and it's possible the choke point could come earlier (although I believe that this would be unlikely; it's not likely unless the system is low on resources for handling tty input).

The proper "quick hack" fix is elusive :-}

Why not cut it back, say to 2047?



---

archive/issue_comments_036425.json:
```json
{
    "body": "But 4095 is the number of digits I get, at least in my tests on both OSX and Linux.  Isn't 2047 something arbitrary you just made up?  I chose 4095 because I literally pasted a bigger number in, and exactly 4095 digits get read, then all else is ignored. \n\nAnd isn't 4095 = 2^12 - 1, since it seems like a reasonable magic number :-)\n\n- William",
    "created_at": "2008-12-16T16:31:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4814#issuecomment-36425",
    "user": "https://github.com/williamstein"
}
```

But 4095 is the number of digits I get, at least in my tests on both OSX and Linux.  Isn't 2047 something arbitrary you just made up?  I chose 4095 because I literally pasted a bigger number in, and exactly 4095 digits get read, then all else is ignored. 

And isn't 4095 = 2^12 - 1, since it seems like a reasonable magic number :-)

- William



---

archive/issue_comments_036426.json:
```json
{
    "body": "\"4095\" is reasonable as a magic number, but I'm concerned that it's more random than magic in this case :-}\n\nSince we have a failure at precisely 4095 (or 6), I think we should err on the side of caution here: there's no direct evidence (from looking at the kernel source for Mac OS X) that 4095+/- 1 is magic, so we could trip over this later with a smaller value (3071 for example).  Linux may have similar limits, but not necessarily the same ones; their tty code differs.\n\nAs I noted above, dropping characters (which is what's being done here) can occur when this limit is hit, or for other \"resource-limit\" issues, and it's hard to predict what the number is in those cases.",
    "created_at": "2008-12-16T16:54:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4814#issuecomment-36426",
    "user": "https://trac.sagemath.org/admin/accounts/users/justin"
}
```

"4095" is reasonable as a magic number, but I'm concerned that it's more random than magic in this case :-}

Since we have a failure at precisely 4095 (or 6), I think we should err on the side of caution here: there's no direct evidence (from looking at the kernel source for Mac OS X) that 4095+/- 1 is magic, so we could trip over this later with a smaller value (3071 for example).  Linux may have similar limits, but not necessarily the same ones; their tty code differs.

As I noted above, dropping characters (which is what's being done here) can occur when this limit is hit, or for other "resource-limit" issues, and it's hard to predict what the number is in those cases.



---

archive/issue_comments_036427.json:
```json
{
    "body": "Mike Hansen considers this fix here a hack, so I opened #4855 to fix this properly. For now this fix can go into 3.2.3.\n\nCheers,\n\nMichael",
    "created_at": "2008-12-22T23:03:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4814#issuecomment-36427",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

Mike Hansen considers this fix here a hack, so I opened #4855 to fix this properly. For now this fix can go into 3.2.3.

Cheers,

Michael



---

archive/issue_comments_036428.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2008-12-22T23:34:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4814#issuecomment-36428",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

Resolution: fixed



---

archive/issue_comments_036429.json:
```json
{
    "body": "Merged in Sage 3.2.3.alpha0",
    "created_at": "2008-12-22T23:34:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/4814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/4814#issuecomment-36429",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

Merged in Sage 3.2.3.alpha0



---

archive/issue_events_005056.json:
```json
{
    "actor": "mabshoff",
    "created_at": "2008-12-22T23:34:42Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/4814",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/4814#event-5056"
}
```
