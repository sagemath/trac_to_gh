# Issue 14167: Race condition in singular doctest

Issue created by migration from https://trac.sagemath.org/ticket/14371

Original creator: jdemeyer

Original creation time: 2013-03-27 22:40:15

Assignee: mvngu

CC:  jpflori

On hawk (OpenSolaris):

```
sage -t --long devel/sage/sage/interfaces/expect.py
**********************************************************************
File "devel/sage/sage/interfaces/expect.py", line 1089, in sage.interfaces.expect.Expect._crash_msg
Failed example:
    singular('2+3')
Exception raised:
    Traceback (most recent call last):
      File "/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.9.beta2/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 460, in _run
        self.execute(example, compiled, test.globs)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.9.beta2/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 819, in execute
        exec compiled in globs
      File "<doctest sage.interfaces.expect.Expect._crash_msg[4]>", line 1, in <module>
        singular('2+3')
      File "/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.9.beta2/local/lib/python2.7/site-packages/sage/interfaces/singular.py", line 724, in __call__
        return SingularElement(self, type, x, False)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.9.beta2/local/lib/python2.7/site-packages/sage/interfaces/singular.py", line 1184, in __init__
        self._name = parent._create( value, type)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.9.beta2/local/lib/python2.7/site-packages/sage/interfaces/singular.py", line 685, in _create
        self.set(type, name, value)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.9.beta2/local/lib/python2.7/site-packages/sage/interfaces/singular.py", line 628, in set
        raise TypeError, msg
    TypeError: [Errno 22] Invalid argument
    Error evaluating def sage51=2+3; in Singular
**********************************************************************
```



---

Comment by jdemeyer created at 2013-03-29 01:20:38

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2013-03-29 01:20:38

It's not the best solution possible, but after spending more than 1 hour trying stuff and reading the pexpect source code, there is nothing better I could come up with.


---

Comment by vbraun created at 2013-04-05 12:29:36

Which syscall is failing with invalid argument? Can we get the full backtrace? Why do we catch the RuntimeError at all in `set()`?


---

Comment by jdemeyer created at 2013-04-05 13:03:34

Replying to [comment:2 vbraun]:
> Which syscall is failing with invalid argument?
`os.write()` to the terminal, from the `send()` function in `site-packages/pexpect.py`


---

Comment by vbraun created at 2013-04-07 11:13:22

Does that only happen in parallel testing but not in serial tests? The only thing I can think of is that we are running out of file descriptors. Solaris defaults to a really low `ulimit -n`, I think.


---

Comment by jdemeyer created at 2013-04-07 12:03:17

Replying to [comment:4 vbraun]:
> The only thing I can think of is that we are running out of file descriptors.
I don't that has anything to do with it. I think it has to do with the fact that the Singular process dies and that therefore, writing to the pty fails. But unfortunately, it is more complicated than that.


---

Comment by vbraun created at 2013-04-07 13:51:55

This doesn't make sense, if something is wrong with the file descriptor then write would cause EBADF not EINVAL. Are you sure that the error comes from writing to the old, dead subprocess and not to the newly-forked one? And why are we even catching RuntimeError in sage.interface.singular.set?

I would guess that the issue is the absence of `forkpty()` on Solaris? I.e. no `os.forkpty` in Python, so `pty.fork` falls back to an alternate implementation which presumably triggers a race in Solaris. Contact upstream ;-)

It seems ridiculous to change the doctest here instead of adding a workaround to `sage.interface`. If this doesn't work then your platform just can't run Sage.


---

Attachment

Initial patch


---

Comment by vbraun created at 2013-04-07 16:10:41

I've added a patch that weans off the singular interface from RuntimeError abuse. Maybe you can try with that patch, then we ought to get a actually useful backtrace. All tests pass with the patch on my machine...


---

Comment by jdemeyer created at 2013-04-07 19:48:20

Replying to [comment:6 vbraun]:
> It seems ridiculous to change the doctest here instead of adding a workaround to `sage.interface`.
I agree, but my workaround (adding the `sleep()`) worked and everything else which I tried didn't work. But I'll certainly try your patch.


---

Attachment


---

Comment by jdemeyer created at 2013-04-08 06:33:38

[attachment:14371_traceback_dont_catch.patch] = [attachment:trac_14371_dont_catch_runtimeerror.patch] + [attachment:14371_traceback.patch] with 1 change: inherit `SingularError` from `RuntimeError` for backwards compatibility.


---

Comment by jdemeyer created at 2013-04-08 06:36:12

OK, useful traceback now, any ideas?


---

Attachment


---

Comment by vbraun created at 2013-04-08 09:27:14

`os.write` can never raise a TypeError, only OSError. It is the point where the exception originates, but the exception type and message come from the `except OSError:` branch in `_eval_line`.


---

Comment by vbraun created at 2013-04-08 09:47:26

Maybe run the doctest under dtrace to figure out where the EINVAL comes from? Somebody who is actually using OpenSolaris should make an effort.


---

Comment by jdemeyer created at 2013-04-08 12:21:17

Replying to [comment:15 vbraun]:
> `os.write` can never raise a TypeError, only OSError. It is the point where the exception originates, but the exception type and message come from the `except OSError:` branch in `_eval_line`.
These are all true statements, but what's the point you're trying to make?

Perhaps you are confused by the use of `sys.exc_info()[2]`, which allows to raise a new exception with the old traceback. So it really is the `os.write()` which is failing.


---

Comment by jdemeyer created at 2013-04-08 12:21:48

Replying to [comment:16 vbraun]:
> Somebody who is actually using OpenSolaris should make an effort.
I did, but I really couldn't figure out what is going wrong.


---

Comment by vbraun created at 2013-04-08 12:34:43

That `os.write` fails is ok, we catch the `OSError` and restart the process. But your hack prints the traceback starting from `os.write`, which is not the relevant one. The except: branch fails somewhere and that is the issue.


---

Attachment


---

Comment by jdemeyer created at 2013-04-08 14:50:20

Replying to [comment:19 vbraun]:
> That `os.write` fails is ok, we catch the `OSError` and restart the process.
No, we don't because pexpect hasn't realized that the process is dead (`E.isalive()` is still true).


---

Comment by vbraun created at 2013-04-09 10:52:41

Known bug? This is from `pexpect.py`:

```
    def isalive(self):
        """This tests if the child process is running or not.
        This is non-blocking. If the child was terminated then this
        will read the exitstatus or signalstatus of the child.
        This returns 1 if the child process appears to be running or 0 if not.
        It can take literally SECONDS for Solaris to return the right status.
        """
```

How about we wait for 5 seconds after an `os.write` error on Slowaris?


---

Comment by jdemeyer created at 2013-04-09 11:37:38

Something like this (needs review)?


---

Attachment

I was more thingking about that:

```
    except OSError, msg: 
        if sys.platform.startswith('sunos'):
            # OpenSolaris bug workaround
            time.sleep(5)
        if not E.isalive():
```

There is no point in waiting if your OS works correctly. But more importantly, does it fix the issue?


---

Comment by jdemeyer created at 2013-04-09 12:02:29

Replying to [comment:24 vbraun]:
> There is no point in waiting if your OS works correctly.
True, but I don't like special-casing operating systems. How can we be certain that it only affects (Open)Solaris? Since this failure (`OSError` when the process is truly alive) essentially never happens, I don't think it is a problem. On sane systems, this doesn't affect the doctest since those `time.sleep()` calls will not be done as `E.isalive()` is false.

> But more importantly, does it fix the issue?
I haven't checked it yet, but it should.


---

Comment by vbraun created at 2013-04-09 12:11:44

Replying to [comment:25 jdemeyer]:
> How can we be certain that it only affects (Open)Solaris?

We can't, thats why I would like to special case only Solaris so we get doctest failures if other (better) OS'es have a bug that causes `os.write` to fail while `isalive()`.


---

Comment by jdemeyer created at 2013-04-09 12:14:11

Replying to [comment:26 vbraun]:
> Replying to [comment:25 jdemeyer]:
> > How can we be certain that it only affects (Open)Solaris?
> 
> We can't, thats why I would like to special case only Solaris so we get doctest failures
And then what? Add a fix for that other operating system? Better just fix all hypothetical errors in one go.


---

Comment by jdemeyer created at 2013-04-09 12:14:44

Anyway, the OpenSolaris issue seems to be fixed by this patch.


---

Comment by vbraun created at 2013-04-09 12:18:37

Replying to [comment:27 jdemeyer]:
> And then what?

And then hopefully not make an OS with such a glaring kernel bug a first-class supported platform.


---

Comment by jpflori created at 2013-04-10 09:35:40

FYI, this is also happening on Solaris 10, so not only OpenSolaris (which is dead isn't it? we should maybe rather try OpenIndiana?).


---

Comment by jpflori created at 2013-04-10 09:43:21

(Although OpenIndiana does not support SPARC yet...)


---

Comment by vbraun created at 2013-04-24 15:12:27

Fwiw, here is an alternative patch.


---

Comment by jdemeyer created at 2013-04-24 15:35:53

Volker, for the record: do you give positive review to [attachment:14371_traceback_dont_catch.patch]?


---

Comment by vbraun created at 2013-04-24 15:51:20

Yes, to the extend that I can give positive review to a patch that I wrote for the most part ;-)


---

Comment by jdemeyer created at 2013-04-25 11:53:10

Volker, as release manager I need this bug to be fixed, so I'm going to apply your version, even though I still prefer to fix the potential problem on all systems.

Unfortunately, David Kirkby's OpenSolaris machine is down for the moment, so I cannot test your patch (although it should work).


---

Comment by vbraun created at 2013-04-25 11:59:57

Sorry for being a PITA sometimes ;-)


---

Attachment

Alternative patch


---

Comment by jdemeyer created at 2013-04-25 12:02:56

Comment-only change to your patch. Volker, if you agree, then this one is good to go.


---

Comment by vbraun created at 2013-04-25 12:06:02

Sounds good to me.


---

Comment by vbraun created at 2013-04-25 12:06:02

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-04-25 12:56:43

Resolution: fixed
