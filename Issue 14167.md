# Issue 14167: Race condition in singular doctest

archive/issues_014167.json:
```json
{
    "body": "Assignee: mvngu\n\nCC:  jpflori\n\nOn hawk (OpenSolaris):\n\n```\nsage -t --long devel/sage/sage/interfaces/expect.py\n**********************************************************************\nFile \"devel/sage/sage/interfaces/expect.py\", line 1089, in sage.interfaces.expect.Expect._crash_msg\nFailed example:\n    singular('2+3')\nException raised:\n    Traceback (most recent call last):\n      File \"/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.9.beta2/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 460, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.9.beta2/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 819, in execute\n        exec compiled in globs\n      File \"<doctest sage.interfaces.expect.Expect._crash_msg[4]>\", line 1, in <module>\n        singular('2+3')\n      File \"/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.9.beta2/local/lib/python2.7/site-packages/sage/interfaces/singular.py\", line 724, in __call__\n        return SingularElement(self, type, x, False)\n      File \"/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.9.beta2/local/lib/python2.7/site-packages/sage/interfaces/singular.py\", line 1184, in __init__\n        self._name = parent._create( value, type)\n      File \"/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.9.beta2/local/lib/python2.7/site-packages/sage/interfaces/singular.py\", line 685, in _create\n        self.set(type, name, value)\n      File \"/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.9.beta2/local/lib/python2.7/site-packages/sage/interfaces/singular.py\", line 628, in set\n        raise TypeError, msg\n    TypeError: [Errno 22] Invalid argument\n    Error evaluating def sage51=2+3; in Singular\n**********************************************************************\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/14371\n\n",
    "created_at": "2013-03-27T22:40:15Z",
    "labels": [
        "component: doctest coverage",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.9",
    "title": "Race condition in singular doctest",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14167",
    "user": "https://github.com/jdemeyer"
}
```
Assignee: mvngu

CC:  jpflori

On hawk (OpenSolaris):

```
sage -t --long devel/sage/sage/interfaces/expect.py
**********************************************************************
File "devel/sage/sage/interfaces/expect.py", line 1089, in sage.interfaces.expect.Expect._crash_msg
Failed example:
    singular('2+3')
Exception raised:
    Traceback (most recent call last):
      File "/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.9.beta2/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 460, in _run
        self.execute(example, compiled, test.globs)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.9.beta2/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 819, in execute
        exec compiled in globs
      File "<doctest sage.interfaces.expect.Expect._crash_msg[4]>", line 1, in <module>
        singular('2+3')
      File "/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.9.beta2/local/lib/python2.7/site-packages/sage/interfaces/singular.py", line 724, in __call__
        return SingularElement(self, type, x, False)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.9.beta2/local/lib/python2.7/site-packages/sage/interfaces/singular.py", line 1184, in __init__
        self._name = parent._create( value, type)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.9.beta2/local/lib/python2.7/site-packages/sage/interfaces/singular.py", line 685, in _create
        self.set(type, name, value)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.9.beta2/local/lib/python2.7/site-packages/sage/interfaces/singular.py", line 628, in set
        raise TypeError, msg
    TypeError: [Errno 22] Invalid argument
    Error evaluating def sage51=2+3; in Singular
**********************************************************************
```


Issue created by migration from https://trac.sagemath.org/ticket/14371





---

archive/issue_comments_177676.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-03-29T01:20:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177676",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_177677.json:
```json
{
    "body": "It's not the best solution possible, but after spending more than 1 hour trying stuff and reading the pexpect source code, there is nothing better I could come up with.",
    "created_at": "2013-03-29T01:20:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177677",
    "user": "https://github.com/jdemeyer"
}
```

It's not the best solution possible, but after spending more than 1 hour trying stuff and reading the pexpect source code, there is nothing better I could come up with.



---

archive/issue_comments_177678.json:
```json
{
    "body": "Which syscall is failing with invalid argument? Can we get the full backtrace? Why do we catch the RuntimeError at all in `set()`?",
    "created_at": "2013-04-05T12:29:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177678",
    "user": "https://github.com/vbraun"
}
```

Which syscall is failing with invalid argument? Can we get the full backtrace? Why do we catch the RuntimeError at all in `set()`?



---

archive/issue_comments_177679.json:
```json
{
    "body": "Replying to [comment:2 vbraun]:\n> Which syscall is failing with invalid argument?\n`os.write()` to the terminal, from the `send()` function in `site-packages/pexpect.py`",
    "created_at": "2013-04-05T13:03:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177679",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:2 vbraun]:
> Which syscall is failing with invalid argument?
`os.write()` to the terminal, from the `send()` function in `site-packages/pexpect.py`



---

archive/issue_comments_177680.json:
```json
{
    "body": "Does that only happen in parallel testing but not in serial tests? The only thing I can think of is that we are running out of file descriptors. Solaris defaults to a really low `ulimit -n`, I think.",
    "created_at": "2013-04-07T11:13:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177680",
    "user": "https://github.com/vbraun"
}
```

Does that only happen in parallel testing but not in serial tests? The only thing I can think of is that we are running out of file descriptors. Solaris defaults to a really low `ulimit -n`, I think.



---

archive/issue_comments_177681.json:
```json
{
    "body": "Replying to [comment:4 vbraun]:\n> The only thing I can think of is that we are running out of file descriptors.\nI don't that has anything to do with it. I think it has to do with the fact that the Singular process dies and that therefore, writing to the pty fails. But unfortunately, it is more complicated than that.",
    "created_at": "2013-04-07T12:03:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177681",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:4 vbraun]:
> The only thing I can think of is that we are running out of file descriptors.
I don't that has anything to do with it. I think it has to do with the fact that the Singular process dies and that therefore, writing to the pty fails. But unfortunately, it is more complicated than that.



---

archive/issue_comments_177682.json:
```json
{
    "body": "This doesn't make sense, if something is wrong with the file descriptor then write would cause EBADF not EINVAL. Are you sure that the error comes from writing to the old, dead subprocess and not to the newly-forked one? And why are we even catching RuntimeError in sage.interface.singular.set?\n\nI would guess that the issue is the absence of `forkpty()` on Solaris? I.e. no `os.forkpty` in Python, so `pty.fork` falls back to an alternate implementation which presumably triggers a race in Solaris. Contact upstream ;-)\n\nIt seems ridiculous to change the doctest here instead of adding a workaround to `sage.interface`. If this doesn't work then your platform just can't run Sage.",
    "created_at": "2013-04-07T13:51:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177682",
    "user": "https://github.com/vbraun"
}
```

This doesn't make sense, if something is wrong with the file descriptor then write would cause EBADF not EINVAL. Are you sure that the error comes from writing to the old, dead subprocess and not to the newly-forked one? And why are we even catching RuntimeError in sage.interface.singular.set?

I would guess that the issue is the absence of `forkpty()` on Solaris? I.e. no `os.forkpty` in Python, so `pty.fork` falls back to an alternate implementation which presumably triggers a race in Solaris. Contact upstream ;-)

It seems ridiculous to change the doctest here instead of adding a workaround to `sage.interface`. If this doesn't work then your platform just can't run Sage.



---

archive/issue_comments_177683.json:
```json
{
    "body": "Attachment [trac_14371_dont_catch_runtimeerror.patch](tarball://root/attachments/some-uuid/ticket14371/trac_14371_dont_catch_runtimeerror.patch) by @vbraun created at 2013-04-07 16:09:35\n\nInitial patch",
    "created_at": "2013-04-07T16:09:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177683",
    "user": "https://github.com/vbraun"
}
```

Attachment [trac_14371_dont_catch_runtimeerror.patch](tarball://root/attachments/some-uuid/ticket14371/trac_14371_dont_catch_runtimeerror.patch) by @vbraun created at 2013-04-07 16:09:35

Initial patch



---

archive/issue_comments_177684.json:
```json
{
    "body": "I've added a patch that weans off the singular interface from RuntimeError abuse. Maybe you can try with that patch, then we ought to get a actually useful backtrace. All tests pass with the patch on my machine...",
    "created_at": "2013-04-07T16:10:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177684",
    "user": "https://github.com/vbraun"
}
```

I've added a patch that weans off the singular interface from RuntimeError abuse. Maybe you can try with that patch, then we ought to get a actually useful backtrace. All tests pass with the patch on my machine...



---

archive/issue_comments_177685.json:
```json
{
    "body": "Replying to [comment:6 vbraun]:\n> It seems ridiculous to change the doctest here instead of adding a workaround to `sage.interface`.\nI agree, but my workaround (adding the `sleep()`) worked and everything else which I tried didn't work. But I'll certainly try your patch.",
    "created_at": "2013-04-07T19:48:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177685",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:6 vbraun]:
> It seems ridiculous to change the doctest here instead of adding a workaround to `sage.interface`.
I agree, but my workaround (adding the `sleep()`) worked and everything else which I tried didn't work. But I'll certainly try your patch.



---

archive/issue_comments_177686.json:
```json
{
    "body": "Attachment [14371_traceback.patch](tarball://root/attachments/some-uuid/ticket14371/14371_traceback.patch) by @jdemeyer created at 2013-04-08 06:18:58",
    "created_at": "2013-04-08T06:18:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177686",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [14371_traceback.patch](tarball://root/attachments/some-uuid/ticket14371/14371_traceback.patch) by @jdemeyer created at 2013-04-08 06:18:58



---

archive/issue_comments_177687.json:
```json
{
    "body": "[attachment:14371_traceback_dont_catch.patch] = [attachment:trac_14371_dont_catch_runtimeerror.patch] + [attachment:14371_traceback.patch] with 1 change: inherit `SingularError` from `RuntimeError` for backwards compatibility.",
    "created_at": "2013-04-08T06:33:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177687",
    "user": "https://github.com/jdemeyer"
}
```

[attachment:14371_traceback_dont_catch.patch] = [attachment:trac_14371_dont_catch_runtimeerror.patch] + [attachment:14371_traceback.patch] with 1 change: inherit `SingularError` from `RuntimeError` for backwards compatibility.



---

archive/issue_comments_177688.json:
```json
{
    "body": "OK, useful traceback now, any ideas?",
    "created_at": "2013-04-08T06:36:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177688",
    "user": "https://github.com/jdemeyer"
}
```

OK, useful traceback now, any ideas?



---

archive/issue_comments_177689.json:
```json
{
    "body": "Attachment [14371_singular_race.patch](tarball://root/attachments/some-uuid/ticket14371/14371_singular_race.patch) by @jdemeyer created at 2013-04-08 06:40:31",
    "created_at": "2013-04-08T06:40:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177689",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [14371_singular_race.patch](tarball://root/attachments/some-uuid/ticket14371/14371_singular_race.patch) by @jdemeyer created at 2013-04-08 06:40:31



---

archive/issue_comments_177690.json:
```json
{
    "body": "`os.write` can never raise a TypeError, only OSError. It is the point where the exception originates, but the exception type and message come from the `except OSError:` branch in `_eval_line`.",
    "created_at": "2013-04-08T09:27:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177690",
    "user": "https://github.com/vbraun"
}
```

`os.write` can never raise a TypeError, only OSError. It is the point where the exception originates, but the exception type and message come from the `except OSError:` branch in `_eval_line`.



---

archive/issue_comments_177691.json:
```json
{
    "body": "Maybe run the doctest under dtrace to figure out where the EINVAL comes from? Somebody who is actually using OpenSolaris should make an effort.",
    "created_at": "2013-04-08T09:47:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177691",
    "user": "https://github.com/vbraun"
}
```

Maybe run the doctest under dtrace to figure out where the EINVAL comes from? Somebody who is actually using OpenSolaris should make an effort.



---

archive/issue_comments_177692.json:
```json
{
    "body": "Replying to [comment:15 vbraun]:\n> `os.write` can never raise a TypeError, only OSError. It is the point where the exception originates, but the exception type and message come from the `except OSError:` branch in `_eval_line`.\nThese are all true statements, but what's the point you're trying to make?\n\nPerhaps you are confused by the use of `sys.exc_info()[2]`, which allows to raise a new exception with the old traceback. So it really is the `os.write()` which is failing.",
    "created_at": "2013-04-08T12:21:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177692",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:15 vbraun]:
> `os.write` can never raise a TypeError, only OSError. It is the point where the exception originates, but the exception type and message come from the `except OSError:` branch in `_eval_line`.
These are all true statements, but what's the point you're trying to make?

Perhaps you are confused by the use of `sys.exc_info()[2]`, which allows to raise a new exception with the old traceback. So it really is the `os.write()` which is failing.



---

archive/issue_comments_177693.json:
```json
{
    "body": "Replying to [comment:16 vbraun]:\n> Somebody who is actually using OpenSolaris should make an effort.\nI did, but I really couldn't figure out what is going wrong.",
    "created_at": "2013-04-08T12:21:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177693",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:16 vbraun]:
> Somebody who is actually using OpenSolaris should make an effort.
I did, but I really couldn't figure out what is going wrong.



---

archive/issue_comments_177694.json:
```json
{
    "body": "That `os.write` fails is ok, we catch the `OSError` and restart the process. But your hack prints the traceback starting from `os.write`, which is not the relevant one. The except: branch fails somewhere and that is the issue.",
    "created_at": "2013-04-08T12:34:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177694",
    "user": "https://github.com/vbraun"
}
```

That `os.write` fails is ok, we catch the `OSError` and restart the process. But your hack prints the traceback starting from `os.write`, which is not the relevant one. The except: branch fails somewhere and that is the issue.



---

archive/issue_comments_177695.json:
```json
{
    "body": "Attachment [14371_traceback_dont_catch.patch](tarball://root/attachments/some-uuid/ticket14371/14371_traceback_dont_catch.patch) by @jdemeyer created at 2013-04-08 14:49:04",
    "created_at": "2013-04-08T14:49:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177695",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [14371_traceback_dont_catch.patch](tarball://root/attachments/some-uuid/ticket14371/14371_traceback_dont_catch.patch) by @jdemeyer created at 2013-04-08 14:49:04



---

archive/issue_comments_177696.json:
```json
{
    "body": "Replying to [comment:19 vbraun]:\n> That `os.write` fails is ok, we catch the `OSError` and restart the process.\nNo, we don't because pexpect hasn't realized that the process is dead (`E.isalive()` is still true).",
    "created_at": "2013-04-08T14:50:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177696",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:19 vbraun]:
> That `os.write` fails is ok, we catch the `OSError` and restart the process.
No, we don't because pexpect hasn't realized that the process is dead (`E.isalive()` is still true).



---

archive/issue_comments_177697.json:
```json
{
    "body": "Known bug? This is from `pexpect.py`:\n\n```\n    def isalive(self):\n        \"\"\"This tests if the child process is running or not.\n        This is non-blocking. If the child was terminated then this\n        will read the exitstatus or signalstatus of the child.\n        This returns 1 if the child process appears to be running or 0 if not.\n        It can take literally SECONDS for Solaris to return the right status.\n        \"\"\"\n```\n\nHow about we wait for 5 seconds after an `os.write` error on Slowaris?",
    "created_at": "2013-04-09T10:52:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177697",
    "user": "https://github.com/vbraun"
}
```

Known bug? This is from `pexpect.py`:

```
    def isalive(self):
        """This tests if the child process is running or not.
        This is non-blocking. If the child was terminated then this
        will read the exitstatus or signalstatus of the child.
        This returns 1 if the child process appears to be running or 0 if not.
        It can take literally SECONDS for Solaris to return the right status.
        """
```

How about we wait for 5 seconds after an `os.write` error on Slowaris?



---

archive/issue_comments_177698.json:
```json
{
    "body": "Something like this (needs review)?",
    "created_at": "2013-04-09T11:37:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177698",
    "user": "https://github.com/jdemeyer"
}
```

Something like this (needs review)?



---

archive/issue_comments_177699.json:
```json
{
    "body": "Attachment [14371_sleep_isalive.patch](tarball://root/attachments/some-uuid/ticket14371/14371_sleep_isalive.patch) by @vbraun created at 2013-04-09 11:55:38\n\nI was more thingking about that:\n\n```\n    except OSError, msg: \n        if sys.platform.startswith('sunos'):\n            # OpenSolaris bug workaround\n            time.sleep(5)\n        if not E.isalive():\n```\n\nThere is no point in waiting if your OS works correctly. But more importantly, does it fix the issue?",
    "created_at": "2013-04-09T11:55:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177699",
    "user": "https://github.com/vbraun"
}
```

Attachment [14371_sleep_isalive.patch](tarball://root/attachments/some-uuid/ticket14371/14371_sleep_isalive.patch) by @vbraun created at 2013-04-09 11:55:38

I was more thingking about that:

```
    except OSError, msg: 
        if sys.platform.startswith('sunos'):
            # OpenSolaris bug workaround
            time.sleep(5)
        if not E.isalive():
```

There is no point in waiting if your OS works correctly. But more importantly, does it fix the issue?



---

archive/issue_comments_177700.json:
```json
{
    "body": "Replying to [comment:24 vbraun]:\n> There is no point in waiting if your OS works correctly.\nTrue, but I don't like special-casing operating systems. How can we be certain that it only affects (Open)Solaris? Since this failure (`OSError` when the process is truly alive) essentially never happens, I don't think it is a problem. On sane systems, this doesn't affect the doctest since those `time.sleep()` calls will not be done as `E.isalive()` is false.\n\n> But more importantly, does it fix the issue?\nI haven't checked it yet, but it should.",
    "created_at": "2013-04-09T12:02:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177700",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:24 vbraun]:
> There is no point in waiting if your OS works correctly.
True, but I don't like special-casing operating systems. How can we be certain that it only affects (Open)Solaris? Since this failure (`OSError` when the process is truly alive) essentially never happens, I don't think it is a problem. On sane systems, this doesn't affect the doctest since those `time.sleep()` calls will not be done as `E.isalive()` is false.

> But more importantly, does it fix the issue?
I haven't checked it yet, but it should.



---

archive/issue_comments_177701.json:
```json
{
    "body": "Replying to [comment:25 jdemeyer]:\n> How can we be certain that it only affects (Open)Solaris?\n\nWe can't, thats why I would like to special case only Solaris so we get doctest failures if other (better) OS'es have a bug that causes `os.write` to fail while `isalive()`.",
    "created_at": "2013-04-09T12:11:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177701",
    "user": "https://github.com/vbraun"
}
```

Replying to [comment:25 jdemeyer]:
> How can we be certain that it only affects (Open)Solaris?

We can't, thats why I would like to special case only Solaris so we get doctest failures if other (better) OS'es have a bug that causes `os.write` to fail while `isalive()`.



---

archive/issue_comments_177702.json:
```json
{
    "body": "Replying to [comment:26 vbraun]:\n> Replying to [comment:25 jdemeyer]:\n> > How can we be certain that it only affects (Open)Solaris?\n> \n> We can't, thats why I would like to special case only Solaris so we get doctest failures\nAnd then what? Add a fix for that other operating system? Better just fix all hypothetical errors in one go.",
    "created_at": "2013-04-09T12:14:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177702",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:26 vbraun]:
> Replying to [comment:25 jdemeyer]:
> > How can we be certain that it only affects (Open)Solaris?
> 
> We can't, thats why I would like to special case only Solaris so we get doctest failures
And then what? Add a fix for that other operating system? Better just fix all hypothetical errors in one go.



---

archive/issue_comments_177703.json:
```json
{
    "body": "Anyway, the OpenSolaris issue seems to be fixed by this patch.",
    "created_at": "2013-04-09T12:14:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177703",
    "user": "https://github.com/jdemeyer"
}
```

Anyway, the OpenSolaris issue seems to be fixed by this patch.



---

archive/issue_comments_177704.json:
```json
{
    "body": "Replying to [comment:27 jdemeyer]:\n> And then what?\n\nAnd then hopefully not make an OS with such a glaring kernel bug a first-class supported platform.",
    "created_at": "2013-04-09T12:18:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177704",
    "user": "https://github.com/vbraun"
}
```

Replying to [comment:27 jdemeyer]:
> And then what?

And then hopefully not make an OS with such a glaring kernel bug a first-class supported platform.



---

archive/issue_comments_177705.json:
```json
{
    "body": "FYI, this is also happening on Solaris 10, so not only OpenSolaris (which is dead isn't it? we should maybe rather try OpenIndiana?).",
    "created_at": "2013-04-10T09:35:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177705",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

FYI, this is also happening on Solaris 10, so not only OpenSolaris (which is dead isn't it? we should maybe rather try OpenIndiana?).



---

archive/issue_comments_177706.json:
```json
{
    "body": "(Although OpenIndiana does not support SPARC yet...)",
    "created_at": "2013-04-10T09:43:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177706",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

(Although OpenIndiana does not support SPARC yet...)



---

archive/issue_events_040784.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-24T12:18:50Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "milestone": "sage-5.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14167#event-40784"
}
```



---

archive/issue_comments_177707.json:
```json
{
    "body": "Fwiw, here is an alternative patch.",
    "created_at": "2013-04-24T15:12:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177707",
    "user": "https://github.com/vbraun"
}
```

Fwiw, here is an alternative patch.



---

archive/issue_comments_177708.json:
```json
{
    "body": "Volker, for the record: do you give positive review to [attachment:14371_traceback_dont_catch.patch]?",
    "created_at": "2013-04-24T15:35:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177708",
    "user": "https://github.com/jdemeyer"
}
```

Volker, for the record: do you give positive review to [attachment:14371_traceback_dont_catch.patch]?



---

archive/issue_comments_177709.json:
```json
{
    "body": "Yes, to the extend that I can give positive review to a patch that I wrote for the most part ;-)",
    "created_at": "2013-04-24T15:51:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177709",
    "user": "https://github.com/vbraun"
}
```

Yes, to the extend that I can give positive review to a patch that I wrote for the most part ;-)



---

archive/issue_comments_177710.json:
```json
{
    "body": "Volker, as release manager I need this bug to be fixed, so I'm going to apply your version, even though I still prefer to fix the potential problem on all systems.\n\nUnfortunately, David Kirkby's OpenSolaris machine is down for the moment, so I cannot test your patch (although it should work).",
    "created_at": "2013-04-25T11:53:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177710",
    "user": "https://github.com/jdemeyer"
}
```

Volker, as release manager I need this bug to be fixed, so I'm going to apply your version, even though I still prefer to fix the potential problem on all systems.

Unfortunately, David Kirkby's OpenSolaris machine is down for the moment, so I cannot test your patch (although it should work).



---

archive/issue_comments_177711.json:
```json
{
    "body": "Sorry for being a PITA sometimes ;-)",
    "created_at": "2013-04-25T11:59:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177711",
    "user": "https://github.com/vbraun"
}
```

Sorry for being a PITA sometimes ;-)



---

archive/issue_comments_177712.json:
```json
{
    "body": "Attachment [14371_sleep_isalive_alt.patch](tarball://root/attachments/some-uuid/ticket14371/14371_sleep_isalive_alt.patch) by @jdemeyer created at 2013-04-25 12:02:04\n\nAlternative patch",
    "created_at": "2013-04-25T12:02:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177712",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [14371_sleep_isalive_alt.patch](tarball://root/attachments/some-uuid/ticket14371/14371_sleep_isalive_alt.patch) by @jdemeyer created at 2013-04-25 12:02:04

Alternative patch



---

archive/issue_comments_177713.json:
```json
{
    "body": "Comment-only change to your patch. Volker, if you agree, then this one is good to go.",
    "created_at": "2013-04-25T12:02:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177713",
    "user": "https://github.com/jdemeyer"
}
```

Comment-only change to your patch. Volker, if you agree, then this one is good to go.



---

archive/issue_comments_177714.json:
```json
{
    "body": "Sounds good to me.",
    "created_at": "2013-04-25T12:06:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177714",
    "user": "https://github.com/vbraun"
}
```

Sounds good to me.



---

archive/issue_comments_177715.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-04-25T12:06:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177715",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_177716.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-04-25T12:56:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14167#issuecomment-177716",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_040785.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-25T12:56:43Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/14167",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14167#event-40785"
}
```
