# Issue 19585: Fast polynomial evaluation fmpz_poly/ZZX with mpfr/mpfi input

archive/issues_019585.json:
```json
{
    "body": "We implement functions that allow fast evaluations of integer polynomials with real input:\n- `fmpz_poly_eval_mpfr(mpfr_t res, const fmpz_poly_t poly, const mpfr_t a, mpfr_rnd_t rnd)`\n- `fmpz_poly_eval_mpfi(mpfi_t res, const fmpz_poly_t poly, const mpfi_t a)`\n- `ZZX_eval_mpfr(mpfr_t res, ZZX_c poly, const mpfr_t a, const mpfr_rnd_t rnd)`\n- `ZZX_eval_mpfi(mpfi_t res, ZZX_c poly, const mpfi_t a)`\n\nThese functions are integrated in the polynomial code and number field element comparisons (when real embedding is defined, see #17830). For the latter we win a great `x10` speed up. The new code is also is `x50` faster than comparisons in `QQbar`. For the benchmarks, we used the following comparison function\n\n```\ndef test(a,n):\n    cf = continued_fraction(a)\n    cv1 = a.parent()(cf.convergent(2*n+1))\n    cv2 = a.parent()(cf.convergent(2*n+2))\n    for _ in range(200):\n        assert cv1 > a > cv2\n```\nBefore\n\n```\nsage: x = polygen(ZZ)\nsage: K.<a> = NumberField(x^3 - 2, embedding=1.26)\nsage: sage: %timeit test(a,10)\n10 loops, best of 3: 51.1 ms per loop\nsage: sage: %timeit test(a,20)\n10 loops, best of 3: 67 ms per loop\nsage: sage: %timeit test(a,100)\n10 loops, best of 3: 108 ms per loop\nsage: sage: %timeit test(a,200)\n1 loops, best of 3: 154 ms per loop\n```\nafter\n\n```\nsage: x = polygen(ZZ)\nsage: K.<a> = NumberField(x^3 - 2, embedding=1.26)\nsage: sage: sage: %timeit test(a,10)\n100 loops, best of 3: 5.84 ms per loop\nsage: sage: sage: %timeit test(a,20)\n100 loops, best of 3: 10.2 ms per loop\nsage: sage: sage: %timeit test(a,100)\n10 loops, best of 3: 33.5 ms per loop\nsage: sage: sage: %timeit test(a,200)\n10 loops, best of 3: 64.8 ms per loop\n```\nTo be compared with\n\n```\nsage: a = AA(2)**(1/3)\nsage: a.exactify()\nsage: sage: %timeit test(a,10)\n10 loops, best of 3: 97.7 ms per loop\nsage: sage: %timeit test(a,20)\n10 loops, best of 3: 133 ms per loop\nsage: sage: %timeit test(a,100)\n1 loops, best of 3: 224 ms per loop\nsage: sage: %timeit test(a,200)\n1 loops, best of 3: 305 ms per loop\n```\n\nIssue created by migration from https://trac.sagemath.org/ticket/19822\n\n",
    "created_at": "2016-01-02T15:09:21Z",
    "labels": [
        "component: algebra"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.1",
    "title": "Fast polynomial evaluation fmpz_poly/ZZX with mpfr/mpfi input",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19585",
    "user": "https://github.com/videlec"
}
```
We implement functions that allow fast evaluations of integer polynomials with real input:
- `fmpz_poly_eval_mpfr(mpfr_t res, const fmpz_poly_t poly, const mpfr_t a, mpfr_rnd_t rnd)`
- `fmpz_poly_eval_mpfi(mpfi_t res, const fmpz_poly_t poly, const mpfi_t a)`
- `ZZX_eval_mpfr(mpfr_t res, ZZX_c poly, const mpfr_t a, const mpfr_rnd_t rnd)`
- `ZZX_eval_mpfi(mpfi_t res, ZZX_c poly, const mpfi_t a)`

These functions are integrated in the polynomial code and number field element comparisons (when real embedding is defined, see #17830). For the latter we win a great `x10` speed up. The new code is also is `x50` faster than comparisons in `QQbar`. For the benchmarks, we used the following comparison function

```
def test(a,n):
    cf = continued_fraction(a)
    cv1 = a.parent()(cf.convergent(2*n+1))
    cv2 = a.parent()(cf.convergent(2*n+2))
    for _ in range(200):
        assert cv1 > a > cv2
```
Before

```
sage: x = polygen(ZZ)
sage: K.<a> = NumberField(x^3 - 2, embedding=1.26)
sage: sage: %timeit test(a,10)
10 loops, best of 3: 51.1 ms per loop
sage: sage: %timeit test(a,20)
10 loops, best of 3: 67 ms per loop
sage: sage: %timeit test(a,100)
10 loops, best of 3: 108 ms per loop
sage: sage: %timeit test(a,200)
1 loops, best of 3: 154 ms per loop
```
after

```
sage: x = polygen(ZZ)
sage: K.<a> = NumberField(x^3 - 2, embedding=1.26)
sage: sage: sage: %timeit test(a,10)
100 loops, best of 3: 5.84 ms per loop
sage: sage: sage: %timeit test(a,20)
100 loops, best of 3: 10.2 ms per loop
sage: sage: sage: %timeit test(a,100)
10 loops, best of 3: 33.5 ms per loop
sage: sage: sage: %timeit test(a,200)
10 loops, best of 3: 64.8 ms per loop
```
To be compared with

```
sage: a = AA(2)**(1/3)
sage: a.exactify()
sage: sage: %timeit test(a,10)
10 loops, best of 3: 97.7 ms per loop
sage: sage: %timeit test(a,20)
10 loops, best of 3: 133 ms per loop
sage: sage: %timeit test(a,100)
1 loops, best of 3: 224 ms per loop
sage: sage: %timeit test(a,200)
1 loops, best of 3: 305 ms per loop
```

Issue created by migration from https://trac.sagemath.org/ticket/19822





---

archive/issue_comments_268820.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-01-02T15:10:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268820",
    "user": "https://github.com/videlec"
}
```

New commits:



---

archive/issue_comments_268821.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-01-02T15:10:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268821",
    "user": "https://github.com/videlec"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_268822.json:
```json
{
    "body": "Some quick comments:\n\n1. `only do` -> `only does`\n\n2. What's the point of the `mpfr_rnd_t rnd` parameter, given that you don't make any guarantees about exact rounding or rounding direction? Given the code, the only sensible rounding mode is `MPFR_RNDN`.\n\n3. Did you investigate special-casing small degrees (say, degree <= 1)?\n\n4. Both `fmpz_poly_degree(poly)` and `ZZX_deg` return `long`, so the loop variable must be `long` too.",
    "created_at": "2016-01-02T16:15:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268822",
    "user": "https://github.com/jdemeyer"
}
```

Some quick comments:

1. `only do` -> `only does`

2. What's the point of the `mpfr_rnd_t rnd` parameter, given that you don't make any guarantees about exact rounding or rounding direction? Given the code, the only sensible rounding mode is `MPFR_RNDN`.

3. Did you investigate special-casing small degrees (say, degree <= 1)?

4. Both `fmpz_poly_degree(poly)` and `ZZX_deg` return `long`, so the loop variable must be `long` too.



---

archive/issue_comments_268823.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-01-02T16:15:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268823",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_268824.json:
```json
{
    "body": "5. Please move the changes to `src/sage/rings/number_field/number_field_element.pyx` to a new ticket such that we can focus on the actual issue from the ticket here.",
    "created_at": "2016-01-02T16:16:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268824",
    "user": "https://github.com/jdemeyer"
}
```

5. Please move the changes to `src/sage/rings/number_field/number_field_element.pyx` to a new ticket such that we can focus on the actual issue from the ticket here.



---

archive/issue_comments_268825.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-01-02T17:18:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268825",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_268826.json:
```json
{
    "body": "For 2. I just forward the rounding mode to the mpfr functions. Having exact rounding for polynomials might actually be tricky... and also useful. The main reason for having this option is to handle simply polynomial evaluations with different RealField input.\n\nFor 3. I did not consider it on purpose. Having special case for degree 0,1 will slow down the code of higher degree cases which are indeed the interesting ones.",
    "created_at": "2016-01-02T17:23:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268826",
    "user": "https://github.com/videlec"
}
```

For 2. I just forward the rounding mode to the mpfr functions. Having exact rounding for polynomials might actually be tricky... and also useful. The main reason for having this option is to handle simply polynomial evaluations with different RealField input.

For 3. I did not consider it on purpose. Having special case for degree 0,1 will slow down the code of higher degree cases which are indeed the interesting ones.



---

archive/issue_comments_268827.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-01-02T17:23:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268827",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_268828.json:
```json
{
    "body": "To be more complient with flint calling convention I will modify the names of the function `eval -> evaluation`.",
    "created_at": "2016-01-02T17:35:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268828",
    "user": "https://github.com/videlec"
}
```

To be more complient with flint calling convention I will modify the names of the function `eval -> evaluation`.



---

archive/issue_comments_268829.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-01-02T17:42:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268829",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_268830.json:
```json
{
    "body": "Replying to [comment:6 vdelecroix]:\n> For 2. I just forward the rounding mode to the mpfr functions.\n\n\nI know that but it doesn't make sense to do that!\n\nWhat would be the point of doing every single operation with `MPFR_RNDU`? That doesn't guarantee anything about the rounding of the result (if I take a number obtained with `MPFR_RNDU` and multiply it with -1, it effectively becomes rounded with `MPFR_RNDD`). Since polynomials use a mixture of additions and multiplications, it becomes difficult to avoid this problem.",
    "created_at": "2016-01-03T12:57:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268830",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:6 vdelecroix]:
> For 2. I just forward the rounding mode to the mpfr functions.


I know that but it doesn't make sense to do that!

What would be the point of doing every single operation with `MPFR_RNDU`? That doesn't guarantee anything about the rounding of the result (if I take a number obtained with `MPFR_RNDU` and multiply it with -1, it effectively becomes rounded with `MPFR_RNDD`). Since polynomials use a mixture of additions and multiplications, it becomes difficult to avoid this problem.



---

archive/issue_comments_268831.json:
```json
{
    "body": "Tiny detail: please keep the alphabetic order in `src/module_list.py`.",
    "created_at": "2016-01-03T12:58:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268831",
    "user": "https://github.com/jdemeyer"
}
```

Tiny detail: please keep the alphabetic order in `src/module_list.py`.



---

archive/issue_comments_268832.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-01-03T12:58:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268832",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_268833.json:
```json
{
    "body": "Typo: `Hornder` -> `Horner`.",
    "created_at": "2016-01-03T12:59:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268833",
    "user": "https://github.com/jdemeyer"
}
```

Typo: `Hornder` -> `Horner`.



---

archive/issue_comments_268834.json:
```json
{
    "body": "Avoid `sage/libs/ntl/decl.pxi`: just `cimport` what you need from the `.pxd` files in NTL.",
    "created_at": "2016-01-03T13:01:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268834",
    "user": "https://github.com/jdemeyer"
}
```

Avoid `sage/libs/ntl/decl.pxi`: just `cimport` what you need from the `.pxd` files in NTL.



---

archive/issue_comments_268835.json:
```json
{
    "body": "Replying to [comment:10 jdemeyer]:\n> Replying to [comment:6 vdelecroix]:\n> > For 2. I just forward the rounding mode to the mpfr functions.\n\n> \n> I know that but it doesn't make sense to do that!\n\n \nI see and you are definitely right. Then what should with `p(x)` when `p` is an integer polynomial and `x` belongs to `RealField(prec, rnd=MPFR_RNDU)`?",
    "created_at": "2016-01-03T13:02:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268835",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:10 jdemeyer]:
> Replying to [comment:6 vdelecroix]:
> > For 2. I just forward the rounding mode to the mpfr functions.

> 
> I know that but it doesn't make sense to do that!

 
I see and you are definitely right. Then what should with `p(x)` when `p` is an integer polynomial and `x` belongs to `RealField(prec, rnd=MPFR_RNDU)`?



---

archive/issue_comments_268836.json:
```json
{
    "body": "Just use `MPFR_RNDN` for polynomial evaluation in all cases, it's the only sensible thing if you cannot guarantee anything about the rounding.",
    "created_at": "2016-01-03T13:03:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268836",
    "user": "https://github.com/jdemeyer"
}
```

Just use `MPFR_RNDN` for polynomial evaluation in all cases, it's the only sensible thing if you cannot guarantee anything about the rounding.



---

archive/issue_comments_268837.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-01-03T14:08:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268837",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_268838.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-01-03T14:09:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268838",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_268839.json:
```json
{
    "body": "remark: in flint they have two polynomial evaluation algorithms: `Horner` and `divide_and_conquer` and they hardcoded the threshold to 50.",
    "created_at": "2016-01-03T14:14:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268839",
    "user": "https://github.com/videlec"
}
```

remark: in flint they have two polynomial evaluation algorithms: `Horner` and `divide_and_conquer` and they hardcoded the threshold to 50.



---

archive/issue_comments_268840.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-01-06T18:53:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268840",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_268841.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-01-06T19:00:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268841",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_268842.json:
```json
{
    "body": "ready for review again.",
    "created_at": "2016-01-06T19:02:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268842",
    "user": "https://github.com/videlec"
}
```

ready for review again.



---

archive/issue_comments_268843.json:
```json
{
    "body": "ping?",
    "created_at": "2016-01-13T20:05:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268843",
    "user": "https://github.com/videlec"
}
```

ping?



---

archive/issue_comments_268844.json:
```json
{
    "body": "The code looks good but I need to benchmark it.",
    "created_at": "2016-01-13T21:35:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268844",
    "user": "https://github.com/jdemeyer"
}
```

The code looks good but I need to benchmark it.



---

archive/issue_comments_268845.json:
```json
{
    "body": "You can also command it if you have precise requests ;-)\n\nBTW, I added special cases for degree 0 and 1 and I have seen no difference.",
    "created_at": "2016-01-13T21:49:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268845",
    "user": "https://github.com/videlec"
}
```

You can also command it if you have precise requests ;-)

BTW, I added special cases for degree 0 and 1 and I have seen no difference.



---

archive/issue_comments_268846.json:
```json
{
    "body": "Benchmarks indicate that the bound degree < 10 makes no sense at all. The ratio in speed between the old and the new code does not depend on the degree at all.\n\nSomething which is strange: it looks like the precision of the real number/interval matters: for small precisions, the new code is faster but for large precisions (> 50000 bits) the old code is faster. This makes no sense to me! I would guess that both implementations should scale the same way if the precision is increased. Any clues?",
    "created_at": "2016-01-15T18:01:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268846",
    "user": "https://github.com/jdemeyer"
}
```

Benchmarks indicate that the bound degree < 10 makes no sense at all. The ratio in speed between the old and the new code does not depend on the degree at all.

Something which is strange: it looks like the precision of the real number/interval matters: for small precisions, the new code is faster but for large precisions (> 50000 bits) the old code is faster. This makes no sense to me! I would guess that both implementations should scale the same way if the precision is increased. Any clues?



---

archive/issue_comments_268847.json:
```json
{
    "body": "Replying to [comment:27 jdemeyer]:\n> Benchmarks indicate that the bound degree < 10 makes no sense at all. The ratio in speed between the old and the new code does not depend on the degree at all.\n> \n> Something which is strange: it looks like the precision of the real number/interval matters: for small precisions, the new code is faster but for large precisions (> 50000 bits) the old code is faster. This makes no sense to me! I would guess that both implementations should scale the same way if the precision is increased. Any clues?\n\n\nWhat kind of polynomials did you use? The old code tries to minimize the number of operation in evaluation. For example `(x+1)^3` is infinitely smarter than `1 + x(3 + x(3 + x))`.",
    "created_at": "2016-01-15T18:12:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268847",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:27 jdemeyer]:
> Benchmarks indicate that the bound degree < 10 makes no sense at all. The ratio in speed between the old and the new code does not depend on the degree at all.
> 
> Something which is strange: it looks like the precision of the real number/interval matters: for small precisions, the new code is faster but for large precisions (> 50000 bits) the old code is faster. This makes no sense to me! I would guess that both implementations should scale the same way if the precision is increased. Any clues?


What kind of polynomials did you use? The old code tries to minimize the number of operation in evaluation. For example `(x+1)^3` is infinitely smarter than `1 + x(3 + x(3 + x))`.



---

archive/issue_comments_268848.json:
```json
{
    "body": "Replying to [comment:28 vdelecroix]:\n> What kind of polynomials did you use?\n\n\n```\nR.<x> = ZZ[]\npol = R.random_element(deg)\n```\n\n> The old code tries to minimize the number of operation in evaluation.\n\n\nI see. I guess that those \"random\" polynomials are somewhat sparse, so less operations are needed. I will try again with very dense polynomials.",
    "created_at": "2016-01-15T18:18:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268848",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:28 vdelecroix]:
> What kind of polynomials did you use?


```
R.<x> = ZZ[]
pol = R.random_element(deg)
```

> The old code tries to minimize the number of operation in evaluation.


I see. I guess that those "random" polynomials are somewhat sparse, so less operations are needed. I will try again with very dense polynomials.



---

archive/issue_comments_268849.json:
```json
{
    "body": "With dense polynomials and large precision, the timings of the old and new code are essentially the same. That's expected since the MPFR/MPFI operations dominate the runtime.\n\nCan you remove the \"degree < 10\" check?",
    "created_at": "2016-01-15T18:36:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268849",
    "user": "https://github.com/jdemeyer"
}
```

With dense polynomials and large precision, the timings of the old and new code are essentially the same. That's expected since the MPFR/MPFI operations dominate the runtime.

Can you remove the "degree < 10" check?



---

archive/issue_comments_268850.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-01-15T18:36:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268850",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_268851.json:
```json
{
    "body": "On second thought, what if the polynomial is `x^1000`? Then we will lose a lot with your code.",
    "created_at": "2016-01-15T18:39:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268851",
    "user": "https://github.com/jdemeyer"
}
```

On second thought, what if the polynomial is `x^1000`? Then we will lose a lot with your code.



---

archive/issue_comments_268852.json:
```json
{
    "body": "Replying to [comment:31 jdemeyer]:\n> On second thought, what if the polynomial is `x^1000`? Then we will lose a lot with your code.\n\n\nIndeed. It is possible to implement a less stupid Horner with grouping. In other words `x^6 + 3x^2 + 1` would be `1 + x^2(3 + x^4)`. There would be a small overhead for dense polynomials.",
    "created_at": "2016-01-15T18:52:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268852",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:31 jdemeyer]:
> On second thought, what if the polynomial is `x^1000`? Then we will lose a lot with your code.


Indeed. It is possible to implement a less stupid Horner with grouping. In other words `x^6 + 3x^2 + 1` would be `1 + x^2(3 + x^4)`. There would be a small overhead for dense polynomials.



---

archive/issue_comments_268853.json:
```json
{
    "body": "Or just skip the addition if the term is 0. It would be nice to benchmark that.",
    "created_at": "2016-01-15T19:08:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268853",
    "user": "https://github.com/jdemeyer"
}
```

Or just skip the addition if the term is 0. It would be nice to benchmark that.



---

archive/issue_comments_268854.json:
```json
{
    "body": "And there is no `mpfi_pow` nor `mpfi_pow_ui`!!",
    "created_at": "2016-01-15T19:12:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268854",
    "user": "https://github.com/videlec"
}
```

And there is no `mpfi_pow` nor `mpfi_pow_ui`!!



---

archive/issue_comments_268855.json:
```json
{
    "body": "`mpfr_pow` is *more* reliable than trial multiplication! Hence we should use it\n\n```\nsage: a = RR(1.1)\nsage: a*a*a*a == a**4    # understandable\nFalse\nsage: b = RealField(256)(1.1)\nsage: ans=b*b*b*b\nsage: (ans-a**4)\n-4.44089209850063e-16\nsage: (ans-a*a*a*a)\n-6.66133814775094e-16\n```\n\n(EDIT: I was completely wrong in my first version)",
    "created_at": "2016-01-15T22:32:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268855",
    "user": "https://github.com/videlec"
}
```

`mpfr_pow` is *more* reliable than trial multiplication! Hence we should use it

```
sage: a = RR(1.1)
sage: a*a*a*a == a**4    # understandable
False
sage: b = RealField(256)(1.1)
sage: ans=b*b*b*b
sage: (ans-a**4)
-4.44089209850063e-16
sage: (ans-a*a*a*a)
-6.66133814775094e-16
```

(EDIT: I was completely wrong in my first version)



---

archive/issue_comments_268856.json:
```json
{
    "body": "Horner evaluations degree=20 precision=64",
    "created_at": "2016-01-16T15:11:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268856",
    "user": "https://github.com/videlec"
}
```

Horner evaluations degree=20 precision=64



---

archive/issue_comments_268857.json:
```json
{
    "body": "Attachment [degree_20_128.png](tarball://root/attachments/some-uuid/ticket19822/degree_20_128.png) by @videlec created at 2016-01-16 15:12:11\n\nHorner evaluations degree=20 precision=128",
    "created_at": "2016-01-16T15:12:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268857",
    "user": "https://github.com/videlec"
}
```

Attachment [degree_20_128.png](tarball://root/attachments/some-uuid/ticket19822/degree_20_128.png) by @videlec created at 2016-01-16 15:12:11

Horner evaluations degree=20 precision=128



---

archive/issue_comments_268858.json:
```json
{
    "body": "Attachment [degree_10_64.png](tarball://root/attachments/some-uuid/ticket19822/degree_10_64.png) by @videlec created at 2016-01-16 15:12:24\n\nHorner evaluations degree=10 precision=64",
    "created_at": "2016-01-16T15:12:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268858",
    "user": "https://github.com/videlec"
}
```

Attachment [degree_10_64.png](tarball://root/attachments/some-uuid/ticket19822/degree_10_64.png) by @videlec created at 2016-01-16 15:12:24

Horner evaluations degree=10 precision=64



---

archive/issue_comments_268859.json:
```json
{
    "body": "Attachment [degree_10_128.png](tarball://root/attachments/some-uuid/ticket19822/degree_10_128.png) by @videlec created at 2016-01-16 15:12:36\n\nHorner evaluations degree=10 precision=128",
    "created_at": "2016-01-16T15:12:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268859",
    "user": "https://github.com/videlec"
}
```

Attachment [degree_10_128.png](tarball://root/attachments/some-uuid/ticket19822/degree_10_128.png) by @videlec created at 2016-01-16 15:12:36

Horner evaluations degree=10 precision=128



---

archive/issue_comments_268860.json:
```json
{
    "body": "Horner evaluations degree=20 nb_terms=1",
    "created_at": "2016-01-16T15:17:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268860",
    "user": "https://github.com/videlec"
}
```

Horner evaluations degree=20 nb_terms=1



---

archive/issue_comments_268861.json:
```json
{
    "body": "Attachment [poly_20_2.png](tarball://root/attachments/some-uuid/ticket19822/poly_20_2.png) by @videlec created at 2016-01-16 15:17:29\n\nHorner evaluations degree=20 nb_terms=2",
    "created_at": "2016-01-16T15:17:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268861",
    "user": "https://github.com/videlec"
}
```

Attachment [poly_20_2.png](tarball://root/attachments/some-uuid/ticket19822/poly_20_2.png) by @videlec created at 2016-01-16 15:17:29

Horner evaluations degree=20 nb_terms=2



---

archive/issue_comments_268862.json:
```json
{
    "body": "Horner evaluations degree=20 nb_terms=5",
    "created_at": "2016-01-16T15:17:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268862",
    "user": "https://github.com/videlec"
}
```

Horner evaluations degree=20 nb_terms=5



---

archive/issue_comments_268863.json:
```json
{
    "body": "Attachment [poly_20_5.png](tarball://root/attachments/some-uuid/ticket19822/poly_20_5.png) by @videlec created at 2016-01-16 15:17:58\n\nHorner evaluations degree=20 nb_terms=13",
    "created_at": "2016-01-16T15:17:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268863",
    "user": "https://github.com/videlec"
}
```

Attachment [poly_20_5.png](tarball://root/attachments/some-uuid/ticket19822/poly_20_5.png) by @videlec created at 2016-01-16 15:17:58

Horner evaluations degree=20 nb_terms=13



---

archive/issue_comments_268864.json:
```json
{
    "body": "Attachment [poly_20_13.png](tarball://root/attachments/some-uuid/ticket19822/poly_20_13.png) by @videlec created at 2016-01-16 15:18:13\n\nHorner evaluations degree=20 nb_terms=21",
    "created_at": "2016-01-16T15:18:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268864",
    "user": "https://github.com/videlec"
}
```

Attachment [poly_20_13.png](tarball://root/attachments/some-uuid/ticket19822/poly_20_13.png) by @videlec created at 2016-01-16 15:18:13

Horner evaluations degree=20 nb_terms=21



---

archive/issue_comments_268865.json:
```json
{
    "body": "Attachment [poly_20_21.png](tarball://root/attachments/some-uuid/ticket19822/poly_20_21.png) by @videlec created at 2016-01-16 15:29:30\n\nHorner evaluations degree=10 precision=256",
    "created_at": "2016-01-16T15:29:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268865",
    "user": "https://github.com/videlec"
}
```

Attachment [poly_20_21.png](tarball://root/attachments/some-uuid/ticket19822/poly_20_21.png) by @videlec created at 2016-01-16 15:29:30

Horner evaluations degree=10 precision=256



---

archive/issue_comments_268866.json:
```json
{
    "body": "Attachment [degree_20_256.png](tarball://root/attachments/some-uuid/ticket19822/degree_20_256.png) by @videlec created at 2016-01-16 15:31:28\n\nI attached files which compare the various possibilities for Horner scheme:\n\n- `eval1`: the current version which is straightforward Horner expansion (red)\n- `eval2`: the same but skip addition if the term is 0 (green)\n- `eval3`: use `mpfr_pow` (blue)\n\nThere are files `degree_{deg}_{prec}.png` for fixed degrees where the number of terms vary and `poly_{deg}_{nb_terms}.png` where the percision vary.\n\n[This is the Trac macro *Image* that was inherited from the migration called with arguments (degree_20_64.png,45%))](https://trac.sagemath.org/wiki/WikiMacros#Image-macro) [This is the Trac macro *Image* that was inherited from the migration called with arguments (degree_20_256.png,45%))](https://trac.sagemath.org/wiki/WikiMacros#Image-macro)\n\n[This is the Trac macro *Image* that was inherited from the migration called with arguments (poly_20_2.png,45%))](https://trac.sagemath.org/wiki/WikiMacros#Image-macro) [This is the Trac macro *Image* that was inherited from the migration called with arguments (poly_20_13.png,45%))](https://trac.sagemath.org/wiki/WikiMacros#Image-macro)\n\n`eval2` seems superior over `eval1`. But `eval3` seems only interesting for very sparse polynomials or very large precision. Indeed, for half dense polynomials (degree=20, nb_terms=13), `eval3` gets better than the other two around prec=2<sup>8</sup>",
    "created_at": "2016-01-16T15:31:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268866",
    "user": "https://github.com/videlec"
}
```

Attachment [degree_20_256.png](tarball://root/attachments/some-uuid/ticket19822/degree_20_256.png) by @videlec created at 2016-01-16 15:31:28

I attached files which compare the various possibilities for Horner scheme:

- `eval1`: the current version which is straightforward Horner expansion (red)
- `eval2`: the same but skip addition if the term is 0 (green)
- `eval3`: use `mpfr_pow` (blue)

There are files `degree_{deg}_{prec}.png` for fixed degrees where the number of terms vary and `poly_{deg}_{nb_terms}.png` where the percision vary.

[This is the Trac macro *Image* that was inherited from the migration called with arguments (degree_20_64.png,45%))](https://trac.sagemath.org/wiki/WikiMacros#Image-macro) [This is the Trac macro *Image* that was inherited from the migration called with arguments (degree_20_256.png,45%))](https://trac.sagemath.org/wiki/WikiMacros#Image-macro)

[This is the Trac macro *Image* that was inherited from the migration called with arguments (poly_20_2.png,45%))](https://trac.sagemath.org/wiki/WikiMacros#Image-macro) [This is the Trac macro *Image* that was inherited from the migration called with arguments (poly_20_13.png,45%))](https://trac.sagemath.org/wiki/WikiMacros#Image-macro)

`eval2` seems superior over `eval1`. But `eval3` seems only interesting for very sparse polynomials or very large precision. Indeed, for half dense polynomials (degree=20, nb_terms=13), `eval3` gets better than the other two around prec=2<sup>8</sup>



---

archive/issue_comments_268867.json:
```json
{
    "body": "Do you have code for `eval2`? I think that might be the best in the end, it is sort of a compromise.",
    "created_at": "2016-01-17T22:41:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268867",
    "user": "https://github.com/jdemeyer"
}
```

Do you have code for `eval2`? I think that might be the best in the end, it is sort of a compromise.



---

archive/issue_comments_268868.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-01-18T12:04:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268868",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_268869.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-01-18T12:08:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268869",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_268870.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-01-18T12:08:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268870",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_268871.json:
```json
{
    "body": "Replying to [comment:40 git]:\n> |                                                                                                                                          |                                                  |\n> |------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------|\n> |[6970134](http://git.sagemath.org/sage.git/commit/?id=6970134df31c259484fd3d5fda0a2e6516a7db70)|`Trac 19822: ignore zero coefficients + copyright`|\n\n\nCould you at least use the [standard copyright template](http://doc.sagemath.org/html/en/developer/coding_basics.html#headings-of-sage-library-code-files) instead?",
    "created_at": "2016-01-18T13:35:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268871",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:40 git]:
> |                                                                                                                                          |                                                  |
> |------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------|
> |[6970134](http://git.sagemath.org/sage.git/commit/?id=6970134df31c259484fd3d5fda0a2e6516a7db70)|`Trac 19822: ignore zero coefficients + copyright`|


Could you at least use the [standard copyright template](http://doc.sagemath.org/html/en/developer/coding_basics.html#headings-of-sage-library-code-files) instead?



---

archive/issue_comments_268872.json:
```json
{
    "body": "In doctests, use the `x^n` notation instead of `x**n`.",
    "created_at": "2016-01-18T13:40:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268872",
    "user": "https://github.com/jdemeyer"
}
```

In doctests, use the `x^n` notation instead of `x**n`.



---

archive/issue_comments_268873.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-01-18T13:40:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268873",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_events_054233.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-01-18T13:40:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "milestone": "sage-7.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19585#event-54233"
}
```



---

archive/issue_comments_268874.json:
```json
{
    "body": "Remove the mention of \"complex\" values:\n\n```\nThis file provides fast evaluation of integer polynomials with a real\nor complex value\n```",
    "created_at": "2016-01-18T13:41:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268874",
    "user": "https://github.com/jdemeyer"
}
```

Remove the mention of "complex" values:

```
This file provides fast evaluation of integer polynomials with a real
or complex value
```



---

archive/issue_comments_268875.json:
```json
{
    "body": "The doctests with the various rounding modes are obsolete, since the rounding mode isn't used. I suggest to remove those tests.",
    "created_at": "2016-01-18T14:54:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268875",
    "user": "https://github.com/jdemeyer"
}
```

The doctests with the various rounding modes are obsolete, since the rounding mode isn't used. I suggest to remove those tests.



---

archive/issue_comments_268876.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-01-18T17:56:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268876",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_268877.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-01-18T17:56:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268877",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_268878.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-01-19T08:52:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268878",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_268879.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-01-20T10:19:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19585#issuecomment-268879",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_054234.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-01-20T10:19:57Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/19585",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19585#event-54234"
}
```
