# Issue 30539: Implement an improved subgraph test for graph backends

Issue created by migration from https://trac.sagemath.org/ticket/30776

Original creator: @kliem

Original creation time: 2020-10-16 08:51:06

CC:  @kliem dimpase dcoudert vdelecroix

Keywords: graph, equality, subgraph

We implement an improved subgraph test that also speeds up equality test.

Before (on #30753):


```
sage: G = graphs.Grid2dGraph(100, 100)  # dynamic sparse                                                                                                                                                                                                                                                                                                                   
sage: H = G.copy()                                                                                                                                                                                                                                                                                                                                                         
sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       
14.7 ms ± 34.7 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
sage: V = list(G)                                                                                                                                                                                                                                                                                                                                                          
sage: H = G.subgraph(V[:50], algorithm='add')                                                                                                                                                                                                                                                                                                                              
sage: %timeit H.is_subgraph(G)                                                                                                                                                                                                                                                                                                                                             
158 µs ± 162 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
sage: %timeit H.is_subgraph(G, induced=False)                                                                                                                                                                                                                                                                                                                              
48.8 µs ± 131 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)

sage: G = G.copy(immutable=True)  # static sparse                                                                                                                                                                                                                                                                                                                          
sage: H = G.copy()                                                                                                                                                                                                                                                                                                                                                         
sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       
10.4 ms ± 5.66 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
sage: V = list(G)                                                                                                                                                                                                                                                                                                                                                          
sage: H = G.subgraph(V[:50], algorithm='add')                                                                                                                                                                                                                                                                                                                              
sage: %timeit H.is_subgraph(G)                                                                                                                                                                                                                                                                                                                                             
398 µs ± 223 ns per loop (mean ± std. dev. of 7 runs, 1000 loops each)
sage: %timeit H.is_subgraph(G, induced=False)                                                                                                                                                                                                                                                                                                                              
37.2 µs ± 141 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
                                                                                                                                                                                                                                                                                                                                                                   
sage: G = graphs.CompleteGraph(1000)  # dynamic dense                                                                                                                                                                                                                                                                                                                      
sage: H = G.copy()                                                                                                                                                                                                                                                                                                                                                         
sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       
349 ms ± 1.9 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
sage: V = list(G)                                                                                                                                                                                                                                                                                                                                                          
sage: H = G.subgraph(V[:50], algorithm='add')                                                                                                                                                                                                                                                                                                                              
sage: %timeit H.is_subgraph(G)                                                                                                                                                                                                                                                                                                                                             
1.51 ms ± 2.18 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
sage: %timeit H.is_subgraph(G, induced=False)                                                                                                                                                                                                                                                                                                                              
539 µs ± 705 ns per loop (mean ± std. dev. of 7 runs, 1000 loops each)
```


After:


```
sage: G = graphs.Grid2dGraph(100, 100)  # dynamic sparse                                                                                                                                                                                                                                                                                                                   
sage: H = G.copy()                                                                                                                                                                                                                                                                                                                                                         
sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       
3.8 ms ± 3.04 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
sage: V = list(G)                                                                                                                                                                                                                                                                                                                                                          
sage: H = G.subgraph(V[:50], algorithm='add')                                                                                                                                                                                                                                                                                                                              
sage: %timeit H.is_subgraph(G)                                                                                                                                                                                                                                                                                                                                             
50.4 µs ± 53.6 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
sage: %timeit H.is_subgraph(G, induced=False)                                                                                                                                                                                                                                                                                                                              
34.3 µs ± 22.6 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
                                                                                                                                                                                                                                                                                                                                                                      
sage: G = G.copy(immutable=True)  # static sparse                                                                                                                                                                                                                                                                                                                          
sage: H = G.copy()                                                                                                                                                                                                                                                                                                                                                         
sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       
2.42 ms ± 2.44 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
sage: V = list(G)                                                                                                                                                                                                                                                                                                                                                          
sage: H = G.subgraph(V[:50], algorithm='add')                                                                                                                                                                                                                                                                                                                              
sage: %timeit H.is_subgraph(G)                                                                                                                                                                                                                                                                                                                                             
34.6 µs ± 39.8 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
sage: %timeit H.is_subgraph(G, induced=False)                                                                                                                                                                                                                                                                                                                              
24.7 µs ± 31.5 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
sage: G = graphs.CompleteGraph(1000)  # dynamic dense                                                                                                                                                                                                                                                                                                                      
sage: H = G.copy()                                                                                                                                                                                                                                                                                                                                                         
sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       
89.5 ms ± 48.5 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
sage: V = list(G)                                                                                                                                                                                                                                                                                                                                                          
sage: H = G.subgraph(V[:50], algorithm='add')                                                                                                                                                                                                                                                                                                                              
sage: %timeit H.is_subgraph(G)                                                                                                                                                                                                                                                                                                                                             
908 µs ± 810 ns per loop (mean ± std. dev. of 7 runs, 1000 loops each)
sage: %timeit H.is_subgraph(G, induced=False)                                                                                                                                                                                                                                                                                                                              
70.8 µs ± 187 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
```



This is a step towards #30641.


---

Comment by @kliem created at 2020-10-16 08:52:03

Changing status from new to needs_review.


---

Comment by @kliem created at 2020-10-16 08:52:03

Last 10 new commits:


---

Comment by dcoudert created at 2020-10-16 16:16:08

Changing status from needs_review to positive_review.


---

Comment by dcoudert created at 2020-10-16 16:16:08

This looks good to me.


---

Comment by @kliem created at 2020-10-16 18:58:39

Thank you.


---

Comment by vbraun created at 2020-11-01 01:07:37

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2020-11-01 01:07:37

Merge conflict


---

Comment by @kliem created at 2020-11-04 08:58:03

It appears that Volker Braun tried to merge #30776 and #30777 at the same time, but they had a merge conflict.

We set this back on positive review and hope it works now.


---

Comment by @kliem created at 2020-11-04 08:58:03

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2020-11-20 22:14:56

Resolution: fixed
