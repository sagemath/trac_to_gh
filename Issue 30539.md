# Issue 30539: Implement an improved subgraph test for graph backends

archive/issues_030539.json:
```json
{
    "body": "CC:  @kliem dimpase dcoudert vdelecroix\n\nKeywords: graph, equality, subgraph\n\nWe implement an improved subgraph test that also speeds up equality test.\n\nBefore (on #30753):\n\n\n```\nsage: G = graphs.Grid2dGraph(100, 100)  # dynamic sparse                                                                                                                                                                                                                                                                                                                   \nsage: H = G.copy()                                                                                                                                                                                                                                                                                                                                                         \nsage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       \n14.7 ms \u00b1 34.7 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\nsage: V = list(G)                                                                                                                                                                                                                                                                                                                                                          \nsage: H = G.subgraph(V[:50], algorithm='add')                                                                                                                                                                                                                                                                                                                              \nsage: %timeit H.is_subgraph(G)                                                                                                                                                                                                                                                                                                                                             \n158 \u00b5s \u00b1 162 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\nsage: %timeit H.is_subgraph(G, induced=False)                                                                                                                                                                                                                                                                                                                              \n48.8 \u00b5s \u00b1 131 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\n\nsage: G = G.copy(immutable=True)  # static sparse                                                                                                                                                                                                                                                                                                                          \nsage: H = G.copy()                                                                                                                                                                                                                                                                                                                                                         \nsage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       \n10.4 ms \u00b1 5.66 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\nsage: V = list(G)                                                                                                                                                                                                                                                                                                                                                          \nsage: H = G.subgraph(V[:50], algorithm='add')                                                                                                                                                                                                                                                                                                                              \nsage: %timeit H.is_subgraph(G)                                                                                                                                                                                                                                                                                                                                             \n398 \u00b5s \u00b1 223 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\nsage: %timeit H.is_subgraph(G, induced=False)                                                                                                                                                                                                                                                                                                                              \n37.2 \u00b5s \u00b1 141 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\n                                                                                                                                                                                                                                                                                                                                                                   \nsage: G = graphs.CompleteGraph(1000)  # dynamic dense                                                                                                                                                                                                                                                                                                                      \nsage: H = G.copy()                                                                                                                                                                                                                                                                                                                                                         \nsage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       \n349 ms \u00b1 1.9 ms per loop (mean \u00b1 std. dev. of 7 runs, 1 loop each)\nsage: V = list(G)                                                                                                                                                                                                                                                                                                                                                          \nsage: H = G.subgraph(V[:50], algorithm='add')                                                                                                                                                                                                                                                                                                                              \nsage: %timeit H.is_subgraph(G)                                                                                                                                                                                                                                                                                                                                             \n1.51 ms \u00b1 2.18 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\nsage: %timeit H.is_subgraph(G, induced=False)                                                                                                                                                                                                                                                                                                                              \n539 \u00b5s \u00b1 705 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\n```\n\n\nAfter:\n\n\n```\nsage: G = graphs.Grid2dGraph(100, 100)  # dynamic sparse                                                                                                                                                                                                                                                                                                                   \nsage: H = G.copy()                                                                                                                                                                                                                                                                                                                                                         \nsage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       \n3.8 ms \u00b1 3.04 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\nsage: V = list(G)                                                                                                                                                                                                                                                                                                                                                          \nsage: H = G.subgraph(V[:50], algorithm='add')                                                                                                                                                                                                                                                                                                                              \nsage: %timeit H.is_subgraph(G)                                                                                                                                                                                                                                                                                                                                             \n50.4 \u00b5s \u00b1 53.6 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\nsage: %timeit H.is_subgraph(G, induced=False)                                                                                                                                                                                                                                                                                                                              \n34.3 \u00b5s \u00b1 22.6 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\n                                                                                                                                                                                                                                                                                                                                                                      \nsage: G = G.copy(immutable=True)  # static sparse                                                                                                                                                                                                                                                                                                                          \nsage: H = G.copy()                                                                                                                                                                                                                                                                                                                                                         \nsage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       \n2.42 ms \u00b1 2.44 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\nsage: V = list(G)                                                                                                                                                                                                                                                                                                                                                          \nsage: H = G.subgraph(V[:50], algorithm='add')                                                                                                                                                                                                                                                                                                                              \nsage: %timeit H.is_subgraph(G)                                                                                                                                                                                                                                                                                                                                             \n34.6 \u00b5s \u00b1 39.8 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\nsage: %timeit H.is_subgraph(G, induced=False)                                                                                                                                                                                                                                                                                                                              \n24.7 \u00b5s \u00b1 31.5 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     \nsage: G = graphs.CompleteGraph(1000)  # dynamic dense                                                                                                                                                                                                                                                                                                                      \nsage: H = G.copy()                                                                                                                                                                                                                                                                                                                                                         \nsage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       \n89.5 ms \u00b1 48.5 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 10 loops each)\nsage: V = list(G)                                                                                                                                                                                                                                                                                                                                                          \nsage: H = G.subgraph(V[:50], algorithm='add')                                                                                                                                                                                                                                                                                                                              \nsage: %timeit H.is_subgraph(G)                                                                                                                                                                                                                                                                                                                                             \n908 \u00b5s \u00b1 810 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\nsage: %timeit H.is_subgraph(G, induced=False)                                                                                                                                                                                                                                                                                                                              \n70.8 \u00b5s \u00b1 187 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\n```\n\n\n\nThis is a step towards #30641.\n\nIssue created by migration from https://trac.sagemath.org/ticket/30776\n\n",
    "created_at": "2020-10-16T08:51:06Z",
    "labels": [
        "graph theory",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "Implement an improved subgraph test for graph backends",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30539",
    "user": "@kliem"
}
```
CC:  @kliem dimpase dcoudert vdelecroix

Keywords: graph, equality, subgraph

We implement an improved subgraph test that also speeds up equality test.

Before (on #30753):


```
sage: G = graphs.Grid2dGraph(100, 100)  # dynamic sparse                                                                                                                                                                                                                                                                                                                   
sage: H = G.copy()                                                                                                                                                                                                                                                                                                                                                         
sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       
14.7 ms ± 34.7 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
sage: V = list(G)                                                                                                                                                                                                                                                                                                                                                          
sage: H = G.subgraph(V[:50], algorithm='add')                                                                                                                                                                                                                                                                                                                              
sage: %timeit H.is_subgraph(G)                                                                                                                                                                                                                                                                                                                                             
158 µs ± 162 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
sage: %timeit H.is_subgraph(G, induced=False)                                                                                                                                                                                                                                                                                                                              
48.8 µs ± 131 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)

sage: G = G.copy(immutable=True)  # static sparse                                                                                                                                                                                                                                                                                                                          
sage: H = G.copy()                                                                                                                                                                                                                                                                                                                                                         
sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       
10.4 ms ± 5.66 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
sage: V = list(G)                                                                                                                                                                                                                                                                                                                                                          
sage: H = G.subgraph(V[:50], algorithm='add')                                                                                                                                                                                                                                                                                                                              
sage: %timeit H.is_subgraph(G)                                                                                                                                                                                                                                                                                                                                             
398 µs ± 223 ns per loop (mean ± std. dev. of 7 runs, 1000 loops each)
sage: %timeit H.is_subgraph(G, induced=False)                                                                                                                                                                                                                                                                                                                              
37.2 µs ± 141 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
                                                                                                                                                                                                                                                                                                                                                                   
sage: G = graphs.CompleteGraph(1000)  # dynamic dense                                                                                                                                                                                                                                                                                                                      
sage: H = G.copy()                                                                                                                                                                                                                                                                                                                                                         
sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       
349 ms ± 1.9 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
sage: V = list(G)                                                                                                                                                                                                                                                                                                                                                          
sage: H = G.subgraph(V[:50], algorithm='add')                                                                                                                                                                                                                                                                                                                              
sage: %timeit H.is_subgraph(G)                                                                                                                                                                                                                                                                                                                                             
1.51 ms ± 2.18 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
sage: %timeit H.is_subgraph(G, induced=False)                                                                                                                                                                                                                                                                                                                              
539 µs ± 705 ns per loop (mean ± std. dev. of 7 runs, 1000 loops each)
```


After:


```
sage: G = graphs.Grid2dGraph(100, 100)  # dynamic sparse                                                                                                                                                                                                                                                                                                                   
sage: H = G.copy()                                                                                                                                                                                                                                                                                                                                                         
sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       
3.8 ms ± 3.04 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
sage: V = list(G)                                                                                                                                                                                                                                                                                                                                                          
sage: H = G.subgraph(V[:50], algorithm='add')                                                                                                                                                                                                                                                                                                                              
sage: %timeit H.is_subgraph(G)                                                                                                                                                                                                                                                                                                                                             
50.4 µs ± 53.6 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
sage: %timeit H.is_subgraph(G, induced=False)                                                                                                                                                                                                                                                                                                                              
34.3 µs ± 22.6 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
                                                                                                                                                                                                                                                                                                                                                                      
sage: G = G.copy(immutable=True)  # static sparse                                                                                                                                                                                                                                                                                                                          
sage: H = G.copy()                                                                                                                                                                                                                                                                                                                                                         
sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       
2.42 ms ± 2.44 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
sage: V = list(G)                                                                                                                                                                                                                                                                                                                                                          
sage: H = G.subgraph(V[:50], algorithm='add')                                                                                                                                                                                                                                                                                                                              
sage: %timeit H.is_subgraph(G)                                                                                                                                                                                                                                                                                                                                             
34.6 µs ± 39.8 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
sage: %timeit H.is_subgraph(G, induced=False)                                                                                                                                                                                                                                                                                                                              
24.7 µs ± 31.5 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
sage: G = graphs.CompleteGraph(1000)  # dynamic dense                                                                                                                                                                                                                                                                                                                      
sage: H = G.copy()                                                                                                                                                                                                                                                                                                                                                         
sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       
89.5 ms ± 48.5 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
sage: V = list(G)                                                                                                                                                                                                                                                                                                                                                          
sage: H = G.subgraph(V[:50], algorithm='add')                                                                                                                                                                                                                                                                                                                              
sage: %timeit H.is_subgraph(G)                                                                                                                                                                                                                                                                                                                                             
908 µs ± 810 ns per loop (mean ± std. dev. of 7 runs, 1000 loops each)
sage: %timeit H.is_subgraph(G, induced=False)                                                                                                                                                                                                                                                                                                                              
70.8 µs ± 187 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
```



This is a step towards #30641.

Issue created by migration from https://trac.sagemath.org/ticket/30776





---

archive/issue_comments_436128.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-10-16T08:52:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30539#issuecomment-436128",
    "user": "@kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_436129.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2020-10-16T08:52:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30539#issuecomment-436129",
    "user": "@kliem"
}
```

Last 10 new commits:



---

archive/issue_comments_436130.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-10-16T16:16:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30539#issuecomment-436130",
    "user": "dcoudert"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_436131.json:
```json
{
    "body": "This looks good to me.",
    "created_at": "2020-10-16T16:16:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30539#issuecomment-436131",
    "user": "dcoudert"
}
```

This looks good to me.



---

archive/issue_comments_436132.json:
```json
{
    "body": "Thank you.",
    "created_at": "2020-10-16T18:58:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30539#issuecomment-436132",
    "user": "@kliem"
}
```

Thank you.



---

archive/issue_comments_436133.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-11-01T01:07:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30539#issuecomment-436133",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_436134.json:
```json
{
    "body": "Merge conflict",
    "created_at": "2020-11-01T01:07:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30539#issuecomment-436134",
    "user": "vbraun"
}
```

Merge conflict



---

archive/issue_comments_436135.json:
```json
{
    "body": "It appears that Volker Braun tried to merge #30776 and #30777 at the same time, but they had a merge conflict.\n\nWe set this back on positive review and hope it works now.",
    "created_at": "2020-11-04T08:58:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30539#issuecomment-436135",
    "user": "@kliem"
}
```

It appears that Volker Braun tried to merge #30776 and #30777 at the same time, but they had a merge conflict.

We set this back on positive review and hope it works now.



---

archive/issue_comments_436136.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2020-11-04T08:58:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30539#issuecomment-436136",
    "user": "@kliem"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_436137.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-11-20T22:14:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30539#issuecomment-436137",
    "user": "vbraun"
}
```

Resolution: fixed
