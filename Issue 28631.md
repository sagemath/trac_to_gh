# Issue 28631: 1 imagemagick failing doctest in plot/animate.py

Issue created by migration from https://trac.sagemath.org/ticket/28868

Original creator: slabbe

Original creation time: 2019-12-10 08:45:18


```
sage -t --optional=sage,imagemagick src/sage/plot/animate.py
```


gives


```
Using --optional=imagemagick,memlimit,sage
Doctesting 1 file.
sage -t src/sage/plot/animate.py
**********************************************************************
File "src/sage/plot/animate.py", line 563, in sage.plot.animate.Animation.?
Failed example:
    with open(td + 'my_animation.gif', 'rb') as f: print('\x21\xf9\x04\x08\x23\x00' in f.read())  # optional -- ImageMagick
Exception raised:
    Traceback (most recent call last):
      File "/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1123, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.plot.animate.Animation.?[3]>", line 1, in <module>
        with open(td + 'my_animation.gif', 'rb') as f: print('\x21\xf9\x04\x08\x23\x00' in f.read())  # optional -- ImageMagick
    TypeError: a bytes-like object is required, not 'str'
**********************************************************************

...

**********************************************************************
File "src/sage/plot/animate.py", line 1068, in sage.plot.animate.Animation.save
Failed example:
    with open(td + 'wave.gif', 'rb') as f: print('!\xff\x0bNETSCAPE2.0\x03\x01\x03\x00\x00' in f.read())  # optional -- ImageMagick
Exception raised:
    Traceback (most recent call last):
      File "/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1123, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.plot.animate.Animation.save[14]>", line 1, in <module>
        with open(td + 'wave.gif', 'rb') as f: print('!\xff\x0bNETSCAPE2.0\x03\x01\x03\x00\x00' in f.read())  # optional -- ImageMagick
    TypeError: a bytes-like object is required, not 'str'
**********************************************************************
2 items had failures:
   1 of   9 in sage.plot.animate.Animation.?
   6 of  16 in sage.plot.animate.Animation.save
    [208 tests, 7 failures, 57.48 s]
----------------------------------------------------------------------
sage -t src/sage/plot/animate.py  # 7 doctests failed
----------------------------------------------------------------------
```



---

Comment by chapoton created at 2019-12-13 20:15:30

Changing status from new to needs_review.


---

Comment by chapoton created at 2019-12-13 20:15:30

New commits:


---

Comment by chapoton created at 2019-12-14 13:14:33

does not work


---

Comment by chapoton created at 2019-12-14 13:14:33

Changing status from needs_review to needs_work.


---

Comment by embray created at 2020-01-06 14:10:03

Ticket retargeted after milestone closed


---

Comment by chapoton created at 2020-04-03 20:09:55

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2020-04-03 20:09:55

Sébastien, could you please try the branch here ? It seems that it fixes the bytes problems, but there remains a true failure afterwards.


---

Comment by chapoton created at 2020-04-04 08:15:14

All tests seem to pass, I just tried.


---

Comment by slabbe created at 2020-04-04 10:18:49

With the branch on top of 9.1.beta9 I get


```
Git branch: 28868
Using --optional=imagemagick,memlimit,sage
Doctesting 1 file.
sage -t src/sage/plot/animate.py
**********************************************************************
File "src/sage/plot/animate.py", line 1068, in sage.plot.animate.Animation.save
Failed example:
    with open(td + 'wave.gif', 'rb') as f: print(b'!\xff\x0bNETSCAPE2.0\x03\x01\x02\x00\x00' in f.read())  # optional -- ImageMagick
Expected:
    True
Got:
    False
**********************************************************************
1 item had failures:
   1 of  16 in sage.plot.animate.Animation.save
    [208 tests, 1 failure, 57.01 s]
----------------------------------------------------------------------
sage -t src/sage/plot/animate.py  # 1 doctest failed
----------------------------------------------------------------------
```



---

Comment by chapoton created at 2020-04-04 10:27:31

ok. Je propose de faire passer la branche, et de garder le dernier probleme pour un autre ticket. Après tout, c'est un autre probleme, certes au meme endroit.


---

Comment by slabbe created at 2020-04-04 10:34:59

J'ai identifié le soucis. Le dernier changement que tu fait remplace aussi un `\x03` par un `\x02`:

```diff
- sage: with open(td + 'wave.gif', 'rb') as f: print('!\xff\x0bNETSCAPE2.0\x03\x01\x03\x00\x00' in f.read())  # optional -- ImageMagick
+ sage: with open(td + 'wave.gif', 'rb') as f: print(b'!\xff\x0bNETSCAPE2.0\x03\x01\x02\x00\x00' in f.read())  # optional -- ImageMagick
```

Si je garde le `\x03`, alors chez moi le test passe.


---

Comment by slabbe created at 2020-04-04 10:36:56

Si chez toi, tu as besoin de garder le `\x02`, je suggère alors de garder que le préfixe commun
`b'!\xff\x0bNETSCAPE2.0\x03\x01` pour le dernier test.


---

Comment by chapoton created at 2020-04-04 11:42:03

Chez moi, ca foire quand je mets \x03 et ca passe quand je mets \x02

Je veux bien ne garder que le prefixe commun, mais est-ce que ca ne supprime pas tout l'interet du doctest ?


---

Comment by slabbe created at 2020-04-04 18:34:19

> Je veux bien ne garder que le prefixe commun, mais est-ce que ca ne supprime pas tout l'interet du doctest ?

The saved file `wave.gif` works as expected on my machine. What about yours?


---

Comment by chapoton created at 2020-04-04 19:43:50

Il me semble que oui. Je l'attache


---

Attachment


---

Comment by chapoton created at 2020-04-04 19:44:47

faudrait voir si il s'arrete au meme point que chez toi


---

Comment by slabbe created at 2020-04-04 20:49:28

Oui, c'est pareil. Du coup, allons y avec le préfixe commun.


---

Comment by git created at 2020-04-05 07:00:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2020-04-05 07:02:14

j'ai eu une autre idee : verifier la presence d'une des deux chaines. Ca me semble mieux respecter l'esprit du doctest. Voir le dernier commit


---

Comment by slabbe created at 2020-04-05 11:19:35

Changing status from needs_review to positive_review.


---

Comment by slabbe created at 2020-04-05 11:19:35


```
sage -t src/sage/plot/animate.py
    [208 tests, 57.03 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
```



---

Comment by vbraun created at 2020-04-08 21:32:36


```
[dochtml] OSError: /amd/compute/sagebot/sage/local/lib/python3.7/site-packages/sage/plot/animate.py:docstring of sage.plot.animate.animate:11: WARNING: Duplicate explicit target name: "imagemagick".
```



---

Comment by vbraun created at 2020-04-08 21:32:41

Changing status from positive_review to needs_work.


---

Comment by chapoton created at 2020-04-09 15:52:47

oh boy, what's that ?

Could it be caused by

```diff
-- `ImageMagick <http://www.imagemagick.org>`_
+- `ImageMagick <https://www.imagemagick.org>`_
```

?


---

Comment by git created at 2020-04-09 16:00:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2020-04-09 16:01:17

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2020-04-09 16:01:17

Here is probably a fix commit. Please review.


---

Comment by slabbe created at 2020-04-10 07:40:36

Oups, the patchbot were telling us that problem for a while...

I think you can't have the same reference link twice in the same file. It must be because of that. I manage to build the doc correctly on my side. Patchbot light is green this time. Good to go.


---

Comment by slabbe created at 2020-04-10 07:40:36

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-04-16 22:33:32

Resolution: fixed
