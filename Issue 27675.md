# Issue 27675: Add GAP package PackageManager to gap_packages

Issue created by migration from https://trac.sagemath.org/ticket/27912

Original creator: nthiery

Original creation time: 2019-05-31 22:07:18

CC:  dimpase tscrim vbraun embray

The recent GAP `PackageManager` package makes it much much easier to install new GAP packages. It seems to work smoothly from within Sage (up to the caveat of #27911), with e.g.:

```
    sage: libgap.InstallPackage("Semigroups")
```


So this seems like a valuable low hanging fruit.

Of course, the user still needs to have compiler tools and write access to the Sage install; but there is only so much we can do.


---

Comment by nthiery created at 2019-05-31 22:32:35

Oh, it's already bundled in the gap tarball. So it would be just a question of listing it in `spkg-install`?


---

Comment by dimpase created at 2019-05-31 22:48:05

it is more of a question whether it does the right thing, as out directory configuration for GAP is not the original GAPâ€™s one.


---

Comment by nthiery created at 2019-05-31 23:00:03

Ok, I'll give it a shot. It's a very recent package and in pure GAP, so the odds are probably good.


---

Comment by nthiery created at 2019-05-31 23:07:12

Btw: in case this is relevant, e.g. to discuss with Michael Torpey who wrote `PackageManager`, I'll be in St Andrews Monday-Thursday (and in fact hiking with James this week-end).


---

Comment by nthiery created at 2019-05-31 23:19:55

Oh, maybe I see what you mean: the packages get installed in ~/.gap/pkg rather than in Sage's directory. Kind of `pip install --user`. Well, the bonus is that it does not require special permissions. And the same installation can be reused across several installs of GAP. The caveat being to guarantee that it's compatible with all those installations.

At least it seems to work smoothly for now. I'll discuss with Michael about this.


---

Comment by nthiery created at 2019-05-31 23:20:23

Adding `PackageManager` to spkg-install seems to do the trick :-)


---

Comment by nthiery created at 2019-05-31 23:27:19

New commits:


---

Comment by nthiery created at 2019-05-31 23:27:19

Changing status from new to needs_review.


---

Comment by nthiery created at 2019-06-01 05:07:57

For the record: all tests passed (with #27911+#27912).


---

Comment by dimpase created at 2019-06-01 06:08:43

Replying to [comment:7 nthiery]:
> Oh, maybe I see what you mean: the packages get installed in ~/.gap/pkg rather than in Sage's directory. 

I meant packages that do require compilation - especially ones that build GAP kernel modules are tricky.


---

Comment by nthiery created at 2019-06-01 07:44:33

Ah, ok. This seems to have worked smoothly with Semigroup (which requires compilation). I'll be banging on it more seriously all week long so this will be a good test. Do you have suggestions of other complex / more oldish packages to try out?


---

Comment by dimpase created at 2019-06-01 08:00:18

Replying to [comment:14 nthiery]:
> Ah, ok. This seems to have worked smoothly with Semigroup (which requires compilation). I'll be banging on it more seriously all week long so this will be a good test. Do you have suggestions of other complex / more oldish packages to try out?


[EDIM](https://www.gap-system.org/Packages/edim.html) might be a good test, as it builds a GAP kernel module, and has not been worked on in the context of Sage yet (that is, unlike Semigroup)

You might also want to experiment with e.g. removing GRAPE from `gap_packages` and trying to install it via PackageManager.

Try things  on OSX and Cygwin, try not to pull your hair out in the process :-)
(perhaps we might want to spend ODK money on OSX and Windows hardware, so that we can have more boxes to run buildbots, try things on, etc)

I presume that the present GAP 4.10.1 tarball contains a rather old version of PackageManager - I'd really wait for a newer realese.


---

Comment by nthiery created at 2019-06-04 11:49:47

Trying things out with Michael. Current status:
- `libgap.InstallPackage("PackageManager")` nicely upgrades to the latest version
- In a standard GAP on Linux `InstallPackage("EGIM")` seems to work smoothly
- With Sage's GAP, the compilation fails. There seems to be some missing build artefact, starting from a missing link `sysinfo.gap-default64` -> `sysinfo.gap` presumably due to out-of-source installation. Michael is trying such an out of source installation with plain GAP now.


---

Comment by dimpase created at 2019-06-04 11:57:51

It could be that EDIM needs a patch to be installable in Sage's GAP.

One may try adding it to the list of packages to be installed in gap_packages, and
see how it goes there.


---

Comment by nthiery created at 2019-06-04 19:50:29

Replying to [comment:17 dimpase]:
> It could be that EDIM needs a patch to be installable in Sage's GAP.

Indeed; or that our current out-of-source installation procedure for GAP is missing to install some build artefacts. Eventually, this will all be resolved when GAP will provide a native "make install" feature, and the build system of all packages will be updated. I can't wait :-)


---

Comment by nthiery created at 2019-06-04 20:12:36

Thinking about it a bit more, here is my perspective. 

Things have gone much much better recently on the use of GAP package in Sage, which is great. Indeed, and that's unfortunate, there are still GAP packages that can't be installed in Sage's GAP due to different problems. But somehow, that's none of `PackageManager`'s business.

`PackageManager` is about automating the installation of GAP packages that can already be installed smoothly. As such, it's immediately useful for many packages. We should help our users by making it available.


---

Comment by dimpase created at 2019-06-04 20:15:24

OK, why not, indeed.


---

Comment by dimpase created at 2019-06-04 20:15:24

Changing status from needs_review to positive_review.


---

Comment by nthiery created at 2019-06-05 14:04:23

Thanks Dima for the review


---

Comment by nthiery created at 2019-06-05 14:08:08

For the record: one optional test failure by the patchbot; I don't see how this can be related, so I assume it's noise.

```
sage -t --long src/sage/sat/boolean_polynomials.py
**********************************************************************
File "src/sage/sat/boolean_polynomials.py", line 146, in sage.sat.boolean_polynomials.solve
Failed example:
    len(sls_aes)                                                                      # optional - cryptominisat, long time
Expected:
    256
Got:
    16
```



---

Comment by vbraun created at 2019-06-06 22:26:40

Resolution: fixed


---

Comment by embray created at 2019-06-07 18:13:14

When installing packages through this interface, do they go into `local/share/gap`, or into `.gap`, or somewhere else?

Something I'd already been thinking of previously is that it would be handy to have an additional GAP_ROOT outside of `$SAGE_LOCAL` (which I'm trying as hard as possible to make more manageable) where user-installed packages can go.  Certainly `.gap` is a possibility or this, but it would be nice to have a place where additional user-installed packages can be made available 'globally' to a Sage installation, without actually putting them in `$SAGE_LOCAL` or at least not in `$SAGE_LOCAL/share/gap`.


---

Comment by nthiery created at 2019-06-07 20:38:34

It currently goes by default to ~/.gap (so the analogue of --user in pip). It can be configured with any alternative directory (which should be in GAP's path to be relevant). After discussions with Michael, he will implement a shorthand for "the pkg directory of the current gap".
