# Issue 22031: copy for schememropisms_points not deep enough

archive/issues_022031.json:
```json
{
    "body": "CC:  rlmiller\n\nThe copy function for scheme points does not actually produce a copy of the coords. So if you change a value of the coordinates it changes both the point and the copy.\n\n\n```\nsage: P.<x,y>=ProjectiveSpace(ZZ,1)\nsage: Q=P(152,113)\nsage: copy(Q) is Q\nFalse\nsage: copy(Q)._coords is Q._coords\nTrue\n```\n\n\nThe last output should also be false.\n\nIssue created by migration from https://trac.sagemath.org/ticket/22268\n\n",
    "created_at": "2017-01-28T12:57:12Z",
    "labels": [
        "algebraic geometry",
        "minor",
        "bug"
    ],
    "title": "copy for schememropisms_points not deep enough",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22031",
    "user": "bhutz"
}
```
CC:  rlmiller

The copy function for scheme points does not actually produce a copy of the coords. So if you change a value of the coordinates it changes both the point and the copy.


```
sage: P.<x,y>=ProjectiveSpace(ZZ,1)
sage: Q=P(152,113)
sage: copy(Q) is Q
False
sage: copy(Q)._coords is Q._coords
True
```


The last output should also be false.

Issue created by migration from https://trac.sagemath.org/ticket/22268





---

archive/issue_comments_306185.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-01-28T13:24:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22031#issuecomment-306185",
    "user": "bhutz"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_306186.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-01-28T13:24:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22031#issuecomment-306186",
    "user": "bhutz"
}
```

New commits:



---

archive/issue_comments_306187.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-01-30T21:53:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22031#issuecomment-306187",
    "user": "johanneshuisman"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_306188.json:
```json
{
    "body": "Looks good to me.",
    "created_at": "2017-01-30T23:50:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22031#issuecomment-306188",
    "user": "rlmiller"
}
```

Looks good to me.



---

archive/issue_comments_306189.json:
```json
{
    "body": "Merge conflict...",
    "created_at": "2017-02-02T22:10:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22031#issuecomment-306189",
    "user": "vbraun"
}
```

Merge conflict...



---

archive/issue_comments_306190.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-02-02T22:10:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22031#issuecomment-306190",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_306191.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-02-02T22:39:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22031#issuecomment-306191",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_306192.json:
```json
{
    "body": "Merged.\n\nHowever, I'm getting a test failure in projective_morphism that is unrelated to this change. It seems that this fails for me in 7.6.beta2 also.\n\n\n```\nFile \"src/sage/schemes/projective/projective_morphism.py\", line 853, in sage.schemes.projective.projective_morphism.SchemeMorphism_polynomial_projective_space.dynatomic_polynomial\nFailed example:\n    f.dynatomic_polynomial(2)\nExpected:\n    2.00000000000000*x^2 + 0.999999999999999*y^2\nGot:\n    0.666666666666667*x^2 + 0.333333333333333*y^2\n```\n\n\nLooking at the doctest, both the 'Expected' value and the 'Got' value are actually wrong. There is already a ticket open for fixing some other dynatomic polynomial issues, so I'll add this failure there.",
    "created_at": "2017-02-02T22:43:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22031#issuecomment-306192",
    "user": "bhutz"
}
```

Merged.

However, I'm getting a test failure in projective_morphism that is unrelated to this change. It seems that this fails for me in 7.6.beta2 also.


```
File "src/sage/schemes/projective/projective_morphism.py", line 853, in sage.schemes.projective.projective_morphism.SchemeMorphism_polynomial_projective_space.dynatomic_polynomial
Failed example:
    f.dynatomic_polynomial(2)
Expected:
    2.00000000000000*x^2 + 0.999999999999999*y^2
Got:
    0.666666666666667*x^2 + 0.333333333333333*y^2
```


Looking at the doctest, both the 'Expected' value and the 'Got' value are actually wrong. There is already a ticket open for fixing some other dynatomic polynomial issues, so I'll add this failure there.



---

archive/issue_comments_306193.json:
```json
{
    "body": "What is happening in that example is that the quo_rem fails to return a nonzero reminder, so then maxima is tried. The division in maxima (line 964) is not checked to see if the remainder is zero (which it is not).\n\nThis example is unable to be exactly divided, so it should return the rational function.",
    "created_at": "2017-02-02T22:59:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22031#issuecomment-306193",
    "user": "bhutz"
}
```

What is happening in that example is that the quo_rem fails to return a nonzero reminder, so then maxima is tried. The division in maxima (line 964) is not checked to see if the remainder is zero (which it is not).

This example is unable to be exactly divided, so it should return the rational function.



---

archive/issue_comments_306194.json:
```json
{
    "body": "oops, meant to add that to 22265.",
    "created_at": "2017-02-02T23:00:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22031#issuecomment-306194",
    "user": "bhutz"
}
```

oops, meant to add that to 22265.



---

archive/issue_comments_306195.json:
```json
{
    "body": "This is not really an issue. Points are hashable, so `copy(Q) is Q` wouldn't even be a problem. Once you start changing coordinates, you're already in undefined territory (it's an \"_\" attribute for a reason ...):\n\n```\nsage: P.<x,y>=ProjectiveSpace(ZZ,1)\nsage: Q=P(1,2)\nsage: hash(Q)\n-6819944855328768534\nsage: Q._coords[1]=0\nsage: hash(Q)\n3713081631936575706\n```\n\nHashable means immutable; certainly immutable as far as the hash value is concerned.",
    "created_at": "2017-02-03T20:42:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22031#issuecomment-306195",
    "user": "nbruin"
}
```

This is not really an issue. Points are hashable, so `copy(Q) is Q` wouldn't even be a problem. Once you start changing coordinates, you're already in undefined territory (it's an "_" attribute for a reason ...):

```
sage: P.<x,y>=ProjectiveSpace(ZZ,1)
sage: Q=P(1,2)
sage: hash(Q)
-6819944855328768534
sage: Q._coords[1]=0
sage: hash(Q)
3713081631936575706
```

Hashable means immutable; certainly immutable as far as the hash value is concerned.



---

archive/issue_comments_306196.json:
```json
{
    "body": "I understand your point in theory, but I think in practice this is not the case.\n\nAs user, if I create a point P in projective space. Then make a copy Q=copy(P). Then scale the coordinates of P by some value P.scale_by(2) or P.normalize_coordinates(). I do not expect the coordinates of Q to also change.",
    "created_at": "2017-02-03T20:47:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22031#issuecomment-306196",
    "user": "bhutz"
}
```

I understand your point in theory, but I think in practice this is not the case.

As user, if I create a point P in projective space. Then make a copy Q=copy(P). Then scale the coordinates of P by some value P.scale_by(2) or P.normalize_coordinates(). I do not expect the coordinates of Q to also change.



---

archive/issue_comments_306197.json:
```json
{
    "body": "Replying to [comment:11 bhutz]:\n> As user, if I create a point P in projective space. Then make a copy Q=copy(P). Then scale the coordinates of P by some value P.scale_by(2) or P.normalize_coordinates(). I do not expect the coordinates of Q to also change.\n\nAs a user I would not even expect the coordinates of P to change, since P advertises having a well-defined hash.\n\nHowever, I see that `scale_by` and `normalize_coordinates` do not change the equality or hash of the point. So those are sort-of OK.\n\nIf you just change `Q._coords` to a tuple, you'd be done (after fixing the resulting failures). A tuple should be more efficient here anyway.",
    "created_at": "2017-02-03T21:23:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22031#issuecomment-306197",
    "user": "nbruin"
}
```

Replying to [comment:11 bhutz]:
> As user, if I create a point P in projective space. Then make a copy Q=copy(P). Then scale the coordinates of P by some value P.scale_by(2) or P.normalize_coordinates(). I do not expect the coordinates of Q to also change.

As a user I would not even expect the coordinates of P to change, since P advertises having a well-defined hash.

However, I see that `scale_by` and `normalize_coordinates` do not change the equality or hash of the point. So those are sort-of OK.

If you just change `Q._coords` to a tuple, you'd be done (after fixing the resulting failures). A tuple should be more efficient here anyway.



---

archive/issue_comments_306198.json:
```json
{
    "body": "Yes, the hash was made to be independent of the choice of representation. Although I do see that does not quite work correctly as written, if the representation is not in standard form over a field, it isn't normalized first. But that is easily fixed.\n\nchanging the ._coords to a tuple does fix the copy 'issue' and scale_by and normalize_coordinates can be made to work with that. I'm fine with making this ticket that take approach instead.\n\nThe paradigm shift of having scale_by and normalize_coordinates return a new point instead of changing the coordinates in place is one I do not prefer. If this is in conflict with how most other parts of Sage works, then an argument could be made to make this conform, but it would a major change in how all scheme points/maps work.",
    "created_at": "2017-02-04T00:18:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22031#issuecomment-306198",
    "user": "bhutz"
}
```

Yes, the hash was made to be independent of the choice of representation. Although I do see that does not quite work correctly as written, if the representation is not in standard form over a field, it isn't normalized first. But that is easily fixed.

changing the ._coords to a tuple does fix the copy 'issue' and scale_by and normalize_coordinates can be made to work with that. I'm fine with making this ticket that take approach instead.

The paradigm shift of having scale_by and normalize_coordinates return a new point instead of changing the coordinates in place is one I do not prefer. If this is in conflict with how most other parts of Sage works, then an argument could be made to make this conform, but it would a major change in how all scheme points/maps work.



---

archive/issue_comments_306199.json:
```json
{
    "body": "Just to be clear. my argument for the current behavior is that those functions are not changing the point, merely the current representation of the coordinates of that point.",
    "created_at": "2017-02-04T00:45:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22031#issuecomment-306199",
    "user": "bhutz"
}
```

Just to be clear. my argument for the current behavior is that those functions are not changing the point, merely the current representation of the coordinates of that point.



---

archive/issue_comments_306200.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-02-06T16:46:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22031#issuecomment-306200",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_306201.json:
```json
{
    "body": "Well, here is what it would look like changing the ._coords for points to a tuple and ._polys for maps to a tuple.\n\nThis works for everything in /schemes/. I'm currently running the tests on all of sage to see if there are any other places that need updated with this change.\n----\nNew commits:",
    "created_at": "2017-02-06T16:50:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22031#issuecomment-306201",
    "user": "bhutz"
}
```

Well, here is what it would look like changing the ._coords for points to a tuple and ._polys for maps to a tuple.

This works for everything in /schemes/. I'm currently running the tests on all of sage to see if there are any other places that need updated with this change.
----
New commits:



---

archive/issue_comments_306202.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-02-06T23:01:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22031#issuecomment-306202",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_306203.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-02-06T23:08:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22031#issuecomment-306203",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_306204.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-02-06T23:10:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22031#issuecomment-306204",
    "user": "bhutz"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_306205.json:
```json
{
    "body": "There was another failure on a long test and I did some general clean-up.\n\nHere is a version where points/maps are switched to tuples and the couple associated corrections needed for that to work.",
    "created_at": "2017-02-06T23:10:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22031#issuecomment-306205",
    "user": "bhutz"
}
```

There was another failure on a long test and I did some general clean-up.

Here is a version where points/maps are switched to tuples and the couple associated corrections needed for that to work.



---

archive/issue_comments_306206.json:
```json
{
    "body": "Is the current version, switching to tuples, preferred to the first commit which just adds an additional layer of copy for the list?",
    "created_at": "2017-02-20T17:57:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22031#issuecomment-306206",
    "user": "bhutz"
}
```

Is the current version, switching to tuples, preferred to the first commit which just adds an additional layer of copy for the list?



---

archive/issue_comments_306207.json:
```json
{
    "body": "Now that we are using tuples:\n\n```\nsage: P.<x,y>=ProjectiveSpace(ZZ,1)\nsage: Q=P(152,113)\nsage: copy(Q) is Q\nFalse\nsage: copy(Q)._coords is Q._coords\nTrue\n```\n \nThis last output is correct.",
    "created_at": "2017-03-08T16:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22031#issuecomment-306207",
    "user": "rlmiller"
}
```

Now that we are using tuples:

```
sage: P.<x,y>=ProjectiveSpace(ZZ,1)
sage: Q=P(152,113)
sage: copy(Q) is Q
False
sage: copy(Q)._coords is Q._coords
True
```
 
This last output is correct.



---

archive/issue_comments_306208.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-03-08T16:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22031#issuecomment-306208",
    "user": "rlmiller"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_306209.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-03-10T23:12:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22031#issuecomment-306209",
    "user": "vbraun"
}
```

Resolution: fixed
