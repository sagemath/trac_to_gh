# Issue 22031: copy for schememropisms_points not deep enough

Issue created by migration from Trac.

Original creator: bhutz

Original creation time: 2017-01-28 12:57:12

CC:  rlmiller

The copy function for scheme points does not actually produce a copy of the coords. So if you change a value of the coordinates it changes both the point and the copy.


```
sage: P.<x,y>=ProjectiveSpace(ZZ,1)
sage: Q=P(152,113)
sage: copy(Q) is Q
False
sage: copy(Q)._coords is Q._coords
True
```


The last output should also be false.


---

Comment by bhutz created at 2017-01-28 13:24:26

Changing status from new to needs_review.


---

Comment by bhutz created at 2017-01-28 13:24:26

New commits:


---

Comment by johanneshuisman created at 2017-01-30 21:53:25

Changing status from needs_review to positive_review.


---

Comment by rlmiller created at 2017-01-30 23:50:18

Looks good to me.


---

Comment by vbraun created at 2017-02-02 22:10:54

Merge conflict...


---

Comment by vbraun created at 2017-02-02 22:10:54

Changing status from positive_review to needs_work.


---

Comment by git created at 2017-02-02 22:39:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bhutz created at 2017-02-02 22:43:15

Merged.

However, I'm getting a test failure in projective_morphism that is unrelated to this change. It seems that this fails for me in 7.6.beta2 also.


```
File "src/sage/schemes/projective/projective_morphism.py", line 853, in sage.schemes.projective.projective_morphism.SchemeMorphism_polynomial_projective_space.dynatomic_polynomial
Failed example:
    f.dynatomic_polynomial(2)
Expected:
    2.00000000000000*x^2 + 0.999999999999999*y^2
Got:
    0.666666666666667*x^2 + 0.333333333333333*y^2
```


Looking at the doctest, both the 'Expected' value and the 'Got' value are actually wrong. There is already a ticket open for fixing some other dynatomic polynomial issues, so I'll add this failure there.


---

Comment by bhutz created at 2017-02-02 22:59:50

What is happening in that example is that the quo_rem fails to return a nonzero reminder, so then maxima is tried. The division in maxima (line 964) is not checked to see if the remainder is zero (which it is not).

This example is unable to be exactly divided, so it should return the rational function.


---

Comment by bhutz created at 2017-02-02 23:00:26

oops, meant to add that to 22265.


---

Comment by nbruin created at 2017-02-03 20:42:23

This is not really an issue. Points are hashable, so `copy(Q) is Q` wouldn't even be a problem. Once you start changing coordinates, you're already in undefined territory (it's an "_" attribute for a reason ...):

```
sage: P.<x,y>=ProjectiveSpace(ZZ,1)
sage: Q=P(1,2)
sage: hash(Q)
-6819944855328768534
sage: Q._coords[1]=0
sage: hash(Q)
3713081631936575706
```

Hashable means immutable; certainly immutable as far as the hash value is concerned.


---

Comment by bhutz created at 2017-02-03 20:47:02

I understand your point in theory, but I think in practice this is not the case.

As user, if I create a point P in projective space. Then make a copy Q=copy(P). Then scale the coordinates of P by some value P.scale_by(2) or P.normalize_coordinates(). I do not expect the coordinates of Q to also change.


---

Comment by nbruin created at 2017-02-03 21:23:57

Replying to [comment:11 bhutz]:
> As user, if I create a point P in projective space. Then make a copy Q=copy(P). Then scale the coordinates of P by some value P.scale_by(2) or P.normalize_coordinates(). I do not expect the coordinates of Q to also change.

As a user I would not even expect the coordinates of P to change, since P advertises having a well-defined hash.

However, I see that `scale_by` and `normalize_coordinates` do not change the equality or hash of the point. So those are sort-of OK.

If you just change `Q._coords` to a tuple, you'd be done (after fixing the resulting failures). A tuple should be more efficient here anyway.


---

Comment by bhutz created at 2017-02-04 00:18:40

Yes, the hash was made to be independent of the choice of representation. Although I do see that does not quite work correctly as written, if the representation is not in standard form over a field, it isn't normalized first. But that is easily fixed.

changing the ._coords to a tuple does fix the copy 'issue' and scale_by and normalize_coordinates can be made to work with that. I'm fine with making this ticket that take approach instead.

The paradigm shift of having scale_by and normalize_coordinates return a new point instead of changing the coordinates in place is one I do not prefer. If this is in conflict with how most other parts of Sage works, then an argument could be made to make this conform, but it would a major change in how all scheme points/maps work.


---

Comment by bhutz created at 2017-02-04 00:45:47

Just to be clear. my argument for the current behavior is that those functions are not changing the point, merely the current representation of the coordinates of that point.


---

Comment by git created at 2017-02-06 16:46:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bhutz created at 2017-02-06 16:50:00

Well, here is what it would look like changing the ._coords for points to a tuple and ._polys for maps to a tuple.

This works for everything in /schemes/. I'm currently running the tests on all of sage to see if there are any other places that need updated with this change.
----
New commits:


---

Comment by git created at 2017-02-06 23:01:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-02-06 23:08:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bhutz created at 2017-02-06 23:10:20

Changing status from needs_work to needs_review.


---

Comment by bhutz created at 2017-02-06 23:10:20

There was another failure on a long test and I did some general clean-up.

Here is a version where points/maps are switched to tuples and the couple associated corrections needed for that to work.


---

Comment by bhutz created at 2017-02-20 17:57:55

Is the current version, switching to tuples, preferred to the first commit which just adds an additional layer of copy for the list?


---

Comment by rlmiller created at 2017-03-08 16:56:15

Now that we are using tuples:

```
sage: P.<x,y>=ProjectiveSpace(ZZ,1)
sage: Q=P(152,113)
sage: copy(Q) is Q
False
sage: copy(Q)._coords is Q._coords
True
}}} 
This last output is correct.


---

Comment by rlmiller created at 2017-03-08 16:56:15

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-03-10 23:12:45

Resolution: fixed
