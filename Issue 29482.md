# Issue 29482: upgrade to flint 2.6.0

Issue created by migration from https://trac.sagemath.org/ticket/29719

Original creator: vdelecroix

Original creation time: 2020-05-20 22:40:57

CC:  @timokau kedlaya jen saraedum isuruf mkoeppe @kliem vdelecroix winfried slelievre

See anouncement

https://groups.google.com/forum/#!topic/sage-devel/SyUykKwQw6I


---

Comment by dimpase created at 2020-05-21 10:49:44

this is from the latest alpha2 (commit a960857c7d8e5ea7c4d4c2958e38ec52778d85d9)

Patches still need to be sorted out.
----
New commits:


---

Comment by git created at 2020-05-21 12:28:50

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2020-05-21 12:31:00

OK, can be tested now. All our patches got upstreamed, so they are gone now.


---

Comment by dimpase created at 2020-05-21 12:31:00

Changing status from new to needs_review.


---

Comment by dimpase created at 2020-05-21 13:00:00

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2020-05-21 13:00:00

Neither arb 2.16 nor 2.17 work with this version of Flint.

One gets

```
gcc -fPIC -ansi -pedantic -Wall -O2 -funroll-loops -g -mpopcnt  -I/home/scratch2/dimpase/sage/sage/local/var/tmp/sage/build/arb-2.17.0/src -I/home/scratch2/dimpase/sage/sage/local/include -I/home/scratch2/dimpase/sage/sage/local/include -I/home/scratch2/dimpase/sage/sage/local/include -c mul_mpn.c -o ../build/fmpr/mul_mpn.lo -MMD -MP -MF "../build/fmpr/mul_mpn.d" -MT "../build/fmpr/mul_mpn.d" -MT "../build/fmpr/mul_mpn.lo"
In file included from ../fmpr.h:26,
                 from get_si.c:12:
../fmpz_extras.h:47:1: error: redefinition of 'fmpz_add_si'
   47 | fmpz_add_si(fmpz_t z, const fmpz_t x, slong y)
      | ^~~~~~~~~~~
In file included from ../fmpr.h:23,
                 from get_si.c:12:
../../../../../../../include/flint/fmpz.h:479:18: note: previous definition of 'fmpz_add_si' was here
  479 | FMPZ_INLINE void fmpz_add_si(fmpz_t f, const fmpz_t g, slong x)
      |                  ^~~~~~~~~~~
In file included from ../fmpr.h:26,
                 from get_si.c:12:
../fmpz_extras.h:56:1: error: redefinition of 'fmpz_sub_si'
   56 | fmpz_sub_si(fmpz_t z, const fmpz_t x, slong y)
      | ^~~~~~~~~~~
In file included from ../fmpr.h:23,
                 from get_si.c:12:
../../../../../../../include/flint/fmpz.h:487:18: note: previous definition of 'fmpz_sub_si' was here
  487 | FMPZ_INLINE void fmpz_sub_si(fmpz_t f, const fmpz_t g, slong x)
      |                  ^~~~~~~~~~~
make[5]: *** [../Makefile.subdirs:60: ../build/fmpr/get_si.lo] Error 1
```



---

Comment by dimpase created at 2020-05-21 13:15:15

One apparently may use arb patch: https://github.com/fredrik-johansson/arb/commit/d3d9983231e0f034e86a1e75761627eb8213b704.patch - trying this with arb 2.17.0 now.


---

Comment by fredrik.johansson created at 2020-05-21 13:42:33

Yes, there will be an immediate new Arb release. The current git master ought to work.


---

Comment by dimpase created at 2020-05-21 19:50:04

Replying to [comment:6 fredrik.johansson]:
> Yes, there will be an immediate new Arb release. The current git master ought to work.

there are doctest errors (I made https://github.com/dimpase/arb/releases/tag/2.17.1, and removed all the arb patches)

```
sage -t --warn-long 59.4 src/sage/rings/complex_arb.pyx
**********************************************************************
File "src/sage/rings/complex_arb.pyx", line 4554, in sage.rings.complex_arb.ComplexBall.elliptic_pi
Failed example:
    CBF(2,3).elliptic_pi(CBF(1,1))
Expected:
    [0.27029997361983 +/- ...e-15] + [0.715676058329095 +/- ...e-16]*I
Got:
    [0.2702999736198 +/- 4.51e-14] + [0.7156760583291 +/- 1.78e-14]*I
**********************************************************************
File "src/sage/rings/complex_arb.pyx", line 4662, in sage.rings.complex_arb.ComplexBall.elliptic_pi_inc
Failed example:
    n.elliptic_pi_inc(CBF.pi()/2, m)
Expected:
    [0.8934793755173 +/- ...e-14] + [0.95707868710750 +/- ...e-15]*I
Got:
    nan + nan*I
**********************************************************************
File "src/sage/rings/complex_arb.pyx", line 4664, in sage.rings.complex_arb.ComplexBall.elliptic_pi_inc
Failed example:
    n.elliptic_pi(m)
Expected:
    [0.89347937551733 +/- ...e-15] + [0.95707868710750 +/- ...e-15]*I
Got:
    [0.8934793755173 +/- 4.27e-14] + [0.9570786871075 +/- 9.91e-15]*I
**********************************************************************
File "src/sage/rings/complex_arb.pyx", line 4669, in sage.rings.complex_arb.ComplexBall.elliptic_pi_inc
Failed example:
    n.elliptic_pi_inc(CBF.pi()/2, m)
Expected:
    [0.2969588746419 +/- ...e-14] + [1.3188795332738 +/- ...e-14]*I
Got:
    nan + nan*I
**********************************************************************
File "src/sage/rings/complex_arb.pyx", line 4671, in sage.rings.complex_arb.ComplexBall.elliptic_pi_inc
Failed example:
    n.elliptic_pi(m)
Expected:
    [0.29695887464189 +/- ...e-15] + [1.31887953327376 +/- ...e-15]*I
Got:
    [0.2969588746419 +/- 3.79e-14] + [1.3188795332738 +/- 7.19e-14]*I
**********************************************************************
File "src/sage/rings/complex_arb.pyx", line 4747, in sage.rings.complex_arb.ComplexBall.elliptic_rj
Failed example:
    CBF(0,1).elliptic_rj(CBF(-1/2,1), CBF(-1,-1), CBF(2))
Expected:
    [1.004386756285733 +/- ...e-16] + [-0.2451626834391645 +/- ...e-17]*I
Got:
    [1.00438675628573 +/- 6.85e-15] + [-0.24516268343916 +/- 8.11e-15]*I
**********************************************************************
3 items had failures:
   1 of   2 in sage.rings.complex_arb.ComplexBall.elliptic_pi
   4 of  10 in sage.rings.complex_arb.ComplexBall.elliptic_pi_inc
   1 of   2 in sage.rings.complex_arb.ComplexBall.elliptic_rj
    [639 tests, 6 failures, 8.14 s]
```

and

```
sage -t --warn-long 59.4 src/sage/rings/real_arb.pyx
**********************************************************************
File "src/sage/rings/real_arb.pyx", line 295, in sage.rings.real_arb.arb_to_mpfi
Failed example:
    RIF(RBF(2)**(2**100)) # indirect doctest
Expected:
    Traceback (most recent call last):
    ...
    ArithmeticError: Error converting arb to mpfi. Overflow?
Got:
    [5.8756537891115869e1388255822130839282 .. +infinity]
**********************************************************************
File "src/sage/rings/real_arb.pyx", line 1660, in sage.rings.real_arb.RealBall.mid
Failed example:
    b.mid()
Expected:
    Traceback (most recent call last):
    ...
    RuntimeError: unable to convert to MPFR (exponent out of range?)
Got:
    +infinity
**********************************************************************
2 items had failures:
   1 of   7 in sage.rings.real_arb.RealBall.mid
   1 of   2 in sage.rings.real_arb.arb_to_mpfi
    [542 tests, 2 failures, 0.64 s]
```



---

Comment by dimpase created at 2020-05-22 09:55:30

OK, I ended up using arb patch: ​https://github.com/fredrik-johansson/arb/commit/d3d9983231e0f034e86a1e75761627eb8213b704.patch
with arb 2.16.0 (the arb version in Sage now), and get one flint-related regression (a segfault)

```
sage: R.<x> = QQ['x']
sage: A,f = monsky_washnitzer.matrix_of_frobenius_hyperelliptic(x^5 - 2*x + 3, 5, 3)
-------------------------------------------------------------------------------------
/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0x84a4)[0x7f98890224a4]
/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0x8679)[0x7f9889022679]
/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0xae41)[0x7f9889024e41]
/lib64/libc.so.6(+0x37ec0)[0x7f988a679ec0]
/lib64/libc.so.6(gsignal+0x145)[0x7f988a679e35]
/lib64/libc.so.6(abort+0x127)[0x7f988a664895]
/home/scratch2/dimpase/sage/sage/local/lib/libflint.so.14(+0x85dcd)[0x7f9880a64dcd]
/home/scratch2/dimpase/sage/sage/local/lib/libflint.so.14(flint_throw+0xe0)[0x7f9880a64eb0]
/home/scratch2/dimpase/sage/sage/local/lib/libflint.so.14(_nmod_poly_rem_q1+0xa1)[0x7f9880bd8bd1]
/home/scratch2/dimpase/sage/sage/local/lib/libflint.so.14(_nmod_poly_rem+0x195)[0x7f9880bc39f5]
/home/scratch2/dimpase/sage/sage/local/lib/libflint.so.14(_nmod_poly_gcd_euclidean+0x60)[0x7f9880babd50]
/home/scratch2/dimpase/sage/sage/local/lib/libflint.so.14(nmod_poly_gcd+0x95)[0x7f9880bb28b5]
/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/rings/polynomial/polynomial_zmod_flint.cpython-37m-x86_64-linux-gnu.so(+0x1201c)[0x7f983d7b401c]
/lib64/libpython3.7m.so.1.0(_PyMethodDef_RawFastCallDict+0x33a)[0x7f988a402bea]
/lib64/libpython3.7m.so.1.0(+0x1ccd3f)[0x7f988a4c1d3f]
/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/structure/element.cpython-37m-x86_64-linux-gnu.so(+0x134fc)[0x7f98897424fc]
/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/structure/element.cpython-37m-x86_64-linux-gnu.so(+0x338a4)[0x7f98897628a4]
/lib64/libpython3.7m.so.1.0(_PyObject_FastCallKeywords+0x4bc)[0x7f988a433eec]
/lib64/libpython3.7m.so.1.0(+0x1404e9)[0x7f988a4354e9]
/lib64/libpython3.7m.so.1.0(_PyEval_EvalFrameDefault+0x55da)[0x7f988a46fdea]
/lib64/libpython3.7m.so.1.0(_PyEval_EvalCodeWithName+0x2f0)[0x7f988a4227e0]
/lib64/libpython3.7m.so.1.0(_PyFunction_FastCallKeywords+0x2a2)[0x7f988a423822]
/lib64/libpython3.7m.so.1.0(+0x14035f)[0x7f988a43535f]
...
```



---

Comment by git created at 2020-05-22 09:58:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-05-22 10:01:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-05-22 10:20:29

experiments tell that precision  needs to be at least 25 for this example to run, i.e. this works:

```
sage: monsky_washnitzer.matrix_of_frobenius_hyperelliptic(x^5 - 2*x + 3, 5, 25)
```



---

Comment by dimpase created at 2020-05-22 10:55:47

But this works:

```
sage: R.<x> = QQ['x']
sage: C=HyperellipticCurve(x^5 - 2*x + 3)
sage: A,f=monsky_washnitzer.matrix_of_frobenius_hyperelliptic(C,5,3)
sage: A
[            4*5 + O(5^3)       5 + 2*5^2 + O(5^3) 2 + 3*5 + 2*5^2 + O(5^3)     2 + 5 + 5^2 + O(5^3)]
[      3*5 + 5^2 + O(5^3)             3*5 + O(5^3)             4*5 + O(5^3)         2 + 5^2 + O(5^3)]
[    4*5 + 4*5^2 + O(5^3)     3*5 + 2*5^2 + O(5^3)       5 + 3*5^2 + O(5^3)     2*5 + 2*5^2 + O(5^3)]
[            5^2 + O(5^3)       5 + 4*5^2 + O(5^3)     4*5 + 3*5^2 + O(5^3)             2*5 + O(5^3)]
```


So, apparently, some initialisation is missing, if C is created on the fly.


---

Comment by dimpase created at 2020-05-22 12:31:46

This is reproducible on the ticket branch, on Fedora 30 and on Debian 10.
This works:

```
sage: R.<x> = QQ['x']
sage: C=HyperellipticCurve(x^5 - 2*x + 3)
sage: A,f=monsky_washnitzer.matrix_of_frobenius_hyperelliptic(C,5,3)
sage: A
```

but

```
sage: R.<x> = QQ['x']
sage: A,f = monsky_washnitzer.matrix_of_frobenius_hyperelliptic(x^5 - 2*x + 3, 5, 3)
```

segfaults.


---

Comment by fredrik.johansson created at 2020-05-22 12:42:41

Dima, thanks for reporting the Arb doctest failures.

The slight regressions in accuracy for elliptic_pi, elliptic_pi_inc and elliptic_rj are due to using a different algorithm to compute the R_J function for certain complex parameters. The new algorithm is a bit slower and less accurate, but unlike the old algorithm always gives the right branch. These doctest results just need to be updated.

Unfortunately, the new algorithm doesn't work when phi is an inexact multiple of pi/2, leading to the NaN values. There is a workaround: acb_elliptic_pi_inc takes a pi flag to multiply the argument by pi exactly, so if you add a pi flag to the Sage wrapper and pass in phi=0.5 with pi=True in the doctest, it should give the expected result.

It's theoretically possible to fix these regressions, and I will open an Arb issue for it, but I'm not keen to spend time on it any time soon.

The other two examples look correct: converting an Arb number to an MPFR now rounds according to MPFR semantics (including rounding to infinity) instead of abort()ing when the exponents are out of range for MPFR.


---

Comment by dimpase created at 2020-05-22 15:50:57

This works too:

```
sage: sage: R.<x> = QQ['x']
....: sage: C=HyperellipticCurve(x^5 - 2*x + 7)
....: sage: A,f = monsky_washnitzer.matrix_of_frobenius_hyperelliptic(x^5-2*x+3, 5, 3)
```

That is, apparently, some kind of Flint initialisation needs to happen before
the latter function can be called.


---

Comment by dimpase created at 2020-05-22 21:12:50

here it is one step closer to the bug:

```
sage: from sage.schemes.hyperelliptic_curves.monsky_washnitzer import SpecialHyperellipticQuotientRing
sage: R.<x> = QQ['x']
sage: Q=x^5 - 2*x + 3
sage: SpecialHyperellipticQuotientRing(Q, Integers(5**4), True)
Flint exception (Impossible inverse):
    Cannot invert modulo 5*0
------------------------------------------------------------------------
/home/dimpase/sage-src/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0x7ccb)[0x795d3c2ccccb]
/home/dimpase/sage-src/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0x7e98)[0x795d3c2cce98]
/home/dimpase/sage-src/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0xa70d)[0x795d3c2cf70d]
/lib/x86_64-linux-gnu/libpthread.so.0(+0x12730)[0x795d3f372730]
/lib/x86_64-linux-gnu/libc.so.6(gsignal+0x10b)[0x795d3edec7bb]
/lib/x86_64-linux-gnu/libc.so.6(abort+0x121)[0x795d3edd7535]
/home/dimpase/sage-src/local/lib/libflint.so.14(+0x84cfd)[0x795d2f868cfd]
/home/dimpase/sage-src/local/lib/libflint.so.14(flint_throw+0xe0)[0x795d2f868de0]
/home/dimpase/sage-src/local/lib/libflint.so.14(_nmod_poly_rem_q1+0x8f)[0x795d2f9e26ef]
/home/dimpase/sage-src/local/lib/libflint.so.14(_nmod_poly_rem+0x145)[0x795d2f9d0d85]
/home/dimpase/sage-src/local/lib/libflint.so.14(_nmod_poly_gcd_euclidean+0x60)[0x795d2f9b3da0]
/home/dimpase/sage-src/local/lib/libflint.so.14(nmod_poly_gcd+0x93)[0x795d2f9db6a3]
/home/dimpase/sage-src/local/lib/python3.7/site-packages/sage/rings/polynomial/polynomial_zmod_flint.cpython-37m-x86_64-linux-gnu.so(+0x117e4)[0x795cbaa107e4]
/home/dimpase/sage-src/local/bin/python3(_PyMethodDef_RawFastCallDict+0x2d8)[0x5d7518]
/home/dimpase/sage-src/local/bin/python3[0x4d77be]
...
```


with Flint 2.5.2, it prints

```
SpecialHyperellipticQuotientRing K[x,y,y^-1] / (y^2 = x^5 + 623*x + 3) over Ring of integers modulo 625
```

as it should.


---

Comment by dimpase created at 2020-05-22 21:46:05

and one more step further - basically, creating HyperellipticCurve over Z mod 625
does not work:

```
sage: R.<x> = QQ['x']
sage: Q=x^5 - 2*x + 3
sage: HyperellipticCurve(Q.change_ring(Integers(5**4)))
Flint exception (Impossible inverse):
    Cannot invert modulo 5*0
------------------------------------------------------------------------
/home/dimpase/sage-src/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0x7ccb)[0x7d0ea9c75ccb]
/home/dimpase/sage-src/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0x7e98)[0x7d0ea9c75e98]
/home/dimpase/sage-src/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0xa70d)[0x7d0ea9c7870d]
/lib/x86_64-linux-gnu/libpthread.so.0(+0x12730)[0x7d0eacd1b730]
/lib/x86_64-linux-gnu/libc.so.6(gsignal+0x10b)[0x7d0eac7957bb]
/lib/x86_64-linux-gnu/libc.so.6(abort+0x121)[0x7d0eac780535]
/home/dimpase/sage-src/local/lib/libflint.so.14(+0x84cfd)[0x7d0ea1684cfd]
/home/dimpase/sage-src/local/lib/libflint.so.14(flint_throw+0xe0)[0x7d0ea1684de0]
/home/dimpase/sage-src/local/lib/libflint.so.14(_nmod_poly_rem_q1+0x8f)[0x7d0ea17fe6ef]
/home/dimpase/sage-src/local/lib/libflint.so.14(_nmod_poly_rem+0x145)[0x7d0ea17ecd85]
/home/dimpase/sage-src/local/lib/libflint.so.14(_nmod_poly_gcd_euclidean+0x60)[0x7d0ea17cfda0]
/home/dimpase/sage-src/local/lib/libflint.so.14(nmod_poly_gcd+0x93)[0x7d0ea17f76a3]
/home/dimpase/sage-src/local/lib/python3.7/site-packages/sage/rings/polynomial/polynomial_zmod_flint.cpython-37m-x86_64-linux-gnu.so(+0x117e4)[0x7d0e28f387e4]
/home/dimpase/sage-src/local/bin/python3(_PyMethodDef_RawFastCallDict+0x2d8)[0x5d7518]
```



---

Comment by dimpase created at 2020-05-22 22:30:42

OK, so this seems to be a basic `Polynomial_zmod_flint` problem:

```
sage: R.<x> = QQ['x']
sage: Q=x^5 - 2*x + 3
sage: Qm=Q.change_ring(Integers(5**4))
sage: F=4*Qm
sage: F.gcd(F.derivative())
Flint exception (Impossible inverse):
    Cannot invert modulo 5*0
-------------------------
boom...
```


(this happily returns `1` with Flint 2.5.2)

So this is not really a specific p-adic problem at all.


---

Comment by git created at 2020-05-23 09:09:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-05-23 09:52:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-05-23 09:58:19

related discussion with Flint people (Bill): https://github.com/wbhart/flint2/issues/743


---

Comment by dimpase created at 2020-05-23 10:05:13

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2020-05-23 10:05:13

Probably one would need to revise the handling of GCDs of polynomials in general, but this is for another ticket, I guess.


---

Comment by git created at 2020-05-29 09:34:45

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-05-29 10:19:15

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-06-05 17:41:36

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2020-06-05 17:42:17

New commits:
----
New commits:


---

Comment by dimpase created at 2020-06-05 17:42:17

Changing priority from major to critical.


---

Comment by dimpase created at 2020-06-05 17:43:03

OK, now the real reviewing/testing may commence!


---

Comment by @kliem created at 2020-06-05 19:50:55

I'm running github workflows here:

https://github.com/kliem/sage-test-27122/actions/runs/126335040

https://github.com/kliem/sage-test-27122/actions/runs/126335044

https://github.com/kliem/sage-test-27122/actions/runs/126335047

https://github.com/kliem/sage-test-27122/actions/runs/126335050

https://github.com/kliem/sage-test-27122/actions/runs/126335052

(and I should really rename my github repository)

and I'm testing it on a debian buster myself.


---

Attachment


---

Comment by @kliem created at 2020-06-05 20:15:50

e_antic fails to build on this flint.


---

Comment by @kliem created at 2020-06-05 20:20:02

I just was about to do this :-)


---

Comment by dimpase created at 2020-06-05 21:53:45


```
libtool: compile:  gcc -DHAVE_CONFIG_H -I. -fopenmp -march=native -O2 -c poly_extra/descartes_bound.c  -fPIC -DPIC -o poly_extra/.libs/descartes_bound.o
In file included from ./e-antic/poly_extra.h:15,
                 from poly_extra/bisection_step_arb.c:12:
./e-antic/e-antic.h:24:2: error: #error FLINT 2.5.2 or 2.5.3 required
 #error FLINT 2.5.2 or 2.5.3 required
  ^~~~~
```

Why is this done in a header, not in `./configure` ?

using `--enable-flint-devel` in configure doesn't help, by the way.


---

Comment by dimpase created at 2020-06-06 12:57:28

see https://github.com/videlec/e-antic/issues/93


---

Comment by mkoeppe created at 2020-06-06 17:43:48

Let's take care of e_antic on a follow-up ticket.


---

Comment by @kliem created at 2020-06-06 18:27:05

I don't like this. It breaks `normaliz`. Yes, it is only an `optional` package, but that is basically downgrading it to `experimental`. Isn't it?

Or is the fix already pretty much done? The order of things makes sense (first upgrade flint and then fix optional packages it breaks) but I would like that the fix is available (and ideally is even merged in the same beta).


---

Comment by mkoeppe created at 2020-06-06 18:31:43

Of course we must fix it before the next release, but not everything can be done within one beta. We need to do LOTS of package upgrades!


---

Comment by mkoeppe created at 2020-06-06 18:34:46

In particular, a big Normaliz update is coming. Not sure if Winfried is already testing with the new FLINT release?


---

Comment by Winfried created at 2020-06-07 08:58:03

I had not noticed that Flint 2.6.0 is available. Therefore it is not installed with Normaliz 3.8.5 that was just released (not a big release). 

As soon as possible, I will test Flint 2.6.0. I need the backport to the 0 series of e-antic.


---

Comment by @kliem created at 2020-06-07 12:07:07

There is some mac problem:

https://github.com/kliem/sage-test-27122/runs/743556771 local-macos (homebrew-macos-python3_xcode, standard) 


```
 [dochtml]     File "/Applications/Xcode_11.4.1.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.7/lib/python3.7/runpy.py", line 109, in _get_module_details
  [dochtml]       __import__(pkg_name)
  [dochtml]     File "/Users/runner/runners/2.263.0/work/sage-test-27122/sage-test-27122/.tox/local-homebrew-macos-python3_xcode-standard/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 60, in <module>
  [dochtml]       import sage.all
  [dochtml]     File "/Users/runner/runners/2.263.0/work/sage-test-27122/sage-test-27122/.tox/local-homebrew-macos-python3_xcode-standard/local/lib/python3.7/site-packages/sage/all.py", line 119, in <module>
  [dochtml]       from sage.misc.all       import *         # takes a while
  [dochtml]     File "/Users/runner/runners/2.263.0/work/sage-test-27122/sage-test-27122/.tox/local-homebrew-macos-python3_xcode-standard/local/lib/python3.7/site-packages/sage/misc/all.py", line 84, in <module>
  [dochtml]       from .functional import (additive_order,
  [dochtml]     File "/Users/runner/runners/2.263.0/work/sage-test-27122/sage-test-27122/.tox/local-homebrew-macos-python3_xcode-standard/local/lib/python3.7/site-packages/sage/misc/functional.py", line 26, in <module>
  [dochtml]       from sage.rings.complex_double import CDF
  [dochtml]     File "sage/rings/integer.pxd", line 7, in init sage.rings.complex_double (build/cythonized/sage/rings/complex_double.c:23890)
  [dochtml]   ImportError: dlopen(/Users/runner/runners/2.263.0/work/sage-test-27122/sage-test-27122/.tox/local-homebrew-macos-python3_xcode-standard/local/lib/python3.7/site-packages/sage/rings/integer.cpython-37m-darwin.so, 2): Library not loaded: /Users/runner/runners/2.263.0/work/sage-test-27122/sage-test-27122/.tox/local-homebrew-macos-python3_xcode-standard/local/var/tmp/sage/build/flint-2.6.0/inst/Users/runner/runners/2.263.0/work/sage-test-27122/sage-test-27122/.tox/local-homebrew-macos-python3_xcode-standard/local/lib/libflint-14.dylib
  [dochtml]     Referenced from: /Users/runner/runners/2.263.0/work/sage-test-27122/sage-test-27122/.tox/local-homebrew-macos-python3_xcode-standard/local/lib/python3.7/site-packages/sage/rings/integer.cpython-37m-darwin.so
  [dochtml]     Reason: image not found
  [dochtml] Full log file: logs/dochtml.log
make[1]: *** [doc-html] Error 1
```


homebrew https://github.com/kliem/sage-test-27122/runs/743556743


```
[dochtml]     File "/Users/runner/runners/2.263.0/work/sage-test-27122/sage-test-27122/.tox/local-homebrew-macos-standard/homebrew/Cellar/python/3.7.7/Frameworks/Python.framework/Versions/3.7/lib/python3.7/runpy.py", line 109, in _get_module_details
  [dochtml]       __import__(pkg_name)
  [dochtml]     File "/Users/runner/runners/2.263.0/work/sage-test-27122/sage-test-27122/.tox/local-homebrew-macos-standard/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 60, in <module>
  [dochtml]       import sage.all
  [dochtml]     File "/Users/runner/runners/2.263.0/work/sage-test-27122/sage-test-27122/.tox/local-homebrew-macos-standard/local/lib/python3.7/site-packages/sage/all.py", line 119, in <module>
  [dochtml]       from sage.misc.all       import *         # takes a while
  [dochtml]     File "/Users/runner/runners/2.263.0/work/sage-test-27122/sage-test-27122/.tox/local-homebrew-macos-standard/local/lib/python3.7/site-packages/sage/misc/all.py", line 84, in <module>
  [dochtml]       from .functional import (additive_order,
  [dochtml]     File "/Users/runner/runners/2.263.0/work/sage-test-27122/sage-test-27122/.tox/local-homebrew-macos-standard/local/lib/python3.7/site-packages/sage/misc/functional.py", line 26, in <module>
  [dochtml]       from sage.rings.complex_double import CDF
  [dochtml]     File "sage/rings/integer.pxd", line 7, in init sage.rings.complex_double (build/cythonized/sage/rings/complex_double.c:23890)
  [dochtml]   ImportError: dlopen(/Users/runner/runners/2.263.0/work/sage-test-27122/sage-test-27122/.tox/local-homebrew-macos-standard/local/lib/python3.7/site-packages/sage/rings/integer.cpython-37m-darwin.so, 2): Library not loaded: /Users/runner/runners/2.263.0/work/sage-test-27122/sage-test-27122/.tox/local-homebrew-macos-standard/local/var/tmp/sage/build/flint-2.6.0/inst/Users/runner/runners/2.263.0/work/sage-test-27122/sage-test-27122/.tox/local-homebrew-macos-standard/local/lib/libflint-14.dylib
  [dochtml]     Referenced from: /Users/runner/runners/2.263.0/work/sage-test-27122/sage-test-27122/.tox/local-homebrew-macos-standard/local/lib/python3.7/site-packages/sage/rings/integer.cpython-37m-darwin.so
  [dochtml]     Reason: image not found
```


https://github.com/kliem/sage-test-27122/runs/743556808

local-macos (homebrew-macos-python3_pythonorg, standard) 


```
 [dochtml]   Traceback (most recent call last):
  [dochtml]     File "/Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7/runpy.py", line 183, in _run_module_as_main
  [dochtml]       mod_name, mod_spec, code = _get_module_details(mod_name, _Error)
  [dochtml]     File "/Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7/runpy.py", line 142, in _get_module_details
  [dochtml]       return _get_module_details(pkg_main_name, error)
  [dochtml]     File "/Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7/runpy.py", line 109, in _get_module_details
  [dochtml]       __import__(pkg_name)
  [dochtml]     File "/Users/runner/runners/2.263.0/work/sage-test-27122/sage-test-27122/.tox/local-homebrew-macos-python3_pythonorg-standard/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 60, in <module>
  [dochtml]       import sage.all
  [dochtml]     File "/Users/runner/runners/2.263.0/work/sage-test-27122/sage-test-27122/.tox/local-homebrew-macos-python3_pythonorg-standard/local/lib/python3.7/site-packages/sage/all.py", line 119, in <module>
  [dochtml]       from sage.misc.all       import *         # takes a while
  [dochtml]     File "/Users/runner/runners/2.263.0/work/sage-test-27122/sage-test-27122/.tox/local-homebrew-macos-python3_pythonorg-standard/local/lib/python3.7/site-packages/sage/misc/all.py", line 84, in <module>
  [dochtml]       from .functional import (additive_order,
  [dochtml]     File "/Users/runner/runners/2.263.0/work/sage-test-27122/sage-test-27122/.tox/local-homebrew-macos-python3_pythonorg-standard/local/lib/python3.7/site-packages/sage/misc/functional.py", line 26, in <module>
  [dochtml]       from sage.rings.complex_double import CDF
  [dochtml]     File "sage/rings/integer.pxd", line 7, in init sage.rings.complex_double (build/cythonized/sage/rings/complex_double.c:23890)
  [dochtml]   ImportError: dlopen(/Users/runner/runners/2.263.0/work/sage-test-27122/sage-test-27122/.tox/local-homebrew-macos-python3_pythonorg-standard/local/lib/python3.7/site-packages/sage/rings/integer.cpython-37m-darwin.so, 2): Library not loaded: /Users/runner/runners/2.263.0/work/sage-test-27122/sage-test-27122/.tox/local-homebrew-macos-python3_pythonorg-standard/local/var/tmp/sage/build/flint-2.6.0/inst/Users/runner/runners/2.263.0/work/sage-test-27122/sage-test-27122/.tox/local-homebrew-macos-python3_pythonorg-standard/local/lib/libflint-14.dylib
  [dochtml]     Referenced from: /Users/runner/runners/2.263.0/work/sage-test-27122/sage-test-27122/.tox/local-homebrew-macos-python3_pythonorg-standard/local/lib/python3.7/site-packages/sage/rings/integer.cpython-37m-darwin.so
  [dochtml]     Reason: image not found
```



---

Comment by mkoeppe created at 2020-06-07 18:05:10

Sounds like the `install_name` business has been messed up again


---

Comment by mkoeppe created at 2020-06-07 18:07:21

Indeed, broken again with DESTDIR, in https://github.com/wbhart/flint2/blob/v2.6.0/Makefile.in#L216:

```
	$(AT)if [ "$(OS)" = "Darwin" ] && [ "$(FLINT_SHARED)" -eq "1" ]; then \
		install_name_tool -id "$(DESTDIR)$(PREFIX)/$(LIBDIR)/$(FLINT_LIB)" "$(DESTDIR)$(PREFIX)/$(LIBDIR)/$(FLINT_LIBNAME)"; \
	fi
```



---

Comment by mkoeppe created at 2020-06-07 18:19:59

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2020-06-07 19:03:11

please open an issue with upstream


---

Comment by mkoeppe created at 2020-06-07 19:29:06

Here's a branch that should fix it. Please try:
https://github.com/mkoeppe/flint2/tree/v2.6.0-sage


---

Comment by git created at 2020-06-07 19:47:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-07 19:50:49

I'm running some tests at https://github.com/mkoeppe/sage/actions/runs/128112212
(updated<sup>2</sup>)


---

Comment by mkoeppe created at 2020-06-07 21:08:15

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2020-06-08 09:59:42

e-antic should be fixed by #29826


---

Comment by @kliem created at 2020-06-08 10:29:58

Appears to work for me. Also the normaliz doesn't make any problems (at least all doctests in geometry pass and it did install cleanly with flint 2.6.0).


---

Comment by dimpase created at 2020-06-08 11:11:25

Replying to [comment:50 vdelecroix]:
> e-antic should be fixed by #29826

should we add here the patch you produced for flint?
https://github.com/wbhart/flint2/pull/766
as mentioned on
https://github.com/videlec/e-antic/issues/93 ?


---

Comment by vdelecroix created at 2020-06-08 11:20:29

Replying to [comment:52 dimpase]:
> Replying to [comment:50 vdelecroix]:
> > e-antic should be fixed by #29826
> 
> should we add here the patch you produced for flint?
> https://github.com/wbhart/flint2/pull/766
> as mentioned on
> https://github.com/videlec/e-antic/issues/93 ?

The patch is not required for e-antic. Without the patch the `fmpq_poly_add_fmpq` from flint is broken. But this function does not seem to be used anywhere in sage.


---

Comment by Winfried created at 2020-06-08 11:31:43

I have tried to build Normaliz natively with Flint 2.6.0. 

Then compiling e-antic fails with 



```
configure: WARNING: arb.h: present but cannot be compiled
configure: WARNING: arb.h:     check for missing prerequisite headers?
configure: WARNING: arb.h: see the Autoconf documentation
configure: WARNING: arb.h:     section "Present But Cannot Be Compiled"
configure: WARNING: arb.h: proceeding with the compiler's result
configure: WARNING:     ## --------------------------------------------- ##
configure: WARNING:     ## Report this to vincent.delecroix@math.cnrs.fr ##
configure: WARNING:     ## --------------------------------------------- ##
```



O.K. So we try to rebuild arb 2.17. This fails with



```
In file included from /home/winfried/Dropbox/git_normaliz/nmz_opt_lib/ARB_source/arb-2.17.0/fmpr.h:26:0,
                 from add_naive.c:12:
/home/winfried/Dropbox/git_normaliz/nmz_opt_lib/ARB_source/arb-2.17.0/fmpz_extras.h:47:1: error: redefinition of ‘fmpz_add_si’
 fmpz_add_si(fmpz_t z, const fmpz_t x, slong y)
```



---

Comment by dimpase created at 2020-06-08 12:03:21

Unpatched arb 2.16 and 2.17 do not work with flint 2.6.0. You need a patch - e.g. for arb 2.16 it is included in the branch of this ticket (IIRC the same patch will work for 2.17 too).


---

Comment by mkoeppe created at 2020-06-08 14:55:36

Replying to [comment:46 mkoeppe]:
> Here's a branch that should fix it. Please try:
> https://github.com/mkoeppe/flint2/tree/v2.6.0-sage

This is now https://github.com/wbhart/flint2/pull/768


---

Comment by mkoeppe created at 2020-06-09 03:14:19

Replying to [comment:56 mkoeppe]:
> Replying to [comment:46 mkoeppe]:
> > Here's a branch that should fix it. Please try:
> > https://github.com/mkoeppe/flint2/tree/v2.6.0-sage
> 
> This is now https://github.com/wbhart/flint2/pull/768
It has been merged upstream.


---

Comment by Winfried created at 2020-06-09 07:24:50

I will update Normaliz to Flint 2.6.0 as soon as arb and e-antic are in complete harmony with it. I hope for some increase in performance, but that is not so urgent.


---

Comment by git created at 2020-06-10 20:10:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-10 20:14:04

Another round of tests (this time just this ticket) at https://github.com/mkoeppe/sage/actions/runs/131411841


---

Comment by mkoeppe created at 2020-06-14 01:37:26

Looking good now. I'd be ready to set it to positive review, but we need another reviewer for the changes that I added.


---

Comment by Winfried created at 2020-06-14 15:28:13

I have updated Normaliz on GitHub/master to Flint 2.6.0/arb 2.18.0/e-antic 0.1.7. This required no change in the Normaliz code, as expected. The only visible change in the tests is that the floating point approximations to number field elements have one more decimal digit.

The version number is now 3.8.6. Note that the source file structure has been changed considerably: every cpp file is now comiled in a translation unit of its own. Moreover, some small files have been merged and some cpp files have been inserted into h files.

If it should be helpful,  I can make a new Normaliz release the next days.


---

Comment by Winfried created at 2020-06-14 16:12:29

It seems that PyNormaliz has a problem with the new version. Therefore please wait until further notice.


---

Comment by mkoeppe created at 2020-06-14 21:44:39

Arb update is #28623


---

Comment by mkoeppe created at 2020-06-14 22:42:03

Changing status from needs_review to needs_work.


---

Comment by Winfried created at 2020-06-15 13:47:06

The problem was in Normaliz itself. Should be fixed now. The PyNormaliz tests go through. PyNormaliz 2.11 has not been changed.


---

Comment by git created at 2020-06-16 07:40:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-06-16 07:41:10

Changing status from needs_work to needs_review.


---

Comment by Winfried created at 2020-06-16 07:44:10

I did some computations yesterday. My impression: no performance gains or losses compared to the e-antic version based on Flint 2.5.2.


---

Comment by mkoeppe created at 2020-06-16 11:50:08

Replying to [comment:71 git]:
> ||[e1d3d2a](https://git.sagemath.org/sage.git/commit/?id=e1d3d2a1b6ecc7de128f7c439919e042ca4503aa)||`Merge branch 'u/mkoeppe/upgrade_arb_to_2_18_0' of trac.sagemath.org:sage into flint260arb218`||

If you are running the CI on this already, please post the link


---

Comment by Winfried created at 2020-06-16 12:24:46

The pill request has been merged, as you have see. Now action yet. Can I force it to happen?


---

Comment by dimpase created at 2020-06-16 12:39:41

Replying to [comment:74 mkoeppe]:
> Replying to [comment:71 git]:
> > ||[e1d3d2a](https://git.sagemath.org/sage.git/commit/?id=e1d3d2a1b6ecc7de128f7c439919e042ca4503aa)||`Merge branch 'u/mkoeppe/upgrade_arb_to_2_18_0' of trac.sagemath.org:sage into flint260arb218`||
> 
> If you are running the CI on this already, please post the link

no,I haven't started these yet, I was  waiting whether there are any more things to deal with here.


---

Comment by dimpase created at 2020-06-16 12:40:44

Replying to [comment:75 Winfried]:
> The pill request has been merged, as you have see. Now action yet. Can I force it to happen?

I am not sure I undestand what PR you mean. Could you post a link?


---

Comment by Winfried created at 2020-06-16 13:12:29

Sorry, I meant the Normaliz pull request

https://github.com/Normaliz/Normaliz/pull/336


---

Comment by dimpase created at 2020-06-16 17:08:50

Replying to [comment:78 Winfried]:
> Sorry, I meant the Normaliz pull request
> 
> https://github.com/Normaliz/Normaliz/pull/336

this does not seem to be related to updating flint/arb/e_antic.
Did you need to do any changes to accommodate these updates?


---

Comment by git created at 2020-06-18 10:13:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-06-18 21:00:22

tests running on https://github.com/dimpase/sage/pull/12


---

Comment by Winfried created at 2020-06-19 12:40:12

Replying to [comment:79 dimpase]:
> Replying to [comment:78 Winfried]:
> > Sorry, I meant the Normaliz pull request
> > 
> > https://github.com/Normaliz/Normaliz/pull/336
> 
> this does not seem to be related to updating flint/arb/e_antic.
> Did you need to do any changes to accommodate these updates?

Sorry. The comment was misplaced. Too may threads to follow.


---

Comment by dimpase created at 2020-06-20 19:23:50

tests are being spoiled by the e_antic distro on LABRI server being inaccessible :-(


---

Comment by fbissey created at 2020-06-22 01:38:51

Volker just tried to pull #28623 which of course has doctest failures on its own. If everything is happening in this ticket, should we close #28623 as a duplicate?


---

Comment by dimpase created at 2020-06-23 09:20:03

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-06-23 09:20:03

I think this looks good.


---

Comment by arojas created at 2020-06-26 21:34:32

I am seeing the same failures that gh-timokau reported in #28623#comment:9

With arb 2.17 (patched for flint 2.6 support) those tests pass.


---

Comment by mkoeppe created at 2020-06-26 21:37:01

Changing status from positive_review to needs_work.


---

Comment by mkoeppe created at 2020-06-26 21:50:45

Indeed, they can also be seen in the `archlinux-standard` run in https://github.com/dimpase/sage/pull/12/checks?check_run_id=785953750


---

Comment by mkoeppe created at 2020-06-26 21:56:23

Also in `fedora-31-standard` (https://github.com/dimpase/sage/pull/12/checks?check_run_id=785953613)


---

Comment by git created at 2020-06-26 22:01:17

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-06-26 22:01:48

OK, backed out the arb upgrade.


---

Comment by mkoeppe created at 2020-06-26 22:04:19

Tests run at https://github.com/mkoeppe/sage/actions/runs/149186528

Sorry for missing the failures in the previous runs!


---

Comment by mkoeppe created at 2020-06-26 22:04:34

Changing status from needs_work to needs_review.


---

Comment by git created at 2020-07-04 16:32:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-07-05 08:52:06

where are we here?


---

Comment by fbissey created at 2020-07-05 09:09:49

The `arb` ticket has been closed but this branch doesn't upgrade `arb`. It includes a patch for the current shipped `arb` but it doesn't revbump the `arb` package which means that the patch is only applied to fresh builds and not to incremental upgrades.

At the minimum I think this branch needs to include a revbump for `arb`, but since we obsoleted the `arb` ticket I would favor upgrade `arb` in this ticket too.


---

Comment by dimpase created at 2020-07-05 11:36:37

Replying to [comment:97 fbissey]:
> The `arb` ticket has been closed but this branch doesn't upgrade `arb`. It includes a patch for the current shipped `arb` but it doesn't revbump the `arb` package which means that the patch is only applied to fresh builds and not to incremental upgrades.
> 
> At the minimum I think this branch needs to include a revbump for `arb`, but since we obsoleted the `arb` ticket I would favor upgrade `arb` in this ticket too.

As this ticket updates a dependency of arb, it will rebuild arb regardless of the presense of revbump (or at least it should - it it doesn't it's a bug in the build system)


---

Comment by slelievre created at 2020-07-26 17:35:37

Flint 2.6.1 seems to have been released on 2020-07-23.

- https://github.com/wbhart/flint2/releases

But maybe that should be a new ticket if things are ready here.


---

Comment by mkoeppe created at 2020-07-26 17:43:31

Replying to [comment:97 fbissey]:
>  since we obsoleted the `arb` ticket I would favor upgrade `arb` in this ticket too.

The arb ticket #28623 has been un-obsoleted.


---

Comment by git created at 2020-07-26 17:45:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-26 17:46:25

Replying to [comment:97 fbissey]:
> At the minimum I think this branch needs to include a revbump for `arb`

Done


---

Comment by git created at 2020-07-26 17:58:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-26 18:00:03

Tests run at https://github.com/mkoeppe/sage/actions/runs/183335441


---

Comment by slelievre created at 2020-07-29 11:33:49

Replying to [comment:105 mkoeppe]:
> Tests run at https://github.com/mkoeppe/sage/actions/runs/183335441

45 passed, 18 failed, 14 cancelled, 1 skipped


---

Comment by slelievre created at 2020-07-29 11:33:49

Changing keywords from "" to "upgrade".


---

Comment by mkoeppe created at 2020-07-29 18:23:34

These summary statistics don't mean much because they do not distinguish sporadic errors (from the unreliable computing platform) from actual failures - one needs to look at the details.
If you want, I can walk you through on how to read these runs...


---

Comment by dimpase created at 2020-07-31 14:33:05

e_antic needs a bump:

```
[e_antic-0.1.7] In file included from ./e-antic/poly_extra.h:15,
[e_antic-0.1.7]                  from poly_extra/bisection_step_arb.c:12:
[e_antic-0.1.7] ./e-antic/e-antic.h:24:2: error: #error FLINT 2.5.2 or 2.5.3 required
[e_antic-0.1.7]  #error FLINT 2.5.2 or 2.5.3 required
[e_antic-0.1.7]   ^~~~~
[e_antic-0.1.7] In file included from poly_extra/bisection_step_arb.c:12:
[e_antic-0.1.7] ./e-antic/poly_extra.h:267:8: error: static declaration of ‘fmpq_get_d’ follows non-static declaration
[e_antic-0.1.7]  double fmpq_get_d(const fmpq_t q)
[e_antic-0.1.7]         ^~~~~~~~~~
[e_antic-0.1.7] In file included from /mnt/opt/Sage/sage-dev/local/include/flint/fmpz_poly.h:36,
[e_antic-0.1.7]                  from ./e-antic/poly_extra.h:17,
[e_antic-0.1.7]                  from poly_extra/bisection_step_arb.c:12:
[e_antic-0.1.7] /mnt/opt/Sage/sage-dev/local/include/flint/fmpq.h:183:18: note: previous declaration of ‘fmpq_get_d’ was here
[e_antic-0.1.7]  FLINT_DLL double fmpq_get_d(const fmpq_t a);
[e_antic-0.1.7]                   ^~~~~~~~~~
[e_antic-0.1.7] In file included from poly_extra/bisection_step_arb.c:12:
[e_antic-0.1.7] ./e-antic/poly_extra.h:356:2: error: #error "Invalid flint release: e-antic needs flint-2.5.2, flint-2.5.3 or flint-2.6.0"
[e_antic-0.1.7]  #error "Invalid flint release: e-antic needs flint-2.5.2, flint-2.5.3 or flint-2.6.0"
[e_antic-0.1.7]   ^~~~~
[e_antic-0.1.7] make[5]: *** [Makefile:2696: poly_extra/bisection_step_arb.lo] Error 1
```



---

Comment by dimpase created at 2020-07-31 14:33:05

Changing status from needs_review to needs_work.


---

Comment by slelievre created at 2020-07-31 20:36:31

Flint 2.6.2 was released.

- [flint-devel: Flint 2.6.2 release announcement](https://groups.google.com/d/topic/flint-devel/3uB1hhQP6S4/discussion)


---

Comment by mkoeppe created at 2020-07-31 23:22:51

Replying to [comment:108 dimpase]:
> e_antic needs a bump:

Done in #30262, needs merging


---

Comment by slelievre created at 2020-08-12 15:37:18

Flint 2.6.3 was released:

- [flint-devel: Flint 2.6.3 release announcement](https://groups.google.com/d/msg/flint-devel/kos0KU-GdEA/aI3hFY9tAAAJ)


---

Comment by dimpase created at 2020-08-12 15:46:58

I propose to do 2.6.3.


---

Comment by mkoeppe created at 2020-08-12 16:15:30

I agree


---

Comment by @BrentBaccala created at 2020-08-16 05:09:28

I'm working on getting multi-variate polynomials running with the new flint code.

I expect to be opening a dependent ticket for that soon.

In the meantime, every time I type 'make build' on this branch (without any local mods), it rebuilds sage.rings.polynomial.pbori.  Every time.  Takes about 60 seconds, too.

Any ideas why it keeps rebuilding pbori?


---

Comment by mkoeppe created at 2020-08-16 17:08:48

Replying to [comment:115 gh-BrentBaccala]:
> every time I type 'make build' on this branch (without any local mods), it rebuilds sage.rings.polynomial.pbori.  Every time.  Takes about 60 seconds, too.
> 
> Any ideas why it keeps rebuilding pbori?

Sounds like there is something wrong with the Cython dependencies. You could investigate this by setting a breakpoint or printing data in `sage_setup.command.sage_build_cython.sage_build_cython.create_extension`


---

Comment by dimpase created at 2020-08-16 22:22:24

Replying to [comment:116 mkoeppe]:
> Replying to [comment:115 gh-BrentBaccala]:
> > every time I type 'make build' on this branch (without any local mods), it rebuilds sage.rings.polynomial.pbori.  Every time.  Takes about 60 seconds, too.
> > 
> > Any ideas why it keeps rebuilding pbori?
> 
> Sounds like there is something wrong with the Cython dependencies. You could investigate this by setting a breakpoint or printing data in `sage_setup.command.sage_build_cython.sage_build_cython.create_extension`

I think this problem has fixed itself in the latest beta.


---

Comment by slelievre created at 2020-08-19 21:50:16

Rebase on 9.2.beta9?


---

Comment by dimpase created at 2020-08-22 12:03:17

postpone till 9.3?


---

Comment by mkoeppe created at 2020-08-22 15:31:27

I agree


---

Comment by dimpase created at 2020-09-08 19:07:40

an experiment with flint 2.6.3, which is a package on Gentoo, built with cmake, reveals that this breaks its recognition, as `HAVE_GC` may be undefined (it is just not there if  GC is not "found" in some sense. 

I opened https://github.com/wbhart/flint2/issues/837


---

Comment by git created at 2020-09-16 22:28:12

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-09-23 08:15:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-09-23 12:59:43

Replying to [comment:121 dimpase]:
> an experiment with flint 2.6.3, which is a package on Gentoo, built with cmake, reveals that this breaks its recognition, as `HAVE_GC` may be undefined (it is just not there if  GC is not "found" in some sense. 
> 
> I opened https://github.com/wbhart/flint2/issues/837

fixed by #30642


---

Comment by dimpase created at 2020-09-23 16:16:08

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2020-09-23 16:16:08

should we perhaps try getting this into 9.2?


---

Comment by mkoeppe created at 2020-09-23 21:27:41

Is this update needed for supporting Xcode 12?


---

Comment by git created at 2020-10-20 08:34:11

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2020-10-20 08:35:14

rebased over 9.2.rc3


---

Comment by git created at 2020-10-21 20:41:49

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2020-10-21 20:43:06

rebased over #30805


---

Comment by @BrentBaccala created at 2020-10-29 00:05:01

To build the current version of this branch (commit 01271cb) on Ubuntu I had to `apt install libgmp-dev`.

I don't think that's listed as a build requirement.


---

Comment by mkoeppe created at 2020-10-29 00:10:47

Logs please


---

Attachment

Build attempt on commit 01271cb


---

Comment by @BrentBaccala created at 2020-10-29 01:31:38

I attached a log file.

There's really not much to see - a bunch of failed downloads because flint 2.6.3 isn't in any of the Sage mirrors yet, then a compile failure because it couldn't find "gmp.h", which I resolved with `apt install libgmp-dev`.


---

Comment by dimpase created at 2020-10-29 19:26:46

Replying to [comment:135 gh-BrentBaccala]:
> I attached a log file.
> 
> There's really not much to see - a bunch of failed downloads because flint 2.6.3 isn't in any of the Sage mirrors yet, 

`./configure` has `--enable-download-from-upstream-url` option, which use would allow an automatic download from the url  in `checksums.ini`of the package.

> then a compile failure because it couldn't find "gmp.h", which I resolved with `apt install libgmp-dev`.

look at what `./configure` tries to tell at the end of its run - there should be a list of system packages to install to make one's life easier.
On Debian like 90% of Sage's (non-python) libs, as well as Python itself, etc etc, are unvendored, see #27330


---

Comment by @BrentBaccala created at 2020-10-29 19:41:17

Replying to [comment:136 dimpase]:
> 
> look at what `./configure` tries to tell at the end of its run - there should be a list of system packages to install to make one's life easier.
> On Debian like 90% of Sage's (non-python) libs, as well as Python itself, etc etc, are unvendored, see #27330
> 

I had to re-run configure after installing libgmp-dev, and I didn't keep the old log, but I don't remember any glaring complaints.  Furthermore, I found this in the (new) config.log:

   configure:37965: result: gmp-6.1.2:                                   using system package; SPKG will not be installed

I infer from this that a SPKG is available and should have been used by the original build.

I don't know enough about Sage packaging to know how a SPKG gmp should be used by flint.


---

Comment by dimpase created at 2020-10-30 07:52:22

Replying to [comment:133 gh-BrentBaccala]:
> To build the current version of this branch (commit 01271cb) on Ubuntu I had to `apt install libgmp-dev`.
> 
> I don't think that's listed as a build requirement.
How did you start the build?

I only can see this happening on an unconfigured tree if one does not start by
running `./configure`, but rather by doing something like `./sage -p flint` (which indeed does not check dependencies)


---

Comment by @BrentBaccala created at 2020-10-30 13:08:47

Replying to [comment:138 dimpase]:
> Replying to [comment:133 gh-BrentBaccala]:
> > To build the current version of this branch (commit 01271cb) on Ubuntu I had to `apt install libgmp-dev`.
> > 
> > I don't think that's listed as a build requirement.
> How did you start the build?
> 
> I only can see this happening on an unconfigured tree if one does not start by
> running `./configure`, but rather by doing something like `./sage -p flint` (which indeed does not check dependencies)

After `git checkout`, I ran `./bootstrap`, then `./configure`, then `MAKE="make -j8" make`.


---

Comment by dimpase created at 2020-10-30 14:03:48

could be stale leftovers - how about `make bootstrap-clean && make distclean` ?
(for the former possibly #30795 is needed)


---

Comment by git created at 2020-11-06 12:07:03

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2020-11-06 12:09:19

rebased over 9.3.beta0, squashed few things. Let us get this in please!

In particular, here are patches that need to fix doctest on distros that ship flint 2.6.3 already, e.g. Homebrew, Ubuntu 20.10.


---

Comment by mkoeppe created at 2020-11-06 19:29:25

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-11-15 22:47:41

Resolution: fixed
