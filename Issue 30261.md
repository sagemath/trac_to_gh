# Issue 30261: Hash function of libgap objects

archive/issues_030261.json:
```json
{
    "body": "Libgap object hash function is not compatible with Python/Sage\n\n```\nsage: hash(2)\n2\nsage: hash(libgap(2))\n4749963527729243378\n```\n\nas a consequence\n\n```\nsage: set([libgap(2)]) == set([2])\nFalse\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/30498\n\n",
    "created_at": "2020-09-03T09:46:31Z",
    "labels": [
        "packages: standard",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Hash function of libgap objects",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30261",
    "user": "@videlec"
}
```
Libgap object hash function is not compatible with Python/Sage

```
sage: hash(2)
2
sage: hash(libgap(2))
4749963527729243378
```

as a consequence

```
sage: set([libgap(2)]) == set([2])
False
```


Issue created by migration from https://trac.sagemath.org/ticket/30498





---

archive/issue_comments_431496.json:
```json
{
    "body": "Is libgap an exception?\n\n```\nsage: hash(singular(2))                                                                                                                                                                                                                \n-3887916961774677074\nsage: hash(pari(2))                                                                                                                                                                                                                    \n-5620492333743569407\nsage: hash(maxima_calculus(2))                                                                                                                                                                                                         \n-7166118788106343663\n```\n",
    "created_at": "2020-09-03T11:07:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30261#issuecomment-431496",
    "user": "@dimpase"
}
```

Is libgap an exception?

```
sage: hash(singular(2))                                                                                                                                                                                                                
-3887916961774677074
sage: hash(pari(2))                                                                                                                                                                                                                    
-5620492333743569407
sage: hash(maxima_calculus(2))                                                                                                                                                                                                         
-7166118788106343663
```




---

archive/issue_comments_431497.json:
```json
{
    "body": "Replying to [comment:4 dimpase]:\n> Is libgap an exception?\n> {{{\n> sage: hash(singular(2))                                                                                                                                                                                                                \n> -3887916961774677074\n> sage: hash(pari(2))                                                                                                                                                                                                                    \n> -5620492333743569407\n> sage: hash(maxima_calculus(2))                                                                                                                                                                                                         \n> -7166118788106343663\n> }}}\n\nGood point! But I would prefer to fix the various interfaces with various tickets. In particular for pari, the hash comes from `cypari2` and is implemented using a C function from the PARI libaray. It is not on Sage side. The specificity of the libgap interface is that it is using `hash(str(self))` which can easily adapted to match Sage on integers/rationals. Feel free to open further tickets for singular and maxima.",
    "created_at": "2020-09-03T14:28:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30261#issuecomment-431497",
    "user": "@videlec"
}
```

Replying to [comment:4 dimpase]:
> Is libgap an exception?
> {{{
> sage: hash(singular(2))                                                                                                                                                                                                                
> -3887916961774677074
> sage: hash(pari(2))                                                                                                                                                                                                                    
> -5620492333743569407
> sage: hash(maxima_calculus(2))                                                                                                                                                                                                         
> -7166118788106343663
> }}}

Good point! But I would prefer to fix the various interfaces with various tickets. In particular for pari, the hash comes from `cypari2` and is implemented using a C function from the PARI libaray. It is not on Sage side. The specificity of the libgap interface is that it is using `hash(str(self))` which can easily adapted to match Sage on integers/rationals. Feel free to open further tickets for singular and maxima.



---

archive/issue_comments_431498.json:
```json
{
    "body": "I am not convinced that this is a good idea. Why would a hash of differently typed things be equal? To me, the fact that ZZ(2) and int(2) both hash to 2 is more of a hassle, i.e., a hash collision! But I might be wrong - should we discuss this on sage-devel?",
    "created_at": "2020-09-03T15:59:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30261#issuecomment-431498",
    "user": "@dimpase"
}
```

I am not convinced that this is a good idea. Why would a hash of differently typed things be equal? To me, the fact that ZZ(2) and int(2) both hash to 2 is more of a hassle, i.e., a hash collision! But I might be wrong - should we discuss this on sage-devel?



---

archive/issue_comments_431499.json:
```json
{
    "body": "https://docs.python.org/3/reference/datamodel.html#object.__hash__\n\n```\n[...] The only required property is that objects which compare\nequal have the same hash value [...]\n```\n",
    "created_at": "2020-09-03T17:56:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30261#issuecomment-431499",
    "user": "@videlec"
}
```

https://docs.python.org/3/reference/datamodel.html#object.__hash__

```
[...] The only required property is that objects which compare
equal have the same hash value [...]
```




---

archive/issue_comments_431500.json:
```json
{
    "body": "I am not sure whether this only applies to objects of the same class/type.",
    "created_at": "2020-09-03T18:12:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30261#issuecomment-431500",
    "user": "@dimpase"
}
```

I am not sure whether this only applies to objects of the same class/type.



---

archive/issue_comments_431501.json:
```json
{
    "body": "Replying to [comment:8 dimpase]:\n> I am not sure whether this only applies to objects of the same class/type.\n\nThe python spec has no such requirement, which means that generally, objects for different class/type should compare unequal.\n\nIn sage, our equality is too liberal to combine useful hashes with keeping to this strict rule:\n\n```\nsage: 2 == GF(3)(2) == 5\nTrue\n```\n\nso we're already forced to be pragmatic about it. Within the same parent, I think we do want it to hold -- otherwise you're better off making the objects not hashable. Outside of that, we can do a reasonable effort, but things will break eventually. People will have to learn that in Sage, you need to normalize your keys prior to putting them in a dictionary, and what that means depends on your application. It will generally mean forcing all the keys into the same parent. It's important to keep hashes cheap too!",
    "created_at": "2020-09-03T19:23:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30261#issuecomment-431501",
    "user": "@nbruin"
}
```

Replying to [comment:8 dimpase]:
> I am not sure whether this only applies to objects of the same class/type.

The python spec has no such requirement, which means that generally, objects for different class/type should compare unequal.

In sage, our equality is too liberal to combine useful hashes with keeping to this strict rule:

```
sage: 2 == GF(3)(2) == 5
True
```

so we're already forced to be pragmatic about it. Within the same parent, I think we do want it to hold -- otherwise you're better off making the objects not hashable. Outside of that, we can do a reasonable effort, but things will break eventually. People will have to learn that in Sage, you need to normalize your keys prior to putting them in a dictionary, and what that means depends on your application. It will generally mean forcing all the keys into the same parent. It's important to keep hashes cheap too!



---

archive/issue_comments_431502.json:
```json
{
    "body": "Replying to [comment:9 nbruin]:\n> It's important to keep hashes cheap too!\n\nRegarding that point, `hash(str(self))` is slow!",
    "created_at": "2020-09-04T09:30:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30261#issuecomment-431502",
    "user": "@videlec"
}
```

Replying to [comment:9 nbruin]:
> It's important to keep hashes cheap too!

Regarding that point, `hash(str(self))` is slow!



---

archive/issue_comments_431503.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30261#issuecomment-431503",
    "user": "@mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_431504.json:
```json
{
    "body": "I opened an issue for this against gappy as well: https://github.com/embray/gappy/issues/11",
    "created_at": "2021-02-16T12:58:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30261#issuecomment-431504",
    "user": "@embray"
}
```

I opened an issue for this against gappy as well: https://github.com/embray/gappy/issues/11
