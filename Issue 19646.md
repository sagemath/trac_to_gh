# Issue 19646: Let PARI handle its own stack

Issue created by migration from https://trac.sagemath.org/ticket/19883

Original creator: jdemeyer

Original creation time: 2016-01-13 18:14:23

CC:  defeo

For historical reasons, the PARI stack is actually handled "manually" by Sage. The main reason was to implement auto-resizing of the stack in case a command failed due to a stack overflow. With the introduction of `parisizemax`, PARI can handle this on its own.


---

Comment by pbruin created at 2016-01-13 19:26:20

I started working on this some time ago, but never finished it.  In case you are interested, I just pushed my code to `u/pbruin/pari_stack`.


---

Comment by jdemeyer created at 2016-01-14 13:57:50

New commits:


---

Comment by jdemeyer created at 2016-01-14 15:57:27

Changing status from new to needs_review.


---

Comment by pbruin created at 2016-01-14 16:15:42

Two small comments (no time for a complete review):
- remove mention of the deleted `public_memory_functions.patch` in `build/pkgs/pari/patches/README.txt`
- I think you can remove the following lines from `PariInstance.__dealloc__()`:

```
        sage_free(<void*>pari_mainstack.vbot)
        pari_mainstack.rsize = 0
        pari_mainstack.vsize = 0
        pari_mainstack.bot = 0
        pari_mainstack.vbot = 0
        pari_mainstack.top = 0
```



---

Comment by git created at 2016-01-14 16:17:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-01-14 16:18:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pbruin created at 2016-01-14 17:15:49

The following looks funny:

```
sage: pari.allocatemem(2^4, 2^64-1)
  ***   Warning: not enough memory, new stack 9223372036854775808
  ***   Warning: not enough memory, new stack 4611686018427387904
  ***   Warning: not enough memory, new stack 2305843009213693952
  ***   Warning: not enough memory, new stack 1152921504606846976
  ***   Warning: not enough memory, new stack 576460752303423488
  ***   Warning: not enough memory, new stack 288230376151711744
  ***   Warning: not enough memory, new stack 144115188075855872
  ***   Warning: not enough memory, new stack 72057594037927936
  ***   Warning: not enough memory, new stack 36028797018963968
  ***   Warning: not enough memory, new stack 18014398509481984
  ***   Warning: not enough memory, new stack 9007199254740992
  ***   Warning: not enough memory, new stack 4503599627370496
  ***   Warning: not enough memory, new stack 2251799813685248
  ***   Warning: not enough memory, new stack 1125899906842624
  ***   Warning: not enough memory, new stack 562949953421312
  ***   Warning: not enough memory, new stack 281474976710656
  ***   Warning: not enough memory, new stack 140737488355328
  ***   Warning: not enough memory, new stack 70368744177664
PARI stack size set to 1024 bytes
```

You may want to silence these warnings as well.  I would also suggest `allocatemem()` should print both the actual and the maximum stack sizes with `silent=False`.


---

Comment by pbruin created at 2016-01-14 17:40:50

I'm not sure what to think about the strategy to set the maximum PARI stack size to 1/4 of the maximum amount of memory that `malloc()` can allocate.  On a certain system that I use, this causes Sage to show up in `ps` or `top` as using 129 gigabytes of virtual memory (and `pari.stackmax()` returns exactly 128 gigabytes).  Of course this is harmless as long as the memory isn't actually used, but it looks/feels somewhat absurd.


---

Comment by jdemeyer created at 2016-01-14 17:48:09

Replying to [comment:10 pbruin]:
> You may want to silence these warnings as well.
I'm not convinced. This is a case where you get less memory than you explicitly asked for. I think we should really display a warning in that case.

>  I would also suggest `allocatemem()` should print both the actual and the maximum stack sizes with `silent=False`.
Sure.

> On a certain system that I use, this causes Sage to show up in ps or top as using 129 gigabytes of virtual memory
I don't think that this is a problem. It's virtual and unused memory, so it shouldn't hurt at all.

I also wouldn't want to hardcode a `parisizemax` (like in your branch, you use 1G). If you have a machine with lots of RAM, you may want to actually use it.


---

Comment by pbruin created at 2016-01-14 17:59:09

Replying to [comment:12 jdemeyer]:
> Replying to [comment:10 pbruin]:
> > You may want to silence these warnings as well.
> I'm not convinced. This is a case where you get less memory than you explicitly asked for. I think we should really display a warning in that case.
It's fine with me either way; it's just that `stackwarn.patch` made me think you intended to make any memory warnings only show up with `DEBUGMEM > 0`.
> > On a certain system that I use, this causes Sage to show up in ps or top as using 129 gigabytes of virtual memory
> I don't think that this is a problem. It's virtual and unused memory, so it shouldn't hurt at all.
That is clear; it is more of an aesthetic issue, so to say.
> I also wouldn't want to hardcode a `parisizemax` (like in your branch, you use 1G). If you have a machine with lots of RAM, you may want to actually use it.
Sure, the amount in my branch was just meant to be some arbitrary default until I found a better solution (which I never got around to).  I thought about making this configurable, with some reasonable default that would be sufficient for most users.


---

Comment by git created at 2016-01-14 20:50:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2016-01-15 22:44:47

How is Pari implementing this? In GAP its mmap **without** MAP_NORESERVE, so even if its just virtual memory it reserves swap. And if you do it often (parallel doctesting comes to mind) your swap is used up and virtual allocations suddenly are forced into ram. 

There is sage.misc.memory_info to detect ram / swap.

Gap uses it in sage.interfaces.gap.get_gap_memory_pool_size


---

Comment by jdemeyer created at 2016-01-16 10:30:54

Replying to [comment:15 vbraun]:
> How is Pari implementing this?

```c
static void *
pari_mainstack_malloc(size_t size)
{
  void *b = mmap(NULL, size, PROT_READ|PROT_WRITE,
                             MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE,-1,0);
  return (b == MAP_FAILED) ? NULL: b;
}
```


The `MAP_NORESERVE` is indeed important, together with the fact that PARI tries to use a small stack if possible. The enlarged stack is only used when it's really needed.


---

Comment by pbruin created at 2016-01-16 19:35:43

Replying to [comment:16 jdemeyer]:
> The `MAP_NORESERVE` is indeed important, together with the fact that PARI tries to use a small stack if possible. The enlarged stack is only used when it's really needed.
Is this flag supported on all systems?  The lines just before this function are

```
#ifndef MAP_NORESERVE
#define MAP_NORESERVE 0
#endif
```



---

Comment by vbraun created at 2016-01-16 20:50:20

Not every system has mmap or MAP_NORESERVE; If you don't then you clearly aren't interested in efficient use of memory so its ok to ignore.


---

Comment by jdemeyer created at 2016-01-17 08:39:20

Replying to [comment:18 vbraun]:
> Not every system has mmap or MAP_NORESERVE

`mmap()` is defined by POSIX, so it should be available on every system where Sage is supported.


---

Comment by jdemeyer created at 2016-01-17 08:49:36

Replying to [comment:15 vbraun]:
> How is Pari implementing this? In GAP its mmap **without** MAP_NORESERVE, so even if its just virtual memory it reserves swap. And if you do it often (parallel doctesting comes to mind) your swap is used up and virtual allocations suddenly are forced into ram.

I don't quite get what you mean with "reserves swap". It reserves virtual memory, but I don't think that it allocates actual pages on the swap file. That wouldn't make sense for pages which are completely unused (never been written to nor read from). But even then, you want active processes to use RAM, not swap so I don't really see the problem.

Second, what you write is only true if your OS does not overcommit memory. At least Linux overcommits by default, such that the total amount of virtual memory you can allocate is greater than RAM + swap.

So, after thinking about this a bit more, I don't think that `MAP_NORESERVE` is actually so important. It helps by keeping more virtual memory available, but it doesn't change at all how phyisical memory (i.e. RAM) is used.


---

Comment by vbraun created at 2016-01-17 16:10:59

Calling mmap without MAP_NORESERVE does reserve first swap and then ram, this is no joke and bit us with gap. Sure overcommit helps but there is a limit to it; Really its just the final warning before the oomkiller strikes. Overcommitting is NOT a happy place to be.

Imho the "try to allocate all memory" approach has a small chance of messing things up badly. Sure it works almost all the time but some day you'll succeed, sbrk almost everything into one process, and then everybody else on the system will have a bad day. It smells of rare and undebuggable random failures.


---

Comment by jdemeyer created at 2016-01-17 19:44:27

Replying to [comment:21 vbraun]:
> Imho the "try to allocate all memory" approach has a small chance of messing things up badly.
I doubt it. Are there any OSes which really mess up when allocating a large amount of _unused_ memory?


---

Comment by vbraun created at 2016-01-17 21:50:40

Malloc respects overcommit accounting, it essentially does mmap without MAP_NORESERVE (that is one of the implementations in glibc). The OS doesn't mess up, it just does what you ask it to. I.e. overcommit and, quite possibly, kill the next process that wants more memory (or just do something with his previously-malloced memory). And I really don't like my processes being killed because I'm running doctests in the background.


---

Comment by jdemeyer created at 2016-01-17 22:20:04

Does the OOMkiller really kick in based on _virtual memory_ usage? Then you could end up in a situation where there is plenty of unused RAM but still processes would get killed. It would really surprise me if this is what actually happens.


---

Comment by vbraun created at 2016-01-17 23:44:08

Just run malloc (without free) in a for-loop, I'm pretty sure that it stops before the entire addressing space is used up. 

Thats also a pretty weird use case, a process allocates memory but doesn't use it. Why should the virtual memory system cater to that and do all the extra accounting? If you don't need memory then don't ask for it. And in the extremely special case where you want to implement your own memory manager in user space there is still mmap(MAP_NORESERVE).


---

Comment by jdemeyer created at 2016-01-18 07:21:49

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2016-01-18 07:21:49

Replying to [comment:25 vbraun]:
> Thats also a pretty weird use case, a process allocates memory but doesn't use it.
Then why do you think that overcommitting was invented in the first place? Because processes often ask for more memory than they actually use.

Anyway, let's stop this discussion and think about how to actually choose how much memory to allocate for the PARI stack.


---

Comment by git created at 2016-01-18 09:45:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-01-18 09:46:42

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2016-01-18 10:11:38

looks good to me


---

Comment by vbraun created at 2016-01-18 10:11:38

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-01-20 00:37:01

Pari testsuite fails, e.g. http://build.sagedev.org/release/builders/%20%20fast%20Volker%20MiniMac%20%28OSX%2010.10%20x86_64%29%20incremental/builds/684/steps/compile/logs/pari


---

Comment by vbraun created at 2016-01-20 00:37:01

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2016-01-20 09:05:57

The problem is that I disabled some warnings by default but the testsuite expects those warnings. Solution: increase `debugmem` for the PARI testsuite.


---

Comment by git created at 2016-01-20 09:32:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-01-20 09:35:29

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2016-01-20 10:18:49

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-01-20 15:58:52

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2016-01-20 15:58:52

Fails on OSX: http://build.sagedev.org/release/builders/%20%20fast%20Volker%20MiniMac%20%28OSX%2010.10%20x86_64%29%20incremental/builds/686/steps/shell_4/logs/stdio

```
sage -t --long src/sage/doctest/test.py
**********************************************************************
File "src/sage/doctest/test.py", line 26, in sage.doctest.test
Failed example:
    subprocess.call(["sage", "-t", "--warn-long", "0", "longtime.rst"], **kwds)  # long time
Expected:
    Running doctests...
    Doctesting 1 file.
    sage -t --warn-long 0.0 longtime.rst
    [0 tests, ...s]
    ----------------------------------------------------------------------
    All tests passed!
    ----------------------------------------------------------------------
    ...
    0
Got:
      ***   Warning: not enough memory, new stack 1152921504606846976
      ***   Warning: not enough memory, new stack 576460752303423488
      ***   Warning: not enough memory, new stack 288230376151711744
      ***   Warning: not enough memory, new stack 144115188075855872
      ***   Warning: not enough memory, new stack 72057594037927936
      ***   Warning: not enough memory, new stack 36028797018963968
      ***   Warning: not enough memory, new stack 18014398509481984
      ***   Warning: not enough memory, new stack 9007199254740992
      ***   Warning: not enough memory, new stack 4503599627370496
      ***   Warning: not enough memory, new stack 2251799813685248
      ***   Warning: not enough memory, new stack 1125899906842624
      ***   Warning: not enough memory, new stack 562949953421312
      ***   Warning: not enough memory, new stack 281474976710656
      ***   Warning: not enough memory, new stack 140737488355328
      ***   Warning: not enough memory, new stack 70368744177664
    Running doctests with ID 2016-01-20-12-28-05-86bac659.
    Git branch: develop
    Using --optional=gcc,mpir,python2,sage
    Doctesting 1 file.
    sage -t --warn-long 0.0 longtime.rst
        [0 tests, 0.00 s]
    ----------------------------------------------------------------------
    All tests passed!
    ----------------------------------------------------------------------
    Total time for all tests: 0.9 seconds
        cpu time: 0.0 seconds
        cumulative wall time: 0.0 seconds
    0
**********************************************************************
```



---

Comment by jdemeyer created at 2016-01-21 13:26:12

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2016-01-24 21:48:28

Resolution: fixed
