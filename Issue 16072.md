# Issue 16072: Determine argspec of static methods with defaults in Cython files

archive/issues_016072.json:
```json
{
    "body": "CC:  @nthiery\n\nKeywords: staticmethod cython argspec\n\nFix this:\n\n```\nsage: cython(\"\"\"\n....: class Bla:\n....:     @staticmethod\n....:     def join(categories, bint as_list = False, tuple ignore_axioms=(), tuple axioms=()):\n....:         pass\n....: \"\"\")\nsage: from sage.misc.sageinspect import sage_getargspec\nsage: sage_getargspec(Bla.join)\n  File \"<string>\", line unknown\nSyntaxError: Unexpected EOF while parsing argument list\n\n```\n\nThis does not happen if `join` is a bound or unbound (not static) method.\n\nSince this will affect building the docs (see #16296), I'd say the component is \"documentation\".\n\nIssue created by migration from https://trac.sagemath.org/ticket/16309\n\n",
    "created_at": "2014-05-08T14:23:09Z",
    "labels": [
        "component: documentation",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.3",
    "title": "Determine argspec of static methods with defaults in Cython files",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16072",
    "user": "https://github.com/simon-king-jena"
}
```
CC:  @nthiery

Keywords: staticmethod cython argspec

Fix this:

```
sage: cython("""
....: class Bla:
....:     @staticmethod
....:     def join(categories, bint as_list = False, tuple ignore_axioms=(), tuple axioms=()):
....:         pass
....: """)
sage: from sage.misc.sageinspect import sage_getargspec
sage: sage_getargspec(Bla.join)
  File "<string>", line unknown
SyntaxError: Unexpected EOF while parsing argument list

```

This does not happen if `join` is a bound or unbound (not static) method.

Since this will affect building the docs (see #16296), I'd say the component is "documentation".

Issue created by migration from https://trac.sagemath.org/ticket/16309





---

archive/issue_comments_209030.json:
```json
{
    "body": "That's really silly, as the names and defaults are easy to get:\n\n```\nsage: Bla.join.func_code.co_varnames\n('categories', 'as_list', 'ignore_axioms', 'axioms')\nsage: Bla.join.func_defaults\n(False, (), ())",
    "created_at": "2014-05-08T14:31:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16072",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16072#issuecomment-209030",
    "user": "https://github.com/simon-king-jena"
}
```

That's really silly, as the names and defaults are easy to get:

```
sage: Bla.join.func_code.co_varnames
('categories', 'as_list', 'ignore_axioms', 'axioms')
sage: Bla.join.func_defaults
(False, (), ())



---

archive/issue_comments_209031.json:
```json
{
    "body": "People have complained about `inspect.isfunction` being to picky before and a monkey patch has been proposed: http://cython-devel.gmang.org/2013-August/003804.html\n\nWe wouldn't need to hack that badly. We can just go with ducktyping: if `hasattr(obj,'func_code')` we're probably looking at a function (line 1292 of sageinspect.py).\n\nIt's been noted that testing for `<type 'cython_function_or_method'>` cannot be done via `isinstance`, since every cython module makes a separate version of that type (which is considered a bug but unlikely to be fixed (soon)). By the time you're checking for the name of a type you're probably better off looking for a telltale attribute.",
    "created_at": "2014-05-08T16:43:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16072",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16072#issuecomment-209031",
    "user": "https://github.com/nbruin"
}
```

People have complained about `inspect.isfunction` being to picky before and a monkey patch has been proposed: http://cython-devel.gmang.org/2013-August/003804.html

We wouldn't need to hack that badly. We can just go with ducktyping: if `hasattr(obj,'func_code')` we're probably looking at a function (line 1292 of sageinspect.py).

It's been noted that testing for `<type 'cython_function_or_method'>` cannot be done via `isinstance`, since every cython module makes a separate version of that type (which is considered a bug but unlikely to be fixed (soon)). By the time you're checking for the name of a type you're probably better off looking for a telltale attribute.



---

archive/issue_comments_209032.json:
```json
{
    "body": "Replying to [comment:2 nbruin]:\n> People have complained about `inspect.isfunction` being to picky before and a monkey patch has been proposed: http://cython-devel.gmang.org/2013-August/003804.html\n\nIndeed it is a bit odd that the inspect module does type checks rather than duck typing.\n \n> We wouldn't need to hack that badly. We can just go with ducktyping: if `hasattr(obj,'func_code')` we're probably looking at a function (line 1292 of sageinspect.py).\n\nThat's an important information, that I will use in #16296 for the `@`abstract_method decorator.\n\nAnyway, I suppose we need to somehow copy what is done in the inspect module, replacing the type check by duck typing.",
    "created_at": "2014-05-08T17:11:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16072",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16072#issuecomment-209032",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:2 nbruin]:
> People have complained about `inspect.isfunction` being to picky before and a monkey patch has been proposed: http://cython-devel.gmang.org/2013-August/003804.html

Indeed it is a bit odd that the inspect module does type checks rather than duck typing.
 
> We wouldn't need to hack that badly. We can just go with ducktyping: if `hasattr(obj,'func_code')` we're probably looking at a function (line 1292 of sageinspect.py).

That's an important information, that I will use in #16296 for the `@`abstract_method decorator.

Anyway, I suppose we need to somehow copy what is done in the inspect module, replacing the type check by duck typing.



---

archive/issue_comments_209033.json:
```json
{
    "body": "It gets worse.\n\n```\nsage: cython(\"\"\"\n....: class Bla:\n....:     @staticmethod\n....:     def join(categories, bint as_list = False, tuple ignore_axioms=(), tuple axioms=()):\n....:         pass\n....: \"\"\")\nsage: from sage.misc.sageinspect import sage_getsource\nsage: sage_getsource(Bla)\nTraceback (most recent call last):\n...\n/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/misc/sageinspect.pyc in sage_getsourcelines(obj, is_binary)\n   1836                     if B is not None and B is not obj:\n   1837                         return sage_getsourcelines(B)\n-> 1838                 if obj.__class__ != type:\n   1839                     return sage_getsourcelines(obj.__class__)\n   1840                 raise\n\nAttributeError: class Bla has no attribute '__class__'\n```\n\nHowever, the source of `Bla.join` is almost correctly determined:\n\n```\nsage: print sage_getsource(Bla.join)\n    def join(categories, bint as_list = False, tuple ignore_axioms=(), tuple axioms=()):\n        pass\n```\n\nThis should include the decorator!",
    "created_at": "2014-05-08T17:17:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16072",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16072#issuecomment-209033",
    "user": "https://github.com/simon-king-jena"
}
```

It gets worse.

```
sage: cython("""
....: class Bla:
....:     @staticmethod
....:     def join(categories, bint as_list = False, tuple ignore_axioms=(), tuple axioms=()):
....:         pass
....: """)
sage: from sage.misc.sageinspect import sage_getsource
sage: sage_getsource(Bla)
Traceback (most recent call last):
...
/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/misc/sageinspect.pyc in sage_getsourcelines(obj, is_binary)
   1836                     if B is not None and B is not obj:
   1837                         return sage_getsourcelines(B)
-> 1838                 if obj.__class__ != type:
   1839                     return sage_getsourcelines(obj.__class__)
   1840                 raise

AttributeError: class Bla has no attribute '__class__'
```

However, the source of `Bla.join` is almost correctly determined:

```
sage: print sage_getsource(Bla.join)
    def join(categories, bint as_list = False, tuple ignore_axioms=(), tuple axioms=()):
        pass
```

This should include the decorator!



---

archive/issue_comments_209034.json:
```json
{
    "body": "Replying to [comment:4 SimonKing]:\n> However, the source of `Bla.join` is almost correctly determined:\n> {{{\n> sage: print sage_getsource(Bla.join)\n>     def join(categories, bint as_list = False, tuple ignore_axioms=(), tuple axioms=()):\n>         pass\n> }}}\n> This should include the decorator!\nAre you sure? Getsource does exactly what `__doc__` indicates. It would be ``@`staticmethod`'s responsibility to modify that. However, I think cython processes ``@`staticmethod` specially, so you'd need to file a bug to cython for that. I do agree it would be nice to see that a method is static, but presently you'd need to write that in the docstring yourself.\n\nYou are correct in noting that `sage_getsource` for ``@`staticmethod` in a `.py` file does include the decorator. That suggests that cython's ``@`staticmethod` processing should perhaps adjust  `Bla.join.func_code.co_firstlineno` and/or `Bla.join.__doc__`, where it writes file and line number info too.",
    "created_at": "2014-05-08T18:17:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16072",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16072#issuecomment-209034",
    "user": "https://github.com/nbruin"
}
```

Replying to [comment:4 SimonKing]:
> However, the source of `Bla.join` is almost correctly determined:
> {{{
> sage: print sage_getsource(Bla.join)
>     def join(categories, bint as_list = False, tuple ignore_axioms=(), tuple axioms=()):
>         pass
> }}}
> This should include the decorator!
Are you sure? Getsource does exactly what `__doc__` indicates. It would be ``@`staticmethod`'s responsibility to modify that. However, I think cython processes ``@`staticmethod` specially, so you'd need to file a bug to cython for that. I do agree it would be nice to see that a method is static, but presently you'd need to write that in the docstring yourself.

You are correct in noting that `sage_getsource` for ``@`staticmethod` in a `.py` file does include the decorator. That suggests that cython's ``@`staticmethod` processing should perhaps adjust  `Bla.join.func_code.co_firstlineno` and/or `Bla.join.__doc__`, where it writes file and line number info too.



---

archive/issue_comments_209035.json:
```json
{
    "body": "Replying to [comment:5 nbruin]:\n> > This should include the decorator!\n> Are you sure? Getsource does exactly what `__doc__` indicates. It would be ``@`staticmethod`'s responsibility to modify that.\n\nOK, good point. I think it would be odd to fix that on our side.",
    "created_at": "2014-05-08T19:52:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16072",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16072#issuecomment-209035",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:5 nbruin]:
> > This should include the decorator!
> Are you sure? Getsource does exactly what `__doc__` indicates. It would be ``@`staticmethod`'s responsibility to modify that.

OK, good point. I think it would be odd to fix that on our side.



---

archive/issue_comments_209036.json:
```json
{
    "body": "Inserting the following\n\n```python\n    if hasattr(obj, 'func_code'):\n        try:\n            args, varargs, varkw = inspect.getargs(obj.func_code)\n            return inspect.ArgSpec(args, varargs, varkw, obj.func_defaults)\n        except (TypeError, AttributeError):\n            pass\n```\n\nthen the problem is solved for static methods of Python classes defined in Cython code, however it is not solved for static methods of cdef classes and cpdef methods of cdef classes.",
    "created_at": "2014-05-08T20:09:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16072",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16072#issuecomment-209036",
    "user": "https://github.com/simon-king-jena"
}
```

Inserting the following

```python
    if hasattr(obj, 'func_code'):
        try:
            args, varargs, varkw = inspect.getargs(obj.func_code)
            return inspect.ArgSpec(args, varargs, varkw, obj.func_defaults)
        except (TypeError, AttributeError):
            pass
```

then the problem is solved for static methods of Python classes defined in Cython code, however it is not solved for static methods of cdef classes and cpdef methods of cdef classes.



---

archive/issue_comments_209037.json:
```json
{
    "body": "Next problem:\n\n```\nsage: cython(\"\"\"\n....: class Foo:\n....:     @staticmethod\n....:     def join(categories, bint as_list = False, tuple ignore_axioms=(), tuple axioms=()): pass\n....: cdef class Bar:\n....:     @staticmethod\n....:     def join(categories, bint as_list = False, tuple ignore_axioms=(), tuple axioms=()): pass\n....:     cpdef meet(categories, bint as_list = False, tuple ignore_axioms=(), tuple axioms=()): pass\n....: \"\"\")\nsage: from sage.misc.sageinspect import sage_getargspec, sage_getsource, sage_getsourcelines\nsage: sage_getfile(Foo)\n'/home/king/.sage/temp/linux-etl7.site/3169/spyx/_home_king__sage_temp_linux_etl7_site_3169_tmp_qz2nuW_spyx/_home_king__sage_temp_linux_etl7_site_3169_tmp_qz2nuW_spyx_0.so'\n```\n\nShouldn't the file end with `.pyx`?",
    "created_at": "2014-05-08T20:22:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16072",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16072#issuecomment-209037",
    "user": "https://github.com/simon-king-jena"
}
```

Next problem:

```
sage: cython("""
....: class Foo:
....:     @staticmethod
....:     def join(categories, bint as_list = False, tuple ignore_axioms=(), tuple axioms=()): pass
....: cdef class Bar:
....:     @staticmethod
....:     def join(categories, bint as_list = False, tuple ignore_axioms=(), tuple axioms=()): pass
....:     cpdef meet(categories, bint as_list = False, tuple ignore_axioms=(), tuple axioms=()): pass
....: """)
sage: from sage.misc.sageinspect import sage_getargspec, sage_getsource, sage_getsourcelines
sage: sage_getfile(Foo)
'/home/king/.sage/temp/linux-etl7.site/3169/spyx/_home_king__sage_temp_linux_etl7_site_3169_tmp_qz2nuW_spyx/_home_king__sage_temp_linux_etl7_site_3169_tmp_qz2nuW_spyx_0.so'
```

Shouldn't the file end with `.pyx`?



---

archive/issue_comments_209038.json:
```json
{
    "body": "Problem, that is probably the reason why sage_getargspecs has problems:\n\n```\nsage: source = '    def join(categories, bint as_list = False, tuple ignore_axioms=(), tuple axioms=()): pass\\n\\n'\nsage: from sage.misc.sageinspect import _sage_getargspec_cython\nsage: _sage_getargspec_cython(source)\n  File \"<string>\", line unknown\nSyntaxError: Unexpected EOF while parsing argument list\n```\n\nand this (as I just found) boils down to this:\n\n```\nsage: from sage.misc.sageinspect import _split_syntactical_unit\nsage: _split_syntactical_unit('()): pass')\n('())', ': pass')\n```\n\nThe expected result is\n\n```\n('()', '): pass')\n```\n",
    "created_at": "2014-05-08T20:48:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16072",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16072#issuecomment-209038",
    "user": "https://github.com/simon-king-jena"
}
```

Problem, that is probably the reason why sage_getargspecs has problems:

```
sage: source = '    def join(categories, bint as_list = False, tuple ignore_axioms=(), tuple axioms=()): pass\n\n'
sage: from sage.misc.sageinspect import _sage_getargspec_cython
sage: _sage_getargspec_cython(source)
  File "<string>", line unknown
SyntaxError: Unexpected EOF while parsing argument list
```

and this (as I just found) boils down to this:

```
sage: from sage.misc.sageinspect import _split_syntactical_unit
sage: _split_syntactical_unit('()): pass')
('())', ': pass')
```

The expected result is

```
('()', '): pass')
```




---

archive/issue_comments_209039.json:
```json
{
    "body": "With the new branch, most problems mentioned here are fixed (and tested against), but the following remains a problem\n\n```\nsage: cython('''\n....: class Bla:\n....:     @staticmethod\n....:     def join(categories, bint as_list = False, tuple ignore_axioms=(), tuple axioms=()): pass\n....: ''')\nsage: from sage.misc.sageinspect import sage_getsource\nsage: sage_getsource(Bla)\n---------------------------------------------------------------------------\nAttributeError                            Traceback (most recent call last)\n<ipython-input-4-7be424edddca> in <module>()\n----> 1 sage_getsource(Bla)\n\n/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/misc/sageinspect.pyc in sage_getsource(obj, is_binary)\n   1610         pass\n   1611 \n-> 1612     t = sage_getsourcelines(obj, is_binary)\n   1613     if not t:\n   1614         return None\n\n/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/misc/sageinspect.pyc in sage_getsourcelines(obj, is_binary)\n   1877                     if B is not None and B is not obj:\n   1878                         return sage_getsourcelines(B)\n-> 1879                 if obj.__class__ != type:\n   1880                     return sage_getsourcelines(obj.__class__)\n   1881                 raise\n\nAttributeError: class Bla has no attribute '__class__'\n```\n\n----\nNew commits:",
    "created_at": "2014-05-08T21:05:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16072",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16072#issuecomment-209039",
    "user": "https://github.com/simon-king-jena"
}
```

With the new branch, most problems mentioned here are fixed (and tested against), but the following remains a problem

```
sage: cython('''
....: class Bla:
....:     @staticmethod
....:     def join(categories, bint as_list = False, tuple ignore_axioms=(), tuple axioms=()): pass
....: ''')
sage: from sage.misc.sageinspect import sage_getsource
sage: sage_getsource(Bla)
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
<ipython-input-4-7be424edddca> in <module>()
----> 1 sage_getsource(Bla)

/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/misc/sageinspect.pyc in sage_getsource(obj, is_binary)
   1610         pass
   1611 
-> 1612     t = sage_getsourcelines(obj, is_binary)
   1613     if not t:
   1614         return None

/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/misc/sageinspect.pyc in sage_getsourcelines(obj, is_binary)
   1877                     if B is not None and B is not obj:
   1878                         return sage_getsourcelines(B)
-> 1879                 if obj.__class__ != type:
   1880                     return sage_getsourcelines(obj.__class__)
   1881                 raise

AttributeError: class Bla has no attribute '__class__'
```

----
New commits:



---

archive/issue_comments_209040.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-05-08T21:22:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16072",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16072#issuecomment-209040",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_209041.json:
```json
{
    "body": "Hmm. At the moment, I tend to say that this already needs review. The problem described in the previous comment only occurs of `Bla` has no docstring, since otherwise Cython adds embedding information to the docstring.\n\nHence, as long as all classes in Sage get a docstring, we will have no problem. And the fix should be enough for #16296.",
    "created_at": "2014-05-08T21:22:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16072",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16072#issuecomment-209041",
    "user": "https://github.com/simon-king-jena"
}
```

Hmm. At the moment, I tend to say that this already needs review. The problem described in the previous comment only occurs of `Bla` has no docstring, since otherwise Cython adds embedding information to the docstring.

Hence, as long as all classes in Sage get a docstring, we will have no problem. And the fix should be enough for #16296.



---

archive/issue_comments_209042.json:
```json
{
    "body": "The following should be fixed, since it causes other trouble with #16296:\n\n```\nsage: cython('''\n....: class A:\n....:     def __init__(self):\n....:         \"some init doc\"\n....:         pass\n....: from sage.misc.nested_class import NestedClassMetaclass\n....: class B:\n....:     __metaclass__ = NestedClassMetaclass\n....:     class A(A):\n....:         pass\n....: ''')\nsage: from sage.misc.sageinspect sage_getsourcelines\nsage: sage_getsourcelines(B.A)\n(['class A:\\n',\n  '    def __init__(self):\\n',\n  '        \"some init doc\"\\n',\n  '        pass\\n'],\n 7)\nsage: sage_getsourcelines(B)\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-4-850f43ab2175> in <module>()\n----> 1 sage_getsourcelines(B)\n\n/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/misc/sageinspect.pyc in sage_getsourcelines(obj, is_binary)\n   1876                         B = None\n   1877                     if B is not None and B is not obj:\n-> 1878                         return sage_getsourcelines(B)\n   1879                 if obj.__class__ != type:\n   1880                     return sage_getsourcelines(obj.__class__)\n\n/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/misc/sageinspect.pyc in sage_getsourcelines(obj, is_binary)\n   1863         if pos is None:\n   1864             try:\n-> 1865                 return inspect.getsourcelines(obj)\n   1866             except IOError:\n   1867                 if (not hasattr(obj, '__class__')) or hasattr(obj,'__metaclass__'):\n\n/home/king/Sage/git/sage/local/lib/python/inspect.pyc in getsourcelines(object)\n    688     original source file the first line of code was found.  An IOError is\n    689     raised if the source code cannot be retrieved.\"\"\"\n--> 690     lines, lnum = findsource(object)\n    691 \n    692     if ismodule(object): return lines, 0\n\n/home/king/Sage/git/sage/local/lib/python2.7/site-packages/IPython/core/ultratb.pyc in findsource(object)\n    149     FIXED version with which we monkeypatch the stdlib to work around a bug.\"\"\"\n    150 \n--> 151     file = getsourcefile(object) or getfile(object)\n    152     # If the object is a frame, then trying to get the globals dict from its\n    153     # module won't work. Instead, the frame object itself has the globals\n\n/home/king/Sage/git/sage/local/lib/python/inspect.pyc in getsourcefile(object)\n    442     Return None if no way can be identified to get the source.\n    443     \"\"\"\n--> 444     filename = getfile(object)\n    445     if string.lower(filename[-4:]) in ('.pyc', '.pyo'):\n    446         filename = filename[:-4] + '.py'\n\n/home/king/Sage/git/sage/local/lib/python/inspect.pyc in getfile(object)\n    406         if hasattr(object, '__file__'):\n    407             return object.__file__\n--> 408         raise TypeError('{!r} is a built-in class'.format(object))\n    409     if ismethod(object):\n    410         object = object.im_func\n\nTypeError: <module '__builtin__' (built-in)> is a built-in class\n```\n\nSo, it detects `B.A` in the wrong location (reason: It tries to find the embedding information from what Cython inserted into the docstring of the class, and if this has none, then it considers the docstring of `__init__`---even if this is not defined in the class but in a super-class!).\n\nMoreover, it cannot get the source lines of `B`, which I think is because we catch an `IOError` but not a `TypeError` raised by `inspect.getsourcelines`.",
    "created_at": "2014-05-08T23:50:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16072",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16072#issuecomment-209042",
    "user": "https://github.com/simon-king-jena"
}
```

The following should be fixed, since it causes other trouble with #16296:

```
sage: cython('''
....: class A:
....:     def __init__(self):
....:         "some init doc"
....:         pass
....: from sage.misc.nested_class import NestedClassMetaclass
....: class B:
....:     __metaclass__ = NestedClassMetaclass
....:     class A(A):
....:         pass
....: ''')
sage: from sage.misc.sageinspect sage_getsourcelines
sage: sage_getsourcelines(B.A)
(['class A:\n',
  '    def __init__(self):\n',
  '        "some init doc"\n',
  '        pass\n'],
 7)
sage: sage_getsourcelines(B)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-4-850f43ab2175> in <module>()
----> 1 sage_getsourcelines(B)

/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/misc/sageinspect.pyc in sage_getsourcelines(obj, is_binary)
   1876                         B = None
   1877                     if B is not None and B is not obj:
-> 1878                         return sage_getsourcelines(B)
   1879                 if obj.__class__ != type:
   1880                     return sage_getsourcelines(obj.__class__)

/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/misc/sageinspect.pyc in sage_getsourcelines(obj, is_binary)
   1863         if pos is None:
   1864             try:
-> 1865                 return inspect.getsourcelines(obj)
   1866             except IOError:
   1867                 if (not hasattr(obj, '__class__')) or hasattr(obj,'__metaclass__'):

/home/king/Sage/git/sage/local/lib/python/inspect.pyc in getsourcelines(object)
    688     original source file the first line of code was found.  An IOError is
    689     raised if the source code cannot be retrieved."""
--> 690     lines, lnum = findsource(object)
    691 
    692     if ismodule(object): return lines, 0

/home/king/Sage/git/sage/local/lib/python2.7/site-packages/IPython/core/ultratb.pyc in findsource(object)
    149     FIXED version with which we monkeypatch the stdlib to work around a bug."""
    150 
--> 151     file = getsourcefile(object) or getfile(object)
    152     # If the object is a frame, then trying to get the globals dict from its
    153     # module won't work. Instead, the frame object itself has the globals

/home/king/Sage/git/sage/local/lib/python/inspect.pyc in getsourcefile(object)
    442     Return None if no way can be identified to get the source.
    443     """
--> 444     filename = getfile(object)
    445     if string.lower(filename[-4:]) in ('.pyc', '.pyo'):
    446         filename = filename[:-4] + '.py'

/home/king/Sage/git/sage/local/lib/python/inspect.pyc in getfile(object)
    406         if hasattr(object, '__file__'):
    407             return object.__file__
--> 408         raise TypeError('{!r} is a built-in class'.format(object))
    409     if ismethod(object):
    410         object = object.im_func

TypeError: <module '__builtin__' (built-in)> is a built-in class
```

So, it detects `B.A` in the wrong location (reason: It tries to find the embedding information from what Cython inserted into the docstring of the class, and if this has none, then it considers the docstring of `__init__`---even if this is not defined in the class but in a super-class!).

Moreover, it cannot get the source lines of `B`, which I think is because we catch an `IOError` but not a `TypeError` raised by `inspect.getsourcelines`.



---

archive/issue_comments_209043.json:
```json
{
    "body": "Catching the `TypeError` does not solve the example above, but it does solve a modified example: If `B` is provided with a docstring, then its source can be detected from the embedding information.\n\nSo, what we should learn: Always provide a docstring!",
    "created_at": "2014-05-08T23:56:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16072",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16072#issuecomment-209043",
    "user": "https://github.com/simon-king-jena"
}
```

Catching the `TypeError` does not solve the example above, but it does solve a modified example: If `B` is provided with a docstring, then its source can be detected from the embedding information.

So, what we should learn: Always provide a docstring!



---

archive/issue_comments_209044.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-05-09T00:16:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16072",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16072#issuecomment-209044",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_209045.json:
```json
{
    "body": "So far, I have no idea how to find the sources of a class that is defined in a Cython file, has no docstring and inherits a documented `__init__` method from some other class. However, *if* the class has a documentation, then we can now correctly detect a nested class.\n\nNote that a nested class defined in a Cython file does not have a dot in its name. However, Cython provides an attribute `__qualname__`, and there one does find the full name, including the dot. I have changed sageinspect to use this (new?) feature.\n\nI suppose now it can really be reviewed. It will be essential for Cythoning sage.categories.category.",
    "created_at": "2014-05-09T00:21:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16072",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16072#issuecomment-209045",
    "user": "https://github.com/simon-king-jena"
}
```

So far, I have no idea how to find the sources of a class that is defined in a Cython file, has no docstring and inherits a documented `__init__` method from some other class. However, *if* the class has a documentation, then we can now correctly detect a nested class.

Note that a nested class defined in a Cython file does not have a dot in its name. However, Cython provides an attribute `__qualname__`, and there one does find the full name, including the dot. I have changed sageinspect to use this (new?) feature.

I suppose now it can really be reviewed. It will be essential for Cythoning sage.categories.category.



---

archive/issue_events_048066.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2014-05-11T14:29:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16072",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16072#event-48066"
}
```



---

archive/issue_comments_209046.json:
```json
{
    "body": "Hey Simon,\n\nOnce you remove line 1643:\n\n```\n....: from sage.misc.nested_class import NestedClassMetaclass\n```\n\nas it is unused in the doctest, LGTM and you can set a positive review.",
    "created_at": "2014-06-13T17:49:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16072",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16072#issuecomment-209046",
    "user": "https://github.com/tscrim"
}
```

Hey Simon,

Once you remove line 1643:

```
....: from sage.misc.nested_class import NestedClassMetaclass
```

as it is unused in the doctest, LGTM and you can set a positive review.



---

archive/issue_comments_209047.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-07-24T06:53:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16072",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16072#issuecomment-209047",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_209048.json:
```json
{
    "body": "I've removed the line from the doctest and since it is a trivial change, I'm going to set this to positive review.\n\n```\nsage -t sageinspect.py\n    [263 tests, 39.52 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 39.9 seconds\n    cpu time: 5.0 seconds\n    cumulative wall time: 39.5 seconds\n```\n\n----\nNew commits:",
    "created_at": "2014-07-24T06:53:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16072",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16072#issuecomment-209048",
    "user": "https://github.com/tscrim"
}
```

I've removed the line from the doctest and since it is a trivial change, I'm going to set this to positive review.

```
sage -t sageinspect.py
    [263 tests, 39.52 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 39.9 seconds
    cpu time: 5.0 seconds
    cumulative wall time: 39.5 seconds
```

----
New commits:



---

archive/issue_comments_209049.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-07-25T05:05:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16072",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16072#issuecomment-209049",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_048067.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-07-25T05:05:43Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16072",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16072#event-48067"
}
```
