# Issue 3938: coercion framework converts built-in types to Sage types when it should not

archive/issues_003938.json:
```json
{
    "body": "This came up while reviewing #2898, which adds a conversion from float to ZZ (for integral values).  After applying that patch, you get:\n\n```\nsage: 1.0r/8\n1/8\n```\n\nThat's because of this code in coerce.pyx, which does a conversion rather than a coercion:\n\n```\n        elif PY_IS_NUMERIC(x):\n            try:\n                x = yp(x)\n                if PY_TYPE_CHECK(yp, type): return x,y\n```\n\nI tried to fix this, but every time I fixed something it broke something else.  I'm going to attach my latest non-working patch, which may or may not be a useful place to start.\n\n[Once this ticket has been reviewed and merged #2898 should be closed]\n\n**Assignee:** @robertwb\n\n**CC:**  cwitty\n\nIssue created by migration from https://trac.sagemath.org/ticket/3938\n\n",
    "closed_at": "2009-01-28T15:22:03Z",
    "created_at": "2008-08-23T21:02:17Z",
    "labels": [
        "component: coercion",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-3.3",
    "title": "coercion framework converts built-in types to Sage types when it should not",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/3938",
    "user": "https://trac.sagemath.org/admin/accounts/users/cwitty"
}
```
This came up while reviewing #2898, which adds a conversion from float to ZZ (for integral values).  After applying that patch, you get:

```
sage: 1.0r/8
1/8
```

That's because of this code in coerce.pyx, which does a conversion rather than a coercion:

```
        elif PY_IS_NUMERIC(x):
            try:
                x = yp(x)
                if PY_TYPE_CHECK(yp, type): return x,y
```

I tried to fix this, but every time I fixed something it broke something else.  I'm going to attach my latest non-working patch, which may or may not be a useful place to start.

[Once this ticket has been reviewed and merged #2898 should be closed]

**Assignee:** @robertwb

**CC:**  cwitty

Issue created by migration from https://trac.sagemath.org/ticket/3938





---

archive/attachments_004116.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac3938-coercion-converts-native.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket3938/trac3938-coercion-converts-native.patch",
    "created_at": "2008-08-24T08:43:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3938",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/robertwb"
}
```



---

archive/issue_comments_029041.json:
```json
{
    "body": "<a id='comment:1'></a>\nI've been playing around with this a bit, simplified your patch some, but one consequence is that \n\n```\nsage: parent(RealField(100)(1.5) + float(1.5)) # good?\n<type 'float'>\nsage: RealField(100)(2^4000) == float('inf')   # bad?\nTrue\n```\n\nThoughts?",
    "created_at": "2008-08-24T08:43:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3938#issuecomment-29041",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:1'></a>
I've been playing around with this a bit, simplified your patch some, but one consequence is that 

```
sage: parent(RealField(100)(1.5) + float(1.5)) # good?
<type 'float'>
sage: RealField(100)(2^4000) == float('inf')   # bad?
True
```

Thoughts?



---

archive/issue_comments_029042.json:
```json
{
    "body": "<a id='comment:2'></a>\nBoth of these changes make float act more like RDF.  I've sometimes wished that comparison operators would coerce to more-precise types instead of less-precise, but that would be a huge change across big parts of Sage; unless such a policy change is made, I think that both consequences are actually good.",
    "created_at": "2008-08-24T22:26:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3938#issuecomment-29042",
    "user": "https://trac.sagemath.org/admin/accounts/users/cwitty"
}
```

<a id='comment:2'></a>
Both of these changes make float act more like RDF.  I've sometimes wished that comparison operators would coerce to more-precise types instead of less-precise, but that would be a huge change across big parts of Sage; unless such a policy change is made, I think that both consequences are actually good.



---

archive/attachments_004117.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "3938-type-coercion-2.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket3938/3938-type-coercion-2.patch",
    "created_at": "2008-08-27T16:13:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3938",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/robertwb"
}
```



---

archive/issue_comments_029043.json:
```json
{
    "body": "",
    "created_at": "2008-08-27T16:13:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3938#issuecomment-29043",
    "user": "https://github.com/robertwb"
}
```





---

archive/attachments_004118.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "3938-type-coercion-3.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket3938/3938-type-coercion-3.patch",
    "created_at": "2008-08-27T16:15:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3938",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/robertwb"
}
```



---

archive/issue_comments_029044.json:
```json
{
    "body": "<a id='comment:3'></a>\nI feel your pain...what a nasty patch to try and write! Well, I finally feel like I've got a correct, working solution. Apply all three patches.",
    "created_at": "2008-08-27T16:15:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3938#issuecomment-29044",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:3'></a>
I feel your pain...what a nasty patch to try and write! Well, I finally feel like I've got a correct, working solution. Apply all three patches.



---

archive/issue_comments_029045.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2008-08-27T16:15:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3938#issuecomment-29045",
    "user": "https://github.com/robertwb"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_029046.json:
```json
{
    "body": "<a id='comment:4'></a>\nCarl,\n\nany chance you could review those three patches?\n\nCheers,\n\nMichael",
    "created_at": "2008-08-30T23:05:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3938#issuecomment-29046",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:4'></a>
Carl,

any chance you could review those three patches?

Cheers,

Michael



---

archive/issue_comments_029047.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -15,3 +15,5 @@\n ```\n \n I tried to fix this, but every time I fixed something it broke something else.  I'm going to attach my latest non-working patch, which may or may not be a useful place to start.\n+\n+[Once this ticket has been reviewed and merged #2898 should be closed]\n``````\n",
    "created_at": "2008-08-30T23:05:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3938#issuecomment-29047",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -15,3 +15,5 @@
 ```
 
 I tried to fix this, but every time I fixed something it broke something else.  I'm going to attach my latest non-working patch, which may or may not be a useful place to start.
+
+[Once this ticket has been reviewed and merged #2898 should be closed]
``````




---

archive/issue_comments_029048.json:
```json
{
    "body": "<a id='comment:5'></a>\nI get\n\n```\nsage: parent(RealField(10)(1) * float(1))\nReal Field with 10 bits of precision\n```\n\nwith the patches applied against 3.1.2.alpha4.",
    "created_at": "2008-09-06T23:13:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3938#issuecomment-29048",
    "user": "https://trac.sagemath.org/admin/accounts/users/anakha"
}
```

<a id='comment:5'></a>
I get

```
sage: parent(RealField(10)(1) * float(1))
Real Field with 10 bits of precision
```

with the patches applied against 3.1.2.alpha4.



---

archive/issue_comments_029049.json:
```json
{
    "body": "<a id='comment:6'></a>\nIs this not the desired behavior?",
    "created_at": "2008-09-08T16:27:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3938#issuecomment-29049",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:6'></a>
Is this not the desired behavior?



---

archive/issue_comments_029050.json:
```json
{
    "body": "<a id='comment:7'></a>\nI thought the goal was to convert to the type with most precision.  It seems I was mistaken and this is trying to convert to the type with less precision.  \n\nIn that case it works and passes a good chunk of the test suite.  (I can't test the rest because of the interfaces/lisp.py failure)\n\nIt also passes its own tests and the code looks good.",
    "created_at": "2008-09-08T17:40:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3938#issuecomment-29050",
    "user": "https://trac.sagemath.org/admin/accounts/users/anakha"
}
```

<a id='comment:7'></a>
I thought the goal was to convert to the type with most precision.  It seems I was mistaken and this is trying to convert to the type with less precision.  

In that case it works and passes a good chunk of the test suite.  (I can't test the rest because of the interfaces/lisp.py failure)

It also passes its own tests and the code looks good.



---

archive/issue_comments_029051.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2008-09-08T17:40:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3938#issuecomment-29051",
    "user": "https://trac.sagemath.org/admin/accounts/users/anakha"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_029052.json:
```json
{
    "body": "<a id='comment:8'></a>\nThis patch causes a Heisenbug:\n\n```\n\nmabshoff@sage:/scratch/mabshoff/release-cycle/sage-3.1.3.alpha0$ ./sage -t -long devel/sage/sage/modular/modsym/ambient.py\nsage -t -long devel/sage/sage/modular/modsym/ambient.py     \n\n------------------------------------------------------------\nUnhandled SIGSEGV: A segmentation fault occured in SAGE.\nThis probably occured because a *compiled* component\nof SAGE has a bug in it (typically accessing invalid memory)\nor is not properly wrapped with _sig_on, _sig_off.\nYou might want to run SAGE under gdb with 'sage -gdb' to debug this.\nSAGE will now terminate (sorry).\n------------------------------------------------------------\n\n\nA mysterious error (perphaps a memory error?) occurred, which may have crashed doctest.\n         [4.6 s]\nexit code: 768\n```\nIt does not happen without \"-long\" and when running \"-long -verbose\" it also seems to pass. I guess it is time to valgrind :)\n\nCheers,\n\nMichael",
    "created_at": "2008-09-19T01:45:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3938#issuecomment-29052",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:8'></a>
This patch causes a Heisenbug:

```

mabshoff@sage:/scratch/mabshoff/release-cycle/sage-3.1.3.alpha0$ ./sage -t -long devel/sage/sage/modular/modsym/ambient.py
sage -t -long devel/sage/sage/modular/modsym/ambient.py     

------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occured in SAGE.
This probably occured because a *compiled* component
of SAGE has a bug in it (typically accessing invalid memory)
or is not properly wrapped with _sig_on, _sig_off.
You might want to run SAGE under gdb with 'sage -gdb' to debug this.
SAGE will now terminate (sorry).
------------------------------------------------------------


A mysterious error (perphaps a memory error?) occurred, which may have crashed doctest.
         [4.6 s]
exit code: 768
```
It does not happen without "-long" and when running "-long -verbose" it also seems to pass. I guess it is time to valgrind :)

Cheers,

Michael



---

archive/issue_comments_029053.json:
```json
{
    "body": "**Changing status** from positive_review to needs_work.",
    "created_at": "2008-09-19T01:45:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3938#issuecomment-29053",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

**Changing status** from positive_review to needs_work.



---

archive/issue_comments_029054.json:
```json
{
    "body": "<a id='comment:10'></a>\nI didn't find the Heisenbug that Michael mentioned.  I rebased the patches against 3.2.3.",
    "created_at": "2009-01-23T02:46:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3938#issuecomment-29054",
    "user": "https://github.com/roed314"
}
```

<a id='comment:10'></a>
I didn't find the Heisenbug that Michael mentioned.  I rebased the patches against 3.2.3.



---

archive/issue_comments_029055.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2009-01-23T02:47:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3938#issuecomment-29055",
    "user": "https://github.com/roed314"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_029056.json:
```json
{
    "body": "<a id='comment:12'></a>\nThanks for rebasing this. Since you're not the one who originally wrote it, do you want to give it a review?",
    "created_at": "2009-01-23T22:05:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3938#issuecomment-29056",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:12'></a>
Thanks for rebasing this. Since you're not the one who originally wrote it, do you want to give it a review?



---

archive/attachments_004119.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "3938.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket3938/3938.patch",
    "created_at": "2009-01-24T07:49:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3938",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/roed314"
}
```



---

archive/issue_comments_029057.json:
```json
{
    "body": "Merged the three patches, added a few fixes to precision.",
    "created_at": "2009-01-24T07:49:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3938#issuecomment-29057",
    "user": "https://github.com/roed314"
}
```

Merged the three patches, added a few fixes to precision.



---

archive/issue_events_011489.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/3938",
    "rename": {
        "from": "coercion framework converts built-in types to Sage types when it should not",
        "to": "[with positive review pending minor fixes] coercion framework converts built-in types to Sage types when it should not"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3938#event-11489"
}
```



---

archive/issue_comments_029058.json:
```json
{
    "body": "<a id='comment:13'></a>\nPatch looks good. Thankfully, David folded everything into one patch. \n\nI have two minor issues, and after these are fixed, I'm happy to give this a positive review. \n\n* There are two long blocks (an `EXAMPLES` and a `TESTS`) that are not indented correctly. \n\n* There are three functions that are moved and one that is new which need doctests. (The moved functions don't necessarily have to have them added, but since it's three functions, it seems worth just adding doctests.)\n\nOnce these are done, I'm happy to give this a positive review.",
    "created_at": "2009-01-24T08:50:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3938#issuecomment-29058",
    "user": "https://github.com/craigcitro"
}
```

<a id='comment:13'></a>
Patch looks good. Thankfully, David folded everything into one patch. 

I have two minor issues, and after these are fixed, I'm happy to give this a positive review. 

* There are two long blocks (an `EXAMPLES` and a `TESTS`) that are not indented correctly. 

* There are three functions that are moved and one that is new which need doctests. (The moved functions don't necessarily have to have them added, but since it's three functions, it seems worth just adding doctests.)

Once these are done, I'm happy to give this a positive review.



---

archive/issue_comments_029059.json:
```json
{
    "body": "<a id='comment:14'></a>\nOK, I'll go ahead and add those doctests.",
    "created_at": "2009-01-24T08:59:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3938#issuecomment-29059",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:14'></a>
OK, I'll go ahead and add those doctests.



---

archive/attachments_004120.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "3938-type-coercion-final.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket3938/3938-type-coercion-final.patch",
    "created_at": "2009-01-24T10:46:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3938",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/robertwb"
}
```



---

archive/issue_comments_029060.json:
```json
{
    "body": "apply only this patch",
    "created_at": "2009-01-24T10:46:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3938#issuecomment-29060",
    "user": "https://github.com/robertwb"
}
```

apply only this patch



---

archive/issue_comments_029061.json:
```json
{
    "body": "<a id='comment:15'></a>\nOK, I added the doctests and fixed the indentation.",
    "created_at": "2009-01-24T10:48:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3938#issuecomment-29061",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:15'></a>
OK, I added the doctests and fixed the indentation.



---

archive/issue_events_011490.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/3938",
    "rename": {
        "from": "[with positive review pending minor fixes] coercion framework converts built-in types to Sage types when it should not",
        "to": "coercion framework converts built-in types to Sage types when it should not"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3938#event-11490"
}
```



---

archive/issue_comments_029062.json:
```json
{
    "body": "**Changing status** from new to positive_review.",
    "created_at": "2009-01-24T11:31:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3938#issuecomment-29062",
    "user": "https://github.com/craigcitro"
}
```

**Changing status** from new to positive_review.



---

archive/issue_comments_029063.json:
```json
{
    "body": "<a id='comment:16'></a>\nLooks good.",
    "created_at": "2009-01-24T11:31:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3938#issuecomment-29063",
    "user": "https://github.com/craigcitro"
}
```

<a id='comment:16'></a>
Looks good.



---

archive/issue_comments_029064.json:
```json
{
    "body": "<a id='comment:17'></a>\nOne fix:\n\n```\n    TypeError: no cannonical coercion from Real Field with 53 bits of precision to Real Field with 100 bits of precision\n```\nneeds to become\n\n```\n    TypeError: no canonical coercion from Real Field with 53 bits of precision to Real Field with 100 bits of precision\n```\n\nI am fixing that in the patch I am applying.\n\nCheers,\n\nMichael",
    "created_at": "2009-01-28T15:15:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3938#issuecomment-29064",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:17'></a>
One fix:

```
    TypeError: no cannonical coercion from Real Field with 53 bits of precision to Real Field with 100 bits of precision
```
needs to become

```
    TypeError: no canonical coercion from Real Field with 53 bits of precision to Real Field with 100 bits of precision
```

I am fixing that in the patch I am applying.

Cheers,

Michael



---

archive/issue_events_011491.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2009-01-28T15:22:03Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/3938",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3938#event-11491"
}
```



---

archive/issue_events_011492.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2009-01-28T15:22:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/3938",
    "milestone": "sage-3.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3938#event-11492"
}
```



---

archive/issue_comments_029065.json:
```json
{
    "body": "<a id='comment:18'></a>\nMerged 3938-type-coercion-final.patch with spelling fix in Sage 3.3.alpha3.\n\nCheers,\n\nMichael",
    "created_at": "2009-01-28T15:22:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3938#issuecomment-29065",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:18'></a>
Merged 3938-type-coercion-final.patch with spelling fix in Sage 3.3.alpha3.

Cheers,

Michael
