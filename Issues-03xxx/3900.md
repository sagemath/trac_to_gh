# Issue 3900: [with patch; positive review] make testing an official pickle jar a part of "make check"

archive/issues_003900.json:
```json
{
    "body": "See #3482 and #3899.\n\nEach copy of Sage should include an official pickle jar that gets tested.  This should go in the data directory. \n\nAssignee: mabshoff\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/3900\n\n",
    "closed_at": "2008-11-19T21:43:17Z",
    "created_at": "2008-08-19T17:50:54Z",
    "labels": [
        "component: build",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-3.2",
    "title": "[with patch; positive review] make testing an official pickle jar a part of \"make check\"",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/3900",
    "user": "https://github.com/williamstein"
}
```
See #3482 and #3899.

Each copy of Sage should include an official pickle jar that gets tested.  This should go in the data directory. 

Assignee: mabshoff

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/3900





---

archive/issue_comments_029420.json:
```json
{
    "body": "Changing assignee from tbd to mabshoff.",
    "created_at": "2008-09-08T08:36:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3900#issuecomment-29420",
    "user": "https://github.com/aghitza"
}
```

Changing assignee from tbd to mabshoff.



---

archive/issue_comments_029421.json:
```json
{
    "body": "Attachment [sage-3900.patch](tarball://root/attachments/some-uuid/ticket3900/sage-3900.patch) by @williamstein created at 2008-10-23 21:25:50",
    "created_at": "2008-10-23T21:25:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3900#issuecomment-29421",
    "user": "https://github.com/williamstein"
}
```

Attachment [sage-3900.patch](tarball://root/attachments/some-uuid/ticket3900/sage-3900.patch) by @williamstein created at 2008-10-23 21:25:50



---

archive/issue_comments_029422.json:
```json
{
    "body": "You must place this tarball in SAGE_ROOT/data and *leave* it compressed.",
    "created_at": "2008-10-23T21:26:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3900#issuecomment-29422",
    "user": "https://github.com/williamstein"
}
```

You must place this tarball in SAGE_ROOT/data and *leave* it compressed.



---

archive/issue_comments_029423.json:
```json
{
    "body": "<a id='comment:2'></a>\nAttachment [pickle_jar.tar.bz2](tarball://root/attachments/some-uuid/ticket3900/pickle_jar.tar.bz2) by @williamstein created at 2008-10-23 21:27:11",
    "created_at": "2008-10-23T21:27:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3900#issuecomment-29423",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:2'></a>
Attachment [pickle_jar.tar.bz2](tarball://root/attachments/some-uuid/ticket3900/pickle_jar.tar.bz2) by @williamstein created at 2008-10-23 21:27:11



---

archive/issue_events_014500.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/3900",
    "rename": {
        "from": "make testing an official pickle jar a part of \"make check\"",
        "to": "[with patch; needs review] make testing an official pickle jar a part of \"make check\""
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3900#event-14500"
}
```



---

archive/issue_events_014501.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2008-10-26T18:11:05Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/3900",
    "milestone": "sage-3.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3900#event-14501"
}
```



---

archive/issue_events_014502.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2008-11-09T17:54:30Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/3900",
    "milestone": "sage-3.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3900#event-14502"
}
```



---

archive/issue_events_014503.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2008-11-09T17:54:30Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/3900",
    "milestone": "sage-3.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3900#event-14503"
}
```



---

archive/issue_comments_029424.json:
```json
{
    "body": "<a id='comment:6'></a>\nI applied the patch, but got\n\n```\nsage -t  devel/sage/sage/structure/sage_object.pyx          **********************************************************************\nFile \"/home/jaap/downloads/sage-3.2.rc1/devel/sage/sage/structure/sage_object.pyx\", line 750:\n    sage: sage.structure.sage_object.unpickle_all(std)\nException raised:\n    Traceback (most recent call last):\n      File \"/home/jaap/downloads/sage-3.2.rc1/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/home/jaap/downloads/sage-3.2.rc1/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/home/jaap/downloads/sage-3.2.rc1/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_18[6]>\", line 1, in <module>\n        sage.structure.sage_object.unpickle_all(std)###line 750:\n    sage: sage.structure.sage_object.unpickle_all(std)\n      File \"sage_object.pyx\", line 764, in sage.structure.sage_object.unpickle_all (sage/structure/sage_object.c:7475)\n    IndexError: list index out of range\n**********************************************************************\n1 items had failures:\n   1 of   7 in __main__.example_18\n***Test Failed*** 1 failures.\nFor whitespace errors, see the file /home/jaap/downloads/sage-3.2.rc1/tmp/.doctest_sage_object.pybunzip2: /home/jaap/downloads/sage-3.2.rc1/data/pickle_jar.tar.bz2 is not a bzip2 file.\ntar: This does not look like a tar archive\ntar: Error exit delayed from previous errors\n\n\t [3.7 s]\n\n```\n\nJaap",
    "created_at": "2008-11-18T15:36:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3900#issuecomment-29424",
    "user": "https://github.com/jaapspies"
}
```

<a id='comment:6'></a>
I applied the patch, but got

```
sage -t  devel/sage/sage/structure/sage_object.pyx          **********************************************************************
File "/home/jaap/downloads/sage-3.2.rc1/devel/sage/sage/structure/sage_object.pyx", line 750:
    sage: sage.structure.sage_object.unpickle_all(std)
Exception raised:
    Traceback (most recent call last):
      File "/home/jaap/downloads/sage-3.2.rc1/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/home/jaap/downloads/sage-3.2.rc1/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/home/jaap/downloads/sage-3.2.rc1/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_18[6]>", line 1, in <module>
        sage.structure.sage_object.unpickle_all(std)###line 750:
    sage: sage.structure.sage_object.unpickle_all(std)
      File "sage_object.pyx", line 764, in sage.structure.sage_object.unpickle_all (sage/structure/sage_object.c:7475)
    IndexError: list index out of range
**********************************************************************
1 items had failures:
   1 of   7 in __main__.example_18
***Test Failed*** 1 failures.
For whitespace errors, see the file /home/jaap/downloads/sage-3.2.rc1/tmp/.doctest_sage_object.pybunzip2: /home/jaap/downloads/sage-3.2.rc1/data/pickle_jar.tar.bz2 is not a bzip2 file.
tar: This does not look like a tar archive
tar: Error exit delayed from previous errors

	 [3.7 s]

```

Jaap



---

archive/issue_events_014504.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/3900",
    "rename": {
        "from": "[with patch; needs review] make testing an official pickle jar a part of \"make check\"",
        "to": "[with patch; positive review] make testing an official pickle jar a part of \"make check\""
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3900#event-14504"
}
```



---

archive/issue_comments_029425.json:
```json
{
    "body": "<a id='comment:7'></a>\nSorry for the noise.\n\nNow I put in the correct file and all's well\n\n\n```\n[jaap@paix sage-3.2.rc1]$ ./sage -t  devel/sage/sage/structure/sage_object.pyx\nsage -t  devel/sage/sage/structure/sage_object.pyx          \n\t [6.6 s]\n \n----------------------------------------------------------------------\nAll tests passed!\n\nSo positive review.\n\n\n```",
    "created_at": "2008-11-18T15:42:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3900#issuecomment-29425",
    "user": "https://github.com/jaapspies"
}
```

<a id='comment:7'></a>
Sorry for the noise.

Now I put in the correct file and all's well


```
[jaap@paix sage-3.2.rc1]$ ./sage -t  devel/sage/sage/structure/sage_object.pyx
sage -t  devel/sage/sage/structure/sage_object.pyx          
	 [6.6 s]
 
----------------------------------------------------------------------
All tests passed!

So positive review.


```



---

archive/issue_comments_029426.json:
```json
{
    "body": "<a id='comment:8'></a>\nWe need to deal with -sdist and -bdist copying pickle_jar.tar.bz2. One way to do this would be to check the file into the repo, but that seems like a bad idea. \n\nThoughts?\n\nCheers,\n\nMichael",
    "created_at": "2008-11-18T18:11:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3900#issuecomment-29426",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:8'></a>
We need to deal with -sdist and -bdist copying pickle_jar.tar.bz2. One way to do this would be to check the file into the repo, but that seems like a bad idea. 

Thoughts?

Cheers,

Michael



---

archive/issue_comments_029427.json:
```json
{
    "body": "<a id='comment:9'></a>\nHi folks,\n\nthere does not seem to be any problem with binary distributions, once that file \"pickle_jar.tar.bz2\" exists. See line 52 of the \"sage-bdist\" script, where among others the complete subtree under /data is copied over.\n\nAs for source distributions, essentially the distribution of the file \"pickle_jar.tar.bz2\" is not necessary --- it can be (re-)produced from any source distribution by a (very) short sequence of commands that does not change. In that sense it's a \"build output\". For convenience, one might think about having a make target \"make pickle_jar\".\n\nBut since the doctest introduced by this patch requires the prior existence of this file \"pickle_jar.tar.bz2\", and since maybe we don't want to produce updated pickle jars for each and every Sage version in say the alpha release cycles, a simplistic spkg could be the solution:\n\n\"sage_pickle_jar-X.Y.Z.spkg\" containing just the three files \"spkg-install\", \"SPKG.txt\", and \"pickle_jar.tar.bz2\"; and spkg-install just issue a single \"cp\" command.\nThen, e.g. Sage version 3.3.2.alpha4 could still contain the spkg \"sage_pickle_jar-3.3.1.spkg\".\n\nTo make the creation of updated versions of this simplistic spkg easier, using the existing scripts machinery, it would be advisable not to use the directory \"data/\" to store the file \"pickle_jar.tar.bz2\", but instead the directory \"data/sage_pickle_jar/\",\nand storing there all these three files. (So a simple \"spkg -pkg ...\" does the job of creating the updated spkg.)\n\nOf course the naming could also be \"std_pickle_jar\" instead, or similar.\n\nI'd volunteer to create and test the needed script \"spkg-install\" resp. that simplistic spkg, opening another ticket for it, if someone gives me a \"Yep. Good idea. Go for it!\". Then the usual review process would take its course, and this ticket would depend on that other ticket. \n\nCheers,\n\ngsw",
    "created_at": "2008-11-19T21:19:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3900#issuecomment-29427",
    "user": "https://trac.sagemath.org/admin/accounts/users/GeorgSWeber"
}
```

<a id='comment:9'></a>
Hi folks,

there does not seem to be any problem with binary distributions, once that file "pickle_jar.tar.bz2" exists. See line 52 of the "sage-bdist" script, where among others the complete subtree under /data is copied over.

As for source distributions, essentially the distribution of the file "pickle_jar.tar.bz2" is not necessary --- it can be (re-)produced from any source distribution by a (very) short sequence of commands that does not change. In that sense it's a "build output". For convenience, one might think about having a make target "make pickle_jar".

But since the doctest introduced by this patch requires the prior existence of this file "pickle_jar.tar.bz2", and since maybe we don't want to produce updated pickle jars for each and every Sage version in say the alpha release cycles, a simplistic spkg could be the solution:

"sage_pickle_jar-X.Y.Z.spkg" containing just the three files "spkg-install", "SPKG.txt", and "pickle_jar.tar.bz2"; and spkg-install just issue a single "cp" command.
Then, e.g. Sage version 3.3.2.alpha4 could still contain the spkg "sage_pickle_jar-3.3.1.spkg".

To make the creation of updated versions of this simplistic spkg easier, using the existing scripts machinery, it would be advisable not to use the directory "data/" to store the file "pickle_jar.tar.bz2", but instead the directory "data/sage_pickle_jar/",
and storing there all these three files. (So a simple "spkg -pkg ..." does the job of creating the updated spkg.)

Of course the naming could also be "std_pickle_jar" instead, or similar.

I'd volunteer to create and test the needed script "spkg-install" resp. that simplistic spkg, opening another ticket for it, if someone gives me a "Yep. Good idea. Go for it!". Then the usual review process would take its course, and this ticket would depend on that other ticket. 

Cheers,

gsw



---

archive/issue_comments_029428.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [GeorgSWeber](#comment%3A9):\n> Hi folks,\n> \n> there does not seem to be any problem with binary distributions, once that file \"pickle_jar.tar.bz2\" exists. See line 52 of the \"sage-bdist\" script, where among others the complete subtree under /data is copied over.\n\n\nMaybe, but in which spkg does the data directory end up? I can see the content of extcode, but not the data directory itself.\n\n> As for source distributions, essentially the distribution of the file \"pickle_jar.tar.bz2\" is not necessary --- it can be (re-)produced from any source distribution by a (very) short sequence of commands that does not change. In that sense it's a \"build output\". For convenience, one might think about having a make target \"make pickle_jar\".\n\n\nThe point is that the *old* pickle jar works.\n\n> But since the doctest introduced by this patch requires the prior existence of this file \"pickle_jar.tar.bz2\", and since maybe we don't want to produce updated pickle jars for each and every Sage version in say the alpha release cycles, a simplistic spkg could be the solution:\n> \n> \"sage_pickle_jar-X.Y.Z.spkg\" containing just the three files \"spkg-install\", \"SPKG.txt\", and \"pickle_jar.tar.bz2\"; and spkg-install just issue a single \"cp\" command.\n> Then, e.g. Sage version 3.3.2.alpha4 could still contain the spkg \"sage_pickle_jar-3.3.1.spkg\".\n> \n> To make the creation of updated versions of this simplistic spkg easier, using the existing scripts machinery, it would be advisable not to use the directory \"data/\" to store the file \"pickle_jar.tar.bz2\", but instead the directory \"data/sage_pickle_jar/\",\n> and storing there all these three files. (So a simple \"spkg -pkg ...\" does the job of creating the updated spkg.)\n\n\nWe don't want another spkg - that idea was rejected. I am not 100% clear why, but that is what lead to this problem in the first place.\n\n> Of course the naming could also be \"std_pickle_jar\" instead, or similar.\n> \n> I'd volunteer to create and test the needed script \"spkg-install\" resp. that simplistic spkg, opening another ticket for it, if someone gives me a \"Yep. Good idea. Go for it!\". Then the usual review process would take its course, and this ticket would depend on that other ticket. \n> \n> Cheers,\n\n\n> gsw\n\n\nThe easiest solution IMHO would be to check the archive into $SAGE_ROOT/data/extcode/pickle_jar and adjust the path in the patch here.\n\nCheers,\n\nMichael",
    "created_at": "2008-11-19T21:31:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3900#issuecomment-29428",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:10'></a>
Replying to [GeorgSWeber](#comment%3A9):
> Hi folks,
> 
> there does not seem to be any problem with binary distributions, once that file "pickle_jar.tar.bz2" exists. See line 52 of the "sage-bdist" script, where among others the complete subtree under /data is copied over.


Maybe, but in which spkg does the data directory end up? I can see the content of extcode, but not the data directory itself.

> As for source distributions, essentially the distribution of the file "pickle_jar.tar.bz2" is not necessary --- it can be (re-)produced from any source distribution by a (very) short sequence of commands that does not change. In that sense it's a "build output". For convenience, one might think about having a make target "make pickle_jar".


The point is that the *old* pickle jar works.

> But since the doctest introduced by this patch requires the prior existence of this file "pickle_jar.tar.bz2", and since maybe we don't want to produce updated pickle jars for each and every Sage version in say the alpha release cycles, a simplistic spkg could be the solution:
> 
> "sage_pickle_jar-X.Y.Z.spkg" containing just the three files "spkg-install", "SPKG.txt", and "pickle_jar.tar.bz2"; and spkg-install just issue a single "cp" command.
> Then, e.g. Sage version 3.3.2.alpha4 could still contain the spkg "sage_pickle_jar-3.3.1.spkg".
> 
> To make the creation of updated versions of this simplistic spkg easier, using the existing scripts machinery, it would be advisable not to use the directory "data/" to store the file "pickle_jar.tar.bz2", but instead the directory "data/sage_pickle_jar/",
> and storing there all these three files. (So a simple "spkg -pkg ..." does the job of creating the updated spkg.)


We don't want another spkg - that idea was rejected. I am not 100% clear why, but that is what lead to this problem in the first place.

> Of course the naming could also be "std_pickle_jar" instead, or similar.
> 
> I'd volunteer to create and test the needed script "spkg-install" resp. that simplistic spkg, opening another ticket for it, if someone gives me a "Yep. Good idea. Go for it!". Then the usual review process would take its course, and this ticket would depend on that other ticket. 
> 
> Cheers,


> gsw


The easiest solution IMHO would be to check the archive into $SAGE_ROOT/data/extcode/pickle_jar and adjust the path in the patch here.

Cheers,

Michael



---

archive/issue_comments_029429.json:
```json
{
    "body": "<a id='comment:11'></a>\nOn closer inspection: we don't even have to check in the pickle jar into the ext repo, so I will just put it in there.\n\nCheers,\n\nMichael",
    "created_at": "2008-11-19T21:34:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3900#issuecomment-29429",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:11'></a>
On closer inspection: we don't even have to check in the pickle jar into the ext repo, so I will just put it in there.

Cheers,

Michael



---

archive/issue_comments_029430.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2008-11-19T21:43:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3900#issuecomment-29430",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

Resolution: fixed



---

archive/issue_comments_029431.json:
```json
{
    "body": "<a id='comment:12'></a>\nMerged in Sage 3.2.rc2",
    "created_at": "2008-11-19T21:43:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3900#issuecomment-29431",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:12'></a>
Merged in Sage 3.2.rc2



---

archive/issue_events_014505.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2008-11-19T21:43:17Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/3900",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3900#event-14505"
}
```
