# Issue 3934: [with patches; positive review] Eta product modular functions

archive/issues_003934.json:
```json
{
    "body": "At the Heilbronn Institute workshop \"Computations with Modular Forms\", Ken McMurdy requested code for handling eta products on X_0(N). Theory background and wish-list here: http://maths.pratum.net/CMF/resources/McMurdyTalk.pdf.\n\nAssignee: @loefflerd\n\nResolution: fixed\n\nAuthor: David Loeffler\n\nReviewer: John Cremona\n\nMerged: 3.2.alpha1\n\nIssue created by migration from https://trac.sagemath.org/ticket/3934\n\n",
    "closed_at": "2008-10-26T04:06:40Z",
    "created_at": "2008-08-23T11:46:53Z",
    "labels": [
        "component: modular forms",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-3.2",
    "title": "[with patches; positive review] Eta product modular functions",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/3934",
    "user": "https://github.com/loefflerd"
}
```
At the Heilbronn Institute workshop "Computations with Modular Forms", Ken McMurdy requested code for handling eta products on X_0(N). Theory background and wish-list here: http://maths.pratum.net/CMF/resources/McMurdyTalk.pdf.

Assignee: @loefflerd

Resolution: fixed

Author: David Loeffler

Reviewer: John Cremona

Merged: 3.2.alpha1

Issue created by migration from https://trac.sagemath.org/ticket/3934





---

archive/issue_events_009034.json:
```json
{
    "actor": "https://github.com/loefflerd",
    "created_at": "2008-08-23T11:56:07Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/3934",
    "milestone": "sage-feature",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3934#event-9034"
}
```



---

archive/issue_comments_028856.json:
```json
{
    "body": "Changing status from new to assigned.",
    "created_at": "2008-08-23T11:56:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3934",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3934#issuecomment-28856",
    "user": "https://github.com/loefflerd"
}
```

Changing status from new to assigned.



---

archive/issue_comments_028857.json:
```json
{
    "body": "Attachment [10292.patch](tarball://root/attachments/some-uuid/ticket3934/10292.patch) by @loefflerd created at 2008-08-24 12:09:19\n\nFirst version: patch against sage 3.1.1",
    "created_at": "2008-08-24T12:09:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3934",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3934#issuecomment-28857",
    "user": "https://github.com/loefflerd"
}
```

Attachment [10292.patch](tarball://root/attachments/some-uuid/ticket3934/10292.patch) by @loefflerd created at 2008-08-24 12:09:19

First version: patch against sage 3.1.1



---

archive/issue_comments_028858.json:
```json
{
    "body": "<a id='comment:3'></a>Patch applies fine to 3.1.1.  Doctests for the new file pass.\n\nProblem:  doctesting all in sage/modular, some strange errors appear in modular/abvar to do with latex.  They went away when I deleted the line \"... import latex\" in the new file, which is not actually used anyway.\n\nIn the constructor, in checking Ligozat, you loop over divisors of N.  Would it not be faster to loop over the keys in the dict?  There is then no need to factor N, or to look at (however briefly) the divisors which are not in the dict.\n\nThere is something similar at line 146.  Instead of \n\n```\n eta_n = max([ (n/d).floor() for d in divisors(self.level()) if self.r(d) != 0])\n```\nyou could write \n\n```\n eta_n = max([ (n/d).floor() for d in self.r().keys()]) \n```\n\nIf you really wanted to have the full list of divisors of the level around, you could compute it and cache the result in the constructor.\n\nIn the function r(d) you can just say\n\n```\n   return self._rdict.get(d,0)\n```\nsince the get function on a dict returns the value if the key is there or a default value (here 0) if not.\n\nThat's all I have time for now: I got as far as line 235 (def basis_eta_products).",
    "created_at": "2008-08-24T17:51:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3934",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3934#issuecomment-28858",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:3'></a>Patch applies fine to 3.1.1.  Doctests for the new file pass.

Problem:  doctesting all in sage/modular, some strange errors appear in modular/abvar to do with latex.  They went away when I deleted the line "... import latex" in the new file, which is not actually used anyway.

In the constructor, in checking Ligozat, you loop over divisors of N.  Would it not be faster to loop over the keys in the dict?  There is then no need to factor N, or to look at (however briefly) the divisors which are not in the dict.

There is something similar at line 146.  Instead of 

```
 eta_n = max([ (n/d).floor() for d in divisors(self.level()) if self.r(d) != 0])
```
you could write 

```
 eta_n = max([ (n/d).floor() for d in self.r().keys()]) 
```

If you really wanted to have the full list of divisors of the level around, you could compute it and cache the result in the constructor.

In the function r(d) you can just say

```
   return self._rdict.get(d,0)
```
since the get function on a dict returns the value if the key is there or a default value (here 0) if not.

That's all I have time for now: I got as far as line 235 (def basis_eta_products).



---

archive/issue_comments_028859.json:
```json
{
    "body": "<a id='comment:4'></a>Thanks very much for the comments. Since that first version was written I have realised a much better way of fitting the code into Sage's object hierarchy; I will combine that with your suggestions and submit a new version.",
    "created_at": "2008-08-26T18:00:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3934",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3934#issuecomment-28859",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:4'></a>Thanks very much for the comments. Since that first version was written I have realised a much better way of fitting the code into Sage's object hierarchy; I will combine that with your suggestions and submit a new version.



---

archive/issue_comments_028860.json:
```json
{
    "body": "Attachment [10293.patch](tarball://root/attachments/some-uuid/ticket3934/10293.patch) by @loefflerd created at 2008-08-27 14:19:40",
    "created_at": "2008-08-27T14:19:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3934",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3934#issuecomment-28860",
    "user": "https://github.com/loefflerd"
}
```

Attachment [10293.patch](tarball://root/attachments/some-uuid/ticket3934/10293.patch) by @loefflerd created at 2008-08-27 14:19:40



---

archive/issue_comments_028861.json:
```json
{
    "body": "<a id='comment:5'></a>OK, here's a second attempt (patch to be installed on top of the first attempt). I've refactored it extensively, creating a new class EtaGroup which is the parent of eta product objects; changed it so it doesn't use divisors() unless it really has to; and added a new module-level function eta_poly_relations which finds polynomial relations between two eta products.",
    "created_at": "2008-08-27T14:23:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3934",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3934#issuecomment-28861",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:5'></a>OK, here's a second attempt (patch to be installed on top of the first attempt). I've refactored it extensively, creating a new class EtaGroup which is the parent of eta product objects; changed it so it doesn't use divisors() unless it really has to; and added a new module-level function eta_poly_relations which finds polynomial relations between two eta products.



---

archive/issue_comments_028862.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:5 davidloeffler]:\n> OK, here's a second attempt (patch to be installed on top of the first attempt). I've refactored it extensively, creating a new class EtaGroup which is the parent of eta product objects; changed it so it doesn't use divisors() unless it really has to; and added a new module-level function eta_poly_relations which finds polynomial relations between two eta products.\n\n\nExcellent -- I will review this right away.  John",
    "created_at": "2008-08-27T14:50:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3934",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3934#issuecomment-28862",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:6'></a>Replying to [comment:5 davidloeffler]:
> OK, here's a second attempt (patch to be installed on top of the first attempt). I've refactored it extensively, creating a new class EtaGroup which is the parent of eta product objects; changed it so it doesn't use divisors() unless it really has to; and added a new module-level function eta_poly_relations which finds polynomial relations between two eta products.


Excellent -- I will review this right away.  John



---

archive/issue_comments_028863.json:
```json
{
    "body": "Apply after the previous two patches",
    "created_at": "2008-08-27T15:36:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3934",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3934#issuecomment-28863",
    "user": "https://github.com/JohnCremona"
}
```

Apply after the previous two patches



---

archive/issue_comments_028864.json:
```json
{
    "body": "<a id='comment:7'></a>Attachment [10294.patch](tarball://root/attachments/some-uuid/ticket3934/10294.patch) by @JohnCremona created at 2008-08-27 15:37:13\n\nReview summary:  This is a great piece of work, especially after the second patch.  I have made a few changes, detailed below, which are in the 3rd patch.\n\n* I changed the type-checking of the level parameter so that it forces it to be a Sage integer.  This is a good idea since some integer methods would not work if the level was a Python integer, and it also allows you to say `EtaGroup_class(4/2)` should you ever want to.\n\n* docstring for EtaGroup_class.basis() had a spurious redundant INPUT line (N)\n\n* I added a little more type and value checking of parameters\n\n* In  eta_poly_relations there is a lot of output which cannot be turned off.   Why not include a parameter verbose, default False, and only print the output if it is True?  I put this in and changed the doctests accordingly.\n\n* I commented out the NotImplemented plot function, as it seemed pointless to have it!\n\nCoverage test gives this:\n\n```\n ./sage -coverage devel/sage-eta/sage/modular/etaproducts.py \n\ndevel/sage-eta/sage/modular/etaproducts.py\nERROR: Please define a s == loads(dumps(s)) doctest.\nSCORE devel/sage-eta/sage/modular/etaproducts.py: 74% (23 of 31)\n\nMissing documentation:\n\t * __init__(self, level)\n\t * _repr_(self)\n\t * __call__(self, dict)\n\t * __init__(self, parent, rdict)\n\t * __cmp__(self, other)\n\t * __eq__(self, other)\n\t * _short_repr(self)\n\t * _eta_relations_helper(eta1, eta2, degree, qexp_terms, labels, verbose)\n\n\nPossibly wrong (function name doesn't occur in doctests):\n\t * _mul_(self, other)\n\t * _div_(self, other)\n\t * _repr_(self)\n\t * _repr_(self)\n```\nI have never been sure about the loads(dumps) message.  Apart from that all functions which are not preceded by an underscore have docstrings and doctests, which is the main thing:  it would be better if they had a little documentation, but then you'll get the complaint that they should also have doctests.\n\n\nConclusion:  I am very happy with this, but it would be even better if someone who knows a lot more about eta products (such as Ken McMurdy) could put it through its paces.",
    "created_at": "2008-08-27T15:37:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3934",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3934#issuecomment-28864",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:7'></a>Attachment [10294.patch](tarball://root/attachments/some-uuid/ticket3934/10294.patch) by @JohnCremona created at 2008-08-27 15:37:13

Review summary:  This is a great piece of work, especially after the second patch.  I have made a few changes, detailed below, which are in the 3rd patch.

* I changed the type-checking of the level parameter so that it forces it to be a Sage integer.  This is a good idea since some integer methods would not work if the level was a Python integer, and it also allows you to say `EtaGroup_class(4/2)` should you ever want to.

* docstring for EtaGroup_class.basis() had a spurious redundant INPUT line (N)

* I added a little more type and value checking of parameters

* In  eta_poly_relations there is a lot of output which cannot be turned off.   Why not include a parameter verbose, default False, and only print the output if it is True?  I put this in and changed the doctests accordingly.

* I commented out the NotImplemented plot function, as it seemed pointless to have it!

Coverage test gives this:

```
 ./sage -coverage devel/sage-eta/sage/modular/etaproducts.py 

devel/sage-eta/sage/modular/etaproducts.py
ERROR: Please define a s == loads(dumps(s)) doctest.
SCORE devel/sage-eta/sage/modular/etaproducts.py: 74% (23 of 31)

Missing documentation:
	 * __init__(self, level)
	 * _repr_(self)
	 * __call__(self, dict)
	 * __init__(self, parent, rdict)
	 * __cmp__(self, other)
	 * __eq__(self, other)
	 * _short_repr(self)
	 * _eta_relations_helper(eta1, eta2, degree, qexp_terms, labels, verbose)


Possibly wrong (function name doesn't occur in doctests):
	 * _mul_(self, other)
	 * _div_(self, other)
	 * _repr_(self)
	 * _repr_(self)
```
I have never been sure about the loads(dumps) message.  Apart from that all functions which are not preceded by an underscore have docstrings and doctests, which is the main thing:  it would be better if they had a little documentation, but then you'll get the complaint that they should also have doctests.


Conclusion:  I am very happy with this, but it would be even better if someone who knows a lot more about eta products (such as Ken McMurdy) could put it through its paces.



---

archive/issue_comments_028865.json:
```json
{
    "body": "<a id='comment:8'></a>Ok, anything going on here? The patches here have been bitrotting for a while and it would be nice if someone wrote the missing doctests. In order to have the right report pick it up I am renaming it to \"needs work\".\n\nCheers,\n\nMichael",
    "created_at": "2008-09-23T00:19:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3934",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3934#issuecomment-28865",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:8'></a>Ok, anything going on here? The patches here have been bitrotting for a while and it would be nice if someone wrote the missing doctests. In order to have the right report pick it up I am renaming it to "needs work".

Cheers,

Michael



---

archive/issue_comments_028866.json:
```json
{
    "body": "<a id='comment:9'></a>David,\n\nIf you are happy with the additions I made then we can get this accepted soon.  I have not yet tried applying the patches to 3.1.3.*.  John",
    "created_at": "2008-09-23T08:07:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3934",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3934#issuecomment-28866",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:9'></a>David,

If you are happy with the additions I made then we can get this accepted soon.  I have not yet tried applying the patches to 3.1.3.*.  John



---

archive/issue_comments_028867.json:
```json
{
    "body": "<a id='comment:10'></a>I'm very happy with John's changes. I've sent a copy to Ken McMurdy for review; he said he'll reply by September 26th. I doubt that bit rot will be a problem with this one as it's a single new source file which is entirely self-contained.\n\nI'll get to work on the missing doctests and post a new patch.\n\nDavid",
    "created_at": "2008-09-23T09:33:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3934",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3934#issuecomment-28867",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:10'></a>I'm very happy with John's changes. I've sent a copy to Ken McMurdy for review; he said he'll reply by September 26th. I doubt that bit rot will be a problem with this one as it's a single new source file which is entirely self-contained.

I'll get to work on the missing doctests and post a new patch.

David



---

archive/issue_comments_028868.json:
```json
{
    "body": "<a id='comment:11'></a>Attachment [10295.patch](tarball://root/attachments/some-uuid/ticket3934/10295.patch) by @loefflerd created at 2008-09-23 10:35:57\n\nI've added doctests for the underscore methods, and a loads(dumps()) test; sage -coverage now returns 100%.",
    "created_at": "2008-09-23T10:35:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3934",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3934#issuecomment-28868",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:11'></a>Attachment [10295.patch](tarball://root/attachments/some-uuid/ticket3934/10295.patch) by @loefflerd created at 2008-09-23 10:35:57

I've added doctests for the underscore methods, and a loads(dumps()) test; sage -coverage now returns 100%.



---

archive/issue_comments_028869.json:
```json
{
    "body": "<a id='comment:12'></a>Excellent!  I just checked that the sequence of 4 patches applies cleanly to 3.1.3.alpha0, and all tests in sage/modular pass.\n\nLet it roll: even if Ken McMurdy suggests changes and additions, why not merge this now?\n\nI'll inform Lloyd, Gabor and Lassina about this once it is merged, since it sefinitely a success story coming out of their August workshop.",
    "created_at": "2008-09-23T11:15:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3934",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3934#issuecomment-28869",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:12'></a>Excellent!  I just checked that the sequence of 4 patches applies cleanly to 3.1.3.alpha0, and all tests in sage/modular pass.

Let it roll: even if Ken McMurdy suggests changes and additions, why not merge this now?

I'll inform Lloyd, Gabor and Lassina about this once it is merged, since it sefinitely a success story coming out of their August workshop.



---

archive/issue_comments_028870.json:
```json
{
    "body": "<a id='comment:13'></a>Cremona gave this a positive review (above), so I'm changing the heading.",
    "created_at": "2008-10-23T16:18:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3934",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3934#issuecomment-28870",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:13'></a>Cremona gave this a positive review (above), so I'm changing the heading.



---

archive/issue_comments_028871.json:
```json
{
    "body": "<a id='comment:14'></a>I'm also changing this to target 3.2",
    "created_at": "2008-10-23T16:18:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3934",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3934#issuecomment-28871",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:14'></a>I'm also changing this to target 3.2



---

archive/issue_events_009035.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2008-10-23T16:18:21Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/3934",
    "milestone": "sage-feature",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3934#event-9035"
}
```



---

archive/issue_events_009036.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2008-10-23T16:18:21Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/3934",
    "milestone": "sage-3.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3934#event-9036"
}
```



---

archive/issue_events_009037.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2008-10-26T04:06:40Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/3934",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3934#event-9037"
}
```



---

archive/issue_comments_028872.json:
```json
{
    "body": "<a id='comment:15'></a>Merged all four patches in Sage 3.2.alpha1",
    "created_at": "2008-10-26T04:06:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3934",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3934#issuecomment-28872",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:15'></a>Merged all four patches in Sage 3.2.alpha1



---

archive/issue_comments_028873.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2008-10-26T04:06:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3934",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3934#issuecomment-28873",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

Resolution: fixed
