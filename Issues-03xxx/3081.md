# Issue 3081: Added support for Kloosterman sums

archive/issues_003081.json:
```json
{
    "body": "This (nearly trivial patch) adds support for exact and numerical evaluation of \"twisted\" Kloosterman sums. This generalizes Gauss sums, Salie sums and normal Kloosterman sums. \n\n\n**Assignee:** @williamstein\n\n**CC:**  @ncalexan\n\n**Keywords:** editor_craigcitro\n\nIssue created by migration from https://trac.sagemath.org/ticket/3081\n\n",
    "closed_at": "2009-04-12T20:53:10Z",
    "created_at": "2008-05-02T15:05:31Z",
    "labels": [
        "component: number theory",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-3.4.1",
    "title": "Added support for Kloosterman sums",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/3081",
    "user": "https://trac.sagemath.org/admin/accounts/users/kkilger"
}
```
This (nearly trivial patch) adds support for exact and numerical evaluation of "twisted" Kloosterman sums. This generalizes Gauss sums, Salie sums and normal Kloosterman sums. 


**Assignee:** @williamstein

**CC:**  @ncalexan

**Keywords:** editor_craigcitro

Issue created by migration from https://trac.sagemath.org/ticket/3081





---

archive/issue_comments_021183.json:
```json
{
    "body": "**Changing assignee** from mabshoff to @williamstein.",
    "created_at": "2008-05-02T15:10:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3081",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3081#issuecomment-21183",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

**Changing assignee** from mabshoff to @williamstein.



---

archive/issue_comments_021184.json:
```json
{
    "body": "<a id='comment:1'></a>\nHi Kilian,\n\nAside from the fact that this is a number theory ticket everything looks good. Hopefully somebody will review this patch shortly.\n\nCheers,\n\nMichael",
    "created_at": "2008-05-02T15:10:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3081",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3081#issuecomment-21184",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:1'></a>
Hi Kilian,

Aside from the fact that this is a number theory ticket everything looks good. Hopefully somebody will review this patch shortly.

Cheers,

Michael



---

archive/attachments_002975.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "dirichlet2.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket3081/dirichlet2.patch",
    "created_at": "2008-05-02T15:13:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3081",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://trac.sagemath.org/admin/accounts/users/kkilger"
}
```



---

archive/issue_comments_021185.json:
```json
{
    "body": "",
    "created_at": "2008-05-02T15:13:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3081",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3081#issuecomment-21185",
    "user": "https://trac.sagemath.org/admin/accounts/users/kkilger"
}
```





---

archive/issue_comments_021186.json:
```json
{
    "body": "<a id='comment:2'></a>\nThis sounds extremely cool!\nWhat is based on? I can't get it to apply on either 3.0 or 3.0.1.alpha1.",
    "created_at": "2008-05-02T15:23:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3081",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3081#issuecomment-21186",
    "user": "https://github.com/wdjoyner"
}
```

<a id='comment:2'></a>
This sounds extremely cool!
What is based on? I can't get it to apply on either 3.0 or 3.0.1.alpha1.



---

archive/issue_comments_021187.json:
```json
{
    "body": "<a id='comment:3'></a>\nQUESTION:\n\nYou've rewritten some of the functions to be more general, e.g., this\n\n```\n707\t \t            z *= zeta \n708\t \t            g += phi(c)*z \n```\nbecomes this:\n\n```\n763\t                z = zeta ** (a*e + b*(e**(-1))) \n764\t                g += phi(self.__call__(c))*z        \n```\n\nWhat impact does this have on performance in the original case of computing Gauss\nsums?  Is it slower or faster or the same?\n\nAlso, why use \n\n```\nself.__call__(c)\n```\ninstead of \n\n```\nself(c)\n```\n?",
    "created_at": "2008-05-02T15:27:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3081",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3081#issuecomment-21187",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:3'></a>
QUESTION:

You've rewritten some of the functions to be more general, e.g., this

```
707	 	            z *= zeta 
708	 	            g += phi(c)*z 
```
becomes this:

```
763	                z = zeta ** (a*e + b*(e**(-1))) 
764	                g += phi(self.__call__(c))*z        
```

What impact does this have on performance in the original case of computing Gauss
sums?  Is it slower or faster or the same?

Also, why use 

```
self.__call__(c)
```
instead of 

```
self(c)
```
?



---

archive/issue_comments_021188.json:
```json
{
    "body": "<a id='comment:4'></a>\nIt computes the modular inverse every time. So it should be somewhat slower as before. I read that there is an ongoing discussion between code duplication and speed ...  \n\nI wanted to use this to introduce Poincare series in SAGE (and compute their Fourier coefficients) but this is far to slow. I am planning to reimplement the numerical stuff in C/Cython next week (or this weekend). \n\nQuestion: Why are Dirichlet characters in modular/dirichlet.py? Is it for historical reasons?\n\nRegards,\nKilian.",
    "created_at": "2008-05-02T15:50:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3081",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3081#issuecomment-21188",
    "user": "https://trac.sagemath.org/admin/accounts/users/kkilger"
}
```

<a id='comment:4'></a>
It computes the modular inverse every time. So it should be somewhat slower as before. I read that there is an ongoing discussion between code duplication and speed ...  

I wanted to use this to introduce Poincare series in SAGE (and compute their Fourier coefficients) but this is far to slow. I am planning to reimplement the numerical stuff in C/Cython next week (or this weekend). 

Question: Why are Dirichlet characters in modular/dirichlet.py? Is it for historical reasons?

Regards,
Kilian.



---

archive/issue_comments_021189.json:
```json
{
    "body": "<a id='comment:5'></a>\nP.S.: ... oh. I will change self.__call__(c) to self(c). I have to get used to python ;-).",
    "created_at": "2008-05-02T15:54:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3081",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3081#issuecomment-21189",
    "user": "https://trac.sagemath.org/admin/accounts/users/kkilger"
}
```

<a id='comment:5'></a>
P.S.: ... oh. I will change self.__call__(c) to self(c). I have to get used to python ;-).



---

archive/issue_comments_021190.json:
```json
{
    "body": "<a id='comment:6'></a>\nP.P.S: It should be based on 3.0 ...",
    "created_at": "2008-05-02T15:59:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3081",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3081#issuecomment-21190",
    "user": "https://trac.sagemath.org/admin/accounts/users/kkilger"
}
```

<a id='comment:6'></a>
P.P.S: It should be based on 3.0 ...



---

archive/issue_comments_021191.json:
```json
{
    "body": "<a id='comment:7'></a>\n> Question: Why are Dirichlet characters in modular/dirichlet.py? Is it for historical reasons?\n\n\nYep, Historical reasons.  Where would you want to put it.\n\n> It computes the modular inverse every time. So it should be somewhat \n> slower as before. I read that there is an ongoing discussion between \n> code duplication and speed ...\n\n\nWorrisome, but like you say below it is too slow in the first place. \n\n> I wanted to use this to introduce Poincare series in SAGE (and compute their \n> Fourier coefficients) but this is far to slow. I am planning to reimplement \n> the numerical stuff in C/Cython next week (or this weekend). \n\n\nExcellent!\n\n -- William",
    "created_at": "2008-05-02T16:08:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3081",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3081#issuecomment-21191",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:7'></a>
> Question: Why are Dirichlet characters in modular/dirichlet.py? Is it for historical reasons?


Yep, Historical reasons.  Where would you want to put it.

> It computes the modular inverse every time. So it should be somewhat 
> slower as before. I read that there is an ongoing discussion between 
> code duplication and speed ...


Worrisome, but like you say below it is too slow in the first place. 

> I wanted to use this to introduce Poincare series in SAGE (and compute their 
> Fourier coefficients) but this is far to slow. I am planning to reimplement 
> the numerical stuff in C/Cython next week (or this weekend). 


Excellent!

 -- William



---

archive/issue_comments_021192.json:
```json
{
    "body": "<a id='comment:8'></a>\n> Yep, Historical reasons. Where would you want to put it.\n\n\nAre there some other character groups implemented? Perhaps it should go to the dual groups?\n\nAnother question:\n\nIf I compute for example the Kloosterman sum K(2,4,13) in Magma it returns:\n2*zeta_13^10 + 2*zeta_13^9 + 2*zeta_13^7 + 2*zeta_13^6 + 2*zeta_13^4 + 2*zeta_13^3\n\nIf I compute it with SAGE it returns:\n2*zeta156^40 - 2*zeta156^34 + 2*zeta156^28 - 2*zeta156^24 + 2*zeta156^18 - 2*zeta156^14 - 2*zeta156^12 + 2*zeta156^8 - 2*zeta156^2 - 2\n\nThis is the same number but it is much more reduced in MAGMA. The corresponding MAGMA code is:\n\n> Kloosterman := func< u, v, n |\n>     &+[z^(IntegerRing() ! (u*x+v*x^-1)) : x in F | IsUnit(x) ]\n>         where z is RootOfUnity(n, CyclotomicField(n))\n>         where F is ResidueClassRing(n) >;\n\n\nKilian.",
    "created_at": "2008-05-02T17:25:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3081",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3081#issuecomment-21192",
    "user": "https://trac.sagemath.org/admin/accounts/users/kkilger"
}
```

<a id='comment:8'></a>
> Yep, Historical reasons. Where would you want to put it.


Are there some other character groups implemented? Perhaps it should go to the dual groups?

Another question:

If I compute for example the Kloosterman sum K(2,4,13) in Magma it returns:
2*zeta_13^10 + 2*zeta_13^9 + 2*zeta_13^7 + 2*zeta_13^6 + 2*zeta_13^4 + 2*zeta_13^3

If I compute it with SAGE it returns:
2*zeta156^40 - 2*zeta156^34 + 2*zeta156^28 - 2*zeta156^24 + 2*zeta156^18 - 2*zeta156^14 - 2*zeta156^12 + 2*zeta156^8 - 2*zeta156^2 - 2

This is the same number but it is much more reduced in MAGMA. The corresponding MAGMA code is:

> Kloosterman := func< u, v, n |
>     &+[z^(IntegerRing() ! (u*x+v*x^-1)) : x in F | IsUnit(x) ]
>         where z is RootOfUnity(n, CyclotomicField(n))
>         where F is ResidueClassRing(n) >;


Kilian.



---

archive/issue_comments_021193.json:
```json
{
    "body": "<a id='comment:9'></a>\nAgain ... I forgot the code block\n\nMagma-Number:\n\n```\n2*zeta_13^10 + 2*zeta_13^9 + 2*zeta_13^7 + 2*zeta_13^6 + 2*zeta_13^4 + 2*zeta_13^3\n```\n\nSAGE-Number:\n\n```\n2*zeta156^40 - 2*zeta156^34 + 2*zeta156^28 - 2*zeta156^24 + 2*zeta156^18 - 2*zeta156^14 - 2*zeta156^12 + 2*zeta156^8 - 2*zeta156^2 - 2\n```\n\nMagma-Code:\n\n```\n>  Kloosterman := func< u, v, n |\n>      &+[z^(IntegerRing() ! (u*x+v*x^-1)) : x in F | IsUnit(x) ]\n>          where z is RootOfUnity(n, CyclotomicField(n))\n>          where F is ResidueClassRing(n) >;\n```",
    "created_at": "2008-05-02T17:28:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3081",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3081#issuecomment-21193",
    "user": "https://trac.sagemath.org/admin/accounts/users/kkilger"
}
```

<a id='comment:9'></a>
Again ... I forgot the code block

Magma-Number:

```
2*zeta_13^10 + 2*zeta_13^9 + 2*zeta_13^7 + 2*zeta_13^6 + 2*zeta_13^4 + 2*zeta_13^3
```

SAGE-Number:

```
2*zeta156^40 - 2*zeta156^34 + 2*zeta156^28 - 2*zeta156^24 + 2*zeta156^18 - 2*zeta156^14 - 2*zeta156^12 + 2*zeta156^8 - 2*zeta156^2 - 2
```

Magma-Code:

```
>  Kloosterman := func< u, v, n |
>      &+[z^(IntegerRing() ! (u*x+v*x^-1)) : x in F | IsUnit(x) ]
>          where z is RootOfUnity(n, CyclotomicField(n))
>          where F is ResidueClassRing(n) >;
```



---

archive/issue_comments_021194.json:
```json
{
    "body": "**Changing keywords** from \"\" to \"editor_craigcitro\".",
    "created_at": "2008-06-15T21:40:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3081",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3081#issuecomment-21194",
    "user": "https://github.com/craigcitro"
}
```

**Changing keywords** from "" to "editor_craigcitro".



---

archive/issue_events_008741.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/3081",
    "rename": {
        "from": "Added support for Kloosterman sums",
        "to": "[with patch; under review by ncalexan before 7/1] Added support for Kloosterman sums"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3081#event-8741"
}
```



---

archive/issue_comments_021195.json:
```json
{
    "body": "<a id='comment:12'></a>\nNick,\n\nanything going on here?\n\nCheers,\n\nMichael",
    "created_at": "2008-09-25T00:18:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3081",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3081#issuecomment-21195",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:12'></a>
Nick,

anything going on here?

Cheers,

Michael



---

archive/issue_comments_021196.json:
```json
{
    "body": "<a id='comment:13'></a>\nFrom Nick:\n\n```\nI seem to remember thinking this code was mildly flawed (easily fixed) and not fast.  But please pass it on to someone more tuned in.\n```",
    "created_at": "2008-10-30T18:07:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3081",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3081#issuecomment-21196",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:13'></a>
From Nick:

```
I seem to remember thinking this code was mildly flawed (easily fixed) and not fast.  But please pass it on to someone more tuned in.
```



---

archive/issue_events_008742.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/3081",
    "rename": {
        "from": "[with patch; under review by ncalexan before 7/1] Added support for Kloosterman sums",
        "to": "Added support for Kloosterman sums"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3081#event-8742"
}
```



---

archive/issue_comments_021197.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2008-10-30T18:07:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3081",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3081#issuecomment-21197",
    "user": "https://github.com/williamstein"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_021198.json:
```json
{
    "body": "<a id='comment:14'></a>\nREFEREE REPORT:\n\nThis patch needs work.  Just totally delete the first part of the patch that\nreplaces lines 636-652 by nothing and calls kloosterman_sum, since kloosterman_sum is much slower.  Just leave the code like it used to be.\n\nOtherwise, i think the code is good to have included in sage.    In particular, the issue the author raises about the representation of a certain output and a root of unity is interesting, but not something to stop this patch from going in.\n\nSo I think with some very obvious simple work, this can easily be included.  Just delete the part that will slow down the gauss_sum.",
    "created_at": "2008-11-28T04:39:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3081",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3081#issuecomment-21198",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:14'></a>
REFEREE REPORT:

This patch needs work.  Just totally delete the first part of the patch that
replaces lines 636-652 by nothing and calls kloosterman_sum, since kloosterman_sum is much slower.  Just leave the code like it used to be.

Otherwise, i think the code is good to have included in sage.    In particular, the issue the author raises about the representation of a certain output and a root of unity is interesting, but not something to stop this patch from going in.

So I think with some very obvious simple work, this can easily be included.  Just delete the part that will slow down the gauss_sum.



---

archive/issue_comments_021199.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2008-11-28T04:39:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3081",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3081#issuecomment-21199",
    "user": "https://github.com/williamstein"
}
```

**Changing status** from needs_review to needs_work.



---

archive/attachments_002976.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "kloosterman.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket3081/kloosterman.patch",
    "created_at": "2009-04-11T14:22:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3081",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://trac.sagemath.org/admin/accounts/users/kkilger"
}
```



---

archive/issue_comments_021200.json:
```json
{
    "body": "Repaired patch",
    "created_at": "2009-04-11T14:22:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3081",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3081#issuecomment-21200",
    "user": "https://trac.sagemath.org/admin/accounts/users/kkilger"
}
```

Repaired patch



---

archive/issue_comments_021201.json:
```json
{
    "body": "<a id='comment:15'></a>\nSorry ... a bit late but what comes late is better than everything what comes never :-)",
    "created_at": "2009-04-11T14:25:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3081",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3081#issuecomment-21201",
    "user": "https://trac.sagemath.org/admin/accounts/users/kkilger"
}
```

<a id='comment:15'></a>
Sorry ... a bit late but what comes late is better than everything what comes never :-)



---

archive/issue_comments_021202.json:
```json
{
    "body": "<a id='comment:16'></a>\nJust changing the title so this gets noticed.",
    "created_at": "2009-04-11T15:55:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3081",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3081#issuecomment-21202",
    "user": "https://github.com/craigcitro"
}
```

<a id='comment:16'></a>
Just changing the title so this gets noticed.



---

archive/issue_comments_021203.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2009-04-11T15:55:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3081",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3081#issuecomment-21203",
    "user": "https://github.com/craigcitro"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_021204.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2009-04-12T08:14:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3081",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3081#issuecomment-21204",
    "user": "https://github.com/williamstein"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_events_008743.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2009-04-12T20:53:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/3081",
    "milestone": "sage-3.4.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3081#event-8743"
}
```



---

archive/issue_comments_021205.json:
```json
{
    "body": "<a id='comment:18'></a>\nMerged kloosterman.patch in Sage 3.4.1.rc3.\n\nCheers,\n\nMichael",
    "created_at": "2009-04-12T20:53:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3081",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3081#issuecomment-21205",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:18'></a>
Merged kloosterman.patch in Sage 3.4.1.rc3.

Cheers,

Michael



---

archive/issue_events_008744.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2009-04-12T20:53:10Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/3081",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3081#event-8744"
}
```



---

archive/issue_comments_021206.json:
```json
{
    "body": "<a id='comment:19'></a>\nI just notices that this patch uses tabs instead of spaces. In Sage we do not use tabs but spaces, so please adjust your editor.\n\nCheers,\n\nMichael",
    "created_at": "2009-04-18T08:20:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3081",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3081#issuecomment-21206",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:19'></a>
I just notices that this patch uses tabs instead of spaces. In Sage we do not use tabs but spaces, so please adjust your editor.

Cheers,

Michael
