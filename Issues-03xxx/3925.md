# Issue 3925: [with SPKG] Wrap Bernstein 's primegen

archive/issues_003925.json:
```json
{
    "body": "See http://cr.yp.to/primegen.html\n\nSome code at http://thread.gmane.org/gmane.comp.python.cython.devel/2579/focus=2581\n\n\n**Assignee:** @williamstein\n\n**CC:**  mvngu kevin.stueve\n\n**Status:** needs_work\n\nIssue created by migration from https://trac.sagemath.org/ticket/3925\n\n",
    "created_at": "2008-08-22T08:06:19Z",
    "labels": [
        "component: number theory"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "[with SPKG] Wrap Bernstein 's primegen",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/3925",
    "user": "https://github.com/robertwb"
}
```
See http://cr.yp.to/primegen.html

Some code at http://thread.gmane.org/gmane.comp.python.cython.devel/2579/focus=2581


**Assignee:** @williamstein

**CC:**  mvngu kevin.stueve

**Status:** needs_work

Issue created by migration from https://trac.sagemath.org/ticket/3925





---

archive/issue_comments_032576.json:
```json
{
    "body": "<a id='comment:1'></a>\nI added some checks and doctests, and made Primes() use this.\n\nThis is still a work-in-progress. TODO:\n\n* Turn primegen-0.97 into a .spkg. It needs an added -fPIC option since it will be linked into a cython extension module.\n\n* Make sage.rings.arith.primes(start,stop) also use this for n not too small and not too large.\n\n* Determine if there are predefined portable uint32/uint64 types available for use in cython.",
    "created_at": "2009-07-12T12:25:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3925",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3925#issuecomment-32576",
    "user": "https://github.com/wjp"
}
```

<a id='comment:1'></a>
I added some checks and doctests, and made Primes() use this.

This is still a work-in-progress. TODO:

* Turn primegen-0.97 into a .spkg. It needs an added -fPIC option since it will be linked into a cython extension module.

* Make sage.rings.arith.primes(start,stop) also use this for n not too small and not too large.

* Determine if there are predefined portable uint32/uint64 types available for use in cython.



---

archive/issue_events_011748.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mvngu",
    "created_at": "2009-07-12T12:31:59Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/3925",
    "milestone": "sage-4.1.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3925#event-11748"
}
```



---

archive/attachments_004097.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "primegen-0.97.spkg",
    "asset_url": "tarball://root/attachments/some-uuid/ticket3925/primegen-0.97.spkg",
    "created_at": "2009-07-13T21:48:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3925",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.spkg",
    "user": "https://github.com/wjp"
}
```



---

archive/issue_comments_032577.json:
```json
{
    "body": "",
    "created_at": "2009-07-13T21:48:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3925",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3925#issuecomment-32577",
    "user": "https://github.com/wjp"
}
```





---

archive/attachments_004098.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac-3925-spkg_deps.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket3925/trac-3925-spkg_deps.patch",
    "created_at": "2009-07-13T21:48:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3925",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/wjp"
}
```



---

archive/issue_comments_032578.json:
```json
{
    "body": "",
    "created_at": "2009-07-13T21:48:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3925",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3925#issuecomment-32578",
    "user": "https://github.com/wjp"
}
```





---

archive/issue_events_011749.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/3925",
    "rename": {
        "from": "Wrap Bernstein 's primegen",
        "to": "[with SPKG] Wrap Bernstein 's primegen"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3925#event-11749"
}
```



---

archive/issue_comments_032579.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2009-07-13T22:00:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3925",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3925#issuecomment-32579",
    "user": "https://github.com/wjp"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_032580.json:
```json
{
    "body": "<a id='comment:4'></a>\nI've added an attempt at an .spkg for primegen-0.97 as an attachment, and also took the liberty of patching (untested...) spkg/install and spkg/standard/deps to build it automatically when installing sage. (In the 'spkg_deps' patch.)\n\nI'm not entirely confident the build system of the library will work everywhere, since it is rather non-standard, but hopefully it is portable enough.\n\nThe library is tiny, with the .spkg only 32KB, and the compiled (Linux x86_64) library only 17KB.\n\nTiming:\n\n```\ndef f():    \n    P = Primes()\n    for p in P:\n        if p > 10^8:\n            break\ntime f()\n```\n\ngoes from 84.17s (without this spkg+patch) to 20.77s (with spkg+patch) on a 2GHz Opteron.",
    "created_at": "2009-07-13T22:00:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3925",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3925#issuecomment-32580",
    "user": "https://github.com/wjp"
}
```

<a id='comment:4'></a>
I've added an attempt at an .spkg for primegen-0.97 as an attachment, and also took the liberty of patching (untested...) spkg/install and spkg/standard/deps to build it automatically when installing sage. (In the 'spkg_deps' patch.)

I'm not entirely confident the build system of the library will work everywhere, since it is rather non-standard, but hopefully it is portable enough.

The library is tiny, with the .spkg only 32KB, and the compiled (Linux x86_64) library only 17KB.

Timing:

```
def f():    
    P = Primes()
    for p in P:
        if p > 10^8:
            break
time f()
```

goes from 84.17s (without this spkg+patch) to 20.77s (with spkg+patch) on a 2GHz Opteron.



---

archive/attachments_004099.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac-3925-primegen.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket3925/trac-3925-primegen.patch",
    "created_at": "2009-07-24T21:14:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3925",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/JohnCremona"
}
```



---

archive/issue_comments_032581.json:
```json
{
    "body": "<a id='comment:5'></a>\nHello Willem.  I successfully installed the spkg and the second patch but I don't know how to install the first patch as it changes files not in the usual code tree.  If you tell me how, I would like to test this.  -- John",
    "created_at": "2009-07-24T21:14:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3925",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3925#issuecomment-32581",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:5'></a>
Hello Willem.  I successfully installed the spkg and the second patch but I don't know how to install the first patch as it changes files not in the usual code tree.  If you tell me how, I would like to test this.  -- John



---

archive/issue_comments_032582.json:
```json
{
    "body": "<a id='comment:6'></a>\nHi John. The first patch isn't necessary to use the spkg. It's only for making a fresh 'make' of sage automatically build the spkg. I'm not too sure sure if that patch is right, actually; that part should probably be left to a release manager.",
    "created_at": "2009-07-24T23:27:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3925",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3925#issuecomment-32582",
    "user": "https://github.com/wjp"
}
```

<a id='comment:6'></a>
Hi John. The first patch isn't necessary to use the spkg. It's only for making a fresh 'make' of sage automatically build the spkg. I'm not too sure sure if that patch is right, actually; that part should probably be left to a release manager.



---

archive/issue_comments_032583.json:
```json
{
    "body": "<a id='comment:7'></a>\nReplying to [wjp](#comment%3A6):\n> Hi John. The first patch isn't necessary to use the spkg. It's only for making a fresh 'make' of sage automatically build the spkg. I'm not too sure sure if that patch is right, actually; that part should probably be left to a release manager.\n\n\nOK, I'll have another go sometime this weekend.  I'm glad about the first patch, since I'm not really competent to say if it's right (though it looks ok).",
    "created_at": "2009-07-25T09:00:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3925",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3925#issuecomment-32583",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:7'></a>
Replying to [wjp](#comment%3A6):
> Hi John. The first patch isn't necessary to use the spkg. It's only for making a fresh 'make' of sage automatically build the spkg. I'm not too sure sure if that patch is right, actually; that part should probably be left to a release manager.


OK, I'll have another go sometime this weekend.  I'm glad about the first patch, since I'm not really competent to say if it's right (though it looks ok).



---

archive/issue_comments_032584.json:
```json
{
    "body": "<a id='comment:8'></a>\nTo adopt this spkg as part of Sage\nproper would need a vote on sage-devel.  I suggest that wjp helps that process\nby collecting some data (before and after).  For example:\n\n```\nsage: time P = prime_range(10^8)\nCPU times: user 1.83 s, sys: 0.50 s, total: 2.32 s\nWall time: 2.33 s\nsage: len(P)\n5761455\n```\nbut this does not use the new PrimeGen class.  I tried this (with the\nnew spkg + patch):\n\n```\nsage: pg=Primes().pg\nsage: pg.reset()\nsage: N=pg.count(10^8)\nsage: pg.reset()\nsage: time P=[pg.next() for _ in range(N)]\nCPU times: user 4.98 s, sys: 0.03 s, total: 5.01 s\nWall time: 5.02 s\n```\nwhich is slower but it's using a more stupid method to collect the\nprimes that in prime_range().",
    "created_at": "2009-07-26T09:58:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3925",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3925#issuecomment-32584",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:8'></a>
To adopt this spkg as part of Sage
proper would need a vote on sage-devel.  I suggest that wjp helps that process
by collecting some data (before and after).  For example:

```
sage: time P = prime_range(10^8)
CPU times: user 1.83 s, sys: 0.50 s, total: 2.32 s
Wall time: 2.33 s
sage: len(P)
5761455
```
but this does not use the new PrimeGen class.  I tried this (with the
new spkg + patch):

```
sage: pg=Primes().pg
sage: pg.reset()
sage: N=pg.count(10^8)
sage: pg.reset()
sage: time P=[pg.next() for _ in range(N)]
CPU times: user 4.98 s, sys: 0.03 s, total: 5.01 s
Wall time: 5.02 s
```
which is slower but it's using a more stupid method to collect the
primes that in prime_range().



---

archive/issue_comments_032585.json:
```json
{
    "body": "<a id='comment:9'></a>\nChanging this to \"needs work\" given John's latest comments.  Note that \"work\" here would mean making the case to sage-devel that the spkg should be adopted, and asking for a vote.",
    "created_at": "2009-08-16T08:27:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3925",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3925#issuecomment-32585",
    "user": "https://github.com/aghitza"
}
```

<a id='comment:9'></a>
Changing this to "needs work" given John's latest comments.  Note that "work" here would mean making the case to sage-devel that the spkg should be adopted, and asking for a vote.



---

archive/issue_comments_032586.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2009-08-16T08:27:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3925",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3925#issuecomment-32586",
    "user": "https://github.com/aghitza"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_032587.json:
```json
{
    "body": "**Upstream:** N/A",
    "created_at": "2009-12-21T15:23:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3925",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3925#issuecomment-32587",
    "user": "https://trac.sagemath.org/admin/accounts/users/kevin.stueve"
}
```

**Upstream:** N/A



---

archive/issue_events_011750.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/3925",
    "milestone": "sage-4.1.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3925#event-11750"
}
```



---

archive/issue_events_011751.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/3925",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3925#event-11751"
}
```



---

archive/issue_events_011752.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/3925",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3925#event-11752"
}
```



---

archive/issue_events_011753.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/3925",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3925#event-11753"
}
```



---

archive/issue_events_011754.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/3925",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3925#event-11754"
}
```



---

archive/issue_events_011755.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/3925",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3925#event-11755"
}
```



---

archive/issue_events_011756.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/3925",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3925#event-11756"
}
```



---

archive/issue_events_011757.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/3925",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3925#event-11757"
}
```
