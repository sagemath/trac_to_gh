# Issue 3704: make diagonal_matrix accept much more general arguments

archive/issues_003704.json:
```json
{
    "assignees": [],
    "body": "So I think this is a bug \n\n```\nsage: w=vector(RR,[1,2,3])\nsage: d=diagonal_matrix(w)\nUnboundLocalError: local variable 'v' referenced before assignment\n```\nThe following fails as well\n\n```\nsage: d=diagonal_matrix(RR,w) \n```\nthe only thing that works is \n\n```\nsage: d=diagonal_matrix(RR,list(w))\n```\nA stupid but easy fix is to try to turn any argument to diagonal_matrix into a list before bailing out (its in matrix/constructor.py), but there should probably be logic actually expecting vectors and analyzing the parents?\n\n**Assignee:** @williamstein\n\nIssue created by migration from https://trac.sagemath.org/ticket/3704\n\n",
    "closed_at": "2009-01-28T14:12:34Z",
    "created_at": "2008-07-22T04:35:52Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20linear%20algebra",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-3.3",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "make diagonal_matrix accept much more general arguments",
    "type": "issue",
    "updated_at": "2009-01-28T14:12:34Z",
    "url": "https://github.com/sagemath/sage/issues/3704",
    "user": "https://github.com/sagetrac-jkantor"
}
```
So I think this is a bug 

```
sage: w=vector(RR,[1,2,3])
sage: d=diagonal_matrix(w)
UnboundLocalError: local variable 'v' referenced before assignment
```
The following fails as well

```
sage: d=diagonal_matrix(RR,w) 
```
the only thing that works is 

```
sage: d=diagonal_matrix(RR,list(w))
```
A stupid but easy fix is to try to turn any argument to diagonal_matrix into a list before bailing out (its in matrix/constructor.py), but there should probably be logic actually expecting vectors and analyzing the parents?

**Assignee:** @williamstein

Issue created by migration from https://trac.sagemath.org/ticket/3704





---

archive/issue_events_033171.json:
```json
{
    "actor": "https://github.com/sagetrac-jkantor",
    "created_at": "2008-07-22T04:35:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "milestone_number": null,
    "milestone_title": "sage-3.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/3704#event-33171"
}
```



---

archive/issue_events_033172.json:
```json
{
    "actor": "https://github.com/sagetrac-jkantor",
    "created_at": "2008-07-22T04:35:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20linear%20algebra",
    "label_color": "08517b",
    "label_name": "component: linear algebra",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/3704#event-33172"
}
```



---

archive/issue_events_033173.json:
```json
{
    "actor": "https://github.com/sagetrac-jkantor",
    "created_at": "2008-07-22T04:35:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "label": "https://github.com/sagemath/sage/labels/minor",
    "label_color": "ff0000",
    "label_name": "minor",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/3704#event-33173"
}
```



---

archive/issue_events_033174.json:
```json
{
    "actor": "https://github.com/sagetrac-jkantor",
    "created_at": "2008-07-22T04:35:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "008080",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/3704#event-33174"
}
```



---

archive/issue_comments_021225.json:
```json
{
    "body": "<a id='comment:1'>**Comment 1:**</a>\nWould it be easy as taking the argument to diagonal_matrix and sending it through Sequence?\n\n```\nsage: v=vector(QQ,[1,2,3/4])\nsage: v\n(1, 2, 3/4)\nsage: b=diagonal_matrix(Sequence(v)); b\n\n[  1   0   0]\n[  0   2   0]\n[  0   0 3/4]\nsage: b.parent()\nFull MatrixSpace of 3 by 3 dense matrices over Rational Field\n```",
    "created_at": "2008-07-22T14:52:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/3704#issuecomment-21225",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:1'>**Comment 1:**</a>
Would it be easy as taking the argument to diagonal_matrix and sending it through Sequence?

```
sage: v=vector(QQ,[1,2,3/4])
sage: v
(1, 2, 3/4)
sage: b=diagonal_matrix(Sequence(v)); b

[  1   0   0]
[  0   2   0]
[  0   0 3/4]
sage: b.parent()
Full MatrixSpace of 3 by 3 dense matrices over Rational Field
```



---

archive/issue_events_033175.json:
```json
{
    "actor": "https://github.com/jasongrout",
    "created_at": "2008-07-22T16:37:39Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "label": "https://github.com/sagemath/sage/labels/minor",
    "label_color": "ff0000",
    "label_name": "minor",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/3704#event-33175"
}
```



---

archive/issue_comments_021226.json:
```json
{
    "body": "<a id='comment:2'>**Comment 2:**</a>\nThe attached patch is a complete rewrite of diagonal_matrix which now does the following:\n\n1. If the first argument is a ring, pop it off the argument list\n2. If the next thing can be made into a Sequence, do so and use those elements as the diagonal elements.  If the next thing cannot be made into a sequence, then take the remainder of the argument list and use those things as the diagonal elements.\n3. Prepend the ring if one was specified and send everything to the matrix() function.\n\nThis changes the syntax slightly; in order to get a matrix of a specific size, you need to pass an nrows and/or ncols option.  But it is very nice in that it allows diagonal_matrix(1,2,3) or, as mentioned in this ticket, diagonal_matrix(v) where v is a vector.\n\nAll doctests in sage/matrix/* pass and all doctests elsewhere that I found using diagonal_matrix also pass.",
    "created_at": "2008-07-22T16:37:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/3704#issuecomment-21226",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:2'>**Comment 2:**</a>
The attached patch is a complete rewrite of diagonal_matrix which now does the following:

1. If the first argument is a ring, pop it off the argument list
2. If the next thing can be made into a Sequence, do so and use those elements as the diagonal elements.  If the next thing cannot be made into a sequence, then take the remainder of the argument list and use those things as the diagonal elements.
3. Prepend the ring if one was specified and send everything to the matrix() function.

This changes the syntax slightly; in order to get a matrix of a specific size, you need to pass an nrows and/or ncols option.  But it is very nice in that it allows diagonal_matrix(1,2,3) or, as mentioned in this ticket, diagonal_matrix(v) where v is a vector.

All doctests in sage/matrix/* pass and all doctests elsewhere that I found using diagonal_matrix also pass.



---

archive/issue_events_033176.json:
```json
{
    "actor": "https://github.com/jasongrout",
    "created_at": "2008-07-22T16:37:39Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "rename": {
        "from": "diagonal_matrix does not accept vectors",
        "to": "make diagonal_matrix accept much more general arguments"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/3704#event-33176"
}
```



---

archive/issue_events_033177.json:
```json
{
    "actor": "https://github.com/jasongrout",
    "created_at": "2008-07-22T16:37:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/3704#event-33177"
}
```



---

archive/issue_events_033178.json:
```json
{
    "actor": "https://github.com/jasongrout",
    "created_at": "2008-07-22T16:37:50Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "008080",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/3704#event-33178"
}
```



---

archive/issue_events_033179.json:
```json
{
    "actor": "https://github.com/jasongrout",
    "created_at": "2008-07-22T16:37:50Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "008080",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/3704#event-33179"
}
```



---

archive/issue_comments_021227.json:
```json
{
    "body": "<a id='comment:4'>**Comment 4:**</a>\nI guess it really is a defect, as pointed about above; there is a bug that is fixed.",
    "created_at": "2008-07-22T16:38:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/3704#issuecomment-21227",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:4'>**Comment 4:**</a>
I guess it really is a defect, as pointed about above; there is a bug that is fixed.



---

archive/issue_events_033180.json:
```json
{
    "actor": "https://github.com/jasongrout",
    "created_at": "2008-07-22T16:38:13Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "008080",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/3704#event-33180"
}
```



---

archive/issue_events_033181.json:
```json
{
    "actor": "https://github.com/jasongrout",
    "created_at": "2008-07-22T16:38:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "008080",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/3704#event-33181"
}
```



---

archive/issue_events_033182.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2008-07-25T19:45:49Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "milestone_number": null,
    "milestone_title": "sage-3.0.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/3704#event-33182"
}
```



---

archive/issue_events_033183.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2008-07-25T19:45:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "milestone_number": null,
    "milestone_title": "sage-3.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/3704#event-33183"
}
```



---

archive/issue_comments_021228.json:
```json
{
    "body": "<a id='comment:6'>**Comment 6:**</a>\nI generally like this patch, and it provides useful functionality.\n\nI applied th patch to 3.0.4 with no problem and all tests in\nsage/matrix pass.\n\nTwo things seemed strange to me:\n\n1. I cannot see a reason for the provided facility for padding\n    with zeros when nrows is given explicitly.  I just cannot think of\n    a time when anyone would need this!\n\n2. The example  diagonal_matrix(GF(2),GF(5))  is really crazy.\n    [It returns a diagonal matrix of size 5 and entries 0,1,0,1,0,\n    using a list of the elements of GF(5) coerced into GF(2)!]\n\n    This is surely a weird side-effect rather than a useful example.\n    the same result would come from diagonal_matrix(GF(2),range(5))\n    which is a little more sane.\n\nThat last example would not even work if it were not possible to\ncoerce from GF(5) to GF(2).  And I really think that should not be\npossible.  Does it still happen in the \"new coercion model\", I wonder?",
    "created_at": "2008-07-29T01:58:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/3704#issuecomment-21228",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:6'>**Comment 6:**</a>
I generally like this patch, and it provides useful functionality.

I applied th patch to 3.0.4 with no problem and all tests in
sage/matrix pass.

Two things seemed strange to me:

1. I cannot see a reason for the provided facility for padding
    with zeros when nrows is given explicitly.  I just cannot think of
    a time when anyone would need this!

2. The example  diagonal_matrix(GF(2),GF(5))  is really crazy.
    [It returns a diagonal matrix of size 5 and entries 0,1,0,1,0,
    using a list of the elements of GF(5) coerced into GF(2)!]

    This is surely a weird side-effect rather than a useful example.
    the same result would come from diagonal_matrix(GF(2),range(5))
    which is a little more sane.

That last example would not even work if it were not possible to
coerce from GF(5) to GF(2).  And I really think that should not be
possible.  Does it still happen in the "new coercion model", I wonder?



---

archive/issue_events_033184.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2008-07-29T01:58:01Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "rename": {
        "from": "make diagonal_matrix accept much more general arguments",
        "to": "[positve  review with mild reservations] make diagonal_matrix accept much more general arguments"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/3704#event-33184"
}
```



---

archive/issue_comments_021229.json:
```json
{
    "body": "<a id='comment:7'>**Comment 7:**</a>\nThe patch looks mostly good, but I heartily agree with points (1) and (2). Also, the following gives an undesired result: \n\n```\nsage: diagonal_matrix(x^3+3, x+1)\n```\n\nIf a ring is specified, it is converted even if there is no coercion. This allows stuff like\n\n```\nsage: matrix(GF(101), 2, [1, 1/2, 1/3, 1/4])\n[ 1 51]\n[34 76]\n```\n\ndespite there being no coercion QQ -> GF(101).",
    "created_at": "2008-07-29T08:41:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/3704#issuecomment-21229",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:7'>**Comment 7:**</a>
The patch looks mostly good, but I heartily agree with points (1) and (2). Also, the following gives an undesired result: 

```
sage: diagonal_matrix(x^3+3, x+1)
```

If a ring is specified, it is converted even if there is no coercion. This allows stuff like

```
sage: matrix(GF(101), 2, [1, 1/2, 1/3, 1/4])
[ 1 51]
[34 76]
```

despite there being no coercion QQ -> GF(101).



---

archive/issue_comments_021230.json:
```json
{
    "body": "<a id='comment:8'>**Comment 8:**</a>\nThe patch looks mostly good, but I heartily agree with points (1) and (2). Also, the following gives an undesired result: \n\n```\nsage: diagonal_matrix(x^3+3, x+1)\n```\n\nIf a ring is specified, it is converted even if there is no coercion. This allows stuff like\n\n```\nsage: matrix(GF(101), 2, [1, 1/2, 1/3, 1/4])\n[ 1 51]\n[34 76]\n```\n\ndespite there being no coercion QQ -> GF(101).",
    "created_at": "2008-07-29T08:42:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/3704#issuecomment-21230",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:8'>**Comment 8:**</a>
The patch looks mostly good, but I heartily agree with points (1) and (2). Also, the following gives an undesired result: 

```
sage: diagonal_matrix(x^3+3, x+1)
```

If a ring is specified, it is converted even if there is no coercion. This allows stuff like

```
sage: matrix(GF(101), 2, [1, 1/2, 1/3, 1/4])
[ 1 51]
[34 76]
```

despite there being no coercion QQ -> GF(101).



---

archive/issue_comments_021231.json:
```json
{
    "body": "<a id='comment:9'>**Comment 9:**</a>\nThanks for the feedback!  I'm at a conference now, so I won't have time to address point 2 for a few days.  However, to address point 1: the previous version of diagonal_matrix allowed for the rows to be specified and padded with zeros.  I was providing an example which showed how to achieve this effect.  Basically, I'm also showing that behavior is like the matrix() command (to which I am just blindly passing all keyword arguments, except for some special behavior about the sparse keyword).  So: the behavior is a result of the behavior of matrix() and shows how to achieve a former behavior of diagonal_matrix.  Whether or not it is actually useful is another issue: if anyone did use this feature, though, it might be nice to have an example of how to do it with the new diagonal_matrix.\n\nI also agree that coercion should play a role, as pointed out in point 2.  I'll look at that early next week, hopefully.\n\nThanks again!",
    "created_at": "2008-07-30T09:33:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/3704#issuecomment-21231",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:9'>**Comment 9:**</a>
Thanks for the feedback!  I'm at a conference now, so I won't have time to address point 2 for a few days.  However, to address point 1: the previous version of diagonal_matrix allowed for the rows to be specified and padded with zeros.  I was providing an example which showed how to achieve this effect.  Basically, I'm also showing that behavior is like the matrix() command (to which I am just blindly passing all keyword arguments, except for some special behavior about the sparse keyword).  So: the behavior is a result of the behavior of matrix() and shows how to achieve a former behavior of diagonal_matrix.  Whether or not it is actually useful is another issue: if anyone did use this feature, though, it might be nice to have an example of how to do it with the new diagonal_matrix.

I also agree that coercion should play a role, as pointed out in point 2.  I'll look at that early next week, hopefully.

Thanks again!



---

archive/issue_comments_021232.json:
```json
{
    "body": "<a id='comment:10'>**Comment 10:**</a>\nOkay, with the example: \n\n```\nsage: matrix(GF(101), 2, [1, 1/2, 1/3, 1/4])\n[ 1 51]\n[34 76]\n```\nthat comes from `GF(101)(1/2)` giving 51, etc.  I just hand it off to the matrix() constructor, which in turn hands the job off to the MatrixSpace constructor.\n\nAs to another point, I get:\n\n```\nsage: diagonal_matrix(x^3+3, x+1)\n\n[x^3 + 3       0]\n[      0   x + 1]\n```\nso with x being a symbolic variable, things work fine.\n\nHowever, if we have an iterable object, then things are not so good.  In that case, the patch tries to construct a Sequence object from the iterable object, which is where you get your weird results.\n\nI'm changing the patch so that if a list or tuple is passed in, then it tries to construct Sequence object from that list or tuple.  Note that this is only for backwards-compatibility, so we can still pass a list into diagonal_matrix and have it return what it used to return.",
    "created_at": "2008-08-02T14:41:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/3704#issuecomment-21232",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:10'>**Comment 10:**</a>
Okay, with the example: 

```
sage: matrix(GF(101), 2, [1, 1/2, 1/3, 1/4])
[ 1 51]
[34 76]
```
that comes from `GF(101)(1/2)` giving 51, etc.  I just hand it off to the matrix() constructor, which in turn hands the job off to the MatrixSpace constructor.

As to another point, I get:

```
sage: diagonal_matrix(x^3+3, x+1)

[x^3 + 3       0]
[      0   x + 1]
```
so with x being a symbolic variable, things work fine.

However, if we have an iterable object, then things are not so good.  In that case, the patch tries to construct a Sequence object from the iterable object, which is where you get your weird results.

I'm changing the patch so that if a list or tuple is passed in, then it tries to construct Sequence object from that list or tuple.  Note that this is only for backwards-compatibility, so we can still pass a list into diagonal_matrix and have it return what it used to return.



---

archive/issue_events_033185.json:
```json
{
    "actor": "https://github.com/jasongrout",
    "created_at": "2008-08-02T17:18:46Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "rename": {
        "from": "[positve  review with mild reservations] make diagonal_matrix accept much more general arguments",
        "to": "[with patch, positve  review with mild reservations (new patch up which addresses the reservations)] make diagonal_matrix accept much more general arguments"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/3704#event-33185"
}
```



---

archive/issue_comments_021233.json:
```json
{
    "body": "<a id='comment:11'>**Comment 11:**</a>\n**Attachment:** [trac-3704-diagonal_matrix.patch.gz](https://github.com/sagemath/sage/files/ticket3704/trac-3704-diagonal_matrix.patch.gz)\n\nOkay, new patch is up which should take of the issues in my previous post.",
    "created_at": "2008-08-02T17:18:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/3704#issuecomment-21233",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:11'>**Comment 11:**</a>
**Attachment:** [trac-3704-diagonal_matrix.patch.gz](https://github.com/sagemath/sage/files/ticket3704/trac-3704-diagonal_matrix.patch.gz)

Okay, new patch is up which should take of the issues in my previous post.



---

archive/issue_comments_021234.json:
```json
{
    "body": "<a id='comment:12'>**Comment 12:**</a>\nI successfully applied the patch to 3.1.alpha0 and all seems to work as advertised.  All tests in sage.matrix pass.  Publish!",
    "created_at": "2008-08-09T16:34:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/3704#issuecomment-21234",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:12'>**Comment 12:**</a>
I successfully applied the patch to 3.1.alpha0 and all seems to work as advertised.  All tests in sage.matrix pass.  Publish!



---

archive/issue_events_033186.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2008-08-09T16:34:56Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "rename": {
        "from": "[with patch, positve  review with mild reservations (new patch up which addresses the reservations)] make diagonal_matrix accept much more general arguments",
        "to": "[with positive  review] make diagonal_matrix accept much more general arguments"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/3704#event-33186"
}
```



---

archive/issue_comments_021235.json:
```json
{
    "body": "<a id='comment:13'>**Comment 13:**</a>\nPatches at #2577 seem to do something very close to this patch, so someone ought to sort out if there are any differences that could be resolved into one unified patch.\n\nCheers,\n\nMichael",
    "created_at": "2008-08-11T00:43:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/3704#issuecomment-21235",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<a id='comment:13'>**Comment 13:**</a>
Patches at #2577 seem to do something very close to this patch, so someone ought to sort out if there are any differences that could be resolved into one unified patch.

Cheers,

Michael



---

archive/issue_comments_021236.json:
```json
{
    "body": "<a id='comment:14'>**Comment 14:**</a>\nI looked at the patch at #2577 and like the patch here better.  I can't see any extra functionality in #2577 that I would want to merge to this patch, but I'm open to suggestions.",
    "created_at": "2008-08-15T23:38:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/3704#issuecomment-21236",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:14'>**Comment 14:**</a>
I looked at the patch at #2577 and like the patch here better.  I can't see any extra functionality in #2577 that I would want to merge to this patch, but I'm open to suggestions.



---

archive/issue_comments_021237.json:
```json
{
    "body": "<a id='comment:15'>**Comment 15:**</a>\n**Attachment:** [trac-3704-diagonal_matrix-2.patch.gz](https://github.com/sagemath/sage/files/ticket3704/trac-3704-diagonal_matrix-2.patch.gz)\n\nI just added a patch, to be applied on top of the first patch, which does two things:\n\n1. Makes a trivial simplification in the code\n\n2. Adds a doctest illustrating the sparse keyword.",
    "created_at": "2008-08-16T00:07:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/3704#issuecomment-21237",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:15'>**Comment 15:**</a>
**Attachment:** [trac-3704-diagonal_matrix-2.patch.gz](https://github.com/sagemath/sage/files/ticket3704/trac-3704-diagonal_matrix-2.patch.gz)

I just added a patch, to be applied on top of the first patch, which does two things:

1. Makes a trivial simplification in the code

2. Adds a doctest illustrating the sparse keyword.



---

archive/issue_comments_021238.json:
```json
{
    "body": "<a id='comment:16'>**Comment 16:**</a>\nHmm, can we sort out this mess, i.e. what to do about #2577? The consensus seems to be to merge theses patches and close #2577?\n\nAn final positive review will also be good since Jason did add a second patch.\n\nCheers,\n\nMichael",
    "created_at": "2008-09-02T11:26:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/3704#issuecomment-21238",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<a id='comment:16'>**Comment 16:**</a>
Hmm, can we sort out this mess, i.e. what to do about #2577? The consensus seems to be to merge theses patches and close #2577?

An final positive review will also be good since Jason did add a second patch.

Cheers,

Michael



---

archive/issue_events_033187.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-09-02T11:26:15Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "rename": {
        "from": "[with positive  review] make diagonal_matrix accept much more general arguments",
        "to": "make diagonal_matrix accept much more general arguments"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/3704#event-33187"
}
```



---

archive/issue_comments_021239.json:
```json
{
    "body": "**Attachment:** [trac-3704-diagonal_matrix-3.patch.gz](https://github.com/sagemath/sage/files/ticket3704/trac-3704-diagonal_matrix-3.patch.gz)",
    "created_at": "2008-09-02T12:00:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/3704#issuecomment-21239",
    "user": "https://github.com/JohnCremona"
}
```

**Attachment:** [trac-3704-diagonal_matrix-3.patch.gz](https://github.com/sagemath/sage/files/ticket3704/trac-3704-diagonal_matrix-3.patch.gz)



---

archive/issue_events_033188.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2008-09-02T12:01:44Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/3704#event-33188"
}
```



---

archive/issue_events_033189.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2008-09-02T12:01:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/3704#event-33189"
}
```



---

archive/issue_comments_021240.json:
```json
{
    "body": "<a id='comment:17'>**Comment 17:**</a>\nLet's agree to kill #2577 since it does nothing which these patches do not do, and these are now a lot better.\n\nI applied both patches to 3.1.2.alpha3 with no problems.  All the above examples now work and give sensible answers.  They are not all included as doctests though.\n\nI hit a doctest error in sage/matrix/matrix_integer_dense_hnf.py:\n\n```\nsage -t  devel/sage/sage/matrix/matrix_integer_dense_hnf.py **********************************************************************\nFile \"/home/john/sage-3.1.2.alpha3/tmp/matrix_integer_dense_hnf.py\", line 132:\n    sage: m = diagonal_matrix(ZZ, 68, [2]*66 + [1,1])\nException raised:\n    Traceback (most recent call last):\n      File \"/home/john/sage-3.1.2.alpha3/local/lib/python2.5/doctest.py\", line 1228, in __run\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_3[17]>\", line 1, in <module>\n        m = diagonal_matrix(ZZ, Integer(68), [Integer(2)]*Integer(66) + [Integer(1),Integer(1)])###line 132:\n    sage: m = diagonal_matrix(ZZ, 68, [2]*66 + [1,1])\n      File \"/home/john/sage-3.1.2.alpha3/local/lib/python2.5/site-packages/sage/matrix/constructor.py\", line 736, in diagonal_matrix\n        return matrix(*args, **kwds)\n      File \"/home/john/sage-3.1.2.alpha3/local/lib/python2.5/site-packages/sage/matrix/constructor.py\", line 524, in matrix\n        entries, entry_ring = prepare_dict(args[0])\n      File \"/home/john/sage-3.1.2.alpha3/local/lib/python2.5/site-packages/sage/matrix/constructor.py\", line 619, in prepare_dict\n        entries, ring = prepare(X)\n      File \"/home/john/sage-3.1.2.alpha3/local/lib/python2.5/site-packages/sage/matrix/constructor.py\", line 613, in prepare\n        raise TypeError, \"unable to find a common ring for all elements\"\n    TypeError: unable to find a common ring for all elements\n```\nThis is trivial to fix, and I added a trivial patch which fixes it.\n\nConclusion:  kill #2577 and merge this one (all three patches).  I assume mabshoff can take on the responsibility of reviewing the final mini-patch!",
    "created_at": "2008-09-02T12:01:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/3704#issuecomment-21240",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:17'>**Comment 17:**</a>
Let's agree to kill #2577 since it does nothing which these patches do not do, and these are now a lot better.

I applied both patches to 3.1.2.alpha3 with no problems.  All the above examples now work and give sensible answers.  They are not all included as doctests though.

I hit a doctest error in sage/matrix/matrix_integer_dense_hnf.py:

```
sage -t  devel/sage/sage/matrix/matrix_integer_dense_hnf.py **********************************************************************
File "/home/john/sage-3.1.2.alpha3/tmp/matrix_integer_dense_hnf.py", line 132:
    sage: m = diagonal_matrix(ZZ, 68, [2]*66 + [1,1])
Exception raised:
    Traceback (most recent call last):
      File "/home/john/sage-3.1.2.alpha3/local/lib/python2.5/doctest.py", line 1228, in __run
        compileflags, 1) in test.globs
      File "<doctest __main__.example_3[17]>", line 1, in <module>
        m = diagonal_matrix(ZZ, Integer(68), [Integer(2)]*Integer(66) + [Integer(1),Integer(1)])###line 132:
    sage: m = diagonal_matrix(ZZ, 68, [2]*66 + [1,1])
      File "/home/john/sage-3.1.2.alpha3/local/lib/python2.5/site-packages/sage/matrix/constructor.py", line 736, in diagonal_matrix
        return matrix(*args, **kwds)
      File "/home/john/sage-3.1.2.alpha3/local/lib/python2.5/site-packages/sage/matrix/constructor.py", line 524, in matrix
        entries, entry_ring = prepare_dict(args[0])
      File "/home/john/sage-3.1.2.alpha3/local/lib/python2.5/site-packages/sage/matrix/constructor.py", line 619, in prepare_dict
        entries, ring = prepare(X)
      File "/home/john/sage-3.1.2.alpha3/local/lib/python2.5/site-packages/sage/matrix/constructor.py", line 613, in prepare
        raise TypeError, "unable to find a common ring for all elements"
    TypeError: unable to find a common ring for all elements
```
This is trivial to fix, and I added a trivial patch which fixes it.

Conclusion:  kill #2577 and merge this one (all three patches).  I assume mabshoff can take on the responsibility of reviewing the final mini-patch!



---

archive/issue_comments_021241.json:
```json
{
    "body": "<a id='comment:18'>**Comment 18:**</a>\n**Attachment:** [trac-3704-diagonal_matrix-4.patch.gz](https://github.com/sagemath/sage/files/ticket3704/trac-3704-diagonal_matrix-4.patch.gz)\n\nPS Forgot to add that doctest: 4th patch does that too.",
    "created_at": "2008-09-02T12:06:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/3704#issuecomment-21241",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:18'>**Comment 18:**</a>
**Attachment:** [trac-3704-diagonal_matrix-4.patch.gz](https://github.com/sagemath/sage/files/ticket3704/trac-3704-diagonal_matrix-4.patch.gz)

PS Forgot to add that doctest: 4th patch does that too.



---

archive/issue_comments_021242.json:
```json
{
    "body": "<a id='comment:19'>**Comment 19:**</a>\nIs there a reason that we got rid of this construction?\n\n```\n \t        4. matrix(ring, nrows, diagonal_entries, [sparse=True]): \n\t               matrix with given number of rows and flat list of entries  \n```\n\nIt should at least be deprecated first.",
    "created_at": "2008-09-02T23:28:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/3704#issuecomment-21242",
    "user": "https://github.com/mwhansen"
}
```

<a id='comment:19'>**Comment 19:**</a>
Is there a reason that we got rid of this construction?

```
 	        4. matrix(ring, nrows, diagonal_entries, [sparse=True]): 
	               matrix with given number of rows and flat list of entries  
```

It should at least be deprecated first.



---

archive/issue_comments_021243.json:
```json
{
    "body": "<a id='comment:20'>**Comment 20:**</a>\nThere was exactly one doctest which stopped working with that construction missing, and the fix was just to delete the nrows parameter.\n\nI don't have strong feelings about deprecating things like this.  I think the point of having nrows in there was so that diagonal_entries could be shorter than nrows and then would be padded out by zeroes.  I feel happier requiring the user to provide the whole list of diagonal entries, but if someone wants to put this construction back I don't mind either.",
    "created_at": "2008-09-03T08:29:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/3704#issuecomment-21243",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:20'>**Comment 20:**</a>
There was exactly one doctest which stopped working with that construction missing, and the fix was just to delete the nrows parameter.

I don't have strong feelings about deprecating things like this.  I think the point of having nrows in there was so that diagonal_entries could be shorter than nrows and then would be padded out by zeroes.  I feel happier requiring the user to provide the whole list of diagonal entries, but if someone wants to put this construction back I don't mind either.



---

archive/issue_events_033190.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-09-19T03:30:05Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/3704#event-33190"
}
```



---

archive/issue_events_033191.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2008-09-19T03:30:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/3704#event-33191"
}
```



---

archive/issue_comments_021244.json:
```json
{
    "body": "<a id='comment:21'>**Comment 21:**</a>\nThere was some extended discussion on sage-devel and the consensus is that the new non-list constructor will break if more than 255 elements are passed. So this needs work :)\n\nCheers,\n\nMichael",
    "created_at": "2008-09-19T03:30:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/3704#issuecomment-21244",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<a id='comment:21'>**Comment 21:**</a>
There was some extended discussion on sage-devel and the consensus is that the new non-list constructor will break if more than 255 elements are passed. So this needs work :)

Cheers,

Michael



---

archive/issue_events_033192.json:
```json
{
    "actor": "https://github.com/rlmill",
    "created_at": "2009-01-23T12:40:18Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/3704#event-33192"
}
```



---

archive/issue_events_033193.json:
```json
{
    "actor": "https://github.com/rlmill",
    "created_at": "2009-01-23T12:40:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/3704#event-33193"
}
```



---

archive/issue_comments_021245.json:
```json
{
    "body": "<a id='comment:22'>**Comment 22:**</a>\nI'm attaching a new patch which takes a much lower level approach to solving the problem. If a complete rewrite is really necessary, I propose we open a new ticket for it, since this ticket is just about constructing a diagonal matrix from a vector.",
    "created_at": "2009-01-23T12:40:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/3704#issuecomment-21245",
    "user": "https://github.com/rlmill"
}
```

<a id='comment:22'>**Comment 22:**</a>
I'm attaching a new patch which takes a much lower level approach to solving the problem. If a complete rewrite is really necessary, I propose we open a new ticket for it, since this ticket is just about constructing a diagonal matrix from a vector.



---

archive/issue_comments_021246.json:
```json
{
    "body": "**Attachment:** [trac-3704.patch.gz](https://github.com/sagemath/sage/files/ticket3704/trac-3704.patch.gz)\n\nIndependent of the other patches found here.",
    "created_at": "2009-01-23T12:41:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/3704#issuecomment-21246",
    "user": "https://github.com/rlmill"
}
```

**Attachment:** [trac-3704.patch.gz](https://github.com/sagemath/sage/files/ticket3704/trac-3704.patch.gz)

Independent of the other patches found here.



---

archive/issue_events_033194.json:
```json
{
    "actor": "https://github.com/jasongrout",
    "created_at": "2009-01-27T03:55:24Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/3704#event-33194"
}
```



---

archive/issue_events_033195.json:
```json
{
    "actor": "https://github.com/jasongrout",
    "created_at": "2009-01-27T03:55:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/3704#event-33195"
}
```



---

archive/issue_comments_021247.json:
```json
{
    "body": "<a id='comment:23'>**Comment 23:**</a>\nPositive review for rlm's patch.  It fixes the problem mentioned in the ticket.  The new ticket rlm mentioned is #5110.",
    "created_at": "2009-01-27T03:55:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/3704#issuecomment-21247",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:23'>**Comment 23:**</a>
Positive review for rlm's patch.  It fixes the problem mentioned in the ticket.  The new ticket rlm mentioned is #5110.



---

archive/issue_comments_021248.json:
```json
{
    "body": "<a id='comment:24'>**Comment 24:**</a>\n(because of #5110, do not delete the other patches on this ticket.)",
    "created_at": "2009-01-27T03:55:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/3704#issuecomment-21248",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:24'>**Comment 24:**</a>
(because of #5110, do not delete the other patches on this ticket.)



---

archive/issue_events_033196.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-01-28T14:12:34Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "milestone_number": null,
    "milestone_title": "sage-3.4.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/3704#event-33196"
}
```



---

archive/issue_events_033197.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-01-28T14:12:34Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "milestone_number": null,
    "milestone_title": "sage-3.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/3704#event-33197"
}
```



---

archive/issue_events_033198.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-01-28T14:12:34Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/3704#event-33198"
}
```



---

archive/issue_events_033199.json:
```json
{
    "actor": "https://github.com/sagetrac-mabshoff",
    "created_at": "2009-01-28T14:12:34Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/3704#event-33199"
}
```



---

archive/issue_comments_021249.json:
```json
{
    "body": "<a id='comment:25'>**Comment 25:**</a>\nMerged trac-3704.patch only in Sage 3.3.alpha3.\n\nCheers,\n\nMichael",
    "created_at": "2009-01-28T14:12:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/3704",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/3704#issuecomment-21249",
    "user": "https://github.com/sagetrac-mabshoff"
}
```

<a id='comment:25'>**Comment 25:**</a>
Merged trac-3704.patch only in Sage 3.3.alpha3.

Cheers,

Michael
