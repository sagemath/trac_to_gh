# Issue 3883: Streamline elliptic curve division (torsion) polynomials

archive/issues_003883.json:
```json
{
    "body": "#3109 introduced a new bivariate division polynomial for elliptic curves, only implemented for curves in short Weierstrass form, and also very useful functions for dividing points (for arbitrary curves).\n\nIn reviewing #3377 I wanted to use the division_points() function for curvesw defined over number fields and ran into problems.  This led me to reconsider the existing division polynomial code, and this is the result.  I removed the commenting-out # signs from a perfectly good set of three functions pseudo_division_polynomial(), multiple_x_numerator() and multiple_x_denominator().  I rewrote full_division_polynomial() to use these, making it very much simpler and apply to all curves, not just those in short W. form.  I also rewrote division_points(), simplifying it.\n\nI'll shortly post a patch for all this.  In the patch you will find some rather long-winded comments which explain very precisely what the relation is between these functions.  If approved, I'll make use of this and get back to working on #3377.\n\n\n**Assignee:** @williamstein\n\nIssue created by migration from https://trac.sagemath.org/ticket/3883\n\n",
    "closed_at": "2008-08-28T02:01:43Z",
    "created_at": "2008-08-17T17:33:03Z",
    "labels": [
        "component: number theory",
        "minor",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-3.1.2",
    "title": "Streamline elliptic curve division (torsion) polynomials",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/3883",
    "user": "https://github.com/JohnCremona"
}
```
#3109 introduced a new bivariate division polynomial for elliptic curves, only implemented for curves in short Weierstrass form, and also very useful functions for dividing points (for arbitrary curves).

In reviewing #3377 I wanted to use the division_points() function for curvesw defined over number fields and ran into problems.  This led me to reconsider the existing division polynomial code, and this is the result.  I removed the commenting-out # signs from a perfectly good set of three functions pseudo_division_polynomial(), multiple_x_numerator() and multiple_x_denominator().  I rewrote full_division_polynomial() to use these, making it very much simpler and apply to all curves, not just those in short W. form.  I also rewrote division_points(), simplifying it.

I'll shortly post a patch for all this.  In the patch you will find some rather long-winded comments which explain very precisely what the relation is between these functions.  If approved, I'll make use of this and get back to working on #3377.


**Assignee:** @williamstein

Issue created by migration from https://trac.sagemath.org/ticket/3883





---

archive/attachments_004043.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "sage-trac3883.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket3883/sage-trac3883.patch",
    "created_at": "2008-08-17T17:34:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3883",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/JohnCremona"
}
```



---

archive/issue_comments_028461.json:
```json
{
    "body": "",
    "created_at": "2008-08-17T17:34:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3883#issuecomment-28461",
    "user": "https://github.com/JohnCremona"
}
```





---

archive/issue_comments_028462.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2008-08-17T17:35:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3883#issuecomment-28462",
    "user": "https://github.com/JohnCremona"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_028463.json:
```json
{
    "body": "<a id='comment:1'></a>\nPatch sage-trac3883.patch is based on 3.1.rc0",
    "created_at": "2008-08-17T17:35:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3883#issuecomment-28463",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:1'></a>
Patch sage-trac3883.patch is based on 3.1.rc0



---

archive/issue_comments_028464.json:
```json
{
    "body": "<a id='comment:2'></a>\nChris W. has reviewed this in an email to John C., which I will copy here when he tells me I can, and there will be a new patch appearing after that.",
    "created_at": "2008-08-26T11:40:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3883#issuecomment-28464",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:2'></a>
Chris W. has reviewed this in an email to John C., which I will copy here when he tells me I can, and there will be a new patch appearing after that.



---

archive/issue_comments_028465.json:
```json
{
    "body": "Apply after the previous patch",
    "created_at": "2008-08-26T15:36:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3883#issuecomment-28465",
    "user": "https://github.com/JohnCremona"
}
```

Apply after the previous patch



---

archive/attachments_004044.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "sage-trac3883b.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket3883/sage-trac3883b.patch",
    "created_at": "2008-08-26T15:39:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3883",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/JohnCremona"
}
```



---

archive/issue_comments_028466.json:
```json
{
    "body": "<a id='comment:3'></a>\nReview by Chris Wuthrich:\n\nSo, I had a closer look at your division polynomials.\n\nI don't get any errors with 3.1.1. (without the changes in 3927).\nI will make some small changes, like the spelling of my name :), and\nsome bigger ones, depending on your views on these :\n\n* Personally I would have chosen one name, say division_polynomial,\nand then an option in it to get the full_ version or the pseudo\nversion. There are already very many (218) function on the elliptic\ncurve class and it would be less confusing for the average user. That\nis a matter of taste, I guess.\n\n* multiply_x_* should maybe be a _multiply_x_* as I don't think\nsomeone will ever use that directly and it will certainly be confusing\nfor the newbie. Where was this function before ? Has it something to\ndo with the _multiply_point in padics.py ?\n There is another implementation of the division_polynomials that\ncould be rewritten. But there the curve has coefficients in a ring and\none computes integrally. So that does not make sense in ell_generic.\n\n* By the way and completely unrelated, I saw the example\n  E = EllipticCurve(GF(3),[1,2])\n  E.short_weierstrass_model()\nwhich gives \"no short model for Elliptic Curve defined by y^2  = x^3 +\nx + 2 over Finite Field of size 3\". Do you agree that we should not\nraise an error when the model is already in short form ?\n\n* Also, completely unrelated again. E.integral_weierstrass_model\nshould be E.integral_short_weierstrass_model..",
    "created_at": "2008-08-26T15:39:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3883#issuecomment-28466",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:3'></a>
Review by Chris Wuthrich:

So, I had a closer look at your division polynomials.

I don't get any errors with 3.1.1. (without the changes in 3927).
I will make some small changes, like the spelling of my name :), and
some bigger ones, depending on your views on these :

* Personally I would have chosen one name, say division_polynomial,
and then an option in it to get the full_ version or the pseudo
version. There are already very many (218) function on the elliptic
curve class and it would be less confusing for the average user. That
is a matter of taste, I guess.

* multiply_x_* should maybe be a _multiply_x_* as I don't think
someone will ever use that directly and it will certainly be confusing
for the newbie. Where was this function before ? Has it something to
do with the _multiply_point in padics.py ?
 There is another implementation of the division_polynomials that
could be rewritten. But there the curve has coefficients in a ring and
one computes integrally. So that does not make sense in ell_generic.

* By the way and completely unrelated, I saw the example
  E = EllipticCurve(GF(3),[1,2])
  E.short_weierstrass_model()
which gives "no short model for Elliptic Curve defined by y^2  = x^3 +
x + 2 over Finite Field of size 3". Do you agree that we should not
raise an error when the model is already in short form ?

* Also, completely unrelated again. E.integral_weierstrass_model
should be E.integral_short_weierstrass_model..



---

archive/issue_comments_028467.json:
```json
{
    "body": "<a id='comment:4'></a>\nReplying to [cremona](#comment%3A3):\n> Review by Chris Wuthrich:\n> \n> So, I had a closer look at your division polynomials.\n\n\nThanks!\n\n> \n> I don't get any errors with 3.1.1. (without the changes in 3927).\n> I will make some small changes, like the spelling of my name :), and\n> some bigger ones, depending on your views on these :\n\n\nThe only appearance of your name I found has it spelled \"Wuthrich\" (and not by me).  Is it an umlaut you want?\n\nI have made some changes based on your comments, and there is a second patch.\n\n> \n> * Personally I would have chosen one name, say division_polynomial,\n> and then an option in it to get the full_ version or the pseudo\n> version. There are already very many (218) function on the elliptic\n> curve class and it would be less confusing for the average user. That\n> is a matter of taste, I guess.\n\n\nI do agree, so I have refactored the code accordingly.  The only function the user needs is `division_polynomial()`.    Using the value of a flag one can access all the existing functionality.  I have commented out code which is now redundant:  the function `full_division_polynomial()`, originally written by William Stein and rewritten by me, is now accessible by calling division_polynomial with parameter two_torsion_multiplicity=2.  The alternative old `torsion_polynomial()` code by David Kohel has been commented out since it duplicates what is there.  The old function `pseudo_torsion_polynomial()` by David Harvey is now the basis of everything, but is renamed `division_polynomial_0()`.\n\n> \n> * multiply_x_* should maybe be a _multiply_x_* as I don't think\n> someone will ever use that directly and it will certainly be confusing\n> for the newbie. Where was this function before ? Has it something to\n> do with the _multiply_point in padics.py ?\n\n\nThese functions were implemented by David Harvey along with `pseudo_torsion_polynomial()`.  I left the names as they were since we need to access them from ell_point.py which would be awkward if they had leading underscores.  (But I am open to other suggestions for the names of these).\n\n>  There is another implementation of the division_polynomials that\n\n> could be rewritten. But there the curve has coefficients in a ring and\n> one computes integrally. So that does not make sense in ell_generic.\n\n\nI'm not sure where you are referring to here.\n\n> \n> * By the way and completely unrelated, I saw the example\n>   E = EllipticCurve(GF(3),[1,2])\n>   E.short_weierstrass_model()\n> which gives \"no short model for Elliptic Curve defined by y^2  = x^3 +\n> x + 2 over Finite Field of size 3\". Do you agree that we should not\n> raise an error when the model is already in short form ?\n> \n\n\nFair enough, but that belongs in another ticket.\n\n>     * Also, completely unrelated again. E.integral_weierstrass_model\n \n> should be E.integral_short_weierstrass_model..\n> \n\n\nDitto.",
    "created_at": "2008-08-26T15:48:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3883#issuecomment-28467",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:4'></a>
Replying to [cremona](#comment%3A3):
> Review by Chris Wuthrich:
> 
> So, I had a closer look at your division polynomials.


Thanks!

> 
> I don't get any errors with 3.1.1. (without the changes in 3927).
> I will make some small changes, like the spelling of my name :), and
> some bigger ones, depending on your views on these :


The only appearance of your name I found has it spelled "Wuthrich" (and not by me).  Is it an umlaut you want?

I have made some changes based on your comments, and there is a second patch.

> 
> * Personally I would have chosen one name, say division_polynomial,
> and then an option in it to get the full_ version or the pseudo
> version. There are already very many (218) function on the elliptic
> curve class and it would be less confusing for the average user. That
> is a matter of taste, I guess.


I do agree, so I have refactored the code accordingly.  The only function the user needs is `division_polynomial()`.    Using the value of a flag one can access all the existing functionality.  I have commented out code which is now redundant:  the function `full_division_polynomial()`, originally written by William Stein and rewritten by me, is now accessible by calling division_polynomial with parameter two_torsion_multiplicity=2.  The alternative old `torsion_polynomial()` code by David Kohel has been commented out since it duplicates what is there.  The old function `pseudo_torsion_polynomial()` by David Harvey is now the basis of everything, but is renamed `division_polynomial_0()`.

> 
> * multiply_x_* should maybe be a _multiply_x_* as I don't think
> someone will ever use that directly and it will certainly be confusing
> for the newbie. Where was this function before ? Has it something to
> do with the _multiply_point in padics.py ?


These functions were implemented by David Harvey along with `pseudo_torsion_polynomial()`.  I left the names as they were since we need to access them from ell_point.py which would be awkward if they had leading underscores.  (But I am open to other suggestions for the names of these).

>  There is another implementation of the division_polynomials that

> could be rewritten. But there the curve has coefficients in a ring and
> one computes integrally. So that does not make sense in ell_generic.


I'm not sure where you are referring to here.

> 
> * By the way and completely unrelated, I saw the example
>   E = EllipticCurve(GF(3),[1,2])
>   E.short_weierstrass_model()
> which gives "no short model for Elliptic Curve defined by y^2  = x^3 +
> x + 2 over Finite Field of size 3". Do you agree that we should not
> raise an error when the model is already in short form ?
> 


Fair enough, but that belongs in another ticket.

>     * Also, completely unrelated again. E.integral_weierstrass_model
 
> should be E.integral_short_weierstrass_model..
> 


Ditto.



---

archive/issue_comments_028468.json:
```json
{
    "body": "**Changing status** from needs_review to needs_review.",
    "created_at": "2008-08-26T15:48:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3883#issuecomment-28468",
    "user": "https://github.com/JohnCremona"
}
```

**Changing status** from needs_review to needs_review.



---

archive/issue_comments_028469.json:
```json
{
    "body": "small changes to be applied after the previous two patches.",
    "created_at": "2008-08-27T17:16:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3883#issuecomment-28469",
    "user": "https://github.com/categorie"
}
```

small changes to be applied after the previous two patches.



---

archive/issue_comments_028470.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2008-08-27T17:23:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3883#issuecomment-28470",
    "user": "https://github.com/categorie"
}
```

**Changing status** from needs_review to positive_review.



---

archive/attachments_004045.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "sage_trac_3883c.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket3883/sage_trac_3883c.patch",
    "created_at": "2008-08-27T17:23:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3883",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/categorie"
}
```



---

archive/issue_comments_028471.json:
```json
{
    "body": "<a id='comment:5'></a>\nI have added a small patch, which changes all multiply_x_numerator to _multiply_x_numerator. Personally I don't see why it should harm that there is a _function in ell_points.py. I don't believe this function would be used by users directly, so it makes sense to me to hide. Also I changed the documentation referring to my thesis.\n\nAs it is only a matter of taste, it is up to John to decide, I think, if he would like the third patch to be applied or not.\n\nOther than that all is fine. Test pass, the functions are very well documented and very well coded.\n\nPOSITIVE REVIEW (both with only the first two or will all three patches).",
    "created_at": "2008-08-27T17:23:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3883#issuecomment-28471",
    "user": "https://github.com/categorie"
}
```

<a id='comment:5'></a>
I have added a small patch, which changes all multiply_x_numerator to _multiply_x_numerator. Personally I don't see why it should harm that there is a _function in ell_points.py. I don't believe this function would be used by users directly, so it makes sense to me to hide. Also I changed the documentation referring to my thesis.

As it is only a matter of taste, it is up to John to decide, I think, if he would like the third patch to be applied or not.

Other than that all is fine. Test pass, the functions are very well documented and very well coded.

POSITIVE REVIEW (both with only the first two or will all three patches).



---

archive/issue_comments_028472.json:
```json
{
    "body": "<a id='comment:6'></a>\n> The only appearance of your name I found has it spelled \"Wuthrich\" (and not by me). Is it an umlaut you want?\n\n\nNo there was a Christopher before. :)\n\n> I do agree, so I have refactored the code accordingly. [..] but is renamed division_polynomial_0().\n\n\nI agree with you and the new version.\n\n\n>>   There is another implementation of the division_polynomials that could be rewritten. \n\n>> But there the curve has coefficients in a ring and one computes integrally. So that does\n>>  not make sense in ell_generic.\n\n>\n> I'm not sure where you are referring to here.\n\n\nThe function _multiply_point on line 303 in padics.py is just another version of an implementation of the division polynomials. In fact this builds the polynomials that you called multiply_x_numerator and denominator, but as homogeneous polynomials. To clear up denominators so that integers can be plugged in to get integers. The p-adic height computation needs the computation of the square root of numerator of \nx(m*P) for a large m. Using this function is much faster than computing m*P. \n\nBut I think it is better to leave that as it is by now.\n\nChris.",
    "created_at": "2008-08-27T17:35:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3883#issuecomment-28472",
    "user": "https://github.com/categorie"
}
```

<a id='comment:6'></a>
> The only appearance of your name I found has it spelled "Wuthrich" (and not by me). Is it an umlaut you want?


No there was a Christopher before. :)

> I do agree, so I have refactored the code accordingly. [..] but is renamed division_polynomial_0().


I agree with you and the new version.


>>   There is another implementation of the division_polynomials that could be rewritten. 

>> But there the curve has coefficients in a ring and one computes integrally. So that does
>>  not make sense in ell_generic.

>
> I'm not sure where you are referring to here.


The function _multiply_point on line 303 in padics.py is just another version of an implementation of the division polynomials. In fact this builds the polynomials that you called multiply_x_numerator and denominator, but as homogeneous polynomials. To clear up denominators so that integers can be plugged in to get integers. The p-adic height computation needs the computation of the square root of numerator of 
x(m*P) for a large m. Using this function is much faster than computing m*P. 

But I think it is better to leave that as it is by now.

Chris.



---

archive/issue_comments_028473.json:
```json
{
    "body": "<a id='comment:7'></a>\nI am quite happy with the extra changes Chris has made.  (I had already corrected his first name, but he gives a better reference anyway).\n\nThanks for the review!",
    "created_at": "2008-08-27T18:54:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3883#issuecomment-28473",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:7'></a>
I am quite happy with the extra changes Chris has made.  (I had already corrected his first name, but he gives a better reference anyway).

Thanks for the review!



---

archive/issue_events_011301.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2008-08-28T02:01:43Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/3883",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3883#event-11301"
}
```



---

archive/issue_comments_028474.json:
```json
{
    "body": "<a id='comment:8'></a>\nMerged in Sage 3.1.2.alpha2",
    "created_at": "2008-08-28T02:01:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3883#issuecomment-28474",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:8'></a>
Merged in Sage 3.1.2.alpha2
