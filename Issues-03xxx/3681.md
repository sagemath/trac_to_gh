# Issue 3681: modulus() randomly broken for gf2e fields

archive/issues_003681.json:
```json
{
    "body": "\n```\nwdj@hera:~/sagefiles/sage-3.0.4.rc0$ ./sage -t  devel/sage/sage/rings/finite_field_ntl_gf2e.pyx\nsage -t  devel/sage/sage/rings/finite_field_ntl_gf2e.pyx    **********************************************************************\nFile \"/home/wdj/sagefiles/sage-3.0.4.rc0/tmp/finite_field_ntl_gf2e.py\", line 170:\n    sage: k.modulus()\nExpected:\n    x^17 + x^16 + x^15 + x^10 + x^8 + x^6 + x^4 + x^3 + x^2 + x + 1\nGot:\n    x^17\n**********************************************************************\n1 items had failures:\n   1 of   7 in __main__.example_2\n***Test Failed*** 1 failures.\nFor whitespace errors, see the file /home/wdj/sagefiles/sage-3.0.4.rc0/tmp/.doctest_finite_field_ntl_gf2e.py\n         [2.9 s]\nexit code: 1024\n\n----------------------------------------------------------------------\nThe following tests failed:\n\n\n        sage -t  devel/sage/sage/rings/finite_field_ntl_gf2e.pyx\nTotal time for all tests: 2.9 seconds\n```\n\nIssue created by migration from https://trac.sagemath.org/ticket/3681\n\n",
    "closed_at": "2008-07-21T17:54:02Z",
    "created_at": "2008-07-19T14:03:56Z",
    "labels": [
        "component: algebra",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-3.0.6",
    "title": "modulus() randomly broken for gf2e fields",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/3681",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

```
wdj@hera:~/sagefiles/sage-3.0.4.rc0$ ./sage -t  devel/sage/sage/rings/finite_field_ntl_gf2e.pyx
sage -t  devel/sage/sage/rings/finite_field_ntl_gf2e.pyx    **********************************************************************
File "/home/wdj/sagefiles/sage-3.0.4.rc0/tmp/finite_field_ntl_gf2e.py", line 170:
    sage: k.modulus()
Expected:
    x^17 + x^16 + x^15 + x^10 + x^8 + x^6 + x^4 + x^3 + x^2 + x + 1
Got:
    x^17
**********************************************************************
1 items had failures:
   1 of   7 in __main__.example_2
***Test Failed*** 1 failures.
For whitespace errors, see the file /home/wdj/sagefiles/sage-3.0.4.rc0/tmp/.doctest_finite_field_ntl_gf2e.py
         [2.9 s]
exit code: 1024

----------------------------------------------------------------------
The following tests failed:


        sage -t  devel/sage/sage/rings/finite_field_ntl_gf2e.pyx
Total time for all tests: 2.9 seconds
```

Issue created by migration from https://trac.sagemath.org/ticket/3681





---

archive/issue_events_020592.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2008-07-20T13:54:17Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/3681",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/3681#event-20592"
}
```



---

archive/issue_comments_021023.json:
```json
{
    "body": "<a id='comment:1'></a>\nHi,\n\nThe attached two patches make the bug stop, though I'm not completely happy.  Here's what happens.\n\nPatch 1: This is a patch for a completely different bug that I noticed -- namely that the finite field is cached even if modulus='random', which is very stupid:\n\n```\nsage: k.<a> = GF(2^17,modulus='random')\nsage: k.modulus()\nx^17 + x^16 + x^15 + x^14 + x^13 + x^12 + x^11 + x^8 + x^6 + x^4 + x^2 + x + 1\nsage: n.<a> = GF(2^17,modulus='random')\nsage: n.modulus()\nx^17 + x^16 + x^15 + x^14 + x^13 + x^12 + x^11 + x^8 + x^6 + x^4 + x^2 + x + 1\nsage: n is k\nTrue\n```\n\nMuch to my surprise fixing the above caching bug -- i.e., not doing caching, makes\nthe bug that is the subject of this ticket just go away.  Weird!!!\n\nPatch 2: Looking at the code in finite_field_ntl_gf2e.pyx I saw that GF2X_construct\nis used inconsistently.  It is used on ntl_m but *not* on ntl_tmp.  So one or the\nother is wrong.  Digging deeper it seems that using GF2X_construct on ntl_m is\ntotally wrong, since it is only supposed to be used on pointers that are allocated\nusing malloc/new not on C++ classes that are created by just declaring them.  So patch\n2 gets rid of this use of GF2X_construct.   I think this call to GF2X_construct would\npossibly have been a small memory leak (mabshoff?). \n\nNOTE: Applying *only* patch 2 does not fix the bug.  Only patch 1 makes the bug stop happening.\n\nThus I do not understand the bug.  It must somehow be triggered by Python weakrefs and caching\nin a very unusual situation that we just happen to hit with this doctest.    Another remark is\nthat putting \n\n```\nprint \"\"\n```\nin the source code of finite_field_ntl_gf2e.pyx right before the random modulus is computed also causes the bug to stop happening.  \n\nWilliam",
    "created_at": "2008-07-20T13:54:17Z",
    "issue": "https://github.com/sagemath/sage/issues/3681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/3681#issuecomment-21023",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:1'></a>
Hi,

The attached two patches make the bug stop, though I'm not completely happy.  Here's what happens.

Patch 1: This is a patch for a completely different bug that I noticed -- namely that the finite field is cached even if modulus='random', which is very stupid:

```
sage: k.<a> = GF(2^17,modulus='random')
sage: k.modulus()
x^17 + x^16 + x^15 + x^14 + x^13 + x^12 + x^11 + x^8 + x^6 + x^4 + x^2 + x + 1
sage: n.<a> = GF(2^17,modulus='random')
sage: n.modulus()
x^17 + x^16 + x^15 + x^14 + x^13 + x^12 + x^11 + x^8 + x^6 + x^4 + x^2 + x + 1
sage: n is k
True
```

Much to my surprise fixing the above caching bug -- i.e., not doing caching, makes
the bug that is the subject of this ticket just go away.  Weird!!!

Patch 2: Looking at the code in finite_field_ntl_gf2e.pyx I saw that GF2X_construct
is used inconsistently.  It is used on ntl_m but *not* on ntl_tmp.  So one or the
other is wrong.  Digging deeper it seems that using GF2X_construct on ntl_m is
totally wrong, since it is only supposed to be used on pointers that are allocated
using malloc/new not on C++ classes that are created by just declaring them.  So patch
2 gets rid of this use of GF2X_construct.   I think this call to GF2X_construct would
possibly have been a small memory leak (mabshoff?). 

NOTE: Applying *only* patch 2 does not fix the bug.  Only patch 1 makes the bug stop happening.

Thus I do not understand the bug.  It must somehow be triggered by Python weakrefs and caching
in a very unusual situation that we just happen to hit with this doctest.    Another remark is
that putting 

```
print ""
```
in the source code of finite_field_ntl_gf2e.pyx right before the random modulus is computed also causes the bug to stop happening.  

William



---

archive/attachments_003741.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "sage-3681-patch2.patch",
    "asset_url": "tarball://root/attachments/ticket3681/sage-3681-patch2.patch",
    "created_at": "2008-07-20T13:58:53Z",
    "issue": "https://github.com/sagemath/sage/issues/3681",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket3681/sage-3681-patch2.patch",
    "user": "https://github.com/williamstein"
}
```



---

archive/issue_comments_021024.json:
```json
{
    "body": "Attachment [sage-3681-patch2.patch](https://github.com/sagemath/sage/files/ticket3681/sage-3681-patch2.patch) by @williamstein created at 2008-07-20 13:58:53",
    "created_at": "2008-07-20T13:58:53Z",
    "issue": "https://github.com/sagemath/sage/issues/3681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/3681#issuecomment-21024",
    "user": "https://github.com/williamstein"
}
```

Attachment [sage-3681-patch2.patch](https://github.com/sagemath/sage/files/ticket3681/sage-3681-patch2.patch) by @williamstein created at 2008-07-20 13:58:53



---

archive/issue_comments_021025.json:
```json
{
    "body": "<a id='comment:2'></a>\nNitpicks:\n\n* There is a spelling error in sage/rings/finite_field_ntl_gf2e.pyx: \"# called at least once before any arithmetic is perfored. \"\n* Could we add a doctest (maybe a long one) that verifies that the modulus is really irreducible for some number of fields, i.e. a couple dozen or a hundred?\n\nOther than that I think the patch is good to go.\n\nCheers,\n\nMichael",
    "created_at": "2008-07-21T08:07:14Z",
    "issue": "https://github.com/sagemath/sage/issues/3681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/3681#issuecomment-21025",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:2'></a>
Nitpicks:

* There is a spelling error in sage/rings/finite_field_ntl_gf2e.pyx: "# called at least once before any arithmetic is perfored. "
* Could we add a doctest (maybe a long one) that verifies that the modulus is really irreducible for some number of fields, i.e. a couple dozen or a hundred?

Other than that I think the patch is good to go.

Cheers,

Michael



---

archive/issue_comments_021026.json:
```json
{
    "body": "<a id='comment:3'></a>\nI cannot say that I understand any better, but I'll certainly give the first patch a +1 too.",
    "created_at": "2008-07-21T14:24:22Z",
    "issue": "https://github.com/sagemath/sage/issues/3681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/3681#issuecomment-21026",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:3'></a>
I cannot say that I understand any better, but I'll certainly give the first patch a +1 too.



---

archive/attachments_003742.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "sage-3681-part3-ref_response.patch",
    "asset_url": "tarball://root/attachments/ticket3681/sage-3681-part3-ref_response.patch",
    "created_at": "2008-07-21T14:52:48Z",
    "issue": "https://github.com/sagemath/sage/issues/3681",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket3681/sage-3681-part3-ref_response.patch",
    "user": "https://github.com/williamstein"
}
```



---

archive/issue_comments_021027.json:
```json
{
    "body": "<a id='comment:4'></a>\nAttachment [sage-3681-part3-ref_response.patch](https://github.com/sagemath/sage/files/ticket3681/sage-3681-part3-ref_response.patch) by @williamstein created at 2008-07-21 14:52:48\n\npatch attached that addresses mabshoff's nitpicks.",
    "created_at": "2008-07-21T14:52:48Z",
    "issue": "https://github.com/sagemath/sage/issues/3681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/3681#issuecomment-21027",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:4'></a>
Attachment [sage-3681-part3-ref_response.patch](https://github.com/sagemath/sage/files/ticket3681/sage-3681-part3-ref_response.patch) by @williamstein created at 2008-07-21 14:52:48

patch attached that addresses mabshoff's nitpicks.



---

archive/issue_comments_021028.json:
```json
{
    "body": "<a id='comment:5'></a>\nI was puzzled by these lines in finite_field_ntl_gf2e.pyx:\n\n```\n            if modulus == \"random\":\n                current_randstate().set_seed_ntl(False)\n                GF2X_BuildSparseIrred(ntl_tmp, k)\n                GF2X_BuildRandomIrred(ntl_m, ntl_tmp)\n```\nFrom looking at NTL's functions, it looks as if we are creating two irreducibles here, one sparse and one random.  Also, the sparse creation function is *not* random for degrees up to 2048 since it just uses a lookup table.\n\nThe solution is that `GF2X_BuildRandomIrred` takes as input some monic poly, and (by changing some coefficients at random, I think) changes it into another one which has the same degree and passes the irreducibility test.  So I guess that is random, but it seems a bit of overkill to call the first function (especially for degrees >2048) rather than start with `X^k`, say.",
    "created_at": "2008-07-21T16:57:55Z",
    "issue": "https://github.com/sagemath/sage/issues/3681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/3681#issuecomment-21028",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:5'></a>
I was puzzled by these lines in finite_field_ntl_gf2e.pyx:

```
            if modulus == "random":
                current_randstate().set_seed_ntl(False)
                GF2X_BuildSparseIrred(ntl_tmp, k)
                GF2X_BuildRandomIrred(ntl_m, ntl_tmp)
```
From looking at NTL's functions, it looks as if we are creating two irreducibles here, one sparse and one random.  Also, the sparse creation function is *not* random for degrees up to 2048 since it just uses a lookup table.

The solution is that `GF2X_BuildRandomIrred` takes as input some monic poly, and (by changing some coefficients at random, I think) changes it into another one which has the same degree and passes the irreducibility test.  So I guess that is random, but it seems a bit of overkill to call the first function (especially for degrees >2048) rather than start with `X^k`, say.



---

archive/issue_comments_021029.json:
```json
{
    "body": "<a id='comment:6'></a>\nJohn,\n\nI read the ntl source code and what you remark about is true.  Note however that even for k >> 2048 the constructor is very fast and returns a very *non* random poly.  That's why the two calls above are right and do make sense.   It's intriguing but evidently the ntl algorithm to generate a random polynomial is to chose a *random* element of GF(2^k) then compute its minpoly, and return that if it has the right degree.  This might address some issue of distribution.",
    "created_at": "2008-07-21T17:19:51Z",
    "issue": "https://github.com/sagemath/sage/issues/3681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/3681#issuecomment-21029",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:6'></a>
John,

I read the ntl source code and what you remark about is true.  Note however that even for k >> 2048 the constructor is very fast and returns a very *non* random poly.  That's why the two calls above are right and do make sense.   It's intriguing but evidently the ntl algorithm to generate a random polynomial is to chose a *random* element of GF(2^k) then compute its minpoly, and return that if it has the right degree.  This might address some issue of distribution.



---

archive/issue_comments_021030.json:
```json
{
    "body": "<a id='comment:7'></a>\nThat's a clever way of doing it, certainly (OK, so Victor Shoup is clever) -- e.g. if the degree is prime then (almost) any element will do.  I wonder how sparse a random min poly is.\n\nIn the old Sage code, before I fixed it,  it was generating random polys over GF(2) and testing them for irreducibility.  This was bad on two counts:  (a) it took many tries before an irreducible was hit; (b) the polys used had 50% of their coefficients =1, so were slow to deal with (and the field arithmetic was also then slow).\n\nI cannot actually think of a situation where I would want to have a random generator...\n\nBy the way, do we need any more reviewing before this one gets the go-ahead?",
    "created_at": "2008-07-21T17:24:47Z",
    "issue": "https://github.com/sagemath/sage/issues/3681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/3681#issuecomment-21030",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:7'></a>
That's a clever way of doing it, certainly (OK, so Victor Shoup is clever) -- e.g. if the degree is prime then (almost) any element will do.  I wonder how sparse a random min poly is.

In the old Sage code, before I fixed it,  it was generating random polys over GF(2) and testing them for irreducibility.  This was bad on two counts:  (a) it took many tries before an irreducible was hit; (b) the polys used had 50% of their coefficients =1, so were slow to deal with (and the field arithmetic was also then slow).

I cannot actually think of a situation where I would want to have a random generator...

By the way, do we need any more reviewing before this one gets the go-ahead?



---

archive/issue_events_020593.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2008-07-21T17:28:40Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/3681",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/3681#event-20593"
}
```



---

archive/issue_events_020594.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2008-07-21T17:28:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/3681",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/3681#event-20594"
}
```



---

archive/issue_comments_021031.json:
```json
{
    "body": "<a id='comment:8'></a>\nReplying to [cremona](#comment%3A7):\n> That's a clever way of doing it, certainly (OK, so Victor Shoup is clever) -- e.g. if the degree is prime then (almost) any element will do.  I wonder how sparse a random min poly is.\n\n\nI am sure Victor should \"ain't no dummy\" :)\n\n> In the old Sage code, before I fixed it,  it was generating random polys over GF(2) and testing them for irreducibility.  This was bad on two counts:  (a) it took many tries before an irreducible was hit; (b) the polys used had 50% of their coefficients =1, so were slow to deal with (and the field arithmetic was also then slow).\n> \n> I cannot actually think of a situation where I would want to have a random generator...\n> \n> By the way, do we need any more reviewing before this one gets the go-ahead?\n\n\nNo, I consider what you and William wrote a positive review. This has been a Heisenbug and it has been fixed by the patch on the box we did hit the problem on. Should it resurface we will deal with it.\n\nCheers,\n\nMichael",
    "created_at": "2008-07-21T17:28:40Z",
    "issue": "https://github.com/sagemath/sage/issues/3681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/3681#issuecomment-21031",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:8'></a>
Replying to [cremona](#comment%3A7):
> That's a clever way of doing it, certainly (OK, so Victor Shoup is clever) -- e.g. if the degree is prime then (almost) any element will do.  I wonder how sparse a random min poly is.


I am sure Victor should "ain't no dummy" :)

> In the old Sage code, before I fixed it,  it was generating random polys over GF(2) and testing them for irreducibility.  This was bad on two counts:  (a) it took many tries before an irreducible was hit; (b) the polys used had 50% of their coefficients =1, so were slow to deal with (and the field arithmetic was also then slow).
> 
> I cannot actually think of a situation where I would want to have a random generator...
> 
> By the way, do we need any more reviewing before this one gets the go-ahead?


No, I consider what you and William wrote a positive review. This has been a Heisenbug and it has been fixed by the patch on the box we did hit the problem on. Should it resurface we will deal with it.

Cheers,

Michael



---

archive/issue_events_020595.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2008-07-21T17:54:02Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/3681",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/3681#event-20595"
}
```



---

archive/issue_events_020596.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2008-07-21T17:54:02Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/3681",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/3681#event-20596"
}
```



---

archive/issue_comments_021032.json:
```json
{
    "body": "<a id='comment:9'></a>\nMerged in Sage 3.0.6.rc0",
    "created_at": "2008-07-21T17:54:02Z",
    "issue": "https://github.com/sagemath/sage/issues/3681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/3681#issuecomment-21032",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:9'></a>
Merged in Sage 3.0.6.rc0
