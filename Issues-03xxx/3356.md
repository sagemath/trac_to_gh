# Issue 3356: [with patch; positive review] finance -- add randomization code; optimize some models; improve plotting code

archive/issues_003356.json:
```json
{
    "body": "Assignee: @williamstein\n\nKeywords: editor_wstein\n\nFor the lazy I've also posted this clean hg bundle:\n\n\n http://sage.math.washington.edu/home/was/patches/finance.hg\n\nIssue created by migration from https://trac.sagemath.org/ticket/3356\n\n",
    "closed_at": "2008-07-06T19:35:43Z",
    "created_at": "2008-06-03T07:13:19Z",
    "labels": [
        "component: finance",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-3.0.4",
    "title": "[with patch; positive review] finance -- add randomization code; optimize some models; improve plotting code",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/3356",
    "user": "https://github.com/williamstein"
}
```
Assignee: @williamstein

Keywords: editor_wstein

For the lazy I've also posted this clean hg bundle:


 http://sage.math.washington.edu/home/was/patches/finance.hg

Issue created by migration from https://trac.sagemath.org/ticket/3356





---

archive/issue_comments_023283.json:
```json
{
    "body": "Attachment [sage-3356-part1.patch](tarball://root/attachments/some-uuid/ticket3356/sage-3356-part1.patch) by @williamstein created at 2008-06-03 07:14:13\n\nThis depends on #3346.",
    "created_at": "2008-06-03T07:14:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3356#issuecomment-23283",
    "user": "https://github.com/williamstein"
}
```

Attachment [sage-3356-part1.patch](tarball://root/attachments/some-uuid/ticket3356/sage-3356-part1.patch) by @williamstein created at 2008-06-03 07:14:13

This depends on #3346.



---

archive/issue_comments_023284.json:
```json
{
    "body": "Attachment [sage-3356-part2.patch](tarball://root/attachments/some-uuid/ticket3356/sage-3356-part2.patch) by @williamstein created at 2008-06-03 17:32:36",
    "created_at": "2008-06-03T17:32:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3356#issuecomment-23284",
    "user": "https://github.com/williamstein"
}
```

Attachment [sage-3356-part2.patch](tarball://root/attachments/some-uuid/ticket3356/sage-3356-part2.patch) by @williamstein created at 2008-06-03 17:32:36



---

archive/issue_comments_023285.json:
```json
{
    "body": "Attachment [sage-3356-part4.patch](tarball://root/attachments/some-uuid/ticket3356/sage-3356-part4.patch) by @williamstein created at 2008-06-04 17:55:38",
    "created_at": "2008-06-04T17:55:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3356#issuecomment-23285",
    "user": "https://github.com/williamstein"
}
```

Attachment [sage-3356-part4.patch](tarball://root/attachments/some-uuid/ticket3356/sage-3356-part4.patch) by @williamstein created at 2008-06-04 17:55:38



---

archive/issue_comments_023286.json:
```json
{
    "body": "Attachment [sage-3356-part5.patch](tarball://root/attachments/some-uuid/ticket3356/sage-3356-part5.patch) by @williamstein created at 2008-06-11 00:58:03\n\nThis will be ready to review once the doctest coverage is back at 100%.  As of patch 5 it is at about 90%.",
    "created_at": "2008-06-11T00:58:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3356#issuecomment-23286",
    "user": "https://github.com/williamstein"
}
```

Attachment [sage-3356-part5.patch](tarball://root/attachments/some-uuid/ticket3356/sage-3356-part5.patch) by @williamstein created at 2008-06-11 00:58:03

This will be ready to review once the doctest coverage is back at 100%.  As of patch 5 it is at about 90%.



---

archive/issue_comments_023287.json:
```json
{
    "body": "Attachment [sage-3356-part6.patch](tarball://root/attachments/some-uuid/ticket3356/sage-3356-part6.patch) by @cswiercz created at 2008-06-20 04:35:18\n\nAdded log-normal random distribution.",
    "created_at": "2008-06-20T04:35:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3356#issuecomment-23287",
    "user": "https://github.com/cswiercz"
}
```

Attachment [sage-3356-part6.patch](tarball://root/attachments/some-uuid/ticket3356/sage-3356-part6.patch) by @cswiercz created at 2008-06-20 04:35:18

Added log-normal random distribution.



---

archive/issue_comments_023288.json:
```json
{
    "body": "Changing keywords from \"\" to \"editor_wstein\".",
    "created_at": "2008-06-20T04:58:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3356#issuecomment-23288",
    "user": "https://github.com/craigcitro"
}
```

Changing keywords from "" to "editor_wstein".



---

archive/issue_comments_023289.json:
```json
{
    "body": "Attachment [sage-3356-part7.patch](tarball://root/attachments/some-uuid/ticket3356/sage-3356-part7.patch) by @cswiercz created at 2008-06-20 18:10:22\n\nAdded doctests for TimeSeries.randomize",
    "created_at": "2008-06-20T18:10:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3356#issuecomment-23289",
    "user": "https://github.com/cswiercz"
}
```

Attachment [sage-3356-part7.patch](tarball://root/attachments/some-uuid/ticket3356/sage-3356-part7.patch) by @cswiercz created at 2008-06-20 18:10:22

Added doctests for TimeSeries.randomize



---

archive/issue_comments_023290.json:
```json
{
    "body": "patches are dead: Long Live Branches\n\nAll future development for sage-finance lives on the finpatch branch.  Instructions at:\n\nhttp://wiki.sagemath.org/finance",
    "created_at": "2008-06-21T04:23:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3356#issuecomment-23290",
    "user": "https://trac.sagemath.org/admin/accounts/users/ghtdak"
}
```

patches are dead: Long Live Branches

All future development for sage-finance lives on the finpatch branch.  Instructions at:

http://wiki.sagemath.org/finance



---

archive/issue_comments_023291.json:
```json
{
    "body": ">patches are dead: Long Live Branches\n> All future development for sage-finance lives on the finpatch branch. Instructions at: \n\n\nUmh, no.  All code that goes into Sage must appear as patches on this trac server first so\nit can be refereed etc.  What you do to obtain those patches -- use queues, branches, etc.,\nis up to you. \n\n -- William",
    "created_at": "2008-06-21T23:50:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3356#issuecomment-23291",
    "user": "https://github.com/williamstein"
}
```

>patches are dead: Long Live Branches
> All future development for sage-finance lives on the finpatch branch. Instructions at: 


Umh, no.  All code that goes into Sage must appear as patches on this trac server first so
it can be refereed etc.  What you do to obtain those patches -- use queues, branches, etc.,
is up to you. 

 -- William



---

archive/issue_comments_023292.json:
```json
{
    "body": "In keeping with the Twisted rule, all work has a ticket.  This comment\nwas posted on a ticket \"not ready for review\". When its changed to\nready, an aggregate patch will be posted using the accepted process.\n\nThe branches, and published repos for the finance/dsageng development\nactivities provide a finer grained view of the development process for\ncontributors and casual observers.  Since we have this set up, it seems\neasier to use branchy development between reviewable events.\n\n-glenn",
    "created_at": "2008-06-22T00:25:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3356#issuecomment-23292",
    "user": "https://trac.sagemath.org/admin/accounts/users/ghtdak"
}
```

In keeping with the Twisted rule, all work has a ticket.  This comment
was posted on a ticket "not ready for review". When its changed to
ready, an aggregate patch will be posted using the accepted process.

The branches, and published repos for the finance/dsageng development
activities provide a finer grained view of the development process for
contributors and casual observers.  Since we have this set up, it seems
easier to use branchy development between reviewable events.

-glenn



---

archive/issue_comments_023293.json:
```json
{
    "body": "Attachment [sage-3356-part8.patch](tarball://root/attachments/some-uuid/ticket3356/sage-3356-part8.patch) by @williamstein created at 2008-07-01 02:45:00",
    "created_at": "2008-07-01T02:45:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3356#issuecomment-23293",
    "user": "https://github.com/williamstein"
}
```

Attachment [sage-3356-part8.patch](tarball://root/attachments/some-uuid/ticket3356/sage-3356-part8.patch) by @williamstein created at 2008-07-01 02:45:00



---

archive/issue_comments_023294.json:
```json
{
    "body": "Attachment [sage-3356-part9.patch](tarball://root/attachments/some-uuid/ticket3356/sage-3356-part9.patch) by @williamstein created at 2008-07-01 06:28:04\n\nthis patch gets doctest coverage to 100%",
    "created_at": "2008-07-01T06:28:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3356#issuecomment-23294",
    "user": "https://github.com/williamstein"
}
```

Attachment [sage-3356-part9.patch](tarball://root/attachments/some-uuid/ticket3356/sage-3356-part9.patch) by @williamstein created at 2008-07-01 06:28:04

this patch gets doctest coverage to 100%



---

archive/issue_events_007532.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2008-07-01T06:28:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/3356",
    "milestone": "sage-3.0.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3356#event-7532"
}
```



---

archive/issue_comments_023295.json:
```json
{
    "body": "REMARK: I just realized that the autocovariance function doesn't check that its input\nis nonnegative but assumes it in the code.  It would thus segfault or give random garbage\nfor negative input.  This should be fixed.",
    "created_at": "2008-07-03T02:17:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3356#issuecomment-23295",
    "user": "https://github.com/williamstein"
}
```

REMARK: I just realized that the autocovariance function doesn't check that its input
is nonnegative but assumes it in the code.  It would thus segfault or give random garbage
for negative input.  This should be fixed.



---

archive/issue_comments_023296.json:
```json
{
    "body": "Attachment [part10.patch](tarball://root/attachments/some-uuid/ticket3356/part10.patch) by jkantor created at 2008-07-06 01:03:52\n\ndoctest addition and name change of linear_filter to autoregressive_fit",
    "created_at": "2008-07-06T01:03:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3356#issuecomment-23296",
    "user": "https://trac.sagemath.org/admin/accounts/users/jkantor"
}
```

Attachment [part10.patch](tarball://root/attachments/some-uuid/ticket3356/part10.patch) by jkantor created at 2008-07-06 01:03:52

doctest addition and name change of linear_filter to autoregressive_fit



---

archive/issue_comments_023297.json:
```json
{
    "body": "Positive review with comments\n\nI've made some changes to the docstring on the linear filter/forecast methods. I think its more accurate to call it autoregressive_fit, and autoregressive_forecast, also added a doctest (patch attached). Also there was a problem with numerical noise on the hurst_exponent causing a doctest failure I added a ...\n\n\nThe doctest for the linear_filter function involving the multifractal random walk seems odd to me (the one outside the time series class, which I call autoregressive_fit). The reason I'm skeptical is that a complicated series is generated and then one does a fit and produces regression coefficients that are [ .998, stuff nearly 0] which means that the forcast says the best prediction of the next value is the previous one plus noise, which makes sense but somehow doesn't seem like as good of a test of the function to me as it could be given its complexity.\n\n\n\nSuggestions for future improvement I'll do them in a separate patch unless someone does them first\n\neasy: \n\n1.  I think it would be nice if autocovariance/correlation could have a second optional parameter so that t.autocovariance(i,j) would return all the autocovariance \ncoefficients from i to i+j or between i and j as a timeseries (this is just a list comprehension).\n\n\n\n2. partial autocorrelation function, its a function often denoted by \\pi such that\n\\pi_p is last coefficient outputted by autoregressive_fit(p) (formerly known as linearly_filter).",
    "created_at": "2008-07-06T01:04:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3356#issuecomment-23297",
    "user": "https://trac.sagemath.org/admin/accounts/users/jkantor"
}
```

Positive review with comments

I've made some changes to the docstring on the linear filter/forecast methods. I think its more accurate to call it autoregressive_fit, and autoregressive_forecast, also added a doctest (patch attached). Also there was a problem with numerical noise on the hurst_exponent causing a doctest failure I added a ...


The doctest for the linear_filter function involving the multifractal random walk seems odd to me (the one outside the time series class, which I call autoregressive_fit). The reason I'm skeptical is that a complicated series is generated and then one does a fit and produces regression coefficients that are [ .998, stuff nearly 0] which means that the forcast says the best prediction of the next value is the previous one plus noise, which makes sense but somehow doesn't seem like as good of a test of the function to me as it could be given its complexity.



Suggestions for future improvement I'll do them in a separate patch unless someone does them first

easy: 

1.  I think it would be nice if autocovariance/correlation could have a second optional parameter so that t.autocovariance(i,j) would return all the autocovariance 
coefficients from i to i+j or between i and j as a timeseries (this is just a list comprehension).



2. partial autocorrelation function, its a function often denoted by \pi such that
\pi_p is last coefficient outputted by autoregressive_fit(p) (formerly known as linearly_filter).



---

archive/issue_comments_023298.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2008-07-06T19:35:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3356#issuecomment-23298",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

Resolution: fixed



---

archive/issue_comments_023299.json:
```json
{
    "body": "Merged finance.hg in Sage 3.0.4.alpha2 and after resolving two merge issues it seems to doctest fine.\n\nThe comments should move to three new tickets.\n\nCheers,\n\nMichael",
    "created_at": "2008-07-06T19:35:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3356#issuecomment-23299",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

Merged finance.hg in Sage 3.0.4.alpha2 and after resolving two merge issues it seems to doctest fine.

The comments should move to three new tickets.

Cheers,

Michael



---

archive/issue_events_007533.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2008-07-06T19:35:43Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/3356",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3356#event-7533"
}
```



---

archive/issue_comments_023300.json:
```json
{
    "body": "There are some doctest issues:\n\n```\nmabshoff@sage:/scratch/mabshoff/release-cycle/sage-3.0.4.alpha2$ sage -t  devel/sage/sage/finance/time_series.pyx # 3 doctests failed\nsage -t  devel/sage/sage/finance/time_series.pyx            \n**********************************************************************\nFile \"/scratch/mabshoff/release-cycle/sage-3.0.4.alpha2/tmp/time_series.py\", line 525:\n    sage: v.linear_forecast(F)\nExpected:\n    86.017728504280015\nGot:\n    86.01772850427912\n**********************************************************************\nFile \"/scratch/mabshoff/release-cycle/sage-3.0.4.alpha2/tmp/time_series.py\", line 1428:\n    sage: fbm.hurst_exponent()\nExpected:\n    0.66787027921443409\nGot:\n    0.66787027921463038\n**********************************************************************\nFile \"/scratch/mabshoff/release-cycle/sage-3.0.4.alpha2/tmp/time_series.py\", line 1433:\n    sage: fbm.hurst_exponent()\nExpected:\n    0.30450273560706259\nGot:\n    0.30450273560706026\n**********************************************************************\n2 items had failures:\n   1 of   7 in __main__.example_15\n   2 of   9 in __main__.example_46\n***Test Failed*** 3 failures.\nFor whitespace errors, see the file /scratch/mabshoff/release-cycle/sage-3.0.4.alpha2/tmp/.doctest_time_series.py\n\t [13.1 s]\nexit code: 1024\n```\nAnd\n\n```\nmabshoff@sage:/scratch/mabshoff/release-cycle/sage-3.0.4.alpha2$ sage -t  devel/sage/sage/matrix/matrix_space.py # 1 doctests failed\nsage -t  devel/sage/sage/matrix/matrix_space.py  \n**********************************************************************\nFile \"/scratch/mabshoff/release-cycle/sage-3.0.4.alpha2/tmp/matrix_space.py\", line 653:\n    sage: list( MatrixSpace(GF(2), 2, 0) )\nExpected:\n    [[]\n    []]\nGot:\n    [[]]\n**********************************************************************\n```\nand a segfault in devel/sage/sage/matrix/matrix2.pyx.\n\nChecking the merge before taking valgrind for a spin.\n\nCheers,\n\nMichael",
    "created_at": "2008-07-06T19:48:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3356#issuecomment-23300",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

There are some doctest issues:

```
mabshoff@sage:/scratch/mabshoff/release-cycle/sage-3.0.4.alpha2$ sage -t  devel/sage/sage/finance/time_series.pyx # 3 doctests failed
sage -t  devel/sage/sage/finance/time_series.pyx            
**********************************************************************
File "/scratch/mabshoff/release-cycle/sage-3.0.4.alpha2/tmp/time_series.py", line 525:
    sage: v.linear_forecast(F)
Expected:
    86.017728504280015
Got:
    86.01772850427912
**********************************************************************
File "/scratch/mabshoff/release-cycle/sage-3.0.4.alpha2/tmp/time_series.py", line 1428:
    sage: fbm.hurst_exponent()
Expected:
    0.66787027921443409
Got:
    0.66787027921463038
**********************************************************************
File "/scratch/mabshoff/release-cycle/sage-3.0.4.alpha2/tmp/time_series.py", line 1433:
    sage: fbm.hurst_exponent()
Expected:
    0.30450273560706259
Got:
    0.30450273560706026
**********************************************************************
2 items had failures:
   1 of   7 in __main__.example_15
   2 of   9 in __main__.example_46
***Test Failed*** 3 failures.
For whitespace errors, see the file /scratch/mabshoff/release-cycle/sage-3.0.4.alpha2/tmp/.doctest_time_series.py
	 [13.1 s]
exit code: 1024
```
And

```
mabshoff@sage:/scratch/mabshoff/release-cycle/sage-3.0.4.alpha2$ sage -t  devel/sage/sage/matrix/matrix_space.py # 1 doctests failed
sage -t  devel/sage/sage/matrix/matrix_space.py  
**********************************************************************
File "/scratch/mabshoff/release-cycle/sage-3.0.4.alpha2/tmp/matrix_space.py", line 653:
    sage: list( MatrixSpace(GF(2), 2, 0) )
Expected:
    [[]
    []]
Got:
    [[]]
**********************************************************************
```
and a segfault in devel/sage/sage/matrix/matrix2.pyx.

Checking the merge before taking valgrind for a spin.

Cheers,

Michael



---

archive/issue_comments_023301.json:
```json
{
    "body": "This patch fixes the numerical noise doctest issues and one mismerge by me",
    "created_at": "2008-07-06T19:54:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3356#issuecomment-23301",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

This patch fixes the numerical noise doctest issues and one mismerge by me



---

archive/issue_comments_023302.json:
```json
{
    "body": "Attachment [trac_3356_doctest_fixes.patch](tarball://root/attachments/some-uuid/ticket3356/trac_3356_doctest_fixes.patch) by mabshoff created at 2008-07-06 20:05:46\n\nOops, part10.patch and trac_3356_doctest_fixes.patch have some conflicting changes, but I sorted them out :). part10.patch merged in Sage 3.0.4.alpha2\n\nCheers,\n\nMichael",
    "created_at": "2008-07-06T20:05:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3356#issuecomment-23302",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

Attachment [trac_3356_doctest_fixes.patch](tarball://root/attachments/some-uuid/ticket3356/trac_3356_doctest_fixes.patch) by mabshoff created at 2008-07-06 20:05:46

Oops, part10.patch and trac_3356_doctest_fixes.patch have some conflicting changes, but I sorted them out :). part10.patch merged in Sage 3.0.4.alpha2

Cheers,

Michael
