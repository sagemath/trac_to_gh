# Issue 3885: [with additional patch, positive review] Bug in free module __call__ method

archive/issues_003885.json:
```json
{
    "body": "Salman Butt ran into the following bug:\n\n```\nsage: V = QQ**2\nsage: W = V.subspace([[1,2]])\nsage: W([2,1])\n(2, 1)\n```\n\nFix is attached, but the fact that you can still do the following is possibly worrisome:\n\n```\nsage: V = QQ**2\nsage: W = V.subspace([[1,2]])\nsage: W([2,1], check=False) in W\nTrue\n```\n\nI just started a sage-devel thread to see if we should also stop this, i.e. not let users shoot themselves in the foot so easily.\n\nAssignee: @craigcitro\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/3885\n\n",
    "closed_at": "2008-09-03T00:09:49Z",
    "created_at": "2008-08-17T21:58:14Z",
    "labels": [
        "component: linear algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-3.1.2",
    "title": "[with additional patch, positive review] Bug in free module __call__ method",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/3885",
    "user": "https://github.com/craigcitro"
}
```
Salman Butt ran into the following bug:

```
sage: V = QQ**2
sage: W = V.subspace([[1,2]])
sage: W([2,1])
(2, 1)
```

Fix is attached, but the fact that you can still do the following is possibly worrisome:

```
sage: V = QQ**2
sage: W = V.subspace([[1,2]])
sage: W([2,1], check=False) in W
True
```

I just started a sage-devel thread to see if we should also stop this, i.e. not let users shoot themselves in the foot so easily.

Assignee: @craigcitro

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/3885





---

archive/issue_comments_029210.json:
```json
{
    "body": "Attachment [trac-3885.patch](tarball://root/attachments/some-uuid/ticket3885/trac-3885.patch) by @craigcitro created at 2008-08-17 21:59:43",
    "created_at": "2008-08-17T21:59:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3885#issuecomment-29210",
    "user": "https://github.com/craigcitro"
}
```

Attachment [trac-3885.patch](tarball://root/attachments/some-uuid/ticket3885/trac-3885.patch) by @craigcitro created at 2008-08-17 21:59:43



---

archive/issue_comments_029211.json:
```json
{
    "body": "Changing status from new to assigned.",
    "created_at": "2008-08-17T22:07:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3885#issuecomment-29211",
    "user": "https://github.com/craigcitro"
}
```

Changing status from new to assigned.



---

archive/issue_comments_029212.json:
```json
{
    "body": "<a id='comment:1'></a>\nCredit for this patch goes to Martin Albrecht and myself for the fix. (Sorry I didn't mention that above, Martin. :) )",
    "created_at": "2008-08-17T22:07:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3885#issuecomment-29212",
    "user": "https://github.com/craigcitro"
}
```

<a id='comment:1'></a>
Credit for this patch goes to Martin Albrecht and myself for the fix. (Sorry I didn't mention that above, Martin. :) )



---

archive/issue_events_014429.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/3885",
    "rename": {
        "from": "[with patch, needs review and discussion] Bug in free module __call__ method",
        "to": "[with patch, needs review] Bug in free module __call__ method"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3885#event-14429"
}
```



---

archive/issue_events_014430.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/3885",
    "rename": {
        "from": "[with patch, needs review] Bug in free module __call__ method",
        "to": "[with patch, positive review] Bug in free module __call__ method"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3885#event-14430"
}
```



---

archive/issue_comments_029213.json:
```json
{
    "body": "<a id='comment:3'></a>\nLooks good to me.",
    "created_at": "2008-08-29T01:20:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3885#issuecomment-29213",
    "user": "https://github.com/mwhansen"
}
```

<a id='comment:3'></a>
Looks good to me.



---

archive/issue_comments_029214.json:
```json
{
    "body": "<a id='comment:4'></a>\nWith the patch applied I am seeing the following doctest failure:\n\n```\nsage -t -long devel/sage/sage/modular/modsym/ambient.py     **********************************************************************\nFile \"/scratch/mabshoff/release-cycle/sage-3.1.2.alpha2/tmp/ambient.py\", line 1027:\n    sage: M.factorization()                    # long time (about 8 seconds)\nException raised:\n    Traceback (most recent call last):\n      File \"/scratch/mabshoff/release-cycle/sage-3.1.2.alpha2/local/lib/python2.5/doctest.py\", line 1228, in __run\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_20[6]>\", line 1, in <module>\n        M.factorization()                    # long time (about 8 seconds)###line 1027:\n    sage: M.factorization()                    # long time (about 8 seconds)\n      File \"/scratch/mabshoff/release-cycle/sage-3.1.2.alpha2/local/lib/python2.5/site-packages/sage/modular/modsym/ambient.py\", line 1143, in factorization\n        for E in self.eisenstein_submodule().decomposition(anemic=True):\n      File \"/scratch/mabshoff/release-cycle/sage-3.1.2.alpha2/local/lib/python2.5/site-packages/sage/modular/hecke/module.py\", line 582, in decomposition\n        X = t.decomposition_of_subspace(U[i], is_diagonalizable=is_diagonalizable)\n      File \"matrix2.pyx\", line 2169, in sage.matrix.matrix2.Matrix.decomposition_of_subspace (sage/matrix/matrix2.c:13376)\n      File \"matrix2.pyx\", line 2255, in sage.matrix.matrix2.Matrix.restrict (sage/matrix/matrix2.c:14068)\n      File \"element.pyx\", line 1899, in sage.structure.element.Vector.__mul__ (sage/structure/element.c:11232)\n      File \"coerce.pyx\", line 634, in sage.structure.coerce.CoercionModel_cache_maps.bin_op (sage/structure/coerce.c:6030)\n      File \"action.pyx\", line 195, in sage.categories.action.PrecomposedAction._call_ (sage/categories/action.c:3506)\n      File \"morphism.pyx\", line 88, in sage.categories.morphism.CallMorphism._call_ (sage/categories/morphism.c:2309)\n      File \"/scratch/mabshoff/release-cycle/sage-3.1.2.alpha2/local/lib/python2.5/site-packages/sage/modules/free_module.py\", line 684, in __call__\n        raise ValueError, \"element (= %s) is not in free module\"%(x,)\n    ValueError: element (= [0, 1, 0, -1, -zeta3 + 1, 1/2*zeta3 + 1, zeta3 + 1/2]) is not in free module\n**********************************************************************\n1 items had failures:\n   1 of   7 in __main__.example_20\n***Test Failed*** 1 failures.\nFor whitespace errors, see the file /scratch/mabshoff/release-cycle/sage-3.1.2.alpha2/tmp/.doctest_ambient.py\n         [10.9 s]\nexit code: 1024\n```\n\nCheers,\n\nMichael",
    "created_at": "2008-08-29T02:09:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3885#issuecomment-29214",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:4'></a>
With the patch applied I am seeing the following doctest failure:

```
sage -t -long devel/sage/sage/modular/modsym/ambient.py     **********************************************************************
File "/scratch/mabshoff/release-cycle/sage-3.1.2.alpha2/tmp/ambient.py", line 1027:
    sage: M.factorization()                    # long time (about 8 seconds)
Exception raised:
    Traceback (most recent call last):
      File "/scratch/mabshoff/release-cycle/sage-3.1.2.alpha2/local/lib/python2.5/doctest.py", line 1228, in __run
        compileflags, 1) in test.globs
      File "<doctest __main__.example_20[6]>", line 1, in <module>
        M.factorization()                    # long time (about 8 seconds)###line 1027:
    sage: M.factorization()                    # long time (about 8 seconds)
      File "/scratch/mabshoff/release-cycle/sage-3.1.2.alpha2/local/lib/python2.5/site-packages/sage/modular/modsym/ambient.py", line 1143, in factorization
        for E in self.eisenstein_submodule().decomposition(anemic=True):
      File "/scratch/mabshoff/release-cycle/sage-3.1.2.alpha2/local/lib/python2.5/site-packages/sage/modular/hecke/module.py", line 582, in decomposition
        X = t.decomposition_of_subspace(U[i], is_diagonalizable=is_diagonalizable)
      File "matrix2.pyx", line 2169, in sage.matrix.matrix2.Matrix.decomposition_of_subspace (sage/matrix/matrix2.c:13376)
      File "matrix2.pyx", line 2255, in sage.matrix.matrix2.Matrix.restrict (sage/matrix/matrix2.c:14068)
      File "element.pyx", line 1899, in sage.structure.element.Vector.__mul__ (sage/structure/element.c:11232)
      File "coerce.pyx", line 634, in sage.structure.coerce.CoercionModel_cache_maps.bin_op (sage/structure/coerce.c:6030)
      File "action.pyx", line 195, in sage.categories.action.PrecomposedAction._call_ (sage/categories/action.c:3506)
      File "morphism.pyx", line 88, in sage.categories.morphism.CallMorphism._call_ (sage/categories/morphism.c:2309)
      File "/scratch/mabshoff/release-cycle/sage-3.1.2.alpha2/local/lib/python2.5/site-packages/sage/modules/free_module.py", line 684, in __call__
        raise ValueError, "element (= %s) is not in free module"%(x,)
    ValueError: element (= [0, 1, 0, -1, -zeta3 + 1, 1/2*zeta3 + 1, zeta3 + 1/2]) is not in free module
**********************************************************************
1 items had failures:
   1 of   7 in __main__.example_20
***Test Failed*** 1 failures.
For whitespace errors, see the file /scratch/mabshoff/release-cycle/sage-3.1.2.alpha2/tmp/.doctest_ambient.py
         [10.9 s]
exit code: 1024
```

Cheers,

Michael



---

archive/issue_events_014431.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/3885",
    "rename": {
        "from": "[with patch, positive review] Bug in free module __call__ method",
        "to": "[with patch, needs work] Bug in free module __call__ method"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3885#event-14431"
}
```



---

archive/issue_events_014432.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/3885",
    "rename": {
        "from": "[with patch, needs work] Bug in free module __call__ method",
        "to": "[with additional patch, needs quick review] Bug in free module __call__ method"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3885#event-14432"
}
```



---

archive/issue_comments_029215.json:
```json
{
    "body": "<a id='comment:5'></a>\nYep, thank god for doctests. This was really hard to track down: elements of `CyclotomicField(3)` were getting created whose print representation was the same, but whose internal representation was different. (Even harder was finding out that was the problem.) The attached patch corrects the problem. I don't have a current alpha tree to test this against, so let me know if anything still breaks.",
    "created_at": "2008-09-02T06:40:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3885#issuecomment-29215",
    "user": "https://github.com/craigcitro"
}
```

<a id='comment:5'></a>
Yep, thank god for doctests. This was really hard to track down: elements of `CyclotomicField(3)` were getting created whose print representation was the same, but whose internal representation was different. (Even harder was finding out that was the problem.) The attached patch corrects the problem. I don't have a current alpha tree to test this against, so let me know if anything still breaks.



---

archive/issue_comments_029216.json:
```json
{
    "body": "<a id='comment:6'></a>\nAttachment [trac-3885-pt2.patch](tarball://root/attachments/some-uuid/ticket3885/trac-3885-pt2.patch) by mabshoff created at 2008-09-02 09:06:36\n\nWith Craig's second patch all doctests pass. Somebody more knowledgeable in this area of the code please check that this is the correct fix.\n\nCheers,\n\nMichael",
    "created_at": "2008-09-02T09:06:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3885#issuecomment-29216",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:6'></a>
Attachment [trac-3885-pt2.patch](tarball://root/attachments/some-uuid/ticket3885/trac-3885-pt2.patch) by mabshoff created at 2008-09-02 09:06:36

With Craig's second patch all doctests pass. Somebody more knowledgeable in this area of the code please check that this is the correct fix.

Cheers,

Michael



---

archive/issue_comments_029217.json:
```json
{
    "body": "<a id='comment:7'></a>\nThat looks good to me.",
    "created_at": "2008-09-02T17:28:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3885#issuecomment-29217",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:7'></a>
That looks good to me.



---

archive/issue_events_014433.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/3885",
    "rename": {
        "from": "[with additional patch, needs quick review] Bug in free module __call__ method",
        "to": "[with additional patch, positive review] Bug in free module __call__ method"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3885#event-14433"
}
```



---

archive/issue_comments_029218.json:
```json
{
    "body": "<a id='comment:8'></a>\nMerged both patches in Sage 3.1.2.rc0. Nice work Craig :)\n\nCheers,\n\nMichael",
    "created_at": "2008-09-03T00:09:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3885#issuecomment-29218",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:8'></a>
Merged both patches in Sage 3.1.2.rc0. Nice work Craig :)

Cheers,

Michael



---

archive/issue_comments_029219.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2008-09-03T00:09:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/3885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/3885#issuecomment-29219",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

Resolution: fixed



---

archive/issue_events_014434.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2008-09-03T00:09:49Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/3885",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/3885#event-14434"
}
```
