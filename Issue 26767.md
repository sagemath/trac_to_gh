# Issue 26767: Unified wrappers for libsingular structs

archive/issues_026767.json:
```json
{
    "body": "Keywords: libsingular wrapper\n\n1. Currently, there are at least **four** wrappers for libsingular's `ring*`, namely `sage.libs.singular.ring.ring_wrapper_Py`, `sage.libs.singular.function.RingWrap`, `sage.rings.polynomial.multi_polynomial.MPolynomialRing_libsingular` and `sage.rings.polynomial.plural.NCPolynomialRing_plural`. All have in common that they have a cdef attribute `cdef ring *_ring`.\n2. There is a wrapper `sage.libs.singular.function.Resolution` for resolutions, but it is so shallow that it seems almost useless, and also it is located in a strange place.\n3. There is **no** wrapper for libsingular's `ideal*`; at least I couldn't find one. By consequence, a polynomial sequence is used to store results.\n   {{{\nsage: R.<x,y,z> = GF(3)[]\nsage: ideal = sage.libs.singular.function_factory.ff.ideal\nsage: type(ideal(*tuple(R.gens()), ring=R))\n<class 'sage.rings.polynomial.multi_polynomial_sequence.PolynomialSequence_generic'>\n   }}}\n   But this means that all operations on ideals will do transformations back and forth, rather than using a once-computed `ideal*` attribute.\n\nI suggest the following:\n1. Have a simple `ring*` wrapper which replaces the two wrappers in `sage.libs.singular` and which is a base class for the two wrappers in `sage.rings.polynomial`.\n2. Have all basic libsingular wrappers in a new module `sage.libs.singular.wrappers`.\n3. Add more wrappers, in particular for ideals, so that `MPolynomialIdeal_singular_repr` can inherit from it. On a different ticket, it shall also be used to have `MPolynomailIdeal_nc_singular_repr` for ideals over non-commutative polynomial rings.\n\nIssue created by migration from https://trac.sagemath.org/ticket/27004\n\n",
    "created_at": "2019-01-02T23:11:55Z",
    "labels": [
        "interfaces",
        "major",
        "enhancement"
    ],
    "title": "Unified wrappers for libsingular structs",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26767",
    "user": "@simon-king-jena"
}
```
Keywords: libsingular wrapper

1. Currently, there are at least **four** wrappers for libsingular's `ring*`, namely `sage.libs.singular.ring.ring_wrapper_Py`, `sage.libs.singular.function.RingWrap`, `sage.rings.polynomial.multi_polynomial.MPolynomialRing_libsingular` and `sage.rings.polynomial.plural.NCPolynomialRing_plural`. All have in common that they have a cdef attribute `cdef ring *_ring`.
2. There is a wrapper `sage.libs.singular.function.Resolution` for resolutions, but it is so shallow that it seems almost useless, and also it is located in a strange place.
3. There is **no** wrapper for libsingular's `ideal*`; at least I couldn't find one. By consequence, a polynomial sequence is used to store results.
   {{{
sage: R.<x,y,z> = GF(3)[]
sage: ideal = sage.libs.singular.function_factory.ff.ideal
sage: type(ideal(*tuple(R.gens()), ring=R))
<class 'sage.rings.polynomial.multi_polynomial_sequence.PolynomialSequence_generic'>
   }}}
   But this means that all operations on ideals will do transformations back and forth, rather than using a once-computed `ideal*` attribute.

I suggest the following:
1. Have a simple `ring*` wrapper which replaces the two wrappers in `sage.libs.singular` and which is a base class for the two wrappers in `sage.rings.polynomial`.
2. Have all basic libsingular wrappers in a new module `sage.libs.singular.wrappers`.
3. Add more wrappers, in particular for ideals, so that `MPolynomialIdeal_singular_repr` can inherit from it. On a different ticket, it shall also be used to have `MPolynomailIdeal_nc_singular_repr` for ideals over non-commutative polynomial rings.

Issue created by migration from https://trac.sagemath.org/ticket/27004





---

archive/issue_comments_376496.json:
```json
{
    "body": "Potential problems come from multiple inheritance. I think Ring should stay a cdef class, perhaps CommutativeRing as well, and RingWrap has to stay cdef for sure. So, !MPolynomialRing_libsingular cannot simultaneously inherit from both CommutativeRing and RingWrap, with the current class layout of the latter two.\n\nBut it would make sense to let RingWrap inherit from Ring. After all, libsingular's `ring*` is for rings! Perhaps, for efficiency, one wouldn't always call `Ring.__init__(...)`, for instance if one really just need the RingWrap and no fancy stuff from categories.\n\nIn addition, one could move all cdef attributes of CommutativeRing to Ring. In that way, !MPolynomialRing_libsingular could in future be a Python class inheriting both from RingWrap and from CommutativeRing (there would be no layout conflict).\n\nAnd the same would be done for the non-commutative versions of libsingular rings.\n\nSo, that's what I will try, provided I find time in spite of teaching...",
    "created_at": "2019-01-05T13:12:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26767#issuecomment-376496",
    "user": "@simon-king-jena"
}
```

Potential problems come from multiple inheritance. I think Ring should stay a cdef class, perhaps CommutativeRing as well, and RingWrap has to stay cdef for sure. So, !MPolynomialRing_libsingular cannot simultaneously inherit from both CommutativeRing and RingWrap, with the current class layout of the latter two.

But it would make sense to let RingWrap inherit from Ring. After all, libsingular's `ring*` is for rings! Perhaps, for efficiency, one wouldn't always call `Ring.__init__(...)`, for instance if one really just need the RingWrap and no fancy stuff from categories.

In addition, one could move all cdef attributes of CommutativeRing to Ring. In that way, !MPolynomialRing_libsingular could in future be a Python class inheriting both from RingWrap and from CommutativeRing (there would be no layout conflict).

And the same would be done for the non-commutative versions of libsingular rings.

So, that's what I will try, provided I find time in spite of teaching...



---

archive/issue_comments_376497.json:
```json
{
    "body": "Many data types in Singular are ring dependent. Unfortunately, a Singular object doesn't seem to know which ring it belongs to, and the user needs to keep track of the ring and change into it before working with the corresponding object. Also, if that ring is killed, the contained objects are killed as well, even if the user kept a reference to them.\n\nSo, I am currently thinking that the `leftv*` wrapper should also have a pointer to a ring (it may be NULL for those types that are ring independent), increasing the ring refcount, thus preventing it from being collected.\n\nI am really unhappy with how the ring ref count currently is done: It is via a dictionary in which ring wrappers are stored. Why not use the `ref` field of the struct `ring`? After all, that field was designed to keep track of the number of references to a ring!\n\nIn other words, I also think that #13447 should be revived. I will see if I can finally fix #13447. If I can, it should be a dependency for this ticket.",
    "created_at": "2019-01-09T13:15:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26767#issuecomment-376497",
    "user": "@simon-king-jena"
}
```

Many data types in Singular are ring dependent. Unfortunately, a Singular object doesn't seem to know which ring it belongs to, and the user needs to keep track of the ring and change into it before working with the corresponding object. Also, if that ring is killed, the contained objects are killed as well, even if the user kept a reference to them.

So, I am currently thinking that the `leftv*` wrapper should also have a pointer to a ring (it may be NULL for those types that are ring independent), increasing the ring refcount, thus preventing it from being collected.

I am really unhappy with how the ring ref count currently is done: It is via a dictionary in which ring wrappers are stored. Why not use the `ref` field of the struct `ring`? After all, that field was designed to keep track of the number of references to a ring!

In other words, I also think that #13447 should be revived. I will see if I can finally fix #13447. If I can, it should be a dependency for this ticket.



---

archive/issue_comments_376498.json:
```json
{
    "body": "Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.",
    "created_at": "2019-01-15T18:15:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26767#issuecomment-376498",
    "user": "@embray"
}
```

Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.



---

archive/issue_comments_376499.json:
```json
{
    "body": "Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)",
    "created_at": "2019-03-25T10:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26767#issuecomment-376499",
    "user": "@embray"
}
```

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)



---

archive/issue_comments_376500.json:
```json
{
    "body": "As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).",
    "created_at": "2019-06-14T14:54:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26767#issuecomment-376500",
    "user": "@embray"
}
```

As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).
