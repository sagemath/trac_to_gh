# Issue 32877: Feature.require vs. is_present, is_functional

Issue created by migration from https://trac.sagemath.org/ticket/33114

Original creator: mkoeppe

Original creation time: 2022-01-04 18:43:09

CC:  slabbe mjo klee saraedum

(from slabbe in #33092?replyto=23#comment:23)

Maybe changes needs to be done with respect to `is_present()`, `is_functional()` and `require()`. In particular, I have the following questions for `@`mkoeppe:
- why `Feature.require()` does not check that `is_functional()` is True?
- should `is_present()` always return False when `is_functional` return False (even if the vocabulary that is used should logically allow it)?


---

Comment by saraedum created at 2022-01-04 19:11:47

I believe that the original idea was to use this in the build process of [SageMath](SageMath). This influence some of the choices we made back then. If I understand correctly, that's not what we are planning to do anymore.

Anyway, `require` calls `is_present` which calls `is_functional`. At least that's the idea. As far as I recall, `is_functional` is just meant as a hook that you can override to add an additional check while relying on the generic `is_present` check. It should maybe be renamed to `_is_functional` to make this more obvious.


---

Comment by saraedum created at 2022-01-04 19:13:38

So, `is_present` means: is the feature present and functional.

Similarly, `require` means: require this feature to be present in the above sense.

I believe that the task here is to improve the documentation of these methods if that is not sufficiently clear.


---

Comment by slabbe created at 2022-01-04 19:44:07

Ok, this is how I understood the feature code up to today, but the meaning of `is_present` vs `is_functional` always perturbed me.

When we speak with someone verbally, it is possible that we observe for example as in #33092 that imagemagick is "installed" on a machine, thus the convert command "is present", but it "is not functional" because it can't handle PNG files for instance. In real life, it happens that a feature is present but not functional. This is why the current design is weird a little (but probably easy to fix, for example by adding a new method `is_present_and_functional()` that would be used by `require()` and in the sagemath library.)

What I realised today in #33092#comment:20 is that JoinFeature currently does not follow the same behavior with respect to `is_present` vs `is_functional`. Instead, it follows what we would be saying logically: a feature may be present but not functional.


---

Comment by saraedum created at 2022-01-04 20:58:14

Replying to [comment:3 slabbe]:
> Ok, this is how I understood the feature code up to today, but the meaning of `is_present` vs `is_functional` always perturbed me.

I'd propose to rename `is_present` to `is_present_and_functional` and `is_functional` to `_is_functional`. I agree that it's confusing.

> What I realised today in #33092#comment:20 is that JoinFeature currently does not follow the same behavior with respect to `is_present` vs `is_functional`. Instead, it follows what we would be saying logically: a feature may be present but not functional.

Yes, that is a bug in `JoinFeature`. (Copied over from the `Latte` feature from which it was created.)


---

Comment by mkoeppe created at 2022-01-04 23:35:29

I agree with all of the above - except that it's perhaps not necessary to do the renaming `is_present` -> `is_present_and_functional`


---

Comment by slabbe created at 2022-01-05 09:48:13

Replying to [comment:5 mkoeppe]:
> I agree with all of the above - except that it's perhaps not necessary to do the renaming `is_present` -> `is_present_and_functional`

I agree, I was thinking the same. When `is_present_and_functional()` return `False`, the first question that comes is whether it is because it is not functional or whether it is not present. Thus the next question to ask is whether `is_present()` return True or False. Thus we need both `is_present_and_functional()` and `is_present()`.

Maybe the `require()` should raise a different type of error when it is not present vs not functional. Currently, when a feature is not functional the error message says the feature is not present which is weird. See #33092#comment:27.


---

Comment by saraedum created at 2022-01-05 16:55:40

Replying to [comment:6 slabbe]:
> Replying to [comment:5 mkoeppe]:
> > I agree with all of the above - except that it's perhaps not necessary to do the renaming `is_present` -> `is_present_and_functional`
> 
> I agree, I was thinking the same. When `is_present_and_functional()` return `False`, the first question that comes is whether it is because it is not functional or whether it is not present. Thus the next question to ask is whether `is_present()` return True or False. Thus we need both `is_present_and_functional()` and `is_present()`.

So, `is_functional` was never meant to be exposed to the user. It should really be protected with a `_`. It is also only meant as a hook for the `Executable` feature. I would not change that. Similarly `_is_present` is not meant to be exposed to the user in any way.

I don't think you need both `is_functional` and `is_present` for the user. I don't think you really need to distinguish why a feature can't be used like that, i.e., in a machine-readable way. What would be your use case? Instead, the checks can return a `FeatureTestResult` to provide a lot of detail why something is not sufficient.

> Maybe the `require()` should raise a different type of error when it is not present vs not functional. Currently, when a feature is not functional the error message says the feature is not present which is weird. See #33092#comment:27.

Currently, require says `not available`. We could change that wording of course. The rest of the error message is pulled out of the `FeatureTestResult` if available.


---

Comment by mkoeppe created at 2022-01-05 18:52:29

Replying to [comment:7 saraedum]:
> I don't think you need both `is_functional` and `is_present` for the user. I don't think you really need to distinguish why a feature can't be used like that, i.e., in a machine-readable way. What would be your use case? Instead, the checks can return a `FeatureTestResult` to provide a lot of detail why something is not sufficient.

+1


---

Comment by slabbe created at 2022-01-08 14:20:01

Replying to [comment:7 saraedum]:
> Replying to [comment:6 slabbe]:
> > Maybe the `require()` should raise a different type of error when it is not present vs not functional. Currently, when a feature is not functional the error message says the feature is not present which is weird. See #33092#comment:27.
> 
> Currently, require says `not available`. We could change that wording of course. The rest of the error message is pulled out of the `FeatureTestResult` if available.

Well, the full context of that line is `FeatureNotPresentError: imagemagick is not available.` When I read this and I try to interpret it, I understand that the command `convert` was simply not found on the machine. This is not the information that we want to give. The situation we have here is more tricky. The `convert` is available, the problem is that it does not work well. And here we should not say to the user "here is how to install convert" as we do currently.

Or, maybe, I am wrong on the meaning of the word `feature` or the word `present`? For you, what is the definition of a feature? For example, when `ffmpeg` is found in the PATH but can't produce a gif from a png. Is `ffmpeg` a feature? or rather `ffmpeg` + some garenty that it can do something? For me, in this case, the feature `ffmpeg` is present but it is not functional. Therefore we should not raise a `FeatureNotPresentError` and tell the user to install the feature, but rather raise a `FeatureNotFunctionalError` and tell some more meaningfull message to the user which needs to deal with this tricky situation.


---

Comment by mkoeppe created at 2022-01-09 18:40:41

Given that features map to `optional` tags, we should avoid semantics more complicated than "present" vs. "not present".


---

Comment by mkoeppe created at 2022-01-09 18:44:59

If there is an actual use case for distinguishing different levels of "presence" for a feature (present, functional, awesome, spiffy) - then it would be clearer to actually define separate features for these levels.


---

Comment by mkoeppe created at 2022-01-09 18:48:25

Replying to [comment:9 slabbe]:
> we should not raise a `FeatureNotPresentError` and tell the user to install the feature, but rather raise a `FeatureNotFunctionalError` and tell some more meaningful message to the user which needs to deal with this tricky situation.

+1 on better messages where possible, but I don't think it's useful to have a separate exception class.


---

Comment by slabbe created at 2022-01-09 21:19:09

Thanks for the answers. I agree to keep it simple and binary YES/NO. I do not have use cases for more levels of presence.

I allow myself to ask whether `is_present()` is still the good yes/no question we want to ask with the current design? Maybe a better name for it exists? Possibly `is_present_and_functional()` as suggested earlier? or something else?

I agree that my main point boils down to give good information to the user when `require()` fails.


---

Comment by slelievre created at 2022-01-12 09:00:30

Maybe rename `is_functional` to `_is_functional
and `is_present` to `is_functional`?


---

Comment by slabbe created at 2022-01-13 08:06:13

Replying to [comment:14 slelievre]:
> Maybe rename `is_functional` to `_is_functional
> and `is_present` to `is_functional`?

Personaly, I don't disagree.


---

Comment by mkoeppe created at 2022-03-06 00:58:51

Here's a minimal change to improve the situation.
----
Last 10 new commits:


---

Comment by mkoeppe created at 2022-03-06 00:58:51

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2022-03-06 00:59:12

(Last 2 commits only; it is on top of #31292)


---

Comment by mkoeppe created at 2022-03-06 01:00:27

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-03-06 01:03:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-06 01:04:06

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-03-06 01:04:34

(Last 4 commits only; it's on top of #31292.)


---

Comment by mkoeppe created at 2022-03-25 16:37:36

Let's get this in please


---

Comment by slabbe created at 2022-03-25 17:18:26

works for me. Thanks for this improvement.

I think a next step further is, as suggested in comment:14, to rename `is_functional` to `_is_functional` since only `is_present` is supposed to be used from outside.


---

Comment by slabbe created at 2022-03-25 17:18:26

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-03-25 17:38:04

Thanks!


---

Comment by vbraun created at 2022-03-30 22:33:12

Resolution: fixed


---

Comment by slabbe created at 2022-03-31 09:25:20

updated description with choices made in this ticket
