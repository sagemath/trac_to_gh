# Issue 23725: Doctest failure in src/sage/schemes/elliptic_curves/sha_tate.py

Issue created by migration from Trac.

Original creator: mderickx

Original creation time: 2017-10-03 22:18:39

CC:  cremona

On [arando](https://patchbot.sagemath.org/log/0/Ubuntu/14.04/i686/3.13.0-95-generic/arando/2017-10-03%2022:01:02?short), it is probably one of the dependencies of #23881 where it is introduced see  [the discussion starting at comment 52](https://trac.sagemath.org/ticket/23881#comment:52).

```
sage -t --long src/sage/schemes/elliptic_curves/sha_tate.py
**********************************************************************
File "src/sage/schemes/elliptic_curves/sha_tate.py", line 915, in sage.schemes.elliptic_curves.sha_tate.Sha.two_selmer_bound
Failed example:
    sh.two_selmer_bound()
Exception raised:
    Traceback (most recent call last):
      File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 515, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 885, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.schemes.elliptic_curves.sha_tate.Sha.two_selmer_bound[1]>", line 1, in <module>
        sh.two_selmer_bound()
      File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sage/schemes/elliptic_curves/sha_tate.py", line 934, in two_selmer_bound
        r = E.rank()
      File "/home/patchbot/sage-patchbot/local/lib/python2.7/site-packages/sage/schemes/elliptic_curves/ell_rational_field.py", line 2121, in rank
        raise RuntimeError('Rank not provably correct.')
    RuntimeError: Rank not provably correct.
**********************************************************************
1 item had failures:
   1 of  10 in sage.schemes.elliptic_curves.sha_tate.Sha.two_selmer_bound
    [155 tests, 1 failure, 55.87 s]
```



---

Comment by tscrim created at 2017-10-04 01:05:30

This might come from #23544.


---

Comment by jdemeyer created at 2017-10-04 09:51:06

Replying to [comment:1 tscrim]:
> This might come from #23544.

I don't think so. I was reported om sage-release to fail on Sage 8.1.beta7.

The code seems to involve the Cremona database and the `eclib` library, not PARI/GP.

I don't understand the failure though: the curve is contained in the small Cremona database which is installed by default. So the rank should just be read from the database.


---

Comment by mderickx created at 2017-10-04 10:03:05

The rank should, but maybe the two_selmer_bound which might be different from the rank is not read from the database.


---

Comment by mderickx created at 2017-10-04 10:05:14

Sorry ignore my last comment, I should have read the full traceback


---

Comment by jdemeyer created at 2017-10-04 11:04:34

New commits:


---

Comment by jdemeyer created at 2017-10-04 11:04:34

Changing status from new to needs_review.


---

Comment by charpent created at 2017-10-04 13:45:01

As far as I can tell :

* `EllipticCurve` is standard
* therefore, //<some elliptic_curve>//`.rank()` is also standard
* `database_cremona_ellcurve` is optional

If you wish to //always// consult Cremona database in any case, `database_cremona_ellcurve` should become standard.

Unless I am gravely mistaken, of course...


---

Comment by charpent created at 2017-10-04 13:45:01

Changing status from needs_review to needs_info.


---

Comment by jdemeyer created at 2017-10-04 14:03:47

Replying to [comment:12 charpent]:
> If you wish to //always// consult Cremona database in any case

There is a small database which is standard. So consulting "the" Cremona database really means: the large one if that's installed, otherwise the small one.

Also, I'm not saying that consulting always must succeed. The code to get the rank from the database is wrapped in a `try:`/`except LookupError:` block and I'm not changing that.


---

Comment by jdemeyer created at 2017-10-04 14:03:47

Changing status from needs_info to needs_review.


---

Comment by cremona created at 2017-10-04 14:28:49

A couple of comments.

   1. When the new output incudes something like "(guess = 0)" it is not a guess, it is a proved lower bound.  (Not saying a lot if it is zero, but it can be positive).   Please change "guess" to "lower bound".

   2. I see that the cached rank is no longer a dict with True/False keys but a single pair (r,T/F).  I don't know the reason for this change.  I may try to compute the rank with Proof=True (default), got a warning an retired with Proof=False.  How does this behave now?


---

Comment by jdemeyer created at 2017-10-04 14:37:14

Replying to [comment:14 cremona]:
>    2. I see that the cached rank is no longer a dict with True/False keys but a single pair (r,T/F).  I don't know the reason for this change.

This is just a simplification. I found the code dealing with the dict rather complicated. A simple tuple `(rank, proven)` does the job too.


---

Comment by jdemeyer created at 2017-10-04 14:39:27

Replying to [comment:14 cremona]:
> I may try to compute the rank with Proof=True (default), got a warning an retired with Proof=False.

Neither the old nor the new code deals with that. But you are right that it should.


---

Comment by jdemeyer created at 2017-10-04 14:39:27

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-10-04 15:15:29

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-10-04 15:17:07

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-10-04 15:17:07

Fixed the caching of non-proven output from `eclib` and the exception message.


---

Comment by mderickx created at 2017-10-04 15:21:56

Hi Jeroen, 

Very nice that you found out the cause. I'm trying to see the link to your example and the doctest failure. Because your example fails 100% of the time while the doctest only fails sporadically. Is the explanation that the curve E1 is actually already created on
line 362  with `sage: E = EllipticCurve([0, -1, 1, -929, -10595])       # 571A` and that it is quite random wether this curve still exists or is already garbage collected around the line 915 where the doctest failure occurs?

In the mean time I was able to replicate the doctest failure on arando. I needed to test it with `sage -t --global-iterations 1000` before an error showed up. It started failing on the 775th iteration and then it kept failing until the 798th doctest. This might indicate that the randomness might depend on the system load (objects being garbage collected sooner maybe).

P.s. I think it would be good to add the doctest:


```
    sage: E1 = EllipticCurve([0, -1, 1, -929, -10595])
    sage: E2 = EllipticCurve('571a1')
    sage: E2.rank()
    0
```

at the top of the file to make sure that we now have a doctest that fails 100% of the time prior to your fix, but works after it.
----
New commits:


---

Comment by cremona created at 2017-10-04 15:25:14

THanks!   Positive review once tests pass and Maarten is happy.


---

Comment by jdemeyer created at 2017-10-04 15:29:48

Replying to [comment:19 mderickx]:
> Is the explanation that the curve E1 is actually already created on
> line 362  with `sage: E = EllipticCurve([0, -1, 1, -929, -10595])       # 571A` and that it is quite random wether this curve still exists or is already garbage collected around the line 915 where the doctest failure occurs?

Exactly.


---

Comment by charpent created at 2017-10-04 15:34:00

FYI, a `make ptestlong` started //before// Cremona's [comment](https://trac.sagemath.org/ticket/23962#comment:14) passed with no errors whatsoever.

It seems to me that [comment 20](https://trac.sagemath.org/ticket/23962#comment:20) implies yet another patch-push-test cycle. I'll refrain from `ptest`ing it until that.


---

Comment by jdemeyer created at 2017-10-04 15:40:27

Replying to [comment:19 mderickx]:
> I think it would be good to add the doctest:
> 
> {{{
>     sage: E1 = EllipticCurve([0, -1, 1, -929, -10595])
>     sage: E2 = EllipticCurve('571a1')
>     sage: E2.rank()
>     0
> }}}
> at the top of the file to make sure that we now have a doctest that fails 100% of the time prior to your fix, but works after it.

That's what the 1888b1 (*) test does. It's testing the essence of this patch, namely that `rank()` should work for curves which are in the database but which are not constructed using the Cremona label. Personally, I don't think that adding `E2 = EllipticCurve('1888b1')` would add anything interesting to that test.

(*) I looked for a curve which is not used anywhere else in doctests but for which `eclib` also fails to compute the rank due to a non-trivial Sha[2]. Thanks to the LMFDB for the handy query page!


---

Comment by cremona created at 2017-10-04 15:46:30

Replying to [comment:23 jdemeyer]:
> 
> (*) I looked for a curve which is not used anywhere else in doctests but for which `eclib` also fails to compute the rank due to a non-trivial Sha[2]. Thanks to the LMFDB for the handy query page!

We are working on an api for the LMFDB which would make it easy to get all this data (and more) using only an internet connection, making the optional database almost redundant.


---

Comment by mderickx created at 2017-10-04 16:12:52

> That's what the 1888b1 (*) test does. It's testing the essence of this patch, namely that `rank()` should work for curves which are in the database but which are not constructed using the Cremona label. Personally, I don't think that adding `E2 = EllipticCurve('1888b1')` would add anything interesting to that test.
> 
> (*) I looked for a curve which is not used anywhere else in doctests but for which `eclib` also fails to compute the rank due to a non-trivial Sha[2]. Thanks to the LMFDB for the handy query page!

Thanks for this explanation, the test itself suffices, and I am happy with the rest of the code (although there might be some nitpicking that your tuple instead of dict change made the caching of `.__gens` and the `.__rank` less consistent and I like coding style consistency).

I would like to add a little bit more explanation to this test later this evening (I have to leave now). Since now the text around this test does not seem to make clear the subtle issue that different ways of initialising the same globally unique elliptic curve should give actually an object that behaves the same (ok it has the link to this trac ticket).


---

Comment by jdemeyer created at 2017-10-05 08:10:07

Replying to [comment:25 mderickx]:
> although there might be some nitpicking that your tuple instead of dict change made the caching of `.__gens` and the `.__rank` less consistent and I like coding style consistency.

That's true but I wanted to leave that for a separate ticket.

> I would like to add a little bit more explanation to this test later this evening (I have to leave now). Since now the text around this test does not seem to make clear the subtle issue that different ways of initialising the same globally unique elliptic curve should give actually an object that behaves the same (ok it has the link to this trac ticket).

OK. Does this ticket have positive review from you apart from that documentation issue?


---

Comment by git created at 2017-10-05 08:35:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-10-05 08:46:00

I added a small extra test. Is this what you had in mind?


---

Comment by mderickx created at 2017-10-05 12:38:29

The change I had in mind was slightly different. I agree with the code you have written till now, so that part gets positive review from me. Do you agree with my added extra explanation in the test?
----
New commits:


---

Comment by jdemeyer created at 2017-10-05 12:44:35

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-10-05 12:44:35

The fact that "Elliptic curves are globally unique even if they are initialized differently" is already tested in `src/sage/schemes/elliptic_curves/constructor.py`

So there is no need for the extra test

```
        Elliptic curves are globally unique even if they are initialized differently::

            sage: E1 = EllipticCurve([-517, -4528])
            sage: E2 = EllipticCurve('1888b1')
            sage: E1 is E2
            True
```



---

Comment by mderickx created at 2017-10-05 13:12:04

Yes, I know, but I like my doctest to tell a story, this is mainly an example leading up to the explanatory text coming after it.


---

Comment by jdemeyer created at 2017-10-05 14:51:05

OK, fine. Could you just remove the duplicate blank line and limit your lines to 72 characters in length?


---

Comment by jdemeyer created at 2017-10-06 08:08:57

In order to move forward with this blocker ticket, I suggest to merge the code here and move the discussion about the docs to a new ticket: #23974
----
New commits:


---

Comment by jdemeyer created at 2017-10-06 08:08:57

Changing status from needs_work to positive_review.


---

Comment by git created at 2017-10-06 10:00:50

Changing status from positive_review to needs_review.


---

Comment by git created at 2017-10-06 10:00:50

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-10-06 10:04:07

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-10-15 09:22:29

Resolution: fixed
