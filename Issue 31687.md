# Issue 31687: sage -t: Do not run pytest on individual files

Issue created by migration from https://trac.sagemath.org/ticket/31924

Original creator: mkoeppe

Original creation time: 2021-06-07 18:08:02

CC:  @tobiasdiez soehms cremona dimpase saraedum isuruf tscrim

pytest is configured to only discover `*_test.py` files; but if one uses `sage -t` with file arguments, this will override it and lead to many errors:


```
$ ./sage -t  src/sage/databases/*.py 
too many failed tests, not using stored timings
Running doctests with ID 2021-06-07-11-04-14-3c1f8784.
Using --optional=4ti2,bliss,build,database_knotinfo,dochtml,e_antic,homebrew,jupymake,latte_int,lidia,lrslib,normaliz,pip,sage,sage_spkg
Doctesting 16 files.
sage -t --random-seed=0 src/sage/databases/__init__.py
    [0 tests, 0.00 s]
sage -t --random-seed=0 src/sage/databases/all.py
    [5 tests, 0.10 s]
sage -t --random-seed=0 src/sage/databases/conway.py
    [42 tests, 0.10 s]
sage -t --random-seed=0 src/sage/databases/cremona.py
    [133 tests, 0.31 s]
sage -t --random-seed=0 src/sage/databases/cunningham_tables.py
    [0 tests, 0.00 s]
sage -t --random-seed=0 src/sage/databases/db_class_polynomials.py
    [7 tests, 0.01 s]
sage -t --random-seed=0 src/sage/databases/db_modular_polynomials.py
    [13 tests, 0.01 s]
sage -t --random-seed=0 src/sage/databases/findstat.py
    [122 tests, 0.25 s]
sage -t --random-seed=0 src/sage/databases/jones.py
    [8 tests, 0.05 s]
sage -t --random-seed=0 src/sage/databases/knotinfo_db.py
    [97 tests, 1.80 s]
sage -t --random-seed=0 src/sage/databases/odlyzko.py
    [0 tests, 0.00 s]
sage -t --random-seed=0 src/sage/databases/oeis.py
    [134 tests, 0.91 s]
sage -t --random-seed=0 src/sage/databases/sloane.py
    [0 tests, 0.00 s]
sage -t --random-seed=0 src/sage/databases/sql_db.py
    [293 tests, 0.27 s]
sage -t --random-seed=0 src/sage/databases/stein_watkins.py
    [12 tests, 0.01 s]
sage -t --random-seed=0 src/sage/databases/symbolic_data.py
    [0 tests, 0.00 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 4.6 seconds
    cpu time: 3.9 seconds
    cumulative wall time: 3.8 seconds
============================================================================== test session starts ===============================================================================
platform darwin -- Python 3.9.5, pytest-6.2.4, py-1.10.0, pluggy-0.13.1
rootdir: /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src, configfile: tox.ini
collected 0 items / 7 errors                                                                                                                                                     

===================================================================================== ERRORS =====================================================================================
_____________________________________________________________________ ERROR collecting sage/databases/all.py _____________________________________________________________________
ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/databases/all.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
src/sage/databases/all.py:51: in <module>
    from .sql_db import SQLQuery, SQLDatabase
E   ImportError: attempted relative import with no known parent package
_____________________________________________________________________ ERROR collecting sage/databases/all.py _____________________________________________________________________
ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/databases/all.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
src/sage/databases/all.py:51: in <module>
    from .sql_db import SQLQuery, SQLDatabase
E   ImportError: attempted relative import with no known parent package
___________________________________________________________________ ERROR collecting sage/databases/cremona.py ___________________________________________________________________
ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/databases/cremona.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
src/sage/databases/cremona.py:52: in <module>
    from .sql_db import SQLDatabase, verify_column
E   ImportError: attempted relative import with no known parent package
____________________________________________________________ ERROR collecting sage/databases/db_class_polynomials.py _____________________________________________________________
ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/databases/db_class_polynomials.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
src/sage/databases/db_class_polynomials.py:14: in <module>
    from .db_modular_polynomials import _dbz_to_integers
E   ImportError: attempted relative import with no known parent package
__________________________________________________________________ ERROR collecting sage/databases/findstat.py ___________________________________________________________________
src/sage/databases/findstat.py:329: in <module>
    class FindStat(UniqueRepresentation, SageObject):
sage/misc/nested_class.pyx:318: in sage.misc.nested_class.NestedClassMetaclass.__init__
    ???
E   KeyError: 'findstat'
_________________________________________________________________ ERROR collecting sage/databases/knotinfo_db.py _________________________________________________________________
src/sage/databases/knotinfo_db.py:330: in <module>
    class KnotInfoDataBase(SageObject, UniqueRepresentation):
sage/misc/nested_class.pyx:318: in sage.misc.nested_class.NestedClassMetaclass.__init__
    ???
E   KeyError: 'knotinfo_db'
____________________________________________________________________ ERROR collecting sage/databases/oeis.py _____________________________________________________________________
src/sage/databases/oeis.py:651: in <module>
    class OEISSequence(SageObject, UniqueRepresentation):
sage/misc/nested_class.pyx:318: in sage.misc.nested_class.NestedClassMetaclass.__init__
    ???
E   KeyError: 'oeis'
============================================================================ short test summary info =============================================================================
ERROR src/sage/databases/all.py
ERROR src/sage/databases/all.py
ERROR src/sage/databases/cremona.py
ERROR src/sage/databases/db_class_polynomials.py
ERROR src/sage/databases/findstat.py - KeyError: 'findstat'
ERROR src/sage/databases/knotinfo_db.py - KeyError: 'knotinfo_db'
ERROR src/sage/databases/oeis.py - KeyError: 'oeis'
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 7 errors during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
```



---

Comment by mkoeppe created at 2021-06-19 20:10:45

Changing priority from major to critical.


---

Comment by soehms created at 2021-07-02 16:40:47

It seems that there is no way to tell `pytest` to ignore non matching files from the argument list on throwing these error messages.

So, is there anything standing against just doing it like this?


```diff
diff --git a/src/bin/sage-runtests b/src/bin/sage-runtests
index 16d3295..e852853 100755
--- a/src/bin/sage-runtests
+++ b/src/bin/sage-runtests
@@ -143,15 +143,16 @@ if __name__ == "__main__":
     DC = DocTestController(options, args)
     err = DC.run()

-    try:
-        exit_code_pytest = 0
-        import pytest
-        pytest_options = ["--import-mode", "importlib"]
-        if options.verbose:
-            pytest_options.append("-v")
-        exit_code_pytest = pytest.main(pytest_options + args)
-    except ModuleNotFoundError:
-        print("Pytest is not installed, skip checking tests that rely on it.")
+    exit_code_pytest = 0
+    if not args:
+        try:
+            import pytest
+            pytest_options = ["--import-mode", "importlib"]
+            if options.verbose:
+                pytest_options.append("-v")
+            exit_code_pytest = pytest.main(pytest_options + args)
+        except ModuleNotFoundError:
+            print("Pytest is not installed, skip checking tests that rely on it.")
```



---

Comment by mkoeppe created at 2021-07-02 16:48:11

Directory arguments work fine, it's just regular file arguments that cause the trouble.


---

Comment by soehms created at 2021-07-03 10:36:01

Replying to [comment:4 mkoeppe]:
> Directory arguments work fine, it's just regular file arguments that cause the trouble.

I see! I will have a look at it next week!


---

Comment by @tobiasdiez created at 2021-07-04 12:51:53

I think the problem is that in `pytest.main(pytest_options + args)` the argument `-t  src/sage/databases/*.py` is appended, but the correct format for pytest to only test a single file would be without the `-t`, i.e. `pytest src/sage/databases/*.py` should work.


---

Comment by soehms created at 2021-07-06 10:36:57

Replying to [comment:6 gh-tobiasdiez]:
> I think the problem is that in `pytest.main(pytest_options + args)` the argument `-t  src/sage/databases/*.py` is appended, but the correct format for pytest to only test a single file would be without the `-t`, i.e. `pytest src/sage/databases/*.py` should work.

I cannot verify this on my environment:



```bash
~/devel/sage$ ./local/bin/pytest src/sage/databases/knotinfo_db.py
======================================================================================================================================== test session starts ========================================================================================================================================
platform linux -- Python 3.9.5, pytest-6.2.4, py-1.10.0, pluggy-0.13.1
rootdir: /home/sebastian/devel/sage/src, configfile: tox.ini
collected 0 items / 1 error

============================================================================================================================================== ERRORS ===============================================================================================================================================
__________________________________________________________________________________________________________________________ ERROR collecting sage/databases/knotinfo_db.py ___________________________________________________________________________________________________________________________
ImportError while importing test module '/home/sebastian/devel/sage/src/sage/databases/knotinfo_db.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
local/lib/python3.9/importlib/__init__.py:127: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
src/sage/databases/knotinfo_db.py:31: in <module>
    from sage.structure.sage_object import SageObject
src/sage/structure/__init__.py:2: in <module>
    import sage.structure.element
E   ModuleNotFoundError: No module named 'sage.structure.element'
====================================================================================================================================== short test summary info ======================================================================================================================================
ERROR src/sage/databases/knotinfo_db.py
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 1 error during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
========================================================================================================================================= 1 error in 0.29s ==========================================================================================================================================
```



---

Comment by @tobiasdiez created at 2021-07-06 10:52:40

Okay, then I misread the exception message. Thanks for the investigation.

So the problem is that pytest doesn't find the compiled cython modules. I think the common advice is to use the editable install. Another solution that might work is to install and run pytest from the same virtual environment where sage is installed in. Finally, there are some hacks to add the sage path in `sys.path` as outlined here: https://github.com/pytest-dev/pytest/issues/2421#issuecomment-403724503


---

Comment by soehms created at 2021-07-07 08:38:03

Replying to [comment:8 gh-tobiasdiez]:

> So the problem is that pytest doesn't find the compiled cython modules.

Why does it find them for directory arguments?

> I think the common advice is to use the editable install. Another solution that might work is to install and run pytest from the same virtual environment where sage is installed in.

How can we achieve one of these options?

> Finally, there are some hacks to add the sage path in `sys.path` as outlined here: https://github.com/pytest- dev/pytest/issues/2421#issuecomment-403724503

I don't think that it is worth to do that (citation from the comment: _And do not forget to remove this before publishing to PyPI_).


---

Comment by @tobiasdiez created at 2021-07-07 11:22:46

Replying to [comment:9 soehms]:
> Replying to [comment:8 gh-tobiasdiez]:
> 
> > So the problem is that pytest doesn't find the compiled cython modules.
> 
> Why does it find them for directory arguments?

Good question. I have no idea. Maybe the directory argument is in a wrong format so that pytest actually doesn't try to load any test files? 

> 
> > I think the common advice is to use the editable install. Another solution that might work is to install and run pytest from the same virtual environment where sage is installed in.
> 
> How can we achieve one of these options?

The editable install is possible since #31377 and should just work. I'm not familiar enough with the "usual" sage build to be able to recommend a solution that works with it. In the end, you need to specify the sage install directory as part of the PYTHON_PATH so that pytest is able to find the compiled cython modules. Maybe `@`mkoeppe has an idea.


---

Comment by mkoeppe created at 2021-07-07 19:46:49

Replying to [comment:9 soehms]:
> Replying to [comment:8 gh-tobiasdiez]:
> 
> > So the problem is that pytest doesn't find the compiled cython modules.
> 
> Why does it find them for directory arguments?

I don't think it does. What is happening, if I'm not mistaken, is simply that pytest, as configured in `src/tox.ini`, only runs for Python files matching the pattern `*_test.py`; modified with the exclusions declared in `src/conftest.py`. When you pass the names of individual Python files to it, the pattern matching is overridden.

Hence my suggestion of a workaround -- filter out Python file name arguments before passing them to pytest when invoked via `sage -t`.


---

Comment by @tobiasdiez created at 2021-07-07 21:02:59

Yes, that would work as a workaround. However, the underlying problem is still that pytest cannot find cython modules and I think this should be fixed as well (since otherwise you cannot have a pytest test file that has similar imports as knotinfo_db.py)


---

Comment by mkoeppe created at 2021-07-07 21:34:32

Replying to [comment:12 gh-tobiasdiez]:
> the underlying problem is still that pytest cannot find cython modules and I think this should be fixed as well (since otherwise you cannot have a pytest test file that has similar imports as knotinfo_db.py)

Yes, I agree, but that would be another ticket, as this is not "critical" for Sage 9.4.


---

Comment by soehms created at 2021-07-08 07:40:55

Replying to [comment:10 gh-tobiasdiez]:
> The editable install is possible since #31377 and should just work. I'm not familiar enough with the "usual" sage build to be able to recommend a solution that works with it. In the end, you need to specify the sage install directory as part of the PYTHON_PATH so that pytest is able to find the compiled cython modules. Maybe `@`mkoeppe has an idea.

After building Sage with `./configure --enable-editable` the issue still shows. What could I have done wrong?


---

Comment by soehms created at 2021-07-08 07:43:47

Replying to [comment:11 mkoeppe]:
> Replying to [comment:9 soehms]:
> > Replying to [comment:8 gh-tobiasdiez]:
> > 
> > > So the problem is that pytest doesn't find the compiled cython modules.
> > 
> > Why does it find them for directory arguments?
> 
> I don't think it does. What is happening, if I'm not mistaken, is simply that pytest, as configured in `src/tox.ini`, only runs for Python files matching the pattern `*_test.py`; modified with the exclusions declared in `src/conftest.py`. When you pass the names of individual Python files to it, the pattern matching is overridden.
> 

First, I thought the same. But, the following output made me doubt: `collected 0 items / 1 error`.



> Hence my suggestion of a workaround -- filter out Python file name arguments before passing them to pytest when invoked via `sage -t`.
> 
>

Passing an empty argument list, causes an error, as well:


```
:~/devel/sage$ sage -t --new
Running doctests with ID 2021-07-08-09-15-06-93fe9beb.
Git branch: develop
Using --optional=build,debian,dochtml,pip,sage,sage_spkg
Doctesting files changed since last git commit
No files to doctest
======================================================================================================================================== test session starts ========================================================================================================================================
platform linux -- Python 3.9.5, pytest-6.2.4, py-1.10.0, pluggy-0.13.1
rootdir: /home/sebastian/devel/sage
collected 0 items / 1 error

============================================================================================================================================== ERRORS ===============================================================================================================================================
___________________________________________________________________________________________________________________________________ ERROR collecting test session ___________________________________________________________________________________________________________________________________
local/lib/python3.9/site-packages/IPython/conftest.py:9: in <module>
    from .testing import tools
E   ImportError: attempted relative import with no known parent package
====================================================================================================================================== short test summary info ======================================================================================================================================
ERROR  - ImportError: attempted relative import with no known parent package
```


The same output shows with `./local/bin/pytest --import-mode importlib`


---

Comment by mkoeppe created at 2021-07-08 14:25:07

Replying to [comment:15 soehms]:
> Passing an empty argument list, causes an error, as well

OK then, that's another case in which `sage -t` should not invoke pytest.


---

Comment by soehms created at 2021-07-12 08:22:15

I would implement the workaround suggested in comment 11. But at the moment I'm sticking at the following question: What is the best way to share the pattern `*_test.py` between `src/tox.ini` and `sage-runtests`?


---

Comment by @tobiasdiez created at 2021-11-02 18:20:13

Thinking about this again, I was wondering what is the desired behavior of the `-t <files>` argument?
The following seems reasonable to me:

- If `<files>` is a folder, then test all "testable" files in that folder. Here "testable" takes e.g. the file extension (py, rst) into account; and also the pre-defined filter for pytest (`_test.py` ending).
- If `<files>` is a path to a file (or a glob), then test exactly those files without taking the above "testable" criteria into account. One might argue that one should also intersect with "testable" but I guess its better to trust the user that he knows why he wants exactly these files to be tested.

This also seems to be the default behavior of `pytest` (i.e. run `pytest <files>` with either a folder or a fixed path). It also seems to be that sage-runtests is behaving exactly like this, so I don't know if the test discovery should really be changed.

According to this point of view, the reported error is not really a problem with the pytest test discovery but more so an issue with loading these files as modules. If the import would work, pytest would try to find pytest tests in these files, which don't exist, so it would simply not collect anything.


---

Comment by soehms created at 2021-11-04 19:15:14

Replying to [comment:21 gh-tobiasdiez]:
> According to this point of view, the reported error is not really a problem with the pytest test discovery but more so an issue with loading these files as modules. If the import would work, pytest would try to find pytest tests in these files, which don't exist, so it would simply not collect anything.

To you mean to replace relative import statements by absolute ones all over the source code? Would this solve the problem?

BTW: Did you note that the `pytest` call in `sage-runtests` is broken since 9.5.beta3 (see [this comment](https://groups.google.com/g/sage-release/c/yd4qumrBbm0/m/oHEyfKSJAQAJ) in the according release management thread):


```sage
Traceback (most recent call last):
  File "/home/sebastian/devel/sage/src/bin/sage-runtests", line 159, in <module>
    exit_code_pytest = pytest.main(pytest_options + args)
TypeError: can only concatenate list (not "Namespace") to list
```


Probably this is due to #32332.


---

Comment by @tobiasdiez created at 2021-11-17 21:32:32

I don't have much experience with relative imports and namespace imports. But yes, converting relative imports to absolute ones should fix the issue.


---

Comment by tornaria created at 2021-11-22 17:03:12

I get a doctest failure in `src/sage/tests/cmdline.py` that seems to be related.


```
sage -t --random-seed=156938138878576468116341825690522372403 src/sage/tests/cmdline.py
**********************************************************************
File "src/sage/tests/cmdline.py", line 325, in sage.tests.cmdline.test_executable
Failed example:
    ret
Expected:
    0
Got:
    4
**********************************************************************
File "src/sage/tests/cmdline.py", line 330, in sage.tests.cmdline.test_executable
Failed example:
    ret
Expected:
    0
Got:
    5
**********************************************************************
1 item had failures:
   2 of 221 in sage.tests.cmdline.test_executable
    [220 tests, 2 failures, 48.13 s]
----------------------------------------------------------------------
```


The second failure gets fixed after #32892 but not the first one.

Here's a standalone example of the issue:

```
$ cat my_script.sage                                             
# -*- coding: utf-8 -*-
'''This is a test file.
And I am its doctest'''
def my_add(a):
    '''
    Add 2 to a.

        EXAMPLES::

            sage: my_add(2)
            4
        '''
    return a + 2
$ ./sage -t my_script.sage ; echo $?                             
Running doctests with ID 2021-11-22-16-48-40-b731cf3e.
Git branch: develop
Using --optional=build,pip,sage,sage.geometry.polyhedron,sage.rings.real_double,sage_spkg,void
Doctesting 1 file.
sage -t --warn-long 36.1 --random-seed=215445574591070240478383051094230654766 my_script.sage
    [1 test, 0.00 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 0.0 seconds
    cpu time: 0.0 seconds
    cumulative wall time: 0.0 seconds
============================================================================ test session starts =============================================================================
platform linux -- Python 3.9.7, pytest-6.2.5, py-1.10.0, pluggy-1.0.0
rootdir: /usr/lib/sage-9.5.beta7
collected 0 items                                                                                                                                                            

=========================================================================== no tests ran in 0.00s ============================================================================
ERROR: not found: /usr/lib/sage-9.5.beta7/my_script.sage
(no name '/usr/lib/sage-9.5.beta7/my_script.sage' in any of [])

4
```


What I think is going on: pytest is called by

```
exit_code_pytest = pytest.main(pytest_options + args.filenames)
```

where `args.filenames = ['my_script.sage']`. But pytest is skipping `my_script.sage` since it doesn't match patterns `*.py`, `*.txt` or `*.rst` (or something like that). That's the reason for the "ERROR: not found" in there, and the error code is 4 (pytest command line usage error).

I don't know what's a proper way to fix this. Maybe filter out the list of files in `args.filenames` so that only the files that pytest likes get through (not `*.sage`, anyway). Warning: when `args.filenames` is not empty but it becomes empty after filtering, the call to pytest must be skipped otherwise pytest just tests everything recursively, which is not what we want.


---

Comment by soehms created at 2021-11-30 17:01:36

Replying to [comment:23 gh-tobiasdiez]:
> I don't have much experience with relative imports and namespace imports. But yes, converting relative imports to absolute ones should fix the issue.

Sounds like we should make a script that replaces all relative import statements by an absolute one (all over the source tree). Are we sure that there are no such import statement being intentional (by whatever reason)?


---

Comment by soehms created at 2021-11-30 17:07:17

Replying to [comment:24 tornaria]:
> I don't know what's a proper way to fix this. Maybe filter out the list of files in `args.filenames` so that only the files that pytest likes get through (not `*.sage`, anyway). Warning: when `args.filenames` is not empty but it becomes empty after filtering, the call to pytest must be skipped otherwise pytest just tests everything recursively, which is not what we want.

What is the difference to the suggestion made in comment:11 ff? Do you have a hint to the question I asked in comment:17 ?


---

Comment by tornaria created at 2021-11-30 17:29:34

Replying to [comment:26 soehms]:
> What is the difference to the suggestion made in comment:11 ff?

I don't see any difference.


> Do you have a hint to the question I asked in comment:17 ?

No idea.

I only installed pytest because of this message at the end of testing: "Pytest is not installed, skip checking tests that rely on it." I've since learned that I shouldn't. Maybe it's better to remove this warning until this is fixed? AFAICT there are very few tests (if any) that require pytest.


---

Comment by dimpase created at 2021-11-30 20:12:04

Replying to [comment:8 gh-tobiasdiez]:
> Okay, then I misread the exception message. Thanks for the investigation.
> 
> So the problem is that pytest doesn't find the compiled cython modules. I think the common advice is to use the editable install. Another solution that might work is to install and run pytest from the same virtual environment where sage is installed in. Finally, there are some hacks to add the sage path in `sys.path` as outlined here: https://github.com/pytest-dev/pytest/issues/2421#issuecomment-403724503

there is `pytest-cython` which allows one to run `pytest` on cython files, like
`pytest --doctest-cython ...` - I found out about it while working on #25009, which led to
https://github.com/dimpase/primecountpy
(to be moved to https://github.com/sagemath/primecountpy later).


---

Comment by chapoton created at 2022-01-29 08:58:50

bump to 9.6


---

Comment by @tobiasdiez created at 2022-02-01 18:18:12

This issue should be fixed by #32975.


---

Comment by mkoeppe created at 2022-03-19 17:19:33

... which is stalled in "needs_work".


---

Comment by tornaria created at 2022-03-19 18:26:14

Replying to [comment:30 gh-tobiasdiez]:
> This issue should be fixed by #32975.

That ticket seems completely unrelated to the issue here.


---

Comment by @tobiasdiez created at 2022-03-20 12:34:55

I don't exactly remember why #32975 fixes this issue, but for me the command from the ticket description works on top of that ticket. I think the problem was the `collect_ignore` patterns in the test config that has been removed in #32975.


---

Comment by mkoeppe created at 2022-03-20 18:48:23

With #32975, the failures in the ticket description are fixed.


---

Comment by mkoeppe created at 2022-03-20 18:49:08

However, related to comment:24:

```
$ ./sage -tp src/sage/tests/cmdline.py
too many failed tests, not using stored timings
Running doctests with ID 2022-03-20-11-46-21-1dc8fb11.
Using --optional=4ti2,buckygen,ccache,cryptominisat,debugpy,e_antic,gap_packages,homebrew,igraph,jupymake,latte_int,libsemigroups,lidia,lrslib,meataxe,normaliz,pip,polytopes_db_4d,pynormaliz,sage,sage_spkg,texttable
Features to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,nauty,palp,pandoc,pdf2svg,pdftocairo,plantri,polytopes_db,polytopes_db_4d,pynormaliz,python_igraph,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib
Doctesting 1 file using 8 threads.
sage -t --random-seed=23402257756506608859254049173870803147 src/sage/tests/cmdline.py
**********************************************************************
File "src/sage/tests/cmdline.py", line 312, in sage.tests.cmdline.test_executable
Failed example:
    ret
Expected:
    0
Got:
    4
**********************************************************************
1 item had failures:
   1 of 218 in sage.tests.cmdline.test_executable
    [217 tests, 1 failure, 67.30 s]
----------------------------------------------------------------------
sage -t --random-seed=23402257756506608859254049173870803147 src/sage/tests/cmdline.py  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 67.4 seconds
    cpu time: 0.3 seconds
    cumulative wall time: 67.3 seconds
Features detected for doctesting: pandoc
=================================================================================== test session starts ===================================================================================
platform darwin -- Python 3.10.2, pytest-7.0.1, pluggy-1.0.0
rootdir: /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src, configfile: tox.ini
collected 1 item                                                                                                                                                                          

src/sage/tests/cmdline.py E                                                                                                                                                         [100%]

========================================================================================= ERRORS ==========================================================================================
____________________________________________________________________________ ERROR at setup of test_executable ____________________________________________________________________________
file /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/tests/cmdline.py, line 61
  def test_executable(args, input="", timeout=100.0, pydebug_ignore_warnings=False, **kwds):
E       fixture 'args' not found
>       available fixtures: add_imports, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, doctest_namespace, monkeypatch, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory
>       use 'pytest --fixtures [testpath]' for help on them.

/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/tests/cmdline.py:61
================================================================================= short test summary info =================================================================================
ERROR src/sage/tests/cmdline.py::test_executable
==================================================================================== 1 error in 0.01s =====================================================================================
```



---

Comment by @tobiasdiez created at 2022-03-20 19:01:28

Not sure how to approach fixing the error that pytesting `tests/cmdline.py` is not working.
What is happening here is the following:
- The `-t` argument overwrites pytests check that test files have to end on `_test.py` (this is expected behavior and is needed if you want to run pytests specified in a custom test file)
- Pytest is then searching for test methods in `cmdline.py` and finds `test_executable` as, by default, pytest will consider any function prefixed with test as a test.

Would it be okay to rename `test_executable` to say `run_executable` so that it is no longer discovered by pytest?


---

Comment by mkoeppe created at 2022-03-20 19:04:35

`$ git grep '^def test' src/sage` reveals lots of files that would need changing. I think we need a better solution than that.


---

Comment by mkoeppe created at 2022-03-20 19:06:30

I think this really needs the change that the ticket title says: "sage -t: Do not run pytest on individual files"
(... unless they match the pytest file pattern...)


---

Comment by @tobiasdiez created at 2022-03-20 19:37:15

Replying to [comment:38 mkoeppe]:
> `$ git grep '^def test' src/sage` reveals lots of files that would need changing. I think we need a better solution than that.

Yeah, there are quite a few but also not sooo super many (around 60 hits). One could also skip these methods, https://docs.pytest.org/en/6.2.x/skipping.html#skip.

> I think this really needs the change that the ticket title says: "sage -t: Do not run pytest on individual files" (... unless they match the pytest file pattern...) 

I'm not a big fan of this. The longterm goal is to use pytest also for the doctests (replacing sages custom doctest runner) and for this doctests and pytests should be treated in the same way.


---

Comment by mkoeppe created at 2022-03-20 20:09:21

Replying to [comment:41 gh-tobiasdiez]:
> Replying to [comment:38 mkoeppe]:
> > `$ git grep '^def test' src/sage` reveals lots of files that would need changing. I think we need a better solution than that.
> 
> Yeah, there are quite a few but also not sooo super many (around 60 hits). One could also skip these methods, https://docs.pytest.org/en/6.2.x/skipping.html#skip.

If skipping is done with the pytest decorators, we would somehow have to have a version of this decorator that becomes a no-op if pytest is not installed.


---

Comment by mkoeppe created at 2022-03-20 20:13:48

Replying to [comment:41 gh-tobiasdiez]:
> Replying to [comment:38 mkoeppe]:
> > `$ git grep '^def test' src/sage` reveals lots of files that would need changing. I think we need a better solution than that.
> 
> Yeah, there are quite a few but also not sooo super many (around 60 hits). One could also skip these methods, https://docs.pytest.org/en/6.2.x/skipping.html#skip.

I think it's fine to rename them if they are only used by doctests in the same module.
Then we might argue that it was not really intended to be in the public interface and should have been named `_test...`.


---

Comment by mkoeppe created at 2022-03-21 23:29:14

Replying to [comment:41 gh-tobiasdiez]:
> > I think this really needs the change that the ticket title says: "sage -t: Do not run pytest on individual files" (... unless they match the pytest file pattern...) 
> 
> I'm not a big fan of this. The longterm goal is to use pytest also for the doctests (replacing sages custom doctest runner) and for this doctests and pytests should be treated in the same way.

That's fine to keep in mind for the long term. But we really need to restore a non-broken doctesting facility. I marked this as "critical" 9 months ago and we released 9.4 and 9.5 with it. It's overdue to fix it.


---

Comment by mkoeppe created at 2022-03-21 23:41:37

New commits:


---

Comment by mkoeppe created at 2022-03-21 23:41:37

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2022-03-21 23:57:35

Replying to [comment:45 mkoeppe]:
> Replying to [comment:41 gh-tobiasdiez]:
> > The longterm goal is to use pytest also for the doctests (replacing sages custom doctest runner) and for this doctests and pytests should be treated in the same way.
> 
> That's fine to keep in mind for the long term.

I've opened #33546 so that we don't forget.


---

Comment by tornaria created at 2022-03-22 00:17:38

Looks good to me, I will test and report back.

I assume I only have to test the last commit ([16c1b69](https://git.sagemath.org/sage.git/commit?id=16c1b69fb9960c361119039bde5bc99fd892ca5d)) since the other commits have been tested (and indeed already merged) as part of #32975.


---

Comment by mkoeppe created at 2022-03-22 00:22:11

Yes


---

Comment by tornaria created at 2022-03-22 00:29:22

Mmmmm... why this:

```python
        filenames = [f for f in args.filenames
                     if f.endswith("_test.py") or not f.endswith(".py")]
```

instead of just

```python
        filenames = [f for f in args.filenames if f.endswith("_test.py")]
```


We only want to run pytest on `*_test.py`files, right? What am I missing?


---

Comment by mkoeppe created at 2022-03-22 00:31:19

We also want to run it on directory names.


---

Comment by tornaria created at 2022-03-22 01:44:19

Replying to [comment:52 mkoeppe]:
> We also want to run it on directory names.

Sure, but not on `*.pyx`, `*.pxd`, `*.rst`, etc.


---

Comment by mkoeppe created at 2022-03-22 01:44:45

Yes, I have a better version in a second


---

Comment by git created at 2022-03-22 01:45:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tornaria created at 2022-03-22 02:21:24

I was thinking something like this (untested):

```
filenames = [src.path for src in DC.sources if src.path.endswith("_test.py")]
```


Do you see any drawback?


---

Comment by mkoeppe created at 2022-03-22 02:33:19

I prefer the version in which pytest is in charge of the discovery within directories.


---

Comment by @tobiasdiez created at 2022-03-22 07:59:15

Changing status from needs_review to needs_work.


---

Comment by @tobiasdiez created at 2022-03-22 07:59:15

Replying to [comment:45 mkoeppe]:
> Replying to [comment:41 gh-tobiasdiez]:
> > > I think this really needs the change that the ticket title says: "sage -t: Do not run pytest on individual files" (... unless they match the pytest file pattern...) 
> > 
> > I'm not a big fan of this. The longterm goal is to use pytest also for the doctests (replacing sages custom doctest runner) and for this doctests and pytests should be treated in the same way.
> 
> That's fine to keep in mind for the long term. But we really need to restore a non-broken doctesting facility. I marked this as "critical" 9 months ago and we released 9.4 and 9.5 with it. It's overdue to fix it.

The point is that for this goal skipping the non-pytest files has to be reverted and the underlying issue has to be fixed anyway. So let's please directly implement a proper solution: say what you proposed in comment:41 or by converting them to proper pytests.


---

Comment by mkoeppe created at 2022-03-22 16:19:56

Replying to [comment:58 gh-tobiasdiez]:
> Replying to [comment:45 mkoeppe]:
> > Replying to [comment:41 gh-tobiasdiez]:
> > > > I think this really needs the change that the ticket title says: "sage -t: Do not run pytest on individual files" (... unless they match the pytest file pattern...) 
> > > 
> > > I'm not a big fan of this. The longterm goal is to use pytest also for the doctests (replacing sages custom doctest runner) and for this doctests and pytests should be treated in the same way.
> > 
> > That's fine to keep in mind for the long term. But we really need to restore a non-broken doctesting facility. I marked this as "critical" 9 months ago and we released 9.4 and 9.5 with it. It's overdue to fix it.
> 
> The point is that for this goal skipping the non-pytest files has to be reverted and the underlying issue has to be fixed anyway. 

If/when you work on it as part of #33546, the whole `sage-runtest` script will be replaced anyway.


---

Comment by mkoeppe created at 2022-03-22 16:20:11

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-03-22 16:33:15

I've opened #33549 "Rename test_... functions to avoid the naming scheme reserved by pytest" for this work. This has no urgency. 

The present ticket solves the critical annoyance in time for the Sage 9.6 release.


---

Comment by soehms created at 2022-03-22 16:55:54

Replying to [comment:60 mkoeppe]:

Why don't you use `os.path.isfile(f)` instead of `os.path.splitext(f)[1]`? 

Further, there is a typo in the comment (wrong ticket number).


---

Comment by @tobiasdiez created at 2022-03-22 18:11:34

Replying to [comment:62 mkoeppe]:
> I've opened #33549 "Rename test_... functions to avoid the naming scheme reserved by pytest" for this work. This has no urgency. 
> 
> The present ticket solves the critical annoyance in time for the Sage 9.6 release.

But that's the actually issue. Not running pytest on these files only hides the error, while the underlying problem still persists.

Since this issue is almost one year old, I don't see why you now create the impression that it is very urgent and needs a hot-fix instead of a proper fix.


---

Comment by mkoeppe created at 2022-03-22 18:14:29

Replying to [comment:64 gh-tobiasdiez]:
> > The present ticket solves the critical annoyance in time for the Sage 9.6 release.
> 
> But that's the actually issue. Not running pytest on these files only hides the error, while the underlying problem still persists.

No, it does not reduce coverage. All tests still run.


---

Comment by git created at 2022-03-22 18:26:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-22 18:27:27

Replying to [comment:63 soehms]:
> Replying to [comment:60 mkoeppe]:
> 
> Why don't you use `os.path.isfile(f)` instead of `os.path.splitext(f)[1]`? 

Good suggestion, done.

> Further, there is a typo in the comment (wrong ticket number).

Fixed, thanks.


---

Comment by mkoeppe created at 2022-03-22 18:40:33

Replying to [comment:64 gh-tobiasdiez]:
> Replying to [comment:62 mkoeppe]:
> > The present ticket solves the critical annoyance in time for the Sage 9.6 release.
> 
> I don't see why you now create the impression that it is very urgent

We are trying to make a release here, Tobias.


---

Comment by @tobiasdiez created at 2022-03-22 19:23:55

Replying to [comment:65 mkoeppe]:
> Replying to [comment:64 gh-tobiasdiez]:
> > > The present ticket solves the critical annoyance in time for the Sage 9.6 release.
> > 
> > But that's the actually issue. Not running pytest on these files only hides the error, while the underlying problem still persists.
> 
> No, it does not reduce coverage. All tests still run.
> 

My point is that running pytest on these files is not a problem in itself (as described in more detail above in comment:21). I agree however that it leads to problems, namely that some methods are discovered as tests although they are not proper pytests. But it's this latter issue that should be addressed.

In other words, running `pytest src/sage/tests/cmdline.py` with this ticket still leads to the same issue as described in the ticket description.


---

Comment by mkoeppe created at 2022-03-22 20:10:02

Replying to [comment:70 gh-tobiasdiez]:
> In other words, running `pytest src/sage/tests/cmdline.py` with this ticket still leads to the same issue as described in the ticket description.

Yes, but that's not the issue here.


---

Comment by mkoeppe created at 2022-03-22 20:26:22

Clarified this in the beginning of the ticket description. That `sage -t` works without noise is critical. Our use of `pytest` is still in development; that's important work but not critical for the release.


---

Comment by @tobiasdiez created at 2022-03-22 21:37:45

Changing status from needs_review to needs_work.


---

Comment by @tobiasdiez created at 2022-03-22 21:37:45

Replying to [comment:59 mkoeppe]:
> Replying to [comment:58 gh-tobiasdiez]:
> > Replying to [comment:45 mkoeppe]:
> > > Replying to [comment:41 gh-tobiasdiez]:
> > > > > I think this really needs the change that the ticket title says: "sage -t: Do not run pytest on individual files" (... unless they match the pytest file pattern...) 
> > > > 
> > > > I'm not a big fan of this. The longterm goal is to use pytest also for the doctests (replacing sages custom doctest runner) and for this doctests and pytests should be treated in the same way.
> > > 
> > > That's fine to keep in mind for the long term. But we really need to restore a non-broken doctesting facility. I marked this as "critical" 9 months ago and we released 9.4 and 9.5 with it. It's overdue to fix it.
> > 
> > The point is that for this goal skipping the non-pytest files has to be reverted and the underlying issue has to be fixed anyway. 
> 
> If/when you work on it as part of #33546, the whole `sage-runtest` script will be replaced anyway.

I've just realized that with the changes in this ticket it is now impossible to use `sage -t somefile` to test if `somefile` works correctly with pytest (if somefile is not ending on `_test.py`). Thus working and reviewing on tickets that go into the direction of #33546 (such as #33550) is made harder.

Thus, please make it at least possible to disable the added filename check.


---

Comment by @tobiasdiez created at 2022-03-22 21:38:44

Replying to [comment:71 mkoeppe]:
> Replying to [comment:70 gh-tobiasdiez]:
> > In other words, running `pytest src/sage/tests/cmdline.py` with this ticket still leads to the same issue as described in the ticket description.
> 
> Yes, but that's not the issue here. 

So if `pytest src/sage/tests/cmdline.py` would pass, then `sage -t src/sage/tests/cmdline.py` would still fail?


---

Comment by mkoeppe created at 2022-03-22 21:42:22

Replying to [comment:75 gh-tobiasdiez]:
> So if `pytest src/sage/tests/cmdline.py` would pass, then `sage -t src/sage/tests/cmdline.py` would still fail?

Hm?


---

Comment by mkoeppe created at 2022-03-22 21:43:31

Replying to [comment:74 gh-tobiasdiez]:
> I've just realized that with the changes in this ticket it is now impossible to use `sage -t somefile` to test if `somefile` works correctly with pytest 

Then just test it with pytest, no?


---

Comment by mkoeppe created at 2022-03-22 21:44:27

In #33550, you can just update the pattern to allow your new format `_test.sage` too.


---

Comment by mkoeppe created at 2022-03-22 21:44:39

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2022-03-22 21:44:51

Replying to [comment:76 mkoeppe]:
> Replying to [comment:75 gh-tobiasdiez]:
> > So if `pytest src/sage/tests/cmdline.py` would pass, then `sage -t src/sage/tests/cmdline.py` would still fail?
> 
> Hm?

That's the negation of your statement that the failure of `pytest src/sage/tests/cmdline.py` is not the issue.


---

Comment by mkoeppe created at 2022-03-22 21:45:51

Kindly don't negate my statements, thanks ;)


---

Comment by @tobiasdiez created at 2022-03-22 21:47:36

Replying to [comment:81 mkoeppe]:
> Kindly don't negate my statements, thanks ;)

That was only to show that it was not a true statement.


---

Comment by @tobiasdiez created at 2022-03-22 21:49:33

Replying to [comment:77 mkoeppe]:
> Replying to [comment:74 gh-tobiasdiez]:
> > I've just realized that with the changes in this ticket it is now impossible to use `sage -t somefile` to test if `somefile` works correctly with pytest 
> 
> Then just test it with pytest, no?
> 

In principle yes, but pytest needs to be invoked with all the sage env setup and the correct arguments (which will probably include the sage-env dependent `rootdir` argument to fix #33550).


---

Comment by mkoeppe created at 2022-03-22 22:36:00

You mean `./sage -sh -c pytest`?


---

Comment by @tobiasdiez created at 2022-03-22 22:53:28

No, sage-runtests also sets cmdline args for pytest.


---

Comment by mkoeppe created at 2022-03-22 22:59:41

Anyway, as I said in comment:78, when you work on tickets that make a wider range of files work with pytest, you can adjust the condition added in the file.


---

Comment by mkoeppe created at 2022-03-22 22:59:57

So let's please get this in. There is no open issue.


---

Comment by @tobiasdiez created at 2022-03-22 23:15:45

Can you please explain me how one is now supposed to discover issues with pytest? It is already an optional package and with the changes of this ticket it is essentially disabled on most of sages code base.


---

Comment by mkoeppe created at 2022-03-22 23:23:48

Replying to [comment:88 gh-tobiasdiez]:
> Can you please explain me how one is now supposed to discover issues with pytest? It is already an optional package and with the changes of this ticket it is essentially disabled on most of sages code base.

As you see in the example shown in the ticket description, `./sage -t` continues to run pytest on the files named `*_test.py`, which contain pytest tests.

There are no pytest tests in any other files, so there is no need to run pytest on them. 
If/when you work on a ticket that changes that, as I said in comment:78, you adjust the test in that ticket.


---

Comment by mkoeppe created at 2022-03-22 23:25:48

For example, if/when you work on #33549, you can expand from testing all `*_test.py` to testing all `*.py`.


---

Comment by soehms created at 2022-03-23 07:20:35

Replying to [comment:67 mkoeppe]:
> Replying to [comment:63 soehms]:
> > Replying to [comment:60 mkoeppe]:
> > 
> > Why don't you use `os.path.isfile(f)` instead of `os.path.splitext(f)[1]`? 
> 
> Good suggestion, done.
> 
> > Further, there is a typo in the comment (wrong ticket number).
> 
> Fixed, thanks.

Thanks, as well. LGTM. From my point of view this can get a positive review depending on how the fundamental discussion comes to an end.


---

Comment by @tobiasdiez created at 2022-03-23 12:54:12

Replying to [comment:90 mkoeppe]:
> For example, if/when you work on #33549, you can expand from testing all `*_test.py` to testing all `*.py`.

Okay, since #33549 is now ready for review and we both seem to agree that this is the right approach, this ticket here is no longer needed.

Moreover, the approach taken in #33549 to fix pytest in conftest instead of sage-runtests has also the advantage that running `./sage -sh -c pytest` directly (as you advocate above) also works now.


---

Comment by mkoeppe created at 2022-03-23 17:12:22

#33549 is a big change and will likely take a while to review.


---

Comment by tornaria created at 2022-03-23 23:52:44

I'm sorry. I don't really follow what's going on here, and I can't really follow your fast pace.

Is there an IRC channel or similar where these topics are discussed? I don't think this ticket format is good, besides it leaves a lot of useless circumstantial comments that later make it very difficult to understand what happened (let me mention that I also find unhelpful that commits are not squashed and rebased when the fixes change, I know this is a matter of taste and I know the perils of rebasing, but still...)

I guess the last proposal is ok, although I fail to see what's the problem with using the work already done by DC in scanning the files.

If I understood correctly, the goal is to replace the doctest runner by pytest. If so, wouldn't it make more sense to write a different version of `sage-runtests` which is guided by pytest instead of the DC, instead of having `sage-runtests` do two passes on the files, one guided by DC and one guided by pytest?

If, at some point, you want "pytest file.py" to run the pytest tests and also the sage doctests, then the current structure of `sage-runtests` seems not ok as the sage doctests would be run twice (once by the DC and then again by pytest).

It seems to me it makes much more sense to have two "drivers" for running tests. One driver is the current sage-runtests (using DC) and the other driver is a new one using pytest. With this split you can work on developing the pytest driver without breaking the current `sage -t`. When the new pytest driver is well tested and working, and it's a complete replacement for the current DC driver, then `sage -t` can be switched to the new driver. They can probably coexist for some time to ease the transition. Your current strategy seems to be at odds with this.

Some questions about pytest (since I'm not really familiar with it):
 a. Is pytest expected to have a long life? I understand python has changed test frameworks in the past. Is there a reasonable certainty that this won't happen again (I'm not implying it will -- I'm just asking if you've made this risk analysis).
 b. Is there a way that you can make "pytest ARGUMENTS" work, i.e. have some configuration for pytest so the correct sage environment, etc. is loaded? If you don't have a plan on how this is supposed to work, then replacing `sage -t` by `pytest` won't really work...
 c. If not, could you implement a `sage -pytest` or something like that that will run pytest with the needed environment, arguments, etc.?


---

Comment by mkoeppe created at 2022-03-24 00:04:32

The present ticket is a bugfix ticket that removes an annoyance with the existing implementation. My goal is to get it in for the Sage 9.6 release.

Larger discussions of `sage -t` vs. `pytest` should best be taken to a ticket with a larger scope. 

Meta-ticket #28936 (Adopt mainstream Python testing/linting infrastructure: tox, pytest, ...) would be suitable.


---

Comment by mkoeppe created at 2022-03-24 00:05:37

With comment:94 you nuked the ticket description, I assume by accident?


---

Comment by fbissey created at 2022-03-24 01:13:48

Sorry to interfere for a minute. I am testing the ticket right now :) but my intervention is cosmetic. I was reading the commit and this bit grabbed my attention

```
# 31914: Do not run pytest on individual Python files unless
```

Surely you meant "31924".


---

Comment by mkoeppe created at 2022-03-24 03:23:16

That was already fixed in a later commit.


---

Comment by tornaria created at 2022-03-24 09:53:42

Replying to [comment:96 mkoeppe]:
> With comment:94 you nuked the ticket description, I assume by accident?
Oops, I'm sorry.

Here's what I got:

```
$ ./sagelib -tp 8 --long --all
...
Total time for all tests: 1554.2 seconds
    cpu time: 10883.7 seconds
    cumulative wall time: 12084.8 seconds
Features detected for doctesting: graphviz,imagemagick,nauty,palp,pandoc,pdftocairo,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sphinx
============================= test session starts ==============================
platform linux -- Python 3.10.3, pytest-6.2.5, py-1.10.0, pluggy-0.13.1
rootdir: /opt/sage/sage-git/develop/pkgs/sagemath-standard
plugins: anyio-3.5.0, xonsh-0.11.0
collected 39 items / 3 errors / 36 selected

==================================== ERRORS ====================================
_ ERROR collecting build/lib.linux-x86_64-3.10/sage/misc/nested_class_test.py __
pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/misc/nested_class_test.py:72: in <module>
    class TestParent2(Parent, metaclass=NestedClassMetaclass):
sage/misc/nested_class.pyx:292: in sage.misc.nested_class.NestedClassMetaclass.__init__ (build/cythonized/sage/misc/nested_class.c:2384)
    ???
E   KeyError: 'nested_class_test'
_ ERROR collecting build/lib.linux-x86_64-3.10/sage/misc/test_nested_class.py __
pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/misc/test_nested_class.py:72: in <module>
    class TestParent2(Parent, metaclass=NestedClassMetaclass):
sage/misc/nested_class.pyx:292: in sage.misc.nested_class.NestedClassMetaclass.__init__ (build/cythonized/sage/misc/nested_class.c:2384)
    ???
E   KeyError: 'test_nested_class'
_ ERROR collecting build/lib.linux-x86_64-3.10/sage/structure/sage_object_test.py _
ImportError while importing test module '/opt/sage/sage-git/develop/pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/structure/sage_object_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/structure/sage_object_test.py:3: in <module>
    from .sage_object import SageObject
E   ImportError: attempted relative import with no known parent package
=============================== warnings summary ===============================
.:0
  :0: PytestCollectionWarning: cannot collect test class 'TestOutputPlainText' because it has a __init__ constructor (from: build/lib.linux-x86_64-3.10/sage/repl/rich_output/backend_test.py)

.:0
  :0: PytestCollectionWarning: cannot collect test class 'TestObject' because it has a __new__ constructor (from: build/lib.linux-x86_64-3.10/sage/repl/rich_output/backend_test.py)

.:0
  :0: PytestCollectionWarning: cannot collect test class 'TestOutputPlainText' because it has a __init__ constructor (from: build/lib.linux-x86_64-3.10/sage/repl/rich_output/test_backend.py)

.:0
  :0: PytestCollectionWarning: cannot collect test class 'TestObject' because it has a __new__ constructor (from: build/lib.linux-x86_64-3.10/sage/repl/rich_output/test_backend.py)

.:0
  :0: PytestCollectionWarning: cannot collect 'test_factory' because it is not a function.

-- Docs: https://docs.pytest.org/en/stable/warnings.html
=========================== short test summary info ============================
ERROR pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/misc/nested_class_test.py
ERROR pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/misc/test_nested_class.py
ERROR pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/structure/sage_object_test.py
!!!!!!!!!!!!!!!!!!! Interrupted: 3 errors during collection !!!!!!!!!!!!!!!!!!!!
======================== 5 warnings, 3 errors in 3.93s =========================
```

I didn't merge #32975 here, so that may explain these.


---

Comment by fbissey created at 2022-03-24 10:02:26

I just had a "clean" run in sage-on-gentoo

```
----------------------------------------------------------------------
sage -t --long --random-seed=295201559119209171390947016895682587809 sage/env.py  # 2 doctests failed [failed in baseline]
sage -t --long --random-seed=295201559119209171390947016895682587809 sage/interfaces/gap_workspace.py  # 2 doctests failed [failed in baseline]
sage -t --long --random-seed=295201559119209171390947016895682587809 sage/plot/plot3d/tachyon.py  # 1 doctest failed [failed in baseline]
sage -t --long --random-seed=295201559119209171390947016895682587809 sage/tests/startup.py  # 1 doctest failed [failed in baseline]
sage -t --long --random-seed=295201559119209171390947016895682587809 sage_docbuild/__init__.py  # 2 doctests failed [failed in baseline]
sage -t --long --random-seed=295201559119209171390947016895682587809 sage_setup/clean.py  # 4 doctests failed [failed in baseline]
sage -t --long --random-seed=295201559119209171390947016895682587809 sage_setup/find.py  # 8 doctests failed [failed in baseline]
----------------------------------------------------------------------
Total time for all tests: 1515.1 seconds
    cpu time: 9139.7 seconds
    cumulative wall time: 11476.1 seconds
Features detected for doctesting: 4ti2,dvipng,imagemagick,nauty,palp,pdftocairo,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sagemath_doc_html,sphinx
======================================================================================= test session starts =======================================================================================
platform linux -- Python 3.10.2, pytest-7.0.1, pluggy-1.0.0
rootdir: /var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src, configfile: tox.ini
plugins: hypothesis-6.38.0
collected 36 items

sage/manifolds/differentiable/symplectic_form_test.py ......................                                                                                                                [ 61%]
sage/manifolds/differentiable/examples/symplectic_space_test.py ....                                                                                                                        [ 72%]
sage/numerical/backends/cvxopt_backend_test.py ..                                                                                                                                           [ 77%]
sage/numerical/backends/glpk_backend_test.py ..                                                                                                                                             [ 83%]
sage/numerical/backends/glpk_exact_backend_test.py ..                                                                                                                                       [ 88%]
sage/numerical/backends/interactivelp_backend_test.py ..                                                                                                                                    [ 94%]
sage/numerical/backends/ppl_backend_test.py ..                                                                                                                                              [100%]

======================================================================================= 36 passed in 42.71s =======================================================================================
```

You'll notice that my `sage/tests/cmdline.py` issue disappeared after applying this ticket [including the commits I missed earlier].

Intensive testing, installed and in source, in the last couple of days revealed many pitfalls and things to ponder. I need to do a write up.


---

Comment by @tobiasdiez created at 2022-03-24 12:36:10

Replying to [comment:93 mkoeppe]:
> #33549 is a big change and will likely take a while to review.

Can we please return to a friendly and constructive discussion. Thanks! There is already enough war going on in the world, that I don't need another one in my freetime.

My points of criticism of this ticket are:
- It is not fixing the underlying issue with pytest, but it's hiding it.
- It removes the feature that you can have pytests in arbitrary python files and run `sage -t file.py` on it to run them. This is important as `sage -t` is supposed to be a thin wrapper around `pytest` (plus, of course, running the actual doctests) and `pytest file.py` behaves that way. We can of course discuss to change the role pytest should play in `sage -t` but that should be better done in a more relaxed environment without time pressure and should take into account the future plans to e.g. make pytest a standard package.
- It excludes all python files from the pytest discovery, although most of them don't have any issues.
- It currently excludes the problematic files only at the level of `sage -t` and not `pytest` (that is, all exclusions should be in conftest and not sage-runtests).
- With #33549 and #32975 there are proper fixes for the issues reported so far.
- I don't understand why there is time pressure to fix this now in an adhoc manner. The ticket has been open for almost a year and my comment:30 saying that most reported issues should be fixed with #32975 didn't get attention for almost two months. Moreover, it's a problem with an optional package so people can easily opt-out. And finally, there is nothing really broken. `sage -t` still works and runs all doctests just fine, there is only a bunch of additional noise at the end that devs can ignore.


---

Comment by @tobiasdiez created at 2022-03-24 12:48:28

Replying to [comment:94 tornaria]:
> If I understood correctly, the goal is to replace the doctest runner by pytest. If so, wouldn't it make more sense to write a different version of `sage-runtests` which is guided by pytest instead of the DC, instead of having `sage-runtests` do two passes on the files, one guided by DC and one guided by pytest?

Yes that's the longterm goal. However, we had to start somewhere and it seemed the easiest to first gain some experience with pytest by integrating it in the existing `sage -t` run, and add some pytests (the most extensive ones being for the symplectic forms so far). But yes, this design probably needs changes in the future and I'm very open for discussing different approaches.

> It seems to me it makes much more sense to have two "drivers" for running tests. One driver is the current sage-runtests (using DC) and the other driver is a new one using pytest.

I like the idea. 

> Some questions about pytest (since I'm not really familiar with it):
>  a. Is pytest expected to have a long life? I understand python has changed test frameworks in the past. Is there a reasonable certainty that this won't happen again (I'm not implying it will -- I'm just asking if you've made this risk analysis).


pytest has been around for over 10 years and is widely used (e.g. in scipy).

>  b. Is there a way that you can make "pytest ARGUMENTS" work, i.e. have some configuration for pytest so the correct sage environment, etc. is loaded? If you don't have a plan on how this is supposed to work, then replacing `sage -t` by `pytest` won't really work...

Running `pytest` already works in principle. Currently the only problem is that some modules still need an initalized sage-env (e.g. environment variables) instead of using the one provided by sage-conf. But there is work in this direction, mainly driven by the needs for the modulaization effort.

>  c. If not, could you implement a `sage -pytest` or something like that that will run pytest with the needed environment, arguments, etc.?

Yes, one could implement something like this. Say, 

- `sage -t` uses the current doctest driver for sage doctests and pytest for actual pytests.
- `sage -pytest` (or maybe directly `pytest`) uses pytest for both.

I think that could be good design indeed. But as Mathias says, maybe its better to discuss this somewhere else.


---

Comment by mkoeppe created at 2022-03-24 15:21:29

Replying to [comment:99 tornaria]:
> Replying to [comment:96 mkoeppe]:
> > With comment:94 you nuked the ticket description, I assume by accident?
> Oops, I'm sorry.

No worries, I've restored it now.


---

Comment by mkoeppe created at 2022-03-24 15:26:29

Replying to [comment:99 tornaria]:
> Here's what I got:
> {{{
> $ ./sagelib -tp 8 --long --all
> [...]
> _ ERROR collecting build/lib.linux-x86_64-3.10/sage/misc/nested_class_test.py __
> pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/misc/nested_class_test.py:72: in <module>
>     class TestParent2(Parent, metaclass=NestedClassMetaclass):
> sage/misc/nested_class.pyx:292: in sage.misc.nested_class.NestedClassMetaclass.__init__ (build/cythonized/sage/misc/nested_class.c:2384)
>     ???
> E   KeyError: 'nested_class_test'
> _ ERROR collecting build/lib.linux-x86_64-3.10/sage/misc/test_nested_class.py __
> pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/misc/test_nested_class.py:72: in <module>
> [...]
> -- Docs: https://docs.pytest.org/en/stable/warnings.html
> =========================== short test summary info ============================
> ERROR pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/misc/nested_class_test.py
> ERROR pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/misc/test_nested_class.py
> ERROR pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/structure/sage_object_test.py
> !!!!!!!!!!!!!!!!!!! Interrupted: 3 errors during collection !!!!!!!!!!!!!!!!!!!!
> ======================== 5 warnings, 3 errors in 3.93s =========================
> }}}
> I didn't merge #32975 here, so that may explain these.

I think the problem in this test is actually your nonstandard setup in which `conftest.py` is not found. 

This is #33521 (doctesting with pytest fails on system install of sage), see in particular #33521#comment:8


---

Comment by git created at 2022-03-25 18:22:59

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2022-03-26 18:16:04

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-03-26 18:34:08

Replying to [comment:101 gh-tobiasdiez]:
> My points of criticism of this ticket are:

Thanks for the summary - most of them have been asked and answered.

> - It is not fixing the underlying issue with pytest, but it's hiding it.

Answered in comment:73

> - It removes the feature that you can have pytests in arbitrary python files and run `sage -t file.py` on it to run them. This is important as `sage -t` is supposed to be a thin wrapper around `pytest` [...]

No, this was never the stated design goal. The motivation for having `sage -t` invoke `pytest`, implemented in #31103, is that the test coverage of running `sage -t` is not reduced by migrating tests to pytest.

A "thin wrapper around pytest" would have pytest's actual interface (passing command line options etc.) and could be `sage -pytest` as suggested in comment:94 or `sage -tox -e pytest`.

> - It excludes all python files from the pytest discovery, although most of them don't have any issues.

That's how #31103 should have originally implemented it.

> - It currently excludes the problematic files only at the level of `sage -t` and not `pytest` (that is, all exclusions should be in conftest and not sage-runtests).

Answered in comment:73

> - With #33549 and #32975 there are proper fixes for the issues reported so far.

#33549 is now a dependency of the present ticket.

There's still more to be addressed in #33550, #33560, and #33561 in order to fix everything that is fixed by the present ticket.

> - I don't understand why there is time pressure to fix this now in an adhoc manner. [...]

Answered in comment:45, comment:69.


---

Comment by mkoeppe created at 2022-03-26 18:34:19

Ready for review.


---

Comment by mkoeppe created at 2022-03-26 19:07:29

Replying to [comment:109 mkoeppe]:
> A "thin wrapper around pytest" would have pytest's actual interface (passing command line options etc.) and could be `sage -pytest` as suggested in comment:94 

I've opened #33572 for this one.


---

Comment by mkoeppe created at 2022-03-26 19:21:30

Replying to [comment:91 soehms]:
> LGTM. From my point of view this can get a positive review depending on how the fundamental discussion comes to an end.

There's no fundamental discussion happening here. It's not a question of "either-or", but a strategy of fixing now what can be fixed to get a high quality release 9.6, and doing the larger fixes when they are ready. In comment:78, comment:89, comment:90, etc. I have already explained how to adjust the change in this ticket when this work is done.


---

Comment by soehms created at 2022-03-27 10:25:44

Changing status from needs_review to positive_review.


---

Comment by soehms created at 2022-03-27 10:25:44

Replying to [comment:112 mkoeppe]:
> Replying to [comment:91 soehms]:
> > LGTM. From my point of view this can get a positive review depending on how the fundamental discussion comes to an end.
> 
> There's no fundamental discussion happening here. It's not a question of "either-or", but a strategy of fixing now what can be fixed to get a high quality release 9.6, and doing the larger fixes when they are ready. In comment:78, comment:89, comment:90, etc. I have already explained how to adjust the change in this ticket when this work is done.

I've seen that the discussion was about strategy. But obviously the strategy was not clarified completely and thus the discussion was not finished at that point. By your comment [comment 109](https://trac.sagemath.org/ticket/31924#comment:109) and the new ticket #33572 the situation is improved, now.

The difficulty with this ticket is that it shades out a couple of issues Tobias is currently working on. I can understand that this was annoying. For example the bug treated in #33550 will not show any more in the way as it did before if this ticket is released.

Thus, we should work throughout all of these issues and find new test cases for them, now. Probably, the best way to do this is to use #33572.


---

Comment by @tobiasdiez created at 2022-03-27 12:23:08

Replying to [comment:109 mkoeppe]:
> > - With #33549 and #32975 there are proper fixes for the issues reported so far.
> 
> #33549 is now a dependency of the present ticket.
> 
> There's still more to be addressed in #33550, #33560, and #33561 in order to fix everything that is fixed by the present ticket.

All of which are ready for review.


---

Comment by @tobiasdiez created at 2022-03-27 12:28:41

Replying to [comment:113 soehms]:
> The difficulty with this ticket is that it shades out a couple of issues Tobias is currently working on. I can understand that this was annoying. For example the bug treated in #33550 will not show any more in the way as it did before if this ticket is released.
> 
> Thus, we should work throughout all of these issues and find new test cases for them, now. Probably, the best way to do this is to use #33572.

I agree #33572 would be a good way to test. But as the discussion there shows running `pytest somefile.py` still needs a lot of work until it works because `sage.all` is not imported. On the other hand, `sage -t` takes care of this.

I hope #33550, #33560, and #33561 get reviewed before this ticket here is merged, since otherwise the reviewers have to revert the changes manually before running `sage -t`.


---

Comment by tornaria created at 2022-03-27 15:08:39

May I suggest adding some switches to `sage-runtests`:
 - `--skip-doctest`: if given, the `DocTestController` run would be skipped
 - `--skip-pytest`: if given, the pytest run would be skipped

And maybe:
 - `--pytest-all`: if given, the filename filter implemented in this ticket would not be applied, so pytest would be run for all the given arguments

I think it would be quite useful (a) if I happen to have pytest installed and for some reason (maybe something is broken, perhaps because a bug in my system pytest, whatever) I prefer to skip pytest (b) if I want to actually test pytest (maybe I'm working on the pytest code) I may want to run pytest on different arguments without having to wait for doctest (c) want to run pytest on some file not matching the pattern.

All of these are easy to acomplish by trivial patching of `sage-runtests` but it's much more convenient to be able to get these different behaviours with an unchanged script.


---

Comment by mkoeppe created at 2022-03-27 15:08:58

Thanks for the review.


---

Comment by mkoeppe created at 2022-03-27 15:09:23

Replying to [comment:116 tornaria]:
> May I suggest adding some switches to `sage-runtests`

Separate ticket


---

Comment by @GMS103 created at 2022-03-27 21:14:19

This is on Apple Silicon M1 Macs with Homebrew up to date, both macOS 11.6.5 (Big Sur) with Xcode 13.2.1 and macOS 12.3 (Monterey) with Xcode 13.3.

SageMath 9.6.beta6 together with this ticket #31924 and nothing else:
after `make` and `make pytest`, `make ptestlong` gives

```
**********************************************************************
File "src/sage/tests/cmdline.py", line 311, in sage.tests.cmdline._test_executable
Failed example:
    (out, err, ret) = test_executable(["sage", "-t", script])
Exception raised:
    Traceback (most recent call last):
      File "/Users/sagemath/SageMath/Git/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 695, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/sagemath/SageMath/Git/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1093, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.tests.cmdline._test_executable[107]>", line 1, in <module>
        (out, err, ret) = test_executable(["sage", "-t", script])
    NameError: name 'test_executable' is not defined
**********************************************************************
File "src/sage/tests/cmdline.py", line 314, in sage.tests.cmdline._test_executable
Failed example:
    out.find("All tests passed!") >= 0
Expected:
    True
Got:
    False
**********************************************************************
```

Am I doing something wrong?

BTW, I am at a loss with all the tickets mentioned here. Some would not merge with this one.


---

Comment by mkoeppe created at 2022-03-27 23:04:47

That's fixed in the latest version of #33549 - I haven't merged that here.


---

Comment by @GMS103 created at 2022-03-28 01:02:18

FWIW, positive review for [SageMath](SageMath) 9.6.beta6 plus #31924 and #33549 plus `make pytest` on Apple Silicon M1 Macs with Homebrew up to date, both macOS 11.6.5 (Big Sur) with Xcode 13.2.1 and macOS 12.3 (Monterey) with Xcode 13.3.


---

Comment by soehms created at 2022-03-28 05:58:52

Sorry for the lack of attention!


---

Comment by git created at 2022-03-30 00:45:22

Changing status from positive_review to needs_review.


---

Comment by git created at 2022-03-30 00:45:22

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-03-30 00:46:12

Rebased on 9.6.beta6, away from #33549


---

Comment by mkoeppe created at 2022-03-30 00:46:27

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-04-02 10:53:35

Resolution: fixed
