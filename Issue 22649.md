# Issue 22649: fix pxd header files

archive/issues_022649.json:
```json
{
    "body": "CC:  jdemeyer\n\nIf we try to compile some external Cython code that links against some Sage Cython code the compiler is not able to find some of the headers. Thanks to our patched version of Cython, tiny modifications of the include solve the issue.\n\nIssue created by migration from https://trac.sagemath.org/ticket/22886\n\n",
    "created_at": "2017-04-27T13:41:30Z",
    "labels": [
        "misc",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "fix pxd header files",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22649",
    "user": "vdelecroix"
}
```
CC:  jdemeyer

If we try to compile some external Cython code that links against some Sage Cython code the compiler is not able to find some of the headers. Thanks to our patched version of Cython, tiny modifications of the include solve the issue.

Issue created by migration from https://trac.sagemath.org/ticket/22886





---

archive/issue_comments_315938.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-04-27T13:42:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22649#issuecomment-315938",
    "user": "vdelecroix"
}
```

New commits:



---

archive/issue_comments_315939.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-04-27T13:42:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22649#issuecomment-315939",
    "user": "vdelecroix"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_315940.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-04-27T13:44:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22649#issuecomment-315940",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_315941.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-04-28T11:19:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22649#issuecomment-315941",
    "user": "jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_315942.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-04-28T11:19:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22649#issuecomment-315942",
    "user": "jdemeyer"
}
```

New commits:



---

archive/issue_comments_315943.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-04-29T10:06:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22649#issuecomment-315943",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_315944.json:
```json
{
    "body": "On OSX there is lots of breakage of the form:\n\n```\nsage -t --long src/sage/misc/inherit_comparison.pyx\n**********************************************************************\nFile \"src/sage/misc/inherit_comparison.pyx\", line 54, in sage.misc.inherit_comparison.InheritComparisonMetaclass\nFailed example:\n    cython('''\n    from sage.misc.inherit_comparison cimport InheritComparisonMetaclass\n    cdef class Base(object):\n        def __richcmp__(left, right, int op):\n            print(\"Calling Base.__richcmp__\")\n            return left is right\n    cdef class Derived(Base):\n        def __hash__(self):\n            return 1\n    cdef class DerivedWithRichcmp(Base):\n        def __getmetaclass__(_):\n            from sage.misc.inherit_comparison import InheritComparisonMetaclass\n            return InheritComparisonMetaclass\n        def __hash__(self):\n            return 1\n    ''')\nException raised:\n    Traceback (most recent call last):\n      File \"/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 509, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 872, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.misc.inherit_comparison.InheritComparisonMetaclass[0]>\", line 19, in <module>\n        ''')\n      File \"sage/misc/lazy_import.pyx\", line 389, in sage.misc.lazy_import.LazyImport.__call__ (/Users/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/misc/lazy_import.c:4016)\n        return self._get_object()(*args, **kwds)\n      File \"sage/misc/cython_c.pyx\", line 65, in sage.misc.cython_c.cython_compile (/Users/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/misc/cython_c.c:1192)\n        cython_import_all(tmpfile, get_globals(),\n      File \"/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/misc/cython.py\", line 789, in cython_import_all\n        create_local_c_file=create_local_c_file)\n      File \"/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/misc/cython.py\", line 766, in cython_import\n        **kwds)\n      File \"/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/misc/cython.py\", line 554, in cython\n        raise RuntimeError(\"Error compiling {}:\\n{}\\n{}\".format(filename, log, err))\n    RuntimeError: Error compiling /Users/buildslave-sage/slave/sage_git/dot_sage/temp/osx/75462/tmp_S_2CnH.spyx:\n    running build\n    running build_ext\n    building '_Users_buildslave_sage_slave_sage_git_dot_sage_temp_osx_75462_tmp_S_2CnH_spyx_0' extension\n    creating build\n    creating build/temp.macosx-10.9-x86_64-2.7\n    gcc -fno-strict-aliasing -I/Users/buildslave-sage/slave/sage_git/build/local/var/tmp/sage/build/python2-2.7.13.p1/include -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -I/Users/buildslave-sage/slave/sage_git/build/local/include -I/Users/buildslave-sage/slave/sage_git/build/local/include/python2.7 -I/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/numpy/core/include -I/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages -I/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/ext -I/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/cysignals -I/Users/buildslave-sage/slave/sage_git/dot_sage/temp/osx/75462 -I/Users/buildslave-sage/slave/sage_git/build/local/include/python2.7 -c _Users_buildslave_sage_slave_sage_git_dot_sage_temp_osx_75462_tmp_S_2CnH_spyx_0.c -o build/temp.macosx-10.9-x86_64-2.7/_Users_buildslave_sage_slave_sage_git_dot_sage_temp_osx_75462_tmp_S_2CnH_spyx_0.o -w -O2\n    _Users_buildslave_sage_slave_sage_git_dot_sage_temp_osx_75462_tmp_S_2CnH_spyx_0.c:432:30: fatal error: cython_metaclass.h: No such file or directory\n    compilation terminated.\n    error: command 'gcc' failed with exit status 1\n```\n",
    "created_at": "2017-04-29T10:06:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22649#issuecomment-315944",
    "user": "vbraun"
}
```

On OSX there is lots of breakage of the form:

```
sage -t --long src/sage/misc/inherit_comparison.pyx
**********************************************************************
File "src/sage/misc/inherit_comparison.pyx", line 54, in sage.misc.inherit_comparison.InheritComparisonMetaclass
Failed example:
    cython('''
    from sage.misc.inherit_comparison cimport InheritComparisonMetaclass
    cdef class Base(object):
        def __richcmp__(left, right, int op):
            print("Calling Base.__richcmp__")
            return left is right
    cdef class Derived(Base):
        def __hash__(self):
            return 1
    cdef class DerivedWithRichcmp(Base):
        def __getmetaclass__(_):
            from sage.misc.inherit_comparison import InheritComparisonMetaclass
            return InheritComparisonMetaclass
        def __hash__(self):
            return 1
    ''')
Exception raised:
    Traceback (most recent call last):
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 509, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 872, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.inherit_comparison.InheritComparisonMetaclass[0]>", line 19, in <module>
        ''')
      File "sage/misc/lazy_import.pyx", line 389, in sage.misc.lazy_import.LazyImport.__call__ (/Users/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/misc/lazy_import.c:4016)
        return self._get_object()(*args, **kwds)
      File "sage/misc/cython_c.pyx", line 65, in sage.misc.cython_c.cython_compile (/Users/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/misc/cython_c.c:1192)
        cython_import_all(tmpfile, get_globals(),
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/misc/cython.py", line 789, in cython_import_all
        create_local_c_file=create_local_c_file)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/misc/cython.py", line 766, in cython_import
        **kwds)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/misc/cython.py", line 554, in cython
        raise RuntimeError("Error compiling {}:\n{}\n{}".format(filename, log, err))
    RuntimeError: Error compiling /Users/buildslave-sage/slave/sage_git/dot_sage/temp/osx/75462/tmp_S_2CnH.spyx:
    running build
    running build_ext
    building '_Users_buildslave_sage_slave_sage_git_dot_sage_temp_osx_75462_tmp_S_2CnH_spyx_0' extension
    creating build
    creating build/temp.macosx-10.9-x86_64-2.7
    gcc -fno-strict-aliasing -I/Users/buildslave-sage/slave/sage_git/build/local/var/tmp/sage/build/python2-2.7.13.p1/include -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -I/Users/buildslave-sage/slave/sage_git/build/local/include -I/Users/buildslave-sage/slave/sage_git/build/local/include/python2.7 -I/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/numpy/core/include -I/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages -I/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/ext -I/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/cysignals -I/Users/buildslave-sage/slave/sage_git/dot_sage/temp/osx/75462 -I/Users/buildslave-sage/slave/sage_git/build/local/include/python2.7 -c _Users_buildslave_sage_slave_sage_git_dot_sage_temp_osx_75462_tmp_S_2CnH_spyx_0.c -o build/temp.macosx-10.9-x86_64-2.7/_Users_buildslave_sage_slave_sage_git_dot_sage_temp_osx_75462_tmp_S_2CnH_spyx_0.o -w -O2
    _Users_buildslave_sage_slave_sage_git_dot_sage_temp_osx_75462_tmp_S_2CnH_spyx_0.c:432:30: fatal error: cython_metaclass.h: No such file or directory
    compilation terminated.
    error: command 'gcc' failed with exit status 1
```




---

archive/issue_comments_315945.json:
```json
{
    "body": "The `gcc` command in your sample looks wrong. Are the errors only related to `cython_metaclass.h` or gcc just fails to find any of the header?",
    "created_at": "2017-04-29T10:11:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22649#issuecomment-315945",
    "user": "vdelecroix"
}
```

The `gcc` command in your sample looks wrong. Are the errors only related to `cython_metaclass.h` or gcc just fails to find any of the header?



---

archive/issue_comments_315946.json:
```json
{
    "body": "I am seeing it too in sage-on-gentoo. The bulk seems to be `cython_metaclass.h` but it is not the only one\n\n```\nsage -t --long /usr/lib64/python2.7/site-packages/sage/libs/pynac/pynac.pxd\n**********************************************************************\nFile \"/usr/lib64/python2.7/site-packages/sage/libs/pynac/pynac.pxd\", line 10, in sage.libs.pynac.pynac\nFailed example:\n    cython(  # long time\n    '''\n    #clang c++\n    #clib pynac\n    #cargs --std=c++11\n    cimport sage.libs.pynac.pynac\n    ''')\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib64/python2.7/site-packages/sage/doctest/forker.py\", line 512, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib64/python2.7/site-packages/sage/doctest/forker.py\", line 875, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.libs.pynac.pynac[0]>\", line 7, in <module>\n        ''')\n      File \"sage/misc/lazy_import.pyx\", line 389, in sage.misc.lazy_import.LazyImport.__call__ (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/misc/lazy_import.c:4016)\n        return self._get_object()(*args, **kwds)\n      File \"sage/misc/cython_c.pyx\", line 65, in sage.misc.cython_c.cython_compile (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/misc/cython_c.c:1192)\n        cython_import_all(tmpfile, get_globals(),\n      File \"/usr/lib64/python2.7/site-packages/sage/misc/cython.py\", line 789, in cython_import_all\n        create_local_c_file=create_local_c_file)\n      File \"/usr/lib64/python2.7/site-packages/sage/misc/cython.py\", line 766, in cython_import\n        **kwds)\n      File \"/usr/lib64/python2.7/site-packages/sage/misc/cython.py\", line 554, in cython\n        raise RuntimeError(\"Error compiling {}:\\n{}\\n{}\".format(filename, log, err))\n    RuntimeError: Error compiling /home/fbissey/.sage/temp/moonloop/5134/tmp_2LMfAG.spyx:\n    running build\n    running build_ext\n    building '_home_fbissey__sage_temp_moonloop_5134_tmp_2LMfAG_spyx_0' extension\n    creating build\n    creating build/temp.linux-x86_64-2.7\n    x86_64-pc-linux-gnu-g++ -pthread -fPIC -I/usr/include -I/usr/include/python2.7 -I/usr/lib64/python2.7/site-packages/numpy/core/include -I/usr/lib64/python2.7/site-packages -I/usr/lib64/python2.7/site-packages/sage/ext -I/usr/lib64/python2.7/site-packages/cysignals -I/usr/lib64/python2.7/site-packages/cysignals -I/home/fbissey/.sage/temp/moonloop/5134 -I/usr/include/python2.7 -c _home_fbissey__sage_temp_moonloop_5134_tmp_2LMfAG_spyx_0.cpp -o build/temp.linux-x86_64-2.7/_home_fbissey__sage_temp_moonloop_5134_tmp_2LMfAG_spyx_0.o -w -O2 --std=c++11\n\n    _home_fbissey__sage_temp_moonloop_5134_tmp_2LMfAG_spyx_0.cpp:457:24: fatal error: pynac_wrap.h: No such file or directory\n    compilation terminated.\n    error: command 'x86_64-pc-linux-gnu-g++' failed with exit status 1\n```\n",
    "created_at": "2017-04-29T10:37:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22649#issuecomment-315946",
    "user": "fbissey"
}
```

I am seeing it too in sage-on-gentoo. The bulk seems to be `cython_metaclass.h` but it is not the only one

```
sage -t --long /usr/lib64/python2.7/site-packages/sage/libs/pynac/pynac.pxd
**********************************************************************
File "/usr/lib64/python2.7/site-packages/sage/libs/pynac/pynac.pxd", line 10, in sage.libs.pynac.pynac
Failed example:
    cython(  # long time
    '''
    #clang c++
    #clib pynac
    #cargs --std=c++11
    cimport sage.libs.pynac.pynac
    ''')
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 512, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 875, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.libs.pynac.pynac[0]>", line 7, in <module>
        ''')
      File "sage/misc/lazy_import.pyx", line 389, in sage.misc.lazy_import.LazyImport.__call__ (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/misc/lazy_import.c:4016)
        return self._get_object()(*args, **kwds)
      File "sage/misc/cython_c.pyx", line 65, in sage.misc.cython_c.cython_compile (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/misc/cython_c.c:1192)
        cython_import_all(tmpfile, get_globals(),
      File "/usr/lib64/python2.7/site-packages/sage/misc/cython.py", line 789, in cython_import_all
        create_local_c_file=create_local_c_file)
      File "/usr/lib64/python2.7/site-packages/sage/misc/cython.py", line 766, in cython_import
        **kwds)
      File "/usr/lib64/python2.7/site-packages/sage/misc/cython.py", line 554, in cython
        raise RuntimeError("Error compiling {}:\n{}\n{}".format(filename, log, err))
    RuntimeError: Error compiling /home/fbissey/.sage/temp/moonloop/5134/tmp_2LMfAG.spyx:
    running build
    running build_ext
    building '_home_fbissey__sage_temp_moonloop_5134_tmp_2LMfAG_spyx_0' extension
    creating build
    creating build/temp.linux-x86_64-2.7
    x86_64-pc-linux-gnu-g++ -pthread -fPIC -I/usr/include -I/usr/include/python2.7 -I/usr/lib64/python2.7/site-packages/numpy/core/include -I/usr/lib64/python2.7/site-packages -I/usr/lib64/python2.7/site-packages/sage/ext -I/usr/lib64/python2.7/site-packages/cysignals -I/usr/lib64/python2.7/site-packages/cysignals -I/home/fbissey/.sage/temp/moonloop/5134 -I/usr/include/python2.7 -c _home_fbissey__sage_temp_moonloop_5134_tmp_2LMfAG_spyx_0.cpp -o build/temp.linux-x86_64-2.7/_home_fbissey__sage_temp_moonloop_5134_tmp_2LMfAG_spyx_0.o -w -O2 --std=c++11

    _home_fbissey__sage_temp_moonloop_5134_tmp_2LMfAG_spyx_0.cpp:457:24: fatal error: pynac_wrap.h: No such file or directory
    compilation terminated.
    error: command 'x86_64-pc-linux-gnu-g++' failed with exit status 1
```




---

archive/issue_comments_315947.json:
```json
{
    "body": "Ah, I see. This is essentially yet another problem caused by #22461",
    "created_at": "2017-04-29T10:40:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22649#issuecomment-315947",
    "user": "jdemeyer"
}
```

Ah, I see. This is essentially yet another problem caused by #22461



---

archive/issue_comments_315948.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-09-15T11:40:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22649#issuecomment-315948",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_315949.json:
```json
{
    "body": "Merged in the dependencies.",
    "created_at": "2017-09-15T11:40:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22649#issuecomment-315949",
    "user": "jdemeyer"
}
```

Merged in the dependencies.



---

archive/issue_comments_315950.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-09-15T11:46:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22649#issuecomment-315950",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_315951.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-09-15T11:47:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22649#issuecomment-315951",
    "user": "jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_315952.json:
```json
{
    "body": "Given that I gave this ticket positive_review earlier, this should be set back to positive_review (modulo the dependencies of course) if tests pass.",
    "created_at": "2017-09-15T11:48:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22649#issuecomment-315952",
    "user": "jdemeyer"
}
```

Given that I gave this ticket positive_review earlier, this should be set back to positive_review (modulo the dependencies of course) if tests pass.



---

archive/issue_comments_315953.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-09-15T12:15:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22649#issuecomment-315953",
    "user": "jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_315954.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-10-05T06:54:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22649#issuecomment-315954",
    "user": "vbraun"
}
```

Resolution: fixed
