# Issue 22649: fix pxd header files

Issue created by migration from Trac.

Original creator: vdelecroix

Original creation time: 2017-04-27 13:41:30

CC:  jdemeyer

If we try to compile some external Cython code that links against some Sage Cython code the compiler is not able to find some of the headers. Thanks to our patched version of Cython, tiny modifications of the include solve the issue.


---

Comment by vdelecroix created at 2017-04-27 13:42:11

New commits:


---

Comment by vdelecroix created at 2017-04-27 13:42:11

Changing status from new to needs_review.


---

Comment by git created at 2017-04-27 13:44:25

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-04-28 11:19:26

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2017-04-28 11:19:26

New commits:


---

Comment by vbraun created at 2017-04-29 10:06:42

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2017-04-29 10:06:42

On OSX there is lots of breakage of the form:

```
sage -t --long src/sage/misc/inherit_comparison.pyx
**********************************************************************
File "src/sage/misc/inherit_comparison.pyx", line 54, in sage.misc.inherit_comparison.InheritComparisonMetaclass
Failed example:
    cython('''
    from sage.misc.inherit_comparison cimport InheritComparisonMetaclass
    cdef class Base(object):
        def __richcmp__(left, right, int op):
            print("Calling Base.__richcmp__")
            return left is right
    cdef class Derived(Base):
        def __hash__(self):
            return 1
    cdef class DerivedWithRichcmp(Base):
        def __getmetaclass__(_):
            from sage.misc.inherit_comparison import InheritComparisonMetaclass
            return InheritComparisonMetaclass
        def __hash__(self):
            return 1
    ''')
Exception raised:
    Traceback (most recent call last):
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 509, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 872, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.inherit_comparison.InheritComparisonMetaclass[0]>", line 19, in <module>
        ''')
      File "sage/misc/lazy_import.pyx", line 389, in sage.misc.lazy_import.LazyImport.__call__ (/Users/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/misc/lazy_import.c:4016)
        return self._get_object()(*args, **kwds)
      File "sage/misc/cython_c.pyx", line 65, in sage.misc.cython_c.cython_compile (/Users/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/misc/cython_c.c:1192)
        cython_import_all(tmpfile, get_globals(),
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/misc/cython.py", line 789, in cython_import_all
        create_local_c_file=create_local_c_file)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/misc/cython.py", line 766, in cython_import
        **kwds)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/misc/cython.py", line 554, in cython
        raise RuntimeError("Error compiling {}:\n{}\n{}".format(filename, log, err))
    RuntimeError: Error compiling /Users/buildslave-sage/slave/sage_git/dot_sage/temp/osx/75462/tmp_S_2CnH.spyx:
    running build
    running build_ext
    building '_Users_buildslave_sage_slave_sage_git_dot_sage_temp_osx_75462_tmp_S_2CnH_spyx_0' extension
    creating build
    creating build/temp.macosx-10.9-x86_64-2.7
    gcc -fno-strict-aliasing -I/Users/buildslave-sage/slave/sage_git/build/local/var/tmp/sage/build/python2-2.7.13.p1/include -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -I/Users/buildslave-sage/slave/sage_git/build/local/include -I/Users/buildslave-sage/slave/sage_git/build/local/include/python2.7 -I/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/numpy/core/include -I/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages -I/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/ext -I/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/cysignals -I/Users/buildslave-sage/slave/sage_git/dot_sage/temp/osx/75462 -I/Users/buildslave-sage/slave/sage_git/build/local/include/python2.7 -c _Users_buildslave_sage_slave_sage_git_dot_sage_temp_osx_75462_tmp_S_2CnH_spyx_0.c -o build/temp.macosx-10.9-x86_64-2.7/_Users_buildslave_sage_slave_sage_git_dot_sage_temp_osx_75462_tmp_S_2CnH_spyx_0.o -w -O2
    _Users_buildslave_sage_slave_sage_git_dot_sage_temp_osx_75462_tmp_S_2CnH_spyx_0.c:432:30: fatal error: cython_metaclass.h: No such file or directory
    compilation terminated.
    error: command 'gcc' failed with exit status 1
```



---

Comment by vdelecroix created at 2017-04-29 10:11:57

The `gcc` command in your sample looks wrong. Are the errors only related to `cython_metaclass.h` or gcc just fails to find any of the header?


---

Comment by fbissey created at 2017-04-29 10:37:20

I am seeing it too in sage-on-gentoo. The bulk seems to be `cython_metaclass.h` but it is not the only one

```
sage -t --long /usr/lib64/python2.7/site-packages/sage/libs/pynac/pynac.pxd
**********************************************************************
File "/usr/lib64/python2.7/site-packages/sage/libs/pynac/pynac.pxd", line 10, in sage.libs.pynac.pynac
Failed example:
    cython(  # long time
    '''
    #clang c++
    #clib pynac
    #cargs --std=c++11
    cimport sage.libs.pynac.pynac
    ''')
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 512, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 875, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.libs.pynac.pynac[0]>", line 7, in <module>
        ''')
      File "sage/misc/lazy_import.pyx", line 389, in sage.misc.lazy_import.LazyImport.__call__ (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/misc/lazy_import.c:4016)
        return self._get_object()(*args, **kwds)
      File "sage/misc/cython_c.pyx", line 65, in sage.misc.cython_c.cython_compile (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/misc/cython_c.c:1192)
        cython_import_all(tmpfile, get_globals(),
      File "/usr/lib64/python2.7/site-packages/sage/misc/cython.py", line 789, in cython_import_all
        create_local_c_file=create_local_c_file)
      File "/usr/lib64/python2.7/site-packages/sage/misc/cython.py", line 766, in cython_import
        **kwds)
      File "/usr/lib64/python2.7/site-packages/sage/misc/cython.py", line 554, in cython
        raise RuntimeError("Error compiling {}:\n{}\n{}".format(filename, log, err))
    RuntimeError: Error compiling /home/fbissey/.sage/temp/moonloop/5134/tmp_2LMfAG.spyx:
    running build
    running build_ext
    building '_home_fbissey__sage_temp_moonloop_5134_tmp_2LMfAG_spyx_0' extension
    creating build
    creating build/temp.linux-x86_64-2.7
    x86_64-pc-linux-gnu-g++ -pthread -fPIC -I/usr/include -I/usr/include/python2.7 -I/usr/lib64/python2.7/site-packages/numpy/core/include -I/usr/lib64/python2.7/site-packages -I/usr/lib64/python2.7/site-packages/sage/ext -I/usr/lib64/python2.7/site-packages/cysignals -I/usr/lib64/python2.7/site-packages/cysignals -I/home/fbissey/.sage/temp/moonloop/5134 -I/usr/include/python2.7 -c _home_fbissey__sage_temp_moonloop_5134_tmp_2LMfAG_spyx_0.cpp -o build/temp.linux-x86_64-2.7/_home_fbissey__sage_temp_moonloop_5134_tmp_2LMfAG_spyx_0.o -w -O2 --std=c++11

    _home_fbissey__sage_temp_moonloop_5134_tmp_2LMfAG_spyx_0.cpp:457:24: fatal error: pynac_wrap.h: No such file or directory
    compilation terminated.
    error: command 'x86_64-pc-linux-gnu-g++' failed with exit status 1
```



---

Comment by jdemeyer created at 2017-04-29 10:40:56

Ah, I see. This is essentially yet another problem caused by #22461


---

Comment by git created at 2017-09-15 11:40:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-09-15 11:40:49

Merged in the dependencies.


---

Comment by git created at 2017-09-15 11:46:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-09-15 11:47:55

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-09-15 11:48:56

Given that I gave this ticket positive_review earlier, this should be set back to positive_review (modulo the dependencies of course) if tests pass.


---

Comment by jdemeyer created at 2017-09-15 12:15:22

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-10-05 06:54:15

Resolution: fixed
