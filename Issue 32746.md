# Issue 32746: Reduction method of Elliptic curve over relative numberfield sometimes fails

archive/issues_032746.json:
```json
{
    "body": "CC:  slelievre\n\n\n```\nsage: x = polygen(ZZ) \n....: f = x ** 2 - x + 1007 \n....: K.<a> = QQ.extension(f) \n....: L.<b> = K.extension(x**2 - 11) \n....: q = L.prime_above(11) \n....: Fq = q.residue_field() \n....: E = EllipticCurve(L,[0,11**3]) \n....: E.reduction(q)                                                            \n---------------------------------------------------------------------------\nKeyError                                  Traceback (most recent call last)\n/var/tmp/sage-9.4-current/local/lib/python3.9/site-packages/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel.bin_op (build/cythonized/sage/structure/coerce.c:10474)()\n   1188         try:\n-> 1189             action = self._action_maps.get(xp, yp, op)\n   1190         except KeyError:\n\n/var/tmp/sage-9.4-current/local/lib/python3.9/site-packages/sage/structure/coerce_dict.pyx in sage.structure.coerce_dict.TripleDict.get (build/cythonized/sage/structure/coerce_dict.c:8024)()\n   1327         if not valid(cursor.key_id1):\n-> 1328             raise KeyError((k1, k2, k3))\n   1329         value = <object>cursor.value\n\nKeyError: (Residue field in bbar of Fractional ideal (b), Multivariate Polynomial Ring in x, y, z over Residue field in bbar of Fractional ideal (b), <built-in function mul>)\n\nDuring handling of the above exception, another exception occurred:\n\nIndexError                                Traceback (most recent call last)\n<ipython-input-106-0b37805c90b1> in <module>\n      6 Fq = q.residue_field()\n      7 E = EllipticCurve(L,[Integer(0),Integer(13)**Integer(3)])\n----> 8 E.reduction(q)\n\n...\n\n/var/tmp/sage-9.4-current/local/lib/python3.9/site-packages/sage/structure/category_object.pyx in sage.structure.category_object.normalize_names (build/cythonized/sage/structure/category_object.c:8487)()\n    898         return dir_with_other_class(self, self.category().parent_class)\n    899 \n--> 900 cpdef normalize_names(Py_ssize_t ngens, names):\n    901     r\"\"\"\n    902     Return a tuple of strings of variable names of length ngens given\n\n/var/tmp/sage-9.4-current/local/lib/python3.9/site-packages/sage/structure/category_object.pyx in sage.structure.category_object.normalize_names (build/cythonized/sage/structure/category_object.c:8361)()\n   1018     certify_names(names)\n   1019     if ngens >= 0 and len(names) != ngens:\n-> 1020        raise IndexError(\"the number of names must equal the number of generators\")\n   1021     return tuple(names)\n   1022 \n\nIndexError: the number of names must equal the number of generators\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/32983\n\n",
    "created_at": "2021-12-06T17:27:00Z",
    "labels": [
        "elliptic curves",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Reduction method of Elliptic curve over relative numberfield sometimes fails",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32746",
    "user": "mderickx"
}
```
CC:  slelievre


```
sage: x = polygen(ZZ) 
....: f = x ** 2 - x + 1007 
....: K.<a> = QQ.extension(f) 
....: L.<b> = K.extension(x**2 - 11) 
....: q = L.prime_above(11) 
....: Fq = q.residue_field() 
....: E = EllipticCurve(L,[0,11**3]) 
....: E.reduction(q)                                                            
---------------------------------------------------------------------------
KeyError                                  Traceback (most recent call last)
/var/tmp/sage-9.4-current/local/lib/python3.9/site-packages/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel.bin_op (build/cythonized/sage/structure/coerce.c:10474)()
   1188         try:
-> 1189             action = self._action_maps.get(xp, yp, op)
   1190         except KeyError:

/var/tmp/sage-9.4-current/local/lib/python3.9/site-packages/sage/structure/coerce_dict.pyx in sage.structure.coerce_dict.TripleDict.get (build/cythonized/sage/structure/coerce_dict.c:8024)()
   1327         if not valid(cursor.key_id1):
-> 1328             raise KeyError((k1, k2, k3))
   1329         value = <object>cursor.value

KeyError: (Residue field in bbar of Fractional ideal (b), Multivariate Polynomial Ring in x, y, z over Residue field in bbar of Fractional ideal (b), <built-in function mul>)

During handling of the above exception, another exception occurred:

IndexError                                Traceback (most recent call last)
<ipython-input-106-0b37805c90b1> in <module>
      6 Fq = q.residue_field()
      7 E = EllipticCurve(L,[Integer(0),Integer(13)**Integer(3)])
----> 8 E.reduction(q)

...

/var/tmp/sage-9.4-current/local/lib/python3.9/site-packages/sage/structure/category_object.pyx in sage.structure.category_object.normalize_names (build/cythonized/sage/structure/category_object.c:8487)()
    898         return dir_with_other_class(self, self.category().parent_class)
    899 
--> 900 cpdef normalize_names(Py_ssize_t ngens, names):
    901     r"""
    902     Return a tuple of strings of variable names of length ngens given

/var/tmp/sage-9.4-current/local/lib/python3.9/site-packages/sage/structure/category_object.pyx in sage.structure.category_object.normalize_names (build/cythonized/sage/structure/category_object.c:8361)()
   1018     certify_names(names)
   1019     if ngens >= 0 and len(names) != ngens:
-> 1020        raise IndexError("the number of names must equal the number of generators")
   1021     return tuple(names)
   1022 

IndexError: the number of names must equal the number of generators
```


Issue created by migration from https://trac.sagemath.org/ticket/32983





---

archive/issue_comments_467083.json:
```json
{
    "body": "Changing component from elliptic curves to algebra.",
    "created_at": "2021-12-06T18:00:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32746#issuecomment-467083",
    "user": "mderickx"
}
```

Changing component from elliptic curves to algebra.



---

archive/issue_comments_467084.json:
```json
{
    "body": "Changing component from algebra to number fields.",
    "created_at": "2021-12-07T16:25:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32746#issuecomment-467084",
    "user": "slelievre"
}
```

Changing component from algebra to number fields.



---

archive/issue_comments_467085.json:
```json
{
    "body": "The first example works, when writing `x1 * Fq.0` and also if you do `R(Fq.0) * x1`.",
    "created_at": "2022-02-01T20:24:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32746#issuecomment-467085",
    "user": "saraedum"
}
```

The first example works, when writing `x1 * Fq.0` and also if you do `R(Fq.0) * x1`.



---

archive/issue_comments_467086.json:
```json
{
    "body": "The underlying problem seems to be that `Fq.construction()` is an \"AlgebraicExtensionFunctor\".\n\nThere's a hack in pushout.py that makes that functor do something completely different in the context of residue fields. However, here, a generic pushout is tried and that then fails.",
    "created_at": "2022-02-01T20:34:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32746#issuecomment-467086",
    "user": "saraedum"
}
```

The underlying problem seems to be that `Fq.construction()` is an "AlgebraicExtensionFunctor".

There's a hack in pushout.py that makes that functor do something completely different in the context of residue fields. However, here, a generic pushout is tried and that then fails.
