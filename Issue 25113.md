# Issue 25113: trivial cases of operations in ℤ[x]

Issue created by migration from Trac.

Original creator: mmezzarobba

Original creation time: 2018-05-11 19:26:44




---

Comment by mmezzarobba created at 2018-05-11 19:30:29

Similar to #25349, more debatable since trivial operations with flint polynomials are reasonably fast, but, in my use cases at least, handling these special cases without creating temporary objects is faster.

(I considered changing the conversion into the parent to a coercion as it should be, but I didn't do it on this ticket for fear of breaking existing code. In particular, `gcd()` currently accepts fractions with denominator one...)


---

Comment by tscrim created at 2018-05-11 22:21:59

So by my understanding, this test is now stronger than before:

```diff
-            if right in ZZ:
-                sig_on()
-                fmpz_poly_scalar_fdiv_mpz(res.__poly, self.__poly,
-                        (<Integer>ZZ(right)).value)
-                sig_off()
-                return res
-        if self._parent is not right.parent():
-            right = self._parent(right)
-        sig_on()
-        fmpz_poly_div(res.__poly, self.__poly,
-                (<Polynomial_integer_dense_flint>right).__poly)
-        sig_off()
-        return res
+            if isinstance(right, Integer):
+                if (<Integer> right).is_zero():
+                    raise ZeroDivisionError("division by zero")
+                else:
+                    res = self._new()
+                    sig_on()
+                    fmpz_poly_scalar_fdiv_mpz(res.__poly, self.__poly,
+                            (<Integer>ZZ(right)).value)
+                    sig_off()
+                    return res
+            else:
+                right = self._parent(right)
```

Hence, you get a slowdown:

```
sage: R.<x> = ZZ[]
sage: %timeit (x^2 + 13*x + 169) // QQ(13)
The slowest run took 86.24 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 6.97 µs per loop
```

vs 8.3.beta0:

```
sage: %timeit (x^2 + 13*x + 169) // QQ(13)
The slowest run took 174.81 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 3.06 µs per loop
```

The reason is it converts `QQ -> ZZ['x']` and then does the `floordiv`. This is likely common because if you do, e.g., `4/2` instead of `4//2`, you get something in `QQ`. Plus the extra `ZZ` conversion in your new test is unnecessary. I would instead do:

```python
            if isinstance(right, Integer):
                if (<Integer> right).is_zero():
                    raise ZeroDivisionError("division by zero")
                else:
                    res = self._new()
                    sig_on()
                    fmpz_poly_scalar_fdiv_mpz(res.__poly, self.__poly,
                            (<Integer> right).value)
                    sig_off()
                    return res
            elif right in ZZ:
                res = self._new()
                sig_on()
                fmpz_poly_scalar_fdiv_mpz(res.__poly, self.__poly,
                        (<Integer>ZZ(right)).value)
                sig_off()
                return res
            else:
                right = self._parent(right)
```



---

Comment by mmezzarobba created at 2018-05-12 04:47:21

Replying to [comment:2 tscrim]:
> So by my understanding, this test is now stronger than before:

Indeed. It was intentional (not the Right Way ⇒ no point in making it fast)... but I didn't think of that:

> This is likely common because if you do, e.g., `4/2` instead of `4//2`, you get something in `QQ`.

and I'm open to reverting the change.

> Plus the extra `ZZ` conversion in your new test is unnecessary.

That was an oversight, thanks!


---

Comment by git created at 2018-05-12 04:51:56

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by tscrim created at 2018-05-12 07:08:43

This `(<Polynomial_integer_dense_flint>right)` would be better as `_right` given that you've already have the variable and done the typecast. That's all the comments I have (so if with that change, you set this to needs review, then you can set it to a positive review on my behalf).

I was never suggesting to revert the change; just wanted the old faster code path to still be there.


---

Comment by git created at 2018-05-12 10:54:57

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mmezzarobba created at 2018-05-12 10:56:57

Ok, thanks again! (I'll wait for the patchbot to go green before setting it to positive review.)


---

Comment by mmezzarobba created at 2018-05-12 10:56:57

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2018-05-12 19:43:59

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2018-05-12 19:43:59

flint has a `fmpz_poly_is_one`.


---

Comment by git created at 2018-05-14 10:45:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mmezzarobba created at 2018-05-14 10:46:22

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2018-05-14 22:58:24

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-05-18 17:48:52

Resolution: fixed
