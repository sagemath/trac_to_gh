# Issue 25113: trivial cases of operations in ℤ[x]

archive/issues_025113.json:
```json
{
    "body": "\n\nIssue created by migration from https://trac.sagemath.org/ticket/25350\n\n",
    "created_at": "2018-05-11T19:26:44Z",
    "labels": [
        "basic arithmetic",
        "minor",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.3",
    "title": "trivial cases of operations in \u2124[x]",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25113",
    "user": "mmezzarobba"
}
```


Issue created by migration from https://trac.sagemath.org/ticket/25350





---

archive/issue_comments_353348.json:
```json
{
    "body": "Similar to #25349, more debatable since trivial operations with flint polynomials are reasonably fast, but, in my use cases at least, handling these special cases without creating temporary objects is faster.\n\n(I considered changing the conversion into the parent to a coercion as it should be, but I didn't do it on this ticket for fear of breaking existing code. In particular, `gcd()` currently accepts fractions with denominator one...)",
    "created_at": "2018-05-11T19:30:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25113#issuecomment-353348",
    "user": "mmezzarobba"
}
```

Similar to #25349, more debatable since trivial operations with flint polynomials are reasonably fast, but, in my use cases at least, handling these special cases without creating temporary objects is faster.

(I considered changing the conversion into the parent to a coercion as it should be, but I didn't do it on this ticket for fear of breaking existing code. In particular, `gcd()` currently accepts fractions with denominator one...)



---

archive/issue_comments_353349.json:
```json
{
    "body": "So by my understanding, this test is now stronger than before:\n\n```diff\n-            if right in ZZ:\n-                sig_on()\n-                fmpz_poly_scalar_fdiv_mpz(res.__poly, self.__poly,\n-                        (<Integer>ZZ(right)).value)\n-                sig_off()\n-                return res\n-        if self._parent is not right.parent():\n-            right = self._parent(right)\n-        sig_on()\n-        fmpz_poly_div(res.__poly, self.__poly,\n-                (<Polynomial_integer_dense_flint>right).__poly)\n-        sig_off()\n-        return res\n+            if isinstance(right, Integer):\n+                if (<Integer> right).is_zero():\n+                    raise ZeroDivisionError(\"division by zero\")\n+                else:\n+                    res = self._new()\n+                    sig_on()\n+                    fmpz_poly_scalar_fdiv_mpz(res.__poly, self.__poly,\n+                            (<Integer>ZZ(right)).value)\n+                    sig_off()\n+                    return res\n+            else:\n+                right = self._parent(right)\n```\n\nHence, you get a slowdown:\n\n```\nsage: R.<x> = ZZ[]\nsage: %timeit (x^2 + 13*x + 169) // QQ(13)\nThe slowest run took 86.24 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 6.97 \u00b5s per loop\n```\n\nvs 8.3.beta0:\n\n```\nsage: %timeit (x^2 + 13*x + 169) // QQ(13)\nThe slowest run took 174.81 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 3.06 \u00b5s per loop\n```\n\nThe reason is it converts `QQ -> ZZ['x']` and then does the `floordiv`. This is likely common because if you do, e.g., `4/2` instead of `4//2`, you get something in `QQ`. Plus the extra `ZZ` conversion in your new test is unnecessary. I would instead do:\n\n```python\n            if isinstance(right, Integer):\n                if (<Integer> right).is_zero():\n                    raise ZeroDivisionError(\"division by zero\")\n                else:\n                    res = self._new()\n                    sig_on()\n                    fmpz_poly_scalar_fdiv_mpz(res.__poly, self.__poly,\n                            (<Integer> right).value)\n                    sig_off()\n                    return res\n            elif right in ZZ:\n                res = self._new()\n                sig_on()\n                fmpz_poly_scalar_fdiv_mpz(res.__poly, self.__poly,\n                        (<Integer>ZZ(right)).value)\n                sig_off()\n                return res\n            else:\n                right = self._parent(right)\n```\n",
    "created_at": "2018-05-11T22:21:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25113#issuecomment-353349",
    "user": "tscrim"
}
```

So by my understanding, this test is now stronger than before:

```diff
-            if right in ZZ:
-                sig_on()
-                fmpz_poly_scalar_fdiv_mpz(res.__poly, self.__poly,
-                        (<Integer>ZZ(right)).value)
-                sig_off()
-                return res
-        if self._parent is not right.parent():
-            right = self._parent(right)
-        sig_on()
-        fmpz_poly_div(res.__poly, self.__poly,
-                (<Polynomial_integer_dense_flint>right).__poly)
-        sig_off()
-        return res
+            if isinstance(right, Integer):
+                if (<Integer> right).is_zero():
+                    raise ZeroDivisionError("division by zero")
+                else:
+                    res = self._new()
+                    sig_on()
+                    fmpz_poly_scalar_fdiv_mpz(res.__poly, self.__poly,
+                            (<Integer>ZZ(right)).value)
+                    sig_off()
+                    return res
+            else:
+                right = self._parent(right)
```

Hence, you get a slowdown:

```
sage: R.<x> = ZZ[]
sage: %timeit (x^2 + 13*x + 169) // QQ(13)
The slowest run took 86.24 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 6.97 µs per loop
```

vs 8.3.beta0:

```
sage: %timeit (x^2 + 13*x + 169) // QQ(13)
The slowest run took 174.81 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 3.06 µs per loop
```

The reason is it converts `QQ -> ZZ['x']` and then does the `floordiv`. This is likely common because if you do, e.g., `4/2` instead of `4//2`, you get something in `QQ`. Plus the extra `ZZ` conversion in your new test is unnecessary. I would instead do:

```python
            if isinstance(right, Integer):
                if (<Integer> right).is_zero():
                    raise ZeroDivisionError("division by zero")
                else:
                    res = self._new()
                    sig_on()
                    fmpz_poly_scalar_fdiv_mpz(res.__poly, self.__poly,
                            (<Integer> right).value)
                    sig_off()
                    return res
            elif right in ZZ:
                res = self._new()
                sig_on()
                fmpz_poly_scalar_fdiv_mpz(res.__poly, self.__poly,
                        (<Integer>ZZ(right)).value)
                sig_off()
                return res
            else:
                right = self._parent(right)
```




---

archive/issue_comments_353350.json:
```json
{
    "body": "Replying to [comment:2 tscrim]:\n> So by my understanding, this test is now stronger than before:\n\nIndeed. It was intentional (not the Right Way \u21d2 no point in making it fast)... but I didn't think of that:\n\n> This is likely common because if you do, e.g., `4/2` instead of `4//2`, you get something in `QQ`.\n\nand I'm open to reverting the change.\n\n> Plus the extra `ZZ` conversion in your new test is unnecessary.\n\nThat was an oversight, thanks!",
    "created_at": "2018-05-12T04:47:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25113#issuecomment-353350",
    "user": "mmezzarobba"
}
```

Replying to [comment:2 tscrim]:
> So by my understanding, this test is now stronger than before:

Indeed. It was intentional (not the Right Way ⇒ no point in making it fast)... but I didn't think of that:

> This is likely common because if you do, e.g., `4/2` instead of `4//2`, you get something in `QQ`.

and I'm open to reverting the change.

> Plus the extra `ZZ` conversion in your new test is unnecessary.

That was an oversight, thanks!



---

archive/issue_comments_353351.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-05-12T04:51:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25113#issuecomment-353351",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_353352.json:
```json
{
    "body": "This `(<Polynomial_integer_dense_flint>right)` would be better as `_right` given that you've already have the variable and done the typecast. That's all the comments I have (so if with that change, you set this to needs review, then you can set it to a positive review on my behalf).\n\nI was never suggesting to revert the change; just wanted the old faster code path to still be there.",
    "created_at": "2018-05-12T07:08:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25113#issuecomment-353352",
    "user": "tscrim"
}
```

This `(<Polynomial_integer_dense_flint>right)` would be better as `_right` given that you've already have the variable and done the typecast. That's all the comments I have (so if with that change, you set this to needs review, then you can set it to a positive review on my behalf).

I was never suggesting to revert the change; just wanted the old faster code path to still be there.



---

archive/issue_comments_353353.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-05-12T10:54:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25113#issuecomment-353353",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_353354.json:
```json
{
    "body": "Ok, thanks again! (I'll wait for the patchbot to go green before setting it to positive review.)",
    "created_at": "2018-05-12T10:56:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25113#issuecomment-353354",
    "user": "mmezzarobba"
}
```

Ok, thanks again! (I'll wait for the patchbot to go green before setting it to positive review.)



---

archive/issue_comments_353355.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-05-12T10:56:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25113#issuecomment-353355",
    "user": "mmezzarobba"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_353356.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-05-12T19:43:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25113#issuecomment-353356",
    "user": "vdelecroix"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_353357.json:
```json
{
    "body": "flint has a `fmpz_poly_is_one`.",
    "created_at": "2018-05-12T19:43:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25113#issuecomment-353357",
    "user": "vdelecroix"
}
```

flint has a `fmpz_poly_is_one`.



---

archive/issue_comments_353358.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-05-14T10:45:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25113#issuecomment-353358",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_353359.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-05-14T10:46:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25113#issuecomment-353359",
    "user": "mmezzarobba"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_353360.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-05-14T22:58:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25113#issuecomment-353360",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_353361.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-05-18T17:48:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25113",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25113#issuecomment-353361",
    "user": "vbraun"
}
```

Resolution: fixed
