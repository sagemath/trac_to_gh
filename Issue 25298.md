# Issue 25298: failing internet doctest in sage/repl/load.py

Issue created by migration from Trac.

Original creator: slabbe

Original creation time: 2018-06-07 20:09:19

As reported on [sage-release 8.3.beta3](https://groups.google.com/d/msg/sage-release/l635YEuT7Hs/WkHCnmWhAQAJ),


```
sage -tp --optional=sage,internet src/sage/repl/load.py
```


gives


```
sage -t src/sage/repl/load.py
**********************************************************************
File "src/sage/repl/load.py", line 142, in sage.repl.load.load
Failed example:
    sage.repl.load.load('http://wstein.org/loadtest.py', globals())  # optional - internet
Exception raised:
    Traceback (most recent call last):
      File "/home/slabbe/GitBox/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 572, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/slabbe/GitBox/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 982, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.repl.load.load[16]>", line 1, in <module>
        sage.repl.load.load('http://wstein.org/loadtest.py', globals())  # optional - internet
      File "/home/slabbe/GitBox/sage/local/lib/python2.7/site-packages/sage/repl/load.py", line 242, in load
        code = compile(f.read(), fpath, 'exec')
      File "/home/slabbe/.sage/temp/labbe-laptop/4725/tmp_aLSpZn.py", line 1
        <!DOCTYPE html>
        ^
    SyntaxError: invalid syntax
**********************************************************************
1 item had failures:
   1 of  37 in sage.repl.load.load
    [45 tests, 1 failure, 3.81 s]
----------------------------------------------------------------------
sage -t src/sage/repl/load.py  # 1 doctest failed
----------------------------------------------------------------------
```




---

Comment by slabbe created at 2018-08-25 13:11:25

This works:


```
$ wget http://wstein.org/loadtest.py
$ cat loadtest.py 
print "hi from the net"

print 2+3
```


But it does not work from Sage:


```
sage: sage.repl.load.load('http://wstein.org/loadtest.py', globals())
  File "/home/slabbe/.sage/temp/labbe-laptop/25148/tmp_GGzNox.py", line 1
    <!DOCTYPE html>
    ^
SyntaxError: invalid syntax
```


This allows to understand the problem:


```
sage: !cat /home/slabbe/.sage/temp/labbe-laptop/25148/tmp_GGzNox.py
<!DOCTYPE html>
...
<head>
<title>Access denied | wstein.org used Cloudflare to restrict access</title>
...
        <h2 class="cf-subheadline">Access denied</h2>
...
            <h2 data-translate="what_happened">What happened?</h2>
            <p>The owner of this website (wstein.org) has banned your access based on your browser's signature. ...</p>
          </div>
...
</script>
</body>
</html>
sage: 
```



---

Comment by @timokau created at 2018-08-25 14:22:24

Is the point of that doctest to fetch a random python file from a webpage over http and execute it? If so, we should probably remove the doctest instead or amend it to use a local file / check the hash of the file first.


---

Comment by nbruin created at 2018-08-26 18:12:08

The issue that Cloudflare blocks the default python useragent was already encountered at #25222. We have a workaround there as well.

Indeed the wisdom in executing a file fetched from the internet relatively blindly is questionable.


---

Comment by slabbe created at 2018-09-01 09:39:40

Changing status from new to needs_review.


---

Comment by slabbe created at 2018-09-01 09:39:40

As suggested by nbruin, I added some User-Agent in `get_remote_file`. The problem is that I now use `urlopen` instead of `urlretrieve`. Thus, I can not specify the `report_hook` anymore which was used by the `verbose`.

I set it to `needs_review` to get some feedback by the patchbots.
----
New commits:


---

Comment by @timokau created at 2018-09-01 11:22:43

In my opinion the security issue of fetching an executing a file from the internet (especially over HTTP) should also be addressed. Although you could argue that it is out of scope in this ticket, maybe it can be combined.


---

Comment by slabbe created at 2018-09-02 21:12:30

Indeed, I wanted to say that my first commit was just fixing the doctest with the new url `http://www.sagemath.org/files/loadtest.py`. I am not a specialist on security issues.

I know that fixing this doctest means that the `loadtest.py` file will be downloaded and executed each time someone runs optional doctests including those with tag `internet`. Is it possible that someone replaces the `loadtest.py` file by something else more malecious one day? I don't know. I let other discuss the security issue and possibly propose other commits, solutions...

Meanwhile, I know that the doctest is broken which means that something is currently broken and keeping the doctest will guarrentees that the feature continue to be tested.


---

Comment by @timokau created at 2018-09-02 21:41:24

Replying to [comment:6 slabbe]:
> Is it possible that someone replaces the `loadtest.py` file by something else more malecious one day? I don't know. I let other discuss the security issue and possibly propose other commits, solutions...

Yes, that is one possibility. It could be replaced by someone on the sage team for various motivations (though rather unlikely) or be replaced as part of a server compromise. Targeted attacks that go unnoticed would also be possible.
But worse is the possibility of the request jost being MITM'd by *anybody* on the network since it is fetched over HTTP. So if you're running the sage doctests in a public wifi, anybody else in that wifi could execute code on your computer.

Possible solutions include
- first downloading the file, then verifying the contents match a hash, then loading it
- just loading a local file

Do we really need to test that we can fetch a file from the internet? Thats more or less a python primitive. And if we need to test that we can and should test it seperately from the `load` mechanism.


---

Comment by chapoton created at 2018-09-03 06:05:08

the loadtest.py file should also be made python3-compatible

EDIT: DONE


---

Comment by git created at 2018-09-20 09:23:36

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by slabbe created at 2018-09-20 09:38:30

I rebased on top of the most recent beta and I added a commit.

There are three issues begin dealt in this ticket:

 - `get_remote_file` was broken
 - `get_remote_file` was not properly tested (even broken, the doctests were passing)
 - `load` was loading a file from the http which is not secure

I believe the proposed two commits solves the above 3 issues (needs review).


---

Comment by slabbe created at 2018-09-20 09:40:12

There is one small thing that I am still not able to preserve. It is the loading bar of dots `........` as in:


```
sage: get_remote_file('http://www.sagemath.org/files/loadtest.py', verbose=True)
Attempting to load remote file: http://www.sagemath.org/files/loadtest.py
Loading: [.................]    
```


which used to be printed with the help of the `report_hook` which I can not use anymore since I replaced the call to `urlretrieve` by a call to `urlopen`:


```diff
-        urlretrieve(filename, temp_name, report_hook)
+        content = urlopen(req, timeout=1)
+        with open(temp_name, 'w') as f:
+            f.write(content.read())
```


Somebody has a solution? (... one of them being getting rid of the report_hook thing)


---

Comment by chapoton created at 2018-09-30 12:47:08

le plugin "pyflakes" est pas content, car un import est en trop..


---

Comment by git created at 2018-10-08 18:59:58

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by slabbe created at 2018-10-08 19:04:48

Replying to [comment:12 chapoton]:
> le plugin "pyflakes" est pas content, car un import est en trop..

yes, this was because of the `urlretrieve` that I am replacing by `urlopen`. I was waiting for an answer to my previous comment before removing the `import urlretrieve`...

I removed it now and rebased the branch on top of 8.4.rc0


---

Comment by vklein created at 2019-01-10 10:05:30

Set assignee to vklein.


---

Comment by vklein created at 2019-01-10 10:49:44

Replying to [comment:11 slabbe]:
> 
> Somebody has a solution? (... one of them being getting rid of the report_hook thing)

Others `urlopen` usage in sage don't seems to display a kind of "Download progress bar" and in my opinion something like "Loading started" and "Loading ended" is enough for the verbose mode. It's still possible to implement a read chunk by chunk if it's really needed.

Either way the remaining `report_hook` function and `cur` global variable should be removed from the code.


---

Comment by slabbe created at 2019-01-10 13:05:11

Changing status from needs_review to needs_work.


---

Comment by slabbe created at 2019-01-10 13:05:11

ok


---

Comment by vklein created at 2019-01-10 13:31:55

Remove assignee vklein.


---

Comment by vklein created at 2019-01-10 13:31:55

I am ok with the rest of this ticket, i have no other remark.


---

Comment by embray created at 2019-01-15 18:15:21

Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.


---

Comment by git created at 2019-01-31 09:28:05

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by slabbe created at 2019-01-31 09:29:22

Changing keywords from "" to "thursdaysbdx".


---

Comment by slabbe created at 2019-01-31 09:29:22

Changing status from needs_work to needs_review.


---

Comment by vklein created at 2019-01-31 10:08:56

Looks good to me.


---

Comment by vklein created at 2019-01-31 10:08:56

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-02-03 09:00:09

Resolution: fixed
