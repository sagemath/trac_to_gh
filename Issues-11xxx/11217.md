# Issue 11217: Bad displays for Macaulay2

archive/issues_011045.json:
```json
{
    "body": "This input in the sage notebook\n\n```\nR2 = macaulay2.ring('QQ','[x,y]'); R2\n```\ngives this output\n\n```\nQQ[x..y, Degrees => {2:1}, Heft => {1}, MonomialOrder =>\n{MonomialSize => 16}, DegreeRank => 1]\n                                                         {Lex => 2   \n}\n                                                         {Position =>\nUp    }\n\n\n```\n\nThis input in the sage notebook \n\n```\nI = macaulay2.ideal( ('y^2 -x','x-y') ); I\nJ = I^3;\nprint J\nprint J.gb()\n```\ngives this output\n\n```\n        6       4     2 2    3     4    5     2 2       3    3    2    2\n2       3    4    3     2       2   3     2        2    3\nideal (y  + 2x*y  - 2x y  - x , x*y  - y  - 2x y  + 2x*y  + x  - x y, x\ny  - 2x*y  + y  - x  + 2x y - x*y , x  + 2x y - 2x*y  - y )\nGroebnerBasis[status: done; S-pairs encountered up to degree 6]\n```\nThis may not be limited to the sage notebook. I haven't checked.\n\nAssignee: jason, mpatel, was\n\nKeywords: Macaulay2\n\nBranch/Commit: 8bec6409ea565b62d0accb90c844920cc1dc1b0c\n\nReviewer: Fr\u00e9d\u00e9ric Chapoton\n\nAuthor: Markus Wageringel\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/11217\n\n",
    "closed_at": "2019-07-23T21:03:56Z",
    "created_at": "2011-04-19T04:06:45Z",
    "labels": [
        "component: interfaces: optional",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.9",
    "title": "Bad displays for Macaulay2",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11217",
    "user": "https://github.com/tdupu"
}
```
This input in the sage notebook

```
R2 = macaulay2.ring('QQ','[x,y]'); R2
```
gives this output

```
QQ[x..y, Degrees => {2:1}, Heft => {1}, MonomialOrder =>
{MonomialSize => 16}, DegreeRank => 1]
                                                         {Lex => 2   
}
                                                         {Position =>
Up    }


```

This input in the sage notebook 

```
I = macaulay2.ideal( ('y^2 -x','x-y') ); I
J = I^3;
print J
print J.gb()
```
gives this output

```
        6       4     2 2    3     4    5     2 2       3    3    2    2
2       3    4    3     2       2   3     2        2    3
ideal (y  + 2x*y  - 2x y  - x , x*y  - y  - 2x y  + 2x*y  + x  - x y, x
y  - 2x*y  + y  - x  + 2x y - x*y , x  + 2x y - 2x*y  - y )
GroebnerBasis[status: done; S-pairs encountered up to degree 6]
```
This may not be limited to the sage notebook. I haven't checked.

Assignee: jason, mpatel, was

Keywords: Macaulay2

Branch/Commit: 8bec6409ea565b62d0accb90c844920cc1dc1b0c

Reviewer: Frédéric Chapoton

Author: Markus Wageringel

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/11217





---

archive/issue_comments_120181.json:
```json
{
    "body": "Changing keywords from \"Macaulay2, Sage Notebook\" to \"Macaulay2\".",
    "created_at": "2019-06-21T08:11:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11217",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11217#issuecomment-120181",
    "user": "https://github.com/fchapoton"
}
```

Changing keywords from "Macaulay2, Sage Notebook" to "Macaulay2".



---

archive/issue_comments_120182.json:
```json
{
    "body": "Changing component from notebook to interfaces: optional.",
    "created_at": "2019-06-21T08:11:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11217",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11217#issuecomment-120182",
    "user": "https://github.com/fchapoton"
}
```

Changing component from notebook to interfaces: optional.



---

archive/issue_comments_120183.json:
```json
{
    "body": "<a id='comment:4'></a>This is controlled by `printWidth` in Macaulay2, which is initialized to 0 by the interface, effectively disabling line wrapping. It could probably be set to something else, e.g. 80 or the terminal width, but some parts of the implementation might expect unwrapped output, such as tab completion.\n\nWith Macaulay2 1.12, it can also be set manually:\n\n```\nsage: macaulay2.eval('printWidth = 80;')\n\nsage: I^3\n          3     2 2       4    6   3     2 2    2       4       3\nideal (- x  + 3x y  - 3x*y  + y , x  - 2x y  - x y + x*y  + 2x*y\n------------------------------------------------------------------\n   5     3    2 2     2        3      2    4   3     2        2\n- y , - x  + x y  + 2x y - 2x*y  - x*y  + y , x  - 3x y + 3x*y  -\n------------------------------------------------------------------\n 3\ny )\n```\n\nIn Macaulay2 1.13, this does not have any effect. Apparently the behavior of `describe` has changed to ignore `printWidth` \u2013 this should make it work:\n\n```diff\n--- a/src/sage/interfaces/macaulay2.py\n+++ b/src/sage/interfaces/macaulay2.py\n@@ -303,7 +311,7 @@ class Macaulay2(ExtraTabCompletion, Expect):\n             sage: macaulay2.get(\"a\")      # optional - macaulay2\n             2\n         \"\"\"\n-        return self.eval(\"describe %s\"%var, strip=True)\n+        return self.eval(\"net describe %s\"%var, strip=True)\n\n     def set(self, var, value):\n         \"\"\"\n```",
    "created_at": "2019-06-22T15:01:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11217",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11217#issuecomment-120183",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:4'></a>This is controlled by `printWidth` in Macaulay2, which is initialized to 0 by the interface, effectively disabling line wrapping. It could probably be set to something else, e.g. 80 or the terminal width, but some parts of the implementation might expect unwrapped output, such as tab completion.

With Macaulay2 1.12, it can also be set manually:

```
sage: macaulay2.eval('printWidth = 80;')

sage: I^3
          3     2 2       4    6   3     2 2    2       4       3
ideal (- x  + 3x y  - 3x*y  + y , x  - 2x y  - x y + x*y  + 2x*y
------------------------------------------------------------------
   5     3    2 2     2        3      2    4   3     2        2
- y , - x  + x y  + 2x y - 2x*y  - x*y  + y , x  - 3x y + 3x*y  -
------------------------------------------------------------------
 3
y )
```

In Macaulay2 1.13, this does not have any effect. Apparently the behavior of `describe` has changed to ignore `printWidth` – this should make it work:

```diff
--- a/src/sage/interfaces/macaulay2.py
+++ b/src/sage/interfaces/macaulay2.py
@@ -303,7 +311,7 @@ class Macaulay2(ExtraTabCompletion, Expect):
             sage: macaulay2.get("a")      # optional - macaulay2
             2
         """
-        return self.eval("describe %s"%var, strip=True)
+        return self.eval("net describe %s"%var, strip=True)

     def set(self, var, value):
         """
```



---

archive/issue_comments_120184.json:
```json
{
    "body": "<a id='comment:5'></a>The following patch (based on #27979) works for me with Macaulay2 version 1.12 and 1.13. This leaves `printWidth` alone, but comes with the advantage that it always takes the current terminal width into account. In the notebook, it defaults to 80 characters.\n\nSeveral doctests will need to be updated for this \u2013 I will postpone this until the other Macaulay2 tickets are merged.\n\n```diff\n--- a/src/sage/interfaces/macaulay2.py\n+++ b/src/sage/interfaces/macaulay2.py\n@@ -184,7 +184,12 @@ class Macaulay2(ExtraTabCompletion, Expect):\n             # Also prevent line wrapping in Macaulay2\n             \"printWidth = 0;\" +\n             # And make all output labels to be of the same width\n-            \"lineNumber = 10^9;\")\n+            \"lineNumber = 10^9;\"\n+            # Convert a Macaulay2 element to Net for display in Sage.\n+            'sageDescribe = method();'\n+            'sageDescribe(Thing) := net @@ describe;'\n+            'sageDescribe(Matrix) := net;'\n+            )\n         Expect.__init__(self,\n                         name = 'macaulay2',\n                         prompt = PROMPT,\n@@ -339,8 +344,9 @@ class Macaulay2(ExtraTabCompletion, Expect):\n             | 1 2 |\n             | 3 4 |\n         \"\"\"\n-        return self.eval('(if instance({0}, Matrix) then net else describe)'\n-                         ' {0}'.format(var), strip=True)\n+        from sage.typeset.ascii_art import empty_ascii_art\n+        return self.eval('wrap(%d,\"-\",sageDescribe %s)'\n+                % (empty_ascii_art._terminal_width(), var), strip=True)\n\n     def set(self, var, value):\n         \"\"\"\n```",
    "created_at": "2019-06-27T19:54:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11217",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11217#issuecomment-120184",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:5'></a>The following patch (based on #27979) works for me with Macaulay2 version 1.12 and 1.13. This leaves `printWidth` alone, but comes with the advantage that it always takes the current terminal width into account. In the notebook, it defaults to 80 characters.

Several doctests will need to be updated for this – I will postpone this until the other Macaulay2 tickets are merged.

```diff
--- a/src/sage/interfaces/macaulay2.py
+++ b/src/sage/interfaces/macaulay2.py
@@ -184,7 +184,12 @@ class Macaulay2(ExtraTabCompletion, Expect):
             # Also prevent line wrapping in Macaulay2
             "printWidth = 0;" +
             # And make all output labels to be of the same width
-            "lineNumber = 10^9;")
+            "lineNumber = 10^9;"
+            # Convert a Macaulay2 element to Net for display in Sage.
+            'sageDescribe = method();'
+            'sageDescribe(Thing) := net @@ describe;'
+            'sageDescribe(Matrix) := net;'
+            )
         Expect.__init__(self,
                         name = 'macaulay2',
                         prompt = PROMPT,
@@ -339,8 +344,9 @@ class Macaulay2(ExtraTabCompletion, Expect):
             | 1 2 |
             | 3 4 |
         """
-        return self.eval('(if instance({0}, Matrix) then net else describe)'
-                         ' {0}'.format(var), strip=True)
+        from sage.typeset.ascii_art import empty_ascii_art
+        return self.eval('wrap(%d,"-",sageDescribe %s)'
+                % (empty_ascii_art._terminal_width(), var), strip=True)

     def set(self, var, value):
         """
```



---

archive/issue_events_029053.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2019-07-15T21:00:40Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11217",
    "milestone": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11217#event-29053"
}
```



---

archive/issue_comments_120185.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-07-15T21:00:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11217",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11217#issuecomment-120185",
    "user": "https://github.com/mwageringel"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_120186.json:
```json
{
    "body": "<a id='comment:6'></a>Here is a branch implementing this. This was tested with Macaulay2 version 1.12 and 1.13 using\n\n```\n./sage -t --long --optional=sage,macaulay2 $(grep -i \"optional.*macaulay2\" -r src/sage -l | paste -sd \" \" -)\n```\n\n---\nNew commits:",
    "created_at": "2019-07-15T21:00:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11217",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11217#issuecomment-120186",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:6'></a>Here is a branch implementing this. This was tested with Macaulay2 version 1.12 and 1.13 using

```
./sage -t --long --optional=sage,macaulay2 $(grep -i "optional.*macaulay2" -r src/sage -l | paste -sd " " -)
```

---
New commits:



---

archive/issue_comments_120187.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-07-15T22:05:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11217",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11217#issuecomment-120187",
    "user": "https://github.com/mwageringel"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_120188.json:
```json
{
    "body": "<a id='comment:7'></a>This needs more work, as conversion to Sage in the method `_sage_()` depends on the unwrapped string representation of Macaulay2 elements, in several places. For example this fails:\n\n```\nsage: macaulay2('QQ[x_0..x_5]')._sage_()\nMultivariate Polynomial Ring in x_0, x_1, x_2, x_3, x_4, x_5 over Rational Field\nsage: macaulay2('QQ[x_0..x_100]')._sage_()\n...\nValueError: variable name '------...' is not alphanumeric\n```",
    "created_at": "2019-07-15T22:05:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11217",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11217#issuecomment-120188",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:7'></a>This needs more work, as conversion to Sage in the method `_sage_()` depends on the unwrapped string representation of Macaulay2 elements, in several places. For example this fails:

```
sage: macaulay2('QQ[x_0..x_5]')._sage_()
Multivariate Polynomial Ring in x_0, x_1, x_2, x_3, x_4, x_5 over Rational Field
sage: macaulay2('QQ[x_0..x_100]')._sage_()
...
ValueError: variable name '------...' is not alphanumeric
```



---

archive/issue_comments_120189.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-07-17T22:20:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11217",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11217#issuecomment-120189",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_120190.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-07-17T22:28:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11217",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11217#issuecomment-120190",
    "user": "https://github.com/mwageringel"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_120191.json:
```json
{
    "body": "<a id='comment:9'></a>I solved this by implementing the method `_repr_` which is now distinct from `__str__`. Now `_repr_` wraps the Macaulay2 output in the Sage REPL, similar to how output is wrapped in the Macaulay2 REPL.\n\nIn contrast, `__str__` does not wrap the output \u2013 this way, printing a `Macaulay2Element` using `print` gives the unwrapped output, just like printing in Macaulay2 does not wrap the output.\n\n```\nsage: macaulay2.eval('print(1..25)')\n(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25)\nsage: print(macaulay2('1..25'))\n(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25)\nsage: macaulay2('1..25')\n(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22,\n--------------------------------------------------------------------------------\n23, 24, 25)\n```\n\nAside from that, I changed the way the Nets of Macaulay2 elements are converted to the string representations in Sage (in `get` and `_repr_`). Namely, I added a `print` as this avoids having to remove the prompt from the output string.\n\nI also fixed a corner case involving Macaulay2 Sequences, and changed a few doctests to be more specific in what they test (in order to avoid the clumsy output of Macaulay2 polynomial rings).",
    "created_at": "2019-07-17T22:28:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11217",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11217#issuecomment-120191",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:9'></a>I solved this by implementing the method `_repr_` which is now distinct from `__str__`. Now `_repr_` wraps the Macaulay2 output in the Sage REPL, similar to how output is wrapped in the Macaulay2 REPL.

In contrast, `__str__` does not wrap the output – this way, printing a `Macaulay2Element` using `print` gives the unwrapped output, just like printing in Macaulay2 does not wrap the output.

```
sage: macaulay2.eval('print(1..25)')
(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25)
sage: print(macaulay2('1..25'))
(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25)
sage: macaulay2('1..25')
(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22,
--------------------------------------------------------------------------------
23, 24, 25)
```

Aside from that, I changed the way the Nets of Macaulay2 elements are converted to the string representations in Sage (in `get` and `_repr_`). Namely, I added a `print` as this avoids having to remove the prompt from the output string.

I also fixed a corner case involving Macaulay2 Sequences, and changed a few doctests to be more specific in what they test (in order to avoid the clumsy output of Macaulay2 polynomial rings).



---

archive/issue_comments_120192.json:
```json
{
    "body": "<a id='comment:10'></a>looks good, works and pass the tests => positive review\n\nMaybe one should send \"sageDescribe\" to upstream ?",
    "created_at": "2019-07-18T07:58:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11217",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11217#issuecomment-120192",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:10'></a>looks good, works and pass the tests => positive review

Maybe one should send "sageDescribe" to upstream ?



---

archive/issue_comments_120193.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-07-18T07:58:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11217",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11217#issuecomment-120193",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_120194.json:
```json
{
    "body": "<a id='comment:11'></a>Thanks. I opened https://github.com/Macaulay2/M2/issues/967 about this.",
    "created_at": "2019-07-19T19:32:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11217",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11217#issuecomment-120194",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:11'></a>Thanks. I opened https://github.com/Macaulay2/M2/issues/967 about this.



---

archive/issue_comments_120195.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-07-23T21:03:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11217",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11217#issuecomment-120195",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_029054.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-07-23T21:03:56Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/11217",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11217#event-29054"
}
```
