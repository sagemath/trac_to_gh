# Issue 11752: ecl.pyx should not touch SIGPWR neither SIGXCPU when initializing ecl

archive/issues_011580.json:
```json
{
    "assignees": [],
    "body": "I experienced a problem in the Mandriva sagemath 4.7.1 that was causing sage to exit with the this\u00a0somewhat funny message:\n\nsage: from sage.interfaces.maxima_lib import maxima_lib\n\n`/usr/share/sage/local/bin/sage-sage: line 178: \u00a07177 Power failure \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 sage-ipython \"$@\" -i`\n\nThe problem is the logic in ecl.pyx that saves all signal handlers, initializes ecl and restores them, but this has the nasty side effect of messing with Boehm GC thread handling, that uses SIGXCPU and SIGPWR to stop/restart threads during gc.The attached patch corrects the problem for me, but is just a suggestion, and may need proper testing on non Linux systems, but on other systems Boehm GC should use a signal number larger than 32. Or, maybe add some comments about what those numbers are (SIGPWR = 30 and SIGXCPU = 24).\n\n---\n\nSolution turned out to be: tell ECL not to create a separate signal-handling thread (which it won't do if threads are not enabled, as in the standard Sage build of ECL).\n\n---\n\nApply only [attachment: 11752_ecl-nothread.patch.gz](https://github.com/sagemath/sage/files/ticket11752/11752_ecl-nothread.patch.gz) to the Sage library.\n\n\nAssignee: **@williamstein**\n\nAuthor: **Paulo C\u00e9sar Pereira de Andrade**\n\nReviewer: **Nils Bruin**\n\nMerged: **sage-4.7.2.alpha3**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/11752_\n\n",
    "closed_at": "2011-09-12T19:25:13Z",
    "created_at": "2011-08-27T02:13:12Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20interfaces",
        "https://github.com/sagemath/sage/labels/p4%20%E2%80%93%20minor",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-4.7.2",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "ecl.pyx should not touch SIGPWR neither SIGXCPU when initializing ecl",
    "type": "issue",
    "updated_at": "2011-09-12T19:25:13Z",
    "url": "https://github.com/sagemath/sage/issues/11752",
    "user": "https://github.com/sagetrac-pcpa"
}
```
I experienced a problem in the Mandriva sagemath 4.7.1 that was causing sage to exit with the this somewhat funny message:

sage: from sage.interfaces.maxima_lib import maxima_lib

`/usr/share/sage/local/bin/sage-sage: line 178:  7177 Power failure           sage-ipython "$@" -i`

The problem is the logic in ecl.pyx that saves all signal handlers, initializes ecl and restores them, but this has the nasty side effect of messing with Boehm GC thread handling, that uses SIGXCPU and SIGPWR to stop/restart threads during gc.The attached patch corrects the problem for me, but is just a suggestion, and may need proper testing on non Linux systems, but on other systems Boehm GC should use a signal number larger than 32. Or, maybe add some comments about what those numbers are (SIGPWR = 30 and SIGXCPU = 24).

---

Solution turned out to be: tell ECL not to create a separate signal-handling thread (which it won't do if threads are not enabled, as in the standard Sage build of ECL).

---

Apply only [attachment: 11752_ecl-nothread.patch.gz](https://github.com/sagemath/sage/files/ticket11752/11752_ecl-nothread.patch.gz) to the Sage library.


Assignee: **@williamstein**

Author: **Paulo César Pereira de Andrade**

Reviewer: **Nils Bruin**

Merged: **sage-4.7.2.alpha3**

_Issue created by migration from https://trac.sagemath.org/ticket/11752_





---

archive/issue_events_144221.json:
```json
{
    "actor": "https://github.com/sagetrac-pcpa",
    "created_at": "2011-08-27T02:13:12Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "milestone_number": null,
    "milestone_title": "sage-4.7.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11752#event-144221"
}
```



---

archive/issue_events_144222.json:
```json
{
    "actor": "https://github.com/sagetrac-pcpa",
    "created_at": "2011-08-27T02:13:12Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20interfaces",
    "label_color": "0000ff",
    "label_name": "component: interfaces",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11752#event-144222"
}
```



---

archive/issue_events_144223.json:
```json
{
    "actor": "https://github.com/sagetrac-pcpa",
    "created_at": "2011-08-27T02:13:12Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11752#event-144223"
}
```



---

archive/issue_events_144224.json:
```json
{
    "actor": "https://github.com/sagetrac-pcpa",
    "created_at": "2011-08-27T02:13:12Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11752#event-144224"
}
```



---

archive/issue_comments_124422.json:
```json
{
    "body": "<a id='comment:1'>Comment 1:</a>\nIn principle the proposed change should be OK. Restoring the 32 signal handlers was just a general approach to avoid ECL's interrupt handlers.\n\nNote however that sage's ECL and Boehm GC are normally built with threading disabled, and then they don't touch or use SIGPWR and SIGXCPU. ECL has some quite advanced features for dealing with threads, but I recall that the approach taken with signal handlers when threads are enabled is quite incompatible with sage.\n\nCurrently, to make SIGINT work in long-running ecl code, the signal handler simply gets swapped to the ecl one and swapped back to the sage one upon exit of the ecl code. This approach is obviously incompatible with multiple threads.\n\nThe approach taken in ecl, have one thread receive all asynchronous signals and let that distribute them over the other threads is a sound one, but in order to make that work in sage we would have to have such a thread in sage and make it aware of any ecl threads running.\n\nSo in practice, if the fix here is necessary you run the risk that you are running a configuration that handles signals quite poorly. You may want to test this.",
    "created_at": "2011-08-28T02:10:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11752#issuecomment-124422",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:1'>Comment 1:</a>
In principle the proposed change should be OK. Restoring the 32 signal handlers was just a general approach to avoid ECL's interrupt handlers.

Note however that sage's ECL and Boehm GC are normally built with threading disabled, and then they don't touch or use SIGPWR and SIGXCPU. ECL has some quite advanced features for dealing with threads, but I recall that the approach taken with signal handlers when threads are enabled is quite incompatible with sage.

Currently, to make SIGINT work in long-running ecl code, the signal handler simply gets swapped to the ecl one and swapped back to the sage one upon exit of the ecl code. This approach is obviously incompatible with multiple threads.

The approach taken in ecl, have one thread receive all asynchronous signals and let that distribute them over the other threads is a sound one, but in order to make that work in sage we would have to have such a thread in sage and make it aware of any ecl threads running.

So in practice, if the fix here is necessary you run the risk that you are running a configuration that handles signals quite poorly. You may want to test this.



---

archive/issue_comments_124423.json:
```json
{
    "body": "<a id='comment:2'>Comment 2:</a>\nI need to make more complete tests, but the idea is to use as much as possible from system packages in my Mandriva sagemath rpm. The patch allows sage to load the ecl/maxima module and at least the (few) doctests I run did work correctly. Patch probably can be made a one liner by just not restoring handlers after cl_boot call, and for more clarity, use proper signal names, instead of numeric value.\n\nIf truly required, I may adapt the sagemath rpm package to use an alternate ecl, Bohem GC, and possibly maxima build, but at first I am trying to avoid it.\n\nThis should at least help in knowing beforehand issues that will happen in the future if sage is linked to other binaries, multi thread or not, that uses Bohem GC, or do their own signal management.",
    "created_at": "2011-08-28T03:40:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11752#issuecomment-124423",
    "user": "https://github.com/sagetrac-pcpa"
}
```

<a id='comment:2'>Comment 2:</a>
I need to make more complete tests, but the idea is to use as much as possible from system packages in my Mandriva sagemath rpm. The patch allows sage to load the ecl/maxima module and at least the (few) doctests I run did work correctly. Patch probably can be made a one liner by just not restoring handlers after cl_boot call, and for more clarity, use proper signal names, instead of numeric value.

If truly required, I may adapt the sagemath rpm package to use an alternate ecl, Bohem GC, and possibly maxima build, but at first I am trying to avoid it.

This should at least help in knowing beforehand issues that will happen in the future if sage is linked to other binaries, multi thread or not, that uses Bohem GC, or do their own signal management.



---

archive/issue_comments_124424.json:
```json
{
    "body": "<a id='comment:3'>Comment 3:</a>\nReplying to [pcpa](#comment%3A2):\n> The patch allows sage to load the ecl/maxima module and at least the (few) doctests I run did work correctly.\n\nThis does not test asynchronous signal handling at all. The easiest way to do so is to start up a time-consuming job and send some Ctrl-C signals to the process (I don't think there are many other async signals Sage is required to handle properly).  See #10818 for some relevant tests and ideas.\n\n>Patch probably can be made a one liner by just not restoring handlers after cl_boot call, and for more clarity, use proper signal names, instead of numeric value.\n\nYou'll at least have to restore the SIGINT handler.\n\n> This should at least help in knowing beforehand issues that will happen in the future if sage is linked to other binaries, multi thread or not, that use Boehm GC, or do their own signal management.\n\nAbsolutely! This is very useful work.",
    "created_at": "2011-08-28T21:20:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11752#issuecomment-124424",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:3'>Comment 3:</a>
Replying to [pcpa](#comment%3A2):
> The patch allows sage to load the ecl/maxima module and at least the (few) doctests I run did work correctly.

This does not test asynchronous signal handling at all. The easiest way to do so is to start up a time-consuming job and send some Ctrl-C signals to the process (I don't think there are many other async signals Sage is required to handle properly).  See #10818 for some relevant tests and ideas.

>Patch probably can be made a one liner by just not restoring handlers after cl_boot call, and for more clarity, use proper signal names, instead of numeric value.

You'll at least have to restore the SIGINT handler.

> This should at least help in knowing beforehand issues that will happen in the future if sage is linked to other binaries, multi thread or not, that use Boehm GC, or do their own signal management.

Absolutely! This is very useful work.



---

archive/issue_comments_124425.json:
```json
{
    "body": "<a id='comment:4'>Comment 4:</a>\nIt appears I have it completely broken in regarding to signal handling now. The attached log session is what I found. Running simple doctests does not test this behavior indeed. In the attached session log, the <<<<<< comment >>>>>>> lines are about what I pressed or typed when the console was not echoing.",
    "created_at": "2011-08-28T23:06:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11752#issuecomment-124425",
    "user": "https://github.com/sagetrac-pcpa"
}
```

<a id='comment:4'>Comment 4:</a>
It appears I have it completely broken in regarding to signal handling now. The attached log session is what I found. Running simple doctests does not test this behavior indeed. In the attached session log, the <<<<<< comment >>>>>>> lines are about what I pressed or typed when the console was not echoing.



---

archive/issue_comments_124426.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\nJust looking at what's happening in sage-on-gentoo. We give a bit more freedom about what user can enable or not. I don't see the problem on my machine where I have boehm-gc compiled with threads but ecl without. However there was a report on bugzilla this morning of someone getting\n\n```\n$ LC_ALL=C sage\n----------------------------------------------------------------------\n| Sage Version 4.7.1, Release Date: 2011-08-11                       |\n| Type notebook() for the GUI, and license() for information.        |\n----------------------------------------------------------------------\nsage: var('i n')\n(i, n)\nsage: sum(4*i+1, i, 1, n)\n/usr/bin/sage-sage: line 230:  8666 Power failure           sage-ipython \"$@\" -i\n```\nWhich appear to me to be very similar to what you describe, I'll write again when I get more info from this user.",
    "created_at": "2011-08-29T01:59:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11752#issuecomment-124426",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:5'>Comment 5:</a>
Just looking at what's happening in sage-on-gentoo. We give a bit more freedom about what user can enable or not. I don't see the problem on my machine where I have boehm-gc compiled with threads but ecl without. However there was a report on bugzilla this morning of someone getting

```
$ LC_ALL=C sage
----------------------------------------------------------------------
| Sage Version 4.7.1, Release Date: 2011-08-11                       |
| Type notebook() for the GUI, and license() for information.        |
----------------------------------------------------------------------
sage: var('i n')
(i, n)
sage: sum(4*i+1, i, 1, n)
/usr/bin/sage-sage: line 230:  8666 Power failure           sage-ipython "$@" -i
```
Which appear to me to be very similar to what you describe, I'll write again when I get more info from this user.



---

archive/issue_comments_124427.json:
```json
{
    "body": "<a id='comment:6'>Comment 6:</a>\nSome observations:\n- the fact that you land in ECL's break-loop is indeed a sign something is broken, because we run the equivalent of a \"try ... expect\" in ecl_eval, so the interrupt should be caught and propagated up. I suspect this breaks because you are running it in a thread-enabled ECL. Perhaps the ctrl-C arrives at a different thread that is not running under such protection? There has to be a thread-aware option in ECL to change the handling of SIGINT, though. We could adjust that\n- You should exit ECL's break-loop with \":q\", not \"(quit)\". The latter terminates the ECL session, but because ECL is not running its top-level (it's embedded), it cannot really do this and hence leaves the system in an inconsistent state. So the memory corruption you are observing is probably not due to erroneous signal handling.\n\nThank you for testing this! It looks like for now we should really advise people against running ECL in thread-enabled mode inside Sage. Unfortunately, it seems enabling/disabling threads is something done at configure time, not at ECL run time.",
    "created_at": "2011-08-29T02:52:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11752#issuecomment-124427",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:6'>Comment 6:</a>
Some observations:
- the fact that you land in ECL's break-loop is indeed a sign something is broken, because we run the equivalent of a "try ... expect" in ecl_eval, so the interrupt should be caught and propagated up. I suspect this breaks because you are running it in a thread-enabled ECL. Perhaps the ctrl-C arrives at a different thread that is not running under such protection? There has to be a thread-aware option in ECL to change the handling of SIGINT, though. We could adjust that
- You should exit ECL's break-loop with ":q", not "(quit)". The latter terminates the ECL session, but because ECL is not running its top-level (it's embedded), it cannot really do this and hence leaves the system in an inconsistent state. So the memory corruption you are observing is probably not due to erroneous signal handling.

Thank you for testing this! It looks like for now we should really advise people against running ECL in thread-enabled mode inside Sage. Unfortunately, it seems enabling/disabling threads is something done at configure time, not at ECL run time.



---

archive/issue_comments_124428.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\nThere may be a boot-time option for ECL that gets around this problem. See [ECL doc](http://ecls.sourceforge.net/new-manual/re41.html). If you can set `SIGNAL_HANDLING_THREAD` to false when calling `cl_boot`, you may be able to force ECL to not set up a separate signal handling thread, even if threading is enabled. I cannot test this here because I do not have a thread-enabled ECL, but in your setup it may be easy to try out.",
    "created_at": "2011-08-29T03:13:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11752#issuecomment-124428",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:7'>Comment 7:</a>
There may be a boot-time option for ECL that gets around this problem. See [ECL doc](http://ecls.sourceforge.net/new-manual/re41.html). If you can set `SIGNAL_HANDLING_THREAD` to false when calling `cl_boot`, you may be able to force ECL to not set up a separate signal handling thread, even if threading is enabled. I cannot test this here because I do not have a thread-enabled ECL, but in your setup it may be easy to try out.



---

archive/issue_comments_124429.json:
```json
{
    "body": "<a id='comment:8'>Comment 8:</a>\nReplying to [@nbruin](#comment%3A7):\n\n> There may be a boot-time option for ECL that gets around this problem. See [ECL doc](http://ecls.sourceforge.net/new-manual/re41.html). If you can set `SIGNAL_HANDLING_THREAD` to false when calling `cl_boot`, you may be able to force ECL to not set up a separate signal handling thread, even if threading is enabled. I cannot test this here because I do not have a thread-enabled ECL, but in your setup it may be easy to try out.\n\nThanks! This indeed appears to correct the problem.\n\n[Updating patch and simple session log attachments next]",
    "created_at": "2011-08-29T03:42:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11752#issuecomment-124429",
    "user": "https://github.com/sagetrac-pcpa"
}
```

<a id='comment:8'>Comment 8:</a>
Replying to [@nbruin](#comment%3A7):

> There may be a boot-time option for ECL that gets around this problem. See [ECL doc](http://ecls.sourceforge.net/new-manual/re41.html). If you can set `SIGNAL_HANDLING_THREAD` to false when calling `cl_boot`, you may be able to force ECL to not set up a separate signal handling thread, even if threading is enabled. I cannot test this here because I do not have a thread-enabled ECL, but in your setup it may be easy to try out.

Thanks! This indeed appears to correct the problem.

[Updating patch and simple session log attachments next]



---

archive/issue_comments_124430.json:
```json
{
    "body": "Attachment: **[ecl-log.txt](https://github.com/sagemath/sage/files/ticket11752/ecl-log.txt)**\n\necl-log.txt",
    "created_at": "2011-08-29T03:45:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11752#issuecomment-124430",
    "user": "https://github.com/sagetrac-pcpa"
}
```

Attachment: **[ecl-log.txt](https://github.com/sagemath/sage/files/ticket11752/ecl-log.txt)**

ecl-log.txt



---

archive/issue_comments_124431.json:
```json
{
    "body": "<a id='comment:9'>Comment 9:</a>\nReplying to [pcpa](#comment%3A8):\n\n> Thanks! This indeed appears to correct the problem.\n\nWonderful. The `ecl_set_option(ECL_OPT_SIGNAL_HANDLING_THREAD, 0)` is completely uncontroversial. There is a remote possibility that specifying this option might be enough to dissuade Boehm GC from using SIGPWR etc. Given that this fixes something that shouldn't occur in standard Sage configurations, such a minimal fix would be preferable. If that's enough, I can give your amended patch a positive review right away.\n\nIf it doesn't, I think SIGPWR and SIGXCPU are such exotic signals (and Sage doesn't do anything special with them anyway) that I think it should be acceptable to relinquish them to ECLs handlers. You could add them to `cdef extern int SIGINT, SIGBUS, SIGSEGV` (line 48 in ecl.pyx) to refer to them by name.\n\nIf they do need to be given to ecl, they probably need treatment in `ecl_sig_on` and `ecl_sig_off` as well. That doesn't make it thread-safe yet (imagine 2 sage threads, one of which executing ECL code that triggers a GC. What's the other thread going to do with the SIGPWR?). Perhaps jdemeyer can give some advice what to do in that case.",
    "created_at": "2011-08-29T05:35:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11752#issuecomment-124431",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:9'>Comment 9:</a>
Replying to [pcpa](#comment%3A8):

> Thanks! This indeed appears to correct the problem.

Wonderful. The `ecl_set_option(ECL_OPT_SIGNAL_HANDLING_THREAD, 0)` is completely uncontroversial. There is a remote possibility that specifying this option might be enough to dissuade Boehm GC from using SIGPWR etc. Given that this fixes something that shouldn't occur in standard Sage configurations, such a minimal fix would be preferable. If that's enough, I can give your amended patch a positive review right away.

If it doesn't, I think SIGPWR and SIGXCPU are such exotic signals (and Sage doesn't do anything special with them anyway) that I think it should be acceptable to relinquish them to ECLs handlers. You could add them to `cdef extern int SIGINT, SIGBUS, SIGSEGV` (line 48 in ecl.pyx) to refer to them by name.

If they do need to be given to ecl, they probably need treatment in `ecl_sig_on` and `ecl_sig_off` as well. That doesn't make it thread-safe yet (imagine 2 sage threads, one of which executing ECL code that triggers a GC. What's the other thread going to do with the SIGPWR?). Perhaps jdemeyer can give some advice what to do in that case.



---

archive/issue_comments_124432.json:
```json
{
    "body": "<a id='comment:10'>Comment 10:</a>\nI just did a build of ecl.so without patching the code to save/restore signal handlers and it does still work, so, it is only required the call to `ecl_set_option()`. As long as there is only one thread, it should be ok, as Bohem GC for sure will not pthread_kill(pthread_self(), SIG{PWR,XCPU}), and one should not inject whatever code is required to create a thread in `ecl_eval()`.\n\nOnly testing to see what would happen with multiple threads, what would be desirable would be to have \"a single Bohem GC instance\". In one quick test I did, it failed miserably, that was to link libcsage.so to -lpthread, do a `s/sigprocmask/pthread_sigmask/` including gc.h and calling `GC_init()` before setting signal handles in interrupt.c. It did print some weird messages rooted in the `cl_boot()` call and crashed.\n\nUpdating again the patch, that now is only the ecl_set_option call, and sync to missing ECL_OPT values.",
    "created_at": "2011-08-29T06:28:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11752#issuecomment-124432",
    "user": "https://github.com/sagetrac-pcpa"
}
```

<a id='comment:10'>Comment 10:</a>
I just did a build of ecl.so without patching the code to save/restore signal handlers and it does still work, so, it is only required the call to `ecl_set_option()`. As long as there is only one thread, it should be ok, as Bohem GC for sure will not pthread_kill(pthread_self(), SIG{PWR,XCPU}), and one should not inject whatever code is required to create a thread in `ecl_eval()`.

Only testing to see what would happen with multiple threads, what would be desirable would be to have "a single Bohem GC instance". In one quick test I did, it failed miserably, that was to link libcsage.so to -lpthread, do a `s/sigprocmask/pthread_sigmask/` including gc.h and calling `GC_init()` before setting signal handles in interrupt.c. It did print some weird messages rooted in the `cl_boot()` call and crashed.

Updating again the patch, that now is only the ecl_set_option call, and sync to missing ECL_OPT values.



---

archive/issue_events_144225.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2011-08-29T06:38:04Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11752#event-144225"
}
```



---

archive/issue_events_144226.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2011-08-29T06:38:04Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "label": "https://github.com/sagemath/sage/labels/p4%20%E2%80%93%20minor",
    "label_color": "ffe799",
    "label_name": "p4 \u2013 minor",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11752#event-144226"
}
```



---

archive/issue_events_144227.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2011-08-29T06:38:04Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11752#event-144227"
}
```



---

archive/issue_comments_124433.json:
```json
{
    "body": "Author: **Paulo C\u00e9sar Pereira de Andrade**",
    "created_at": "2011-08-29T06:38:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11752#issuecomment-124433",
    "user": "https://github.com/nbruin"
}
```

Author: **Paulo César Pereira de Andrade**



---

archive/issue_comments_124434.json:
```json
{
    "body": "Reviewer: **Nils Bruin**",
    "created_at": "2011-08-29T06:38:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11752#issuecomment-124434",
    "user": "https://github.com/nbruin"
}
```

Reviewer: **Nils Bruin**



---

archive/issue_events_144228.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2011-08-29T06:41:29Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11752#event-144228"
}
```



---

archive/issue_events_144229.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2011-08-29T06:41:29Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11752#event-144229"
}
```



---

archive/issue_comments_124435.json:
```json
{
    "body": "<a id='comment:12'>Comment 12:</a>\nThe attached patch fixes something for non-standard Sage configurations. The change cannot possibly affect standard sage configurations negatively because we really do not want a separate signal handling thread in ECL (that messes thing up in exactly the way the author was observing). So: positive review from me.\n\nThanks to Paulo for tracking this down.",
    "created_at": "2011-08-29T06:41:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11752#issuecomment-124435",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:12'>Comment 12:</a>
The attached patch fixes something for non-standard Sage configurations. The change cannot possibly affect standard sage configurations negatively because we really do not want a separate signal handling thread in ECL (that messes thing up in exactly the way the author was observing). So: positive review from me.

Thanks to Paulo for tracking this down.



---

archive/issue_events_144230.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2011-08-29T06:52:41Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11752#event-144230"
}
```



---

archive/issue_events_144231.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2011-08-29T06:52:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11752#event-144231"
}
```



---

archive/issue_comments_124436.json:
```json
{
    "body": "<a id='comment:13'>Comment 13:</a>\nOuch, sorry. I tried\n\n```\n> sage -sh\n> cd $SAGE_ROOT/devel/sage/sage\n> hg qimport <patch file>\n> hg qpush\n```\nand I get failures:\n\n```\napplying sage-4.7.1-ecl_module.patch\nunable to find 'spkg/build/sage-4.7.1/sage/libs/ecl.pxd' for patching\n1 out of 1 hunks FAILED -- saving rejects to file spkg/build/sage-4.7.1/sage/libs/ecl.pxd.rej\nunable to find 'spkg/build/sage-4.7.1/sage/libs/ecl.pyx' for patching\n1 out of 1 hunks FAILED -- saving rejects to file spkg/build/sage-4.7.1/sage/libs/ecl.pyx.rej\npatch failed, unable to continue (try -v)\npatch failed, rejects left in working dir\nerrors during apply, please fix and refresh sage-4.7.1-ecl_module.patch\n```\nIt looks like the patch file isn't formatted properly! Can you follow the sage instructions for creating a patch file that applies cleanly to the distribution? The proposed change is fine, but we have to make sure the patch file is formatted so that the distribution manager can easily apply it.\n\nWhile you're at it, also make sure to include a meaningful commit message mentioning #11752.",
    "created_at": "2011-08-29T06:52:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11752#issuecomment-124436",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:13'>Comment 13:</a>
Ouch, sorry. I tried

```
> sage -sh
> cd $SAGE_ROOT/devel/sage/sage
> hg qimport <patch file>
> hg qpush
```
and I get failures:

```
applying sage-4.7.1-ecl_module.patch
unable to find 'spkg/build/sage-4.7.1/sage/libs/ecl.pxd' for patching
1 out of 1 hunks FAILED -- saving rejects to file spkg/build/sage-4.7.1/sage/libs/ecl.pxd.rej
unable to find 'spkg/build/sage-4.7.1/sage/libs/ecl.pyx' for patching
1 out of 1 hunks FAILED -- saving rejects to file spkg/build/sage-4.7.1/sage/libs/ecl.pyx.rej
patch failed, unable to continue (try -v)
patch failed, rejects left in working dir
errors during apply, please fix and refresh sage-4.7.1-ecl_module.patch
```
It looks like the patch file isn't formatted properly! Can you follow the sage instructions for creating a patch file that applies cleanly to the distribution? The proposed change is fine, but we have to make sure the patch file is formatted so that the distribution manager can easily apply it.

While you're at it, also make sure to include a meaningful commit message mentioning #11752.



---

archive/issue_comments_124437.json:
```json
{
    "body": "<a id='comment:14'>Comment 14:</a>\nSorry, the patch is \u00a0formatted for the procedure I use to rpmbuild sagemath. I am not much used to mercurial... Based on log, it should be something like \"hg import -p4 sage-4.7.1-ecl_module.patch\".\n\nI will edit the patch to look like patches from raw mode view of commits to hg.sagemath.org, and add a description to the \"patch header\".",
    "created_at": "2011-08-29T08:25:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11752#issuecomment-124437",
    "user": "https://github.com/sagetrac-pcpa"
}
```

<a id='comment:14'>Comment 14:</a>
Sorry, the patch is  formatted for the procedure I use to rpmbuild sagemath. I am not much used to mercurial... Based on log, it should be something like "hg import -p4 sage-4.7.1-ecl_module.patch".

I will edit the patch to look like patches from raw mode view of commits to hg.sagemath.org, and add a description to the "patch header".



---

archive/issue_comments_124438.json:
```json
{
    "body": "sage-4.7.1-ecl_module.patch",
    "created_at": "2011-08-29T08:26:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11752#issuecomment-124438",
    "user": "https://github.com/sagetrac-pcpa"
}
```

sage-4.7.1-ecl_module.patch



---

archive/issue_comments_124439.json:
```json
{
    "body": "Attachment: **[sage-4.7.1-ecl_module.patch.gz](https://github.com/sagemath/sage/files/ticket11752/sage-4.7.1-ecl_module.patch.gz)**\n\nSet an option for ecl's cl_boot",
    "created_at": "2011-08-29T16:02:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11752#issuecomment-124439",
    "user": "https://github.com/nbruin"
}
```

Attachment: **[sage-4.7.1-ecl_module.patch.gz](https://github.com/sagemath/sage/files/ticket11752/sage-4.7.1-ecl_module.patch.gz)**

Set an option for ecl's cl_boot



---

archive/issue_events_144232.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2011-08-29T16:04:41Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11752#event-144232"
}
```



---

archive/issue_events_144233.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2011-08-29T16:04:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11752#event-144233"
}
```



---

archive/issue_comments_124440.json:
```json
{
    "body": "<a id='comment:15'>Comment 15:</a>\nAttachment: **[11752_ecl-nothread.patch.gz](https://github.com/sagemath/sage/files/ticket11752/11752_ecl-nothread.patch.gz)**\n\nThanks! Patch applied but it still didn't quite look like a \"mercurial\" patch (things like date and author missing) so I reexported the patch with \"hg export qtip\". I hope this patch is OK.",
    "created_at": "2011-08-29T16:04:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11752#issuecomment-124440",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:15'>Comment 15:</a>
Attachment: **[11752_ecl-nothread.patch.gz](https://github.com/sagemath/sage/files/ticket11752/11752_ecl-nothread.patch.gz)**

Thanks! Patch applied but it still didn't quite look like a "mercurial" patch (things like date and author missing) so I reexported the patch with "hg export qtip". I hope this patch is OK.



---

archive/issue_comments_124441.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -2,4 +2,12 @@\n \n sage: from sage.interfaces.maxima_lib import maxima_lib\n \n-`/usr/share/sage/local/bin/sage-sage: line 178: \u00a07177 Power failure \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 sage-ipython \"$@\" -iThe problem is the logic in ecl.pyx that saves all signal handlers, initializes ecl and restores them, but this has the nasty side effect of messing with Boehm GC thread handling, that uses SIGXCPU and SIGPWR to stop/restart threads during gc.The attached patch corrects the problem for me, but is just a suggestion, and may need proper testing on non Linux systems, but on other systems Boehm GC should use a signal number larger than 32. Or, maybe add some comments about what those numbers are (SIGPWR = 30 and SIGXCPU = 24).`\n+`/usr/share/sage/local/bin/sage-sage: line 178: \u00a07177 Power failure \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 sage-ipython \"$@\" -i`\n+\n+The problem is the logic in ecl.pyx that saves all signal handlers, initializes ecl and restores them, but this has the nasty side effect of messing with Boehm GC thread handling, that uses SIGXCPU and SIGPWR to stop/restart threads during gc.The attached patch corrects the problem for me, but is just a suggestion, and may need proper testing on non Linux systems, but on other systems Boehm GC should use a signal number larger than 32. Or, maybe add some comments about what those numbers are (SIGPWR = 30 and SIGXCPU = 24).\n+\n+---\n+\n+Solution turned out to be: tell ECL not to create a separate signal-handling thread (which it won't do if threads are not enabled, as in the standard Sage build of ECL).\n+\n+Apply 11752_ecl-nothread.patch\n``````\n",
    "created_at": "2011-08-29T16:08:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11752#issuecomment-124441",
    "user": "https://github.com/nbruin"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -2,4 +2,12 @@
 
 sage: from sage.interfaces.maxima_lib import maxima_lib
 
-`/usr/share/sage/local/bin/sage-sage: line 178:  7177 Power failure           sage-ipython "$@" -iThe problem is the logic in ecl.pyx that saves all signal handlers, initializes ecl and restores them, but this has the nasty side effect of messing with Boehm GC thread handling, that uses SIGXCPU and SIGPWR to stop/restart threads during gc.The attached patch corrects the problem for me, but is just a suggestion, and may need proper testing on non Linux systems, but on other systems Boehm GC should use a signal number larger than 32. Or, maybe add some comments about what those numbers are (SIGPWR = 30 and SIGXCPU = 24).`
+`/usr/share/sage/local/bin/sage-sage: line 178:  7177 Power failure           sage-ipython "$@" -i`
+
+The problem is the logic in ecl.pyx that saves all signal handlers, initializes ecl and restores them, but this has the nasty side effect of messing with Boehm GC thread handling, that uses SIGXCPU and SIGPWR to stop/restart threads during gc.The attached patch corrects the problem for me, but is just a suggestion, and may need proper testing on non Linux systems, but on other systems Boehm GC should use a signal number larger than 32. Or, maybe add some comments about what those numbers are (SIGPWR = 30 and SIGXCPU = 24).
+
+---
+
+Solution turned out to be: tell ECL not to create a separate signal-handling thread (which it won't do if threads are not enabled, as in the standard Sage build of ECL).
+
+Apply 11752_ecl-nothread.patch
``````




---

archive/issue_comments_124442.json:
```json
{
    "body": "<a id='comment:17'>Comment 17:</a>\nLooks good to me too. Hopefully it will go in the next alpha.",
    "created_at": "2011-08-29T19:32:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11752#issuecomment-124442",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:17'>Comment 17:</a>
Looks good to me too. Hopefully it will go in the next alpha.



---

archive/issue_comments_124443.json:
```json
{
    "body": "<a id='comment:18'>Comment 18:</a>\nPlease use proper URLs (in this case to the raw attachment) or trac wiki mark-up (\"`[attachment: here_comes_the_filename.gz](https://github.com/sagemath/sage/files/ticket11752/here_comes_the_filename.gz)`\") when referring to patches (or spkgs) in the description.\n\nAlso, an attachment comment *\"Apply only this patch.\"* can make life easier.",
    "created_at": "2011-09-08T10:02:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11752#issuecomment-124443",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:18'>Comment 18:</a>
Please use proper URLs (in this case to the raw attachment) or trac wiki mark-up ("`[attachment: here_comes_the_filename.gz](https://github.com/sagemath/sage/files/ticket11752/here_comes_the_filename.gz)`") when referring to patches (or spkgs) in the description.

Also, an attachment comment *"Apply only this patch."* can make life easier.



---

archive/issue_comments_124444.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -10,4 +10,7 @@\n \n Solution turned out to be: tell ECL not to create a separate signal-handling thread (which it won't do if threads are not enabled, as in the standard Sage build of ECL).\n \n-Apply 11752_ecl-nothread.patch\n+---\n+\n+Apply only [attachment: 11752_ecl-nothread.patch.gz](https://github.com/sagemath/sage/files/ticket11752/11752_ecl-nothread.patch.gz) to the Sage library.\n+\n``````\n",
    "created_at": "2011-09-08T10:02:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11752#issuecomment-124444",
    "user": "https://github.com/nexttime"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -10,4 +10,7 @@
 
 Solution turned out to be: tell ECL not to create a separate signal-handling thread (which it won't do if threads are not enabled, as in the standard Sage build of ECL).
 
-Apply 11752_ecl-nothread.patch
+---
+
+Apply only [attachment: 11752_ecl-nothread.patch.gz](https://github.com/sagemath/sage/files/ticket11752/11752_ecl-nothread.patch.gz) to the Sage library.
+
``````




---

archive/issue_events_144234.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2011-09-12T19:25:13Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11752#event-144234"
}
```



---

archive/issue_events_144235.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2011-09-12T19:25:13Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11752#event-144235"
}
```



---

archive/issue_comments_124445.json:
```json
{
    "body": "Merged: **sage-4.7.2.alpha3**",
    "created_at": "2011-09-12T19:25:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11752#issuecomment-124445",
    "user": "https://github.com/nexttime"
}
```

Merged: **sage-4.7.2.alpha3**
