# Issue 11514: Race condition in matplotlib mkdir()

archive/issues_011514.json:
```json
{
    "body": "Assignee: tbd\n\nCC:  @jhpalmieri @jasongrout\n\nKeywords: MPL Errno 17 libpng\n\nI regularly see this error when testing on the buildbot:\n\n```\nsage -t -long  -force_lib devel/sage/doc/de/tutorial/tour_functions.rst\n**********************************************************************\nFile \"/Users/buildbot/build/sage/bsd-1/bsd_64_upgrade/build/sage-4.5.3-4.7.1/devel/sage-main/doc/de/tutorial/tour_functions.rst\", line 24:\n    sage: plot(f, 0, 2)\nException raised:\n    Traceback (most recent call last):\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_upgrade/build/sage-4.5.3-4.7.1/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_upgrade/build/sage-4.5.3-4.7.1/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_upgrade/build/sage-4.5.3-4.7.1/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_0[5]>\", line 1, in <module>\n        plot(f, Integer(0), Integer(2))###line 24:\n    sage: plot(f, 0, 2)\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_upgrade/build/sage-4.5.3-4.7.1/local/lib/python/site-packages/sage/misc/displayhook.py\", line 174, in displayhook\n        print_obj(sys.stdout, obj)\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_upgrade/build/sage-4.5.3-4.7.1/local/lib/python/site-packages/sage/misc/displayhook.py\", line 142, in print_obj\n        print >>out_stream, `obj`\n      File \"sage_object.pyx\", line 154, in sage.structure.sage_object.SageObject.__repr__ (sage/structure/sage_object.c:1463)\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_upgrade/build/sage-4.5.3-4.7.1/local/lib/python/site-packages/sage/plot/plot.py\", line 1081, in _repr_\n        self.show()\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_upgrade/build/sage-4.5.3-4.7.1/local/lib/python/site-packages/sage/misc/decorators.py\", line 426, in wrapper\n        return func(*args, **kwds)\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_upgrade/build/sage-4.5.3-4.7.1/local/lib/python/site-packages/sage/plot/plot.py\", line 1723, in show\n        self.save(DOCTEST_MODE_FILE, **kwds)\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_upgrade/build/sage-4.5.3-4.7.1/local/lib/python/site-packages/sage/misc/decorators.py\", line 426, in wrapper\n        return func(*args, **kwds)\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_upgrade/build/sage-4.5.3-4.7.1/local/lib/python/site-packages/sage/plot/plot.py\", line 2453, in save\n        figure = self.matplotlib(**options)\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_upgrade/build/sage-4.5.3-4.7.1/local/lib/python/site-packages/sage/plot/plot.py\", line 1930, in matplotlib\n        from matplotlib.figure import Figure, figaspect\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_upgrade/build/sage-4.5.3-4.7.1/local/lib/python/site-packages/matplotlib/figure.py\", line 18, in <module>\n        from axes import Axes, SubplotBase, subplot_class_factory\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_upgrade/build/sage-4.5.3-4.7.1/local/lib/python/site-packages/matplotlib/axes.py\", line 18, in <module>\n        import matplotlib.contour as mcontour\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_upgrade/build/sage-4.5.3-4.7.1/local/lib/python/site-packages/matplotlib/contour.py\", line 21, in <module>\n        import matplotlib.texmanager as texmanager\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_upgrade/build/sage-4.5.3-4.7.1/local/lib/python/site-packages/matplotlib/texmanager.py\", line 72, in <module>\n        class TexManager:\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_upgrade/build/sage-4.5.3-4.7.1/local/lib/python/site-packages/matplotlib/texmanager.py\", line 92, in TexManager\n        os.mkdir(texcache)\n    OSError: [Errno 17] File exists: '/tmp/dot_sage.WboXjWq0ow/matplotlib-1.0.1/tex.cache'\n```\n\nThe problem looks to be the following race condition in the matplotlib code:\n\n```\n    if not os.path.exists(texcache):\n        os.mkdir(texcache)\n```\n\n---\n\nNew spkg available at\n\n[http://sage.math.washington.edu/home/palmieri/SPKG/matplotlib-1.0.1.p0.spkg](http://sage.math.washington.edu/home/palmieri/SPKG/matplotlib-1.0.1.p0.spkg)\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/11686\n\n",
    "closed_at": "2011-08-18T22:05:31Z",
    "created_at": "2011-08-13T08:22:10Z",
    "labels": [
        "component: packages: standard",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.7.2",
    "title": "Race condition in matplotlib mkdir()",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11514",
    "user": "https://github.com/jdemeyer"
}
```
Assignee: tbd

CC:  @jhpalmieri @jasongrout

Keywords: MPL Errno 17 libpng

I regularly see this error when testing on the buildbot:

```
sage -t -long  -force_lib devel/sage/doc/de/tutorial/tour_functions.rst
**********************************************************************
File "/Users/buildbot/build/sage/bsd-1/bsd_64_upgrade/build/sage-4.5.3-4.7.1/devel/sage-main/doc/de/tutorial/tour_functions.rst", line 24:
    sage: plot(f, 0, 2)
Exception raised:
    Traceback (most recent call last):
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_upgrade/build/sage-4.5.3-4.7.1/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_upgrade/build/sage-4.5.3-4.7.1/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_upgrade/build/sage-4.5.3-4.7.1/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_0[5]>", line 1, in <module>
        plot(f, Integer(0), Integer(2))###line 24:
    sage: plot(f, 0, 2)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_upgrade/build/sage-4.5.3-4.7.1/local/lib/python/site-packages/sage/misc/displayhook.py", line 174, in displayhook
        print_obj(sys.stdout, obj)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_upgrade/build/sage-4.5.3-4.7.1/local/lib/python/site-packages/sage/misc/displayhook.py", line 142, in print_obj
        print >>out_stream, `obj`
      File "sage_object.pyx", line 154, in sage.structure.sage_object.SageObject.__repr__ (sage/structure/sage_object.c:1463)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_upgrade/build/sage-4.5.3-4.7.1/local/lib/python/site-packages/sage/plot/plot.py", line 1081, in _repr_
        self.show()
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_upgrade/build/sage-4.5.3-4.7.1/local/lib/python/site-packages/sage/misc/decorators.py", line 426, in wrapper
        return func(*args, **kwds)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_upgrade/build/sage-4.5.3-4.7.1/local/lib/python/site-packages/sage/plot/plot.py", line 1723, in show
        self.save(DOCTEST_MODE_FILE, **kwds)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_upgrade/build/sage-4.5.3-4.7.1/local/lib/python/site-packages/sage/misc/decorators.py", line 426, in wrapper
        return func(*args, **kwds)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_upgrade/build/sage-4.5.3-4.7.1/local/lib/python/site-packages/sage/plot/plot.py", line 2453, in save
        figure = self.matplotlib(**options)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_upgrade/build/sage-4.5.3-4.7.1/local/lib/python/site-packages/sage/plot/plot.py", line 1930, in matplotlib
        from matplotlib.figure import Figure, figaspect
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_upgrade/build/sage-4.5.3-4.7.1/local/lib/python/site-packages/matplotlib/figure.py", line 18, in <module>
        from axes import Axes, SubplotBase, subplot_class_factory
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_upgrade/build/sage-4.5.3-4.7.1/local/lib/python/site-packages/matplotlib/axes.py", line 18, in <module>
        import matplotlib.contour as mcontour
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_upgrade/build/sage-4.5.3-4.7.1/local/lib/python/site-packages/matplotlib/contour.py", line 21, in <module>
        import matplotlib.texmanager as texmanager
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_upgrade/build/sage-4.5.3-4.7.1/local/lib/python/site-packages/matplotlib/texmanager.py", line 72, in <module>
        class TexManager:
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_upgrade/build/sage-4.5.3-4.7.1/local/lib/python/site-packages/matplotlib/texmanager.py", line 92, in TexManager
        os.mkdir(texcache)
    OSError: [Errno 17] File exists: '/tmp/dot_sage.WboXjWq0ow/matplotlib-1.0.1/tex.cache'
```

The problem looks to be the following race condition in the matplotlib code:

```
    if not os.path.exists(texcache):
        os.mkdir(texcache)
```

---

New spkg available at

[http://sage.math.washington.edu/home/palmieri/SPKG/matplotlib-1.0.1.p0.spkg](http://sage.math.washington.edu/home/palmieri/SPKG/matplotlib-1.0.1.p0.spkg)


Issue created by migration from https://trac.sagemath.org/ticket/11686





---

archive/issue_comments_128817.json:
```json
{
    "body": "Seen this before (i.e., similar), haven't we?",
    "created_at": "2011-08-13T13:55:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128817",
    "user": "https://github.com/nexttime"
}
```

Seen this before (i.e., similar), haven't we?



---

archive/issue_comments_128818.json:
```json
{
    "body": "Looks like the same issue (with the same fix) as in #10159.  I reported this to the [matplotlib mailing list](http://sourceforge.net/mailarchive/forum.php?thread_name=AANLkTim37KAOL6u6jn6pahZQrnBM0DGXpoTHdmHJ600Y%40mail.gmail.com&forum_name=matplotlib-devel) in October 2010, but no response.\n\nIn fact, what happened to the patches from #10159 which dealt with this issue?  Leif has noted on #10588 that those patches seem to have been lost in the update to version 1.0.1...",
    "created_at": "2011-08-13T15:21:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128818",
    "user": "https://github.com/jhpalmieri"
}
```

Looks like the same issue (with the same fix) as in #10159.  I reported this to the [matplotlib mailing list](http://sourceforge.net/mailarchive/forum.php?thread_name=AANLkTim37KAOL6u6jn6pahZQrnBM0DGXpoTHdmHJ600Y%40mail.gmail.com&forum_name=matplotlib-devel) in October 2010, but no response.

In fact, what happened to the patches from #10159 which dealt with this issue?  Leif has noted on #10588 that those patches seem to have been lost in the update to version 1.0.1...



---

archive/issue_comments_128819.json:
```json
{
    "body": "Replying to [comment:1 leif]:\n> Seen this before (i.e., similar), haven't we?\n\n\nThis is a regression introduced by #10588, previously fixed in John's spkg from #10159, because the spkg of the former had not been based on the latter (and the bug hasn't [yet] been fixed upstream, at least not in 1.0.1).\n \nAlso, the current spkg is full of crap in `src/build/`. (The whole directory can be deleted.)",
    "created_at": "2011-08-13T15:45:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128819",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:1 leif]:
> Seen this before (i.e., similar), haven't we?


This is a regression introduced by #10588, previously fixed in John's spkg from #10159, because the spkg of the former had not been based on the latter (and the bug hasn't [yet] been fixed upstream, at least not in 1.0.1).
 
Also, the current spkg is full of crap in `src/build/`. (The whole directory can be deleted.)



---

archive/issue_comments_128820.json:
```json
{
    "body": "Replying to [comment:2 jhpalmieri]:\n> In fact, what happened to the patches from #10159 which dealt with this issue?  Leif has noted on #10588 that those patches seem to have been lost in the update to version 1.0.1...\n\n\nIt's different to what I first thought; see my previous comment... ;-)\n\nWith a bit of luck your patches from #10159 still apply seamlessly to the current upstream version; haven't tested that yet.",
    "created_at": "2011-08-13T15:52:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128820",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:2 jhpalmieri]:
> In fact, what happened to the patches from #10159 which dealt with this issue?  Leif has noted on #10588 that those patches seem to have been lost in the update to version 1.0.1...


It's different to what I first thought; see my previous comment... ;-)

With a bit of luck your patches from #10159 still apply seamlessly to the current upstream version; haven't tested that yet.



---

archive/issue_comments_128821.json:
```json
{
    "body": "Just checked: John's 1.0.0.p0 spkg has been in Sage 4.6.1 and 4.6.2.alpha0, then the one from #10588 got merged into Sage 4.6.2.alpha1.",
    "created_at": "2011-08-13T16:00:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128821",
    "user": "https://github.com/nexttime"
}
```

Just checked: John's 1.0.0.p0 spkg has been in Sage 4.6.1 and 4.6.2.alpha0, then the one from #10588 got merged into Sage 4.6.2.alpha1.



---

archive/issue_comments_128822.json:
```json
{
    "body": "Replying to [comment:4 leif]:\n> With a bit of luck your patches from #10159 still apply seamlessly to the current upstream version; haven't tested that yet.\n\n\nHmmm, a little work has to be done:\n\n```sh\n~/Sage/spkgs/matplotlib-1.0.1.p1/patches$ patch __init__.py < __init__.py.patch \npatching file __init__.py\nHunk #1 succeeded at 103 with fuzz 2.\n~/Sage/spkgs/matplotlib-1.0.1.p1/patches$ patch finance.py < finance.py.patch \npatching file finance.py\nHunk #1 FAILED at 4.\nHunk #2 succeeded at 173 (offset 4 lines).\n1 out of 2 hunks FAILED -- saving rejects to file finance.py.rej\n~/Sage/spkgs/matplotlib-1.0.1.p1/patches$ patch texmanager.py < texmanager.py.patch \npatching file texmanager.py\n$\n```\n\nJohn, are you going to do this?",
    "created_at": "2011-08-13T16:13:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128822",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:4 leif]:
> With a bit of luck your patches from #10159 still apply seamlessly to the current upstream version; haven't tested that yet.


Hmmm, a little work has to be done:

```sh
~/Sage/spkgs/matplotlib-1.0.1.p1/patches$ patch __init__.py < __init__.py.patch 
patching file __init__.py
Hunk #1 succeeded at 103 with fuzz 2.
~/Sage/spkgs/matplotlib-1.0.1.p1/patches$ patch finance.py < finance.py.patch 
patching file finance.py
Hunk #1 FAILED at 4.
Hunk #2 succeeded at 173 (offset 4 lines).
1 out of 2 hunks FAILED -- saving rejects to file finance.py.rej
~/Sage/spkgs/matplotlib-1.0.1.p1/patches$ patch texmanager.py < texmanager.py.patch 
patching file texmanager.py
$
```

John, are you going to do this?



---

archive/issue_comments_128823.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-08-13T16:36:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128823",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_128824.json:
```json
{
    "body": "I've created a new spkg, link in the ticket description. I'm posting the diff here for review purposes.",
    "created_at": "2011-08-13T16:36:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128824",
    "user": "https://github.com/jhpalmieri"
}
```

I've created a new spkg, link in the ticket description. I'm posting the diff here for review purposes.



---

archive/issue_comments_128825.json:
```json
{
    "body": "(I also deleted `src/build` and a few random `.pyc` files.)",
    "created_at": "2011-08-13T16:39:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128825",
    "user": "https://github.com/jhpalmieri"
}
```

(I also deleted `src/build` and a few random `.pyc` files.)



---

archive/issue_comments_128826.json:
```json
{
    "body": "(Actually, I didn't delete 'src/build', I just dropped in a freshly downloaded vanilla source as the 'src' directory, in case the previous version was corrupted in other ways than just the presence of 'build'.)",
    "created_at": "2011-08-13T16:45:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128826",
    "user": "https://github.com/jhpalmieri"
}
```

(Actually, I didn't delete 'src/build', I just dropped in a freshly downloaded vanilla source as the 'src' directory, in case the previous version was corrupted in other ways than just the presence of 'build'.)



---

archive/issue_comments_128827.json:
```json
{
    "body": "Replying to [comment:9 jhpalmieri]:\n> (Actually, I didn't delete 'src/build', I just dropped in a freshly downloaded vanilla source as the 'src' directory, in case the previous version was corrupted in other ways than just the presence of 'build'.)\n\n\nYep, the upstream sources of Ryan's and your spkg differ:\n\nHundreds of instances of\n\n```diff\ndiff -r matplotlib-1.0.1/src/lib/pytz/tzfile.py matplotlib-1.0.1.p0/src/lib/pytz/tzfile.py\n1c1\n< #!/usr/bin/env python2\n---\n> #!/usr/bin/env python\n```\nand also\n\n```diff\ndiff -r matplotlib-1.0.1/src/setup.py matplotlib-1.0.1.p0/src/setup.py\n21c21\n< rc = dict({'backend':'GTKAgg', 'numerix':'numpy'})\n---\n> rc = {'backend':'Agg'}\nOnly in matplotlib-1.0.1/src/: setupext.pyc\nOnly in matplotlib-1.0.1.p0/src/src: backend_agg.cpp\nOnly in matplotlib-1.0.1.p0/src/src: backend_gdk.c\nOnly in matplotlib-1.0.1.p0/src/src: image.cpp\nOnly in matplotlib-1.0.1.p0/src/src: path.cpp\n```",
    "created_at": "2011-08-13T17:25:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128827",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:9 jhpalmieri]:
> (Actually, I didn't delete 'src/build', I just dropped in a freshly downloaded vanilla source as the 'src' directory, in case the previous version was corrupted in other ways than just the presence of 'build'.)


Yep, the upstream sources of Ryan's and your spkg differ:

Hundreds of instances of

```diff
diff -r matplotlib-1.0.1/src/lib/pytz/tzfile.py matplotlib-1.0.1.p0/src/lib/pytz/tzfile.py
1c1
< #!/usr/bin/env python2
---
> #!/usr/bin/env python
```
and also

```diff
diff -r matplotlib-1.0.1/src/setup.py matplotlib-1.0.1.p0/src/setup.py
21c21
< rc = dict({'backend':'GTKAgg', 'numerix':'numpy'})
---
> rc = {'backend':'Agg'}
Only in matplotlib-1.0.1/src/: setupext.pyc
Only in matplotlib-1.0.1.p0/src/src: backend_agg.cpp
Only in matplotlib-1.0.1.p0/src/src: backend_gdk.c
Only in matplotlib-1.0.1.p0/src/src: image.cpp
Only in matplotlib-1.0.1.p0/src/src: path.cpp
```



---

archive/issue_comments_128828.json:
```json
{
    "body": "Is this normal?\n\n```\nOPTIONAL BACKEND DEPENDENCIES\n                libpng: found, but unknown version (no pkg-config)\n```\nI do have `pkg-config` installed, and `$SAGE_ROOT/local/lib/pkgconfig/libpng12.pc` (target of a symbolic link `libpng.pc`) looks like this:\n\n```\n...\nName: libpng\nDescription: Loads and saves PNG files\nVersion: 1.2.35\nLibs: -L${libdir} -lpng12\n...\n```\nSo maybe either `pkg-config` or MPL is confused by the \"wrong\" `Name: `, since we patch MPL's `setupext.py`:\n\n```diff\n--- src/setupext.py\t2010-06-11 10:50:55.000000000 -0500\n+++ src/setupext.py\t2010-06-11 14:42:15.000000000 -0500\n@@ -538,7 +538,7 @@\n     module.include_dirs.append(numpy.get_include())\n \n def add_png_flags(module):\n-    try_pkgconfig(module, 'libpng', 'png')\n+    try_pkgconfig(module, 'libpng12', 'png12')\n     add_base_flags(module)\n     add_numpy_flags(module)\n     module.libraries.append('z')\n```\nProbably this patch should only be applied on MacOS X, since\n\n```\n * setupext.py: link to libpng12 instead of libpng to apparently avoid\n   some name clashes on OSX.\n```\n(Currently running doctests, so haven't checked if not applying the patch on Linux changes anything w.r.t. that.)\n\n\n\n\nWe should add freetype (and now also GNU patch) to the *Dependencies*:\n\n```\nREQUIRED DEPENDENCIES\n                 numpy: 1.5.1\n             freetype2: 9.16.3\n\n```\n\n```\n## Dependencies\n\n * python\n * numpy\n\n```",
    "created_at": "2011-08-13T18:07:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128828",
    "user": "https://github.com/nexttime"
}
```

Is this normal?

```
OPTIONAL BACKEND DEPENDENCIES
                libpng: found, but unknown version (no pkg-config)
```
I do have `pkg-config` installed, and `$SAGE_ROOT/local/lib/pkgconfig/libpng12.pc` (target of a symbolic link `libpng.pc`) looks like this:

```
...
Name: libpng
Description: Loads and saves PNG files
Version: 1.2.35
Libs: -L${libdir} -lpng12
...
```
So maybe either `pkg-config` or MPL is confused by the "wrong" `Name: `, since we patch MPL's `setupext.py`:

```diff
--- src/setupext.py	2010-06-11 10:50:55.000000000 -0500
+++ src/setupext.py	2010-06-11 14:42:15.000000000 -0500
@@ -538,7 +538,7 @@
     module.include_dirs.append(numpy.get_include())
 
 def add_png_flags(module):
-    try_pkgconfig(module, 'libpng', 'png')
+    try_pkgconfig(module, 'libpng12', 'png12')
     add_base_flags(module)
     add_numpy_flags(module)
     module.libraries.append('z')
```
Probably this patch should only be applied on MacOS X, since

```
 * setupext.py: link to libpng12 instead of libpng to apparently avoid
   some name clashes on OSX.
```
(Currently running doctests, so haven't checked if not applying the patch on Linux changes anything w.r.t. that.)




We should add freetype (and now also GNU patch) to the *Dependencies*:

```
REQUIRED DEPENDENCIES
                 numpy: 1.5.1
             freetype2: 9.16.3

```

```
## Dependencies

 * python
 * numpy

```



---

archive/issue_comments_128829.json:
```json
{
    "body": "On my OS X box, I see the same thing with the old 1.0.1 and with the new one:\n\n```\nREQUIRED DEPENDENCIES\n                 numpy: 1.5.1\n             freetype2: found, but unknown version (no pkg-config)\n\nOPTIONAL BACKEND DEPENDENCIES\n                libpng: found, but unknown version (no pkg-config)\n```\nI see that on linux, or at least on sage.math, it reports the correct version for these.\n\nI can\n\n- apply the patch to `setupext.py` only on Darwin.\n- apply the patch always, but add an `if ... then ... else` so it only does something different on Darwin.\n\nOpinions?\n\nI'll certainly add freetype and patch to the dependencies.",
    "created_at": "2011-08-13T19:13:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128829",
    "user": "https://github.com/jhpalmieri"
}
```

On my OS X box, I see the same thing with the old 1.0.1 and with the new one:

```
REQUIRED DEPENDENCIES
                 numpy: 1.5.1
             freetype2: found, but unknown version (no pkg-config)

OPTIONAL BACKEND DEPENDENCIES
                libpng: found, but unknown version (no pkg-config)
```
I see that on linux, or at least on sage.math, it reports the correct version for these.

I can

- apply the patch to `setupext.py` only on Darwin.
- apply the patch always, but add an `if ... then ... else` so it only does something different on Darwin.

Opinions?

I'll certainly add freetype and patch to the dependencies.



---

archive/issue_comments_128830.json:
```json
{
    "body": "Impressive:\n\n```sh\n$ du -h matplotlib-1.0.1*.spkg\n12M\tmatplotlib-1.0.1.p0.spkg\n19M\tmatplotlib-1.0.1.spkg\n```\n\nSo the Sage tarball will get a bit smaller again.\n\n(It'll get even smaller if someone someday removes the JSMath fonts and other obsolete files from SageNB's Mercurial repository; I'm not sure if we even ship duplicates in other packages.)",
    "created_at": "2011-08-13T19:14:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128830",
    "user": "https://github.com/nexttime"
}
```

Impressive:

```sh
$ du -h matplotlib-1.0.1*.spkg
12M	matplotlib-1.0.1.p0.spkg
19M	matplotlib-1.0.1.spkg
```

So the Sage tarball will get a bit smaller again.

(It'll get even smaller if someone someday removes the JSMath fonts and other obsolete files from SageNB's Mercurial repository; I'm not sure if we even ship duplicates in other packages.)



---

archive/issue_comments_128831.json:
```json
{
    "body": "The version MPL reports for freetype2 clearly comes from Sage's `.pc` file, since my system one refers to a different one; also `PKG_CONFIG_PATH` is \"properly\" set to (just) Sage's `pkg-config` directory.\n\nIs `PKG_CONFIG_PATH` set on sage.math outside the Sage environment? (We only set it to Sage's if it is empty, i.e. don't prepend Sage's in case it is already set.)",
    "created_at": "2011-08-13T19:42:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128831",
    "user": "https://github.com/nexttime"
}
```

The version MPL reports for freetype2 clearly comes from Sage's `.pc` file, since my system one refers to a different one; also `PKG_CONFIG_PATH` is "properly" set to (just) Sage's `pkg-config` directory.

Is `PKG_CONFIG_PATH` set on sage.math outside the Sage environment? (We only set it to Sage's if it is empty, i.e. don't prepend Sage's in case it is already set.)



---

archive/issue_comments_128832.json:
```json
{
    "body": "I'm confused now.  On sage.math, if I look at the install log from the old matplotlib-1.0.1 (during a fresh Sage build), it says\n\n```\nOPTIONAL BACKEND DEPENDENCIES\n\t\tlibpng: 1.2.35\n```\nBut if I do \"sage -f ...\" on the *same* spkg, I get this in its install log:\n\n```\nOPTIONAL BACKEND DEPENDENCIES                \n                 libpng: found, but unknown version (no pkg-config)\n```\nAnd of course, in this old spkg, this was the only patch installed, and it was installed regardless of the OS.  I don't know what's going on, but I'm posting a new spkg which only applies the patch on Darwin.  I hope this improves things on non-Darwin systems, or at least doesn't hurt anything on such systems.",
    "created_at": "2011-08-13T20:07:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128832",
    "user": "https://github.com/jhpalmieri"
}
```

I'm confused now.  On sage.math, if I look at the install log from the old matplotlib-1.0.1 (during a fresh Sage build), it says

```
OPTIONAL BACKEND DEPENDENCIES
		libpng: 1.2.35
```
But if I do "sage -f ..." on the *same* spkg, I get this in its install log:

```
OPTIONAL BACKEND DEPENDENCIES                
                 libpng: found, but unknown version (no pkg-config)
```
And of course, in this old spkg, this was the only patch installed, and it was installed regardless of the OS.  I don't know what's going on, but I'm posting a new spkg which only applies the patch on Darwin.  I hope this improves things on non-Darwin systems, or at least doesn't hurt anything on such systems.



---

archive/issue_comments_128833.json:
```json
{
    "body": "Replying to [comment:12 jhpalmieri]:\n> I can \n\n\n> \n> - apply the patch to `setupext.py` only on Darwin. \n\n\n>  - apply the patch always, but add an `if ... then ... else` so it only does something different on Darwin. \n\n\n> \n> Opinions?\n\n\nI think modifying the patch is easier, but do what you prefer.\n\nNote that the change should only be made if the OS is Darwin **and** `pkg-config` is **not** installed, since Sage's `libpng*.pc` contains\n\n```\nLibs: -L${libdir} -lpng12\n```",
    "created_at": "2011-08-13T20:21:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128833",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:12 jhpalmieri]:
> I can 


> 
> - apply the patch to `setupext.py` only on Darwin. 


>  - apply the patch always, but add an `if ... then ... else` so it only does something different on Darwin. 


> 
> Opinions?


I think modifying the patch is easier, but do what you prefer.

Note that the change should only be made if the OS is Darwin **and** `pkg-config` is **not** installed, since Sage's `libpng*.pc` contains

```
Libs: -L${libdir} -lpng12
```



---

archive/issue_comments_128834.json:
```json
{
    "body": "I should perhaps open another ticket for changing `sage-env` to *always* add Sage's `pkg-config` directory to `PKG_CONFIG_PATH`, since otherwise wrong libraries may get used.",
    "created_at": "2011-08-13T20:25:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128834",
    "user": "https://github.com/nexttime"
}
```

I should perhaps open another ticket for changing `sage-env` to *always* add Sage's `pkg-config` directory to `PKG_CONFIG_PATH`, since otherwise wrong libraries may get used.



---

archive/issue_comments_128835.json:
```json
{
    "body": "Replying to [comment:16 leif]:\n> Note that the change should only be made if the OS is Darwin **and** `pkg-config` is **not** installed\n\n\nHere's a version which does this.  I'm not a shell script expert; is this a good way to accomplish it?\n\n```\n\tif [ \"$UNAME\" = \"Darwin\" ]; then\n\t    command -v pkg-config || patch -p1 < \"$patch\"\n```",
    "created_at": "2011-08-13T21:07:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128835",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:16 leif]:
> Note that the change should only be made if the OS is Darwin **and** `pkg-config` is **not** installed


Here's a version which does this.  I'm not a shell script expert; is this a good way to accomplish it?

```
	if [ "$UNAME" = "Darwin" ]; then
	    command -v pkg-config || patch -p1 < "$patch"
```



---

archive/issue_comments_128836.json:
```json
{
    "body": "Replying to [comment:18 jhpalmieri]:\n> Here's a version which does this.  I'm not a shell script expert; is this a good way to accomplish it?\n\n{{{#!sh\n\tif [ \"$UNAME\" = \"Darwin\" ]; then\n\t    command -v pkg-config || patch -p1 < \"$patch\"\n}}}\nI see you've redirected the output of `command` to `/dev/null` in the actual patch.\n\nIMHO a bit more readable would be\n\n```sh\n    if [ \"$UNAME\" = Darwin ] && ! command -v pkg-config >/dev/null; then\n        patch -p1 < \"$patch\" # Apply only on Darwin if pkg-config isn't installed\n    fi\n```\nbut for simplicity (if you're not going to change the patch) I would move the specific patch to `patches/Darwin/` and do the following:\n\n```sh\n# Apply patches for all platforms.  See SPKG.txt for why and what.\nfor patch in ../patches/*.patch; do\n    patch -p1 <\"$patch\"\n    if [ $? -ne 0 ]; then\n        echo >&2 \"Error applying '$patch'\"\n        exit 1\n    fi\ndone\n\n# Apply patch(es) for Darwin.\nif [ \"$UNAME\" = Darwin ]; then\n    for patch in ../patches/Darwin/*.patch; do\n        patch -p1 <\"$patch\"\n        if [ $? -ne 0 ]; then\n            echo >&2 \"Error applying '$patch'\"\n            exit 1\n        fi\n    done\nfi\n```\n(The latter would have to be changed from a loop to an `if`-statement depending on `command -v ...` if we only apply the single patch and don't test for `pkg-config` in the patch itself, i.e., from Python.)\n\nHaving the patch in a separate directory it's also immediately clear that it is platform-specific; unfortunately we here have another precondition.",
    "created_at": "2011-08-13T22:42:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128836",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:18 jhpalmieri]:
> Here's a version which does this.  I'm not a shell script expert; is this a good way to accomplish it?

{{{#!sh
	if [ "$UNAME" = "Darwin" ]; then
	    command -v pkg-config || patch -p1 < "$patch"
}}}
I see you've redirected the output of `command` to `/dev/null` in the actual patch.

IMHO a bit more readable would be

```sh
    if [ "$UNAME" = Darwin ] && ! command -v pkg-config >/dev/null; then
        patch -p1 < "$patch" # Apply only on Darwin if pkg-config isn't installed
    fi
```
but for simplicity (if you're not going to change the patch) I would move the specific patch to `patches/Darwin/` and do the following:

```sh
# Apply patches for all platforms.  See SPKG.txt for why and what.
for patch in ../patches/*.patch; do
    patch -p1 <"$patch"
    if [ $? -ne 0 ]; then
        echo >&2 "Error applying '$patch'"
        exit 1
    fi
done

# Apply patch(es) for Darwin.
if [ "$UNAME" = Darwin ]; then
    for patch in ../patches/Darwin/*.patch; do
        patch -p1 <"$patch"
        if [ $? -ne 0 ]; then
            echo >&2 "Error applying '$patch'"
            exit 1
        fi
    done
fi
```
(The latter would have to be changed from a loop to an `if`-statement depending on `command -v ...` if we only apply the single patch and don't test for `pkg-config` in the patch itself, i.e., from Python.)

Having the patch in a separate directory it's also immediately clear that it is platform-specific; unfortunately we here have another precondition.



---

archive/issue_comments_128837.json:
```json
{
    "body": "For whatever reason, I still get\n\n```\n...\nNOTE: Set SAGE_MATPLOTLIB_GUI to anything but 'no' to try to build the Matplotlib GUI.\nNot building any matplotlib graphical backends.\npatching file lib/matplotlib/__init__.py\npatching file lib/matplotlib/finance.py\npatching file lib/matplotlib/texmanager.py\nbasedirlist is: ['/home/leif/Sage/sage-4.7.1.rc2/local']\n============================================================================\nBUILDING MATPLOTLIB\n            matplotlib: 1.0.1\n                python: 2.6.4 (r264, Aug 11 2011, 12:43:02)  [GCC 4.5.1]\n              platform: linux2\n\nREQUIRED DEPENDENCIES\n                 numpy: 1.5.1\n             freetype2: 9.16.3\n\nOPTIONAL BACKEND DEPENDENCIES\n                libpng: found, but unknown version (no pkg-config)\n...\n```\ni.e. an \"unknown\" libpng version, even without the patch to `setupext.py`.",
    "created_at": "2011-08-13T22:59:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128837",
    "user": "https://github.com/nexttime"
}
```

For whatever reason, I still get

```
...
NOTE: Set SAGE_MATPLOTLIB_GUI to anything but 'no' to try to build the Matplotlib GUI.
Not building any matplotlib graphical backends.
patching file lib/matplotlib/__init__.py
patching file lib/matplotlib/finance.py
patching file lib/matplotlib/texmanager.py
basedirlist is: ['/home/leif/Sage/sage-4.7.1.rc2/local']
============================================================================
BUILDING MATPLOTLIB
            matplotlib: 1.0.1
                python: 2.6.4 (r264, Aug 11 2011, 12:43:02)  [GCC 4.5.1]
              platform: linux2

REQUIRED DEPENDENCIES
                 numpy: 1.5.1
             freetype2: 9.16.3

OPTIONAL BACKEND DEPENDENCIES
                libpng: found, but unknown version (no pkg-config)
...
```
i.e. an "unknown" libpng version, even without the patch to `setupext.py`.



---

archive/issue_comments_128838.json:
```json
{
    "body": "I think that using the vanilla source is best when possible, so I'm only going to apply the patch on Darwin.  However, it's possible that someone will install (or uninstall) pkg-config and not recompile Sage, so I've put the test for that inside the patch.",
    "created_at": "2011-08-13T23:03:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128838",
    "user": "https://github.com/jhpalmieri"
}
```

I think that using the vanilla source is best when possible, so I'm only going to apply the patch on Darwin.  However, it's possible that someone will install (or uninstall) pkg-config and not recompile Sage, so I've put the test for that inside the patch.



---

archive/issue_comments_128839.json:
```json
{
    "body": "Haha:\n\n```\n~/Sage/sage-4.7.1.rc2$ env PKG_CONFIG_PATH=/foo ./sage -f ~/Sage/spkgs/matplotlib-1.0.1.p0.spkg \nForce installing /home/leif/Sage/spkgs/matplotlib-1.0.1.p0.spkg\n...\nNOTE: Set SAGE_MATPLOTLIB_GUI to anything but 'no' to try to build the Matplotlib GUI.\nNot building any matplotlib graphical backends.\npatching file lib/matplotlib/__init__.py\npatching file lib/matplotlib/finance.py\npatching file lib/matplotlib/texmanager.py\nbasedirlist is: ['/home/leif/Sage/sage-4.7.1.rc2/local']\n============================================================================\nBUILDING MATPLOTLIB\n            matplotlib: 1.0.1\n                python: 2.6.4 (r264, Aug 11 2011, 12:43:02)  [GCC 4.5.1]\n              platform: linux2\n\nREQUIRED DEPENDENCIES\n                 numpy: 1.5.1\n             freetype2: 9.22.3\n\nOPTIONAL BACKEND DEPENDENCIES\n                libpng: 1.2.42\n...\n```\nSo somehow Sage's `libpng*.pc` appears to be \"broken\".",
    "created_at": "2011-08-13T23:08:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128839",
    "user": "https://github.com/nexttime"
}
```

Haha:

```
~/Sage/sage-4.7.1.rc2$ env PKG_CONFIG_PATH=/foo ./sage -f ~/Sage/spkgs/matplotlib-1.0.1.p0.spkg 
Force installing /home/leif/Sage/spkgs/matplotlib-1.0.1.p0.spkg
...
NOTE: Set SAGE_MATPLOTLIB_GUI to anything but 'no' to try to build the Matplotlib GUI.
Not building any matplotlib graphical backends.
patching file lib/matplotlib/__init__.py
patching file lib/matplotlib/finance.py
patching file lib/matplotlib/texmanager.py
basedirlist is: ['/home/leif/Sage/sage-4.7.1.rc2/local']
============================================================================
BUILDING MATPLOTLIB
            matplotlib: 1.0.1
                python: 2.6.4 (r264, Aug 11 2011, 12:43:02)  [GCC 4.5.1]
              platform: linux2

REQUIRED DEPENDENCIES
                 numpy: 1.5.1
             freetype2: 9.22.3

OPTIONAL BACKEND DEPENDENCIES
                libpng: 1.2.42
...
```
So somehow Sage's `libpng*.pc` appears to be "broken".



---

archive/issue_comments_128840.json:
```json
{
    "body": "Replying to [comment:22 leif]:\n> So somehow Sage's `libpng*.pc` appears to be \"broken\".\n\n\nYep, apparently by `sage-location`, during the build.\n\nIf I reinstall `libpng12`, and then MPL, everything is fine.\n\nThe offending line was\n\n```\nSAGE_ROOT=${SAGE_ROOT}\n```\n`SAGE_ROOT=/the/appropriate/absolute/path` works. I have no idea why `pkg-config` doesn't take `$SAGE_ROOT` from the environment if it isn't defined in the `.pc` file itself; it IMHO used to -- last year, but meanwhile doesn't ... 8/\n\nI.e.,\n\n```\nprefix=${SAGE_ROOT}\n```\ndoes no longer work unless `SAGE_ROOT` is also defined in the `.pc` file itself.\n\nWe may have to really wrap `pkg-config` in `$SAGE_ROOT/local/bin` with\n\n```sh\n#!/bin/sh\n\nif [ -z \"$SAGE_ROOT\" ]; then\n    echo >&2 \"Error: $0: SAGE_ROOT not defined.\"\n    exit 1\nfi\n\nexec /usr/bin/env PATH=`echo $PATH | sed -e \"s|$SAGE_ROOT/local/bin:||\"` \\\n    pkg-config --define-variable=SAGE_ROOT=\"$SAGE_ROOT\" \"$@\"\n```\n(Or just call the system's `pkg-config` *without* `--define-variable ...` if `SAGE_ROOT` is undefined.)\n\nDefining `SAGE_ORIG_PATH` in `sage-env` wouldn't be a bad idea either.",
    "created_at": "2011-08-14T00:17:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128840",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:22 leif]:
> So somehow Sage's `libpng*.pc` appears to be "broken".


Yep, apparently by `sage-location`, during the build.

If I reinstall `libpng12`, and then MPL, everything is fine.

The offending line was

```
SAGE_ROOT=${SAGE_ROOT}
```
`SAGE_ROOT=/the/appropriate/absolute/path` works. I have no idea why `pkg-config` doesn't take `$SAGE_ROOT` from the environment if it isn't defined in the `.pc` file itself; it IMHO used to -- last year, but meanwhile doesn't ... 8/

I.e.,

```
prefix=${SAGE_ROOT}
```
does no longer work unless `SAGE_ROOT` is also defined in the `.pc` file itself.

We may have to really wrap `pkg-config` in `$SAGE_ROOT/local/bin` with

```sh
#!/bin/sh

if [ -z "$SAGE_ROOT" ]; then
    echo >&2 "Error: $0: SAGE_ROOT not defined."
    exit 1
fi

exec /usr/bin/env PATH=`echo $PATH | sed -e "s|$SAGE_ROOT/local/bin:||"` \
    pkg-config --define-variable=SAGE_ROOT="$SAGE_ROOT" "$@"
```
(Or just call the system's `pkg-config` *without* `--define-variable ...` if `SAGE_ROOT` is undefined.)

Defining `SAGE_ORIG_PATH` in `sage-env` wouldn't be a bad idea either.



---

archive/issue_comments_128841.json:
```json
{
    "body": "Replying to [comment:23 leif]:\n> Replying to [comment:22 leif]:\n> > So somehow Sage's `libpng*.pc` appears to be \"broken\". \n\n\n> > [...]\n\n{{{\nprefix=${SAGE_ROOT}\n}}}\n> does no longer work unless `SAGE_ROOT` is also defined in the `.pc` file itself.\n\n\nIt never did that way; I used `$${SAGE_ROOT}`.\n\n> We may have to really wrap `pkg-config` in `$SAGE_ROOT/local/bin` [...]\n\n\nWe don't have to, and shouldn't do so (see e.g. [comment:ticket:10202:26 this comment] at #10202).\n\n\n\n\nSo what's the current status of this ticket?\n\nIs the attached diff (and the spkg) still current, or did you / do you plan to make further changes to `spkg-install` (w.r.t. to applying the patches) and the `setupext.py` patch?\n\nI think the `pkg-config` issues (on Linux) have shown to be rather unrelated to this ticket (and MPL itself), so the patch to `setupext.py` may not have to only be applied on MacOS X (if `pkg-config` is installed), though limiting its application shouldn't hurt either.\n\nIf you want to leave the code as is, I'll re-review and test it now. The only thing I noticed is that `SPKG.txt` isn't very explicit regarding the patch to `setupext.py`, i.e. what it currently exactly does and that it's indeed only applied on Darwin. I'd consider this a minor issue though.",
    "created_at": "2011-08-14T18:28:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128841",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:23 leif]:
> Replying to [comment:22 leif]:
> > So somehow Sage's `libpng*.pc` appears to be "broken". 


> > [...]

{{{
prefix=${SAGE_ROOT}
}}}
> does no longer work unless `SAGE_ROOT` is also defined in the `.pc` file itself.


It never did that way; I used `$${SAGE_ROOT}`.

> We may have to really wrap `pkg-config` in `$SAGE_ROOT/local/bin` [...]


We don't have to, and shouldn't do so (see e.g. [comment:ticket:10202:26 this comment] at #10202).




So what's the current status of this ticket?

Is the attached diff (and the spkg) still current, or did you / do you plan to make further changes to `spkg-install` (w.r.t. to applying the patches) and the `setupext.py` patch?

I think the `pkg-config` issues (on Linux) have shown to be rather unrelated to this ticket (and MPL itself), so the patch to `setupext.py` may not have to only be applied on MacOS X (if `pkg-config` is installed), though limiting its application shouldn't hurt either.

If you want to leave the code as is, I'll re-review and test it now. The only thing I noticed is that `SPKG.txt` isn't very explicit regarding the patch to `setupext.py`, i.e. what it currently exactly does and that it's indeed only applied on Darwin. I'd consider this a minor issue though.



---

archive/issue_comments_128842.json:
```json
{
    "body": "Oh, and the Changelog entry could mention that you refreshed the upstream sources. (They apparently actually changed the `#!/usr/bin/env python2`, unless Ryan had previously modified the sources.)",
    "created_at": "2011-08-14T18:36:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128842",
    "user": "https://github.com/nexttime"
}
```

Oh, and the Changelog entry could mention that you refreshed the upstream sources. (They apparently actually changed the `#!/usr/bin/env python2`, unless Ryan had previously modified the sources.)



---

archive/issue_comments_128843.json:
```json
{
    "body": "I'll post one more version, updating SPKG.txt and the commit message, saying that the upstream sources have been refreshed.  I don't really know the purpose of the setupext.py patch, so I don't feel qualified to modify what SPKG.txt says.  If you have suggestions, I'd be happy to hear them.  For now, I added a trac number to the comment in SPKG.txt (that trac number was in the original patch from #4774, but has since disappeared...).\n\nThe new spkg is in place, so once I've attached the most recent patch to this ticket, it will be ready for review.",
    "created_at": "2011-08-14T19:04:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128843",
    "user": "https://github.com/jhpalmieri"
}
```

I'll post one more version, updating SPKG.txt and the commit message, saying that the upstream sources have been refreshed.  I don't really know the purpose of the setupext.py patch, so I don't feel qualified to modify what SPKG.txt says.  If you have suggestions, I'd be happy to hear them.  For now, I added a trac number to the comment in SPKG.txt (that trac number was in the original patch from #4774, but has since disappeared...).

The new spkg is in place, so once I've attached the most recent patch to this ticket, it will be ready for review.



---

archive/issue_comments_128844.json:
```json
{
    "body": "patch for matplotlib spkg; for review only",
    "created_at": "2011-08-14T19:04:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128844",
    "user": "https://github.com/jhpalmieri"
}
```

patch for matplotlib spkg; for review only



---

archive/issue_comments_128845.json:
```json
{
    "body": "Attachment [trac_11686-matplotlib.patch](tarball://root/attachments/some-uuid/ticket11686/trac_11686-matplotlib.patch) by @jhpalmieri created at 2011-08-14 19:11:24\n\nSummarizing:\n\n- this ticket includes most of the patches from #10159 (the missing parts are because I got tired, so I didn't fix the fact that some lines in SPKG.txt have lengths > 80).\n- in SPKG.txt, the prerequisites have been updated.\n- the patches now use \"patch\" for their application.\n- the patches are divided into ones specifically for Darwin, and ones for all platforms.\n- the Darwin patch passes 'libpng12' or 'libpng' to `try_pkgconfig`, depending on whether `pkg-config` is installed, instead of just always passing 'libpng12'.\n- as part of the patches from #10159, the installation procedure prints Sage's setting of the variable MPLCONFIGDIR.\n- the 'src' directory has been replaced with a vanilla source, downloaded 13-Aug-2011.",
    "created_at": "2011-08-14T19:11:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128845",
    "user": "https://github.com/jhpalmieri"
}
```

Attachment [trac_11686-matplotlib.patch](tarball://root/attachments/some-uuid/ticket11686/trac_11686-matplotlib.patch) by @jhpalmieri created at 2011-08-14 19:11:24

Summarizing:

- this ticket includes most of the patches from #10159 (the missing parts are because I got tired, so I didn't fix the fact that some lines in SPKG.txt have lengths > 80).
- in SPKG.txt, the prerequisites have been updated.
- the patches now use "patch" for their application.
- the patches are divided into ones specifically for Darwin, and ones for all platforms.
- the Darwin patch passes 'libpng12' or 'libpng' to `try_pkgconfig`, depending on whether `pkg-config` is installed, instead of just always passing 'libpng12'.
- as part of the patches from #10159, the installation procedure prints Sage's setting of the variable MPLCONFIGDIR.
- the 'src' directory has been replaced with a vanilla source, downloaded 13-Aug-2011.



---

archive/issue_comments_128846.json:
```json
{
    "body": "Replying to [comment:27 jhpalmieri]:\n> Summarizing: \n\n\n>  [...] \n\n\n>  - in SPKG.txt, the prerequisites have been updated. \n\n\n>  - the patches now use \"patch\" for their application. \n\n\n>  - the patches are divided into ones specifically for Darwin, and ones for all platforms. \n\n\n>  - the Darwin patch passes 'libpng12' or 'libpng' to `try_pkgconfig`, depending on whether `pkg-config` is installed, instead of just always passing 'libpng12'. \n\n\n\n(May also read *\"... instead of just always passing ** 'libpng' **\"*; it is at least not clear to what \"instead\" refers to, i.e. unmodifed code or unconditional application of the patch.)\n\n>  - as part of the patches from #10159, the installation procedure prints Sage's setting of the variable MPLCONFIGDIR. \n\n\n>  [...]\n\n\nI would have just added the above to the Changelog entry. :)\n\n\n\n\n> I don't really know the purpose of the setupext.py patch, so I don't feel qualified to modify what SPKG.txt says. If you have suggestions, I'd be happy to hear them.\n\n\nI rather meant noting that the patch is only applied on Darwin, and that it only changes the behaviour if `pkg-config` is not installed.\n\n__W.r.t. why this is necessary:__\n\nThe assumption is that when `pkg-config` *is* installed, it will always pick up Sage's `libpng.pc` (which is a symbolic link to `libpng12.pc`), so MPL will always be linked to the correct, i.e. Sage's `libpng`, regardless of whether `\"libpng\"` or `\"libpng12\"` is used in `try_pkgconfig()`.\n\nIf `pkg-config` is *not* available, and you pass just `\"libpng\"` (without `12`) to `try_pkgconfig()`, MPL might pick up some random system `libpng` (without the `12`), which can lead to name clashes and other errors because two different `libpng`s could be linked into Sage.\n\nSo it should be pretty safe to just always pass `\"libpng12\"`, no matter what operating system and whether `pkg-config` is installed or not -- Sorry for the previous noise...\n\n(On the other hand, it's also not bad to only apply such patches on [potentially] affected systems; if Sage's `libpng12` one day changes to, say, `libpng13`, we'd have to modify MPL for all systems to work. If we only used `\"libpng12\"` on e.g. Darwin instead, only Darwin would break on such an upgrade.)\n\n---\n\nIs the following still current (for version 1.x)?\n\n```python\n...\nconfig.add_section('gui_support')\nfor backend in ('gtk', 'gtkagg', 'tkagg', 'wxagg', 'macosx', 'windowing'):\n    config.set('gui_support', backend,  graphical_backend)\n...\n```\n\n```sh\n$ hg log -v make-setup-config.py \nchangeset:   37:0aef07ceab83\nuser:        Jason Grout <jason-sage@creativetrax.com>\ndate:        Fri Jun 11 12:06:36 2010 -0500\n...\n```\n(That's the only entry, corresponding to `matplotlib-0.99.3-svn8415.spkg`.)\n\nI haven't tried to (attempt to) build any graphical backends.",
    "created_at": "2011-08-14T20:20:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128846",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:27 jhpalmieri]:
> Summarizing: 


>  [...] 


>  - in SPKG.txt, the prerequisites have been updated. 


>  - the patches now use "patch" for their application. 


>  - the patches are divided into ones specifically for Darwin, and ones for all platforms. 


>  - the Darwin patch passes 'libpng12' or 'libpng' to `try_pkgconfig`, depending on whether `pkg-config` is installed, instead of just always passing 'libpng12'. 



(May also read *"... instead of just always passing ** 'libpng' **"*; it is at least not clear to what "instead" refers to, i.e. unmodifed code or unconditional application of the patch.)

>  - as part of the patches from #10159, the installation procedure prints Sage's setting of the variable MPLCONFIGDIR. 


>  [...]


I would have just added the above to the Changelog entry. :)




> I don't really know the purpose of the setupext.py patch, so I don't feel qualified to modify what SPKG.txt says. If you have suggestions, I'd be happy to hear them.


I rather meant noting that the patch is only applied on Darwin, and that it only changes the behaviour if `pkg-config` is not installed.

__W.r.t. why this is necessary:__

The assumption is that when `pkg-config` *is* installed, it will always pick up Sage's `libpng.pc` (which is a symbolic link to `libpng12.pc`), so MPL will always be linked to the correct, i.e. Sage's `libpng`, regardless of whether `"libpng"` or `"libpng12"` is used in `try_pkgconfig()`.

If `pkg-config` is *not* available, and you pass just `"libpng"` (without `12`) to `try_pkgconfig()`, MPL might pick up some random system `libpng` (without the `12`), which can lead to name clashes and other errors because two different `libpng`s could be linked into Sage.

So it should be pretty safe to just always pass `"libpng12"`, no matter what operating system and whether `pkg-config` is installed or not -- Sorry for the previous noise...

(On the other hand, it's also not bad to only apply such patches on [potentially] affected systems; if Sage's `libpng12` one day changes to, say, `libpng13`, we'd have to modify MPL for all systems to work. If we only used `"libpng12"` on e.g. Darwin instead, only Darwin would break on such an upgrade.)

---

Is the following still current (for version 1.x)?

```python
...
config.add_section('gui_support')
for backend in ('gtk', 'gtkagg', 'tkagg', 'wxagg', 'macosx', 'windowing'):
    config.set('gui_support', backend,  graphical_backend)
...
```

```sh
$ hg log -v make-setup-config.py 
changeset:   37:0aef07ceab83
user:        Jason Grout <jason-sage@creativetrax.com>
date:        Fri Jun 11 12:06:36 2010 -0500
...
```
(That's the only entry, corresponding to `matplotlib-0.99.3-svn8415.spkg`.)

I haven't tried to (attempt to) build any graphical backends.



---

archive/issue_comments_128847.json:
```json
{
    "body": "Replying to [comment:28 leif]:\n> Is the following still current (for version 1.x)?\n\n{{{#!python\n...\nconfig.add_section('gui_support')\nfor backend in ('gtk', 'gtkagg', 'tkagg', 'wxagg', 'macosx', 'windowing'):\n    config.set('gui_support', backend,  graphical_backend)\n...\n}}}\n> [...] \n\n\n```sh\n$ hg log -v make-setup-config.py \nchangeset:   37:0aef07ceab83\nuser:        Jason Grout <jason-sage@creativetrax.com>\ndate:        Fri Jun 11 12:06:36 2010 -0500\n...\n```\n> (That's the only entry, corresponding to `matplotlib-0.99.3-svn8415.spkg`.) \n\n\n> \n\n\n> I haven't tried to (attempt to) build any graphical backends.\n\n\nAt least setting `SAGE_MATPLOTLIB_GUI=yes` has no real effect on my system, because of at least some missing components:\n\n```\n...\n\nOPTIONAL BACKEND DEPENDENCIES\n                libpng: 1.2.35\n               Tkinter: no\n                        * TKAgg requires Tkinter\n              wxPython: no\n                        * wxPython not found\n                  Gtk+: no\n                        * Building for Gtk+ requires pygtk; you must be able\n                        * to \"import gtk\" in your build/install environment\n       Mac OS X native: no\n                    Qt: no\n                   Qt4: no\n                 Cairo: no\n\n```\n\nPerhaps one should test this on other systems as well, though not really on topic of *this* ticket, i.e., I think if the list of graphics backends needs to be updated, this should be done on a follow-up, but we should IMHO check this while we're at it.\n\nOtherwise positive review for the current spkg.",
    "created_at": "2011-08-14T21:12:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128847",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:28 leif]:
> Is the following still current (for version 1.x)?

{{{#!python
...
config.add_section('gui_support')
for backend in ('gtk', 'gtkagg', 'tkagg', 'wxagg', 'macosx', 'windowing'):
    config.set('gui_support', backend,  graphical_backend)
...
}}}
> [...] 


```sh
$ hg log -v make-setup-config.py 
changeset:   37:0aef07ceab83
user:        Jason Grout <jason-sage@creativetrax.com>
date:        Fri Jun 11 12:06:36 2010 -0500
...
```
> (That's the only entry, corresponding to `matplotlib-0.99.3-svn8415.spkg`.) 


> 


> I haven't tried to (attempt to) build any graphical backends.


At least setting `SAGE_MATPLOTLIB_GUI=yes` has no real effect on my system, because of at least some missing components:

```
...

OPTIONAL BACKEND DEPENDENCIES
                libpng: 1.2.35
               Tkinter: no
                        * TKAgg requires Tkinter
              wxPython: no
                        * wxPython not found
                  Gtk+: no
                        * Building for Gtk+ requires pygtk; you must be able
                        * to "import gtk" in your build/install environment
       Mac OS X native: no
                    Qt: no
                   Qt4: no
                 Cairo: no

```

Perhaps one should test this on other systems as well, though not really on topic of *this* ticket, i.e., I think if the list of graphics backends needs to be updated, this should be done on a follow-up, but we should IMHO check this while we're at it.

Otherwise positive review for the current spkg.



---

archive/issue_comments_128848.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2011-08-14T21:12:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128848",
    "user": "https://github.com/nexttime"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_128849.json:
```json
{
    "body": "I'm considering modifying SPKG.txt as follows:\n\n```diff\ndiff --git a/SPKG.txt b/SPKG.txt\n--- a/SPKG.txt\n+++ b/SPKG.txt\n@@ -40,7 +40,11 @@ The following patches are in the patches\n The patches are applied during the build process.\n \n  * setupext.py: link to libpng12 instead of libpng to apparently avoid\n-   some name clashes on OSX.  See Sage trac #4774.\n+   some name clashes on OSX.  As of version 1.0.1.p0, this patch is\n+   only applied on OS X, and it tests for the presence of\n+   'pkg-config': if it is not installed, then it links to libpng12\n+   instead of libpng; otherwise it does nothing.  See Sage trac #4774\n+   and #11686.\n \n  * __init__.py, finance.py, texmanager.py: instead of \"if\n    not.os.path.exists(DIR): os.mkdir(DIR)\", do \"try os.mkdir(DIR)\" and\n@@ -75,8 +79,20 @@ The patches are applied during the build\n === matplotlib 1.0.1.p0 (John Palmieri, 13 Aug 2011) ===\n  * Patch __init__.py, finance.py, and texmanager.py to avoid race\n    conditions when creating directories.  See Sage trac #11686\n-   and #10159.  Also replaced the \"src\" directory with a freshly\n-   downloaded copy of the vanilla source code.\n+   and #10159.\n+\n+ * Updated the list of prerequisites in this file.\n+ \n+ * Changed spkg-install so that the patches are now applied using\n+   'patch'.\n+\n+ * The patch to setupext.py is now only applied on OS X.  The patch\n+   itself tests whether pkg-config is installed: if so, it maintains\n+   the status quo, and if not, it passes the argument 'libpng12' when\n+   configuring then png package.\n+\n+ * Replaced the \"src\" directory with a freshly downloaded copy of\n+   the vanilla source code.\n \n === matplotlib 1.0.1 (Ryan Grout, 10 Jan 2011) ===\n  * Update to matplotlib 1.0.1.  Fixes a handful of annoying bugs in SAGE.\n```\n\nRe `SAGE_MATPLOTLIB_GUI`: I'm not sure what to check, so I'm hoping we can do this on a follow-up ticket.  (\"We\" meaning someone else, actually.)",
    "created_at": "2011-08-15T01:44:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128849",
    "user": "https://github.com/jhpalmieri"
}
```

I'm considering modifying SPKG.txt as follows:

```diff
diff --git a/SPKG.txt b/SPKG.txt
--- a/SPKG.txt
+++ b/SPKG.txt
@@ -40,7 +40,11 @@ The following patches are in the patches
 The patches are applied during the build process.
 
  * setupext.py: link to libpng12 instead of libpng to apparently avoid
-   some name clashes on OSX.  See Sage trac #4774.
+   some name clashes on OSX.  As of version 1.0.1.p0, this patch is
+   only applied on OS X, and it tests for the presence of
+   'pkg-config': if it is not installed, then it links to libpng12
+   instead of libpng; otherwise it does nothing.  See Sage trac #4774
+   and #11686.
 
  * __init__.py, finance.py, texmanager.py: instead of "if
    not.os.path.exists(DIR): os.mkdir(DIR)", do "try os.mkdir(DIR)" and
@@ -75,8 +79,20 @@ The patches are applied during the build
 === matplotlib 1.0.1.p0 (John Palmieri, 13 Aug 2011) ===
  * Patch __init__.py, finance.py, and texmanager.py to avoid race
    conditions when creating directories.  See Sage trac #11686
-   and #10159.  Also replaced the "src" directory with a freshly
-   downloaded copy of the vanilla source code.
+   and #10159.
+
+ * Updated the list of prerequisites in this file.
+ 
+ * Changed spkg-install so that the patches are now applied using
+   'patch'.
+
+ * The patch to setupext.py is now only applied on OS X.  The patch
+   itself tests whether pkg-config is installed: if so, it maintains
+   the status quo, and if not, it passes the argument 'libpng12' when
+   configuring then png package.
+
+ * Replaced the "src" directory with a freshly downloaded copy of
+   the vanilla source code.
 
 === matplotlib 1.0.1 (Ryan Grout, 10 Jan 2011) ===
  * Update to matplotlib 1.0.1.  Fixes a handful of annoying bugs in SAGE.
```

Re `SAGE_MATPLOTLIB_GUI`: I'm not sure what to check, so I'm hoping we can do this on a follow-up ticket.  ("We" meaning someone else, actually.)



---

archive/issue_comments_128850.json:
```json
{
    "body": "Replying to [comment:30 jhpalmieri]:\n> I'm considering modifying SPKG.txt as follows ...\n\n\ns/OSX/OS X/\n\ns/then png package/the png package/\n\ns/otherwise it does nothing/otherwise doesn't change the behavio[u]r/\n\nI'd also say *explicitly searches for and uses libpng12* instead of *links to ...* in the description of the patch to `setupext.py`.\n\n\n\n\n> Re `SAGE_MATPLOTLIB_GUI`: I'm not sure what to check, so I'm hoping we can do this on a follow-up ticket.  (\"We\" meaning someone else, actually.)\n\n\nWell, one would have to check MPL's docs / release notes / changelog, and also have to install [at least] a lot of Python ~~crap~~ stuff from within the Sage installation, on K<sub>N</sub> different machines for each of the N platforms supported by Sage, and test each of the M supported graphical backend variants on these... ;-)\n\nFor the moment, step one should be sufficient, and Jason or `$SOMEONE_ELSE` might already know whether anything changed.",
    "created_at": "2011-08-15T02:29:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128850",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:30 jhpalmieri]:
> I'm considering modifying SPKG.txt as follows ...


s/OSX/OS X/

s/then png package/the png package/

s/otherwise it does nothing/otherwise doesn't change the behavio[u]r/

I'd also say *explicitly searches for and uses libpng12* instead of *links to ...* in the description of the patch to `setupext.py`.




> Re `SAGE_MATPLOTLIB_GUI`: I'm not sure what to check, so I'm hoping we can do this on a follow-up ticket.  ("We" meaning someone else, actually.)


Well, one would have to check MPL's docs / release notes / changelog, and also have to install [at least] a lot of Python ~~crap~~ stuff from within the Sage installation, on K<sub>N</sub> different machines for each of the N platforms supported by Sage, and test each of the M supported graphical backend variants on these... ;-)

For the moment, step one should be sufficient, and Jason or `$SOMEONE_ELSE` might already know whether anything changed.



---

archive/issue_comments_128851.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2011-08-15T03:41:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128851",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_128852.json:
```json
{
    "body": "Okay, here's a new version. The only change from the previous one is recorded in the \"SPKG.txt\" patch.",
    "created_at": "2011-08-15T03:41:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128852",
    "user": "https://github.com/jhpalmieri"
}
```

Okay, here's a new version. The only change from the previous one is recorded in the "SPKG.txt" patch.



---

archive/issue_comments_128853.json:
```json
{
    "body": "for review only; this was applied on top of the other patch",
    "created_at": "2011-08-15T03:42:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128853",
    "user": "https://github.com/jhpalmieri"
}
```

for review only; this was applied on top of the other patch



---

archive/issue_comments_128854.json:
```json
{
    "body": "Attachment [trac_11686-matplotlib-SPKG.txt.patch](tarball://root/attachments/some-uuid/ticket11686/trac_11686-matplotlib-SPKG.txt.patch) by @nexttime created at 2011-08-15 04:45:18\n\nReplying to [comment:32 jhpalmieri]:\n> Okay, here's a new version. The only change from the previous one is recorded in the \"SPKG.txt\" patch.\n\n\nOk.",
    "created_at": "2011-08-15T04:45:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128854",
    "user": "https://github.com/nexttime"
}
```

Attachment [trac_11686-matplotlib-SPKG.txt.patch](tarball://root/attachments/some-uuid/ticket11686/trac_11686-matplotlib-SPKG.txt.patch) by @nexttime created at 2011-08-15 04:45:18

Replying to [comment:32 jhpalmieri]:
> Okay, here's a new version. The only change from the previous one is recorded in the "SPKG.txt" patch.


Ok.



---

archive/issue_comments_128855.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-08-15T04:45:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128855",
    "user": "https://github.com/nexttime"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_128856.json:
```json
{
    "body": "Haven't read my mail in the weekend and now I come back to see this.  Nice work!",
    "created_at": "2011-08-16T08:16:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128856",
    "user": "https://github.com/jdemeyer"
}
```

Haven't read my mail in the weekend and now I come back to see this.  Nice work!



---

archive/issue_comments_128857.json:
```json
{
    "body": "New version which only does some cleanup in `SPKG.txt`: [http://boxen.math.washington.edu/home/jdemeyer/spkg/matplotlib-1.0.1.p0.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/matplotlib-1.0.1.p0.spkg)\n\nThese changes are so trivial, I don't think they need review.\n\nChanges: [attachment:matplotlib-jdemeyer.patch]",
    "created_at": "2011-08-16T09:10:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128857",
    "user": "https://github.com/jdemeyer"
}
```

New version which only does some cleanup in `SPKG.txt`: [http://boxen.math.washington.edu/home/jdemeyer/spkg/matplotlib-1.0.1.p0.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/matplotlib-1.0.1.p0.spkg)

These changes are so trivial, I don't think they need review.

Changes: [attachment:matplotlib-jdemeyer.patch]



---

archive/issue_comments_128858.json:
```json
{
    "body": "Attachment [matplotlib-jdemeyer.patch](tarball://root/attachments/some-uuid/ticket11686/matplotlib-jdemeyer.patch) by @jdemeyer created at 2011-08-16 09:10:32\n\nAdditional changes",
    "created_at": "2011-08-16T09:10:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128858",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [matplotlib-jdemeyer.patch](tarball://root/attachments/some-uuid/ticket11686/matplotlib-jdemeyer.patch) by @jdemeyer created at 2011-08-16 09:10:32

Additional changes



---

archive/issue_comments_128859.json:
```json
{
    "body": "Replying to [comment:35 jdemeyer]:\n> These changes are so trivial, I don't think they need review.\n\n\nFWIW, they look ok to me.",
    "created_at": "2011-08-16T15:17:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128859",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:35 jdemeyer]:
> These changes are so trivial, I don't think they need review.


FWIW, they look ok to me.



---

archive/issue_comments_128860.json:
```json
{
    "body": "This fails on the buildbot machine `iras`:\n\n```\nWarning: Attempted to overwrite SAGE_ROOT environment variable\nmatplotlib-1.0.1.p0\nMachine:\nLinux iras 2.6.16.46-0.12-default #1 SMP Thu May 17 14:00:09 UTC 2007 ia64 ia64 ia64 GNU/Linux\n[...]\n============================================================================\nBUILDING MATPLOTLIB\n            matplotlib: 1.0.1\n                python: 2.6.4 (r264:75706, Aug 16 2011, 18:26:56)  [GCC\n                        4.6.1]\n              platform: linux2\n\nREQUIRED DEPENDENCIES\n                 numpy: 1.5.1\n             freetype2: found, but unknown version (no pkg-config)\n\nOPTIONAL BACKEND DEPENDENCIES\n                libpng: found, but unknown version (no pkg-config)\n                  Gtk+: no\n                        * Building for Gtk+ requires pygtk; you must be able\n                        * to \"import gtk\" in your build/install environment\n                    Qt: no\n                   Qt4: no\n                 Cairo: no\n\nOPTIONAL DATE/TIMEZONE DEPENDENCIES\n              datetime: present, version unknown\n              dateutil: matplotlib will provide\n                  pytz: matplotlib will provide\nadding pytz\n\nOPTIONAL USETEX DEPENDENCIES\n                dvipng: no\n           ghostscript: 8.15.3\n                 latex: no\n[...]\nbuilding 'matplotlib._png' extension\ngcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -O3 -Wall -Wstrict-prototypes -fPIC -DPY_ARRAY_UNIQUE_SYMBOL=MPL_ARRAY_API -DPYCXX_ISO_CPP_LIB=1 -I/home/buildbot/build/sage/iras-1/iras_full/build/sage-4.7.2.alpha1/local/include -I. -I/home/buildbot/build/sage/iras-1/iras_full/build/sage-4.7.2.alpha1/local/lib/python2.6/site-packages/numpy/core/include -I. -I/home/buildbot/build/sage/iras-1/iras_full/build/sage-4.7.2.alpha1/local/include/python2.6 -c src/_png.cpp -o build/temp.linux-ia64-2.6/src/_png.o\ncc1plus: warning: command line option \u2018-Wstrict-prototypes\u2019 is valid for Ada/C/ObjC but not for C++ [enabled by default]\nsrc/_png.cpp: In function \u2018void init_png()\u2019:\nsrc/_png.cpp:485:25: warning: variable \u2018_png\u2019 set but not used [-Wunused-but-set-variable]\ng++ -pthread -shared build/temp.linux-ia64-2.6/src/_png.o build/temp.linux-ia64-2.6/src/mplutils.o build/temp.linux-ia64-2.6/CXX/cxxsupport.o build/temp.linux-ia64-2.6/CXX/cxx_extensions.o build/temp.linux-ia64-2.6/CXX/IndirectPythonInterface.o build/temp.linux-ia64-2.6/CXX/cxxextensions.o -L/home/buildbot/build/sage/iras-1/iras_full/build/sage-4.7.2.alpha1/local/lib -L/home/buildbot/build/sage/iras-1/iras_full/build/sage-4.7.2.alpha1/local/lib -lpng -lz -lstdc++ -lm -lpython2.6 -o build/lib.linux-ia64-2.6/matplotlib/_png.so\n/usr/local/binutils-2.21/ia64-Linux-suse-gcc-4.5.1/bin/ld: cannot find -lpng\ncollect2: ld returned 1 exit status\nerror: command 'g++' failed with exit status 1\nError building matplotlib package.\n```\n\nFull log: [http://build.sagemath.org/sage/builders/SUSE%20ES10-64%20%28iras%29/builds/161/steps/shell_1/logs/matplotlib/text](http://build.sagemath.org/sage/builders/SUSE%20ES10-64%20%28iras%29/builds/161/steps/shell_1/logs/matplotlib/text)",
    "created_at": "2011-08-17T07:59:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128860",
    "user": "https://github.com/jdemeyer"
}
```

This fails on the buildbot machine `iras`:

```
Warning: Attempted to overwrite SAGE_ROOT environment variable
matplotlib-1.0.1.p0
Machine:
Linux iras 2.6.16.46-0.12-default #1 SMP Thu May 17 14:00:09 UTC 2007 ia64 ia64 ia64 GNU/Linux
[...]
============================================================================
BUILDING MATPLOTLIB
            matplotlib: 1.0.1
                python: 2.6.4 (r264:75706, Aug 16 2011, 18:26:56)  [GCC
                        4.6.1]
              platform: linux2

REQUIRED DEPENDENCIES
                 numpy: 1.5.1
             freetype2: found, but unknown version (no pkg-config)

OPTIONAL BACKEND DEPENDENCIES
                libpng: found, but unknown version (no pkg-config)
                  Gtk+: no
                        * Building for Gtk+ requires pygtk; you must be able
                        * to "import gtk" in your build/install environment
                    Qt: no
                   Qt4: no
                 Cairo: no

OPTIONAL DATE/TIMEZONE DEPENDENCIES
              datetime: present, version unknown
              dateutil: matplotlib will provide
                  pytz: matplotlib will provide
adding pytz

OPTIONAL USETEX DEPENDENCIES
                dvipng: no
           ghostscript: 8.15.3
                 latex: no
[...]
building 'matplotlib._png' extension
gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -O3 -Wall -Wstrict-prototypes -fPIC -DPY_ARRAY_UNIQUE_SYMBOL=MPL_ARRAY_API -DPYCXX_ISO_CPP_LIB=1 -I/home/buildbot/build/sage/iras-1/iras_full/build/sage-4.7.2.alpha1/local/include -I. -I/home/buildbot/build/sage/iras-1/iras_full/build/sage-4.7.2.alpha1/local/lib/python2.6/site-packages/numpy/core/include -I. -I/home/buildbot/build/sage/iras-1/iras_full/build/sage-4.7.2.alpha1/local/include/python2.6 -c src/_png.cpp -o build/temp.linux-ia64-2.6/src/_png.o
cc1plus: warning: command line option -Wstrict-prototypes is valid for Ada/C/ObjC but not for C++ [enabled by default]
src/_png.cpp: In function void init_png():
src/_png.cpp:485:25: warning: variable _png set but not used [-Wunused-but-set-variable]
g++ -pthread -shared build/temp.linux-ia64-2.6/src/_png.o build/temp.linux-ia64-2.6/src/mplutils.o build/temp.linux-ia64-2.6/CXX/cxxsupport.o build/temp.linux-ia64-2.6/CXX/cxx_extensions.o build/temp.linux-ia64-2.6/CXX/IndirectPythonInterface.o build/temp.linux-ia64-2.6/CXX/cxxextensions.o -L/home/buildbot/build/sage/iras-1/iras_full/build/sage-4.7.2.alpha1/local/lib -L/home/buildbot/build/sage/iras-1/iras_full/build/sage-4.7.2.alpha1/local/lib -lpng -lz -lstdc++ -lm -lpython2.6 -o build/lib.linux-ia64-2.6/matplotlib/_png.so
/usr/local/binutils-2.21/ia64-Linux-suse-gcc-4.5.1/bin/ld: cannot find -lpng
collect2: ld returned 1 exit status
error: command 'g++' failed with exit status 1
Error building matplotlib package.
```

Full log: [http://build.sagemath.org/sage/builders/SUSE%20ES10-64%20%28iras%29/builds/161/steps/shell_1/logs/matplotlib/text](http://build.sagemath.org/sage/builders/SUSE%20ES10-64%20%28iras%29/builds/161/steps/shell_1/logs/matplotlib/text)



---

archive/issue_comments_128861.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2011-08-17T07:59:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128861",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_128862.json:
```json
{
    "body": "Replying to [comment:37 jdemeyer]:\n> This fails on the buildbot machine `iras`:\n\n{{{\n...\nOPTIONAL BACKEND DEPENDENCIES\n                libpng: found, but unknown version (no pkg-config)\n...\ng++ -pthread -shared build/temp.linux-ia64-2.6/src/_png.o build/temp.linux-ia64-2.6/src/mplutils.o build/temp.linux-ia64-2.6/CXX/cxxsupport.o build/temp.linux-ia64-2.6/CXX/cxx_extensions.o build/temp.linux-ia64-2.6/CXX/IndirectPythonInterface.o build/temp.linux-ia64-2.6/CXX/cxxextensions.o -L/home/buildbot/build/sage/iras-1/iras_full/build/sage-4.7.2.alpha1/local/lib -L/home/buildbot/build/sage/iras-1/iras_full/build/sage-4.7.2.alpha1/local/lib -lpng -lz -lstdc++ -lm -lpython2.6 -o build/lib.linux-ia64-2.6/matplotlib/_png.so\n/usr/local/binutils-2.21/ia64-Linux-suse-gcc-4.5.1/bin/ld: cannot find -lpng\n}}}\n\nRead the ticket.\n\nThis is unrelated to the MPL spkg, but due to a messed-up `libpng12.pc` file.\n\nIf you first reinstall the `libpng12` spkg, and then MPL, all should work fine.\n(Or fix `local/lib/pkgconfig/libpng12.pc` manually, most probably by deleting the line `SAGE_ROOT=${SAGE_ROOT}`. Another cause can be having `PKG_CONFIG_PATH` set outside the Sage environment, which is a bug in `sage-env`, cf. also #11687.)",
    "created_at": "2011-08-17T12:36:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128862",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:37 jdemeyer]:
> This fails on the buildbot machine `iras`:

{{{
...
OPTIONAL BACKEND DEPENDENCIES
                libpng: found, but unknown version (no pkg-config)
...
g++ -pthread -shared build/temp.linux-ia64-2.6/src/_png.o build/temp.linux-ia64-2.6/src/mplutils.o build/temp.linux-ia64-2.6/CXX/cxxsupport.o build/temp.linux-ia64-2.6/CXX/cxx_extensions.o build/temp.linux-ia64-2.6/CXX/IndirectPythonInterface.o build/temp.linux-ia64-2.6/CXX/cxxextensions.o -L/home/buildbot/build/sage/iras-1/iras_full/build/sage-4.7.2.alpha1/local/lib -L/home/buildbot/build/sage/iras-1/iras_full/build/sage-4.7.2.alpha1/local/lib -lpng -lz -lstdc++ -lm -lpython2.6 -o build/lib.linux-ia64-2.6/matplotlib/_png.so
/usr/local/binutils-2.21/ia64-Linux-suse-gcc-4.5.1/bin/ld: cannot find -lpng
}}}

Read the ticket.

This is unrelated to the MPL spkg, but due to a messed-up `libpng12.pc` file.

If you first reinstall the `libpng12` spkg, and then MPL, all should work fine.
(Or fix `local/lib/pkgconfig/libpng12.pc` manually, most probably by deleting the line `SAGE_ROOT=${SAGE_ROOT}`. Another cause can be having `PKG_CONFIG_PATH` set outside the Sage environment, which is a bug in `sage-env`, cf. also #11687.)



---

archive/issue_comments_128863.json:
```json
{
    "body": "P.S.: You can also try\n\n```sh\n$ ./sage -sh -c \"pkg-config --libs libpng\"\n```\non iras, which should either raise an error, or give the wrong library, unless you fix the `.pc` file (and/or unset `PKG_CONFIG_PATH` in the \"global\" environment).",
    "created_at": "2011-08-17T12:46:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128863",
    "user": "https://github.com/nexttime"
}
```

P.S.: You can also try

```sh
$ ./sage -sh -c "pkg-config --libs libpng"
```
on iras, which should either raise an error, or give the wrong library, unless you fix the `.pc` file (and/or unset `PKG_CONFIG_PATH` in the "global" environment).



---

archive/issue_comments_128864.json:
```json
{
    "body": "Replying to [comment:38 leif]:\n> This is unrelated to the MPL spkg, but due to a messed-up `libpng12.pc` file.\n\n\nI don't have time to care where the bug is, only that the old spkg worked and the new one not.\n\nIf this new matplotlib spkg exposes a bug in the libpng spkg, then the new matplotlib spkg cannot be merged without fixing the libpng bug.\n\n```\nbuildbot@iras sage-4.7.2.alpha1$ ./sage -sh -c \"pkg-config --libs libpng\"\n\nStarting subshell with Sage environment variables set.\nBe sure to exit when you are done and do not do anything\nwith other copies of Sage!\n\nBypassing shell configuration files ...\n\nbash: pkg-config: command not found\nExited Sage subshell.\n```",
    "created_at": "2011-08-17T12:51:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128864",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:38 leif]:
> This is unrelated to the MPL spkg, but due to a messed-up `libpng12.pc` file.


I don't have time to care where the bug is, only that the old spkg worked and the new one not.

If this new matplotlib spkg exposes a bug in the libpng spkg, then the new matplotlib spkg cannot be merged without fixing the libpng bug.

```
buildbot@iras sage-4.7.2.alpha1$ ./sage -sh -c "pkg-config --libs libpng"

Starting subshell with Sage environment variables set.
Be sure to exit when you are done and do not do anything
with other copies of Sage!

Bypassing shell configuration files ...

bash: pkg-config: command not found
Exited Sage subshell.
```



---

archive/issue_comments_128865.json:
```json
{
    "body": "Replying to [comment:40 jdemeyer]:\n> Replying to [comment:38 leif]:\n> > This is unrelated to the MPL spkg, but due to a messed-up `libpng12.pc` file.\n\n> \n> I don't have time to care where the bug is,\n\n\nIt should be obvious from a first glance that we ran into similar and discussed this on the ticket here.\n\n> only that the old spkg worked and the new one not.\n\n\nThat's simply not true, or rather an incident. Reinstalling the old spkg won't work either, at least not on all systems.\n\n> If this new matplotlib spkg exposes a bug in the libpng spkg, then the new matplotlib spkg cannot be merged without fixing the libpng bug.\n\n\nPart of the bug is caused by `sage-location` (and eventually also `sage-env`). See e.g. [comment:ticket:10202:26] for how we should IMHO fix `.pc` files w.r.t. relocation.\n\nNevertheless, the `libpng12` spkg could likely create symbolic links from `local/lib/libpng.{a,la,so}`, then MPL would also find it and link to it without the help of `pkg-config`.\n\n`pkg-config` btw. should be installed on all supported platforms except Darwin.",
    "created_at": "2011-08-17T13:47:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128865",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:40 jdemeyer]:
> Replying to [comment:38 leif]:
> > This is unrelated to the MPL spkg, but due to a messed-up `libpng12.pc` file.

> 
> I don't have time to care where the bug is,


It should be obvious from a first glance that we ran into similar and discussed this on the ticket here.

> only that the old spkg worked and the new one not.


That's simply not true, or rather an incident. Reinstalling the old spkg won't work either, at least not on all systems.

> If this new matplotlib spkg exposes a bug in the libpng spkg, then the new matplotlib spkg cannot be merged without fixing the libpng bug.


Part of the bug is caused by `sage-location` (and eventually also `sage-env`). See e.g. [comment:ticket:10202:26] for how we should IMHO fix `.pc` files w.r.t. relocation.

Nevertheless, the `libpng12` spkg could likely create symbolic links from `local/lib/libpng.{a,la,so}`, then MPL would also find it and link to it without the help of `pkg-config`.

`pkg-config` btw. should be installed on all supported platforms except Darwin.



---

archive/issue_comments_128866.json:
```json
{
    "body": "Replying to [comment:41 leif]:\n> `pkg-config` btw. should be installed on all supported platforms except Darwin.\n\n\nI don't think that `pkg-config` is part of Sage's prerequisites.  This machine without `pkg-config` did manage to build earlier versions of Sage, so this new matplotlib spkg is a regression (even if the problem is not with matplotlib itself).",
    "created_at": "2011-08-17T13:58:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128866",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:41 leif]:
> `pkg-config` btw. should be installed on all supported platforms except Darwin.


I don't think that `pkg-config` is part of Sage's prerequisites.  This machine without `pkg-config` did manage to build earlier versions of Sage, so this new matplotlib spkg is a regression (even if the problem is not with matplotlib itself).



---

archive/issue_comments_128867.json:
```json
{
    "body": "Replying to [comment:41 leif]:\n> Nevertheless, the `libpng12` spkg could likely create symbolic links from `local/lib/libpng.{a,la,so}`, then MPL would also find it and link to it without the help of `pkg-config`.\n\n\nThis is now #11696.",
    "created_at": "2011-08-17T13:59:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128867",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:41 leif]:
> Nevertheless, the `libpng12` spkg could likely create symbolic links from `local/lib/libpng.{a,la,so}`, then MPL would also find it and link to it without the help of `pkg-config`.


This is now #11696.



---

archive/issue_comments_128868.json:
```json
{
    "body": "Sorry, I should have tested this on skynet.  I created a new spkg (not publicly available yet) which patches `setupext.py` on all platforms, not just Darwin.  I tried many of the skynet machines and on all of them but iras, both the old and the new spkg seem to work fine.  On iras, as Jeroen reports, the old one fails.  The new one works, though.\n\nSo I think we should apply this patch on all platforms.  That's the old behavior, after all.  Shall I post a new spkg?",
    "created_at": "2011-08-17T16:21:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128868",
    "user": "https://github.com/jhpalmieri"
}
```

Sorry, I should have tested this on skynet.  I created a new spkg (not publicly available yet) which patches `setupext.py` on all platforms, not just Darwin.  I tried many of the skynet machines and on all of them but iras, both the old and the new spkg seem to work fine.  On iras, as Jeroen reports, the old one fails.  The new one works, though.

So I think we should apply this patch on all platforms.  That's the old behavior, after all.  Shall I post a new spkg?



---

archive/issue_comments_128869.json:
```json
{
    "body": "Changing status from needs_work to needs_info.",
    "created_at": "2011-08-17T16:21:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128869",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_work to needs_info.



---

archive/issue_comments_128870.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2011-08-17T16:33:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128870",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_128871.json:
```json
{
    "body": "Since Jeroen's package supersedes mine, there is no danger for me to overwrite my version.  So here's a new spkg:\n\n- [http://sage.math.washington.edu/home/palmieri/SPKG/matplotlib-1.0.1.p0.spkg](http://sage.math.washington.edu/home/palmieri/SPKG/matplotlib-1.0.1.p0.spkg)\n\nI'm attaching the patch, too.  If this approach is acceptable, I'll change the ticket description to point at this one.",
    "created_at": "2011-08-17T16:33:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128871",
    "user": "https://github.com/jhpalmieri"
}
```

Since Jeroen's package supersedes mine, there is no danger for me to overwrite my version.  So here's a new spkg:

- [http://sage.math.washington.edu/home/palmieri/SPKG/matplotlib-1.0.1.p0.spkg](http://sage.math.washington.edu/home/palmieri/SPKG/matplotlib-1.0.1.p0.spkg)

I'm attaching the patch, too.  If this approach is acceptable, I'll change the ticket description to point at this one.



---

archive/issue_comments_128872.json:
```json
{
    "body": "Replying to [comment:45 jhpalmieri]:\n> Sorry, I should have tested this on skynet.\n\nNo need to apologize.  There is a reason we test all potential Sage releases on skynet.  We certainly do not want to burden all Sage developers with testing on skynet (most of them probably don't have access to skynet anyway).",
    "created_at": "2011-08-17T17:04:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128872",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:45 jhpalmieri]:
> Sorry, I should have tested this on skynet.

No need to apologize.  There is a reason we test all potential Sage releases on skynet.  We certainly do not want to burden all Sage developers with testing on skynet (most of them probably don't have access to skynet anyway).



---

archive/issue_comments_128873.json:
```json
{
    "body": "Replying to [comment:45 jhpalmieri]:\n> So I think we should apply this patch on all platforms.\n\n\nBut IMHO only if `pkg-config` is not available.\n\n> That's the old behavior, after all.\n\n\nWhich is a bit odd, as pointed out earlier.",
    "created_at": "2011-08-17T17:05:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128873",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:45 jhpalmieri]:
> So I think we should apply this patch on all platforms.


But IMHO only if `pkg-config` is not available.

> That's the old behavior, after all.


Which is a bit odd, as pointed out earlier.



---

archive/issue_comments_128874.json:
```json
{
    "body": "Replying to [comment:48 leif]:\n> Replying to [comment:45 jhpalmieri]:\n> > So I think we should apply this patch on all platforms.\n\n> \n> But IMHO only if `pkg-config` is not available.\n\n\nLooks as if you do that or similar (by checking for `pkg-config` in the patch itself), though the attached diff doesn't move the patch (to `setupext.py` btw., the commit message is wrong) from `patches/Darwin/` to `patches/`.\n\n\nNote that I've also made a new `libpng` spkg at #11696, which needs testing especially on Darwin.",
    "created_at": "2011-08-17T17:14:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128874",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:48 leif]:
> Replying to [comment:45 jhpalmieri]:
> > So I think we should apply this patch on all platforms.

> 
> But IMHO only if `pkg-config` is not available.


Looks as if you do that or similar (by checking for `pkg-config` in the patch itself), though the attached diff doesn't move the patch (to `setupext.py` btw., the commit message is wrong) from `patches/Darwin/` to `patches/`.


Note that I've also made a new `libpng` spkg at #11696, which needs testing especially on Darwin.



---

archive/issue_comments_128875.json:
```json
{
    "body": "Replying to [comment:49 leif]:\n> (by checking for pkg-config in the patch itself)\n\n\nAs I noted earlier, someone might install pkg-config without recompiling Sage or this spkg, so it makes sense to me to test this at run-time, not just at installation.\n\n> the attached diff doesn't move the patch (to `setupext.py` btw., the commit message is wrong) from `patches/Darwin/` to `patches/`.\n\n\nIt actually does, but it's hard to see in the patch: it's right after the header for \"spkg-install\".\n\nI'll fix the commit message, and I'll look at #11696 eventually.  It's easy enough for me to test on Darwin.",
    "created_at": "2011-08-17T17:25:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128875",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:49 leif]:
> (by checking for pkg-config in the patch itself)


As I noted earlier, someone might install pkg-config without recompiling Sage or this spkg, so it makes sense to me to test this at run-time, not just at installation.

> the attached diff doesn't move the patch (to `setupext.py` btw., the commit message is wrong) from `patches/Darwin/` to `patches/`.


It actually does, but it's hard to see in the patch: it's right after the header for "spkg-install".

I'll fix the commit message, and I'll look at #11696 eventually.  It's easy enough for me to test on Darwin.



---

archive/issue_comments_128876.json:
```json
{
    "body": "Attachment [trac_11686-iras.patch](tarball://root/attachments/some-uuid/ticket11686/trac_11686-iras.patch) by @jhpalmieri created at 2011-08-17 17:28:25\n\napplied on top of jdemeyer's spkg",
    "created_at": "2011-08-17T17:28:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128876",
    "user": "https://github.com/jhpalmieri"
}
```

Attachment [trac_11686-iras.patch](tarball://root/attachments/some-uuid/ticket11686/trac_11686-iras.patch) by @jhpalmieri created at 2011-08-17 17:28:25

applied on top of jdemeyer's spkg



---

archive/issue_comments_128877.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-08-17T17:37:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128877",
    "user": "https://github.com/nexttime"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_128878.json:
```json
{
    "body": "Changing keywords from \"\" to \"MPL Errno 14 libpng\".",
    "created_at": "2011-08-17T17:37:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128878",
    "user": "https://github.com/nexttime"
}
```

Changing keywords from "" to "MPL Errno 14 libpng".



---

archive/issue_comments_128879.json:
```json
{
    "body": "Replying to [comment:50 jhpalmieri]:\n> Replying to [comment:49 leif]:\n> > (by checking for pkg-config in the patch itself)\n\n> \n> As I noted earlier, someone might install pkg-config without recompiling Sage or this spkg, so it makes sense to me to test this at run-time, not just at installation.\n\n\nWell, the code is only executed when MPL gets installed, and the file itself doesn't get installed anywhere AFAIK.\n\n\n\n\n> > the attached diff doesn't move the patch (to `setupext.py` btw., the commit message is wrong) from `patches/Darwin/` to `patches/`.\n\n> \n> It actually does, but it's hard to see in the patch: it's right after the header for \"spkg-install\".\n\n\nI see. Also the spkg is ok, so I'll give it positive review again, also based on your comment that it works on iras (which I would expect it to anyway).\n\n\n\n\n> I'll fix the commit message, and I'll look at #11696 eventually.  It's easy enough for me to test on Darwin.\n\n\nPerhaps on some ancient Darwin systems as well if you can.",
    "created_at": "2011-08-17T17:37:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128879",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:50 jhpalmieri]:
> Replying to [comment:49 leif]:
> > (by checking for pkg-config in the patch itself)

> 
> As I noted earlier, someone might install pkg-config without recompiling Sage or this spkg, so it makes sense to me to test this at run-time, not just at installation.


Well, the code is only executed when MPL gets installed, and the file itself doesn't get installed anywhere AFAIK.




> > the attached diff doesn't move the patch (to `setupext.py` btw., the commit message is wrong) from `patches/Darwin/` to `patches/`.

> 
> It actually does, but it's hard to see in the patch: it's right after the header for "spkg-install".


I see. Also the spkg is ok, so I'll give it positive review again, also based on your comment that it works on iras (which I would expect it to anyway).




> I'll fix the commit message, and I'll look at #11696 eventually.  It's easy enough for me to test on Darwin.


Perhaps on some ancient Darwin systems as well if you can.



---

archive/issue_comments_128880.json:
```json
{
    "body": "Replying to [comment:51 leif]:\n> Perhaps on some ancient Darwin systems as well if you can.\n\n\nAnd perhaps also on iras by first installing the new libpng spkg and afterwards **your old** matplotlib spkg (the one that only applies the patch on Darwin).",
    "created_at": "2011-08-17T17:40:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128880",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:51 leif]:
> Perhaps on some ancient Darwin systems as well if you can.


And perhaps also on iras by first installing the new libpng spkg and afterwards **your old** matplotlib spkg (the one that only applies the patch on Darwin).



---

archive/issue_comments_128881.json:
```json
{
    "body": "Changing keywords from \"MPL Errno 14 libpng\" to \"MPL Errno 17 libpng\".",
    "created_at": "2011-08-17T17:42:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128881",
    "user": "https://github.com/nexttime"
}
```

Changing keywords from "MPL Errno 14 libpng" to "MPL Errno 17 libpng".



---

archive/issue_comments_128882.json:
```json
{
    "body": "I'll leave [the old SPKG](http://sage.math.washington.edu/home/palmieri/SPKG/matplotlib-1.0.1.p0.spkg.old) around for a while, in case anyone needs it.  I also just made [a version](http://sage.math.washington.edu/home/palmieri/SPKG/matplotlib-1.0.1.X.spkg) which doesn't patch setupext.py at all, to help test #11696.",
    "created_at": "2011-08-17T18:16:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128882",
    "user": "https://github.com/jhpalmieri"
}
```

I'll leave [the old SPKG](http://sage.math.washington.edu/home/palmieri/SPKG/matplotlib-1.0.1.p0.spkg.old) around for a while, in case anyone needs it.  I also just made [a version](http://sage.math.washington.edu/home/palmieri/SPKG/matplotlib-1.0.1.X.spkg) which doesn't patch setupext.py at all, to help test #11696.



---

archive/issue_comments_128883.json:
```json
{
    "body": "Is the new spkg now ready to be merged independently of #11696?",
    "created_at": "2011-08-18T12:24:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128883",
    "user": "https://github.com/jdemeyer"
}
```

Is the new spkg now ready to be merged independently of #11696?



---

archive/issue_comments_128884.json:
```json
{
    "body": "Yes, the new spkg is independent of #11696.  (One of the consequences of the changes at #11696 is to make one of the patches in the new spkg unnecessary.)",
    "created_at": "2011-08-18T15:46:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128884",
    "user": "https://github.com/jhpalmieri"
}
```

Yes, the new spkg is independent of #11696.  (One of the consequences of the changes at #11696 is to make one of the patches in the new spkg unnecessary.)



---

archive/issue_comments_128885.json:
```json
{
    "body": "Replying to [comment:55 jdemeyer]:\n> Is the new spkg now ready to be merged independently of #11696?\n\n\nYes. I just forgot to delete the work issues when giving it positive review again.\n\nI think it doesn't hurt if #11696 also (partially) fixes this in a different way, too, though, and the spkg there contains other important changes to the libpng spkg. (Currently, the latter needs work though, i.e. I have to update the spkg there, but as said, the MPL one here can be merged regardless of that.)",
    "created_at": "2011-08-18T16:30:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128885",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:55 jdemeyer]:
> Is the new spkg now ready to be merged independently of #11696?


Yes. I just forgot to delete the work issues when giving it positive review again.

I think it doesn't hurt if #11696 also (partially) fixes this in a different way, too, though, and the spkg there contains other important changes to the libpng spkg. (Currently, the latter needs work though, i.e. I have to update the spkg there, but as said, the MPL one here can be merged regardless of that.)



---

archive/issue_comments_128886.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-08-18T22:05:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128886",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_030693.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-08-18T22:05:31Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11514#event-30693"
}
```



---

archive/issue_comments_128887.json:
```json
{
    "body": "Attachment [matplotlib-1.0.1.p0.log](tarball://root/attachments/some-uuid/ticket11686/matplotlib-1.0.1.p0.log) by johanbosman created at 2011-08-30 07:39:05\n\nLog of a failed build",
    "created_at": "2011-08-30T07:39:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128887",
    "user": "https://trac.sagemath.org/admin/accounts/users/johanbosman"
}
```

Attachment [matplotlib-1.0.1.p0.log](tarball://root/attachments/some-uuid/ticket11686/matplotlib-1.0.1.p0.log) by johanbosman created at 2011-08-30 07:39:05

Log of a failed build



---

archive/issue_comments_128888.json:
```json
{
    "body": "Can this ticket be reopened again?  My build failed (see http://groups.google.com/group/sage-release/browse_thread/thread/6daea0d0dfef0562).",
    "created_at": "2011-08-30T07:40:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128888",
    "user": "https://trac.sagemath.org/admin/accounts/users/johanbosman"
}
```

Can this ticket be reopened again?  My build failed (see http://groups.google.com/group/sage-release/browse_thread/thread/6daea0d0dfef0562).



---

archive/issue_comments_128889.json:
```json
{
    "body": "Replying to [comment:59 johanbosman]:\n> Can this ticket be reopened again?  My build failed (see http://groups.google.com/group/sage-release/browse_thread/thread/6daea0d0dfef0562).\n\n\nCf. [comment:ticket:11696:11 my comment here]. (You could try building with my current libpng spkg there, though it needs work *for other constellations*.)\n\nI'd prefer opening a follow-up ticket, as this ticket has already been merged; haven't looked at your build log yet, though.",
    "created_at": "2011-08-30T12:21:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128889",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:59 johanbosman]:
> Can this ticket be reopened again?  My build failed (see http://groups.google.com/group/sage-release/browse_thread/thread/6daea0d0dfef0562).


Cf. [comment:ticket:11696:11 my comment here]. (You could try building with my current libpng spkg there, though it needs work *for other constellations*.)

I'd prefer opening a follow-up ticket, as this ticket has already been merged; haven't looked at your build log yet, though.



---

archive/issue_comments_128890.json:
```json
{
    "body": "Replying to [comment:60 leif]:\n> I'd prefer opening a follow-up ticket, as this ticket has already been merged; haven't looked at your build log yet, though.\n\n\n(And *this* ticket was intended to just fix a regression, because the first MPL 1.0.1 spkg had accidentally been based on an obsolete one; therefore its title.)",
    "created_at": "2011-08-30T12:26:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128890",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:60 leif]:
> I'd prefer opening a follow-up ticket, as this ticket has already been merged; haven't looked at your build log yet, though.


(And *this* ticket was intended to just fix a regression, because the first MPL 1.0.1 spkg had accidentally been based on an obsolete one; therefore its title.)



---

archive/issue_comments_128891.json:
```json
{
    "body": "Okay, we'll move the discussion somewhere else then. ;).",
    "created_at": "2011-08-30T12:35:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128891",
    "user": "https://trac.sagemath.org/admin/accounts/users/johanbosman"
}
```

Okay, we'll move the discussion somewhere else then. ;).



---

archive/issue_comments_128892.json:
```json
{
    "body": "Apparently MPL has problems using your `pkg-config`, for whatever reason...:\n\n```\n...\nREQUIRED DEPENDENCIES\n                 numpy: 1.5.1\n             freetype2: found, but unknown version (no pkg-config)\n\nOPTIONAL BACKEND DEPENDENCIES\n                libpng: found, but unknown version (no pkg-config)\n...\n```\n\nThe patched `setupext.py` in contrast seems to find it, and therefore disables the work-around for when `pkg-config` is *not* installed.\n\n(The note *\"(no pkg-config)\"* also appears if `pkg-config` **is** installed, but unable to read the `.pc` file, e.g. because of duplicate definitions of `SAGE_ROOT` in it.)",
    "created_at": "2011-08-30T12:52:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128892",
    "user": "https://github.com/nexttime"
}
```

Apparently MPL has problems using your `pkg-config`, for whatever reason...:

```
...
REQUIRED DEPENDENCIES
                 numpy: 1.5.1
             freetype2: found, but unknown version (no pkg-config)

OPTIONAL BACKEND DEPENDENCIES
                libpng: found, but unknown version (no pkg-config)
...
```

The patched `setupext.py` in contrast seems to find it, and therefore disables the work-around for when `pkg-config` is *not* installed.

(The note *"(no pkg-config)"* also appears if `pkg-config` **is** installed, but unable to read the `.pc` file, e.g. because of duplicate definitions of `SAGE_ROOT` in it.)



---

archive/issue_comments_128893.json:
```json
{
    "body": "Johan, please install [this spkg](http://sage.math.washington.edu/home/leif/Sage/spkgs/matplotlib-1.0.1.p0-debug.spkg) (which provides some debugging output, not trying to fix anything yet), and inspect the top of the install log (only up to *\"[Edit setup.cfg to suppress the above messages]\"* if it fails, which I expect it to).\n\nThanks.\n\n(I think I now know where the problem lies. :) )",
    "created_at": "2011-08-30T15:49:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128893",
    "user": "https://github.com/nexttime"
}
```

Johan, please install [this spkg](http://sage.math.washington.edu/home/leif/Sage/spkgs/matplotlib-1.0.1.p0-debug.spkg) (which provides some debugging output, not trying to fix anything yet), and inspect the top of the install log (only up to *"[Edit setup.cfg to suppress the above messages]"* if it fails, which I expect it to).

Thanks.

(I think I now know where the problem lies. :) )



---

archive/issue_comments_128894.json:
```json
{
    "body": "How do I install this?",
    "created_at": "2011-08-30T16:11:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128894",
    "user": "https://trac.sagemath.org/admin/accounts/users/johanbosman"
}
```

How do I install this?



---

archive/issue_comments_128895.json:
```json
{
    "body": "Replying to [comment:65 johanbosman]:\n> How do I install this?\n\n\nFor example by typing\n\n```sh\n$ ./sage -f http://sage.math.washington.edu/home/leif/Sage/spkgs/matplotlib-1.0.1.p0-debug.spkg\n```\nin your `SAGE_ROOT` directory. (Or download it manually with your favourite program and pass the local filename to `./sage -f ...`.)",
    "created_at": "2011-08-30T16:23:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128895",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:65 johanbosman]:
> How do I install this?


For example by typing

```sh
$ ./sage -f http://sage.math.washington.edu/home/leif/Sage/spkgs/matplotlib-1.0.1.p0-debug.spkg
```
in your `SAGE_ROOT` directory. (Or download it manually with your favourite program and pass the local filename to `./sage -f ...`.)



---

archive/issue_comments_128896.json:
```json
{
    "body": "The point is that Sage did not build.  Or is it okay for this purpose to use another version of Sage?",
    "created_at": "2011-08-30T16:29:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128896",
    "user": "https://trac.sagemath.org/admin/accounts/users/johanbosman"
}
```

The point is that Sage did not build.  Or is it okay for this purpose to use another version of Sage?



---

archive/issue_comments_128897.json:
```json
{
    "body": "Replying to [comment:67 johanbosman]:\n> The point is that Sage did not build.  Or is it okay for this purpose to use another version of Sage?\n\n\nThis AFAIK shouldn't matter (that Sage didn't build), but I'm not totally sure.\n\nSince I assume previous versions of Sage did build for you on that machine (with an older MPL spkg), I'd use the Sage installation where it failed (i.e., Sage 4.7.2.alpha2), since the error might (at least in theory) originate from something else.\n\nTo be on the safe side, copy the downloaded package to `$SAGE_ROOT/spkg/standard/` and (re)run `make`. Then Sage *should<sup>TM</sup>* pick up the new spkg with debugging. The log is then `spkg/logs/matplotlib-1.0.1.p0-debug.log`.\n\n(In case Sage *doesn't* pick up the right one, which I don't think, you could (re)move the original MPL spkg from there. A matter of file modification times, so you could equally just `touch` the new spkg.)\n\nTo see in advance which version Sage would install, do\n\n```sh\n$ (cd $SAGE_ROOT/spkg/standard/ && ./newest_version matplotlib)\n```",
    "created_at": "2011-08-30T16:49:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128897",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:67 johanbosman]:
> The point is that Sage did not build.  Or is it okay for this purpose to use another version of Sage?


This AFAIK shouldn't matter (that Sage didn't build), but I'm not totally sure.

Since I assume previous versions of Sage did build for you on that machine (with an older MPL spkg), I'd use the Sage installation where it failed (i.e., Sage 4.7.2.alpha2), since the error might (at least in theory) originate from something else.

To be on the safe side, copy the downloaded package to `$SAGE_ROOT/spkg/standard/` and (re)run `make`. Then Sage *should<sup>TM</sup>* pick up the new spkg with debugging. The log is then `spkg/logs/matplotlib-1.0.1.p0-debug.log`.

(In case Sage *doesn't* pick up the right one, which I don't think, you could (re)move the original MPL spkg from there. A matter of file modification times, so you could equally just `touch` the new spkg.)

To see in advance which version Sage would install, do

```sh
$ (cd $SAGE_ROOT/spkg/standard/ && ./newest_version matplotlib)
```



---

archive/issue_comments_128898.json:
```json
{
    "body": "Thanks for explaining.  I'm trying to build it now. ;)",
    "created_at": "2011-08-30T16:58:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128898",
    "user": "https://trac.sagemath.org/admin/accounts/users/johanbosman"
}
```

Thanks for explaining.  I'm trying to build it now. ;)



---

archive/issue_comments_128899.json:
```json
{
    "body": "Hmm, I tried to upload the top of the build log, but I got an error message:\n\nIOError: [Errno 28] No space left on device\n\nAny suggestions?",
    "created_at": "2011-08-30T18:41:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128899",
    "user": "https://trac.sagemath.org/admin/accounts/users/johanbosman"
}
```

Hmm, I tried to upload the top of the build log, but I got an error message:

IOError: [Errno 28] No space left on device

Any suggestions?



---

archive/issue_comments_128900.json:
```json
{
    "body": "Replying to [comment:70 johanbosman]:\n> Hmm, I tried to upload the top of the build log, but I got an error message:\n> \n> IOError: [Errno 28] No space left on device\n\n\nTo trac?\n\nI didn't think of the (full) MPL log (which you attached) being that large btw.\n\n> Any suggestions?\n\n\nTry replacing the already attached one with the newer, smaller one. Requires it having the same filename of course.\n\nOr upload it onto `sage.math` and provide a link. If it's not too long, you could also quote it here in a comment (in a \"code block\").\n\nOr mail it to me (notdotreallyatonlinedotde, replacing the obvious), then I can upload it to `sage.math`.",
    "created_at": "2011-08-30T19:00:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128900",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:70 johanbosman]:
> Hmm, I tried to upload the top of the build log, but I got an error message:
> 
> IOError: [Errno 28] No space left on device


To trac?

I didn't think of the (full) MPL log (which you attached) being that large btw.

> Any suggestions?


Try replacing the already attached one with the newer, smaller one. Requires it having the same filename of course.

Or upload it onto `sage.math` and provide a link. If it's not too long, you could also quote it here in a comment (in a "code block").

Or mail it to me (notdotreallyatonlinedotde, replacing the obvious), then I can upload it to `sage.math`.



---

archive/issue_comments_128901.json:
```json
{
    "body": "Hahaha, my guess was right:\n\n```\n...\nhas_pkgconfig(): trying 'pkg-config --help'...\nhas_pkgconfig(): command exited with 34304.\nOutput is:\nUsage: pkg-config [OPTION...]\n  --version                                      output version of pkg-config\n  --modversion                                   output version for package\n  --atleast-pkgconfig-version=VERSION            sh: line 1: 16589 Abort trap              pkg-config --help\nhas_pkgconfig(): returning False.\n...\nadd_png_flags(): Sage: 'pkg-config' is in PATH, not trying to use work-around.\n...\n```\n\nJohan, can you give the output of\n\n```sh\n$ pkg-config --version ; echo $?\n\n$ pkg-config --help ; echo $?\n\n```\n?",
    "created_at": "2011-08-30T19:59:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128901",
    "user": "https://github.com/nexttime"
}
```

Hahaha, my guess was right:

```
...
has_pkgconfig(): trying 'pkg-config --help'...
has_pkgconfig(): command exited with 34304.
Output is:
Usage: pkg-config [OPTION...]
  --version                                      output version of pkg-config
  --modversion                                   output version for package
  --atleast-pkgconfig-version=VERSION            sh: line 1: 16589 Abort trap              pkg-config --help
has_pkgconfig(): returning False.
...
add_png_flags(): Sage: 'pkg-config' is in PATH, not trying to use work-around.
...
```

Johan, can you give the output of

```sh
$ pkg-config --version ; echo $?

$ pkg-config --help ; echo $?

```
?



---

archive/issue_comments_128902.json:
```json
{
    "body": "Replying to [comment:72 leif]:\n> Hahaha, my guess was right:\n\n{{{\n...\nhas_pkgconfig(): trying 'pkg-config --help'...\nhas_pkgconfig(): command exited with 34304.\n...\nhas_pkgconfig(): returning False.\n...\nadd_png_flags(): Sage: 'pkg-config' is in PATH, not trying to use work-around.\n...\n}}}\n\nFor the record, I have a [(preliminary) MPL 1.0.1.p1 spkg](http://sage.math.washington.edu/home/leif/Sage/spkgs/matplotlib-1.0.1.p1.spkg) fixing this, which Johan already tested.\n\n(Cf. [http://groups.google.com/group/sage-release/msg/49a4ded0bc168976](http://groups.google.com/group/sage-release/msg/49a4ded0bc168976).)\n\nI'll open a follow-up for that one at some uncertain point in the future... (Remind me of that in case nothing should happen for a while.) ;-)",
    "created_at": "2011-08-31T18:41:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128902",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:72 leif]:
> Hahaha, my guess was right:

{{{
...
has_pkgconfig(): trying 'pkg-config --help'...
has_pkgconfig(): command exited with 34304.
...
has_pkgconfig(): returning False.
...
add_png_flags(): Sage: 'pkg-config' is in PATH, not trying to use work-around.
...
}}}

For the record, I have a [(preliminary) MPL 1.0.1.p1 spkg](http://sage.math.washington.edu/home/leif/Sage/spkgs/matplotlib-1.0.1.p1.spkg) fixing this, which Johan already tested.

(Cf. [http://groups.google.com/group/sage-release/msg/49a4ded0bc168976](http://groups.google.com/group/sage-release/msg/49a4ded0bc168976).)

I'll open a follow-up for that one at some uncertain point in the future... (Remind me of that in case nothing should happen for a while.) ;-)



---

archive/issue_comments_128903.json:
```json
{
    "body": "*Some* follow-up, for upgrading to MPL 1.1.0: #11915",
    "created_at": "2011-10-11T14:26:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11514#issuecomment-128903",
    "user": "https://github.com/nexttime"
}
```

*Some* follow-up, for upgrading to MPL 1.1.0: #11915
