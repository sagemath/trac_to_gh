# Issue 11818: sage <script> does not run sage-cleaner

archive/issues_011646.json:
```json
{
    "body": "When you are running a long computation, you are probably putting your sage program in a `script.sage` file and then run `sage script.sage` in a screen'ed terminal. In that case, `sage-cleaner` is not run. So if you use `@`parallel, each fork creates a new subdirectory `$DOT_SAGE/temp/hostname/pid` that is not being cleaned up. This can easily reach a limit of the file system, for example ext2/ext3 are limited to 2<sup>15</sup>  subdirectories per directory.\n\nA typical error message then looks like\n\n```\n[Errno 31] Too many links: '/home/vbraun/.sage//temp/hostname/26457/'\n```\n\nApply [attachment:trac_11818_run_sage_setup.patch] to the sage-scripts repository ($SAGE_LOCAL/bin)\n\n**Resolution:** fixed\n\n**Author:** John Palmieri\n\n**Reviewer:** Volker Braun\n\n**Merged:** sage-4.7.2.alpha3\n\nIssue created by migration from https://trac.sagemath.org/ticket/11818\n\n",
    "closed_at": "2011-09-27T17:39:01Z",
    "created_at": "2011-09-20T16:51:47Z",
    "labels": [
        "component: scripts",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.7.2",
    "title": "sage <script> does not run sage-cleaner",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11818",
    "user": "https://github.com/vbraun"
}
```
When you are running a long computation, you are probably putting your sage program in a `script.sage` file and then run `sage script.sage` in a screen'ed terminal. In that case, `sage-cleaner` is not run. So if you use `@`parallel, each fork creates a new subdirectory `$DOT_SAGE/temp/hostname/pid` that is not being cleaned up. This can easily reach a limit of the file system, for example ext2/ext3 are limited to 2<sup>15</sup>  subdirectories per directory.

A typical error message then looks like

```
[Errno 31] Too many links: '/home/vbraun/.sage//temp/hostname/26457/'
```

Apply [attachment:trac_11818_run_sage_setup.patch] to the sage-scripts repository ($SAGE_LOCAL/bin)

**Resolution:** fixed

**Author:** John Palmieri

**Reviewer:** Volker Braun

**Merged:** sage-4.7.2.alpha3

Issue created by migration from https://trac.sagemath.org/ticket/11818





---

archive/issue_comments_166770.json:
```json
{
    "body": "<a id='comment:1'></a>\nSteps to reproduce:\n\n```sh\n[vbraun@volker-desktop ~]$ ls ~/.sage/temp/volker_desktop.stp.dias.ie/ | wc\n      0       0       0\n[vbraun@volker-desktop ~]$ cat > script.sage <<EOF\n@parallel(verbose=True)\ndef f(i):\n    return i\n\nlist(f(range(0,100)))\nEOF\n[vbraun@volker-desktop ~]$ sage script.sage\n[vbraun@volker-desktop ~]$ ls ~/.sage/temp/volker_desktop.stp.dias.ie/ | wc\n    101     101     505\n```",
    "created_at": "2011-09-20T16:59:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11818",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11818#issuecomment-166770",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:1'></a>
Steps to reproduce:

```sh
[vbraun@volker-desktop ~]$ ls ~/.sage/temp/volker_desktop.stp.dias.ie/ | wc
      0       0       0
[vbraun@volker-desktop ~]$ cat > script.sage <<EOF
@parallel(verbose=True)
def f(i):
    return i

list(f(range(0,100)))
EOF
[vbraun@volker-desktop ~]$ sage script.sage
[vbraun@volker-desktop ~]$ ls ~/.sage/temp/volker_desktop.stp.dias.ie/ | wc
    101     101     505
```



---

archive/issue_comments_166771.json:
```json
{
    "body": "<a id='comment:2'></a>\nIs a change like this good enough?\n\n```diff\ndiff --git a/sage-sage b/sage-sage\n--- a/sage-sage\n+++ b/sage-sage\n@@ -1021,6 +1021,7 @@ if [ $# -ge 1 ]; then\n        exit $?\n    fi\n    cd \"$SAGE_LOCAL/bin/\"\n+   SAGE_BANNER=\"no\" sage_setup\n    sage-run \"$CUR\" \"$@\"\n    exit $?\n fi\n```",
    "created_at": "2011-09-20T17:59:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11818",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11818#issuecomment-166771",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:2'></a>
Is a change like this good enough?

```diff
diff --git a/sage-sage b/sage-sage
--- a/sage-sage
+++ b/sage-sage
@@ -1021,6 +1021,7 @@ if [ $# -ge 1 ]; then
        exit $?
    fi
    cd "$SAGE_LOCAL/bin/"
+   SAGE_BANNER="no" sage_setup
    sage-run "$CUR" "$@"
    exit $?
 fi
```



---

archive/issue_comments_166772.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2011-09-20T19:52:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11818",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11818#issuecomment-166772",
    "user": "https://github.com/vbraun"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_166773.json:
```json
{
    "body": "**Author:** John Palmieri",
    "created_at": "2011-09-20T19:52:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11818",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11818#issuecomment-166773",
    "user": "https://github.com/vbraun"
}
```

**Author:** John Palmieri



---

archive/issue_comments_166774.json:
```json
{
    "body": "<a id='comment:3'></a>\nYes, that is it!",
    "created_at": "2011-09-20T19:52:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11818",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11818#issuecomment-166774",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:3'></a>
Yes, that is it!



---

archive/issue_comments_166775.json:
```json
{
    "body": "John's patch",
    "created_at": "2011-09-20T19:55:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11818",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11818#issuecomment-166775",
    "user": "https://github.com/vbraun"
}
```

John's patch



---

archive/issue_comments_166776.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2011-09-20T19:55:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11818",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11818#issuecomment-166776",
    "user": "https://github.com/vbraun"
}
```

**Changing status** from needs_review to positive_review.



---

archive/attachments_015682.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_11818_run_sage_setup.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket11818/trac_11818_run_sage_setup.patch",
    "created_at": "2011-09-20T19:55:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11818",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/vbraun"
}
```



---

archive/issue_comments_166777.json:
```json
{
    "body": "<a id='comment:4'></a>\nI am giving this positive review :-)",
    "created_at": "2011-09-20T19:55:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11818",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11818#issuecomment-166777",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:4'></a>
I am giving this positive review :-)



---

archive/issue_comments_166778.json:
```json
{
    "body": "**Reviewer:** Volker Braun",
    "created_at": "2011-09-20T19:55:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11818",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11818#issuecomment-166778",
    "user": "https://github.com/vbraun"
}
```

**Reviewer:** Volker Braun



---

archive/issue_comments_166779.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -6,3 +6,4 @@\n [Errno 31] Too many links: '/home/vbraun/.sage//temp/hostname/26457/'\n ```\n \n+Apply trac_11818_run_sage_setup.patch to the sage-scripts repository ($SAGE_LOCAL/bin)\n``````\n",
    "created_at": "2011-09-20T19:56:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11818",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11818#issuecomment-166779",
    "user": "https://github.com/vbraun"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -6,3 +6,4 @@
 [Errno 31] Too many links: '/home/vbraun/.sage//temp/hostname/26457/'
 ```
 
+Apply trac_11818_run_sage_setup.patch to the sage-scripts repository ($SAGE_LOCAL/bin)
``````




---

archive/issue_comments_166780.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -6,4 +6,4 @@\n [Errno 31] Too many links: '/home/vbraun/.sage//temp/hostname/26457/'\n ```\n \n-Apply trac_11818_run_sage_setup.patch to the sage-scripts repository ($SAGE_LOCAL/bin)\n+Apply [attachment:trac_11818_run_sage_setup.patch] to the sage-scripts repository ($SAGE_LOCAL/bin)\n``````\n",
    "created_at": "2011-09-20T20:06:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11818",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11818#issuecomment-166780",
    "user": "https://github.com/jhpalmieri"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -6,4 +6,4 @@
 [Errno 31] Too many links: '/home/vbraun/.sage//temp/hostname/26457/'
 ```
 
-Apply trac_11818_run_sage_setup.patch to the sage-scripts repository ($SAGE_LOCAL/bin)
+Apply [attachment:trac_11818_run_sage_setup.patch] to the sage-scripts repository ($SAGE_LOCAL/bin)
``````




---

archive/issue_comments_166781.json:
```json
{
    "body": "<a id='comment:7'></a>\nI'll see if I can include this patch bomb into Sage 4.7.2.alpha3...",
    "created_at": "2011-09-20T20:34:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11818",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11818#issuecomment-166781",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:7'></a>
I'll see if I can include this patch bomb into Sage 4.7.2.alpha3...



---

archive/issue_comments_166782.json:
```json
{
    "body": "<a id='comment:8'></a>\nP.S.:\n\nSome doctest in `sage/parallel/*` analoguous to what Volker did wouldn't be bad.",
    "created_at": "2011-09-20T20:37:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11818",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11818#issuecomment-166782",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:8'></a>
P.S.:

Some doctest in `sage/parallel/*` analoguous to what Volker did wouldn't be bad.



---

archive/issue_comments_166783.json:
```json
{
    "body": "<a id='comment:9'></a>\nBut during parallel doctests there should be a large and fluctuating number of directories in the temp dir. So I don't see an easy way of testing this...",
    "created_at": "2011-09-20T20:40:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11818",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11818#issuecomment-166783",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:9'></a>
But during parallel doctests there should be a large and fluctuating number of directories in the temp dir. So I don't see an easy way of testing this...



---

archive/issue_comments_166784.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [leif](#comment%3A8):\n> P.S.:\n> \n> Some doctest in `sage/parallel/*` analoguous to what Volker did wouldn't be bad.\n\n\n... which perhaps isn't *that* easy.",
    "created_at": "2011-09-20T20:42:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11818",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11818#issuecomment-166784",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:10'></a>
Replying to [leif](#comment%3A8):
> P.S.:
> 
> Some doctest in `sage/parallel/*` analoguous to what Volker did wouldn't be bad.


... which perhaps isn't *that* easy.



---

archive/issue_comments_166785.json:
```json
{
    "body": "<a id='comment:11'></a>\nI had an idea how to doctest this, but it passes doctests regardless of whether the patch here has been applied.  I'll post it here in case you have any suggestions.",
    "created_at": "2011-09-20T21:11:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11818",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11818#issuecomment-166785",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:11'></a>
I had an idea how to doctest this, but it passes doctests regardless of whether the patch here has been applied.  I'll post it here in case you have any suggestions.



---

archive/issue_comments_166786.json:
```json
{
    "body": "for Sage library, but currently not working properly",
    "created_at": "2011-09-20T21:12:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11818",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11818#issuecomment-166786",
    "user": "https://github.com/jhpalmieri"
}
```

for Sage library, but currently not working properly



---

archive/attachments_015683.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_11818-experimental.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket11818/trac_11818-experimental.patch",
    "created_at": "2011-09-20T21:17:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11818",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/vbraun"
}
```



---

archive/issue_comments_166787.json:
```json
{
    "body": "<a id='comment:12'></a>\nWhen you are doctesting this, the sage-cleaner was already started by the doctesting process. In a single-threaded doctest you could kill the sage-cleaner and check that it is being restarted, but with parallel testing that would just be a race condition.",
    "created_at": "2011-09-20T21:17:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11818",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11818#issuecomment-166787",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:12'></a>
When you are doctesting this, the sage-cleaner was already started by the doctesting process. In a single-threaded doctest you could kill the sage-cleaner and check that it is being restarted, but with parallel testing that would just be a race condition.



---

archive/issue_comments_166788.json:
```json
{
    "body": "<a id='comment:13'></a>\nReplying to [vbraun](#comment%3A12):\n> When you are doctesting this, the sage-cleaner was already started by the doctesting process.\n\n\nRight, I was just coming to the same conclusion, although I'm not sure where sage-cleaner is actually started when you run \"sage -t FILE\".\n\nIn any case, it looks difficult, or at least annoying, to test this from within Sage's doctesting framework.",
    "created_at": "2011-09-20T21:26:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11818",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11818#issuecomment-166788",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:13'></a>
Replying to [vbraun](#comment%3A12):
> When you are doctesting this, the sage-cleaner was already started by the doctesting process.


Right, I was just coming to the same conclusion, although I'm not sure where sage-cleaner is actually started when you run "sage -t FILE".

In any case, it looks difficult, or at least annoying, to test this from within Sage's doctesting framework.



---

archive/issue_comments_166789.json:
```json
{
    "body": "**Merged:** sage-4.7.2.alpha3",
    "created_at": "2011-09-27T17:39:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11818",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11818#issuecomment-166789",
    "user": "https://github.com/nexttime"
}
```

**Merged:** sage-4.7.2.alpha3



---

archive/issue_events_036801.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2011-09-27T17:39:01Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/11818",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11818#event-36801"
}
```



---

archive/issue_comments_166790.json:
```json
{
    "body": "**Resolution:** fixed",
    "created_at": "2011-09-27T17:39:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11818",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11818#issuecomment-166790",
    "user": "https://github.com/nexttime"
}
```

**Resolution:** fixed
