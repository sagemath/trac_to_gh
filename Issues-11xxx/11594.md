# Issue 11594: fast_callable always segfaults when input is a polynomial of large degree

archive/issues_011594.json:
```json
{
    "body": "Assignee: @aghitza\n\nCC:  @jasongrout\n\nThe `fast_callable` function is great -- perfect for the application I had in mind, which was running Newton-Raphson on a polynomial of large degree.  Unfortunately, it seems `fast_callable` is implemented recursively, and maybe \"blows the stack\" as soon as the degree of the input gets large.   Here's an example, which fails on both 64-bit Linux *and* OS X:\n\n```\nsage: R.<x> = CC[];  f = R.random_element(degree=30000)\nsage:  time g = fast_callable(f, CC)                   \n/home/wstein/sage/sage-4.7.2.alpha2/local/bin/sage-sage: line 301: 15849 Segmentation fault      sage-ipython \"$@\" -i\n```\n\nIssue created by migration from https://trac.sagemath.org/ticket/11766\n\n",
    "closed_at": "2012-03-28T10:03:18Z",
    "created_at": "2011-08-31T18:46:05Z",
    "labels": [
        "component: basic arithmetic",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.0",
    "title": "fast_callable always segfaults when input is a polynomial of large degree",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11594",
    "user": "https://github.com/williamstein"
}
```
Assignee: @aghitza

CC:  @jasongrout

The `fast_callable` function is great -- perfect for the application I had in mind, which was running Newton-Raphson on a polynomial of large degree.  Unfortunately, it seems `fast_callable` is implemented recursively, and maybe "blows the stack" as soon as the degree of the input gets large.   Here's an example, which fails on both 64-bit Linux *and* OS X:

```
sage: R.<x> = CC[];  f = R.random_element(degree=30000)
sage:  time g = fast_callable(f, CC)                   
/home/wstein/sage/sage-4.7.2.alpha2/local/bin/sage-sage: line 301: 15849 Segmentation fault      sage-ipython "$@" -i
```

Issue created by migration from https://trac.sagemath.org/ticket/11766





---

archive/issue_comments_130493.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-09-02T07:29:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11594#issuecomment-130493",
    "user": "https://github.com/robertwb"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_130494.json:
```json
{
    "body": "Note that fast_callable(f, CDF) will produce a much faster evaluating expression.",
    "created_at": "2011-09-02T07:29:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11594#issuecomment-130494",
    "user": "https://github.com/robertwb"
}
```

Note that fast_callable(f, CDF) will produce a much faster evaluating expression.



---

archive/issue_comments_130495.json:
```json
{
    "body": "From Robert Bradshaw: \"Ugh. I didn't write that version of the code, but yes, it, it'll blow\nthe stack. (Incidentally, I remember running into very similar issues\nto #11767 refereeing some similar code over the reals...)\"",
    "created_at": "2011-09-27T01:31:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11594#issuecomment-130495",
    "user": "https://github.com/williamstein"
}
```

From Robert Bradshaw: "Ugh. I didn't write that version of the code, but yes, it, it'll blow
the stack. (Incidentally, I remember running into very similar issues
to #11767 refereeing some similar code over the reals...)"



---

archive/issue_comments_130496.json:
```json
{
    "body": "This works as advertised, but is slow on large input.  I'd like to use fast_callable with / instead of polynomial_compiled, but that doesn't look promising so far since it takes so long to build the fast_callable.  \n\n```\nsage: R.<x> = CC[];  f = R.random_element(degree=600000)\nsage: time f(1)\n63.7162567572333 - 243.107542673361*I\nTime: CPU 1.62 s, Wall: 1.62 s\nsage: time f(1)\n63.7162567572333 - 243.107542673361*I\nTime: CPU 1.59 s, Wall: 1.60 s\nsage: time g = fast_callable(f,CC)\nTime: CPU 32.33 s, Wall: 32.41 s\nsage: time g(1)\n63.7162567572333 - 243.107542673361*I\nTime: CPU 0.74 s, Wall: 0.74 s\n```\n\n\nHere's a slightly more reasonable example.\n\n```\nsage: R.<x> = CC[];  f = R.random_element(degree=20000)\nsage: time f(1)                                        \n67.4816349551299 + 91.7847423047406*I\nTime: CPU 0.09 s, Wall: 0.09 s\nsage: time f(1)                                        \n67.4816349551299 + 91.7847423047406*I\nTime: CPU 0.05 s, Wall: 0.06 s\nsage: time g = fast_callable(f,CC)                     \nTime: CPU 0.38 s, Wall: 0.38 s\nsage: time g(1)                                        \n67.4816349551299 + 91.7847423047406*I\nTime: CPU 0.04 s, Wall: 0.04 s\nsage: \n```\n\nThis is not significantly slower than the old version, so I'm accepting the patch",
    "created_at": "2012-03-20T18:38:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11594#issuecomment-130496",
    "user": "https://trac.sagemath.org/admin/accounts/users/boothby"
}
```

This works as advertised, but is slow on large input.  I'd like to use fast_callable with / instead of polynomial_compiled, but that doesn't look promising so far since it takes so long to build the fast_callable.  

```
sage: R.<x> = CC[];  f = R.random_element(degree=600000)
sage: time f(1)
63.7162567572333 - 243.107542673361*I
Time: CPU 1.62 s, Wall: 1.62 s
sage: time f(1)
63.7162567572333 - 243.107542673361*I
Time: CPU 1.59 s, Wall: 1.60 s
sage: time g = fast_callable(f,CC)
Time: CPU 32.33 s, Wall: 32.41 s
sage: time g(1)
63.7162567572333 - 243.107542673361*I
Time: CPU 0.74 s, Wall: 0.74 s
```


Here's a slightly more reasonable example.

```
sage: R.<x> = CC[];  f = R.random_element(degree=20000)
sage: time f(1)                                        
67.4816349551299 + 91.7847423047406*I
Time: CPU 0.09 s, Wall: 0.09 s
sage: time f(1)                                        
67.4816349551299 + 91.7847423047406*I
Time: CPU 0.05 s, Wall: 0.06 s
sage: time g = fast_callable(f,CC)                     
Time: CPU 0.38 s, Wall: 0.38 s
sage: time g(1)                                        
67.4816349551299 + 91.7847423047406*I
Time: CPU 0.04 s, Wall: 0.04 s
sage: 
```

This is not significantly slower than the old version, so I'm accepting the patch



---

archive/issue_comments_130497.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-03-20T18:38:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11594#issuecomment-130497",
    "user": "https://trac.sagemath.org/admin/accounts/users/boothby"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_130498.json:
```json
{
    "body": "BTW, there's some fuzz:\n\n```\n~/Desktop/sage-4.8/devel/sage/sage$ hg qpush\napplying 11766-fast-callable-stack-smash.patch\npatching file sage/ext/fast_callable.pyx\nHunk #2 succeeded at 1555 with fuzz 2 (offset 3 lines).\nnow at: 11766-fast-callable-stack-smash.patch\n```",
    "created_at": "2012-03-20T18:42:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11594#issuecomment-130498",
    "user": "https://trac.sagemath.org/admin/accounts/users/boothby"
}
```

BTW, there's some fuzz:

```
~/Desktop/sage-4.8/devel/sage/sage$ hg qpush
applying 11766-fast-callable-stack-smash.patch
patching file sage/ext/fast_callable.pyx
Hunk #2 succeeded at 1555 with fuzz 2 (offset 3 lines).
now at: 11766-fast-callable-stack-smash.patch
```



---

archive/issue_comments_130499.json:
```json
{
    "body": "Attachment [11766-fast-callable-stack-smash-4.8nofuzz.patch](tarball://root/attachments/some-uuid/ticket11766/11766-fast-callable-stack-smash-4.8nofuzz.patch) by @jdemeyer created at 2012-03-20 22:31:10",
    "created_at": "2012-03-20T22:31:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11594#issuecomment-130499",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [11766-fast-callable-stack-smash-4.8nofuzz.patch](tarball://root/attachments/some-uuid/ticket11766/11766-fast-callable-stack-smash-4.8nofuzz.patch) by @jdemeyer created at 2012-03-20 22:31:10



---

archive/issue_comments_130500.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-03-28T10:03:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11594",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11594#issuecomment-130500",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_030949.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-03-28T10:03:18Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/11594",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11594#event-30949"
}
```
