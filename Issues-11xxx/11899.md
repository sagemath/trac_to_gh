# Issue 11899: Add #long time at various places

archive/issues_011727.json:
```json
{
    "body": "Throughout Sage, there are a few doctests taking a very long time (more than 30 seconds) but sometimes these can easily be simplified to take less time.  Also add `# long time` where needed.\n\n---\n\nApply\n\n1. [attachment:11899_2.patch]\n\nto the sage repository\n\n**Assignee:** mvngu\n\n**CC:**  @nexttime\n\n**Keywords:** sd35\n\n**Author:** Jeroen Demeyer\n\n**Reviewer:** Julian Rueth\n\n**Merged:** sage-4.8.alpha5\n\nIssue created by migration from https://trac.sagemath.org/ticket/11899\n\n",
    "closed_at": "2011-12-22T13:05:45Z",
    "created_at": "2011-10-05T08:35:31Z",
    "labels": [
        "component: doctest coverage",
        "minor",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.8",
    "title": "Add #long time at various places",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11899",
    "user": "https://github.com/jdemeyer"
}
```
Throughout Sage, there are a few doctests taking a very long time (more than 30 seconds) but sometimes these can easily be simplified to take less time.  Also add `# long time` where needed.

---

Apply

1. [attachment:11899_2.patch]

to the sage repository

**Assignee:** mvngu

**CC:**  @nexttime

**Keywords:** sd35

**Author:** Jeroen Demeyer

**Reviewer:** Julian Rueth

**Merged:** sage-4.8.alpha5

Issue created by migration from https://trac.sagemath.org/ticket/11899





---

archive/issue_comments_156785.json:
```json
{
    "body": "<a id='comment:1'></a>\nAnd on some machines the PExpect interfaces are very slow, or frequently hang...\n(There's some ticket by Simon King alleviating this in a couple of cases; don't recall the ticket number right now.)\n\nSlightly related: We should IMHO make it such that the timeouts for doctests (perhaps optionally, or in addition) do not refer to wall but actual CPU time, since often doctests timeout just because they don't get enough CPU when doctesting with (more or less) many threads [and] on an already loaded machine.",
    "created_at": "2011-10-05T10:26:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11899#issuecomment-156785",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:1'></a>
And on some machines the PExpect interfaces are very slow, or frequently hang...
(There's some ticket by Simon King alleviating this in a couple of cases; don't recall the ticket number right now.)

Slightly related: We should IMHO make it such that the timeouts for doctests (perhaps optionally, or in addition) do not refer to wall but actual CPU time, since often doctests timeout just because they don't get enough CPU when doctesting with (more or less) many threads [and] on an already loaded machine.



---

archive/issue_comments_156786.json:
```json
{
    "body": "<a id='comment:2'></a>\nReplying to [leif](#comment%3A1):\n> Slightly related: We should IMHO make it such that the timeouts for doctests (perhaps optionally, or in addition) do not refer to wall but actual CPU time, since often doctests timeout just because they don't get enough CPU when doctesting with (more or less) many threads [and] on an already loaded machine.\n\n\nIn principle I agree, but I don't think that is implementable in a good and portable way.",
    "created_at": "2011-10-05T10:33:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11899#issuecomment-156786",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>
Replying to [leif](#comment%3A1):
> Slightly related: We should IMHO make it such that the timeouts for doctests (perhaps optionally, or in addition) do not refer to wall but actual CPU time, since often doctests timeout just because they don't get enough CPU when doctesting with (more or less) many threads [and] on an already loaded machine.


In principle I agree, but I don't think that is implementable in a good and portable way.



---

archive/issue_comments_156787.json:
```json
{
    "body": "<a id='comment:3'></a>\nP.S.: If you want to see *which line* of a doctest takes how long, you can\n\n```sh\n$ cd $SAGE_ROOT/local/bin\n$ mv ncadoctest.py ncadoctest.py.orig\n$ cp -p sage:/home/leif/Sage/scripts/ncadoctest-v0.3.py ncadoctest.py\n```\nand test the file(s) in verbose mode.\n\nThere's no patch worth to get merged yet; I'll *one day*<sup>TM</sup> develop this further and implement this behaviour as a separate option to `sage -t ...`.\n\nNote that with this version of `ncadoctest.py` the output when a doctest fails *in non-verbose mode* also differs.",
    "created_at": "2011-10-05T10:42:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11899#issuecomment-156787",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:3'></a>
P.S.: If you want to see *which line* of a doctest takes how long, you can

```sh
$ cd $SAGE_ROOT/local/bin
$ mv ncadoctest.py ncadoctest.py.orig
$ cp -p sage:/home/leif/Sage/scripts/ncadoctest-v0.3.py ncadoctest.py
```
and test the file(s) in verbose mode.

There's no patch worth to get merged yet; I'll *one day*<sup>TM</sup> develop this further and implement this behaviour as a separate option to `sage -t ...`.

Note that with this version of `ncadoctest.py` the output when a doctest fails *in non-verbose mode* also differs.



---

archive/issue_comments_156788.json:
```json
{
    "body": "<a id='comment:4'></a>\ns/`cp`/`scp`/",
    "created_at": "2011-10-05T10:44:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11899#issuecomment-156788",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:4'></a>
s/`cp`/`scp`/



---

archive/issue_comments_156789.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [jdemeyer](#comment%3A2):\n> Replying to [leif](#comment%3A1):\n> > We should IMHO make it such that the timeouts for doctests (perhaps optionally, or in addition) do not refer to wall but actual CPU time [...]\n\n> \n> In principle I agree, but I don't think that is implementable in a good and portable way.\n\n\nWe could use `setrlimit()` in `sage-doctest.py` (which tests just a single file, i.e., each doctested file has its own instance), or add appropriate code (e.g. setting `SIGALRM`, and checking the consumed CPU time with `getrusage()`) to the generated temporary files with the examples that get run by Python. Emitting such extra code could be optional, too.\n\nAs a first step, we could in addition print the CPU time a doctest (of a complete file) took, by using `getrusage()` in `sage-test.py` / `sage-ptest.py`",
    "created_at": "2011-10-05T11:08:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11899#issuecomment-156789",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:5'></a>
Replying to [jdemeyer](#comment%3A2):
> Replying to [leif](#comment%3A1):
> > We should IMHO make it such that the timeouts for doctests (perhaps optionally, or in addition) do not refer to wall but actual CPU time [...]

> 
> In principle I agree, but I don't think that is implementable in a good and portable way.


We could use `setrlimit()` in `sage-doctest.py` (which tests just a single file, i.e., each doctested file has its own instance), or add appropriate code (e.g. setting `SIGALRM`, and checking the consumed CPU time with `getrusage()`) to the generated temporary files with the examples that get run by Python. Emitting such extra code could be optional, too.

As a first step, we could in addition print the CPU time a doctest (of a complete file) took, by using `getrusage()` in `sage-test.py` / `sage-ptest.py`



---

archive/issue_comments_156790.json:
```json
{
    "body": "<a id='comment:6'></a>\nReplying to [leif](#comment%3A5):\n> We could use `setrlimit()` in `sage-doctest.py`\n\nThis only works for one process, so it will not work well with pexpect interfaces which spawn several child processes.",
    "created_at": "2011-10-05T11:26:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11899#issuecomment-156790",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>
Replying to [leif](#comment%3A5):
> We could use `setrlimit()` in `sage-doctest.py`

This only works for one process, so it will not work well with pexpect interfaces which spawn several child processes.



---

archive/issue_comments_156791.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1 +1 @@\n-Throughout Sage, there are a few doctests taking a very long time (more than 30 seconds) but sometimes these can easily be simplified to take less time.\n+Throughout Sage, there are a few doctests taking a very long time (more than 30 seconds) but sometimes these can easily be simplified to take less time.  Also add `# long time` where needed.\n``````\n",
    "created_at": "2011-10-05T13:02:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11899#issuecomment-156791",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1 +1 @@
-Throughout Sage, there are a few doctests taking a very long time (more than 30 seconds) but sometimes these can easily be simplified to take less time.
+Throughout Sage, there are a few doctests taking a very long time (more than 30 seconds) but sometimes these can easily be simplified to take less time.  Also add `# long time` where needed.
``````




---

archive/issue_comments_156792.json:
```json
{
    "body": "**Author:** Jeroen Demeyer",
    "created_at": "2011-10-05T13:30:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11899#issuecomment-156792",
    "user": "https://github.com/jdemeyer"
}
```

**Author:** Jeroen Demeyer



---

archive/issue_comments_156793.json:
```json
{
    "body": "<a id='comment:8'></a>\nMost of these timings seem to be regressions, see sage-devel.",
    "created_at": "2011-10-05T13:30:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11899#issuecomment-156793",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>
Most of these timings seem to be regressions, see sage-devel.



---

archive/issue_events_037344.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/11899",
    "rename": {
        "from": "Simplify some very long doctests",
        "to": "Add #long time at various places"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11899#event-37344"
}
```



---

archive/issue_comments_156794.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2011-10-30T14:26:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11899#issuecomment-156794",
    "user": "https://github.com/jdemeyer"
}
```

**Changing status** from new to needs_review.



---

archive/attachments_015816.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "11899.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket11899/11899.patch",
    "created_at": "2011-10-30T14:26:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11899",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/jdemeyer"
}
```



---

archive/issue_comments_156795.json:
```json
{
    "body": "<a id='comment:10'></a>\n",
    "created_at": "2011-10-30T14:26:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11899#issuecomment-156795",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>




---

archive/issue_comments_156796.json:
```json
{
    "body": "Milestone sage-4.7.3 deleted",
    "created_at": "2011-11-03T16:14:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11899#issuecomment-156796",
    "user": "https://github.com/jdemeyer"
}
```

Milestone sage-4.7.3 deleted



---

archive/attachments_015817.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "11899_2.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket11899/11899_2.patch",
    "created_at": "2011-12-18T15:09:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11899",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/saraedum"
}
```



---

archive/issue_comments_156797.json:
```json
{
    "body": "rebased previous patch against 4.8.alpha3",
    "created_at": "2011-12-18T15:09:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11899#issuecomment-156797",
    "user": "https://github.com/saraedum"
}
```

rebased previous patch against 4.8.alpha3



---

archive/issue_comments_156798.json:
```json
{
    "body": "<a id='comment:12'></a>\nApply only 11899_2.patch\n\n(will set this to positive review when the doctests have finished)",
    "created_at": "2011-12-18T15:11:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11899#issuecomment-156798",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:12'></a>
Apply only 11899_2.patch

(will set this to positive review when the doctests have finished)



---

archive/issue_comments_156799.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1 +1,9 @@\n Throughout Sage, there are a few doctests taking a very long time (more than 30 seconds) but sometimes these can easily be simplified to take less time.  Also add `# long time` where needed.\n+\n+---\n+\n+Apply\n+\n+1. [attachment:11899_2.patch]\n+\n+to the sage repository\n``````\n",
    "created_at": "2011-12-18T15:11:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11899#issuecomment-156799",
    "user": "https://github.com/saraedum"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1 +1,9 @@
 Throughout Sage, there are a few doctests taking a very long time (more than 30 seconds) but sometimes these can easily be simplified to take less time.  Also add `# long time` where needed.
+
+---
+
+Apply
+
+1. [attachment:11899_2.patch]
+
+to the sage repository
``````




---

archive/issue_events_037345.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2011-12-18T15:11:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11899",
    "milestone": "sage-4.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11899#event-37345"
}
```



---

archive/issue_comments_156800.json:
```json
{
    "body": "**Reviewer:** Julian Rueth",
    "created_at": "2011-12-18T15:11:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11899#issuecomment-156800",
    "user": "https://github.com/saraedum"
}
```

**Reviewer:** Julian Rueth



---

archive/issue_comments_156801.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2011-12-18T18:22:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11899#issuecomment-156801",
    "user": "https://github.com/saraedum"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_156802.json:
```json
{
    "body": "**Changing keywords** from \"\" to \"sd35\".",
    "created_at": "2011-12-21T15:23:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11899#issuecomment-156802",
    "user": "https://github.com/saraedum"
}
```

**Changing keywords** from "" to "sd35".



---

archive/issue_comments_156803.json:
```json
{
    "body": "**Merged:** sage-4.8.alpha5",
    "created_at": "2011-12-22T13:05:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11899#issuecomment-156803",
    "user": "https://github.com/jdemeyer"
}
```

**Merged:** sage-4.8.alpha5



---

archive/issue_events_037346.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-12-22T13:05:45Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/11899",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11899#event-37346"
}
```
