# Issue 11669: optimize quaternion algebra elements a bit, in some obvious ways

archive/issues_011497.json:
```json
{
    "body": "This ticket depends on #11670.\n\nThere are a couple of simple optimizations to quaternion algebras that will help a lot with speed.  For example, before this patch:\n\n```\n\nsage: K.<a> = NumberField(x^2-x-1); Q.<i,j,k> = QuaternionAlgebra(K,-1,-1); z=2*i+3*j+4/3*k+5/8\nsage: type(z)\n<type 'sage.algebras.quatalg.quaternion_algebra_element.QuaternionAlgebraElement_generic'>\nsage: timeit('~z')\n625 loops, best of 3: 115 \u00b5s per loop\nsage: v = [z+i for i in range(1000)]\nsage: time k = loads(dumps(v))\nTime: CPU 1.80 s, Wall: 1.80 s\nsage: timeit('a*z')\n625 loops, best of 3: 96.4 \u00b5s per loop\n```\nand after:\n\n```\nsage: K.<a> = NumberField(x^2-x-1); Q.<i,j,k> = QuaternionAlgebra(K,-1,-1); z=2*i+3*j+4/3*k+5/8\nsage: type(z)\n<type 'sage.algebras.quatalg.quaternion_algebra_element.QuaternionAlgebraElement_generic'>\nsage: timeit('~z')\n625 loops, best of 3: 20.6 \u00b5s per loop\nsage: v = [z+i for i in range(1000)]\nsage: time k = loads(dumps(v))\nTime: CPU 0.31 s, Wall: 0.31 s\nsage: timeit('a*z')\n625 loops, best of 3: 4.63 \u00b5s per loop\n```\n\nThe changes in the patch to give this \"order of magnitude\" speedup are very simple, and will make quaternion arithmetic over all base rings much faster for certain important operation.  The main idea of the patch (after I had tried many things and deleted most of them) is just to add a check parameter to get rid of some coercion that isn't needed, plus adding lmul and rmul methods generically.  That's it.  But it leads to 6-20 times speedups on basic operations of importance to me. \n\n\nAssignee: @aghitza\n\nBranch/Commit: 81f86b8ca4e93c3802c8313c6967fe76cbf34e2d\n\nReviewer: R. Andrew Ohana\n\nAuthor: William Stein\n\nDependencies: #11670\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/11669\n\n",
    "closed_at": "2014-05-08T11:50:10Z",
    "created_at": "2011-08-08T18:53:37Z",
    "labels": [
        "component: algebra",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.3",
    "title": "optimize quaternion algebra elements a bit, in some obvious ways",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11669",
    "user": "https://github.com/williamstein"
}
```
This ticket depends on #11670.

There are a couple of simple optimizations to quaternion algebras that will help a lot with speed.  For example, before this patch:

```

sage: K.<a> = NumberField(x^2-x-1); Q.<i,j,k> = QuaternionAlgebra(K,-1,-1); z=2*i+3*j+4/3*k+5/8
sage: type(z)
<type 'sage.algebras.quatalg.quaternion_algebra_element.QuaternionAlgebraElement_generic'>
sage: timeit('~z')
625 loops, best of 3: 115 µs per loop
sage: v = [z+i for i in range(1000)]
sage: time k = loads(dumps(v))
Time: CPU 1.80 s, Wall: 1.80 s
sage: timeit('a*z')
625 loops, best of 3: 96.4 µs per loop
```
and after:

```
sage: K.<a> = NumberField(x^2-x-1); Q.<i,j,k> = QuaternionAlgebra(K,-1,-1); z=2*i+3*j+4/3*k+5/8
sage: type(z)
<type 'sage.algebras.quatalg.quaternion_algebra_element.QuaternionAlgebraElement_generic'>
sage: timeit('~z')
625 loops, best of 3: 20.6 µs per loop
sage: v = [z+i for i in range(1000)]
sage: time k = loads(dumps(v))
Time: CPU 0.31 s, Wall: 0.31 s
sage: timeit('a*z')
625 loops, best of 3: 4.63 µs per loop
```

The changes in the patch to give this "order of magnitude" speedup are very simple, and will make quaternion arithmetic over all base rings much faster for certain important operation.  The main idea of the patch (after I had tried many things and deleted most of them) is just to add a check parameter to get rid of some coercion that isn't needed, plus adding lmul and rmul methods generically.  That's it.  But it leads to 6-20 times speedups on basic operations of importance to me. 


Assignee: @aghitza

Branch/Commit: 81f86b8ca4e93c3802c8313c6967fe76cbf34e2d

Reviewer: R. Andrew Ohana

Author: William Stein

Dependencies: #11670

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/11669





---

archive/issue_comments_162900.json:
```json
{
    "body": "<a id='comment:1'></a>\nAttachment [trac_11669.patch](tarball://root/attachments/some-uuid/ticket11669/trac_11669.patch) by @williamstein created at 2011-08-08 19:00:45",
    "created_at": "2011-08-08T19:00:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11669#issuecomment-162900",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:1'></a>
Attachment [trac_11669.patch](tarball://root/attachments/some-uuid/ticket11669/trac_11669.patch) by @williamstein created at 2011-08-08 19:00:45



---

archive/issue_comments_162901.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-08-08T19:00:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11669#issuecomment-162901",
    "user": "https://github.com/williamstein"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_162902.json:
```json
{
    "body": "<a id='comment:2'></a>\nI found a subtle issue, namely that when unpickling elements, they suddenly get the wrong quadratic field as parent.  This ends up making other code I have that uses quaternion algebras actually massively slower.    Anyway, I have to fix this before this patch can be used.\n\n```\nsage: K.<a> = NumberField(x^2-x-1); Q.<i,j,k> = QuaternionAlgebra(K,-1,-1); z=2*i+3*j+4/3*k+5/8\nsage: w = loads(dumps(z))\nsage: w.parent().base_ring() is K\nTrue\nsage: w[0].parent() is K     # output should be \"True\"\nFalse\n```",
    "created_at": "2011-08-08T19:36:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11669#issuecomment-162902",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:2'></a>
I found a subtle issue, namely that when unpickling elements, they suddenly get the wrong quadratic field as parent.  This ends up making other code I have that uses quaternion algebras actually massively slower.    Anyway, I have to fix this before this patch can be used.

```
sage: K.<a> = NumberField(x^2-x-1); Q.<i,j,k> = QuaternionAlgebra(K,-1,-1); z=2*i+3*j+4/3*k+5/8
sage: w = loads(dumps(z))
sage: w.parent().base_ring() is K
True
sage: w[0].parent() is K     # output should be "True"
False
```



---

archive/issue_comments_162903.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-08-08T19:36:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11669#issuecomment-162903",
    "user": "https://github.com/williamstein"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_162904.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,5 @@\n+This ticket depends on #11670.\n+\n There are a couple of simple optimizations to quaternion algebras that will help a lot with speed.  For example, before this patch:\n \n ```\n``````\n",
    "created_at": "2011-08-09T17:31:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11669#issuecomment-162904",
    "user": "https://github.com/williamstein"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,5 @@
+This ticket depends on #11670.
+
 There are a couple of simple optimizations to quaternion algebras that will help a lot with speed.  For example, before this patch:
 
 ```
``````




---

archive/issue_comments_162905.json:
```json
{
    "body": "<a id='comment:3'></a>\nThe issue I mentioned above is fixed by #11670.  \n\n```\nsage: K.<a> = NumberField(x^2-x-1); Q.<i,j,k> = QuaternionAlgebra(K,-1,-1); z=2*i+3*j+4/3*k+5/8\nsage: \nsage:  w = loads(dumps(z))\nsage: w.parent().base_ring() is K\nTrue\nsage: w[0].parent() is K\nTrue\n```",
    "created_at": "2011-08-09T17:31:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11669#issuecomment-162905",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:3'></a>
The issue I mentioned above is fixed by #11670.  

```
sage: K.<a> = NumberField(x^2-x-1); Q.<i,j,k> = QuaternionAlgebra(K,-1,-1); z=2*i+3*j+4/3*k+5/8
sage: 
sage:  w = loads(dumps(z))
sage: w.parent().base_ring() is K
True
sage: w[0].parent() is K
True
```



---

archive/issue_comments_162906.json:
```json
{
    "body": "Changing dependencies from \"\" to \"11670\"",
    "created_at": "2011-08-09T17:31:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11669#issuecomment-162906",
    "user": "https://github.com/williamstein"
}
```

Changing dependencies from "" to "11670"



---

archive/issue_comments_162907.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-08-09T17:31:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11669#issuecomment-162907",
    "user": "https://github.com/williamstein"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_162908.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-09-27T03:55:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11669#issuecomment-162908",
    "user": "https://github.com/ohanar"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_162909.json:
```json
{
    "body": "<a id='comment:6'></a>\nCode makes sense and everything passes.",
    "created_at": "2011-09-27T03:55:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11669#issuecomment-162909",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:6'></a>
Code makes sense and everything passes.



---

archive/issue_comments_162910.json:
```json
{
    "body": "Changing reviewer from \"\" to \"R. Andrew Ohana\"",
    "created_at": "2011-09-28T20:34:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11669#issuecomment-162910",
    "user": "https://github.com/loefflerd"
}
```

Changing reviewer from "" to "R. Andrew Ohana"



---

archive/issue_comments_162911.json:
```json
{
    "body": "Changing author from \"\" to \"William Stein\"",
    "created_at": "2011-09-28T20:34:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11669#issuecomment-162911",
    "user": "https://github.com/loefflerd"
}
```

Changing author from "" to "William Stein"



---

archive/issue_comments_162912.json:
```json
{
    "body": "Changing dependencies from \"11670\" to \"#11670\"",
    "created_at": "2011-09-29T03:48:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11669#issuecomment-162912",
    "user": "https://github.com/nexttime"
}
```

Changing dependencies from "11670" to "#11670"



---

archive/issue_events_036249.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-10-06T08:18:20Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11669",
    "milestone": "sage-pending",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11669#event-36249"
}
```



---

archive/issue_comments_162913.json:
```json
{
    "body": "<a id='comment:11'></a>\nPatch converted into a Git branch, fixed trivial merge conflict and whitespace.  All tests still pass.",
    "created_at": "2014-05-02T13:59:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11669#issuecomment-162913",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:11'></a>
Patch converted into a Git branch, fixed trivial merge conflict and whitespace.  All tests still pass.



---

archive/issue_events_036250.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2014-05-02T13:59:20Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11669",
    "milestone": "sage-pending",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11669#event-36250"
}
```



---

archive/issue_events_036251.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2014-05-02T13:59:20Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11669",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11669#event-36251"
}
```



---

archive/issue_comments_162914.json:
```json
{
    "body": "Changing commit from \"\" to \"81f86b8ca4e93c3802c8313c6967fe76cbf34e2d\"",
    "created_at": "2014-05-02T13:59:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11669#issuecomment-162914",
    "user": "https://github.com/pjbruin"
}
```

Changing commit from "" to "81f86b8ca4e93c3802c8313c6967fe76cbf34e2d"



---

archive/issue_comments_162915.json:
```json
{
    "body": "Changing branch from \"\" to \"u/pbruin/11669-quaternion_algebra_elements\"",
    "created_at": "2014-05-02T13:59:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11669#issuecomment-162915",
    "user": "https://github.com/pjbruin"
}
```

Changing branch from "" to "u/pbruin/11669-quaternion_algebra_elements"



---

archive/issue_comments_162916.json:
```json
{
    "body": "Changing branch from \"u/pbruin/11669-quaternion_algebra_elements\" to \"81f86b8ca4e93c3802c8313c6967fe76cbf34e2d\"",
    "created_at": "2014-05-08T11:50:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11669#issuecomment-162916",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/pbruin/11669-quaternion_algebra_elements" to "81f86b8ca4e93c3802c8313c6967fe76cbf34e2d"



---

archive/issue_comments_162917.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-05-08T11:50:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11669#issuecomment-162917",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_036252.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-05-08T11:50:10Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/11669",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11669#event-36252"
}
```
