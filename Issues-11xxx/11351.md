# Issue 11351: Implementation of Cohen-Macaulay test for simplicial complexes

archive/issues_011351.json:
```json
{
    "body": "Assignee: @malb\n\nCC:  @jhpalmieri\n\nKeywords: Cohen-Macaulay, homology, simplicial complexes\n\nSimplicial complexes were lacking a method to test Cohen-Macaulayness.\n\nIn order to implement this method, some other methods are improved, namely a hash function is implemented, and _enlarge_subcomplex has become faster.\n\nFor convinience, I also added a face_iterator.\n\nRemark: the new line\n\n```\nint_facets = set( a.set().intersection(f_set) for a in new_facets ) \n```\n\nin _enalarge_subcomplex improved speed for computing the homology by 65% (in the example I looked at -- needs to be verified). This method still has the potential to be speeded a lot, and it is responsible for a lot cpu time when computing the homology.\n\nI also added a second version using parallel tests on multiple cpus.\n\n---\n\nApply only: [attachment:trac_11523-cohen_macaulay_complex-cs-jhp-review-ts.patch]\n\nIssue created by migration from https://trac.sagemath.org/ticket/11523\n\n",
    "closed_at": "2012-12-27T10:24:46Z",
    "created_at": "2011-06-20T14:56:12Z",
    "labels": [
        "component: commutative algebra"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.6",
    "title": "Implementation of Cohen-Macaulay test for simplicial complexes",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11351",
    "user": "https://trac.sagemath.org/admin/accounts/users/stumpc5"
}
```
Assignee: @malb

CC:  @jhpalmieri

Keywords: Cohen-Macaulay, homology, simplicial complexes

Simplicial complexes were lacking a method to test Cohen-Macaulayness.

In order to implement this method, some other methods are improved, namely a hash function is implemented, and _enlarge_subcomplex has become faster.

For convinience, I also added a face_iterator.

Remark: the new line

```
int_facets = set( a.set().intersection(f_set) for a in new_facets ) 
```

in _enalarge_subcomplex improved speed for computing the homology by 65% (in the example I looked at -- needs to be verified). This method still has the potential to be speeded a lot, and it is responsible for a lot cpu time when computing the homology.

I also added a second version using parallel tests on multiple cpus.

---

Apply only: [attachment:trac_11523-cohen_macaulay_complex-cs-jhp-review-ts.patch]

Issue created by migration from https://trac.sagemath.org/ticket/11523





---

archive/issue_comments_125442.json:
```json
{
    "body": "I'm sorry, I forgot about this ticket.\n\nOverall, I think this looks pretty good.  Some comments and questions:\n\n- I had to rebase this against 4.7.2.alpha2.\n- why have both `is_cohen_macaulay` and `is_cohen_macaulay_parallel`?  When would you ever want to use the first one?  With ncpus=1, the parallel one is about as fast as the first, so should we get rid of the first one?\n- on the other hand, when I run the parallel version with ncpus=1, I sometimes see an error:\n\n```\nException OSError: (10, 'No child processes') in <generator object __call__ at 0x10d20ee10> ignored\n```\n and then the computation proceeds.  Should we try to catch this and hide it?  Can we do that if it says \"ignored\"?\n- in my testing (`timeit('simplicial_complexes.NotIConnectedGraphs(5,2).homology()')`), I saw no change in the time required to do homology computations from the old version to the new one, but if you have other ideas for speeding things up, please implement them.\n- the method `face_iterator` has no documentation.\n\nI don't know if this was ready for review, but I'm attaching a new version of the patch which makes some of these changes: it renames `is_cohen_macaulay` to `_is_cohen_macaulay_serial` (so it's hidden), renames the parallel version to `is_cohen_macaulay`.  I wonder if we should set ncpus to be 2 by default instead of 1?  I'll try testing on a machine with just one cpu to see what effect that has.",
    "created_at": "2011-09-26T22:52:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11351#issuecomment-125442",
    "user": "https://github.com/jhpalmieri"
}
```

I'm sorry, I forgot about this ticket.

Overall, I think this looks pretty good.  Some comments and questions:

- I had to rebase this against 4.7.2.alpha2.
- why have both `is_cohen_macaulay` and `is_cohen_macaulay_parallel`?  When would you ever want to use the first one?  With ncpus=1, the parallel one is about as fast as the first, so should we get rid of the first one?
- on the other hand, when I run the parallel version with ncpus=1, I sometimes see an error:

```
Exception OSError: (10, 'No child processes') in <generator object __call__ at 0x10d20ee10> ignored
```
 and then the computation proceeds.  Should we try to catch this and hide it?  Can we do that if it says "ignored"?
- in my testing (`timeit('simplicial_complexes.NotIConnectedGraphs(5,2).homology()')`), I saw no change in the time required to do homology computations from the old version to the new one, but if you have other ideas for speeding things up, please implement them.
- the method `face_iterator` has no documentation.

I don't know if this was ready for review, but I'm attaching a new version of the patch which makes some of these changes: it renames `is_cohen_macaulay` to `_is_cohen_macaulay_serial` (so it's hidden), renames the parallel version to `is_cohen_macaulay`.  I wonder if we should set ncpus to be 2 by default instead of 1?  I'll try testing on a machine with just one cpu to see what effect that has.



---

archive/issue_comments_125443.json:
```json
{
    "body": "Replying to [comment:3 jhpalmieri]:\n\nThanks for looking at it again, I hope we can get it into sage soon, as it was pretty much done. The only reason why I stopped working was that I thought I can still speed things up, but I never found the time to do so. I vote for leaving it as it is for now, and if someone (maybe me) needs a faster version, we get back to it.\n\n> Overall, I think this looks pretty good. Some comments and questions:\n> - why have both `is_cohen_macaulay` and `is_cohen_macaulay_parallel`?  When would you ever want to use the first one?  With ncpus=1, the parallel one is about as fast as the first, so should we get rid of the first one?\n\n\nthat was just a left-over, as I first implemented is_cohen_macaulay and then started to play with the parallel version.\n\n>  - on the other hand, when I run the parallel version with ncpus=1, I sometimes see an error:\n \n> {{{\n> Exception OSError: (10, 'No child processes') in <generator object __call__ at 0x10d20ee10> ignored\n> }}}\n>  and then the computation proceeds.  Should we try to catch this and hide it?  Can we do that if it says \"ignored\"?\n\n\nIf I remember right, this happens not only for 1 cpu, but if a negative answer is returned without waiting the other parallel sessions to be finished. I agree that we should catch that error!\n\n>  - in my testing (`timeit('simplicial_complexes.NotIConnectedGraphs(5,2).homology()')`), I saw no change in the time required to do homology computations from the old version to the new one, but if you have other ideas for speeding things up, please implement them.\n\n\nSee my comment at the beginning.\n\n>  - the method `face_iterator` has no documentation.\n\n\nI will add it!\n\n> I don't know if this was ready for review, but I'm attaching a new version of the patch which makes some of these changes: it renames `is_cohen_macaulay` to `_is_cohen_macaulay_serial` (so it's hidden), renames the parallel version to `is_cohen_macaulay`.  I wonder if we should set ncpus to be 2 by default instead of 1?  I'll try testing on a machine with just one cpu to see what effect that has.\n\n\nThanks again, I will update your patch as soon as I have done the changes...\n\nBest, Christian",
    "created_at": "2011-10-10T08:24:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11351#issuecomment-125443",
    "user": "https://trac.sagemath.org/admin/accounts/users/stumpc5"
}
```

Replying to [comment:3 jhpalmieri]:

Thanks for looking at it again, I hope we can get it into sage soon, as it was pretty much done. The only reason why I stopped working was that I thought I can still speed things up, but I never found the time to do so. I vote for leaving it as it is for now, and if someone (maybe me) needs a faster version, we get back to it.

> Overall, I think this looks pretty good. Some comments and questions:
> - why have both `is_cohen_macaulay` and `is_cohen_macaulay_parallel`?  When would you ever want to use the first one?  With ncpus=1, the parallel one is about as fast as the first, so should we get rid of the first one?


that was just a left-over, as I first implemented is_cohen_macaulay and then started to play with the parallel version.

>  - on the other hand, when I run the parallel version with ncpus=1, I sometimes see an error:
 
> {{{
> Exception OSError: (10, 'No child processes') in <generator object __call__ at 0x10d20ee10> ignored
> }}}
>  and then the computation proceeds.  Should we try to catch this and hide it?  Can we do that if it says "ignored"?


If I remember right, this happens not only for 1 cpu, but if a negative answer is returned without waiting the other parallel sessions to be finished. I agree that we should catch that error!

>  - in my testing (`timeit('simplicial_complexes.NotIConnectedGraphs(5,2).homology()')`), I saw no change in the time required to do homology computations from the old version to the new one, but if you have other ideas for speeding things up, please implement them.


See my comment at the beginning.

>  - the method `face_iterator` has no documentation.


I will add it!

> I don't know if this was ready for review, but I'm attaching a new version of the patch which makes some of these changes: it renames `is_cohen_macaulay` to `_is_cohen_macaulay_serial` (so it's hidden), renames the parallel version to `is_cohen_macaulay`.  I wonder if we should set ncpus to be 2 by default instead of 1?  I'll try testing on a machine with just one cpu to see what effect that has.


Thanks again, I will update your patch as soon as I have done the changes...

Best, Christian



---

archive/issue_comments_125444.json:
```json
{
    "body": "I updated a new version. The only changes are that I import `QQ` as we need that, and I simplified the code for is_cohen_macaulay slightly. I saw that you added the documentation for `face_iterator` already, thanks!",
    "created_at": "2011-10-10T08:57:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11351#issuecomment-125444",
    "user": "https://trac.sagemath.org/admin/accounts/users/stumpc5"
}
```

I updated a new version. The only changes are that I import `QQ` as we need that, and I simplified the code for is_cohen_macaulay slightly. I saw that you added the documentation for `face_iterator` already, thanks!



---

archive/issue_comments_125445.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-10-10T08:57:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11351#issuecomment-125445",
    "user": "https://trac.sagemath.org/admin/accounts/users/stumpc5"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_125446.json:
```json
{
    "body": "Replying to [comment:5 stumpc5]:\n> I updated a new version. The only changes are that I import `QQ` as we need that, and I simplified the code for is_cohen_macaulay slightly. I saw that you added the documentation for `face_iterator` already, thanks!\n\n\nIt is rebased against 4.7.2.alpha3.",
    "created_at": "2011-10-10T09:00:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11351#issuecomment-125446",
    "user": "https://trac.sagemath.org/admin/accounts/users/stumpc5"
}
```

Replying to [comment:5 stumpc5]:
> I updated a new version. The only changes are that I import `QQ` as we need that, and I simplified the code for is_cohen_macaulay slightly. I saw that you added the documentation for `face_iterator` already, thanks!


It is rebased against 4.7.2.alpha3.



---

archive/issue_comments_125447.json:
```json
{
    "body": "This is mostly good.  The only problems are with the parallel version: if I run with more than one process, I get a message like\n\n```\nsage: X.is_cohen_macaulay(2)\nKilling any remaining workers...\nFalse\n```\nIf I run it with one process, I get\n\n```\nsage: X.is_cohen_macaulay(1)\nKilling any remaining workers...\nException OSError: (10, 'No child processes') in <generator object __call__ at 0x10ca39a00> ignored\nFalse\n```\nWe should be able to catch the error.  Can we also suppress the message \"Killing any remaining workers...\"?",
    "created_at": "2011-10-14T23:00:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11351#issuecomment-125447",
    "user": "https://github.com/jhpalmieri"
}
```

This is mostly good.  The only problems are with the parallel version: if I run with more than one process, I get a message like

```
sage: X.is_cohen_macaulay(2)
Killing any remaining workers...
False
```
If I run it with one process, I get

```
sage: X.is_cohen_macaulay(1)
Killing any remaining workers...
Exception OSError: (10, 'No child processes') in <generator object __call__ at 0x10ca39a00> ignored
False
```
We should be able to catch the error.  Can we also suppress the message "Killing any remaining workers..."?



---

archive/issue_comments_125448.json:
```json
{
    "body": "Replying to [comment:7 jhpalmieri]:\n> This is mostly good.  The only problems are with the parallel version: if I run with more than one process, I get a message like\n> \n> ```\n> sage: X.is_cohen_macaulay(2)\n> Killing any remaining workers...\n> False\n> ```\n> If I run it with one process, I get\n> \n> ```\n> sage: X.is_cohen_macaulay(1)\n> Killing any remaining workers...\n> Exception OSError: (10, 'No child processes') in <generator object __call__ at 0x10ca39a00> ignored\n> False\n> ```\n> We should be able to catch the error.  Can we also suppress the message \"Killing any remaining workers...\"?\n\n\nI tried to catch it, but it it already caught somewhere inside the decorator, so I don't know how to suppress the output, do you?\n\nFeel free to update the patch if you see a way to do it!",
    "created_at": "2011-10-15T05:10:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11351#issuecomment-125448",
    "user": "https://trac.sagemath.org/admin/accounts/users/stumpc5"
}
```

Replying to [comment:7 jhpalmieri]:
> This is mostly good.  The only problems are with the parallel version: if I run with more than one process, I get a message like
> 
> ```
> sage: X.is_cohen_macaulay(2)
> Killing any remaining workers...
> False
> ```
> If I run it with one process, I get
> 
> ```
> sage: X.is_cohen_macaulay(1)
> Killing any remaining workers...
> Exception OSError: (10, 'No child processes') in <generator object __call__ at 0x10ca39a00> ignored
> False
> ```
> We should be able to catch the error.  Can we also suppress the message "Killing any remaining workers..."?


I tried to catch it, but it it already caught somewhere inside the decorator, so I don't know how to suppress the output, do you?

Feel free to update the patch if you see a way to do it!



---

archive/issue_comments_125449.json:
```json
{
    "body": "I'm sorry this has languished for so long. Here is a new patch which turns off the message \"Killing remaining workers...\". I don't know how to get rid of the \"No child processes warning\", so I mentioned its possible presence in the docstring, so people won't be too concerned if they see it. I also removed the serial version altogether.",
    "created_at": "2012-07-11T15:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11351#issuecomment-125449",
    "user": "https://github.com/jhpalmieri"
}
```

I'm sorry this has languished for so long. Here is a new patch which turns off the message "Killing remaining workers...". I don't know how to get rid of the "No child processes warning", so I mentioned its possible presence in the docstring, so people won't be too concerned if they see it. I also removed the serial version altogether.



---

archive/issue_comments_125450.json:
```json
{
    "body": "Because of the hashing of simplicial complexes, this is in conflict with #12587. I've started a topic on sage-devel on the mutability of SimplicialComplex.",
    "created_at": "2012-10-27T19:11:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11351#issuecomment-125450",
    "user": "https://github.com/tscrim"
}
```

Because of the hashing of simplicial complexes, this is in conflict with #12587. I've started a topic on sage-devel on the mutability of SimplicialComplex.



---

archive/issue_comments_125451.json:
```json
{
    "body": "Replying to [comment:10 tscrim]:\n> Because of the hashing of simplicial complexes, this is in conflict with #12587. I've started a topic on sage-devel on the mutability of SimplicialComplex.\n\n\nThanks for bringing this up. I will modify this ticket here as soon as the other ticket is ready.",
    "created_at": "2012-10-28T08:52:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11351#issuecomment-125451",
    "user": "https://trac.sagemath.org/admin/accounts/users/stumpc5"
}
```

Replying to [comment:10 tscrim]:
> Because of the hashing of simplicial complexes, this is in conflict with #12587. I've started a topic on sage-devel on the mutability of SimplicialComplex.


Thanks for bringing this up. I will modify this ticket here as soon as the other ticket is ready.



---

archive/issue_comments_125452.json:
```json
{
    "body": "Hey Christian,\n\nJust wondering about the status of this patch now that #12587 is (code-wise) finalized.\n\nThanks,\n\nTravis",
    "created_at": "2012-12-15T17:08:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11351#issuecomment-125452",
    "user": "https://github.com/tscrim"
}
```

Hey Christian,

Just wondering about the status of this patch now that #12587 is (code-wise) finalized.

Thanks,

Travis



---

archive/issue_comments_125453.json:
```json
{
    "body": "Okay, this is now ready for its final review, I guess... Thanks Travis for bringing it up again!",
    "created_at": "2012-12-16T06:13:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11351#issuecomment-125453",
    "user": "https://trac.sagemath.org/admin/accounts/users/stumpc5"
}
```

Okay, this is now ready for its final review, I guess... Thanks Travis for bringing it up again!



---

archive/issue_comments_125454.json:
```json
{
    "body": "Attachment [trac_11523-cohen_macaulay_complex-cs-jhp-review-ts.patch](tarball://root/attachments/some-uuid/ticket11523/trac_11523-cohen_macaulay_complex-cs-jhp-review-ts.patch) by @tscrim created at 2012-12-17 06:48:46\n\nHey Christian and John,\n\nThis did not apply against #12587, so I did the very minor rebase in my review patch (it contains the entire patch; sorry if I overstepped here). I also made some minor docstring changes: some formatting and moved the note about the exception in a `.. NOTE::` block. If you agree with the changes, feel free to set this to positive review.\n\nThanks for your work on this, I plan on putting this to good use,\n\nTravis\n\nFor patchbot:\n\nApply only: trac_11523-cohen_macaulay_complex-cs-jhp-review-ts.patch",
    "created_at": "2012-12-17T06:48:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11351#issuecomment-125454",
    "user": "https://github.com/tscrim"
}
```

Attachment [trac_11523-cohen_macaulay_complex-cs-jhp-review-ts.patch](tarball://root/attachments/some-uuid/ticket11523/trac_11523-cohen_macaulay_complex-cs-jhp-review-ts.patch) by @tscrim created at 2012-12-17 06:48:46

Hey Christian and John,

This did not apply against #12587, so I did the very minor rebase in my review patch (it contains the entire patch; sorry if I overstepped here). I also made some minor docstring changes: some formatting and moved the note about the exception in a `.. NOTE::` block. If you agree with the changes, feel free to set this to positive review.

Thanks for your work on this, I plan on putting this to good use,

Travis

For patchbot:

Apply only: trac_11523-cohen_macaulay_complex-cs-jhp-review-ts.patch



---

archive/issue_comments_125455.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-12-17T10:04:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11351#issuecomment-125455",
    "user": "https://trac.sagemath.org/admin/accounts/users/stumpc5"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_125456.json:
```json
{
    "body": "Replying to [comment:14 tscrim]:\n> Thanks for your work on this, I plan on putting this to good use,\n\n\n\ngreat!\n\nThe patch looks good to me, so I am marking it positive...\n\nBest, Christian",
    "created_at": "2012-12-17T10:04:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11351#issuecomment-125456",
    "user": "https://trac.sagemath.org/admin/accounts/users/stumpc5"
}
```

Replying to [comment:14 tscrim]:
> Thanks for your work on this, I plan on putting this to good use,



great!

The patch looks good to me, so I am marking it positive...

Best, Christian



---

archive/issue_comments_125457.json:
```json
{
    "body": "Is the work issue still relevant?",
    "created_at": "2012-12-23T21:17:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11351#issuecomment-125457",
    "user": "https://github.com/jdemeyer"
}
```

Is the work issue still relevant?



---

archive/issue_comments_125458.json:
```json
{
    "body": "Replying to [comment:3 jhpalmieri]:\n> Thanks for looking at it again, I hope we can get it into sage soon, as it was pretty much done. The only reason why I stopped working was that I thought I can still speed things up, but I never found the time to do so. I vote for leaving it as it is for now, and if someone (maybe me) needs a faster version, we get back to it.\n\n\nIt seems like it's not.",
    "created_at": "2012-12-23T21:25:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11351#issuecomment-125458",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:3 jhpalmieri]:
> Thanks for looking at it again, I hope we can get it into sage soon, as it was pretty much done. The only reason why I stopped working was that I thought I can still speed things up, but I never found the time to do so. I vote for leaving it as it is for now, and if someone (maybe me) needs a faster version, we get back to it.


It seems like it's not.



---

archive/issue_comments_125459.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-12-27T10:24:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11351#issuecomment-125459",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_030105.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-12-27T10:24:46Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/11351",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11351#event-30105"
}
```
