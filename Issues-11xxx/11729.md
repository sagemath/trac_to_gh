# Issue 11729: Cache module import locations

archive/issues_011557.json:
```json
{
    "body": "Assignee: @jasongrout\n\nCC:  @williamstein @robertwb @ohanar simonking\n\nKeywords: sd32\n\nThis ticket implements a cached module importer for Python. It compiles a list of all available files during build (when `sage -b` is run), hooks into the Python import framework and finds modules by the predetermined file list. \n\nBuilding the Sage library (`sage -b`) automatically creates the cache and the `sitecustomize.py` that is used to load the importer into the Python session. The cache is a standard Python dictionary in `sage/misc/modules_cache.py`.\n\n```\n[vbraun@volker-laptop-two hg]$ strace -e file -f sage -c quit |& grep ENOENT | wc -l\n26327\n[vbraun@volker-laptop-two hg]$ sage -b\n...\n[vbraun@volker-laptop-two hg]$ strace -e file -f sage -c quit |& grep ENOENT | wc -l\n3785\n```\n\nIf you encounter any problems while testing this patch, you have to \n\n```\nrm $SAGE_LOCAL/lib/python/site-packages/sitecustomize.py*\n```\nto not load the importer during Python startup.\n\n\nApply trac_11729_cached_importer.patch to the sage library and  trac_11729_import_cache_during_build.patch to the sage_scripts (`$AGE_LOCAL/bin`) repository.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/11729\n\n",
    "closed_at": "2021-12-03T18:41:01Z",
    "created_at": "2011-08-24T03:26:41Z",
    "labels": [
        "component: misc"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Cache module import locations",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11729",
    "user": "https://github.com/vbraun"
}
```
Assignee: @jasongrout

CC:  @williamstein @robertwb @ohanar simonking

Keywords: sd32

This ticket implements a cached module importer for Python. It compiles a list of all available files during build (when `sage -b` is run), hooks into the Python import framework and finds modules by the predetermined file list. 

Building the Sage library (`sage -b`) automatically creates the cache and the `sitecustomize.py` that is used to load the importer into the Python session. The cache is a standard Python dictionary in `sage/misc/modules_cache.py`.

```
[vbraun@volker-laptop-two hg]$ strace -e file -f sage -c quit |& grep ENOENT | wc -l
26327
[vbraun@volker-laptop-two hg]$ sage -b
...
[vbraun@volker-laptop-two hg]$ strace -e file -f sage -c quit |& grep ENOENT | wc -l
3785
```

If you encounter any problems while testing this patch, you have to 

```
rm $SAGE_LOCAL/lib/python/site-packages/sitecustomize.py*
```
to not load the importer during Python startup.


Apply trac_11729_cached_importer.patch to the sage library and  trac_11729_import_cache_during_build.patch to the sage_scripts (`$AGE_LOCAL/bin`) repository.


Issue created by migration from https://trac.sagemath.org/ticket/11729





---

archive/issue_comments_129767.json:
```json
{
    "body": "Changing keywords from \"\" to \"sd32\".",
    "created_at": "2011-08-24T23:31:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11729#issuecomment-129767",
    "user": "https://github.com/williamstein"
}
```

Changing keywords from "" to "sd32".



---

archive/issue_comments_129768.json:
```json
{
    "body": "NOTE: If you try to test this, watch out because of these lines:\n\n```\n\t113\tcat <<EOF > \"$SAGE_LOCAL/lib/python/site-packages/sitecustomize.py\" \n \t114\tfrom sage.misc.importer import sage_importer \n \t115\tsage_importer.register() \n \t116\tEOF \n```\nThey can make it so your Sage install is totally broken.  To fix, just remove the contents of sitecustomize.py.   I spent 15 minutes confused by this.",
    "created_at": "2011-08-26T01:29:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11729#issuecomment-129768",
    "user": "https://github.com/williamstein"
}
```

NOTE: If you try to test this, watch out because of these lines:

```
	113	cat <<EOF > "$SAGE_LOCAL/lib/python/site-packages/sitecustomize.py" 
 	114	from sage.misc.importer import sage_importer 
 	115	sage_importer.register() 
 	116	EOF 
```
They can make it so your Sage install is totally broken.  To fix, just remove the contents of sitecustomize.py.   I spent 15 minutes confused by this.



---

archive/issue_comments_129769.json:
```json
{
    "body": "You have to delete both `$SAGE_LOCAL/lib/python/site-packages/sitecustomize.py` and `$SAGE_LOCAL/lib/python/site-packages/sitecustomize.pyc`, though the latter might not exist. The final version of the patch will test that sage starts up successfully and otherwise delete the `sitecustomize.py` automatically.\n\nAlso, if you run into problems (presumably some `ImportError`), please post what is causing it.",
    "created_at": "2011-08-26T02:57:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11729#issuecomment-129769",
    "user": "https://github.com/vbraun"
}
```

You have to delete both `$SAGE_LOCAL/lib/python/site-packages/sitecustomize.py` and `$SAGE_LOCAL/lib/python/site-packages/sitecustomize.pyc`, though the latter might not exist. The final version of the patch will test that sage starts up successfully and otherwise delete the `sitecustomize.py` automatically.

Also, if you run into problems (presumably some `ImportError`), please post what is causing it.



---

archive/issue_comments_129770.json:
```json
{
    "body": "Updated patch",
    "created_at": "2011-08-27T03:00:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11729#issuecomment-129770",
    "user": "https://github.com/vbraun"
}
```

Updated patch



---

archive/issue_comments_129771.json:
```json
{
    "body": "Attachment [trac_11729_cached_importer.patch](tarball://root/attachments/some-uuid/ticket11729/trac_11729_cached_importer.patch) by @vbraun created at 2011-09-12 17:45:45\n\nUpdated patch",
    "created_at": "2011-09-12T17:45:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11729#issuecomment-129771",
    "user": "https://github.com/vbraun"
}
```

Attachment [trac_11729_cached_importer.patch](tarball://root/attachments/some-uuid/ticket11729/trac_11729_cached_importer.patch) by @vbraun created at 2011-09-12 17:45:45

Updated patch



---

archive/issue_comments_129772.json:
```json
{
    "body": "I've added another workaround for `PIL.Image`, now `make ptest` passes! I would say that the patch is now feature-complete, though it lacks documentation and doctests. Though writing doctests is tricky without breaking the module importing. Somebody should test it on OSX :-)",
    "created_at": "2011-09-12T18:06:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11729#issuecomment-129772",
    "user": "https://github.com/vbraun"
}
```

I've added another workaround for `PIL.Image`, now `make ptest` passes! I would say that the patch is now feature-complete, though it lacks documentation and doctests. Though writing doctests is tricky without breaking the module importing. Somebody should test it on OSX :-)



---

archive/issue_events_030838.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11729#event-30838"
}
```



---

archive/issue_events_030839.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11729#event-30839"
}
```



---

archive/issue_events_030840.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11729#event-30840"
}
```



---

archive/issue_events_030841.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11729#event-30841"
}
```



---

archive/issue_events_030842.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11729#event-30842"
}
```



---

archive/issue_events_030843.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11729#event-30843"
}
```



---

archive/issue_events_030844.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11729#event-30844"
}
```



---

archive/issue_comments_129773.json:
```json
{
    "body": "outdated, should close",
    "created_at": "2021-12-02T00:55:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11729#issuecomment-129773",
    "user": "https://github.com/mkoeppe"
}
```

outdated, should close



---

archive/issue_events_030845.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-02T00:55:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11729#event-30845"
}
```



---

archive/issue_events_030846.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-02T00:55:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11729#event-30846"
}
```



---

archive/issue_comments_129774.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-12-02T00:55:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11729#issuecomment-129774",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_129775.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-12-03T09:33:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11729#issuecomment-129775",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_129776.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2021-12-03T18:41:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11729#issuecomment-129776",
    "user": "https://github.com/mkoeppe"
}
```

Resolution: invalid



---

archive/issue_events_030847.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-03T18:41:01Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11729#event-30847"
}
```
