# Issue 11729: Cache module import locations

archive/issues_011557.json:
```json
{
    "body": "This ticket implements a cached module importer for Python. It compiles a list of all available files during build (when `sage -b` is run), hooks into the Python import framework and finds modules by the predetermined file list. \n\nBuilding the Sage library (`sage -b`) automatically creates the cache and the `sitecustomize.py` that is used to load the importer into the Python session. The cache is a standard Python dictionary in `sage/misc/modules_cache.py`.\n\n```\n[vbraun@volker-laptop-two hg]$ strace -e file -f sage -c quit |& grep ENOENT | wc -l\n26327\n[vbraun@volker-laptop-two hg]$ sage -b\n...\n[vbraun@volker-laptop-two hg]$ strace -e file -f sage -c quit |& grep ENOENT | wc -l\n3785\n```\n\nIf you encounter any problems while testing this patch, you have to \n\n```\nrm $SAGE_LOCAL/lib/python/site-packages/sitecustomize.py*\n```\nto not load the importer during Python startup.\n\n\nApply trac_11729_cached_importer.patch to the sage library and  trac_11729_import_cache_during_build.patch to the sage_scripts (`$AGE_LOCAL/bin`) repository.\n\n\nAssignee: @jasongrout\n\nCC:  @williamstein @robertwb @ohanar simonking\n\nKeywords: sd32\n\nReviewer: Dima Pasechnik\n\nAuthor: Volker Braun\n\nResolution: invalid\n\nIssue created by migration from https://trac.sagemath.org/ticket/11729\n\n",
    "closed_at": "2021-12-03T18:41:01Z",
    "created_at": "2011-08-24T03:26:41Z",
    "labels": [
        "component: misc"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Cache module import locations",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11729",
    "user": "https://github.com/vbraun"
}
```
This ticket implements a cached module importer for Python. It compiles a list of all available files during build (when `sage -b` is run), hooks into the Python import framework and finds modules by the predetermined file list. 

Building the Sage library (`sage -b`) automatically creates the cache and the `sitecustomize.py` that is used to load the importer into the Python session. The cache is a standard Python dictionary in `sage/misc/modules_cache.py`.

```
[vbraun@volker-laptop-two hg]$ strace -e file -f sage -c quit |& grep ENOENT | wc -l
26327
[vbraun@volker-laptop-two hg]$ sage -b
...
[vbraun@volker-laptop-two hg]$ strace -e file -f sage -c quit |& grep ENOENT | wc -l
3785
```

If you encounter any problems while testing this patch, you have to 

```
rm $SAGE_LOCAL/lib/python/site-packages/sitecustomize.py*
```
to not load the importer during Python startup.


Apply trac_11729_cached_importer.patch to the sage library and  trac_11729_import_cache_during_build.patch to the sage_scripts (`$AGE_LOCAL/bin`) repository.


Assignee: @jasongrout

CC:  @williamstein @robertwb @ohanar simonking

Keywords: sd32

Reviewer: Dima Pasechnik

Author: Volker Braun

Resolution: invalid

Issue created by migration from https://trac.sagemath.org/ticket/11729





---

archive/issue_comments_137107.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,6 +1,6 @@\n This ticket implements a cached module importer for Python. It hooks into the Python import framework and caches whether a module was found and if so, its location. The cache is persistent over sessions.\n \n-Except for the location of the persistent storage (in \\`DOT_SAGE/import_cache.txt\\`) there is no dependency on Sage.\n+Except for the location of the persistent storage (in \\`$DOT_SAGE/import_cache.txt\\`) there is no dependency on Sage.\n \n By default, the cached importer is not active. To activate it on your system, you have to import the module at one point in the Python startup, preferably as early as possible. The easiest way to do so is to create a file \\`$SAGE_LOCAL/lib/python/site-packages/sitecustomize.py\\` containing the single line\n \n@@ -11,8 +11,17 @@\n Some benchmarks:\n \n \\`\\`\\`sh\n+[vbraun@volker-laptop-two ~]$ rm ~/.sage/import_cache.txt \n+[vbraun@volker-laptop-two ~]$ strace -e file -f sage -c quit |& grep ENOENT | wc\n+  20173  243630 3085872\n+[vbraun@volker-laptop-two ~]$ strace -e file -f sage -c quit |& grep ENOENT | wc\n+   2276   28856  258830\n+[vbraun@volker-laptop-two ~]$ strace -e file -f sage -c quit |& grep ENOENT | wc\n+   2276   28905  257473\n+\\`\\`\\`\n+Sage-4.7.2.alpha1 startuptime on my laptop decreased from 0.89s to 0.78s with the cached importer.\n \n-\\`\\`\\`\n+Note: at this point you should erase the \\`import_cache.txt\\` before and after rebuilding the sage library. In the future, we might introduce timestamps for the cache to be erased automatically if it is obsolete.\n \n Author: Volker Braun\n \n```\n",
    "created_at": "2011-08-24T03:54:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11729#issuecomment-137107",
    "user": "https://github.com/vbraun"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,6 +1,6 @@
 This ticket implements a cached module importer for Python. It hooks into the Python import framework and caches whether a module was found and if so, its location. The cache is persistent over sessions.
 
-Except for the location of the persistent storage (in \`DOT_SAGE/import_cache.txt\`) there is no dependency on Sage.
+Except for the location of the persistent storage (in \`$DOT_SAGE/import_cache.txt\`) there is no dependency on Sage.
 
 By default, the cached importer is not active. To activate it on your system, you have to import the module at one point in the Python startup, preferably as early as possible. The easiest way to do so is to create a file \`$SAGE_LOCAL/lib/python/site-packages/sitecustomize.py\` containing the single line
 
@@ -11,8 +11,17 @@
 Some benchmarks:
 
 \`\`\`sh
+[vbraun@volker-laptop-two ~]$ rm ~/.sage/import_cache.txt 
+[vbraun@volker-laptop-two ~]$ strace -e file -f sage -c quit |& grep ENOENT | wc
+  20173  243630 3085872
+[vbraun@volker-laptop-two ~]$ strace -e file -f sage -c quit |& grep ENOENT | wc
+   2276   28856  258830
+[vbraun@volker-laptop-two ~]$ strace -e file -f sage -c quit |& grep ENOENT | wc
+   2276   28905  257473
+\`\`\`
+Sage-4.7.2.alpha1 startuptime on my laptop decreased from 0.89s to 0.78s with the cached importer.
 
-\`\`\`
+Note: at this point you should erase the \`import_cache.txt\` before and after rebuilding the sage library. In the future, we might introduce timestamps for the cache to be erased automatically if it is obsolete.
 
 Author: Volker Braun
 
```




---

archive/issue_comments_137108.json:
```json
{
    "body": "Changing keywords from \"\" to \"sd32\".",
    "created_at": "2011-08-24T23:31:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11729#issuecomment-137108",
    "user": "https://github.com/williamstein"
}
```

Changing keywords from "" to "sd32".



---

archive/issue_comments_137109.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,7 @@\n+This ticket implements a cached module importer for Python. It compiles a list of all available files during build (when sage -b is run), hooks into the Python import framework and finds modules by the predetermined file list.\n \n+\n+Apply trac_11729_cached_importer.patch to the sage library and  trac_11729_import_cache_during_build.patch to the sage_scripts (\\`$AGE_LOCAL/bin\\`) repository.\n \n Author: Volker Braun\n \n```\n",
    "created_at": "2011-08-25T06:31:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11729#issuecomment-137109",
    "user": "https://github.com/vbraun"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,7 @@
+This ticket implements a cached module importer for Python. It compiles a list of all available files during build (when sage -b is run), hooks into the Python import framework and finds modules by the predetermined file list.
 
+
+Apply trac_11729_cached_importer.patch to the sage library and  trac_11729_import_cache_during_build.patch to the sage_scripts (\`$AGE_LOCAL/bin\`) repository.
 
 Author: Volker Braun
 
```




---

archive/issue_comments_137110.json:
```json
{
    "body": "<a id='comment:6'></a>NOTE: If you try to test this, watch out because of these lines:\n\n```\n\t113\tcat <<EOF > \"$SAGE_LOCAL/lib/python/site-packages/sitecustomize.py\" \n \t114\tfrom sage.misc.importer import sage_importer \n \t115\tsage_importer.register() \n \t116\tEOF \n```\nThey can make it so your Sage install is totally broken.  To fix, just remove the contents of sitecustomize.py.   I spent 15 minutes confused by this.",
    "created_at": "2011-08-26T01:29:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11729#issuecomment-137110",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:6'></a>NOTE: If you try to test this, watch out because of these lines:

```
	113	cat <<EOF > "$SAGE_LOCAL/lib/python/site-packages/sitecustomize.py" 
 	114	from sage.misc.importer import sage_importer 
 	115	sage_importer.register() 
 	116	EOF 
```
They can make it so your Sage install is totally broken.  To fix, just remove the contents of sitecustomize.py.   I spent 15 minutes confused by this.



---

archive/issue_comments_137111.json:
```json
{
    "body": "<a id='comment:7'></a>You have to delete both `$SAGE_LOCAL/lib/python/site-packages/sitecustomize.py` and `$SAGE_LOCAL/lib/python/site-packages/sitecustomize.pyc`, though the latter might not exist. The final version of the patch will test that sage starts up successfully and otherwise delete the `sitecustomize.py` automatically.\n\nAlso, if you run into problems (presumably some `ImportError`), please post what is causing it.",
    "created_at": "2011-08-26T02:57:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11729#issuecomment-137111",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:7'></a>You have to delete both `$SAGE_LOCAL/lib/python/site-packages/sitecustomize.py` and `$SAGE_LOCAL/lib/python/site-packages/sitecustomize.pyc`, though the latter might not exist. The final version of the patch will test that sage starts up successfully and otherwise delete the `sitecustomize.py` automatically.

Also, if you run into problems (presumably some `ImportError`), please post what is causing it.



---

archive/issue_comments_137112.json:
```json
{
    "body": "Updated patch",
    "created_at": "2011-08-27T03:00:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11729#issuecomment-137112",
    "user": "https://github.com/vbraun"
}
```

Updated patch



---

archive/issue_comments_137113.json:
```json
{
    "body": "Attachment [trac_11729_cached_importer.patch](tarball://root/attachments/some-uuid/ticket11729/trac_11729_cached_importer.patch) by @vbraun created at 2011-09-12 17:45:45\n\nUpdated patch",
    "created_at": "2011-09-12T17:45:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11729#issuecomment-137113",
    "user": "https://github.com/vbraun"
}
```

Attachment [trac_11729_cached_importer.patch](tarball://root/attachments/some-uuid/ticket11729/trac_11729_cached_importer.patch) by @vbraun created at 2011-09-12 17:45:45

Updated patch



---

archive/issue_comments_137114.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,25 @@\n+This ticket implements a cached module importer for Python. It compiles a list of all available files during build (when \\`sage -b\\` is run), hooks into the Python import framework and finds modules by the predetermined file list. \n+\n+Building the Sage library (\\`sage -b\\`) automatically creates the cache and the \\`sitecustomize.py\\` that is used to load the importer into the Python session. The cache is a standard Python dictionary in \\`sage/misc/modules_cache.py\\`.\n+\n+\\`\\`\\`\n+[vbraun@volker-laptop-two hg]$ strace -e file -f sage -c quit |& grep ENOENT | wc -l\n+26327\n+[vbraun@volker-laptop-two hg]$ sage -b\n+...\n+[vbraun@volker-laptop-two hg]$ strace -e file -f sage -c quit |& grep ENOENT | wc -l\n+3785\n+\\`\\`\\`\n+\n+If you encounter any problems while testing this patch, you have to \n+\n+\\`\\`\\`\n+rm $SAGE_LOCAL/lib/python/site-packages/sitecustomize.py*\n+\\`\\`\\`\n+to not load the importer during Python startup.\n+\n+\n+Apply trac_11729_cached_importer.patch to the sage library and  trac_11729_import_cache_during_build.patch to the sage_scripts (\\`$AGE_LOCAL/bin\\`) repository.\n \n \n Author: Volker Braun\n```\n",
    "created_at": "2011-09-12T18:06:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11729#issuecomment-137114",
    "user": "https://github.com/vbraun"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,25 @@
+This ticket implements a cached module importer for Python. It compiles a list of all available files during build (when \`sage -b\` is run), hooks into the Python import framework and finds modules by the predetermined file list. 
+
+Building the Sage library (\`sage -b\`) automatically creates the cache and the \`sitecustomize.py\` that is used to load the importer into the Python session. The cache is a standard Python dictionary in \`sage/misc/modules_cache.py\`.
+
+\`\`\`
+[vbraun@volker-laptop-two hg]$ strace -e file -f sage -c quit |& grep ENOENT | wc -l
+26327
+[vbraun@volker-laptop-two hg]$ sage -b
+...
+[vbraun@volker-laptop-two hg]$ strace -e file -f sage -c quit |& grep ENOENT | wc -l
+3785
+\`\`\`
+
+If you encounter any problems while testing this patch, you have to 
+
+\`\`\`
+rm $SAGE_LOCAL/lib/python/site-packages/sitecustomize.py*
+\`\`\`
+to not load the importer during Python startup.
+
+
+Apply trac_11729_cached_importer.patch to the sage library and  trac_11729_import_cache_during_build.patch to the sage_scripts (\`$AGE_LOCAL/bin\`) repository.
 
 
 Author: Volker Braun
```




---

archive/issue_comments_137115.json:
```json
{
    "body": "<a id='comment:8'></a>I've added another workaround for `PIL.Image`, now `make ptest` passes! I would say that the patch is now feature-complete, though it lacks documentation and doctests. Though writing doctests is tricky without breaking the module importing. Somebody should test it on OSX :-)",
    "created_at": "2011-09-12T18:06:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11729#issuecomment-137115",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:8'></a>I've added another workaround for `PIL.Image`, now `make ptest` passes! I would say that the patch is now feature-complete, though it lacks documentation and doctests. Though writing doctests is tricky without breaking the module importing. Somebody should test it on OSX :-)



---

archive/issue_events_030838.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11729#event-30838"
}
```



---

archive/issue_events_030839.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11729#event-30839"
}
```



---

archive/issue_events_030840.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11729#event-30840"
}
```



---

archive/issue_events_030841.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11729#event-30841"
}
```



---

archive/issue_events_030842.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11729#event-30842"
}
```



---

archive/issue_events_030843.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11729#event-30843"
}
```



---

archive/issue_events_030844.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11729#event-30844"
}
```



---

archive/issue_comments_137116.json:
```json
{
    "body": "<a id='comment:15'></a>outdated, should close",
    "created_at": "2021-12-02T00:55:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11729#issuecomment-137116",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:15'></a>outdated, should close



---

archive/issue_events_030845.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-02T00:55:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11729#event-30845"
}
```



---

archive/issue_events_030846.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-02T00:55:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11729#event-30846"
}
```



---

archive/issue_comments_137117.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-12-02T00:55:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11729#issuecomment-137117",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_137118.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-12-03T09:33:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11729#issuecomment-137118",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_137119.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2021-12-03T18:41:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11729#issuecomment-137119",
    "user": "https://github.com/mkoeppe"
}
```

Resolution: invalid



---

archive/issue_events_030847.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-03T18:41:01Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/11729",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11729#event-30847"
}
```
