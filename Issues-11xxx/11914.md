# Issue 11914: `sage -n` fails when current directory is $SAGE_ROOT/devel/sage

archive/issues_011742.json:
```json
{
    "body": "Traceback as follows:\n\n```\nfs@zhenghe /opt/sage/devel/sage $ ../../sage -n\n----------------------------------------------------------------------\n| Sage Version 4.7.2.alpha3, Release Date: 2011-09-28                |\n| Type notebook() for the GUI, and license() for information.        |\n----------------------------------------------------------------------\n**********************************************************************\n*                                                                    *\n* Warning: this is a prerelease version, and it may be unstable.     *\n*                                                                    *\n**********************************************************************\n\nPlease wait while the Sage Notebook server starts...\nTraceback (most recent call last):\n  File \"/opt/sage/local/bin/sage-notebook\", line 9, in <module>\n    from sage.server.notebook.all import notebook\n  File \"/opt/sage-4.7.2.alpha3/devel/sage-main/sage/server/notebook/all.py\", line 22, in <module>\n    from sagenb.notebook.all import *\n  File \"/opt/sage/devel/sagenb/sagenb/notebook/all.py\", line 18, in <module>\n    from interact import interact, input_box, slider, range_slider, selector, checkbox, input_grid, text_control, color_selector\n  File \"/opt/sage/devel/sagenb/sagenb/notebook/interact.py\", line 158, in <module>\n    from sage.misc.cachefunc import cached_method\n  File \"/opt/sage-4.7.2.alpha3/devel/sage-main/sage/misc/cachefunc.py\", line 22, in <module>\n    from function_mangling import ArgumentFixer\nImportError: No module named function_mangling\nfs@zhenghe /opt/sage/devel/sage $ \n```\n\nppurka suggests prepending `$SAGE_ROOT/devel/sage/build/sage/` to `PYTHONPATH` in `sage-env`. This indeed works, but I'm not sure what else it might break. Advice?\n\n---\n\nRelated: #10192 (SageNB is broken if \"`.`\" is *explicitly* contained in `PYTHONPATH` **during installation** of it.)\n\n---\n\nApply [attachment:trac_11914-sage-env-pythonpath.patch](https://github.com/sagemath/sage/files/ticket11914/trac_11914-sage-env-pythonpath.patch) to `$SAGE_ROOT/local/bin`\n\n**CC:**  @ppurka @nexttime\n\n**Keywords:** notebook SageNB startup, crash, sage-env PYTHONPATH\n\n**Author:** Leif Leonhardy\n\n**Reviewer:** Keshav Kini, John Palmieri\n\n**Merged:** sage-4.8.alpha0\n\nIssue created by migration from https://trac.sagemath.org/ticket/11914\n\n",
    "closed_at": "2011-10-17T07:58:18Z",
    "created_at": "2011-10-11T11:44:03Z",
    "labels": [
        "component: scripts",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-4.8",
    "title": "`sage -n` fails when current directory is $SAGE_ROOT/devel/sage",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/11914",
    "user": "https://github.com/kini"
}
```
Traceback as follows:

```
fs@zhenghe /opt/sage/devel/sage $ ../../sage -n
----------------------------------------------------------------------
| Sage Version 4.7.2.alpha3, Release Date: 2011-09-28                |
| Type notebook() for the GUI, and license() for information.        |
----------------------------------------------------------------------
**********************************************************************
*                                                                    *
* Warning: this is a prerelease version, and it may be unstable.     *
*                                                                    *
**********************************************************************

Please wait while the Sage Notebook server starts...
Traceback (most recent call last):
  File "/opt/sage/local/bin/sage-notebook", line 9, in <module>
    from sage.server.notebook.all import notebook
  File "/opt/sage-4.7.2.alpha3/devel/sage-main/sage/server/notebook/all.py", line 22, in <module>
    from sagenb.notebook.all import *
  File "/opt/sage/devel/sagenb/sagenb/notebook/all.py", line 18, in <module>
    from interact import interact, input_box, slider, range_slider, selector, checkbox, input_grid, text_control, color_selector
  File "/opt/sage/devel/sagenb/sagenb/notebook/interact.py", line 158, in <module>
    from sage.misc.cachefunc import cached_method
  File "/opt/sage-4.7.2.alpha3/devel/sage-main/sage/misc/cachefunc.py", line 22, in <module>
    from function_mangling import ArgumentFixer
ImportError: No module named function_mangling
fs@zhenghe /opt/sage/devel/sage $ 
```

ppurka suggests prepending `$SAGE_ROOT/devel/sage/build/sage/` to `PYTHONPATH` in `sage-env`. This indeed works, but I'm not sure what else it might break. Advice?

---

Related: #10192 (SageNB is broken if "`.`" is *explicitly* contained in `PYTHONPATH` **during installation** of it.)

---

Apply [attachment:trac_11914-sage-env-pythonpath.patch](https://github.com/sagemath/sage/files/ticket11914/trac_11914-sage-env-pythonpath.patch) to `$SAGE_ROOT/local/bin`

**CC:**  @ppurka @nexttime

**Keywords:** notebook SageNB startup, crash, sage-env PYTHONPATH

**Author:** Leif Leonhardy

**Reviewer:** Keshav Kini, John Palmieri

**Merged:** sage-4.8.alpha0

Issue created by migration from https://trac.sagemath.org/ticket/11914





---

archive/issue_comments_127816.json:
```json
{
    "body": "<a id='comment:2'></a>\nTo clarify, it seems that Python is trying to load the sage library from `$SAGE_ROOT/devel/sage/sage/` (which equals `./sage/` in this context) rather than from `$SAGE_ROOT/devel/sage/build/sage/`, thus ppurka's `PYTHONPATH` fix.",
    "created_at": "2011-10-11T11:50:30Z",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11914#issuecomment-127816",
    "user": "https://github.com/kini"
}
```

<a id='comment:2'></a>
To clarify, it seems that Python is trying to load the sage library from `$SAGE_ROOT/devel/sage/sage/` (which equals `./sage/` in this context) rather than from `$SAGE_ROOT/devel/sage/build/sage/`, thus ppurka's `PYTHONPATH` fix.



---

archive/issue_comments_127817.json:
```json
{
    "body": "<a id='comment:3'></a>\nReplying to [kini](#comment%3A2):\n> To clarify, it seems that Python is trying to load the sage library from `$SAGE_ROOT/devel/sage/sage/` (which equals `./sage/` in this context) rather than from `$SAGE_ROOT/devel/sage/build/sage/`, thus ppurka's `PYTHONPATH` fix.\n\nThe subdirectory `./sage` was my guess...",
    "created_at": "2011-10-11T13:44:02Z",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11914#issuecomment-127817",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:3'></a>
Replying to [kini](#comment%3A2):
> To clarify, it seems that Python is trying to load the sage library from `$SAGE_ROOT/devel/sage/sage/` (which equals `./sage/` in this context) rather than from `$SAGE_ROOT/devel/sage/build/sage/`, thus ppurka's `PYTHONPATH` fix.

The subdirectory `./sage` was my guess...



---

archive/issue_comments_127818.json:
```json
{
    "body": "<a id='comment:4'></a>\nReplying to [leif](#comment%3A3):\n> Replying to [kini](#comment%3A2):\n> > To clarify, it seems that Python is trying to load the sage library from `$SAGE_ROOT/devel/sage/sage/` (which equals `./sage/` in this context) rather than from `$SAGE_ROOT/devel/sage/build/sage/`, thus ppurka's `PYTHONPATH` fix.\n\n> \n> The subdirectory `./sage` was my guess...\n\n```sh\n$ cd $SAGE_ROOT\n$ (mkdir -p tmp/sage/sage && cd tmp/sage && ../../sage -n)\n```\n\nin contrast works for me.",
    "created_at": "2011-10-11T14:39:21Z",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11914#issuecomment-127818",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:4'></a>
Replying to [leif](#comment%3A3):
> Replying to [kini](#comment%3A2):
> > To clarify, it seems that Python is trying to load the sage library from `$SAGE_ROOT/devel/sage/sage/` (which equals `./sage/` in this context) rather than from `$SAGE_ROOT/devel/sage/build/sage/`, thus ppurka's `PYTHONPATH` fix.

> 
> The subdirectory `./sage` was my guess...

```sh
$ cd $SAGE_ROOT
$ (mkdir -p tmp/sage/sage && cd tmp/sage && ../../sage -n)
```

in contrast works for me.



---

archive/issue_comments_127819.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [leif](#comment%3A4):\n> ` #!sh $ cd $SAGE_ROOT $ (mkdir -p tmp/sage/sage && cd tmp/sage && ../../sage -n) ` in contrast works for me.\n\nBut the following doesn't work:\n\n```\ncd Installations/sage-4.7/tmp\nln -s ../devel/sage/sage .\n../sage -n\n```",
    "created_at": "2011-10-12T03:20:27Z",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11914#issuecomment-127819",
    "user": "https://github.com/ppurka"
}
```

<a id='comment:5'></a>
Replying to [leif](#comment%3A4):
> ` #!sh $ cd $SAGE_ROOT $ (mkdir -p tmp/sage/sage && cd tmp/sage && ../../sage -n) ` in contrast works for me.

But the following doesn't work:

```
cd Installations/sage-4.7/tmp
ln -s ../devel/sage/sage .
../sage -n
```



---

archive/issue_comments_127820.json:
```json
{
    "body": "<a id='comment:6'></a>\nIf I delete the file `SAGE_ROOT/devel/sage/sage/__init__.py` (and the corresponding .pyc file if present), then I don't see this problem.  Should that file be autogenerated (as `SAGE_ROOT/local/lib/python/site-packages/sage/__init__.py`, say by the `install` script in devel/sage) when necessary?  Or is that a bad, or a too complicated, idea?",
    "created_at": "2011-10-12T03:53:05Z",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11914#issuecomment-127820",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:6'></a>
If I delete the file `SAGE_ROOT/devel/sage/sage/__init__.py` (and the corresponding .pyc file if present), then I don't see this problem.  Should that file be autogenerated (as `SAGE_ROOT/local/lib/python/site-packages/sage/__init__.py`, say by the `install` script in devel/sage) when necessary?  Or is that a bad, or a too complicated, idea?



---

archive/issue_comments_127821.json:
```json
{
    "body": "<a id='comment:7'></a>\nBut `$SAGE_ROOT/local/lib/python/site-packages/sage` is a symlink to `$SAGE_ROOT/local/lib/python/site-packages/../../../../devel/sage/build/sage`, which already contains an `__init__.py`. Or am I misunderstanding what you propose to do?",
    "created_at": "2011-10-12T04:01:14Z",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11914#issuecomment-127821",
    "user": "https://github.com/kini"
}
```

<a id='comment:7'></a>
But `$SAGE_ROOT/local/lib/python/site-packages/sage` is a symlink to `$SAGE_ROOT/local/lib/python/site-packages/../../../../devel/sage/build/sage`, which already contains an `__init__.py`. Or am I misunderstanding what you propose to do?



---

archive/issue_comments_127822.json:
```json
{
    "body": "<a id='comment:8'></a>\nNever mind, I guess you mean we should remove `__init__.py` from `$SAGE_ROOT/devel/sage/sage`. I don't think this is a good idea, as it *is* part of the Sage library.",
    "created_at": "2011-10-12T04:02:33Z",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11914#issuecomment-127822",
    "user": "https://github.com/kini"
}
```

<a id='comment:8'></a>
Never mind, I guess you mean we should remove `__init__.py` from `$SAGE_ROOT/devel/sage/sage`. I don't think this is a good idea, as it *is* part of the Sage library.



---

archive/issue_comments_127823.json:
```json
{
    "body": "<a id='comment:9'></a>\nOr perhaps this patch to the script sage-notebook:\n\n```diff\ndiff --git a/sage-notebook b/sage-notebook\n--- a/sage-notebook\n+++ b/sage-notebook\n@@ -2,6 +2,13 @@\n \n import os, sys, socket\n \n+CUR=os.path.abspath(os.curdir)\n+if os.path.samefile(CUR, os.path.join(os.environ['SAGE_ROOT'], 'devel', 'sage')):\n+    try:\n+        sys.path.remove(CUR)\n+    except ValueError:\n+        pass\n+\n print open(os.environ['SAGE_ROOT'] + '/local/bin/sage-banner').read()\n \n print \"Please wait while the Sage Notebook server starts...\"\n```\nThis looks safer than my first suggestion, although it could be a bit more refined: search sys.path not just for CUR, but for anything which is equivalent to CUR.",
    "created_at": "2011-10-12T04:04:35Z",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11914#issuecomment-127823",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:9'></a>
Or perhaps this patch to the script sage-notebook:

```diff
diff --git a/sage-notebook b/sage-notebook
--- a/sage-notebook
+++ b/sage-notebook
@@ -2,6 +2,13 @@
 
 import os, sys, socket
 
+CUR=os.path.abspath(os.curdir)
+if os.path.samefile(CUR, os.path.join(os.environ['SAGE_ROOT'], 'devel', 'sage')):
+    try:
+        sys.path.remove(CUR)
+    except ValueError:
+        pass
+
 print open(os.environ['SAGE_ROOT'] + '/local/bin/sage-banner').read()
 
 print "Please wait while the Sage Notebook server starts..."
```
This looks safer than my first suggestion, although it could be a bit more refined: search sys.path not just for CUR, but for anything which is equivalent to CUR.



---

archive/issue_comments_127824.json:
```json
{
    "body": "<a id='comment:10'></a>\nThat raises the question of whether we want to fix this too:\n\n```\nfs@zhenghe ~ $ mkdir sage\nfs@zhenghe ~ $ touch sage/__init__.py\nfs@zhenghe ~ $ sage -n\n----------------------------------------------------------------------\n| Sage Version 4.7.2.alpha3, Release Date: 2011-09-28                |\n| Type notebook() for the GUI, and license() for information.        |\n----------------------------------------------------------------------\n**********************************************************************\n*                                                                    *\n* Warning: this is a prerelease version, and it may be unstable.     *\n*                                                                    *\n**********************************************************************\n\nPlease wait while the Sage Notebook server starts...\nTraceback (most recent call last):\n  File \"/opt/sage/local/bin/sage-notebook\", line 9, in <module>\n    from sage.server.notebook.all import notebook\nImportError: No module named server.notebook.all\n```",
    "created_at": "2011-10-12T04:12:18Z",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11914#issuecomment-127824",
    "user": "https://github.com/kini"
}
```

<a id='comment:10'></a>
That raises the question of whether we want to fix this too:

```
fs@zhenghe ~ $ mkdir sage
fs@zhenghe ~ $ touch sage/__init__.py
fs@zhenghe ~ $ sage -n
----------------------------------------------------------------------
| Sage Version 4.7.2.alpha3, Release Date: 2011-09-28                |
| Type notebook() for the GUI, and license() for information.        |
----------------------------------------------------------------------
**********************************************************************
*                                                                    *
* Warning: this is a prerelease version, and it may be unstable.     *
*                                                                    *
**********************************************************************

Please wait while the Sage Notebook server starts...
Traceback (most recent call last):
  File "/opt/sage/local/bin/sage-notebook", line 9, in <module>
    from sage.server.notebook.all import notebook
ImportError: No module named server.notebook.all
```



---

archive/issue_comments_127825.json:
```json
{
    "body": "<a id='comment:11'></a>\nPffffffff...\n\nHow about this:\n\n```diff\ndiff --git a/sage-env b/sage-env\n--- a/sage-env\n+++ b/sage-env\n@@ -186,7 +186,12 @@\n fi\n \n if [ -d \"$SAGE_ROOT/local/lib/python\" ]; then\n-    PYTHONPATH=\"$SAGE_PATH:$SAGE_ROOT/local/lib/python\"   && export PYTHONPATH\n+    if [ -n \"$SAGE_PATH\" ]; then\n+        PYTHONPATH=\"$SAGE_PATH:$SAGE_ROOT/local/lib/python\"\n+    else\n+        PYTHONPATH=\"$SAGE_ROOT/local/lib/python\"\n+    fi\n+    export PYTHONPATH\n     PYTHONHOME=\"$SAGE_ROOT/local\" && export PYTHONHOME\n fi\n \n```\n\nWe could make it more nice of course.\n\nThis disturbed me for a while now...",
    "created_at": "2011-10-12T04:17:28Z",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11914#issuecomment-127825",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:11'></a>
Pffffffff...

How about this:

```diff
diff --git a/sage-env b/sage-env
--- a/sage-env
+++ b/sage-env
@@ -186,7 +186,12 @@
 fi
 
 if [ -d "$SAGE_ROOT/local/lib/python" ]; then
-    PYTHONPATH="$SAGE_PATH:$SAGE_ROOT/local/lib/python"   && export PYTHONPATH
+    if [ -n "$SAGE_PATH" ]; then
+        PYTHONPATH="$SAGE_PATH:$SAGE_ROOT/local/lib/python"
+    else
+        PYTHONPATH="$SAGE_ROOT/local/lib/python"
+    fi
+    export PYTHONPATH
     PYTHONHOME="$SAGE_ROOT/local" && export PYTHONHOME
 fi
 
```

We could make it more nice of course.

This disturbed me for a while now...



---

archive/issue_comments_127826.json:
```json
{
    "body": "<a id='comment:12'></a>\nReplying to [leif](#comment%3A11):\n> We could make it more nice of course.\n\nLike this for example:\n\n```diff\ndiff --git a/sage-env b/sage-env\n--- a/sage-env\n+++ b/sage-env\n@@ -186,8 +186,13 @@\n fi\n \n if [ -d \"$SAGE_ROOT/local/lib/python\" ]; then\n-    PYTHONPATH=\"$SAGE_PATH:$SAGE_ROOT/local/lib/python\"   && export PYTHONPATH\n-    PYTHONHOME=\"$SAGE_ROOT/local\" && export PYTHONHOME\n+    PYTHONPATH=\"$SAGE_ROOT/local/lib/python\"\n+    if [ -n \"$SAGE_PATH\" ]; then\n+        PYTHONPATH=\"$SAGE_PATH:$PYTHONPATH\"\n+    fi\n+    PYTHONHOME=\"$SAGE_ROOT/local\"\n+    export PYTHONPATH\n+    export PYTHONHOME\n fi\n \n if [ -z \"${SAGE_ORIG_LD_LIBRARY_PATH_SET}\" ]; then\n```",
    "created_at": "2011-10-12T04:23:30Z",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11914#issuecomment-127826",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:12'></a>
Replying to [leif](#comment%3A11):
> We could make it more nice of course.

Like this for example:

```diff
diff --git a/sage-env b/sage-env
--- a/sage-env
+++ b/sage-env
@@ -186,8 +186,13 @@
 fi
 
 if [ -d "$SAGE_ROOT/local/lib/python" ]; then
-    PYTHONPATH="$SAGE_PATH:$SAGE_ROOT/local/lib/python"   && export PYTHONPATH
-    PYTHONHOME="$SAGE_ROOT/local" && export PYTHONHOME
+    PYTHONPATH="$SAGE_ROOT/local/lib/python"
+    if [ -n "$SAGE_PATH" ]; then
+        PYTHONPATH="$SAGE_PATH:$PYTHONPATH"
+    fi
+    PYTHONHOME="$SAGE_ROOT/local"
+    export PYTHONPATH
+    export PYTHONHOME
 fi
 
 if [ -z "${SAGE_ORIG_LD_LIBRARY_PATH_SET}" ]; then
```



---

archive/issue_comments_127827.json:
```json
{
    "body": "<a id='comment:13'></a>\n(I don't know what potentially weird shells might source `sage-env`, otherwise I'd use `export FOO=\"bar\"` or `export FOO BAR` etc.)",
    "created_at": "2011-10-12T04:26:24Z",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11914#issuecomment-127827",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:13'></a>
(I don't know what potentially weird shells might source `sage-env`, otherwise I'd use `export FOO="bar"` or `export FOO BAR` etc.)



---

archive/issue_comments_127828.json:
```json
{
    "body": "<a id='comment:14'></a>\nWhat, seriously!? The cause of this is just the colon at the beginning of `PYTHONPATH`? Well then your solution is simple and obviously the correct way to fix this, it seems to me.",
    "created_at": "2011-10-12T04:28:44Z",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11914#issuecomment-127828",
    "user": "https://github.com/kini"
}
```

<a id='comment:14'></a>
What, seriously!? The cause of this is just the colon at the beginning of `PYTHONPATH`? Well then your solution is simple and obviously the correct way to fix this, it seems to me.



---

archive/issue_comments_127829.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [kini](#comment%3A14):\n> What, seriously!? The cause of this is just the colon at the beginning of `PYTHONPATH`? Well then your solution is simple and obviously the correct way to fix this, it seems to me.\n\nPython interprets the empty entry as the current working directory (\"`.`\").",
    "created_at": "2011-10-12T04:30:36Z",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11914#issuecomment-127829",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:15'></a>
Replying to [kini](#comment%3A14):
> What, seriously!? The cause of this is just the colon at the beginning of `PYTHONPATH`? Well then your solution is simple and obviously the correct way to fix this, it seems to me.

Python interprets the empty entry as the current working directory ("`.`").



---

archive/issue_comments_127830.json:
```json
{
    "body": "<a id='comment:16'></a>\nReplying to [leif](#comment%3A13):\n> (I don't know what potentially weird shells might source `sage-env`, otherwise I'd use `export FOO=\"bar\"` or `export FOO BAR` etc.)\n\nIs sage-env even called from anywhere outside Sage scripts? It seems weird that all the sage scripts are called as `#!/usr/bin/env bash` but the scripts themselves are not written (most of the time) as bash scripts. It should probably be like the `$SAGE_ROOT/sage` script should be POSIX shell compatible and then the rest should be proper bash scripts, since they anyway invoke bash. It will make the scripts nicer and easier to read.\n\nThanks for the PYTHONPATH fix. Didn't know that empty paths resolve to current directory.",
    "created_at": "2011-10-12T05:33:13Z",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11914#issuecomment-127830",
    "user": "https://github.com/ppurka"
}
```

<a id='comment:16'></a>
Replying to [leif](#comment%3A13):
> (I don't know what potentially weird shells might source `sage-env`, otherwise I'd use `export FOO="bar"` or `export FOO BAR` etc.)

Is sage-env even called from anywhere outside Sage scripts? It seems weird that all the sage scripts are called as `#!/usr/bin/env bash` but the scripts themselves are not written (most of the time) as bash scripts. It should probably be like the `$SAGE_ROOT/sage` script should be POSIX shell compatible and then the rest should be proper bash scripts, since they anyway invoke bash. It will make the scripts nicer and easier to read.

Thanks for the PYTHONPATH fix. Didn't know that empty paths resolve to current directory.



---

archive/issue_comments_127831.json:
```json
{
    "body": "<a id='comment:17'></a>\nIf they are mostly written as POSIX-compatible, why not just go all the way and make them all call `sh` instead, and remove bashisms? But this is getting off topic, I think...\n\nI'll make an hg patch out of leif's diff.",
    "created_at": "2011-10-12T05:42:15Z",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11914#issuecomment-127831",
    "user": "https://github.com/kini"
}
```

<a id='comment:17'></a>
If they are mostly written as POSIX-compatible, why not just go all the way and make them all call `sh` instead, and remove bashisms? But this is getting off topic, I think...

I'll make an hg patch out of leif's diff.



---

archive/issue_comments_127832.json:
```json
{
    "body": "apply to $SAGE_ROOT/local/bin",
    "created_at": "2011-10-12T05:43:35Z",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11914#issuecomment-127832",
    "user": "https://github.com/kini"
}
```

apply to $SAGE_ROOT/local/bin



---

archive/issue_comments_127833.json:
```json
{
    "body": "**Author:** Leif Leonhardy",
    "created_at": "2011-10-12T05:45:01Z",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11914#issuecomment-127833",
    "user": "https://github.com/kini"
}
```

**Author:** Leif Leonhardy



---

archive/attachments_016406.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_11914-sage-env-pythonpath.patch",
    "asset_url": "tarball://root/attachments/ticket11914/trac_11914-sage-env-pythonpath.patch",
    "created_at": "2011-10-12T05:45:01Z",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket11914/trac_11914-sage-env-pythonpath.patch",
    "user": "https://github.com/kini"
}
```



---

archive/issue_comments_127834.json:
```json
{
    "body": "<a id='comment:18'></a>\n**Attachment:** [trac_11914-sage-env-pythonpath.patch](https://github.com/sagemath/sage/files/ticket11914/trac_11914-sage-env-pythonpath.patch)",
    "created_at": "2011-10-12T05:45:01Z",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11914#issuecomment-127834",
    "user": "https://github.com/kini"
}
```

<a id='comment:18'></a>
**Attachment:** [trac_11914-sage-env-pythonpath.patch](https://github.com/sagemath/sage/files/ticket11914/trac_11914-sage-env-pythonpath.patch)



---

archive/issue_events_095941.json:
```json
{
    "actor": "https://github.com/kini",
    "created_at": "2011-10-12T05:45:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11914#event-95941"
}
```



---

archive/issue_comments_127835.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -29,3 +29,7 @@\n ```\n \n ppurka suggests prepending `$SAGE_ROOT/devel/sage/build/sage/` to `PYTHONPATH` in `sage-env`. This indeed works, but I'm not sure what else it might break. Advice?\n+\n+---\n+\n+Apply [attachment:trac_11914-sage-env-pythonpath.patch](https://github.com/sagemath/sage/files/ticket11914/trac_11914-sage-env-pythonpath.patch) to `$SAGE_ROOT/local/bin`\n``````\n",
    "created_at": "2011-10-12T05:45:01Z",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11914#issuecomment-127835",
    "user": "https://github.com/kini"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -29,3 +29,7 @@
 ```
 
 ppurka suggests prepending `$SAGE_ROOT/devel/sage/build/sage/` to `PYTHONPATH` in `sage-env`. This indeed works, but I'm not sure what else it might break. Advice?
+
+---
+
+Apply [attachment:trac_11914-sage-env-pythonpath.patch](https://github.com/sagemath/sage/files/ticket11914/trac_11914-sage-env-pythonpath.patch) to `$SAGE_ROOT/local/bin`
``````




---

archive/issue_comments_127836.json:
```json
{
    "body": "<a id='comment:19'></a>\nI'll leave formal review to others who know shell scripting better than I, but it looks fine to me, fwiw.",
    "created_at": "2011-10-12T05:45:44Z",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11914#issuecomment-127836",
    "user": "https://github.com/kini"
}
```

<a id='comment:19'></a>
I'll leave formal review to others who know shell scripting better than I, but it looks fine to me, fwiw.



---

archive/issue_comments_127837.json:
```json
{
    "body": "<a id='comment:20'></a>\nReplying to [kini](#comment%3A17):\n> If they are mostly written as POSIX-compatible, why not just go all the way and make them all call `sh` instead, and remove bashisms? But this is getting off topic, I think...\n\nHmmm.  In principle we should avoid bashisms whenever possible.  (One of the very few exceptions would IMHO be `set -o pipefail`, which is supported by bashs >=3.0, but we still officially require just 2.04 since this version is shipped with MacOS X 10.4 [which is a mess to support anyway], <flame> and its users are incapable of installing a more recent version </flame>.)\n\nThe main reason we use `bash` is that we can to some extent rely on it being functional; there are too many broken Bourne shells, or at least `/bin/sh`ells.\n\n\n\n\n> I'll make an hg patch out of leif's diff.\n\nNice service, thanks.\n\nI just wonder how many parts of Sage (unconsciously exploiting it) break if we fix this bug.",
    "created_at": "2011-10-12T05:58:34Z",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11914#issuecomment-127837",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:20'></a>
Replying to [kini](#comment%3A17):
> If they are mostly written as POSIX-compatible, why not just go all the way and make them all call `sh` instead, and remove bashisms? But this is getting off topic, I think...

Hmmm.  In principle we should avoid bashisms whenever possible.  (One of the very few exceptions would IMHO be `set -o pipefail`, which is supported by bashs >=3.0, but we still officially require just 2.04 since this version is shipped with MacOS X 10.4 [which is a mess to support anyway], <flame> and its users are incapable of installing a more recent version </flame>.)

The main reason we use `bash` is that we can to some extent rely on it being functional; there are too many broken Bourne shells, or at least `/bin/sh`ells.




> I'll make an hg patch out of leif's diff.

Nice service, thanks.

I just wonder how many parts of Sage (unconsciously exploiting it) break if we fix this bug.



---

archive/issue_comments_127838.json:
```json
{
    "body": "<a id='comment:21'></a>\nWell, I'll run a doctest, though I doubt this will catch anything relevant...",
    "created_at": "2011-10-12T08:26:31Z",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11914#issuecomment-127838",
    "user": "https://github.com/kini"
}
```

<a id='comment:21'></a>
Well, I'll run a doctest, though I doubt this will catch anything relevant...



---

archive/issue_comments_127839.json:
```json
{
    "body": "<a id='comment:22'></a>\nI don't think anything should break because the following two commands returned no output:\n\n```\n...lations/sage-4.7.2 [130] > LC_ALL=\"C\" grep -re 'from [^\\.]+[[:space:]]+import' *\n...allations/sage-4.7.2 [1] > LC_ALL=\"C\" grep -re '^[[:space:]]+import [^\\.]+' *\n...allations/sage-4.7.2 [1] > \n```",
    "created_at": "2011-10-12T08:51:04Z",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11914#issuecomment-127839",
    "user": "https://github.com/ppurka"
}
```

<a id='comment:22'></a>
I don't think anything should break because the following two commands returned no output:

```
...lations/sage-4.7.2 [130] > LC_ALL="C" grep -re 'from [^\.]+[[:space:]]+import' *
...allations/sage-4.7.2 [1] > LC_ALL="C" grep -re '^[[:space:]]+import [^\.]+' *
...allations/sage-4.7.2 [1] > 
```



---

archive/issue_comments_127840.json:
```json
{
    "body": "<a id='comment:23'></a>\nNeglect above post. Really weird. It should have returned some output.",
    "created_at": "2011-10-12T08:55:16Z",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11914#issuecomment-127840",
    "user": "https://github.com/ppurka"
}
```

<a id='comment:23'></a>
Neglect above post. Really weird. It should have returned some output.



---

archive/issue_comments_127841.json:
```json
{
    "body": "<a id='comment:24'></a>\nAll tests pass on `sage.math.washington.edu`, as expected.",
    "created_at": "2011-10-12T09:06:23Z",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11914#issuecomment-127841",
    "user": "https://github.com/kini"
}
```

<a id='comment:24'></a>
All tests pass on `sage.math.washington.edu`, as expected.



---

archive/issue_comments_127842.json:
```json
{
    "body": "<a id='comment:25'></a>\nAdded a reference to #10192.",
    "created_at": "2011-10-13T11:10:02Z",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11914#issuecomment-127842",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:25'></a>
Added a reference to #10192.



---

archive/issue_comments_127843.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -32,4 +32,8 @@\n \n ---\n \n+Related: #10192 (SageNB is broken if \"`.`\" is *explicitly* contained in `PYTHONPATH` **during installation** of it.)\n+\n+---\n+\n Apply [attachment:trac_11914-sage-env-pythonpath.patch](https://github.com/sagemath/sage/files/ticket11914/trac_11914-sage-env-pythonpath.patch) to `$SAGE_ROOT/local/bin`\n``````\n",
    "created_at": "2011-10-13T11:10:02Z",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11914#issuecomment-127843",
    "user": "https://github.com/nexttime"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -32,4 +32,8 @@
 
 ---
 
+Related: #10192 (SageNB is broken if "`.`" is *explicitly* contained in `PYTHONPATH` **during installation** of it.)
+
+---
+
 Apply [attachment:trac_11914-sage-env-pythonpath.patch](https://github.com/sagemath/sage/files/ticket11914/trac_11914-sage-env-pythonpath.patch) to `$SAGE_ROOT/local/bin`
``````




---

archive/issue_comments_127844.json:
```json
{
    "body": "**Changing keywords** from \"startup, crash, sage-env\" to \"notebook SageNB startup, crash, sage-env PYTHONPATH\".",
    "created_at": "2011-10-13T11:14:07Z",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11914#issuecomment-127844",
    "user": "https://github.com/nexttime"
}
```

**Changing keywords** from "startup, crash, sage-env" to "notebook SageNB startup, crash, sage-env PYTHONPATH".



---

archive/issue_events_095942.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2011-10-14T18:45:02Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11914#event-95942"
}
```



---

archive/issue_events_095943.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2011-10-14T18:45:02Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11914#event-95943"
}
```



---

archive/issue_comments_127845.json:
```json
{
    "body": "**Reviewer:** Keshav Kini, John Palmieri",
    "created_at": "2011-10-14T18:45:02Z",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11914#issuecomment-127845",
    "user": "https://github.com/jhpalmieri"
}
```

**Reviewer:** Keshav Kini, John Palmieri



---

archive/issue_events_095944.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-10-16T15:41:29Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "milestone": "sage-4.7.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11914#event-95944"
}
```



---

archive/issue_events_095945.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-10-16T15:41:29Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "milestone": "sage-4.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11914#event-95945"
}
```



---

archive/issue_comments_127846.json:
```json
{
    "body": "**Merged:** sage-4.7.3.alpha0",
    "created_at": "2011-10-17T07:58:18Z",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11914#issuecomment-127846",
    "user": "https://github.com/jdemeyer"
}
```

**Merged:** sage-4.7.3.alpha0



---

archive/issue_events_095946.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-10-17T07:58:18Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11914#event-95946"
}
```



---

archive/issue_events_095947.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-10-17T07:58:18Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11914#event-95947"
}
```



---

archive/issue_comments_127847.json:
```json
{
    "body": "Milestone sage-4.7.3 deleted",
    "created_at": "2011-11-03T16:14:43Z",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11914#issuecomment-127847",
    "user": "https://github.com/jdemeyer"
}
```

Milestone sage-4.7.3 deleted



---

archive/issue_events_095948.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-11-03T16:14:43Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "milestone": "sage-4.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11914#event-95948"
}
```



---

archive/issue_comments_127848.json:
```json
{
    "body": "**Changing merged** from \"sage-4.7.3.alpha0\" to \"sage-4.8.alpha0\".",
    "created_at": "2011-11-03T16:19:27Z",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11914#issuecomment-127848",
    "user": "https://github.com/jdemeyer"
}
```

**Changing merged** from "sage-4.7.3.alpha0" to "sage-4.8.alpha0".



---

archive/issue_events_095949.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-11-03T16:19:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/11914",
    "milestone": "sage-4.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11914#event-95949"
}
```
