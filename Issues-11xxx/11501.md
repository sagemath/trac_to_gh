# Issue 11501: User authentication via LDAP

archive/issues_011329.json:
```json
{
    "assignees": [
        "https://github.com/jasongrout",
        "https://github.com/qed777",
        "https://github.com/williamstein"
    ],
    "body": "Support (optional) user authentication via LDAP or other external backends.\n\nThis will be useful for i.e. universities (especially once the notebook is scalable).\n\nUsers should also be able to search for (i.e. when adding collaborators to a ws) that are available but not yet known to sage.\n\nSee #14330 instead.\n\nUpstream: **Reported upstream. Developers acknowledge bug.**\n\nCC:  @rkirov @kini @sagetrac-jasonbhill @novoselt\n\nComponent: **notebook**\n\nKeywords: **notebook, auth, ldap**\n\nReviewer: **Robin Martinjak**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/11501_\n\n",
    "closed_at": "2013-06-19T12:18:05Z",
    "created_at": "2011-06-16T07:29:55Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20user%20interface",
        "https://github.com/sagemath/sage/labels/duplicate",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "User authentication via LDAP",
    "type": "issue",
    "updated_at": "2013-06-19T12:18:05Z",
    "url": "https://github.com/sagemath/sage/issues/11501",
    "user": "https://github.com/sagetrac-rmartinjak"
}
```
Support (optional) user authentication via LDAP or other external backends.

This will be useful for i.e. universities (especially once the notebook is scalable).

Users should also be able to search for (i.e. when adding collaborators to a ws) that are available but not yet known to sage.

See #14330 instead.

Upstream: **Reported upstream. Developers acknowledge bug.**

CC:  @rkirov @kini @sagetrac-jasonbhill @novoselt

Component: **notebook**

Keywords: **notebook, auth, ldap**

Reviewer: **Robin Martinjak**

_Issue created by migration from https://trac.sagemath.org/ticket/11501_





---

archive/issue_events_151802.json:
```json
{
    "actor": "https://github.com/sagetrac-rmartinjak",
    "created_at": "2011-06-16T07:29:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20user%20interface",
    "label_color": "0000b0",
    "label_name": "c: user interface",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11501#event-151802"
}
```



---

archive/issue_events_151803.json:
```json
{
    "actor": "https://github.com/sagetrac-rmartinjak",
    "created_at": "2011-06-16T07:29:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20minor%20/%204",
    "label_color": "ffe799",
    "label_name": "p: minor / 4",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11501#event-151803"
}
```



---

archive/issue_events_151804.json:
```json
{
    "actor": "https://github.com/sagetrac-rmartinjak",
    "created_at": "2011-06-16T07:29:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11501#event-151804"
}
```



---

archive/issue_events_151805.json:
```json
{
    "actor": "https://github.com/jasongrout",
    "created_at": "2011-06-16T07:29:55Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "subject": "https://github.com/sagetrac-rmartinjak",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11501#event-151805"
}
```



---

archive/issue_events_151806.json:
```json
{
    "actor": "https://github.com/qed777",
    "created_at": "2011-06-16T07:29:55Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "subject": "https://github.com/sagetrac-rmartinjak",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11501#event-151806"
}
```



---

archive/issue_events_151807.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2011-06-16T07:29:55Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "subject": "https://github.com/sagetrac-rmartinjak",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11501#event-151807"
}
```



---

archive/issue_comments_116764.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\npatch is based on Rado Kirov's \nmodule \"python-ldap\" (available via easy_install like in Rado's install instructions)\n\n\nmajor changes in the patch:\n\nuser_manager.py:\nrenamed \"valid_login_names\" to \"known_users\" (imho the old name is kind of misleading now)\nnew UserManager (ExtAuthUsermanager)\nnew abstract class AuthMethod (all auth methods used by ExtAuthUM should implement its methods)\nclass LdapAuthMethod for LDAP authentication\n\nuser.py\nnew User.account_type: \"external\"\nnew methods may_change_email(), may_change_password()\n\nconf.py/server_conf.py\nadded (optional) key POS that allows ordering of items in a config group\nadded config items for LDAP auth\nmade openid login configurable \n\naccount_settings.html\nusers only see the \"change email/password\" form if above mentioned methods return true\n\nworksheet_share.html\nadded a user lookup form",
    "created_at": "2011-06-16T07:49:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11501#issuecomment-116764",
    "user": "https://github.com/sagetrac-rmartinjak"
}
```

<div id="comment:1" align="right">comment:1</div>

patch is based on Rado Kirov's 
module "python-ldap" (available via easy_install like in Rado's install instructions)


major changes in the patch:

user_manager.py:
renamed "valid_login_names" to "known_users" (imho the old name is kind of misleading now)
new UserManager (ExtAuthUsermanager)
new abstract class AuthMethod (all auth methods used by ExtAuthUM should implement its methods)
class LdapAuthMethod for LDAP authentication

user.py
new User.account_type: "external"
new methods may_change_email(), may_change_password()

conf.py/server_conf.py
added (optional) key POS that allows ordering of items in a config group
added config items for LDAP auth
made openid login configurable 

account_settings.html
users only see the "change email/password" form if above mentioned methods return true

worksheet_share.html
added a user lookup form



---

archive/issue_comments_116765.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nthe first comment should actually say:\n\npatch is based on Rado Kirov's \"rkirov-flask\" repo.\n\nrequires module \"python-ldap\" (available via easy_install like in Rado's install instructions)\n\n(and the list of changes is missing newlines, sorry for that)",
    "created_at": "2011-06-17T10:24:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11501#issuecomment-116765",
    "user": "https://github.com/sagetrac-rmartinjak"
}
```

<div id="comment:2" align="right">comment:2</div>

the first comment should actually say:

patch is based on Rado Kirov's "rkirov-flask" repo.

requires module "python-ldap" (available via easy_install like in Rado's install instructions)

(and the list of changes is missing newlines, sorry for that)



---

archive/issue_comments_116766.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nCopied over from discussion on sage-notebook.\n\n1. Which python-ldap instructions from Rado are you referring to?  I had trouble easy_installing python-ldap with Sage 4.7, and had to download it, configure setup.cfg by hand, and compile it.  I had to get a recent version of OpenLDAP and BerkeleyDB for this to work.  If those steps are not required, I'd love to know what I did wrong.\n\n2. Why did you do:\n\nclass ExtAuthUserManager(OpenIDUserManager):\n\nIt would seem to me that this should be reversed.  ExtAuthUserManager should be the generic class, and OpenIDUserManager should turn into an OpenIDAuth otion in the _auth_methods dict.\n\n3. I would suggest making a list of _auth_methods keys which can be ordered so it is predictable which auth_method is being used first, second, etc.\n\n4. It doesn't seem very nice to have OpenID-specific references anywhere inside ExtAuthUserManager. (__init__ and a few OpenID specific methods).\n\n5. Can you point me at some details of how the \"conf\" system works?  Where does this come from on disk?  What is passed to the constructor?\n\n6. I would have the conf file specify the full URL to the LDAP host, rather than have \"host\" and \"port\" configs.  We use:\n\nldaps://hostname\n\nwhich is impossible to configure for in your current code: it is fixed with \"ldap\".\n\n7. Please can you provide an example configuration file?  In particular, I'm interested in:\n\n        result = self._ldap_search(\"(%s=%s)\" % (self._conf['ldap_username_attrib'], username), attrlist)\n\nMy best guess is that \"ldap_username_attrib\" will typically be \"uid\", but I can tell you that in our LDAP server the same user may have multiple entries for different LDAP namespaces.  We have one namespace for system users, and another for web portal users, so my username ijstokes shows up twice:\n\nuid=ijstokes,cn=users,cn=portal,dc=nebiogrid,dc=org\nuid=ijstokes,cn=users,cn=accounts,dc=nebiogrid,dc=org\n\nPlus on a big LDAP server this is an expensive search.  The admin will know where users are kept, and the search should be limited just to that part of the LDAP tree.  In my LDAP implementation, I did a synchronous search as follows:\n\nresults = self._ldap_con.search_s(\"uid=%s,cn=users,cn=portal,dc=nebiogrid,dc=org\" % username, ldap.SCOPE_BASE, attrlist=['uid','cn','mail'])\n\n8. I think you should just setup the LDAP connection once in the constructor.  I *think* Python LDAP will manage the connection intelligently.\n\n9. check_password seems a bit convoluted -- it does two binds: once to get the DN, and once to check the password.  I'd prefer the model above.\n\n10. Sage stores a little bit of additional per-user state: suspended/active and worksheet timeouts or auto-save (can't remember).  TTBOMK the OpenID system gets around this by creating a Sage user when someone authenticates for the first time.  Do you inherit the same behavior?  I can't see where this happens.",
    "created_at": "2011-06-17T18:33:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11501#issuecomment-116766",
    "user": "https://github.com/sagetrac-ijstokes"
}
```

<div id="comment:3" align="right">comment:3</div>

Copied over from discussion on sage-notebook.

1. Which python-ldap instructions from Rado are you referring to?  I had trouble easy_installing python-ldap with Sage 4.7, and had to download it, configure setup.cfg by hand, and compile it.  I had to get a recent version of OpenLDAP and BerkeleyDB for this to work.  If those steps are not required, I'd love to know what I did wrong.

2. Why did you do:

class ExtAuthUserManager(OpenIDUserManager):

It would seem to me that this should be reversed.  ExtAuthUserManager should be the generic class, and OpenIDUserManager should turn into an OpenIDAuth otion in the _auth_methods dict.

3. I would suggest making a list of _auth_methods keys which can be ordered so it is predictable which auth_method is being used first, second, etc.

4. It doesn't seem very nice to have OpenID-specific references anywhere inside ExtAuthUserManager. (__init__ and a few OpenID specific methods).

5. Can you point me at some details of how the "conf" system works?  Where does this come from on disk?  What is passed to the constructor?

6. I would have the conf file specify the full URL to the LDAP host, rather than have "host" and "port" configs.  We use:

ldaps://hostname

which is impossible to configure for in your current code: it is fixed with "ldap".

7. Please can you provide an example configuration file?  In particular, I'm interested in:

        result = self._ldap_search("(%s=%s)" % (self._conf['ldap_username_attrib'], username), attrlist)

My best guess is that "ldap_username_attrib" will typically be "uid", but I can tell you that in our LDAP server the same user may have multiple entries for different LDAP namespaces.  We have one namespace for system users, and another for web portal users, so my username ijstokes shows up twice:

uid=ijstokes,cn=users,cn=portal,dc=nebiogrid,dc=org
uid=ijstokes,cn=users,cn=accounts,dc=nebiogrid,dc=org

Plus on a big LDAP server this is an expensive search.  The admin will know where users are kept, and the search should be limited just to that part of the LDAP tree.  In my LDAP implementation, I did a synchronous search as follows:

results = self._ldap_con.search_s("uid=%s,cn=users,cn=portal,dc=nebiogrid,dc=org" % username, ldap.SCOPE_BASE, attrlist=['uid','cn','mail'])

8. I think you should just setup the LDAP connection once in the constructor.  I *think* Python LDAP will manage the connection intelligently.

9. check_password seems a bit convoluted -- it does two binds: once to get the DN, and once to check the password.  I'd prefer the model above.

10. Sage stores a little bit of additional per-user state: suspended/active and worksheet timeouts or auto-save (can't remember).  TTBOMK the OpenID system gets around this by creating a Sage user when someone authenticates for the first time.  Do you inherit the same behavior?  I can't see where this happens.



---

archive/issue_comments_116767.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nReplying to [@sagetrac-ijstokes](#comment%3A3):\n\n> Copied over from discussion on sage-notebook. 1. Which python-ldap instructions from Rado are you referring to?  I had trouble easy_installing python-ldap with Sage 4.7, and had to download it, configure setup.cfg by hand, and compile it.  I had to get a recent version of OpenLDAP and BerkeleyDB for this to work.  If those steps are not required, I'd love to know what I did wrong.\n\nMy bad, the comment went horribly wrong.\n\nI meant Rado's instruction for getting his flask notebook running (he also uses easy_install from sage's ipython) on top of which my patch is based.\n\nTo get python-ldap easy_install'ed you need OpenLDAP's libldap but I can't confirm if that suffices.\n\n> 2. Why did you do: class ExtAuthUserManager(OpenIDUserManager): It would seem to me that this should be reversed.  ExtAuthUserManager should be the generic class, and OpenIDUserManager should turn into an OpenIDAuth otion in the _auth_methods dict.\n\nYou are right. I'm not experienced with OpenID so I have no idea if/how this can be done.\n\n> 3. I would suggest making a list of _auth_methods keys which can be ordered so it is predictable which auth_method is being used first, second, etc.\n\nI'd favour that too but unfortunately lists of preset values can not be configured in the UI (yet).\n\n> 4. It doesn't seem very nice to have OpenID-specific references anywhere inside ExtAuthUserManager. (__init__ and a few OpenID specific methods).\n\nIndeed. I didn't want to break functionality and OpenID seems to be a quite special case. This should be changed if possible\n\n> 5. Can you point me at some details of how the \"conf\" system works?  Where does this come from on disk?  What is passed to the constructor?\n\nA reference to a ServerConfiguration (server_conf.py object is passed. Configuration is done in the browser UI (settings -> notebook settings).\n\n> 6. I would have the conf file specify the full URL to the LDAP host, rather than have \"host\" and \"port\" configs.  We use: !ldaps://hostname\n\nRight! I will change that immediately, completely forgot about ldap**s**\n\n> 7. Please can you provide an example configuration file?  In particular, I'm interested in: result = self._ldap_search ![...] 8. I think you should just setup the LDAP connection once in the constructor.  I *think* Python LDAP will manage the connection intelligently.\n\n> 9. check_password seems a bit convoluted -- it does two binds: once to get the DN, and once to check the password.  I'd prefer the model above.\n\nThe first bind is with a \"generic\" DN (i.e. a non-user account).\n After the bind succeeds, LDAP is queried for an object which (italic == configurable item):\n\n* is below *ldap_basedn* (this could be cn=users,cn=portal,dc=nebiogrid,dc=org)\n* attribute *ldap_username_attribute* exactly matches <username>\n\nThe generic DN is then unbound and either one ldap object or \"None\" is returned. After unbinding the connection must be reset with ldap.initialize\n\nIf a unique object is returned, we use that object's DN and the provided <password> to try and bind with ldap. If that succeeds, the user has successfully logged in.\n\nSee this screenshot for a config example: !http://rmartinjak.de/notebooksettings.png\n\n> 10. Sage stores a little bit of additional per-user state: suspended/active and worksheet timeouts or auto-save (can't remember).  TTBOMK the OpenID system gets around this by creating a Sage user when someone authenticates for the first time.  Do you inherit the same behavior?  I can't see where this happens.\n\nDone in ExtAuthUM's \"_user()\"",
    "created_at": "2011-06-17T20:21:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11501#issuecomment-116767",
    "user": "https://github.com/sagetrac-rmartinjak"
}
```

<div id="comment:4" align="right">comment:4</div>

Replying to [@sagetrac-ijstokes](#comment%3A3):

> Copied over from discussion on sage-notebook. 1. Which python-ldap instructions from Rado are you referring to?  I had trouble easy_installing python-ldap with Sage 4.7, and had to download it, configure setup.cfg by hand, and compile it.  I had to get a recent version of OpenLDAP and BerkeleyDB for this to work.  If those steps are not required, I'd love to know what I did wrong.

My bad, the comment went horribly wrong.

I meant Rado's instruction for getting his flask notebook running (he also uses easy_install from sage's ipython) on top of which my patch is based.

To get python-ldap easy_install'ed you need OpenLDAP's libldap but I can't confirm if that suffices.

> 2. Why did you do: class ExtAuthUserManager(OpenIDUserManager): It would seem to me that this should be reversed.  ExtAuthUserManager should be the generic class, and OpenIDUserManager should turn into an OpenIDAuth otion in the _auth_methods dict.

You are right. I'm not experienced with OpenID so I have no idea if/how this can be done.

> 3. I would suggest making a list of _auth_methods keys which can be ordered so it is predictable which auth_method is being used first, second, etc.

I'd favour that too but unfortunately lists of preset values can not be configured in the UI (yet).

> 4. It doesn't seem very nice to have OpenID-specific references anywhere inside ExtAuthUserManager. (__init__ and a few OpenID specific methods).

Indeed. I didn't want to break functionality and OpenID seems to be a quite special case. This should be changed if possible

> 5. Can you point me at some details of how the "conf" system works?  Where does this come from on disk?  What is passed to the constructor?

A reference to a ServerConfiguration (server_conf.py object is passed. Configuration is done in the browser UI (settings -> notebook settings).

> 6. I would have the conf file specify the full URL to the LDAP host, rather than have "host" and "port" configs.  We use: !ldaps://hostname

Right! I will change that immediately, completely forgot about ldap**s**

> 7. Please can you provide an example configuration file?  In particular, I'm interested in: result = self._ldap_search ![...] 8. I think you should just setup the LDAP connection once in the constructor.  I *think* Python LDAP will manage the connection intelligently.

> 9. check_password seems a bit convoluted -- it does two binds: once to get the DN, and once to check the password.  I'd prefer the model above.

The first bind is with a "generic" DN (i.e. a non-user account).
 After the bind succeeds, LDAP is queried for an object which (italic == configurable item):

* is below *ldap_basedn* (this could be cn=users,cn=portal,dc=nebiogrid,dc=org)
* attribute *ldap_username_attribute* exactly matches <username>

The generic DN is then unbound and either one ldap object or "None" is returned. After unbinding the connection must be reset with ldap.initialize

If a unique object is returned, we use that object's DN and the provided <password> to try and bind with ldap. If that succeeds, the user has successfully logged in.

See this screenshot for a config example: !http://rmartinjak.de/notebooksettings.png

> 10. Sage stores a little bit of additional per-user state: suspended/active and worksheet timeouts or auto-save (can't remember).  TTBOMK the OpenID system gets around this by creating a Sage user when someone authenticates for the first time.  Do you inherit the same behavior?  I can't see where this happens.

Done in ExtAuthUM's "_user()"



---

archive/issue_comments_116768.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nAttachment: **[trac_11501_ldap_auth.patch.gz](https://github.com/sagemath/sage/files/ticket11501/trac_11501_ldap_auth.patch.gz)**\n\nthey say I have to build ldap 2.13 from source on MacOSX 10.6, otherwise ldap doesn't work.\nsee http://stackoverflow.com/questions/6475118/python-ldap-os-x-10-6-and-python-2-6",
    "created_at": "2011-08-01T08:27:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11501#issuecomment-116768",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:5" align="right">comment:5</div>

Attachment: **[trac_11501_ldap_auth.patch.gz](https://github.com/sagemath/sage/files/ticket11501/trac_11501_ldap_auth.patch.gz)**

they say I have to build ldap 2.13 from source on MacOSX 10.6, otherwise ldap doesn't work.
see http://stackoverflow.com/questions/6475118/python-ldap-os-x-10-6-and-python-2-6



---

archive/issue_comments_116769.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nReplying to [@dimpase](#comment%3A5):\n> they say I have to build ldap 2.13 from source on MacOSX 10.6, otherwise ldap doesn't work.\n> see http://stackoverflow.com/questions/6475118/python-ldap-os-x-10-6-and-python-2-6\n\noops, I meant 2.3.13\nAfter I took the source and did \n\n```\nsage -sh \npython setup.py install\n```\nin its source directory, I was able to get to\n\n```\n\n\t  File \"/usr/local/src/sage/current/devel/sagenb/flask_version/authentication.py\", line 53, in login\n\t    elif g.notebook.user_manager().check_password(username, password):\n\t  File \"/usr/local/src/sage/sage-4.7.alpha5/devel/rkirov-flask/sagenb/notebook/user_manager.py\", line 503, in check_password\n\t    return self._check_password(username, password)\n\t  File \"/usr/local/src/sage/sage-4.7.alpha5/devel/rkirov-flask/sagenb/notebook/user_manager.py\", line 612, in _check_password\n\t    u = self._auth_methods[a].check_user(username)\n\t  File \"/usr/local/src/sage/sage-4.7.alpha5/devel/rkirov-flask/sagenb/notebook/user_manager.py\", line 729, in check_user\n\t    u = self._get_ldapuser(username)\n\t  File \"/usr/local/src/sage/sage-4.7.alpha5/devel/rkirov-flask/sagenb/notebook/user_manager.py\", line 709, in _get_ldapuser\n\t    result = self._ldap_search(\"(%s=%s)\" % (self._conf['ldap_username_attrib'], username), attrlist)\n\t  File \"/usr/local/src/sage/sage-4.7.alpha5/devel/rkirov-flask/sagenb/notebook/user_manager.py\", line 690, in _ldap_search\n\t    raise ValueError, \"invalid LDAP credentials\"\n\texceptions.ValueError: invalid LDAP credentials\n```\nafter attempting to log in (well, it could well be that the \"Bind DN\" is set wrongly in my case).\n\nby the way, there is obvious typo in the patch in flask_version/authentication.py\n\n```        \npassword = request.form['password'True] \n```\nwe guessed that \"'True\" should be gone there.",
    "created_at": "2011-08-01T08:46:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11501#issuecomment-116769",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:6" align="right">comment:6</div>

Replying to [@dimpase](#comment%3A5):
> they say I have to build ldap 2.13 from source on MacOSX 10.6, otherwise ldap doesn't work.
> see http://stackoverflow.com/questions/6475118/python-ldap-os-x-10-6-and-python-2-6

oops, I meant 2.3.13
After I took the source and did 

```
sage -sh 
python setup.py install
```
in its source directory, I was able to get to

```

	  File "/usr/local/src/sage/current/devel/sagenb/flask_version/authentication.py", line 53, in login
	    elif g.notebook.user_manager().check_password(username, password):
	  File "/usr/local/src/sage/sage-4.7.alpha5/devel/rkirov-flask/sagenb/notebook/user_manager.py", line 503, in check_password
	    return self._check_password(username, password)
	  File "/usr/local/src/sage/sage-4.7.alpha5/devel/rkirov-flask/sagenb/notebook/user_manager.py", line 612, in _check_password
	    u = self._auth_methods[a].check_user(username)
	  File "/usr/local/src/sage/sage-4.7.alpha5/devel/rkirov-flask/sagenb/notebook/user_manager.py", line 729, in check_user
	    u = self._get_ldapuser(username)
	  File "/usr/local/src/sage/sage-4.7.alpha5/devel/rkirov-flask/sagenb/notebook/user_manager.py", line 709, in _get_ldapuser
	    result = self._ldap_search("(%s=%s)" % (self._conf['ldap_username_attrib'], username), attrlist)
	  File "/usr/local/src/sage/sage-4.7.alpha5/devel/rkirov-flask/sagenb/notebook/user_manager.py", line 690, in _ldap_search
	    raise ValueError, "invalid LDAP credentials"
	exceptions.ValueError: invalid LDAP credentials
```
after attempting to log in (well, it could well be that the "Bind DN" is set wrongly in my case).

by the way, there is obvious typo in the patch in flask_version/authentication.py

```        
password = request.form['password'True] 
```
we guessed that "'True" should be gone there.



---

archive/issue_comments_116770.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nJust by the way, we are currently using this patch (rebased and modified a bit) to do authentication for [our Sage-based undergraduate class](https://groups.google.com/d/topic/sage-devel/dmG6pwqXwiI/discussion). Thanks for your work, rmartinjak! Hopefully we can eventually review this and get it into the main notebook codebase (but that will probably take some more discussion).",
    "created_at": "2011-08-13T05:36:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11501#issuecomment-116770",
    "user": "https://github.com/kini"
}
```

<div id="comment:9" align="right">comment:9</div>

Just by the way, we are currently using this patch (rebased and modified a bit) to do authentication for [our Sage-based undergraduate class](https://groups.google.com/d/topic/sage-devel/dmG6pwqXwiI/discussion). Thanks for your work, rmartinjak! Hopefully we can eventually review this and get it into the main notebook codebase (but that will probably take some more discussion).



---

archive/issue_comments_116771.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nI'm glad to hear that.\n\nActually, the username normalization to ascii is problematic, as it allows logging in with invalid usernames (i.e. rm\u00e4rtinjak or rm*rtinjak instead of rmartinjak)\n\nI attached a newer class that uses python-ldaps filter_format() method to build valid ldap queries\n\n\n@dimpase:\nyou're right with the typo and throwing an exception with \"invalid LDAP credentials\" occurs when either your bind DN or the corresponding bind password is wrong (as you suspected)",
    "created_at": "2011-08-16T08:00:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11501#issuecomment-116771",
    "user": "https://github.com/sagetrac-rmartinjak"
}
```

<div id="comment:10" align="right">comment:10</div>

I'm glad to hear that.

Actually, the username normalization to ascii is problematic, as it allows logging in with invalid usernames (i.e. rmärtinjak or rm*rtinjak instead of rmartinjak)

I attached a newer class that uses python-ldaps filter_format() method to build valid ldap queries


@dimpase:
you're right with the typo and throwing an exception with "invalid LDAP credentials" occurs when either your bind DN or the corresponding bind password is wrong (as you suspected)



---

archive/issue_comments_116772.json:
```json
{
    "body": "Attachment: **[ldapauth.py.gz](https://github.com/sagemath/sage/files/ticket11501/ldapauth.py.gz)**",
    "created_at": "2011-08-16T08:01:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11501#issuecomment-116772",
    "user": "https://github.com/sagetrac-rmartinjak"
}
```

Attachment: **[ldapauth.py.gz](https://github.com/sagemath/sage/files/ticket11501/ldapauth.py.gz)**



---

archive/issue_comments_116773.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nOne more thing that we just noticed: our LDAP has case-insensitive login names, resulting in nb creating separate sws directories for, say, user bond007, if he logs in as  BOND007, or as Bond007, or as bond07.\n\nThis has to be a feature of ldapauth, to canonise login names in some way for such LDAP (our is an AD Windows thing).",
    "created_at": "2011-08-22T04:50:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11501#issuecomment-116773",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:12" align="right">comment:12</div>

One more thing that we just noticed: our LDAP has case-insensitive login names, resulting in nb creating separate sws directories for, say, user bond007, if he logs in as  BOND007, or as Bond007, or as bond07.

This has to be a feature of ldapauth, to canonise login names in some way for such LDAP (our is an AD Windows thing).



---

archive/issue_comments_116774.json:
```json
{
    "body": "Upstream: **Reported upstream. Developers acknowledge bug.**",
    "created_at": "2012-06-20T16:58:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11501#issuecomment-116774",
    "user": "https://github.com/kcrisman"
}
```

Upstream: **Reported upstream. Developers acknowledge bug.**



---

archive/issue_comments_116775.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nThis is now basically happening upstream.  See [this pull request](https://github.com/sagemath/sagenb/pull/46), apparently unrelated to anything here, and the continuation of this material at [this fork](https://github.com/rmartinjak/sagenb/tree/ldap) by rmartinjak.",
    "created_at": "2012-06-20T16:58:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11501#issuecomment-116775",
    "user": "https://github.com/kcrisman"
}
```

<div id="comment:14" align="right">comment:14</div>

This is now basically happening upstream.  See [this pull request](https://github.com/sagemath/sagenb/pull/46), apparently unrelated to anything here, and the continuation of this material at [this fork](https://github.com/rmartinjak/sagenb/tree/ldap) by rmartinjak.



---

archive/issue_comments_116776.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nCorrection: the pull request is based on rmartinjak's patch from this ticket, though it was done by someone else (Konstantin Podshumok, who also submitted a nice gettext cleanup and Russian translation).\n\nPersonally I am wondering what happened to ijstokes's list of concerns, all of which seem very reasonable to me.",
    "created_at": "2012-06-20T19:07:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11501#issuecomment-116776",
    "user": "https://github.com/kini"
}
```

<div id="comment:15" align="right">comment:15</div>

Correction: the pull request is based on rmartinjak's patch from this ticket, though it was done by someone else (Konstantin Podshumok, who also submitted a nice gettext cleanup and Russian translation).

Personally I am wondering what happened to ijstokes's list of concerns, all of which seem very reasonable to me.



---

archive/issue_comments_116777.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nLooking at [rmartinjak's current \"ldap\" branch on sagenb](https://github.com/rmartinjak/sagenb/compare/94947d0...ldap), it seems that some of ijstokes's comments have been addressed... `OpenIDUserManager` now inherits from `ExtAuthUserManager` rather than vice versa, for example. So apparently the patch here is out of date.",
    "created_at": "2012-06-20T19:20:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11501#issuecomment-116777",
    "user": "https://github.com/kini"
}
```

<div id="comment:16" align="right">comment:16</div>

Looking at [rmartinjak's current "ldap" branch on sagenb](https://github.com/rmartinjak/sagenb/compare/94947d0...ldap), it seems that some of ijstokes's comments have been addressed... `OpenIDUserManager` now inherits from `ExtAuthUserManager` rather than vice versa, for example. So apparently the patch here is out of date.



---

archive/issue_comments_116778.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@kini](#comment%3A16):\n\n> Looking at [rmartinjak's current \"ldap\" branch on sagenb](https://github.com/rmartinjak/sagenb/compare/94947d0...ldap) , it seems that some of ijstokes's comments have been addressed... `OpenIDUserManager`  now inherits from `ExtAuthUserManager`  rather than vice versa, for example. So apparently the patch here is out of date.\n\nThis is true, anything but \"3.\" (ordered list of auth methods) should've been taken care of.\nMaybe also part 1, getting python-ldap, might be an issue. Building it requires libldap (with headers) iirc",
    "created_at": "2012-06-20T19:52:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11501#issuecomment-116778",
    "user": "https://github.com/sagetrac-rmartinjak"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@kini](#comment%3A16):

> Looking at [rmartinjak's current "ldap" branch on sagenb](https://github.com/rmartinjak/sagenb/compare/94947d0...ldap) , it seems that some of ijstokes's comments have been addressed... `OpenIDUserManager`  now inherits from `ExtAuthUserManager`  rather than vice versa, for example. So apparently the patch here is out of date.

This is true, anything but "3." (ordered list of auth methods) should've been taken care of.
Maybe also part 1, getting python-ldap, might be an issue. Building it requires libldap (with headers) iirc



---

archive/issue_comments_116779.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nNote from this thread https://groups.google.com/forum/?fromgroups#!topic/sage-support/6DmaZW8cY98\nThat python-dev needs to be installed (on Ubuntu) to use the instructions in this ticket else import crypto fails.",
    "created_at": "2012-08-03T13:28:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11501#issuecomment-116779",
    "user": "https://github.com/pipedream"
}
```

<div id="comment:18" align="right">comment:18</div>

Note from this thread https://groups.google.com/forum/?fromgroups#!topic/sage-support/6DmaZW8cY98
That python-dev needs to be installed (on Ubuntu) to use the instructions in this ticket else import crypto fails.



---

archive/issue_events_151808.json:
```json
{
    "actor": "https://github.com/kcrisman",
    "created_at": "2013-06-14T19:40:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11501#event-151808"
}
```



---

archive/issue_comments_116780.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nThis is now clearly a duplicate of #14330, or depends on it, or something like that.",
    "created_at": "2013-06-14T19:40:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11501#issuecomment-116780",
    "user": "https://github.com/kcrisman"
}
```

<div id="comment:19" align="right">comment:19</div>

This is now clearly a duplicate of #14330, or depends on it, or something like that.



---

archive/issue_events_151809.json:
```json
{
    "actor": "https://github.com/kcrisman",
    "created_at": "2013-06-14T19:41:15Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11501#event-151809"
}
```



---

archive/issue_events_151810.json:
```json
{
    "actor": "https://github.com/kcrisman",
    "created_at": "2013-06-14T19:41:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11501#event-151810"
}
```



---

archive/issue_events_151811.json:
```json
{
    "actor": "https://github.com/kcrisman",
    "created_at": "2013-06-14T19:41:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "label": "https://github.com/sagemath/sage/labels/pending",
    "label_color": "008080",
    "label_name": "pending",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11501#event-151811"
}
```



---

archive/issue_comments_116781.json:
```json
{
    "body": "Dependencies: **#14430**",
    "created_at": "2013-06-14T19:41:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11501#issuecomment-116781",
    "user": "https://github.com/kcrisman"
}
```

Dependencies: **#14430**



---

archive/issue_events_151812.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-06-18T07:04:14Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "label": "https://github.com/sagemath/sage/labels/pending",
    "label_color": "008080",
    "label_name": "pending",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11501#event-151812"
}
```



---

archive/issue_comments_116782.json:
```json
{
    "body": "Changed dependencies from **#14430** to none",
    "created_at": "2013-06-18T07:04:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11501#issuecomment-116782",
    "user": "https://github.com/jdemeyer"
}
```

Changed dependencies from **#14430** to none



---

archive/issue_comments_116783.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -4,6 +4,4 @@\n \n Users should also be able to search for (i.e. when adding collaborators to a ws) that are available but not yet known to sage.\n \n-relevant tickets:\n-\n-*  #11080 (move notebook to flask/wsgi-based notebook)\n+See #14330 instead.\n``````\n",
    "created_at": "2013-06-18T07:04:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11501#issuecomment-116783",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -4,6 +4,4 @@
 
 Users should also be able to search for (i.e. when adding collaborators to a ws) that are available but not yet known to sage.
 
-relevant tickets:
-
-*  #11080 (move notebook to flask/wsgi-based notebook)
+See #14330 instead.
``````




---

archive/issue_comments_116784.json:
```json
{
    "body": "Changed author from **Robin Martinjak** to none",
    "created_at": "2013-06-18T07:04:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11501#issuecomment-116784",
    "user": "https://github.com/jdemeyer"
}
```

Changed author from **Robin Martinjak** to none



---

archive/issue_comments_116785.json:
```json
{
    "body": "Reviewer: **Robin Martinjak**",
    "created_at": "2013-06-18T07:04:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11501#issuecomment-116785",
    "user": "https://github.com/jdemeyer"
}
```

Reviewer: **Robin Martinjak**



---

archive/issue_events_151813.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-06-19T12:18:05Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20minor%20/%204",
    "label_color": "ffe799",
    "label_name": "p: minor / 4",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11501#event-151813"
}
```



---

archive/issue_events_151814.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-06-19T12:18:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "label": "https://github.com/sagemath/sage/labels/duplicate",
    "label_color": "c6c6c6",
    "label_name": "duplicate",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11501#event-151814"
}
```



---

archive/issue_events_151815.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-06-19T12:18:05Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11501#event-151815"
}
```



---

archive/issue_events_151816.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-06-19T12:18:05Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/11501",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11501#event-151816"
}
```
