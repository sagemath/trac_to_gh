# Issue 11941: Solve and assumptions too aggressive with cube root of negative numbers

archive/issues_011769.json:
```json
{
    "body": "#6515 did a great job helping us start to catch some assumptions when we do solving.\n\nHowever, [this ask.sagemath.org post](http://ask.sagemath.org/question/824/real-solution-of-x38-0) catches a case where it's too aggressive, because Sage says that `(-1)^(1/3)` is not real.  \n\n```\nsage: solve(x^3+1==0,x)\n[x == 1/2*I*(-1)^(1/3)*sqrt(3) - 1/2*(-1)^(1/3), x == -1/2*I*(-1)^(1/3)*sqrt(3) - 1/2*(-1)^(1/3), x == (-1)^(1/3)]\nsage: assume(x,'real')\nsage: solve(x^3+1==0,x)\n[]\n```\n\nWhat's weird about this is that the Maxima in Sage should just return `x==-1`.\n\n```\n(%i2) display2d:false;\n\n(%o2) false\n(%i3) solve(x^3+1=0,x);\n\n(%o3) [x = -(sqrt(3)*%i-1)/2,x = (sqrt(3)*%i+1)/2,x = -1]\n```\nNot sure what's going on with that.\n\n**Assignee:** @burcin\n\n**CC:**  @pelegm\n\n**Work Issues:** report upstream\n\n**Upstream:** Not yet reported upstream; Will do shortly.\n\nIssue created by migration from https://trac.sagemath.org/ticket/11941\n\n",
    "created_at": "2011-10-18T19:47:37Z",
    "labels": [
        "component: symbolics",
        "bug",
        "needs work"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-7.6",
    "title": "Solve and assumptions too aggressive with cube root of negative numbers",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/11941",
    "user": "https://github.com/kcrisman"
}
```
#6515 did a great job helping us start to catch some assumptions when we do solving.

However, [this ask.sagemath.org post](http://ask.sagemath.org/question/824/real-solution-of-x38-0) catches a case where it's too aggressive, because Sage says that `(-1)^(1/3)` is not real.  

```
sage: solve(x^3+1==0,x)
[x == 1/2*I*(-1)^(1/3)*sqrt(3) - 1/2*(-1)^(1/3), x == -1/2*I*(-1)^(1/3)*sqrt(3) - 1/2*(-1)^(1/3), x == (-1)^(1/3)]
sage: assume(x,'real')
sage: solve(x^3+1==0,x)
[]
```

What's weird about this is that the Maxima in Sage should just return `x==-1`.

```
(%i2) display2d:false;

(%o2) false
(%i3) solve(x^3+1=0,x);

(%o3) [x = -(sqrt(3)*%i-1)/2,x = (sqrt(3)*%i+1)/2,x = -1]
```
Not sure what's going on with that.

**Assignee:** @burcin

**CC:**  @pelegm

**Work Issues:** report upstream

**Upstream:** Not yet reported upstream; Will do shortly.

Issue created by migration from https://trac.sagemath.org/ticket/11941





---

archive/issue_events_096315.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-11-03T16:14:43Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "milestone": "sage-4.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11941#event-96315"
}
```



---

archive/issue_comments_128517.json:
```json
{
    "body": "Milestone sage-4.7.3 deleted",
    "created_at": "2011-11-03T16:14:43Z",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11941#issuecomment-128517",
    "user": "https://github.com/jdemeyer"
}
```

Milestone sage-4.7.3 deleted



---

archive/issue_comments_128518.json:
```json
{
    "body": "<a id='comment:2'></a>\nThe fact that Maxima normally returns `-1`\nand Sage returns `(-1)^(1/3)` is a bit odd,\nas you mentioned. At a more basic level,\nSage doesn't seem to think that `(-1)^(1/3)`\nis in `RR`:\n\n```\nsage: (-1)^(1/3) in RR\nFalse\nsage: (2)^(1/3) in RR\nTrue\n```\n\nSo if we fix that problem, then at least it would\nreturn `(-1)^(1/3)`. I also suspect that it would\nproperly simplify to `-1` at that point as well,\nbased on the following example:\n\n```\nsage: solve(x^3 - 8 == 0, x)\n[x == I*sqrt(3) - 1,\n x == -I*sqrt(3) - 1,\n x == 2]\nsage: solve(x^3 + 8 == 0, x)\n[x == I*(-1)^(1/3)*sqrt(3) - (-1)^(1/3),\n x == -I*(-1)^(1/3)*sqrt(3) - (-1)^(1/3),\n x == 2*(-1)^(1/3)]\n```\n\n(Note that the `(1/3)` exponent appears everywhere\nnext to the `-1`, as if some rule specifies that\nSage should not simplify it out.)\n\nI am new, however, and I am not sure where next to look.",
    "created_at": "2011-11-17T06:08:04Z",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11941#issuecomment-128518",
    "user": "https://github.com/mboratko"
}
```

<a id='comment:2'></a>
The fact that Maxima normally returns `-1`
and Sage returns `(-1)^(1/3)` is a bit odd,
as you mentioned. At a more basic level,
Sage doesn't seem to think that `(-1)^(1/3)`
is in `RR`:

```
sage: (-1)^(1/3) in RR
False
sage: (2)^(1/3) in RR
True
```

So if we fix that problem, then at least it would
return `(-1)^(1/3)`. I also suspect that it would
properly simplify to `-1` at that point as well,
based on the following example:

```
sage: solve(x^3 - 8 == 0, x)
[x == I*sqrt(3) - 1,
 x == -I*sqrt(3) - 1,
 x == 2]
sage: solve(x^3 + 8 == 0, x)
[x == I*(-1)^(1/3)*sqrt(3) - (-1)^(1/3),
 x == -I*(-1)^(1/3)*sqrt(3) - (-1)^(1/3),
 x == 2*(-1)^(1/3)]
```

(Note that the `(1/3)` exponent appears everywhere
next to the `-1`, as if some rule specifies that
Sage should not simplify it out.)

I am new, however, and I am not sure where next to look.



---

archive/issue_events_096316.json:
```json
{
    "actor": "https://github.com/mboratko",
    "created_at": "2011-11-17T06:08:04Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "milestone": "sage-4.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11941#event-96316"
}
```



---

archive/issue_comments_128519.json:
```json
{
    "body": "<a id='comment:3'></a>\nWell, in general we do *not* want to do this.  It's been discussed ad nauseam [many](http://groups.google.com/group/sage-support/browse_thread/thread/66d45649ca8c1cc3?pli=1)  [times](http://ask.sagemath.org/question/260/fractional-power-to-negative-number), and the sense is that:\n* Similar programs don't necessarily do this\n* `(-1)^(1/3)` is not really `-1` but a primitive complex root of `-1`.  \n\nThis ticket is about the fact that Maxima returns three solutions to the equation, but when we do the `assume(x,'real')` they *all* mysteriously vanish!",
    "created_at": "2011-11-17T14:18:27Z",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11941#issuecomment-128519",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:3'></a>
Well, in general we do *not* want to do this.  It's been discussed ad nauseam [many](http://groups.google.com/group/sage-support/browse_thread/thread/66d45649ca8c1cc3?pli=1)  [times](http://ask.sagemath.org/question/260/fractional-power-to-negative-number), and the sense is that:
* Similar programs don't necessarily do this
* `(-1)^(1/3)` is not really `-1` but a primitive complex root of `-1`.  

This ticket is about the fact that Maxima returns three solutions to the equation, but when we do the `assume(x,'real')` they *all* mysteriously vanish!



---

archive/issue_comments_128520.json:
```json
{
    "body": "<a id='comment:4'></a>\nHere's what maple does:\n\n```\n> solve( x^3+1= 0, x);\n                                     1/2               1/2\n                    -1, 1/2 - 1/2 I 3   , 1/2 + 1/2 I 3\n```\n\nI wonder why maxima is returning `(-1)^(1/3)`. Maybe we should ask the Maxima developers.",
    "created_at": "2011-11-17T16:05:10Z",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11941#issuecomment-128520",
    "user": "https://github.com/burcin"
}
```

<a id='comment:4'></a>
Here's what maple does:

```
> solve( x^3+1= 0, x);
                                     1/2               1/2
                    -1, 1/2 - 1/2 I 3   , 1/2 + 1/2 I 3
```

I wonder why maxima is returning `(-1)^(1/3)`. Maybe we should ask the Maxima developers.



---

archive/issue_comments_128521.json:
```json
{
    "body": "<a id='comment:5'></a>\n> I wonder why maxima is returning `(-1)^(1/3)`. Maybe we should ask the Maxima developers.\n\n\n\nNo, no!  See this example from the description:\n\n```\n(%i2) display2d:false;\n\n(%o2) false\n(%i3) solve(x^3+1=0,x);\n\n(%o3) [x = -(sqrt(3)*%i-1)/2,x = (sqrt(3)*%i+1)/2,x = -1]\n```\nWe are somehow getting the `(-1)^(1/3)` by doing something nonstandard in Maxima, apparently.   But their vanilla thing is just right.",
    "created_at": "2011-11-17T16:12:25Z",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11941#issuecomment-128521",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:5'></a>
> I wonder why maxima is returning `(-1)^(1/3)`. Maybe we should ask the Maxima developers.



No, no!  See this example from the description:

```
(%i2) display2d:false;

(%o2) false
(%i3) solve(x^3+1=0,x);

(%o3) [x = -(sqrt(3)*%i-1)/2,x = (sqrt(3)*%i+1)/2,x = -1]
```
We are somehow getting the `(-1)^(1/3)` by doing something nonstandard in Maxima, apparently.   But their vanilla thing is just right.



---

archive/issue_comments_128522.json:
```json
{
    "body": "<a id='comment:6'></a>\nIt seems that sage sets domain: complex (I was made aware of this by burcin in IRC). You do get this result as follows:\n\n{{{(%i8) domain:complex;\n\n(%o8) complex\n(%i9) solve(x^3+1=0,x);\n\n(%o9) [x = ((-1)<sup>(1/3)*sqrt(3)*%i-(-1)</sup>(1/3))/2,\n       x = -((-1)<sup>(1/3)*sqrt(3)*%i+(-1)</sup>(1/3))/2,x = (-1)^(1/3)]\n}}}",
    "created_at": "2011-11-17T16:15:08Z",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11941#issuecomment-128522",
    "user": "https://github.com/mboratko"
}
```

<a id='comment:6'></a>
It seems that sage sets domain: complex (I was made aware of this by burcin in IRC). You do get this result as follows:

{{{(%i8) domain:complex;

(%o8) complex
(%i9) solve(x^3+1=0,x);

(%o9) [x = ((-1)<sup>(1/3)*sqrt(3)*%i-(-1)</sup>(1/3))/2,
       x = -((-1)<sup>(1/3)*sqrt(3)*%i+(-1)</sup>(1/3))/2,x = (-1)^(1/3)]
}}}



---

archive/issue_comments_128523.json:
```json
{
    "body": "<a id='comment:7'></a>\nUgh, all my comments have screwed up formatting. I wish I could edit them (can I?). I should have been:\n\n```\n\n(%i8) domain:complex;\n\n(%o8) complex\n(%i9) solve(x^3+1=0,x);\n\n(%o9) [x = ((-1)^(1/3)*sqrt(3)*%i-(-1)^(1/3))/2,\n       x = -((-1)^(1/3)*sqrt(3)*%i+(-1)^(1/3))/2,x = (-1)^(1/3)]\n\n```",
    "created_at": "2011-11-17T16:16:50Z",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11941#issuecomment-128523",
    "user": "https://github.com/mboratko"
}
```

<a id='comment:7'></a>
Ugh, all my comments have screwed up formatting. I wish I could edit them (can I?). I should have been:

```

(%i8) domain:complex;

(%o8) complex
(%i9) solve(x^3+1=0,x);

(%o9) [x = ((-1)^(1/3)*sqrt(3)*%i-(-1)^(1/3))/2,
       x = -((-1)^(1/3)*sqrt(3)*%i+(-1)^(1/3))/2,x = (-1)^(1/3)]

```



---

archive/issue_comments_128524.json:
```json
{
    "body": "<a id='comment:8'></a>\nReplying to [mboratko](#comment%3A6):\n> It seems that sage sets domain: complex (I was made aware of this by burcin in IRC). You do get this result as follows:\n\n\nYes, we do, but I didn't bother checking that.  Good work.\n\nSo of course now the question becomes what the \"right\" thing to do is?  I don't think we want to set and unset `domain:real/complex` in Maxima every time we use `solve`, because presumably this would break other things.  Or?   At any rate we definitely need to keep `domain:complex` in general, if I recall correctly other problems that occur without it.\n\n```\n(%i1) (-1)^(1/3);\n(%o1)                                 - 1\n(%i2) domain:complex;\n(%o2)                               complex\n(%i3) (-1)^(1/3);\n                                        1/3\n(%o3)                              (- 1)\n```\nTypically we would want the latter answer, e.g in \n\n```\nsage: a = (-1)^(1/3)\nsage: a.simplify()\n(-1)^(1/3)\n```",
    "created_at": "2011-11-17T16:19:53Z",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11941#issuecomment-128524",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:8'></a>
Replying to [mboratko](#comment%3A6):
> It seems that sage sets domain: complex (I was made aware of this by burcin in IRC). You do get this result as follows:


Yes, we do, but I didn't bother checking that.  Good work.

So of course now the question becomes what the "right" thing to do is?  I don't think we want to set and unset `domain:real/complex` in Maxima every time we use `solve`, because presumably this would break other things.  Or?   At any rate we definitely need to keep `domain:complex` in general, if I recall correctly other problems that occur without it.

```
(%i1) (-1)^(1/3);
(%o1)                                 - 1
(%i2) domain:complex;
(%o2)                               complex
(%i3) (-1)^(1/3);
                                        1/3
(%o3)                              (- 1)
```
Typically we would want the latter answer, e.g in 

```
sage: a = (-1)^(1/3)
sage: a.simplify()
(-1)^(1/3)
```



---

archive/issue_comments_128525.json:
```json
{
    "body": "<a id='comment:9'></a>\nI've attached a fairly limited workaround, but it does give (semi?) desirable behavior:\n\n```\nsage: assume(x, 'real')\nsage: solve(x^3+1==0,x)\n[x == (-1)^(1/3)]\n```\n\nIf it is then up to the user to interpret the result, this seems ok. If they want to programmatically use the result later, it's really no good. I suppose if they were aware of this and wanted to fix the result to be real then they could manually employ the same method as in my patch to the result.\n\nI guess, as a more general question, do we want the results of solve to always return a result with domain: real, and if so can we make this change for just this function? If there is a use case where this is undesirable, then I think the only option is make the assumptions file not only check the returned value, but also modify it (so that if assume is real, then the value is actually replaced with the real values). Perhaps another option is to allow the user to specify the desired domain of results from solve.",
    "created_at": "2011-11-17T16:53:47Z",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11941#issuecomment-128525",
    "user": "https://github.com/mboratko"
}
```

<a id='comment:9'></a>
I've attached a fairly limited workaround, but it does give (semi?) desirable behavior:

```
sage: assume(x, 'real')
sage: solve(x^3+1==0,x)
[x == (-1)^(1/3)]
```

If it is then up to the user to interpret the result, this seems ok. If they want to programmatically use the result later, it's really no good. I suppose if they were aware of this and wanted to fix the result to be real then they could manually employ the same method as in my patch to the result.

I guess, as a more general question, do we want the results of solve to always return a result with domain: real, and if so can we make this change for just this function? If there is a use case where this is undesirable, then I think the only option is make the assumptions file not only check the returned value, but also modify it (so that if assume is real, then the value is actually replaced with the real values). Perhaps another option is to allow the user to specify the desired domain of results from solve.



---

archive/issue_comments_128526.json:
```json
{
    "body": "limited workaround for assumption and solve",
    "created_at": "2011-11-17T17:16:55Z",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11941#issuecomment-128526",
    "user": "https://github.com/mboratko"
}
```

limited workaround for assumption and solve



---

archive/issue_events_096317.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "milestone": "sage-5.11",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11941#event-96317"
}
```



---

archive/issue_events_096318.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11941#event-96318"
}
```



---

archive/attachments_015902.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_11941.patch",
    "asset_url": "tarball://root/attachments/ticket11941/trac_11941.patch",
    "created_at": "2013-08-13T15:35:53Z",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket11941/trac_11941.patch",
    "user": "https://github.com/jdemeyer"
}
```



---

archive/issue_comments_128527.json:
```json
{
    "body": "<a id='comment:10'></a>\nAttachment [trac_11941.patch](https://github.com/sagemath/sage/files/ticket11941/trac_11941.patch) by @jdemeyer created at 2013-08-13 15:35:53",
    "created_at": "2013-08-13T15:35:53Z",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11941#issuecomment-128527",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>
Attachment [trac_11941.patch](https://github.com/sagemath/sage/files/ticket11941/trac_11941.patch) by @jdemeyer created at 2013-08-13 15:35:53



---

archive/issue_events_096319.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "milestone": "sage-6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11941#event-96319"
}
```



---

archive/issue_events_096320.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11941#event-96320"
}
```



---

archive/issue_events_096321.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11941#event-96321"
}
```



---

archive/issue_events_096322.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11941#event-96322"
}
```



---

archive/issue_events_096323.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11941#event-96323"
}
```



---

archive/issue_events_096324.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11941#event-96324"
}
```



---

archive/issue_comments_128528.json:
```json
{
    "body": "<a id='comment:14'></a>\nYou need to set \"needs review\" if you want someone to look at your code. I'll do that now.",
    "created_at": "2015-01-31T09:05:26Z",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11941#issuecomment-128528",
    "user": "https://github.com/rwst"
}
```

<a id='comment:14'></a>
You need to set "needs review" if you want someone to look at your code. I'll do that now.



---

archive/issue_events_096325.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2015-01-31T09:05:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11941#event-96325"
}
```



---

archive/issue_comments_128529.json:
```json
{
    "body": "**Work_Issues:** report upstream",
    "created_at": "2015-03-11T17:22:31Z",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11941#issuecomment-128529",
    "user": "https://github.com/rwst"
}
```

**Work_Issues:** report upstream



---

archive/issue_comments_128530.json:
```json
{
    "body": "**Upstream:** Not yet reported upstream; Will do shortly.",
    "created_at": "2015-03-11T17:22:31Z",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11941#issuecomment-128530",
    "user": "https://github.com/rwst"
}
```

**Upstream:** Not yet reported upstream; Will do shortly.



---

archive/issue_comments_128531.json:
```json
{
    "body": "<a id='comment:15'></a>\nAs Karl-Dieter says in [comment:8](#comment%3A8) it is not desirable to switch back and forth with Maxima domain commands, so I don't think your patch is the right way to solve it, esp. since you don't get the right result, either. Presumably the failure of assumption should be reported upstream.",
    "created_at": "2015-03-11T17:22:31Z",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11941#issuecomment-128531",
    "user": "https://github.com/rwst"
}
```

<a id='comment:15'></a>
As Karl-Dieter says in [comment:8](#comment%3A8) it is not desirable to switch back and forth with Maxima domain commands, so I don't think your patch is the right way to solve it, esp. since you don't get the right result, either. Presumably the failure of assumption should be reported upstream.



---

archive/issue_events_096326.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2015-03-11T17:22:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11941#event-96326"
}
```



---

archive/issue_events_096327.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2015-03-11T17:22:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11941#event-96327"
}
```



---

archive/issue_comments_128532.json:
```json
{
    "body": "<a id='comment:16'></a>\nAs found in #22017 SymPy gets it right. If SymPy is better than Maxima with symbolic polynomial roots then I think we should switch to SymPy for the special case.",
    "created_at": "2016-12-05T06:51:53Z",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11941#issuecomment-128532",
    "user": "https://github.com/rwst"
}
```

<a id='comment:16'></a>
As found in #22017 SymPy gets it right. If SymPy is better than Maxima with symbolic polynomial roots then I think we should switch to SymPy for the special case.



---

archive/issue_events_096328.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2016-12-05T06:51:53Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11941#event-96328"
}
```



---

archive/issue_events_096329.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2016-12-05T06:51:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "milestone": "sage-7.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11941#event-96329"
}
```



---

archive/issue_comments_128533.json:
```json
{
    "body": "<a id='comment:17'></a>\nNote that sympy also incorporates assumptions into the solver:\n\n```python\nIn [2]: x = var('x', real=True)\n\nIn [3]: solve(Eq(x**3, -8))\nOut[3]: [-2]\n```",
    "created_at": "2016-12-05T07:19:21Z",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11941#issuecomment-128533",
    "user": "https://github.com/pelegm"
}
```

<a id='comment:17'></a>
Note that sympy also incorporates assumptions into the solver:

```python
In [2]: x = var('x', real=True)

In [3]: solve(Eq(x**3, -8))
Out[3]: [-2]
```



---

archive/issue_comments_128534.json:
```json
{
    "body": "<a id='comment:18'></a>\nSwitching to SymPy would also depend on something like #22024.",
    "created_at": "2016-12-05T07:39:51Z",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11941#issuecomment-128534",
    "user": "https://github.com/rwst"
}
```

<a id='comment:18'></a>
Switching to SymPy would also depend on something like #22024.



---

archive/issue_comments_128535.json:
```json
{
    "body": "<a id='comment:19'></a>\nWith #22024 we have now:\n\n```\nsage: solve(x^3+1==0,x,algorithm='sympy')\n[x == -1, x == -1/2*I*sqrt(3) + 1/2, x == 1/2*I*sqrt(3) + 1/2]\nsage: solve(x^3+1==0,x,algorithm='sympy', domain='real')\n[x == -1]\n```\nwhich, as I understand the notorious discussion, isn't right either because in the complex domain Maxima's results are not reproduced?",
    "created_at": "2017-11-02T07:09:23Z",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11941#issuecomment-128535",
    "user": "https://github.com/rwst"
}
```

<a id='comment:19'></a>
With #22024 we have now:

```
sage: solve(x^3+1==0,x,algorithm='sympy')
[x == -1, x == -1/2*I*sqrt(3) + 1/2, x == 1/2*I*sqrt(3) + 1/2]
sage: solve(x^3+1==0,x,algorithm='sympy', domain='real')
[x == -1]
```
which, as I understand the notorious discussion, isn't right either because in the complex domain Maxima's results are not reproduced?



---

archive/issue_comments_128536.json:
```json
{
    "body": "<a id='comment:20'></a>\nReplying to [rws](#comment%3A19):\n> With #22024 we have now:\n> \n> ```\n> sage: solve(x^3+1==0,x,algorithm='sympy')\n> [x == -1, x == -1/2*I*sqrt(3) + 1/2, x == 1/2*I*sqrt(3) + 1/2]\n> sage: solve(x^3+1==0,x,algorithm='sympy', domain='real')\n> [x == -1]\n> ```\n> which, as I understand the notorious discussion, isn't right either because in the complex domain Maxima's results are not reproduced?\n\n\nHmmm... things seems to have changed on Maxima's front. Compare :\n\n```\ncharpent@p-202-021:~$ sage -maxima\n;;; Loading #P\"/usr/local/sage-8/local/lib/ecl/sb-bsd-sockets.fas\"\n;;; Loading #P\"/usr/local/sage-8/local/lib/ecl/sockets.fas\"\n;;; Loading #P\"/usr/local/sage-8/local/lib/ecl/defsystem.fas\"\n;;; Loading #P\"/usr/local/sage-8/local/lib/ecl/cmp.fas\"\nMaxima 5.39.0 http://maxima.sourceforge.net\nusing Lisp ECL 16.1.2\nDistributed under the GNU Public License. See the file COPYING.\nDedicated to the memory of William Schelter.\nThe function bug_report() provides bug reporting information.\n(%i1) forget();\n(%o1)                                 []\n(%i2) solve(x^3+1=0,x);\n                     sqrt(3) %i - 1      sqrt(3) %i + 1\n(%o2)         [x = - --------------, x = --------------, x = - 1]\n                           2                   2\n(%i3) declare(x,real);\n(%o3)                                done\n(%i4) solve(x^3+1=0,x);\n                     sqrt(3) %i - 1      sqrt(3) %i + 1\n(%o4)         [x = - --------------, x = --------------, x = - 1]\n                           2                   2\n(%i5) quit();\n```\n\n[ Note : this is \"our\" Maxima ; but Maxima 5.40.0 as packaged in Debian and Cocalc's version both give the same answers... ]\n\nand :\n\n```\ncharpent@p-202-021:~$ sage\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 8.1.rc0, Release Date: 2017-11-08                 \u2502\n\u2502 Type \"notebook()\" for the browser-based notebook interface.        \u2502\n\u2502 Type \"help()\" for help.                                            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250f\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2513\n\u2503 Warning: this is a prerelease version, and it may be unstable.     \u2503\n\u2517\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u251b\nsage: forget();\nsage: solve(x^3+1==0,x)\n[x == 1/2*I*sqrt(3)*(-1)^(1/3) - 1/2*(-1)^(1/3), x == -1/2*I*sqrt(3)*(-1)^(1/3) - 1/2*(-1)^(1/3), x == (-1)^(1/3)]\nsage: assume(x,\"real\")\nsage: solve(x^3+1==0,x)\n[]\nsage: quit\nExiting Sage (CPU time 0m1.63s, Wall time 1m2.97s).\n```\n\nMaxima's second answer may be disputable (it doesn't account for the declaration of `x` as real), but Sage's is indisputably wrong, *wrong*, **wrong**.\n\nI'm painfully tempted to file a new ticket and flag it as critical. Advice ?",
    "created_at": "2017-11-14T15:40:04Z",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11941#issuecomment-128536",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:20'></a>
Replying to [rws](#comment%3A19):
> With #22024 we have now:
> 
> ```
> sage: solve(x^3+1==0,x,algorithm='sympy')
> [x == -1, x == -1/2*I*sqrt(3) + 1/2, x == 1/2*I*sqrt(3) + 1/2]
> sage: solve(x^3+1==0,x,algorithm='sympy', domain='real')
> [x == -1]
> ```
> which, as I understand the notorious discussion, isn't right either because in the complex domain Maxima's results are not reproduced?


Hmmm... things seems to have changed on Maxima's front. Compare :

```
charpent@p-202-021:~$ sage -maxima
;;; Loading #P"/usr/local/sage-8/local/lib/ecl/sb-bsd-sockets.fas"
;;; Loading #P"/usr/local/sage-8/local/lib/ecl/sockets.fas"
;;; Loading #P"/usr/local/sage-8/local/lib/ecl/defsystem.fas"
;;; Loading #P"/usr/local/sage-8/local/lib/ecl/cmp.fas"
Maxima 5.39.0 http://maxima.sourceforge.net
using Lisp ECL 16.1.2
Distributed under the GNU Public License. See the file COPYING.
Dedicated to the memory of William Schelter.
The function bug_report() provides bug reporting information.
(%i1) forget();
(%o1)                                 []
(%i2) solve(x^3+1=0,x);
                     sqrt(3) %i - 1      sqrt(3) %i + 1
(%o2)         [x = - --------------, x = --------------, x = - 1]
                           2                   2
(%i3) declare(x,real);
(%o3)                                done
(%i4) solve(x^3+1=0,x);
                     sqrt(3) %i - 1      sqrt(3) %i + 1
(%o4)         [x = - --------------, x = --------------, x = - 1]
                           2                   2
(%i5) quit();
```

[ Note : this is "our" Maxima ; but Maxima 5.40.0 as packaged in Debian and Cocalc's version both give the same answers... ]

and :

```
charpent@p-202-021:~$ sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 8.1.rc0, Release Date: 2017-11-08                 │
│ Type "notebook()" for the browser-based notebook interface.        │
│ Type "help()" for help.                                            │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: forget();
sage: solve(x^3+1==0,x)
[x == 1/2*I*sqrt(3)*(-1)^(1/3) - 1/2*(-1)^(1/3), x == -1/2*I*sqrt(3)*(-1)^(1/3) - 1/2*(-1)^(1/3), x == (-1)^(1/3)]
sage: assume(x,"real")
sage: solve(x^3+1==0,x)
[]
sage: quit
Exiting Sage (CPU time 0m1.63s, Wall time 1m2.97s).
```

Maxima's second answer may be disputable (it doesn't account for the declaration of `x` as real), but Sage's is indisputably wrong, *wrong*, **wrong**.

I'm painfully tempted to file a new ticket and flag it as critical. Advice ?



---

archive/issue_comments_128537.json:
```json
{
    "body": "<a id='comment:21'></a>\nAs pointed out [earlier](#comment%3A6), this is due to `domain:complex`:\n\n```\nMaxima 5.39.0 http://maxima.sourceforge.net\nusing Lisp ECL 16.1.2\nDistributed under the GNU Public License. See the file COPYING.\nDedicated to the memory of William Schelter.\nThe function bug_report() provides bug reporting information.\n(%i1) domain:complex;\n(%o1)                               complex\n(%i2) solve(x^3+1=0,x);\n                1/3                   1/3\n           (- 1)    sqrt(3) %i - (- 1)\n(%o2) [x = ------------------------------, \n                         2\n                                       1/3                   1/3\n                                  (- 1)    sqrt(3) %i + (- 1)              1/3\n                            x = - ------------------------------, x = (- 1)   ]\n                                                2\n```",
    "created_at": "2017-11-14T15:45:01Z",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11941#issuecomment-128537",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:21'></a>
As pointed out [earlier](#comment%3A6), this is due to `domain:complex`:

```
Maxima 5.39.0 http://maxima.sourceforge.net
using Lisp ECL 16.1.2
Distributed under the GNU Public License. See the file COPYING.
Dedicated to the memory of William Schelter.
The function bug_report() provides bug reporting information.
(%i1) domain:complex;
(%o1)                               complex
(%i2) solve(x^3+1=0,x);
                1/3                   1/3
           (- 1)    sqrt(3) %i - (- 1)
(%o2) [x = ------------------------------, 
                         2
                                       1/3                   1/3
                                  (- 1)    sqrt(3) %i + (- 1)              1/3
                            x = - ------------------------------, x = (- 1)   ]
                                                2
```



---

archive/issue_comments_128538.json:
```json
{
    "body": "<a id='comment:22'></a>\nAnd if you can figure out how to deal with this - in Maxima or elsewhere - please do!   I don't think this was ever reported upstream.",
    "created_at": "2017-11-14T15:46:25Z",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11941#issuecomment-128538",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:22'></a>
And if you can figure out how to deal with this - in Maxima or elsewhere - please do!   I don't think this was ever reported upstream.



---

archive/issue_comments_128539.json:
```json
{
    "body": "<a id='comment:23'></a>\nReplying to [kcrisman](#comment%3A21):\n> As pointed out [earlier](#comment%3A6), this is due to `domain:complex`:\n> \n> ```\n> Maxima 5.39.0 http://maxima.sourceforge.net\n> using Lisp ECL 16.1.2\n> Distributed under the GNU Public License. See the file COPYING.\n> Dedicated to the memory of William Schelter.\n> The function bug_report() provides bug reporting information.\n> (%i1) domain:complex;\n> (%o1)                               complex\n> (%i2) solve(x^3+1=0,x);\n>                 1/3                   1/3\n>            (- 1)    sqrt(3) %i - (- 1)\n> (%o2) [x = ------------------------------, \n>                          2\n>                                        1/3                   1/3\n>                                   (- 1)    sqrt(3) %i + (- 1)              1/3\n>                             x = - ------------------------------, x = (- 1)   ]\n>                                                 2\n> ```\n\n\nOK. I agree that this is only *disputable*.\n\nMy beef is with Sage's *second* answer, which tells us that Sage is unable to find a real root to `x^3+1==O`. Maxima returns a list of three *candidate* answers, among whom two turn out to be unacceptable. Sage turns out *no* candidate.",
    "created_at": "2017-11-14T16:24:58Z",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11941#issuecomment-128539",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:23'></a>
Replying to [kcrisman](#comment%3A21):
> As pointed out [earlier](#comment%3A6), this is due to `domain:complex`:
> 
> ```
> Maxima 5.39.0 http://maxima.sourceforge.net
> using Lisp ECL 16.1.2
> Distributed under the GNU Public License. See the file COPYING.
> Dedicated to the memory of William Schelter.
> The function bug_report() provides bug reporting information.
> (%i1) domain:complex;
> (%o1)                               complex
> (%i2) solve(x^3+1=0,x);
>                 1/3                   1/3
>            (- 1)    sqrt(3) %i - (- 1)
> (%o2) [x = ------------------------------, 
>                          2
>                                        1/3                   1/3
>                                   (- 1)    sqrt(3) %i + (- 1)              1/3
>                             x = - ------------------------------, x = (- 1)   ]
>                                                 2
> ```


OK. I agree that this is only *disputable*.

My beef is with Sage's *second* answer, which tells us that Sage is unable to find a real root to `x^3+1==O`. Maxima returns a list of three *candidate* answers, among whom two turn out to be unacceptable. Sage turns out *no* candidate.



---

archive/issue_comments_128540.json:
```json
{
    "body": "<a id='comment:24'></a>\nYou can definitely feel free to fix it or report upstream though!  It is ugly to say the least.\n\nThe second answer I can't quite explain.  Typically `solve` has nothing to do with our assumptions - least of all the `declare` syntax Maxima uses for what we do with things like assuming real or integer.  But we do have some minimal checking (see below).\n\n```\n(%i3) declare(x,real);\n(%o3)                                done\n(%i4) solve(x^3+1=0,x);\n                1/3                   1/3\n           (- 1)    sqrt(3) %i - (- 1)\n(%o4) [x = ------------------------------, \n                         2\n                                       1/3                   1/3\n                                  (- 1)    sqrt(3) %i + (- 1)              1/3\n                            x = - ------------------------------, x = (- 1)   ]\n                                                2\n```\n\nHowever, note that without `domain:complex` we get\n\n```\n(%i1) declare(x,real);\n(%o1)                                done\n(%i2) solve(x^3+1=0,x);\n                     sqrt(3) %i - 1      sqrt(3) %i + 1\n(%o2)         [x = - --------------, x = --------------, x = - 1]\n                           2                   2\n```\n\nas perhaps noted above.  \n\n[Here is the relevant code](https://github.com/sagemath/sage/blob/master/src/sage/symbolic/expression.pyx#L11436) for how Sage checks for assumptions with solving.\n\n```\n        # make sure all the assumptions are satisfied\n        from sage.symbolic.assumptions import assumptions\n        to_check = assumptions()\n        if to_check:\n            for ix, soln in reversed(list(enumerate(X))):\n                if soln.lhs().is_symbol():\n                    if any([a.contradicts(soln) for a in to_check]):\n                        del X[ix]\n                        if multiplicities:\n                            del ret_multiplicities[ix]\n                        continue\n```\nApparently something is going wrong here with `x == -1`, but I'm not sure what.",
    "created_at": "2017-11-14T18:16:50Z",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11941#issuecomment-128540",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:24'></a>
You can definitely feel free to fix it or report upstream though!  It is ugly to say the least.

The second answer I can't quite explain.  Typically `solve` has nothing to do with our assumptions - least of all the `declare` syntax Maxima uses for what we do with things like assuming real or integer.  But we do have some minimal checking (see below).

```
(%i3) declare(x,real);
(%o3)                                done
(%i4) solve(x^3+1=0,x);
                1/3                   1/3
           (- 1)    sqrt(3) %i - (- 1)
(%o4) [x = ------------------------------, 
                         2
                                       1/3                   1/3
                                  (- 1)    sqrt(3) %i + (- 1)              1/3
                            x = - ------------------------------, x = (- 1)   ]
                                                2
```

However, note that without `domain:complex` we get

```
(%i1) declare(x,real);
(%o1)                                done
(%i2) solve(x^3+1=0,x);
                     sqrt(3) %i - 1      sqrt(3) %i + 1
(%o2)         [x = - --------------, x = --------------, x = - 1]
                           2                   2
```

as perhaps noted above.  

[Here is the relevant code](https://github.com/sagemath/sage/blob/master/src/sage/symbolic/expression.pyx#L11436) for how Sage checks for assumptions with solving.

```
        # make sure all the assumptions are satisfied
        from sage.symbolic.assumptions import assumptions
        to_check = assumptions()
        if to_check:
            for ix, soln in reversed(list(enumerate(X))):
                if soln.lhs().is_symbol():
                    if any([a.contradicts(soln) for a in to_check]):
                        del X[ix]
                        if multiplicities:
                            del ret_multiplicities[ix]
                        continue
```
Apparently something is going wrong here with `x == -1`, but I'm not sure what.



---

archive/issue_comments_128541.json:
```json
{
    "body": "<a id='comment:25'></a>\nReplying to [kcrisman](#comment%3A24):\n> You can definitely feel free to fix it or report upstream though!  It is ugly to say the least.\n\n\nInded. But the point of *not* replacing (-1)!^(1/n) by -1 is well taken : the first expression may, after all, be *any* *n*th root of -1 (see an example below).\n\nSo I'm not sure it's a bug. But yes, it's ugly as hell... (more tolerable in \\LaTeX...).\n\n> The second answer I can't quite explain.  Typically `solve` has nothing to do with our assumptions - least of all the `declare` syntax Maxima uses for what we do with things like assuming real or integer.  But we do have some minimal checking (see below).\n> \n> ```\n> (%i3) declare(x,real);\n> (%o3)                                done\n> (%i4) solve(x^3+1=0,x);\n>                 1/3                   1/3\n>            (- 1)    sqrt(3) %i - (- 1)\n> (%o4) [x = ------------------------------, \n>                          2\n>                                        1/3                   1/3\n>                                   (- 1)    sqrt(3) %i + (- 1)              1/3\n>                             x = - ------------------------------, x = (- 1)   ]\n>                                                 2\n> ```\n> \n> However, note that without `domain:complex` we get\n> \n> ```\n> (%i1) declare(x,real);\n> (%o1)                                done\n> (%i2) solve(x^3+1=0,x);\n>                      sqrt(3) %i - 1      sqrt(3) %i + 1\n> (%o2)         [x = - --------------, x = --------------, x = - 1]\n>                            2                   2\n> ```\n> \n> as perhaps noted above.  \n> \n> [Here is the relevant code](https://github.com/sagemath/sage/blob/master/src/sage/symbolic/expression.pyx#L11436) for how Sage checks for assumptions with solving.\n> \n> ```\n>         # make sure all the assumptions are satisfied\n>         from sage.symbolic.assumptions import assumptions\n>         to_check = assumptions()\n>         if to_check:\n>             for ix, soln in reversed(list(enumerate(X))):\n>                 if soln.lhs().is_symbol():\n>                     if any([a.contradicts(soln) for a in to_check]):\n>                         del X[ix]\n>                         if multiplicities:\n>                             del ret_multiplicities[ix]\n>                         continue\n> ```\n> Apparently something is going wrong here with `x == -1`, but I'm not sure what.\n\n\nI think that our code for testing that an expression is real is too weak. After all,\n\n```\nsage: ((-1)^(1/3)).is_real()\nFalse\n```\n\nA workaround is to force the evaluation of each root \"in Sage terms\", as demonstrates the following crock :\n\n```\nsage: Sols=solve(x^3+1==0,x);Sols\n[x == 1/2*I*sqrt(3)*(-1)^(1/3) - 1/2*(-1)^(1/3), x == -1/2*I*sqrt(3)*(-1)^(1/3) - 1/2*(-1)^(1/3), x == (-1)^(1/3)]\nsage: [t.rhs().is_real() for t in Sols]\n[False, False, False]\n```\nNone of these roots is *known as* real (in direct contradiction of d'Alembert's theorem, no less...). Try to force a re-evaluation of these expressions :\n\n```\nsage: [t.rhs().real_part()+I*t.rhs().imag_part() for t in Sols]\n[-1, -1/2*I*sqrt(3) + 1/2, 1/2*I*sqrt(3) + 1/2]\n```\n (Note that this implies that, in that specific case, `(-1)^(1/3)` is `(I*sqrt(3)+1)/2`...)\n\nNow, these re-evaluated quantities *can* be effectively tested for \"reality\" :\n\n```\nsage: [(t.rhs().real_part()+I*t.rhs().imag_part()).is_real() for t in Sols]\n[True, False, False]\n```\n\nI do not know what code uses the `.contradict()` method for the assertion `x is real`, but it may fall in the same trap.\n\nThe problem is now to know *what code* is to be fixed : assumptions ? Or more general algebraic code ? Is this problem specific to Maxima-generated expressions, or more general ? How to force re-evaluation (`real_part()` and `imag_part()` may be highly nontrivial, or even impossible for some expressions) ?\n\nAdvice more than welcome...",
    "created_at": "2017-11-14T19:36:15Z",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11941#issuecomment-128541",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:25'></a>
Replying to [kcrisman](#comment%3A24):
> You can definitely feel free to fix it or report upstream though!  It is ugly to say the least.


Inded. But the point of *not* replacing (-1)!^(1/n) by -1 is well taken : the first expression may, after all, be *any* *n*th root of -1 (see an example below).

So I'm not sure it's a bug. But yes, it's ugly as hell... (more tolerable in \LaTeX...).

> The second answer I can't quite explain.  Typically `solve` has nothing to do with our assumptions - least of all the `declare` syntax Maxima uses for what we do with things like assuming real or integer.  But we do have some minimal checking (see below).
> 
> ```
> (%i3) declare(x,real);
> (%o3)                                done
> (%i4) solve(x^3+1=0,x);
>                 1/3                   1/3
>            (- 1)    sqrt(3) %i - (- 1)
> (%o4) [x = ------------------------------, 
>                          2
>                                        1/3                   1/3
>                                   (- 1)    sqrt(3) %i + (- 1)              1/3
>                             x = - ------------------------------, x = (- 1)   ]
>                                                 2
> ```
> 
> However, note that without `domain:complex` we get
> 
> ```
> (%i1) declare(x,real);
> (%o1)                                done
> (%i2) solve(x^3+1=0,x);
>                      sqrt(3) %i - 1      sqrt(3) %i + 1
> (%o2)         [x = - --------------, x = --------------, x = - 1]
>                            2                   2
> ```
> 
> as perhaps noted above.  
> 
> [Here is the relevant code](https://github.com/sagemath/sage/blob/master/src/sage/symbolic/expression.pyx#L11436) for how Sage checks for assumptions with solving.
> 
> ```
>         # make sure all the assumptions are satisfied
>         from sage.symbolic.assumptions import assumptions
>         to_check = assumptions()
>         if to_check:
>             for ix, soln in reversed(list(enumerate(X))):
>                 if soln.lhs().is_symbol():
>                     if any([a.contradicts(soln) for a in to_check]):
>                         del X[ix]
>                         if multiplicities:
>                             del ret_multiplicities[ix]
>                         continue
> ```
> Apparently something is going wrong here with `x == -1`, but I'm not sure what.


I think that our code for testing that an expression is real is too weak. After all,

```
sage: ((-1)^(1/3)).is_real()
False
```

A workaround is to force the evaluation of each root "in Sage terms", as demonstrates the following crock :

```
sage: Sols=solve(x^3+1==0,x);Sols
[x == 1/2*I*sqrt(3)*(-1)^(1/3) - 1/2*(-1)^(1/3), x == -1/2*I*sqrt(3)*(-1)^(1/3) - 1/2*(-1)^(1/3), x == (-1)^(1/3)]
sage: [t.rhs().is_real() for t in Sols]
[False, False, False]
```
None of these roots is *known as* real (in direct contradiction of d'Alembert's theorem, no less...). Try to force a re-evaluation of these expressions :

```
sage: [t.rhs().real_part()+I*t.rhs().imag_part() for t in Sols]
[-1, -1/2*I*sqrt(3) + 1/2, 1/2*I*sqrt(3) + 1/2]
```
 (Note that this implies that, in that specific case, `(-1)^(1/3)` is `(I*sqrt(3)+1)/2`...)

Now, these re-evaluated quantities *can* be effectively tested for "reality" :

```
sage: [(t.rhs().real_part()+I*t.rhs().imag_part()).is_real() for t in Sols]
[True, False, False]
```

I do not know what code uses the `.contradict()` method for the assertion `x is real`, but it may fall in the same trap.

The problem is now to know *what code* is to be fixed : assumptions ? Or more general algebraic code ? Is this problem specific to Maxima-generated expressions, or more general ? How to force re-evaluation (`real_part()` and `imag_part()` may be highly nontrivial, or even impossible for some expressions) ?

Advice more than welcome...



---

archive/issue_comments_128542.json:
```json
{
    "body": "<a id='comment:26'></a>\nOne more data point : Maxima seems to be able to solve the specific test which is problematic for the current Sage assumption code. Consider :\n\n```\nsage: ## A few abbreviations, I'm lazy\nsage: def mrhs(x):return(maxima_lib.rhs(x))\nsage: def mreal(x):return(maxima_lib.featurep(x,\"real\"))\nsage: def msolve(e,v):return(maxima_lib.solve(*[t._maxima_lib_() for t in [e,v]]\n....: ))\nsage: assumptions()\n[]\nsage: maxima_lib.facts()\n[kind(sinh,one_to_one),kind(log,one_to_one),kind(tanh,one_to_one),kind(log,increasing)]\nsage: [mreal(mrhs(t)) for t in msolve(x^3+1==0,x)]\n[true, false, false]\n```\n\nQuestions :\n* Should we use this ? If so\n    - where ?\n    - with what generality ?\n\nAdvice necessary...",
    "created_at": "2017-11-15T20:38:15Z",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11941#issuecomment-128542",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:26'></a>
One more data point : Maxima seems to be able to solve the specific test which is problematic for the current Sage assumption code. Consider :

```
sage: ## A few abbreviations, I'm lazy
sage: def mrhs(x):return(maxima_lib.rhs(x))
sage: def mreal(x):return(maxima_lib.featurep(x,"real"))
sage: def msolve(e,v):return(maxima_lib.solve(*[t._maxima_lib_() for t in [e,v]]
....: ))
sage: assumptions()
[]
sage: maxima_lib.facts()
[kind(sinh,one_to_one),kind(log,one_to_one),kind(tanh,one_to_one),kind(log,increasing)]
sage: [mreal(mrhs(t)) for t in msolve(x^3+1==0,x)]
[true, false, false]
```

Questions :
* Should we use this ? If so
    - where ?
    - with what generality ?

Advice necessary...



---

archive/issue_comments_128543.json:
```json
{
    "body": "<a id='comment:27'></a>\nReplying to [charpent](#comment%3A25):\n> I think that our code for testing that an expression is real is too weak. After all,\n> \n> ```\n> sage: ((-1)^(1/3)).is_real()\n> False\n> ```\n\n\nThe False from is_real (and any of these functions) just means \"I don't know\" in absence of a Python tri-state logic. It may be possible to return Unknown here by implementing `is_complex`.",
    "created_at": "2017-11-16T06:52:17Z",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11941#issuecomment-128543",
    "user": "https://github.com/rwst"
}
```

<a id='comment:27'></a>
Replying to [charpent](#comment%3A25):
> I think that our code for testing that an expression is real is too weak. After all,
> 
> ```
> sage: ((-1)^(1/3)).is_real()
> False
> ```


The False from is_real (and any of these functions) just means "I don't know" in absence of a Python tri-state logic. It may be possible to return Unknown here by implementing `is_complex`.



---

archive/issue_comments_128544.json:
```json
{
    "body": "<a id='comment:28'></a>\nReplying to [charpent](#comment%3A26):\n> \n> ```\n> sage: [mreal(mrhs(t)) for t in msolve(x^3+1==0,x)]\n> [true, false, false]\n> ```\n\n\nIs that root really real? In what domain is Maxima at that point?",
    "created_at": "2017-11-16T06:56:19Z",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11941#issuecomment-128544",
    "user": "https://github.com/rwst"
}
```

<a id='comment:28'></a>
Replying to [charpent](#comment%3A26):
> 
> ```
> sage: [mreal(mrhs(t)) for t in msolve(x^3+1==0,x)]
> [true, false, false]
> ```


Is that root really real? In what domain is Maxima at that point?



---

archive/issue_comments_128545.json:
```json
{
    "body": "<a id='comment:29'></a>\nReplying to [rws](#comment%3A28):\n> Replying to [charpent](#comment%3A26):\n> > \n> > ```\n> > sage: [mreal(mrhs(t)) for t in msolve(x^3+1==0,x)]\n> > [true, false, false]\n> > ```\n\n> \n> Is that root really real?\n\n\nThat's  what Maxima says. Whatever it does is probably more credible than what we do (see below).\n\n> In what domain is Maxima at that point?\n\n\nLook for yourself :\n\n```\nsage: from sage.interfaces.maxima_lib import maxima_lib as ml\nsage: def mrhs(x):return(ml.rhs(x))\nsage: def msolve(e,v):return(ml.solve(*[t._maxima_lib_() for t in [e,v]]))\nsage: def mreal(x):return(ml.featurep(x,\"real\"))\nsage: ml.ev(\"domain\")\ncomplex\nsage: sol=msolve(x^3+1==0,x);sol\n[_SAGE_VAR_x=((-1)^(1/3)*sqrt(3)*%i-(-1)^(1/3))/2,_SAGE_VAR_x=-((-1)^(1/3)*sqrt(3)*%i+(-1)^(1/3))/2,_SAGE_VAR_x=(-1)^(1/3)]\nsage: ml.ev(\"domain\")\ncomplex\nsage: [mreal(mrhs(t)) for t in sol]\n[true, false, false]\nsage: [mrhs(t).sage().n() for t in sol]\n\n[-1.00000000000000 + 1.11022302462516e-16*I,\n 0.500000000000000 - 0.866025403784439*I,\n 0.500000000000000 + 0.866025403784439*I]\n```\n\nThe numerical values *tend to confirm* that the first root is real.\n\nAnd **that** is our problem : the `.contradicts` code (in `$SAGE_ROOT/src/sage/symbolic/assumptions.py`) is piss-poor : it coerces the value to be tested to `CC` and tests if the resulting coercion belongs to `RR`. Aaaaarghhh...\n\nThat said, I stumbled on another problem. Our current code doesn't pass *declarations* to Maxima correctly :\n\n```\nage: assume(z,\"integer\")\nsage: assume(z>0)\nsage: assumptions()\n[z is integer, z > 0]\nsage: ml.facts()\n[kind(sinh,one_to_one),kind(log,one_to_one),kind(tanh,one_to_one),kind(log,increasing),_SAGE_VAR_z>0]\nsage: maxima_calculus(\"facts()\")\n[kind(sinh,one_to_one),kind(log,one_to_one),kind(tanh,one_to_one),kind(log,increasing),_SAGE_VAR_z>0]\n```\n\nI haven't (yet) checked trac to see if this is known. If not, that's a nice ticket to file.\n\nI don't (yet) have a solution.",
    "created_at": "2017-11-16T07:52:25Z",
    "issue": "https://github.com/sagemath/sage/issues/11941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11941#issuecomment-128545",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:29'></a>
Replying to [rws](#comment%3A28):
> Replying to [charpent](#comment%3A26):
> > 
> > ```
> > sage: [mreal(mrhs(t)) for t in msolve(x^3+1==0,x)]
> > [true, false, false]
> > ```

> 
> Is that root really real?


That's  what Maxima says. Whatever it does is probably more credible than what we do (see below).

> In what domain is Maxima at that point?


Look for yourself :

```
sage: from sage.interfaces.maxima_lib import maxima_lib as ml
sage: def mrhs(x):return(ml.rhs(x))
sage: def msolve(e,v):return(ml.solve(*[t._maxima_lib_() for t in [e,v]]))
sage: def mreal(x):return(ml.featurep(x,"real"))
sage: ml.ev("domain")
complex
sage: sol=msolve(x^3+1==0,x);sol
[_SAGE_VAR_x=((-1)^(1/3)*sqrt(3)*%i-(-1)^(1/3))/2,_SAGE_VAR_x=-((-1)^(1/3)*sqrt(3)*%i+(-1)^(1/3))/2,_SAGE_VAR_x=(-1)^(1/3)]
sage: ml.ev("domain")
complex
sage: [mreal(mrhs(t)) for t in sol]
[true, false, false]
sage: [mrhs(t).sage().n() for t in sol]

[-1.00000000000000 + 1.11022302462516e-16*I,
 0.500000000000000 - 0.866025403784439*I,
 0.500000000000000 + 0.866025403784439*I]
```

The numerical values *tend to confirm* that the first root is real.

And **that** is our problem : the `.contradicts` code (in `$SAGE_ROOT/src/sage/symbolic/assumptions.py`) is piss-poor : it coerces the value to be tested to `CC` and tests if the resulting coercion belongs to `RR`. Aaaaarghhh...

That said, I stumbled on another problem. Our current code doesn't pass *declarations* to Maxima correctly :

```
age: assume(z,"integer")
sage: assume(z>0)
sage: assumptions()
[z is integer, z > 0]
sage: ml.facts()
[kind(sinh,one_to_one),kind(log,one_to_one),kind(tanh,one_to_one),kind(log,increasing),_SAGE_VAR_z>0]
sage: maxima_calculus("facts()")
[kind(sinh,one_to_one),kind(log,one_to_one),kind(tanh,one_to_one),kind(log,increasing),_SAGE_VAR_z>0]
```

I haven't (yet) checked trac to see if this is known. If not, that's a nice ticket to file.

I don't (yet) have a solution.
