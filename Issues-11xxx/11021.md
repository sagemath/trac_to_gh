# Issue 11021: Fix install_package() library function

archive/issues_010927.json:
```json
{
    "body": "**Apply**\n1. [attachment:trac_11021-fix_sage.misc.install_package.sagelib.patch]\nto the **Sage library**.\n1. [attachment:trac_11021-root.patch] to `SAGE_ROOT`.\n\n---\n\n**OLD STUFF** superseded by other tickets, no longer relevant:\n\n## Fix \"sage -info\" and a bug when sourcing sage-env more than once\n\nOne of the patches at #9960 did a lot of clean-up to the file `sage-spkg`: quoting environment variables, replacing tabs with spaces, etc., also adding comments and TODOs.  Since those changes were not related to the issue at #9960, I've split them off and put them here instead.  The main change of any content is to look at the file `SPKG.txt` rather than `SAGE.txt` when the \"`-info`\" flag is passed so `sage-spkg` (through `sage -info ...`). Also, warnings and error messages are now redirected to `stderr`.\n\nThe additional patch to `sage-spkg` is based on the v2 \"clean-up\" patch, fixing some more bugs, adding error checks, improving some messages (see comment below / commit message for some more details).\n\nApparently support for `sage -info ...` was removed at some point (or never existed); the patch to `sage-sage` fixes that.\n\nThe patch to `sage-env` fixes a bug caused or enabled by #10469, which through the patch to `sage-spkg` now becomes more visible and potentially worse.\n\n**DO NOT** apply:\n1. [attachment:trac_11021-sage-spkg-cleanup-v2-rebased_to_4.7.1.alpha4.patch]\n2. [attachment:trac_11021-additional_changes_to_sage-spkg.scripts.patch] (somewhat optional, can be reviewed separately)\n3. [attachment:trac_11021-support_and_document_sage_-info_in_sage-sage.scripts.patch]\n4. [attachment:trac_11021-export_BUILD_in_sage-env.scripts.patch]\nto the **scripts repo**.\n\n\n**Assignee:** @nexttime\n\n**CC:**  drkirkby @nexttime @kiwifb\n\n**Keywords:** SPKG.txt SAGE.txt -info BUILD sage-env sage-sage sage-spkg\n\n**Reviewer:** Kelvin Li, Leif Leonhardy, John Palmieri\n\n**Author:** Leif Leonhardy, Kelvin Li, Jeroen Demeyer\n\n**Merged:** sage-5.4.beta0\n\n**Resolution:** fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/11021\n\n",
    "closed_at": "2012-09-04T11:37:14Z",
    "created_at": "2011-03-24T23:37:41Z",
    "labels": [
        "component: packages: standard",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.3",
    "title": "Fix install_package() library function",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11021",
    "user": "https://github.com/jhpalmieri"
}
```
**Apply**
1. [attachment:trac_11021-fix_sage.misc.install_package.sagelib.patch]
to the **Sage library**.
1. [attachment:trac_11021-root.patch] to `SAGE_ROOT`.

---

**OLD STUFF** superseded by other tickets, no longer relevant:

## Fix "sage -info" and a bug when sourcing sage-env more than once

One of the patches at #9960 did a lot of clean-up to the file `sage-spkg`: quoting environment variables, replacing tabs with spaces, etc., also adding comments and TODOs.  Since those changes were not related to the issue at #9960, I've split them off and put them here instead.  The main change of any content is to look at the file `SPKG.txt` rather than `SAGE.txt` when the "`-info`" flag is passed so `sage-spkg` (through `sage -info ...`). Also, warnings and error messages are now redirected to `stderr`.

The additional patch to `sage-spkg` is based on the v2 "clean-up" patch, fixing some more bugs, adding error checks, improving some messages (see comment below / commit message for some more details).

Apparently support for `sage -info ...` was removed at some point (or never existed); the patch to `sage-sage` fixes that.

The patch to `sage-env` fixes a bug caused or enabled by #10469, which through the patch to `sage-spkg` now becomes more visible and potentially worse.

**DO NOT** apply:
1. [attachment:trac_11021-sage-spkg-cleanup-v2-rebased_to_4.7.1.alpha4.patch]
2. [attachment:trac_11021-additional_changes_to_sage-spkg.scripts.patch] (somewhat optional, can be reviewed separately)
3. [attachment:trac_11021-support_and_document_sage_-info_in_sage-sage.scripts.patch]
4. [attachment:trac_11021-export_BUILD_in_sage-env.scripts.patch]
to the **scripts repo**.


**Assignee:** @nexttime

**CC:**  drkirkby @nexttime @kiwifb

**Keywords:** SPKG.txt SAGE.txt -info BUILD sage-env sage-sage sage-spkg

**Reviewer:** Kelvin Li, Leif Leonhardy, John Palmieri

**Author:** Leif Leonhardy, Kelvin Li, Jeroen Demeyer

**Merged:** sage-5.4.beta0

**Resolution:** fixed

Issue created by migration from https://trac.sagemath.org/ticket/11021





---

archive/issue_comments_148311.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2011-03-24T23:45:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148311",
    "user": "https://github.com/jhpalmieri"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_148312.json:
```json
{
    "body": "<a id='comment:2'></a>\nPatch has been rebased to sage 4.7. However, there is a problem on lines 136-143 in `sage-spkg` (after patch has been applied). The return code check doesn't do anything after the statement `echo \"\"`, because that overwrites `$?` to `0`. I can't figure out the intent of the preceding `tar` command, so I don't know how to fix this problem. Could someone help me?",
    "created_at": "2011-06-18T00:56:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148312",
    "user": "https://trac.sagemath.org/admin/accounts/users/ltw"
}
```

<a id='comment:2'></a>
Patch has been rebased to sage 4.7. However, there is a problem on lines 136-143 in `sage-spkg` (after patch has been applied). The return code check doesn't do anything after the statement `echo ""`, because that overwrites `$?` to `0`. I can't figure out the intent of the preceding `tar` command, so I don't know how to fix this problem. Could someone help me?



---

archive/issue_comments_148313.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1 +1,4 @@\n One of the patches at #9960 did a lot of clean-up to the file sage-spkg: quoting environment variables, replacing tabs with spaces, etc.  Since those changes were not related to the issue at #9960, I've split them off and put them here instead.  The main change of any content is to look at the file SPKG.txt rather than SAGE.txt when the \"-info\" flag is passed so sage-spkg.\n+\n+Apply:\n+1. [attachment:trac_11021-sage-spkg-cleanup-v2.patch]\n``````\n",
    "created_at": "2011-06-18T00:57:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148313",
    "user": "https://trac.sagemath.org/admin/accounts/users/ltw"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1 +1,4 @@
 One of the patches at #9960 did a lot of clean-up to the file sage-spkg: quoting environment variables, replacing tabs with spaces, etc.  Since those changes were not related to the issue at #9960, I've split them off and put them here instead.  The main change of any content is to look at the file SPKG.txt rather than SAGE.txt when the "-info" flag is passed so sage-spkg.
+
+Apply:
+1. [attachment:trac_11021-sage-spkg-cleanup-v2.patch]
``````




---

archive/issue_comments_148314.json:
```json
{
    "body": "<a id='comment:4'></a>\nWell, the code is a bit weird anyway; there should be an `exit 1` if the package (`$PKG_SRC`) does not exist:\n\n```sh\nif [ \"$INFO\" -ne 0 ]; then\n    if [ ! -f \"$PKG_SRC\" ]; then\n        echo \"Package $PKG_NAME not found\"\n        # EXIT HERE\n    fi\n    ...\n```\n\nI don't think we really need the `echo \"\"`, since `SPKG.txt` files should be newline-terminated. (The `tar` commands extract this file to `stdout`.)\n\n---\n\nAs far as I know, there are indeed (at least some old, optional) packages that do have a *short* `SAGE.txt` (rather than `SPKG.txt`), so I'm not sure if we shouldn't check for both.\n\nAlso, typical `SPKG.txt` files are quite long, so we might omit some parts or e.g. \"cut\" them where the Changelog section starts.",
    "created_at": "2011-06-18T01:49:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148314",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:4'></a>
Well, the code is a bit weird anyway; there should be an `exit 1` if the package (`$PKG_SRC`) does not exist:

```sh
if [ "$INFO" -ne 0 ]; then
    if [ ! -f "$PKG_SRC" ]; then
        echo "Package $PKG_NAME not found"
        # EXIT HERE
    fi
    ...
```

I don't think we really need the `echo ""`, since `SPKG.txt` files should be newline-terminated. (The `tar` commands extract this file to `stdout`.)

---

As far as I know, there are indeed (at least some old, optional) packages that do have a *short* `SAGE.txt` (rather than `SPKG.txt`), so I'm not sure if we shouldn't check for both.

Also, typical `SPKG.txt` files are quite long, so we might omit some parts or e.g. "cut" them where the Changelog section starts.



---

archive/issue_comments_148315.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n One of the patches at #9960 did a lot of clean-up to the file sage-spkg: quoting environment variables, replacing tabs with spaces, etc.  Since those changes were not related to the issue at #9960, I've split them off and put them here instead.  The main change of any content is to look at the file SPKG.txt rather than SAGE.txt when the \"-info\" flag is passed so sage-spkg.\n \n Apply:\n-1. [attachment:trac_11021-sage-spkg-cleanup-v2.patch]\n+1. [attachment:trac_11021-sage-spkg-cleanup-v2.patch] to scripts repo\n``````\n",
    "created_at": "2011-06-18T02:40:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148315",
    "user": "https://trac.sagemath.org/admin/accounts/users/ltw"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
 One of the patches at #9960 did a lot of clean-up to the file sage-spkg: quoting environment variables, replacing tabs with spaces, etc.  Since those changes were not related to the issue at #9960, I've split them off and put them here instead.  The main change of any content is to look at the file SPKG.txt rather than SAGE.txt when the "-info" flag is passed so sage-spkg.
 
 Apply:
-1. [attachment:trac_11021-sage-spkg-cleanup-v2.patch]
+1. [attachment:trac_11021-sage-spkg-cleanup-v2.patch] to scripts repo
``````




---

archive/issue_comments_148316.json:
```json
{
    "body": "<a id='comment:5'></a>\nLeif, I have updated the patch according to your first two suggestions. I don't know what to do with `SAGE.txt` or truncating long `SPKG.txt` files. I'm thinking that we should put those \"real\" changes in another ticket (or does one already exist?).",
    "created_at": "2011-06-18T02:40:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148316",
    "user": "https://trac.sagemath.org/admin/accounts/users/ltw"
}
```

<a id='comment:5'></a>
Leif, I have updated the patch according to your first two suggestions. I don't know what to do with `SAGE.txt` or truncating long `SPKG.txt` files. I'm thinking that we should put those "real" changes in another ticket (or does one already exist?).



---

archive/issue_comments_148317.json:
```json
{
    "body": "<a id='comment:6'></a>\nReplying to [ltw](#comment%3A5):\n> Leif, I have updated the patch according to your first two suggestions.\n\n\nOk, though I wouldn't have changed the \"error\" message; the previous one sounds a bit friendlier. (Actually a non-zero status code can have a couple of reasons there, but I don't mind. ;-) )\n\n\n\n\n> I don't know what to do with `SAGE.txt` or truncating long `SPKG.txt` files. I'm thinking that we should put those \"real\" changes in another ticket (or does one already exist?).\n\n\nMaybe John has some idea or opinion on that...\n\n(We could e.g. pipe the `tar` output to some sort of `sed -e '/== Changelog ==/,$d'` and perhaps give some message indicating it was omitted. Not important to me; maybe users less familiar with `more` or `less` could enjoy that - I personally don't use the `-info` option at all.)",
    "created_at": "2011-06-18T04:06:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148317",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:6'></a>
Replying to [ltw](#comment%3A5):
> Leif, I have updated the patch according to your first two suggestions.


Ok, though I wouldn't have changed the "error" message; the previous one sounds a bit friendlier. (Actually a non-zero status code can have a couple of reasons there, but I don't mind. ;-) )




> I don't know what to do with `SAGE.txt` or truncating long `SPKG.txt` files. I'm thinking that we should put those "real" changes in another ticket (or does one already exist?).


Maybe John has some idea or opinion on that...

(We could e.g. pipe the `tar` output to some sort of `sed -e '/== Changelog ==/,$d'` and perhaps give some message indicating it was omitted. Not important to me; maybe users less familiar with `more` or `less` could enjoy that - I personally don't use the `-info` option at all.)



---

archive/issue_comments_148318.json:
```json
{
    "body": "**Reviewer:** Kelvin Li",
    "created_at": "2011-06-18T04:11:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148318",
    "user": "https://github.com/nexttime"
}
```

**Reviewer:** Kelvin Li



---

archive/issue_comments_148319.json:
```json
{
    "body": "<a id='comment:8'></a>\nReplying to [leif](#comment%3A6):\n> Ok, though I wouldn't have changed the \"error\" message; the previous one sounds a bit friendlier. (Actually a non-zero status code can have a couple of reasons there, but I don't mind. ;-) )\n\n\nA few lines above, there is an error message `\"Package $PKG_NAME not found\"`. So I thought `\"File SPKG.txt not found in package $PKG_NAME\"` would follow the same grammar. But I can change it back, no problem. :-)\n\n> (We could e.g. pipe the `tar` output to some sort of `sed -e '/== Changelog ==/,$d'` and perhaps give some message indicating it was omitted.\n\n\nThat's pretty hackish in my opinion. It would impose an undocumented constraint on the format of SPKG.txt, which does not have any formatting validation otherwise. I'm not sure that truncating SPKG.txt is even desirable.",
    "created_at": "2011-06-19T05:14:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148319",
    "user": "https://trac.sagemath.org/admin/accounts/users/ltw"
}
```

<a id='comment:8'></a>
Replying to [leif](#comment%3A6):
> Ok, though I wouldn't have changed the "error" message; the previous one sounds a bit friendlier. (Actually a non-zero status code can have a couple of reasons there, but I don't mind. ;-) )


A few lines above, there is an error message `"Package $PKG_NAME not found"`. So I thought `"File SPKG.txt not found in package $PKG_NAME"` would follow the same grammar. But I can change it back, no problem. :-)

> (We could e.g. pipe the `tar` output to some sort of `sed -e '/== Changelog ==/,$d'` and perhaps give some message indicating it was omitted.


That's pretty hackish in my opinion. It would impose an undocumented constraint on the format of SPKG.txt, which does not have any formatting validation otherwise. I'm not sure that truncating SPKG.txt is even desirable.



---

archive/issue_comments_148320.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [ltw](#comment%3A8):\n> Replying to [leif](#comment%3A6):\n> > Ok, though I wouldn't have changed the \"error\" message; the previous one sounds a bit friendlier. (Actually a non-zero status code can have a couple of reasons there, but I don't mind. ;-) )\n\n> \n> A few lines above, there is an error message `\"Package $PKG_NAME not found\"`. So I thought `\"File SPKG.txt not found in package $PKG_NAME\"` would follow the same grammar. But I can change it back, no problem. :-)\n\n\nWhat about *\"Could not extract SPKG.txt.\"* or better *\"Package $PKG_NAME appears to have no SPKG.txt.\"*?\n\nRedirecting `stderr` **of the `tar` commands** to `/dev/null` is a bit odd there. On the other hand, the presence of `$PKG_SRC` (the spkg file) itself is checked **twice** a few lines above, so a non-zero exit code of `tar` most probably means either a corrupted tarball or the file to extract wasn't found. Maybe the proper way would be to first try to list the file (`tar tf - ... 2>/dev/null`) into some shell variable and check if it is empty (or, better, list the tarball's whole contents grepping for `$PKG_NAME/SPKG.txt`), and use `bunzip2 -t ...` to test whether the spkg is compressed in advance.\n\nOr verify the spkg **wasn't** corrupted in case of an error (`$? -ne 0`):\n\n```sh\n    ...\n    if [ $? -ne 0 ]; then\n        # Extracting SPKG.txt failed for *some* reason,\n        # now check if it's simply missing:\n        if (bunzip2 -c \"$PKG_SRC\" | tar tf -) &>/dev/null ||\n           tar tf \"$PKG_SRC\" &>/dev/null\n        then\n            echo \"Package $PKG_NAME lacks a description (SPKG.txt file).\"\n            exit 1\n        else\n            echo \"$PKG_SRC seems to be corrupted. Exiting.\"\n            exit 1 # or some other error code\n        fi\n    fi\n    exit 0\nfi\n```\n\nBut IMHO a rather minor issue.\n\n\n\n \n> > (We could e.g. pipe the `tar` output to some sort of `sed -e '/== Changelog ==/,$d'` and perhaps give some message indicating it was omitted.\n\n> \n> That's pretty hackish in my opinion. It would impose an undocumented constraint on the format of SPKG.txt, which does not have any formatting validation otherwise. I'm not sure that truncating SPKG.txt is even desirable.\n\n\n`SPKG.txt` files are supposed to have a quite clear structure, with ReST (section) mark-up (which an spkg reviewer should check btw). If there's no line matching `== Changelog ==` -- or preferably a more generic, i.e. robust pattern, nothing would get omitted.\n\nBut as I said, I have no opinion on truncating them there.",
    "created_at": "2011-06-19T08:53:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148320",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:9'></a>
Replying to [ltw](#comment%3A8):
> Replying to [leif](#comment%3A6):
> > Ok, though I wouldn't have changed the "error" message; the previous one sounds a bit friendlier. (Actually a non-zero status code can have a couple of reasons there, but I don't mind. ;-) )

> 
> A few lines above, there is an error message `"Package $PKG_NAME not found"`. So I thought `"File SPKG.txt not found in package $PKG_NAME"` would follow the same grammar. But I can change it back, no problem. :-)


What about *"Could not extract SPKG.txt."* or better *"Package $PKG_NAME appears to have no SPKG.txt."*?

Redirecting `stderr` **of the `tar` commands** to `/dev/null` is a bit odd there. On the other hand, the presence of `$PKG_SRC` (the spkg file) itself is checked **twice** a few lines above, so a non-zero exit code of `tar` most probably means either a corrupted tarball or the file to extract wasn't found. Maybe the proper way would be to first try to list the file (`tar tf - ... 2>/dev/null`) into some shell variable and check if it is empty (or, better, list the tarball's whole contents grepping for `$PKG_NAME/SPKG.txt`), and use `bunzip2 -t ...` to test whether the spkg is compressed in advance.

Or verify the spkg **wasn't** corrupted in case of an error (`$? -ne 0`):

```sh
    ...
    if [ $? -ne 0 ]; then
        # Extracting SPKG.txt failed for *some* reason,
        # now check if it's simply missing:
        if (bunzip2 -c "$PKG_SRC" | tar tf -) &>/dev/null ||
           tar tf "$PKG_SRC" &>/dev/null
        then
            echo "Package $PKG_NAME lacks a description (SPKG.txt file)."
            exit 1
        else
            echo "$PKG_SRC seems to be corrupted. Exiting."
            exit 1 # or some other error code
        fi
    fi
    exit 0
fi
```

But IMHO a rather minor issue.



 
> > (We could e.g. pipe the `tar` output to some sort of `sed -e '/== Changelog ==/,$d'` and perhaps give some message indicating it was omitted.

> 
> That's pretty hackish in my opinion. It would impose an undocumented constraint on the format of SPKG.txt, which does not have any formatting validation otherwise. I'm not sure that truncating SPKG.txt is even desirable.


`SPKG.txt` files are supposed to have a quite clear structure, with ReST (section) mark-up (which an spkg reviewer should check btw). If there's no line matching `== Changelog ==` -- or preferably a more generic, i.e. robust pattern, nothing would get omitted.

But as I said, I have no opinion on truncating them there.



---

archive/issue_comments_148321.json:
```json
{
    "body": "<a id='comment:10'></a>\nP.S.: I wonder if we shouldn't also redirect all warning and error messages to `stderr` (`echo >2 \"...\"`). We just recently started doing so in a couple of other scripts, so it's not yet consistent within Sage, but an ongoing change.",
    "created_at": "2011-06-19T09:31:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148321",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:10'></a>
P.S.: I wonder if we shouldn't also redirect all warning and error messages to `stderr` (`echo >2 "..."`). We just recently started doing so in a couple of other scripts, so it's not yet consistent within Sage, but an ongoing change.



---

archive/issue_comments_148322.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [leif](#comment%3A10):\n> I wonder if we shouldn't also redirect all warning and error messages to `stderr` (`echo >2 \"...\"`).\n\n\n`echo >&2 \"...\"` of course.",
    "created_at": "2011-06-19T09:38:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148322",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:11'></a>
Replying to [leif](#comment%3A10):
> I wonder if we shouldn't also redirect all warning and error messages to `stderr` (`echo >2 "..."`).


`echo >&2 "..."` of course.



---

archive/issue_comments_148323.json:
```json
{
    "body": "<a id='comment:12'></a>\nReplying to [leif](#comment%3A9):\n> What about *\"Could not extract SPKG.txt.\"* or better *\"Package $PKG_NAME appears to have no SPKG.txt.\"*?\n\n\nI have decided to follow the original phrasing: *\"No file SPKG.txt in package $PKG_NAME\"*.\n\n> Or verify the spkg **wasn't** corrupted in case of an error (`$? -ne 0`):\n\n<SNIP>\n> But IMHO a rather minor issue.\n\n\nI didn't touch it for this patch update; I'll have to think about it later. :-)\n\n> `SPKG.txt` files are supposed to have a quite clear structure, with ReST (section) mark-up (which an spkg reviewer should check btw). If there's no line matching `== Changelog ==` -- or preferably a more generic, i.e. robust pattern, nothing would get omitted.\n> \n> But as I said, I have no opinion on truncating them there.\n\n\nAlso didn't change anything here. I didn't know that SPKG.txt is supposed to be structured; honestly I've never even read one. O_o\n\nReplying to [leif](#comment%3A10):\n> P.S.: I wonder if we shouldn't also redirect all warning and error messages to `stderr` (`echo >2 \"...\"`). We just recently started doing so in a couple of other scripts, so it's not yet consistent within Sage, but an ongoing change.\n\n\nI have changed a number of these. I wasn't sure on a few cases; please check them.\n\nI also replaced a few instances of `echo \"*************\"` with a common function call (`print_separator`). I'm not sure whether this was a good idea. Please criticize!",
    "created_at": "2011-06-20T05:42:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148323",
    "user": "https://trac.sagemath.org/admin/accounts/users/ltw"
}
```

<a id='comment:12'></a>
Replying to [leif](#comment%3A9):
> What about *"Could not extract SPKG.txt."* or better *"Package $PKG_NAME appears to have no SPKG.txt."*?


I have decided to follow the original phrasing: *"No file SPKG.txt in package $PKG_NAME"*.

> Or verify the spkg **wasn't** corrupted in case of an error (`$? -ne 0`):

<SNIP>
> But IMHO a rather minor issue.


I didn't touch it for this patch update; I'll have to think about it later. :-)

> `SPKG.txt` files are supposed to have a quite clear structure, with ReST (section) mark-up (which an spkg reviewer should check btw). If there's no line matching `== Changelog ==` -- or preferably a more generic, i.e. robust pattern, nothing would get omitted.
> 
> But as I said, I have no opinion on truncating them there.


Also didn't change anything here. I didn't know that SPKG.txt is supposed to be structured; honestly I've never even read one. O_o

Replying to [leif](#comment%3A10):
> P.S.: I wonder if we shouldn't also redirect all warning and error messages to `stderr` (`echo >2 "..."`). We just recently started doing so in a couple of other scripts, so it's not yet consistent within Sage, but an ongoing change.


I have changed a number of these. I wasn't sure on a few cases; please check them.

I also replaced a few instances of `echo "*************"` with a common function call (`print_separator`). I'm not sure whether this was a good idea. Please criticize!



---

archive/issue_comments_148324.json:
```json
{
    "body": "**Changing keywords** from \"\" to \"SPKG.txt SAGE.txt -info\".",
    "created_at": "2011-06-28T16:30:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148324",
    "user": "https://github.com/nexttime"
}
```

**Changing keywords** from "" to "SPKG.txt SAGE.txt -info".



---

archive/issue_comments_148325.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2011-07-06T21:44:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148325",
    "user": "https://github.com/nexttime"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_148326.json:
```json
{
    "body": "<a id='comment:14'></a>\nHmmm, for Sage 4.7.1.alpha4, we'll have to rebase the patch:\n\n```\napplying /home/leif/Sage/patches/trac_11021-sage-spkg-cleanup-v2.patch\npatching file sage-spkg\nHunk #3 succeeded at 59 (offset 4 lines).\nHunk #4 succeeded at 93 (offset 4 lines).\nHunk #5 succeeded at 139 (offset 4 lines).\nHunk #6 succeeded at 164 (offset 4 lines).\nHunk #7 succeeded at 183 (offset 4 lines).\nHunk #8 succeeded at 191 (offset 4 lines).\nHunk #9 succeeded at 226 (offset 4 lines).\nHunk #10 succeeded at 250 (offset 4 lines).\nHunk #11 succeeded at 273 (offset 4 lines).\nHunk #12 succeeded at 292 (offset 4 lines).\nHunk #13 FAILED at 304\nHunk #14 succeeded at 402 (offset 4 lines).\nHunk #15 succeeded at 413 (offset 4 lines).\nHunk #16 succeeded at 439 (offset 4 lines).\n1 out of 16 hunks FAILED -- saving rejects to file sage-spkg.rej\nabort: patch failed to apply\n```\n\nSorry for the delay btw, been busy with other things.\n\nThough there are still some things that could be improved (e.g. still two instances of `build` rather than `$BUILD` IIRC), and I would have put the `>&2` right after `echo` to be more obvious, I'm ok with your changes.\n\nI.e., I'll rebase the patch as is, test it, and if *you're* ok with *my* previous changes, we'd have a positive review.\n\n(Other things like supporting `SAGE_CHECK=ignore` and what else we've mentioned on this ticket can be implemented on follow-ups, we just have to get this ticket merged first... :) )",
    "created_at": "2011-07-06T21:44:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148326",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:14'></a>
Hmmm, for Sage 4.7.1.alpha4, we'll have to rebase the patch:

```
applying /home/leif/Sage/patches/trac_11021-sage-spkg-cleanup-v2.patch
patching file sage-spkg
Hunk #3 succeeded at 59 (offset 4 lines).
Hunk #4 succeeded at 93 (offset 4 lines).
Hunk #5 succeeded at 139 (offset 4 lines).
Hunk #6 succeeded at 164 (offset 4 lines).
Hunk #7 succeeded at 183 (offset 4 lines).
Hunk #8 succeeded at 191 (offset 4 lines).
Hunk #9 succeeded at 226 (offset 4 lines).
Hunk #10 succeeded at 250 (offset 4 lines).
Hunk #11 succeeded at 273 (offset 4 lines).
Hunk #12 succeeded at 292 (offset 4 lines).
Hunk #13 FAILED at 304
Hunk #14 succeeded at 402 (offset 4 lines).
Hunk #15 succeeded at 413 (offset 4 lines).
Hunk #16 succeeded at 439 (offset 4 lines).
1 out of 16 hunks FAILED -- saving rejects to file sage-spkg.rej
abort: patch failed to apply
```

Sorry for the delay btw, been busy with other things.

Though there are still some things that could be improved (e.g. still two instances of `build` rather than `$BUILD` IIRC), and I would have put the `>&2` right after `echo` to be more obvious, I'm ok with your changes.

I.e., I'll rebase the patch as is, test it, and if *you're* ok with *my* previous changes, we'd have a positive review.

(Other things like supporting `SAGE_CHECK=ignore` and what else we've mentioned on this ticket can be implemented on follow-ups, we just have to get this ticket merged first... :) )



---

archive/issue_comments_148327.json:
```json
{
    "body": "**Work_Issues:** Rebase to 4.7.1.alpha4",
    "created_at": "2011-07-06T21:44:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148327",
    "user": "https://github.com/nexttime"
}
```

**Work_Issues:** Rebase to 4.7.1.alpha4



---

archive/attachments_014470.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_11021-sage-spkg-cleanup-v2-rebased_to_4.7.1.alpha4.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket11021/trac_11021-sage-spkg-cleanup-v2-rebased_to_4.7.1.alpha4.patch",
    "created_at": "2011-07-06T22:40:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/nexttime"
}
```



---

archive/issue_comments_148328.json:
```json
{
    "body": "SCRIPTS repo. Version 2 simply rebased to Sage 4.7.1.alpha4.",
    "created_at": "2011-07-06T22:40:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148328",
    "user": "https://github.com/nexttime"
}
```

SCRIPTS repo. Version 2 simply rebased to Sage 4.7.1.alpha4.



---

archive/issue_comments_148329.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,4 +1,3 @@\n-One of the patches at #9960 did a lot of clean-up to the file sage-spkg: quoting environment variables, replacing tabs with spaces, etc.  Since those changes were not related to the issue at #9960, I've split them off and put them here instead.  The main change of any content is to look at the file SPKG.txt rather than SAGE.txt when the \"-info\" flag is passed so sage-spkg.\n+One of the patches at #9960 did a lot of clean-up to the file `sage-spkg`: quoting environment variables, replacing tabs with spaces, etc., also adding comments and TODOs.  Since those changes were not related to the issue at #9960, I've split them off and put them here instead.  The main change of any content is to look at the file `SPKG.txt` rather than `SAGE.txt` when the \"`-info`\" flag is passed so `sage-spkg` (through `sage -info ...`). Also, warnings and error messages are now redirected to `stderr`.\n \n-Apply:\n-1. [attachment:trac_11021-sage-spkg-cleanup-v2.patch] to scripts repo\n+Apply **only** [attachment:trac_11021-sage-spkg-cleanup-v2-rebased_to_4.7.1.alpha4.patch] to the **scripts repo**.\n``````\n",
    "created_at": "2011-07-06T22:52:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148329",
    "user": "https://github.com/nexttime"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,4 +1,3 @@
-One of the patches at #9960 did a lot of clean-up to the file sage-spkg: quoting environment variables, replacing tabs with spaces, etc.  Since those changes were not related to the issue at #9960, I've split them off and put them here instead.  The main change of any content is to look at the file SPKG.txt rather than SAGE.txt when the "-info" flag is passed so sage-spkg.
+One of the patches at #9960 did a lot of clean-up to the file `sage-spkg`: quoting environment variables, replacing tabs with spaces, etc., also adding comments and TODOs.  Since those changes were not related to the issue at #9960, I've split them off and put them here instead.  The main change of any content is to look at the file `SPKG.txt` rather than `SAGE.txt` when the "`-info`" flag is passed so `sage-spkg` (through `sage -info ...`). Also, warnings and error messages are now redirected to `stderr`.
 
-Apply:
-1. [attachment:trac_11021-sage-spkg-cleanup-v2.patch] to scripts repo
+Apply **only** [attachment:trac_11021-sage-spkg-cleanup-v2-rebased_to_4.7.1.alpha4.patch] to the **scripts repo**.
``````




---

archive/issue_comments_148330.json:
```json
{
    "body": "**Changing work_issues** from \"Rebase to 4.7.1.alpha4\" to \"\".",
    "created_at": "2011-07-06T22:52:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148330",
    "user": "https://github.com/nexttime"
}
```

**Changing work_issues** from "Rebase to 4.7.1.alpha4" to "".



---

archive/issue_comments_148331.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [leif](#comment%3A14):\n> I'll rebase the patch as is.\n\n\nDone.",
    "created_at": "2011-07-06T22:52:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148331",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:15'></a>
Replying to [leif](#comment%3A14):
> I'll rebase the patch as is.


Done.



---

archive/issue_comments_148332.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2011-07-06T22:52:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148332",
    "user": "https://github.com/nexttime"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_148333.json:
```json
{
    "body": "SCRIPTS repo. Fix BUILD not being set if sage-env is sourced a second time. Based on Sage 4.7.1.alpha4.",
    "created_at": "2011-07-07T04:23:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148333",
    "user": "https://github.com/nexttime"
}
```

SCRIPTS repo. Fix BUILD not being set if sage-env is sourced a second time. Based on Sage 4.7.1.alpha4.



---

archive/attachments_014471.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_11021-support_and_document_sage_-info_in_sage-sage.scripts.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket11021/trac_11021-support_and_document_sage_-info_in_sage-sage.scripts.patch",
    "created_at": "2011-07-07T04:49:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/nexttime"
}
```



---

archive/issue_comments_148334.json:
```json
{
    "body": "SCRIPTS repo. Implements/supports & documents \"sage -info ...\" in sage-sage; minor fixes. Based on Sage 4.7.1.alpha4.",
    "created_at": "2011-07-07T04:49:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148334",
    "user": "https://github.com/nexttime"
}
```

SCRIPTS repo. Implements/supports & documents "sage -info ..." in sage-sage; minor fixes. Based on Sage 4.7.1.alpha4.



---

archive/issue_comments_148335.json:
```json
{
    "body": "**Changing keywords** from \"SPKG.txt SAGE.txt -info\" to \"SPKG.txt SAGE.txt -info BUILD sage-env sage-sage\".",
    "created_at": "2011-07-07T05:18:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148335",
    "user": "https://github.com/nexttime"
}
```

**Changing keywords** from "SPKG.txt SAGE.txt -info" to "SPKG.txt SAGE.txt -info BUILD sage-env sage-sage".



---

archive/issue_comments_148336.json:
```json
{
    "body": "**Changing author** from \"Leif Leonhardy\" to \"Leif Leonhardy, Kelvin Li\".",
    "created_at": "2011-07-07T05:18:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148336",
    "user": "https://github.com/nexttime"
}
```

**Changing author** from "Leif Leonhardy" to "Leif Leonhardy, Kelvin Li".



---

archive/issue_comments_148337.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,3 +1,12 @@\n One of the patches at #9960 did a lot of clean-up to the file `sage-spkg`: quoting environment variables, replacing tabs with spaces, etc., also adding comments and TODOs.  Since those changes were not related to the issue at #9960, I've split them off and put them here instead.  The main change of any content is to look at the file `SPKG.txt` rather than `SAGE.txt` when the \"`-info`\" flag is passed so `sage-spkg` (through `sage -info ...`). Also, warnings and error messages are now redirected to `stderr`.\n \n-Apply **only** [attachment:trac_11021-sage-spkg-cleanup-v2-rebased_to_4.7.1.alpha4.patch] to the **scripts repo**.\n+Apparently support for `sage -info ...` was removed at some point (or never existed); the patch to `sage-sage` fixes that.\n+\n+The patch to `sage-env` fixes a bug caused or enabled by #10469, which through the patch to `sage-spkg` now becomes more visible and potentially worse.\n+\n+Apply\n+1. [attachment:trac_11021-sage-spkg-cleanup-v2-rebased_to_4.7.1.alpha4.patch]\n+2. [attachment:trac_11021-support_and_document_sage_-info_in_sage-sage.scripts.patch]\n+3. [attachment:trac_11021-export_BUILD_in_sage-env.scripts.patch]\n+to the **scripts repo**.\n+\n``````\n",
    "created_at": "2011-07-07T05:18:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148337",
    "user": "https://github.com/nexttime"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,3 +1,12 @@
 One of the patches at #9960 did a lot of clean-up to the file `sage-spkg`: quoting environment variables, replacing tabs with spaces, etc., also adding comments and TODOs.  Since those changes were not related to the issue at #9960, I've split them off and put them here instead.  The main change of any content is to look at the file `SPKG.txt` rather than `SAGE.txt` when the "`-info`" flag is passed so `sage-spkg` (through `sage -info ...`). Also, warnings and error messages are now redirected to `stderr`.
 
-Apply **only** [attachment:trac_11021-sage-spkg-cleanup-v2-rebased_to_4.7.1.alpha4.patch] to the **scripts repo**.
+Apparently support for `sage -info ...` was removed at some point (or never existed); the patch to `sage-sage` fixes that.
+
+The patch to `sage-env` fixes a bug caused or enabled by #10469, which through the patch to `sage-spkg` now becomes more visible and potentially worse.
+
+Apply
+1. [attachment:trac_11021-sage-spkg-cleanup-v2-rebased_to_4.7.1.alpha4.patch]
+2. [attachment:trac_11021-support_and_document_sage_-info_in_sage-sage.scripts.patch]
+3. [attachment:trac_11021-export_BUILD_in_sage-env.scripts.patch]
+to the **scripts repo**.
+
``````




---

archive/issue_comments_148338.json:
```json
{
    "body": "**Changing reviewer** from \"Kelvin Li\" to \"Kelvin Li, Leif Leonhardy\".",
    "created_at": "2011-07-07T05:18:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148338",
    "user": "https://github.com/nexttime"
}
```

**Changing reviewer** from "Kelvin Li" to "Kelvin Li, Leif Leonhardy".



---

archive/issue_comments_148339.json:
```json
{
    "body": "<a id='comment:16'></a>\nThe other two patches I've attached fix issues that came up while testing the patch to `sage-spkg` with Sage 4.7.1.alpha4.\n\nThey're both necessary to make `sage -info ...` as well as `sage-spkg` in general (with the changes made by the other patch) work.\n\nCf. http://trac.sagemath.org/sage_trac/ticket/10469#comment:24.\n\nPlease review!",
    "created_at": "2011-07-07T05:18:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148339",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:16'></a>
The other two patches I've attached fix issues that came up while testing the patch to `sage-spkg` with Sage 4.7.1.alpha4.

They're both necessary to make `sage -info ...` as well as `sage-spkg` in general (with the changes made by the other patch) work.

Cf. http://trac.sagemath.org/sage_trac/ticket/10469#comment:24.

Please review!



---

archive/issue_comments_148340.json:
```json
{
    "body": "**Changing keywords** from \"SPKG.txt SAGE.txt -info BUILD sage-env sage-sage\" to \"SPKG.txt SAGE.txt -info BUILD sage-env sage-sage sage-spkg\".",
    "created_at": "2011-07-07T05:26:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148340",
    "user": "https://github.com/nexttime"
}
```

**Changing keywords** from "SPKG.txt SAGE.txt -info BUILD sage-env sage-sage" to "SPKG.txt SAGE.txt -info BUILD sage-env sage-sage sage-spkg".



---

archive/issue_events_034100.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "rename": {
        "from": "clean up sage-spkg",
        "to": "Fix \"sage -info\" and a bug when sourcing sage-env more than once"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11021#event-34100"
}
```



---

archive/issue_comments_148341.json:
```json
{
    "body": "<a id='comment:18'></a>\nI've made some more changes to `sage-spkg` (more than I intended):\n\n* Fixed some bugs, e.g. not recording the version of a package found in `spkg/{standard,optional}` such that the installation later failed; superfluous second download now doesn't take place.\n* All instances of `build` now use `$BUILD`. (It is now also checked that `BUILD` is really set, cf. patch to `sage-env`.)\n* More error checks and more appropriate error messages.\n* Non-conforming spkgs are no longer said to be corrupted.\n* Default installation scripts now use `$MAKE` rather than `make` (`$MAKE -j1` for installation).\n* `spkg-check` is now `time`d, too.\n* Trying to install an already installed spkg now suggests using `-f`.\n* Some restructuring and simplification, removed useless code.\n* Lots of comments (including TODOs) added, some cosmetic changes.\n\nHarder to review, but please also do. ;-)\n\n(Patch is based on the rebased v2, i.e. should be applied after that.)",
    "created_at": "2011-07-07T13:01:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148341",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:18'></a>
I've made some more changes to `sage-spkg` (more than I intended):

* Fixed some bugs, e.g. not recording the version of a package found in `spkg/{standard,optional}` such that the installation later failed; superfluous second download now doesn't take place.
* All instances of `build` now use `$BUILD`. (It is now also checked that `BUILD` is really set, cf. patch to `sage-env`.)
* More error checks and more appropriate error messages.
* Non-conforming spkgs are no longer said to be corrupted.
* Default installation scripts now use `$MAKE` rather than `make` (`$MAKE -j1` for installation).
* `spkg-check` is now `time`d, too.
* Trying to install an already installed spkg now suggests using `-f`.
* Some restructuring and simplification, removed useless code.
* Lots of comments (including TODOs) added, some cosmetic changes.

Harder to review, but please also do. ;-)

(Patch is based on the rebased v2, i.e. should be applied after that.)



---

archive/issue_comments_148342.json:
```json
{
    "body": "**Assignee:** @nexttime",
    "created_at": "2011-07-07T13:01:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148342",
    "user": "https://github.com/nexttime"
}
```

**Assignee:** @nexttime



---

archive/issue_comments_148343.json:
```json
{
    "body": "SCRIPTS repo. Bug fixes, more error checks, improved messages, restructuring. Apply on top of the rebased v2-patch.",
    "created_at": "2011-07-07T13:04:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148343",
    "user": "https://github.com/nexttime"
}
```

SCRIPTS repo. Bug fixes, more error checks, improved messages, restructuring. Apply on top of the rebased v2-patch.



---

archive/issue_comments_148344.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,4 +1,6 @@\n One of the patches at #9960 did a lot of clean-up to the file `sage-spkg`: quoting environment variables, replacing tabs with spaces, etc., also adding comments and TODOs.  Since those changes were not related to the issue at #9960, I've split them off and put them here instead.  The main change of any content is to look at the file `SPKG.txt` rather than `SAGE.txt` when the \"`-info`\" flag is passed so `sage-spkg` (through `sage -info ...`). Also, warnings and error messages are now redirected to `stderr`.\n+\n+The additional patch to `sage-spkg` is based on the v2 \"clean-up\" patch, fixing some more bugs, adding error checks, improving some messages (see comment below / commit message for some more details).\n \n Apparently support for `sage -info ...` was removed at some point (or never existed); the patch to `sage-sage` fixes that.\n \n@@ -6,7 +8,8 @@\n \n Apply\n 1. [attachment:trac_11021-sage-spkg-cleanup-v2-rebased_to_4.7.1.alpha4.patch]\n-2. [attachment:trac_11021-support_and_document_sage_-info_in_sage-sage.scripts.patch]\n-3. [attachment:trac_11021-export_BUILD_in_sage-env.scripts.patch]\n+2. [attachment:trac_11021-additional_changes_to_sage-spkg.scripts.patch] (somewhat optional, can be reviewed separately)\n+3. [attachment:trac_11021-support_and_document_sage_-info_in_sage-sage.scripts.patch]\n+4. [attachment:trac_11021-export_BUILD_in_sage-env.scripts.patch]\n to the **scripts repo**.\n \n``````\n",
    "created_at": "2011-07-07T13:13:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148344",
    "user": "https://github.com/nexttime"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,4 +1,6 @@
 One of the patches at #9960 did a lot of clean-up to the file `sage-spkg`: quoting environment variables, replacing tabs with spaces, etc., also adding comments and TODOs.  Since those changes were not related to the issue at #9960, I've split them off and put them here instead.  The main change of any content is to look at the file `SPKG.txt` rather than `SAGE.txt` when the "`-info`" flag is passed so `sage-spkg` (through `sage -info ...`). Also, warnings and error messages are now redirected to `stderr`.
+
+The additional patch to `sage-spkg` is based on the v2 "clean-up" patch, fixing some more bugs, adding error checks, improving some messages (see comment below / commit message for some more details).
 
 Apparently support for `sage -info ...` was removed at some point (or never existed); the patch to `sage-sage` fixes that.
 
@@ -6,7 +8,8 @@
 
 Apply
 1. [attachment:trac_11021-sage-spkg-cleanup-v2-rebased_to_4.7.1.alpha4.patch]
-2. [attachment:trac_11021-support_and_document_sage_-info_in_sage-sage.scripts.patch]
-3. [attachment:trac_11021-export_BUILD_in_sage-env.scripts.patch]
+2. [attachment:trac_11021-additional_changes_to_sage-spkg.scripts.patch] (somewhat optional, can be reviewed separately)
+3. [attachment:trac_11021-support_and_document_sage_-info_in_sage-sage.scripts.patch]
+4. [attachment:trac_11021-export_BUILD_in_sage-env.scripts.patch]
 to the **scripts repo**.
 
``````




---

archive/attachments_014472.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_11021-additional_changes_to_sage-spkg.scripts.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket11021/trac_11021-additional_changes_to_sage-spkg.scripts.patch",
    "created_at": "2011-07-07T13:13:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/nexttime"
}
```



---

archive/issue_comments_148345.json:
```json
{
    "body": "<a id='comment:19'></a>\nNew patch is up now.",
    "created_at": "2011-07-07T13:13:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148345",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:19'></a>
New patch is up now.



---

archive/issue_comments_148346.json:
```json
{
    "body": "<a id='comment:20'></a>\nI've added another, necessary patch *to the Sage library*, since otherwise e.g. `sage -b` would break (just because to detect if an optional spkg was installed the function finally called used `sage -f` instead of `sage -i`).\n\nP.S.: The fully qualified name of the function is of course<sup>TM</sup> `sage.misc.package.install_package()`.",
    "created_at": "2011-07-08T11:17:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148346",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:20'></a>
I've added another, necessary patch *to the Sage library*, since otherwise e.g. `sage -b` would break (just because to detect if an optional spkg was installed the function finally called used `sage -f` instead of `sage -i`).

P.S.: The fully qualified name of the function is of course<sup>TM</sup> `sage.misc.package.install_package()`.



---

archive/issue_comments_148347.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -13,3 +13,7 @@\n 4. [attachment:trac_11021-export_BUILD_in_sage-env.scripts.patch]\n to the **scripts repo**.\n \n+Apply\n+1. [attachment:trac_11021-fix_sage.misc.install_package.sagelib.patch]\n+to the **Sage library**.\n+\n``````\n",
    "created_at": "2011-07-08T11:17:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148347",
    "user": "https://github.com/nexttime"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -13,3 +13,7 @@
 4. [attachment:trac_11021-export_BUILD_in_sage-env.scripts.patch]
 to the **scripts repo**.
 
+Apply
+1. [attachment:trac_11021-fix_sage.misc.install_package.sagelib.patch]
+to the **Sage library**.
+
``````




---

archive/issue_comments_148348.json:
```json
{
    "body": "<a id='comment:22'></a>\nI'm happy with the patch to the Sage library.  I'm attaching a referee patch for that one, adding a doctest and fixing the part marked \"FIXME\".  I will try to look at the many patches to the scripts repo, but it may take me a while.",
    "created_at": "2011-07-12T22:19:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148348",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:22'></a>
I'm happy with the patch to the Sage library.  I'm attaching a referee patch for that one, adding a doctest and fixing the part marked "FIXME".  I will try to look at the many patches to the scripts repo, but it may take me a while.



---

archive/issue_comments_148349.json:
```json
{
    "body": "**Changing reviewer** from \"Kelvin Li, Leif Leonhardy\" to \"Kelvin Li, Leif Leonhardy, John Palmieri\".",
    "created_at": "2011-07-12T22:19:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148349",
    "user": "https://github.com/jhpalmieri"
}
```

**Changing reviewer** from "Kelvin Li, Leif Leonhardy" to "Kelvin Li, Leif Leonhardy, John Palmieri".



---

archive/issue_comments_148350.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -15,5 +15,6 @@\n \n Apply\n 1. [attachment:trac_11021-fix_sage.misc.install_package.sagelib.patch]\n+2. [attachment:trac_11021-sage-library-referee.patch]\n to the **Sage library**.\n \n``````\n",
    "created_at": "2011-07-12T22:22:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148350",
    "user": "https://github.com/jhpalmieri"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -15,5 +15,6 @@
 
 Apply
 1. [attachment:trac_11021-fix_sage.misc.install_package.sagelib.patch]
+2. [attachment:trac_11021-sage-library-referee.patch]
 to the **Sage library**.
 
``````




---

archive/issue_comments_148351.json:
```json
{
    "body": "<a id='comment:24'></a>\nI'm utterly tired of the message \"Warning: Attempted to overwrite SAGE_ROOT environment variable\".  Can we apply this patch to `sage-env`:\n\n```diff\ndiff --git a/sage-env b/sage-env\n--- a/sage-env\n+++ b/sage-env\n@@ -50,7 +50,7 @@ if [ \"$SAGE_ROOT\" = \"\" ]; then\n else\n     if [ -f \"$SAGE_ROOT\"/sage -a -d \"$SAGE_ROOT\"/spkg ]; then\n         # SAGE_ROOT points to a sage installation as expected\n-        if [ \"$SAGE_ROOT\" != \"$GUESSED_SAGE_ROOT\" ]; then\n+        if [ -n \"$GUESSED_SAGE_ROOT\" -a \"$SAGE_ROOT\" != \"$GUESSED_SAGE_ROOT\" ]; then\n             echo \"Warning: Attempted to overwrite SAGE_ROOT environment variable\"\n         fi\n     else\n```\nThat will eliminate some of its occurrences.\n\nMeanwhile, I'm happy with [attachment:trac_11021-support_and_document_sage_-info_in_sage-sage.scripts.patch] and [attachment:trac_11021-export_BUILD_in_sage-env.scripts.patch].  [attachment:trac_11021-sage-spkg-cleanup-v2-rebased_to_4.7.1.alpha4.patch] also looks good, and anyway I think it's just a rebased version of a patch which already had a positive review.  This leaves [attachment:trac_11021-additional_changes_to_sage-spkg.scripts.patch].  I'll try to work on that, and anyone else who wants to is welcome.",
    "created_at": "2011-07-12T22:44:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148351",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:24'></a>
I'm utterly tired of the message "Warning: Attempted to overwrite SAGE_ROOT environment variable".  Can we apply this patch to `sage-env`:

```diff
diff --git a/sage-env b/sage-env
--- a/sage-env
+++ b/sage-env
@@ -50,7 +50,7 @@ if [ "$SAGE_ROOT" = "" ]; then
 else
     if [ -f "$SAGE_ROOT"/sage -a -d "$SAGE_ROOT"/spkg ]; then
         # SAGE_ROOT points to a sage installation as expected
-        if [ "$SAGE_ROOT" != "$GUESSED_SAGE_ROOT" ]; then
+        if [ -n "$GUESSED_SAGE_ROOT" -a "$SAGE_ROOT" != "$GUESSED_SAGE_ROOT" ]; then
             echo "Warning: Attempted to overwrite SAGE_ROOT environment variable"
         fi
     else
```
That will eliminate some of its occurrences.

Meanwhile, I'm happy with [attachment:trac_11021-support_and_document_sage_-info_in_sage-sage.scripts.patch] and [attachment:trac_11021-export_BUILD_in_sage-env.scripts.patch].  [attachment:trac_11021-sage-spkg-cleanup-v2-rebased_to_4.7.1.alpha4.patch] also looks good, and anyway I think it's just a rebased version of a patch which already had a positive review.  This leaves [attachment:trac_11021-additional_changes_to_sage-spkg.scripts.patch].  I'll try to work on that, and anyone else who wants to is welcome.



---

archive/issue_comments_148352.json:
```json
{
    "body": "<a id='comment:25'></a>\nActually, a few minor comments about [attachment: trac_11021-support_and_document_sage_-info_in_sage-sage.scripts.patch  and trac_11021-export_BUILD_in_sage-env.scripts.patch . trac_11021-sage-spkg-cleanup]:\n\n- The file.spkg argument should be documented in the `-advanced` option.  Easy to fix, but I'll leave it to you in hopes that you'll fix the next problem as well.\n- If you run \"sage -info zlib sqlite\", it says \"Listing SPKG.txt of zlib sqlite\", which looks a little funny to me.  This is not a big deal, but if you could fix it, that would be nice.",
    "created_at": "2011-07-12T22:49:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148352",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:25'></a>
Actually, a few minor comments about [attachment: trac_11021-support_and_document_sage_-info_in_sage-sage.scripts.patch  and trac_11021-export_BUILD_in_sage-env.scripts.patch . trac_11021-sage-spkg-cleanup]:

- The file.spkg argument should be documented in the `-advanced` option.  Easy to fix, but I'll leave it to you in hopes that you'll fix the next problem as well.
- If you run "sage -info zlib sqlite", it says "Listing SPKG.txt of zlib sqlite", which looks a little funny to me.  This is not a big deal, but if you could fix it, that would be nice.



---

archive/issue_comments_148353.json:
```json
{
    "body": "<a id='comment:26'></a>\nOh, and also, \"sage --info ...\" should work...",
    "created_at": "2011-07-12T22:51:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148353",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:26'></a>
Oh, and also, "sage --info ..." should work...



---

archive/issue_comments_148354.json:
```json
{
    "body": "<a id='comment:27'></a>\nOy.  The [few minor comments](http://trac.sagemath.org/sage_trac/ticket/11021#comment:25) are about the patch to sage-sage, in case that wasn't clear.  Sorry about the mess in that comment.",
    "created_at": "2011-07-12T22:52:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148354",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:27'></a>
Oy.  The [few minor comments](http://trac.sagemath.org/sage_trac/ticket/11021#comment:25) are about the patch to sage-sage, in case that wasn't clear.  Sorry about the mess in that comment.



---

archive/issue_comments_148355.json:
```json
{
    "body": "<a id='comment:28'></a>\nReplying to [jhpalmieri](#comment%3A22):\n> I'm happy with the patch to the Sage library.  I'm attaching a referee patch for that one, adding a doctest and fixing the part marked \"FIXME\".\n\n\nLooks good to me, except that I'm not sure whether the (first) doctest passes on all systems. Ok, thinking more about it, there'll be a *fake* `spkg/installed/atlas-*` on systems where ATLAS doesn't get built/installed, right?\n\nThanks for reviewing this.",
    "created_at": "2011-07-12T23:15:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148355",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:28'></a>
Replying to [jhpalmieri](#comment%3A22):
> I'm happy with the patch to the Sage library.  I'm attaching a referee patch for that one, adding a doctest and fixing the part marked "FIXME".


Looks good to me, except that I'm not sure whether the (first) doctest passes on all systems. Ok, thinking more about it, there'll be a *fake* `spkg/installed/atlas-*` on systems where ATLAS doesn't get built/installed, right?

Thanks for reviewing this.



---

archive/issue_comments_148356.json:
```json
{
    "body": "<a id='comment:29'></a>\nReplying to [jhpalmieri](#comment%3A24):\n> I'm utterly tired of the message \"Warning: Attempted to overwrite SAGE_ROOT environment variable\".  Can we apply this patch to `sage-env` [...]\n\n\n**Yes, yes, yes, please! **\n\nI really wonder others (especially \"ordinary\" Sage users) didn't already get totally annoyed by this odd message, at least I'm not aware of any complaints about that. Maybe it's just us...",
    "created_at": "2011-07-12T23:28:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148356",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:29'></a>
Replying to [jhpalmieri](#comment%3A24):
> I'm utterly tired of the message "Warning: Attempted to overwrite SAGE_ROOT environment variable".  Can we apply this patch to `sage-env` [...]


**Yes, yes, yes, please! **

I really wonder others (especially "ordinary" Sage users) didn't already get totally annoyed by this odd message, at least I'm not aware of any complaints about that. Maybe it's just us...



---

archive/issue_comments_148357.json:
```json
{
    "body": "<a id='comment:30'></a>\n> Looks good to me, except that I'm not sure whether the (first) doctest passes on all systems. Ok, thinking more about it, there'll be a fake spkg/installed/atlas-* on systems where ATLAS doesn't get built/installed, right?\n\n\nRight. First, it passed tests on my Mac OS X box, and the atlas spkg doesn't installed anything there. Second, the script sage-spkg writes a file to spkg/installed as long as spkg-install runs successfully, and since the atlas spkg-install always runs (even if it doesn't do anything), there will be a record in spkg/installed.",
    "created_at": "2011-07-12T23:38:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148357",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:30'></a>
> Looks good to me, except that I'm not sure whether the (first) doctest passes on all systems. Ok, thinking more about it, there'll be a fake spkg/installed/atlas-* on systems where ATLAS doesn't get built/installed, right?


Right. First, it passed tests on my Mac OS X box, and the atlas spkg doesn't installed anything there. Second, the script sage-spkg writes a file to spkg/installed as long as spkg-install runs successfully, and since the atlas spkg-install always runs (even if it doesn't do anything), there will be a record in spkg/installed.



---

archive/issue_comments_148358.json:
```json
{
    "body": "<a id='comment:31'></a>\nReplying to [jhpalmieri](#comment%3A25):\n>  - The `file.spkg` argument should be documented in the `-advanced` option.  Easy to fix, but I'll leave it to you in hopes that you'll fix the next problem as well.\n\n\nWell, that's not advanced usage ;-) , but I can add it there, too. (It's btw. not a new feature, I just documented it.)\n\n>  - If you run \"`sage -info zlib sqlite`\", it says \"Listing SPKG.txt of zlib sqlite\", which looks a little funny to me.  This is not a big deal, but if you could fix it, that would be nice.\n\n\nHmmm, that's intentional. Do you want the spkg names to be separated by commas?\n\n> Oh, and also, \"`sage --info ...`\" should work...\n\n\nWe (currently) don't support long options consistently, but I can also add that (i.e., support `--info`, too).",
    "created_at": "2011-07-12T23:48:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148358",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:31'></a>
Replying to [jhpalmieri](#comment%3A25):
>  - The `file.spkg` argument should be documented in the `-advanced` option.  Easy to fix, but I'll leave it to you in hopes that you'll fix the next problem as well.


Well, that's not advanced usage ;-) , but I can add it there, too. (It's btw. not a new feature, I just documented it.)

>  - If you run "`sage -info zlib sqlite`", it says "Listing SPKG.txt of zlib sqlite", which looks a little funny to me.  This is not a big deal, but if you could fix it, that would be nice.


Hmmm, that's intentional. Do you want the spkg names to be separated by commas?

> Oh, and also, "`sage --info ...`" should work...


We (currently) don't support long options consistently, but I can also add that (i.e., support `--info`, too).



---

archive/issue_comments_148359.json:
```json
{
    "body": "<a id='comment:32'></a>\nReplying to [jhpalmieri](#comment%3A30):\n> > Looks good to me, except that I'm not sure whether the (first) doctest passes on all systems. Ok, thinking more about it, there'll be a fake spkg/installed/atlas-* on systems where ATLAS doesn't get built/installed, right?\n\n> \n> Right. First, it passed tests on my Mac OS X box, and the atlas spkg doesn't installed anything there. Second, the script sage-spkg writes a file to spkg/installed as long as spkg-install runs successfully, and since the atlas spkg-install always runs (even if it doesn't do anything), there will be a record in spkg/installed.\n\n\nOk, hopefully this also works with `SAGE_CHECK=yes`... (since if the test suite -- does ATLAS have one, i.e. `spkg-check`, at all? -- fails, the file in `.../installed/` gets deleted).",
    "created_at": "2011-07-12T23:54:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148359",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:32'></a>
Replying to [jhpalmieri](#comment%3A30):
> > Looks good to me, except that I'm not sure whether the (first) doctest passes on all systems. Ok, thinking more about it, there'll be a fake spkg/installed/atlas-* on systems where ATLAS doesn't get built/installed, right?

> 
> Right. First, it passed tests on my Mac OS X box, and the atlas spkg doesn't installed anything there. Second, the script sage-spkg writes a file to spkg/installed as long as spkg-install runs successfully, and since the atlas spkg-install always runs (even if it doesn't do anything), there will be a record in spkg/installed.


Ok, hopefully this also works with `SAGE_CHECK=yes`... (since if the test suite -- does ATLAS have one, i.e. `spkg-check`, at all? -- fails, the file in `.../installed/` gets deleted).



---

archive/issue_comments_148360.json:
```json
{
    "body": "<a id='comment:33'></a>\nA few issues with [attachment:trac_11021-additional_changes_to_sage-spkg.scripts.patch] -- line numbers refer to the file sage-spkg (as listed in the patch):\n\n- line 59, `error >&2 \"Error: Environment variable 'BUILD' not set!\"`: \"error\" should be \"echo\"\n- lines 175-176: the code `(bunzip2 -c \"$PKG_SRC\" | tar tf -)` seems to have a zero return value if $PKG_SRC is not a valid bzip2 file.  I'm trying to reach the error message `echo >&2 \"Error: '$PKG_SRC' seems to be corrupted. Exiting.\"`, but I can't.  This is on Mac OS X; on linux, the above code has return value \"2\".  Running \"bunzip2 -c blah\" on an invalid bzip2 file returns a value of 2 on Mac OS X.",
    "created_at": "2011-07-13T00:12:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148360",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:33'></a>
A few issues with [attachment:trac_11021-additional_changes_to_sage-spkg.scripts.patch] -- line numbers refer to the file sage-spkg (as listed in the patch):

- line 59, `error >&2 "Error: Environment variable 'BUILD' not set!"`: "error" should be "echo"
- lines 175-176: the code `(bunzip2 -c "$PKG_SRC" | tar tf -)` seems to have a zero return value if $PKG_SRC is not a valid bzip2 file.  I'm trying to reach the error message `echo >&2 "Error: '$PKG_SRC' seems to be corrupted. Exiting."`, but I can't.  This is on Mac OS X; on linux, the above code has return value "2".  Running "bunzip2 -c blah" on an invalid bzip2 file returns a value of 2 on Mac OS X.



---

archive/issue_comments_148361.json:
```json
{
    "body": "<a id='comment:34'></a>\nThe relevant part of the spkg-check file for atlas says:\n\n```\nif [ `uname` = \"Darwin\" ]; then\n    exit 0\nfi\n```",
    "created_at": "2011-07-13T00:15:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148361",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:34'></a>
The relevant part of the spkg-check file for atlas says:

```
if [ `uname` = "Darwin" ]; then
    exit 0
fi
```



---

archive/issue_comments_148362.json:
```json
{
    "body": "<a id='comment:35'></a>\nReplying to [leif](#comment%3A31):\n> Replying to [jhpalmieri](#comment%3A25):\n> >  - The `file.spkg` argument should be documented in the `-advanced` option.  Easy to fix, but I'll leave it to you in hopes that you'll fix the next problem as well.\n \n> \n> Well, that's not advanced usage ;-) , but I can add it there, too. \n\n\nIt would fit in well after the lines\n\n```\nRunning Sage:\n  file.[sage|py|spyx] -- run given .sage, .py or .spyx files\n```\n\n> (It's btw. not a new feature, I just documented it.)\n\n\nRight.\n\n> >  - If you run \"`sage -info zlib sqlite`\", it says \"Listing SPKG.txt of zlib sqlite\", which looks a little funny to me.  This is not a big deal, but if you could fix it, that would be nice.\n \n> \n> Hmmm, that's intentional. Do you want the spkg names to be separated by commas?\n\n\nIf possible, commas would be nice.  It looks fine with a single argument, but with multiple args, I think some punctuation would help.\n \n> > Oh, and also, \"`sage --info ...`\" should work...\n\n> \n> We (currently) don't support long options consistently, but I can also add that (i.e., support `--info`, too).\n\n\nWe say that we do: at the end of \"sage -advanced\", it says\n\n```\nYou can also use -- before a long option, e.g., 'sage --optional'.\n```\nI see that a few options are missing, like `--merge``, but most of them are there.  The script sage-sage is a mess anyway, but cleaning it up belongs on another ticket<sup>TM</sup>.",
    "created_at": "2011-07-13T02:41:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148362",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:35'></a>
Replying to [leif](#comment%3A31):
> Replying to [jhpalmieri](#comment%3A25):
> >  - The `file.spkg` argument should be documented in the `-advanced` option.  Easy to fix, but I'll leave it to you in hopes that you'll fix the next problem as well.
 
> 
> Well, that's not advanced usage ;-) , but I can add it there, too. 


It would fit in well after the lines

```
Running Sage:
  file.[sage|py|spyx] -- run given .sage, .py or .spyx files
```

> (It's btw. not a new feature, I just documented it.)


Right.

> >  - If you run "`sage -info zlib sqlite`", it says "Listing SPKG.txt of zlib sqlite", which looks a little funny to me.  This is not a big deal, but if you could fix it, that would be nice.
 
> 
> Hmmm, that's intentional. Do you want the spkg names to be separated by commas?


If possible, commas would be nice.  It looks fine with a single argument, but with multiple args, I think some punctuation would help.
 
> > Oh, and also, "`sage --info ...`" should work...

> 
> We (currently) don't support long options consistently, but I can also add that (i.e., support `--info`, too).


We say that we do: at the end of "sage -advanced", it says

```
You can also use -- before a long option, e.g., 'sage --optional'.
```
I see that a few options are missing, like `--merge``, but most of them are there.  The script sage-sage is a mess anyway, but cleaning it up belongs on another ticket<sup>TM</sup>.



---

archive/issue_comments_148363.json:
```json
{
    "body": "<a id='comment:36'></a>\n[Hours later: Sorry, apparently my router is just about to die -- massive packet losses... :( Now via wireless LAN...]\n\nReplying to [jhpalmieri](#comment%3A33):\n>  - line 59, `error >&2 \"Error: Environment variable 'BUILD' not set!\"`: \"error\" should be \"echo\"\n\n\nOoops, kind of inconvenient, though it should raise an error as is... ;-)\n\n\n\n\n> - lines 175-176: the code `(bunzip2 -c \"$PKG_SRC\" | tar tf -)` seems to have a zero return value if `$PKG_SRC` is not a valid bzip2 file.  I'm trying to reach the error message `echo >&2 \"Error: '$PKG_SRC' seems to be corrupted. Exiting.\"`, but I can't.  This is on Mac OS X; on linux, the above code has return value \"2\".  Running \"bunzip2 -c blah\" on an invalid bzip2 file returns a value of 2 on Mac OS X.\n\n\nMacOS... What does `cat /dev/null | tar tf -` give?\n\n\n\n\n> The relevant part of the spkg-check file for atlas says [...]\n\n\nI haven't looked at the *current* ATLAS spkg; don't know if it also works on Cygwin, e.g. if `SAGE_ATLAS_LIB` is set there (in which case any tests are skipped as well).",
    "created_at": "2011-07-13T04:39:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148363",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:36'></a>
[Hours later: Sorry, apparently my router is just about to die -- massive packet losses... :( Now via wireless LAN...]

Replying to [jhpalmieri](#comment%3A33):
>  - line 59, `error >&2 "Error: Environment variable 'BUILD' not set!"`: "error" should be "echo"


Ooops, kind of inconvenient, though it should raise an error as is... ;-)




> - lines 175-176: the code `(bunzip2 -c "$PKG_SRC" | tar tf -)` seems to have a zero return value if `$PKG_SRC` is not a valid bzip2 file.  I'm trying to reach the error message `echo >&2 "Error: '$PKG_SRC' seems to be corrupted. Exiting."`, but I can't.  This is on Mac OS X; on linux, the above code has return value "2".  Running "bunzip2 -c blah" on an invalid bzip2 file returns a value of 2 on Mac OS X.


MacOS... What does `cat /dev/null | tar tf -` give?




> The relevant part of the spkg-check file for atlas says [...]


I haven't looked at the *current* ATLAS spkg; don't know if it also works on Cygwin, e.g. if `SAGE_ATLAS_LIB` is set there (in which case any tests are skipped as well).



---

archive/issue_comments_148364.json:
```json
{
    "body": "<a id='comment:37'></a>\nReplying to [jhpalmieri](#comment%3A35):\n> Replying to [leif](#comment%3A31):\n> > >  - If you run \"`sage -info zlib sqlite`\", it says \"Listing SPKG.txt of zlib sqlite\", which looks a little funny to me.  This is not a big deal, but if you could fix it, that would be nice.\n \n> > \n> > Hmmm, that's intentional. Do you want the spkg names to be separated by commas?\n\n> \n> If possible, commas would be nice.  It looks fine with a single argument, but with multiple args, I think some punctuation would help.\n\n\nWell, `sage -i pkg1 pkg2 ...` behaves the same (\"`Installing pkg1 pkg2 ...`\", and did before), but I can add commas to both -- easily, until we support (or use) spaces in spkg filenames...\n\n\n\n\n> > We (currently) don't support long options consistently, but I can also add that (i.e., support `--info`, too).\n\n> \n> We say that we do: at the end of \"sage -advanced\", it says\n\n\n```\n You can also use -- before a long option, e.g., 'sage --optional'.\n```\n> I see that a few options are missing, like `--merge``, but most of them are there.\n\n\n`sage -t --verbose ...` doesn't work either; only `sage-sage` seems to support (some) long options with double dashs.\n\n> The script sage-sage is a mess anyway, but cleaning it up belongs on another ticket<sup>TM</sup>.\n\n\nAgreed. I'd also *remove* long options with a *single* dash (i.e., only allow `--` there), but others disagreed a while ago.",
    "created_at": "2011-07-13T04:53:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148364",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:37'></a>
Replying to [jhpalmieri](#comment%3A35):
> Replying to [leif](#comment%3A31):
> > >  - If you run "`sage -info zlib sqlite`", it says "Listing SPKG.txt of zlib sqlite", which looks a little funny to me.  This is not a big deal, but if you could fix it, that would be nice.
 
> > 
> > Hmmm, that's intentional. Do you want the spkg names to be separated by commas?

> 
> If possible, commas would be nice.  It looks fine with a single argument, but with multiple args, I think some punctuation would help.


Well, `sage -i pkg1 pkg2 ...` behaves the same ("`Installing pkg1 pkg2 ...`", and did before), but I can add commas to both -- easily, until we support (or use) spaces in spkg filenames...




> > We (currently) don't support long options consistently, but I can also add that (i.e., support `--info`, too).

> 
> We say that we do: at the end of "sage -advanced", it says


```
 You can also use -- before a long option, e.g., 'sage --optional'.
```
> I see that a few options are missing, like `--merge``, but most of them are there.


`sage -t --verbose ...` doesn't work either; only `sage-sage` seems to support (some) long options with double dashs.

> The script sage-sage is a mess anyway, but cleaning it up belongs on another ticket<sup>TM</sup>.


Agreed. I'd also *remove* long options with a *single* dash (i.e., only allow `--` there), but others disagreed a while ago.



---

archive/issue_comments_148365.json:
```json
{
    "body": "<a id='comment:38'></a>\n> MacOS... What does cat /dev/null | tar tf - give?\n\n\n\n```\n$ cat /dev/null | tar tf -\n$ echo $?\n0\n\n$ cat temp.pdf | tar jxf -\ntar: Unrecognized archive format: Inappropriate file type or format\ntar: Error exit delayed from previous errors.\n$ echo $?\n1\n```\nFor the second example, the same thing happens with \"tar xf\" as with \"tar jxf\".  The man page for tar said nothing helpful about return codes.  It seems to be BSD tar, for what that's worth.\n\n> Well, sage -i pkg1 pkg2 ... behaves the same (\"Installing pkg1 pkg2 ...\", and did before), but I can add commas to both -- easily, until we support (or use) spaces in spkg filenames...\n\n\nI don't care that much about it.  If you want to change it, that would be fine, but don't worry about it too much.\n\n> Agreed. I'd also remove long options with a single dash (i.e., only allow -- there), but others disagreed a while ago.\n\n\nI had a plan (at #21) to gradually phase them out, but that ticket has stalled.  There are also some issues with the approach there, and I'm not planning on working on it any time soon.",
    "created_at": "2011-07-13T06:03:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148365",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:38'></a>
> MacOS... What does cat /dev/null | tar tf - give?



```
$ cat /dev/null | tar tf -
$ echo $?
0

$ cat temp.pdf | tar jxf -
tar: Unrecognized archive format: Inappropriate file type or format
tar: Error exit delayed from previous errors.
$ echo $?
1
```
For the second example, the same thing happens with "tar xf" as with "tar jxf".  The man page for tar said nothing helpful about return codes.  It seems to be BSD tar, for what that's worth.

> Well, sage -i pkg1 pkg2 ... behaves the same ("Installing pkg1 pkg2 ...", and did before), but I can add commas to both -- easily, until we support (or use) spaces in spkg filenames...


I don't care that much about it.  If you want to change it, that would be fine, but don't worry about it too much.

> Agreed. I'd also remove long options with a single dash (i.e., only allow -- there), but others disagreed a while ago.


I had a plan (at #21) to gradually phase them out, but that ticket has stalled.  There are also some issues with the approach there, and I'm not planning on working on it any time soon.



---

archive/issue_comments_148366.json:
```json
{
    "body": "<a id='comment:39'></a>\nReplying to [jhpalmieri](#comment%3A38):\n> > MacOS... What does cat /dev/null | tar tf - give?\n  \n> \n\n```sh\n$ cat /dev/null | tar tf -\n$ echo $?\n0\n```\nThat's odd. IIRC we require **GNU** `tar`, which behaves correctly:\n\n```sh\n$ cat /dev/null | tar tf -\ntar: This does not look like a tar archive\ntar: Exiting with failure status due to previous errors\n```\n\nMaybe we can work around in a dumb way (which I'd still prefer over using `pipestatus` *there*) by doing\n\n```sh\n(bunzip2 -c \"$PKG_SRC\" || echo foo) | tar tf -\n```\nwhich should fail in any case if `bunzip2` fails.",
    "created_at": "2011-07-13T07:00:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148366",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:39'></a>
Replying to [jhpalmieri](#comment%3A38):
> > MacOS... What does cat /dev/null | tar tf - give?
  
> 

```sh
$ cat /dev/null | tar tf -
$ echo $?
0
```
That's odd. IIRC we require **GNU** `tar`, which behaves correctly:

```sh
$ cat /dev/null | tar tf -
tar: This does not look like a tar archive
tar: Exiting with failure status due to previous errors
```

Maybe we can work around in a dumb way (which I'd still prefer over using `pipestatus` *there*) by doing

```sh
(bunzip2 -c "$PKG_SRC" || echo foo) | tar tf -
```
which should fail in any case if `bunzip2` fails.



---

archive/issue_comments_148367.json:
```json
{
    "body": "<a id='comment:40'></a>\nReplying to [leif](#comment%3A39):\n> That's odd. IIRC we require **GNU** `tar`, which behaves correctly.\n\n\nAh, the Sage Installation Guide (though usually not a reliable source of contemporary information) states GNU `tar` should be used / installed on Solaris, OpenSolaris, HP-UX and AIX; BSD `tar` is said to be sufficient on MacOS X.",
    "created_at": "2011-07-13T07:21:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148367",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:40'></a>
Replying to [leif](#comment%3A39):
> That's odd. IIRC we require **GNU** `tar`, which behaves correctly.


Ah, the Sage Installation Guide (though usually not a reliable source of contemporary information) states GNU `tar` should be used / installed on Solaris, OpenSolaris, HP-UX and AIX; BSD `tar` is said to be sufficient on MacOS X.



---

archive/issue_comments_148368.json:
```json
{
    "body": "<a id='comment:41'></a>\nReplying to [leif](#comment%3A39):\n>\n\n```sh\n (bunzip2 -c \"$PKG_SRC\" || echo foo) | tar tf -\n```\n> which should fail in any case if `bunzip2` fails.\n\n\nThat seems to work, both from the command line to test the return value and when inserted into sage-spkg in the appropriate place.",
    "created_at": "2011-07-13T15:13:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148368",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:41'></a>
Replying to [leif](#comment%3A39):
>

```sh
 (bunzip2 -c "$PKG_SRC" || echo foo) | tar tf -
```
> which should fail in any case if `bunzip2` fails.


That seems to work, both from the command line to test the return value and when inserted into sage-spkg in the appropriate place.



---

archive/issue_comments_148369.json:
```json
{
    "body": "<a id='comment:42'></a>\nReplying to [leif](#comment%3A29):\n> Replying to [jhpalmieri](#comment%3A24):\n> > I'm utterly tired of the message \"Warning: Attempted to overwrite SAGE_ROOT environment variable\".  Can we apply this patch to `sage-env` [...]\n\n> \n> **Yes, yes, yes, please! **\n> \n> I really wonder others (especially \"ordinary\" Sage users) didn't already get totally annoyed by this odd message, at least I'm not aware of any complaints about that. Maybe it's just us...\n\n\nI think given that when building Sage a user will see thousands of warnings messages, they are not likely to report this. \n\nIt probably bothers John more as he knows it's code written by Sage developers that is generating the warning. But for \"normal\" users (non-developers), there's no reason this warning should stand out in any way.\n\nAs for the tar problem, there is no requirement for tar to even exist on a POSIX system, so it not really possible to say any particular behavior is wrong. \n\nDave",
    "created_at": "2011-07-13T17:34:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148369",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

<a id='comment:42'></a>
Replying to [leif](#comment%3A29):
> Replying to [jhpalmieri](#comment%3A24):
> > I'm utterly tired of the message "Warning: Attempted to overwrite SAGE_ROOT environment variable".  Can we apply this patch to `sage-env` [...]

> 
> **Yes, yes, yes, please! **
> 
> I really wonder others (especially "ordinary" Sage users) didn't already get totally annoyed by this odd message, at least I'm not aware of any complaints about that. Maybe it's just us...


I think given that when building Sage a user will see thousands of warnings messages, they are not likely to report this. 

It probably bothers John more as he knows it's code written by Sage developers that is generating the warning. But for "normal" users (non-developers), there's no reason this warning should stand out in any way.

As for the tar problem, there is no requirement for tar to even exist on a POSIX system, so it not really possible to say any particular behavior is wrong. 

Dave



---

archive/issue_comments_148370.json:
```json
{
    "body": "<a id='comment:43'></a>\nBy the way, the same issue occurs on line 290 of sage-spkg, and the same fix seems to work.  Probably the same on line 323\n\nRe lines 236-243 (and I would guess a similar block in lines 308-314):\n\n```\n        PKG_NAME=`sage-latest-online-package \"$PKG_NAME\"`\n        if [ $? -eq 0 ]; then\n            echo \"Found package '$PKG_NAME'.\"\n            FOUND_VERSION='1'\n        else\n            echo >&2 \"$PKG_NAME\" # That's now an error message.\n            exit 1\n        fi\n```\nIn the \"else\" part of this, `$PKG_NAME` will likely be an empty string, so the echo won't print anything.  The script `sage-latest-online-package` prints a suitable error message so this is not a big deal, but it's kind of odd.\n\n---\n\nRegarding the comments about Atlas and spkg-check, in retrospect, I'm not sure I understand what you're saying.  If spkg-check fails, then it makes sense for atlas not to be installed, in which case you don't have a complete Sage install, in which case I don't mind if a doctest fails.  But as I said, I may be misunderstanding your point.",
    "created_at": "2011-07-14T03:15:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148370",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:43'></a>
By the way, the same issue occurs on line 290 of sage-spkg, and the same fix seems to work.  Probably the same on line 323

Re lines 236-243 (and I would guess a similar block in lines 308-314):

```
        PKG_NAME=`sage-latest-online-package "$PKG_NAME"`
        if [ $? -eq 0 ]; then
            echo "Found package '$PKG_NAME'."
            FOUND_VERSION='1'
        else
            echo >&2 "$PKG_NAME" # That's now an error message.
            exit 1
        fi
```
In the "else" part of this, `$PKG_NAME` will likely be an empty string, so the echo won't print anything.  The script `sage-latest-online-package` prints a suitable error message so this is not a big deal, but it's kind of odd.

---

Regarding the comments about Atlas and spkg-check, in retrospect, I'm not sure I understand what you're saying.  If spkg-check fails, then it makes sense for atlas not to be installed, in which case you don't have a complete Sage install, in which case I don't mind if a doctest fails.  But as I said, I may be misunderstanding your point.



---

archive/issue_comments_148371.json:
```json
{
    "body": "<a id='comment:44'></a>\nA related issue with [attachment:trac_11021-additional_changes_to_sage-spkg.scripts.patch]: on OS X, if I insert \n\n```\n(bunzip2 -c \"$PKG_SRC\" || echo foo) | tar tf -\n```\ninstead of the other code, then valid spkg files are not being extracted: I did this at around line 300, and I also put in \"pwd\" and \"ls -l\" a few lines later, and I got this (this is with a local spkg file, phc-2.3.60.spkg, specified with a full path):\n\n```\nFinished extraction.\n/Applications/sage/spkg/build\ntotal 8\ndrwxr-xr-x  76 palmieri  admin  2584 Jul  4 09:35 bzip2-1.0.5\ndrwxr-xr-x   8 palmieri  admin   272 Jul 12 15:10 chomp-20100213.p2\ndrwxr-xr-x   2 palmieri  admin    68 Jul 12 16:55 old\ndrwxr-xr-x@ 21 palmieri  admin   714 Jul  4 09:35 prereq-0.9\n-rw-r--r--   1 palmieri  admin    19 Mar 24  2010 sagetex-2.2.5.cksum\nWarning: After extraction the directory 'phc-2.3.60' does not exist.\nThis means that the corresponding .spkg needs to be downloaded again.\n```\nBut maybe I didn't insert that code correctly.  I'll try a new patch when you have chance to make one. Or if you want, just make the small changes to the sage-sage patch, and we can defer the more major changes to sage-spkg to another ticket.  We should try to get the bug fixes in the other patches merged pretty soon, I think.",
    "created_at": "2011-07-15T02:13:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148371",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:44'></a>
A related issue with [attachment:trac_11021-additional_changes_to_sage-spkg.scripts.patch]: on OS X, if I insert 

```
(bunzip2 -c "$PKG_SRC" || echo foo) | tar tf -
```
instead of the other code, then valid spkg files are not being extracted: I did this at around line 300, and I also put in "pwd" and "ls -l" a few lines later, and I got this (this is with a local spkg file, phc-2.3.60.spkg, specified with a full path):

```
Finished extraction.
/Applications/sage/spkg/build
total 8
drwxr-xr-x  76 palmieri  admin  2584 Jul  4 09:35 bzip2-1.0.5
drwxr-xr-x   8 palmieri  admin   272 Jul 12 15:10 chomp-20100213.p2
drwxr-xr-x   2 palmieri  admin    68 Jul 12 16:55 old
drwxr-xr-x@ 21 palmieri  admin   714 Jul  4 09:35 prereq-0.9
-rw-r--r--   1 palmieri  admin    19 Mar 24  2010 sagetex-2.2.5.cksum
Warning: After extraction the directory 'phc-2.3.60' does not exist.
This means that the corresponding .spkg needs to be downloaded again.
```
But maybe I didn't insert that code correctly.  I'll try a new patch when you have chance to make one. Or if you want, just make the small changes to the sage-sage patch, and we can defer the more major changes to sage-spkg to another ticket.  We should try to get the bug fixes in the other patches merged pretty soon, I think.



---

archive/issue_comments_148372.json:
```json
{
    "body": "<a id='comment:45'></a>\nReplying to [jhpalmieri](#comment%3A43):\n> Re lines 236-243 (and I would guess a similar block in lines 308-314):\n\n\n```\n        PKG_NAME=`sage-latest-online-package \"$PKG_NAME\"`\n        if [ $? -eq 0 ]; then\n            echo \"Found package '$PKG_NAME'.\"\n            FOUND_VERSION='1'\n        else\n            echo >&2 \"$PKG_NAME\" # That's now an error message.\n            exit 1\n        fi\n```\n> In the \"else\" part of this, `$PKG_NAME` will likely be an empty string, so the echo won't print anything.  The script `sage-latest-online-package` prints a suitable error message so this is not a big deal, but it's kind of odd.\n\n\nHmmm, shame on me. I was pretty sure `sage-latest-online-package` would print the error message to **`stdout`** (rather than `stderr`) since otherwise these two instances of `echo $PKG_NAME` really wouldn't make sense, so I just added an according comment -- without looking at the script. 8/\n\nWe can either just remove the `echo ...` or add `2>&1` to the command substitution.\n\n---\n \n> Regarding the comments about Atlas and spkg-check, in retrospect, I'm not sure I understand what you're saying.  If spkg-check fails, then it makes sense for atlas not to be installed, in which case you don't have a complete Sage install, in which case I don't mind if a doctest fails.  But as I said, I may be misunderstanding your point.\n\n\nForget about that. I just wasn't sure whether ATLAS's `spkg-check` is \"Cygwin-hard\" at the moment. If it is not, the build might fail. At least without `SAGE_CHECK=yes`, `spkg/installed/atlas-*` should (currently<sup>TM</sup>) always be there, no matter if ATLAS really got (re)installed or not.",
    "created_at": "2011-07-15T21:51:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148372",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:45'></a>
Replying to [jhpalmieri](#comment%3A43):
> Re lines 236-243 (and I would guess a similar block in lines 308-314):


```
        PKG_NAME=`sage-latest-online-package "$PKG_NAME"`
        if [ $? -eq 0 ]; then
            echo "Found package '$PKG_NAME'."
            FOUND_VERSION='1'
        else
            echo >&2 "$PKG_NAME" # That's now an error message.
            exit 1
        fi
```
> In the "else" part of this, `$PKG_NAME` will likely be an empty string, so the echo won't print anything.  The script `sage-latest-online-package` prints a suitable error message so this is not a big deal, but it's kind of odd.


Hmmm, shame on me. I was pretty sure `sage-latest-online-package` would print the error message to **`stdout`** (rather than `stderr`) since otherwise these two instances of `echo $PKG_NAME` really wouldn't make sense, so I just added an according comment -- without looking at the script. 8/

We can either just remove the `echo ...` or add `2>&1` to the command substitution.

---
 
> Regarding the comments about Atlas and spkg-check, in retrospect, I'm not sure I understand what you're saying.  If spkg-check fails, then it makes sense for atlas not to be installed, in which case you don't have a complete Sage install, in which case I don't mind if a doctest fails.  But as I said, I may be misunderstanding your point.


Forget about that. I just wasn't sure whether ATLAS's `spkg-check` is "Cygwin-hard" at the moment. If it is not, the build might fail. At least without `SAGE_CHECK=yes`, `spkg/installed/atlas-*` should (currently<sup>TM</sup>) always be there, no matter if ATLAS really got (re)installed or not.



---

archive/issue_comments_148373.json:
```json
{
    "body": "<a id='comment:46'></a>\n> We can either just remove the echo ... or add 2>&1 to the command substitution.\n\n\nI think removing the echo command makes sense.",
    "created_at": "2011-07-15T22:05:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148373",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:46'></a>
> We can either just remove the echo ... or add 2>&1 to the command substitution.


I think removing the echo command makes sense.



---

archive/issue_comments_148374.json:
```json
{
    "body": "<a id='comment:47'></a>\nTrying to recap:\n\n* `sage-sage`:\n  * Support also `--info`.\n  * Document `sage <file>.spkg` in more places.\n  * Print spkg names separated by commas ( `sage <-i|-info|-f> ...`).\n\n* `sage-spkg`:\n  * Fix `error` typo.\n  * Support BSD `tar`. (I meanwhile have a copy installed for testing.) W.r.t. your PHC spkg, you probably just inserted the wrong code snippet (perhaps with `t` instead of `x`?).\n  * Remove useless `echo $PKG_NAME` if `sage-latest-online-package` failed (twice).",
    "created_at": "2011-07-15T22:11:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148374",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:47'></a>
Trying to recap:

* `sage-sage`:
  * Support also `--info`.
  * Document `sage <file>.spkg` in more places.
  * Print spkg names separated by commas ( `sage <-i|-info|-f> ...`).

* `sage-spkg`:
  * Fix `error` typo.
  * Support BSD `tar`. (I meanwhile have a copy installed for testing.) W.r.t. your PHC spkg, you probably just inserted the wrong code snippet (perhaps with `t` instead of `x`?).
  * Remove useless `echo $PKG_NAME` if `sage-latest-online-package` failed (twice).



---

archive/issue_comments_148375.json:
```json
{
    "body": "<a id='comment:48'></a>\nThat looks like everything.  Adding the commas is the lowest priority, I would say.  If you want to add the code from [comment:24] about \"Warning: Attempted to overwrite SAGE_ROOT environment variable\", that would be fine, too: it's beyond the scope of the ticket, but it looks like a pretty safe change.",
    "created_at": "2011-07-15T22:23:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148375",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:48'></a>
That looks like everything.  Adding the commas is the lowest priority, I would say.  If you want to add the code from [comment:24] about "Warning: Attempted to overwrite SAGE_ROOT environment variable", that would be fine, too: it's beyond the scope of the ticket, but it looks like a pretty safe change.



---

archive/issue_comments_148376.json:
```json
{
    "body": "<a id='comment:49'></a>\nI wonder if there's a better (and more efficient) way to test if an spkg is (bzip2-) compressed, preferably in a shell function.\n\nI suspect something like\n\n```sh\nif file \"$spkg\" | grep \"bzip2\" >/dev/null; then\n    # it is compressed\n    ...\n```\nwouldn't be very portable, since `file` might not recognize bzip2 files on some systems.\n\nWe could also directly check the magic header instead, with e.g. `head` and `cut` or `dd`.\n\nAny further suggestions?",
    "created_at": "2011-07-15T22:37:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148376",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:49'></a>
I wonder if there's a better (and more efficient) way to test if an spkg is (bzip2-) compressed, preferably in a shell function.

I suspect something like

```sh
if file "$spkg" | grep "bzip2" >/dev/null; then
    # it is compressed
    ...
```
wouldn't be very portable, since `file` might not recognize bzip2 files on some systems.

We could also directly check the magic header instead, with e.g. `head` and `cut` or `dd`.

Any further suggestions?



---

archive/issue_comments_148377.json:
```json
{
    "body": "<a id='comment:50'></a>\nNot a shell function, but isn't this what \"bunzip2 -t FILE\" is for?",
    "created_at": "2011-07-15T22:43:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148377",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:50'></a>
Not a shell function, but isn't this what "bunzip2 -t FILE" is for?



---

archive/issue_comments_148378.json:
```json
{
    "body": "<a id='comment:51'></a>\nReplying to [jhpalmieri](#comment%3A48):\n> That looks like everything.  Adding the commas is the lowest priority, I would say.\n\n\nOk.\n\n\n\n\n> If you want to add the code from [comment:24] about \"Warning: Attempted to overwrite SAGE_ROOT environment variable\", that would be fine, too: it's beyond the scope of the ticket, but it looks like a pretty safe change.\n\n\nAh, I didn't remember it was an \"inline\" patch; I thought you already attached a reviewer patch for that. Can add this, too, of course.\n\n---\n\nIf all are happy, I can also provide cumulative patches later.",
    "created_at": "2011-07-15T22:46:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148378",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:51'></a>
Replying to [jhpalmieri](#comment%3A48):
> That looks like everything.  Adding the commas is the lowest priority, I would say.


Ok.




> If you want to add the code from [comment:24] about "Warning: Attempted to overwrite SAGE_ROOT environment variable", that would be fine, too: it's beyond the scope of the ticket, but it looks like a pretty safe change.


Ah, I didn't remember it was an "inline" patch; I thought you already attached a reviewer patch for that. Can add this, too, of course.

---

If all are happy, I can also provide cumulative patches later.



---

archive/issue_comments_148379.json:
```json
{
    "body": "<a id='comment:52'></a>\nReplying to [jhpalmieri](#comment%3A50):\n> Not a shell function, but isn't this what \"bunzip2 -t FILE\" is for?\n\n\nWell, that's quite inefficient if the file indeed **is** bzip2-compressed.",
    "created_at": "2011-07-15T22:47:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148379",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:52'></a>
Replying to [jhpalmieri](#comment%3A50):
> Not a shell function, but isn't this what "bunzip2 -t FILE" is for?


Well, that's quite inefficient if the file indeed **is** bzip2-compressed.



---

archive/issue_comments_148380.json:
```json
{
    "body": "<a id='comment:53'></a>\nReplying to [leif](#comment%3A52):\n> Replying to [jhpalmieri](#comment%3A50):\n> > Not a shell function, but isn't this what \"bunzip2 -t FILE\" is for?\n\n> \n> Well, that's quite inefficient if the file indeed **is** bzip2-compressed.\n\n\nYes and no.  On my computer, in the worst case, it takes about 7 or 8 seconds (for the main sage spkg).   Installing that package takes 35 minutes, so the added time is insignificant, taken in proportion.  For most of the standard spkg's, this is the case.  (Running `time bunzip2 -t *.spkg` on the directory `SAGE_ROOT/spkg/standard` takes 49 seconds on my machine, compared to 2 hours to build all of Sage.)",
    "created_at": "2011-07-16T16:44:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148380",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:53'></a>
Replying to [leif](#comment%3A52):
> Replying to [jhpalmieri](#comment%3A50):
> > Not a shell function, but isn't this what "bunzip2 -t FILE" is for?

> 
> Well, that's quite inefficient if the file indeed **is** bzip2-compressed.


Yes and no.  On my computer, in the worst case, it takes about 7 or 8 seconds (for the main sage spkg).   Installing that package takes 35 minutes, so the added time is insignificant, taken in proportion.  For most of the standard spkg's, this is the case.  (Running `time bunzip2 -t *.spkg` on the directory `SAGE_ROOT/spkg/standard` takes 49 seconds on my machine, compared to 2 hours to build all of Sage.)



---

archive/issue_comments_148381.json:
```json
{
    "body": "<a id='comment:54'></a>\nI think I found another consequence of not exporting `BUILD`: because of the [stupid way](http://trac.sagemath.org/sage_trac/ticket/9906) the RPy package is installed, its build directory ends up being `SAGE_ROOT/spkg/rpy2-2.0.8`, rather than `SAGE_ROOT/spkg/build/rpy2-2.0.8`.",
    "created_at": "2011-08-03T18:05:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148381",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:54'></a>
I think I found another consequence of not exporting `BUILD`: because of the [stupid way](http://trac.sagemath.org/sage_trac/ticket/9906) the RPy package is installed, its build directory ends up being `SAGE_ROOT/spkg/rpy2-2.0.8`, rather than `SAGE_ROOT/spkg/build/rpy2-2.0.8`.



---

archive/issue_comments_148382.json:
```json
{
    "body": "<a id='comment:55'></a>\nAny progress on this?",
    "created_at": "2011-10-29T22:59:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148382",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:55'></a>
Any progress on this?



---

archive/issue_comments_148383.json:
```json
{
    "body": "<a id='comment:56'></a>\nLarge parts of this have been subsumed by #12479 and related tickets. I think there are still worthwhile changes here; should we keep this open, or close it and open more specific tickets?  For example, this change still looks like a good idea:\n\n```diff\ndiff --git a/spkg/bin/sage-spkg b/spkg/bin/sage-spkg\n--- a/spkg/bin/sage-spkg\n+++ b/spkg/bin/sage-spkg\n@@ -361,7 +361,7 @@ fi\n if [ ! -f spkg-install ]; then\n     echo '#!/usr/bin/env bash' > spkg-install\n     if [ -x configure ]; then\n-        echo './configure --prefix=\"$SAGE_LOCAL\" && make && make install' >> spkg-install\n+        echo './configure --prefix=\\\"\\$SAGE_LOCAL\\\" && make && make install' >> spkg-install\n     elif [ -f setup.py ]; then\n         echo 'python setup.py install' >> spkg-install\n     else\n```\nSo anyway, this ticket needs work.",
    "created_at": "2012-03-20T18:56:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148383",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:56'></a>
Large parts of this have been subsumed by #12479 and related tickets. I think there are still worthwhile changes here; should we keep this open, or close it and open more specific tickets?  For example, this change still looks like a good idea:

```diff
diff --git a/spkg/bin/sage-spkg b/spkg/bin/sage-spkg
--- a/spkg/bin/sage-spkg
+++ b/spkg/bin/sage-spkg
@@ -361,7 +361,7 @@ fi
 if [ ! -f spkg-install ]; then
     echo '#!/usr/bin/env bash' > spkg-install
     if [ -x configure ]; then
-        echo './configure --prefix="$SAGE_LOCAL" && make && make install' >> spkg-install
+        echo './configure --prefix=\"\$SAGE_LOCAL\" && make && make install' >> spkg-install
     elif [ -f setup.py ]; then
         echo 'python setup.py install' >> spkg-install
     else
```
So anyway, this ticket needs work.



---

archive/issue_comments_148384.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2012-03-20T18:56:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148384",
    "user": "https://github.com/jhpalmieri"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_148385.json:
```json
{
    "body": "<a id='comment:57'></a>\nReplying to [jhpalmieri](#comment%3A56):\n> Large parts of this have been subsumed by #12479 and related tickets. I think there are still worthwhile changes here; should we keep this open, or close it and open more specific tickets?\n\n\n\nYes, it would have been much easier if people had based their work on this here (or simply [first] completed this ticket; there wasn't much missing, and everything was well documented)... 8/\n\nI wouldn't close it yet, but I currently don't know what's meanwhile been solved elsewhere.\n\nAt least rebasing seems impossible, i.e., all changes would have to manually be put into one or more completely new patches.",
    "created_at": "2012-03-20T19:19:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148385",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:57'></a>
Replying to [jhpalmieri](#comment%3A56):
> Large parts of this have been subsumed by #12479 and related tickets. I think there are still worthwhile changes here; should we keep this open, or close it and open more specific tickets?



Yes, it would have been much easier if people had based their work on this here (or simply [first] completed this ticket; there wasn't much missing, and everything was well documented)... 8/

I wouldn't close it yet, but I currently don't know what's meanwhile been solved elsewhere.

At least rebasing seems impossible, i.e., all changes would have to manually be put into one or more completely new patches.



---

archive/issue_comments_148386.json:
```json
{
    "body": "<a id='comment:58'></a>\nI had a quick look over the **scripts** patches and I think everything there has been fixed in other patches (most recently, #12606, which needs review by the way).\n\nI think we should still keep the Sage library patches.",
    "created_at": "2012-08-29T19:20:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148386",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:58'></a>
I had a quick look over the **scripts** patches and I think everything there has been fixed in other patches (most recently, #12606, which needs review by the way).

I think we should still keep the Sage library patches.



---

archive/issue_comments_148387.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -6,15 +6,14 @@\n \n The patch to `sage-env` fixes a bug caused or enabled by #10469, which through the patch to `sage-spkg` now becomes more visible and potentially worse.\n \n-Apply\n+**DO NOT** Apply:\n 1. [attachment:trac_11021-sage-spkg-cleanup-v2-rebased_to_4.7.1.alpha4.patch]\n 2. [attachment:trac_11021-additional_changes_to_sage-spkg.scripts.patch] (somewhat optional, can be reviewed separately)\n 3. [attachment:trac_11021-support_and_document_sage_-info_in_sage-sage.scripts.patch]\n 4. [attachment:trac_11021-export_BUILD_in_sage-env.scripts.patch]\n to the **scripts repo**.\n \n-Apply\n+**apply**\n 1. [attachment:trac_11021-fix_sage.misc.install_package.sagelib.patch]\n-2. [attachment:trac_11021-sage-library-referee.patch]\n to the **Sage library**.\n \n``````\n",
    "created_at": "2012-08-29T19:20:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148387",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -6,15 +6,14 @@
 
 The patch to `sage-env` fixes a bug caused or enabled by #10469, which through the patch to `sage-spkg` now becomes more visible and potentially worse.
 
-Apply
+**DO NOT** Apply:
 1. [attachment:trac_11021-sage-spkg-cleanup-v2-rebased_to_4.7.1.alpha4.patch]
 2. [attachment:trac_11021-additional_changes_to_sage-spkg.scripts.patch] (somewhat optional, can be reviewed separately)
 3. [attachment:trac_11021-support_and_document_sage_-info_in_sage-sage.scripts.patch]
 4. [attachment:trac_11021-export_BUILD_in_sage-env.scripts.patch]
 to the **scripts repo**.
 
-Apply
+**apply**
 1. [attachment:trac_11021-fix_sage.misc.install_package.sagelib.patch]
-2. [attachment:trac_11021-sage-library-referee.patch]
 to the **Sage library**.
 
``````




---

archive/issue_comments_148388.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,3 +1,11 @@\n+**Apply**\n+1. [attachment:trac_11021-fix_sage.misc.install_package.sagelib.patch]\n+to the **Sage library**.\n+\n+---\n+\n+**OLD STUFF** superseded by other tickets, no longer relevant:\n+\n One of the patches at #9960 did a lot of clean-up to the file `sage-spkg`: quoting environment variables, replacing tabs with spaces, etc., also adding comments and TODOs.  Since those changes were not related to the issue at #9960, I've split them off and put them here instead.  The main change of any content is to look at the file `SPKG.txt` rather than `SAGE.txt` when the \"`-info`\" flag is passed so `sage-spkg` (through `sage -info ...`). Also, warnings and error messages are now redirected to `stderr`.\n \n The additional patch to `sage-spkg` is based on the v2 \"clean-up\" patch, fixing some more bugs, adding error checks, improving some messages (see comment below / commit message for some more details).\n@@ -6,14 +14,10 @@\n \n The patch to `sage-env` fixes a bug caused or enabled by #10469, which through the patch to `sage-spkg` now becomes more visible and potentially worse.\n \n-**DO NOT** Apply:\n+**DO NOT** apply:\n 1. [attachment:trac_11021-sage-spkg-cleanup-v2-rebased_to_4.7.1.alpha4.patch]\n 2. [attachment:trac_11021-additional_changes_to_sage-spkg.scripts.patch] (somewhat optional, can be reviewed separately)\n 3. [attachment:trac_11021-support_and_document_sage_-info_in_sage-sage.scripts.patch]\n 4. [attachment:trac_11021-export_BUILD_in_sage-env.scripts.patch]\n to the **scripts repo**.\n \n-**apply**\n-1. [attachment:trac_11021-fix_sage.misc.install_package.sagelib.patch]\n-to the **Sage library**.\n-\n``````\n",
    "created_at": "2012-08-29T19:33:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148388",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,3 +1,11 @@
+**Apply**
+1. [attachment:trac_11021-fix_sage.misc.install_package.sagelib.patch]
+to the **Sage library**.
+
+---
+
+**OLD STUFF** superseded by other tickets, no longer relevant:
+
 One of the patches at #9960 did a lot of clean-up to the file `sage-spkg`: quoting environment variables, replacing tabs with spaces, etc., also adding comments and TODOs.  Since those changes were not related to the issue at #9960, I've split them off and put them here instead.  The main change of any content is to look at the file `SPKG.txt` rather than `SAGE.txt` when the "`-info`" flag is passed so `sage-spkg` (through `sage -info ...`). Also, warnings and error messages are now redirected to `stderr`.
 
 The additional patch to `sage-spkg` is based on the v2 "clean-up" patch, fixing some more bugs, adding error checks, improving some messages (see comment below / commit message for some more details).
@@ -6,14 +14,10 @@
 
 The patch to `sage-env` fixes a bug caused or enabled by #10469, which through the patch to `sage-spkg` now becomes more visible and potentially worse.
 
-**DO NOT** Apply:
+**DO NOT** apply:
 1. [attachment:trac_11021-sage-spkg-cleanup-v2-rebased_to_4.7.1.alpha4.patch]
 2. [attachment:trac_11021-additional_changes_to_sage-spkg.scripts.patch] (somewhat optional, can be reviewed separately)
 3. [attachment:trac_11021-support_and_document_sage_-info_in_sage-sage.scripts.patch]
 4. [attachment:trac_11021-export_BUILD_in_sage-env.scripts.patch]
 to the **scripts repo**.
 
-**apply**
-1. [attachment:trac_11021-fix_sage.misc.install_package.sagelib.patch]
-to the **Sage library**.
-
``````




---

archive/issue_comments_148389.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2012-08-29T19:33:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148389",
    "user": "https://github.com/jdemeyer"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_148390.json:
```json
{
    "body": "**Changing author** from \"Leif Leonhardy, Kelvin Li\" to \"Leif Leonhardy, Kelvin Li, Jeroen Demeyer\".",
    "created_at": "2012-08-29T19:33:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148390",
    "user": "https://github.com/jdemeyer"
}
```

**Changing author** from "Leif Leonhardy, Kelvin Li" to "Leif Leonhardy, Kelvin Li, Jeroen Demeyer".



---

archive/issue_comments_148391.json:
```json
{
    "body": "<a id='comment:60'></a>\nI have merged the two Sage library patches into one and made some further cosmetic changes.\n\nCould anybody have a look please?",
    "created_at": "2012-08-29T19:34:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148391",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:60'></a>
I have merged the two Sage library patches into one and made some further cosmetic changes.

Could anybody have a look please?



---

archive/attachments_014473.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_11021-fix_sage.misc.install_package.sagelib.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket11021/trac_11021-fix_sage.misc.install_package.sagelib.patch",
    "created_at": "2012-08-29T19:38:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/jdemeyer"
}
```



---

archive/issue_comments_148392.json:
```json
{
    "body": "Patch for the Sage library",
    "created_at": "2012-08-29T19:38:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148392",
    "user": "https://github.com/jdemeyer"
}
```

Patch for the Sage library



---

archive/issue_comments_148393.json:
```json
{
    "body": "<a id='comment:61'></a>\nThe Sage library patch looks okay to me. I'm not completely happy with a feature of both the old and new implementation. In Sage 5.3.rc0, cvxopt (for example) has been upgraded compared to the version on the web page, so if I do `install_package('cvxopt')`, it tries to download and install the previous version. Should the behavior of `standard_packages()` be changed? Or should its output be modified before use in `install_package(...)`, taking other (later) versions of packages into account?\n\nBy the way, I see a regression in the behavior of Sage: `sage file.spkg` doesn't work anymore. It used to (as of Sage 4.7, at least) install the given spkg. When I run it now, I get an error. On sage.math:\n\n```\n$ sage /scratch/palmieri/sage/spkg/standard/cvxopt-1.1.5.spkg \nCalling sage-spkg on ''\n/scratch/palmieri/sage-5.3.beta2/spkg/bin/sage-spkg: line 152: [: =: unary operator expected\n/scratch/palmieri/sage-5.3.beta2/spkg/bin/sage-spkg: line 158: [: =: unary operator expected\n/scratch/palmieri/sage-5.3.beta2/spkg/bin/sage-spkg: line 163: [: =: unary operator expected\n/scratch/palmieri/sage-5.3.beta2/spkg/bin/sage-spkg: line 168: [: =: unary operator expected\nAttempting to download package \nSearching for latest online version of \nCould not find a version for .\n```\nI guess it's from these lines, in particular the second line, from `spkg/bin/sage`:\n\n```\n   if [ \"$T \" = \"spkg \" ]; then\n       install \"\" \"$@\"\n       exit $?\n   fi\n```\nSince this isn't documented, I guess it's not a big deal, but perhaps it could be fixed. Another ticket?\n\nEdit: with the patch at #12606, the error messages don't appear, but it still doesn't work.",
    "created_at": "2012-08-30T03:45:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148393",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:61'></a>
The Sage library patch looks okay to me. I'm not completely happy with a feature of both the old and new implementation. In Sage 5.3.rc0, cvxopt (for example) has been upgraded compared to the version on the web page, so if I do `install_package('cvxopt')`, it tries to download and install the previous version. Should the behavior of `standard_packages()` be changed? Or should its output be modified before use in `install_package(...)`, taking other (later) versions of packages into account?

By the way, I see a regression in the behavior of Sage: `sage file.spkg` doesn't work anymore. It used to (as of Sage 4.7, at least) install the given spkg. When I run it now, I get an error. On sage.math:

```
$ sage /scratch/palmieri/sage/spkg/standard/cvxopt-1.1.5.spkg 
Calling sage-spkg on ''
/scratch/palmieri/sage-5.3.beta2/spkg/bin/sage-spkg: line 152: [: =: unary operator expected
/scratch/palmieri/sage-5.3.beta2/spkg/bin/sage-spkg: line 158: [: =: unary operator expected
/scratch/palmieri/sage-5.3.beta2/spkg/bin/sage-spkg: line 163: [: =: unary operator expected
/scratch/palmieri/sage-5.3.beta2/spkg/bin/sage-spkg: line 168: [: =: unary operator expected
Attempting to download package 
Searching for latest online version of 
Could not find a version for .
```
I guess it's from these lines, in particular the second line, from `spkg/bin/sage`:

```
   if [ "$T " = "spkg " ]; then
       install "" "$@"
       exit $?
   fi
```
Since this isn't documented, I guess it's not a big deal, but perhaps it could be fixed. Another ticket?

Edit: with the patch at #12606, the error messages don't appear, but it still doesn't work.



---

archive/attachments_014474.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "11021_spkg.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket11021/11021_spkg.patch",
    "created_at": "2012-08-30T06:52:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/jdemeyer"
}
```



---

archive/issue_comments_148394.json:
```json
{
    "body": "",
    "created_at": "2012-08-30T06:52:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148394",
    "user": "https://github.com/jdemeyer"
}
```





---

archive/issue_comments_148395.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,6 +1,7 @@\n **Apply**\n 1. [attachment:trac_11021-fix_sage.misc.install_package.sagelib.patch]\n to the **Sage library**.\n+1. [attachment:11021_spkg.patch] to `SAGE_ROOT`.\n \n ---\n \n``````\n",
    "created_at": "2012-08-30T06:54:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148395",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,6 +1,7 @@
 **Apply**
 1. [attachment:trac_11021-fix_sage.misc.install_package.sagelib.patch]
 to the **Sage library**.
+1. [attachment:11021_spkg.patch] to `SAGE_ROOT`.
 
 ---
 
``````




---

archive/issue_comments_148396.json:
```json
{
    "body": "<a id='comment:62'></a>\nI added a patch to fix\n\n```\n./sage foo.spkg\n```\nIt now force-installs `foo.spkg`.",
    "created_at": "2012-08-30T06:54:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148396",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:62'></a>
I added a patch to fix

```
./sage foo.spkg
```
It now force-installs `foo.spkg`.



---

archive/issue_comments_148397.json:
```json
{
    "body": "<a id='comment:63'></a>\nReplying to [jhpalmieri](#comment%3A61):\n> The Sage library patch looks okay to me. I'm not completely happy with a feature of both the old and new implementation. In Sage 5.3.rc0, cvxopt (for example) has been upgraded compared to the version on the web page, so if I do `install_package('cvxopt')`, it tries to download and install the previous version. Should the behavior of `standard_packages()` be changed? Or should its output be modified before use in `install_package(...)`, taking other (later) versions of packages into account?\n\n\nHow about simply not using `standard_packages()` at all and simply calling `sage -i cvxopt`?  Then `sage-spkg` will figure out which version to install (it would install `spkg/standard/cvxopt-NNN.spkg`)",
    "created_at": "2012-08-30T06:56:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148397",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:63'></a>
Replying to [jhpalmieri](#comment%3A61):
> The Sage library patch looks okay to me. I'm not completely happy with a feature of both the old and new implementation. In Sage 5.3.rc0, cvxopt (for example) has been upgraded compared to the version on the web page, so if I do `install_package('cvxopt')`, it tries to download and install the previous version. Should the behavior of `standard_packages()` be changed? Or should its output be modified before use in `install_package(...)`, taking other (later) versions of packages into account?


How about simply not using `standard_packages()` at all and simply calling `sage -i cvxopt`?  Then `sage-spkg` will figure out which version to install (it would install `spkg/standard/cvxopt-NNN.spkg`)



---

archive/issue_comments_148398.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -6,6 +6,8 @@\n ---\n \n **OLD STUFF** superseded by other tickets, no longer relevant:\n+\n+## Fix \"sage -info\" and a bug when sourcing sage-env more than once\n \n One of the patches at #9960 did a lot of clean-up to the file `sage-spkg`: quoting environment variables, replacing tabs with spaces, etc., also adding comments and TODOs.  Since those changes were not related to the issue at #9960, I've split them off and put them here instead.  The main change of any content is to look at the file `SPKG.txt` rather than `SAGE.txt` when the \"`-info`\" flag is passed so `sage-spkg` (through `sage -info ...`). Also, warnings and error messages are now redirected to `stderr`.\n \n``````\n",
    "created_at": "2012-08-30T07:22:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148398",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -6,6 +6,8 @@
 ---
 
 **OLD STUFF** superseded by other tickets, no longer relevant:
+
+## Fix "sage -info" and a bug when sourcing sage-env more than once
 
 One of the patches at #9960 did a lot of clean-up to the file `sage-spkg`: quoting environment variables, replacing tabs with spaces, etc., also adding comments and TODOs.  Since those changes were not related to the issue at #9960, I've split them off and put them here instead.  The main change of any content is to look at the file `SPKG.txt` rather than `SAGE.txt` when the "`-info`" flag is passed so `sage-spkg` (through `sage -info ...`). Also, warnings and error messages are now redirected to `stderr`.
 
``````




---

archive/issue_events_034101.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "rename": {
        "from": "Fix \"sage -info\" and a bug when sourcing sage-env more than once",
        "to": "Fix install_package() library function"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11021#event-34101"
}
```



---

archive/issue_comments_148399.json:
```json
{
    "body": "<a id='comment:65'></a>\n*** ping ***",
    "created_at": "2012-09-03T14:08:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148399",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:65'></a>
*** ping ***



---

archive/issue_comments_148400.json:
```json
{
    "body": "<a id='comment:66'></a>\nReplying to [jdemeyer](#comment%3A62):\n> I added a patch to fix\n> \n> ```\n> ./sage foo.spkg\n> ```\n> It now force-installs `foo.spkg`.\n\n\nIt used to install without forcing. The old behavior seems more natural to me, so I'm suggesting my patch instead. Positive review for the Sage library patch.\n\n> How about simply not using standard_packages() at all and simply calling sage -i cvxopt? Then sage-spkg will figure out which version to install (it would install spkg/standard/cvxopt-NNN.spkg) \n\n\nSounds fine to me, although let's do this on another ticket.",
    "created_at": "2012-09-03T17:11:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148400",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:66'></a>
Replying to [jdemeyer](#comment%3A62):
> I added a patch to fix
> 
> ```
> ./sage foo.spkg
> ```
> It now force-installs `foo.spkg`.


It used to install without forcing. The old behavior seems more natural to me, so I'm suggesting my patch instead. Positive review for the Sage library patch.

> How about simply not using standard_packages() at all and simply calling sage -i cvxopt? Then sage-spkg will figure out which version to install (it would install spkg/standard/cvxopt-NNN.spkg) 


Sounds fine to me, although let's do this on another ticket.



---

archive/attachments_014475.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_11021-root.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket11021/trac_11021-root.patch",
    "created_at": "2012-09-03T17:11:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/jhpalmieri"
}
```



---

archive/issue_comments_148401.json:
```json
{
    "body": "root repo",
    "created_at": "2012-09-03T17:11:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148401",
    "user": "https://github.com/jhpalmieri"
}
```

root repo



---

archive/issue_comments_148402.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,7 +1,7 @@\n **Apply**\n 1. [attachment:trac_11021-fix_sage.misc.install_package.sagelib.patch]\n to the **Sage library**.\n-1. [attachment:11021_spkg.patch] to `SAGE_ROOT`.\n+1. [attachment:trac_11021-root.patch] to `SAGE_ROOT`.\n \n ---\n \n``````\n",
    "created_at": "2012-09-03T17:12:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148402",
    "user": "https://github.com/jhpalmieri"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,7 +1,7 @@
 **Apply**
 1. [attachment:trac_11021-fix_sage.misc.install_package.sagelib.patch]
 to the **Sage library**.
-1. [attachment:11021_spkg.patch] to `SAGE_ROOT`.
+1. [attachment:trac_11021-root.patch] to `SAGE_ROOT`.
 
 ---
 
``````




---

archive/issue_comments_148403.json:
```json
{
    "body": "**Resolution:** fixed",
    "created_at": "2012-09-04T11:37:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148403",
    "user": "https://github.com/jdemeyer"
}
```

**Resolution:** fixed



---

archive/issue_comments_148404.json:
```json
{
    "body": "**Merged:** sage-5.4.beta0",
    "created_at": "2012-09-04T11:37:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148404",
    "user": "https://github.com/jdemeyer"
}
```

**Merged:** sage-5.4.beta0



---

archive/issue_comments_148405.json:
```json
{
    "body": "<a id='comment:68'></a>\nPositive review then.",
    "created_at": "2012-09-04T11:37:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11021#issuecomment-148405",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:68'></a>
Positive review then.



---

archive/issue_events_034102.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-09-04T11:37:14Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/11021",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11021#event-34102"
}
```
