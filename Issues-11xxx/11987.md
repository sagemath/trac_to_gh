# Issue 11987: integrate returns divergent, maxima.integrate the correct result

archive/issues_011815.json:
```json
{
    "body": "The following integration fails:\n\n```\nsage: integrate(sin(x)*sin(x/3)/x^2, x, 0, oo)       \nERROR: An unexpected error occurred while tokenizing input\nThe following traceback may be corrupted or invalid\nThe error message is: ('EOF in multi-line statement', (554, 0))\n\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n...\nValueError: Integral is divergent.\n```\nBut the integral is not divergent. It seems that `integrate` uses Maxima, but Maxima can compute the correct result:\n\n```\nsage: maxima.integrate(sin(x)*sin(x/3)/x^2, x, 0, oo)\n%pi/6\n```\n\n---\n\nApply [attachment:trac_11987-principal-value.patch] and [attachment:trac_11987-doctest.patch].\n\n\nAssignee: @burcin\n\nCC:  @nbruin @orlitzky\n\nKeywords: symbolic integration, maxima, integrate, divergent\n\nResolution: fixed\n\nAuthor: Nils Bruin, Karl-Dieter Crisman\n\nReviewer: Karl-Dieter Crisman, Nils Bruin\n\nMerged: sage-4.8.alpha4\n\nIssue created by migration from https://trac.sagemath.org/ticket/11987\n\n",
    "closed_at": "2011-12-05T16:06:03Z",
    "created_at": "2011-11-03T10:41:09Z",
    "labels": [
        "component: calculus",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.8",
    "title": "integrate returns divergent, maxima.integrate the correct result",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11987",
    "user": "https://github.com/dkrenn"
}
```
The following integration fails:

```
sage: integrate(sin(x)*sin(x/3)/x^2, x, 0, oo)       
ERROR: An unexpected error occurred while tokenizing input
The following traceback may be corrupted or invalid
The error message is: ('EOF in multi-line statement', (554, 0))

---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
...
ValueError: Integral is divergent.
```
But the integral is not divergent. It seems that `integrate` uses Maxima, but Maxima can compute the correct result:

```
sage: maxima.integrate(sin(x)*sin(x/3)/x^2, x, 0, oo)
%pi/6
```

---

Apply [attachment:trac_11987-principal-value.patch] and [attachment:trac_11987-doctest.patch].


Assignee: @burcin

CC:  @nbruin @orlitzky

Keywords: symbolic integration, maxima, integrate, divergent

Resolution: fixed

Author: Nils Bruin, Karl-Dieter Crisman

Reviewer: Karl-Dieter Crisman, Nils Bruin

Merged: sage-4.8.alpha4

Issue created by migration from https://trac.sagemath.org/ticket/11987





---

archive/issue_comments_165627.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -18,4 +18,3 @@\n %pi/6\n ```\n \n-So maybe there is a problem in converting expressions from Sage to Maxima\n``````\n",
    "created_at": "2011-11-03T10:44:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11987#issuecomment-165627",
    "user": "https://github.com/dkrenn"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -18,4 +18,3 @@
 %pi/6
 ```
 
-So maybe there is a problem in converting expressions from Sage to Maxima
``````




---

archive/issue_comments_165628.json:
```json
{
    "body": "<a id='comment:2'></a>\nA very relevant data point is that \n\n```\nsage: maxima_calculus.integrate(sin(x)*sin(x/3)/x^2, x, 0, oo)\n    624                 self._name = parent._create(value, name=name)\n    625             except (TypeError, KeyboardInterrupt, RuntimeError, ValueError), x:\n--> 626                 raise TypeError, x\n    627 \n    628     def _latex_(self):\n\nTypeError: ECL says: Divergent Integral\n```\nAnd that is the \"copy\" of Maxima we use for integration and other calculus stuff, and that's why the error is returned.\n\nSo the problem must be in one of the \"extra\" things we use for calculus.\n\n---\nHere's vanilla Sage Maxima.\n\n```\n\n(%i1) integrate(sin(x)*sin(x/3)/x^2, x, 0,inf);\n                                      %pi\n(%o1)                                 ---\n                                       6\n```\nAnd none of the standard things we do to initialize \n\n```\ninit_code = ['display2d : false', 'domain : complex', 'keepfloat : true',\n            'load(to_poly_solver)', 'load(simplify_sum)']\n```\nchange this.  And that's not the error message with the documented principal value one that *should* diverge.\n\n```\n(%i12) integrate(1/x^3,x,-1,3);\nPrincipal Value\n(%o12) 4/9\n```\nTwo more data points of no surprise.\n\n```\nsage: maxima_eval(([max_integrate],[sr_to_max(SR(a)) for a in [sin(x)*sin(x/3)/x^2, x, 0,oo]]))\n---------------------------------------------------------------------------\nRuntimeError: ECL says: Divergent Integral\nsage: ([max_integrate],[sr_to_max(SR(a)) for a in [sin(x)*sin(x/3)/x^2, x, 0,oo]])\n([<ECL: $INTEGRATE>], [<ECL: ((MTIMES) ((MEXPT) $X -2) ((%SIN) ((MTIMES) $X ((RAT) 1 3))) ((%SIN) $X))>, <ECL: $X>, <ECL: 0>, <ECL: $INF>])\n```\nNot sure what is going on here; maybe a missed translation?",
    "created_at": "2011-11-03T13:34:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11987#issuecomment-165628",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:2'></a>
A very relevant data point is that 

```
sage: maxima_calculus.integrate(sin(x)*sin(x/3)/x^2, x, 0, oo)
    624                 self._name = parent._create(value, name=name)
    625             except (TypeError, KeyboardInterrupt, RuntimeError, ValueError), x:
--> 626                 raise TypeError, x
    627 
    628     def _latex_(self):

TypeError: ECL says: Divergent Integral
```
And that is the "copy" of Maxima we use for integration and other calculus stuff, and that's why the error is returned.

So the problem must be in one of the "extra" things we use for calculus.

---
Here's vanilla Sage Maxima.

```

(%i1) integrate(sin(x)*sin(x/3)/x^2, x, 0,inf);
                                      %pi
(%o1)                                 ---
                                       6
```
And none of the standard things we do to initialize 

```
init_code = ['display2d : false', 'domain : complex', 'keepfloat : true',
            'load(to_poly_solver)', 'load(simplify_sum)']
```
change this.  And that's not the error message with the documented principal value one that *should* diverge.

```
(%i12) integrate(1/x^3,x,-1,3);
Principal Value
(%o12) 4/9
```
Two more data points of no surprise.

```
sage: maxima_eval(([max_integrate],[sr_to_max(SR(a)) for a in [sin(x)*sin(x/3)/x^2, x, 0,oo]]))
---------------------------------------------------------------------------
RuntimeError: ECL says: Divergent Integral
sage: ([max_integrate],[sr_to_max(SR(a)) for a in [sin(x)*sin(x/3)/x^2, x, 0,oo]])
([<ECL: $INTEGRATE>], [<ECL: ((MTIMES) ((MEXPT) $X -2) ((%SIN) ((MTIMES) $X ((RAT) 1 3))) ((%SIN) $X))>, <ECL: $X>, <ECL: 0>, <ECL: $INF>])
```
Not sure what is going on here; maybe a missed translation?



---

archive/issue_comments_165629.json:
```json
{
    "body": "Milestone sage-4.7.3 deleted",
    "created_at": "2011-11-03T16:14:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11987#issuecomment-165629",
    "user": "https://github.com/jdemeyer"
}
```

Milestone sage-4.7.3 deleted



---

archive/issue_events_031784.json:
```json
{
    "actor": "https://github.com/kcrisman",
    "created_at": "2011-11-04T16:58:30Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11987",
    "milestone": "sage-4.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11987#event-31784"
}
```



---

archive/issue_comments_165630.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -18,3 +18,19 @@\n %pi/6\n ```\n \n+Originally reported at #11990:  A different behaviour brings the following example\n+\n+```\n+sage: m = var('m')\n+sage: sum(2^m, m, 0, oo)\n+Traceback (most recent call last):\n+...\n+ValueError: Sum is divergent.\n+```\n+Whereas\n+\n+```\n+sage: maxima.sum(2^m, m, 0, oo)\n+inf\n+```\n+\n``````\n",
    "created_at": "2011-11-04T16:58:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11987#issuecomment-165630",
    "user": "https://github.com/kcrisman"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -18,3 +18,19 @@
 %pi/6
 ```
 
+Originally reported at #11990:  A different behaviour brings the following example
+
+```
+sage: m = var('m')
+sage: sum(2^m, m, 0, oo)
+Traceback (most recent call last):
+...
+ValueError: Sum is divergent.
+```
+Whereas
+
+```
+sage: maxima.sum(2^m, m, 0, oo)
+inf
+```
+
``````




---

archive/issue_comments_165631.json:
```json
{
    "body": "<a id='comment:5'></a>\nNils, do you think that line 88 in `maxima_lib.py` could conceivably be responsible for these?\n\n```\necl_eval('(defun principal nil (error \"Divergent Integral\"))')\n```\nI don't really understand what's going on with that line.  Otherwise I don't see how we could be getting something different, though.",
    "created_at": "2011-11-05T02:46:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11987#issuecomment-165631",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:5'></a>
Nils, do you think that line 88 in `maxima_lib.py` could conceivably be responsible for these?

```
ecl_eval('(defun principal nil (error "Divergent Integral"))')
```
I don't really understand what's going on with that line.  Otherwise I don't see how we could be getting something different, though.



---

archive/issue_comments_165632.json:
```json
{
    "body": "<a id='comment:6'></a>\nReplying to [kcrisman](#comment%3A5):\n> Nils, do you think that line 88 in `maxima_lib.py` could conceivably be responsible for these?\n> \n> ```\n> ecl_eval('(defun principal nil (error \"Divergent Integral\"))')\n> ```\n\n\nYou can replace it by this to get closer to the behaviour \"throw an error if Maxima wants to print \"Principal Value\" and do not alter the behaviour otherwise:\n\n```\necl_eval('(defun principal nil (cond ($noprincipal (diverg)) ((not pcprntd) (merror \"Divergent Integral\"))))')\n```\nIt fixes the example in this report.\n\nHowever, when you go and take a look in `defint.lisp` there are some very dodgy `(setq pcprintd t)` statements in there. Essentially what they are doing there is suppressing the printing of the \"Principal Value\" message. I hope those pieces of code have established that taking a principal value integral is indeed undeniably the thing to do ...\n\nI think it's defensible to simply patch maxima_lib with this line. We're depending on maxima for integration anyway, so if their handling leads to errors, we can just point \"upstream\". \n\nFor reference [defint.lisp](http://maxima.git.sourceforge.net/git/gitweb.cgi?p=maxima/maxima;a=blob;f=src/defint.lisp;h=f3d50f01a067ea821884b85f1b290b129fc1b8cb;hb=HEAD#l1096), line 1096.",
    "created_at": "2011-11-05T04:39:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11987#issuecomment-165632",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:6'></a>
Replying to [kcrisman](#comment%3A5):
> Nils, do you think that line 88 in `maxima_lib.py` could conceivably be responsible for these?
> 
> ```
> ecl_eval('(defun principal nil (error "Divergent Integral"))')
> ```


You can replace it by this to get closer to the behaviour "throw an error if Maxima wants to print "Principal Value" and do not alter the behaviour otherwise:

```
ecl_eval('(defun principal nil (cond ($noprincipal (diverg)) ((not pcprntd) (merror "Divergent Integral"))))')
```
It fixes the example in this report.

However, when you go and take a look in `defint.lisp` there are some very dodgy `(setq pcprintd t)` statements in there. Essentially what they are doing there is suppressing the printing of the "Principal Value" message. I hope those pieces of code have established that taking a principal value integral is indeed undeniably the thing to do ...

I think it's defensible to simply patch maxima_lib with this line. We're depending on maxima for integration anyway, so if their handling leads to errors, we can just point "upstream". 

For reference [defint.lisp](http://maxima.git.sourceforge.net/git/gitweb.cgi?p=maxima/maxima;a=blob;f=src/defint.lisp;h=f3d50f01a067ea821884b85f1b290b129fc1b8cb;hb=HEAD#l1096), line 1096.



---

archive/issue_comments_165633.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-11-05T05:13:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11987#issuecomment-165633",
    "user": "https://github.com/nbruin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_165634.json:
```json
{
    "body": "Changing author from \"\" to \"Nils Bruin\"",
    "created_at": "2011-11-05T05:13:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11987#issuecomment-165634",
    "user": "https://github.com/nbruin"
}
```

Changing author from "" to "Nils Bruin"



---

archive/issue_comments_165635.json:
```json
{
    "body": "<a id='comment:7'></a>\nAttachment [trac_11987-principal-value.patch](tarball://root/attachments/some-uuid/ticket11987/trac_11987-principal-value.patch) by @nbruin created at 2011-11-05 05:13:18",
    "created_at": "2011-11-05T05:13:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11987#issuecomment-165635",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:7'></a>
Attachment [trac_11987-principal-value.patch](tarball://root/attachments/some-uuid/ticket11987/trac_11987-principal-value.patch) by @nbruin created at 2011-11-05 05:13:18



---

archive/issue_comments_165636.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Karl-Dieter Crisman\"",
    "created_at": "2011-11-06T02:09:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11987#issuecomment-165636",
    "user": "https://github.com/kcrisman"
}
```

Changing reviewer from "" to "Karl-Dieter Crisman"



---

archive/issue_comments_165637.json:
```json
{
    "body": "<a id='comment:8'></a>\nWell, needs work of course, as we want a doctest that this works.  \n\nI think you are right that this is ok to do.  At least I was right that this is what was happening.  So what happens, are we replacing their handling of principal with ours in certain cases?  I wouldn't mind a quick tutorial in what your function (`defun` defines one, right?) actually *does* :)\n\n---\nVarious uninformed remarks...\n\nSo is this even really a principal value situation?  I mean, the `1/x^2` component and then taking each pos. or neg. piece can make the integral from 0 to oo be like an alternating series, in effect...  For what it's worth, W|A doesn't even mention PV, just returns `pi/6`.\n\nThere is some interesting numerical instability in integration when you go really far out, not surprising I guess with that crazily oscillating of an integrand.\n\n```\nsage: for end in [2,4,6,8,10,12,14,16]:\n    numerical_integral(sin(x)*sin(x/3)/x^2,0,10^end,max_points=10000)\n....:     \n(0.52351589061571202, 9.9920072216264089e-15)\n(0.5235987756295446, 8.2436845585377863e-07)\n(0.52359878933232351, 9.998230889899859e-07)\n(0.52359885121913463, 1.259313851474051e-06)\n(0.52359877780154374, 1.2600489386016923e-06)\n(1.2189490243409529e-08, 2.420112684966894e-08)\n(7.0214579963551362e-11, 1.4528575097897933e-10)\n(1.1777735784870202e-12, 2.382542114112869e-12)\n```",
    "created_at": "2011-11-06T02:09:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11987#issuecomment-165637",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:8'></a>
Well, needs work of course, as we want a doctest that this works.  

I think you are right that this is ok to do.  At least I was right that this is what was happening.  So what happens, are we replacing their handling of principal with ours in certain cases?  I wouldn't mind a quick tutorial in what your function (`defun` defines one, right?) actually *does* :)

---
Various uninformed remarks...

So is this even really a principal value situation?  I mean, the `1/x^2` component and then taking each pos. or neg. piece can make the integral from 0 to oo be like an alternating series, in effect...  For what it's worth, W|A doesn't even mention PV, just returns `pi/6`.

There is some interesting numerical instability in integration when you go really far out, not surprising I guess with that crazily oscillating of an integrand.

```
sage: for end in [2,4,6,8,10,12,14,16]:
    numerical_integral(sin(x)*sin(x/3)/x^2,0,10^end,max_points=10000)
....:     
(0.52351589061571202, 9.9920072216264089e-15)
(0.5235987756295446, 8.2436845585377863e-07)
(0.52359878933232351, 9.998230889899859e-07)
(0.52359885121913463, 1.259313851474051e-06)
(0.52359877780154374, 1.2600489386016923e-06)
(1.2189490243409529e-08, 2.420112684966894e-08)
(7.0214579963551362e-11, 1.4528575097897933e-10)
(1.1777735784870202e-12, 2.382542114112869e-12)
```



---

archive/issue_comments_165638.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -18,19 +18,3 @@\n %pi/6\n ```\n \n-Originally reported at #11990:  A different behaviour brings the following example\n-\n-```\n-sage: m = var('m')\n-sage: sum(2^m, m, 0, oo)\n-Traceback (most recent call last):\n-...\n-ValueError: Sum is divergent.\n-```\n-Whereas\n-\n-```\n-sage: maxima.sum(2^m, m, 0, oo)\n-inf\n-```\n-\n``````\n",
    "created_at": "2011-11-06T02:09:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11987#issuecomment-165638",
    "user": "https://github.com/kcrisman"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -18,19 +18,3 @@
 %pi/6
 ```
 
-Originally reported at #11990:  A different behaviour brings the following example
-
-```
-sage: m = var('m')
-sage: sum(2^m, m, 0, oo)
-Traceback (most recent call last):
-...
-ValueError: Sum is divergent.
-```
-Whereas
-
-```
-sage: maxima.sum(2^m, m, 0, oo)
-inf
-```
-
``````




---

archive/issue_comments_165639.json:
```json
{
    "body": "Changing work_issues from \"\" to \"doctests\"",
    "created_at": "2011-11-06T02:09:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11987#issuecomment-165639",
    "user": "https://github.com/kcrisman"
}
```

Changing work_issues from "" to "doctests"



---

archive/issue_comments_165640.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-11-06T02:09:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11987#issuecomment-165640",
    "user": "https://github.com/kcrisman"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_165641.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [kcrisman](#comment%3A8):\n\n> So what happens, are we replacing their handling of principal with ours in certain cases?\n\n\nSee the link to defint.lisp above. You can see the original definition of `principal` there:\n\n```\n1096 (defun principal nil\n```\ndefinition of a function with an empty argument list\n\n```\n1097   (cond\n```\nthis is the main conditional in lisp. It's like a switch statement\n\n```\n($noprincipal (diverg))\n```\nIf the variable `$noprincipal` (the $ is a name-mangling convention in Maxima that this is the maxima variable `noprincipal`) has a non-nil value, then call [diverg](http://maxima.git.sourceforge.net/git/gitweb.cgi?p=maxima/maxima;a=blob;f=src/defint.lisp;h=f3d50f01a067ea821884b85f1b290b129fc1b8cb;hb=HEAD#l761) and return its value (it actually doesn't return but throws an exception or raises an error)\n\n```\n1098         ((not pcprntd)\n```\nIf pcprntd has a nil (=false) value:\n\n```\n1099          (format t \"Principal Value~%\")\n```\nPrint a message\n\n```\n1100          (setq pcprntd t))))\n```\nand set the variable to `t` to ensure that the message only gets printed once per integral evaluation.\n\n> I wouldn't mind a quick tutorial in what your function (`defun` defines one, right?) actually *does* :)\n\n\nAll that the new version does is replacing the `format` print statement by an error-raising statement. We don't set `pcprntd` because that would not have any effect anyway.\n\nThe nasty bits happen in [line 1144](http://maxima.git.sourceforge.net/git/gitweb.cgi?p=maxima/maxima;a=blob;f=src/defint.lisp;h=f3d50f01a067ea821884b85f1b290b129fc1b8cb;hb=HEAD#l1144) and\n[line 1157](http://maxima.git.sourceforge.net/git/gitweb.cgi?p=maxima/maxima;a=blob;f=src/defint.lisp;h=f3d50f01a067ea821884b85f1b290b129fc1b8cb;hb=HEAD#l1157) where pcprntd gets set to `t` (note the dynamical scoping here! This is different from what would happen in python. Outside the `let` statement, `pcprntd` reverts to its old value again).\n\nFor some reason, Maxima decides to evaluate the integral in this report via a principal value integral somewhere, but apparently the writer of the code is confident that this is the right thing to do and suppresses the printing of the `Principal Value` warning.\n\nWith the patch, we accept that if Maxima wasn't going to print the message, things should be safe and no error should be raised.\n\n> So is this even really a principal value situation?  I mean, the `1/x^2` component and then taking each pos. or neg. piece can make the integral from 0 to oo be like an alternating series, in effect...  For what it's worth, W|A doesn't even mention PV, just returns `pi/6`.\n\n\nThe fact that the patch makes a difference shows that maxima *does* do something that triggers calling `principal` and that only happens in\n[line 625](http://maxima.git.sourceforge.net/git/gitweb.cgi?p=maxima/maxima;a=blob;f=src/defint.lisp;h=f3d50f01a067ea821884b85f1b290b129fc1b8cb;hb=HEAD#l625) and\n[line 1168](http://maxima.git.sourceforge.net/git/gitweb.cgi?p=maxima/maxima;a=blob;f=src/defint.lisp;h=f3d50f01a067ea821884b85f1b290b129fc1b8cb;hb=HEAD#l1168). The latter is the code path we end up in. Maxima doesn't print the message for the reason explained above.\n\nGo ahead and add any appropriate doctests. Then you can co-author the patch! [and thanks for shaming me into repairing this :-) I hope we don't have other monkey-patch surprises]",
    "created_at": "2011-11-06T04:19:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11987#issuecomment-165641",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:9'></a>
Replying to [kcrisman](#comment%3A8):

> So what happens, are we replacing their handling of principal with ours in certain cases?


See the link to defint.lisp above. You can see the original definition of `principal` there:

```
1096 (defun principal nil
```
definition of a function with an empty argument list

```
1097   (cond
```
this is the main conditional in lisp. It's like a switch statement

```
($noprincipal (diverg))
```
If the variable `$noprincipal` (the $ is a name-mangling convention in Maxima that this is the maxima variable `noprincipal`) has a non-nil value, then call [diverg](http://maxima.git.sourceforge.net/git/gitweb.cgi?p=maxima/maxima;a=blob;f=src/defint.lisp;h=f3d50f01a067ea821884b85f1b290b129fc1b8cb;hb=HEAD#l761) and return its value (it actually doesn't return but throws an exception or raises an error)

```
1098         ((not pcprntd)
```
If pcprntd has a nil (=false) value:

```
1099          (format t "Principal Value~%")
```
Print a message

```
1100          (setq pcprntd t))))
```
and set the variable to `t` to ensure that the message only gets printed once per integral evaluation.

> I wouldn't mind a quick tutorial in what your function (`defun` defines one, right?) actually *does* :)


All that the new version does is replacing the `format` print statement by an error-raising statement. We don't set `pcprntd` because that would not have any effect anyway.

The nasty bits happen in [line 1144](http://maxima.git.sourceforge.net/git/gitweb.cgi?p=maxima/maxima;a=blob;f=src/defint.lisp;h=f3d50f01a067ea821884b85f1b290b129fc1b8cb;hb=HEAD#l1144) and
[line 1157](http://maxima.git.sourceforge.net/git/gitweb.cgi?p=maxima/maxima;a=blob;f=src/defint.lisp;h=f3d50f01a067ea821884b85f1b290b129fc1b8cb;hb=HEAD#l1157) where pcprntd gets set to `t` (note the dynamical scoping here! This is different from what would happen in python. Outside the `let` statement, `pcprntd` reverts to its old value again).

For some reason, Maxima decides to evaluate the integral in this report via a principal value integral somewhere, but apparently the writer of the code is confident that this is the right thing to do and suppresses the printing of the `Principal Value` warning.

With the patch, we accept that if Maxima wasn't going to print the message, things should be safe and no error should be raised.

> So is this even really a principal value situation?  I mean, the `1/x^2` component and then taking each pos. or neg. piece can make the integral from 0 to oo be like an alternating series, in effect...  For what it's worth, W|A doesn't even mention PV, just returns `pi/6`.


The fact that the patch makes a difference shows that maxima *does* do something that triggers calling `principal` and that only happens in
[line 625](http://maxima.git.sourceforge.net/git/gitweb.cgi?p=maxima/maxima;a=blob;f=src/defint.lisp;h=f3d50f01a067ea821884b85f1b290b129fc1b8cb;hb=HEAD#l625) and
[line 1168](http://maxima.git.sourceforge.net/git/gitweb.cgi?p=maxima/maxima;a=blob;f=src/defint.lisp;h=f3d50f01a067ea821884b85f1b290b129fc1b8cb;hb=HEAD#l1168). The latter is the code path we end up in. Maxima doesn't print the message for the reason explained above.

Go ahead and add any appropriate doctests. Then you can co-author the patch! [and thanks for shaming me into repairing this :-) I hope we don't have other monkey-patch surprises]



---

archive/issue_comments_165642.json:
```json
{
    "body": "<a id='comment:10'></a>\nThanks for your explanations, very helpful!\n\n> For some reason, Maxima decides to evaluate the integral in this report via a principal value integral somewhere, but apparently the writer of the code is confident that this is the right thing to do and suppresses the printing of the `Principal Value` warning.\n\n\n> With the patch, we accept that if Maxima wasn't going to print the message, things should be safe and no error should be raised.\n\n\nThat makes sense, actually.  The PV value *is* the value if the integral is defined, as I understand it, so they are using trickery :)  Since we aren't going to write our own integration code anyway, we should trust Maxima and report upstream if it does have an error (which this one doesn't).\n\n> Go ahead and add any appropriate doctests. Then you can co-author the patch! [and thanks for shaming me into repairing this :-) I hope we don't have other monkey-patch surprises]\n\n\nGood, I'll do this as I have opportunity over the next couple days.  Thanks for figuring this out!",
    "created_at": "2011-11-07T17:13:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11987#issuecomment-165642",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:10'></a>
Thanks for your explanations, very helpful!

> For some reason, Maxima decides to evaluate the integral in this report via a principal value integral somewhere, but apparently the writer of the code is confident that this is the right thing to do and suppresses the printing of the `Principal Value` warning.


> With the patch, we accept that if Maxima wasn't going to print the message, things should be safe and no error should be raised.


That makes sense, actually.  The PV value *is* the value if the integral is defined, as I understand it, so they are using trickery :)  Since we aren't going to write our own integration code anyway, we should trust Maxima and report upstream if it does have an error (which this one doesn't).

> Go ahead and add any appropriate doctests. Then you can co-author the patch! [and thanks for shaming me into repairing this :-) I hope we don't have other monkey-patch surprises]


Good, I'll do this as I have opportunity over the next couple days.  Thanks for figuring this out!



---

archive/issue_comments_165643.json:
```json
{
    "body": "Doctests, apply on top of other patch",
    "created_at": "2011-11-07T19:02:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11987#issuecomment-165643",
    "user": "https://github.com/kcrisman"
}
```

Doctests, apply on top of other patch



---

archive/issue_comments_165644.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -18,3 +18,7 @@\n %pi/6\n ```\n \n+---\n+\n+Apply [attachment:trac_11987-principal-value.patch] and [attachment:trac_11987-doctest.patch].\n+\n``````\n",
    "created_at": "2011-11-07T21:10:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11987#issuecomment-165644",
    "user": "https://github.com/kcrisman"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -18,3 +18,7 @@
 %pi/6
 ```
 
+---
+
+Apply [attachment:trac_11987-principal-value.patch] and [attachment:trac_11987-doctest.patch].
+
``````




---

archive/issue_comments_165645.json:
```json
{
    "body": "<a id='comment:11'></a>\nAttachment [trac_11987-doctest.patch](tarball://root/attachments/some-uuid/ticket11987/trac_11987-doctest.patch) by @kcrisman created at 2011-11-07 21:10:27\n\nOk, done.  Needs review.  Passes tests on the symbolic, functions, and calculus directories for me.\n\n---\nApply [attachment:trac_11987-principal-value.patch] and [attachment:trac_11987-doctest.patch].",
    "created_at": "2011-11-07T21:10:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11987#issuecomment-165645",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:11'></a>
Attachment [trac_11987-doctest.patch](tarball://root/attachments/some-uuid/ticket11987/trac_11987-doctest.patch) by @kcrisman created at 2011-11-07 21:10:27

Ok, done.  Needs review.  Passes tests on the symbolic, functions, and calculus directories for me.

---
Apply [attachment:trac_11987-principal-value.patch] and [attachment:trac_11987-doctest.patch].



---

archive/issue_comments_165646.json:
```json
{
    "body": "Changing author from \"Nils Bruin\" to \"Nils Bruin, Karl-Dieter Crisman\"",
    "created_at": "2011-11-07T21:10:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11987#issuecomment-165646",
    "user": "https://github.com/kcrisman"
}
```

Changing author from "Nils Bruin" to "Nils Bruin, Karl-Dieter Crisman"



---

archive/issue_comments_165647.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-11-07T21:10:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11987#issuecomment-165647",
    "user": "https://github.com/kcrisman"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_165648.json:
```json
{
    "body": "<a id='comment:12'></a>\nPing.  Should be very easy to finish review, just need the doctest patch to be reviewed.",
    "created_at": "2011-11-30T17:37:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11987#issuecomment-165648",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:12'></a>
Ping.  Should be very easy to finish review, just need the doctest patch to be reviewed.



---

archive/issue_comments_165649.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-11-30T19:03:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11987#issuecomment-165649",
    "user": "https://github.com/nbruin"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_165650.json:
```json
{
    "body": "<a id='comment:13'></a>\nI think KDC thinks the patch itself is OK and I think his doctest is good and informative, so I think we can give this a positive review between the two of us. Anybody in favour of more red tape should feel free to revert this, though.",
    "created_at": "2011-11-30T19:03:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11987#issuecomment-165650",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:13'></a>
I think KDC thinks the patch itself is OK and I think his doctest is good and informative, so I think we can give this a positive review between the two of us. Anybody in favour of more red tape should feel free to revert this, though.



---

archive/issue_comments_165651.json:
```json
{
    "body": "Changing reviewer from \"Karl-Dieter Crisman\" to \"Karl-Dieter Crisman, Nils Bruin\"",
    "created_at": "2011-11-30T20:46:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11987#issuecomment-165651",
    "user": "https://github.com/kcrisman"
}
```

Changing reviewer from "Karl-Dieter Crisman" to "Karl-Dieter Crisman, Nils Bruin"



---

archive/issue_comments_165652.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [nbruin](#comment%3A13):\n> I think KDC thinks the patch itself is OK and I think his doctest is good and informative, so I think we can give this a positive review between the two of us. Anybody in favour of more red tape should feel free to revert this, though. \n\n\nI'm not yet qualified to understand the original patch, but I too have reviewed the doctest. I confirmed the result in Mathematica, and ran the long test suite after applying both patches.",
    "created_at": "2011-11-30T21:33:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11987#issuecomment-165652",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:15'></a>
Replying to [nbruin](#comment%3A13):
> I think KDC thinks the patch itself is OK and I think his doctest is good and informative, so I think we can give this a positive review between the two of us. Anybody in favour of more red tape should feel free to revert this, though. 


I'm not yet qualified to understand the original patch, but I too have reviewed the doctest. I confirmed the result in Mathematica, and ran the long test suite after applying both patches.



---

archive/issue_comments_165653.json:
```json
{
    "body": "Changing work_issues from \"doctests\" to \"\"",
    "created_at": "2011-12-03T12:06:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11987#issuecomment-165653",
    "user": "https://github.com/jdemeyer"
}
```

Changing work_issues from "doctests" to ""



---

archive/issue_comments_165654.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-12-05T16:06:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11987#issuecomment-165654",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_031785.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-12-05T16:06:03Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/11987",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11987#event-31785"
}
```



---

archive/issue_comments_165655.json:
```json
{
    "body": "Changing merged from \"\" to \"sage-4.8.alpha4\"",
    "created_at": "2011-12-05T16:06:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11987#issuecomment-165655",
    "user": "https://github.com/jdemeyer"
}
```

Changing merged from "" to "sage-4.8.alpha4"
