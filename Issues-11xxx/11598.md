# Issue 11598: Congruence testing for odd modular subgroups

archive/issues_011426.json:
```json
{
    "body": "The new functionality added in ticket #11422 makes it possible to manipulate arbitrary finite index (not necessarily congruence) subgroups of SL2Z. This massively extends my old code which only worked for subgroups containing -1.\n\nThe \"is_congruence\" method in the new code, though, *defines* a subgroup to be congruence if its image modulo -1 is a congruence subgroup of PSL2Z. This is not the same as the conventional definition of a congruence subgroup of SL2Z. The patch below modifies the algorithm so it uses the conventional notion of \"congruence\". It also adds functionality for enumerating all the liftings of a projective modular subgroup.\n\nPart of a series of tickets: #10335 - #11422 - this one - #5048 - #10453 - #11601.\n\n**Apply:**\n1.  [attachment:trac_11598-foldedrebased.patch]\n\n\nAssignee: @craigcitro\n\nCC:  @videlec\n\nKeywords: modular congruence subgroup\n\nResolution: fixed\n\nDependencies: #11422\n\nAuthor: David Loeffler\n\nReviewer: Vincent Delecroix\n\nMerged: sage-4.7.2.alpha3\n\nIssue created by migration from https://trac.sagemath.org/ticket/11598\n\n",
    "closed_at": "2011-09-27T17:44:09Z",
    "created_at": "2011-07-14T16:23:13Z",
    "labels": [
        "component: modular forms",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.7.2",
    "title": "Congruence testing for odd modular subgroups",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11598",
    "user": "https://github.com/loefflerd"
}
```
The new functionality added in ticket #11422 makes it possible to manipulate arbitrary finite index (not necessarily congruence) subgroups of SL2Z. This massively extends my old code which only worked for subgroups containing -1.

The "is_congruence" method in the new code, though, *defines* a subgroup to be congruence if its image modulo -1 is a congruence subgroup of PSL2Z. This is not the same as the conventional definition of a congruence subgroup of SL2Z. The patch below modifies the algorithm so it uses the conventional notion of "congruence". It also adds functionality for enumerating all the liftings of a projective modular subgroup.

Part of a series of tickets: #10335 - #11422 - this one - #5048 - #10453 - #11601.

**Apply:**
1.  [attachment:trac_11598-foldedrebased.patch]


Assignee: @craigcitro

CC:  @videlec

Keywords: modular congruence subgroup

Resolution: fixed

Dependencies: #11422

Author: David Loeffler

Reviewer: Vincent Delecroix

Merged: sage-4.7.2.alpha3

Issue created by migration from https://trac.sagemath.org/ticket/11598





---

archive/issue_comments_161301.json:
```json
{
    "body": "<a id='comment:1'></a>\nHi Vincent,\n\nAny chance you could take a look at this? I don't think we should go changing the definition of \"congruence\"! I missed this issue when I reviewed #11422, so I did this little patch to change it.",
    "created_at": "2011-07-14T16:27:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11598#issuecomment-161301",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:1'></a>
Hi Vincent,

Any chance you could take a look at this? I don't think we should go changing the definition of "congruence"! I missed this issue when I reviewed #11422, so I did this little patch to change it.



---

archive/issue_comments_161302.json:
```json
{
    "body": "Changing dependencies from \"11422\" to \"#11422\"",
    "created_at": "2011-07-14T16:27:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11598#issuecomment-161302",
    "user": "https://github.com/loefflerd"
}
```

Changing dependencies from "11422" to "#11422"



---

archive/issue_comments_161303.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-07-14T16:27:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11598#issuecomment-161303",
    "user": "https://github.com/loefflerd"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_161304.json:
```json
{
    "body": "<a id='comment:2'></a>\nJust realised that, since the new algorithm in the odd case is *extremely* slow, it is better to not call it from the generic test routine! Here's a new patch.",
    "created_at": "2011-07-14T17:18:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11598#issuecomment-161304",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:2'></a>
Just realised that, since the new algorithm in the odd case is *extremely* slow, it is better to not call it from the generic test routine! Here's a new patch.



---

archive/issue_comments_161305.json:
```json
{
    "body": "<a id='comment:3'></a>\nReplying to [davidloeffler](#comment%3A2):\n\nI was asking myself what should be the definition of congruence subgroup. In order to use Wohlfart's theorem it is necessary to use the projective definition and that's why it was implemented that way. For all standard congruence groups it makes no difference. Could you explain me a concrete case where the difference matter ?\n\nIn any case, you should add an example of an odd arithmetic subgroup which is not of congruence but which becomes one when we add the element -id.\n\nDo you know a method, given an even subgroup, to build all odd subgroups it may come from ?\n\n> Just realised that, since the new algorithm in the odd case is *extremely* slow, it is better to not call it from the generic test routine! Here's a new patch.\n\n\nFor that particular question, it should be possible, following Hsu method (who produces uniform presentation for PSL(Z,Z/pZ)), to get a congruence test method for odd subgroups.",
    "created_at": "2011-07-14T20:23:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11598#issuecomment-161305",
    "user": "https://github.com/videlec"
}
```

<a id='comment:3'></a>
Replying to [davidloeffler](#comment%3A2):

I was asking myself what should be the definition of congruence subgroup. In order to use Wohlfart's theorem it is necessary to use the projective definition and that's why it was implemented that way. For all standard congruence groups it makes no difference. Could you explain me a concrete case where the difference matter ?

In any case, you should add an example of an odd arithmetic subgroup which is not of congruence but which becomes one when we add the element -id.

Do you know a method, given an even subgroup, to build all odd subgroups it may come from ?

> Just realised that, since the new algorithm in the odd case is *extremely* slow, it is better to not call it from the generic test routine! Here's a new patch.


For that particular question, it should be possible, following Hsu method (who produces uniform presentation for PSL(Z,Z/pZ)), to get a congruence test method for odd subgroups.



---

archive/issue_comments_161306.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-07-14T20:23:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11598#issuecomment-161306",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_161307.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Vincent Delecroix\"",
    "created_at": "2011-07-14T20:23:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11598#issuecomment-161307",
    "user": "https://github.com/videlec"
}
```

Changing reviewer from "" to "Vincent Delecroix"



---

archive/issue_comments_161308.json:
```json
{
    "body": "<a id='comment:4'></a>\nReplying to [vdelecroix](#comment%3A3):\n> Replying to [davidloeffler](#comment%3A2):\n> \n> I was asking myself what should be the definition of congruence subgroup. In order to use Wohlfart's theorem it is necessary to use the projective definition and that's why it was implemented that way. For all standard congruence groups it makes no difference. Could you explain me a concrete case where the difference matter ?\n\n\nHere's one: the group of index 24 with `S2 = (1,3,13,15)(2,4,14,16)(5,7,17,19)(6,10,18,22)(8,12,20,24)(9,11,21,23), S3 = (1,14,15,13,2,3)(4,5,6,16,17,18)(7,8,9,19,20,21)(10,11,12,22,23,24).` This is taken from the paper of Kiming, Schuett and Verrill in J. London Math Soc (2010) which is all about this problem of finding noncongruence odd subgroups whose projective image is congruence.\n\n> In any case, you should add an example of an odd arithmetic subgroup which is not of congruence but which becomes one when we add the element -id.\n> \n> Do you know a method, given an even subgroup, to build all odd subgroups it may come from ?\n\n\nThere is one in the K-S-V paper but it uses Farey symbols heavily. I can think of an algorithm which produces some examples of such subgroups using the permutation representation (which is how I found the one above) but it's not totally obvious to me if it produces all of them.\n\n> > Just realised that, since the new algorithm in the odd case is *extremely* slow, it is better to not call it from the generic test routine! Here's a new patch.\n\n> \n> For that particular question, it should be possible, following Hsu method (who produces uniform presentation for PSL(Z,Z/pZ)), to get a congruence test method for odd subgroups.\n\n\nI've actually thought of another approach, which is slower and less elegant than Hsu's approach but much better than the patch I just made :-). Rather than finding generators for `Gamma(N)`, which is hideously slow if N is more than about 8, one can just look at the subgroup of `SL(2, Z / NZ)` generated by the reductions mod n of the generators of self. Then self is congruence of level N iff this subgroup has the same index in `SL(2, Z/NZ)` as self does in `SL(2,Z)`; and we can always take N to be twice the generalised level. \n\nBetter still, if G isn't congruence, then this algorithm calculates the smallest congruence subgroup containing G (the congruence closure), which is an interesting thing to calculate in itself.\n\nI will do a new patch tomorrow.",
    "created_at": "2011-07-14T20:40:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11598#issuecomment-161308",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:4'></a>
Replying to [vdelecroix](#comment%3A3):
> Replying to [davidloeffler](#comment%3A2):
> 
> I was asking myself what should be the definition of congruence subgroup. In order to use Wohlfart's theorem it is necessary to use the projective definition and that's why it was implemented that way. For all standard congruence groups it makes no difference. Could you explain me a concrete case where the difference matter ?


Here's one: the group of index 24 with `S2 = (1,3,13,15)(2,4,14,16)(5,7,17,19)(6,10,18,22)(8,12,20,24)(9,11,21,23), S3 = (1,14,15,13,2,3)(4,5,6,16,17,18)(7,8,9,19,20,21)(10,11,12,22,23,24).` This is taken from the paper of Kiming, Schuett and Verrill in J. London Math Soc (2010) which is all about this problem of finding noncongruence odd subgroups whose projective image is congruence.

> In any case, you should add an example of an odd arithmetic subgroup which is not of congruence but which becomes one when we add the element -id.
> 
> Do you know a method, given an even subgroup, to build all odd subgroups it may come from ?


There is one in the K-S-V paper but it uses Farey symbols heavily. I can think of an algorithm which produces some examples of such subgroups using the permutation representation (which is how I found the one above) but it's not totally obvious to me if it produces all of them.

> > Just realised that, since the new algorithm in the odd case is *extremely* slow, it is better to not call it from the generic test routine! Here's a new patch.

> 
> For that particular question, it should be possible, following Hsu method (who produces uniform presentation for PSL(Z,Z/pZ)), to get a congruence test method for odd subgroups.


I've actually thought of another approach, which is slower and less elegant than Hsu's approach but much better than the patch I just made :-). Rather than finding generators for `Gamma(N)`, which is hideously slow if N is more than about 8, one can just look at the subgroup of `SL(2, Z / NZ)` generated by the reductions mod n of the generators of self. Then self is congruence of level N iff this subgroup has the same index in `SL(2, Z/NZ)` as self does in `SL(2,Z)`; and we can always take N to be twice the generalised level. 

Better still, if G isn't congruence, then this algorithm calculates the smallest congruence subgroup containing G (the congruence closure), which is an interesting thing to calculate in itself.

I will do a new patch tomorrow.



---

archive/issue_comments_161309.json:
```json
{
    "body": "Attachment [trac_11598-odd_congroup_change.patch](tarball://root/attachments/some-uuid/ticket11598/trac_11598-odd_congroup_change.patch) by @loefflerd created at 2011-07-15 09:34:33\n\npatch against 4.7.1.alpha4 + #10335 + #11422",
    "created_at": "2011-07-15T09:34:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11598#issuecomment-161309",
    "user": "https://github.com/loefflerd"
}
```

Attachment [trac_11598-odd_congroup_change.patch](tarball://root/attachments/some-uuid/ticket11598/trac_11598-odd_congroup_change.patch) by @loefflerd created at 2011-07-15 09:34:33

patch against 4.7.1.alpha4 + #10335 + #11422



---

archive/issue_comments_161310.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-07-15T09:41:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11598#issuecomment-161310",
    "user": "https://github.com/loefflerd"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_161311.json:
```json
{
    "body": "<a id='comment:5'></a>\nHere's a new patch, which:\n\n- implements a congruence test for odd subgroups, using only calculations in finite matrix groups (much faster than the previous version);\n\n- implements enumeration of the index 2 odd subgroups of an even subgroup;\n\n- corrects a few typos etc in the documentation.\n\nThere are probably far better ways of doing the congruence test, as you suggest; but I'd rather get something that works in quickly, rather than having to release a Sage version that uses a different definition and then change it back to the conventional definition later.\n\nI haven't implemented congruence closure yet, because I'm working on a patch that will introduce a new class for generic congruence subgroups defined by a finite group of matrices in ` SL(2, Z / N) `, and I'll include congruence closure in that.\n\nThanks Vincent for the helpful feedback on my previous patch!",
    "created_at": "2011-07-15T09:41:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11598#issuecomment-161311",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:5'></a>
Here's a new patch, which:

- implements a congruence test for odd subgroups, using only calculations in finite matrix groups (much faster than the previous version);

- implements enumeration of the index 2 odd subgroups of an even subgroup;

- corrects a few typos etc in the documentation.

There are probably far better ways of doing the congruence test, as you suggest; but I'd rather get something that works in quickly, rather than having to release a Sage version that uses a different definition and then change it back to the conventional definition later.

I haven't implemented congruence closure yet, because I'm working on a patch that will introduce a new class for generic congruence subgroups defined by a finite group of matrices in ` SL(2, Z / N) `, and I'll include congruence closure in that.

Thanks Vincent for the helpful feedback on my previous patch!



---

archive/issue_events_036018.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "rename": {
        "from": "Change to is_congruence method of modular subgroups",
        "to": "Congruence testing for odd modular subgroups"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11598#event-36018"
}
```



---

archive/issue_comments_161312.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,3 @@\n The new functionality added in ticket #11422 makes it possible to manipulate arbitrary finite index (not necessarily congruence) subgroups of SL2Z. This massively extends my old code which only worked for subgroups containing -1.\n \n-The \"is_congruence\" method in the new code, though, *defines* a subgroup to be congruence if its image modulo -1 is a congruence subgroup of PSL2Z. This is not the same as the conventional definition of a congruence subgroup of SL2Z. The patch below modifies the algorithm so it uses the conventional notion of \"congruence\".\n+The \"is_congruence\" method in the new code, though, *defines* a subgroup to be congruence if its image modulo -1 is a congruence subgroup of PSL2Z. This is not the same as the conventional definition of a congruence subgroup of SL2Z. The patch below modifies the algorithm so it uses the conventional notion of \"congruence\". It also adds functionality for enumerating all the liftings of a projective modular subgroup.\n``````\n",
    "created_at": "2011-07-15T09:41:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11598#issuecomment-161312",
    "user": "https://github.com/loefflerd"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,3 @@
 The new functionality added in ticket #11422 makes it possible to manipulate arbitrary finite index (not necessarily congruence) subgroups of SL2Z. This massively extends my old code which only worked for subgroups containing -1.
 
-The "is_congruence" method in the new code, though, *defines* a subgroup to be congruence if its image modulo -1 is a congruence subgroup of PSL2Z. This is not the same as the conventional definition of a congruence subgroup of SL2Z. The patch below modifies the algorithm so it uses the conventional notion of "congruence".
+The "is_congruence" method in the new code, though, *defines* a subgroup to be congruence if its image modulo -1 is a congruence subgroup of PSL2Z. This is not the same as the conventional definition of a congruence subgroup of SL2Z. The patch below modifies the algorithm so it uses the conventional notion of "congruence". It also adds functionality for enumerating all the liftings of a projective modular subgroup.
``````




---

archive/issue_comments_161313.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,6 @@\n The new functionality added in ticket #11422 makes it possible to manipulate arbitrary finite index (not necessarily congruence) subgroups of SL2Z. This massively extends my old code which only worked for subgroups containing -1.\n \n The \"is_congruence\" method in the new code, though, *defines* a subgroup to be congruence if its image modulo -1 is a congruence subgroup of PSL2Z. This is not the same as the conventional definition of a congruence subgroup of SL2Z. The patch below modifies the algorithm so it uses the conventional notion of \"congruence\". It also adds functionality for enumerating all the liftings of a projective modular subgroup.\n+\n+Part of a series of tickets: #10335 - #11422 - this one - #5048 - #10453 - #11601.\n+\n``````\n",
    "created_at": "2011-07-15T15:23:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11598#issuecomment-161313",
    "user": "https://github.com/loefflerd"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,6 @@
 The new functionality added in ticket #11422 makes it possible to manipulate arbitrary finite index (not necessarily congruence) subgroups of SL2Z. This massively extends my old code which only worked for subgroups containing -1.
 
 The "is_congruence" method in the new code, though, *defines* a subgroup to be congruence if its image modulo -1 is a congruence subgroup of PSL2Z. This is not the same as the conventional definition of a congruence subgroup of SL2Z. The patch below modifies the algorithm so it uses the conventional notion of "congruence". It also adds functionality for enumerating all the liftings of a projective modular subgroup.
+
+Part of a series of tickets: #10335 - #11422 - this one - #5048 - #10453 - #11601.
+
``````




---

archive/issue_comments_161314.json:
```json
{
    "body": "<a id='comment:7'></a>\nReplying to [davidloeffler](#comment%3A5):\n\nVery nice!\n\n> - implements enumeration of the index 2 odd subgroups of an even subgroup;\n\n\n- I modified details of your implementation (not the algorithm). There are some redundancy, but the code is by far much faster. \n\n- I added a method one_odd_subgroup which is a copy of the first lines of your function and a randomization of the end. The randomization is optional (see in the \"reviewer\" patch).\n\n- With the above function, I added a random_odd_subgroup in the testing file and make tests compatible with odd subgroups.\n\n> There are probably far better ways of doing the congruence test, as you suggest; but I'd rather get something that works in quickly, rather than having to release a Sage version that uses a different definition and then change it back to the conventional definition later.\n\n\nI definitely agree.\n\nIf you are OK, with my changes, you can put the ticket in positive review.",
    "created_at": "2011-07-15T18:26:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11598#issuecomment-161314",
    "user": "https://github.com/videlec"
}
```

<a id='comment:7'></a>
Replying to [davidloeffler](#comment%3A5):

Very nice!

> - implements enumeration of the index 2 odd subgroups of an even subgroup;


- I modified details of your implementation (not the algorithm). There are some redundancy, but the code is by far much faster. 

- I added a method one_odd_subgroup which is a copy of the first lines of your function and a randomization of the end. The randomization is optional (see in the "reviewer" patch).

- With the above function, I added a random_odd_subgroup in the testing file and make tests compatible with odd subgroups.

> There are probably far better ways of doing the congruence test, as you suggest; but I'd rather get something that works in quickly, rather than having to release a Sage version that uses a different definition and then change it back to the conventional definition later.


I definitely agree.

If you are OK, with my changes, you can put the ticket in positive review.



---

archive/issue_comments_161315.json:
```json
{
    "body": "<a id='comment:8'></a>\nI've done some tests. You made several changes: setting \"check=False\" in the constructor; adding a custom `__hash__` function; and using a set and a list at the same time. The combined effect of these is dramatic:\n\nBEFORE\n\n```\nsage: time [len(Gamma0(N).as_permutation_group().odd_subgroups()) for N in [11..20]]\nCPU times: user 14.26 s, sys: 2.34 s, total: 16.60 s\nWall time: 38.00 s\n[8, 32, 0, 32, 32, 32, 0, 128, 8, 128]\n```\n\nAFTER\n\n```\nsage: time [len(Gamma0(N).as_permutation_group().odd_subgroups()) for N in [11..20]]\nCPU times: user 3.35 s, sys: 0.49 s, total: 3.84 s\nWall time: 4.32 s\n[8, 32, 0, 32, 32, 32, 0, 128, 8, 128]\n```\n\nBut one part puzzles me a little. I can see that the first two changes lead to a dramatic speedup, but it's not totally clear to me what the advantage of using a set type for the `bucket` variable is. Could you explain? Moreover, if the set leads to some speedup, then why keep the list as well -- why not just `return list(bucket)` at the end?\n\nAlso, you have a random `(` in a comment at line 2478; it seems odd not to disable the check parameter in `one_odd_subgroup`; and the third and fourth lines in the \"Testing randomness\" doctest in `one_odd_subgroup` seem slightly pointless -- with a random routine, checking that it works is sensible, but running a test on the output and ignoring the result seems bizarre.",
    "created_at": "2011-07-16T10:24:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11598#issuecomment-161315",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:8'></a>
I've done some tests. You made several changes: setting "check=False" in the constructor; adding a custom `__hash__` function; and using a set and a list at the same time. The combined effect of these is dramatic:

BEFORE

```
sage: time [len(Gamma0(N).as_permutation_group().odd_subgroups()) for N in [11..20]]
CPU times: user 14.26 s, sys: 2.34 s, total: 16.60 s
Wall time: 38.00 s
[8, 32, 0, 32, 32, 32, 0, 128, 8, 128]
```

AFTER

```
sage: time [len(Gamma0(N).as_permutation_group().odd_subgroups()) for N in [11..20]]
CPU times: user 3.35 s, sys: 0.49 s, total: 3.84 s
Wall time: 4.32 s
[8, 32, 0, 32, 32, 32, 0, 128, 8, 128]
```

But one part puzzles me a little. I can see that the first two changes lead to a dramatic speedup, but it's not totally clear to me what the advantage of using a set type for the `bucket` variable is. Could you explain? Moreover, if the set leads to some speedup, then why keep the list as well -- why not just `return list(bucket)` at the end?

Also, you have a random `(` in a comment at line 2478; it seems odd not to disable the check parameter in `one_odd_subgroup`; and the third and fourth lines in the "Testing randomness" doctest in `one_odd_subgroup` seem slightly pointless -- with a random routine, checking that it works is sensible, but running a test on the output and ignoring the result seems bizarre.



---

archive/issue_comments_161316.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [davidloeffler](#comment%3A8):\n> I've done some tests. \n> [...]\n\n \n> but it's not totally clear to me what the advantage of using a set type for the `bucket` variable is. \n\n\nTo check if an element is in a list is linear in the size of the list, but checking if an element is in a set is constant time (up to a critical size). The reason is that Python set are implemented using a hash table.\n\nNow, the test \"if HH not in bucket\" is made exactly \"n\" times in your algorithm and bucket grows quite fast if the centralizer of G is small. The gain of complexity is dramatic.\n\n> why keep the list as well -- why not just `return list(bucket)` at the end?\n\n\nThe way you generate the odd subgroups is somewhat canonical and the output is sorted that way. If the returned value is \"list(bucket)\" then the output is randomized. But, I'm not too much convinced by having at the same time a list and a set containing exactly the same values. It's up to you to make the change.\n\n> it seems odd not to disable the check parameter in `one_odd_subgroup`;\n\n\nIt is not time critical if the function is called once. But if somebody want 100 random odd subgroups then it would be better to disable the check parameter (done in the reviewer patch).\n\n> and the third and fourth lines in the \"Testing randomness\" doctest in `one_odd_subgroup` seem slightly pointless -- with a random routine, checking that it works is sensible, but running a test on the output and ignoring the result seems bizarre.\n\n\nThanks, I changed the test (see the reviewer patch). I am not so familiar with how is tested the random stuff in Sage.",
    "created_at": "2011-07-16T13:47:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11598#issuecomment-161316",
    "user": "https://github.com/videlec"
}
```

<a id='comment:9'></a>
Replying to [davidloeffler](#comment%3A8):
> I've done some tests. 
> [...]

 
> but it's not totally clear to me what the advantage of using a set type for the `bucket` variable is. 


To check if an element is in a list is linear in the size of the list, but checking if an element is in a set is constant time (up to a critical size). The reason is that Python set are implemented using a hash table.

Now, the test "if HH not in bucket" is made exactly "n" times in your algorithm and bucket grows quite fast if the centralizer of G is small. The gain of complexity is dramatic.

> why keep the list as well -- why not just `return list(bucket)` at the end?


The way you generate the odd subgroups is somewhat canonical and the output is sorted that way. If the returned value is "list(bucket)" then the output is randomized. But, I'm not too much convinced by having at the same time a list and a set containing exactly the same values. It's up to you to make the change.

> it seems odd not to disable the check parameter in `one_odd_subgroup`;


It is not time critical if the function is called once. But if somebody want 100 random odd subgroups then it would be better to disable the check parameter (done in the reviewer patch).

> and the third and fourth lines in the "Testing randomness" doctest in `one_odd_subgroup` seem slightly pointless -- with a random routine, checking that it works is sensible, but running a test on the output and ignoring the result seems bizarre.


Thanks, I changed the test (see the reviewer patch). I am not so familiar with how is tested the random stuff in Sage.



---

archive/issue_comments_161317.json:
```json
{
    "body": "Attachment [trac_11598-reviewer.patch](tarball://root/attachments/some-uuid/ticket11598/trac_11598-reviewer.patch) by @videlec created at 2011-07-16 13:47:49",
    "created_at": "2011-07-16T13:47:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11598#issuecomment-161317",
    "user": "https://github.com/videlec"
}
```

Attachment [trac_11598-reviewer.patch](tarball://root/attachments/some-uuid/ticket11598/trac_11598-reviewer.patch) by @videlec created at 2011-07-16 13:47:49



---

archive/issue_comments_161318.json:
```json
{
    "body": "<a id='comment:10'></a>\nI'm not totally sold on the new version of the random doctest either, since it has a positive probability of failing! We can't have that, I'm afraid.\n\nI'm about to upload a new patch. This incorporates all the changes from both my previous patch and yours, together with some more tiny changes: I've cleaned up the docstrings slightly, added a few more doctests (mostly to illustrate how things fail on invalid inputs), and rearranged the order of the validity checks in the constructor function slightly (mainly for code clarity, but also giving a tiny efficiency gain by doing the most expensive test last).\n\nLet me know if you're happy with this version. I'm off to a conference tomorrow morning, so hopefully this will be the last iteration. Thanks for your patience with all this reviewing!",
    "created_at": "2011-07-16T15:13:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11598#issuecomment-161318",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:10'></a>
I'm not totally sold on the new version of the random doctest either, since it has a positive probability of failing! We can't have that, I'm afraid.

I'm about to upload a new patch. This incorporates all the changes from both my previous patch and yours, together with some more tiny changes: I've cleaned up the docstrings slightly, added a few more doctests (mostly to illustrate how things fail on invalid inputs), and rearranged the order of the validity checks in the constructor function slightly (mainly for code clarity, but also giving a tiny efficiency gain by doing the most expensive test last).

Let me know if you're happy with this version. I'm off to a conference tomorrow morning, so hopefully this will be the last iteration. Thanks for your patience with all this reviewing!



---

archive/issue_comments_161319.json:
```json
{
    "body": "Apply only this patch. Patch against 4.7.1.alpha0 + #10335 + #11422.",
    "created_at": "2011-07-16T15:14:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11598#issuecomment-161319",
    "user": "https://github.com/loefflerd"
}
```

Apply only this patch. Patch against 4.7.1.alpha0 + #10335 + #11422.



---

archive/issue_comments_161320.json:
```json
{
    "body": "Changing work_issues from \"\" to \"docstrings\"",
    "created_at": "2011-07-16T18:36:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11598#issuecomment-161320",
    "user": "https://github.com/videlec"
}
```

Changing work_issues from "" to "docstrings"



---

archive/issue_comments_161321.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-07-16T18:36:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11598#issuecomment-161321",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_161322.json:
```json
{
    "body": "<a id='comment:11'></a>\nAttachment [trac_11598-all.patch](tarball://root/attachments/some-uuid/ticket11598/trac_11598-all.patch) by @videlec created at 2011-07-16 18:36:03\n\nReplying to [davidloeffler](#comment%3A10):\n\nI'm perfectly ok with your changes in the code.\n\n> I'm not totally sold on the new version of the random doctest either, since it has a positive probability of failing! We can't have that, I'm afraid.\n\n\nActually, it doesn't. Sage reinitialize the random seed with the same value before performing the tests. It is safe, but perhaps not pedagogic, to let it in the doctest. I vote for letting the current version.\n\nSince you made some changes in the documentation. I quickly reread it and there are some misprints.\n\n- some docstrings start with \"Returns bla bla...\" and others with \"Return bla bla...\". It seems that the Developer guide recommands \"Returns\". \n\n- The first line of the file starts with \"[...] described by the action of the generators of G \". The generators of the group are not attached to G. It would be better to set \"some generators of G\".\n\n- At the begining of the file \"Three couples which which [...]\"\n\n- since the file tests is not compiled in the reference manual, the link to the tests module does not appear. So it is not necessary to use the format :mod:`...`.\n\n- I discussed with some people and the pair of generators which is involved in continued fractions is (l,s2) and not (l,r). Anyway, (l,r) is a nice pair because they generate the semi-group of matrix in SL(2,Z) with non-negative entries.\n\n- In the class ArithmeticSubgroup_Permutation_class, the list of generators does not appear as they should. There is a bug with the latex interpretor. If you write \"`s_2`, `s_3`, `l`, `r`\" then only s_2 is considered for latex compilation.\n\nThat's all.",
    "created_at": "2011-07-16T18:36:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11598#issuecomment-161322",
    "user": "https://github.com/videlec"
}
```

<a id='comment:11'></a>
Attachment [trac_11598-all.patch](tarball://root/attachments/some-uuid/ticket11598/trac_11598-all.patch) by @videlec created at 2011-07-16 18:36:03

Replying to [davidloeffler](#comment%3A10):

I'm perfectly ok with your changes in the code.

> I'm not totally sold on the new version of the random doctest either, since it has a positive probability of failing! We can't have that, I'm afraid.


Actually, it doesn't. Sage reinitialize the random seed with the same value before performing the tests. It is safe, but perhaps not pedagogic, to let it in the doctest. I vote for letting the current version.

Since you made some changes in the documentation. I quickly reread it and there are some misprints.

- some docstrings start with "Returns bla bla..." and others with "Return bla bla...". It seems that the Developer guide recommands "Returns". 

- The first line of the file starts with "[...] described by the action of the generators of G ". The generators of the group are not attached to G. It would be better to set "some generators of G".

- At the begining of the file "Three couples which which [...]"

- since the file tests is not compiled in the reference manual, the link to the tests module does not appear. So it is not necessary to use the format :mod:`...`.

- I discussed with some people and the pair of generators which is involved in continued fractions is (l,s2) and not (l,r). Anyway, (l,r) is a nice pair because they generate the semi-group of matrix in SL(2,Z) with non-negative entries.

- In the class ArithmeticSubgroup_Permutation_class, the list of generators does not appear as they should. There is a bug with the latex interpretor. If you write "`s_2`, `s_3`, `l`, `r`" then only s_2 is considered for latex compilation.

That's all.



---

archive/issue_comments_161323.json:
```json
{
    "body": "Apply over trac_11598-all.patch",
    "created_at": "2011-07-17T07:19:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11598#issuecomment-161323",
    "user": "https://github.com/loefflerd"
}
```

Apply over trac_11598-all.patch



---

archive/issue_comments_161324.json:
```json
{
    "body": "<a id='comment:12'></a>\nAttachment [trac_11598-docfixes.patch](tarball://root/attachments/some-uuid/ticket11598/trac_11598-docfixes.patch) by @loefflerd created at 2011-07-17 07:22:00\n\nHere's a patch which corrects the docstrings as you suggest. If there are any further documentation fixes, can I suggest we agree to keep them for a future ticket?",
    "created_at": "2011-07-17T07:22:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11598#issuecomment-161324",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:12'></a>
Attachment [trac_11598-docfixes.patch](tarball://root/attachments/some-uuid/ticket11598/trac_11598-docfixes.patch) by @loefflerd created at 2011-07-17 07:22:00

Here's a patch which corrects the docstrings as you suggest. If there are any further documentation fixes, can I suggest we agree to keep them for a future ticket?



---

archive/issue_comments_161325.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -4,3 +4,7 @@\n \n Part of a series of tickets: #10335 - #11422 - this one - #5048 - #10453 - #11601.\n \n+**Apply:**\n+1.  [attachment:trac_11598-all.patch]\n+2.  [attachment:trac_11598-docfixes.patch]\n+\n``````\n",
    "created_at": "2011-07-17T07:22:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11598#issuecomment-161325",
    "user": "https://github.com/loefflerd"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -4,3 +4,7 @@
 
 Part of a series of tickets: #10335 - #11422 - this one - #5048 - #10453 - #11601.
 
+**Apply:**
+1.  [attachment:trac_11598-all.patch]
+2.  [attachment:trac_11598-docfixes.patch]
+
``````




---

archive/issue_comments_161326.json:
```json
{
    "body": "Changing work_issues from \"docstrings\" to \"\"",
    "created_at": "2011-07-17T07:22:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11598#issuecomment-161326",
    "user": "https://github.com/loefflerd"
}
```

Changing work_issues from "docstrings" to ""



---

archive/issue_comments_161327.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-07-17T07:22:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11598#issuecomment-161327",
    "user": "https://github.com/loefflerd"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_161328.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-07-17T08:40:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11598#issuecomment-161328",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_036019.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-07-22T17:06:42Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "milestone": "sage-pending",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11598#event-36019"
}
```



---

archive/issue_comments_161329.json:
```json
{
    "body": "Rebased for latest patch at #11422. Apply only this patch.",
    "created_at": "2011-07-30T13:36:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11598#issuecomment-161329",
    "user": "https://github.com/loefflerd"
}
```

Rebased for latest patch at #11422. Apply only this patch.



---

archive/issue_comments_161330.json:
```json
{
    "body": "<a id='comment:15'></a>\nAttachment [trac_11598-foldedrebased.patch](tarball://root/attachments/some-uuid/ticket11598/trac_11598-foldedrebased.patch) by @loefflerd created at 2011-07-30 13:38:32\n\nThe unpickling bug that I recently spotted and fixed at #11422 causes the patches here to fail to merge. I've rebased the relevant patches and qfolded them into a single patch. As there is no change to the actual code, I hope it's fair to leave this as positive review.",
    "created_at": "2011-07-30T13:38:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11598#issuecomment-161330",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:15'></a>
Attachment [trac_11598-foldedrebased.patch](tarball://root/attachments/some-uuid/ticket11598/trac_11598-foldedrebased.patch) by @loefflerd created at 2011-07-30 13:38:32

The unpickling bug that I recently spotted and fixed at #11422 causes the patches here to fail to merge. I've rebased the relevant patches and qfolded them into a single patch. As there is no change to the actual code, I hope it's fair to leave this as positive review.



---

archive/issue_comments_161331.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -5,6 +5,5 @@\n Part of a series of tickets: #10335 - #11422 - this one - #5048 - #10453 - #11601.\n \n **Apply:**\n-1.  [attachment:trac_11598-all.patch]\n-2.  [attachment:trac_11598-docfixes.patch]\n+1.  [attachment:trac_11598-foldedrebased.patch]\n \n``````\n",
    "created_at": "2011-07-30T13:38:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11598#issuecomment-161331",
    "user": "https://github.com/loefflerd"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -5,6 +5,5 @@
 Part of a series of tickets: #10335 - #11422 - this one - #5048 - #10453 - #11601.
 
 **Apply:**
-1.  [attachment:trac_11598-all.patch]
-2.  [attachment:trac_11598-docfixes.patch]
+1.  [attachment:trac_11598-foldedrebased.patch]
 
``````




---

archive/issue_events_036020.json:
```json
{
    "actor": "https://github.com/loefflerd",
    "created_at": "2011-09-22T15:23:25Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "milestone": "sage-pending",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11598#event-36020"
}
```



---

archive/issue_events_036021.json:
```json
{
    "actor": "https://github.com/loefflerd",
    "created_at": "2011-09-22T15:23:25Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "milestone": "sage-4.7.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11598#event-36021"
}
```



---

archive/issue_events_036022.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2011-09-27T17:44:09Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11598#event-36022"
}
```



---

archive/issue_comments_161332.json:
```json
{
    "body": "Changing merged from \"\" to \"sage-4.7.2.alpha3\"",
    "created_at": "2011-09-27T17:44:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11598#issuecomment-161332",
    "user": "https://github.com/nexttime"
}
```

Changing merged from "" to "sage-4.7.2.alpha3"



---

archive/issue_comments_161333.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-09-27T17:44:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11598#issuecomment-161333",
    "user": "https://github.com/nexttime"
}
```

Resolution: fixed
