# Issue 11868: PARI library interface broken by design

archive/issues_011696.json:
```json
{
    "body": "The `t0GEN()`, `t1GEN()`,... system in the PARI interface is broken by design.  Apply [attachment:demonstrate_11868.patch] to see the bug in action.\n\nThe problem is that the conversion of `b` (Python object) to `t1` (PARI GEN) uses the PARI stack and therefore it clobbers the previously computed `t0`.\n\nThere is no urgent need to fix this, as the bug doesn't seem to occur in practice (it was discovered when working on #9334).  It only occurs when:\n1. Calling a PARI function with at least 2 arguments besides `self`.\n2. Apart from the first non-`self` argument, there should be another argument which is a \"complicated\" Python type (e.g. a number field element).\n\nAs work-around, it is easy to defeat condition 2 by converting arguments to pari before calling the function.\n\nThis problem can be solved by using only local variables instead of `t0GEN` etc.\n\nApply: [attachment:trac_11868-t0GEN_new.patch], [attachment:trac_11868-remove_workarounds.patch], [attachment:11868_pari_extra.patch]\n\n**Assignee:** @williamstein\n\n**Keywords:** t0GEN t1GEN gen\n\n**Reviewer:** Jeroen Demeyer\n\n**Author:** Peter Bruin\n\n**Merged:** sage-5.13.beta5\n\n**Dependencies:** #864, #9640, #10018\n\n**Resolution:** fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/11868\n\n",
    "closed_at": "2013-12-05T08:02:06Z",
    "created_at": "2011-09-29T08:42:32Z",
    "labels": [
        "component: interfaces",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.13",
    "title": "PARI library interface broken by design",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11868",
    "user": "https://github.com/jdemeyer"
}
```
The `t0GEN()`, `t1GEN()`,... system in the PARI interface is broken by design.  Apply [attachment:demonstrate_11868.patch] to see the bug in action.

The problem is that the conversion of `b` (Python object) to `t1` (PARI GEN) uses the PARI stack and therefore it clobbers the previously computed `t0`.

There is no urgent need to fix this, as the bug doesn't seem to occur in practice (it was discovered when working on #9334).  It only occurs when:
1. Calling a PARI function with at least 2 arguments besides `self`.
2. Apart from the first non-`self` argument, there should be another argument which is a "complicated" Python type (e.g. a number field element).

As work-around, it is easy to defeat condition 2 by converting arguments to pari before calling the function.

This problem can be solved by using only local variables instead of `t0GEN` etc.

Apply: [attachment:trac_11868-t0GEN_new.patch], [attachment:trac_11868-remove_workarounds.patch], [attachment:11868_pari_extra.patch]

**Assignee:** @williamstein

**Keywords:** t0GEN t1GEN gen

**Reviewer:** Jeroen Demeyer

**Author:** Peter Bruin

**Merged:** sage-5.13.beta5

**Dependencies:** #864, #9640, #10018

**Resolution:** fixed

Issue created by migration from https://trac.sagemath.org/ticket/11868





---

archive/issue_comments_167542.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1 +1,3 @@\n+The `t0GEN()`, `t1GEN()`,... system in the PARI interface is broken by design.  Apply [attachment:demonstrate_11868.patch] to see the bug in action.\n \n+The problem is that the conversion of `b` (Python object) to `t1` (PARI GEN) uses the PARI stack and therefore it clobbers the previously computed `t0`.\n``````\n",
    "created_at": "2011-09-29T08:52:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167542",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1 +1,3 @@
+The `t0GEN()`, `t1GEN()`,... system in the PARI interface is broken by design.  Apply [attachment:demonstrate_11868.patch] to see the bug in action.
 
+The problem is that the conversion of `b` (Python object) to `t1` (PARI GEN) uses the PARI stack and therefore it clobbers the previously computed `t0`.
``````




---

archive/issue_comments_167543.json:
```json
{
    "body": "<a id='comment:1'></a>\nThe `t0GEN()`, `t1GEN()`,... system in the PARI interface is broken by design.  Apply [attachment:demonstrate_11868.patch] to see the bug in action.",
    "created_at": "2011-09-29T08:52:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167543",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:1'></a>
The `t0GEN()`, `t1GEN()`,... system in the PARI interface is broken by design.  Apply [attachment:demonstrate_11868.patch] to see the bug in action.



---

archive/issue_comments_167544.json:
```json
{
    "body": "Patch to *demonstrate* the bug",
    "created_at": "2011-09-29T08:52:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167544",
    "user": "https://github.com/jdemeyer"
}
```

Patch to *demonstrate* the bug



---

archive/attachments_015750.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "demonstrate_11868.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket11868/demonstrate_11868.patch",
    "created_at": "2011-09-29T09:11:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/jdemeyer"
}
```



---

archive/issue_comments_167545.json:
```json
{
    "body": "<a id='comment:2'></a>\n",
    "created_at": "2011-09-29T09:11:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167545",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>




---

archive/issue_comments_167546.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,3 +1,9 @@\n The `t0GEN()`, `t1GEN()`,... system in the PARI interface is broken by design.  Apply [attachment:demonstrate_11868.patch] to see the bug in action.\n \n The problem is that the conversion of `b` (Python object) to `t1` (PARI GEN) uses the PARI stack and therefore it clobbers the previously computed `t0`.\n+\n+There is no urgent need to fix this, as the bug doesn't seem to occur in practice (it was discovered when working on #9334).  It only occurs when:\n+1. Calling a PARI function with at least 2 arguments besides `self`.\n+2. Apart from the first non-`self` argument, there should be another argument which is a \"complicated\" Python type (e.g. a number field element).\n+\n+As work-around, it is easy to defeat condition 2 by converting arguments to pari before calling the function.\n``````\n",
    "created_at": "2011-09-29T09:11:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167546",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,3 +1,9 @@
 The `t0GEN()`, `t1GEN()`,... system in the PARI interface is broken by design.  Apply [attachment:demonstrate_11868.patch] to see the bug in action.
 
 The problem is that the conversion of `b` (Python object) to `t1` (PARI GEN) uses the PARI stack and therefore it clobbers the previously computed `t0`.
+
+There is no urgent need to fix this, as the bug doesn't seem to occur in practice (it was discovered when working on #9334).  It only occurs when:
+1. Calling a PARI function with at least 2 arguments besides `self`.
+2. Apart from the first non-`self` argument, there should be another argument which is a "complicated" Python type (e.g. a number field element).
+
+As work-around, it is easy to defeat condition 2 by converting arguments to pari before calling the function.
``````




---

archive/issue_comments_167547.json:
```json
{
    "body": "Milestone sage-4.7.3 deleted",
    "created_at": "2011-11-03T16:14:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167547",
    "user": "https://github.com/jdemeyer"
}
```

Milestone sage-4.7.3 deleted



---

archive/attachments_015751.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_11868-t0GEN.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket11868/trac_11868-t0GEN.patch",
    "created_at": "2013-11-24T02:26:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/pjbruin"
}
```



---

archive/issue_comments_167548.json:
```json
{
    "body": "eliminate global GEN variables",
    "created_at": "2013-11-24T02:26:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167548",
    "user": "https://github.com/pjbruin"
}
```

eliminate global GEN variables



---

archive/issue_comments_167549.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -7,3 +7,7 @@\n 2. Apart from the first non-`self` argument, there should be another argument which is a \"complicated\" Python type (e.g. a number field element).\n \n As work-around, it is easy to defeat condition 2 by converting arguments to pari before calling the function.\n+\n+This problem can be solved by using only local variables instead of `t0GEN` etc.\n+\n+Apply: [attachment:trac_11868-t0GEN.patch]\n``````\n",
    "created_at": "2013-11-24T02:28:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167549",
    "user": "https://github.com/pjbruin"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -7,3 +7,7 @@
 2. Apart from the first non-`self` argument, there should be another argument which is a "complicated" Python type (e.g. a number field element).
 
 As work-around, it is easy to defeat condition 2 by converting arguments to pari before calling the function.
+
+This problem can be solved by using only local variables instead of `t0GEN` etc.
+
+Apply: [attachment:trac_11868-t0GEN.patch]
``````




---

archive/issue_events_037017.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2013-11-24T02:28:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "milestone": "sage-5.13",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11868#event-37017"
}
```



---

archive/issue_comments_167550.json:
```json
{
    "body": "**Author:** Peter Bruin",
    "created_at": "2013-11-24T02:28:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167550",
    "user": "https://github.com/pjbruin"
}
```

**Author:** Peter Bruin



---

archive/issue_comments_167551.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2013-11-24T02:28:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167551",
    "user": "https://github.com/pjbruin"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_167552.json:
```json
{
    "body": "<a id='comment:5'></a>\nThe patch contains (slightly) more changes than strictly necessary; this is to make life a bit easier for #15185.",
    "created_at": "2013-11-24T02:39:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167552",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:5'></a>
The patch contains (slightly) more changes than strictly necessary; this is to make life a bit easier for #15185.



---

archive/issue_comments_167553.json:
```json
{
    "body": "<a id='comment:6'></a>\nIs it not possible to keep `get_nf()` as a function returning a `GEN` without copying?",
    "created_at": "2013-11-24T17:47:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167553",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>
Is it not possible to keep `get_nf()` as a function returning a `GEN` without copying?



---

archive/issue_comments_167554.json:
```json
{
    "body": "<a id='comment:7'></a>\nI agree with the general approach, but have to check the many details...",
    "created_at": "2013-11-24T17:52:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167554",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>
I agree with the general approach, but have to check the many details...



---

archive/issue_comments_167555.json:
```json
{
    "body": "**Reviewer:** Jeroen Demeyer",
    "created_at": "2013-11-24T17:55:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167555",
    "user": "https://github.com/jdemeyer"
}
```

**Reviewer:** Jeroen Demeyer



---

archive/issue_comments_167556.json:
```json
{
    "body": "<a id='comment:8'></a>\nIn the PARI sources, there are various workarounds for #11868, could you undo these workarounds:\n\n```\ndevel/sage/sage/schemes/elliptic_curves/ell_point.py:        We need to explicitly call ``pari()`` because of :trac:`11868`::\ndevel/sage/sage/rings/number_field/number_field.py:            # to work around Trac #11868 -- Jeroen Demeyer\ndevel/sage/sage/rings/number_field/number_field.py:        # to work around Trac #11868 -- Jeroen Demeyer\ndevel/sage/sage/libs/pari/gen.pyx:            sage: pari(K).nfhilbert(t, t+2)  # not tested, known bug #11868\n```",
    "created_at": "2013-11-24T17:55:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167556",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>
In the PARI sources, there are various workarounds for #11868, could you undo these workarounds:

```
devel/sage/sage/schemes/elliptic_curves/ell_point.py:        We need to explicitly call ``pari()`` because of :trac:`11868`::
devel/sage/sage/rings/number_field/number_field.py:            # to work around Trac #11868 -- Jeroen Demeyer
devel/sage/sage/rings/number_field/number_field.py:        # to work around Trac #11868 -- Jeroen Demeyer
devel/sage/sage/libs/pari/gen.pyx:            sage: pari(K).nfhilbert(t, t+2)  # not tested, known bug #11868
```



---

archive/issue_comments_167557.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2013-11-24T17:55:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167557",
    "user": "https://github.com/jdemeyer"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_167558.json:
```json
{
    "body": "<a id='comment:9'></a>\nMaybe rename `get_nf()` as `_get_nf()` to emphazise that it's a private internal function?",
    "created_at": "2013-11-24T17:56:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167558",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>
Maybe rename `get_nf()` as `_get_nf()` to emphazise that it's a private internal function?



---

archive/issue_comments_167559.json:
```json
{
    "body": "<a id='comment:10'></a>\nOne important \"detail\": it seems this ticket causes a lot more copying of data (because of the `gcopy()` in `cdef GEN toGEN`. That's bad.",
    "created_at": "2013-11-24T18:01:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167559",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>
One important "detail": it seems this ticket causes a lot more copying of data (because of the `gcopy()` in `cdef GEN toGEN`. That's bad.



---

archive/issue_comments_167560.json:
```json
{
    "body": "<a id='comment:11'></a>\nMaybe the right thing to do is to have things like `t0` of type `gen` instead of `GEN` and then using `t0.g` (like we already often do for `self`).",
    "created_at": "2013-11-24T18:02:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167560",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>
Maybe the right thing to do is to have things like `t0` of type `gen` instead of `GEN` and then using `t0.g` (like we already often do for `self`).



---

archive/issue_comments_167561.json:
```json
{
    "body": "<a id='comment:12'></a>\nReplying to [jdemeyer](#comment%3A8):\n> In the PARI sources, there are various workarounds for #11868, could you undo these workarounds:\n\nDone, patch on its way.",
    "created_at": "2013-11-24T22:12:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167561",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:12'></a>
Replying to [jdemeyer](#comment%3A8):
> In the PARI sources, there are various workarounds for #11868, could you undo these workarounds:

Done, patch on its way.



---

archive/issue_comments_167562.json:
```json
{
    "body": "remove workarounds for bug related to global GEN variables",
    "created_at": "2013-11-24T22:12:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167562",
    "user": "https://github.com/pjbruin"
}
```

remove workarounds for bug related to global GEN variables



---

archive/attachments_015752.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_11868-remove_workarounds.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket11868/trac_11868-remove_workarounds.patch",
    "created_at": "2013-11-24T22:13:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/pjbruin"
}
```



---

archive/issue_comments_167563.json:
```json
{
    "body": "<a id='comment:13'></a>\n",
    "created_at": "2013-11-24T22:13:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167563",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:13'></a>




---

archive/issue_comments_167564.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -10,4 +10,4 @@\n \n This problem can be solved by using only local variables instead of `t0GEN` etc.\n \n-Apply: [attachment:trac_11868-t0GEN.patch]\n+Apply: [attachment:trac_11868-t0GEN.patch], [attachment:trac_11868-remove_workarounds.patch]\n``````\n",
    "created_at": "2013-11-24T22:13:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167564",
    "user": "https://github.com/pjbruin"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -10,4 +10,4 @@
 
 This problem can be solved by using only local variables instead of `t0GEN` etc.
 
-Apply: [attachment:trac_11868-t0GEN.patch]
+Apply: [attachment:trac_11868-t0GEN.patch], [attachment:trac_11868-remove_workarounds.patch]
``````




---

archive/issue_comments_167565.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [jdemeyer](#comment%3A6):\n> Is it not possible to keep `get_nf()` as a function returning a `GEN` without copying?\n\nIt is actually even possible that we don't need `get_nf()` at all, since PARI has higher-level functions like `member_pol()`, `member_diff()` etc. that accept various types of number fields.  (Maybe these didn't exist when `gen.pyx` was written?)  I'll look into it.",
    "created_at": "2013-11-24T22:29:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167565",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:14'></a>
Replying to [jdemeyer](#comment%3A6):
> Is it not possible to keep `get_nf()` as a function returning a `GEN` without copying?

It is actually even possible that we don't need `get_nf()` at all, since PARI has higher-level functions like `member_pol()`, `member_diff()` etc. that accept various types of number fields.  (Maybe these didn't exist when `gen.pyx` was written?)  I'll look into it.



---

archive/attachments_015753.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_11868-get_nf.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket11868/trac_11868-get_nf.patch",
    "created_at": "2013-11-25T00:26:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/pjbruin"
}
```



---

archive/issue_comments_167566.json:
```json
{
    "body": "eliminate the gen.get_nf() method",
    "created_at": "2013-11-25T00:26:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167566",
    "user": "https://github.com/pjbruin"
}
```

eliminate the gen.get_nf() method



---

archive/issue_comments_167567.json:
```json
{
    "body": "<a id='comment:15'></a>\nIt turns out that `get_nf()` can indeed be done away with entirely.",
    "created_at": "2013-11-25T00:27:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167567",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:15'></a>
It turns out that `get_nf()` can indeed be done away with entirely.



---

archive/issue_comments_167568.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -10,4 +10,4 @@\n \n This problem can be solved by using only local variables instead of `t0GEN` etc.\n \n-Apply: [attachment:trac_11868-t0GEN.patch], [attachment:trac_11868-remove_workarounds.patch]\n+Apply: [attachment:trac_11868-t0GEN.patch], [attachment:trac_11868-remove_workarounds.patch], [attachment:trac_11868-get_nf.patch]\n``````\n",
    "created_at": "2013-11-25T00:27:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167568",
    "user": "https://github.com/pjbruin"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -10,4 +10,4 @@
 
 This problem can be solved by using only local variables instead of `t0GEN` etc.
 
-Apply: [attachment:trac_11868-t0GEN.patch], [attachment:trac_11868-remove_workarounds.patch]
+Apply: [attachment:trac_11868-t0GEN.patch], [attachment:trac_11868-remove_workarounds.patch], [attachment:trac_11868-get_nf.patch]
``````




---

archive/issue_comments_167569.json:
```json
{
    "body": "<a id='comment:16'></a>\nReplying to [jdemeyer](#comment%3A10):\n> One important \"detail\": it seems this ticket causes a lot more copying of data (because of the `gcopy()` in `cdef GEN toGEN`. That's bad.\n\nIn an earlier attempt I did make the `t0` variables of type `gen`.  I think the reason I changed them back to `GEN` is to decrease the number of `gen` objects that had to be created/deleted.  The (only) price to pay for this is an extra `gcopy()` for Sage objects that are converted via their `_pari_()` method.  This is an extremely common case of course.  I'll have to think some more about this issue.",
    "created_at": "2013-11-25T00:34:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167569",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:16'></a>
Replying to [jdemeyer](#comment%3A10):
> One important "detail": it seems this ticket causes a lot more copying of data (because of the `gcopy()` in `cdef GEN toGEN`. That's bad.

In an earlier attempt I did make the `t0` variables of type `gen`.  I think the reason I changed them back to `GEN` is to decrease the number of `gen` objects that had to be created/deleted.  The (only) price to pay for this is an extra `gcopy()` for Sage objects that are converted via their `_pari_()` method.  This is an extremely common case of course.  I'll have to think some more about this issue.



---

archive/issue_comments_167570.json:
```json
{
    "body": "<a id='comment:17'></a>\nReplying to [pbruin](#comment%3A16):\n> Replying to [jdemeyer](#comment%3A10):\n> > One important \"detail\": it seems this ticket causes a lot more copying of data (because of the `gcopy()` in `cdef GEN toGEN`. That's bad.\n\n> In an earlier attempt I did make the `t0` variables of type `gen`.  I think the reason I changed them back to `GEN` is to decrease the number of `gen` objects that had to be created/deleted.  The (only) price to pay for this is an extra `gcopy()` for Sage objects that are converted via their `_pari_()` method.  This is an extremely common case of course.  I'll have to think some more about this issue.\n\nI don't my suggestion would create more `gen` objects. What usually happens is (with this patch applied):\n- some PARI computation creates a `GEN` on the PARI stack\n- `_new_gen()` calls `deepcopy_to_python_heap` which copies the object to the Python heap and makes it into a `gen` object\n- `toGEN` copies the object back to the PARI stack\n\nMy proposal is essentially removing the last step.",
    "created_at": "2013-11-25T09:39:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167570",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>
Replying to [pbruin](#comment%3A16):
> Replying to [jdemeyer](#comment%3A10):
> > One important "detail": it seems this ticket causes a lot more copying of data (because of the `gcopy()` in `cdef GEN toGEN`. That's bad.

> In an earlier attempt I did make the `t0` variables of type `gen`.  I think the reason I changed them back to `GEN` is to decrease the number of `gen` objects that had to be created/deleted.  The (only) price to pay for this is an extra `gcopy()` for Sage objects that are converted via their `_pari_()` method.  This is an extremely common case of course.  I'll have to think some more about this issue.

I don't my suggestion would create more `gen` objects. What usually happens is (with this patch applied):
- some PARI computation creates a `GEN` on the PARI stack
- `_new_gen()` calls `deepcopy_to_python_heap` which copies the object to the Python heap and makes it into a `gen` object
- `toGEN` copies the object back to the PARI stack

My proposal is essentially removing the last step.



---

archive/issue_comments_167571.json:
```json
{
    "body": "<a id='comment:18'></a>\nI found another problem with your patch: you must not do\n\n```\npari_catch_sig_on()\ncdef GEN t0 = P.toGEN(x)\n```\nbecause you should not call Python code within `sig_on()`/`sig_off()` and `toGEN()` potentially calls Python code. So the `toGEN` should be before `pari_catch_sig_on()`.",
    "created_at": "2013-11-25T09:41:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167571",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>
I found another problem with your patch: you must not do

```
pari_catch_sig_on()
cdef GEN t0 = P.toGEN(x)
```
because you should not call Python code within `sig_on()`/`sig_off()` and `toGEN()` potentially calls Python code. So the `toGEN` should be before `pari_catch_sig_on()`.



---

archive/issue_comments_167572.json:
```json
{
    "body": "<a id='comment:19'></a>\nI have also been thinking about using a `with` statement:\n\n```\ncdef GEN r\nwith to_GEN(s) as t0:\n    pari_catch_sig_on\n    r = gwhatever(t0)\n    pari_catch_sig_off\nreturn new_gen(r)  # Clears stack but doesn't call pari_catch_sig_off()\n```\n\nThen `to_GEN` would be something like\n\n```\ncimport cython\n\n@cython.final\ncdef class to_GEN:\n    cdef gen x\n\n    def `__init__`(to_GEN self, s):\n        self.x = s._pari_()\n\n    cdef inline GEN `__enter__`(to_GEN self):\n        return self.x.g\n\n    cdef inline int `__exit__`(to_GEN self, typ, value, traceback):\n        return 0\n```\n\nThis looks more complicated, but it has the added advantage that the `gen` object for `s` is hidden inside the `to_GEN` class and that the `gen` `x` is kept alive for just the right amount of time. This opens a possibility (not on this ticket) to make `deepcopy_to_python_heap()` lazy, such that it only activates when the PARI stack is cleared.",
    "created_at": "2013-11-25T10:45:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167572",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:19'></a>
I have also been thinking about using a `with` statement:

```
cdef GEN r
with to_GEN(s) as t0:
    pari_catch_sig_on
    r = gwhatever(t0)
    pari_catch_sig_off
return new_gen(r)  # Clears stack but doesn't call pari_catch_sig_off()
```

Then `to_GEN` would be something like

```
cimport cython

@cython.final
cdef class to_GEN:
    cdef gen x

    def `__init__`(to_GEN self, s):
        self.x = s._pari_()

    cdef inline GEN `__enter__`(to_GEN self):
        return self.x.g

    cdef inline int `__exit__`(to_GEN self, typ, value, traceback):
        return 0
```

This looks more complicated, but it has the added advantage that the `gen` object for `s` is hidden inside the `to_GEN` class and that the `gen` `x` is kept alive for just the right amount of time. This opens a possibility (not on this ticket) to make `deepcopy_to_python_heap()` lazy, such that it only activates when the PARI stack is cleared.



---

archive/issue_comments_167573.json:
```json
{
    "body": "<a id='comment:20'></a>\nReplying to [jdemeyer](#comment%3A18):\n> I found another problem with your patch: you must not do\n> \n> ```\n> pari_catch_sig_on()\n> cdef GEN t0 = P.toGEN(x)\n> ```\n> because you should not call Python code within `sig_on()`/`sig_off()` and `toGEN()` potentially calls Python code. So the `toGEN` should be before `pari_catch_sig_on()`.\n\nYes, I also realised in the meantime that this is a problem.  With the current policy of clearing the whole stack at every `new_gen()`, this means that have to wrap every temporary `GEN` in a `gen` if we want it to survive subsequent applications of `toGEN()`.  So I think the best solution is to use `gen` instead of `GEN`, as in[comment:11](#comment%3A11).  (This is essentially very close to what we currently have.)",
    "created_at": "2013-11-25T14:17:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167573",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:20'></a>
Replying to [jdemeyer](#comment%3A18):
> I found another problem with your patch: you must not do
> 
> ```
> pari_catch_sig_on()
> cdef GEN t0 = P.toGEN(x)
> ```
> because you should not call Python code within `sig_on()`/`sig_off()` and `toGEN()` potentially calls Python code. So the `toGEN` should be before `pari_catch_sig_on()`.

Yes, I also realised in the meantime that this is a problem.  With the current policy of clearing the whole stack at every `new_gen()`, this means that have to wrap every temporary `GEN` in a `gen` if we want it to survive subsequent applications of `toGEN()`.  So I think the best solution is to use `gen` instead of `GEN`, as in[comment:11](#comment%3A11).  (This is essentially very close to what we currently have.)



---

archive/issue_comments_167574.json:
```json
{
    "body": "<a id='comment:21'></a>\nReplying to [jdemeyer](#comment%3A17):\n> I don't my suggestion would create more `gen` objects.\n\nIt doesn't create any more `gen` objects than what we have now, but I wanted (and failed for now) to create *fewer* `gen` objects than what we have now.\n> What usually happens is (with this patch applied):\n> - some PARI computation creates a `GEN` on the PARI stack\n> - `_new_gen()` calls `deepcopy_to_python_heap` which copies the object to the Python heap and makes it into a `gen` object\n> - `toGEN` copies the object back to the PARI stack\n> \n> My proposal is essentially removing the last step.\n\nThat is what happens for objects with a `_pari_()` method.  For other objects, my idea was to not create any `gen` object and keep the converted `GEN` on the PARI stack.  Ideally, `toGEN()` should either leave the temporary `GEN` in the Python heap (if it comes from an existing `gen` or from a `_pari_()` method) or on the PARI stack (if it is converted, withouth an intermediate `gen`, from a Python object without a `_pari_()` method).\n\nAnyway, this idea is now defeated for the time being because of[comment:18](#comment%3A18) and[comment:20](#comment%3A20).  To implement it, we would need a more fine-grained way of clearing the PARI stack (only clear what you have used, and leave the rest of the stack alone).\n\nNow working on a new patch in the spirit of[comment:11](#comment%3A11).",
    "created_at": "2013-11-25T14:37:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167574",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:21'></a>
Replying to [jdemeyer](#comment%3A17):
> I don't my suggestion would create more `gen` objects.

It doesn't create any more `gen` objects than what we have now, but I wanted (and failed for now) to create *fewer* `gen` objects than what we have now.
> What usually happens is (with this patch applied):
> - some PARI computation creates a `GEN` on the PARI stack
> - `_new_gen()` calls `deepcopy_to_python_heap` which copies the object to the Python heap and makes it into a `gen` object
> - `toGEN` copies the object back to the PARI stack
> 
> My proposal is essentially removing the last step.

That is what happens for objects with a `_pari_()` method.  For other objects, my idea was to not create any `gen` object and keep the converted `GEN` on the PARI stack.  Ideally, `toGEN()` should either leave the temporary `GEN` in the Python heap (if it comes from an existing `gen` or from a `_pari_()` method) or on the PARI stack (if it is converted, withouth an intermediate `gen`, from a Python object without a `_pari_()` method).

Anyway, this idea is now defeated for the time being because of[comment:18](#comment%3A18) and[comment:20](#comment%3A20).  To implement it, we would need a more fine-grained way of clearing the PARI stack (only clear what you have used, and leave the rest of the stack alone).

Now working on a new patch in the spirit of[comment:11](#comment%3A11).



---

archive/attachments_015754.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_11868-t0GEN_new.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket11868/trac_11868-t0GEN_new.patch",
    "created_at": "2013-11-25T18:33:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/pjbruin"
}
```



---

archive/issue_comments_167575.json:
```json
{
    "body": "eliminate global GEN variables",
    "created_at": "2013-11-25T18:33:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167575",
    "user": "https://github.com/pjbruin"
}
```

eliminate global GEN variables



---

archive/issue_comments_167576.json:
```json
{
    "body": "<a id='comment:22'></a>\n[attachment:trac_11868-t0GEN_new.patch] replaces [attachment:trac_11868-t0GEN.patch] and [attachment:trac_11868-get_nf.patch]\n\nApply trac_11868-t0GEN_new.patch, trac_11868-remove_workarounds.patch",
    "created_at": "2013-11-25T18:36:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167576",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:22'></a>
[attachment:trac_11868-t0GEN_new.patch] replaces [attachment:trac_11868-t0GEN.patch] and [attachment:trac_11868-get_nf.patch]

Apply trac_11868-t0GEN_new.patch, trac_11868-remove_workarounds.patch



---

archive/issue_comments_167577.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -10,4 +10,4 @@\n \n This problem can be solved by using only local variables instead of `t0GEN` etc.\n \n-Apply: [attachment:trac_11868-t0GEN.patch], [attachment:trac_11868-remove_workarounds.patch], [attachment:trac_11868-get_nf.patch]\n+Apply: [attachment:trac_11868-t0GEN_new.patch], [attachment:trac_11868-remove_workarounds.patch]\n``````\n",
    "created_at": "2013-11-25T18:36:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167577",
    "user": "https://github.com/pjbruin"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -10,4 +10,4 @@
 
 This problem can be solved by using only local variables instead of `t0GEN` etc.
 
-Apply: [attachment:trac_11868-t0GEN.patch], [attachment:trac_11868-remove_workarounds.patch], [attachment:trac_11868-get_nf.patch]
+Apply: [attachment:trac_11868-t0GEN_new.patch], [attachment:trac_11868-remove_workarounds.patch]
``````




---

archive/issue_comments_167578.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2013-11-25T18:36:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167578",
    "user": "https://github.com/pjbruin"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_167579.json:
```json
{
    "body": "**Dependencies:** #864",
    "created_at": "2013-11-26T11:17:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167579",
    "user": "https://github.com/jdemeyer"
}
```

**Dependencies:** #864



---

archive/issue_comments_167580.json:
```json
{
    "body": "**Changing dependencies** from \"#864\" to \"#864, #9640, #10018\".",
    "created_at": "2013-11-26T11:19:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167580",
    "user": "https://github.com/jdemeyer"
}
```

**Changing dependencies** from "#864" to "#864, #9640, #10018".



---

archive/issue_comments_167581.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -10,4 +10,4 @@\n \n This problem can be solved by using only local variables instead of `t0GEN` etc.\n \n-Apply: [attachment:trac_11868-t0GEN_new.patch], [attachment:trac_11868-remove_workarounds.patch]\n+Apply: [attachment:trac_11868-t0GEN_new.patch], [attachment:trac_11868-remove_workarounds.patch], [attachment:11868_pari_extra.patch]\n``````\n",
    "created_at": "2013-11-26T14:00:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167581",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -10,4 +10,4 @@
 
 This problem can be solved by using only local variables instead of `t0GEN` etc.
 
-Apply: [attachment:trac_11868-t0GEN_new.patch], [attachment:trac_11868-remove_workarounds.patch]
+Apply: [attachment:trac_11868-t0GEN_new.patch], [attachment:trac_11868-remove_workarounds.patch], [attachment:11868_pari_extra.patch]
``````




---

archive/issue_comments_167582.json:
```json
{
    "body": "<a id='comment:26'></a>\nI added some small changes, see [attachment:11868_pari_extra.patch]. It's not strictly a reviewer patch, since many changes are unrelated to this ticket but just small things I observed while checking your patch.",
    "created_at": "2013-11-26T14:02:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167582",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:26'></a>
I added some small changes, see [attachment:11868_pari_extra.patch]. It's not strictly a reviewer patch, since many changes are unrelated to this ticket but just small things I observed while checking your patch.



---

archive/issue_comments_167583.json:
```json
{
    "body": "<a id='comment:27'></a>\nReplying to [jdemeyer](#comment%3A26):\n> I added some small changes, see [attachment:11868_pari_extra.patch]. It's not strictly a reviewer patch, since many changes are unrelated to this ticket but just small things I observed while checking your patch.\n\nI will look at this more carefully later; just two questions for now:\n- What exactly is a dangerous `malloc()`?\n- In some places (e.g. `isprime()`), doing `P.clear_stack()` instead of `pari_catch_sig_off()` is clearly better because we call a PARI function returing a `GEN` that would otherwise be left on the stack.  In other cases (e.g. `ispseudoprime()`) we only call a PARI function returning `long`; is `clear_stack()` really necessary here?",
    "created_at": "2013-11-26T14:52:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167583",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:27'></a>
Replying to [jdemeyer](#comment%3A26):
> I added some small changes, see [attachment:11868_pari_extra.patch]. It's not strictly a reviewer patch, since many changes are unrelated to this ticket but just small things I observed while checking your patch.

I will look at this more carefully later; just two questions for now:
- What exactly is a dangerous `malloc()`?
- In some places (e.g. `isprime()`), doing `P.clear_stack()` instead of `pari_catch_sig_off()` is clearly better because we call a PARI function returing a `GEN` that would otherwise be left on the stack.  In other cases (e.g. `ispseudoprime()`) we only call a PARI function returning `long`; is `clear_stack()` really necessary here?



---

archive/issue_comments_167584.json:
```json
{
    "body": "<a id='comment:28'></a>\nReplying to [pbruin](#comment%3A27):\n> - What exactly is a dangerous `malloc()`?\n \n`malloc()` inside `sig_on()` is dangerous because an interrupt **during** `malloc()` will almost certainly corrupt the heap. `sage_malloc()` fixes this, but of course PARI doesn't know about `sage_malloc()`.\n\n> is `clear_stack()` really necessary here?\n\nYou're right, it's not needed.\n\nI also noticed that Cython seems unable to optimize `P(x)`, so it might be better to invent a `cdef` method for that (say, `P.togen(x)`) which can be more optimized.",
    "created_at": "2013-11-26T15:21:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167584",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:28'></a>
Replying to [pbruin](#comment%3A27):
> - What exactly is a dangerous `malloc()`?
 
`malloc()` inside `sig_on()` is dangerous because an interrupt **during** `malloc()` will almost certainly corrupt the heap. `sage_malloc()` fixes this, but of course PARI doesn't know about `sage_malloc()`.

> is `clear_stack()` really necessary here?

You're right, it's not needed.

I also noticed that Cython seems unable to optimize `P(x)`, so it might be better to invent a `cdef` method for that (say, `P.togen(x)`) which can be more optimized.



---

archive/issue_comments_167585.json:
```json
{
    "body": "<a id='comment:29'></a>\nReplying to [jdemeyer](#comment%3A28):\n> I also noticed that Cython seems unable to optimize `P(x)`, so it might be better to invent a `cdef` method for that (say, `P.togen(x)`) which can be more optimized.\n\n\nI changed `P(x)` to `objtogen(x)` everywhere, where `objtogen` is a `cdef` function (not method). This gives a noticable speed gain.",
    "created_at": "2013-11-26T17:33:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167585",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:29'></a>
Replying to [jdemeyer](#comment%3A28):
> I also noticed that Cython seems unable to optimize `P(x)`, so it might be better to invent a `cdef` method for that (say, `P.togen(x)`) which can be more optimized.


I changed `P(x)` to `objtogen(x)` everywhere, where `objtogen` is a `cdef` function (not method). This gives a noticable speed gain.



---

archive/issue_comments_167586.json:
```json
{
    "body": "<a id='comment:30'></a>\nIn `objtogen`, I also added an extra case for strings which should be faster now.",
    "created_at": "2013-11-26T17:34:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167586",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:30'></a>
In `objtogen`, I also added an extra case for strings which should be faster now.



---

archive/issue_comments_167587.json:
```json
{
    "body": "<a id='comment:31'></a>\nYour change to `__int__()` and `__long__()` gives a major slowdown due to the importing of `Integer` (a factor of more than 6 for small examples on my system).  The `late_import()` does look ugly; it may be slightly nicer to inline it in `__int__()` and `__long__()` as\n\n```\nglobal Integer \nif Integer is None: \n    import sage.rings.integer \n    Integer = sage.rings.integer.Integer \n```",
    "created_at": "2013-11-26T22:20:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167587",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:31'></a>
Your change to `__int__()` and `__long__()` gives a major slowdown due to the importing of `Integer` (a factor of more than 6 for small examples on my system).  The `late_import()` does look ugly; it may be slightly nicer to inline it in `__int__()` and `__long__()` as

```
global Integer 
if Integer is None: 
    import sage.rings.integer 
    Integer = sage.rings.integer.Integer 
```



---

archive/issue_comments_167588.json:
```json
{
    "body": "<a id='comment:32'></a>\nI agree with the rest of your extra changes.",
    "created_at": "2013-11-26T22:22:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167588",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:32'></a>
I agree with the rest of your extra changes.



---

archive/issue_comments_167589.json:
```json
{
    "body": "<a id='comment:33'></a>\nFor `__int__()`, I also experimented with first doing\n\n```python\n    cdef long i\n    try:\n        pari_catch_sig_on()\n        i = gtolong(self.g)\n        pari_catch_sig_off()\n        return i\n    except PariError:  # overflow\n        pass\n```\nThis gives a speedup of a factor about 2 if there is no overflow, but is very slow if the exception occurs.",
    "created_at": "2013-11-26T22:27:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167589",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:33'></a>
For `__int__()`, I also experimented with first doing

```python
    cdef long i
    try:
        pari_catch_sig_on()
        i = gtolong(self.g)
        pari_catch_sig_off()
        return i
    except PariError:  # overflow
        pass
```
This gives a speedup of a factor about 2 if there is no overflow, but is very slow if the exception occurs.



---

archive/issue_comments_167590.json:
```json
{
    "body": "<a id='comment:34'></a>\n`gtolong` doesn't check for overflow when converting from `t_REAL`. I used your proposal of\n\n```\n        global Integer\n        if Integer is None:\n            import sage.rings.integer\n            Integer = sage.rings.integer.Integer\n        return int(Integer(self))\n```\nand added two doctests for conversion `t_REAL` -> `int`",
    "created_at": "2013-11-27T16:07:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167590",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:34'></a>
`gtolong` doesn't check for overflow when converting from `t_REAL`. I used your proposal of

```
        global Integer
        if Integer is None:
            import sage.rings.integer
            Integer = sage.rings.integer.Integer
        return int(Integer(self))
```
and added two doctests for conversion `t_REAL` -> `int`



---

archive/issue_comments_167591.json:
```json
{
    "body": "<a id='comment:35'></a>\nReplying to [jdemeyer](#comment%3A34):\n> added two doctests for conversion `t_REAL` -> `int`\n\nThose doctests don't seem to involve PARI, or am I missing something?",
    "created_at": "2013-11-27T17:00:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167591",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:35'></a>
Replying to [jdemeyer](#comment%3A34):
> added two doctests for conversion `t_REAL` -> `int`

Those doctests don't seem to involve PARI, or am I missing something?



---

archive/issue_comments_167592.json:
```json
{
    "body": "<a id='comment:36'></a>\nReplying to [pbruin](#comment%3A35):\n> Those doctests don't seem to involve PARI, or am I missing something?\n\nYou're right, I fixed them.",
    "created_at": "2013-11-27T17:03:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167592",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:36'></a>
Replying to [pbruin](#comment%3A35):
> Those doctests don't seem to involve PARI, or am I missing something?

You're right, I fixed them.



---

archive/issue_comments_167593.json:
```json
{
    "body": "<a id='comment:37'></a>\nFor the conversion to `bool`, Cython translates `bool(x)` into a complicated call to the `bool` type.  Using `x != 0` or `PyBool_FromLong(x)` is more efficient.",
    "created_at": "2013-11-27T17:24:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167593",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:37'></a>
For the conversion to `bool`, Cython translates `bool(x)` into a complicated call to the `bool` type.  Using `x != 0` or `PyBool_FromLong(x)` is more efficient.



---

archive/issue_comments_167594.json:
```json
{
    "body": "<a id='comment:38'></a>\nAdded patch\n\n```diff\ndiff --git a/sage/libs/pari/gen.pyx b/sage/libs/pari/gen.pyx\n--- a/sage/libs/pari/gen.pyx\n+++ b/sage/libs/pari/gen.pyx\n@@ -1871,7 +1871,7 @@\n         pari_catch_sig_on()\n         cdef int ret = gequal(a.g, t0.g)\n         pari_catch_sig_off()\n-        return bool(ret)\n+        return ret != 0\n \n     def gequal0(gen a):\n         r\"\"\"\n@@ -1893,7 +1893,7 @@\n         pari_catch_sig_on()\n         cdef int ret = gequal0(a.g)\n         pari_catch_sig_off()\n-        return bool(ret)\n+        return ret != 0\n \n     def gequal_long(gen a, long b):\n         r\"\"\"\n@@ -1920,7 +1920,7 @@\n         pari_catch_sig_on()\n         cdef int ret = gequalsg(b, a.g)\n         pari_catch_sig_off()\n-        return bool(ret)\n+        return ret != 0\n     \n \n     ###########################################\n@@ -1962,7 +1962,7 @@\n         pari_catch_sig_on()\n         cdef long t = signe(gisprime(self.g, flag))\n         P.clear_stack()\n-        return bool(t)\n+        return t != 0\n \n     def qfbhclassno(gen n):\n         r\"\"\"\n@@ -2041,7 +2041,7 @@\n         pari_catch_sig_on()\n         cdef long t = ispseudoprime(self.g, flag)\n         pari_catch_sig_off()\n-        return bool(t)\n+        return t != 0\n \n     def ispower(gen self, k=None):\n         r\"\"\"\n@@ -3209,9 +3209,9 @@\n             [True, False, True, True, True, True, True, True, True, True]\n         \"\"\"\n         pari_catch_sig_on()\n-        b = bool(bittest(x.g, n))\n+        cdef long b = bittest(x.g, n)\n         pari_catch_sig_off()\n-        return b\n+        return b != 0\n     \n     def bitxor(gen x, y):\n         \"\"\"\n@@ -5541,24 +5541,24 @@\n \n     def issquare(gen x, find_root=False):\n         \"\"\"\n-        issquare(x,n): true(1) if x is a square, false(0) if not. If\n-        find_root is given, also returns the exact square root if it was\n-        computed.\n-        \"\"\"\n-        cdef GEN G, t\n+        issquare(x,n): ``True`` if x is a square, ``False`` if not. If\n+        ``find_root`` is given, also returns the exact square root.\n+        \"\"\"\n+        cdef GEN G\n+        cdef long t\n         cdef gen g\n         pari_catch_sig_on()\n         if find_root:\n-            t = gissquareall(x.g, &G)\n-            v = bool(P.new_gen_noclear(t))\n-            if v:\n-                return v, P.new_gen(G)\n+            t = itos(gissquareall(x.g, &G))\n+            if t:\n+                return True, P.new_gen(G)\n             else:\n-                pari_catch_sig_off()\n-                return v, None\n+                P.clear_stack()\n+                return False, None\n         else:\n-            return P.new_gen(gissquare(x.g))\n-\n+            t = itos(gissquare(x.g))\n+            pari_catch_sig_off()\n+            return t != 0\n \n     def issquarefree(gen self):\n         \"\"\"\n@@ -5570,9 +5570,9 @@\n             False\n         \"\"\"\n         pari_catch_sig_on()\n-        t = bool(issquarefree(self.g))\n+        cdef long t = issquarefree(self.g)\n         pari_catch_sig_off()\n-        return t\n+        return t != 0\n \n     def lcm(gen x, y):\n         \"\"\"\n@@ -6203,9 +6203,9 @@\n         \"\"\"\n         cdef gen t0 = objtogen(x)\n         pari_catch_sig_on()\n-        t = bool(oncurve(self.g, t0.g) == 1)\n+        cdef int t = oncurve(self.g, t0.g)\n         pari_catch_sig_off()\n-        return t\n+        return t != 0\n \n     def elllocalred(self, p):\n         r\"\"\"\n@@ -8034,9 +8034,10 @@\n         non-constant polynomial, or False if f is reducible or constant.\n         \"\"\"\n         pari_catch_sig_on()\n-        return bool(self.new_gen(gisirreducible(self.g)))\n-        \n-        \n+        cdef long t = itos(gisirreducible(self.g))\n+        P.clear_stack()\n+        return t != 0\n+\n     def pollead(self, v=-1):\n         \"\"\"\n         self.pollead(v): leading coefficient of polynomial or series self,\n```",
    "created_at": "2013-11-27T20:17:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167594",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:38'></a>
Added patch

```diff
diff --git a/sage/libs/pari/gen.pyx b/sage/libs/pari/gen.pyx
--- a/sage/libs/pari/gen.pyx
+++ b/sage/libs/pari/gen.pyx
@@ -1871,7 +1871,7 @@
         pari_catch_sig_on()
         cdef int ret = gequal(a.g, t0.g)
         pari_catch_sig_off()
-        return bool(ret)
+        return ret != 0
 
     def gequal0(gen a):
         r"""
@@ -1893,7 +1893,7 @@
         pari_catch_sig_on()
         cdef int ret = gequal0(a.g)
         pari_catch_sig_off()
-        return bool(ret)
+        return ret != 0
 
     def gequal_long(gen a, long b):
         r"""
@@ -1920,7 +1920,7 @@
         pari_catch_sig_on()
         cdef int ret = gequalsg(b, a.g)
         pari_catch_sig_off()
-        return bool(ret)
+        return ret != 0
     
 
     ###########################################
@@ -1962,7 +1962,7 @@
         pari_catch_sig_on()
         cdef long t = signe(gisprime(self.g, flag))
         P.clear_stack()
-        return bool(t)
+        return t != 0
 
     def qfbhclassno(gen n):
         r"""
@@ -2041,7 +2041,7 @@
         pari_catch_sig_on()
         cdef long t = ispseudoprime(self.g, flag)
         pari_catch_sig_off()
-        return bool(t)
+        return t != 0
 
     def ispower(gen self, k=None):
         r"""
@@ -3209,9 +3209,9 @@
             [True, False, True, True, True, True, True, True, True, True]
         """
         pari_catch_sig_on()
-        b = bool(bittest(x.g, n))
+        cdef long b = bittest(x.g, n)
         pari_catch_sig_off()
-        return b
+        return b != 0
     
     def bitxor(gen x, y):
         """
@@ -5541,24 +5541,24 @@
 
     def issquare(gen x, find_root=False):
         """
-        issquare(x,n): true(1) if x is a square, false(0) if not. If
-        find_root is given, also returns the exact square root if it was
-        computed.
-        """
-        cdef GEN G, t
+        issquare(x,n): ``True`` if x is a square, ``False`` if not. If
+        ``find_root`` is given, also returns the exact square root.
+        """
+        cdef GEN G
+        cdef long t
         cdef gen g
         pari_catch_sig_on()
         if find_root:
-            t = gissquareall(x.g, &G)
-            v = bool(P.new_gen_noclear(t))
-            if v:
-                return v, P.new_gen(G)
+            t = itos(gissquareall(x.g, &G))
+            if t:
+                return True, P.new_gen(G)
             else:
-                pari_catch_sig_off()
-                return v, None
+                P.clear_stack()
+                return False, None
         else:
-            return P.new_gen(gissquare(x.g))
-
+            t = itos(gissquare(x.g))
+            pari_catch_sig_off()
+            return t != 0
 
     def issquarefree(gen self):
         """
@@ -5570,9 +5570,9 @@
             False
         """
         pari_catch_sig_on()
-        t = bool(issquarefree(self.g))
+        cdef long t = issquarefree(self.g)
         pari_catch_sig_off()
-        return t
+        return t != 0
 
     def lcm(gen x, y):
         """
@@ -6203,9 +6203,9 @@
         """
         cdef gen t0 = objtogen(x)
         pari_catch_sig_on()
-        t = bool(oncurve(self.g, t0.g) == 1)
+        cdef int t = oncurve(self.g, t0.g)
         pari_catch_sig_off()
-        return t
+        return t != 0
 
     def elllocalred(self, p):
         r"""
@@ -8034,9 +8034,10 @@
         non-constant polynomial, or False if f is reducible or constant.
         """
         pari_catch_sig_on()
-        return bool(self.new_gen(gisirreducible(self.g)))
-        
-        
+        cdef long t = itos(gisirreducible(self.g))
+        P.clear_stack()
+        return t != 0
+
     def pollead(self, v=-1):
         """
         self.pollead(v): leading coefficient of polynomial or series self,
```



---

archive/attachments_015755.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "11868_pari_extra.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket11868/11868_pari_extra.patch",
    "created_at": "2013-11-27T21:30:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/pjbruin"
}
```



---

archive/issue_comments_167595.json:
```json
{
    "body": "<a id='comment:39'></a>\nExcellent, I'm happy with the current state.",
    "created_at": "2013-11-27T21:30:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167595",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:39'></a>
Excellent, I'm happy with the current state.



---

archive/issue_comments_167596.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2013-11-27T21:43:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167596",
    "user": "https://github.com/jdemeyer"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_167597.json:
```json
{
    "body": "**Merged:** sage-5.13.beta5",
    "created_at": "2013-12-05T08:02:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167597",
    "user": "https://github.com/jdemeyer"
}
```

**Merged:** sage-5.13.beta5



---

archive/issue_events_037018.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-12-05T08:02:06Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11868#event-37018"
}
```



---

archive/issue_comments_167598.json:
```json
{
    "body": "**Resolution:** fixed",
    "created_at": "2013-12-05T08:02:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11868#issuecomment-167598",
    "user": "https://github.com/jdemeyer"
}
```

**Resolution:** fixed
