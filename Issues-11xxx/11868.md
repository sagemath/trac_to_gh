# Issue 11868: PARI library interface broken by design

archive/issues_011696.json:
```json
{
    "assignees": [],
    "body": "The `t0GEN()`, `t1GEN()`,... system in the PARI interface is broken by design.  Apply [attachment: demonstrate_11868.patch.gz](https://github.com/sagemath/sage/files/ticket11868/demonstrate_11868.patch.gz) to see the bug in action.\n\nThe problem is that the conversion of `b` (Python object) to `t1` (PARI GEN) uses the PARI stack and therefore it clobbers the previously computed `t0`.\n\nThere is no urgent need to fix this, as the bug doesn't seem to occur in practice (it was discovered when working on #9334).  It only occurs when:\n1. Calling a PARI function with at least 2 arguments besides `self`.\n2. Apart from the first non-`self` argument, there should be another argument which is a \"complicated\" Python type (e.g. a number field element).\n\nAs work-around, it is easy to defeat condition 2 by converting arguments to pari before calling the function.\n\nThis problem can be solved by using only local variables instead of `t0GEN` etc.\n\nApply: [[attachment: trac_11868-remove_workarounds.patch.gz](https://github.com/sagemath/sage/files/ticket11868/trac_11868-remove_workarounds.patch.gz), [attachment: 11868_pari_extra.patch.gz](https://github.com/sagemath/sage/files/ticket11868/11868_pari_extra.patch.gz)(https://github.com/sagemath/sage/files/ticket11868/ff96891296ff423eb92647ea76b6905d.gz)\n\nDepends on #864\nDepends on #9640\nDepends on #10018\n\nAssignee: **@williamstein**\n\nKeywords: **t0GEN t1GEN gen**\n\nReviewer: **Jeroen Demeyer**\n\nAuthor: **Peter Bruin**\n\nMerged: **sage-5.13.beta5**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/11868_\n\n",
    "closed_at": "2013-12-05T08:02:06Z",
    "created_at": "2011-09-29T08:42:32Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20interfaces",
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.13",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "PARI library interface broken by design",
    "type": "issue",
    "updated_at": "2013-12-05T08:02:06Z",
    "url": "https://github.com/sagemath/sage/issues/11868",
    "user": "https://github.com/jdemeyer"
}
```
The `t0GEN()`, `t1GEN()`,... system in the PARI interface is broken by design.  Apply [attachment: demonstrate_11868.patch.gz](https://github.com/sagemath/sage/files/ticket11868/demonstrate_11868.patch.gz) to see the bug in action.

The problem is that the conversion of `b` (Python object) to `t1` (PARI GEN) uses the PARI stack and therefore it clobbers the previously computed `t0`.

There is no urgent need to fix this, as the bug doesn't seem to occur in practice (it was discovered when working on #9334).  It only occurs when:
1. Calling a PARI function with at least 2 arguments besides `self`.
2. Apart from the first non-`self` argument, there should be another argument which is a "complicated" Python type (e.g. a number field element).

As work-around, it is easy to defeat condition 2 by converting arguments to pari before calling the function.

This problem can be solved by using only local variables instead of `t0GEN` etc.

Apply: [[attachment: trac_11868-remove_workarounds.patch.gz](https://github.com/sagemath/sage/files/ticket11868/trac_11868-remove_workarounds.patch.gz), [attachment: 11868_pari_extra.patch.gz](https://github.com/sagemath/sage/files/ticket11868/11868_pari_extra.patch.gz)(https://github.com/sagemath/sage/files/ticket11868/ff96891296ff423eb92647ea76b6905d.gz)

Depends on #864
Depends on #9640
Depends on #10018

Assignee: **@williamstein**

Keywords: **t0GEN t1GEN gen**

Reviewer: **Jeroen Demeyer**

Author: **Peter Bruin**

Merged: **sage-5.13.beta5**

_Issue created by migration from https://trac.sagemath.org/ticket/11868_





---

archive/issue_events_146067.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-09-29T08:42:32Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "milestone_number": null,
    "milestone_title": "sage-4.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11868#event-146067"
}
```



---

archive/issue_events_146068.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-09-29T08:42:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20interfaces",
    "label_color": "0000ff",
    "label_name": "component: interfaces",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11868#event-146068"
}
```



---

archive/issue_events_146069.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-09-29T08:42:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11868#event-146069"
}
```



---

archive/issue_events_146070.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-09-29T08:42:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11868#event-146070"
}
```



---

archive/issue_comments_126367.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,3 @@\n+The `t0GEN()`, `t1GEN()`,... system in the PARI interface is broken by design.  Apply [attachment: demonstrate_11868.patch.gz](https://github.com/sagemath/sage/files/ticket11868/demonstrate_11868.patch.gz) to see the bug in action.\n \n+The problem is that the conversion of `b` (Python object) to `t1` (PARI GEN) uses the PARI stack and therefore it clobbers the previously computed `t0`.\n``````\n",
    "created_at": "2011-09-29T08:52:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126367",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,3 @@
+The `t0GEN()`, `t1GEN()`,... system in the PARI interface is broken by design.  Apply [attachment: demonstrate_11868.patch.gz](https://github.com/sagemath/sage/files/ticket11868/demonstrate_11868.patch.gz) to see the bug in action.
 
+The problem is that the conversion of `b` (Python object) to `t1` (PARI GEN) uses the PARI stack and therefore it clobbers the previously computed `t0`.
``````




---

archive/issue_comments_126368.json:
```json
{
    "body": "<a id='comment:1'>Comment 1:</a>\nThe `t0GEN()`, `t1GEN()`,... system in the PARI interface is broken by design.  Apply [attachment: demonstrate_11868.patch.gz](https://github.com/sagemath/sage/files/ticket11868/demonstrate_11868.patch.gz) to see the bug in action.",
    "created_at": "2011-09-29T08:52:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126368",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:1'>Comment 1:</a>
The `t0GEN()`, `t1GEN()`,... system in the PARI interface is broken by design.  Apply [attachment: demonstrate_11868.patch.gz](https://github.com/sagemath/sage/files/ticket11868/demonstrate_11868.patch.gz) to see the bug in action.



---

archive/issue_comments_126369.json:
```json
{
    "body": "Patch to *demonstrate* the bug",
    "created_at": "2011-09-29T08:52:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126369",
    "user": "https://github.com/jdemeyer"
}
```

Patch to *demonstrate* the bug



---

archive/issue_comments_126370.json:
```json
{
    "body": "<a id='comment:2'>Comment 2:</a>\nAttachment: **[demonstrate_11868.patch.gz](https://github.com/sagemath/sage/files/ticket11868/demonstrate_11868.patch.gz)**",
    "created_at": "2011-09-29T09:11:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126370",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'>Comment 2:</a>
Attachment: **[demonstrate_11868.patch.gz](https://github.com/sagemath/sage/files/ticket11868/demonstrate_11868.patch.gz)**



---

archive/issue_comments_126371.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,9 @@\n The `t0GEN()`, `t1GEN()`,... system in the PARI interface is broken by design.  Apply [attachment: demonstrate_11868.patch.gz](https://github.com/sagemath/sage/files/ticket11868/demonstrate_11868.patch.gz) to see the bug in action.\n \n The problem is that the conversion of `b` (Python object) to `t1` (PARI GEN) uses the PARI stack and therefore it clobbers the previously computed `t0`.\n+\n+There is no urgent need to fix this, as the bug doesn't seem to occur in practice (it was discovered when working on #9334).  It only occurs when:\n+1. Calling a PARI function with at least 2 arguments besides `self`.\n+2. Apart from the first non-`self` argument, there should be another argument which is a \"complicated\" Python type (e.g. a number field element).\n+\n+As work-around, it is easy to defeat condition 2 by converting arguments to pari before calling the function.\n``````\n",
    "created_at": "2011-09-29T09:11:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126371",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,9 @@
 The `t0GEN()`, `t1GEN()`,... system in the PARI interface is broken by design.  Apply [attachment: demonstrate_11868.patch.gz](https://github.com/sagemath/sage/files/ticket11868/demonstrate_11868.patch.gz) to see the bug in action.
 
 The problem is that the conversion of `b` (Python object) to `t1` (PARI GEN) uses the PARI stack and therefore it clobbers the previously computed `t0`.
+
+There is no urgent need to fix this, as the bug doesn't seem to occur in practice (it was discovered when working on #9334).  It only occurs when:
+1. Calling a PARI function with at least 2 arguments besides `self`.
+2. Apart from the first non-`self` argument, there should be another argument which is a "complicated" Python type (e.g. a number field element).
+
+As work-around, it is easy to defeat condition 2 by converting arguments to pari before calling the function.
``````




---

archive/issue_comments_126372.json:
```json
{
    "body": "Milestone sage-4.7.3 deleted",
    "created_at": "2011-11-03T16:14:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126372",
    "user": "https://github.com/jdemeyer"
}
```

Milestone sage-4.7.3 deleted



---

archive/issue_events_146071.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-11-03T16:14:43Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "milestone_number": null,
    "milestone_title": "sage-4.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11868#event-146071"
}
```



---

archive/issue_comments_126373.json:
```json
{
    "body": "Attachment: **[trac_11868-t0GEN.patch.gz](https://github.com/sagemath/sage/files/ticket11868/trac_11868-t0GEN.patch.gz)**\n\neliminate global GEN variables",
    "created_at": "2013-11-24T02:26:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126373",
    "user": "https://github.com/pjbruin"
}
```

Attachment: **[trac_11868-t0GEN.patch.gz](https://github.com/sagemath/sage/files/ticket11868/trac_11868-t0GEN.patch.gz)**

eliminate global GEN variables



---

archive/issue_comments_126374.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -7,3 +7,7 @@\n 2. Apart from the first non-`self` argument, there should be another argument which is a \"complicated\" Python type (e.g. a number field element).\n \n As work-around, it is easy to defeat condition 2 by converting arguments to pari before calling the function.\n+\n+This problem can be solved by using only local variables instead of `t0GEN` etc.\n+\n+Apply: [attachment: trac_11868-t0GEN.patch.gz](https://github.com/sagemath/sage/files/ticket11868/trac_11868-t0GEN.patch.gz)\n``````\n",
    "created_at": "2013-11-24T02:28:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126374",
    "user": "https://github.com/pjbruin"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -7,3 +7,7 @@
 2. Apart from the first non-`self` argument, there should be another argument which is a "complicated" Python type (e.g. a number field element).
 
 As work-around, it is easy to defeat condition 2 by converting arguments to pari before calling the function.
+
+This problem can be solved by using only local variables instead of `t0GEN` etc.
+
+Apply: [attachment: trac_11868-t0GEN.patch.gz](https://github.com/sagemath/sage/files/ticket11868/trac_11868-t0GEN.patch.gz)
``````




---

archive/issue_events_146072.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2013-11-24T02:28:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "milestone_number": null,
    "milestone_title": "sage-5.13",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11868#event-146072"
}
```



---

archive/issue_comments_126375.json:
```json
{
    "body": "Author: **Peter Bruin**",
    "created_at": "2013-11-24T02:28:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126375",
    "user": "https://github.com/pjbruin"
}
```

Author: **Peter Bruin**



---

archive/issue_events_146073.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2013-11-24T02:28:27Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11868#event-146073"
}
```



---

archive/issue_comments_126376.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\nThe patch contains (slightly) more changes than strictly necessary; this is to make life a bit easier for #15185.",
    "created_at": "2013-11-24T02:39:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126376",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:5'>Comment 5:</a>
The patch contains (slightly) more changes than strictly necessary; this is to make life a bit easier for #15185.



---

archive/issue_comments_126377.json:
```json
{
    "body": "<a id='comment:6'>Comment 6:</a>\nIs it not possible to keep `get_nf()` as a function returning a `GEN` without copying?",
    "created_at": "2013-11-24T17:47:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126377",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'>Comment 6:</a>
Is it not possible to keep `get_nf()` as a function returning a `GEN` without copying?



---

archive/issue_comments_126378.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\nI agree with the general approach, but have to check the many details...",
    "created_at": "2013-11-24T17:52:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126378",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'>Comment 7:</a>
I agree with the general approach, but have to check the many details...



---

archive/issue_comments_126379.json:
```json
{
    "body": "Reviewer: **Jeroen Demeyer**",
    "created_at": "2013-11-24T17:55:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126379",
    "user": "https://github.com/jdemeyer"
}
```

Reviewer: **Jeroen Demeyer**



---

archive/issue_comments_126380.json:
```json
{
    "body": "<a id='comment:8'>Comment 8:</a>\nIn the PARI sources, there are various workarounds for #11868, could you undo these workarounds:\n\n```\ndevel/sage/sage/schemes/elliptic_curves/ell_point.py:        We need to explicitly call ``pari()`` because of :trac:`11868`::\ndevel/sage/sage/rings/number_field/number_field.py:            # to work around Trac #11868 -- Jeroen Demeyer\ndevel/sage/sage/rings/number_field/number_field.py:        # to work around Trac #11868 -- Jeroen Demeyer\ndevel/sage/sage/libs/pari/gen.pyx:            sage: pari(K).nfhilbert(t, t+2)  # not tested, known bug #11868\n```",
    "created_at": "2013-11-24T17:55:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126380",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'>Comment 8:</a>
In the PARI sources, there are various workarounds for #11868, could you undo these workarounds:

```
devel/sage/sage/schemes/elliptic_curves/ell_point.py:        We need to explicitly call ``pari()`` because of :trac:`11868`::
devel/sage/sage/rings/number_field/number_field.py:            # to work around Trac #11868 -- Jeroen Demeyer
devel/sage/sage/rings/number_field/number_field.py:        # to work around Trac #11868 -- Jeroen Demeyer
devel/sage/sage/libs/pari/gen.pyx:            sage: pari(K).nfhilbert(t, t+2)  # not tested, known bug #11868
```



---

archive/issue_events_146074.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-11-24T17:55:46Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11868#event-146074"
}
```



---

archive/issue_events_146075.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-11-24T17:55:46Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11868#event-146075"
}
```



---

archive/issue_comments_126381.json:
```json
{
    "body": "<a id='comment:9'>Comment 9:</a>\nMaybe rename `get_nf()` as `_get_nf()` to emphazise that it's a private internal function?",
    "created_at": "2013-11-24T17:56:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126381",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'>Comment 9:</a>
Maybe rename `get_nf()` as `_get_nf()` to emphazise that it's a private internal function?



---

archive/issue_comments_126382.json:
```json
{
    "body": "<a id='comment:10'>Comment 10:</a>\nOne important \"detail\": it seems this ticket causes a lot more copying of data (because of the `gcopy()` in `cdef GEN toGEN`. That's bad.",
    "created_at": "2013-11-24T18:01:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126382",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'>Comment 10:</a>
One important "detail": it seems this ticket causes a lot more copying of data (because of the `gcopy()` in `cdef GEN toGEN`. That's bad.



---

archive/issue_comments_126383.json:
```json
{
    "body": "<a id='comment:11'>Comment 11:</a>\nMaybe the right thing to do is to have things like `t0` of type `gen` instead of `GEN` and then using `t0.g` (like we already often do for `self`).",
    "created_at": "2013-11-24T18:02:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126383",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'>Comment 11:</a>
Maybe the right thing to do is to have things like `t0` of type `gen` instead of `GEN` and then using `t0.g` (like we already often do for `self`).



---

archive/issue_comments_126384.json:
```json
{
    "body": "<a id='comment:12'>Comment 12:</a>\nReplying to [@jdemeyer](#comment%3A8):\n> In the PARI sources, there are various workarounds for #11868, could you undo these workarounds:\n\nDone, patch on its way.",
    "created_at": "2013-11-24T22:12:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126384",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:12'>Comment 12:</a>
Replying to [@jdemeyer](#comment%3A8):
> In the PARI sources, there are various workarounds for #11868, could you undo these workarounds:

Done, patch on its way.



---

archive/issue_comments_126385.json:
```json
{
    "body": "remove workarounds for bug related to global GEN variables",
    "created_at": "2013-11-24T22:12:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126385",
    "user": "https://github.com/pjbruin"
}
```

remove workarounds for bug related to global GEN variables



---

archive/issue_comments_126386.json:
```json
{
    "body": "<a id='comment:13'>Comment 13:</a>\nAttachment: **[trac_11868-remove_workarounds.patch.gz](https://github.com/sagemath/sage/files/ticket11868/trac_11868-remove_workarounds.patch.gz)**",
    "created_at": "2013-11-24T22:13:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126386",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:13'>Comment 13:</a>
Attachment: **[trac_11868-remove_workarounds.patch.gz](https://github.com/sagemath/sage/files/ticket11868/trac_11868-remove_workarounds.patch.gz)**



---

archive/issue_comments_126387.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -10,4 +10,4 @@\n \n This problem can be solved by using only local variables instead of `t0GEN` etc.\n \n-Apply: [attachment: trac_11868-t0GEN.patch.gz](https://github.com/sagemath/sage/files/ticket11868/trac_11868-t0GEN.patch.gz)\n+Apply: [[attachment: trac_11868-remove_workarounds.patch.gz](https://github.com/sagemath/sage/files/ticket11868/trac_11868-remove_workarounds.patch.gz)(https://github.com/sagemath/sage/files/ticket11868/5d896f888c6647269b042dc722b17802.gz)\n``````\n",
    "created_at": "2013-11-24T22:13:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126387",
    "user": "https://github.com/pjbruin"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -10,4 +10,4 @@
 
 This problem can be solved by using only local variables instead of `t0GEN` etc.
 
-Apply: [attachment: trac_11868-t0GEN.patch.gz](https://github.com/sagemath/sage/files/ticket11868/trac_11868-t0GEN.patch.gz)
+Apply: [[attachment: trac_11868-remove_workarounds.patch.gz](https://github.com/sagemath/sage/files/ticket11868/trac_11868-remove_workarounds.patch.gz)(https://github.com/sagemath/sage/files/ticket11868/5d896f888c6647269b042dc722b17802.gz)
``````




---

archive/issue_comments_126388.json:
```json
{
    "body": "<a id='comment:14'>Comment 14:</a>\nReplying to [@jdemeyer](#comment%3A6):\n> Is it not possible to keep `get_nf()` as a function returning a `GEN` without copying?\n\nIt is actually even possible that we don't need `get_nf()` at all, since PARI has higher-level functions like `member_pol()`, `member_diff()` etc. that accept various types of number fields.  (Maybe these didn't exist when `gen.pyx` was written?)  I'll look into it.",
    "created_at": "2013-11-24T22:29:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126388",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:14'>Comment 14:</a>
Replying to [@jdemeyer](#comment%3A6):
> Is it not possible to keep `get_nf()` as a function returning a `GEN` without copying?

It is actually even possible that we don't need `get_nf()` at all, since PARI has higher-level functions like `member_pol()`, `member_diff()` etc. that accept various types of number fields.  (Maybe these didn't exist when `gen.pyx` was written?)  I'll look into it.



---

archive/issue_comments_126389.json:
```json
{
    "body": "Attachment: **[trac_11868-get_nf.patch.gz](https://github.com/sagemath/sage/files/ticket11868/trac_11868-get_nf.patch.gz)**\n\neliminate the gen.get_nf() method",
    "created_at": "2013-11-25T00:26:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126389",
    "user": "https://github.com/pjbruin"
}
```

Attachment: **[trac_11868-get_nf.patch.gz](https://github.com/sagemath/sage/files/ticket11868/trac_11868-get_nf.patch.gz)**

eliminate the gen.get_nf() method



---

archive/issue_comments_126390.json:
```json
{
    "body": "<a id='comment:15'>Comment 15:</a>\nIt turns out that `get_nf()` can indeed be done away with entirely.",
    "created_at": "2013-11-25T00:27:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126390",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:15'>Comment 15:</a>
It turns out that `get_nf()` can indeed be done away with entirely.



---

archive/issue_comments_126391.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -10,4 +10,4 @@\n \n This problem can be solved by using only local variables instead of `t0GEN` etc.\n \n-Apply: [[attachment: trac_11868-remove_workarounds.patch.gz](https://github.com/sagemath/sage/files/ticket11868/trac_11868-remove_workarounds.patch.gz)(https://github.com/sagemath/sage/files/ticket11868/5d896f888c6647269b042dc722b17802.gz)\n+Apply: [[attachment: trac_11868-remove_workarounds.patch.gz](https://github.com/sagemath/sage/files/ticket11868/trac_11868-remove_workarounds.patch.gz), [attachment: trac_11868-get_nf.patch.gz](https://github.com/sagemath/sage/files/ticket11868/trac_11868-get_nf.patch.gz)(https://github.com/sagemath/sage/files/ticket11868/5d896f888c6647269b042dc722b17802.gz)\n``````\n",
    "created_at": "2013-11-25T00:27:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126391",
    "user": "https://github.com/pjbruin"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -10,4 +10,4 @@
 
 This problem can be solved by using only local variables instead of `t0GEN` etc.
 
-Apply: [[attachment: trac_11868-remove_workarounds.patch.gz](https://github.com/sagemath/sage/files/ticket11868/trac_11868-remove_workarounds.patch.gz)(https://github.com/sagemath/sage/files/ticket11868/5d896f888c6647269b042dc722b17802.gz)
+Apply: [[attachment: trac_11868-remove_workarounds.patch.gz](https://github.com/sagemath/sage/files/ticket11868/trac_11868-remove_workarounds.patch.gz), [attachment: trac_11868-get_nf.patch.gz](https://github.com/sagemath/sage/files/ticket11868/trac_11868-get_nf.patch.gz)(https://github.com/sagemath/sage/files/ticket11868/5d896f888c6647269b042dc722b17802.gz)
``````




---

archive/issue_comments_126392.json:
```json
{
    "body": "<a id='comment:16'>Comment 16:</a>\nReplying to [@jdemeyer](#comment%3A10):\n> One important \"detail\": it seems this ticket causes a lot more copying of data (because of the `gcopy()` in `cdef GEN toGEN`. That's bad.\n\nIn an earlier attempt I did make the `t0` variables of type `gen`.  I think the reason I changed them back to `GEN` is to decrease the number of `gen` objects that had to be created/deleted.  The (only) price to pay for this is an extra `gcopy()` for Sage objects that are converted via their `_pari_()` method.  This is an extremely common case of course.  I'll have to think some more about this issue.",
    "created_at": "2013-11-25T00:34:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126392",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:16'>Comment 16:</a>
Replying to [@jdemeyer](#comment%3A10):
> One important "detail": it seems this ticket causes a lot more copying of data (because of the `gcopy()` in `cdef GEN toGEN`. That's bad.

In an earlier attempt I did make the `t0` variables of type `gen`.  I think the reason I changed them back to `GEN` is to decrease the number of `gen` objects that had to be created/deleted.  The (only) price to pay for this is an extra `gcopy()` for Sage objects that are converted via their `_pari_()` method.  This is an extremely common case of course.  I'll have to think some more about this issue.



---

archive/issue_comments_126393.json:
```json
{
    "body": "<a id='comment:17'>Comment 17:</a>\nReplying to [@pjbruin](#comment%3A16):\n> Replying to [@jdemeyer](#comment%3A10):\n> > One important \"detail\": it seems this ticket causes a lot more copying of data (because of the `gcopy()` in `cdef GEN toGEN`. That's bad.\n\n> In an earlier attempt I did make the `t0` variables of type `gen`.  I think the reason I changed them back to `GEN` is to decrease the number of `gen` objects that had to be created/deleted.  The (only) price to pay for this is an extra `gcopy()` for Sage objects that are converted via their `_pari_()` method.  This is an extremely common case of course.  I'll have to think some more about this issue.\n\nI don't my suggestion would create more `gen` objects. What usually happens is (with this patch applied):\n- some PARI computation creates a `GEN` on the PARI stack\n- `_new_gen()` calls `deepcopy_to_python_heap` which copies the object to the Python heap and makes it into a `gen` object\n- `toGEN` copies the object back to the PARI stack\n\nMy proposal is essentially removing the last step.",
    "created_at": "2013-11-25T09:39:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126393",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'>Comment 17:</a>
Replying to [@pjbruin](#comment%3A16):
> Replying to [@jdemeyer](#comment%3A10):
> > One important "detail": it seems this ticket causes a lot more copying of data (because of the `gcopy()` in `cdef GEN toGEN`. That's bad.

> In an earlier attempt I did make the `t0` variables of type `gen`.  I think the reason I changed them back to `GEN` is to decrease the number of `gen` objects that had to be created/deleted.  The (only) price to pay for this is an extra `gcopy()` for Sage objects that are converted via their `_pari_()` method.  This is an extremely common case of course.  I'll have to think some more about this issue.

I don't my suggestion would create more `gen` objects. What usually happens is (with this patch applied):
- some PARI computation creates a `GEN` on the PARI stack
- `_new_gen()` calls `deepcopy_to_python_heap` which copies the object to the Python heap and makes it into a `gen` object
- `toGEN` copies the object back to the PARI stack

My proposal is essentially removing the last step.



---

archive/issue_comments_126394.json:
```json
{
    "body": "<a id='comment:18'>Comment 18:</a>\nI found another problem with your patch: you must not do\n\n```\npari_catch_sig_on()\ncdef GEN t0 = P.toGEN(x)\n```\nbecause you should not call Python code within `sig_on()`/`sig_off()` and `toGEN()` potentially calls Python code. So the `toGEN` should be before `pari_catch_sig_on()`.",
    "created_at": "2013-11-25T09:41:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126394",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'>Comment 18:</a>
I found another problem with your patch: you must not do

```
pari_catch_sig_on()
cdef GEN t0 = P.toGEN(x)
```
because you should not call Python code within `sig_on()`/`sig_off()` and `toGEN()` potentially calls Python code. So the `toGEN` should be before `pari_catch_sig_on()`.



---

archive/issue_comments_126395.json:
```json
{
    "body": "<a id='comment:19'>Comment 19:</a>\nI have also been thinking about using a `with` statement:\n\n```\ncdef GEN r\nwith to_GEN(s) as t0:\n    pari_catch_sig_on\n    r = gwhatever(t0)\n    pari_catch_sig_off\nreturn new_gen(r)  # Clears stack but doesn't call pari_catch_sig_off()\n```\n\nThen `to_GEN` would be something like\n\n```\ncimport cython\n\n@cython.final\ncdef class to_GEN:\n    cdef gen x\n\n    def __init__(to_GEN self, s):\n        self.x = s._pari_()\n\n    cdef inline GEN __enter__(to_GEN self):\n        return self.x.g\n\n    cdef inline int __exit__(to_GEN self, typ, value, traceback):\n        return 0\n```\n\nThis looks more complicated, but it has the added advantage that the `gen` object for `s` is hidden inside the `to_GEN` class and that the `gen` `x` is kept alive for just the right amount of time. This opens a possibility (not on this ticket) to make `deepcopy_to_python_heap()` lazy, such that it only activates when the PARI stack is cleared.",
    "created_at": "2013-11-25T10:45:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126395",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:19'>Comment 19:</a>
I have also been thinking about using a `with` statement:

```
cdef GEN r
with to_GEN(s) as t0:
    pari_catch_sig_on
    r = gwhatever(t0)
    pari_catch_sig_off
return new_gen(r)  # Clears stack but doesn't call pari_catch_sig_off()
```

Then `to_GEN` would be something like

```
cimport cython

@cython.final
cdef class to_GEN:
    cdef gen x

    def __init__(to_GEN self, s):
        self.x = s._pari_()

    cdef inline GEN __enter__(to_GEN self):
        return self.x.g

    cdef inline int __exit__(to_GEN self, typ, value, traceback):
        return 0
```

This looks more complicated, but it has the added advantage that the `gen` object for `s` is hidden inside the `to_GEN` class and that the `gen` `x` is kept alive for just the right amount of time. This opens a possibility (not on this ticket) to make `deepcopy_to_python_heap()` lazy, such that it only activates when the PARI stack is cleared.



---

archive/issue_comments_126396.json:
```json
{
    "body": "<a id='comment:20'>Comment 20:</a>\nReplying to [@jdemeyer](#comment%3A18):\n> I found another problem with your patch: you must not do\n> \n> ```\n> pari_catch_sig_on()\n> cdef GEN t0 = P.toGEN(x)\n> ```\n> because you should not call Python code within `sig_on()`/`sig_off()` and `toGEN()` potentially calls Python code. So the `toGEN` should be before `pari_catch_sig_on()`.\n\nYes, I also realised in the meantime that this is a problem.  With the current policy of clearing the whole stack at every `new_gen()`, this means that have to wrap every temporary `GEN` in a `gen` if we want it to survive subsequent applications of `toGEN()`.  So I think the best solution is to use `gen` instead of `GEN`, as in [comment:11](#comment%3A11).  (This is essentially very close to what we currently have.)",
    "created_at": "2013-11-25T14:17:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126396",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:20'>Comment 20:</a>
Replying to [@jdemeyer](#comment%3A18):
> I found another problem with your patch: you must not do
> 
> ```
> pari_catch_sig_on()
> cdef GEN t0 = P.toGEN(x)
> ```
> because you should not call Python code within `sig_on()`/`sig_off()` and `toGEN()` potentially calls Python code. So the `toGEN` should be before `pari_catch_sig_on()`.

Yes, I also realised in the meantime that this is a problem.  With the current policy of clearing the whole stack at every `new_gen()`, this means that have to wrap every temporary `GEN` in a `gen` if we want it to survive subsequent applications of `toGEN()`.  So I think the best solution is to use `gen` instead of `GEN`, as in [comment:11](#comment%3A11).  (This is essentially very close to what we currently have.)



---

archive/issue_comments_126397.json:
```json
{
    "body": "<a id='comment:21'>Comment 21:</a>\nReplying to [@jdemeyer](#comment%3A17):\n> I don't my suggestion would create more `gen` objects.\n\nIt doesn't create any more `gen` objects than what we have now, but I wanted (and failed for now) to create *fewer* `gen` objects than what we have now.\n> What usually happens is (with this patch applied):\n> - some PARI computation creates a `GEN` on the PARI stack\n> - `_new_gen()` calls `deepcopy_to_python_heap` which copies the object to the Python heap and makes it into a `gen` object\n> - `toGEN` copies the object back to the PARI stack\n> \n> My proposal is essentially removing the last step.\n\nThat is what happens for objects with a `_pari_()` method.  For other objects, my idea was to not create any `gen` object and keep the converted `GEN` on the PARI stack.  Ideally, `toGEN()` should either leave the temporary `GEN` in the Python heap (if it comes from an existing `gen` or from a `_pari_()` method) or on the PARI stack (if it is converted, withouth an intermediate `gen`, from a Python object without a `_pari_()` method).\n\nAnyway, this idea is now defeated for the time being because of [comment:18](#comment%3A18) and [comment:20](#comment%3A20).  To implement it, we would need a more fine-grained way of clearing the PARI stack (only clear what you have used, and leave the rest of the stack alone).\n\nNow working on a new patch in the spirit of [comment:11](#comment%3A11).",
    "created_at": "2013-11-25T14:37:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126397",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:21'>Comment 21:</a>
Replying to [@jdemeyer](#comment%3A17):
> I don't my suggestion would create more `gen` objects.

It doesn't create any more `gen` objects than what we have now, but I wanted (and failed for now) to create *fewer* `gen` objects than what we have now.
> What usually happens is (with this patch applied):
> - some PARI computation creates a `GEN` on the PARI stack
> - `_new_gen()` calls `deepcopy_to_python_heap` which copies the object to the Python heap and makes it into a `gen` object
> - `toGEN` copies the object back to the PARI stack
> 
> My proposal is essentially removing the last step.

That is what happens for objects with a `_pari_()` method.  For other objects, my idea was to not create any `gen` object and keep the converted `GEN` on the PARI stack.  Ideally, `toGEN()` should either leave the temporary `GEN` in the Python heap (if it comes from an existing `gen` or from a `_pari_()` method) or on the PARI stack (if it is converted, withouth an intermediate `gen`, from a Python object without a `_pari_()` method).

Anyway, this idea is now defeated for the time being because of [comment:18](#comment%3A18) and [comment:20](#comment%3A20).  To implement it, we would need a more fine-grained way of clearing the PARI stack (only clear what you have used, and leave the rest of the stack alone).

Now working on a new patch in the spirit of [comment:11](#comment%3A11).



---

archive/issue_comments_126398.json:
```json
{
    "body": "Attachment: **[trac_11868-t0GEN_new.patch.gz](https://github.com/sagemath/sage/files/ticket11868/trac_11868-t0GEN_new.patch.gz)**\n\neliminate global GEN variables",
    "created_at": "2013-11-25T18:33:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126398",
    "user": "https://github.com/pjbruin"
}
```

Attachment: **[trac_11868-t0GEN_new.patch.gz](https://github.com/sagemath/sage/files/ticket11868/trac_11868-t0GEN_new.patch.gz)**

eliminate global GEN variables



---

archive/issue_comments_126399.json:
```json
{
    "body": "<a id='comment:22'>Comment 22:</a>\n[replaces [attachment: trac_11868-t0GEN.patch.gz](https://github.com/sagemath/sage/files/ticket11868/trac_11868-t0GEN.patch.gz) and [attachment: trac_11868-get_nf.patch.gz](https://github.com/sagemath/sage/files/ticket11868/trac_11868-get_nf.patch.gz)(https://github.com/sagemath/sage/files/ticket11868/2ff035df75d63bd15b85f1caf91bd095.gz)\n\nApply trac_11868-t0GEN_new.patch, trac_11868-remove_workarounds.patch",
    "created_at": "2013-11-25T18:36:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126399",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:22'>Comment 22:</a>
[replaces [attachment: trac_11868-t0GEN.patch.gz](https://github.com/sagemath/sage/files/ticket11868/trac_11868-t0GEN.patch.gz) and [attachment: trac_11868-get_nf.patch.gz](https://github.com/sagemath/sage/files/ticket11868/trac_11868-get_nf.patch.gz)(https://github.com/sagemath/sage/files/ticket11868/2ff035df75d63bd15b85f1caf91bd095.gz)

Apply trac_11868-t0GEN_new.patch, trac_11868-remove_workarounds.patch



---

archive/issue_comments_126400.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -10,4 +10,4 @@\n \n This problem can be solved by using only local variables instead of `t0GEN` etc.\n \n-Apply: [[attachment: trac_11868-remove_workarounds.patch.gz](https://github.com/sagemath/sage/files/ticket11868/trac_11868-remove_workarounds.patch.gz), [attachment: trac_11868-get_nf.patch.gz](https://github.com/sagemath/sage/files/ticket11868/trac_11868-get_nf.patch.gz)(https://github.com/sagemath/sage/files/ticket11868/5d896f888c6647269b042dc722b17802.gz)\n+Apply: [[attachment: trac_11868-remove_workarounds.patch.gz](https://github.com/sagemath/sage/files/ticket11868/trac_11868-remove_workarounds.patch.gz)(https://github.com/sagemath/sage/files/ticket11868/ff96891296ff423eb92647ea76b6905d.gz)\n``````\n",
    "created_at": "2013-11-25T18:36:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126400",
    "user": "https://github.com/pjbruin"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -10,4 +10,4 @@
 
 This problem can be solved by using only local variables instead of `t0GEN` etc.
 
-Apply: [[attachment: trac_11868-remove_workarounds.patch.gz](https://github.com/sagemath/sage/files/ticket11868/trac_11868-remove_workarounds.patch.gz), [attachment: trac_11868-get_nf.patch.gz](https://github.com/sagemath/sage/files/ticket11868/trac_11868-get_nf.patch.gz)(https://github.com/sagemath/sage/files/ticket11868/5d896f888c6647269b042dc722b17802.gz)
+Apply: [[attachment: trac_11868-remove_workarounds.patch.gz](https://github.com/sagemath/sage/files/ticket11868/trac_11868-remove_workarounds.patch.gz)(https://github.com/sagemath/sage/files/ticket11868/ff96891296ff423eb92647ea76b6905d.gz)
``````




---

archive/issue_events_146076.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2013-11-25T18:36:04Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11868#event-146076"
}
```



---

archive/issue_events_146077.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2013-11-25T18:36:04Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11868#event-146077"
}
```



---

archive/issue_comments_126401.json:
```json
{
    "body": "Dependencies: **#864**",
    "created_at": "2013-11-26T11:17:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126401",
    "user": "https://github.com/jdemeyer"
}
```

Dependencies: **#864**



---

archive/issue_comments_126402.json:
```json
{
    "body": "Changed dependencies from **#864** to **#864, #9640, #10018**",
    "created_at": "2013-11-26T11:19:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126402",
    "user": "https://github.com/jdemeyer"
}
```

Changed dependencies from **#864** to **#864, #9640, #10018**



---

archive/issue_comments_126403.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -10,4 +10,4 @@\n \n This problem can be solved by using only local variables instead of `t0GEN` etc.\n \n-Apply: [[attachment: trac_11868-remove_workarounds.patch.gz](https://github.com/sagemath/sage/files/ticket11868/trac_11868-remove_workarounds.patch.gz)(https://github.com/sagemath/sage/files/ticket11868/ff96891296ff423eb92647ea76b6905d.gz)\n+Apply: [[attachment: trac_11868-remove_workarounds.patch.gz](https://github.com/sagemath/sage/files/ticket11868/trac_11868-remove_workarounds.patch.gz), [attachment: 11868_pari_extra.patch.gz](https://github.com/sagemath/sage/files/ticket11868/11868_pari_extra.patch.gz)(https://github.com/sagemath/sage/files/ticket11868/ff96891296ff423eb92647ea76b6905d.gz)\n``````\n",
    "created_at": "2013-11-26T14:00:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126403",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -10,4 +10,4 @@
 
 This problem can be solved by using only local variables instead of `t0GEN` etc.
 
-Apply: [[attachment: trac_11868-remove_workarounds.patch.gz](https://github.com/sagemath/sage/files/ticket11868/trac_11868-remove_workarounds.patch.gz)(https://github.com/sagemath/sage/files/ticket11868/ff96891296ff423eb92647ea76b6905d.gz)
+Apply: [[attachment: trac_11868-remove_workarounds.patch.gz](https://github.com/sagemath/sage/files/ticket11868/trac_11868-remove_workarounds.patch.gz), [attachment: 11868_pari_extra.patch.gz](https://github.com/sagemath/sage/files/ticket11868/11868_pari_extra.patch.gz)(https://github.com/sagemath/sage/files/ticket11868/ff96891296ff423eb92647ea76b6905d.gz)
``````




---

archive/issue_comments_126404.json:
```json
{
    "body": "<a id='comment:26'>Comment 26:</a>\nI added some small changes, see [attachment: 11868_pari_extra.patch.gz](https://github.com/sagemath/sage/files/ticket11868/11868_pari_extra.patch.gz). It's not strictly a reviewer patch, since many changes are unrelated to this ticket but just small things I observed while checking your patch.",
    "created_at": "2013-11-26T14:02:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126404",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:26'>Comment 26:</a>
I added some small changes, see [attachment: 11868_pari_extra.patch.gz](https://github.com/sagemath/sage/files/ticket11868/11868_pari_extra.patch.gz). It's not strictly a reviewer patch, since many changes are unrelated to this ticket but just small things I observed while checking your patch.



---

archive/issue_comments_126405.json:
```json
{
    "body": "<a id='comment:27'>Comment 27:</a>\nReplying to [@jdemeyer](#comment%3A26):\n> I added some small changes, see [attachment: 11868_pari_extra.patch.gz](https://github.com/sagemath/sage/files/ticket11868/11868_pari_extra.patch.gz). It's not strictly a reviewer patch, since many changes are unrelated to this ticket but just small things I observed while checking your patch.\n\nI will look at this more carefully later; just two questions for now:\n- What exactly is a dangerous `malloc()`?\n- In some places (e.g. `isprime()`), doing `P.clear_stack()` instead of `pari_catch_sig_off()` is clearly better because we call a PARI function returing a `GEN` that would otherwise be left on the stack.  In other cases (e.g. `ispseudoprime()`) we only call a PARI function returning `long`; is `clear_stack()` really necessary here?",
    "created_at": "2013-11-26T14:52:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126405",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:27'>Comment 27:</a>
Replying to [@jdemeyer](#comment%3A26):
> I added some small changes, see [attachment: 11868_pari_extra.patch.gz](https://github.com/sagemath/sage/files/ticket11868/11868_pari_extra.patch.gz). It's not strictly a reviewer patch, since many changes are unrelated to this ticket but just small things I observed while checking your patch.

I will look at this more carefully later; just two questions for now:
- What exactly is a dangerous `malloc()`?
- In some places (e.g. `isprime()`), doing `P.clear_stack()` instead of `pari_catch_sig_off()` is clearly better because we call a PARI function returing a `GEN` that would otherwise be left on the stack.  In other cases (e.g. `ispseudoprime()`) we only call a PARI function returning `long`; is `clear_stack()` really necessary here?



---

archive/issue_comments_126406.json:
```json
{
    "body": "<a id='comment:28'>Comment 28:</a>\nReplying to [@pjbruin](#comment%3A27):\n> - What exactly is a dangerous `malloc()`?\n\n`malloc()` inside `sig_on()` is dangerous because an interrupt **during** `malloc()` will almost certainly corrupt the heap. `sage_malloc()` fixes this, but of course PARI doesn't know about `sage_malloc()`.\n\n> is `clear_stack()` really necessary here?\n\nYou're right, it's not needed.\n\nI also noticed that Cython seems unable to optimize `P(x)`, so it might be better to invent a `cdef` method for that (say, `P.togen(x)`) which can be more optimized.",
    "created_at": "2013-11-26T15:21:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126406",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:28'>Comment 28:</a>
Replying to [@pjbruin](#comment%3A27):
> - What exactly is a dangerous `malloc()`?

`malloc()` inside `sig_on()` is dangerous because an interrupt **during** `malloc()` will almost certainly corrupt the heap. `sage_malloc()` fixes this, but of course PARI doesn't know about `sage_malloc()`.

> is `clear_stack()` really necessary here?

You're right, it's not needed.

I also noticed that Cython seems unable to optimize `P(x)`, so it might be better to invent a `cdef` method for that (say, `P.togen(x)`) which can be more optimized.



---

archive/issue_comments_126407.json:
```json
{
    "body": "<a id='comment:29'>Comment 29:</a>\nReplying to [@jdemeyer](#comment%3A28):\n> I also noticed that Cython seems unable to optimize `P(x)`, so it might be better to invent a `cdef` method for that (say, `P.togen(x)`) which can be more optimized.\n\nI changed `P(x)` to `objtogen(x)` everywhere, where `objtogen` is a `cdef` function (not method). This gives a noticable speed gain.",
    "created_at": "2013-11-26T17:33:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126407",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:29'>Comment 29:</a>
Replying to [@jdemeyer](#comment%3A28):
> I also noticed that Cython seems unable to optimize `P(x)`, so it might be better to invent a `cdef` method for that (say, `P.togen(x)`) which can be more optimized.

I changed `P(x)` to `objtogen(x)` everywhere, where `objtogen` is a `cdef` function (not method). This gives a noticable speed gain.



---

archive/issue_comments_126408.json:
```json
{
    "body": "<a id='comment:30'>Comment 30:</a>\nIn `objtogen`, I also added an extra case for strings which should be faster now.",
    "created_at": "2013-11-26T17:34:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126408",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:30'>Comment 30:</a>
In `objtogen`, I also added an extra case for strings which should be faster now.



---

archive/issue_comments_126409.json:
```json
{
    "body": "<a id='comment:31'>Comment 31:</a>\nYour change to `__int__()` and `__long__()` gives a major slowdown due to the importing of `Integer` (a factor of more than 6 for small examples on my system).  The `late_import()` does look ugly; it may be slightly nicer to inline it in `__int__()` and `__long__()` as\n\n```\nglobal Integer \nif Integer is None: \n    import sage.rings.integer \n    Integer = sage.rings.integer.Integer \n```",
    "created_at": "2013-11-26T22:20:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126409",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:31'>Comment 31:</a>
Your change to `__int__()` and `__long__()` gives a major slowdown due to the importing of `Integer` (a factor of more than 6 for small examples on my system).  The `late_import()` does look ugly; it may be slightly nicer to inline it in `__int__()` and `__long__()` as

```
global Integer 
if Integer is None: 
    import sage.rings.integer 
    Integer = sage.rings.integer.Integer 
```



---

archive/issue_comments_126410.json:
```json
{
    "body": "<a id='comment:32'>Comment 32:</a>\nI agree with the rest of your extra changes.",
    "created_at": "2013-11-26T22:22:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126410",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:32'>Comment 32:</a>
I agree with the rest of your extra changes.



---

archive/issue_comments_126411.json:
```json
{
    "body": "<a id='comment:33'>Comment 33:</a>\nFor `__int__()`, I also experimented with first doing\n\n```python\n    cdef long i\n    try:\n        pari_catch_sig_on()\n        i = gtolong(self.g)\n        pari_catch_sig_off()\n        return i\n    except PariError:  # overflow\n        pass\n```\nThis gives a speedup of a factor about 2 if there is no overflow, but is very slow if the exception occurs.",
    "created_at": "2013-11-26T22:27:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126411",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:33'>Comment 33:</a>
For `__int__()`, I also experimented with first doing

```python
    cdef long i
    try:
        pari_catch_sig_on()
        i = gtolong(self.g)
        pari_catch_sig_off()
        return i
    except PariError:  # overflow
        pass
```
This gives a speedup of a factor about 2 if there is no overflow, but is very slow if the exception occurs.



---

archive/issue_comments_126412.json:
```json
{
    "body": "<a id='comment:34'>Comment 34:</a>\n`gtolong` doesn't check for overflow when converting from `t_REAL`. I used your proposal of\n\n```\n        global Integer\n        if Integer is None:\n            import sage.rings.integer\n            Integer = sage.rings.integer.Integer\n        return int(Integer(self))\n```\nand added two doctests for conversion `t_REAL` -> `int`",
    "created_at": "2013-11-27T16:07:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126412",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:34'>Comment 34:</a>
`gtolong` doesn't check for overflow when converting from `t_REAL`. I used your proposal of

```
        global Integer
        if Integer is None:
            import sage.rings.integer
            Integer = sage.rings.integer.Integer
        return int(Integer(self))
```
and added two doctests for conversion `t_REAL` -> `int`



---

archive/issue_comments_126413.json:
```json
{
    "body": "<a id='comment:35'>Comment 35:</a>\nReplying to [@jdemeyer](#comment%3A34):\n> added two doctests for conversion `t_REAL` -> `int`\n\nThose doctests don't seem to involve PARI, or am I missing something?",
    "created_at": "2013-11-27T17:00:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126413",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:35'>Comment 35:</a>
Replying to [@jdemeyer](#comment%3A34):
> added two doctests for conversion `t_REAL` -> `int`

Those doctests don't seem to involve PARI, or am I missing something?



---

archive/issue_comments_126414.json:
```json
{
    "body": "<a id='comment:36'>Comment 36:</a>\nReplying to [@pjbruin](#comment%3A35):\n> Those doctests don't seem to involve PARI, or am I missing something?\n\nYou're right, I fixed them.",
    "created_at": "2013-11-27T17:03:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126414",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:36'>Comment 36:</a>
Replying to [@pjbruin](#comment%3A35):
> Those doctests don't seem to involve PARI, or am I missing something?

You're right, I fixed them.



---

archive/issue_comments_126415.json:
```json
{
    "body": "<a id='comment:37'>Comment 37:</a>\nFor the conversion to `bool`, Cython translates `bool(x)` into a complicated call to the `bool` type.  Using `x != 0` or `PyBool_FromLong(x)` is more efficient.",
    "created_at": "2013-11-27T17:24:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126415",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:37'>Comment 37:</a>
For the conversion to `bool`, Cython translates `bool(x)` into a complicated call to the `bool` type.  Using `x != 0` or `PyBool_FromLong(x)` is more efficient.



---

archive/issue_comments_126416.json:
```json
{
    "body": "<a id='comment:38'>Comment 38:</a>\nAdded patch\n\n```diff\ndiff --git a/sage/libs/pari/gen.pyx b/sage/libs/pari/gen.pyx\n--- a/sage/libs/pari/gen.pyx\n+++ b/sage/libs/pari/gen.pyx\n@@ -1871,7 +1871,7 @@\n         pari_catch_sig_on()\n         cdef int ret = gequal(a.g, t0.g)\n         pari_catch_sig_off()\n-        return bool(ret)\n+        return ret != 0\n \n     def gequal0(gen a):\n         r\"\"\"\n@@ -1893,7 +1893,7 @@\n         pari_catch_sig_on()\n         cdef int ret = gequal0(a.g)\n         pari_catch_sig_off()\n-        return bool(ret)\n+        return ret != 0\n \n     def gequal_long(gen a, long b):\n         r\"\"\"\n@@ -1920,7 +1920,7 @@\n         pari_catch_sig_on()\n         cdef int ret = gequalsg(b, a.g)\n         pari_catch_sig_off()\n-        return bool(ret)\n+        return ret != 0\n     \n \n     ###########################################\n@@ -1962,7 +1962,7 @@\n         pari_catch_sig_on()\n         cdef long t = signe(gisprime(self.g, flag))\n         P.clear_stack()\n-        return bool(t)\n+        return t != 0\n \n     def qfbhclassno(gen n):\n         r\"\"\"\n@@ -2041,7 +2041,7 @@\n         pari_catch_sig_on()\n         cdef long t = ispseudoprime(self.g, flag)\n         pari_catch_sig_off()\n-        return bool(t)\n+        return t != 0\n \n     def ispower(gen self, k=None):\n         r\"\"\"\n@@ -3209,9 +3209,9 @@\n             [True, False, True, True, True, True, True, True, True, True]\n         \"\"\"\n         pari_catch_sig_on()\n-        b = bool(bittest(x.g, n))\n+        cdef long b = bittest(x.g, n)\n         pari_catch_sig_off()\n-        return b\n+        return b != 0\n     \n     def bitxor(gen x, y):\n         \"\"\"\n@@ -5541,24 +5541,24 @@\n \n     def issquare(gen x, find_root=False):\n         \"\"\"\n-        issquare(x,n): true(1) if x is a square, false(0) if not. If\n-        find_root is given, also returns the exact square root if it was\n-        computed.\n-        \"\"\"\n-        cdef GEN G, t\n+        issquare(x,n): ``True`` if x is a square, ``False`` if not. If\n+        ``find_root`` is given, also returns the exact square root.\n+        \"\"\"\n+        cdef GEN G\n+        cdef long t\n         cdef gen g\n         pari_catch_sig_on()\n         if find_root:\n-            t = gissquareall(x.g, &G)\n-            v = bool(P.new_gen_noclear(t))\n-            if v:\n-                return v, P.new_gen(G)\n+            t = itos(gissquareall(x.g, &G))\n+            if t:\n+                return True, P.new_gen(G)\n             else:\n-                pari_catch_sig_off()\n-                return v, None\n+                P.clear_stack()\n+                return False, None\n         else:\n-            return P.new_gen(gissquare(x.g))\n-\n+            t = itos(gissquare(x.g))\n+            pari_catch_sig_off()\n+            return t != 0\n \n     def issquarefree(gen self):\n         \"\"\"\n@@ -5570,9 +5570,9 @@\n             False\n         \"\"\"\n         pari_catch_sig_on()\n-        t = bool(issquarefree(self.g))\n+        cdef long t = issquarefree(self.g)\n         pari_catch_sig_off()\n-        return t\n+        return t != 0\n \n     def lcm(gen x, y):\n         \"\"\"\n@@ -6203,9 +6203,9 @@\n         \"\"\"\n         cdef gen t0 = objtogen(x)\n         pari_catch_sig_on()\n-        t = bool(oncurve(self.g, t0.g) == 1)\n+        cdef int t = oncurve(self.g, t0.g)\n         pari_catch_sig_off()\n-        return t\n+        return t != 0\n \n     def elllocalred(self, p):\n         r\"\"\"\n@@ -8034,9 +8034,10 @@\n         non-constant polynomial, or False if f is reducible or constant.\n         \"\"\"\n         pari_catch_sig_on()\n-        return bool(self.new_gen(gisirreducible(self.g)))\n-        \n-        \n+        cdef long t = itos(gisirreducible(self.g))\n+        P.clear_stack()\n+        return t != 0\n+\n     def pollead(self, v=-1):\n         \"\"\"\n         self.pollead(v): leading coefficient of polynomial or series self,\n```",
    "created_at": "2013-11-27T20:17:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126416",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:38'>Comment 38:</a>
Added patch

```diff
diff --git a/sage/libs/pari/gen.pyx b/sage/libs/pari/gen.pyx
--- a/sage/libs/pari/gen.pyx
+++ b/sage/libs/pari/gen.pyx
@@ -1871,7 +1871,7 @@
         pari_catch_sig_on()
         cdef int ret = gequal(a.g, t0.g)
         pari_catch_sig_off()
-        return bool(ret)
+        return ret != 0
 
     def gequal0(gen a):
         r"""
@@ -1893,7 +1893,7 @@
         pari_catch_sig_on()
         cdef int ret = gequal0(a.g)
         pari_catch_sig_off()
-        return bool(ret)
+        return ret != 0
 
     def gequal_long(gen a, long b):
         r"""
@@ -1920,7 +1920,7 @@
         pari_catch_sig_on()
         cdef int ret = gequalsg(b, a.g)
         pari_catch_sig_off()
-        return bool(ret)
+        return ret != 0
     
 
     ###########################################
@@ -1962,7 +1962,7 @@
         pari_catch_sig_on()
         cdef long t = signe(gisprime(self.g, flag))
         P.clear_stack()
-        return bool(t)
+        return t != 0
 
     def qfbhclassno(gen n):
         r"""
@@ -2041,7 +2041,7 @@
         pari_catch_sig_on()
         cdef long t = ispseudoprime(self.g, flag)
         pari_catch_sig_off()
-        return bool(t)
+        return t != 0
 
     def ispower(gen self, k=None):
         r"""
@@ -3209,9 +3209,9 @@
             [True, False, True, True, True, True, True, True, True, True]
         """
         pari_catch_sig_on()
-        b = bool(bittest(x.g, n))
+        cdef long b = bittest(x.g, n)
         pari_catch_sig_off()
-        return b
+        return b != 0
     
     def bitxor(gen x, y):
         """
@@ -5541,24 +5541,24 @@
 
     def issquare(gen x, find_root=False):
         """
-        issquare(x,n): true(1) if x is a square, false(0) if not. If
-        find_root is given, also returns the exact square root if it was
-        computed.
-        """
-        cdef GEN G, t
+        issquare(x,n): ``True`` if x is a square, ``False`` if not. If
+        ``find_root`` is given, also returns the exact square root.
+        """
+        cdef GEN G
+        cdef long t
         cdef gen g
         pari_catch_sig_on()
         if find_root:
-            t = gissquareall(x.g, &G)
-            v = bool(P.new_gen_noclear(t))
-            if v:
-                return v, P.new_gen(G)
+            t = itos(gissquareall(x.g, &G))
+            if t:
+                return True, P.new_gen(G)
             else:
-                pari_catch_sig_off()
-                return v, None
+                P.clear_stack()
+                return False, None
         else:
-            return P.new_gen(gissquare(x.g))
-
+            t = itos(gissquare(x.g))
+            pari_catch_sig_off()
+            return t != 0
 
     def issquarefree(gen self):
         """
@@ -5570,9 +5570,9 @@
             False
         """
         pari_catch_sig_on()
-        t = bool(issquarefree(self.g))
+        cdef long t = issquarefree(self.g)
         pari_catch_sig_off()
-        return t
+        return t != 0
 
     def lcm(gen x, y):
         """
@@ -6203,9 +6203,9 @@
         """
         cdef gen t0 = objtogen(x)
         pari_catch_sig_on()
-        t = bool(oncurve(self.g, t0.g) == 1)
+        cdef int t = oncurve(self.g, t0.g)
         pari_catch_sig_off()
-        return t
+        return t != 0
 
     def elllocalred(self, p):
         r"""
@@ -8034,9 +8034,10 @@
         non-constant polynomial, or False if f is reducible or constant.
         """
         pari_catch_sig_on()
-        return bool(self.new_gen(gisirreducible(self.g)))
-        
-        
+        cdef long t = itos(gisirreducible(self.g))
+        P.clear_stack()
+        return t != 0
+
     def pollead(self, v=-1):
         """
         self.pollead(v): leading coefficient of polynomial or series self,
```



---

archive/issue_comments_126417.json:
```json
{
    "body": "<a id='comment:39'>Comment 39:</a>\nAttachment: **[11868_pari_extra.patch.gz](https://github.com/sagemath/sage/files/ticket11868/11868_pari_extra.patch.gz)**\n\nExcellent, I'm happy with the current state.",
    "created_at": "2013-11-27T21:30:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126417",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:39'>Comment 39:</a>
Attachment: **[11868_pari_extra.patch.gz](https://github.com/sagemath/sage/files/ticket11868/11868_pari_extra.patch.gz)**

Excellent, I'm happy with the current state.



---

archive/issue_events_146078.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-11-27T21:43:05Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11868#event-146078"
}
```



---

archive/issue_events_146079.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-11-27T21:43:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11868#event-146079"
}
```



---

archive/issue_comments_126418.json:
```json
{
    "body": "Merged: **sage-5.13.beta5**",
    "created_at": "2013-12-05T08:02:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11868#issuecomment-126418",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-5.13.beta5**



---

archive/issue_events_146080.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-12-05T08:02:06Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11868#event-146080"
}
```



---

archive/issue_events_146081.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-12-05T08:02:06Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/11868",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11868#event-146081"
}
```
