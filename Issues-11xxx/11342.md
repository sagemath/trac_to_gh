# Issue 11342: Make getattr faster on parents and elements

archive/issues_011170.json:
```json
{
    "body": "If an attribute of a parent or element can not be found by inspecting the method resolution order, `__getattr__` is invoked. It tries to obtain the attribute from the parent class or the element class of the category of the parent. If it can not be found, the attribute error is raised using a Cython function `sage.structure.parent.raise_attribute_error`.\n\nI see several ways to make both `__getattr__` and `sage.structure.parent.raise_attribute_error` a lot faster. Details will be given in the comments.\n\nBecause of one doctest in `sage.categories.primer`, it is needed that the category of polynomial rings is properly initialised. Therefore:\n\nDepends on #9944\n\nApply \n\n* [attachment:trac11342-attribute_error_message.rebased.patch]\n* [attachment:trac_11342_fix_pari_initialization.patch]\n* [attachment:trac_11342_fix_pari_ring.patch]\n* [attachment:trac_11342_crypto_fixes.patch]\n* [attachment:trac11342_test_parent_on_getattr.patch]\n\n\nCC:  @jdemeyer\n\nKeywords: getattr parent element\n\nResolution: fixed\n\nDependencies: #9944\n\nAuthor: Simon King, Volker Braun\n\nReviewer: Jeroen Demeyer, Volker Braun, Simon King\n\nMerged: sage-4.7.2.alpha3\n\nIssue created by migration from https://trac.sagemath.org/ticket/11342\n\n",
    "closed_at": "2011-09-17T04:44:34Z",
    "created_at": "2011-05-17T09:06:24Z",
    "labels": [
        "component: performance"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.7.2",
    "title": "Make getattr faster on parents and elements",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11342",
    "user": "https://github.com/simon-king-jena"
}
```
If an attribute of a parent or element can not be found by inspecting the method resolution order, `__getattr__` is invoked. It tries to obtain the attribute from the parent class or the element class of the category of the parent. If it can not be found, the attribute error is raised using a Cython function `sage.structure.parent.raise_attribute_error`.

I see several ways to make both `__getattr__` and `sage.structure.parent.raise_attribute_error` a lot faster. Details will be given in the comments.

Because of one doctest in `sage.categories.primer`, it is needed that the category of polynomial rings is properly initialised. Therefore:

Depends on #9944

Apply 

* [attachment:trac11342-attribute_error_message.rebased.patch]
* [attachment:trac_11342_fix_pari_initialization.patch]
* [attachment:trac_11342_fix_pari_ring.patch]
* [attachment:trac_11342_crypto_fixes.patch]
* [attachment:trac11342_test_parent_on_getattr.patch]


CC:  @jdemeyer

Keywords: getattr parent element

Resolution: fixed

Dependencies: #9944

Author: Simon King, Volker Braun

Reviewer: Jeroen Demeyer, Volker Braun, Simon King

Merged: sage-4.7.2.alpha3

Issue created by migration from https://trac.sagemath.org/ticket/11342





---

archive/issue_comments_155282.json:
```json
{
    "body": "Attachment [trac11342-faster_getattr.patch](tarball://root/attachments/some-uuid/ticket11342/trac11342-faster_getattr.patch) by @simon-king-jena created at 2011-05-17 09:07:58\n\nMake attribute access faster on elements and parents",
    "created_at": "2011-05-17T09:07:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155282",
    "user": "https://github.com/simon-king-jena"
}
```

Attachment [trac11342-faster_getattr.patch](tarball://root/attachments/some-uuid/ticket11342/trac11342-faster_getattr.patch) by @simon-king-jena created at 2011-05-17 09:07:58

Make attribute access faster on elements and parents



---

archive/issue_comments_155283.json:
```json
{
    "body": "<a id='comment:1'></a>\nHere are my ideas to make attribute access faster.\n\n**1. Make raising an attribute error faster**\n\nIt is very common that one tries to get an attribute, but it does not exist - attribute error. Since it occurs so frequently, it is essential that the error be raised as quickly as possible. Raising the error is therefore the job of a Cython function `raise_attribute_error` in `sage.structure.parent`. However, that function can be slightly improved.\n\n1.a) The second argument to that function always is a string: The attribute name. Thus, why not explicitly state it in the Cython code?\n\n1.b) It internally operates with the type of the first argument. So, why not explicitly state it in the Cython code?\n\n1.c) The error message is formed from the name of the class and the name of the attribute. There is one complication: If one has an extension type then its name shall be prepended by its module name. There is a Cython function `is_extension_type` for telling whether it is an extension type or not. But the function is small, and a tiny bit of time can be saved by doing the test inside `raise_attribute_error`.\n\n1.d) How shall one create the error message? In unpatched Sage, it is done by a formatted string that is formed by the class name (perhaps together with the name of the module of the class) and the attribute name. However, it turned out in some timings that I did that composing the error message by addition of strings is faster than the formatted string.\n\n1.e) If one has an extension type then it turns out to be faster to get module name plus class name from the string representation of that type, rather than from addition of strings.\n\nHence, the new `raise_attribute_error` looks like this:\n\n```\ncdef inline raise_attribute_error(self, str name):\n    cdef type cls = type(self)\n    cdef int dictoff\n    try:\n        dictoff = cls.__dictoffset__\n    except AttributeError:\n        raise AttributeError, \"'\"+cls.__name__+\"' object has no attribute '\"+name+\"'\"\n    if dictoff:\n        raise AttributeError, \"'\"+cls.__name__+\"' object has no attribute '\"+name+\"'\"\n    raise AttributeError, repr(cls)[6:-1] + \" object has no attribute '\"+name+\"'\"\n```\n\n__Timings for `raise_attribute_error`__\n\nI compare the timings of unpatched and patched sage-4.7.alpha5, stating the patched version first. We have to distinguish extension types and others:\n\n```\nsage: cython(\"\"\"\n....: from sage.structure.parent cimport raise_attribute_error\n....: def test(self, name, long m):\n....:     cdef long i\n....:     for i from 0<=i<m:\n....:         try:\n....:             raise_attribute_error(self,name)\n....:         except AttributeError:\n....:             pass\n....: \"\"\")\nsage: P.<a,b,c> = PolynomialRing(QQ)\nsage: P.__class__.__dictoffset__\n0\nsage: QQ.__class__.__dictoffset__\n288\nsage: %time test(P,'bla',10^7)\nCPU times: user 19.99 s, sys: 0.00 s, total: 19.99 s\nWall time: 19.99 s\n# unpatched:\n# CPU times: user 21.28 s, sys: 0.00 s, total: 21.28 s\n# Wall time: 21.28 s\nsage: %time test(QQ,'bla',10^7)\nCPU times: user 17.66 s, sys: 0.01 s, total: 17.67 s\nWall time: 17.67 s\n# unpatched:\n# CPU times: user 19.92 s, sys: 0.01 s, total: 19.93 s\n# Wall time: 19.93 s\n```\n\n**2. Raise attribute errors earlier**\n\nAn attribute of a parent can be obtained from the category only if its category is properly initialised. Otherwise an attribute error is raised. In order to test whether it is properly initialised, the method `_is_category_initialized` is called. However, that method merely tests whether the cdef attribute `_category` of the parent is None.\n\nHence, first suggestion: Directly test whether `self._category` is None, if `self` is a parent.\n\nUp to now, an attribute of an element can be obtained from the category of its parent, even if the category of the parent is *not* properly initialised. I doubt that this is a good idea. In fact, there is only a single doctest error if one requests the parent's category to be initialised, and this error vanishes if #9944 is applied.\n\nHence, second suggestion: If self is an element, then try to get an attribute from the category only if self._parent._category is not None. These changes have a nice effect on the performance. Again, I state the timings for the patched version first.\n\nRecall that by #10467, if the `__getattr__` method of a parent (or element) is asked for a private attribute (one that starts with double underscore but does not end with an underscore), it immediately raises an error, since by convention private attributes can not be inherited from the category (or they wouldn't be private).\n\nHence, we have to consider the following cases:\n\n1. non-existing private attributes\n\n```\nsage: a = 1\nsage: timeit('try: QQ.__bla\\nexcept: pass')\n625 loops, best of 3: 13.8 \u00b5s per loop\n# unpatched: 625 loops, best of 3: 15.3 \u00b5s per loop\nsage: timeit('try: a.__bla\\nexcept: pass')\n625 loops, best of 3: 13.3 \u00b5s per loop\n# unpatched: 625 loops, best of 3: 14 \u00b5s per loop\n```\n\n2. non-existing non-private attributes\n\n```\nsage: timeit('try: QQ.__bla_\\nexcept: pass')\n625 loops, best of 3: 17.2 \u00b5s per loop\n# unpatched: 625 loops, best of 3: 23.4 \u00b5s per loop\nsage: timeit('try: a.__bla_\\nexcept: pass')\n625 loops, best of 3: 21.6 \u00b5s per loop\n# unpatched: 625 loops, best of 3: 28.2 \u00b5s per loop\nsage: timeit('try: QQ.bla\\nexcept: pass')\n625 loops, best of 3: 16.7 \u00b5s per loop\n# unpatched: 625 loops, best of 3: 22.9 \u00b5s per loop\nsage: timeit('try: a.bla\\nexcept: pass')\n625 loops, best of 3: 20.8 \u00b5s per loop\n# unpatched: 625 loops, best of 3: 27.2 \u00b5s per loop\n```\n\n3. existing attributes inherited from the category\n\n```\nsage: timeit('try: QQ.sum\\nexcept: pass',number=10^5)\n100000 loops, best of 3: 740 ns per loop\n# unpatched: 625 loops, best of 3: 744 ns per loop\nsage: timeit('try: a.cartesian_product\\nexcept: pass',number=10^5)\n100000 loops, best of 3: 1.67 \u00b5s per loop\n# unpatched: 100000 loops, best of 3: 3.89 \u00b5s per loop\n```\n\nLong doctests pass for me - #9944 is required for one test in `sage.category.primer`. So: Needs review!\n\nDepends on #9944",
    "created_at": "2011-05-17T09:50:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155283",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:1'></a>
Here are my ideas to make attribute access faster.

**1. Make raising an attribute error faster**

It is very common that one tries to get an attribute, but it does not exist - attribute error. Since it occurs so frequently, it is essential that the error be raised as quickly as possible. Raising the error is therefore the job of a Cython function `raise_attribute_error` in `sage.structure.parent`. However, that function can be slightly improved.

1.a) The second argument to that function always is a string: The attribute name. Thus, why not explicitly state it in the Cython code?

1.b) It internally operates with the type of the first argument. So, why not explicitly state it in the Cython code?

1.c) The error message is formed from the name of the class and the name of the attribute. There is one complication: If one has an extension type then its name shall be prepended by its module name. There is a Cython function `is_extension_type` for telling whether it is an extension type or not. But the function is small, and a tiny bit of time can be saved by doing the test inside `raise_attribute_error`.

1.d) How shall one create the error message? In unpatched Sage, it is done by a formatted string that is formed by the class name (perhaps together with the name of the module of the class) and the attribute name. However, it turned out in some timings that I did that composing the error message by addition of strings is faster than the formatted string.

1.e) If one has an extension type then it turns out to be faster to get module name plus class name from the string representation of that type, rather than from addition of strings.

Hence, the new `raise_attribute_error` looks like this:

```
cdef inline raise_attribute_error(self, str name):
    cdef type cls = type(self)
    cdef int dictoff
    try:
        dictoff = cls.__dictoffset__
    except AttributeError:
        raise AttributeError, "'"+cls.__name__+"' object has no attribute '"+name+"'"
    if dictoff:
        raise AttributeError, "'"+cls.__name__+"' object has no attribute '"+name+"'"
    raise AttributeError, repr(cls)[6:-1] + " object has no attribute '"+name+"'"
```

__Timings for `raise_attribute_error`__

I compare the timings of unpatched and patched sage-4.7.alpha5, stating the patched version first. We have to distinguish extension types and others:

```
sage: cython("""
....: from sage.structure.parent cimport raise_attribute_error
....: def test(self, name, long m):
....:     cdef long i
....:     for i from 0<=i<m:
....:         try:
....:             raise_attribute_error(self,name)
....:         except AttributeError:
....:             pass
....: """)
sage: P.<a,b,c> = PolynomialRing(QQ)
sage: P.__class__.__dictoffset__
0
sage: QQ.__class__.__dictoffset__
288
sage: %time test(P,'bla',10^7)
CPU times: user 19.99 s, sys: 0.00 s, total: 19.99 s
Wall time: 19.99 s
# unpatched:
# CPU times: user 21.28 s, sys: 0.00 s, total: 21.28 s
# Wall time: 21.28 s
sage: %time test(QQ,'bla',10^7)
CPU times: user 17.66 s, sys: 0.01 s, total: 17.67 s
Wall time: 17.67 s
# unpatched:
# CPU times: user 19.92 s, sys: 0.01 s, total: 19.93 s
# Wall time: 19.93 s
```

**2. Raise attribute errors earlier**

An attribute of a parent can be obtained from the category only if its category is properly initialised. Otherwise an attribute error is raised. In order to test whether it is properly initialised, the method `_is_category_initialized` is called. However, that method merely tests whether the cdef attribute `_category` of the parent is None.

Hence, first suggestion: Directly test whether `self._category` is None, if `self` is a parent.

Up to now, an attribute of an element can be obtained from the category of its parent, even if the category of the parent is *not* properly initialised. I doubt that this is a good idea. In fact, there is only a single doctest error if one requests the parent's category to be initialised, and this error vanishes if #9944 is applied.

Hence, second suggestion: If self is an element, then try to get an attribute from the category only if self._parent._category is not None. These changes have a nice effect on the performance. Again, I state the timings for the patched version first.

Recall that by #10467, if the `__getattr__` method of a parent (or element) is asked for a private attribute (one that starts with double underscore but does not end with an underscore), it immediately raises an error, since by convention private attributes can not be inherited from the category (or they wouldn't be private).

Hence, we have to consider the following cases:

1. non-existing private attributes

```
sage: a = 1
sage: timeit('try: QQ.__bla\nexcept: pass')
625 loops, best of 3: 13.8 µs per loop
# unpatched: 625 loops, best of 3: 15.3 µs per loop
sage: timeit('try: a.__bla\nexcept: pass')
625 loops, best of 3: 13.3 µs per loop
# unpatched: 625 loops, best of 3: 14 µs per loop
```

2. non-existing non-private attributes

```
sage: timeit('try: QQ.__bla_\nexcept: pass')
625 loops, best of 3: 17.2 µs per loop
# unpatched: 625 loops, best of 3: 23.4 µs per loop
sage: timeit('try: a.__bla_\nexcept: pass')
625 loops, best of 3: 21.6 µs per loop
# unpatched: 625 loops, best of 3: 28.2 µs per loop
sage: timeit('try: QQ.bla\nexcept: pass')
625 loops, best of 3: 16.7 µs per loop
# unpatched: 625 loops, best of 3: 22.9 µs per loop
sage: timeit('try: a.bla\nexcept: pass')
625 loops, best of 3: 20.8 µs per loop
# unpatched: 625 loops, best of 3: 27.2 µs per loop
```

3. existing attributes inherited from the category

```
sage: timeit('try: QQ.sum\nexcept: pass',number=10^5)
100000 loops, best of 3: 740 ns per loop
# unpatched: 625 loops, best of 3: 744 ns per loop
sage: timeit('try: a.cartesian_product\nexcept: pass',number=10^5)
100000 loops, best of 3: 1.67 µs per loop
# unpatched: 100000 loops, best of 3: 3.89 µs per loop
```

Long doctests pass for me - #9944 is required for one test in `sage.category.primer`. So: Needs review!

Depends on #9944



---

archive/issue_comments_155284.json:
```json
{
    "body": "Dependencies: #9944",
    "created_at": "2011-05-17T09:50:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155284",
    "user": "https://github.com/simon-king-jena"
}
```

Dependencies: #9944



---

archive/issue_comments_155285.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-05-17T09:50:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155285",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_155286.json:
```json
{
    "body": "Author: Simon King",
    "created_at": "2011-05-17T09:50:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155286",
    "user": "https://github.com/simon-king-jena"
}
```

Author: Simon King



---

archive/issue_comments_155287.json:
```json
{
    "body": "Make attribute access faster on elements and parents: Create the error message only when needed",
    "created_at": "2011-05-22T06:53:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155287",
    "user": "https://github.com/simon-king-jena"
}
```

Make attribute access faster on elements and parents: Create the error message only when needed



---

archive/issue_comments_155288.json:
```json
{
    "body": "<a id='comment:2'></a>\nAttachment [trac11342-AttributeErrorMessage.patch](tarball://root/attachments/some-uuid/ticket11342/trac11342-AttributeErrorMessage.patch) by @simon-king-jena created at 2011-05-22 07:15:31\n\nUsing an additional idea, I was able to improve the timings even further.\n\nI have already indicated that the process of raising the attribute error actually is a bottle neck. To be precise: Most time is spent for creating the nicely formatted error message.\n\nThe point is: The typical fate of an `AttributeError` is being caught. Hence, nobody will ever see the error message, except under very special circumstances.\n\nTherefore I suggest that the error message will only be created if someone wants to see it. This is possible by introducing a new class `sage.structure.parent.AttributeErrorMessage`. Its instances simply store a class `cls` and an attribute name, and its string representation is the well-known error message stating that `cls` has no attribute of the given name. This string representation is not created during initialisation but only when needed.\n\nHence, rather than calling `raise_attribute_error(self,name)`, one would do `raise AttributeError, AttributeErrorMessage(self,name)`. That is **a lot** faster:\n\n```\nsage: cython(\"\"\"\n....: from sage.structure.parent import AttributeErrorMessage\n....: def test(self,name,long m):\n....:     cdef long i\n....:     for i from 0<=i<m:\n....:         try:\n....:             raise AttributeError, AttributeErrorMessage(self,name)\n....:         except AttributeError:\n....:             pass\n....: \"\"\")\nsage: P.<a,b,c> = PolynomialRing(QQ)\nsage: %time test(P,'bla',10^7)\nCPU times: user 3.10 s, sys: 0.00 s, total: 3.10 s\nWall time: 3.10 s\nsage: %time test(QQ,'bla',10^7)\nCPU times: user 3.06 s, sys: 0.00 s, total: 3.06 s\nWall time: 3.07 s\n```\nCompare with the timings for `raise_attribute_error` in my previous comments!\n\nOther than that, I added the specification that the attribute name is supposed to be a string:\n\n```\ndef __getattr__(self, str name):\n```\ninstead of\n\n```\ndef __getattr__(self, name):\n```\n\n**__Updated timings__**\n\nI am repeating the tests from my previous comments.\n\n1. non-existing private attributes\n\nThere is a clear improvement, even compared with the previous patch version.\n\n```\nsage: a = 1\nsage: timeit('try: QQ.__bla\\nexcept: pass')\n625 loops, best of 3: 10.5 \u00b5s per loop\nsage: timeit('try: a.__bla\\nexcept: pass')\n625 loops, best of 3: 8.78 \u00b5s per loop\nsage: timeit('try: QQ.__bla_\\nexcept: pass')\n```\n\n2. non-existing non-private attributes\n\nThere is a clear improvement, even compared with the previous patch version.\n\n```\nsage: timeit('try: QQ.__bla_\\nexcept: pass')\n625 loops, best of 3: 14.1 \u00b5s per loop\nsage: timeit('try: a.__bla_\\nexcept: pass')\n625 loops, best of 3: 16.1 \u00b5s per loop\nsage: timeit('try: QQ.bla\\nexcept: pass')\n625 loops, best of 3: 13.8 \u00b5s per loop\nsage: timeit('try: a.bla\\nexcept: pass')\n625 loops, best of 3: 16.3 \u00b5s per loop\n```\n\n3. existing attributes inherited from the category\n\n```\nsage: timeit('try: QQ.sum\\nexcept: pass',number=10^5)\n100000 loops, best of 3: 741 ns per loop\nsage: timeit('try: a.cartesian_product\\nexcept: pass',number=10^5)\n100000 loops, best of 3: 1.67 \u00b5s per loop\n```\n\n**Note**\n\nUsually, errors are raised with an error message that is given by a string. It seems that raising it with an instance of `AttributeErrorMessage` is fine as well - at least it does not seem to break existing tests. However, perhaps other people have objections.\n\nTherefore I'm informing sage-devel, and I did not override the old patch but created a new one.\n\nFor the patchbot:\n\nDepends on #9944\n\nApply [attachent:trac11342-AttributeErrorMessage.patch]",
    "created_at": "2011-05-22T07:15:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155288",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:2'></a>
Attachment [trac11342-AttributeErrorMessage.patch](tarball://root/attachments/some-uuid/ticket11342/trac11342-AttributeErrorMessage.patch) by @simon-king-jena created at 2011-05-22 07:15:31

Using an additional idea, I was able to improve the timings even further.

I have already indicated that the process of raising the attribute error actually is a bottle neck. To be precise: Most time is spent for creating the nicely formatted error message.

The point is: The typical fate of an `AttributeError` is being caught. Hence, nobody will ever see the error message, except under very special circumstances.

Therefore I suggest that the error message will only be created if someone wants to see it. This is possible by introducing a new class `sage.structure.parent.AttributeErrorMessage`. Its instances simply store a class `cls` and an attribute name, and its string representation is the well-known error message stating that `cls` has no attribute of the given name. This string representation is not created during initialisation but only when needed.

Hence, rather than calling `raise_attribute_error(self,name)`, one would do `raise AttributeError, AttributeErrorMessage(self,name)`. That is **a lot** faster:

```
sage: cython("""
....: from sage.structure.parent import AttributeErrorMessage
....: def test(self,name,long m):
....:     cdef long i
....:     for i from 0<=i<m:
....:         try:
....:             raise AttributeError, AttributeErrorMessage(self,name)
....:         except AttributeError:
....:             pass
....: """)
sage: P.<a,b,c> = PolynomialRing(QQ)
sage: %time test(P,'bla',10^7)
CPU times: user 3.10 s, sys: 0.00 s, total: 3.10 s
Wall time: 3.10 s
sage: %time test(QQ,'bla',10^7)
CPU times: user 3.06 s, sys: 0.00 s, total: 3.06 s
Wall time: 3.07 s
```
Compare with the timings for `raise_attribute_error` in my previous comments!

Other than that, I added the specification that the attribute name is supposed to be a string:

```
def __getattr__(self, str name):
```
instead of

```
def __getattr__(self, name):
```

**__Updated timings__**

I am repeating the tests from my previous comments.

1. non-existing private attributes

There is a clear improvement, even compared with the previous patch version.

```
sage: a = 1
sage: timeit('try: QQ.__bla\nexcept: pass')
625 loops, best of 3: 10.5 µs per loop
sage: timeit('try: a.__bla\nexcept: pass')
625 loops, best of 3: 8.78 µs per loop
sage: timeit('try: QQ.__bla_\nexcept: pass')
```

2. non-existing non-private attributes

There is a clear improvement, even compared with the previous patch version.

```
sage: timeit('try: QQ.__bla_\nexcept: pass')
625 loops, best of 3: 14.1 µs per loop
sage: timeit('try: a.__bla_\nexcept: pass')
625 loops, best of 3: 16.1 µs per loop
sage: timeit('try: QQ.bla\nexcept: pass')
625 loops, best of 3: 13.8 µs per loop
sage: timeit('try: a.bla\nexcept: pass')
625 loops, best of 3: 16.3 µs per loop
```

3. existing attributes inherited from the category

```
sage: timeit('try: QQ.sum\nexcept: pass',number=10^5)
100000 loops, best of 3: 741 ns per loop
sage: timeit('try: a.cartesian_product\nexcept: pass',number=10^5)
100000 loops, best of 3: 1.67 µs per loop
```

**Note**

Usually, errors are raised with an error message that is given by a string. It seems that raising it with an instance of `AttributeErrorMessage` is fine as well - at least it does not seem to break existing tests. However, perhaps other people have objections.

Therefore I'm informing sage-devel, and I did not override the old patch but created a new one.

For the patchbot:

Depends on #9944

Apply [attachent:trac11342-AttributeErrorMessage.patch]



---

archive/issue_comments_155289.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -5,4 +5,4 @@\n Because of one doctest in `sage.categories.primer`, it is needed that the category of polynomial rings is properly initialised. Therefore:\n \n Depends on #9944\n-\n+Apply [attachment:trac11342-AttributeErrorMessage.patch]\n``````\n",
    "created_at": "2011-05-22T07:15:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155289",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -5,4 +5,4 @@
 Because of one doctest in `sage.categories.primer`, it is needed that the category of polynomial rings is properly initialised. Therefore:
 
 Depends on #9944
-
+Apply [attachment:trac11342-AttributeErrorMessage.patch]
``````




---

archive/issue_comments_155290.json:
```json
{
    "body": "<a id='comment:3'></a>\nHi Simon,\n\nI didn't realize that it was part of your problem, that's why I only react now. It seems that your class `AttributeErrorMessage` somehow reproduce the feature of LazyFormat (see #11342). We probably should merge the two features. Note that mine is pure Python so that probably a little Cythonizing is needed if it fits you needs. \n\nFlorent",
    "created_at": "2011-05-22T08:41:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155290",
    "user": "https://github.com/hivert"
}
```

<a id='comment:3'></a>
Hi Simon,

I didn't realize that it was part of your problem, that's why I only react now. It seems that your class `AttributeErrorMessage` somehow reproduce the feature of LazyFormat (see #11342). We probably should merge the two features. Note that mine is pure Python so that probably a little Cythonizing is needed if it fits you needs. 

Florent



---

archive/issue_comments_155291.json:
```json
{
    "body": "<a id='comment:4'></a>\nReplying to [hivert](#comment%3A3):\n> I didn't realize that it was part of your problem, that's why I only react now. It seems that your class `AttributeErrorMessage` somehow reproduce the feature of LazyFormat (see #11342).\n\n\nYou mean #8742.\n\nThank you for the pointer to lazy format strings!",
    "created_at": "2011-05-22T11:40:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155291",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:4'></a>
Replying to [hivert](#comment%3A3):
> I didn't realize that it was part of your problem, that's why I only react now. It seems that your class `AttributeErrorMessage` somehow reproduce the feature of LazyFormat (see #11342).


You mean #8742.

Thank you for the pointer to lazy format strings!



---

archive/issue_comments_155292.json:
```json
{
    "body": "<a id='comment:5'></a>\nI did the following test with lazy format strings:\n\n```\nsage: cython(\"\"\"\n....: from sage.misc.lazy_format import LazyFormat\n....: def test(self,name,long m):\n....:     s = LazyFormat(\"%s has no attribute %s\")\n....:     cdef long i\n....:     for i from 0<=i<m:\n....:         try:\n....:             raise AttributeError, s%(self.__class__,name)\n....:         except AttributeError:\n....:             pass\n....: \"\"\")\n```\n\nThat string is a good approximation to what we really want, but the differences to the original error messages could only be resolved by a case distinction:\n\n```\nsage: s = LazyFormat(\"%s has no attribute %s\")\nsage: raise AttributeError, s%(QQ.__class__,'bla')\n---------------------------------------------------------------------------\nAttributeError                            Traceback (most recent call last)\n\n/home/king/<ipython console> in <module>()\n\nAttributeError: <class 'sage.rings.rational_field.RationalField_with_category'> has no attribute bla\nsage: QQ.bla\n...\nAttributeError: 'RationalField_with_category' object has no attribute 'bla'\n```\n\nHowever, even if we do not insist on reproducing the exact same error message, lazy format strings are simply too slow.\n\n```\nsage: %time test(QQ,'bla',10^6)\nCPU times: user 16.12 s, sys: 0.01 s, total: 16.13 s\nWall time: 16.12 s\n```\n\nSo, it is nearly eight times slower than using `raise_attribute_error` in unpatched sage, and about fifty times slower than using `AttributeErrorMessage`, which was only 3 seconds for `10^7` (not `10^6`) iterations, and which *does* preserve the old error messages.",
    "created_at": "2011-05-22T12:11:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155292",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:5'></a>
I did the following test with lazy format strings:

```
sage: cython("""
....: from sage.misc.lazy_format import LazyFormat
....: def test(self,name,long m):
....:     s = LazyFormat("%s has no attribute %s")
....:     cdef long i
....:     for i from 0<=i<m:
....:         try:
....:             raise AttributeError, s%(self.__class__,name)
....:         except AttributeError:
....:             pass
....: """)
```

That string is a good approximation to what we really want, but the differences to the original error messages could only be resolved by a case distinction:

```
sage: s = LazyFormat("%s has no attribute %s")
sage: raise AttributeError, s%(QQ.__class__,'bla')
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)

/home/king/<ipython console> in <module>()

AttributeError: <class 'sage.rings.rational_field.RationalField_with_category'> has no attribute bla
sage: QQ.bla
...
AttributeError: 'RationalField_with_category' object has no attribute 'bla'
```

However, even if we do not insist on reproducing the exact same error message, lazy format strings are simply too slow.

```
sage: %time test(QQ,'bla',10^6)
CPU times: user 16.12 s, sys: 0.01 s, total: 16.13 s
Wall time: 16.12 s
```

So, it is nearly eight times slower than using `raise_attribute_error` in unpatched sage, and about fifty times slower than using `AttributeErrorMessage`, which was only 3 seconds for `10^7` (not `10^6`) iterations, and which *does* preserve the old error messages.



---

archive/issue_comments_155293.json:
```json
{
    "body": "<a id='comment:6'></a>\n> So, it is nearly eight times slower than using `raise_attribute_error` in unpatched sage, and about fifty times slower than using `AttributeErrorMessage`, which was only 3 seconds for `10^7` (not `10^6`) iterations, and which *does* preserve the old error messages.\n\n\nAs I already said: [It] is pure Python so that probably a little Cythonizing is needed if it fits you needs. \n\nPlus compared to your code I have have to pay the extra cost of calling the operator `__mod__` for `%` when binding the string to its extra args. If you want speed from cython, it would be better to have this extra binding in a non standard def method so that you can bypass the call to python interpreter. Do you accept a little slow down (calling %) as a trade-off to avoid code and feature duplication ?",
    "created_at": "2011-05-23T13:30:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155293",
    "user": "https://github.com/hivert"
}
```

<a id='comment:6'></a>
> So, it is nearly eight times slower than using `raise_attribute_error` in unpatched sage, and about fifty times slower than using `AttributeErrorMessage`, which was only 3 seconds for `10^7` (not `10^6`) iterations, and which *does* preserve the old error messages.


As I already said: [It] is pure Python so that probably a little Cythonizing is needed if it fits you needs. 

Plus compared to your code I have have to pay the extra cost of calling the operator `__mod__` for `%` when binding the string to its extra args. If you want speed from cython, it would be better to have this extra binding in a non standard def method so that you can bypass the call to python interpreter. Do you accept a little slow down (calling %) as a trade-off to avoid code and feature duplication ?



---

archive/issue_comments_155294.json:
```json
{
    "body": "<a id='comment:7'></a>\nHi Simon\n\nSome more info: According to prun most of the time is spend during the copy in\n\n```\n    def __mod__(self, args):\n        \"\"\"\n        \"\"\"\n        if hasattr(self, \"_args\"): # self is already bound...\n            self = copy(self)\n        self._args = args\n        return self\n```\nFor example\n\n```\n        1    2.828    2.828   19.882   19.882 {_home_florent__sage_temp_popcorn_rouba_net_19739_tmp_0_spyx_0.test}\n   999999    2.429    0.000   15.759    0.000 copy.py:65(copy)\n  1000000    1.088    0.000   17.054    0.000 lazy_format.py:82(__mod__)\n  1999999    1.067    0.000    1.067    0.000 {hasattr}\n```\nI'm pretty sure that cythonizing properly this copy should give a large\nspeedup. So the question is: should we try to optimize `LazyFormat` or do\nyou rather have a hand tuned err-message to ensure proper backward\ncompatibility ?",
    "created_at": "2011-05-23T13:42:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155294",
    "user": "https://github.com/hivert"
}
```

<a id='comment:7'></a>
Hi Simon

Some more info: According to prun most of the time is spend during the copy in

```
    def __mod__(self, args):
        """
        """
        if hasattr(self, "_args"): # self is already bound...
            self = copy(self)
        self._args = args
        return self
```
For example

```
        1    2.828    2.828   19.882   19.882 {_home_florent__sage_temp_popcorn_rouba_net_19739_tmp_0_spyx_0.test}
   999999    2.429    0.000   15.759    0.000 copy.py:65(copy)
  1000000    1.088    0.000   17.054    0.000 lazy_format.py:82(__mod__)
  1999999    1.067    0.000    1.067    0.000 {hasattr}
```
I'm pretty sure that cythonizing properly this copy should give a large
speedup. So the question is: should we try to optimize `LazyFormat` or do
you rather have a hand tuned err-message to ensure proper backward
compatibility ?



---

archive/issue_comments_155295.json:
```json
{
    "body": "Remove assignee tbd.",
    "created_at": "2011-05-23T13:42:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155295",
    "user": "https://github.com/hivert"
}
```

Remove assignee tbd.



---

archive/issue_comments_155296.json:
```json
{
    "body": "<a id='comment:8'></a>\nReplying to [hivert](#comment%3A6):\n> As I already said: [It] is pure Python so that probably a little Cythonizing is needed if it fits you needs. \n> \n> Plus compared to your code I have have to pay the extra cost of calling the operator `__mod__` for `%` when binding the string to its extra args. If you want speed from cython, it would be better to have this extra binding in a non standard def method so that you can bypass the call to python interpreter. Do you accept a little slow down (calling %) as a trade-off to avoid code and feature duplication ?\n\n\nI don't think that there is any code or feature duplication.\n\nCertainly there is no code duplication.\n\nWhat you can do with `AttributeErrorMessage` can not directly be done with a format string (lazy or not), because you need to distinguish two cases. And what you can do with lazy format strings can not be done with an `AttributeErrorMessage`, since the only thing that the new class can do is to print itself as an error message. So, there is no feature duplication either.\n\nMoreover, this ticket explicitly is about speed. A slow down by an extra call to __mod__ would thus not be acceptable, IMO. In particular if that call makes the attribute access slower than with unpatched sage.",
    "created_at": "2011-05-23T13:47:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155296",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:8'></a>
Replying to [hivert](#comment%3A6):
> As I already said: [It] is pure Python so that probably a little Cythonizing is needed if it fits you needs. 
> 
> Plus compared to your code I have have to pay the extra cost of calling the operator `__mod__` for `%` when binding the string to its extra args. If you want speed from cython, it would be better to have this extra binding in a non standard def method so that you can bypass the call to python interpreter. Do you accept a little slow down (calling %) as a trade-off to avoid code and feature duplication ?


I don't think that there is any code or feature duplication.

Certainly there is no code duplication.

What you can do with `AttributeErrorMessage` can not directly be done with a format string (lazy or not), because you need to distinguish two cases. And what you can do with lazy format strings can not be done with an `AttributeErrorMessage`, since the only thing that the new class can do is to print itself as an error message. So, there is no feature duplication either.

Moreover, this ticket explicitly is about speed. A slow down by an extra call to __mod__ would thus not be acceptable, IMO. In particular if that call makes the attribute access slower than with unpatched sage.



---

archive/issue_comments_155297.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [hivert](#comment%3A7):\n> Some more info: According to prun most of the time is spend during the copy in\n> [__mod__].\n\n>...\n> I'm pretty sure that cythonizing properly this copy should give a large\n> speedup. So the question is: should we try to optimize `LazyFormat` or do\n> you rather have a hand tuned err-message to ensure proper backward\n> compatibility ?\n\n\nBackward compatibility is one thing.\n\nIn addition I don't think that you can come up to speed, even with cython, if you need to copy strings etc. The point of `AttributeErrorMessage` is to assign two attributes (without copying, so, it just sets two pointers to existing objects) *and nothing else*.\n\nOf course, you may try to tune the lazy format strings so that they are fast enough for the application here. But for the moment, I really don't see why one should not introduce a very slim new class (it only has `__init__` and `__repr__`), if it is faster and offers backward compatibility for free.",
    "created_at": "2011-05-23T13:59:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155297",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:9'></a>
Replying to [hivert](#comment%3A7):
> Some more info: According to prun most of the time is spend during the copy in
> [__mod__].

>...
> I'm pretty sure that cythonizing properly this copy should give a large
> speedup. So the question is: should we try to optimize `LazyFormat` or do
> you rather have a hand tuned err-message to ensure proper backward
> compatibility ?


Backward compatibility is one thing.

In addition I don't think that you can come up to speed, even with cython, if you need to copy strings etc. The point of `AttributeErrorMessage` is to assign two attributes (without copying, so, it just sets two pointers to existing objects) *and nothing else*.

Of course, you may try to tune the lazy format strings so that they are fast enough for the application here. But for the moment, I really don't see why one should not introduce a very slim new class (it only has `__init__` and `__repr__`), if it is faster and offers backward compatibility for free.



---

archive/issue_comments_155298.json:
```json
{
    "body": "<a id='comment:10'></a>\n> In addition I don't think that you can come up to speed, even with cython,\n> if you need to copy strings etc. The point of `AttributeErrorMessage` is to\n> assign two attributes (without copying, so, it just sets two pointers to\n> existing objects) *and nothing else*.\n\n\nPlease have a look at the code... I'm just copying the object itself if it is\nbound with two different objects. Now using copy.copy from python is always\nawfully slow. So I'm basically creating a new object as you have to do.\n\n> Of course, you may try to tune the lazy format strings so that they are fast\n> enough for the application here. But for the moment, I really don't see why\n> one should not introduce a very slim new class (it only has `__init__` and\n> `__repr__`), if it is faster and offers backward compatibility for free.\n\n\nIf you tell me you won't use it, I'm less motivated to tune it finely ;-)",
    "created_at": "2011-05-23T21:13:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155298",
    "user": "https://github.com/hivert"
}
```

<a id='comment:10'></a>
> In addition I don't think that you can come up to speed, even with cython,
> if you need to copy strings etc. The point of `AttributeErrorMessage` is to
> assign two attributes (without copying, so, it just sets two pointers to
> existing objects) *and nothing else*.


Please have a look at the code... I'm just copying the object itself if it is
bound with two different objects. Now using copy.copy from python is always
awfully slow. So I'm basically creating a new object as you have to do.

> Of course, you may try to tune the lazy format strings so that they are fast
> enough for the application here. But for the moment, I really don't see why
> one should not introduce a very slim new class (it only has `__init__` and
> `__repr__`), if it is faster and offers backward compatibility for free.


If you tell me you won't use it, I'm less motivated to tune it finely ;-)



---

archive/issue_comments_155299.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -5,4 +5,5 @@\n Because of one doctest in `sage.categories.primer`, it is needed that the category of polynomial rings is properly initialised. Therefore:\n \n Depends on #9944\n+\n Apply [attachment:trac11342-AttributeErrorMessage.patch]\n``````\n",
    "created_at": "2011-05-25T06:51:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155299",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -5,4 +5,5 @@
 Because of one doctest in `sage.categories.primer`, it is needed that the category of polynomial rings is properly initialised. Therefore:
 
 Depends on #9944
+
 Apply [attachment:trac11342-AttributeErrorMessage.patch]
``````




---

archive/issue_comments_155300.json:
```json
{
    "body": "<a id='comment:12'></a>\nPing!\n\nFor the patchbot (since it doesn't read the ticket description):\n\nApply trac11342-AttributeErrorMessage.patch",
    "created_at": "2011-06-25T10:24:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155300",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:12'></a>
Ping!

For the patchbot (since it doesn't read the ticket description):

Apply trac11342-AttributeErrorMessage.patch



---

archive/issue_comments_155301.json:
```json
{
    "body": "<a id='comment:13'></a>\nOn June 27, the patchbot applied both patches, even though on June 26 I pointed out that only one patch has to be applied.\n\nLet's ty again...\n\nApply trac11342-AttributeErrorMessage.patch",
    "created_at": "2011-07-21T18:21:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155301",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:13'></a>
On June 27, the patchbot applied both patches, even though on June 26 I pointed out that only one patch has to be applied.

Let's ty again...

Apply trac11342-AttributeErrorMessage.patch



---

archive/issue_comments_155302.json:
```json
{
    "body": "<a id='comment:14'></a>\napply only trac11342-AttributeErrorMessage.patch",
    "created_at": "2011-07-21T20:49:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155302",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:14'></a>
apply only trac11342-AttributeErrorMessage.patch



---

archive/issue_comments_155303.json:
```json
{
    "body": "<a id='comment:15'></a>\nStupid auto-wikification ` apply only trac11342-AttributeErrorMessage.patch `",
    "created_at": "2011-07-21T20:53:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155303",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:15'></a>
Stupid auto-wikification ` apply only trac11342-AttributeErrorMessage.patch `



---

archive/issue_comments_155304.json:
```json
{
    "body": "apply only this patch",
    "created_at": "2011-07-21T21:00:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155304",
    "user": "https://github.com/robertwb"
}
```

apply only this patch



---

archive/issue_comments_155305.json:
```json
{
    "body": "<a id='comment:16'></a>\nAttachment [trac11342-attribute_error_message.patch](tarball://root/attachments/some-uuid/ticket11342/trac11342-attribute_error_message.patch) by @simon-king-jena created at 2011-07-21 21:34:59\n\nReplying to [robertwb](#comment%3A15):\n> Stupid auto-wikification \n\n\nThank you for your effort and for renaming the patch!\n\nNow, the patchbot has still trouble, namely when applying #9944. That ticket was merged in sage-4.7.1.alpha2, but apparently it can not be applied to sage-4.7.\n\nH\u00e9las.\n\nFor the record: It should work on top of sage-4.7.1.rc2.",
    "created_at": "2011-07-21T21:34:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155305",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:16'></a>
Attachment [trac11342-attribute_error_message.patch](tarball://root/attachments/some-uuid/ticket11342/trac11342-attribute_error_message.patch) by @simon-king-jena created at 2011-07-21 21:34:59

Replying to [robertwb](#comment%3A15):
> Stupid auto-wikification 


Thank you for your effort and for renaming the patch!

Now, the patchbot has still trouble, namely when applying #9944. That ticket was merged in sage-4.7.1.alpha2, but apparently it can not be applied to sage-4.7.

Hélas.

For the record: It should work on top of sage-4.7.1.rc2.



---

archive/issue_comments_155306.json:
```json
{
    "body": "Only apply this patch. Make attribute access faster on elements and parents: Create the error message only when needed",
    "created_at": "2011-08-01T16:14:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155306",
    "user": "https://github.com/simon-king-jena"
}
```

Only apply this patch. Make attribute access faster on elements and parents: Create the error message only when needed



---

archive/issue_comments_155307.json:
```json
{
    "body": "<a id='comment:17'></a>\nAttachment [trac11342-attribute_error_message.rebased.patch](tarball://root/attachments/some-uuid/ticket11342/trac11342-attribute_error_message.rebased.patch) by @simon-king-jena created at 2011-08-01 16:16:26\n\nI had to rebase the patch, since it only applied with fuzz 1 against sage-4.7.1.rc1.\n\nStill needs review.\n\nApply trac11342-attribute_error_message.rebased.patch",
    "created_at": "2011-08-01T16:16:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155307",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:17'></a>
Attachment [trac11342-attribute_error_message.rebased.patch](tarball://root/attachments/some-uuid/ticket11342/trac11342-attribute_error_message.rebased.patch) by @simon-king-jena created at 2011-08-01 16:16:26

I had to rebase the patch, since it only applied with fuzz 1 against sage-4.7.1.rc1.

Still needs review.

Apply trac11342-attribute_error_message.rebased.patch



---

archive/issue_comments_155308.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -6,4 +6,4 @@\n \n Depends on #9944\n \n-Apply [attachment:trac11342-AttributeErrorMessage.patch]\n+Apply [attachment:trac11342-attribute_error_message.rebased.patch]\n``````\n",
    "created_at": "2011-08-01T16:16:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155308",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -6,4 +6,4 @@
 
 Depends on #9944
 
-Apply [attachment:trac11342-AttributeErrorMessage.patch]
+Apply [attachment:trac11342-attribute_error_message.rebased.patch]
``````




---

archive/issue_comments_155309.json:
```json
{
    "body": "<a id='comment:18'></a>\nSage-4.7.2.alpha1 segfaults with the patch applied:\n\n```\n[vbraun@volker-laptop-two sage]$ sage -gdb\n----------------------------------------------------------------------\n----------------------------------------------------------------------\n**********************************************************************\n*                                                                    *\n* Warning: this is a prerelease version, and it may be unstable.     *\n*                                                                    *\n**********************************************************************\n/home/vbraun/Sage/sage/local/bin/sage-ipython\nGNU gdb (GDB) Fedora (7.3-41.fc15)\nCopyright (C) 2011 Free Software Foundation, Inc.\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.  Type \"show copying\"\nand \"show warranty\" for details.\nThis GDB was configured as \"x86_64-redhat-linux-gnu\".\nFor bug reporting instructions, please see:\n<http://www.gnu.org/software/gdb/bugs/>...\nReading symbols from /home/vbraun/opt/sage-4.7.2.alpha1/local/bin/python...done.\n[Thread debugging using libthread_db enabled]\nPython 2.6.4 (r264:75706, Aug 20 2011, 21:29:24) \n[GCC 4.6.0 20110603 (Red Hat 4.6.0-10)] on linux2\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\nTraceback (most recent call last):\n  File \"/usr/share/gdb/auto-load/usr/lib64/libstdc++.so.6.0.16-gdb.py\", line 59, in <module>\n    from libstdcxx.v6.printers import register_libstdcxx_printers\n  File \"/usr/lib64/../share/gcc-4.6.0/python/libstdcxx/v6/printers.py\", line 19, in <module>\n    import itertools\nImportError: No module named itertools\n| Sage Version 4.7.2.alpha1, Release Date: 2011-08-17                |\n| Type notebook() for the GUI, and license() for information.        |\n\nProgram received signal SIGSEGV, Segmentation fault.\nPyObject_GetAttr (v=0x0, name=0x1038378) at Objects/object.c:1174\n1174\tObjects/object.c: No such file or directory.\n\tin Objects/object.c\nMissing separate debuginfos, use: debuginfo-install atlas-3.8.3-18.fc14.x86_64 expat-2.0.1-11.fc15.x86_64 fontconfig-2.8.0-3.fc15.x86_64 glibc-2.14-5.x86_64 keyutils-libs-1.2-7.fc15.x86_64 krb5-libs-1.9.1-5.fc15.x86_64 libcom_err-1.41.14-2.fc15.x86_64 libgcc-4.6.0-10.fc15.x86_64 libselinux-2.0.99-4.fc15.x86_64 libstdc++-4.6.0-10.fc15.x86_64 openssl-1.0.0d-1.fc15.x86_64\n(gdb) bt\n#0  PyObject_GetAttr (v=0x0, name=0x1038378) at Objects/object.c:1174\n#1  0x00007fffea27c2e1 in __pyx_pf_4sage_9structure_7element_7Element_3__getattr__ (\n    __pyx_v_name=0x12b1530, __pyx_v_self=0x10eb418) at sage/structure/element.c:2795\n#2  __pyx_tp_getattro_4sage_9structure_7element_Element (n=0x12b1530, o=0x10eb418)\n    at sage/structure/element.c:23398\n#3  __pyx_tp_getattro_4sage_9structure_7element_Element (o=0x10eb418, n=0x12b1530)\n    at sage/structure/element.c:23394\n#4  0x00007ffff7d197ba in builtin_hasattr (self=<optimized out>, args=<optimized out>)\n    at Python/bltinmodule.c:880\n#5  0x00007ffff7d225b5 in call_function (oparg=<optimized out>, pp_stack=0x7ffffffeccc0)\n    at Python/ceval.c:3706\n#6  PyEval_EvalFrameEx (f=<optimized out>, throwflag=<optimized out>) at Python/ceval.c:2389\n#7  0x00007ffff7d242c9 in PyEval_EvalCodeEx (co=<optimized out>, globals=<optimized out>, \n    locals=<optimized out>, args=<optimized out>, argcount=2, kws=0x0, kwcount=0, defs=0x0, \n    defcount=0, closure=0x0) at Python/ceval.c:2968\n#8  0x00007ffff7cb0596 in function_call (func=0x1c57230, arg=0x2299488, kw=0x0)\n    at Objects/funcobject.c:524\n#9  0x00007ffff7c8a763 in PyObject_Call (func=0x1c57230, arg=<optimized out>, kw=<optimized out>)\n    at Objects/abstract.c:2492\n#10 0x00007ffff7c973bf in instancemethod_call (func=0x1c57230, arg=0x2299488, kw=0x0)\n    at Objects/classobject.c:2579\n#11 0x00007ffff7c8a763 in PyObject_Call (func=0x1e725a0, arg=<optimized out>, kw=<optimized out>)\n    at Objects/abstract.c:2492\n#12 0x00007fffeab5dab6 in __pyx_f_4sage_9structure_10parent_old_6Parent__coerce_c (\n    __pyx_v_self=0x1ca5650, __pyx_v_x=0x10eb418, __pyx_skip_dispatch=<optimized out>)\n    at sage/structure/parent_old.c:3711\n#13 0x00007fffeab5660e in __pyx_f_4sage_9structure_10parent_old_6Parent_has_coerce_map_from_c_impl (\n    __pyx_v_self=0x1ca5650, __pyx_v_S=0x1089240) at sage/structure/parent_old.c:4914\n#14 0x00007fffeab55964 in __pyx_pf_4sage_9structure_10parent_old_6Parent_11has_coerce_map_from_impl (\n    __pyx_v_self=0x1ca5650, __pyx_v_S=0x1089240) at sage/structure/parent_old.c:4802\n#15 0x00007ffff7c8a763 in PyObject_Call (func=0x1f95d88, arg=<optimized out>, kw=<optimized out>)\n    at Objects/abstract.c:2492\n#16 0x00007fffeab58e41 in __pyx_f_4sage_9structure_10parent_old_6Parent_has_coerce_map_from_c (\n    __pyx_v_self=0x1ca5650, __pyx_v_S=0x1089240, __pyx_skip_dispatch=<optimized out>)\n    at sage/structure/parent_old.c:4659\n#17 0x00007fffeab54737 in __pyx_f_4sage_9structure_10parent_old_6Parent_coerce_map_from_c_impl (\n    __pyx_v_self=0x1ca5650, __pyx_v_S=0x1089240) at sage/structure/parent_old.c:2638\n#18 0x00007fffeab55f64 in __pyx_pf_4sage_9structure_10parent_old_6Parent_2coerce_map_from_impl (\n    __pyx_v_self=0x1ca5650, __pyx_v_S=0x1089240) at sage/structure/parent_old.c:2283\n#19 0x00007ffff7c8a763 in PyObject_Call (func=0x1f83e18, arg=<optimized out>, kw=<optimized out>)\n    at Objects/abstract.c:2492\n#20 0x00007fffeab5a2a2 in __pyx_f_4sage_9structure_10parent_old_6Parent_coerce_map_from_c (\n    __pyx_v_self=0x1ca5650, __pyx_v_S=0x1089240, __pyx_skip_dispatch=<optimized out>)\n    at sage/structure/parent_old.c:1887\n```",
    "created_at": "2011-08-22T17:19:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155309",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:18'></a>
Sage-4.7.2.alpha1 segfaults with the patch applied:

```
[vbraun@volker-laptop-two sage]$ sage -gdb
----------------------------------------------------------------------
----------------------------------------------------------------------
**********************************************************************
*                                                                    *
* Warning: this is a prerelease version, and it may be unstable.     *
*                                                                    *
**********************************************************************
/home/vbraun/Sage/sage/local/bin/sage-ipython
GNU gdb (GDB) Fedora (7.3-41.fc15)
Copyright (C) 2011 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "x86_64-redhat-linux-gnu".
For bug reporting instructions, please see:
<http://www.gnu.org/software/gdb/bugs/>...
Reading symbols from /home/vbraun/opt/sage-4.7.2.alpha1/local/bin/python...done.
[Thread debugging using libthread_db enabled]
Python 2.6.4 (r264:75706, Aug 20 2011, 21:29:24) 
[GCC 4.6.0 20110603 (Red Hat 4.6.0-10)] on linux2
Type "help", "copyright", "credits" or "license" for more information.
Traceback (most recent call last):
  File "/usr/share/gdb/auto-load/usr/lib64/libstdc++.so.6.0.16-gdb.py", line 59, in <module>
    from libstdcxx.v6.printers import register_libstdcxx_printers
  File "/usr/lib64/../share/gcc-4.6.0/python/libstdcxx/v6/printers.py", line 19, in <module>
    import itertools
ImportError: No module named itertools
| Sage Version 4.7.2.alpha1, Release Date: 2011-08-17                |
| Type notebook() for the GUI, and license() for information.        |

Program received signal SIGSEGV, Segmentation fault.
PyObject_GetAttr (v=0x0, name=0x1038378) at Objects/object.c:1174
1174	Objects/object.c: No such file or directory.
	in Objects/object.c
Missing separate debuginfos, use: debuginfo-install atlas-3.8.3-18.fc14.x86_64 expat-2.0.1-11.fc15.x86_64 fontconfig-2.8.0-3.fc15.x86_64 glibc-2.14-5.x86_64 keyutils-libs-1.2-7.fc15.x86_64 krb5-libs-1.9.1-5.fc15.x86_64 libcom_err-1.41.14-2.fc15.x86_64 libgcc-4.6.0-10.fc15.x86_64 libselinux-2.0.99-4.fc15.x86_64 libstdc++-4.6.0-10.fc15.x86_64 openssl-1.0.0d-1.fc15.x86_64
(gdb) bt
#0  PyObject_GetAttr (v=0x0, name=0x1038378) at Objects/object.c:1174
#1  0x00007fffea27c2e1 in __pyx_pf_4sage_9structure_7element_7Element_3__getattr__ (
    __pyx_v_name=0x12b1530, __pyx_v_self=0x10eb418) at sage/structure/element.c:2795
#2  __pyx_tp_getattro_4sage_9structure_7element_Element (n=0x12b1530, o=0x10eb418)
    at sage/structure/element.c:23398
#3  __pyx_tp_getattro_4sage_9structure_7element_Element (o=0x10eb418, n=0x12b1530)
    at sage/structure/element.c:23394
#4  0x00007ffff7d197ba in builtin_hasattr (self=<optimized out>, args=<optimized out>)
    at Python/bltinmodule.c:880
#5  0x00007ffff7d225b5 in call_function (oparg=<optimized out>, pp_stack=0x7ffffffeccc0)
    at Python/ceval.c:3706
#6  PyEval_EvalFrameEx (f=<optimized out>, throwflag=<optimized out>) at Python/ceval.c:2389
#7  0x00007ffff7d242c9 in PyEval_EvalCodeEx (co=<optimized out>, globals=<optimized out>, 
    locals=<optimized out>, args=<optimized out>, argcount=2, kws=0x0, kwcount=0, defs=0x0, 
    defcount=0, closure=0x0) at Python/ceval.c:2968
#8  0x00007ffff7cb0596 in function_call (func=0x1c57230, arg=0x2299488, kw=0x0)
    at Objects/funcobject.c:524
#9  0x00007ffff7c8a763 in PyObject_Call (func=0x1c57230, arg=<optimized out>, kw=<optimized out>)
    at Objects/abstract.c:2492
#10 0x00007ffff7c973bf in instancemethod_call (func=0x1c57230, arg=0x2299488, kw=0x0)
    at Objects/classobject.c:2579
#11 0x00007ffff7c8a763 in PyObject_Call (func=0x1e725a0, arg=<optimized out>, kw=<optimized out>)
    at Objects/abstract.c:2492
#12 0x00007fffeab5dab6 in __pyx_f_4sage_9structure_10parent_old_6Parent__coerce_c (
    __pyx_v_self=0x1ca5650, __pyx_v_x=0x10eb418, __pyx_skip_dispatch=<optimized out>)
    at sage/structure/parent_old.c:3711
#13 0x00007fffeab5660e in __pyx_f_4sage_9structure_10parent_old_6Parent_has_coerce_map_from_c_impl (
    __pyx_v_self=0x1ca5650, __pyx_v_S=0x1089240) at sage/structure/parent_old.c:4914
#14 0x00007fffeab55964 in __pyx_pf_4sage_9structure_10parent_old_6Parent_11has_coerce_map_from_impl (
    __pyx_v_self=0x1ca5650, __pyx_v_S=0x1089240) at sage/structure/parent_old.c:4802
#15 0x00007ffff7c8a763 in PyObject_Call (func=0x1f95d88, arg=<optimized out>, kw=<optimized out>)
    at Objects/abstract.c:2492
#16 0x00007fffeab58e41 in __pyx_f_4sage_9structure_10parent_old_6Parent_has_coerce_map_from_c (
    __pyx_v_self=0x1ca5650, __pyx_v_S=0x1089240, __pyx_skip_dispatch=<optimized out>)
    at sage/structure/parent_old.c:4659
#17 0x00007fffeab54737 in __pyx_f_4sage_9structure_10parent_old_6Parent_coerce_map_from_c_impl (
    __pyx_v_self=0x1ca5650, __pyx_v_S=0x1089240) at sage/structure/parent_old.c:2638
#18 0x00007fffeab55f64 in __pyx_pf_4sage_9structure_10parent_old_6Parent_2coerce_map_from_impl (
    __pyx_v_self=0x1ca5650, __pyx_v_S=0x1089240) at sage/structure/parent_old.c:2283
#19 0x00007ffff7c8a763 in PyObject_Call (func=0x1f83e18, arg=<optimized out>, kw=<optimized out>)
    at Objects/abstract.c:2492
#20 0x00007fffeab5a2a2 in __pyx_f_4sage_9structure_10parent_old_6Parent_coerce_map_from_c (
    __pyx_v_self=0x1ca5650, __pyx_v_S=0x1089240, __pyx_skip_dispatch=<optimized out>)
    at sage/structure/parent_old.c:1887
```



---

archive/issue_comments_155310.json:
```json
{
    "body": "<a id='comment:19'></a>\nReplying to [vbraun](#comment%3A18):\n> Sage-4.7.2.alpha1 segfaults with the patch applied:\n\n\nWhat? Then why does it work (at least for me) with sage-4.7.1.rc1?\n\nSo, homework for me: Build sage-4.7.2.alpha1.\n\nI just noticed that this patch comes *after* #9138 in my private patch queue. #9138 makes all rings use the category framework, and the `__getattr__` method we are dealing with here is related with the category framework. Could you test whether the segfault vanishes if you first have #9138?",
    "created_at": "2011-08-22T18:42:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155310",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:19'></a>
Replying to [vbraun](#comment%3A18):
> Sage-4.7.2.alpha1 segfaults with the patch applied:


What? Then why does it work (at least for me) with sage-4.7.1.rc1?

So, homework for me: Build sage-4.7.2.alpha1.

I just noticed that this patch comes *after* #9138 in my private patch queue. #9138 makes all rings use the category framework, and the `__getattr__` method we are dealing with here is related with the category framework. Could you test whether the segfault vanishes if you first have #9138?



---

archive/issue_comments_155311.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-08-22T18:42:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155311",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_155312.json:
```json
{
    "body": "<a id='comment:20'></a>\nLooking at the debug information more closely: parent_old is mentioned. To me, that makes it rather likely that #9138 is to blame (or to praise) for the fact that \"at home\" it works for me.",
    "created_at": "2011-08-22T18:44:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155312",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:20'></a>
Looking at the debug information more closely: parent_old is mentioned. To me, that makes it rather likely that #9138 is to blame (or to praise) for the fact that "at home" it works for me.



---

archive/issue_comments_155313.json:
```json
{
    "body": "<a id='comment:21'></a>\nI get the same segfault with #9138, too.",
    "created_at": "2011-08-22T18:51:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155313",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:21'></a>
I get the same segfault with #9138, too.



---

archive/issue_comments_155314.json:
```json
{
    "body": "<a id='comment:22'></a>\nThe segfault is in the last line; is `_category` Null?\n\n```c\n\n  /* \"sage/structure/element.pyx\":328\n *         if (name.startswith('__') and not name.endswith('_')) or self._parent._category is None:\n *             raise AttributeError, AttributeErrorMessage(self, name)\n *         return getattr_from_other_class(self, self._parent._category.element_class, name)             # <<<<<<<<<<<<<<\n * \n *     def __dir__(self):\n */\n  __Pyx_XDECREF(__pyx_r);\n  __pyx_t_2 = __Pyx_GetName(__pyx_m, __pyx_n_s_8); if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 328; __pyx_clineno = __LINE__; goto __pyx_L1_error;}\n  __Pyx_GOTREF(__pyx_t_2);\n  __pyx_t_1 = PyObject_GetAttr(((struct __pyx_obj_4sage_9structure_7element_Element *)__pyx_v_self)->_parent->__pyx_base._category, __pyx_n_s__element_class); if (unlikely(!__pyx_t_1)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 328; __pyx_clineno = __LINE__; goto __pyx_L1_error;}\n```",
    "created_at": "2011-08-22T18:57:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155314",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:22'></a>
The segfault is in the last line; is `_category` Null?

```c

  /* "sage/structure/element.pyx":328
 *         if (name.startswith('__') and not name.endswith('_')) or self._parent._category is None:
 *             raise AttributeError, AttributeErrorMessage(self, name)
 *         return getattr_from_other_class(self, self._parent._category.element_class, name)             # <<<<<<<<<<<<<<
 * 
 *     def __dir__(self):
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_2 = __Pyx_GetName(__pyx_m, __pyx_n_s_8); if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 328; __pyx_clineno = __LINE__; goto __pyx_L1_error;}
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_1 = PyObject_GetAttr(((struct __pyx_obj_4sage_9structure_7element_Element *)__pyx_v_self)->_parent->__pyx_base._category, __pyx_n_s__element_class); if (unlikely(!__pyx_t_1)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 328; __pyx_clineno = __LINE__; goto __pyx_L1_error;}
```



---

archive/issue_comments_155315.json:
```json
{
    "body": "<a id='comment:23'></a>\nReplying to [vbraun](#comment%3A22):\n> The segfault is in the last line; is `_category` Null?\n\n>...\n>  *         if (name.startswith('__') and not name.endswith('_')) or self._parent._category is None:\n\n\nThe preceding line is supposed to test whether the category of self._parent is initialised. If a cdef attribute is not initialised then it is None. At least, so it is on all computers that I worked with.\n\n>  *             raise AttributeError, AttributeErrorMessage(self, name)\n>  *         return getattr_from_other_class(self, self._parent._category.element_class, name)             # <<<<<<<<<<<<<<\n\n\nAnd IF self._parent._category is not None then it has an element_class.\n\nVery strange.\n\nI just verified that on my machine and with sage-4.7.1.rc2 I do *not* get the segfault, even without #9138. So, I should definitely build sage-4.7.2.alpha1.\n\nCheers,\nSimon",
    "created_at": "2011-08-22T19:12:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155315",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:23'></a>
Replying to [vbraun](#comment%3A22):
> The segfault is in the last line; is `_category` Null?

>...
>  *         if (name.startswith('__') and not name.endswith('_')) or self._parent._category is None:


The preceding line is supposed to test whether the category of self._parent is initialised. If a cdef attribute is not initialised then it is None. At least, so it is on all computers that I worked with.

>  *             raise AttributeError, AttributeErrorMessage(self, name)
>  *         return getattr_from_other_class(self, self._parent._category.element_class, name)             # <<<<<<<<<<<<<<


And IF self._parent._category is not None then it has an element_class.

Very strange.

I just verified that on my machine and with sage-4.7.1.rc2 I do *not* get the segfault, even without #9138. So, I should definitely build sage-4.7.2.alpha1.

Cheers,
Simon



---

archive/issue_comments_155316.json:
```json
{
    "body": "<a id='comment:24'></a>\nI also get the segfault with sage-4.7.1.rc2...",
    "created_at": "2011-08-22T19:24:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155316",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:24'></a>
I also get the segfault with sage-4.7.1.rc2...



---

archive/issue_comments_155317.json:
```json
{
    "body": "<a id='comment:25'></a>\nReplying to [vbraun](#comment%3A24):\n> I also get the segfault with sage-4.7.1.rc2...\n\n\nWhat computer is it?\n\nCould you insert a print statement, printing self._parent._category (or, at least printing the type of self._parent._category)? I that way, one could see what happens right in front of the segfault.",
    "created_at": "2011-08-22T19:36:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155317",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:25'></a>
Replying to [vbraun](#comment%3A24):
> I also get the segfault with sage-4.7.1.rc2...


What computer is it?

Could you insert a print statement, printing self._parent._category (or, at least printing the type of self._parent._category)? I that way, one could see what happens right in front of the segfault.



---

archive/issue_comments_155318.json:
```json
{
    "body": "<a id='comment:26'></a>\nAnd I just noticed that I was working with sage-4.7.1.rc1, not rc2.\n\nAnyway, I am building sage-4.7.2.alpha2 now. So, tomorrow I will probably know more...",
    "created_at": "2011-08-22T19:46:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155318",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:26'></a>
And I just noticed that I was working with sage-4.7.1.rc1, not rc2.

Anyway, I am building sage-4.7.2.alpha2 now. So, tomorrow I will probably know more...



---

archive/issue_comments_155319.json:
```json
{
    "body": "<a id='comment:27'></a>\nI added some debug output and it dies here:\n\n```\nself = x^2 + 1\nself._parent = Univariate Polynomial Ring in x over Rational Field\nself._parent._category = Category of euclidean domains\nself = x^2 + 1\nself._parent = Univariate Polynomial Ring in x over Rational Field\nself._parent._category = Category of euclidean domains\nself = x^2 + 1\nself._parent = Univariate Polynomial Ring in x over Rational Field\nself._parent._category = Category of euclidean domains\nself = x^2 + 1\nself._parent = Univariate Polynomial Ring in x over Rational Field\nself._parent._category = Category of euclidean domains\nself = x^2 + 1\nself._parent = Univariate Polynomial Ring in x over Rational Field\nself._parent._category = Category of euclidean domains\nself = 0\nself._parent = None\n/home/vbraun/opt/sage-4.7.1.rc2/local/lib/libcsage.so(print_backtrace+0x31)[0x7fb2f72cb242]\n/home/vbraun/opt/sage-4.7.1.rc2/local/lib/libcsage.so(sigdie+0x14)[0x7fb2f72cb274]\n/home/vbraun/opt/sage-4.7.1.rc2/local/lib/libcsage.so(sage_signal_handler+0x20c)[0x7fb2f72caec2]\n/lib64/libpthread.so.0[0x389c20eef0]\n```",
    "created_at": "2011-08-22T19:51:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155319",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:27'></a>
I added some debug output and it dies here:

```
self = x^2 + 1
self._parent = Univariate Polynomial Ring in x over Rational Field
self._parent._category = Category of euclidean domains
self = x^2 + 1
self._parent = Univariate Polynomial Ring in x over Rational Field
self._parent._category = Category of euclidean domains
self = x^2 + 1
self._parent = Univariate Polynomial Ring in x over Rational Field
self._parent._category = Category of euclidean domains
self = x^2 + 1
self._parent = Univariate Polynomial Ring in x over Rational Field
self._parent._category = Category of euclidean domains
self = x^2 + 1
self._parent = Univariate Polynomial Ring in x over Rational Field
self._parent._category = Category of euclidean domains
self = 0
self._parent = None
/home/vbraun/opt/sage-4.7.1.rc2/local/lib/libcsage.so(print_backtrace+0x31)[0x7fb2f72cb242]
/home/vbraun/opt/sage-4.7.1.rc2/local/lib/libcsage.so(sigdie+0x14)[0x7fb2f72cb274]
/home/vbraun/opt/sage-4.7.1.rc2/local/lib/libcsage.so(sage_signal_handler+0x20c)[0x7fb2f72caec2]
/lib64/libpthread.so.0[0x389c20eef0]
```



---

archive/issue_comments_155320.json:
```json
{
    "body": "<a id='comment:28'></a>\nPS: Its a Thinkpad W520 running Fedora 15",
    "created_at": "2011-08-22T19:52:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155320",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:28'></a>
PS: Its a Thinkpad W520 running Fedora 15



---

archive/issue_comments_155321.json:
```json
{
    "body": "<a id='comment:29'></a>\nReplying to [vbraun](#comment%3A27):\n> self = 0\n> self._parent = None\n\n\nAha! So, it can not do self._parent._category, since the parent is not assigned!\n\nself is zero. But what zero? Integer? Polynomial? Can you print its type?\n\nBut in either case, one could insert a test \"if self._parent is not None\". Unfortunately, any additional test decreases performance...",
    "created_at": "2011-08-22T19:56:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155321",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:29'></a>
Replying to [vbraun](#comment%3A27):
> self = 0
> self._parent = None


Aha! So, it can not do self._parent._category, since the parent is not assigned!

self is zero. But what zero? Integer? Polynomial? Can you print its type?

But in either case, one could insert a test "if self._parent is not None". Unfortunately, any additional test decreases performance...



---

archive/issue_comments_155322.json:
```json
{
    "body": "<a id='comment:30'></a>\nPS: The likely problem is that some attribute is requested before doing `Element.__init__(self,...)`, whatever self is.",
    "created_at": "2011-08-22T19:57:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155322",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:30'></a>
PS: The likely problem is that some attribute is requested before doing `Element.__init__(self,...)`, whatever self is.



---

archive/issue_comments_155323.json:
```json
{
    "body": "<a id='comment:31'></a>\nLooks like pari is to blame:\n\n```\nself = x^2 + 1 type = <type 'sage.rings.polynomial.polynomial_rational_flint.Polynomial_rational_flint'>\nself._parent = Univariate Polynomial Ring in x over Rational Field type = <class 'sage.rings.polynomial.polynomial_ring.PolynomialRing_field_with_category'>\nself._parent._category = Category of euclidean domains\nself = x^2 + 1 type = <type 'sage.rings.polynomial.polynomial_rational_flint.Polynomial_rational_flint'>\nself._parent = Univariate Polynomial Ring in x over Rational Field type = <class 'sage.rings.polynomial.polynomial_ring.PolynomialRing_field_with_category'>\nself._parent._category = Category of euclidean domains\nself = 0 type = <type 'sage.libs.pari.gen.gen'>\nself._parent = None type = <type 'NoneType'>\n/home/vbraun/opt/sage-4.7.1.rc2/local/lib/libcsage.so(print_backtrace+0x31)[0x7fe0b9a3c242]\n/home/vbraun/opt/sage-4.7.1.rc2/local/lib/libcsage.so(sigdie+0x14)[0x7fe0b9a3c274]\n/home/vbraun/opt/sage-4.7.1.rc2/local/lib/libcsage.so(sage_signal_handler+0x20c)[0x7fe0b9a3bec2]\n/lib64/libpthread.so.0[0x389c20eef0]\n```",
    "created_at": "2011-08-22T20:00:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155323",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:31'></a>
Looks like pari is to blame:

```
self = x^2 + 1 type = <type 'sage.rings.polynomial.polynomial_rational_flint.Polynomial_rational_flint'>
self._parent = Univariate Polynomial Ring in x over Rational Field type = <class 'sage.rings.polynomial.polynomial_ring.PolynomialRing_field_with_category'>
self._parent._category = Category of euclidean domains
self = x^2 + 1 type = <type 'sage.rings.polynomial.polynomial_rational_flint.Polynomial_rational_flint'>
self._parent = Univariate Polynomial Ring in x over Rational Field type = <class 'sage.rings.polynomial.polynomial_ring.PolynomialRing_field_with_category'>
self._parent._category = Category of euclidean domains
self = 0 type = <type 'sage.libs.pari.gen.gen'>
self._parent = None type = <type 'NoneType'>
/home/vbraun/opt/sage-4.7.1.rc2/local/lib/libcsage.so(print_backtrace+0x31)[0x7fe0b9a3c242]
/home/vbraun/opt/sage-4.7.1.rc2/local/lib/libcsage.so(sigdie+0x14)[0x7fe0b9a3c274]
/home/vbraun/opt/sage-4.7.1.rc2/local/lib/libcsage.so(sage_signal_handler+0x20c)[0x7fe0b9a3bec2]
/lib64/libpthread.so.0[0x389c20eef0]
```



---

archive/issue_comments_155324.json:
```json
{
    "body": "<a id='comment:32'></a>\nReplying to [vbraun](#comment%3A31):\n> Looks like pari is to blame:\n\n\nGreat! Concerning \"blame\": I have never user \"hg blame\". Do you know how it works? Perhaps it could help to find out what patches between sage-4.7.1.rc1 and sage-4.7.1.rc2 have altered the init method of pari_gen. Or perhaps it is easier to look up the list of patches merged into rc2.",
    "created_at": "2011-08-22T20:07:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155324",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:32'></a>
Replying to [vbraun](#comment%3A31):
> Looks like pari is to blame:


Great! Concerning "blame": I have never user "hg blame". Do you know how it works? Perhaps it could help to find out what patches between sage-4.7.1.rc1 and sage-4.7.1.rc2 have altered the init method of pari_gen. Or perhaps it is easier to look up the list of patches merged into rc2.



---

archive/issue_comments_155325.json:
```json
{
    "body": "<a id='comment:33'></a>\nI checked the list of merged patches, but it did not give me a clue. But perhaps hg blame knows better.",
    "created_at": "2011-08-22T20:15:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155325",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:33'></a>
I checked the list of merged patches, but it did not give me a clue. But perhaps hg blame knows better.



---

archive/issue_comments_155326.json:
```json
{
    "body": "<a id='comment:34'></a>\nIn my Sage version, the init method of an object such as `pari(x)` looks as follows:\n\n```python\n    def __init__(self):\n        self.b = 0\n        self._parent = P\n        self._refers_to = {}\n```\nThat is sage/libs/pari/gen.pyx at line 391. How does it look in your Sage version?\n\nP should be defined as \n\n```python\ncdef PariInstance pari_instance, P\npari_instance = PariInstance(16000000, 500000)\nP = pari_instance   # shorthand notation\n```\nat lines 176 ff.\n\nCould you test whether P is None when it is used in the `__init__` method (lines 391 ff)?",
    "created_at": "2011-08-22T20:27:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155326",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:34'></a>
In my Sage version, the init method of an object such as `pari(x)` looks as follows:

```python
    def __init__(self):
        self.b = 0
        self._parent = P
        self._refers_to = {}
```
That is sage/libs/pari/gen.pyx at line 391. How does it look in your Sage version?

P should be defined as 

```python
cdef PariInstance pari_instance, P
pari_instance = PariInstance(16000000, 500000)
P = pari_instance   # shorthand notation
```
at lines 176 ff.

Could you test whether P is None when it is used in the `__init__` method (lines 391 ff)?



---

archive/issue_comments_155327.json:
```json
{
    "body": "<a id='comment:35'></a>\nI have the same pari `__init__`. There were no nontrivial changes to pari between rc1 and rc2, and I get the same segfault on rc1 as well.\n\nThis looks like some initialization race / module initialization ordering issue.",
    "created_at": "2011-08-22T20:33:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155327",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:35'></a>
I have the same pari `__init__`. There were no nontrivial changes to pari between rc1 and rc2, and I get the same segfault on rc1 as well.

This looks like some initialization race / module initialization ordering issue.



---

archive/issue_comments_155328.json:
```json
{
    "body": "<a id='comment:36'></a>\nNotice how Pari's `PariInstance.__init__` generates elements like `PariInstance.PARI_ZERO`. But during the construction of `pari_instance`, it can't set the parent to anything non-null. Cython actually starts with `None` for all uninitialized variables, so this is why the first few pari `gen`s have `None` as parent.",
    "created_at": "2011-08-22T21:09:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155328",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:36'></a>
Notice how Pari's `PariInstance.__init__` generates elements like `PariInstance.PARI_ZERO`. But during the construction of `pari_instance`, it can't set the parent to anything non-null. Cython actually starts with `None` for all uninitialized variables, so this is why the first few pari `gen`s have `None` as parent.



---

archive/issue_comments_155329.json:
```json
{
    "body": "<a id='comment:37'></a>\nReplying to [vbraun](#comment%3A36):\n> Notice how Pari's `PariInstance.__init__` generates elements like `PariInstance.PARI_ZERO`. But during the construction of `pari_instance`, it can't set the parent to anything non-null. Cython actually starts with `None` for all uninitialized variables, so this is why the first few pari `gen`s have `None` as parent.\n\n\nMaybe a solution could be to decouple the true initialization of PARI and the generation of elements like `PARI_ZERO`.  Initializing `PARI_ZERO` should be done after `PariInstance`'s `__init__()`.  Or we could probably completely remove `PARI_ZERO`, ..., `PARI_TWO`.  They are almost never used anyway.",
    "created_at": "2011-08-22T21:26:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155329",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:37'></a>
Replying to [vbraun](#comment%3A36):
> Notice how Pari's `PariInstance.__init__` generates elements like `PariInstance.PARI_ZERO`. But during the construction of `pari_instance`, it can't set the parent to anything non-null. Cython actually starts with `None` for all uninitialized variables, so this is why the first few pari `gen`s have `None` as parent.


Maybe a solution could be to decouple the true initialization of PARI and the generation of elements like `PARI_ZERO`.  Initializing `PARI_ZERO` should be done after `PariInstance`'s `__init__()`.  Or we could probably completely remove `PARI_ZERO`, ..., `PARI_TWO`.  They are almost never used anyway.



---

archive/issue_comments_155330.json:
```json
{
    "body": "<a id='comment:38'></a>\nWith the attached patch the segfault does not occur any more. I also tested that this was the only element whose parent was None.",
    "created_at": "2011-08-22T21:45:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155330",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:38'></a>
With the attached patch the segfault does not occur any more. I also tested that this was the only element whose parent was None.



---

archive/issue_comments_155331.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -6,4 +6,5 @@\n \n Depends on #9944\n \n-Apply [attachment:trac11342-attribute_error_message.rebased.patch]\n+Apply [attachment:trac11342-attribute_error_message.rebased.patch], [attachment:trac_11342_fix_pari_initialization.patch]\n+\n``````\n",
    "created_at": "2011-08-22T21:45:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155331",
    "user": "https://github.com/vbraun"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -6,4 +6,5 @@
 
 Depends on #9944
 
-Apply [attachment:trac11342-attribute_error_message.rebased.patch]
+Apply [attachment:trac11342-attribute_error_message.rebased.patch], [attachment:trac_11342_fix_pari_initialization.patch]
+
``````




---

archive/issue_comments_155332.json:
```json
{
    "body": "<a id='comment:39'></a>\nReplying to [vbraun](#comment%3A36):\n> Notice how Pari's `PariInstance.__init__` generates elements like `PariInstance.PARI_ZERO`. But during the construction of `pari_instance`, it can't set the parent to anything non-null. \n\n\nYes it can! If I understand correctly, you say that the pari instance creates some elements while its own initialisation is not complete yet. Apparently it is supposed that there exists exactly one pari instance. Hence, if that instance is initialised, and if some elements are created during initialisation, then one can certainly assign `self` to the `._parent` attribute of these elements.\n\nBut, frankly, the `__init__` in sage/libs/pari/gen.pyx at line 391 is very improper. I mean, there is that pari instance P -- all elements are supposed to have an init method accepting a an argument `parent`.\n\nAnyway. I guess the fix for that problem will take place in the initialisation of the pari instance.\n\nBy the way, building sage-4.7.2.alpha2 was shorter than I thought. Problem: I do *not* get the segfault! Is the segfault supposed to happen when Sage starts? Or is it in some test?\n\nI see that Volker already has a patch. It is a shame that I can still not reproduce the error, but I'll have a look at the new patch.",
    "created_at": "2011-08-22T21:51:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155332",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:39'></a>
Replying to [vbraun](#comment%3A36):
> Notice how Pari's `PariInstance.__init__` generates elements like `PariInstance.PARI_ZERO`. But during the construction of `pari_instance`, it can't set the parent to anything non-null. 


Yes it can! If I understand correctly, you say that the pari instance creates some elements while its own initialisation is not complete yet. Apparently it is supposed that there exists exactly one pari instance. Hence, if that instance is initialised, and if some elements are created during initialisation, then one can certainly assign `self` to the `._parent` attribute of these elements.

But, frankly, the `__init__` in sage/libs/pari/gen.pyx at line 391 is very improper. I mean, there is that pari instance P -- all elements are supposed to have an init method accepting a an argument `parent`.

Anyway. I guess the fix for that problem will take place in the initialisation of the pari instance.

By the way, building sage-4.7.2.alpha2 was shorter than I thought. Problem: I do *not* get the segfault! Is the segfault supposed to happen when Sage starts? Or is it in some test?

I see that Volker already has a patch. It is a shame that I can still not reproduce the error, but I'll have a look at the new patch.



---

archive/issue_comments_155333.json:
```json
{
    "body": "<a id='comment:40'></a>\nYep, your patch looks nice. Probably  I would have done\n\n```\nself.PARI_ZERO = self.new_gen_noclear(gen_0)\nself.PARI_ZERO._parent = self\n```\nbut I think that'll work as well.\n\nJeroen, are you able to reproduce the segfault when only my patch is applied? Then perhaps you could review Volker's patch. To me, it seems reasonable that it fixes the problem, but I can not reproduce the problem.",
    "created_at": "2011-08-22T21:57:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155333",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:40'></a>
Yep, your patch looks nice. Probably  I would have done

```
self.PARI_ZERO = self.new_gen_noclear(gen_0)
self.PARI_ZERO._parent = self
```
but I think that'll work as well.

Jeroen, are you able to reproduce the segfault when only my patch is applied? Then perhaps you could review Volker's patch. To me, it seems reasonable that it fixes the problem, but I can not reproduce the problem.



---

archive/issue_comments_155334.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-08-22T21:57:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155334",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_155335.json:
```json
{
    "body": "<a id='comment:41'></a>\nFixing up the element's parent in the parent ctor works here, but in general will lead you to elements with incomplete parents until the parent ctor finishes. This might lead  to weird errors if you do anything non-trivial with the elements. I think that, as a rule of thumb, parent ctors should never create elements.\n\nIts an implementation detail whether you get the segfault or not. There is a C struct with an uninitialized pointer, and dereferencing it may or may not segfault.",
    "created_at": "2011-08-22T22:03:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155335",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:41'></a>
Fixing up the element's parent in the parent ctor works here, but in general will lead you to elements with incomplete parents until the parent ctor finishes. This might lead  to weird errors if you do anything non-trivial with the elements. I think that, as a rule of thumb, parent ctors should never create elements.

Its an implementation detail whether you get the segfault or not. There is a C struct with an uninitialized pointer, and dereferencing it may or may not segfault.



---

archive/issue_comments_155336.json:
```json
{
    "body": "<a id='comment:42'></a>\nVolker, could you wrap the initialization of `PARI_ZERO`,... with `sig_on()`/`sig_off()`, just like it was before in `__init__()`?",
    "created_at": "2011-08-23T06:33:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155336",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:42'></a>
Volker, could you wrap the initialization of `PARI_ZERO`,... with `sig_on()`/`sig_off()`, just like it was before in `__init__()`?



---

archive/issue_comments_155337.json:
```json
{
    "body": "Reviewer: Jeroen Demeyer",
    "created_at": "2011-08-23T06:33:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155337",
    "user": "https://github.com/jdemeyer"
}
```

Reviewer: Jeroen Demeyer



---

archive/issue_comments_155338.json:
```json
{
    "body": "Updated patch",
    "created_at": "2011-08-24T04:19:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155338",
    "user": "https://github.com/vbraun"
}
```

Updated patch



---

archive/issue_comments_155339.json:
```json
{
    "body": "<a id='comment:43'></a>\nAttachment [trac_11342_fix_pari_initialization.patch](tarball://root/attachments/some-uuid/ticket11342/trac_11342_fix_pari_initialization.patch) by @vbraun created at 2011-08-24 04:19:43\n\nI've added the sig_on/sig_off in the patch.",
    "created_at": "2011-08-24T04:19:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155339",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:43'></a>
Attachment [trac_11342_fix_pari_initialization.patch](tarball://root/attachments/some-uuid/ticket11342/trac_11342_fix_pari_initialization.patch) by @vbraun created at 2011-08-24 04:19:43

I've added the sig_on/sig_off in the patch.



---

archive/issue_comments_155340.json:
```json
{
    "body": "<a id='comment:44'></a>\nI'm still getting segfaults. Does `make ptest` complete for you? I get the following doctest errors\n\n```\n\tsage -t  -force_lib .7.2.alpha1/devel/sage/sage/rings/pari_ring.py # Killed/crashed\n\tsage -t  -force_lib .7.2.alpha1/devel/sage/sage/crypto/classical_cipher.py # Killed/crashed\n\tsage -t  -force_lib .7.2.alpha1/devel/sage/sage/algebras/quatalg/quaternion_algebra.py # Killed/crashed\n\tsage -t  -force_lib .7.2.alpha1/devel/sage/sage/modular/abvar/abvar.py # Killed/crashed\n\tsage -t  -force_lib .7.2.alpha1/devel/sage/sage/modular/quatalg/brandt.py # Killed/crashed\n\tsage -t  -force_lib .7.2.alpha1/devel/sage/sage/schemes/elliptic_curves/heegner.py # Killed/crashed\n```\nThe first one is this:\n\n```\nsage: R = PariRing()\nsage: f = R('x^3 + 1/2')\nsage: f.dumps()\n\nProgram received signal SIGSEGV, Segmentation fault.\nPyObject_GetAttr (v=0x0, name=0x10393e8) at Objects/object.c:1174\n1174\tObjects/object.c: No such file or directory.\n\tin Objects/object.c\nMissing separate debuginfos, use: debuginfo-install atlas-3.8.3-18.fc14.x86_64 expat-2.0.1-11.fc15.x86_64 fontconfig-2.8.0-3.fc15.x86_64 glibc-2.14-5.x86_64 keyutils-libs-1.2-7.fc15.x86_64 krb5-libs-1.9.1-5.fc15.x86_64 libcom_err-1.41.14-2.fc15.x86_64 libgcc-4.6.0-10.fc15.x86_64 libgfortran-4.6.0-10.fc15.x86_64 libquadmath-4.6.0-10.fc15.x86_64 libselinux-2.0.99-4.fc15.x86_64 libstdc++-4.6.0-10.fc15.x86_64 nss-softokn-freebl-3.12.10-2.fc15.x86_64 openssl-1.0.0d-1.fc15.x86_64\n(gdb) bt\n#0  PyObject_GetAttr (v=0x0, name=0x10393e8) at Objects/object.c:1174\n#1  0x00007fffea27c2e1 in __pyx_pf_4sage_9structure_7element_7Element_3__getattr__ (__pyx_v_name=0x7ffff7bdfab0, __pyx_v_self=0x4aebeb0) at sage/structure/element.c:2795\n#2  __pyx_tp_getattro_4sage_9structure_7element_Element (n=0x7ffff7bdfab0, o=0x4aebeb0) at sage/structure/element.c:23398\n#3  __pyx_tp_getattro_4sage_9structure_7element_Element (o=0x4aebeb0, n=0x7ffff7bdfab0) at sage/structure/element.c:23394\n#4  0x00007ffff7cc4a0d in PyObject_GetAttrString (name=<optimized out>, v=0x4aebeb0) at Objects/object.c:1138\n#5  PyObject_GetAttrString (v=0x4aebeb0, name=<optimized out>) at Objects/object.c:1129\n#6  0x00007ffff7cdd733 in reduce_2 (obj=0x4aebeb0) at Objects/typeobject.c:3183\n#7  0x00007ffff7cde048 in _common_reduce (proto=2, self=0x4aebeb0) at Objects/typeobject.c:3327\n#8  object_reduce_ex (self=0x4aebeb0, args=<optimized out>) at Objects/typeobject.c:3389\n#9  0x00007ffff7c8a763 in PyObject_Call (func=0x4a991b8, arg=<optimized out>, kw=<optimized out>) at Objects/abstract.c:2492\n#10 0x00007fffee745d16 in save (self=0x79d788, args=0x4aebeb0, pers_save=0) at /home/vbraun/opt/sage-4.7.2.alpha1/spkg/build/python-2.6.4.p11/src/Modules/cPickle.c:2648\n#11 0x00007fffee7475b8 in dump (self=0x79d788, args=0x4aebeb0) at /home/vbraun/opt/sage-4.7.2.alpha1/spkg/build/python-2.6.4.p11/src/Modules/cPickle.c:2714\n```",
    "created_at": "2011-08-24T05:25:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155340",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:44'></a>
I'm still getting segfaults. Does `make ptest` complete for you? I get the following doctest errors

```
	sage -t  -force_lib .7.2.alpha1/devel/sage/sage/rings/pari_ring.py # Killed/crashed
	sage -t  -force_lib .7.2.alpha1/devel/sage/sage/crypto/classical_cipher.py # Killed/crashed
	sage -t  -force_lib .7.2.alpha1/devel/sage/sage/algebras/quatalg/quaternion_algebra.py # Killed/crashed
	sage -t  -force_lib .7.2.alpha1/devel/sage/sage/modular/abvar/abvar.py # Killed/crashed
	sage -t  -force_lib .7.2.alpha1/devel/sage/sage/modular/quatalg/brandt.py # Killed/crashed
	sage -t  -force_lib .7.2.alpha1/devel/sage/sage/schemes/elliptic_curves/heegner.py # Killed/crashed
```
The first one is this:

```
sage: R = PariRing()
sage: f = R('x^3 + 1/2')
sage: f.dumps()

Program received signal SIGSEGV, Segmentation fault.
PyObject_GetAttr (v=0x0, name=0x10393e8) at Objects/object.c:1174
1174	Objects/object.c: No such file or directory.
	in Objects/object.c
Missing separate debuginfos, use: debuginfo-install atlas-3.8.3-18.fc14.x86_64 expat-2.0.1-11.fc15.x86_64 fontconfig-2.8.0-3.fc15.x86_64 glibc-2.14-5.x86_64 keyutils-libs-1.2-7.fc15.x86_64 krb5-libs-1.9.1-5.fc15.x86_64 libcom_err-1.41.14-2.fc15.x86_64 libgcc-4.6.0-10.fc15.x86_64 libgfortran-4.6.0-10.fc15.x86_64 libquadmath-4.6.0-10.fc15.x86_64 libselinux-2.0.99-4.fc15.x86_64 libstdc++-4.6.0-10.fc15.x86_64 nss-softokn-freebl-3.12.10-2.fc15.x86_64 openssl-1.0.0d-1.fc15.x86_64
(gdb) bt
#0  PyObject_GetAttr (v=0x0, name=0x10393e8) at Objects/object.c:1174
#1  0x00007fffea27c2e1 in __pyx_pf_4sage_9structure_7element_7Element_3__getattr__ (__pyx_v_name=0x7ffff7bdfab0, __pyx_v_self=0x4aebeb0) at sage/structure/element.c:2795
#2  __pyx_tp_getattro_4sage_9structure_7element_Element (n=0x7ffff7bdfab0, o=0x4aebeb0) at sage/structure/element.c:23398
#3  __pyx_tp_getattro_4sage_9structure_7element_Element (o=0x4aebeb0, n=0x7ffff7bdfab0) at sage/structure/element.c:23394
#4  0x00007ffff7cc4a0d in PyObject_GetAttrString (name=<optimized out>, v=0x4aebeb0) at Objects/object.c:1138
#5  PyObject_GetAttrString (v=0x4aebeb0, name=<optimized out>) at Objects/object.c:1129
#6  0x00007ffff7cdd733 in reduce_2 (obj=0x4aebeb0) at Objects/typeobject.c:3183
#7  0x00007ffff7cde048 in _common_reduce (proto=2, self=0x4aebeb0) at Objects/typeobject.c:3327
#8  object_reduce_ex (self=0x4aebeb0, args=<optimized out>) at Objects/typeobject.c:3389
#9  0x00007ffff7c8a763 in PyObject_Call (func=0x4a991b8, arg=<optimized out>, kw=<optimized out>) at Objects/abstract.c:2492
#10 0x00007fffee745d16 in save (self=0x79d788, args=0x4aebeb0, pers_save=0) at /home/vbraun/opt/sage-4.7.2.alpha1/spkg/build/python-2.6.4.p11/src/Modules/cPickle.c:2648
#11 0x00007fffee7475b8 in dump (self=0x79d788, args=0x4aebeb0) at /home/vbraun/opt/sage-4.7.2.alpha1/spkg/build/python-2.6.4.p11/src/Modules/cPickle.c:2714
```



---

archive/issue_comments_155341.json:
```json
{
    "body": "<a id='comment:45'></a>\nOk I looked at `sage/rings/pari_ring.py` and it makes my eyes bleed... The elements don't call `RingElement.__init__` so their parent is not set. Also, should use `UniqueRepresentation`. But is anybody using that module?",
    "created_at": "2011-08-24T06:20:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155341",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:45'></a>
Ok I looked at `sage/rings/pari_ring.py` and it makes my eyes bleed... The elements don't call `RingElement.__init__` so their parent is not set. Also, should use `UniqueRepresentation`. But is anybody using that module?



---

archive/issue_comments_155342.json:
```json
{
    "body": "<a id='comment:46'></a>\nReplying to [vbraun](#comment%3A45):\n> Ok I looked at `sage/rings/pari_ring.py` and it makes my eyes bleed... The elements don't call `RingElement.__init__` so their parent is not set. Also, should use `UniqueRepresentation`. But is anybody using that module?\n\n\nI guess, implicitly we are using it all: As we have seen, some pari objects are generated when sage starts. And you are right, it is evident that sage/rings/pari_ring.py has been written long time ago...\n\nDo you think we should attempt to bring it up to date *here*? Or do it on a different ticket and just use the work-around provided by [attachment:trac_11342_fix_pari_initialization.patch]?\n\nIf we fix it here: Did you already start with it? Otherwise, I'd do it myself.",
    "created_at": "2011-08-24T08:37:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155342",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:46'></a>
Replying to [vbraun](#comment%3A45):
> Ok I looked at `sage/rings/pari_ring.py` and it makes my eyes bleed... The elements don't call `RingElement.__init__` so their parent is not set. Also, should use `UniqueRepresentation`. But is anybody using that module?


I guess, implicitly we are using it all: As we have seen, some pari objects are generated when sage starts. And you are right, it is evident that sage/rings/pari_ring.py has been written long time ago...

Do you think we should attempt to bring it up to date *here*? Or do it on a different ticket and just use the work-around provided by [attachment:trac_11342_fix_pari_initialization.patch]?

If we fix it here: Did you already start with it? Otherwise, I'd do it myself.



---

archive/issue_comments_155343.json:
```json
{
    "body": "<a id='comment:47'></a>\nVolker, I am *not* getting the segfault you reported.\n\nWith the current two patches, I obtain:\n\n```\nsage: R = PariRing()\nsage: loads(R.dumps()) == R\nTrue\nsage: loads(R.dumps()) is R  # I want to fix that!\nFalse\nsage: f = R('x^3 + 1/2')\nsage: f.dumps()\n'x\\x9ck`J.NLO\\xd5+\\xca\\xccK/\\xd6+H,\\xca\\x8c\\x071\\xb9\\x02\\x80,\\xaeBF\\xcd\\xc6B&\\xbf\\xdaB\\xe6P\\x8ex\\x90H||E!\\x0bDCNf\\x12D\\xbd^zj^|A%W\\x01X\\x07k(gE\\x9c\\xb1\\x82\\xb6\\x82\\xa1\\xbeQkP![q[\\x92\\x1e\\x00\\xbc9 \\xf7'\n```\n\nSo, the question is whether we should fix it here, or open a new ticket and make it a dependency.",
    "created_at": "2011-08-24T08:47:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155343",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:47'></a>
Volker, I am *not* getting the segfault you reported.

With the current two patches, I obtain:

```
sage: R = PariRing()
sage: loads(R.dumps()) == R
True
sage: loads(R.dumps()) is R  # I want to fix that!
False
sage: f = R('x^3 + 1/2')
sage: f.dumps()
'x\x9ck`J.NLO\xd5+\xca\xccK/\xd6+H,\xca\x8c\x071\xb9\x02\x80,\xaeBF\xcd\xc6B&\xbf\xdaB\xe6P\x8ex\x90H||E!\x0bDCNf\x12D\xbd^zj^|A%W\x01X\x07k(gE\x9c\xb1\x82\xb6\x82\xa1\xbeQkP![q[\x92\x1e\x00\xbc9 \xf7'
```

So, the question is whether we should fix it here, or open a new ticket and make it a dependency.



---

archive/issue_comments_155344.json:
```json
{
    "body": "Some fixes for the Pari pseudoring",
    "created_at": "2011-08-24T09:31:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155344",
    "user": "https://github.com/simon-king-jena"
}
```

Some fixes for the Pari pseudoring



---

archive/issue_comments_155345.json:
```json
{
    "body": "<a id='comment:48'></a>\nAttachment [trac_11342_fix_pari_ring.patch](tarball://root/attachments/some-uuid/ticket11342/trac_11342_fix_pari_ring.patch) by @simon-king-jena created at 2011-08-24 09:33:34\n\nI have already produced a patch on the pari ring problem. Volker, does it make your segfault vanish? At least, I think that my patch improves the code quality of pari_ring.py.",
    "created_at": "2011-08-24T09:33:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155345",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:48'></a>
Attachment [trac_11342_fix_pari_ring.patch](tarball://root/attachments/some-uuid/ticket11342/trac_11342_fix_pari_ring.patch) by @simon-king-jena created at 2011-08-24 09:33:34

I have already produced a patch on the pari ring problem. Volker, does it make your segfault vanish? At least, I think that my patch improves the code quality of pari_ring.py.



---

archive/issue_comments_155346.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -6,5 +6,9 @@\n \n Depends on #9944\n \n-Apply [attachment:trac11342-attribute_error_message.rebased.patch], [attachment:trac_11342_fix_pari_initialization.patch]\n+Apply \n \n+* [attachment:trac11342-attribute_error_message.rebased.patch]\n+* [attachment:trac_11342_fix_pari_initialization.patch]\n+* [attachment:trac_11342_fix_pari_ring.patch]\n+\n``````\n",
    "created_at": "2011-08-24T09:33:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155346",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -6,5 +6,9 @@
 
 Depends on #9944
 
-Apply [attachment:trac11342-attribute_error_message.rebased.patch], [attachment:trac_11342_fix_pari_initialization.patch]
+Apply 
 
+* [attachment:trac11342-attribute_error_message.rebased.patch]
+* [attachment:trac_11342_fix_pari_initialization.patch]
+* [attachment:trac_11342_fix_pari_ring.patch]
+
``````




---

archive/issue_comments_155347.json:
```json
{
    "body": "Attachment [trac_11342_crypto_fixes.patch](tarball://root/attachments/some-uuid/ticket11342/trac_11342_crypto_fixes.patch) by @vbraun created at 2011-08-24 16:30:50\n\nInitial patch",
    "created_at": "2011-08-24T16:30:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155347",
    "user": "https://github.com/vbraun"
}
```

Attachment [trac_11342_crypto_fixes.patch](tarball://root/attachments/some-uuid/ticket11342/trac_11342_crypto_fixes.patch) by @vbraun created at 2011-08-24 16:30:50

Initial patch



---

archive/issue_comments_155348.json:
```json
{
    "body": "<a id='comment:49'></a>\nYour patch fixes the `pari_ring` segfaults and looks great!\n\nI've fixed the crash in `sage/crypto/classical_cipher.py` in the patch that I just posted.\n\nThe next crash, in `sage/algebras/quatalg/quaternion_algebra.py`, is more tricky. Ideals in quaternion algebras don't have their parent set. The `QuaternionFractionalIdeal_rational` class derives from `sage.ring.ideal` which assumes it is an ideal in a commutative ring, see `sage.ring.ideal_monoid`.",
    "created_at": "2011-08-24T16:35:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155348",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:49'></a>
Your patch fixes the `pari_ring` segfaults and looks great!

I've fixed the crash in `sage/crypto/classical_cipher.py` in the patch that I just posted.

The next crash, in `sage/algebras/quatalg/quaternion_algebra.py`, is more tricky. Ideals in quaternion algebras don't have their parent set. The `QuaternionFractionalIdeal_rational` class derives from `sage.ring.ideal` which assumes it is an ideal in a commutative ring, see `sage.ring.ideal_monoid`.



---

archive/issue_comments_155349.json:
```json
{
    "body": "<a id='comment:50'></a>\nReplying to [vbraun](#comment%3A49):\n> Your patch fixes the `pari_ring` segfaults and looks great!\n\n\nThank you!\n\n> I've fixed the crash in `sage/crypto/classical_cipher.py` in the patch that I just posted.\n\n\nOK, I'll have a look (but the problem is that I can't verify that it fixes a segfault, because I don't get a segfault.\n\n> \n> The next crash, in `sage/algebras/quatalg/quaternion_algebra.py`, is more tricky. Ideals in quaternion algebras don't have their parent set. The `QuaternionFractionalIdeal_rational` class derives from `sage.ring.ideal` which assumes it is an ideal in a commutative ring, see `sage.ring.ideal_monoid`.\n\n\nToo bad. There is #11068, which introduces *proper* support for one- and twosided ideals in non-commutative rings. But that comes much later in my patch chain...\n\nPerhaps we can use a temporary workaround: `__getattr__` could not only test whether `self._parent._category` is None, but whether `self._parent` is None.\n\nOf course, any additional test will affect the performance. But perhaps it is still acceptable? I think that would be the easiest solution, so, let's do some tests with it.",
    "created_at": "2011-08-24T16:49:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155349",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:50'></a>
Replying to [vbraun](#comment%3A49):
> Your patch fixes the `pari_ring` segfaults and looks great!


Thank you!

> I've fixed the crash in `sage/crypto/classical_cipher.py` in the patch that I just posted.


OK, I'll have a look (but the problem is that I can't verify that it fixes a segfault, because I don't get a segfault.

> 
> The next crash, in `sage/algebras/quatalg/quaternion_algebra.py`, is more tricky. Ideals in quaternion algebras don't have their parent set. The `QuaternionFractionalIdeal_rational` class derives from `sage.ring.ideal` which assumes it is an ideal in a commutative ring, see `sage.ring.ideal_monoid`.


Too bad. There is #11068, which introduces *proper* support for one- and twosided ideals in non-commutative rings. But that comes much later in my patch chain...

Perhaps we can use a temporary workaround: `__getattr__` could not only test whether `self._parent._category` is None, but whether `self._parent` is None.

Of course, any additional test will affect the performance. But perhaps it is still acceptable? I think that would be the easiest solution, so, let's do some tests with it.



---

archive/issue_comments_155350.json:
```json
{
    "body": "<a id='comment:51'></a>\nThe crypto fix looks nice. I didn't run the doc tests yet, but \"what could possibly go wrong\"?\n\nI think it should be used even if the segfaults could be used in a different way. That's to say, I will add `if self._parent is not None` to `__getattr__` and run all tests with *both* your new and my to-be-created patch.",
    "created_at": "2011-08-24T16:55:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155350",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:51'></a>
The crypto fix looks nice. I didn't run the doc tests yet, but "what could possibly go wrong"?

I think it should be used even if the segfaults could be used in a different way. That's to say, I will add `if self._parent is not None` to `__getattr__` and run all tests with *both* your new and my to-be-created patch.



---

archive/issue_comments_155351.json:
```json
{
    "body": "<a id='comment:52'></a>\nI have added a new patch. Since *any* element has a parent, I do actually not test whether `self._parent is None`. Instead, I do `cdef Parent P = self._parent or self.parent()`.\n\nThat works, because `self.parent()` is supposed to return something (even in cases of improper elements as we have met them in Pari). Moreover, it is fast, since the slow call `self.parent()` will not be used if `self._parent` is not None.\n\nSince the parent needs to be retrieved anyway, my new patch essentially preserves the performance. So, the additional test is essentially for free.\n\nI suppose that my patch would suffice to fix the problem. However, Volker's crypto patch improves the code quality and thus should be included as well.\n\nFor me, the tests pass when adding Volker's and my patch. But, after all, I did not suffer from the segfault. So, please see if it's fixed!\n\nApply trac11342-attribute_error_message.rebased.patch, trac_11342_fix_pari_initialization.patch, trac_11342_fix_pari_ring.patch, trac_11342_crypto_fixes.patch, trac11342_test_parent_on_getattr.patch",
    "created_at": "2011-08-24T19:14:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155351",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:52'></a>
I have added a new patch. Since *any* element has a parent, I do actually not test whether `self._parent is None`. Instead, I do `cdef Parent P = self._parent or self.parent()`.

That works, because `self.parent()` is supposed to return something (even in cases of improper elements as we have met them in Pari). Moreover, it is fast, since the slow call `self.parent()` will not be used if `self._parent` is not None.

Since the parent needs to be retrieved anyway, my new patch essentially preserves the performance. So, the additional test is essentially for free.

I suppose that my patch would suffice to fix the problem. However, Volker's crypto patch improves the code quality and thus should be included as well.

For me, the tests pass when adding Volker's and my patch. But, after all, I did not suffer from the segfault. So, please see if it's fixed!

Apply trac11342-attribute_error_message.rebased.patch, trac_11342_fix_pari_initialization.patch, trac_11342_fix_pari_ring.patch, trac_11342_crypto_fixes.patch, trac11342_test_parent_on_getattr.patch



---

archive/issue_comments_155352.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -11,4 +11,6 @@\n * [attachment:trac11342-attribute_error_message.rebased.patch]\n * [attachment:trac_11342_fix_pari_initialization.patch]\n * [attachment:trac_11342_fix_pari_ring.patch]\n+* [attachment:trac_11342_crypto_fixes.patch]\n+* [attachment:trac11342_test_parent_on_getattr.patch]\n \n``````\n",
    "created_at": "2011-08-24T19:14:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155352",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -11,4 +11,6 @@
 * [attachment:trac11342-attribute_error_message.rebased.patch]
 * [attachment:trac_11342_fix_pari_initialization.patch]
 * [attachment:trac_11342_fix_pari_ring.patch]
+* [attachment:trac_11342_crypto_fixes.patch]
+* [attachment:trac11342_test_parent_on_getattr.patch]
 
``````




---

archive/issue_comments_155353.json:
```json
{
    "body": "<a id='comment:53'></a>\nThats not good enough because e.g. the ideals in the quaternion algebra return ``None`` as `parent()`, too. Without this patch:\n\n```\nsage: R = QuaternionAlgebra(-11,-1).maximal_order()\nsage: R.right_ideal(R.basis())\nFractional ideal (1/2 + 1/2*j, 1/2*i + 1/2*k, j, k)\nsage: R.unit_ideal().parent() is None\nTrue\n```\nand with this ticket it still segfaults.",
    "created_at": "2011-08-24T20:47:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155353",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:53'></a>
Thats not good enough because e.g. the ideals in the quaternion algebra return ``None`` as `parent()`, too. Without this patch:

```
sage: R = QuaternionAlgebra(-11,-1).maximal_order()
sage: R.right_ideal(R.basis())
Fractional ideal (1/2 + 1/2*j, 1/2*i + 1/2*k, j, k)
sage: R.unit_ideal().parent() is None
True
```
and with this ticket it still segfaults.



---

archive/issue_comments_155354.json:
```json
{
    "body": "<a id='comment:54'></a>\nReplying to [vbraun](#comment%3A53):\n> Thats not good enough because e.g. the ideals in the quaternion algebra return ``None`` as `parent()`, too.\n\n\nToo bad. Then I'll try the more radical solution and test whether P is None.",
    "created_at": "2011-08-25T07:57:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155354",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:54'></a>
Replying to [vbraun](#comment%3A53):
> Thats not good enough because e.g. the ideals in the quaternion algebra return ``None`` as `parent()`, too.


Too bad. Then I'll try the more radical solution and test whether P is None.



---

archive/issue_comments_155355.json:
```json
{
    "body": "<a id='comment:55'></a>\nAnd, by the way, even my patch on ideals in non-commutative rings wouldn't solve the problems with Quaternion algebra, since #11068 is about ideals, not fractional ideals.",
    "created_at": "2011-08-25T08:10:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155355",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:55'></a>
And, by the way, even my patch on ideals in non-commutative rings wouldn't solve the problems with Quaternion algebra, since #11068 is about ideals, not fractional ideals.



---

archive/issue_comments_155356.json:
```json
{
    "body": "Attachment [trac11342_test_parent_on_getattr.patch](tarball://root/attachments/some-uuid/ticket11342/trac11342_test_parent_on_getattr.patch) by @simon-king-jena created at 2011-08-25 08:21:43\n\nTest whether self._parent is None, before requestin self._parent._category",
    "created_at": "2011-08-25T08:21:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155356",
    "user": "https://github.com/simon-king-jena"
}
```

Attachment [trac11342_test_parent_on_getattr.patch](tarball://root/attachments/some-uuid/ticket11342/trac11342_test_parent_on_getattr.patch) by @simon-king-jena created at 2011-08-25 08:21:43

Test whether self._parent is None, before requestin self._parent._category



---

archive/issue_comments_155357.json:
```json
{
    "body": "<a id='comment:56'></a>\nI just updated my last patch. It should be absolutely airtight, since it is now explicitly tested whether the parent is None.\n\nThe timings, which is the main point of this ticket, are still fine. They did almost not change compared with the old patches, but they are much better than with unpatched sage-4.7.2.alpha2:\n\n1. non-existing private attributes\n\n```\nsage: a = 1\nsage: timeit('try: QQ.__bla\\nexcept: pass')\n625 loops, best of 3: 10.8 \u00b5s per loop\n#unpatched: 15 \u00b5s per loop\nsage: timeit('try: a.__bla\\nexcept: pass')\n625 loops, best of 3: 9.07 \u00b5s per loop\n#unpatched: 13.9 \u00b5s per loop\nsage: timeit('try: QQ.__bla_\\nexcept: pass')\n625 loops, best of 3: 14.3 \u00b5s per loop\n#unpatched: 22.8 \u00b5s per loop\n```\n\n2. non-existing non-private attributes\n\n```\nsage: timeit('try: QQ.__bla_\\nexcept: pass')\n625 loops, best of 3: 14.2 \u00b5s per loop\n#unpatched: 23 \u00b5s per loop\nsage: timeit('try: a.__bla_\\nexcept: pass')\n625 loops, best of 3: 17.3 \u00b5s per loop\n#unpatched: 23.2 \u00b5s per loop\nsage: timeit('try: QQ.bla\\nexcept: pass')\n625 loops, best of 3: 13.9 \u00b5s per loop\n#unpatched: 22.6 \u00b5s per loop\nsage: timeit('try: a.bla\\nexcept: pass')\n625 loops, best of 3: 16.6 \u00b5s per loop\n#unpatched: 25.9 \u00b5s per loop\n```\n\n3. existing attributes inherited from the category\n\n```\nsage: timeit('try: QQ.sum\\nexcept: pass',number=10^5)\n100000 loops, best of 3: 744 ns per loop\n#unpatched: 754 ns per loop\nsage: timeit('try: a.cartesian_product\\nexcept: pass',number=10^5)\n100000 loops, best of 3: 1.68 \u00b5s per loop\n#unpatched: 3.97 \u00b5s per loop\n```\n\nI hope that the segfaults are finally gone!!\n\nApply trac11342-attribute_error_message.rebased.patch, trac_11342_fix_pari_initialization.patch, trac_11342_fix_pari_ring.patch, trac_11342_crypto_fixes.patch, trac11342_test_parent_on_getattr.patch",
    "created_at": "2011-08-25T08:39:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155357",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:56'></a>
I just updated my last patch. It should be absolutely airtight, since it is now explicitly tested whether the parent is None.

The timings, which is the main point of this ticket, are still fine. They did almost not change compared with the old patches, but they are much better than with unpatched sage-4.7.2.alpha2:

1. non-existing private attributes

```
sage: a = 1
sage: timeit('try: QQ.__bla\nexcept: pass')
625 loops, best of 3: 10.8 µs per loop
#unpatched: 15 µs per loop
sage: timeit('try: a.__bla\nexcept: pass')
625 loops, best of 3: 9.07 µs per loop
#unpatched: 13.9 µs per loop
sage: timeit('try: QQ.__bla_\nexcept: pass')
625 loops, best of 3: 14.3 µs per loop
#unpatched: 22.8 µs per loop
```

2. non-existing non-private attributes

```
sage: timeit('try: QQ.__bla_\nexcept: pass')
625 loops, best of 3: 14.2 µs per loop
#unpatched: 23 µs per loop
sage: timeit('try: a.__bla_\nexcept: pass')
625 loops, best of 3: 17.3 µs per loop
#unpatched: 23.2 µs per loop
sage: timeit('try: QQ.bla\nexcept: pass')
625 loops, best of 3: 13.9 µs per loop
#unpatched: 22.6 µs per loop
sage: timeit('try: a.bla\nexcept: pass')
625 loops, best of 3: 16.6 µs per loop
#unpatched: 25.9 µs per loop
```

3. existing attributes inherited from the category

```
sage: timeit('try: QQ.sum\nexcept: pass',number=10^5)
100000 loops, best of 3: 744 ns per loop
#unpatched: 754 ns per loop
sage: timeit('try: a.cartesian_product\nexcept: pass',number=10^5)
100000 loops, best of 3: 1.68 µs per loop
#unpatched: 3.97 µs per loop
```

I hope that the segfaults are finally gone!!

Apply trac11342-attribute_error_message.rebased.patch, trac_11342_fix_pari_initialization.patch, trac_11342_fix_pari_ring.patch, trac_11342_crypto_fixes.patch, trac11342_test_parent_on_getattr.patch



---

archive/issue_comments_155358.json:
```json
{
    "body": "<a id='comment:57'></a>\nWhen combining this ticket with #9138 then another pari test fails (because #9138 initialises some category that here is expected to be not initialised).\n\nHow to proceed? Both tickets are not positively reviewed yet.",
    "created_at": "2011-09-07T10:51:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155358",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:57'></a>
When combining this ticket with #9138 then another pari test fails (because #9138 initialises some category that here is expected to be not initialised).

How to proceed? Both tickets are not positively reviewed yet.



---

archive/issue_comments_155359.json:
```json
{
    "body": "Changing reviewer from \"Jeroen Demeyer\" to \"Jeroen Demeyer, Volker Braun\"",
    "created_at": "2011-09-07T14:21:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155359",
    "user": "https://github.com/vbraun"
}
```

Changing reviewer from "Jeroen Demeyer" to "Jeroen Demeyer, Volker Braun"



---

archive/issue_comments_155360.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-09-07T14:21:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155360",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_155361.json:
```json
{
    "body": "<a id='comment:58'></a>\nWe should probably merge this ticket first since it is more low-level. I'm happy with it, so positive review for everything except `trac_11342_crypto_fixes.patch` and `trac_11342_fix_pari_initialization.patch` (which I wrote). Simon and Jeroen already reviewed those somewhat trivial patches, so everything is good to go.",
    "created_at": "2011-09-07T14:21:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155361",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:58'></a>
We should probably merge this ticket first since it is more low-level. I'm happy with it, so positive review for everything except `trac_11342_crypto_fixes.patch` and `trac_11342_fix_pari_initialization.patch` (which I wrote). Simon and Jeroen already reviewed those somewhat trivial patches, so everything is good to go.



---

archive/issue_comments_155362.json:
```json
{
    "body": "<a id='comment:59'></a>\nIf it is needed (one could argue that your patches are small enough to be reviewer patches), I give your patches a positive review as well.",
    "created_at": "2011-09-07T14:52:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155362",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:59'></a>
If it is needed (one could argue that your patches are small enough to be reviewer patches), I give your patches a positive review as well.



---

archive/issue_comments_155363.json:
```json
{
    "body": "Changing reviewer from \"Jeroen Demeyer, Volker Braun\" to \"Jeroen Demeyer, Volker Braun, Simon King\"",
    "created_at": "2011-09-12T01:46:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155363",
    "user": "https://github.com/nexttime"
}
```

Changing reviewer from "Jeroen Demeyer, Volker Braun" to "Jeroen Demeyer, Volker Braun, Simon King"



---

archive/issue_comments_155364.json:
```json
{
    "body": "Changing author from \"Simon King\" to \"Simon King, Volker Braun\"",
    "created_at": "2011-09-12T01:46:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155364",
    "user": "https://github.com/nexttime"
}
```

Changing author from "Simon King" to "Simon King, Volker Braun"



---

archive/issue_comments_155365.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-09-17T04:44:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155365",
    "user": "https://github.com/nexttime"
}
```

Resolution: fixed



---

archive/issue_events_034960.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2011-09-17T04:44:34Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11342#event-34960"
}
```



---

archive/issue_comments_155366.json:
```json
{
    "body": "Merged: sage-4.7.2.alpha3",
    "created_at": "2011-09-17T04:44:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11342#issuecomment-155366",
    "user": "https://github.com/nexttime"
}
```

Merged: sage-4.7.2.alpha3
