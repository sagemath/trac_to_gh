# Issue 11790: `sage --sh -c ...` shouldn't print [that many] messages

archive/issues_011618.json:
```json
{
    "assignees": [],
    "body": "Currently, we have\n\n```sh\n$ ./sage --sh -c \"echo Hello\"\n\nStarting subshell with Sage environment variables set.\nBe sure to exit when you are done and do not do anything\nwith other copies of Sage!\n\nBypassing shell configuration files ...\n\nHello\nExited Sage subshell.\n$ \n```\nwhich is IMHO odd.\n\nAnd it's inconvenient if one wants to further process the output of some command run in a Sage subshell.\n\nIn `spkg/bin/sage`, we have:\n\n```sh\nif [ \"$1\" = '-sh'  -o \"$1\" = '--sh' ]; then\n    # AUTHORS:\n    #   Carl Witty and William Stein: initial version\n    #   Craig Citro: add options for not loading profile\n    cd \"$CUR\"\n    shift\n    echo \"\"\n    echo \"Starting subshell with Sage environment variables set.\"\n    echo \"Be sure to exit when you are done and do not do anything\"\n    echo \"with other copies of Sage!\"\n    echo \"\"\n    SHELL_NAME=`basename $SHELL`\n    echo \"Bypassing shell configuration files ...\"\n    echo\n\n    ...\n\n    $SHELL_NAME $SHELL_OPTS \"$@\"\n\n    status=$?\n    echo \"Exited Sage subshell.\"\n    exit $status\nfi\n```\n\nSo I'd propose to change `sage` to not print *any* messages if there are any further arguments to `sage --sh`.\n\nAlternatively, all (or a reduced set of) messages should at least go to `stderr` instead of `stdout`, perhaps regardless of whether `-c` was specified or not.\n\nIn addition, if we dropped the \"`Exited Sage subshell.`\" (at least in the case of `-c`), we could (or should) also use\n\n```sh\n    exec $SHELL_NAME $SHELL_OPTS \"$@\"\n```\n\n(Actually, `exec` should be used in a couple of Sage commands which don't need any \"post-processing\", e.g. by `sage`.)\n\n**Apply** [attachment: 11790_sage_sh.patch](https://github.com/sagemath/sage/files/ticket11790/11790_sage_sh.patch.gz) and [attachment: 11790_review.patch](https://github.com/sagemath/sage/files/ticket11790/11790_review.patch.gz) to the SAGE_ROOT repository.\n\nDepends on #12647\n\nCC:  @gvol\n\nKeywords: **subshell commands sage-sage environment batch mode stdout**\n\nReviewer: **Jeroen Demeyer, John Palmieri**\n\nAuthor: **John Palmieri, Jeroen Demeyer**\n\nMerged: **sage-5.0.beta9**\n\nComponent: **scripts**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/11790_\n\n",
    "closed_at": "2012-03-21T22:05:42Z",
    "created_at": "2011-09-11T15:26:48Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20scripts",
        "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.0",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "`sage --sh -c ...` shouldn't print [that many] messages",
    "type": "issue",
    "updated_at": "2012-03-21T22:05:42Z",
    "url": "https://github.com/sagemath/sage/issues/11790",
    "user": "https://github.com/nexttime"
}
```
Currently, we have

```sh
$ ./sage --sh -c "echo Hello"

Starting subshell with Sage environment variables set.
Be sure to exit when you are done and do not do anything
with other copies of Sage!

Bypassing shell configuration files ...

Hello
Exited Sage subshell.
$ 
```
which is IMHO odd.

And it's inconvenient if one wants to further process the output of some command run in a Sage subshell.

In `spkg/bin/sage`, we have:

```sh
if [ "$1" = '-sh'  -o "$1" = '--sh' ]; then
    # AUTHORS:
    #   Carl Witty and William Stein: initial version
    #   Craig Citro: add options for not loading profile
    cd "$CUR"
    shift
    echo ""
    echo "Starting subshell with Sage environment variables set."
    echo "Be sure to exit when you are done and do not do anything"
    echo "with other copies of Sage!"
    echo ""
    SHELL_NAME=`basename $SHELL`
    echo "Bypassing shell configuration files ..."
    echo

    ...

    $SHELL_NAME $SHELL_OPTS "$@"

    status=$?
    echo "Exited Sage subshell."
    exit $status
fi
```

So I'd propose to change `sage` to not print *any* messages if there are any further arguments to `sage --sh`.

Alternatively, all (or a reduced set of) messages should at least go to `stderr` instead of `stdout`, perhaps regardless of whether `-c` was specified or not.

In addition, if we dropped the "`Exited Sage subshell.`" (at least in the case of `-c`), we could (or should) also use

```sh
    exec $SHELL_NAME $SHELL_OPTS "$@"
```

(Actually, `exec` should be used in a couple of Sage commands which don't need any "post-processing", e.g. by `sage`.)

**Apply** [attachment: 11790_sage_sh.patch](https://github.com/sagemath/sage/files/ticket11790/11790_sage_sh.patch.gz) and [attachment: 11790_review.patch](https://github.com/sagemath/sage/files/ticket11790/11790_review.patch.gz) to the SAGE_ROOT repository.

Depends on #12647

CC:  @gvol

Keywords: **subshell commands sage-sage environment batch mode stdout**

Reviewer: **Jeroen Demeyer, John Palmieri**

Author: **John Palmieri, Jeroen Demeyer**

Merged: **sage-5.0.beta9**

Component: **scripts**

_Issue created by migration from https://trac.sagemath.org/ticket/11790_





---

archive/issue_events_159214.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2011-09-11T15:26:48Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "milestone_number": null,
    "milestone_title": "sage-5.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11790#event-159214"
}
```



---

archive/issue_events_159215.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2011-09-11T15:26:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20scripts",
    "label_color": "000080",
    "label_name": "c: scripts",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11790#event-159215"
}
```



---

archive/issue_events_159216.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2011-09-11T15:26:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "label": "https://github.com/sagemath/sage/labels/p%3A%204%20%E2%80%93%20minor",
    "label_color": "ffe799",
    "label_name": "p: 4 \u2013 minor",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11790#event-159216"
}
```



---

archive/issue_events_159217.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2011-09-11T15:26:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11790#event-159217"
}
```



---

archive/issue_comments_123115.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nHere's a first attempt at a patch.  This also fixes some of incorrect prompts (taken from #10822 -- the patch there will need to be rebased on this one if this one gets done first).",
    "created_at": "2011-09-13T01:32:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123115",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:1" align="right">comment:1</div>

Here's a first attempt at a patch.  This also fixes some of incorrect prompts (taken from #10822 -- the patch there will need to be rebased on this one if this one gets done first).



---

archive/issue_comments_123116.json:
```json
{
    "body": "Author: **John Palmieri**",
    "created_at": "2011-09-13T01:32:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123116",
    "user": "https://github.com/jhpalmieri"
}
```

Author: **John Palmieri**



---

archive/issue_events_159218.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2011-09-13T01:32:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11790#event-159218"
}
```



---

archive/issue_comments_123117.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nNew patch rebased w.r.t. #11866.",
    "created_at": "2011-09-28T20:49:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123117",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:2" align="right">comment:2</div>

New patch rebased w.r.t. #11866.



---

archive/issue_comments_123118.json:
```json
{
    "body": "Dependencies: **#11866**",
    "created_at": "2011-09-28T20:49:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123118",
    "user": "https://github.com/jhpalmieri"
}
```

Dependencies: **#11866**



---

archive/issue_comments_123119.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nLooks ok, but I cannot tell (or test right now) whether all prompts, and shell options regarding not executing rc files are correct.\n\nThe code testing for `-c` could be moved up, since everything else (in the `case ... esac`) is useless in this case .\n\nAlso, if `exec` returns, this means an error, so we could print some according message in this case (although *hopefully*<sup>TM</sup> the shell itself did).",
    "created_at": "2011-09-28T21:10:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123119",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:3" align="right">comment:3</div>

Looks ok, but I cannot tell (or test right now) whether all prompts, and shell options regarding not executing rc files are correct.

The code testing for `-c` could be moved up, since everything else (in the `case ... esac`) is useless in this case .

Also, if `exec` returns, this means an error, so we could print some according message in this case (although *hopefully*<sup>TM</sup> the shell itself did).



---

archive/issue_comments_123120.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nReplying to [@nexttime](#comment:3):\n> Looks ok, but I cannot tell (or test right now) whether all prompts, and shell options regarding not executing rc files are correct.\n\nOn my Mac, I was able to run \"chsh\" and then open up new terminal windows and run \"sage -sh\" to test the prompts.\n\n> The code testing for `-c` could be moved up, since everything else (in the `case ... esac`) is useless in this case .\n\nWell, if you're running \"sage --sh CMD\", it should matter whether you're running \"bash\" or \"bash --norc\", right?  The `case ... esac` stuff sets shell options like `--norc` in addition to the prompt, and I think we want this.\n\n> Also, if `exec` returns, this means an error, so we could print some according message in this case (although *hopefully*<sup>TM</sup> the shell itself did).\n\nSo are you suggesting not checking the status at all? Like this:\n\n```diff\ndiff --git a/sage-sage b/sage-sage\n--- a/sage-sage\n+++ b/sage-sage\n@@ -518,8 +518,8 @@ PS1=\"SAGE_ROOT=${SAGE_ROOT}\n     esac\n     if [ \"$1\" = '-c' ]; then\n        exec $SHELL_NAME $SHELL_OPTS \"$@\"\n-       status=$?\n-       exit $status\n+       echo \"An error seems to occurred.\" 1>&2\n+       exit 1\n     fi\n     # -c is not the first option, so print informative messages...\n     echo \"\" 1>&2\n```\nI could probably come up with a more cryptic message, though.",
    "created_at": "2011-09-28T21:29:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123120",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:4" align="right">comment:4</div>

Replying to [@nexttime](#comment:3):
> Looks ok, but I cannot tell (or test right now) whether all prompts, and shell options regarding not executing rc files are correct.

On my Mac, I was able to run "chsh" and then open up new terminal windows and run "sage -sh" to test the prompts.

> The code testing for `-c` could be moved up, since everything else (in the `case ... esac`) is useless in this case .

Well, if you're running "sage --sh CMD", it should matter whether you're running "bash" or "bash --norc", right?  The `case ... esac` stuff sets shell options like `--norc` in addition to the prompt, and I think we want this.

> Also, if `exec` returns, this means an error, so we could print some according message in this case (although *hopefully*<sup>TM</sup> the shell itself did).

So are you suggesting not checking the status at all? Like this:

```diff
diff --git a/sage-sage b/sage-sage
--- a/sage-sage
+++ b/sage-sage
@@ -518,8 +518,8 @@ PS1="SAGE_ROOT=${SAGE_ROOT}
     esac
     if [ "$1" = '-c' ]; then
        exec $SHELL_NAME $SHELL_OPTS "$@"
-       status=$?
-       exit $status
+       echo "An error seems to occurred." 1>&2
+       exit 1
     fi
     # -c is not the first option, so print informative messages...
     echo "" 1>&2
```
I could probably come up with a more cryptic message, though.



---

archive/issue_comments_123121.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\ns/to occurred/to have occurred/, obviously.",
    "created_at": "2011-09-28T21:30:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123121",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:5" align="right">comment:5</div>

s/to occurred/to have occurred/, obviously.



---

archive/issue_comments_123122.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nReplying to [@jhpalmieri](#comment:4):\n> Replying to [@nexttime](#comment:3):\n> > The code testing for `-c` could be moved up, since everything else (in the `case ... esac`) is useless in this case .\n\n> \n> Well, if you're running \"sage --sh CMD\", it should matter whether you're running \"bash\" or \"bash --norc\", right?  The `case ... esac` stuff sets shell options like `--norc` in addition to the prompt, and I think we want this.\n\nAny shell called with `-c` **must not** execute any rc files.\n\n\n\n\n> > Also, if `exec` returns, this means an error, so we could print some according message in this case (although *hopefully*<sup>TM</sup> the shell itself did).\n\n> \n> So are you suggesting not checking the status at all? Like this:\n\n\n```diff\ndiff --git a/sage-sage b/sage-sage\n--- a/sage-sage\n+++ b/sage-sage\n@@ -518,8 +518,8 @@ PS1=\"SAGE_ROOT=${SAGE_ROOT}\n     esac\n     if [ \"$1\" = '-c' ]; then\n        exec $SHELL_NAME $SHELL_OPTS \"$@\"\n-       status=$?\n-       exit $status\n+       echo \"An error seems to occurred.\" 1>&2\n+       exit 1\n     fi\n     # -c is not the first option, so print informative messages...\n     echo \"\" 1>&2\n```\n> I could probably come up with a more cryptic message, though.\n\n:)\n\nI rather meant something like\n\n```sh\n    ...\n    SHELL_NAME=`basename $SHELL`\n\n    if [ \"$1\" = \"-c\" ]; then\n        exec \"$SHELL_NAME\" \"$@\"\n        # If 'exec' returns, an error occurred:\n        status=$?\n        echo >&2 \"Fatal error: 'exec \\\"$SHELL_NAME\\\" \\\"$@\\\"' failed!\"\n        exit $status # Always non-zero, but return the code the shell gave.\n    fi\n\n    case $SHELL_NAME in\n    ...\n```\n\n\n\n\nBtw., any reason to call `$SHELL_NAME` instead of `$SHELL`?\n\nThe latter would IMHO be correct.",
    "created_at": "2011-09-28T21:54:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123122",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:6" align="right">comment:6</div>

Replying to [@jhpalmieri](#comment:4):
> Replying to [@nexttime](#comment:3):
> > The code testing for `-c` could be moved up, since everything else (in the `case ... esac`) is useless in this case .

> 
> Well, if you're running "sage --sh CMD", it should matter whether you're running "bash" or "bash --norc", right?  The `case ... esac` stuff sets shell options like `--norc` in addition to the prompt, and I think we want this.

Any shell called with `-c` **must not** execute any rc files.




> > Also, if `exec` returns, this means an error, so we could print some according message in this case (although *hopefully*<sup>TM</sup> the shell itself did).

> 
> So are you suggesting not checking the status at all? Like this:


```diff
diff --git a/sage-sage b/sage-sage
--- a/sage-sage
+++ b/sage-sage
@@ -518,8 +518,8 @@ PS1="SAGE_ROOT=${SAGE_ROOT}
     esac
     if [ "$1" = '-c' ]; then
        exec $SHELL_NAME $SHELL_OPTS "$@"
-       status=$?
-       exit $status
+       echo "An error seems to occurred." 1>&2
+       exit 1
     fi
     # -c is not the first option, so print informative messages...
     echo "" 1>&2
```
> I could probably come up with a more cryptic message, though.

:)

I rather meant something like

```sh
    ...
    SHELL_NAME=`basename $SHELL`

    if [ "$1" = "-c" ]; then
        exec "$SHELL_NAME" "$@"
        # If 'exec' returns, an error occurred:
        status=$?
        echo >&2 "Fatal error: 'exec \"$SHELL_NAME\" \"$@\"' failed!"
        exit $status # Always non-zero, but return the code the shell gave.
    fi

    case $SHELL_NAME in
    ...
```




Btw., any reason to call `$SHELL_NAME` instead of `$SHELL`?

The latter would IMHO be correct.



---

archive/issue_comments_123123.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nHere's a new patch.",
    "created_at": "2011-09-29T05:13:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123123",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:7" align="right">comment:7</div>

Here's a new patch.



---

archive/issue_comments_123124.json:
```json
{
    "body": "scripts repo",
    "created_at": "2011-09-29T05:14:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123124",
    "user": "https://github.com/jhpalmieri"
}
```

scripts repo



---

archive/issue_comments_123125.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nAttachment: **[trac_11790-sage-sh.patch.gz](https://github.com/sagemath/sage/files/ticket11790/trac_11790-sage-sh.patch.gz)**\n\nBoth `$SHELL` and `$SHELL_NAME` should in principle be quoted... ;-)",
    "created_at": "2011-09-29T05:18:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123125",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:8" align="right">comment:8</div>

Attachment: **[trac_11790-sage-sh.patch.gz](https://github.com/sagemath/sage/files/ticket11790/trac_11790-sage-sh.patch.gz)**

Both `$SHELL` and `$SHELL_NAME` should in principle be quoted... ;-)



---

archive/issue_comments_123126.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nLike this?\n\n```diff\ndiff --git a/sage-sage b/sage-sage\n--- a/sage-sage\n+++ b/sage-sage\n@@ -473,7 +473,7 @@ if [ \"$1\" = '-sh'  -o \"$1\" = '--sh' ]; t\n     cd \"$CUR\"\n     shift\n     if [ \"$1\" = '-c' ]; then\n-       exec $SHELL \"$@\"\n+       exec \"$SHELL\" \"$@\"\n         # If 'exec' returns, an error occurred:\n         status=$?\n         echo >&2 \"Fatal error: 'exec \\\"$SHELL\\\" \\\"$@\\\"' failed!\"\n@@ -489,8 +489,8 @@ if [ \"$1\" = '-sh'  -o \"$1\" = '--sh' ]; t\n     echo \"\" 1>&2\n     # We must start a new shell with no .profile or .bashrc files\n     # processed, so that we know our path is correct\n-    SHELL_NAME=`basename $SHELL`\n-    case $SHELL_NAME in\n+    SHELL_NAME=`basename \"$SHELL\"`\n+    case \"$SHELL_NAME\" in\n         bash)\n             SHELL_OPTS=\" --norc\"\n             PS1=\"SAGE_ROOT=${SAGE_ROOT}\\n(sage subshell) \\h:\\W \\u\\$ \"\n@@ -531,7 +531,7 @@ PS1=\"SAGE_ROOT=${SAGE_ROOT}\n             echo >&2 \"Aborting.\"\n             exit 1\n     esac\n-    $SHELL $SHELL_OPTS \"$@\"\n+    \"$SHELL\" $SHELL_OPTS \"$@\"\n     status=$?\n     echo \"Exited Sage subshell.\" 1>&2\n     exit $status\n```\nLet's make this v2 of the patch.",
    "created_at": "2011-09-29T05:25:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123126",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:9" align="right">comment:9</div>

Like this?

```diff
diff --git a/sage-sage b/sage-sage
--- a/sage-sage
+++ b/sage-sage
@@ -473,7 +473,7 @@ if [ "$1" = '-sh'  -o "$1" = '--sh' ]; t
     cd "$CUR"
     shift
     if [ "$1" = '-c' ]; then
-       exec $SHELL "$@"
+       exec "$SHELL" "$@"
         # If 'exec' returns, an error occurred:
         status=$?
         echo >&2 "Fatal error: 'exec \"$SHELL\" \"$@\"' failed!"
@@ -489,8 +489,8 @@ if [ "$1" = '-sh'  -o "$1" = '--sh' ]; t
     echo "" 1>&2
     # We must start a new shell with no .profile or .bashrc files
     # processed, so that we know our path is correct
-    SHELL_NAME=`basename $SHELL`
-    case $SHELL_NAME in
+    SHELL_NAME=`basename "$SHELL"`
+    case "$SHELL_NAME" in
         bash)
             SHELL_OPTS=" --norc"
             PS1="SAGE_ROOT=${SAGE_ROOT}\n(sage subshell) \h:\W \u\$ "
@@ -531,7 +531,7 @@ PS1="SAGE_ROOT=${SAGE_ROOT}
             echo >&2 "Aborting."
             exit 1
     esac
-    $SHELL $SHELL_OPTS "$@"
+    "$SHELL" $SHELL_OPTS "$@"
     status=$?
     echo "Exited Sage subshell." 1>&2
     exit $status
```
Let's make this v2 of the patch.



---

archive/issue_comments_123127.json:
```json
{
    "body": "Attachment: **[trac_11790-sage-sh.v2.patch.gz](https://github.com/sagemath/sage/files/ticket11790/trac_11790-sage-sh.v2.patch.gz)**\n\nscripts repo",
    "created_at": "2011-09-29T05:25:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123127",
    "user": "https://github.com/jhpalmieri"
}
```

Attachment: **[trac_11790-sage-sh.v2.patch.gz](https://github.com/sagemath/sage/files/ticket11790/trac_11790-sage-sh.v2.patch.gz)**

scripts repo



---

archive/issue_comments_123128.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@jhpalmieri](#comment:9):\n> Like this?\n\nYep. As a MacOS user, you should be familiar with spaces in filenames... ;-)",
    "created_at": "2011-09-29T05:41:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123128",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@jhpalmieri](#comment:9):
> Like this?

Yep. As a MacOS user, you should be familiar with spaces in filenames... ;-)



---

archive/issue_comments_123129.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nI would prefer not to special-case `-c` and print the \"informative\" messages only when *no arguments* are given.\n\nSecond, please get rid of the double-line prompt.  I find that so confusing.  No need to print `SAGE_ROOT` on every prompt (maybe print it once in the \"informative\" messages).",
    "created_at": "2011-10-31T12:10:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123129",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:11" align="right">comment:11</div>

I would prefer not to special-case `-c` and print the "informative" messages only when *no arguments* are given.

Second, please get rid of the double-line prompt.  I find that so confusing.  No need to print `SAGE_ROOT` on every prompt (maybe print it once in the "informative" messages).



---

archive/issue_events_159219.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-10-31T12:10:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11790#event-159219"
}
```



---

archive/issue_events_159220.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-10-31T12:10:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11790#event-159220"
}
```



---

archive/issue_comments_123130.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nThird, now that you are working on this: it is absolutely wrong to assume that `/bin/sh` supports `--norc`.  I would not make any assumptions at all about which shell is `/bin/sh`, so I would set no options for `sh`.",
    "created_at": "2011-10-31T12:13:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123130",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:12" align="right">comment:12</div>

Third, now that you are working on this: it is absolutely wrong to assume that `/bin/sh` supports `--norc`.  I would not make any assumptions at all about which shell is `/bin/sh`, so I would set no options for `sh`.



---

archive/issue_comments_123131.json:
```json
{
    "body": "Reviewer: **Jeroen Demeyer**",
    "created_at": "2011-10-31T12:13:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123131",
    "user": "https://github.com/jdemeyer"
}
```

Reviewer: **Jeroen Demeyer**



---

archive/issue_comments_123132.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nReplying to [@jdemeyer](#comment:11):\n> I would prefer not to special-case `-c` and print the \"informative\" messages only when *no arguments* are given.\n> \n> Second, please get rid of the double-line prompt.  I find that so confusing.  No need to print `SAGE_ROOT` on every prompt (maybe print it once in the \"informative\" messages).\n\n+N (N>=1)\n\nI always found that annoying, but hesitated to change it since others might argue that it may be helpful to \"less experienced users\"<sup>TM</sup>.\n\n(One reason I hardly ever use the Sage subshell... ;-) )",
    "created_at": "2011-10-31T20:35:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123132",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:13" align="right">comment:13</div>

Replying to [@jdemeyer](#comment:11):
> I would prefer not to special-case `-c` and print the "informative" messages only when *no arguments* are given.
> 
> Second, please get rid of the double-line prompt.  I find that so confusing.  No need to print `SAGE_ROOT` on every prompt (maybe print it once in the "informative" messages).

+N (N>=1)

I always found that annoying, but hesitated to change it since others might argue that it may be helpful to "less experienced users"<sup>TM</sup>.

(One reason I hardly ever use the Sage subshell... ;-) )



---

archive/issue_comments_123133.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@jdemeyer](#comment:11):\n> I would prefer not to special-case `-c` and print the \"informative\" messages only when *no arguments* are given.\n\nWell, other options could be passed such that the shell would still be interactive.\n\nIn that case, the \"informative messages\" should probably still get printed.",
    "created_at": "2011-10-31T20:40:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123133",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@jdemeyer](#comment:11):
> I would prefer not to special-case `-c` and print the "informative" messages only when *no arguments* are given.

Well, other options could be passed such that the shell would still be interactive.

In that case, the "informative messages" should probably still get printed.



---

archive/issue_comments_123134.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nI wouldn't mind shortening the prompt to one line, but I'd like to get more feedback, so I asked the question on sage-devel.\n\nIf it is shortened, should we do more to highlight that we're in a subshell?  The following shortens \"(sage subshell)\" to \"(Sage)\" and puts in reverse video.  We could use boldface if reverse video is too obnoxious.\n\n```diff\n\ndiff --git a/sage-sage b/sage-sage\n--- a/sage-sage\n+++ b/sage-sage\n@@ -490,10 +491,19 @@ if [ \"$1\" = '-sh'  -o \"$1\" = '--sh' ]; t\n     # We must start a new shell with no .profile or .bashrc files\n     # processed, so that we know our path is correct\n     SHELL_NAME=`basename \"$SHELL\"`\n+    if [ -x /usr/bin/tput ] && tput setaf 1 >&/dev/null; then\n+        color_prompt=yes\n+    else\n+        color_prompt=\n+    fi\n     case \"$SHELL_NAME\" in\n         bash)\n             SHELL_OPTS=\" --norc\"\n-            PS1=\"SAGE_ROOT=${SAGE_ROOT}\\n(sage subshell) \\h:\\W \\u\\$ \"\n+            if [ \"$color_prompt\" = yes ] ; then\n+                PS1=\"\\[$(tput rev)\\](Sage)\\[$(tput sgr0)\\] \\h:\\W \\u\\$ \"\n+            else\n+                PS1=\"(Sage) \\h:\\W \\u\\$ \"\n+            fi\n             export PS1\n             ;;\n         csh)\n@@ -504,14 +514,18 @@ if [ \"$1\" = '-sh'  -o \"$1\" = '--sh' ]; t\n             ;;\n         ksh)\n             SHELL_OPTS=\" -p\"\n-            PS1=\"SAGE_ROOT=${SAGE_ROOT}\n-(sage subshell) `hostname -s`:\\${PWD##*/} $USER$ \"\n+            if [ \"$color_prompt\" = yes ] ; then\n+                PS1=\"\\[$(tput rev)\\](Sage)\\[$(tput sgr0)\\] `hostname -s`:\\${PWD##*/} $USER$ \"\n+            else\n+                PS1=\"(Sage) `hostname -s`:\\${PWD##*/} $USER$ \"\n+            fi\n             export PS1\n             ;;\n         sh)\n-            SHELL_OPTS=\" --norc\"\n-            PS1=\"SAGE_ROOT=${SAGE_ROOT}\n-(sage subshell) `hostname -s`:\\${PWD##*/} $USER$ \"\n+            # If sh is derived from bash, then the following is okay,\n+            # but we shouldn't assume this.\n+            #SHELL_OPTS=\" --norc\"\n+            PS1=\"(Sage) `hostname -s`:\\${PWD##*/} $USER$ \"\n             export PS1\n             ;;\n         tcsh)\n@@ -521,8 +535,11 @@ if [ \"$1\" = '-sh'  -o \"$1\" = '--sh' ]; t\n             SHELL_OPTS=\" -f\"\n             ;;\n         zsh)\n```",
    "created_at": "2011-10-31T21:13:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123134",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:15" align="right">comment:15</div>

I wouldn't mind shortening the prompt to one line, but I'd like to get more feedback, so I asked the question on sage-devel.

If it is shortened, should we do more to highlight that we're in a subshell?  The following shortens "(sage subshell)" to "(Sage)" and puts in reverse video.  We could use boldface if reverse video is too obnoxious.

```diff

diff --git a/sage-sage b/sage-sage
--- a/sage-sage
+++ b/sage-sage
@@ -490,10 +491,19 @@ if [ "$1" = '-sh'  -o "$1" = '--sh' ]; t
     # We must start a new shell with no .profile or .bashrc files
     # processed, so that we know our path is correct
     SHELL_NAME=`basename "$SHELL"`
+    if [ -x /usr/bin/tput ] && tput setaf 1 >&/dev/null; then
+        color_prompt=yes
+    else
+        color_prompt=
+    fi
     case "$SHELL_NAME" in
         bash)
             SHELL_OPTS=" --norc"
-            PS1="SAGE_ROOT=${SAGE_ROOT}\n(sage subshell) \h:\W \u\$ "
+            if [ "$color_prompt" = yes ] ; then
+                PS1="\[$(tput rev)\](Sage)\[$(tput sgr0)\] \h:\W \u\$ "
+            else
+                PS1="(Sage) \h:\W \u\$ "
+            fi
             export PS1
             ;;
         csh)
@@ -504,14 +514,18 @@ if [ "$1" = '-sh'  -o "$1" = '--sh' ]; t
             ;;
         ksh)
             SHELL_OPTS=" -p"
-            PS1="SAGE_ROOT=${SAGE_ROOT}
-(sage subshell) `hostname -s`:\${PWD##*/} $USER$ "
+            if [ "$color_prompt" = yes ] ; then
+                PS1="\[$(tput rev)\](Sage)\[$(tput sgr0)\] `hostname -s`:\${PWD##*/} $USER$ "
+            else
+                PS1="(Sage) `hostname -s`:\${PWD##*/} $USER$ "
+            fi
             export PS1
             ;;
         sh)
-            SHELL_OPTS=" --norc"
-            PS1="SAGE_ROOT=${SAGE_ROOT}
-(sage subshell) `hostname -s`:\${PWD##*/} $USER$ "
+            # If sh is derived from bash, then the following is okay,
+            # but we shouldn't assume this.
+            #SHELL_OPTS=" --norc"
+            PS1="(Sage) `hostname -s`:\${PWD##*/} $USER$ "
             export PS1
             ;;
         tcsh)
@@ -521,8 +535,11 @@ if [ "$1" = '-sh'  -o "$1" = '--sh' ]; t
             SHELL_OPTS=" -f"
             ;;
         zsh)
```



---

archive/issue_comments_123135.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nSimon King had the interesting suggestion of prepending e.g. \"(sage-sh)\" to the current prompt.  Can we access the current prompt?",
    "created_at": "2011-10-31T21:58:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123135",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:16" align="right">comment:16</div>

Simon King had the interesting suggestion of prepending e.g. "(sage-sh)" to the current prompt.  Can we access the current prompt?



---

archive/issue_comments_123136.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@jhpalmieri](#comment:16):\n> Simon King had the interesting suggestion of prepending e.g. \"(sage-sh)\" to the current prompt.  Can we access the current prompt?\n\nWell, `$PS1` is the current prompt.  So you could do\n\n```\nexport PS1=\"(sage-sh) $PS1\"\n```",
    "created_at": "2011-10-31T22:29:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123136",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@jhpalmieri](#comment:16):
> Simon King had the interesting suggestion of prepending e.g. "(sage-sh)" to the current prompt.  Can we access the current prompt?

Well, `$PS1` is the current prompt.  So you could do

```
export PS1="(sage-sh) $PS1"
```



---

archive/issue_comments_123137.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nReplying to [@nexttime](#comment:14):\n> Replying to [@jdemeyer](#comment:11):\n> > I would prefer not to special-case `-c` and print the \"informative\" messages only when *no arguments* are given.\n\n> \n> Well, other options could be passed such that the shell would still be interactive.\n\nOn the other hand, other options (e.g. the name of a script) could be passed such that the shell would *not* be interactive.  I would say that any option passed qualifies as \"advanced usage\" meaning the user knows what he is doing and does not need \"informative\" messages.",
    "created_at": "2011-10-31T22:32:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123137",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:18" align="right">comment:18</div>

Replying to [@nexttime](#comment:14):
> Replying to [@jdemeyer](#comment:11):
> > I would prefer not to special-case `-c` and print the "informative" messages only when *no arguments* are given.

> 
> Well, other options could be passed such that the shell would still be interactive.

On the other hand, other options (e.g. the name of a script) could be passed such that the shell would *not* be interactive.  I would say that any option passed qualifies as "advanced usage" meaning the user knows what he is doing and does not need "informative" messages.



---

archive/issue_comments_123138.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nReplying to [@jdemeyer](#comment:17):\n> Well, `$PS1` is the current prompt.  So you could do\n\nI tried that but it doesn't seem to work: $PS1 is not defined when running sage-sage: add a line `echo \"current prompt is $PS1\"` somewhere.",
    "created_at": "2011-10-31T22:35:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123138",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:19" align="right">comment:19</div>

Replying to [@jdemeyer](#comment:17):
> Well, `$PS1` is the current prompt.  So you could do

I tried that but it doesn't seem to work: $PS1 is not defined when running sage-sage: add a line `echo "current prompt is $PS1"` somewhere.



---

archive/issue_comments_123139.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nI don't like playing with \"fancy\" prompts.\n\nIf someone needs such, we could support `SAGE_SHELL_PROMPT` or whatever.\n\n(Ceterum censeo we should support `~/.sagerc` [or `$DOT_SAGE/.sagerc` or both], or `~/.sageshrc`, for common environment settings etc., i.e., this should be a shell script which is sourced by `sage-env` if present.)",
    "created_at": "2011-10-31T23:40:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123139",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:20" align="right">comment:20</div>

I don't like playing with "fancy" prompts.

If someone needs such, we could support `SAGE_SHELL_PROMPT` or whatever.

(Ceterum censeo we should support `~/.sagerc` [or `$DOT_SAGE/.sagerc` or both], or `~/.sageshrc`, for common environment settings etc., i.e., this should be a shell script which is sourced by `sage-env` if present.)



---

archive/issue_comments_123140.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nHere is version 3 of the patch.  This implements Leif's idea about ./sage/.sagerc, in a simple-minded way.  It also checks for the environment variable `SAGE_SHPROMPT`.\n\nMy opinion is that the prompt for the Sage shell should indicate **very clearly** that this is a Sage shell, so the default in this patch is for it to start with \"(sage-sh)\" in reverse video.  If you don't like it, you can override it by setting `PS1` in .sagerc or by setting `SAGE_SHPROMPT` anywhere.\n\nThis also doesn't print any warning message or even set the prompt if `sage -sh` is followed by more arguments.  I'm not sure I'm happy about that, in particular the potential lack of a different prompt.",
    "created_at": "2011-11-01T20:38:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123140",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:21" align="right">comment:21</div>

Here is version 3 of the patch.  This implements Leif's idea about ./sage/.sagerc, in a simple-minded way.  It also checks for the environment variable `SAGE_SHPROMPT`.

My opinion is that the prompt for the Sage shell should indicate **very clearly** that this is a Sage shell, so the default in this patch is for it to start with "(sage-sh)" in reverse video.  If you don't like it, you can override it by setting `PS1` in .sagerc or by setting `SAGE_SHPROMPT` anywhere.

This also doesn't print any warning message or even set the prompt if `sage -sh` is followed by more arguments.  I'm not sure I'm happy about that, in particular the potential lack of a different prompt.



---

archive/issue_events_159221.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2011-11-01T20:38:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11790#event-159221"
}
```



---

archive/issue_events_159222.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2011-11-01T20:38:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11790#event-159222"
}
```



---

archive/issue_comments_123141.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nOkay, I changed it so it sets the prompt regardless of the number of arguments.",
    "created_at": "2011-11-01T20:53:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123141",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:22" align="right">comment:22</div>

Okay, I changed it so it sets the prompt regardless of the number of arguments.



---

archive/issue_comments_123142.json:
```json
{
    "body": "Attachment: **[trac_11790-sage-sh.v3.patch.gz](https://github.com/sagemath/sage/files/ticket11790/trac_11790-sage-sh.v3.patch.gz)**\n\nscripts repo",
    "created_at": "2011-11-01T20:56:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123142",
    "user": "https://github.com/jhpalmieri"
}
```

Attachment: **[trac_11790-sage-sh.v3.patch.gz](https://github.com/sagemath/sage/files/ticket11790/trac_11790-sage-sh.v3.patch.gz)**

scripts repo



---

archive/issue_events_159223.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-02-26T09:26:51Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "label": "https://github.com/sagemath/sage/labels/p%3A%204%20%E2%80%93%20minor",
    "label_color": "ffe799",
    "label_name": "p: 4 \u2013 minor",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11790#event-159223"
}
```



---

archive/issue_events_159224.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-02-26T09:26:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "label": "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p: 1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11790#event-159224"
}
```



---

archive/issue_comments_123143.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -17,7 +17,7 @@\n \n And it's inconvenient if one wants to further process the output of some command run in a Sage subshell.\n \n-In `local/bin/sage-sage`, we have:\n+In `spkg/bin/sage`, we have:\n \n ```sh\n if [ \"$1\" = '-sh'  -o \"$1\" = '--sh' ]; then\n@@ -45,7 +45,7 @@\n fi\n ```\n \n-So I'd propose to change `sage-sage` to not print *any* messages if the first argument to the subshell is `-c`.\n+So I'd propose to change `sage` to not print *any* messages if there are any further arguments to `sage --sh`.\n \n Alternatively, all (or a reduced set of) messages should at least go to `stderr` instead of `stdout`, perhaps regardless of whether `-c` was specified or not.\n \n@@ -55,5 +55,6 @@\n     exec $SHELL_NAME $SHELL_OPTS \"$@\"\n ```\n \n-(Actually, `exec` should be used in a couple of Sage commands which don't need any \"post-processing\", e.g. by `sage-sage`.)\n+(Actually, `exec` should be used in a couple of Sage commands which don't need any \"post-processing\", e.g. by `sage`.)\n \n+**Apply** [attachment: 11790_sage_sh.patch](https://github.com/sagemath/sage/files/ticket11790/11790_sage_sh.patch.gz) to the SAGE_ROOT repository.\n``````\n",
    "created_at": "2012-03-09T16:18:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123143",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -17,7 +17,7 @@
 
 And it's inconvenient if one wants to further process the output of some command run in a Sage subshell.
 
-In `local/bin/sage-sage`, we have:
+In `spkg/bin/sage`, we have:
 
 ```sh
 if [ "$1" = '-sh'  -o "$1" = '--sh' ]; then
@@ -45,7 +45,7 @@
 fi
 ```
 
-So I'd propose to change `sage-sage` to not print *any* messages if the first argument to the subshell is `-c`.
+So I'd propose to change `sage` to not print *any* messages if there are any further arguments to `sage --sh`.
 
 Alternatively, all (or a reduced set of) messages should at least go to `stderr` instead of `stdout`, perhaps regardless of whether `-c` was specified or not.
 
@@ -55,5 +55,6 @@
     exec $SHELL_NAME $SHELL_OPTS "$@"
 ```
 
-(Actually, `exec` should be used in a couple of Sage commands which don't need any "post-processing", e.g. by `sage-sage`.)
+(Actually, `exec` should be used in a couple of Sage commands which don't need any "post-processing", e.g. by `sage`.)
 
+**Apply** [attachment: 11790_sage_sh.patch](https://github.com/sagemath/sage/files/ticket11790/11790_sage_sh.patch.gz) to the SAGE_ROOT repository.
``````




---

archive/issue_comments_123144.json:
```json
{
    "body": "Changed dependencies from **#11866** to none",
    "created_at": "2012-03-09T16:18:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123144",
    "user": "https://github.com/jdemeyer"
}
```

Changed dependencies from **#11866** to none



---

archive/issue_comments_123145.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nI think adding a `sagerc` file warrants its own ticket: #12647.",
    "created_at": "2012-03-09T20:51:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123145",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:26" align="right">comment:26</div>

I think adding a `sagerc` file warrants its own ticket: #12647.



---

archive/issue_comments_123146.json:
```json
{
    "body": "Dependencies: **#12647**",
    "created_at": "2012-03-09T20:53:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123146",
    "user": "https://github.com/jdemeyer"
}
```

Dependencies: **#12647**



---

archive/issue_events_159225.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-03-09T20:53:14Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11790#event-159225"
}
```



---

archive/issue_events_159226.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-03-09T20:53:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11790#event-159226"
}
```



---

archive/issue_comments_123147.json:
```json
{
    "body": "Attachment: **[11790_sage_sh.patch.gz](https://github.com/sagemath/sage/files/ticket11790/11790_sage_sh.patch.gz)**\n\nAttachment: **[11790_review.patch.gz](https://github.com/sagemath/sage/files/ticket11790/11790_review.patch.gz)**",
    "created_at": "2012-03-09T21:25:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123147",
    "user": "https://github.com/jdemeyer"
}
```

Attachment: **[11790_sage_sh.patch.gz](https://github.com/sagemath/sage/files/ticket11790/11790_sage_sh.patch.gz)**

Attachment: **[11790_review.patch.gz](https://github.com/sagemath/sage/files/ticket11790/11790_review.patch.gz)**



---

archive/issue_events_159227.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-03-09T21:30:53Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11790#event-159227"
}
```



---

archive/issue_events_159228.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-03-09T21:30:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11790#event-159228"
}
```



---

archive/issue_comments_123148.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -57,4 +57,4 @@\n \n (Actually, `exec` should be used in a couple of Sage commands which don't need any \"post-processing\", e.g. by `sage`.)\n \n-**Apply** [attachment: 11790_sage_sh.patch](https://github.com/sagemath/sage/files/ticket11790/11790_sage_sh.patch.gz) to the SAGE_ROOT repository.\n+**Apply** [attachment: 11790_sage_sh.patch](https://github.com/sagemath/sage/files/ticket11790/11790_sage_sh.patch.gz) and [attachment: 11790_review.patch](https://github.com/sagemath/sage/files/ticket11790/11790_review.patch.gz) to the SAGE_ROOT repository.\n``````\n",
    "created_at": "2012-03-09T21:30:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123148",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -57,4 +57,4 @@
 
 (Actually, `exec` should be used in a couple of Sage commands which don't need any "post-processing", e.g. by `sage`.)
 
-**Apply** [attachment: 11790_sage_sh.patch](https://github.com/sagemath/sage/files/ticket11790/11790_sage_sh.patch.gz) to the SAGE_ROOT repository.
+**Apply** [attachment: 11790_sage_sh.patch](https://github.com/sagemath/sage/files/ticket11790/11790_sage_sh.patch.gz) and [attachment: 11790_review.patch](https://github.com/sagemath/sage/files/ticket11790/11790_review.patch.gz) to the SAGE_ROOT repository.
``````




---

archive/issue_comments_123149.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nReviewer patch needs review...",
    "created_at": "2012-03-09T21:32:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123149",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:29" align="right">comment:29</div>

Reviewer patch needs review...



---

archive/issue_comments_123150.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nAdding a sagerc script (#12637) needs review.",
    "created_at": "2012-03-13T17:03:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123150",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:30" align="right">comment:30</div>

Adding a sagerc script (#12637) needs review.



---

archive/issue_comments_123151.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nI meant #12647.",
    "created_at": "2012-03-13T17:04:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123151",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:31" align="right">comment:31</div>

I meant #12647.



---

archive/issue_events_159229.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2012-03-14T18:23:34Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11790#event-159229"
}
```



---

archive/issue_events_159230.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2012-03-14T18:23:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11790#event-159230"
}
```



---

archive/issue_comments_123152.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nThis looks good to me.\n\nRegarding the use of \"exec\", which was suggested by Leif, was in my version of the patch, and is in the current patch: if we want to be able to do something like `sage --norc -c ...` (as in #11932), then we want to be able to delete the temporary `DOTSAGE` directory after the Sage command finishes.  Using \"exec\" prevents this, doesn't it?  So unless I'm misunderstanding and there is a good way to clean things up after \"exec CMD\", we should be wary of overusing \"exec\" in the sage script.\n\nAnyway, I'm willing to give this a positive review.",
    "created_at": "2012-03-14T18:23:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123152",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:32" align="right">comment:32</div>

This looks good to me.

Regarding the use of "exec", which was suggested by Leif, was in my version of the patch, and is in the current patch: if we want to be able to do something like `sage --norc -c ...` (as in #11932), then we want to be able to delete the temporary `DOTSAGE` directory after the Sage command finishes.  Using "exec" prevents this, doesn't it?  So unless I'm misunderstanding and there is a good way to clean things up after "exec CMD", we should be wary of overusing "exec" in the sage script.

Anyway, I'm willing to give this a positive review.



---

archive/issue_comments_123153.json:
```json
{
    "body": "Changed reviewer from **Jeroen Demeyer** to **Jeroen Demeyer, John Palmieri**",
    "created_at": "2012-03-14T18:23:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123153",
    "user": "https://github.com/jhpalmieri"
}
```

Changed reviewer from **Jeroen Demeyer** to **Jeroen Demeyer, John Palmieri**



---

archive/issue_comments_123154.json:
```json
{
    "body": "Changed author from **John Palmieri** to **John Palmieri, Jeroen Demeyer**",
    "created_at": "2012-03-14T18:23:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123154",
    "user": "https://github.com/jhpalmieri"
}
```

Changed author from **John Palmieri** to **John Palmieri, Jeroen Demeyer**



---

archive/issue_comments_123155.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nReplying to [@jhpalmieri](#comment:32):\n> Regarding the use of \"exec\", which was suggested by Leif, was in my version of the patch, and is in the current patch: if we want to be able to do something like `sage --norc -c ...` (as in #11932), then we want to be able to delete the temporary `DOTSAGE` directory after the Sage command finishes.  Using \"exec\" prevents this, doesn't it?\n\nUsing `exec` **here** doesn't prevent that.  It just means that we cannot implement `--norc` itself using `exec`, which is fine.\n\nExample:\nscriptA does\n\n```\nscriptB\ncleanup\n```\n\nscriptB does\n\n```\nexec scriptC\ncleanup2\n```\n\nThe `exec` in `scriptB` doesn't prevent the `cleanup` in `scriptA`, it only prevents the `cleanup2` in `scriptB`.",
    "created_at": "2012-03-14T19:41:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123155",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:33" align="right">comment:33</div>

Replying to [@jhpalmieri](#comment:32):
> Regarding the use of "exec", which was suggested by Leif, was in my version of the patch, and is in the current patch: if we want to be able to do something like `sage --norc -c ...` (as in #11932), then we want to be able to delete the temporary `DOTSAGE` directory after the Sage command finishes.  Using "exec" prevents this, doesn't it?

Using `exec` **here** doesn't prevent that.  It just means that we cannot implement `--norc` itself using `exec`, which is fine.

Example:
scriptA does

```
scriptB
cleanup
```

scriptB does

```
exec scriptC
cleanup2
```

The `exec` in `scriptB` doesn't prevent the `cleanup` in `scriptA`, it only prevents the `cleanup2` in `scriptB`.



---

archive/issue_comments_123156.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nRight, but suppose we do something like this:\n\n```\nif [ \"$1\" = '--norc' -o \"$1\" = '--nodotsage' ]; then\n    export DOT_SAGE=`mktemp -d ${TMPDIR:-/tmp}/dotsageXXXXXX`\n    shift\n    sage \"$@\"\n    status=$?\n    rm -rf \"$DOT_SAGE\"\n    exit $status\nfi\n```\nThen if you do `sage --norc --sh ...` (or any other option like `--sh` which uses `exec`), it will never reach the line `rm -rf \"$DOT_SAGE\"`.",
    "created_at": "2012-03-14T20:35:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123156",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:34" align="right">comment:34</div>

Right, but suppose we do something like this:

```
if [ "$1" = '--norc' -o "$1" = '--nodotsage' ]; then
    export DOT_SAGE=`mktemp -d ${TMPDIR:-/tmp}/dotsageXXXXXX`
    shift
    sage "$@"
    status=$?
    rm -rf "$DOT_SAGE"
    exit $status
fi
```
Then if you do `sage --norc --sh ...` (or any other option like `--sh` which uses `exec`), it will never reach the line `rm -rf "$DOT_SAGE"`.



---

archive/issue_comments_123157.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nReplying to [@jhpalmieri](#comment:34):\n> Then if you do `sage --norc --sh ...` (or any other option like `--sh` which uses `exec`), it will never reach the line `rm -rf \"$DOT_SAGE\"`.\n\nThat would be very surprising, are you sure about this?",
    "created_at": "2012-03-14T20:40:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123157",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:35" align="right">comment:35</div>

Replying to [@jhpalmieri](#comment:34):
> Then if you do `sage --norc --sh ...` (or any other option like `--sh` which uses `exec`), it will never reach the line `rm -rf "$DOT_SAGE"`.

That would be very surprising, are you sure about this?



---

archive/issue_comments_123158.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nNo, I'm not sure about this - it seems to work the way we want, and as described in [your comment](#comment:33). Never mind.",
    "created_at": "2012-03-14T20:45:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123158",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:36" align="right">comment:36</div>

No, I'm not sure about this - it seems to work the way we want, and as described in [your comment](#comment:33). Never mind.



---

archive/issue_comments_123159.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nSee #12698 for a sort-of follow-up.",
    "created_at": "2012-03-19T15:07:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123159",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:37" align="right">comment:37</div>

See #12698 for a sort-of follow-up.



---

archive/issue_events_159231.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-03-21T22:05:42Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11790#event-159231"
}
```



---

archive/issue_events_159232.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-03-21T22:05:42Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11790#event-159232"
}
```



---

archive/issue_comments_123160.json:
```json
{
    "body": "Merged: **sage-5.0.beta9**",
    "created_at": "2012-03-21T22:05:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11790#issuecomment-123160",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-5.0.beta9**
