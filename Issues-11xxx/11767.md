# Issue 11767: elliptic_logarithm of high precision points often hangs forever

archive/issues_011595.json:
```json
{
    "assignees": [],
    "body": "I am doing a project to compute Chow-Heegner points with Darmon, Rotger, et al., and am using Sage's `elliptic_logarithm` function with high precision points as input.  Unfortunately, it completely hangs on many input points over number fields.  Here is an example below, where computing to precision 500 works fine, but precision 600 hangs Sage forever:\n\n```\nsage: R.<x> = QQ[]\nsage: K.<a> = NumberField(x^2 + x + 5)\nsage: E = EllipticCurve(K, [0,0,1,-3,-5])\nsage: P = E([0,a])\nsage: L = P.curve().period_lattice(K.embeddings(ComplexField(600))[0])\nsage: time L.elliptic_logarithm(P, prec=500)\n\n-0.842248166487739393375018008381693990800588864069506187033873183845246233548058477561706400464057832396643843146464236956684557207157300006542470428494 - 0.571366031453267388121279381354098224265947866751130917440598461117775339240176310729173301979590106474259885638797913383502735083088736326391919063211*I\nTime: CPU 0.08 s, Wall: 0.09 s\n```\n\nBUT:\n\n```\nsage: L.elliptic_logarithm(P, prec=600)\nHANGS FOREVER\n```\n\nHitting control-c and using the debugger suggests that the termination condition is impossible.  You end up in this line `if (r.abs()-1).abs() < eps: break` with actually having `(r.abs()-1).abs() == eps`, so the strict inequality isnt' satisfied, and maybe for some reason it can't be???\n\n```\n\nipdb> l\n   1357             r = C(((xP-e3)/(xP-e2)).sqrt())\n   1358             if r.real()<0: r=-r\n   1359             t = -C(wP)/(2*r*(xP-e2))\n   1360             eps = R(1)>>(prec2);\n   1361             while True:        \n-> 1362                 s = b*r+a\n   1363                 a, b = (a+b)/2, (a*b).sqrt()\n   1364                 if (a+b).abs() < (a-b).abs():  b=-b\n   1365                 r = (a*(r+1)/s).sqrt()\n   1366                 if (r.abs()-1).abs() < eps: break\n   1367                 if r.real()<0: r=-r\n\nipdb> print eps\n5.80771375621750318328344999898952221581714435905885826948966319082059051450573607513973642929306226703333487164506974570166210185861027247933383445853709821724799129294394972880718063974478259360634645856449058721344643691320490207325897321618392592839150233975392885056947380044108965624364302537017698344822203678107744035231793749824965395444912652822986530e-362\nipdb> print r    \n1.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\nipdb> print (r.abs()-1).abs()\n5.80771375621750318328344999898952221581714435905885826948966319082059051450573607513973642929306226703333487164506974570166210185861027247933383445853709821724799129294394972880718063974478259360634645856449058721344643691320490207325897321618392592839150233975392885056947380044108965624364302537017698344822203678107744035231793749824965395444912652822986530e-362\nipdb> print eps\n5.80771375621750318328344999898952221581714435905885826948966319082059051450573607513973642929306226703333487164506974570166210185861027247933383445853709821724799129294394972880718063974478259360634645856449058721344643691320490207325897321618392592839150233975392885056947380044108965624364302537017698344822203678107744035231793749824965395444912652822986530e-362\nipdb> print (r.abs()-1).abs() < eps\nFalse\nipdb> print (r.abs()-1).abs() <= eps\nTrue\n```\n\nChanging `< eps` to `<= eps` in two spots in the relevant file seems to fix the problem for me.\n\n---\n\nApply\n1. [attachment: trac_11767b.patch.gz](https://github.com/sagemath/sage/files/ticket11767/trac_11767b.patch.gz)\n2. [attachment: trac_11767c.patch.gz](https://github.com/sagemath/sage/files/ticket11767/trac_11767c.patch.gz)\nto the Sage library.\n\n\nAssignee: **@JohnCremona**\n\nKeywords: **ecc2011**\n\nAuthor: **Paul Zimmermann**\n\nReviewer: **John Cremona, Leif Leonhardy, William Stein**\n\nMerged: **sage-4.7.2.alpha3**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/11767_\n\n",
    "closed_at": "2011-09-18T22:59:06Z",
    "created_at": "2011-08-31T21:51:01Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20elliptic%20curves",
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-4.7.2",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "elliptic_logarithm of high precision points often hangs forever",
    "type": "issue",
    "updated_at": "2011-09-18T22:59:06Z",
    "url": "https://github.com/sagemath/sage/issues/11767",
    "user": "https://github.com/williamstein"
}
```
I am doing a project to compute Chow-Heegner points with Darmon, Rotger, et al., and am using Sage's `elliptic_logarithm` function with high precision points as input.  Unfortunately, it completely hangs on many input points over number fields.  Here is an example below, where computing to precision 500 works fine, but precision 600 hangs Sage forever:

```
sage: R.<x> = QQ[]
sage: K.<a> = NumberField(x^2 + x + 5)
sage: E = EllipticCurve(K, [0,0,1,-3,-5])
sage: P = E([0,a])
sage: L = P.curve().period_lattice(K.embeddings(ComplexField(600))[0])
sage: time L.elliptic_logarithm(P, prec=500)

-0.842248166487739393375018008381693990800588864069506187033873183845246233548058477561706400464057832396643843146464236956684557207157300006542470428494 - 0.571366031453267388121279381354098224265947866751130917440598461117775339240176310729173301979590106474259885638797913383502735083088736326391919063211*I
Time: CPU 0.08 s, Wall: 0.09 s
```

BUT:

```
sage: L.elliptic_logarithm(P, prec=600)
HANGS FOREVER
```

Hitting control-c and using the debugger suggests that the termination condition is impossible.  You end up in this line `if (r.abs()-1).abs() < eps: break` with actually having `(r.abs()-1).abs() == eps`, so the strict inequality isnt' satisfied, and maybe for some reason it can't be???

```

ipdb> l
   1357             r = C(((xP-e3)/(xP-e2)).sqrt())
   1358             if r.real()<0: r=-r
   1359             t = -C(wP)/(2*r*(xP-e2))
   1360             eps = R(1)>>(prec2);
   1361             while True:        
-> 1362                 s = b*r+a
   1363                 a, b = (a+b)/2, (a*b).sqrt()
   1364                 if (a+b).abs() < (a-b).abs():  b=-b
   1365                 r = (a*(r+1)/s).sqrt()
   1366                 if (r.abs()-1).abs() < eps: break
   1367                 if r.real()<0: r=-r

ipdb> print eps
5.80771375621750318328344999898952221581714435905885826948966319082059051450573607513973642929306226703333487164506974570166210185861027247933383445853709821724799129294394972880718063974478259360634645856449058721344643691320490207325897321618392592839150233975392885056947380044108965624364302537017698344822203678107744035231793749824965395444912652822986530e-362
ipdb> print r    
1.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ipdb> print (r.abs()-1).abs()
5.80771375621750318328344999898952221581714435905885826948966319082059051450573607513973642929306226703333487164506974570166210185861027247933383445853709821724799129294394972880718063974478259360634645856449058721344643691320490207325897321618392592839150233975392885056947380044108965624364302537017698344822203678107744035231793749824965395444912652822986530e-362
ipdb> print eps
5.80771375621750318328344999898952221581714435905885826948966319082059051450573607513973642929306226703333487164506974570166210185861027247933383445853709821724799129294394972880718063974478259360634645856449058721344643691320490207325897321618392592839150233975392885056947380044108965624364302537017698344822203678107744035231793749824965395444912652822986530e-362
ipdb> print (r.abs()-1).abs() < eps
False
ipdb> print (r.abs()-1).abs() <= eps
True
```

Changing `< eps` to `<= eps` in two spots in the relevant file seems to fix the problem for me.

---

Apply
1. [attachment: trac_11767b.patch.gz](https://github.com/sagemath/sage/files/ticket11767/trac_11767b.patch.gz)
2. [attachment: trac_11767c.patch.gz](https://github.com/sagemath/sage/files/ticket11767/trac_11767c.patch.gz)
to the Sage library.


Assignee: **@JohnCremona**

Keywords: **ecc2011**

Author: **Paul Zimmermann**

Reviewer: **John Cremona, Leif Leonhardy, William Stein**

Merged: **sage-4.7.2.alpha3**

_Issue created by migration from https://trac.sagemath.org/ticket/11767_





---

archive/issue_events_144460.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2011-08-31T21:51:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "milestone_number": null,
    "milestone_title": "sage-4.7.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11767#event-144460"
}
```



---

archive/issue_events_144461.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2011-08-31T21:51:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20elliptic%20curves",
    "label_color": "0000ff",
    "label_name": "component: elliptic curves",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11767#event-144461"
}
```



---

archive/issue_events_144462.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2011-08-31T21:51:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11767#event-144462"
}
```



---

archive/issue_events_144463.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2011-08-31T21:51:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11767#event-144463"
}
```



---

archive/issue_comments_124806.json:
```json
{
    "body": "<a id='comment:1'>Comment 1:</a>\nIn case you provide a patch, you could also fix this:\n\n```\n        # embeddings uses only real arithmetic i nthe iteraion, and is\n```\n(And remove the superfluous semicolon from `eps = R(1)>>(prec2);` twice.)",
    "created_at": "2011-08-31T22:54:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124806",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:1'>Comment 1:</a>
In case you provide a patch, you could also fix this:

```
        # embeddings uses only real arithmetic i nthe iteraion, and is
```
(And remove the superfluous semicolon from `eps = R(1)>>(prec2);` twice.)



---

archive/issue_comments_124807.json:
```json
{
    "body": "<a id='comment:2'>Comment 2:</a>\nI do not claim to understand the `<` versus `<=` issue, since I do not know the algorithm in question.  But I can attach a patch with this fix, which fixes the problem, has an example to illustrate that the problem is fixed, and fixes the typos leif mentions above.  Perhaps this will be easy for John Cremona to referee.",
    "created_at": "2011-09-01T04:01:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124807",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:2'>Comment 2:</a>
I do not claim to understand the `<` versus `<=` issue, since I do not know the algorithm in question.  But I can attach a patch with this fix, which fixes the problem, has an example to illustrate that the problem is fixed, and fixes the typos leif mentions above.  Perhaps this will be easy for John Cremona to referee.



---

archive/issue_events_144464.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2011-09-01T04:01:29Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11767#event-144464"
}
```



---

archive/issue_comments_124808.json:
```json
{
    "body": "Attachment: **[trac_11767.patch.gz](https://github.com/sagemath/sage/files/ticket11767/trac_11767.patch.gz)**",
    "created_at": "2011-09-01T04:02:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124808",
    "user": "https://github.com/williamstein"
}
```

Attachment: **[trac_11767.patch.gz](https://github.com/sagemath/sage/files/ticket11767/trac_11767.patch.gz)**



---

archive/issue_comments_124809.json:
```json
{
    "body": "<a id='comment:3'>Comment 3:</a>\nFWIW, using\n\n```python\n        R = RealField(prec2+1)\n        C = ComplexField(prec2+1)\n```\ninstead also works for (and seems a bit cleaner to) me, though of course a bit more expensive.\n\nJohn will certainly know better.",
    "created_at": "2011-09-01T04:42:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124809",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:3'>Comment 3:</a>
FWIW, using

```python
        R = RealField(prec2+1)
        C = ComplexField(prec2+1)
```
instead also works for (and seems a bit cleaner to) me, though of course a bit more expensive.

John will certainly know better.



---

archive/issue_comments_124810.json:
```json
{
    "body": "<a id='comment:4'>Comment 4:</a>\nI cannot fix this now and maybe someone else should anyway, since my numerical analysis expertise is clearly lacking -- apologies.  The underlying algorithm here is very good indeed (double exponential) but the stopping condition needs to be handled properly.\n\nIn the function elliptic_logarithm, first of all the working precision is doubled (prec2 is 2*prec)!  Overkill perhaps but with this algorithm the number of correct digits doubles with each step anyway.  The stopping condition (line 1366) is that the relative error is < eps where eps is `2^-prec2`.  In the loop, a and b are sequences of complex numbers which converge to a common limit and we ant to stop when a/b is close to 1.  Similarly on line 1400 where a,b are real.\n\nI think that the right thing to do would be to replace eps by `2^-(prec2-1)` or something similar.  Also, replacing \"while True\" by something else so that infinite looping is impossible?\n\nI'm glad this function is useful, by the way -- there is no other software which can take complex elliptic logs!",
    "created_at": "2011-09-03T16:41:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124810",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:4'>Comment 4:</a>
I cannot fix this now and maybe someone else should anyway, since my numerical analysis expertise is clearly lacking -- apologies.  The underlying algorithm here is very good indeed (double exponential) but the stopping condition needs to be handled properly.

In the function elliptic_logarithm, first of all the working precision is doubled (prec2 is 2*prec)!  Overkill perhaps but with this algorithm the number of correct digits doubles with each step anyway.  The stopping condition (line 1366) is that the relative error is < eps where eps is `2^-prec2`.  In the loop, a and b are sequences of complex numbers which converge to a common limit and we ant to stop when a/b is close to 1.  Similarly on line 1400 where a,b are real.

I think that the right thing to do would be to replace eps by `2^-(prec2-1)` or something similar.  Also, replacing "while True" by something else so that infinite looping is impossible?

I'm glad this function is useful, by the way -- there is no other software which can take complex elliptic logs!



---

archive/issue_comments_124811.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\n> I'm glad this function is useful, by the way -- there is no other \n> software which can take complex elliptic logs!\n\nThanks -- it's absolutely *critical* for my research right now!",
    "created_at": "2011-09-03T17:10:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124811",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:5'>Comment 5:</a>
> I'm glad this function is useful, by the way -- there is no other 
> software which can take complex elliptic logs!

Thanks -- it's absolutely *critical* for my research right now!



---

archive/issue_comments_124812.json:
```json
{
    "body": "<a id='comment:6'>Comment 6:</a>\nanother typo in that file:\n\n```\n...the the returned value z...\n```\nPaul",
    "created_at": "2011-09-14T12:59:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124812",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:6'>Comment 6:</a>
another typo in that file:

```
...the the returned value z...
```
Paul



---

archive/issue_comments_124813.json:
```json
{
    "body": "this patch should be applied after the previous one",
    "created_at": "2011-09-14T13:45:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124813",
    "user": "https://github.com/zimmermann6"
}
```

this patch should be applied after the previous one



---

archive/issue_comments_124814.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\nAttachment: **[trac_11767a.patch.gz](https://github.com/sagemath/sage/files/ticket11767/trac_11767a.patch.gz)**\n\nI have added a 2nd patch (to be applied after the first one) which solves the typo, and\nmodifies the termination condition.\n\nAs far as I understand, the termination is when the (complex) variable `r` becomes 1.\nWe compute the complex norm of `r`, subtract one from it, and compare to `eps`\nwhich is `2^(-prec2)`.\n\nIf `r` is near one, typically `r.abs()` will be 1, or one of the floating-point numbers\nnear from 1, which are `1-2^(-prec2)` and `1+2^(1-prec2)`. The subtraction of 1 is exact,\nand the only case where the comparison `r.abs()-1 < eps` can be true is when `r=1`.\n\nWhat I've done is that I've changed the termination condition to also check whether the\nrelative difference `r.abs()-1` does not change from one step to the next one.\nSince `r.abs()-1` converges to one, this should catch cases where it stays at say\n`1-2^(-prec2)` due to rounding errors. However it will not catch cases where it oscillates\nbetween two different values near from 1.\n\nPaul",
    "created_at": "2011-09-14T13:55:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124814",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:7'>Comment 7:</a>
Attachment: **[trac_11767a.patch.gz](https://github.com/sagemath/sage/files/ticket11767/trac_11767a.patch.gz)**

I have added a 2nd patch (to be applied after the first one) which solves the typo, and
modifies the termination condition.

As far as I understand, the termination is when the (complex) variable `r` becomes 1.
We compute the complex norm of `r`, subtract one from it, and compare to `eps`
which is `2^(-prec2)`.

If `r` is near one, typically `r.abs()` will be 1, or one of the floating-point numbers
near from 1, which are `1-2^(-prec2)` and `1+2^(1-prec2)`. The subtraction of 1 is exact,
and the only case where the comparison `r.abs()-1 < eps` can be true is when `r=1`.

What I've done is that I've changed the termination condition to also check whether the
relative difference `r.abs()-1` does not change from one step to the next one.
Since `r.abs()-1` converges to one, this should catch cases where it stays at say
`1-2^(-prec2)` due to rounding errors. However it will not catch cases where it oscillates
between two different values near from 1.

Paul



---

archive/issue_comments_124815.json:
```json
{
    "body": "<a id='comment:8'>Comment 8:</a>\nPaul, thanks.  I trust your knowledge of binary floating point issues as being much better than my own.  Are you saying that even with your patch the termination condition may never hold and hence we loop forever?\n\nBearing in mind that I already doubled the precision (prec2 = 2*prec)  should we perhaps change `1-2^(-prec2)` to ` 1-2^(-prec2+1)`?  If that would mean that termination is then guaranteed?",
    "created_at": "2011-09-14T14:06:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124815",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:8'>Comment 8:</a>
Paul, thanks.  I trust your knowledge of binary floating point issues as being much better than my own.  Are you saying that even with your patch the termination condition may never hold and hence we loop forever?

Bearing in mind that I already doubled the precision (prec2 = 2*prec)  should we perhaps change `1-2^(-prec2)` to ` 1-2^(-prec2+1)`?  If that would mean that termination is then guaranteed?



---

archive/issue_comments_124816.json:
```json
{
    "body": "<a id='comment:9'>Comment 9:</a>\nJohn, if you change `eps` to `2^(-prec2+1)` instead of `2^(-prec2)` then the case\nwhere `r = 1 - 2^(-prec2)` will also terminate with the < condition. But the case where\n`r = 1 + 2^(-prec2+1)` will still loop.\n\nIf the target precision is `prec` and you compute internally with `2*prec` bits, then\n`eps` could be `2^(-prec)`, no?\n\nPaul",
    "created_at": "2011-09-14T14:51:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124816",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:9'>Comment 9:</a>
John, if you change `eps` to `2^(-prec2+1)` instead of `2^(-prec2)` then the case
where `r = 1 - 2^(-prec2)` will also terminate with the < condition. But the case where
`r = 1 + 2^(-prec2+1)` will still loop.

If the target precision is `prec` and you compute internally with `2*prec` bits, then
`eps` could be `2^(-prec)`, no?

Paul



---

archive/issue_comments_124817.json:
```json
{
    "body": "<a id='comment:10'>Comment 10:</a>\nReplying to [@zimmermann6](#comment%3A9):\n> John, if you change `eps` to `2^(-prec2+1)` instead of `2^(-prec2)` then the case\n> where `r = 1 - 2^(-prec2)` will also terminate with the < condition. But the case where\n> `r = 1 + 2^(-prec2+1)` will still loop.\n\nWell, either `r.abs()` converges to one, or it doesn't. So if you compute with sufficiently high precision, especially not choosing epsilon to be the minimal positive value of the floating point type used, the termination condition will get true after some iterations.",
    "created_at": "2011-09-14T17:10:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124817",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:10'>Comment 10:</a>
Replying to [@zimmermann6](#comment%3A9):
> John, if you change `eps` to `2^(-prec2+1)` instead of `2^(-prec2)` then the case
> where `r = 1 - 2^(-prec2)` will also terminate with the < condition. But the case where
> `r = 1 + 2^(-prec2+1)` will still loop.

Well, either `r.abs()` converges to one, or it doesn't. So if you compute with sufficiently high precision, especially not choosing epsilon to be the minimal positive value of the floating point type used, the termination condition will get true after some iterations.



---

archive/issue_comments_124818.json:
```json
{
    "body": "<a id='comment:11'>Comment 11:</a>\nok, after looking again, it seems that using `prec2 = 2*prec` is overkill.\nUsually, what we do in MPFR is that we use as internal precision prec + log2(prec) + a few bits.\nTo avoid computing a log(), I suggest using `prec2 = prec + 40` which should be large enough.\nWith this change, William's example with prec=600 runs ok. John, if you agree with that, I can\nmake a new patch.\n\nPaul",
    "created_at": "2011-09-15T06:23:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124818",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:11'>Comment 11:</a>
ok, after looking again, it seems that using `prec2 = 2*prec` is overkill.
Usually, what we do in MPFR is that we use as internal precision prec + log2(prec) + a few bits.
To avoid computing a log(), I suggest using `prec2 = prec + 40` which should be large enough.
With this change, William's example with prec=600 runs ok. John, if you agree with that, I can
make a new patch.

Paul



---

archive/issue_comments_124819.json:
```json
{
    "body": "<a id='comment:12'>Comment 12:</a>\nReplying to [@zimmermann6](#comment%3A11):\n> ok, after looking again, it seems that using `prec2 = 2*prec` is overkill.\n> Usually, what we do in MPFR is that we use as internal precision prec + log2(prec) + a few bits.\n> To avoid computing a log(), I suggest using `prec2 = prec + 40` which should be large enough.\n> With this change, William's example with prec=600 runs ok. John, if you agree with that, I can\n> make a new patch.\n> \n> Paul\n\nI agree, that is fine.  I put in 2*prec for testing and it worked (well, for several months!) and the algorithm was fast enough that I never bothered to work out a more sensible increase.\n\nAfter today (Thursday 15/9/11) I'll be away for 8 days so please don't wait for my approval to give the new patch a positive review assuming that the tests pass, including the new doctest with William's example.",
    "created_at": "2011-09-15T08:26:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124819",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:12'>Comment 12:</a>
Replying to [@zimmermann6](#comment%3A11):
> ok, after looking again, it seems that using `prec2 = 2*prec` is overkill.
> Usually, what we do in MPFR is that we use as internal precision prec + log2(prec) + a few bits.
> To avoid computing a log(), I suggest using `prec2 = prec + 40` which should be large enough.
> With this change, William's example with prec=600 runs ok. John, if you agree with that, I can
> make a new patch.
> 
> Paul

I agree, that is fine.  I put in 2*prec for testing and it worked (well, for several months!) and the algorithm was fast enough that I never bothered to work out a more sensible increase.

After today (Thursday 15/9/11) I'll be away for 8 days so please don't wait for my approval to give the new patch a positive review assuming that the tests pass, including the new doctest with William's example.



---

archive/issue_comments_124820.json:
```json
{
    "body": "attach only that patch",
    "created_at": "2011-09-15T08:56:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124820",
    "user": "https://github.com/zimmermann6"
}
```

attach only that patch



---

archive/issue_comments_124821.json:
```json
{
    "body": "<a id='comment:13'>Comment 13:</a>\nAttachment: **[trac_11767b.patch.gz](https://github.com/sagemath/sage/files/ticket11767/trac_11767b.patch.gz)**\n\nJohn, thank you for your feedback. I've now uploaded a new patch `trac_11767b.patch` which\nshould be applied solely. William, please could you review that ticket?\n\nPaul",
    "created_at": "2011-09-15T08:58:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124821",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:13'>Comment 13:</a>
Attachment: **[trac_11767b.patch.gz](https://github.com/sagemath/sage/files/ticket11767/trac_11767b.patch.gz)**

John, thank you for your feedback. I've now uploaded a new patch `trac_11767b.patch` which
should be applied solely. William, please could you review that ticket?

Paul



---

archive/issue_comments_124822.json:
```json
{
    "body": "<a id='comment:14'>Comment 14:</a>\nReplying to [@zimmermann6](#comment%3A13):\n> John, thank you for your feedback. I've now uploaded a new patch `trac_11767b.patch` which\n> should be applied solely. William, please could you review that ticket?\n> \n> Paul\n\nThe patch looks fine to me though I have not tested it.  With a Positive Review the testbot will test it thoroughly anyway, but I think that at least one human who is not the author should test it too.",
    "created_at": "2011-09-15T09:23:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124822",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:14'>Comment 14:</a>
Replying to [@zimmermann6](#comment%3A13):
> John, thank you for your feedback. I've now uploaded a new patch `trac_11767b.patch` which
> should be applied solely. William, please could you review that ticket?
> 
> Paul

The patch looks fine to me though I have not tested it.  With a Positive Review the testbot will test it thoroughly anyway, but I think that at least one human who is not the author should test it too.



---

archive/issue_comments_124823.json:
```json
{
    "body": "<a id='comment:15'>Comment 15:</a>\nWell, I think even I can review this. ;-)\n\nBy the way, I guess the double \"the\" should have read \"then the\", i.e., an \"n\" was missing rather than a word duplicated, but it's ok as is, too.\n\nSo I think we have a positive review.\n\nOf course William could again stress-test this, but at least there should no longer be endless loops, and the algorithm converges fast (with an *unmodified* termination condition, except that epsilon is now larger for high precision inputs), such that I don't expect very different or much less precise results w.r.t. the previous version either. Note that epsilon will now even be smaller for *lower* precision inputs.",
    "created_at": "2011-09-15T10:37:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124823",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:15'>Comment 15:</a>
Well, I think even I can review this. ;-)

By the way, I guess the double "the" should have read "then the", i.e., an "n" was missing rather than a word duplicated, but it's ok as is, too.

So I think we have a positive review.

Of course William could again stress-test this, but at least there should no longer be endless loops, and the algorithm converges fast (with an *unmodified* termination condition, except that epsilon is now larger for high precision inputs), such that I don't expect very different or much less precise results w.r.t. the previous version either. Note that epsilon will now even be smaller for *lower* precision inputs.



---

archive/issue_comments_124824.json:
```json
{
    "body": "Reviewer: **John Cremona, Leif Leonhardy**",
    "created_at": "2011-09-15T10:37:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124824",
    "user": "https://github.com/nexttime"
}
```

Reviewer: **John Cremona, Leif Leonhardy**



---

archive/issue_comments_124825.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -50,4 +50,9 @@\n True\n ```\n \n-Changing `< eps` to `<= eps` in two spots in the relevant file seems to fix the problem for me. \n+Changing `< eps` to `<= eps` in two spots in the relevant file seems to fix the problem for me.\n+\n+---\n+\n+Apply only [attachment: trac_11767b.patch.gz](https://github.com/sagemath/sage/files/ticket11767/trac_11767b.patch.gz) to the Sage library.\n+\n``````\n",
    "created_at": "2011-09-15T10:37:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124825",
    "user": "https://github.com/nexttime"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -50,4 +50,9 @@
 True
 ```
 
-Changing `< eps` to `<= eps` in two spots in the relevant file seems to fix the problem for me. 
+Changing `< eps` to `<= eps` in two spots in the relevant file seems to fix the problem for me.
+
+---
+
+Apply only [attachment: trac_11767b.patch.gz](https://github.com/sagemath/sage/files/ticket11767/trac_11767b.patch.gz) to the Sage library.
+
``````




---

archive/issue_comments_124826.json:
```json
{
    "body": "Author: **Paul Zimmermann**",
    "created_at": "2011-09-15T10:37:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124826",
    "user": "https://github.com/nexttime"
}
```

Author: **Paul Zimmermann**



---

archive/issue_comments_124827.json:
```json
{
    "body": "<a id='comment:16'>Comment 16:</a>\nOh, the superfluous semicolons survived Paul's patch, but I don't mind.",
    "created_at": "2011-09-15T10:43:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124827",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:16'>Comment 16:</a>
Oh, the superfluous semicolons survived Paul's patch, but I don't mind.



---

archive/issue_comments_124828.json:
```json
{
    "body": "<a id='comment:17'>Comment 17:</a>\nLeif,\n\n> So I think we have a positive review.\n\nyou didn't hit \"positive review\" thus you are waiting for William's review?\n\nNote that William's example seems to exercise only the case where `r` is real in the\ncode. Maybe one should check that there is at least one example where `r` is complex\nwith large precision, or add one if it is not the case.\n\nPaul",
    "created_at": "2011-09-15T11:13:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124828",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:17'>Comment 17:</a>
Leif,

> So I think we have a positive review.

you didn't hit "positive review" thus you are waiting for William's review?

Note that William's example seems to exercise only the case where `r` is real in the
code. Maybe one should check that there is at least one example where `r` is complex
with large precision, or add one if it is not the case.

Paul



---

archive/issue_comments_124829.json:
```json
{
    "body": "<a id='comment:18'>Comment 18:</a>\nReplying to [@zimmermann6](#comment%3A17):\n> Leif,\n> \n> > So I think we have a positive review.\n\n> \n> you didn't hit \"positive review\" thus you are waiting for William's review?\n\nYes, it's 4 am over there...",
    "created_at": "2011-09-15T11:19:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124829",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:18'>Comment 18:</a>
Replying to [@zimmermann6](#comment%3A17):
> Leif,
> 
> > So I think we have a positive review.

> 
> you didn't hit "positive review" thus you are waiting for William's review?

Yes, it's 4 am over there...



---

archive/issue_comments_124830.json:
```json
{
    "body": "<a id='comment:19'>Comment 19:</a>\nReplying to [@zimmermann6](#comment%3A17):\n> Leif,\n> \n> > So I think we have a positive review.\n\n> \n> you didn't hit \"positive review\" thus you are waiting for William's review?\n> \n> Note that William's example seems to exercise only the case where `r` is real in the\n> code. Maybe one should check that there is at least one example where `r` is complex\n> with large precision, or add one if it is not the case.\n> \n\nThat is a *very* good observation.  The real case algorithm has been known for a very long time, but the complex case (using a generalised complex AGM) is still in preprint form!  I will come up with an example.\n\n\n> Paul",
    "created_at": "2011-09-15T11:29:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124830",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:19'>Comment 19:</a>
Replying to [@zimmermann6](#comment%3A17):
> Leif,
> 
> > So I think we have a positive review.

> 
> you didn't hit "positive review" thus you are waiting for William's review?
> 
> Note that William's example seems to exercise only the case where `r` is real in the
> code. Maybe one should check that there is at least one example where `r` is complex
> with large precision, or add one if it is not the case.
> 

That is a *very* good observation.  The real case algorithm has been known for a very long time, but the complex case (using a generalised complex AGM) is still in preprint form!  I will come up with an example.


> Paul



---

archive/issue_comments_124831.json:
```json
{
    "body": "<a id='comment:20'>Comment 20:</a>\nTry this:\n\n```\nsage: K.<a> = QuadraticField(-5)\nsage: E = EllipticCurve([1,1,a,a,0])\nsage: P = E(0,0)\nsage: P.order()\n+Infinity\nsage: L = P.curve().period_lattice(K.embeddings(ComplexField())[0])\nsage: time L.elliptic_logarithm(P, prec=500)\n1.17058357737548897849026170185581196033579563441850967539191867385734983296504066660506637438866628981886518901958717288150400849746892393771983141354 - 1.13513899565966043682474529757126359416758251309237866586896869548539516543734207347695898664875799307727928332953834601460994992792519799260968053875*I\nTime: CPU 0.35 s, Wall: 0.36 s\nsage: L = P.curve().period_lattice(K.embeddings(ComplexField(1000))[0])\nsage: time L.elliptic_logarithm(P, prec=1000)\n```\nThe last line hangs with vanilla 4.7.1.  prec=900 is still OK.  Note that it is irrelevant to specify the precision when constructing the period lattice, since the only use made of the embedding at that stage is to determine which emebedding is required;  the elliptic log computation is where the floating point work is done.",
    "created_at": "2011-09-15T11:36:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124831",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:20'>Comment 20:</a>
Try this:

```
sage: K.<a> = QuadraticField(-5)
sage: E = EllipticCurve([1,1,a,a,0])
sage: P = E(0,0)
sage: P.order()
+Infinity
sage: L = P.curve().period_lattice(K.embeddings(ComplexField())[0])
sage: time L.elliptic_logarithm(P, prec=500)
1.17058357737548897849026170185581196033579563441850967539191867385734983296504066660506637438866628981886518901958717288150400849746892393771983141354 - 1.13513899565966043682474529757126359416758251309237866586896869548539516543734207347695898664875799307727928332953834601460994992792519799260968053875*I
Time: CPU 0.35 s, Wall: 0.36 s
sage: L = P.curve().period_lattice(K.embeddings(ComplexField(1000))[0])
sage: time L.elliptic_logarithm(P, prec=1000)
```
The last line hangs with vanilla 4.7.1.  prec=900 is still OK.  Note that it is irrelevant to specify the precision when constructing the period lattice, since the only use made of the embedding at that stage is to determine which emebedding is required;  the elliptic log computation is where the floating point work is done.



---

archive/issue_comments_124832.json:
```json
{
    "body": "<a id='comment:21'>Comment 21:</a>\nReplying to [@JohnCremona](#comment%3A20):\n> Try this:\n\nBoth work for me with Paul's patch.",
    "created_at": "2011-09-15T11:43:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124832",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:21'>Comment 21:</a>
Replying to [@JohnCremona](#comment%3A20):
> Try this:

Both work for me with Paul's patch.



---

archive/issue_comments_124833.json:
```json
{
    "body": "<a id='comment:22'>Comment 22:</a>\nReplying to [@nexttime](#comment%3A21):\n> Replying to [@JohnCremona](#comment%3A20):\n> > Try this:\n\n> \n> Both work for me with Paul's patch.\n\nThanks for testing.  Paul, could you add the new example to the tests?  You can use exactly the code I provided though the line\n\n```\nsage: L = P.curve().period_lattice(K.embeddings(ComplexField(1000))[0])\n```\ncan be omitted for the reasons I explained (the lattice only needs to be defined once, with no precision specified).",
    "created_at": "2011-09-15T12:35:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124833",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:22'>Comment 22:</a>
Replying to [@nexttime](#comment%3A21):
> Replying to [@JohnCremona](#comment%3A20):
> > Try this:

> 
> Both work for me with Paul's patch.

Thanks for testing.  Paul, could you add the new example to the tests?  You can use exactly the code I provided though the line

```
sage: L = P.curve().period_lattice(K.embeddings(ComplexField(1000))[0])
```
can be omitted for the reasons I explained (the lattice only needs to be defined once, with no precision specified).



---

archive/issue_comments_124834.json:
```json
{
    "body": "Attachment: **[trac_11767c.patch.gz](https://github.com/sagemath/sage/files/ticket11767/trac_11767c.patch.gz)**\n\napply this patch after trac_11767b.patch",
    "created_at": "2011-09-15T13:11:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124834",
    "user": "https://github.com/zimmermann6"
}
```

Attachment: **[trac_11767c.patch.gz](https://github.com/sagemath/sage/files/ticket11767/trac_11767c.patch.gz)**

apply this patch after trac_11767b.patch



---

archive/issue_comments_124835.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -54,5 +54,6 @@\n \n ---\n \n-Apply only [attachment: trac_11767b.patch.gz](https://github.com/sagemath/sage/files/ticket11767/trac_11767b.patch.gz) to the Sage library.\n+Apply only [attachment: trac_11767b.patch.gz](https://github.com/sagemath/sage/files/ticket11767/trac_11767b.patch.gz) and\n+[attachment: trac_11767c.patch.gz](https://github.com/sagemath/sage/files/ticket11767/trac_11767c.patch.gz) (in this order) to the Sage library.\n \n``````\n",
    "created_at": "2011-09-15T13:13:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124835",
    "user": "https://github.com/zimmermann6"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -54,5 +54,6 @@
 
 ---
 
-Apply only [attachment: trac_11767b.patch.gz](https://github.com/sagemath/sage/files/ticket11767/trac_11767b.patch.gz) to the Sage library.
+Apply only [attachment: trac_11767b.patch.gz](https://github.com/sagemath/sage/files/ticket11767/trac_11767b.patch.gz) and
+[attachment: trac_11767c.patch.gz](https://github.com/sagemath/sage/files/ticket11767/trac_11767c.patch.gz) (in this order) to the Sage library.
 
``````




---

archive/issue_comments_124836.json:
```json
{
    "body": "<a id='comment:23'>Comment 23:</a>\nI knew I should not have opened my mouth... Attached is a second patch. Don't ask me to make a\nunified patch, I prefer to spend my time on other tickets.\n\nPaul",
    "created_at": "2011-09-15T13:13:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124836",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:23'>Comment 23:</a>
I knew I should not have opened my mouth... Attached is a second patch. Don't ask me to make a
unified patch, I prefer to spend my time on other tickets.

Paul



---

archive/issue_comments_124837.json:
```json
{
    "body": "<a id='comment:24'>Comment 24:</a>\nReplying to [@zimmermann6](#comment%3A23):\n> I knew I should not have opened my mouth... Attached is a second patch. Don't ask me to make a\n> unified patch, I prefer to spend my time on other tickets.\n> \n> Paul\n\nThank you!",
    "created_at": "2011-09-15T13:17:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124837",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:24'>Comment 24:</a>
Replying to [@zimmermann6](#comment%3A23):
> I knew I should not have opened my mouth... Attached is a second patch. Don't ask me to make a
> unified patch, I prefer to spend my time on other tickets.
> 
> Paul

Thank you!



---

archive/issue_comments_124838.json:
```json
{
    "body": "<a id='comment:25'>Comment 25:</a>\nFWIW, 11767b+c also passes doctests here.\n\n\n\n\nP.S.:\n\nThere are various ways to make one patch out of two. E.g., take a fresh branch, import the first with `--no-commit`, and the second with `-f`(orce), then commit the cumulative changes. A diff is even easier, just compare the tip to the changeset two below the tip. (If you export two changesets at once, they will end up in one file, but effectively be two patches which are simply concatenated, but you can in turn re-import such a patch as one changeset into a fresh branch and re-export it as a true single patch.)",
    "created_at": "2011-09-15T13:52:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124838",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:25'>Comment 25:</a>
FWIW, 11767b+c also passes doctests here.




P.S.:

There are various ways to make one patch out of two. E.g., take a fresh branch, import the first with `--no-commit`, and the second with `-f`(orce), then commit the cumulative changes. A diff is even easier, just compare the tip to the changeset two below the tip. (If you export two changesets at once, they will end up in one file, but effectively be two patches which are simply concatenated, but you can in turn re-import such a patch as one changeset into a fresh branch and re-export it as a true single patch.)



---

archive/issue_comments_124839.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -54,6 +54,8 @@\n \n ---\n \n-Apply only [attachment: trac_11767b.patch.gz](https://github.com/sagemath/sage/files/ticket11767/trac_11767b.patch.gz) and\n-[attachment: trac_11767c.patch.gz](https://github.com/sagemath/sage/files/ticket11767/trac_11767c.patch.gz) (in this order) to the Sage library.\n+Apply\n+1. [attachment: trac_11767b.patch.gz](https://github.com/sagemath/sage/files/ticket11767/trac_11767b.patch.gz)\n+2. [attachment: trac_11767c.patch.gz](https://github.com/sagemath/sage/files/ticket11767/trac_11767c.patch.gz)\n+to the Sage library.\n \n``````\n",
    "created_at": "2011-09-15T13:52:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124839",
    "user": "https://github.com/nexttime"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -54,6 +54,8 @@
 
 ---
 
-Apply only [attachment: trac_11767b.patch.gz](https://github.com/sagemath/sage/files/ticket11767/trac_11767b.patch.gz) and
-[attachment: trac_11767c.patch.gz](https://github.com/sagemath/sage/files/ticket11767/trac_11767c.patch.gz) (in this order) to the Sage library.
+Apply
+1. [attachment: trac_11767b.patch.gz](https://github.com/sagemath/sage/files/ticket11767/trac_11767b.patch.gz)
+2. [attachment: trac_11767c.patch.gz](https://github.com/sagemath/sage/files/ticket11767/trac_11767c.patch.gz)
+to the Sage library.
 
``````




---

archive/issue_comments_124840.json:
```json
{
    "body": "Changed keywords from **** to **ecc2011**",
    "created_at": "2011-09-16T12:28:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124840",
    "user": "https://github.com/zimmermann6"
}
```

Changed keywords from **** to **ecc2011**



---

archive/issue_comments_124841.json:
```json
{
    "body": "<a id='comment:27'>Comment 27:</a>\nCan someone (William?) give this a final positive review?\n\nIf this happens within a few hours, I can still merge it into Sage 4.7.2.alpha3.",
    "created_at": "2011-09-18T05:16:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124841",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:27'>Comment 27:</a>
Can someone (William?) give this a final positive review?

If this happens within a few hours, I can still merge it into Sage 4.7.2.alpha3.



---

archive/issue_events_144465.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2011-09-18T14:56:46Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11767#event-144465"
}
```



---

archive/issue_events_144466.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2011-09-18T14:56:46Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11767#event-144466"
}
```



---

archive/issue_comments_124842.json:
```json
{
    "body": "<a id='comment:28'>Comment 28:</a>\nfinal positive review.",
    "created_at": "2011-09-18T14:56:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124842",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:28'>Comment 28:</a>
final positive review.



---

archive/issue_comments_124843.json:
```json
{
    "body": "Changed reviewer from **John Cremona, Leif Leonhardy** to **John Cremona, Leif Leonhardy, William Stein**",
    "created_at": "2011-09-18T15:06:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124843",
    "user": "https://github.com/nexttime"
}
```

Changed reviewer from **John Cremona, Leif Leonhardy** to **John Cremona, Leif Leonhardy, William Stein**



---

archive/issue_events_144467.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2011-09-18T22:59:06Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11767#event-144467"
}
```



---

archive/issue_events_144468.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2011-09-18T22:59:06Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11767#event-144468"
}
```



---

archive/issue_comments_124844.json:
```json
{
    "body": "Merged: **sage-4.7.2.alpha3**",
    "created_at": "2011-09-18T22:59:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-124844",
    "user": "https://github.com/nexttime"
}
```

Merged: **sage-4.7.2.alpha3**
