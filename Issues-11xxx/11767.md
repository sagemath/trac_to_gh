# Issue 11767: elliptic_logarithm of high precision points often hangs forever

archive/issues_011595.json:
```json
{
    "assignees": [
        "https://github.com/JohnCremona"
    ],
    "body": "I am doing a project to compute Chow-Heegner points with Darmon, Rotger, et al., and am using Sage's `elliptic_logarithm` function with high precision points as input.  Unfortunately, it completely hangs on many input points over number fields.  Here is an example below, where computing to precision 500 works fine, but precision 600 hangs Sage forever:\n\n```\nsage: R.<x> = QQ[]\nsage: K.<a> = NumberField(x^2 + x + 5)\nsage: E = EllipticCurve(K, [0,0,1,-3,-5])\nsage: P = E([0,a])\nsage: L = P.curve().period_lattice(K.embeddings(ComplexField(600))[0])\nsage: time L.elliptic_logarithm(P, prec=500)\n\n-0.842248166487739393375018008381693990800588864069506187033873183845246233548058477561706400464057832396643843146464236956684557207157300006542470428494 - 0.571366031453267388121279381354098224265947866751130917440598461117775339240176310729173301979590106474259885638797913383502735083088736326391919063211*I\nTime: CPU 0.08 s, Wall: 0.09 s\n```\n\nBUT:\n\n```\nsage: L.elliptic_logarithm(P, prec=600)\nHANGS FOREVER\n```\n\nHitting control-c and using the debugger suggests that the termination condition is impossible.  You end up in this line `if (r.abs()-1).abs() < eps: break` with actually having `(r.abs()-1).abs() == eps`, so the strict inequality isnt' satisfied, and maybe for some reason it can't be???\n\n```\n\nipdb> l\n   1357             r = C(((xP-e3)/(xP-e2)).sqrt())\n   1358             if r.real()<0: r=-r\n   1359             t = -C(wP)/(2*r*(xP-e2))\n   1360             eps = R(1)>>(prec2);\n   1361             while True:        \n-> 1362                 s = b*r+a\n   1363                 a, b = (a+b)/2, (a*b).sqrt()\n   1364                 if (a+b).abs() < (a-b).abs():  b=-b\n   1365                 r = (a*(r+1)/s).sqrt()\n   1366                 if (r.abs()-1).abs() < eps: break\n   1367                 if r.real()<0: r=-r\n\nipdb> print eps\n5.80771375621750318328344999898952221581714435905885826948966319082059051450573607513973642929306226703333487164506974570166210185861027247933383445853709821724799129294394972880718063974478259360634645856449058721344643691320490207325897321618392592839150233975392885056947380044108965624364302537017698344822203678107744035231793749824965395444912652822986530e-362\nipdb> print r    \n1.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\nipdb> print (r.abs()-1).abs()\n5.80771375621750318328344999898952221581714435905885826948966319082059051450573607513973642929306226703333487164506974570166210185861027247933383445853709821724799129294394972880718063974478259360634645856449058721344643691320490207325897321618392592839150233975392885056947380044108965624364302537017698344822203678107744035231793749824965395444912652822986530e-362\nipdb> print eps\n5.80771375621750318328344999898952221581714435905885826948966319082059051450573607513973642929306226703333487164506974570166210185861027247933383445853709821724799129294394972880718063974478259360634645856449058721344643691320490207325897321618392592839150233975392885056947380044108965624364302537017698344822203678107744035231793749824965395444912652822986530e-362\nipdb> print (r.abs()-1).abs() < eps\nFalse\nipdb> print (r.abs()-1).abs() <= eps\nTrue\n```\n\nChanging `< eps` to `<= eps` in two spots in the relevant file seems to fix the problem for me.\n\n---\n\nApply\n1. [attachment: trac_11767b.patch](https://github.com/sagemath/sage/files/ticket11767/trac_11767b.patch.gz)\n2. [attachment: trac_11767c.patch](https://github.com/sagemath/sage/files/ticket11767/trac_11767c.patch.gz)\nto the Sage library.\n\n\nKeywords: **ecc2011**\n\nComponent: **elliptic curves**\n\nAuthor: **Paul Zimmermann**\n\nReviewer: **John Cremona, Leif Leonhardy, William Stein**\n\nMerged: **sage-4.7.2.alpha3**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/11767_\n\n",
    "closed_at": "2011-09-18T22:59:06Z",
    "created_at": "2011-08-31T21:51:01Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20elliptic%20curves",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-4.7.2",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "elliptic_logarithm of high precision points often hangs forever",
    "type": "issue",
    "updated_at": "2011-09-18T22:59:06Z",
    "url": "https://github.com/sagemath/sage/issues/11767",
    "user": "https://github.com/williamstein"
}
```
I am doing a project to compute Chow-Heegner points with Darmon, Rotger, et al., and am using Sage's `elliptic_logarithm` function with high precision points as input.  Unfortunately, it completely hangs on many input points over number fields.  Here is an example below, where computing to precision 500 works fine, but precision 600 hangs Sage forever:

```
sage: R.<x> = QQ[]
sage: K.<a> = NumberField(x^2 + x + 5)
sage: E = EllipticCurve(K, [0,0,1,-3,-5])
sage: P = E([0,a])
sage: L = P.curve().period_lattice(K.embeddings(ComplexField(600))[0])
sage: time L.elliptic_logarithm(P, prec=500)

-0.842248166487739393375018008381693990800588864069506187033873183845246233548058477561706400464057832396643843146464236956684557207157300006542470428494 - 0.571366031453267388121279381354098224265947866751130917440598461117775339240176310729173301979590106474259885638797913383502735083088736326391919063211*I
Time: CPU 0.08 s, Wall: 0.09 s
```

BUT:

```
sage: L.elliptic_logarithm(P, prec=600)
HANGS FOREVER
```

Hitting control-c and using the debugger suggests that the termination condition is impossible.  You end up in this line `if (r.abs()-1).abs() < eps: break` with actually having `(r.abs()-1).abs() == eps`, so the strict inequality isnt' satisfied, and maybe for some reason it can't be???

```

ipdb> l
   1357             r = C(((xP-e3)/(xP-e2)).sqrt())
   1358             if r.real()<0: r=-r
   1359             t = -C(wP)/(2*r*(xP-e2))
   1360             eps = R(1)>>(prec2);
   1361             while True:        
-> 1362                 s = b*r+a
   1363                 a, b = (a+b)/2, (a*b).sqrt()
   1364                 if (a+b).abs() < (a-b).abs():  b=-b
   1365                 r = (a*(r+1)/s).sqrt()
   1366                 if (r.abs()-1).abs() < eps: break
   1367                 if r.real()<0: r=-r

ipdb> print eps
5.80771375621750318328344999898952221581714435905885826948966319082059051450573607513973642929306226703333487164506974570166210185861027247933383445853709821724799129294394972880718063974478259360634645856449058721344643691320490207325897321618392592839150233975392885056947380044108965624364302537017698344822203678107744035231793749824965395444912652822986530e-362
ipdb> print r    
1.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ipdb> print (r.abs()-1).abs()
5.80771375621750318328344999898952221581714435905885826948966319082059051450573607513973642929306226703333487164506974570166210185861027247933383445853709821724799129294394972880718063974478259360634645856449058721344643691320490207325897321618392592839150233975392885056947380044108965624364302537017698344822203678107744035231793749824965395444912652822986530e-362
ipdb> print eps
5.80771375621750318328344999898952221581714435905885826948966319082059051450573607513973642929306226703333487164506974570166210185861027247933383445853709821724799129294394972880718063974478259360634645856449058721344643691320490207325897321618392592839150233975392885056947380044108965624364302537017698344822203678107744035231793749824965395444912652822986530e-362
ipdb> print (r.abs()-1).abs() < eps
False
ipdb> print (r.abs()-1).abs() <= eps
True
```

Changing `< eps` to `<= eps` in two spots in the relevant file seems to fix the problem for me.

---

Apply
1. [attachment: trac_11767b.patch](https://github.com/sagemath/sage/files/ticket11767/trac_11767b.patch.gz)
2. [attachment: trac_11767c.patch](https://github.com/sagemath/sage/files/ticket11767/trac_11767c.patch.gz)
to the Sage library.


Keywords: **ecc2011**

Component: **elliptic curves**

Author: **Paul Zimmermann**

Reviewer: **John Cremona, Leif Leonhardy, William Stein**

Merged: **sage-4.7.2.alpha3**

_Issue created by migration from https://trac.sagemath.org/ticket/11767_





---

archive/issue_events_158134.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2011-08-31T21:51:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "milestone_number": null,
    "milestone_title": "sage-4.7.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11767#event-158134"
}
```



---

archive/issue_events_158135.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2011-08-31T21:51:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20elliptic%20curves",
    "label_color": "0000ff",
    "label_name": "c: elliptic curves",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11767#event-158135"
}
```



---

archive/issue_events_158136.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2011-08-31T21:51:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11767#event-158136"
}
```



---

archive/issue_events_158137.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2011-08-31T21:51:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11767#event-158137"
}
```



---

archive/issue_events_158138.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2011-08-31T21:51:01Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "subject": "https://github.com/williamstein",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11767#event-158138"
}
```



---

archive/issue_comments_122628.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nIn case you provide a patch, you could also fix this:\n\n```\n        # embeddings uses only real arithmetic i nthe iteraion, and is\n```\n(And remove the superfluous semicolon from `eps = R(1)>>(prec2);` twice.)",
    "created_at": "2011-08-31T22:54:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122628",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:1" align="right">comment:1</div>

In case you provide a patch, you could also fix this:

```
        # embeddings uses only real arithmetic i nthe iteraion, and is
```
(And remove the superfluous semicolon from `eps = R(1)>>(prec2);` twice.)



---

archive/issue_comments_122629.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nI do not claim to understand the `<` versus `<=` issue, since I do not know the algorithm in question.  But I can attach a patch with this fix, which fixes the problem, has an example to illustrate that the problem is fixed, and fixes the typos leif mentions above.  Perhaps this will be easy for John Cremona to referee.",
    "created_at": "2011-09-01T04:01:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122629",
    "user": "https://github.com/williamstein"
}
```

<div id="comment:2" align="right">comment:2</div>

I do not claim to understand the `<` versus `<=` issue, since I do not know the algorithm in question.  But I can attach a patch with this fix, which fixes the problem, has an example to illustrate that the problem is fixed, and fixes the typos leif mentions above.  Perhaps this will be easy for John Cremona to referee.



---

archive/issue_events_158139.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2011-09-01T04:01:29Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11767#event-158139"
}
```



---

archive/issue_comments_122630.json:
```json
{
    "body": "Attachment: **[trac_11767.patch.gz](https://github.com/sagemath/sage/files/ticket11767/trac_11767.patch.gz)**",
    "created_at": "2011-09-01T04:02:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122630",
    "user": "https://github.com/williamstein"
}
```

Attachment: **[trac_11767.patch.gz](https://github.com/sagemath/sage/files/ticket11767/trac_11767.patch.gz)**



---

archive/issue_comments_122631.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nFWIW, using\n\n```python\n        R = RealField(prec2+1)\n        C = ComplexField(prec2+1)\n```\ninstead also works for (and seems a bit cleaner to) me, though of course a bit more expensive.\n\nJohn will certainly know better.",
    "created_at": "2011-09-01T04:42:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122631",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:3" align="right">comment:3</div>

FWIW, using

```python
        R = RealField(prec2+1)
        C = ComplexField(prec2+1)
```
instead also works for (and seems a bit cleaner to) me, though of course a bit more expensive.

John will certainly know better.



---

archive/issue_comments_122632.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nI cannot fix this now and maybe someone else should anyway, since my numerical analysis expertise is clearly lacking -- apologies.  The underlying algorithm here is very good indeed (double exponential) but the stopping condition needs to be handled properly.\n\nIn the function elliptic_logarithm, first of all the working precision is doubled (prec2 is 2*prec)!  Overkill perhaps but with this algorithm the number of correct digits doubles with each step anyway.  The stopping condition (line 1366) is that the relative error is < eps where eps is `2^-prec2`.  In the loop, a and b are sequences of complex numbers which converge to a common limit and we ant to stop when a/b is close to 1.  Similarly on line 1400 where a,b are real.\n\nI think that the right thing to do would be to replace eps by `2^-(prec2-1)` or something similar.  Also, replacing \"while True\" by something else so that infinite looping is impossible?\n\nI'm glad this function is useful, by the way -- there is no other software which can take complex elliptic logs!",
    "created_at": "2011-09-03T16:41:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122632",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:4" align="right">comment:4</div>

I cannot fix this now and maybe someone else should anyway, since my numerical analysis expertise is clearly lacking -- apologies.  The underlying algorithm here is very good indeed (double exponential) but the stopping condition needs to be handled properly.

In the function elliptic_logarithm, first of all the working precision is doubled (prec2 is 2*prec)!  Overkill perhaps but with this algorithm the number of correct digits doubles with each step anyway.  The stopping condition (line 1366) is that the relative error is < eps where eps is `2^-prec2`.  In the loop, a and b are sequences of complex numbers which converge to a common limit and we ant to stop when a/b is close to 1.  Similarly on line 1400 where a,b are real.

I think that the right thing to do would be to replace eps by `2^-(prec2-1)` or something similar.  Also, replacing "while True" by something else so that infinite looping is impossible?

I'm glad this function is useful, by the way -- there is no other software which can take complex elliptic logs!



---

archive/issue_comments_122633.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\n> I'm glad this function is useful, by the way -- there is no other \n> software which can take complex elliptic logs!\n\nThanks -- it's absolutely *critical* for my research right now!",
    "created_at": "2011-09-03T17:10:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122633",
    "user": "https://github.com/williamstein"
}
```

<div id="comment:5" align="right">comment:5</div>

> I'm glad this function is useful, by the way -- there is no other 
> software which can take complex elliptic logs!

Thanks -- it's absolutely *critical* for my research right now!



---

archive/issue_comments_122634.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nanother typo in that file:\n\n```\n...the the returned value z...\n```\nPaul",
    "created_at": "2011-09-14T12:59:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122634",
    "user": "https://github.com/zimmermann6"
}
```

<div id="comment:6" align="right">comment:6</div>

another typo in that file:

```
...the the returned value z...
```
Paul



---

archive/issue_comments_122635.json:
```json
{
    "body": "this patch should be applied after the previous one",
    "created_at": "2011-09-14T13:45:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122635",
    "user": "https://github.com/zimmermann6"
}
```

this patch should be applied after the previous one



---

archive/issue_comments_122636.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nAttachment: **[trac_11767a.patch.gz](https://github.com/sagemath/sage/files/ticket11767/trac_11767a.patch.gz)**\n\nI have added a 2nd patch (to be applied after the first one) which solves the typo, and\nmodifies the termination condition.\n\nAs far as I understand, the termination is when the (complex) variable `r` becomes 1.\nWe compute the complex norm of `r`, subtract one from it, and compare to `eps`\nwhich is `2^(-prec2)`.\n\nIf `r` is near one, typically `r.abs()` will be 1, or one of the floating-point numbers\nnear from 1, which are `1-2^(-prec2)` and `1+2^(1-prec2)`. The subtraction of 1 is exact,\nand the only case where the comparison `r.abs()-1 < eps` can be true is when `r=1`.\n\nWhat I've done is that I've changed the termination condition to also check whether the\nrelative difference `r.abs()-1` does not change from one step to the next one.\nSince `r.abs()-1` converges to one, this should catch cases where it stays at say\n`1-2^(-prec2)` due to rounding errors. However it will not catch cases where it oscillates\nbetween two different values near from 1.\n\nPaul",
    "created_at": "2011-09-14T13:55:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122636",
    "user": "https://github.com/zimmermann6"
}
```

<div id="comment:7" align="right">comment:7</div>

Attachment: **[trac_11767a.patch.gz](https://github.com/sagemath/sage/files/ticket11767/trac_11767a.patch.gz)**

I have added a 2nd patch (to be applied after the first one) which solves the typo, and
modifies the termination condition.

As far as I understand, the termination is when the (complex) variable `r` becomes 1.
We compute the complex norm of `r`, subtract one from it, and compare to `eps`
which is `2^(-prec2)`.

If `r` is near one, typically `r.abs()` will be 1, or one of the floating-point numbers
near from 1, which are `1-2^(-prec2)` and `1+2^(1-prec2)`. The subtraction of 1 is exact,
and the only case where the comparison `r.abs()-1 < eps` can be true is when `r=1`.

What I've done is that I've changed the termination condition to also check whether the
relative difference `r.abs()-1` does not change from one step to the next one.
Since `r.abs()-1` converges to one, this should catch cases where it stays at say
`1-2^(-prec2)` due to rounding errors. However it will not catch cases where it oscillates
between two different values near from 1.

Paul



---

archive/issue_comments_122637.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nPaul, thanks.  I trust your knowledge of binary floating point issues as being much better than my own.  Are you saying that even with your patch the termination condition may never hold and hence we loop forever?\n\nBearing in mind that I already doubled the precision (prec2 = 2*prec)  should we perhaps change `1-2^(-prec2)` to ` 1-2^(-prec2+1)`?  If that would mean that termination is then guaranteed?",
    "created_at": "2011-09-14T14:06:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122637",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:8" align="right">comment:8</div>

Paul, thanks.  I trust your knowledge of binary floating point issues as being much better than my own.  Are you saying that even with your patch the termination condition may never hold and hence we loop forever?

Bearing in mind that I already doubled the precision (prec2 = 2*prec)  should we perhaps change `1-2^(-prec2)` to ` 1-2^(-prec2+1)`?  If that would mean that termination is then guaranteed?



---

archive/issue_comments_122638.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nJohn, if you change `eps` to `2^(-prec2+1)` instead of `2^(-prec2)` then the case\nwhere `r = 1 - 2^(-prec2)` will also terminate with the < condition. But the case where\n`r = 1 + 2^(-prec2+1)` will still loop.\n\nIf the target precision is `prec` and you compute internally with `2*prec` bits, then\n`eps` could be `2^(-prec)`, no?\n\nPaul",
    "created_at": "2011-09-14T14:51:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122638",
    "user": "https://github.com/zimmermann6"
}
```

<div id="comment:9" align="right">comment:9</div>

John, if you change `eps` to `2^(-prec2+1)` instead of `2^(-prec2)` then the case
where `r = 1 - 2^(-prec2)` will also terminate with the < condition. But the case where
`r = 1 + 2^(-prec2+1)` will still loop.

If the target precision is `prec` and you compute internally with `2*prec` bits, then
`eps` could be `2^(-prec)`, no?

Paul



---

archive/issue_comments_122639.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@zimmermann6](#comment:9):\n> John, if you change `eps` to `2^(-prec2+1)` instead of `2^(-prec2)` then the case\n> where `r = 1 - 2^(-prec2)` will also terminate with the < condition. But the case where\n> `r = 1 + 2^(-prec2+1)` will still loop.\n\nWell, either `r.abs()` converges to one, or it doesn't. So if you compute with sufficiently high precision, especially not choosing epsilon to be the minimal positive value of the floating point type used, the termination condition will get true after some iterations.",
    "created_at": "2011-09-14T17:10:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122639",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@zimmermann6](#comment:9):
> John, if you change `eps` to `2^(-prec2+1)` instead of `2^(-prec2)` then the case
> where `r = 1 - 2^(-prec2)` will also terminate with the < condition. But the case where
> `r = 1 + 2^(-prec2+1)` will still loop.

Well, either `r.abs()` converges to one, or it doesn't. So if you compute with sufficiently high precision, especially not choosing epsilon to be the minimal positive value of the floating point type used, the termination condition will get true after some iterations.



---

archive/issue_comments_122640.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nok, after looking again, it seems that using `prec2 = 2*prec` is overkill.\nUsually, what we do in MPFR is that we use as internal precision prec + log2(prec) + a few bits.\nTo avoid computing a log(), I suggest using `prec2 = prec + 40` which should be large enough.\nWith this change, William's example with prec=600 runs ok. John, if you agree with that, I can\nmake a new patch.\n\nPaul",
    "created_at": "2011-09-15T06:23:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122640",
    "user": "https://github.com/zimmermann6"
}
```

<div id="comment:11" align="right">comment:11</div>

ok, after looking again, it seems that using `prec2 = 2*prec` is overkill.
Usually, what we do in MPFR is that we use as internal precision prec + log2(prec) + a few bits.
To avoid computing a log(), I suggest using `prec2 = prec + 40` which should be large enough.
With this change, William's example with prec=600 runs ok. John, if you agree with that, I can
make a new patch.

Paul



---

archive/issue_comments_122641.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@zimmermann6](#comment:11):\n> ok, after looking again, it seems that using `prec2 = 2*prec` is overkill.\n> Usually, what we do in MPFR is that we use as internal precision prec + log2(prec) + a few bits.\n> To avoid computing a log(), I suggest using `prec2 = prec + 40` which should be large enough.\n> With this change, William's example with prec=600 runs ok. John, if you agree with that, I can\n> make a new patch.\n> \n> Paul\n\nI agree, that is fine.  I put in 2*prec for testing and it worked (well, for several months!) and the algorithm was fast enough that I never bothered to work out a more sensible increase.\n\nAfter today (Thursday 15/9/11) I'll be away for 8 days so please don't wait for my approval to give the new patch a positive review assuming that the tests pass, including the new doctest with William's example.",
    "created_at": "2011-09-15T08:26:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122641",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@zimmermann6](#comment:11):
> ok, after looking again, it seems that using `prec2 = 2*prec` is overkill.
> Usually, what we do in MPFR is that we use as internal precision prec + log2(prec) + a few bits.
> To avoid computing a log(), I suggest using `prec2 = prec + 40` which should be large enough.
> With this change, William's example with prec=600 runs ok. John, if you agree with that, I can
> make a new patch.
> 
> Paul

I agree, that is fine.  I put in 2*prec for testing and it worked (well, for several months!) and the algorithm was fast enough that I never bothered to work out a more sensible increase.

After today (Thursday 15/9/11) I'll be away for 8 days so please don't wait for my approval to give the new patch a positive review assuming that the tests pass, including the new doctest with William's example.



---

archive/issue_comments_122642.json:
```json
{
    "body": "attach only that patch",
    "created_at": "2011-09-15T08:56:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122642",
    "user": "https://github.com/zimmermann6"
}
```

attach only that patch



---

archive/issue_comments_122643.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nAttachment: **[trac_11767b.patch.gz](https://github.com/sagemath/sage/files/ticket11767/trac_11767b.patch.gz)**\n\nJohn, thank you for your feedback. I've now uploaded a new patch `trac_11767b.patch` which\nshould be applied solely. William, please could you review that ticket?\n\nPaul",
    "created_at": "2011-09-15T08:58:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122643",
    "user": "https://github.com/zimmermann6"
}
```

<div id="comment:13" align="right">comment:13</div>

Attachment: **[trac_11767b.patch.gz](https://github.com/sagemath/sage/files/ticket11767/trac_11767b.patch.gz)**

John, thank you for your feedback. I've now uploaded a new patch `trac_11767b.patch` which
should be applied solely. William, please could you review that ticket?

Paul



---

archive/issue_comments_122644.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@zimmermann6](#comment:13):\n> John, thank you for your feedback. I've now uploaded a new patch `trac_11767b.patch` which\n> should be applied solely. William, please could you review that ticket?\n> \n> Paul\n\nThe patch looks fine to me though I have not tested it.  With a Positive Review the testbot will test it thoroughly anyway, but I think that at least one human who is not the author should test it too.",
    "created_at": "2011-09-15T09:23:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122644",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@zimmermann6](#comment:13):
> John, thank you for your feedback. I've now uploaded a new patch `trac_11767b.patch` which
> should be applied solely. William, please could you review that ticket?
> 
> Paul

The patch looks fine to me though I have not tested it.  With a Positive Review the testbot will test it thoroughly anyway, but I think that at least one human who is not the author should test it too.



---

archive/issue_comments_122645.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nWell, I think even I can review this. ;-)\n\nBy the way, I guess the double \"the\" should have read \"then the\", i.e., an \"n\" was missing rather than a word duplicated, but it's ok as is, too.\n\nSo I think we have a positive review.\n\nOf course William could again stress-test this, but at least there should no longer be endless loops, and the algorithm converges fast (with an *unmodified* termination condition, except that epsilon is now larger for high precision inputs), such that I don't expect very different or much less precise results w.r.t. the previous version either. Note that epsilon will now even be smaller for *lower* precision inputs.",
    "created_at": "2011-09-15T10:37:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122645",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:15" align="right">comment:15</div>

Well, I think even I can review this. ;-)

By the way, I guess the double "the" should have read "then the", i.e., an "n" was missing rather than a word duplicated, but it's ok as is, too.

So I think we have a positive review.

Of course William could again stress-test this, but at least there should no longer be endless loops, and the algorithm converges fast (with an *unmodified* termination condition, except that epsilon is now larger for high precision inputs), such that I don't expect very different or much less precise results w.r.t. the previous version either. Note that epsilon will now even be smaller for *lower* precision inputs.



---

archive/issue_comments_122646.json:
```json
{
    "body": "Reviewer: **John Cremona, Leif Leonhardy**",
    "created_at": "2011-09-15T10:37:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122646",
    "user": "https://github.com/nexttime"
}
```

Reviewer: **John Cremona, Leif Leonhardy**



---

archive/issue_comments_122647.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -50,4 +50,9 @@\n True\n ```\n \n-Changing `< eps` to `<= eps` in two spots in the relevant file seems to fix the problem for me. \n+Changing `< eps` to `<= eps` in two spots in the relevant file seems to fix the problem for me.\n+\n+---\n+\n+Apply only [attachment: trac_11767b.patch](https://github.com/sagemath/sage/files/ticket11767/trac_11767b.patch.gz) to the Sage library.\n+\n``````\n",
    "created_at": "2011-09-15T10:37:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122647",
    "user": "https://github.com/nexttime"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -50,4 +50,9 @@
 True
 ```
 
-Changing `< eps` to `<= eps` in two spots in the relevant file seems to fix the problem for me. 
+Changing `< eps` to `<= eps` in two spots in the relevant file seems to fix the problem for me.
+
+---
+
+Apply only [attachment: trac_11767b.patch](https://github.com/sagemath/sage/files/ticket11767/trac_11767b.patch.gz) to the Sage library.
+
``````




---

archive/issue_comments_122648.json:
```json
{
    "body": "Author: **Paul Zimmermann**",
    "created_at": "2011-09-15T10:37:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122648",
    "user": "https://github.com/nexttime"
}
```

Author: **Paul Zimmermann**



---

archive/issue_comments_122649.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nOh, the superfluous semicolons survived Paul's patch, but I don't mind.",
    "created_at": "2011-09-15T10:43:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122649",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:16" align="right">comment:16</div>

Oh, the superfluous semicolons survived Paul's patch, but I don't mind.



---

archive/issue_comments_122650.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nLeif,\n\n> So I think we have a positive review.\n\nyou didn't hit \"positive review\" thus you are waiting for William's review?\n\nNote that William's example seems to exercise only the case where `r` is real in the\ncode. Maybe one should check that there is at least one example where `r` is complex\nwith large precision, or add one if it is not the case.\n\nPaul",
    "created_at": "2011-09-15T11:13:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122650",
    "user": "https://github.com/zimmermann6"
}
```

<div id="comment:17" align="right">comment:17</div>

Leif,

> So I think we have a positive review.

you didn't hit "positive review" thus you are waiting for William's review?

Note that William's example seems to exercise only the case where `r` is real in the
code. Maybe one should check that there is at least one example where `r` is complex
with large precision, or add one if it is not the case.

Paul



---

archive/issue_comments_122651.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nReplying to [@zimmermann6](#comment:17):\n> Leif,\n> \n> > So I think we have a positive review.\n\n> \n> you didn't hit \"positive review\" thus you are waiting for William's review?\n\nYes, it's 4 am over there...",
    "created_at": "2011-09-15T11:19:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122651",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:18" align="right">comment:18</div>

Replying to [@zimmermann6](#comment:17):
> Leif,
> 
> > So I think we have a positive review.

> 
> you didn't hit "positive review" thus you are waiting for William's review?

Yes, it's 4 am over there...



---

archive/issue_comments_122652.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nReplying to [@zimmermann6](#comment:17):\n> Leif,\n> \n> > So I think we have a positive review.\n\n> \n> you didn't hit \"positive review\" thus you are waiting for William's review?\n> \n> Note that William's example seems to exercise only the case where `r` is real in the\n> code. Maybe one should check that there is at least one example where `r` is complex\n> with large precision, or add one if it is not the case.\n> \n\nThat is a *very* good observation.  The real case algorithm has been known for a very long time, but the complex case (using a generalised complex AGM) is still in preprint form!  I will come up with an example.\n\n\n> Paul",
    "created_at": "2011-09-15T11:29:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122652",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:19" align="right">comment:19</div>

Replying to [@zimmermann6](#comment:17):
> Leif,
> 
> > So I think we have a positive review.

> 
> you didn't hit "positive review" thus you are waiting for William's review?
> 
> Note that William's example seems to exercise only the case where `r` is real in the
> code. Maybe one should check that there is at least one example where `r` is complex
> with large precision, or add one if it is not the case.
> 

That is a *very* good observation.  The real case algorithm has been known for a very long time, but the complex case (using a generalised complex AGM) is still in preprint form!  I will come up with an example.


> Paul



---

archive/issue_comments_122653.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nTry this:\n\n```\nsage: K.<a> = QuadraticField(-5)\nsage: E = EllipticCurve([1,1,a,a,0])\nsage: P = E(0,0)\nsage: P.order()\n+Infinity\nsage: L = P.curve().period_lattice(K.embeddings(ComplexField())[0])\nsage: time L.elliptic_logarithm(P, prec=500)\n1.17058357737548897849026170185581196033579563441850967539191867385734983296504066660506637438866628981886518901958717288150400849746892393771983141354 - 1.13513899565966043682474529757126359416758251309237866586896869548539516543734207347695898664875799307727928332953834601460994992792519799260968053875*I\nTime: CPU 0.35 s, Wall: 0.36 s\nsage: L = P.curve().period_lattice(K.embeddings(ComplexField(1000))[0])\nsage: time L.elliptic_logarithm(P, prec=1000)\n```\nThe last line hangs with vanilla 4.7.1.  prec=900 is still OK.  Note that it is irrelevant to specify the precision when constructing the period lattice, since the only use made of the embedding at that stage is to determine which emebedding is required;  the elliptic log computation is where the floating point work is done.",
    "created_at": "2011-09-15T11:36:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122653",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:20" align="right">comment:20</div>

Try this:

```
sage: K.<a> = QuadraticField(-5)
sage: E = EllipticCurve([1,1,a,a,0])
sage: P = E(0,0)
sage: P.order()
+Infinity
sage: L = P.curve().period_lattice(K.embeddings(ComplexField())[0])
sage: time L.elliptic_logarithm(P, prec=500)
1.17058357737548897849026170185581196033579563441850967539191867385734983296504066660506637438866628981886518901958717288150400849746892393771983141354 - 1.13513899565966043682474529757126359416758251309237866586896869548539516543734207347695898664875799307727928332953834601460994992792519799260968053875*I
Time: CPU 0.35 s, Wall: 0.36 s
sage: L = P.curve().period_lattice(K.embeddings(ComplexField(1000))[0])
sage: time L.elliptic_logarithm(P, prec=1000)
```
The last line hangs with vanilla 4.7.1.  prec=900 is still OK.  Note that it is irrelevant to specify the precision when constructing the period lattice, since the only use made of the embedding at that stage is to determine which emebedding is required;  the elliptic log computation is where the floating point work is done.



---

archive/issue_comments_122654.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nReplying to [@JohnCremona](#comment:20):\n> Try this:\n\nBoth work for me with Paul's patch.",
    "created_at": "2011-09-15T11:43:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122654",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:21" align="right">comment:21</div>

Replying to [@JohnCremona](#comment:20):
> Try this:

Both work for me with Paul's patch.



---

archive/issue_comments_122655.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nReplying to [@nexttime](#comment:21):\n> Replying to [@JohnCremona](#comment:20):\n> > Try this:\n\n> \n> Both work for me with Paul's patch.\n\nThanks for testing.  Paul, could you add the new example to the tests?  You can use exactly the code I provided though the line\n\n```\nsage: L = P.curve().period_lattice(K.embeddings(ComplexField(1000))[0])\n```\ncan be omitted for the reasons I explained (the lattice only needs to be defined once, with no precision specified).",
    "created_at": "2011-09-15T12:35:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122655",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:22" align="right">comment:22</div>

Replying to [@nexttime](#comment:21):
> Replying to [@JohnCremona](#comment:20):
> > Try this:

> 
> Both work for me with Paul's patch.

Thanks for testing.  Paul, could you add the new example to the tests?  You can use exactly the code I provided though the line

```
sage: L = P.curve().period_lattice(K.embeddings(ComplexField(1000))[0])
```
can be omitted for the reasons I explained (the lattice only needs to be defined once, with no precision specified).



---

archive/issue_comments_122656.json:
```json
{
    "body": "Attachment: **[trac_11767c.patch.gz](https://github.com/sagemath/sage/files/ticket11767/trac_11767c.patch.gz)**\n\napply this patch after trac_11767b.patch",
    "created_at": "2011-09-15T13:11:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122656",
    "user": "https://github.com/zimmermann6"
}
```

Attachment: **[trac_11767c.patch.gz](https://github.com/sagemath/sage/files/ticket11767/trac_11767c.patch.gz)**

apply this patch after trac_11767b.patch



---

archive/issue_comments_122657.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -54,5 +54,6 @@\n \n ---\n \n-Apply only [attachment: trac_11767b.patch](https://github.com/sagemath/sage/files/ticket11767/trac_11767b.patch.gz) to the Sage library.\n+Apply only [attachment: trac_11767b.patch](https://github.com/sagemath/sage/files/ticket11767/trac_11767b.patch.gz) and\n+[attachment: trac_11767c.patch](https://github.com/sagemath/sage/files/ticket11767/trac_11767c.patch.gz) (in this order) to the Sage library.\n \n``````\n",
    "created_at": "2011-09-15T13:13:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122657",
    "user": "https://github.com/zimmermann6"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -54,5 +54,6 @@
 
 ---
 
-Apply only [attachment: trac_11767b.patch](https://github.com/sagemath/sage/files/ticket11767/trac_11767b.patch.gz) to the Sage library.
+Apply only [attachment: trac_11767b.patch](https://github.com/sagemath/sage/files/ticket11767/trac_11767b.patch.gz) and
+[attachment: trac_11767c.patch](https://github.com/sagemath/sage/files/ticket11767/trac_11767c.patch.gz) (in this order) to the Sage library.
 
``````




---

archive/issue_comments_122658.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nI knew I should not have opened my mouth... Attached is a second patch. Don't ask me to make a\nunified patch, I prefer to spend my time on other tickets.\n\nPaul",
    "created_at": "2011-09-15T13:13:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122658",
    "user": "https://github.com/zimmermann6"
}
```

<div id="comment:23" align="right">comment:23</div>

I knew I should not have opened my mouth... Attached is a second patch. Don't ask me to make a
unified patch, I prefer to spend my time on other tickets.

Paul



---

archive/issue_comments_122659.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nReplying to [@zimmermann6](#comment:23):\n> I knew I should not have opened my mouth... Attached is a second patch. Don't ask me to make a\n> unified patch, I prefer to spend my time on other tickets.\n> \n> Paul\n\nThank you!",
    "created_at": "2011-09-15T13:17:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122659",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:24" align="right">comment:24</div>

Replying to [@zimmermann6](#comment:23):
> I knew I should not have opened my mouth... Attached is a second patch. Don't ask me to make a
> unified patch, I prefer to spend my time on other tickets.
> 
> Paul

Thank you!



---

archive/issue_comments_122660.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nFWIW, 11767b+c also passes doctests here.\n\n\n\n\nP.S.:\n\nThere are various ways to make one patch out of two. E.g., take a fresh branch, import the first with `--no-commit`, and the second with `-f`(orce), then commit the cumulative changes. A diff is even easier, just compare the tip to the changeset two below the tip. (If you export two changesets at once, they will end up in one file, but effectively be two patches which are simply concatenated, but you can in turn re-import such a patch as one changeset into a fresh branch and re-export it as a true single patch.)",
    "created_at": "2011-09-15T13:52:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122660",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:25" align="right">comment:25</div>

FWIW, 11767b+c also passes doctests here.




P.S.:

There are various ways to make one patch out of two. E.g., take a fresh branch, import the first with `--no-commit`, and the second with `-f`(orce), then commit the cumulative changes. A diff is even easier, just compare the tip to the changeset two below the tip. (If you export two changesets at once, they will end up in one file, but effectively be two patches which are simply concatenated, but you can in turn re-import such a patch as one changeset into a fresh branch and re-export it as a true single patch.)



---

archive/issue_comments_122661.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -54,6 +54,8 @@\n \n ---\n \n-Apply only [attachment: trac_11767b.patch](https://github.com/sagemath/sage/files/ticket11767/trac_11767b.patch.gz) and\n-[attachment: trac_11767c.patch](https://github.com/sagemath/sage/files/ticket11767/trac_11767c.patch.gz) (in this order) to the Sage library.\n+Apply\n+1. [attachment: trac_11767b.patch](https://github.com/sagemath/sage/files/ticket11767/trac_11767b.patch.gz)\n+2. [attachment: trac_11767c.patch](https://github.com/sagemath/sage/files/ticket11767/trac_11767c.patch.gz)\n+to the Sage library.\n \n``````\n",
    "created_at": "2011-09-15T13:52:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122661",
    "user": "https://github.com/nexttime"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -54,6 +54,8 @@
 
 ---
 
-Apply only [attachment: trac_11767b.patch](https://github.com/sagemath/sage/files/ticket11767/trac_11767b.patch.gz) and
-[attachment: trac_11767c.patch](https://github.com/sagemath/sage/files/ticket11767/trac_11767c.patch.gz) (in this order) to the Sage library.
+Apply
+1. [attachment: trac_11767b.patch](https://github.com/sagemath/sage/files/ticket11767/trac_11767b.patch.gz)
+2. [attachment: trac_11767c.patch](https://github.com/sagemath/sage/files/ticket11767/trac_11767c.patch.gz)
+to the Sage library.
 
``````




---

archive/issue_comments_122662.json:
```json
{
    "body": "Changed keywords from none to **ecc2011**",
    "created_at": "2011-09-16T12:28:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122662",
    "user": "https://github.com/zimmermann6"
}
```

Changed keywords from none to **ecc2011**



---

archive/issue_comments_122663.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nCan someone (William?) give this a final positive review?\n\nIf this happens within a few hours, I can still merge it into Sage 4.7.2.alpha3.",
    "created_at": "2011-09-18T05:16:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122663",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:27" align="right">comment:27</div>

Can someone (William?) give this a final positive review?

If this happens within a few hours, I can still merge it into Sage 4.7.2.alpha3.



---

archive/issue_events_158140.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2011-09-18T14:56:46Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11767#event-158140"
}
```



---

archive/issue_events_158141.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2011-09-18T14:56:46Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11767#event-158141"
}
```



---

archive/issue_comments_122664.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nfinal positive review.",
    "created_at": "2011-09-18T14:56:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122664",
    "user": "https://github.com/williamstein"
}
```

<div id="comment:28" align="right">comment:28</div>

final positive review.



---

archive/issue_comments_122665.json:
```json
{
    "body": "Changed reviewer from **John Cremona, Leif Leonhardy** to **John Cremona, Leif Leonhardy, William Stein**",
    "created_at": "2011-09-18T15:06:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122665",
    "user": "https://github.com/nexttime"
}
```

Changed reviewer from **John Cremona, Leif Leonhardy** to **John Cremona, Leif Leonhardy, William Stein**



---

archive/issue_events_158142.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2011-09-18T22:59:06Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11767#event-158142"
}
```



---

archive/issue_events_158143.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2011-09-18T22:59:06Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11767#event-158143"
}
```



---

archive/issue_comments_122666.json:
```json
{
    "body": "Merged: **sage-4.7.2.alpha3**",
    "created_at": "2011-09-18T22:59:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11767#issuecomment-122666",
    "user": "https://github.com/nexttime"
}
```

Merged: **sage-4.7.2.alpha3**
