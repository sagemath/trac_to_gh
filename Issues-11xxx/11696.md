# Issue 11696: The libpng12 spkg should also create symbolic links from `libpng.*` for its libraries

archive/issues_011524.json:
```json
{
    "body": "Doing so avoids trouble if `pkg-config` isn't available, and packages look for just `libpng`.\n\nThe header `png.h` is already installed in `$SAGE_LOCAL/include/`, and a symbolic link from `$SAGE_LOCAL/lib/pkgconfig/libpng.pc` to the actual `libpng12.pc` is also created.\n\n---\n\nActually the links (and a compatibility `libpng` shared library) **are** created by upstream, but `spkg-install` deleted these.\n\n---\n\nUse spkg at:\nhttp://boxen.math.washington.edu/home/jpflori/libpng-1.2.35.p5.spkg\n\n---\n\nOriginal changes:\n### libpng-1.2.35.p4 (Leif Leonhardy, August 17th 2011)\n* #11696: Do *not* delete symbolic links from `libpng.*` (and the shared\n  library named `libpng.so.*`) in `$SAGE_LOCAL/lib`; see the comment in\n  `spkg-install` for why (cf. also #11686).\n* Add `-L$SAGE_LOCAL/lib` to `LDFLAGS`, since otherwise Sage's zlib won't\n  be used.\n* Fix order of additions to flags, and don't drop user's settings. (Some\n  might still intentionally get overridden though.)\n* Use `$MAKE`, but also install serially since this shouldn't take much\n  time and is certainly safer.\n* Quote also `$UNAME`.\n\nFurther changes:\n* Let libpng build a correct import on Cygwin using the SYMBOL_PREFIX trick, seehttp://old.nabble.com/Fwd%3A---libpng-Bugs-2981656---Import-library-definitions-missing-in-Windows-td28130513.html.\n* Further cleanups.\n\nAssignee: @nexttime\n\nCC:  @jdemeyer @jhpalmieri @kcrisman @dimpase\n\nKeywords: PNG libpng spkg\n\nReviewer: Dmitrii Pasechnik\n\nAuthor: Leif Leonhardy, Jean-Pierre Flori\n\nMerged: sage-5.8.beta1\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/11696\n\n",
    "closed_at": "2013-02-22T19:10:31Z",
    "created_at": "2011-08-17T13:58:08Z",
    "labels": [
        "component: packages: standard",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.8",
    "title": "The libpng12 spkg should also create symbolic links from `libpng.*` for its libraries",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11696",
    "user": "https://github.com/nexttime"
}
```
Doing so avoids trouble if `pkg-config` isn't available, and packages look for just `libpng`.

The header `png.h` is already installed in `$SAGE_LOCAL/include/`, and a symbolic link from `$SAGE_LOCAL/lib/pkgconfig/libpng.pc` to the actual `libpng12.pc` is also created.

---

Actually the links (and a compatibility `libpng` shared library) **are** created by upstream, but `spkg-install` deleted these.

---

Use spkg at:
http://boxen.math.washington.edu/home/jpflori/libpng-1.2.35.p5.spkg

---

Original changes:
### libpng-1.2.35.p4 (Leif Leonhardy, August 17th 2011)
* #11696: Do *not* delete symbolic links from `libpng.*` (and the shared
  library named `libpng.so.*`) in `$SAGE_LOCAL/lib`; see the comment in
  `spkg-install` for why (cf. also #11686).
* Add `-L$SAGE_LOCAL/lib` to `LDFLAGS`, since otherwise Sage's zlib won't
  be used.
* Fix order of additions to flags, and don't drop user's settings. (Some
  might still intentionally get overridden though.)
* Use `$MAKE`, but also install serially since this shouldn't take much
  time and is certainly safer.
* Quote also `$UNAME`.

Further changes:
* Let libpng build a correct import on Cygwin using the SYMBOL_PREFIX trick, seehttp://old.nabble.com/Fwd%3A---libpng-Bugs-2981656---Import-library-definitions-missing-in-Windows-td28130513.html.
* Further cleanups.

Assignee: @nexttime

CC:  @jdemeyer @jhpalmieri @kcrisman @dimpase

Keywords: PNG libpng spkg

Reviewer: Dmitrii Pasechnik

Author: Leif Leonhardy, Jean-Pierre Flori

Merged: sage-5.8.beta1

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/11696





---

archive/issue_comments_136266.json:
```json
{
    "body": "<a id='comment:1'></a>New spkg is up.\n\nNeeds review and testing, the latter especially on Darwin.\n\n(Though I see no reason for doing so, we could still delete some of the links / the compatibility shared library on Darwin only.)",
    "created_at": "2011-08-17T15:43:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136266",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:1'></a>New spkg is up.

Needs review and testing, the latter especially on Darwin.

(Though I see no reason for doing so, we could still delete some of the links / the compatibility shared library on Darwin only.)



---

archive/issue_comments_136267.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -2,7 +2,29 @@\n \n The header `png.h` is already installed in `$SAGE_LOCAL/include/`, and a symbolic link from `$SAGE_LOCAL/lib/pkgconfig/libpng.pc` to the actual `libpng12.pc` is also created.\n \n-Assignee: tbd\n+---\n+\n+Actually the links (and a compatibility `libpng` shared library) **are** created by upstream, but `spkg-install` deleted these.\n+\n+---\n+\n+**New spkg: http://spkg-upload.googlecode.com/files/libpng-1.2.35.p4.spkg**\n+\n+**md5sum:** `3789f82616a101eb1b00f339509f9616  libpng-1.2.35.p4.spkg`\n+\n+\n+### libpng-1.2.35.p4 (Leif Leonhardy, August 17th 2011)\n+* #11696: Do *not* delete symbolic links from `libpng.*` (and the shared\n+  library named `libpng.so.*`) in `$SAGE_LOCAL/lib`; see the comment in\n+  `spkg-install` for why (cf. also #11686).\n+* Add `-L$SAGE_LOCAL/lib` to `LDFLAGS`, since otherwise Sage's zlib won't\n+  be used.\n+* Fix order of additions to flags, and don't drop user's settings. (Some\n+  might still intentionally get overridden though.)\n+* Use `$MAKE`, but also install serially since this shouldn't take much\n+  time and is certainly safer.\n+* Quote also `$UNAME`.\n+\n \n Comment: 1\n \n``````\n",
    "created_at": "2011-08-17T15:43:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136267",
    "user": "https://github.com/nexttime"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -2,7 +2,29 @@
 
 The header `png.h` is already installed in `$SAGE_LOCAL/include/`, and a symbolic link from `$SAGE_LOCAL/lib/pkgconfig/libpng.pc` to the actual `libpng12.pc` is also created.
 
-Assignee: tbd
+---
+
+Actually the links (and a compatibility `libpng` shared library) **are** created by upstream, but `spkg-install` deleted these.
+
+---
+
+**New spkg: http://spkg-upload.googlecode.com/files/libpng-1.2.35.p4.spkg**
+
+**md5sum:** `3789f82616a101eb1b00f339509f9616  libpng-1.2.35.p4.spkg`
+
+
+### libpng-1.2.35.p4 (Leif Leonhardy, August 17th 2011)
+* #11696: Do *not* delete symbolic links from `libpng.*` (and the shared
+  library named `libpng.so.*`) in `$SAGE_LOCAL/lib`; see the comment in
+  `spkg-install` for why (cf. also #11686).
+* Add `-L$SAGE_LOCAL/lib` to `LDFLAGS`, since otherwise Sage's zlib won't
+  be used.
+* Fix order of additions to flags, and don't drop user's settings. (Some
+  might still intentionally get overridden though.)
+* Use `$MAKE`, but also install serially since this shouldn't take much
+  time and is certainly safer.
+* Quote also `$UNAME`.
+
 
 Comment: 1
 
``````




---

archive/issue_comments_136268.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-08-17T15:43:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136268",
    "user": "https://github.com/nexttime"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_136269.json:
```json
{
    "body": "Changing assignee from tbd to @nexttime.",
    "created_at": "2011-08-17T16:53:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136269",
    "user": "https://github.com/nexttime"
}
```

Changing assignee from tbd to @nexttime.



---

archive/issue_comments_136270.json:
```json
{
    "body": "<a id='comment:2'></a>P.S.:\n\nThis is just another instance of where it IMHO doesn't make sense to build a Sage version if the system already provides some sufficient one, since doing so only causes trouble.\n\nThe best way would be to make such rather basic, unmodified packages just prerequisites; perhaps also supplying some easy way to build/install them on older systems (i.e., a tarball with some additional install script using reasonable settings). Shipping \"standard\" spkgs like e.g. also `iconv`, Fortran or Cephes just blows up the Sage tarball and increases the build time due to useless dependencies.\n\nIf we keep building such broadly available packages regardless of whether they're already installed system-wide (like also readline, PPL, GMP/MPIR, MPFR etc.), we should make sure they only get used by Sage components, by \"moving them out of `LD_LIBRARY_PATH`\" and using (a relative!) `RPATH` / `RUNPATH` in the parts of Sage that use these libraries.",
    "created_at": "2011-08-17T16:53:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136270",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:2'></a>P.S.:

This is just another instance of where it IMHO doesn't make sense to build a Sage version if the system already provides some sufficient one, since doing so only causes trouble.

The best way would be to make such rather basic, unmodified packages just prerequisites; perhaps also supplying some easy way to build/install them on older systems (i.e., a tarball with some additional install script using reasonable settings). Shipping "standard" spkgs like e.g. also `iconv`, Fortran or Cephes just blows up the Sage tarball and increases the build time due to useless dependencies.

If we keep building such broadly available packages regardless of whether they're already installed system-wide (like also readline, PPL, GMP/MPIR, MPFR etc.), we should make sure they only get used by Sage components, by "moving them out of `LD_LIBRARY_PATH`" and using (a relative!) `RPATH` / `RUNPATH` in the parts of Sage that use these libraries.



---

archive/issue_comments_136271.json:
```json
{
    "body": "<a id='comment:3'></a>Notes (from #11686):\n\n- test on OS X (recent)\n- test on older versions of OS X\n- test on skynet machine iras\n\nFor testing on iras, apply the spkg here, and then try building [this matplotlib spkg](http://sage.math.washington.edu/home/palmieri/SPKG/matplotlib-1.0.1.X.spkg).  (The standard matplotlib spkg patches the file `setupext.py` to accommodate the lack of `pkg-config` on some systems, especially OS X.  This modified spkg eliminates that patch.)",
    "created_at": "2011-08-17T18:14:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136271",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:3'></a>Notes (from #11686):

- test on OS X (recent)
- test on older versions of OS X
- test on skynet machine iras

For testing on iras, apply the spkg here, and then try building [this matplotlib spkg](http://sage.math.washington.edu/home/palmieri/SPKG/matplotlib-1.0.1.X.spkg).  (The standard matplotlib spkg patches the file `setupext.py` to accommodate the lack of `pkg-config` on some systems, especially OS X.  This modified spkg eliminates that patch.)



---

archive/issue_comments_136272.json:
```json
{
    "body": "<a id='comment:4'></a>On both an OS X box (OS version 10.6.8) and on iras: before installing the libpng spkg here, both systems failed to build the modified matplotlib spkg referred to in the previous comment.  After installing the new libpng, both successfully built it.  All doctests passed for the \"plot\" directory, and this worked:\n\n```\nsage: P = plot(sin(x))\nsage: P.save('x.png')\n```\nAfter exiting Sage: \n\n```\n$ file x.png \nx.png: PNG image data, 484 x 316, 8-bit/color RGBA, non-interlaced\n```\nFrom the code, it looks like `P.save('x.png')` should call matplotlib, and so if libpng is broken or if matplotlib can't find it, I think this should fail.  So things look good so far.  Any other suggestions for testing this?\n\nThe package still needs testing on other systems, and we should run full doctests as well, not just for the 'plot' directory.",
    "created_at": "2011-08-17T18:42:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136272",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:4'></a>On both an OS X box (OS version 10.6.8) and on iras: before installing the libpng spkg here, both systems failed to build the modified matplotlib spkg referred to in the previous comment.  After installing the new libpng, both successfully built it.  All doctests passed for the "plot" directory, and this worked:

```
sage: P = plot(sin(x))
sage: P.save('x.png')
```
After exiting Sage: 

```
$ file x.png 
x.png: PNG image data, 484 x 316, 8-bit/color RGBA, non-interlaced
```
From the code, it looks like `P.save('x.png')` should call matplotlib, and so if libpng is broken or if matplotlib can't find it, I think this should fail.  So things look good so far.  Any other suggestions for testing this?

The package still needs testing on other systems, and we should run full doctests as well, not just for the 'plot' directory.



---

archive/issue_comments_136273.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:4 jhpalmieri]:\n> Any other suggestions for testing this? \n\n\n> \n> The package still needs testing on other systems, and we should run full doctests as well, not just for the 'plot' directory.\n\n\nPerhaps also on some MacOS X 10.4 box, and also in general by building Sage from scratch with the new libpng spkg.\n\nThe only issues I can imagine to arise happen if you try to start some program dynamically linked to an incompatible (presumably very old) system `libpng` library *from within the Sage environment*.\n\nI don't know if there are any use cases of the latter we would have to take care of.\n\n\n\n\nAnother problem we would notice when building Sage from scratch could be *some* \"tight\" components (shared libraries / extension modules), not using `pkg-config` in their build, actually linking to the shared `libpng.so.3*` library, such that we might end up with a Sage binary pulling in *both* libraries, which could then again lead to name clashes, e.g. on Darwin.\n\nThe latter should IMHO never happen (at least not with properly written packages) since `$SAGE_ROOT/local/lib/libpng.so` is a symbolic link to `$SAGE_ROOT/local/lib/libpng12.so`, not `$SAGE_ROOT/local/lib/libpng.so.3.35.0`.",
    "created_at": "2011-08-17T19:26:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136273",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:5'></a>Replying to [comment:4 jhpalmieri]:
> Any other suggestions for testing this? 


> 
> The package still needs testing on other systems, and we should run full doctests as well, not just for the 'plot' directory.


Perhaps also on some MacOS X 10.4 box, and also in general by building Sage from scratch with the new libpng spkg.

The only issues I can imagine to arise happen if you try to start some program dynamically linked to an incompatible (presumably very old) system `libpng` library *from within the Sage environment*.

I don't know if there are any use cases of the latter we would have to take care of.




Another problem we would notice when building Sage from scratch could be *some* "tight" components (shared libraries / extension modules), not using `pkg-config` in their build, actually linking to the shared `libpng.so.3*` library, such that we might end up with a Sage binary pulling in *both* libraries, which could then again lead to name clashes, e.g. on Darwin.

The latter should IMHO never happen (at least not with properly written packages) since `$SAGE_ROOT/local/lib/libpng.so` is a symbolic link to `$SAGE_ROOT/local/lib/libpng12.so`, not `$SAGE_ROOT/local/lib/libpng.so.3.35.0`.



---

archive/issue_comments_136274.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-08-17T21:15:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136274",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_136275.json:
```json
{
    "body": "<a id='comment:6'></a>A full build works successfully on sage.math and another unix box on skynet (taurus).  I'm still waiting on the skynet machines fulvia (OpenSolaris), mark (Solaris), and iras (\"ia64-Linux-suse\").\n\nMeanwhile, this fails on OS X 10.6.8.  That is, while the spkg builds, it causes R to fail to install.  I've put the full install log [on-line](http://sage.math.washington.edu/home/palmieri/misc/r-2.10.1.p4.log), but here is the tail end of the log:\n\n```\nbuilding package 'graphics'\nmkdir ../../../library/graphics\nmake[4]: warning: -jN forced in submake: disabling jobserver mode.\nmkdir ../../../library/graphics/R\nmkdir ../../../library/graphics/po\nmake[4]: warning: -jN forced in submake: disabling jobserver mode.\nError in dyn.load(file, DLLpath = DLLpath, ...) : \n  unable to load shared library '/Applications/sage_builds/sage-4.7.1.rc2/spkg/build/r-2.10.1.p4/src/library/grDevices/libs/grDevices.so':\n  dlopen(/Applications/sage_builds/sage-4.7.1.rc2/spkg/build/r-2.10.1.p4/src/library/grDevices/libs/grDevices.so, 6): Symbol not found: __cg_png_create_info_struct\n  Referenced from: /System/Library/Frameworks/ApplicationServices.framework/Versions/A/Frameworks/ImageIO.framework/Versions/A/ImageIO\n  Expected in: /Applications/sage_builds/sage-4.7.1.rc2/local/lib//libPng.dylib\n in /System/Library/Frameworks/ApplicationServices.framework/Versions/A/Frameworks/ImageIO.framework/Versions/A/ImageIO\nCalls: <Anonymous> ... namespaceImport -> loadNamespace -> library.dynam -> dyn.load\nExecution halted\nmake[4]: *** [mklazy] Error 1\nmake[3]: *** [all] Error 2\nmake[2]: *** [R] Error 1\nmake[1]: *** [R] Error 1\nmake: *** [R] Error 1\nError building R.\n```\n\nOn one OS X box, the following line from the R install log switched from \"no\" to \"yes\" after installing the new libpng spkg:\n\n```\nchecking for png_create_write_struct in -lpng... yes\n```\nOn another box, it said \"yes\" for the old spkg as well.  For both machines, I get the same failure.",
    "created_at": "2011-08-17T21:15:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136275",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:6'></a>A full build works successfully on sage.math and another unix box on skynet (taurus).  I'm still waiting on the skynet machines fulvia (OpenSolaris), mark (Solaris), and iras ("ia64-Linux-suse").

Meanwhile, this fails on OS X 10.6.8.  That is, while the spkg builds, it causes R to fail to install.  I've put the full install log [on-line](http://sage.math.washington.edu/home/palmieri/misc/r-2.10.1.p4.log), but here is the tail end of the log:

```
building package 'graphics'
mkdir ../../../library/graphics
make[4]: warning: -jN forced in submake: disabling jobserver mode.
mkdir ../../../library/graphics/R
mkdir ../../../library/graphics/po
make[4]: warning: -jN forced in submake: disabling jobserver mode.
Error in dyn.load(file, DLLpath = DLLpath, ...) : 
  unable to load shared library '/Applications/sage_builds/sage-4.7.1.rc2/spkg/build/r-2.10.1.p4/src/library/grDevices/libs/grDevices.so':
  dlopen(/Applications/sage_builds/sage-4.7.1.rc2/spkg/build/r-2.10.1.p4/src/library/grDevices/libs/grDevices.so, 6): Symbol not found: __cg_png_create_info_struct
  Referenced from: /System/Library/Frameworks/ApplicationServices.framework/Versions/A/Frameworks/ImageIO.framework/Versions/A/ImageIO
  Expected in: /Applications/sage_builds/sage-4.7.1.rc2/local/lib//libPng.dylib
 in /System/Library/Frameworks/ApplicationServices.framework/Versions/A/Frameworks/ImageIO.framework/Versions/A/ImageIO
Calls: <Anonymous> ... namespaceImport -> loadNamespace -> library.dynam -> dyn.load
Execution halted
make[4]: *** [mklazy] Error 1
make[3]: *** [all] Error 2
make[2]: *** [R] Error 1
make[1]: *** [R] Error 1
make: *** [R] Error 1
Error building R.
```

On one OS X box, the following line from the R install log switched from "no" to "yes" after installing the new libpng spkg:

```
checking for png_create_write_struct in -lpng... yes
```
On another box, it said "yes" for the old spkg as well.  For both machines, I get the same failure.



---

archive/issue_comments_136276.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:6 jhpalmieri]:\n> Meanwhile, this fails on OS X 10.6.8.  That is, while the spkg builds, it causes R to fail to install.  I've put the full install log [on-line](http://sage.math.washington.edu/home/palmieri/misc/r-2.10.1.p4.log) ...\n\n\nYes, another system library R links to uses `libpng`, and that apparently expects other (or additional) symbols to be present, which aren't in the official (Sage's) one.\n\nIf only MacOS used proper shared library versioning...\n\n\nCan you also give the output of\n\n```sh\n$ ls -l $SAGE_ROOT/local/lib/lib[Pp]ng*\n```\n?",
    "created_at": "2011-08-17T21:36:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136276",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:7'></a>Replying to [comment:6 jhpalmieri]:
> Meanwhile, this fails on OS X 10.6.8.  That is, while the spkg builds, it causes R to fail to install.  I've put the full install log [on-line](http://sage.math.washington.edu/home/palmieri/misc/r-2.10.1.p4.log) ...


Yes, another system library R links to uses `libpng`, and that apparently expects other (or additional) symbols to be present, which aren't in the official (Sage's) one.

If only MacOS used proper shared library versioning...


Can you also give the output of

```sh
$ ls -l $SAGE_ROOT/local/lib/lib[Pp]ng*
```
?



---

archive/issue_comments_136277.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:7 leif]:\n> Can you also give the output of\n\n{{{#!sh\n$ ls -l $SAGE_ROOT/local/lib/lib[Pp]ng*\n}}}\n> ?\n\n\nWith the old libpng:\n\n```\n-rwxr-xr-x  1 palmieri  admin  253536 Aug 16 15:27 sage-4.7.1/local/lib/libpng12.0.dylib*\n-rw-r--r--  1 palmieri  admin  605960 Aug 16 18:49 sage-4.7.1/local/lib/libpng12.a\nlrwxr-xr-x  1 palmieri  admin      16 Aug 16 21:32 sage-4.7.1/local/lib/libpng12.dylib@ -> libpng12.0.dylib\n-rwxr-xr-x  1 palmieri  admin     981 Aug 16 18:49 sage-4.7.1/local/lib/libpng12.la*\n```\n\nWith the new one:\n\n```\n-rwxr-xr-x  1 palmieri  admin  256112 Aug 17 13:52 sage-4.7.1.rc2/local/lib/libpng.3.dylib*\nlrwxr-xr-x  1 palmieri  admin      10 Aug 17 13:52 sage-4.7.1.rc2/local/lib/libpng.a@ -> libpng12.a\nlrwxr-xr-x  1 palmieri  admin      14 Aug 17 13:52 sage-4.7.1.rc2/local/lib/libpng.dylib@ -> libpng12.dylib\nlrwxr-xr-x  1 palmieri  admin      11 Aug 17 13:52 sage-4.7.1.rc2/local/lib/libpng.la@ -> libpng12.la\n-rwxr-xr-x  1 palmieri  admin  253504 Aug 17 13:52 sage-4.7.1.rc2/local/lib/libpng12.0.dylib*\n-rw-r--r--  1 palmieri  admin  605864 Aug 17 13:52 sage-4.7.1.rc2/local/lib/libpng12.a\nlrwxr-xr-x  1 palmieri  admin      16 Aug 17 13:52 sage-4.7.1.rc2/local/lib/libpng12.dylib@ -> libpng12.0.dylib\n-rwxr-xr-x  1 palmieri  admin    1032 Aug 17 13:52 sage-4.7.1.rc2/local/lib/libpng12.la*\n```",
    "created_at": "2011-08-17T22:07:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136277",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:8'></a>Replying to [comment:7 leif]:
> Can you also give the output of

{{{#!sh
$ ls -l $SAGE_ROOT/local/lib/lib[Pp]ng*
}}}
> ?


With the old libpng:

```
-rwxr-xr-x  1 palmieri  admin  253536 Aug 16 15:27 sage-4.7.1/local/lib/libpng12.0.dylib*
-rw-r--r--  1 palmieri  admin  605960 Aug 16 18:49 sage-4.7.1/local/lib/libpng12.a
lrwxr-xr-x  1 palmieri  admin      16 Aug 16 21:32 sage-4.7.1/local/lib/libpng12.dylib@ -> libpng12.0.dylib
-rwxr-xr-x  1 palmieri  admin     981 Aug 16 18:49 sage-4.7.1/local/lib/libpng12.la*
```

With the new one:

```
-rwxr-xr-x  1 palmieri  admin  256112 Aug 17 13:52 sage-4.7.1.rc2/local/lib/libpng.3.dylib*
lrwxr-xr-x  1 palmieri  admin      10 Aug 17 13:52 sage-4.7.1.rc2/local/lib/libpng.a@ -> libpng12.a
lrwxr-xr-x  1 palmieri  admin      14 Aug 17 13:52 sage-4.7.1.rc2/local/lib/libpng.dylib@ -> libpng12.dylib
lrwxr-xr-x  1 palmieri  admin      11 Aug 17 13:52 sage-4.7.1.rc2/local/lib/libpng.la@ -> libpng12.la
-rwxr-xr-x  1 palmieri  admin  253504 Aug 17 13:52 sage-4.7.1.rc2/local/lib/libpng12.0.dylib*
-rw-r--r--  1 palmieri  admin  605864 Aug 17 13:52 sage-4.7.1.rc2/local/lib/libpng12.a
lrwxr-xr-x  1 palmieri  admin      16 Aug 17 13:52 sage-4.7.1.rc2/local/lib/libpng12.dylib@ -> libpng12.0.dylib
-rwxr-xr-x  1 palmieri  admin    1032 Aug 17 13:52 sage-4.7.1.rc2/local/lib/libpng12.la*
```



---

archive/issue_comments_136278.json:
```json
{
    "body": "<a id='comment:9'></a>Ok, removing `$SAGE_ROOT/local/lib/libpng.dylib` should be sufficient to make R install, though then keeping `$SAGE_ROOT/local/lib/libpng.3.dylib` doesn't make much sense either. (Just wondering why the mtimes of the libraries of 4.7.1 differ that much.)\n\nI'll update the spkg accordingly later.\n\n\nNote to myself: Also support `CFLAG64`.",
    "created_at": "2011-08-17T23:56:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136278",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:9'></a>Ok, removing `$SAGE_ROOT/local/lib/libpng.dylib` should be sufficient to make R install, though then keeping `$SAGE_ROOT/local/lib/libpng.3.dylib` doesn't make much sense either. (Just wondering why the mtimes of the libraries of 4.7.1 differ that much.)

I'll update the spkg accordingly later.


Note to myself: Also support `CFLAG64`.



---

archive/issue_comments_136279.json:
```json
{
    "body": "<a id='comment:10'></a>For the old libpng spkg, as part of a fresh Sage build:\n\n```\n  -rwxr-xr-x    1 palmieri  admin    253536 Aug 16 15:27 libpng12.0.dylib\n  -rw-r--r--    1 palmieri  admin    605960 Aug 16 18:49 libpng12.a\n  lrwxr-xr-x    1 palmieri  admin        16 Aug 16 15:27 libpng12.dylib -> libpng12.0.dylib\n  -rwxr-xr-x    1 palmieri  admin       981 Aug 16 18:49 libpng12.la\n```\nThe later times are the same for all of the .a and .la files in SAGE_LOCAL/lib, which is the time when docbuilding finished and doctesting started (as part of \"make ptestlong\").  For the earlier example I posted, all of the symlinks `blah.dylib` have the same modification date, and I don't know what it corresponds to.  The last time I ran that copy of Sage?  The last time I installed an spkg in that copy of Sage?\n\nFor the new spkg, since the Sage build crashed, it didn't reach any of these stages.",
    "created_at": "2011-08-18T01:24:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136279",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:10'></a>For the old libpng spkg, as part of a fresh Sage build:

```
  -rwxr-xr-x    1 palmieri  admin    253536 Aug 16 15:27 libpng12.0.dylib
  -rw-r--r--    1 palmieri  admin    605960 Aug 16 18:49 libpng12.a
  lrwxr-xr-x    1 palmieri  admin        16 Aug 16 15:27 libpng12.dylib -> libpng12.0.dylib
  -rwxr-xr-x    1 palmieri  admin       981 Aug 16 18:49 libpng12.la
```
The later times are the same for all of the .a and .la files in SAGE_LOCAL/lib, which is the time when docbuilding finished and doctesting started (as part of "make ptestlong").  For the earlier example I posted, all of the symlinks `blah.dylib` have the same modification date, and I don't know what it corresponds to.  The last time I ran that copy of Sage?  The last time I installed an spkg in that copy of Sage?

For the new spkg, since the Sage build crashed, it didn't reach any of these stages.



---

archive/issue_comments_136280.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:9 leif]:\n> Ok, removing `$SAGE_ROOT/local/lib/libpng.dylib` should be sufficient to make R install, though then keeping `$SAGE_ROOT/local/lib/libpng.3.dylib` doesn't make much sense either. (Just wondering why the mtimes of the libraries of 4.7.1 differ that much.)\n> \n> I'll update the spkg accordingly later.\n\n\nOoops, completely forgot this ticket.\n\nDeleting the symbolic link `libpng.dylib -> libpng12.dylib` can also cause trouble, namely if `pkg-config` **is** installed on Darwin, we still have a broken / messed-up `libpng12.pc` file (containing `SAGE_ROOT=${SAGE_ROOT}`), and there's **no** system-wide `libpng.dylib` installed.\n\nJohan Bosman apparently [ran into this](http://groups.google.com/group/sage-release/msg/ab91298b636b947a).\n\nSo we should perhaps only remove the symbolic link (on Darwin) if there's really a system-wide `libpng` installed.\n\nNevertheless, we should still fix `sage-location` to not \"initialize\" `.pc` files more than once, until we handle these files differently such that `sage-location` won't have to deal with them at all.",
    "created_at": "2011-08-29T22:07:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136280",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:11'></a>Replying to [comment:9 leif]:
> Ok, removing `$SAGE_ROOT/local/lib/libpng.dylib` should be sufficient to make R install, though then keeping `$SAGE_ROOT/local/lib/libpng.3.dylib` doesn't make much sense either. (Just wondering why the mtimes of the libraries of 4.7.1 differ that much.)
> 
> I'll update the spkg accordingly later.


Ooops, completely forgot this ticket.

Deleting the symbolic link `libpng.dylib -> libpng12.dylib` can also cause trouble, namely if `pkg-config` **is** installed on Darwin, we still have a broken / messed-up `libpng12.pc` file (containing `SAGE_ROOT=${SAGE_ROOT}`), and there's **no** system-wide `libpng.dylib` installed.

Johan Bosman apparently [ran into this](http://groups.google.com/group/sage-release/msg/ab91298b636b947a).

So we should perhaps only remove the symbolic link (on Darwin) if there's really a system-wide `libpng` installed.

Nevertheless, we should still fix `sage-location` to not "initialize" `.pc` files more than once, until we handle these files differently such that `sage-location` won't have to deal with them at all.



---

archive/issue_comments_136281.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:11 leif]:\n> Nevertheless, we should still fix `sage-location` to not \"initialize\" `.pc` files more than once, until we handle these files differently such that `sage-location` won't have to deal with them at all.\n\n\n**And** *prepend* Sage's `pkg-config` directory to `PKG_CONFIG_PATH` if it's already set. Currently it isn't modified at all if it is non-empty.",
    "created_at": "2011-08-29T22:27:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136281",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:12'></a>Replying to [comment:11 leif]:
> Nevertheless, we should still fix `sage-location` to not "initialize" `.pc` files more than once, until we handle these files differently such that `sage-location` won't have to deal with them at all.


**And** *prepend* Sage's `pkg-config` directory to `PKG_CONFIG_PATH` if it's already set. Currently it isn't modified at all if it is non-empty.



---

archive/issue_comments_136282.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:12 leif]:\n> Replying to [comment:11 leif]:\n> > Nevertheless, we should still fix `sage-location` to not \"initialize\" `.pc` files more than once, until we handle these files differently such that `sage-location` won't have to deal with them at all.\n\n\nThis is now #11760.",
    "created_at": "2011-08-31T02:28:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136282",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:13'></a>Replying to [comment:12 leif]:
> Replying to [comment:11 leif]:
> > Nevertheless, we should still fix `sage-location` to not "initialize" `.pc` files more than once, until we handle these files differently such that `sage-location` won't have to deal with them at all.


This is now #11760.



---

archive/issue_comments_136283.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [comment:11 leif]:\n> Deleting the symbolic link `libpng.dylib -> libpng12.dylib` can also cause trouble, namely if `pkg-config` **is** installed on Darwin, we still have a broken / messed-up `libpng12.pc` file (containing `SAGE_ROOT=${SAGE_ROOT}`), and there's **no** system-wide `libpng.dylib` installed. \n\n\n> \n\n\n> Johan Bosman apparently [ran into this](http://groups.google.com/group/sage-release/msg/ab91298b636b947a).\n\n\nThe problem on his MacOS X machine is actually caused by something else, namely the way matplotlib tries to detect whether `pkg-config` is installed, and a broken `pkg-config`, exiting with a non-zero status when called with `--help`.\n\nA preliminary matplotlib-1.0.1.p1 spkg working around this (and adding a couple of tests and diagnostic messages) can be found [here](http://sage.math.washington.edu/home/leif/Sage/spkgs/matplotlib-1.0.1.p1.spkg).",
    "created_at": "2011-08-31T02:39:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136283",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:14'></a>Replying to [comment:11 leif]:
> Deleting the symbolic link `libpng.dylib -> libpng12.dylib` can also cause trouble, namely if `pkg-config` **is** installed on Darwin, we still have a broken / messed-up `libpng12.pc` file (containing `SAGE_ROOT=${SAGE_ROOT}`), and there's **no** system-wide `libpng.dylib` installed. 


> 


> Johan Bosman apparently [ran into this](http://groups.google.com/group/sage-release/msg/ab91298b636b947a).


The problem on his MacOS X machine is actually caused by something else, namely the way matplotlib tries to detect whether `pkg-config` is installed, and a broken `pkg-config`, exiting with a non-zero status when called with `--help`.

A preliminary matplotlib-1.0.1.p1 spkg working around this (and adding a couple of tests and diagnostic messages) can be found [here](http://sage.math.washington.edu/home/leif/Sage/spkgs/matplotlib-1.0.1.p1.spkg).



---

archive/issue_comments_136284.json:
```json
{
    "body": "<a id='comment:15'></a>The part about Cygwin in spkg-install is also very fishy and IMHO should be removed.\nI'm testing a minimalistically modified spkg which does not inlcude this part now.",
    "created_at": "2012-12-20T10:16:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136284",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:15'></a>The part about Cygwin in spkg-install is also very fishy and IMHO should be removed.
I'm testing a minimalistically modified spkg which does not inlcude this part now.



---

archive/issue_comments_136285.json:
```json
{
    "body": "<a id='comment:16'></a>In fact it is somehow needed because the import library produced by libpng12 is quite empty and so useless...\nThis was the reason for the hack at #9146.\n\nMaybe it is a good time to update libpng?\nOr do some other spkgs specifically need version 1.2?",
    "created_at": "2012-12-20T13:16:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136285",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:16'></a>In fact it is somehow needed because the import library produced by libpng12 is quite empty and so useless...
This was the reason for the hack at #9146.

Maybe it is a good time to update libpng?
Or do some other spkgs specifically need version 1.2?



---

archive/issue_comments_136286.json:
```json
{
    "body": "<a id='comment:17'></a>I've cleaned up everything, removed commented out code, added the trick for Cygwin.\nNeeds review.",
    "created_at": "2013-02-11T17:40:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136286",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:17'></a>I've cleaned up everything, removed commented out code, added the trick for Cygwin.
Needs review.



---

archive/issue_comments_136287.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-02-11T17:40:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136287",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_136288.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,34 @@\n+Doing so avoids trouble if `pkg-config` isn't available, and packages look for just `libpng`.\n \n+The header `png.h` is already installed in `$SAGE_LOCAL/include/`, and a symbolic link from `$SAGE_LOCAL/lib/pkgconfig/libpng.pc` to the actual `libpng12.pc` is also created.\n+\n+---\n+\n+Actually the links (and a compatibility `libpng` shared library) **are** created by upstream, but `spkg-install` deleted these.\n+\n+---\n+\n+Use spkg at:\n+http://boxen.math.washington.edu/home/jpflori/libpng-1.2.35.p5.spkg\n+\n+---\n+\n+Original changes:\n+### libpng-1.2.35.p4 (Leif Leonhardy, August 17th 2011)\n+* #11696: Do *not* delete symbolic links from `libpng.*` (and the shared\n+  library named `libpng.so.*`) in `$SAGE_LOCAL/lib`; see the comment in\n+  `spkg-install` for why (cf. also #11686).\n+* Add `-L$SAGE_LOCAL/lib` to `LDFLAGS`, since otherwise Sage's zlib won't\n+  be used.\n+* Fix order of additions to flags, and don't drop user's settings. (Some\n+  might still intentionally get overridden though.)\n+* Use `$MAKE`, but also install serially since this shouldn't take much\n+  time and is certainly safer.\n+* Quote also `$UNAME`.\n+\n+Further changes:\n+* Let libpng build a correct import on Cygwin using the SYMBOL_PREFIX trick, seehttp://old.nabble.com/Fwd%3A---libpng-Bugs-2981656---Import-library-definitions-missing-in-Windows-td28130513.html.\n+* Further cleanups.\n \n Comment: 1\n \n``````\n",
    "created_at": "2013-02-11T17:40:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136288",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,34 @@
+Doing so avoids trouble if `pkg-config` isn't available, and packages look for just `libpng`.
 
+The header `png.h` is already installed in `$SAGE_LOCAL/include/`, and a symbolic link from `$SAGE_LOCAL/lib/pkgconfig/libpng.pc` to the actual `libpng12.pc` is also created.
+
+---
+
+Actually the links (and a compatibility `libpng` shared library) **are** created by upstream, but `spkg-install` deleted these.
+
+---
+
+Use spkg at:
+http://boxen.math.washington.edu/home/jpflori/libpng-1.2.35.p5.spkg
+
+---
+
+Original changes:
+### libpng-1.2.35.p4 (Leif Leonhardy, August 17th 2011)
+* #11696: Do *not* delete symbolic links from `libpng.*` (and the shared
+  library named `libpng.so.*`) in `$SAGE_LOCAL/lib`; see the comment in
+  `spkg-install` for why (cf. also #11686).
+* Add `-L$SAGE_LOCAL/lib` to `LDFLAGS`, since otherwise Sage's zlib won't
+  be used.
+* Fix order of additions to flags, and don't drop user's settings. (Some
+  might still intentionally get overridden though.)
+* Use `$MAKE`, but also install serially since this shouldn't take much
+  time and is certainly safer.
+* Quote also `$UNAME`.
+
+Further changes:
+* Let libpng build a correct import on Cygwin using the SYMBOL_PREFIX trick, seehttp://old.nabble.com/Fwd%3A---libpng-Bugs-2981656---Import-library-definitions-missing-in-Windows-td28130513.html.
+* Further cleanups.
 
 Comment: 1
 
``````




---

archive/issue_comments_136289.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-02-13T02:52:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136289",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_136290.json:
```json
{
    "body": "<a id='comment:18'></a>something is not right with the spkg:\n\n```\n$ ../../sage -f http://boxen.math.washington.edu/home/jpflori/libpng-1.2.35.p5.spkg\nAttempting to download package libpng-1.2.35.p5\n>>> Downloading libpng-1.2.35.p5.spkg.\n  File \"<stdin>\", line 29\nSyntaxError: Non-ASCII character '\\xc2' in file <stdin> on line 29, but no encoding declared; see http://www.python.org/peps/pep-0263.html for details\nError: failed to download package libpng-1.2.35.p5\n```",
    "created_at": "2013-02-13T02:52:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136290",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:18'></a>something is not right with the spkg:

```
$ ../../sage -f http://boxen.math.washington.edu/home/jpflori/libpng-1.2.35.p5.spkg
Attempting to download package libpng-1.2.35.p5
>>> Downloading libpng-1.2.35.p5.spkg.
  File "<stdin>", line 29
SyntaxError: Non-ASCII character '\xc2' in file <stdin> on line 29, but no encoding declared; see http://www.python.org/peps/pep-0263.html for details
Error: failed to download package libpng-1.2.35.p5
```



---

archive/issue_comments_136291.json:
```json
{
    "body": "<a id='comment:19'></a>That's strange...\nCould you try downloading the spkg by hand?",
    "created_at": "2013-02-13T08:12:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136291",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:19'></a>That's strange...
Could you try downloading the spkg by hand?



---

archive/issue_comments_136292.json:
```json
{
    "body": "<a id='comment:20'></a>Alternatively, try downloading a different random package to check whether the problem lies with the package or the download script.",
    "created_at": "2013-02-13T08:21:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136292",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:20'></a>Alternatively, try downloading a different random package to check whether the problem lies with the package or the download script.



---

archive/issue_comments_136293.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [comment:19 jpflori]:\n> That's strange...\n> Could you try downloading the spkg by hand?\n\n\n* `wget` says \"Scheme missing\"\n\n* `curl -O` downloads it quite OK.\n\nlooks like a server-side issue to me.",
    "created_at": "2013-02-13T08:24:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136293",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:21'></a>Replying to [comment:19 jpflori]:
> That's strange...
> Could you try downloading the spkg by hand?


* `wget` says "Scheme missing"

* `curl -O` downloads it quite OK.

looks like a server-side issue to me.



---

archive/issue_comments_136294.json:
```json
{
    "body": "<a id='comment:22'></a>For info, wget worked from two different places for me (as well as downloading from Firefox).\nAnyway that's not really the point of this ticket.",
    "created_at": "2013-02-13T09:22:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136294",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:22'></a>For info, wget worked from two different places for me (as well as downloading from Firefox).
Anyway that's not really the point of this ticket.



---

archive/issue_comments_136295.json:
```json
{
    "body": "<a id='comment:23'></a>OK, modulo some irrelevant network issue, it works.",
    "created_at": "2013-02-13T09:33:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136295",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:23'></a>OK, modulo some irrelevant network issue, it works.



---

archive/issue_comments_136296.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2013-02-13T09:33:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136296",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_events_030729.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-13T11:10:24Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "milestone": "sage-5.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11696#event-30729"
}
```



---

archive/issue_comments_136297.json:
```json
{
    "body": "<a id='comment:25'></a>On OS X 10.8, Mercurial doesn't work:\n\n```\nrunning install_egg_info\nRemoving /Users/dehayebuildbot/build/sage/dehaye/dehaye_full/build/sage-5.8.beta0/local/lib/python/mercurial-2.2.2-py2.7.egg-info\nWriting /Users/dehayebuildbot/build/sage/dehaye/dehaye_full/build/sage-5.8.beta0/local/lib/python/mercurial-2.2.2-py2.7.egg-info\nTraceback (most recent call last):\n  File \"/Users/dehayebuildbot/build/sage/dehaye/dehaye_full/build/sage-5.8.beta0/local/bin/hg\", line 38, in <module>\n    mercurial.dispatch.run()\n  File \"/Users/dehayebuildbot/build/sage/dehaye/dehaye_full/build/sage-5.8.beta0/local/lib/python/mercurial/dispatch.py\", line 27, in run\n    sys.exit((dispatch(request(sys.argv[1:])) or 0) & 255)\n  File \"/Users/dehayebuildbot/build/sage/dehaye/dehaye_full/build/sage-5.8.beta0/local/lib/python/mercurial/dispatch.py\", line 40, in dispatch\n    req.ui = uimod.ui()\n  File \"/Users/dehayebuildbot/build/sage/dehaye/dehaye_full/build/sage-5.8.beta0/local/lib/python/mercurial/ui.py\", line 43, in __init__\n    for f in scmutil.rcpath():\n  File \"/Users/dehayebuildbot/build/sage/dehaye/dehaye_full/build/sage-5.8.beta0/local/lib/python/mercurial/scmutil.py\", line 430, in rcpath\n    _rcpath = osrcpath()\n  File \"/Users/dehayebuildbot/build/sage/dehaye/dehaye_full/build/sage-5.8.beta0/local/lib/python/mercurial/scmutil.py\", line 402, in osrcpath\n    path = systemrcpath()\n  File \"/Users/dehayebuildbot/build/sage/dehaye/dehaye_full/build/sage-5.8.beta0/local/lib/python/mercurial/scmutil.py\", line 455, in systemrcpath\n    path.extend(rcfiles(os.path.join(p, root)))\n  File \"/Users/dehayebuildbot/build/sage/dehaye/dehaye_full/build/sage-5.8.beta0/local/lib/python/mercurial/scmutil.py\", line 440, in rcfiles\n    for f, kind in osutil.listdir(rcdir)\n  File \"/Users/dehayebuildbot/build/sage/dehaye/dehaye_full/build/sage-5.8.beta0/local/lib/python/mercurial/demandimport.py\", line 86, in __getattribute__\n    self._load()\n  File \"/Users/dehayebuildbot/build/sage/dehaye/dehaye_full/build/sage-5.8.beta0/local/lib/python/mercurial/demandimport.py\", line 58, in _load\n    mod = _origimport(head, globals, locals)\nImportError: dlopen(/Users/dehayebuildbot/build/sage/dehaye/dehaye_full/build/sage-5.8.beta0/local/lib/python/mercurial/osutil.so, 2): Symbol not found: __cg_png_create_info_struct\n  Referenced from: /System/Library/Frameworks/ImageIO.framework/Versions/A/ImageIO\n  Expected in: /Users/dehayebuildbot/build/sage/dehaye/dehaye_full/build/sage-5.8.beta0/local/lib/libPng.dylib\n in /System/Library/Frameworks/ImageIO.framework/Versions/A/ImageIO\nMercurial installed correctly, but doesn't seem to work properly.\nRunning 'hg log' in the directory /Users/dehayebuildbot/build/sage/dehaye/dehaye_full/build/sage-5.8.beta0/spkg/build/mercurial-2.2.2.p0 failed.\n\nreal\t0m9.692s\nuser\t0m2.443s\nsys\t0m0.917s\n************************************************************************\nError installing package mercurial-2.2.2.p0\n************************************************************************\n```",
    "created_at": "2013-02-17T10:09:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136297",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:25'></a>On OS X 10.8, Mercurial doesn't work:

```
running install_egg_info
Removing /Users/dehayebuildbot/build/sage/dehaye/dehaye_full/build/sage-5.8.beta0/local/lib/python/mercurial-2.2.2-py2.7.egg-info
Writing /Users/dehayebuildbot/build/sage/dehaye/dehaye_full/build/sage-5.8.beta0/local/lib/python/mercurial-2.2.2-py2.7.egg-info
Traceback (most recent call last):
  File "/Users/dehayebuildbot/build/sage/dehaye/dehaye_full/build/sage-5.8.beta0/local/bin/hg", line 38, in <module>
    mercurial.dispatch.run()
  File "/Users/dehayebuildbot/build/sage/dehaye/dehaye_full/build/sage-5.8.beta0/local/lib/python/mercurial/dispatch.py", line 27, in run
    sys.exit((dispatch(request(sys.argv[1:])) or 0) & 255)
  File "/Users/dehayebuildbot/build/sage/dehaye/dehaye_full/build/sage-5.8.beta0/local/lib/python/mercurial/dispatch.py", line 40, in dispatch
    req.ui = uimod.ui()
  File "/Users/dehayebuildbot/build/sage/dehaye/dehaye_full/build/sage-5.8.beta0/local/lib/python/mercurial/ui.py", line 43, in __init__
    for f in scmutil.rcpath():
  File "/Users/dehayebuildbot/build/sage/dehaye/dehaye_full/build/sage-5.8.beta0/local/lib/python/mercurial/scmutil.py", line 430, in rcpath
    _rcpath = osrcpath()
  File "/Users/dehayebuildbot/build/sage/dehaye/dehaye_full/build/sage-5.8.beta0/local/lib/python/mercurial/scmutil.py", line 402, in osrcpath
    path = systemrcpath()
  File "/Users/dehayebuildbot/build/sage/dehaye/dehaye_full/build/sage-5.8.beta0/local/lib/python/mercurial/scmutil.py", line 455, in systemrcpath
    path.extend(rcfiles(os.path.join(p, root)))
  File "/Users/dehayebuildbot/build/sage/dehaye/dehaye_full/build/sage-5.8.beta0/local/lib/python/mercurial/scmutil.py", line 440, in rcfiles
    for f, kind in osutil.listdir(rcdir)
  File "/Users/dehayebuildbot/build/sage/dehaye/dehaye_full/build/sage-5.8.beta0/local/lib/python/mercurial/demandimport.py", line 86, in __getattribute__
    self._load()
  File "/Users/dehayebuildbot/build/sage/dehaye/dehaye_full/build/sage-5.8.beta0/local/lib/python/mercurial/demandimport.py", line 58, in _load
    mod = _origimport(head, globals, locals)
ImportError: dlopen(/Users/dehayebuildbot/build/sage/dehaye/dehaye_full/build/sage-5.8.beta0/local/lib/python/mercurial/osutil.so, 2): Symbol not found: __cg_png_create_info_struct
  Referenced from: /System/Library/Frameworks/ImageIO.framework/Versions/A/ImageIO
  Expected in: /Users/dehayebuildbot/build/sage/dehaye/dehaye_full/build/sage-5.8.beta0/local/lib/libPng.dylib
 in /System/Library/Frameworks/ImageIO.framework/Versions/A/ImageIO
Mercurial installed correctly, but doesn't seem to work properly.
Running 'hg log' in the directory /Users/dehayebuildbot/build/sage/dehaye/dehaye_full/build/sage-5.8.beta0/spkg/build/mercurial-2.2.2.p0 failed.

real	0m9.692s
user	0m2.443s
sys	0m0.917s
************************************************************************
Error installing package mercurial-2.2.2.p0
************************************************************************
```



---

archive/issue_comments_136298.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2013-02-17T10:09:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136298",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_136299.json:
```json
{
    "body": "<a id='comment:26'></a>In fact, this fails on all OS X systems.",
    "created_at": "2013-02-17T10:10:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136299",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:26'></a>In fact, this fails on all OS X systems.



---

archive/issue_comments_136300.json:
```json
{
    "body": "<a id='comment:27'></a>Replying to [comment:26 jdemeyer]:\n> In fact, this fails on all OS X systems.\n\n\nThe problem is a conflict with the system library, which (on OSX\n10.6.8, at least) is\n`/System/Library/Frameworks/ApplicationServices.framework/Versions/A/Frameworks/ImageIO.framework/Versions/A/Resources/libPng.dylib`\n\nThis is probably caused by prepending `-L$(SAGE_LOCAL)/lib` to LDFLAGS\nin the new  spkg.",
    "created_at": "2013-02-17T12:19:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136300",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:27'></a>Replying to [comment:26 jdemeyer]:
> In fact, this fails on all OS X systems.


The problem is a conflict with the system library, which (on OSX
10.6.8, at least) is
`/System/Library/Frameworks/ApplicationServices.framework/Versions/A/Frameworks/ImageIO.framework/Versions/A/Resources/libPng.dylib`

This is probably caused by prepending `-L$(SAGE_LOCAL)/lib` to LDFLAGS
in the new  spkg.



---

archive/issue_comments_136301.json:
```json
{
    "body": "<a id='comment:28'></a>Cannot really work on this one as I don't have access to Mac OS X.\n\nMaybe mercurial links to something outside of Sage which itself links to libpng which at runtime is resolved as our libpng, but unfortunately the libpng we ship is less capable than the system-wide one and the symbol lookup fails.\n\nCould you post the mercurial log?",
    "created_at": "2013-02-18T09:44:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136301",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:28'></a>Cannot really work on this one as I don't have access to Mac OS X.

Maybe mercurial links to something outside of Sage which itself links to libpng which at runtime is resolved as our libpng, but unfortunately the libpng we ship is less capable than the system-wide one and the symbol lookup fails.

Could you post the mercurial log?



---

archive/issue_comments_136302.json:
```json
{
    "body": "<a id='comment:29'></a>Replying to [comment:28 jpflori]:\n> Cannot really work on this one as I don't have access to Mac OS X.\n> \n> Maybe mercurial links to something outside of Sage which itself links to libpng which at runtime is resolved as our libpng, but unfortunately the libpng we ship is less capable than the system-wide one and the symbol lookup fails.\n> \n> Could you post the mercurial log?\n\n\nplease see http://boxen.math.washington.edu/home/dima/tmp/merc-osx.log\n\nthis the install log of this spkg followed by the one of mercurial.",
    "created_at": "2013-02-18T11:34:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136302",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:29'></a>Replying to [comment:28 jpflori]:
> Cannot really work on this one as I don't have access to Mac OS X.
> 
> Maybe mercurial links to something outside of Sage which itself links to libpng which at runtime is resolved as our libpng, but unfortunately the libpng we ship is less capable than the system-wide one and the symbol lookup fails.
> 
> Could you post the mercurial log?


please see http://boxen.math.washington.edu/home/dima/tmp/merc-osx.log

this the install log of this spkg followed by the one of mercurial.



---

archive/issue_comments_136303.json:
```json
{
    "body": "<a id='comment:30'></a>I think the problem is that somehow loading the mercurial module osutils triggers loading some Mac OS framework mysterious stuff which itself wants libpng, but Apple is so nice they decide to prefix their symbols with cg in their system wide libpng.\nUnfortunately its ours which gets picked and we do not prefix the symbols with anything fishy.\nWhence the \"fix\" to remove libpng.dylib so that when the Mac OS graphic thing looks for libpng it does not find ours.\n\nHopefully the spkgs we build and which need libpng ling to libpng12 and finds ours rather than the Mac OS X, at least it seems to be the case on Linux.",
    "created_at": "2013-02-18T14:13:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136303",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:30'></a>I think the problem is that somehow loading the mercurial module osutils triggers loading some Mac OS framework mysterious stuff which itself wants libpng, but Apple is so nice they decide to prefix their symbols with cg in their system wide libpng.
Unfortunately its ours which gets picked and we do not prefix the symbols with anything fishy.
Whence the "fix" to remove libpng.dylib so that when the Mac OS graphic thing looks for libpng it does not find ours.

Hopefully the spkgs we build and which need libpng ling to libpng12 and finds ours rather than the Mac OS X, at least it seems to be the case on Linux.



---

archive/issue_comments_136304.json:
```json
{
    "body": "<a id='comment:31'></a>Just for fun, could you try building libpng after export SYMBOL_PREFIX=cg (same trick as used on Cygwin but with cg instead of the empty string).\nBut that should probably break our spkgs needing a plain linpng...\n\nFor future reference, I just fell on\nhttp://lists.apple.com/archives/unix-porting/2008/Sep/msg00026.html",
    "created_at": "2013-02-18T14:19:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136304",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:31'></a>Just for fun, could you try building libpng after export SYMBOL_PREFIX=cg (same trick as used on Cygwin but with cg instead of the empty string).
But that should probably break our spkgs needing a plain linpng...

For future reference, I just fell on
http://lists.apple.com/archives/unix-porting/2008/Sep/msg00026.html



---

archive/issue_comments_136305.json:
```json
{
    "body": "<a id='comment:32'></a>And doesn't it work on Mac OSes with case sensitive filesystems?\nI think one of Apple's trick is to name their library libPng.dylib, but in the end their filesystem is case insensitive...",
    "created_at": "2013-02-18T14:37:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136305",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:32'></a>And doesn't it work on Mac OSes with case sensitive filesystems?
I think one of Apple's trick is to name their library libPng.dylib, but in the end their filesystem is case insensitive...



---

archive/issue_comments_136306.json:
```json
{
    "body": "<a id='comment:33'></a>Replying to [comment:32 jpflori]:\n> And doesn't it work on Mac OSes with case sensitive filesystems?\n> I think one of Apple's trick is to name their library libPng.dylib, but in the end their filesystem is case insensitive...\n\n\nReplying to [comment:31 jpflori]:\n\n> For future reference, I just fell on\n> http://lists.apple.com/archives/unix-porting/2008/Sep/msg00026.html\n\nreading this makes me think that we don't want to mess around with this. \nThe root of the problem is that the *usual* filesystem used by Apple is case-insensitive, and this makes libPNG indistinguishable from libpng.\nhttp://lists.apple.com/archives/unix-porting/2008/Sep/msg00030.html",
    "created_at": "2013-02-18T14:45:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136306",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:33'></a>Replying to [comment:32 jpflori]:
> And doesn't it work on Mac OSes with case sensitive filesystems?
> I think one of Apple's trick is to name their library libPng.dylib, but in the end their filesystem is case insensitive...


Replying to [comment:31 jpflori]:

> For future reference, I just fell on
> http://lists.apple.com/archives/unix-porting/2008/Sep/msg00026.html

reading this makes me think that we don't want to mess around with this. 
The root of the problem is that the *usual* filesystem used by Apple is case-insensitive, and this makes libPNG indistinguishable from libpng.
http://lists.apple.com/archives/unix-porting/2008/Sep/msg00030.html



---

archive/issue_comments_136307.json:
```json
{
    "body": "<a id='comment:34'></a>I agree we don't want to deal with ssuch a mess, but the original goal of this ticket is to let Sage install on systems without a system wide libpng.\nOf course we also want it to install on systems with a system wide conflicting libpng...\n\nBy the way it seems mercurial triggers the ImageIO thingy because it uses EDITOR:\nhttp://trac.sagemath.org/sage_trac/ticket/4678#comment:3",
    "created_at": "2013-02-18T14:51:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136307",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:34'></a>I agree we don't want to deal with ssuch a mess, but the original goal of this ticket is to let Sage install on systems without a system wide libpng.
Of course we also want it to install on systems with a system wide conflicting libpng...

By the way it seems mercurial triggers the ImageIO thingy because it uses EDITOR:
http://trac.sagemath.org/sage_trac/ticket/4678#comment:3



---

archive/issue_comments_136308.json:
```json
{
    "body": "<a id='comment:35'></a>So maybe the best solution is to do as suggested in the above linked comment and in #4216 and use sage-native-execute to run hg on Mac OS...\nThat would be the more robust solution, unless we play will DYLD_[FALLBACK_]LIBRARY_PATH which I have no idea how Sage uses.",
    "created_at": "2013-02-18T14:54:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136308",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:35'></a>So maybe the best solution is to do as suggested in the above linked comment and in #4216 and use sage-native-execute to run hg on Mac OS...
That would be the more robust solution, unless we play will DYLD_[FALLBACK_]LIBRARY_PATH which I have no idea how Sage uses.



---

archive/issue_comments_136309.json:
```json
{
    "body": "<a id='comment:36'></a>Replying to [comment:35 jpflori]:\n> So maybe the best solution is to do as suggested in the above linked comment and in #4216 and use sage-native-execute to run hg on Mac OS...\n> That would be the more robust solution, unless we play will DYLD_[FALLBACK_]LIBRARY_PATH which I have no idea how Sage uses.\n\n\nWIth p4, there is no lib[Pp]ng.* in $SAGE_LOCAL/lib at all on my (curresystem. There are libpng12.* only.\n(except $SAGE_LOCAL/lib/pkgconfig/libpng.pc, which is a link to $SAGE_LOCAL/lib/pkgconfig/libpng12.pc).\n\nThis is why it works. \n\nWith p5 (i.e. spkg on the ticket), there are lots of libpng.*\n\n```\nsage-5.6.beta2/local/lib/libpng.3.dylib\nsage-5.6.beta2/local/lib/libpng.a -> libpng12.a\nsage-5.6.beta2/local/lib/libpng.dylib -> libpng12.dylib\nsage-5.6.beta2/local/lib/libpng.la -> libpng12.la\n```\n\nThis results in the name clash we see on OSX. I suppose you can  tweak the spkg  to remove all the `libpng.*`, they are apparently not needed.\n(This of course defeats part of the purpose of this ticket :-)).",
    "created_at": "2013-02-18T15:35:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136309",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:36'></a>Replying to [comment:35 jpflori]:
> So maybe the best solution is to do as suggested in the above linked comment and in #4216 and use sage-native-execute to run hg on Mac OS...
> That would be the more robust solution, unless we play will DYLD_[FALLBACK_]LIBRARY_PATH which I have no idea how Sage uses.


WIth p4, there is no lib[Pp]ng.* in $SAGE_LOCAL/lib at all on my (curresystem. There are libpng12.* only.
(except $SAGE_LOCAL/lib/pkgconfig/libpng.pc, which is a link to $SAGE_LOCAL/lib/pkgconfig/libpng12.pc).

This is why it works. 

With p5 (i.e. spkg on the ticket), there are lots of libpng.*

```
sage-5.6.beta2/local/lib/libpng.3.dylib
sage-5.6.beta2/local/lib/libpng.a -> libpng12.a
sage-5.6.beta2/local/lib/libpng.dylib -> libpng12.dylib
sage-5.6.beta2/local/lib/libpng.la -> libpng12.la
```

This results in the name clash we see on OSX. I suppose you can  tweak the spkg  to remove all the `libpng.*`, they are apparently not needed.
(This of course defeats part of the purpose of this ticket :-)).



---

archive/issue_comments_136310.json:
```json
{
    "body": "<a id='comment:37'></a>Replying to [comment:36 dimpase]:\n> This results in the name clash we see on OSX. I suppose you can  tweak the spkg  to remove all the `libpng.*`, they are apparently not needed.\n> (This of course defeats part of the purpose of this ticket :-)).\n\nExactly, and the solution to delete files is somehow \"dirty\"...\nIn particular if a package looks for a png rather than png12 it will fail, which may be considered bad.\nOr good as the problem with R mentioned here shows... if R finds png then it somehow triggers the use of the evil ImageIO which wants a symbol prefixed png, but its our non prefixed version which is loaded.\n\nHere are two different preliminary plans to get this merged.\nFirst one:\n* delete libpng.* from $SAGE_LOCAL/lib on Darwin\nand potentially (although quite unrelated):\n* include the fix from John from http://sage.math.washington.edu/home/leif/Sage/spkgs/matplotlib-1.0.1.p1.spkg to fix the problem described here http://groups.google.com/group/sage-release/msg/ab91298b636b947a caused by broken pkg-config (needs to be rebased on top of #11915).\nor for this second point:\n* modify the changes introduced in #11686 to matplotlib so that it only directly links to png12 rather than png when pkg-config is not installed and not unconditionally, because I feel it was not really needed (the real problem was that some pc file got broken, that should be now fixed in #11760) but kept because it was cleaner that way, i.e. only patch when needed, although http://groups.google.com/group/sage-release/msg/ab91298b636b947a showed it might be beneficial in other situations.\n\nOr second one:\n* do not delete libpng.* from $SAGE_LOCAL/lib\nand:\n* use sage-native-execute to run hg\n* find a similar workaround for R and other things which magically trigger the use of ImageIO on Darwin\nand potentially:\n* get rid of all fixes/hacks which make packages link directly to png12 rather than png as this won't be needed anymore.\n\nThe first solution looks infinitely more realistic and simpler, so I'll craft something based on that.",
    "created_at": "2013-02-18T15:52:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136310",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:37'></a>Replying to [comment:36 dimpase]:
> This results in the name clash we see on OSX. I suppose you can  tweak the spkg  to remove all the `libpng.*`, they are apparently not needed.
> (This of course defeats part of the purpose of this ticket :-)).

Exactly, and the solution to delete files is somehow "dirty"...
In particular if a package looks for a png rather than png12 it will fail, which may be considered bad.
Or good as the problem with R mentioned here shows... if R finds png then it somehow triggers the use of the evil ImageIO which wants a symbol prefixed png, but its our non prefixed version which is loaded.

Here are two different preliminary plans to get this merged.
First one:
* delete libpng.* from $SAGE_LOCAL/lib on Darwin
and potentially (although quite unrelated):
* include the fix from John from http://sage.math.washington.edu/home/leif/Sage/spkgs/matplotlib-1.0.1.p1.spkg to fix the problem described here http://groups.google.com/group/sage-release/msg/ab91298b636b947a caused by broken pkg-config (needs to be rebased on top of #11915).
or for this second point:
* modify the changes introduced in #11686 to matplotlib so that it only directly links to png12 rather than png when pkg-config is not installed and not unconditionally, because I feel it was not really needed (the real problem was that some pc file got broken, that should be now fixed in #11760) but kept because it was cleaner that way, i.e. only patch when needed, although http://groups.google.com/group/sage-release/msg/ab91298b636b947a showed it might be beneficial in other situations.

Or second one:
* do not delete libpng.* from $SAGE_LOCAL/lib
and:
* use sage-native-execute to run hg
* find a similar workaround for R and other things which magically trigger the use of ImageIO on Darwin
and potentially:
* get rid of all fixes/hacks which make packages link directly to png12 rather than png as this won't be needed anymore.

The first solution looks infinitely more realistic and simpler, so I'll craft something based on that.



---

archive/issue_comments_136311.json:
```json
{
    "body": "Spkg diff, for review only.",
    "created_at": "2013-02-19T10:04:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136311",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Spkg diff, for review only.



---

archive/issue_comments_136312.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-02-19T10:06:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136312",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_136313.json:
```json
{
    "body": "<a id='comment:38'></a>Attachment [libpng-1.2.35.p5.diff](tarball://root/attachments/some-uuid/ticket11696/libpng-1.2.35.p5.diff) by jpflori created at 2013-02-19 10:06:49\n\nUpdated spkg which deletes symlinks in $SAGE_LOCAL/lib/ on Darwin, please test there.\n\nThe matplotlib/pkg-config problem should be dealt with elsewhere by updating the matplotlib spkg if still present.",
    "created_at": "2013-02-19T10:06:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136313",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:38'></a>Attachment [libpng-1.2.35.p5.diff](tarball://root/attachments/some-uuid/ticket11696/libpng-1.2.35.p5.diff) by jpflori created at 2013-02-19 10:06:49

Updated spkg which deletes symlinks in $SAGE_LOCAL/lib/ on Darwin, please test there.

The matplotlib/pkg-config problem should be dealt with elsewhere by updating the matplotlib spkg if still present.



---

archive/issue_comments_136314.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-02-19T10:24:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136314",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_136315.json:
```json
{
    "body": "<a id='comment:39'></a>looks ok on OSX. Positive review.",
    "created_at": "2013-02-19T10:24:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136315",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:39'></a>looks ok on OSX. Positive review.



---

archive/issue_comments_136316.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-02-22T19:10:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-136316",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_030730.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-22T19:10:31Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11696#event-30730"
}
```
