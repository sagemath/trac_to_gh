# Issue 11678: sage-4.7 gives error on relocating the root directory

archive/issues_011506.json:
```json
{
    "assignees": [],
    "body": "I installed sage-4.7 in a directory as **~/tmp/Downloadz/sage/sage-4.7** and I could run sage by doing **cd ~/tmp/Downloadz/sage/sage-4.7; ./sage -n**\n\nA day ago, I decided to move the directory into a more permanent location (from ~/tmp :)) and moved the whole folder by **mv ~/tmp/Downloadz/sage/sage-4.7 ~/Installations/.**. Now, on trying to run sage, I get the following errors:\n\nFirst, for the notebook:\n\n```\n~/Installations/sage-4.7> ./sage -n\n----------------------------------------------------------------------\n| Sage Version 4.7, Release Date: 2011-05-23                         |\n| Type notebook() for the GUI, and license() for information.        |\n----------------------------------------------------------------------\n\nPlease wait while the Sage Notebook server starts...\nTraceback (most recent call last):\n  File \"/home/ppurka/Installations/sage-4.7/local/bin/sage-notebook\", line 9, in <module>\n    from sage.server.notebook.all import notebook\n  File \"/home/ppurka/Installations/sage-4.7/local/lib/python2.6/site-packages/sage/server/notebook/all.py\", line 22, in <module>\n    from sagenb.notebook.all import *\nImportError: No module named sagenb.notebook.all\n```\n\nFor sage itself:\n\n```\n...allations/sage-4.7 [130] > ./sage\n----------------------------------------------------------------------\n| Sage Version 4.7, Release Date: 2011-05-23                         |\n| Type notebook() for the GUI, and license() for information.        |\n----------------------------------------------------------------------\n---------------------------------------------------------------------------\nImportError                               Traceback (most recent call last)\n\n/home/ppurka/Installations/sage-4.7/local/bin/<string> in <module>()\n\n/home/ppurka/Installations/sage-4.7/local/lib/python2.6/site-packages/sage/misc/preparser_ipython.py in <module>()\n      6 ###########################################################################\n\n      7 \n----> 8 import sage.misc.interpreter\n      9 \n     10 import preparser\n\n/home/ppurka/Installations/sage-4.7/local/lib/python2.6/site-packages/sage/misc/interpreter.py in <module>()\n    100 \n    101 import os\n--> 102 import log\n    103 import re\n    104 \n\n/home/ppurka/Installations/sage-4.7/local/lib/python2.6/site-packages/sage/misc/log.py in <module>()\n     63 \n     64 import interpreter\n---> 65 import latex\n     66 import misc\n     67 \n\n/home/ppurka/Installations/sage-4.7/local/lib/python2.6/site-packages/sage/misc/latex.py in <module>()\n     39 import subprocess\n     40 \n---> 41 from misc import tmp_dir, graphics_filename\n     42 import sage_eval\n     43 from sage.misc.misc import SAGE_DOC\n\n/home/ppurka/Installations/sage-4.7/local/lib/python2.6/site-packages/sage/misc/misc.py in <module>()\n   2104     return \"0\"*(size-len(str(s))) + str(s)\n   2105 \n-> 2106 import sage.server.support\n   2107 \n   2108 def embedded():\n\n/home/ppurka/Installations/sage-4.7/local/lib/python2.6/site-packages/sage/server/support.py in <module>()\n     17 import sage.misc.pager\n     18 \n---> 19 import sage.misc.sagedoc as sagedoc\n     20 import sage.misc.sageinspect as sageinspect\n     21 \n\n/home/ppurka/Installations/sage-4.7/local/lib/python2.6/site-packages/sage/misc/sagedoc.py in <module>()\n     26 from sage.misc.viewer import browser\n     27 from sage.misc.misc import SAGE_DOC, tmp_dir\n---> 28 from sagenb.misc.sphinxify import sphinxify\n     29 import sage.version\n     30 \n\nImportError: No module named sagenb.misc.sphinxify\nWARNING: Failure executing code: 'import sage.misc.preparser_ipython;  sage.misc.preparser_ipython.magma_colon_equals=True'\n---------------------------------------------------------------------------\nImportError                               Traceback (most recent call last)\n\n/home/ppurka/Installations/sage-4.7/local/lib/python2.6/site-packages/IPython/ipmaker.pyc in force_import(modname)\n     64         reload(sys.modules[modname])\n     65     else:\n---> 66         __import__(modname)\n     67 \n     68 \n\n/home/ppurka/Installations/sage-4.7/local/bin/ipy_profile_sage.py in <module>()\n      1 import os\n      2 if 'SAGE_CLEAN' not in os.environ:\n----> 3     import sage.misc.misc\n      4     from sage.misc.interpreter import preparser, _ip\n      5     preparser(True)\n\n/home/ppurka/Installations/sage-4.7/local/lib/python2.6/site-packages/sage/misc/misc.py in <module>()\n   2104     return \"0\"*(size-len(str(s))) + str(s)\n   2105 \n-> 2106 import sage.server.support\n   2107 \n   2108 def embedded():\n\n/home/ppurka/Installations/sage-4.7/local/lib/python2.6/site-packages/sage/server/support.py in <module>()\n     17 import sage.misc.pager\n     18 \n---> 19 import sage.misc.sagedoc as sagedoc\n     20 import sage.misc.sageinspect as sageinspect\n     21 \n\n/home/ppurka/Installations/sage-4.7/local/lib/python2.6/site-packages/sage/misc/sagedoc.py in <module>()\n     26 from sage.misc.viewer import browser\n     27 from sage.misc.misc import SAGE_DOC, tmp_dir\n---> 28 from sagenb.misc.sphinxify import sphinxify\n     29 import sage.version\n     30 \n\nImportError: No module named sagenb.misc.sphinxify\nError importing ipy_profile_sage - perhaps you should run %upgrade?\nWARNING: Loading of ipy_profile_sage failed.\n\n<ERROR: name 'sage_prompt' is not defined>\n```\n\ngrep-ing the sources leads to tons of files which have the earlier path hardcoded into the source files. Just a sample:\n\n```\n~/Installations/sage-4.7> grep -r Downloadz *\n<showing only some output here>\nBinary file devel/sage/sage/__init__.pyc matches\nBinary file devel/sage/sage/misc/package.pyc matches\nBinary file devel/sage/sage/misc/lazy_import_cache.pyc matches\nBinary file devel/sage/sage/misc/__init__.pyc matches\nBinary file local/lib/python2.6/site-packages/speaklater-1.2-py2.6.egg/speaklater.pyc matches\n```\n\nAll the errors were fixed as soon as I made a symbolic link as follows:\n\n```\nln -s ~/Installations/sage-4.7 ~/tmp/Downloadz/sage/.\n```\n\nSince the file **~/Installations/sage-4.7/README.txt** claims that sage should be relocatable, I believe this is a relocation bug in sage.\n\nIf it matters, my system is a Gentoo Linux amd64 system. I do have a sage-4.7 installation in / installed via the sage-on-gentoo overlay. This installation (the one in ~/Installations) was compiled \"manually\" by downloading the sage tarball from the website. It was originally compiled inside the ~/tmp/Downloadz/sage directory.\n\nCC:  @nexttime @rkirov\n\nKeywords: **flask notebook easy-install.pth easy_install**\n\nReviewer: **Punarbasu Purkayastha**\n\nComponent: **relocation**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/11678_\n\n",
    "closed_at": "2012-12-21T22:47:41Z",
    "created_at": "2011-08-11T05:08:21Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/bug",
        "https://github.com/sagemath/sage/labels/c%3A%20relocation",
        "https://github.com/sagemath/sage/labels/worksforme"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "sage-4.7 gives error on relocating the root directory",
    "type": "issue",
    "updated_at": "2012-12-21T22:47:41Z",
    "url": "https://github.com/sagemath/sage/issues/11678",
    "user": "https://github.com/ppurka"
}
```
I installed sage-4.7 in a directory as **~/tmp/Downloadz/sage/sage-4.7** and I could run sage by doing **cd ~/tmp/Downloadz/sage/sage-4.7; ./sage -n**

A day ago, I decided to move the directory into a more permanent location (from ~/tmp :)) and moved the whole folder by **mv ~/tmp/Downloadz/sage/sage-4.7 ~/Installations/.**. Now, on trying to run sage, I get the following errors:

First, for the notebook:

```
~/Installations/sage-4.7> ./sage -n
----------------------------------------------------------------------
| Sage Version 4.7, Release Date: 2011-05-23                         |
| Type notebook() for the GUI, and license() for information.        |
----------------------------------------------------------------------

Please wait while the Sage Notebook server starts...
Traceback (most recent call last):
  File "/home/ppurka/Installations/sage-4.7/local/bin/sage-notebook", line 9, in <module>
    from sage.server.notebook.all import notebook
  File "/home/ppurka/Installations/sage-4.7/local/lib/python2.6/site-packages/sage/server/notebook/all.py", line 22, in <module>
    from sagenb.notebook.all import *
ImportError: No module named sagenb.notebook.all
```

For sage itself:

```
...allations/sage-4.7 [130] > ./sage
----------------------------------------------------------------------
| Sage Version 4.7, Release Date: 2011-05-23                         |
| Type notebook() for the GUI, and license() for information.        |
----------------------------------------------------------------------
---------------------------------------------------------------------------
ImportError                               Traceback (most recent call last)

/home/ppurka/Installations/sage-4.7/local/bin/<string> in <module>()

/home/ppurka/Installations/sage-4.7/local/lib/python2.6/site-packages/sage/misc/preparser_ipython.py in <module>()
      6 ###########################################################################

      7 
----> 8 import sage.misc.interpreter
      9 
     10 import preparser

/home/ppurka/Installations/sage-4.7/local/lib/python2.6/site-packages/sage/misc/interpreter.py in <module>()
    100 
    101 import os
--> 102 import log
    103 import re
    104 

/home/ppurka/Installations/sage-4.7/local/lib/python2.6/site-packages/sage/misc/log.py in <module>()
     63 
     64 import interpreter
---> 65 import latex
     66 import misc
     67 

/home/ppurka/Installations/sage-4.7/local/lib/python2.6/site-packages/sage/misc/latex.py in <module>()
     39 import subprocess
     40 
---> 41 from misc import tmp_dir, graphics_filename
     42 import sage_eval
     43 from sage.misc.misc import SAGE_DOC

/home/ppurka/Installations/sage-4.7/local/lib/python2.6/site-packages/sage/misc/misc.py in <module>()
   2104     return "0"*(size-len(str(s))) + str(s)
   2105 
-> 2106 import sage.server.support
   2107 
   2108 def embedded():

/home/ppurka/Installations/sage-4.7/local/lib/python2.6/site-packages/sage/server/support.py in <module>()
     17 import sage.misc.pager
     18 
---> 19 import sage.misc.sagedoc as sagedoc
     20 import sage.misc.sageinspect as sageinspect
     21 

/home/ppurka/Installations/sage-4.7/local/lib/python2.6/site-packages/sage/misc/sagedoc.py in <module>()
     26 from sage.misc.viewer import browser
     27 from sage.misc.misc import SAGE_DOC, tmp_dir
---> 28 from sagenb.misc.sphinxify import sphinxify
     29 import sage.version
     30 

ImportError: No module named sagenb.misc.sphinxify
WARNING: Failure executing code: 'import sage.misc.preparser_ipython;  sage.misc.preparser_ipython.magma_colon_equals=True'
---------------------------------------------------------------------------
ImportError                               Traceback (most recent call last)

/home/ppurka/Installations/sage-4.7/local/lib/python2.6/site-packages/IPython/ipmaker.pyc in force_import(modname)
     64         reload(sys.modules[modname])
     65     else:
---> 66         __import__(modname)
     67 
     68 

/home/ppurka/Installations/sage-4.7/local/bin/ipy_profile_sage.py in <module>()
      1 import os
      2 if 'SAGE_CLEAN' not in os.environ:
----> 3     import sage.misc.misc
      4     from sage.misc.interpreter import preparser, _ip
      5     preparser(True)

/home/ppurka/Installations/sage-4.7/local/lib/python2.6/site-packages/sage/misc/misc.py in <module>()
   2104     return "0"*(size-len(str(s))) + str(s)
   2105 
-> 2106 import sage.server.support
   2107 
   2108 def embedded():

/home/ppurka/Installations/sage-4.7/local/lib/python2.6/site-packages/sage/server/support.py in <module>()
     17 import sage.misc.pager
     18 
---> 19 import sage.misc.sagedoc as sagedoc
     20 import sage.misc.sageinspect as sageinspect
     21 

/home/ppurka/Installations/sage-4.7/local/lib/python2.6/site-packages/sage/misc/sagedoc.py in <module>()
     26 from sage.misc.viewer import browser
     27 from sage.misc.misc import SAGE_DOC, tmp_dir
---> 28 from sagenb.misc.sphinxify import sphinxify
     29 import sage.version
     30 

ImportError: No module named sagenb.misc.sphinxify
Error importing ipy_profile_sage - perhaps you should run %upgrade?
WARNING: Loading of ipy_profile_sage failed.

<ERROR: name 'sage_prompt' is not defined>
```

grep-ing the sources leads to tons of files which have the earlier path hardcoded into the source files. Just a sample:

```
~/Installations/sage-4.7> grep -r Downloadz *
<showing only some output here>
Binary file devel/sage/sage/__init__.pyc matches
Binary file devel/sage/sage/misc/package.pyc matches
Binary file devel/sage/sage/misc/lazy_import_cache.pyc matches
Binary file devel/sage/sage/misc/__init__.pyc matches
Binary file local/lib/python2.6/site-packages/speaklater-1.2-py2.6.egg/speaklater.pyc matches
```

All the errors were fixed as soon as I made a symbolic link as follows:

```
ln -s ~/Installations/sage-4.7 ~/tmp/Downloadz/sage/.
```

Since the file **~/Installations/sage-4.7/README.txt** claims that sage should be relocatable, I believe this is a relocation bug in sage.

If it matters, my system is a Gentoo Linux amd64 system. I do have a sage-4.7 installation in / installed via the sage-on-gentoo overlay. This installation (the one in ~/Installations) was compiled "manually" by downloading the sage tarball from the website. It was originally compiled inside the ~/tmp/Downloadz/sage directory.

CC:  @nexttime @rkirov

Keywords: **flask notebook easy-install.pth easy_install**

Reviewer: **Punarbasu Purkayastha**

Component: **relocation**

_Issue created by migration from https://trac.sagemath.org/ticket/11678_





---

archive/issue_events_155075.json:
```json
{
    "actor": "https://github.com/ppurka",
    "created_at": "2011-08-11T05:08:21Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/11678",
    "milestone_number": null,
    "milestone_title": "sage-5.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11678#event-155075"
}
```



---

archive/issue_events_155076.json:
```json
{
    "actor": "https://github.com/ppurka",
    "created_at": "2011-08-11T05:08:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11678",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20relocation",
    "label_color": "0000b0",
    "label_name": "c: relocation",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11678#event-155076"
}
```



---

archive/issue_events_155077.json:
```json
{
    "actor": "https://github.com/ppurka",
    "created_at": "2011-08-11T05:08:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11678",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20minor%20/%204",
    "label_color": "ffe799",
    "label_name": "p: minor / 4",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11678#event-155077"
}
```



---

archive/issue_events_155078.json:
```json
{
    "actor": "https://github.com/ppurka",
    "created_at": "2011-08-11T05:08:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11678",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11678#event-155078"
}
```



---

archive/issue_comments_120565.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nDid you notice a message\n\n```\nThe Sage install tree may have moved\n(from ... to ...)\nChanging various hardcoded paths\n(please wait at most a few minutes)...\nDo not interrupt this.\n```\nwhen you first started `./sage` in the new directory (`~/Installations/sage-4.7/`)?\n\n\n\n\nI'm not sure if (or rather doubt that) Sage will fully work in the presence of another system-wide Sage installation, i.e., if another (different) `sage` is in your `PATH`.\n\nThe latter *might* be the problem.",
    "created_at": "2011-08-11T09:16:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11678#issuecomment-120565",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:2" align="right">comment:2</div>

Did you notice a message

```
The Sage install tree may have moved
(from ... to ...)
Changing various hardcoded paths
(please wait at most a few minutes)...
Do not interrupt this.
```
when you first started `./sage` in the new directory (`~/Installations/sage-4.7/`)?




I'm not sure if (or rather doubt that) Sage will fully work in the presence of another system-wide Sage installation, i.e., if another (different) `sage` is in your `PATH`.

The latter *might* be the problem.



---

archive/issue_comments_120566.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nP.S.: If it's just the `.pyc` files, you may cure your installation by simply removing them; they'll get recompiled the next time Python executes their respective `.py` files.\n\n(I of course don't consider this a solution to the general problem, but it also would be helpful to know whether there are further files which still contain the old location *and* hinder Sage from starting up without the symbolic link from its original location. AFAIK there'll always remain some \"harmless\" `RPATH`s in shared libraries pointing to the old location.)",
    "created_at": "2011-08-11T09:31:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11678#issuecomment-120566",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:3" align="right">comment:3</div>

P.S.: If it's just the `.pyc` files, you may cure your installation by simply removing them; they'll get recompiled the next time Python executes their respective `.py` files.

(I of course don't consider this a solution to the general problem, but it also would be helpful to know whether there are further files which still contain the old location *and* hinder Sage from starting up without the symbolic link from its original location. AFAIK there'll always remain some "harmless" `RPATH`s in shared libraries pointing to the old location.)



---

archive/issue_comments_120567.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nReplying to [@nexttime](#comment%3A2):\n> Did you notice a message\n> \n> ```\n> The Sage install tree may have moved\n> (from ... to ...)\n> Changing various hardcoded paths\n> (please wait at most a few minutes)...\n> Do not interrupt this.\n> ```\n> when you first started `./sage` in the new directory (`~/Installations/sage-4.7/`)?\n> \n> \n\n> \n> I'm not sure if (or rather doubt that) Sage will fully work in the presence of another system-wide Sage installation, i.e., if another (different) `sage` is in your `PATH`.\n> \n> The latter *might* be the problem.\n\nSorry, I don't clearly remember what was the output at the very first run of sage.\n\nDeleting the .pyc files doesn't work. I get the same error as I got earlier. If I have the symlink, then it does work fine, irrespective of the system wide sage installation. I know that it uses the sage (at least the notebook) from the directory ~/Installations, since I am running the rkirov-flask notebook in that directory. But you are right, there might be other things which are getting mixed up. I will simply try recompiling the local sage installation again.",
    "created_at": "2011-08-11T13:06:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11678#issuecomment-120567",
    "user": "https://github.com/ppurka"
}
```

<div id="comment:4" align="right">comment:4</div>

Replying to [@nexttime](#comment%3A2):
> Did you notice a message
> 
> ```
> The Sage install tree may have moved
> (from ... to ...)
> Changing various hardcoded paths
> (please wait at most a few minutes)...
> Do not interrupt this.
> ```
> when you first started `./sage` in the new directory (`~/Installations/sage-4.7/`)?
> 
> 

> 
> I'm not sure if (or rather doubt that) Sage will fully work in the presence of another system-wide Sage installation, i.e., if another (different) `sage` is in your `PATH`.
> 
> The latter *might* be the problem.

Sorry, I don't clearly remember what was the output at the very first run of sage.

Deleting the .pyc files doesn't work. I get the same error as I got earlier. If I have the symlink, then it does work fine, irrespective of the system wide sage installation. I know that it uses the sage (at least the notebook) from the directory ~/Installations, since I am running the rkirov-flask notebook in that directory. But you are right, there might be other things which are getting mixed up. I will simply try recompiling the local sage installation again.



---

archive/issue_comments_120568.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nIn the file `SAGE_ROOT/local/lib/python/site-packages/easy-install.pth`, there should be a line containing \"sagenb\".  Is the path there relative (`../../../../devel/sagenb`) or absolute?  If it's absolute, what happens if you replace it with the relative path I gave?",
    "created_at": "2011-08-11T16:14:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11678#issuecomment-120568",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:5" align="right">comment:5</div>

In the file `SAGE_ROOT/local/lib/python/site-packages/easy-install.pth`, there should be a line containing "sagenb".  Is the path there relative (`../../../../devel/sagenb`) or absolute?  If it's absolute, what happens if you replace it with the relative path I gave?



---

archive/issue_comments_120569.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nReplying to [@jhpalmieri](#comment%3A5):\n> In the file `SAGE_ROOT/local/lib/python/site-packages/easy-install.pth`, there should be a line containing \"sagenb\".  Is the path there relative (`../../../../devel/sagenb`) or absolute?  If it's absolute, what happens if you replace it with the relative path I gave?\n\nI know I once fixed this (especially if `SAGE_PATH` was set), but I don't recall if that sagenb spkg ever finally got merged.",
    "created_at": "2011-08-11T16:20:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11678#issuecomment-120569",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:6" align="right">comment:6</div>

Replying to [@jhpalmieri](#comment%3A5):
> In the file `SAGE_ROOT/local/lib/python/site-packages/easy-install.pth`, there should be a line containing "sagenb".  Is the path there relative (`../../../../devel/sagenb`) or absolute?  If it's absolute, what happens if you replace it with the relative path I gave?

I know I once fixed this (especially if `SAGE_PATH` was set), but I don't recall if that sagenb spkg ever finally got merged.



---

archive/issue_comments_120570.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nLeif: I think the issue is the flask notebook.  With the \"classic\" notebook, I don't seem to have this problem, and the spkg-install file tries to make the path relative, but when I tried the [installation instructions](http://code.google.com/r/rkirov-flask/) for the flask notebook, I got an absolute path for the notebook (referring to \"rkirov-flask\" instead of \"sagenb\"), and it renders my Sage installation non-relocateable.",
    "created_at": "2011-08-11T16:26:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11678#issuecomment-120570",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:7" align="right">comment:7</div>

Leif: I think the issue is the flask notebook.  With the "classic" notebook, I don't seem to have this problem, and the spkg-install file tries to make the path relative, but when I tried the [installation instructions](http://code.google.com/r/rkirov-flask/) for the flask notebook, I got an absolute path for the notebook (referring to "rkirov-flask" instead of "sagenb"), and it renders my Sage installation non-relocateable.



---

archive/issue_comments_120571.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nReplying to [@ppurka](#comment%3A4):\n> Replying to [@nexttime](#comment%3A2):\n> > Did you notice a message\n\n\n```\nThe Sage install tree may have moved\n(from ... to ...)\nChanging various hardcoded paths\n(please wait at most a few minutes)...\nDo not interrupt this.\n```\n> > when you first started `./sage` in the new directory (`~/Installations/sage-4.7/`)?\n> > \n> > \n\n> > \n> > I'm not sure if (or rather doubt that) Sage will fully work in the presence of another system-wide Sage installation, i.e., if another (different) `sage` is in your `PATH`.\n> > \n> > The latter *might* be the problem.\n\n> \n> Sorry, I don't clearly remember what was the output at the very first run of sage.\n\nWell, you can retry by simply renaming the `$SAGE_ROOT` directory. ;-)\n\n\n> If I have the symlink, then it does work fine, irrespective of the system wide sage installation. I know that it uses the sage (at least the notebook) from the directory ~/Installations, since I am running the rkirov-flask notebook in that directory. But you are right, there might be other things which are getting mixed up. I will simply try recompiling the local sage installation again.\n\nYou could just rename your system-wide `sage` command, in `/usr/bin/` or `/usr/local/bin/` I guess. (`command -v sage` should show which one is used when you're outside the separate Sage installation.)",
    "created_at": "2011-08-11T16:28:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11678#issuecomment-120571",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:8" align="right">comment:8</div>

Replying to [@ppurka](#comment%3A4):
> Replying to [@nexttime](#comment%3A2):
> > Did you notice a message


```
The Sage install tree may have moved
(from ... to ...)
Changing various hardcoded paths
(please wait at most a few minutes)...
Do not interrupt this.
```
> > when you first started `./sage` in the new directory (`~/Installations/sage-4.7/`)?
> > 
> > 

> > 
> > I'm not sure if (or rather doubt that) Sage will fully work in the presence of another system-wide Sage installation, i.e., if another (different) `sage` is in your `PATH`.
> > 
> > The latter *might* be the problem.

> 
> Sorry, I don't clearly remember what was the output at the very first run of sage.

Well, you can retry by simply renaming the `$SAGE_ROOT` directory. ;-)


> If I have the symlink, then it does work fine, irrespective of the system wide sage installation. I know that it uses the sage (at least the notebook) from the directory ~/Installations, since I am running the rkirov-flask notebook in that directory. But you are right, there might be other things which are getting mixed up. I will simply try recompiling the local sage installation again.

You could just rename your system-wide `sage` command, in `/usr/bin/` or `/usr/local/bin/` I guess. (`command -v sage` should show which one is used when you're outside the separate Sage installation.)



---

archive/issue_comments_120572.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nReplying to [@jhpalmieri](#comment%3A7):\n> Leif: I think the issue is the flask notebook.  With the \"classic\" notebook, I don't seem to have this problem, and the spkg-install file tries to make the path relative, but when I tried the [installation instructions](http://code.google.com/r/rkirov-flask/) for the flask notebook, I got an absolute path for the notebook (referring to \"rkirov-flask\" instead of \"sagenb\"), and it renders my Sage installation non-relocateable.\n\nAh, so it's an upstream problem... :D",
    "created_at": "2011-08-11T16:34:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11678#issuecomment-120572",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:9" align="right">comment:9</div>

Replying to [@jhpalmieri](#comment%3A7):
> Leif: I think the issue is the flask notebook.  With the "classic" notebook, I don't seem to have this problem, and the spkg-install file tries to make the path relative, but when I tried the [installation instructions](http://code.google.com/r/rkirov-flask/) for the flask notebook, I got an absolute path for the notebook (referring to "rkirov-flask" instead of "sagenb"), and it renders my Sage installation non-relocateable.

Ah, so it's an upstream problem... :D



---

archive/issue_comments_120573.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@jhpalmieri](#comment%3A5):\n> In the file `SAGE_ROOT/local/lib/python/site-packages/easy-install.pth`, there should be a line containing \"sagenb\".  Is the path there relative (`../../../../devel/sagenb`) or absolute?  If it's absolute, what happens if you replace it with the relative path I gave?\n\nExcellent! This fixes the relocation problem. Indeed rkirov-flask was written as a full path instead of the relative one. So, this is not a bug in sage relocation per se.",
    "created_at": "2011-08-11T16:37:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11678#issuecomment-120573",
    "user": "https://github.com/ppurka"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@jhpalmieri](#comment%3A5):
> In the file `SAGE_ROOT/local/lib/python/site-packages/easy-install.pth`, there should be a line containing "sagenb".  Is the path there relative (`../../../../devel/sagenb`) or absolute?  If it's absolute, what happens if you replace it with the relative path I gave?

Excellent! This fixes the relocation problem. Indeed rkirov-flask was written as a full path instead of the relative one. So, this is not a bug in sage relocation per se.



---

archive/issue_comments_120574.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nCan someone report this upstream, to Rado?",
    "created_at": "2011-08-11T16:41:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11678#issuecomment-120574",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:11" align="right">comment:11</div>

Can someone report this upstream, to Rado?



---

archive/issue_comments_120575.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@nexttime](#comment%3A11):\n> Can someone report this upstream, to Rado?\n\nI will see him tomorrow, so I will tell him :)",
    "created_at": "2011-08-11T16:42:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11678#issuecomment-120575",
    "user": "https://github.com/ppurka"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@nexttime](#comment%3A11):
> Can someone report this upstream, to Rado?

I will see him tomorrow, so I will tell him :)



---

archive/issue_comments_120576.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nI don't understand python's setuptools, but I haven't hardcoded the path anywhere. My guess is that doing \"python setup.py develop\" does that. Once flask becomes a proper spkg this should go away (hopefully).",
    "created_at": "2011-08-11T17:44:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11678#issuecomment-120576",
    "user": "https://github.com/rkirov"
}
```

<div id="comment:13" align="right">comment:13</div>

I don't understand python's setuptools, but I haven't hardcoded the path anywhere. My guess is that doing "python setup.py develop" does that. Once flask becomes a proper spkg this should go away (hopefully).



---

archive/issue_comments_120577.json:
```json
{
    "body": "Changed keywords from none to **flask notebook easy-install.pth easy_install**",
    "created_at": "2011-08-11T18:31:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11678#issuecomment-120577",
    "user": "https://github.com/nexttime"
}
```

Changed keywords from none to **flask notebook easy-install.pth easy_install**



---

archive/issue_comments_120578.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@rkirov](#comment%3A13):\n> I don't understand python's setuptools, but I haven't hardcoded the path anywhere. My guess is that doing \"python setup.py develop\" does that. Once flask becomes a proper spkg this should go away (hopefully).\n\nIn SageNB, we use\n\n```sh\npython setup.py develop --egg-path ../../../../devel/sagenb\n```\nbut that apparently doesn't always work, so I hacked SageNB's `spkg-dist` which creates its `spkg-install`:\n\n```sh\n...\ncd \"$SAGE_ROOT/local/lib/python/site-packages\"\n...\nif ! grep sagenb easy-install.pth >/dev/null; then\n    # Ugly work-around, we haven't found the real cause yet (see #10176):\n    echo \"No sagenb path found in 'easy-install.pth'\"'!'\n    echo \"Adding relative sagenb path to 'easy-install.pth'...\"\n    sed -e '$ i \\../../../../devel/sagenb' easy-install.pth > easy-install.pth.$$\n    if [ $? -ne 0 ]; then\n        echo >&2 \"Error adding relative sagenb path to 'easy-install.pth'.\"\n        exit 1\n    fi\nelse\n    echo \"Making sagenb path in 'easy-install.pth' relative...\"\n    sed 's/^.*sagenb.*$/..\\/..\\/..\\/..\\/devel\\/sagenb/' easy-install.pth > easy-install.pth.$$\n    if [ $? -ne 0 ]; then\n        echo >&2 \"Error patching 'easy-install.pth' to have relative path to SageNB.\"\n        exit 1\n    fi\nfi\n...\n# The following fails only on wrong file permissions etc.:\nmv -f easy-install.pth.$$ easy-install.pth\nif [ $? -ne 0 ]; then\n    echo >&2 \"Error overwriting original 'easy-install.pth'.\"\n    exit 1\nfi\n...\n```\n\n(IIRC the trouble with *a completely missing* `sagenb` path was caused by having `SAGE_PATH` set to \"`.`\", but I'm not sure.)",
    "created_at": "2011-08-11T18:31:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11678#issuecomment-120578",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@rkirov](#comment%3A13):
> I don't understand python's setuptools, but I haven't hardcoded the path anywhere. My guess is that doing "python setup.py develop" does that. Once flask becomes a proper spkg this should go away (hopefully).

In SageNB, we use

```sh
python setup.py develop --egg-path ../../../../devel/sagenb
```
but that apparently doesn't always work, so I hacked SageNB's `spkg-dist` which creates its `spkg-install`:

```sh
...
cd "$SAGE_ROOT/local/lib/python/site-packages"
...
if ! grep sagenb easy-install.pth >/dev/null; then
    # Ugly work-around, we haven't found the real cause yet (see #10176):
    echo "No sagenb path found in 'easy-install.pth'"'!'
    echo "Adding relative sagenb path to 'easy-install.pth'..."
    sed -e '$ i \../../../../devel/sagenb' easy-install.pth > easy-install.pth.$$
    if [ $? -ne 0 ]; then
        echo >&2 "Error adding relative sagenb path to 'easy-install.pth'."
        exit 1
    fi
else
    echo "Making sagenb path in 'easy-install.pth' relative..."
    sed 's/^.*sagenb.*$/..\/..\/..\/..\/devel\/sagenb/' easy-install.pth > easy-install.pth.$$
    if [ $? -ne 0 ]; then
        echo >&2 "Error patching 'easy-install.pth' to have relative path to SageNB."
        exit 1
    fi
fi
...
# The following fails only on wrong file permissions etc.:
mv -f easy-install.pth.$$ easy-install.pth
if [ $? -ne 0 ]; then
    echo >&2 "Error overwriting original 'easy-install.pth'."
    exit 1
fi
...
```

(IIRC the trouble with *a completely missing* `sagenb` path was caused by having `SAGE_PATH` set to "`.`", but I'm not sure.)



---

archive/issue_comments_120579.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nThere is actually absolutely no difference between rkirov-flask/spkg-dist and sagenb-main/spkg-dist. So, this problem will probably \"magically go away\" once rkirov-flask is actually packaged.",
    "created_at": "2011-08-11T18:37:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11678#issuecomment-120579",
    "user": "https://github.com/ppurka"
}
```

<div id="comment:15" align="right">comment:15</div>

There is actually absolutely no difference between rkirov-flask/spkg-dist and sagenb-main/spkg-dist. So, this problem will probably "magically go away" once rkirov-flask is actually packaged.



---

archive/issue_comments_120580.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@ppurka](#comment%3A15):\n> There is actually absolutely no difference between rkirov-flask/spkg-dist and sagenb-main/spkg-dist. So, this problem will probably \"magically go away\" once rkirov-flask is actually packaged.\n\nYeah, but Rado could add a script (or just a note on that) to the project page.\n\n---\n\nFor the record:\n\nThe `--egg-path ...` was actually introduced at #10097, and only affects the `sagenb.egg-link` file, therefore Mitesh added replacing the absolute path in `easy-install.pth` by a relative one.\n\n#10176 and #10192 (the latter patching `sage-spkg`, and still needing review) dealt with a completely missing `sagenb` entry in `easy-install.pth`, due to `SAGE_PATH=\".\"` (and removed `ln -snf`, see below).\n\nNote that the `-n` option of `ln -snf` isn't defined by POSIX, and -- worse -- shows different behaviour on GNU/Linux and Solaris, so we must not use it. I'd also change the `rkirov-flask` installation instructions, though currently explicitly for Linux, accordingly.",
    "created_at": "2011-08-11T19:42:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11678#issuecomment-120580",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@ppurka](#comment%3A15):
> There is actually absolutely no difference between rkirov-flask/spkg-dist and sagenb-main/spkg-dist. So, this problem will probably "magically go away" once rkirov-flask is actually packaged.

Yeah, but Rado could add a script (or just a note on that) to the project page.

---

For the record:

The `--egg-path ...` was actually introduced at #10097, and only affects the `sagenb.egg-link` file, therefore Mitesh added replacing the absolute path in `easy-install.pth` by a relative one.

#10176 and #10192 (the latter patching `sage-spkg`, and still needing review) dealt with a completely missing `sagenb` entry in `easy-install.pth`, due to `SAGE_PATH="."` (and removed `ln -snf`, see below).

Note that the `-n` option of `ln -snf` isn't defined by POSIX, and -- worse -- shows different behaviour on GNU/Linux and Solaris, so we must not use it. I'd also change the `rkirov-flask` installation instructions, though currently explicitly for Linux, accordingly.



---

archive/issue_comments_120581.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nThis is still a problem with sage-4.7.2 + jasongrout-flask.",
    "created_at": "2011-12-01T12:55:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11678#issuecomment-120581",
    "user": "https://github.com/ppurka"
}
```

<div id="comment:18" align="right">comment:18</div>

This is still a problem with sage-4.7.2 + jasongrout-flask.



---

archive/issue_events_155079.json:
```json
{
    "actor": "https://github.com/ppurka",
    "created_at": "2012-12-11T16:42:37Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/11678",
    "milestone_number": null,
    "milestone_title": "sage-5.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11678#event-155079"
}
```



---

archive/issue_comments_120582.json:
```json
{
    "body": "Reviewer: **Punarbasu Purkayastha**",
    "created_at": "2012-12-11T16:42:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11678#issuecomment-120582",
    "user": "https://github.com/ppurka"
}
```

Reviewer: **Punarbasu Purkayastha**



---

archive/issue_events_155080.json:
```json
{
    "actor": "https://github.com/ppurka",
    "created_at": "2012-12-11T16:42:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11678",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11678#event-155080"
}
```



---

archive/issue_events_155081.json:
```json
{
    "actor": "https://github.com/ppurka",
    "created_at": "2012-12-11T16:42:47Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11678",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11678#event-155081"
}
```



---

archive/issue_events_155082.json:
```json
{
    "actor": "https://github.com/ppurka",
    "created_at": "2012-12-11T16:42:47Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11678",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11678#event-155082"
}
```



---

archive/issue_comments_120583.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nsagenb has long ago been merged. And this ticket is pointless now.",
    "created_at": "2012-12-11T16:44:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11678",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11678#issuecomment-120583",
    "user": "https://github.com/ppurka"
}
```

<div id="comment:21" align="right">comment:21</div>

sagenb has long ago been merged. And this ticket is pointless now.



---

archive/issue_events_155083.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-12-21T22:47:41Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11678",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20minor%20/%204",
    "label_color": "ffe799",
    "label_name": "p: minor / 4",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11678#event-155083"
}
```



---

archive/issue_events_155084.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-12-21T22:47:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11678",
    "label": "https://github.com/sagemath/sage/labels/worksforme",
    "label_color": "c6c6c6",
    "label_name": "worksforme",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11678#event-155084"
}
```



---

archive/issue_events_155085.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-12-21T22:47:41Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11678",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11678#event-155085"
}
```



---

archive/issue_events_155086.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-12-21T22:47:41Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/11678",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11678#event-155086"
}
```
