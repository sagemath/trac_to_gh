# Issue 11429: Count integral points without PALP

archive/issues_011257.json:
```json
{
    "assignees": [],
    "body": "We want our own code to enumerate lattice points in polyhedra because:\n* Going through the PALP pexpect interface is annoyingly slow. \n* no more compile-time bounds\n* It seems like PALP uses a very unsophisticated algorithm:\n\n    ```\n    sage: v = [(1,0,7,-1), (-2,-2,4,-3), (-1,-1,-1,4), (2,9,0,-5), (-2,-1,5,1)]\n    sage: lp = LatticePolytope(matrix(v).transpose()); lp\n    A lattice polytope: 4-dimensional, 5 vertices.\n    sage: lp.npoints()\n  ```\n  takes forever with PALP but only 500ms with my Python code.\n\nComparing timings, it seems that PALP always runs over the integral points of a rectangular bounding box. This is good for small polytopes (low overhead) but bad for large ones. To match PALP's speed for small polytopes, I implemented the same algorithm in Cython (the second patch) and use it for bounding boxes containing <50k points. \n\n\n**Apply:**\n1. [attachment:trac_11429_native_enumeration_of_lattice_polytope_points.patch](https://github.com/sagemath/sage/files/ticket11429/trac_11429_native_enumeration_of_lattice_polytope_points.patch)\n2. [attachment:trac_11429_cythonize_lattice_points.patch](https://github.com/sagemath/sage/files/ticket11429/trac_11429_cythonize_lattice_points.patch)\n3. [attachment:trac_11429_fix_doctests.patch](https://github.com/sagemath/sage/files/ticket11429/trac_11429_fix_doctests.patch)\n\nDepends on #11312\n\nDepends on #9958\n\n**Assignee:** @aghitza\n\n**CC:**  @novoselt @zafeirakopoulos\n\n**Keywords:** sd31\n\n**Author:** Volker Braun\n\n**Reviewer:** Andrey Novoseltsev, Jeroen Demeyer\n\n**Merged:** sage-5.0.beta2\n\nIssue created by migration from https://trac.sagemath.org/ticket/11429\n\n",
    "closed_at": "2012-01-29T11:17:33Z",
    "created_at": "2011-06-05T19:26:25Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20geometry",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.0",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Count integral points without PALP",
    "type": "issue",
    "updated_at": "2012-01-29T11:17:33Z",
    "url": "https://github.com/sagemath/sage/issues/11429",
    "user": "https://github.com/vbraun"
}
```
We want our own code to enumerate lattice points in polyhedra because:
* Going through the PALP pexpect interface is annoyingly slow. 
* no more compile-time bounds
* It seems like PALP uses a very unsophisticated algorithm:

    ```
    sage: v = [(1,0,7,-1), (-2,-2,4,-3), (-1,-1,-1,4), (2,9,0,-5), (-2,-1,5,1)]
    sage: lp = LatticePolytope(matrix(v).transpose()); lp
    A lattice polytope: 4-dimensional, 5 vertices.
    sage: lp.npoints()
  ```
  takes forever with PALP but only 500ms with my Python code.

Comparing timings, it seems that PALP always runs over the integral points of a rectangular bounding box. This is good for small polytopes (low overhead) but bad for large ones. To match PALP's speed for small polytopes, I implemented the same algorithm in Cython (the second patch) and use it for bounding boxes containing <50k points. 


**Apply:**
1. [attachment:trac_11429_native_enumeration_of_lattice_polytope_points.patch](https://github.com/sagemath/sage/files/ticket11429/trac_11429_native_enumeration_of_lattice_polytope_points.patch)
2. [attachment:trac_11429_cythonize_lattice_points.patch](https://github.com/sagemath/sage/files/ticket11429/trac_11429_cythonize_lattice_points.patch)
3. [attachment:trac_11429_fix_doctests.patch](https://github.com/sagemath/sage/files/ticket11429/trac_11429_fix_doctests.patch)

Depends on #11312

Depends on #9958

**Assignee:** @aghitza

**CC:**  @novoselt @zafeirakopoulos

**Keywords:** sd31

**Author:** Volker Braun

**Reviewer:** Andrey Novoseltsev, Jeroen Demeyer

**Merged:** sage-5.0.beta2

Issue created by migration from https://trac.sagemath.org/ticket/11429





---

archive/issue_events_128196.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-06-05T19:26:25Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "milestone_number": null,
    "milestone_title": "sage-5.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11429#event-128196"
}
```



---

archive/issue_events_128197.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-06-05T19:26:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20algebraic%20geometry",
    "label_color": "08517b",
    "label_name": "component: algebraic geometry",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11429#event-128197"
}
```



---

archive/issue_events_128198.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-06-05T19:26:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "008080",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11429#event-128198"
}
```



---

archive/issue_comments_117776.json:
```json
{
    "body": "**Dependencies:** #11312",
    "created_at": "2011-06-05T19:36:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11429#issuecomment-117776",
    "user": "https://github.com/vbraun"
}
```

**Dependencies:** #11312



---

archive/issue_comments_117777.json:
```json
{
    "body": "Updated patch",
    "created_at": "2011-06-13T04:07:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11429#issuecomment-117777",
    "user": "https://github.com/vbraun"
}
```

Updated patch



---

archive/issue_events_128199.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-06-13T04:15:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11429#event-128199"
}
```



---

archive/issue_comments_117778.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -10,3 +10,5 @@\n     sage: lp.npoints()\n   ```\n   takes forever with PALP but only 500ms with my Python code.\n+\n+Comparing timings, it seems that PALP always runs over the integral points of a rectangular bounding box. This is good for small polytopes (low overhead) but bad for large ones. To match PALP's speed for small polytopes, I implemented the same algorithm in Cython (the second patch) and use it for bounding boxes containing <50k points. \n``````\n",
    "created_at": "2011-06-13T04:15:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11429#issuecomment-117778",
    "user": "https://github.com/vbraun"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -10,3 +10,5 @@
     sage: lp.npoints()
   ```
   takes forever with PALP but only 500ms with my Python code.
+
+Comparing timings, it seems that PALP always runs over the integral points of a rectangular bounding box. This is good for small polytopes (low overhead) but bad for large ones. To match PALP's speed for small polytopes, I implemented the same algorithm in Cython (the second patch) and use it for bounding boxes containing <50k points. 
``````




---

archive/issue_comments_117779.json:
```json
{
    "body": "<a id='comment:2'>**Comment 2:**</a>\n**Attachment:** [trac_11429_native_enumeration_of_lattice_polytope_points.patch.gz](https://github.com/sagemath/sage/files/ticket11429/trac_11429_native_enumeration_of_lattice_polytope_points.patch.gz)",
    "created_at": "2011-06-13T04:15:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11429#issuecomment-117779",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:2'>**Comment 2:**</a>
**Attachment:** [trac_11429_native_enumeration_of_lattice_polytope_points.patch.gz](https://github.com/sagemath/sage/files/ticket11429/trac_11429_native_enumeration_of_lattice_polytope_points.patch.gz)



---

archive/issue_comments_117780.json:
```json
{
    "body": "<a id='comment:3'>**Comment 3:**</a>\nThe order of points is different from PALP (unsurprisingly), so doctests needed to be fixed. This is done in the last patch.",
    "created_at": "2011-06-13T05:59:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11429#issuecomment-117780",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:3'>**Comment 3:**</a>
The order of points is different from PALP (unsurprisingly), so doctests needed to be fixed. This is done in the last patch.



---

archive/issue_comments_117781.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -12,3 +12,6 @@\n   takes forever with PALP but only 500ms with my Python code.\n \n Comparing timings, it seems that PALP always runs over the integral points of a rectangular bounding box. This is good for small polytopes (low overhead) but bad for large ones. To match PALP's speed for small polytopes, I implemented the same algorithm in Cython (the second patch) and use it for bounding boxes containing <50k points. \n+\n+\n+Apply trac_11429_native_enumeration_of_lattice_polytope_points.patch, trac_11429_cythonize_lattice_points.patch, trac_11429_fix_doctests.patch\n``````\n",
    "created_at": "2011-06-13T06:00:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11429#issuecomment-117781",
    "user": "https://github.com/vbraun"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -12,3 +12,6 @@
   takes forever with PALP but only 500ms with my Python code.
 
 Comparing timings, it seems that PALP always runs over the integral points of a rectangular bounding box. This is good for small polytopes (low overhead) but bad for large ones. To match PALP's speed for small polytopes, I implemented the same algorithm in Cython (the second patch) and use it for bounding boxes containing <50k points. 
+
+
+Apply trac_11429_native_enumeration_of_lattice_polytope_points.patch, trac_11429_cythonize_lattice_points.patch, trac_11429_fix_doctests.patch
``````




---

archive/issue_comments_117782.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -14,4 +14,7 @@\n Comparing timings, it seems that PALP always runs over the integral points of a rectangular bounding box. This is good for small polytopes (low overhead) but bad for large ones. To match PALP's speed for small polytopes, I implemented the same algorithm in Cython (the second patch) and use it for bounding boxes containing <50k points. \n \n \n-Apply trac_11429_native_enumeration_of_lattice_polytope_points.patch, trac_11429_cythonize_lattice_points.patch, trac_11429_fix_doctests.patch\n+**Apply:**\n+1. [attachment:trac_11429_native_enumeration_of_lattice_polytope_points.patch](https://github.com/sagemath/sage/files/ticket11429/trac_11429_native_enumeration_of_lattice_polytope_points.patch)\n+2. [attachment:trac_11429_cythonize_lattice_points.patch](https://github.com/sagemath/sage/files/ticket11429/trac_11429_cythonize_lattice_points.patch)\n+3. [attachment:trac_11429_fix_doctests.patch](https://github.com/sagemath/sage/files/ticket11429/trac_11429_fix_doctests.patch)\n``````\n",
    "created_at": "2011-06-16T20:10:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11429#issuecomment-117782",
    "user": "https://github.com/novoselt"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -14,4 +14,7 @@
 Comparing timings, it seems that PALP always runs over the integral points of a rectangular bounding box. This is good for small polytopes (low overhead) but bad for large ones. To match PALP's speed for small polytopes, I implemented the same algorithm in Cython (the second patch) and use it for bounding boxes containing <50k points. 
 
 
-Apply trac_11429_native_enumeration_of_lattice_polytope_points.patch, trac_11429_cythonize_lattice_points.patch, trac_11429_fix_doctests.patch
+**Apply:**
+1. [attachment:trac_11429_native_enumeration_of_lattice_polytope_points.patch](https://github.com/sagemath/sage/files/ticket11429/trac_11429_native_enumeration_of_lattice_polytope_points.patch)
+2. [attachment:trac_11429_cythonize_lattice_points.patch](https://github.com/sagemath/sage/files/ticket11429/trac_11429_cythonize_lattice_points.patch)
+3. [attachment:trac_11429_fix_doctests.patch](https://github.com/sagemath/sage/files/ticket11429/trac_11429_fix_doctests.patch)
``````




---

archive/issue_comments_117783.json:
```json
{
    "body": "**Reviewer:** Andrey Novoseltsev",
    "created_at": "2011-06-16T20:10:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11429#issuecomment-117783",
    "user": "https://github.com/novoselt"
}
```

**Reviewer:** Andrey Novoseltsev



---

archive/issue_comments_117784.json:
```json
{
    "body": "**Changing keywords** from \"\" to \"sd31\".",
    "created_at": "2011-06-16T20:10:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11429#issuecomment-117784",
    "user": "https://github.com/novoselt"
}
```

**Changing keywords** from "" to "sd31".



---

archive/issue_comments_117785.json:
```json
{
    "body": "<a id='comment:6'>**Comment 6:**</a>\nRegarding the reuse of objects, there was this ticket which may be related/useful: #8702.",
    "created_at": "2011-06-16T20:23:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11429#issuecomment-117785",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:6'>**Comment 6:**</a>
Regarding the reuse of objects, there was this ticket which may be related/useful: #8702.



---

archive/issue_comments_117786.json:
```json
{
    "body": "<a id='comment:8'>**Comment 8:**</a>\nUpdated patch because of Andrey's documentation changes to #11312.",
    "created_at": "2011-06-18T00:11:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11429#issuecomment-117786",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:8'>**Comment 8:**</a>
Updated patch because of Andrey's documentation changes to #11312.



---

archive/issue_comments_117787.json:
```json
{
    "body": "<a id='comment:9'>**Comment 9:**</a>\nHi Volker,\n\nWould it make any sense to somehow unite these functions/classes with your PPL wrapper, which already has stuff for inequalities and their systems? Do you know if they (PPL-people) have plans on algorithms for point counts and point listing?\n\nThere are also functions without documentation or without full description of input/output...",
    "created_at": "2011-06-25T19:32:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11429#issuecomment-117787",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:9'>**Comment 9:**</a>
Hi Volker,

Would it make any sense to somehow unite these functions/classes with your PPL wrapper, which already has stuff for inequalities and their systems? Do you know if they (PPL-people) have plans on algorithms for point counts and point listing?

There are also functions without documentation or without full description of input/output...



---

archive/issue_events_128200.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2011-06-25T19:32:41Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20algebraic%20geometry",
    "label_color": "08517b",
    "label_name": "component: algebraic geometry",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11429#event-128200"
}
```



---

archive/issue_events_128201.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2011-06-25T19:32:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20geometry",
    "label_color": "08517b",
    "label_name": "component: geometry",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11429#event-128201"
}
```



---

archive/issue_comments_117788.json:
```json
{
    "body": "<a id='comment:10'>**Comment 10:**</a>\nI don't know the PPL future plans, but I don't think that some Cython code would fit into their project. Its also not functionality that fits with their core misson objective, I think.\n\nI haven't used the usual standards of documentation for cdef'd functions since they aren't reachable from Python, so you'll never see the help. Nor can you write Python doctests for them. Also, I think documenting input/output is implicit when you have typed arguments.",
    "created_at": "2011-06-25T20:19:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11429#issuecomment-117788",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:10'>**Comment 10:**</a>
I don't know the PPL future plans, but I don't think that some Cython code would fit into their project. Its also not functionality that fits with their core misson objective, I think.

I haven't used the usual standards of documentation for cdef'd functions since they aren't reachable from Python, so you'll never see the help. Nor can you write Python doctests for them. Also, I think documenting input/output is implicit when you have typed arguments.



---

archive/issue_comments_117789.json:
```json
{
    "body": "<a id='comment:11'>**Comment 11:**</a>\nLine numbers are for the new module in the big patch:\n1. 224: should be `if A is not None:` for robustness (zero matrices evaluate to `False`)\n2. 231: should be `if A is None:`\n3. 273-275: Why there is a conversion to set? Is it expected that the output contains repetitions?\n4. 293: shouldn't `translate_points` be used here?\n5. 336: No description of input/output and what happens if the polyhedron is not specified.\n6. In the code of this function: why is it necessary to use this permutation? It seems like an extra operation on all of the points, although I believe that there is some reason ;-) Perhaps it can be explained in the documentation or comments.\n7. 421: Incomplete INPUT, missing OUTPUT, no real EXAMPLE.\n8. 440: While this function is inaccessible from Sage directly, it still would be nice to have a comment on what it does and what is d.\n9. 477: If I am correct, this condition is always true. In which case it can be removed, as well the next line, and 444 moved into the beginning of outer while. (Just for making code a little simpler.)\n10. I didn't yet looked carefully at the rest, but just one more pick at 575: Is it really necessary to have `DEF INEQ_INT_MAX_DIM = 20`? I mean can't it be without hard-coded limits?\n\nWill look over the second half of the new module in the next few days, I am fine with the rest of the code.\n\nSpeedwise PALP is still more efficient for small polytopes, but of course only if one can call PALP at once for a lot of them, which is not always possible:\n\n```\nsage: len(ReflexivePolytopes(3))\n4319\nsage: %time\nsage: ps = [Polyhedron(vertices=p.vertices().columns()) for p in ReflexivePolytopes(3)]\nCPU time: 83.87 s,  Wall time: 218.85 s\nsage: %time\nsage: for p, lp in zip(ps, ReflexivePolytopes(3)):                                    \n...       if len(p.integral_points()) != lp.npoints():\n...           print lp\nCPU time: 10.10 s,  Wall time: 10.30 s\nsage: %time\nsage: lattice_polytope.all_points(ReflexivePolytopes(3))\nCPU time: 2.90 s,  Wall time: 3.46 s\n```\nThe last line is actually somewhat sad: PALP spends half a second to compute all the points and then Sage spends 3 seconds to read its output and convert into matrices. But hopefully objects of new generations will be more efficient ;-)",
    "created_at": "2011-06-29T02:51:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11429#issuecomment-117789",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:11'>**Comment 11:**</a>
Line numbers are for the new module in the big patch:
1. 224: should be `if A is not None:` for robustness (zero matrices evaluate to `False`)
2. 231: should be `if A is None:`
3. 273-275: Why there is a conversion to set? Is it expected that the output contains repetitions?
4. 293: shouldn't `translate_points` be used here?
5. 336: No description of input/output and what happens if the polyhedron is not specified.
6. In the code of this function: why is it necessary to use this permutation? It seems like an extra operation on all of the points, although I believe that there is some reason ;-) Perhaps it can be explained in the documentation or comments.
7. 421: Incomplete INPUT, missing OUTPUT, no real EXAMPLE.
8. 440: While this function is inaccessible from Sage directly, it still would be nice to have a comment on what it does and what is d.
9. 477: If I am correct, this condition is always true. In which case it can be removed, as well the next line, and 444 moved into the beginning of outer while. (Just for making code a little simpler.)
10. I didn't yet looked carefully at the rest, but just one more pick at 575: Is it really necessary to have `DEF INEQ_INT_MAX_DIM = 20`? I mean can't it be without hard-coded limits?

Will look over the second half of the new module in the next few days, I am fine with the rest of the code.

Speedwise PALP is still more efficient for small polytopes, but of course only if one can call PALP at once for a lot of them, which is not always possible:

```
sage: len(ReflexivePolytopes(3))
4319
sage: %time
sage: ps = [Polyhedron(vertices=p.vertices().columns()) for p in ReflexivePolytopes(3)]
CPU time: 83.87 s,  Wall time: 218.85 s
sage: %time
sage: for p, lp in zip(ps, ReflexivePolytopes(3)):                                    
...       if len(p.integral_points()) != lp.npoints():
...           print lp
CPU time: 10.10 s,  Wall time: 10.30 s
sage: %time
sage: lattice_polytope.all_points(ReflexivePolytopes(3))
CPU time: 2.90 s,  Wall time: 3.46 s
```
The last line is actually somewhat sad: PALP spends half a second to compute all the points and then Sage spends 3 seconds to read its output and convert into matrices. But hopefully objects of new generations will be more efficient ;-)



---

archive/issue_comments_117790.json:
```json
{
    "body": "<a id='comment:12'>**Comment 12:**</a>\n3. I added a `len(pts)` to the `len(set(pts))` to clarify - the doctests checks that all points are distinct.\n   6. The coordinates are permuted such that the largest edge of the bounding  box becomes the inner loop. The inner loop is optimized to run very fast, so we save wall time by doing the maximal amount of work there.\n   9. No `inc` will usually be `1`. Usually you'll only have to call `prepare_inner_loop` between two inner loops. Only if the \"odometer ticks over\" you need to call `prepare_next_to_inner_loop`. In terms of the coordinates `(x1,x2,x3,...)` of the box, the inner loop runs over `x1`. It suffices to only call `prepare_inner_loop` as long as only `x1`, `x2` change. You need to call `prepare_next_to_inner_loop` if more coordinates changed from one inner loop to the next. \n   10. The dimension limit is only used for the machine integer representation of inequalities. Its not a real limit, in higher dimensions the generic Python implementation is used.\n\nThere is some overhead to avoid integer overflows and the like, which is a good thing. Possible improvements are\n- don't permute coordinates (overhead) for really really small polyhedra, and\n- allow to just count points without enumeration (since we already find upper/lower bound in inner loop).",
    "created_at": "2011-06-29T19:20:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11429#issuecomment-117790",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:12'>**Comment 12:**</a>
3. I added a `len(pts)` to the `len(set(pts))` to clarify - the doctests checks that all points are distinct.
   6. The coordinates are permuted such that the largest edge of the bounding  box becomes the inner loop. The inner loop is optimized to run very fast, so we save wall time by doing the maximal amount of work there.
   9. No `inc` will usually be `1`. Usually you'll only have to call `prepare_inner_loop` between two inner loops. Only if the "odometer ticks over" you need to call `prepare_next_to_inner_loop`. In terms of the coordinates `(x1,x2,x3,...)` of the box, the inner loop runs over `x1`. It suffices to only call `prepare_inner_loop` as long as only `x1`, `x2` change. You need to call `prepare_next_to_inner_loop` if more coordinates changed from one inner loop to the next. 
   10. The dimension limit is only used for the machine integer representation of inequalities. Its not a real limit, in higher dimensions the generic Python implementation is used.

There is some overhead to avoid integer overflows and the like, which is a good thing. Possible improvements are
- don't permute coordinates (overhead) for really really small polyhedra, and
- allow to just count points without enumeration (since we already find upper/lower bound in inner loop).



---

archive/issue_comments_117791.json:
```json
{
    "body": "<a id='comment:13'>**Comment 13:**</a>\nUpdated patch fixes the remaining points of [comment:11](#comment%3A11)",
    "created_at": "2011-06-29T19:21:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11429#issuecomment-117791",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:13'>**Comment 13:**</a>
Updated patch fixes the remaining points of [comment:11](#comment%3A11)



---

archive/issue_comments_117792.json:
```json
{
    "body": "**Attachment:** [trac_11429_fix_doctests.patch.gz](https://github.com/sagemath/sage/files/ticket11429/trac_11429_fix_doctests.patch.gz)\n\nRebased patch",
    "created_at": "2011-12-15T22:24:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11429#issuecomment-117792",
    "user": "https://github.com/vbraun"
}
```

**Attachment:** [trac_11429_fix_doctests.patch.gz](https://github.com/sagemath/sage/files/ticket11429/trac_11429_fix_doctests.patch.gz)

Rebased patch



---

archive/issue_comments_117793.json:
```json
{
    "body": "<a id='comment:14'>**Comment 14:**</a>\nLast small picks, lines again refer to the new module in the big patch:\n1. 483: Looks like something was not pasted.\n2. 720: If it is indeed necessary to check if the dimension is less than 1, perhaps a different error message is in order?\n3. 912: A perhaps naive question: wouldn't it be more efficient to work in an affine span of the polytope if there are equations? (If yes, I don't insist on doing it, but a \"todo\" note could be nice.)",
    "created_at": "2012-01-10T06:36:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11429#issuecomment-117793",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:14'>**Comment 14:**</a>
Last small picks, lines again refer to the new module in the big patch:
1. 483: Looks like something was not pasted.
2. 720: If it is indeed necessary to check if the dimension is less than 1, perhaps a different error message is in order?
3. 912: A perhaps naive question: wouldn't it be more efficient to work in an affine span of the polytope if there are equations? (If yes, I don't insist on doing it, but a "todo" note could be nice.)



---

archive/issue_comments_117794.json:
```json
{
    "body": "<a id='comment:15'>**Comment 15:**</a>\n1. The `permuted_list()` function was just a leftover that I forgot to delete. \n   2. The `OverflowError` is caught internally and the generic version (as opposed to the optimized machine int version) is used. So the user never gets to see the error message.\n   3. There is definitely room for improvement for special lattice polytopes. But for really small lattice polytopes I think the naive thing is faster than doing linear algebra for the affine span.",
    "created_at": "2012-01-10T15:10:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11429#issuecomment-117794",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:15'>**Comment 15:**</a>
1. The `permuted_list()` function was just a leftover that I forgot to delete. 
   2. The `OverflowError` is caught internally and the generic version (as opposed to the optimized machine int version) is used. So the user never gets to see the error message.
   3. There is definitely room for improvement for special lattice polytopes. But for really small lattice polytopes I think the naive thing is faster than doing linear algebra for the affine span.



---

archive/issue_events_128202.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2012-01-10T15:41:06Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11429#event-128202"
}
```



---

archive/issue_events_128203.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2012-01-10T15:41:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11429#event-128203"
}
```



---

archive/issue_comments_117795.json:
```json
{
    "body": "<a id='comment:16'>**Comment 16:**</a>\nOK, positive review!\n\nWith deep apollogies for the duration of \"the next few days\"...",
    "created_at": "2012-01-10T15:41:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11429#issuecomment-117795",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:16'>**Comment 16:**</a>
OK, positive review!

With deep apollogies for the duration of "the next few days"...



---

archive/issue_events_128204.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-01-10T22:33:15Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "milestone_number": null,
    "milestone_title": "sage-4.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11429#event-128204"
}
```



---

archive/issue_events_128205.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-01-10T22:33:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "milestone_number": null,
    "milestone_title": "sage-5.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11429#event-128205"
}
```



---

archive/issue_comments_117796.json:
```json
{
    "body": "<a id='comment:18'>**Comment 18:**</a>\nWhen running this with Python-2.7.2 (#9958), there is a doctest failure:\n\n```\nsage -t  -force_lib devel/sage/sage/geometry/integral_points.pyx\n**********************************************************************\nFile \"/mnt/usb1/scratch/jdemeyer/merger/sage-5.0.beta1/devel/sage-main/sage/geometry/integral_points.pyx\", line 668:\n    sage: Inequality_int([2,3,7], -5*10^50, [10]*3)\nExpected:\n    Traceback (most recent call last):\n    ...\n    OverflowError: long int too large to convert to int\nGot:\n    Traceback (most recent call last):\n      File \"/mnt/usb1/scratch/jdemeyer/merger/sage-5.0.beta1/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/mnt/usb1/scratch/jdemeyer/merger/sage-5.0.beta1/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/mnt/usb1/scratch/jdemeyer/merger/sage-5.0.beta1/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_14[7]>\", line 1, in <module>\n        Inequality_int([Integer(2),Integer(3),Integer(7)], -Integer(5)*Integer(10)**Integer(50), [Integer(10)]*Integer(3))###line 668:\n    sage: Inequality_int([2,3,7], -5*10^50, [10]*3)\n      File \"integral_points.pyx\", line 705, in sage.geometry.integral_points.Inequality_int.__cinit__ (sage/geometry/integral_points.c:495\n0)\n        self.b = self._to_int(b)\n      File \"integral_points.pyx\", line 685, in sage.geometry.integral_points.Inequality_int._to_int (sage/geometry/integral_points.c:4765)\n        return int(x)  # raises OverflowError in Cython if necessary\n    OverflowError: Python int too large to convert to C long\n**********************************************************************\n```\nSince Python-2.7 will surely be merged in sage-5.0.beta0, you should fix the error message.",
    "created_at": "2012-01-19T15:44:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11429#issuecomment-117796",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'>**Comment 18:**</a>
When running this with Python-2.7.2 (#9958), there is a doctest failure:

```
sage -t  -force_lib devel/sage/sage/geometry/integral_points.pyx
**********************************************************************
File "/mnt/usb1/scratch/jdemeyer/merger/sage-5.0.beta1/devel/sage-main/sage/geometry/integral_points.pyx", line 668:
    sage: Inequality_int([2,3,7], -5*10^50, [10]*3)
Expected:
    Traceback (most recent call last):
    ...
    OverflowError: long int too large to convert to int
Got:
    Traceback (most recent call last):
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-5.0.beta1/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-5.0.beta1/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-5.0.beta1/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_14[7]>", line 1, in <module>
        Inequality_int([Integer(2),Integer(3),Integer(7)], -Integer(5)*Integer(10)**Integer(50), [Integer(10)]*Integer(3))###line 668:
    sage: Inequality_int([2,3,7], -5*10^50, [10]*3)
      File "integral_points.pyx", line 705, in sage.geometry.integral_points.Inequality_int.__cinit__ (sage/geometry/integral_points.c:495
0)
        self.b = self._to_int(b)
      File "integral_points.pyx", line 685, in sage.geometry.integral_points.Inequality_int._to_int (sage/geometry/integral_points.c:4765)
        return int(x)  # raises OverflowError in Cython if necessary
    OverflowError: Python int too large to convert to C long
**********************************************************************
```
Since Python-2.7 will surely be merged in sage-5.0.beta0, you should fix the error message.



---

archive/issue_events_128206.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-01-19T15:44:59Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11429#event-128206"
}
```



---

archive/issue_events_128207.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-01-19T15:44:59Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11429#event-128207"
}
```



---

archive/issue_comments_117797.json:
```json
{
    "body": "**Changing dependencies** from \"#11312\" to \"#11312, #9958\".",
    "created_at": "2012-01-19T15:44:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11429#issuecomment-117797",
    "user": "https://github.com/jdemeyer"
}
```

**Changing dependencies** from "#11312" to "#11312, #9958".



---

archive/issue_comments_117798.json:
```json
{
    "body": "<a id='comment:19'>**Comment 19:**</a>\nBy the way: #9958 suggests the error message *might* be different on 32-bit and 64-bit systems.",
    "created_at": "2012-01-19T15:52:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11429#issuecomment-117798",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:19'>**Comment 19:**</a>
By the way: #9958 suggests the error message *might* be different on 32-bit and 64-bit systems.



---

archive/issue_comments_117799.json:
```json
{
    "body": "Updated patch",
    "created_at": "2012-01-19T17:50:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11429#issuecomment-117799",
    "user": "https://github.com/vbraun"
}
```

Updated patch



---

archive/issue_events_128208.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2012-01-19T17:51:41Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11429#event-128208"
}
```



---

archive/issue_events_128209.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2012-01-19T17:51:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11429#event-128209"
}
```



---

archive/issue_comments_117800.json:
```json
{
    "body": "<a id='comment:20'>**Comment 20:**</a>\n**Attachment:** [trac_11429_cythonize_lattice_points.patch.gz](https://github.com/sagemath/sage/files/ticket11429/trac_11429_cythonize_lattice_points.patch.gz)\n\nI've modified the doctest to only expect `OverflowError: ...` instead of a particular message.",
    "created_at": "2012-01-19T17:51:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11429#issuecomment-117800",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:20'>**Comment 20:**</a>
**Attachment:** [trac_11429_cythonize_lattice_points.patch.gz](https://github.com/sagemath/sage/files/ticket11429/trac_11429_cythonize_lattice_points.patch.gz)

I've modified the doctest to only expect `OverflowError: ...` instead of a particular message.



---

archive/issue_comments_117801.json:
```json
{
    "body": "**Changing reviewer** from \"Andrey Novoseltsev\" to \"Andrey Novoseltsev, Jeroen Demeyer\".",
    "created_at": "2012-01-19T18:55:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11429#issuecomment-117801",
    "user": "https://github.com/jdemeyer"
}
```

**Changing reviewer** from "Andrey Novoseltsev" to "Andrey Novoseltsev, Jeroen Demeyer".



---

archive/issue_comments_117802.json:
```json
{
    "body": "<a id='comment:21'>**Comment 21:**</a>\nReplying to [@vbraun](#comment%3A20):\n> I've modified the doctest to only expect `OverflowError: ...` instead of a particular message.\n\nI haven't yet tested it, but this should fix the issue.",
    "created_at": "2012-01-19T18:55:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11429#issuecomment-117802",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'>**Comment 21:**</a>
Replying to [@vbraun](#comment%3A20):
> I've modified the doctest to only expect `OverflowError: ...` instead of a particular message.

I haven't yet tested it, but this should fix the issue.



---

archive/issue_events_128210.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-01-19T18:55:19Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11429#event-128210"
}
```



---

archive/issue_events_128211.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-01-19T18:55:19Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11429#event-128211"
}
```



---

archive/issue_comments_117803.json:
```json
{
    "body": "**Merged:** sage-5.0.beta2",
    "created_at": "2012-01-29T11:17:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11429#issuecomment-117803",
    "user": "https://github.com/jdemeyer"
}
```

**Merged:** sage-5.0.beta2



---

archive/issue_events_128212.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-01-29T11:17:33Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11429#event-128212"
}
```



---

archive/issue_events_128213.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-01-29T11:17:33Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/11429",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11429#event-128213"
}
```
