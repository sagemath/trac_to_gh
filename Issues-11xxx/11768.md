# Issue 11768: Get source code for parent/element classes of categories

archive/issues_011596.json:
```json
{
    "assignees": [],
    "body": "Currently (sage-4.7.2.alpha2) one can not interactively get the source code of the parent or element classes of a category:\n\n```\nsage: C.parent_class??\nType:           DynamicMetaclass\nBase Class:     <class 'sage.structure.dynamic_class.DynamicMetaclass'>\nString Form:    <class 'sage.categories.rings.Rings.parent_class'>\nNamespace:      Interactive\nFile:           /mnt/local/king/SAGE/sage-4.7.2.alpha1/local/lib/python2.6/site-packages/sage/categories/rings.py\nSource:\nclass DynamicMetaclass(type):\n    \"\"\"\n    A metaclass implementing an appropriate reduce-by-construction method\n    \"\"\"\n\n    def __reduce__(self):\n        \"\"\"\n        See sage.structure.dynamic_class.dynamic_class? for non trivial tests.\n\n        TESTS::\n\n...\n```\n\nAs one can see, it gets the source file right, but can not find the class definition in it.\n\nI tried to track it down.\n\n* For a dynamic metaclass, we want to obtain the documentation and source of the base class (resp. the class that is passed too the dynamic metaclass by the `doccls` argument).\n* The module is correctly provided, and thus Python's inspect module is able to find the source file.\n* If it is a class then Python's inspect module tries to find something like `\"class \"+cls.__name__+\":\"` in the sources (they use a more sophisticated regular expression).\n* The base class is `Rings().ParentMethods`. Unfortunately, it is defined by `class ParentMethods`, but the name is differently:\n\n ```\n sage: Rings().ParentMethods.__name__\n 'Rings.ParentMethods'\n ```\n\nI do not suggest to change the name: If the name is just `'ParentMethods'` then Python's inspect module would always find the first occurence of that name, which is bad if one module defines several categories.\n\nInstead, I suggest to create a new function in `sage.misc.sageinspect` that recursively finds the sources for classes whose sources can't be found by other methods and whose name contains a dot:\n\nThe function that I plan to write does not start with the whole source file of `sage.categories.rings`, but it starts with the sources of `sage.categories.rings.Rings` and then searches `class ParentMethods` (with the regular expression from the inspect module) only in that small part of the full source file.\n\nI think \"getting sources\" belongs to the component \"misc\", even though the problem is  relevant for not getting confused by the category framework. Thus, cc to Nicolas...\n\n**__Apply__**\n\n* [attachment:trac11768_source_of_dynamic_class.patch](https://github.com/sagemath/sage/files/ticket11768/trac11768_source_of_dynamic_class.patch)\n\n\n**Assignee:** @jasongrout\n\n**CC:**  @nthiery @hivert\n\n**Keywords:** sources dynamic class\n\n**Reviewer:** Volker Braun\n\n**Author:** Simon King\n\n**Merged:** sage-5.6.beta1\n\nIssue created by migration from https://trac.sagemath.org/ticket/11768\n\n",
    "closed_at": "2012-12-21T09:30:48Z",
    "created_at": "2011-09-01T08:20:41Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20misc",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.6",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Get source code for parent/element classes of categories",
    "type": "issue",
    "updated_at": "2012-12-21T09:30:48Z",
    "url": "https://github.com/sagemath/sage/issues/11768",
    "user": "https://github.com/simon-king-jena"
}
```
Currently (sage-4.7.2.alpha2) one can not interactively get the source code of the parent or element classes of a category:

```
sage: C.parent_class??
Type:           DynamicMetaclass
Base Class:     <class 'sage.structure.dynamic_class.DynamicMetaclass'>
String Form:    <class 'sage.categories.rings.Rings.parent_class'>
Namespace:      Interactive
File:           /mnt/local/king/SAGE/sage-4.7.2.alpha1/local/lib/python2.6/site-packages/sage/categories/rings.py
Source:
class DynamicMetaclass(type):
    """
    A metaclass implementing an appropriate reduce-by-construction method
    """

    def __reduce__(self):
        """
        See sage.structure.dynamic_class.dynamic_class? for non trivial tests.

        TESTS::

...
```

As one can see, it gets the source file right, but can not find the class definition in it.

I tried to track it down.

* For a dynamic metaclass, we want to obtain the documentation and source of the base class (resp. the class that is passed too the dynamic metaclass by the `doccls` argument).
* The module is correctly provided, and thus Python's inspect module is able to find the source file.
* If it is a class then Python's inspect module tries to find something like `"class "+cls.__name__+":"` in the sources (they use a more sophisticated regular expression).
* The base class is `Rings().ParentMethods`. Unfortunately, it is defined by `class ParentMethods`, but the name is differently:

 ```
 sage: Rings().ParentMethods.__name__
 'Rings.ParentMethods'
 ```

I do not suggest to change the name: If the name is just `'ParentMethods'` then Python's inspect module would always find the first occurence of that name, which is bad if one module defines several categories.

Instead, I suggest to create a new function in `sage.misc.sageinspect` that recursively finds the sources for classes whose sources can't be found by other methods and whose name contains a dot:

The function that I plan to write does not start with the whole source file of `sage.categories.rings`, but it starts with the sources of `sage.categories.rings.Rings` and then searches `class ParentMethods` (with the regular expression from the inspect module) only in that small part of the full source file.

I think "getting sources" belongs to the component "misc", even though the problem is  relevant for not getting confused by the category framework. Thus, cc to Nicolas...

**__Apply__**

* [attachment:trac11768_source_of_dynamic_class.patch](https://github.com/sagemath/sage/files/ticket11768/trac11768_source_of_dynamic_class.patch)


**Assignee:** @jasongrout

**CC:**  @nthiery @hivert

**Keywords:** sources dynamic class

**Reviewer:** Volker Braun

**Author:** Simon King

**Merged:** sage-5.6.beta1

Issue created by migration from https://trac.sagemath.org/ticket/11768





---

archive/issue_comments_124815.json:
```json
{
    "body": "<a id='comment:1'></a>\nThe patch works exactly as it is announced in the ticket description. One can now (on top of sage-4.7.2.alpha2) do:\n\n```\nsage: C = Rings()\nsage: from sage.misc.sageinspect import sage_getsource\nsage: print sage_getsource(C.parent_class)  #indirect doctest\nclass ParentMethods:\n    def is_field(self):\n        raise NotImplementedError\n<BLANKLINE>\n    def bracket(self, x, y):\n...\n```\n\nUnfortunately,\n\n```\nsage: P = JackPolynomialsP(QQ); P.rename(\"JackP\")\nsage: P.element_class??\n```\ndoes not work yet. So, the search for definitions should also include the `__base__` attribute of a class.",
    "created_at": "2011-09-01T10:08:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124815",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:1'></a>
The patch works exactly as it is announced in the ticket description. One can now (on top of sage-4.7.2.alpha2) do:

```
sage: C = Rings()
sage: from sage.misc.sageinspect import sage_getsource
sage: print sage_getsource(C.parent_class)  #indirect doctest
class ParentMethods:
    def is_field(self):
        raise NotImplementedError
<BLANKLINE>
    def bracket(self, x, y):
...
```

Unfortunately,

```
sage: P = JackPolynomialsP(QQ); P.rename("JackP")
sage: P.element_class??
```
does not work yet. So, the search for definitions should also include the `__base__` attribute of a class.



---

archive/issue_comments_124816.json:
```json
{
    "body": "**Author:** Simon King",
    "created_at": "2011-09-01T10:52:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124816",
    "user": "https://github.com/simon-king-jena"
}
```

**Author:** Simon King



---

archive/issue_events_094132.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2011-09-01T10:52:47Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11768#event-94132"
}
```



---

archive/issue_comments_124817.json:
```json
{
    "body": "<a id='comment:2'></a>\nIt seems to me that things are fine now.\n\nIn particular, we have\n\n```\nsage: C = Rings()\nsage: C.parent_class??\nType:           DynamicMetaclass\nBase Class:     <class 'sage.structure.dynamic_class.DynamicMetaclass'>\nString Form:    <class 'sage.categories.rings.Rings.parent_class'>\nNamespace:      Interactive\nFile:           /mnt/local/king/SAGE/sage-4.7.2.alpha1/local/lib/python2.6/site-packages/sage/categories/rings.py\nSource:\n    class ParentMethods:\n        def is_field(self):\n            raise NotImplementedError\n\n        def bracket(self, x, y):\n...\nsage: P = JackPolynomialsP(QQ)\nsage: P.element_class??\nType:           DynamicMetaclass\nBase Class:     <class 'sage.structure.dynamic_class.DynamicMetaclass'>\nString Form:    <class 'sage.combinat.sf.jack.JackPolynomials_p_with_category.element_class'>\nNamespace:      Interactive\nFile:           /mnt/local/king/SAGE/sage-4.7.2.alpha1/local/lib/python2.6/site-packages/sage/combinat/sf/jack.py\nDefinition:     P.element_class(self, x, include=None, exclude=None)\nSource:\nclass SymmetricFunctionAlgebra_generic_Element(CombinatorialFreeModule.Element):\n    def __repr__(self):\n        \"\"\"\n        EXAMPLES::\n\n            sage: m = SFAMonomial(QQ)\n...\nsage: P.<x,y> = QQ[]\nsage: I = P*[x,y]\nsage: I??\nType:           MPolynomialIdeal\nBase Class:     <class 'sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal'>\nString Form:    Ideal (x, y) of Multivariate Polynomial Ring in x, y over Rational Field\nNamespace:      Interactive\nFile:           /mnt/local/king/SAGE/sage-4.7.2.alpha1/local/lib/python2.6/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py\nSource:\nclass MPolynomialIdeal( MPolynomialIdeal_singular_repr, \\\n                        MPolynomialIdeal_macaulay2_repr, \\\n                        MPolynomialIdeal_magma_repr, \\\n                        Ideal_generic ):\n    def __init__(self, ring, gens, coerce=True):\n        r\"\"\"\n        Create an ideal in a multivariate polynomial ring.\n...\n```\n\nAll three examples are doctested (via `sage_getsourcelines`). So, ready for review!",
    "created_at": "2011-09-01T10:52:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124817",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:2'></a>
It seems to me that things are fine now.

In particular, we have

```
sage: C = Rings()
sage: C.parent_class??
Type:           DynamicMetaclass
Base Class:     <class 'sage.structure.dynamic_class.DynamicMetaclass'>
String Form:    <class 'sage.categories.rings.Rings.parent_class'>
Namespace:      Interactive
File:           /mnt/local/king/SAGE/sage-4.7.2.alpha1/local/lib/python2.6/site-packages/sage/categories/rings.py
Source:
    class ParentMethods:
        def is_field(self):
            raise NotImplementedError

        def bracket(self, x, y):
...
sage: P = JackPolynomialsP(QQ)
sage: P.element_class??
Type:           DynamicMetaclass
Base Class:     <class 'sage.structure.dynamic_class.DynamicMetaclass'>
String Form:    <class 'sage.combinat.sf.jack.JackPolynomials_p_with_category.element_class'>
Namespace:      Interactive
File:           /mnt/local/king/SAGE/sage-4.7.2.alpha1/local/lib/python2.6/site-packages/sage/combinat/sf/jack.py
Definition:     P.element_class(self, x, include=None, exclude=None)
Source:
class SymmetricFunctionAlgebra_generic_Element(CombinatorialFreeModule.Element):
    def __repr__(self):
        """
        EXAMPLES::

            sage: m = SFAMonomial(QQ)
...
sage: P.<x,y> = QQ[]
sage: I = P*[x,y]
sage: I??
Type:           MPolynomialIdeal
Base Class:     <class 'sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal'>
String Form:    Ideal (x, y) of Multivariate Polynomial Ring in x, y over Rational Field
Namespace:      Interactive
File:           /mnt/local/king/SAGE/sage-4.7.2.alpha1/local/lib/python2.6/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py
Source:
class MPolynomialIdeal( MPolynomialIdeal_singular_repr, \
                        MPolynomialIdeal_macaulay2_repr, \
                        MPolynomialIdeal_magma_repr, \
                        Ideal_generic ):
    def __init__(self, ring, gens, coerce=True):
        r"""
        Create an ideal in a multivariate polynomial ring.
...
```

All three examples are doctested (via `sage_getsourcelines`). So, ready for review!



---

archive/issue_comments_124818.json:
```json
{
    "body": "<a id='comment:3'></a>\nPerhaps it would work to get it in sage-4.7.2, not only sage-5.0?",
    "created_at": "2011-09-01T10:53:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124818",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:3'></a>
Perhaps it would work to get it in sage-4.7.2, not only sage-5.0?



---

archive/issue_events_094133.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2011-09-01T10:53:32Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "milestone_number": null,
    "milestone_title": "sage-5.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11768#event-94133"
}
```



---

archive/issue_events_094134.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2011-09-01T10:53:32Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "milestone_number": null,
    "milestone_title": "sage-4.7.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11768#event-94134"
}
```



---

archive/issue_comments_124819.json:
```json
{
    "body": "<a id='comment:4'></a>\nI just found one thing that doesn't work, yet.\n\nWith\n\n```\nsage: C = Rings()\nsage: HC = C.hom_category()\n```\nneither `HC??` nor `edit(HC,'vim')` do what one would wish.",
    "created_at": "2011-09-01T11:42:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124819",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:4'></a>
I just found one thing that doesn't work, yet.

With

```
sage: C = Rings()
sage: HC = C.hom_category()
```
neither `HC??` nor `edit(HC,'vim')` do what one would wish.



---

archive/issue_events_094135.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2011-09-01T11:42:13Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11768#event-94135"
}
```



---

archive/issue_events_094136.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2011-09-01T11:42:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11768#event-94136"
}
```



---

archive/issue_events_094137.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2011-09-01T12:05:32Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11768#event-94137"
}
```



---

archive/issue_events_094138.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2011-09-01T12:05:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11768#event-94138"
}
```



---

archive/issue_comments_124820.json:
```json
{
    "body": "<a id='comment:5'></a>\nIntrospection of `Rings().hom_category()` works and is doctested with the updated patch. Back to \"needs review\".",
    "created_at": "2011-09-01T12:05:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124820",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:5'></a>
Introspection of `Rings().hom_category()` works and is doctested with the updated patch. Back to "needs review".



---

archive/issue_comments_124821.json:
```json
{
    "body": "<a id='comment:6'></a>\nHi Simon!\n\nDefinitely +1 on the feature! Thanks! \n\nI had a quick look at the implementation, and it sounds reasonable, though I do not yet have an opinion yet. Any sageinspect expert around?",
    "created_at": "2011-09-01T19:55:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124821",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:6'></a>
Hi Simon!

Definitely +1 on the feature! Thanks! 

I had a quick look at the implementation, and it sounds reasonable, though I do not yet have an opinion yet. Any sageinspect expert around?



---

archive/issue_comments_124822.json:
```json
{
    "body": "<a id='comment:7'></a>\nI'm also +1 on the feature. I just want point out the following trap. With double class nesting the name mangling is currently incorrect (see #9107). Unfortunately, I won't have time to work on it (ping Nicolas ;-). There is a patch in combinat's queue ( trac_9107-nested_class_bug-fh.patch) which experiment on what is happening.",
    "created_at": "2011-09-02T11:45:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124822",
    "user": "https://github.com/hivert"
}
```

<a id='comment:7'></a>
I'm also +1 on the feature. I just want point out the following trap. With double class nesting the name mangling is currently incorrect (see #9107). Unfortunately, I won't have time to work on it (ping Nicolas ;-). There is a patch in combinat's queue ( trac_9107-nested_class_bug-fh.patch) which experiment on what is happening.



---

archive/issue_comments_124823.json:
```json
{
    "body": "<a id='comment:8'></a>\nHi Florent,\n\nThank you for pointing to the other ticket! #9107 seems quite mysterious to me. Clearly, in the example exposed there, my way to get to the sources would fail. Of course, the current way would fail even more...",
    "created_at": "2011-09-02T15:12:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124823",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:8'></a>
Hi Florent,

Thank you for pointing to the other ticket! #9107 seems quite mysterious to me. Clearly, in the example exposed there, my way to get to the sources would fail. Of course, the current way would fail even more...



---

archive/issue_comments_124824.json:
```json
{
    "body": "<a id='comment:9'></a>\nFails to apply to vanilla sage-4.7.2.alpha2. Dependencies?",
    "created_at": "2011-09-19T09:37:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124824",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:9'></a>
Fails to apply to vanilla sage-4.7.2.alpha2. Dependencies?



---

archive/issue_comments_124825.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [@vbraun](#comment%3A9):\n> Fails to apply to vanilla sage-4.7.2.alpha2. Dependencies?\n\nActually I don't know (I don't remember that I had anything else added when I worked on the patch). But it should apply to sage-4.7.2.alpha3-prerelease.",
    "created_at": "2011-09-19T09:46:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124825",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:10'></a>
Replying to [@vbraun](#comment%3A9):
> Fails to apply to vanilla sage-4.7.2.alpha2. Dependencies?

Actually I don't know (I don't remember that I had anything else added when I worked on the patch). But it should apply to sage-4.7.2.alpha3-prerelease.



---

archive/issue_comments_124826.json:
```json
{
    "body": "<a id='comment:11'></a>\nDo you really start with vanilla sage-4.7.2.alpha2? I just tested, and I have (sorry for the German):\n\n```\nking@mpc622:/mnt/local/king/SAGE/debug/sage-4.7.2.alpha2/devel/sage$ hg qimport https://github.com/sagemath/sage/files/ticket11768/trac11768_source_of_dynamic_class.patch.gz\nF\u00fcge trac11768_source_of_dynamic_class.patch zur Seriendatei hinzu\nking@mpc622:/mnt/local/king/SAGE/debug/sage-4.7.2.alpha2/devel/sage$ hg qpush\nWende trac11768_source_of_dynamic_class.patch an\njetzt bei: trac11768_source_of_dynamic_class.patch\nking@mpc622:/mnt/local/king/SAGE/debug/sage-4.7.2.alpha2/devel/sage$ hg qapplied \ntrac11768_source_of_dynamic_class.patch\n```\n\nSo, it *does* apply to vanilla sage-4.7.2.alpha2 without fuzz.",
    "created_at": "2011-09-19T09:55:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124826",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:11'></a>
Do you really start with vanilla sage-4.7.2.alpha2? I just tested, and I have (sorry for the German):

```
king@mpc622:/mnt/local/king/SAGE/debug/sage-4.7.2.alpha2/devel/sage$ hg qimport https://github.com/sagemath/sage/files/ticket11768/trac11768_source_of_dynamic_class.patch.gz
FÃ¼ge trac11768_source_of_dynamic_class.patch zur Seriendatei hinzu
king@mpc622:/mnt/local/king/SAGE/debug/sage-4.7.2.alpha2/devel/sage$ hg qpush
Wende trac11768_source_of_dynamic_class.patch an
jetzt bei: trac11768_source_of_dynamic_class.patch
king@mpc622:/mnt/local/king/SAGE/debug/sage-4.7.2.alpha2/devel/sage$ hg qapplied 
trac11768_source_of_dynamic_class.patch
```

So, it *does* apply to vanilla sage-4.7.2.alpha2 without fuzz.



---

archive/issue_comments_124827.json:
```json
{
    "body": "<a id='comment:12'></a>\nSorry, you are right. It does apply. Must have forgotten to pop all patches %-)",
    "created_at": "2011-09-19T10:47:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124827",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:12'></a>
Sorry, you are right. It does apply. Must have forgotten to pop all patches %-)



---

archive/issue_comments_124828.json:
```json
{
    "body": "<a id='comment:13'></a>\nWhat is the patchbot complaining about? It states that it fails to apply, but I find it is fine with 4.7.2-alpha3-prerelease.",
    "created_at": "2011-09-30T08:02:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124828",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:13'></a>
What is the patchbot complaining about? It states that it fails to apply, but I find it is fine with 4.7.2-alpha3-prerelease.



---

archive/issue_comments_124829.json:
```json
{
    "body": "<a id='comment:14'></a>\nAny reviewer for that ticket? I think introspection is a nice thing to have in more generality...",
    "created_at": "2011-10-26T19:08:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124829",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:14'></a>
Any reviewer for that ticket? I think introspection is a nice thing to have in more generality...



---

archive/issue_events_094139.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2011-10-29T06:35:17Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11768#event-94139"
}
```



---

archive/issue_events_094140.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2011-10-29T06:35:17Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11768#event-94140"
}
```



---

archive/issue_comments_124830.json:
```json
{
    "body": "**Work Issues:** Make it independent of #11900",
    "created_at": "2011-10-29T06:35:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124830",
    "user": "https://github.com/simon-king-jena"
}
```

**Work Issues:** Make it independent of #11900



---

archive/issue_comments_124831.json:
```json
{
    "body": "<a id='comment:15'></a>\nIt turns out that a combination of this ticket with #11900 yields a problem. I'll try to rewrite the patch here, so that it doesn't matter whether #11900 is applied or not.",
    "created_at": "2011-10-29T06:35:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124831",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:15'></a>
It turns out that a combination of this ticket with #11900 yields a problem. I'll try to rewrite the patch here, so that it doesn't matter whether #11900 is applied or not.



---

archive/issue_comments_124832.json:
```json
{
    "body": "<a id='comment:16'></a>\nDone! Using the new patch, the doc tests of sage/misc/sageinspect.py pass regardless whether #11900 is applied or not.",
    "created_at": "2011-10-29T07:25:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124832",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:16'></a>
Done! Using the new patch, the doc tests of sage/misc/sageinspect.py pass regardless whether #11900 is applied or not.



---

archive/issue_comments_124833.json:
```json
{
    "body": "**Changing work issues** from \"Make it independent of #11900\" to \"\".",
    "created_at": "2011-10-29T07:25:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124833",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing work issues** from "Make it independent of #11900" to "".



---

archive/issue_events_094141.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2011-10-29T07:25:03Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11768#event-94141"
}
```



---

archive/issue_events_094142.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2011-10-29T07:25:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11768#event-94142"
}
```



---

archive/issue_comments_124834.json:
```json
{
    "body": "<a id='comment:17'></a>\nWith the patch, one still has\n\n```\nsage: C = Algebras(ZZ).TensorProducts()\nsage: C.ParentMethods??\nError getting source: could not get source code\nType:           classobj\nString Form:    sage.categories.algebras.TensorProducts.ParentMethods\nNamespace:      Interactive\nFile:           /mnt/local/king/SAGE/rebase/sage-4.8.alpha0/local/lib/python2.6/site-packages/sage/categories/algebras.py\n```\n\nHowever, if C is the category of Z-algebras, then `C.ParentMethods??` works nicely. So, the patch isn't perfect, but it is a progress. Review, anyone?",
    "created_at": "2011-11-10T19:19:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124834",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:17'></a>
With the patch, one still has

```
sage: C = Algebras(ZZ).TensorProducts()
sage: C.ParentMethods??
Error getting source: could not get source code
Type:           classobj
String Form:    sage.categories.algebras.TensorProducts.ParentMethods
Namespace:      Interactive
File:           /mnt/local/king/SAGE/rebase/sage-4.8.alpha0/local/lib/python2.6/site-packages/sage/categories/algebras.py
```

However, if C is the category of Z-algebras, then `C.ParentMethods??` works nicely. So, the patch isn't perfect, but it is a progress. Review, anyone?



---

archive/issue_comments_124835.json:
```json
{
    "body": "<a id='comment:18'></a>\nIf #12876 is applied then one of the tests introduced here gives an unexpected result: We test against a particular code snipped, that changes with #12876.\n\nHence, I'll rewrite the test so that it expects only those parts of the code that do not change.",
    "created_at": "2012-05-02T19:24:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124835",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:18'></a>
If #12876 is applied then one of the tests introduced here gives an unexpected result: We test against a particular code snipped, that changes with #12876.

Hence, I'll rewrite the test so that it expects only those parts of the code that do not change.



---

archive/issue_comments_124836.json:
```json
{
    "body": "<a id='comment:19'></a>\nWith the second patch, the doctest becomes independent of whether or not #12876 is applied.\n\nApply trac11768_source_of_dynamic_class.patch trac11768_docfix.patch",
    "created_at": "2012-05-03T10:04:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124836",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:19'></a>
With the second patch, the doctest becomes independent of whether or not #12876 is applied.

Apply trac11768_source_of_dynamic_class.patch trac11768_docfix.patch



---

archive/issue_comments_124837.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -43,3 +43,9 @@\n The function that I plan to write does not start with the whole source file of `sage.categories.rings`, but it starts with the sources of `sage.categories.rings.Rings` and then searches `class ParentMethods` (with the regular expression from the inspect module) only in that small part of the full source file.\n \n I think \"getting sources\" belongs to the component \"misc\", even though the problem is  relevant for not getting confused by the category framework. Thus, cc to Nicolas...\n+\n+**__Apply__**\n+\n+* [attachment:trac11768_source_of_dynamic_class.patch](https://github.com/sagemath/sage/files/ticket11768/trac11768_source_of_dynamic_class.patch)\n+* [attachment:trac11768_docfix.patch](https://github.com/sagemath/sage/files/ticket11768/trac11768_docfix.patch)\n+\n``````\n",
    "created_at": "2012-05-03T10:04:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124837",
    "user": "https://github.com/simon-king-jena"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -43,3 +43,9 @@
 The function that I plan to write does not start with the whole source file of `sage.categories.rings`, but it starts with the sources of `sage.categories.rings.Rings` and then searches `class ParentMethods` (with the regular expression from the inspect module) only in that small part of the full source file.
 
 I think "getting sources" belongs to the component "misc", even though the problem is  relevant for not getting confused by the category framework. Thus, cc to Nicolas...
+
+**__Apply__**
+
+* [attachment:trac11768_source_of_dynamic_class.patch](https://github.com/sagemath/sage/files/ticket11768/trac11768_source_of_dynamic_class.patch)
+* [attachment:trac11768_docfix.patch](https://github.com/sagemath/sage/files/ticket11768/trac11768_docfix.patch)
+
``````




---

archive/issue_comments_124838.json:
```json
{
    "body": "<a id='comment:20'></a>\nCool! I just notice:\n\n```\nsage: C = Algebras(ZZ).TensorProducts()\nsage: C.ParentMethods??\nType:\t\tclassobj\nString Form:\tsage.categories.algebras.Algebras.TensorProducts.ParentMethods\nNamespace:\tInteractive\nLoaded File:\t/mnt/local/king/SAGE/stable/sage-5.0.beta13/local/lib/python2.7/site-packages/sage/categories/algebras.py\nSource File:\t/mnt/local/king/SAGE/stable/sage-5.0.beta13/devel/sage/sage/categories/algebras.py\nSource:\n        class ParentMethods:\n            #def coproduct(self):\n            #    tensor products of morphisms are not yet implemented\n            #    return tensor(module.coproduct for module in self.modules)\n            pass\n```\nI don't know who solved that, but (as I stated above) that used to fail!",
    "created_at": "2012-05-03T10:06:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124838",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:20'></a>
Cool! I just notice:

```
sage: C = Algebras(ZZ).TensorProducts()
sage: C.ParentMethods??
Type:		classobj
String Form:	sage.categories.algebras.Algebras.TensorProducts.ParentMethods
Namespace:	Interactive
Loaded File:	/mnt/local/king/SAGE/stable/sage-5.0.beta13/local/lib/python2.7/site-packages/sage/categories/algebras.py
Source File:	/mnt/local/king/SAGE/stable/sage-5.0.beta13/devel/sage/sage/categories/algebras.py
Source:
        class ParentMethods:
            #def coproduct(self):
            #    tensor products of morphisms are not yet implemented
            #    return tensor(module.coproduct for module in self.modules)
            pass
```
I don't know who solved that, but (as I stated above) that used to fail!



---

archive/issue_comments_124839.json:
```json
{
    "body": "<a id='comment:21'></a>\nBy the way: feel free to steal this little fix which I did take the time not push through ...:\n\nhttp://combinat.sagemath.org/patches/file/tip/sage_inspect_for_classes-nt.patch",
    "created_at": "2012-05-04T20:22:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124839",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:21'></a>
By the way: feel free to steal this little fix which I did take the time not push through ...:

http://combinat.sagemath.org/patches/file/tip/sage_inspect_for_classes-nt.patch



---

archive/issue_comments_124840.json:
```json
{
    "body": "<a id='comment:22'></a>\nReplying to [@nthiery](#comment%3A21):\n> By the way: feel free to steal this little fix which I did take the time not push through ...:\n\n??\n\nAccording to the comments in the patch, it would *not* solve the problem addressed here:\n\n```\nNow sage_getsourcelines works similarly for old and new style classes:\n\nsage: sage_getsourcelines(Sets.ParentMethods)\nsage: sage_getsourcelines(Sets.Algebras)\n\nStill both fail, because inspect.getsourcelines (in fact\ninspect.findsource) fails on nested classes which have been renamed\nwith NestedClassMetaclass:\n...\n```\nThe point is that both *do* work with my patch:\n\n```\nsage: from sage.misc.sageinspect import sage_getsourcelines\nsage: for x in sage_getsourcelines(Sets.Algebras)[0]:             \n....:     print x,\n....:     \n    class Algebras(AlgebrasCategory):\n\n        def extra_super_categories(self):\n            \"\"\"\n            EXAMPLES::\n\n                sage: Sets().Algebras(QQ).extra_super_categories()\n                [Category of modules with basis over Rational Field]\n\n                sage: Sets().Algebras(QQ).super_categories()\n                [Category of modules with basis over Rational Field]\n\n                sage: Sets().example().algebra(ZZ).categories()\n                [Category of set algebras over Integer Ring,\n                 Category of modules with basis over Integer Ring,\n                 ...\n                 Category of objects]\n\n            \"\"\"\n            from sage.categories.modules_with_basis import ModulesWithBasis\n            return [ModulesWithBasis(self.base_ring())]\n```",
    "created_at": "2012-05-04T21:30:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124840",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:22'></a>
Replying to [@nthiery](#comment%3A21):
> By the way: feel free to steal this little fix which I did take the time not push through ...:

??

According to the comments in the patch, it would *not* solve the problem addressed here:

```
Now sage_getsourcelines works similarly for old and new style classes:

sage: sage_getsourcelines(Sets.ParentMethods)
sage: sage_getsourcelines(Sets.Algebras)

Still both fail, because inspect.getsourcelines (in fact
inspect.findsource) fails on nested classes which have been renamed
with NestedClassMetaclass:
...
```
The point is that both *do* work with my patch:

```
sage: from sage.misc.sageinspect import sage_getsourcelines
sage: for x in sage_getsourcelines(Sets.Algebras)[0]:             
....:     print x,
....:     
    class Algebras(AlgebrasCategory):

        def extra_super_categories(self):
            """
            EXAMPLES::

                sage: Sets().Algebras(QQ).extra_super_categories()
                [Category of modules with basis over Rational Field]

                sage: Sets().Algebras(QQ).super_categories()
                [Category of modules with basis over Rational Field]

                sage: Sets().example().algebra(ZZ).categories()
                [Category of set algebras over Integer Ring,
                 Category of modules with basis over Integer Ring,
                 ...
                 Category of objects]

            """
            from sage.categories.modules_with_basis import ModulesWithBasis
            return [ModulesWithBasis(self.base_ring())]
```



---

archive/issue_comments_124841.json:
```json
{
    "body": "<a id='comment:23'></a>\nReplying to [@simon-king-jena](#comment%3A22):\n> Replying to [@nthiery](#comment%3A21):\n> > By the way: feel free to steal this little fix which I did take the time not push through ...:\n\n> According to the comments in the patch, it would *not* solve the problem addressed here:\n> \n> ```\n> Now sage_getsourcelines works similarly for old and new style classes:\n> \n> sage: sage_getsourcelines(Sets.ParentMethods)\n> sage: sage_getsourcelines(Sets.Algebras)\n> \n> Still both fail, because inspect.getsourcelines (in fact\n> inspect.findsource) fails on nested classes which have been renamed\n> with NestedClassMetaclass:\n> ...\n> ```\n\nOh, sorry, I was unclear. I did not mean that this patch would fix\nthis ticket. Just that it fixed another little issue in a related spot\nin the code. If your patch already takes care of it, so much the\nbetter!\n\nCheers,\n\t\t\t\tNicolas",
    "created_at": "2012-05-05T07:25:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124841",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:23'></a>
Replying to [@simon-king-jena](#comment%3A22):
> Replying to [@nthiery](#comment%3A21):
> > By the way: feel free to steal this little fix which I did take the time not push through ...:

> According to the comments in the patch, it would *not* solve the problem addressed here:
> 
> ```
> Now sage_getsourcelines works similarly for old and new style classes:
> 
> sage: sage_getsourcelines(Sets.ParentMethods)
> sage: sage_getsourcelines(Sets.Algebras)
> 
> Still both fail, because inspect.getsourcelines (in fact
> inspect.findsource) fails on nested classes which have been renamed
> with NestedClassMetaclass:
> ...
> ```

Oh, sorry, I was unclear. I did not mean that this patch would fix
this ticket. Just that it fixed another little issue in a related spot
in the code. If your patch already takes care of it, so much the
better!

Cheers,
				Nicolas



---

archive/issue_comments_124842.json:
```json
{
    "body": "<a id='comment:24'></a>\nAny review for better access to source code in the category framework?",
    "created_at": "2012-08-13T13:08:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124842",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:24'></a>
Any review for better access to source code in the category framework?



---

archive/issue_comments_124843.json:
```json
{
    "body": "<a id='comment:25'></a>\nLooks good. You might want to pick classes for doctests that are not moving targets in the combinat queue, though ;-)  How about `sage/structure/sage_object.py` or something else thats buried deep down and unlikely to change.",
    "created_at": "2012-11-27T10:45:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124843",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:25'></a>
Looks good. You might want to pick classes for doctests that are not moving targets in the combinat queue, though ;-)  How about `sage/structure/sage_object.py` or something else thats buried deep down and unlikely to change.



---

archive/issue_comments_124844.json:
```json
{
    "body": "<a id='comment:26'></a>\nReplying to [@vbraun](#comment%3A25):\n> Looks good. You might want to pick classes for doctests that are not moving targets in the combinat queue, though ;-)  How about `sage/structure/sage_object.py` or something else thats buried deep down and unlikely to change.\n\nGood idea. I can not remember why I chose `JackPolynomials` to create examples. I'll see if `SageObject.element_class` shows the same problems with introspection than `JackPolynomials.element_class`.",
    "created_at": "2012-11-27T11:10:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124844",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:26'></a>
Replying to [@vbraun](#comment%3A25):
> Looks good. You might want to pick classes for doctests that are not moving targets in the combinat queue, though ;-)  How about `sage/structure/sage_object.py` or something else thats buried deep down and unlikely to change.

Good idea. I can not remember why I chose `JackPolynomials` to create examples. I'll see if `SageObject.element_class` shows the same problems with introspection than `JackPolynomials.element_class`.



---

archive/issue_comments_124845.json:
```json
{
    "body": "<a id='comment:27'></a>\nI think what I need is:\n\n* A parent class whose metaclass is a sub-class of `NestedClassMetaclass` (such as `UniqueRepresentation`)\n* ... so that the `Element` attribute is given as a nested class.\n\nThese two properties hold for the `JackPolynomials` example.\n\nWhat I could do is to create a minimal example in the doc tests. Unfortunately, I need a source file to make it work -- hence, such a doc test needs to use the cython(...) function and hence needs a compiler.\n\nI did create a couple of examples of that type in other patches that got merged, but some people said it is bad practice to have examples that rely on a compiler.\n\nSo, what do you think? Shall I use the compiler, or perhaps create a new class in the Sage library just for the purpose of testing?",
    "created_at": "2012-11-27T11:22:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124845",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:27'></a>
I think what I need is:

* A parent class whose metaclass is a sub-class of `NestedClassMetaclass` (such as `UniqueRepresentation`)
* ... so that the `Element` attribute is given as a nested class.

These two properties hold for the `JackPolynomials` example.

What I could do is to create a minimal example in the doc tests. Unfortunately, I need a source file to make it work -- hence, such a doc test needs to use the cython(...) function and hence needs a compiler.

I did create a couple of examples of that type in other patches that got merged, but some people said it is bad practice to have examples that rely on a compiler.

So, what do you think? Shall I use the compiler, or perhaps create a new class in the Sage library just for the purpose of testing?



---

archive/issue_comments_124846.json:
```json
{
    "body": "<a id='comment:28'></a>\nI don't know yet whether my patch would fix the following example:\n\n```\nsage: class MyParent(UniqueRepresentation, Parent):\n....:    class Element:\n....:        pass\n....:     \nsage: P = MyParent(ZZ)\nsage: P.element_class??\nType:           DynamicMetaclass\nBase Class:     <class 'sage.structure.dynamic_class.DynamicMetaclass'>\nString Form:    <class '__main__.MyParent.element_class'>\nNamespace:      Interactive\nLoaded File:    /home/simon/SAGE/debug/sage-5.5.rc0/local/lib/python2.7/site-packages/IPython/FakeModule.py\nSource File:    /home/simon/SAGE/debug/sage-5.5.rc0/devel/sage/IPython/FakeModule.py\nSource:\nclass DynamicMetaclass(type):\n...\n```\n\nIf I understand correctly, my patch *would* fix a corresponding example in Cython (because it then has a source file to inspect). If my patch is able to fix the example above then I'll use it.",
    "created_at": "2012-11-27T11:27:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124846",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:28'></a>
I don't know yet whether my patch would fix the following example:

```
sage: class MyParent(UniqueRepresentation, Parent):
....:    class Element:
....:        pass
....:     
sage: P = MyParent(ZZ)
sage: P.element_class??
Type:           DynamicMetaclass
Base Class:     <class 'sage.structure.dynamic_class.DynamicMetaclass'>
String Form:    <class '__main__.MyParent.element_class'>
Namespace:      Interactive
Loaded File:    /home/simon/SAGE/debug/sage-5.5.rc0/local/lib/python2.7/site-packages/IPython/FakeModule.py
Source File:    /home/simon/SAGE/debug/sage-5.5.rc0/devel/sage/IPython/FakeModule.py
Source:
class DynamicMetaclass(type):
...
```

If I understand correctly, my patch *would* fix a corresponding example in Cython (because it then has a source file to inspect). If my patch is able to fix the example above then I'll use it.



---

archive/issue_comments_124847.json:
```json
{
    "body": "<a id='comment:29'></a>\nTo my surprise, the patch does *not* solve the introspection problem mentioned in my previous post, even if Cython code is used.\n\nI think to make it work interactively should be moved on a different ticket. So, for now, I suggest to create a test class in sage.misc.sageinspect.",
    "created_at": "2012-11-27T16:46:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124847",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:29'></a>
To my surprise, the patch does *not* solve the introspection problem mentioned in my previous post, even if Cython code is used.

I think to make it work interactively should be moved on a different ticket. So, for now, I suggest to create a test class in sage.misc.sageinspect.



---

archive/issue_comments_124848.json:
```json
{
    "body": "<a id='comment:30'></a>\nI have folded the two patches into one, and I replaced some occurences of `trac ticket #...` by the appropriate `:trac:` directive.\n\nAnd of course I removed the `JackPolynomial` test. Instead, the sources of a dummy class are inspected, created only for testing.\n\nIt turned out to be impossible to put the dummy class into `sage.misc.sageinspect`, since importing `UniqueRepresentation` and `Parent` in `sageinspect` seems to create an import cycle. Hence, the dummy is now in `sage.structure.parent` - which should be \n\nApply trac11768_source_of_dynamic_class.patch",
    "created_at": "2012-11-27T20:26:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124848",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:30'></a>
I have folded the two patches into one, and I replaced some occurences of `trac ticket #...` by the appropriate `:trac:` directive.

And of course I removed the `JackPolynomial` test. Instead, the sources of a dummy class are inspected, created only for testing.

It turned out to be impossible to put the dummy class into `sage.misc.sageinspect`, since importing `UniqueRepresentation` and `Parent` in `sageinspect` seems to create an import cycle. Hence, the dummy is now in `sage.structure.parent` - which should be 

Apply trac11768_source_of_dynamic_class.patch



---

archive/issue_comments_124849.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -47,5 +47,4 @@\n **__Apply__**\n \n * [attachment:trac11768_source_of_dynamic_class.patch](https://github.com/sagemath/sage/files/ticket11768/trac11768_source_of_dynamic_class.patch)\n-* [attachment:trac11768_docfix.patch](https://github.com/sagemath/sage/files/ticket11768/trac11768_docfix.patch)\n \n``````\n",
    "created_at": "2012-11-27T20:26:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124849",
    "user": "https://github.com/simon-king-jena"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -47,5 +47,4 @@
 **__Apply__**
 
 * [attachment:trac11768_source_of_dynamic_class.patch](https://github.com/sagemath/sage/files/ticket11768/trac11768_source_of_dynamic_class.patch)
-* [attachment:trac11768_docfix.patch](https://github.com/sagemath/sage/files/ticket11768/trac11768_docfix.patch)
 
``````




---

archive/issue_comments_124850.json:
```json
{
    "body": "<a id='comment:31'></a>\nHi Simon!\n\nThanks for your work on finalizing this. What about putting the example in a new separate file.\nWhat about putting the test class in a separate file like sage.misc.sageinspect_test.py that would only be imported in the doctest?\n\nCheers,\n                       Nicolas",
    "created_at": "2012-11-27T20:58:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124850",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:31'></a>
Hi Simon!

Thanks for your work on finalizing this. What about putting the example in a new separate file.
What about putting the test class in a separate file like sage.misc.sageinspect_test.py that would only be imported in the doctest?

Cheers,
                       Nicolas



---

archive/issue_comments_124851.json:
```json
{
    "body": "<a id='comment:32'></a>\nReplying to [@nthiery](#comment%3A31):\n> Thanks for your work on finalizing this. What about putting the example in a new separate file.\n> What about putting the test class in a separate file like sage.misc.sageinspect_test.py that would only be imported in the doctest?\n\nVolker and Florent, do you agree with Nicolas that a separate file would be better?",
    "created_at": "2012-11-28T10:16:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124851",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:32'></a>
Replying to [@nthiery](#comment%3A31):
> Thanks for your work on finalizing this. What about putting the example in a new separate file.
> What about putting the test class in a separate file like sage.misc.sageinspect_test.py that would only be imported in the doctest?

Volker and Florent, do you agree with Nicolas that a separate file would be better?



---

archive/issue_comments_124852.json:
```json
{
    "body": "<a id='comment:33'></a>\nIf you can't find an appropriate class to test it with then I'm fine with an extra file. I would suggest something in `sage/tests`, though. Maybe `sage/tests/sageinspect.py`. The file can also test itself so it would really be a test (ooh my head hurts now).",
    "created_at": "2012-11-28T10:41:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124852",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:33'></a>
If you can't find an appropriate class to test it with then I'm fine with an extra file. I would suggest something in `sage/tests`, though. Maybe `sage/tests/sageinspect.py`. The file can also test itself so it would really be a test (ooh my head hurts now).



---

archive/issue_comments_124853.json:
```json
{
    "body": "<a id='comment:34'></a>\nReplying to [@vbraun](#comment%3A33):\n> If you can't find an appropriate class to test it with then I'm fine with an extra file. I would suggest something in `sage/tests`, though. Maybe `sage/tests/sageinspect.py`. \n\nI would argue for keeping the tests or test material close to the file under test. We already have sage.misc.nested_class_test which is very similar in purpose. Actually, maybe this should just go there!\n\n> The file can also test itself so it would really be a test (ooh my head hurts now).\n\n:-)",
    "created_at": "2012-11-28T20:34:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124853",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:34'></a>
Replying to [@vbraun](#comment%3A33):
> If you can't find an appropriate class to test it with then I'm fine with an extra file. I would suggest something in `sage/tests`, though. Maybe `sage/tests/sageinspect.py`. 

I would argue for keeping the tests or test material close to the file under test. We already have sage.misc.nested_class_test which is very similar in purpose. Actually, maybe this should just go there!

> The file can also test itself so it would really be a test (ooh my head hurts now).

:-)



---

archive/issue_comments_124854.json:
```json
{
    "body": "<a id='comment:35'></a>\nReplying to [@nthiery](#comment%3A34):\n> I would argue for keeping the tests or test material close to the file under test. We already have sage.misc.nested_class_test which is very similar in purpose. Actually, maybe this should just go there!\n\nGood idea! I plan this for tomorrow.",
    "created_at": "2012-11-28T21:21:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124854",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:35'></a>
Replying to [@nthiery](#comment%3A34):
> I would argue for keeping the tests or test material close to the file under test. We already have sage.misc.nested_class_test which is very similar in purpose. Actually, maybe this should just go there!

Good idea! I plan this for tomorrow.



---

archive/issue_comments_124855.json:
```json
{
    "body": "<a id='comment:36'></a>\nOK, done, ready for review!\n\nNot that the coverage script complains. But I think the coverage script has a bug, since it reports:\n\n```\nsimon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0/devel/sage> ../../sage -coverage sage/misc/sageinspect.py\n----------------------------------------------------------------------\nsage/misc/sageinspect.py\nERROR: Please add a `TestSuite(s).run()` doctest.\nSCORE sage/misc/sageinspect.py: 60% (26 of 43)\n\nMissing documentation:\n         * foo(x, a=')\"', b={not (2+1==3):\n         * __init__(self):\n         * tokeneater(self, type, token, srow_scol, erow_ecol, line):\n         * foo(x, a=')\"', b={(2+1):\n         * foo(x, a='\\')\"', b={not (2+1==3):\n         * dummy' + _grep_first_pair_of_parentheses(source) + ':\\n return' try: return _sage_getargspec_from_ast(proxy) except SyntaxError: # To fix trac #10860. See #11913 for more information. return None elif isinstance(obj,functools.partial):\n         * test_funct(x,y):\n         * create_set_partition_function(letter, k):\n         * __cinit__(self):\n         * object pyobject(self):\n         * __init__(self, ring, gens, coerce=True):\n         * test1(a, b=2):\n         * test3(b, # 12 a=2):\n         * __init__(self, x=None, base=0):\n         * test1(a, b=2):\n         * test3(b, # 12 a=2):\n\n\nMissing doctests:\n         * _getblock(lines):\n\n\nPossibly wrong (function name doesn't occur in doctests):\n         * dummy' + source[beg:] + '\\n return' return tuple(_sage_getargspec_from_ast(proxy)) except Exception: try: # Try to parse just the arguments as a Python argspec. proxy = 'def dummy' + _grep_first_pair_of_parentheses(source) + ':\\n return' return tuple(_sage_getargspec_from_ast(proxy)) except Exception: raise ValueError, \"Could not parse cython argspec\" def sage_getfile(obj):\n```\n\nFirst bug: It expects a `TestSuite.run()` test, but there is no class defined for which this would make sense.\n\nSecond bug: The `dummy' + source[beg:] + '\\n return' return tuple(_sage_getargspec_from_ast(proxy))...` thingy.\n\nApply trac11768_source_of_dynamic_class.patch",
    "created_at": "2012-11-29T08:52:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124855",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:36'></a>
OK, done, ready for review!

Not that the coverage script complains. But I think the coverage script has a bug, since it reports:

```
simon@linux-sqwp:~/SAGE/debug/sage-5.5.rc0/devel/sage> ../../sage -coverage sage/misc/sageinspect.py
----------------------------------------------------------------------
sage/misc/sageinspect.py
ERROR: Please add a `TestSuite(s).run()` doctest.
SCORE sage/misc/sageinspect.py: 60% (26 of 43)

Missing documentation:
         * foo(x, a=')"', b={not (2+1==3):
         * __init__(self):
         * tokeneater(self, type, token, srow_scol, erow_ecol, line):
         * foo(x, a=')"', b={(2+1):
         * foo(x, a='\')"', b={not (2+1==3):
         * dummy' + _grep_first_pair_of_parentheses(source) + ':\n return' try: return _sage_getargspec_from_ast(proxy) except SyntaxError: # To fix trac #10860. See #11913 for more information. return None elif isinstance(obj,functools.partial):
         * test_funct(x,y):
         * create_set_partition_function(letter, k):
         * __cinit__(self):
         * object pyobject(self):
         * __init__(self, ring, gens, coerce=True):
         * test1(a, b=2):
         * test3(b, # 12 a=2):
         * __init__(self, x=None, base=0):
         * test1(a, b=2):
         * test3(b, # 12 a=2):


Missing doctests:
         * _getblock(lines):


Possibly wrong (function name doesn't occur in doctests):
         * dummy' + source[beg:] + '\n return' return tuple(_sage_getargspec_from_ast(proxy)) except Exception: try: # Try to parse just the arguments as a Python argspec. proxy = 'def dummy' + _grep_first_pair_of_parentheses(source) + ':\n return' return tuple(_sage_getargspec_from_ast(proxy)) except Exception: raise ValueError, "Could not parse cython argspec" def sage_getfile(obj):
```

First bug: It expects a `TestSuite.run()` test, but there is no class defined for which this would make sense.

Second bug: The `dummy' + source[beg:] + '\n return' return tuple(_sage_getargspec_from_ast(proxy))...` thingy.

Apply trac11768_source_of_dynamic_class.patch



---

archive/issue_comments_124856.json:
```json
{
    "body": "**Work Issues:** import location for nested test class",
    "created_at": "2012-11-30T14:16:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124856",
    "user": "https://github.com/simon-king-jena"
}
```

**Work Issues:** import location for nested test class



---

archive/issue_events_094143.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-11-30T14:16:57Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11768#event-94143"
}
```



---

archive/issue_events_094144.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-11-30T14:16:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11768#event-94144"
}
```



---

archive/issue_comments_124857.json:
```json
{
    "body": "<a id='comment:37'></a>\nOops, I just notice that in one test I still try to import the testclass from sage.structure.parent. Needs a rather trivial fix...",
    "created_at": "2012-11-30T14:16:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124857",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:37'></a>
Oops, I just notice that in one test I still try to import the testclass from sage.structure.parent. Needs a rather trivial fix...



---

archive/issue_comments_124858.json:
```json
{
    "body": "**Attachment:** [trac11768_source_of_dynamic_class.patch.gz](https://github.com/sagemath/sage/files/ticket11768/trac11768_source_of_dynamic_class.patch.gz)\n\nGet source lines of dynamic classes (e.g., parent_class of a category). Combined patch",
    "created_at": "2012-11-30T14:49:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124858",
    "user": "https://github.com/simon-king-jena"
}
```

**Attachment:** [trac11768_source_of_dynamic_class.patch.gz](https://github.com/sagemath/sage/files/ticket11768/trac11768_source_of_dynamic_class.patch.gz)

Get source lines of dynamic classes (e.g., parent_class of a category). Combined patch



---

archive/issue_events_094145.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-11-30T14:50:25Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11768#event-94145"
}
```



---

archive/issue_events_094146.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-11-30T14:50:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11768#event-94146"
}
```



---

archive/issue_comments_124859.json:
```json
{
    "body": "**Changing work issues** from \"import location for nested test class\" to \"\".",
    "created_at": "2012-11-30T14:50:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124859",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing work issues** from "import location for nested test class" to "".



---

archive/issue_comments_124860.json:
```json
{
    "body": "<a id='comment:38'></a>\nShould now be fixed!\n\nApply trac11768_source_of_dynamic_class.patch",
    "created_at": "2012-11-30T14:50:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124860",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:38'></a>
Should now be fixed!

Apply trac11768_source_of_dynamic_class.patch



---

archive/issue_comments_124861.json:
```json
{
    "body": "<a id='comment:39'></a>\nLooks good to me.\n\nThe coverage script is going crazy. But the correct fix would be to replace the regex cludge with a python lexer/parser. Definitely material for another ticket...",
    "created_at": "2012-12-01T15:08:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124861",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:39'></a>
Looks good to me.

The coverage script is going crazy. But the correct fix would be to replace the regex cludge with a python lexer/parser. Definitely material for another ticket...



---

archive/issue_events_094147.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2012-12-01T15:08:54Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11768#event-94147"
}
```



---

archive/issue_events_094148.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2012-12-01T15:08:54Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11768#event-94148"
}
```



---

archive/issue_comments_124862.json:
```json
{
    "body": "**Reviewer:** Volker Braun",
    "created_at": "2012-12-01T15:08:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124862",
    "user": "https://github.com/vbraun"
}
```

**Reviewer:** Volker Braun



---

archive/issue_comments_124863.json:
```json
{
    "body": "**Merged:** sage-5.6.beta1",
    "created_at": "2012-12-21T09:30:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11768#issuecomment-124863",
    "user": "https://github.com/jdemeyer"
}
```

**Merged:** sage-5.6.beta1



---

archive/issue_events_094149.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-12-21T09:30:48Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11768#event-94149"
}
```



---

archive/issue_events_094150.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-12-21T09:30:48Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/11768",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11768#event-94150"
}
```
