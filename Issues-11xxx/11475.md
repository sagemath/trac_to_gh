# Issue 11475: improve prime_pi (speedup + small fixes)

archive/issues_011303.json:
```json
{
    "body": "I have rewritten the `prime_pi` method from scratch, it is much cleaner and less hacky this time (as I have learned more about coding), however it is still based on the same algorithm as before (no LMO yet, although I intend to take a stab at it later this year). This was developed in parallel with a method to count primes in residue classes (ticket forthcoming).\n\nThe overhead for small input `>= 2` is rather large in the current `prime_pi`, this has been dramatically improved:\n\nNew:\n\n```\nsage: timeit('prime_pi(100)')\n625 loops, best of 3: 475 ns per loop\nsage: timeit('prime_pi(10000)')\n625 loops, best of 3: 483 ns per loop\n```\nOld:\n\n```\nsage: timeit('prime_pi(100)')\n625 loops, best of 3: 1.71 \u00b5s per loop\nsage: timeit('prime_pi(10000)')\n625 loops, best of 3: 5.56 \u00b5s per loop\n```\n\nThere is also a ~5x speedup (conservatively) for larger input:\n\nNew:\n\n```\nsage: timeit('prime_pi(10**8)')\n625 loops, best of 3: 530 \u00b5s per loop\nsage: timeit('prime_pi(10**10)')\n5 loops, best of 3: 27.1 ms per loop\nsage: time prime_pi(10**12)\n37607912018\nTime: CPU 1.53 s, Wall: 1.53 s\n```\nOld:\n\n```\nsage: timeit('prime_pi(10**8)')\n125 loops, best of 3: 3.66 ms per loop\nsage: timeit('prime_pi(10**10)')\n5 loops, best of 3: 161 ms per loop\nsage: time prime_pi(10**12)\n37607912018\nTime: CPU 8.65 s, Wall: 8.64 s\n```\n\nThe user can also give a second argument to use additional memory for a potential speedup. All primes less than the second argument are used in computing pi(x). For example:\n\n```\nsage: time prime_pi(10**12, 10**8)\n37607912018\nTime: CPU 0.92 s, Wall: 0.92 s\nsage: time prime_pi(10**12, 10**8)    # pari's prime table is now cached\n37607912018\nTime: CPU 0.58 s, Wall: 0.58 s\n```\n\nAn earlier version of this implementation started to fail to give correct output on 64-bit systems somewhere between `9.5*10**15` and `9.75*10**15`, for issues that I had previously been unable to determine, so I had initially limited input to be `< 2**49`, which I am fairly confident is safe, as I have done a fair bit of testing in this range trying to debug this issue (despite it taking hours per call). I would appreciate testing on 32-bit platforms.\n\nA lot of the speed of this algorithm relies on the `__cached_count` method, which is essentially a binary search (with a simple adjustment in the beginning that takes advantage of the density of the primes). This is the fastest type of binary search I know of, but if anyone knows of a way to speed it up, it could have a significant effect.\n\nThe other big contributor to the speed is the `__smallPi` table, which stores the values of pi(x) for `x < 2**16`. This is used in the same manner as  `__cached_count`, but is of course much faster.\n\nFinally, I have introduced the `legendres_formula` method, which takes two arguments, `x` and `a`, and returns the number of positive integers not larger than `x` that are not divisible by any -- i.e. co-prime to each -- of the first `a` primes. This function is core to all combinatorial methods for computing the prime counting function, so I figured that I would make this publicly accessible now that I have clean code.\n\n---\n\nApply [attachment:trac_11475mk2.patch] and [attachment:trac_11475-reviewer.patch] to the **Sage library**.\n\n\nDepends on #15138\n\n**Assignee:** @williamstein\n\n**CC:**  @williamstein @nexttime kevin.stueve victor @kcrisman\n\n**Keywords:** primes, prime counting, prime_pi sd40.5\n\n**Branch/Commit:** [e3e33e62cc19bf93b5236e7d1177482bd52b8a9e](https://github.com/sagemath/sagetrac-mirror/commit/e3e33e62cc19bf93b5236e7d1177482bd52b8a9e)\n\n**Reviewer:** Yann Laigle-Chapuy, Leif Leonhardy, William Stein, Karl-Dieter Crisman\n\n**Author:** R. Andrew Ohana\n\nIssue created by migration from https://trac.sagemath.org/ticket/11475\n\n",
    "closed_at": "2014-05-12T11:34:52Z",
    "created_at": "2011-06-14T09:01:44Z",
    "labels": [
        "component: number theory",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-6.3",
    "title": "improve prime_pi (speedup + small fixes)",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/11475",
    "user": "https://github.com/ohanar"
}
```
I have rewritten the `prime_pi` method from scratch, it is much cleaner and less hacky this time (as I have learned more about coding), however it is still based on the same algorithm as before (no LMO yet, although I intend to take a stab at it later this year). This was developed in parallel with a method to count primes in residue classes (ticket forthcoming).

The overhead for small input `>= 2` is rather large in the current `prime_pi`, this has been dramatically improved:

New:

```
sage: timeit('prime_pi(100)')
625 loops, best of 3: 475 ns per loop
sage: timeit('prime_pi(10000)')
625 loops, best of 3: 483 ns per loop
```
Old:

```
sage: timeit('prime_pi(100)')
625 loops, best of 3: 1.71 µs per loop
sage: timeit('prime_pi(10000)')
625 loops, best of 3: 5.56 µs per loop
```

There is also a ~5x speedup (conservatively) for larger input:

New:

```
sage: timeit('prime_pi(10**8)')
625 loops, best of 3: 530 µs per loop
sage: timeit('prime_pi(10**10)')
5 loops, best of 3: 27.1 ms per loop
sage: time prime_pi(10**12)
37607912018
Time: CPU 1.53 s, Wall: 1.53 s
```
Old:

```
sage: timeit('prime_pi(10**8)')
125 loops, best of 3: 3.66 ms per loop
sage: timeit('prime_pi(10**10)')
5 loops, best of 3: 161 ms per loop
sage: time prime_pi(10**12)
37607912018
Time: CPU 8.65 s, Wall: 8.64 s
```

The user can also give a second argument to use additional memory for a potential speedup. All primes less than the second argument are used in computing pi(x). For example:

```
sage: time prime_pi(10**12, 10**8)
37607912018
Time: CPU 0.92 s, Wall: 0.92 s
sage: time prime_pi(10**12, 10**8)    # pari's prime table is now cached
37607912018
Time: CPU 0.58 s, Wall: 0.58 s
```

An earlier version of this implementation started to fail to give correct output on 64-bit systems somewhere between `9.5*10**15` and `9.75*10**15`, for issues that I had previously been unable to determine, so I had initially limited input to be `< 2**49`, which I am fairly confident is safe, as I have done a fair bit of testing in this range trying to debug this issue (despite it taking hours per call). I would appreciate testing on 32-bit platforms.

A lot of the speed of this algorithm relies on the `__cached_count` method, which is essentially a binary search (with a simple adjustment in the beginning that takes advantage of the density of the primes). This is the fastest type of binary search I know of, but if anyone knows of a way to speed it up, it could have a significant effect.

The other big contributor to the speed is the `__smallPi` table, which stores the values of pi(x) for `x < 2**16`. This is used in the same manner as  `__cached_count`, but is of course much faster.

Finally, I have introduced the `legendres_formula` method, which takes two arguments, `x` and `a`, and returns the number of positive integers not larger than `x` that are not divisible by any -- i.e. co-prime to each -- of the first `a` primes. This function is core to all combinatorial methods for computing the prime counting function, so I figured that I would make this publicly accessible now that I have clean code.

---

Apply [attachment:trac_11475mk2.patch] and [attachment:trac_11475-reviewer.patch] to the **Sage library**.


Depends on #15138

**Assignee:** @williamstein

**CC:**  @williamstein @nexttime kevin.stueve victor @kcrisman

**Keywords:** primes, prime counting, prime_pi sd40.5

**Branch/Commit:** [e3e33e62cc19bf93b5236e7d1177482bd52b8a9e](https://github.com/sagemath/sagetrac-mirror/commit/e3e33e62cc19bf93b5236e7d1177482bd52b8a9e)

**Reviewer:** Yann Laigle-Chapuy, Leif Leonhardy, William Stein, Karl-Dieter Crisman

**Author:** R. Andrew Ohana

Issue created by migration from https://trac.sagemath.org/ticket/11475





---

archive/attachments_015120.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_11475.patch",
    "asset_url": "tarball://root/attachments/ticket11475/trac_11475.patch",
    "created_at": "2011-06-14T09:04:04Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket11475/trac_11475.patch",
    "user": "https://github.com/ohanar"
}
```



---

archive/issue_comments_118475.json:
```json
{
    "body": "Attachment [trac_11475.patch](https://github.com/sagemath/sage/files/ticket11475/trac_11475.patch) by @ohanar created at 2011-06-14 09:04:04\n\nbased on sage-4.7",
    "created_at": "2011-06-14T09:04:04Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118475",
    "user": "https://github.com/ohanar"
}
```

Attachment [trac_11475.patch](https://github.com/sagemath/sage/files/ticket11475/trac_11475.patch) by @ohanar created at 2011-06-14 09:04:04

based on sage-4.7



---

archive/issue_comments_118476.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -81,10 +81,12 @@\n 625 loops, best of 3: 304 ns per loop\n ```\n \n-This doesn't cost very much memory, since everything is stored as 32-bit ints, but `prime_range` is currently built on top of pari, which poses a number of problems, but primary concern it is a memory hog when sieving to a large upper bound (important for plotting purposes).\n+This doesn't cost very much memory, since everything is stored as 32-bit ints, but `prime_range` is currently built on top of pari, which poses a number of problems, but the primary concern is that it is a memory hog when sieving to a large upper bound (important for plotting purposes).\n \n I know that this implementation fails to give correct output on 64-bit systems somewhere between `9.5*10**15` and `9.75*10**15`, for issues that I have been unable to determine. I have limited input to be `< 2**49`, which I am fairly confident to be safe, as I have done a fair bit of testing in this range trying to debug this issue (despite it taking hours per call). I would appreciate testing on 32-bit platforms.\n \n A lot of the speed of this algorithm relies on the `__cached_count` method, which is essentially a binary search (with a simple adjustment in the beginning that takes advantage of the density of the primes). This is the fastest type of binary search I know of, but if anyone knows of a way to speed it up, it could have a significant effect.\n \n Finally, I have introduced the `legendres_formula` method, which takes two arguments, `x` and `a`, and returns the number of positive integers less than `x` that are not divisible by the first `a` primes. This function is core to all combinatorial methods for computing the prime counting function, so I figured that I would make this publicly accessible now that I have clean code.\n+\n+Apply trac_11475.patch\n``````\n",
    "created_at": "2011-06-14T09:10:19Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118476",
    "user": "https://github.com/ohanar"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -81,10 +81,12 @@
 625 loops, best of 3: 304 ns per loop
 ```
 
-This doesn't cost very much memory, since everything is stored as 32-bit ints, but `prime_range` is currently built on top of pari, which poses a number of problems, but primary concern it is a memory hog when sieving to a large upper bound (important for plotting purposes).
+This doesn't cost very much memory, since everything is stored as 32-bit ints, but `prime_range` is currently built on top of pari, which poses a number of problems, but the primary concern is that it is a memory hog when sieving to a large upper bound (important for plotting purposes).
 
 I know that this implementation fails to give correct output on 64-bit systems somewhere between `9.5*10**15` and `9.75*10**15`, for issues that I have been unable to determine. I have limited input to be `< 2**49`, which I am fairly confident to be safe, as I have done a fair bit of testing in this range trying to debug this issue (despite it taking hours per call). I would appreciate testing on 32-bit platforms.
 
 A lot of the speed of this algorithm relies on the `__cached_count` method, which is essentially a binary search (with a simple adjustment in the beginning that takes advantage of the density of the primes). This is the fastest type of binary search I know of, but if anyone knows of a way to speed it up, it could have a significant effect.
 
 Finally, I have introduced the `legendres_formula` method, which takes two arguments, `x` and `a`, and returns the number of positive integers less than `x` that are not divisible by the first `a` primes. This function is core to all combinatorial methods for computing the prime counting function, so I figured that I would make this publicly accessible now that I have clean code.
+
+Apply trac_11475.patch
``````




---

archive/issue_events_090546.json:
```json
{
    "actor": "https://github.com/ohanar",
    "created_at": "2011-06-14T09:10:19Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90546"
}
```



---

archive/issue_comments_118477.json:
```json
{
    "body": "<a id='comment:2'></a>\nThe [link(s)](http://wstein.org/home/ohanar/papers/abelian_prime_counting/main.pdf) to [your paper](http://wstein.org/home/ohanar/senior_thesis/main.pdf) is (currently) dead. (I wouldn't call it 'main' btw. ;-) )\n\nHaven't yet looked a the rest...",
    "created_at": "2011-06-14T19:40:53Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118477",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:2'></a>
The [link(s)](http://wstein.org/home/ohanar/papers/abelian_prime_counting/main.pdf) to [your paper](http://wstein.org/home/ohanar/senior_thesis/main.pdf) is (currently) dead. (I wouldn't call it 'main' btw. ;-) )

Haven't yet looked a the rest...



---

archive/issue_comments_118478.json:
```json
{
    "body": "**Changing author** from \"ohanar\" to \"R. Andrew Ohana\".",
    "created_at": "2011-06-14T19:42:07Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118478",
    "user": "https://github.com/nexttime"
}
```

**Changing author** from "ohanar" to "R. Andrew Ohana".



---

archive/issue_comments_118479.json:
```json
{
    "body": "<a id='comment:4'></a>\n> A lot of the speed of this algorithm relies on the __cached_count method, which is essentially a binary search (with a simple adjustment in the beginning that takes advantage of the density of the primes)\n\n\nSomething like this should give you a 10% speedup for big inputs. \n\n```\n        if p < 200:\n            pos = p>>2\n            size = 5\n        else:\n            size = self.__numPrimes>>1\n            # Use the expected density of primes for expected inputs to make an\n            # educated guess\n            if p>>3 < size:\n                size = p>>3\n            pos = size\n```\n\n\n(beware to make sure there are enough primes cached for small inputs)",
    "created_at": "2011-06-14T19:46:01Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118479",
    "user": "https://trac.sagemath.org/admin/accounts/users/ylchapuy"
}
```

<a id='comment:4'></a>
> A lot of the speed of this algorithm relies on the __cached_count method, which is essentially a binary search (with a simple adjustment in the beginning that takes advantage of the density of the primes)


Something like this should give you a 10% speedup for big inputs. 

```
        if p < 200:
            pos = p>>2
            size = 5
        else:
            size = self.__numPrimes>>1
            # Use the expected density of primes for expected inputs to make an
            # educated guess
            if p>>3 < size:
                size = p>>3
            pos = size
```


(beware to make sure there are enough primes cached for small inputs)



---

archive/issue_comments_118480.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [leif](#comment%3A2):\n> (I wouldn't call it 'main' btw. ;-) )\n\n\nOops, `s/call/name/`. :)",
    "created_at": "2011-06-14T19:48:51Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118480",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:5'></a>
Replying to [leif](#comment%3A2):
> (I wouldn't call it 'main' btw. ;-) )


Oops, `s/call/name/`. :)



---

archive/issue_comments_118481.json:
```json
{
    "body": "<a id='comment:6'></a>\nReplying to [leif](#comment%3A2):\n> The [link(s)](http://wstein.org/home/ohanar/papers/abelian_prime_counting/main.pdf) to [your paper](http://wstein.org/home/ohanar/senior_thesis/main.pdf) is (currently) dead. (I wouldn't call it 'main' btw. ;-) )\n\n\nSorry about that, I was planning on moving the folder, but I forgot to. I'll fix that tonight.\n\nReplying to [ylchapuy](#comment%3A4):\n> Something like this should give you a 10% speedup for big inputs. \n\n\nThanks, I'll try it out tonight, and update the description and patch if it proves fruitful.",
    "created_at": "2011-06-14T20:39:54Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118481",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:6'></a>
Replying to [leif](#comment%3A2):
> The [link(s)](http://wstein.org/home/ohanar/papers/abelian_prime_counting/main.pdf) to [your paper](http://wstein.org/home/ohanar/senior_thesis/main.pdf) is (currently) dead. (I wouldn't call it 'main' btw. ;-) )


Sorry about that, I was planning on moving the folder, but I forgot to. I'll fix that tonight.

Replying to [ylchapuy](#comment%3A4):
> Something like this should give you a 10% speedup for big inputs. 


Thanks, I'll try it out tonight, and update the description and patch if it proves fruitful.



---

archive/issue_comments_118482.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -34,7 +34,7 @@\n sage: timeit('prime_pi(100)')\n 625 loops, best of 3: 331 ns per loop\n sage: timeit('prime_pi(1000)')\n-625 loops, best of 3: 963 ns per loop\n+625 loops, best of 3: 838 ns per loop\n ```\n Old:\n \n@@ -45,18 +45,18 @@\n 625 loops, best of 3: 2.72 \u00b5s per loop\n ```\n \n-There is also 25-40% speedup for larger input:\n+There is also 35-50% speedup for larger input:\n \n New:\n \n ```\n sage: timeit('prime_pi(10**8)')\n-125 loops, best of 3: 2.69 ms per loop\n+125 loops, best of 3: 2.5 ms per loop\n sage: timeit('prime_pi(10**10)')\n-5 loops, best of 3: 127 ms per loop\n+5 loops, best of 3: 116 ms per loop\n sage: time prime_pi(10**12)\n 37607912018\n-Time: CPU 6.80 s, Wall: 6.80 s\n+Time: CPU 6.30 s, Wall: 6.29 s\n ```\n Old:\n \n@@ -70,23 +70,23 @@\n Time: CPU 8.65 s, Wall: 8.64 s\n ```\n \n-Primes are now cached, which can give a huge speedup when making smaller calls after larger calls: (run after previous commands)\n+Primes are now cached, which can give a significant speedup when making smaller calls after larger calls: (run after previous commands)\n \n ```\n sage: timeit('prime_pi(10**10)')\n-5 loops, best of 3: 64.6 ms per loop\n+5 loops, best of 3: 59.6 ms per loop\n sage: timeit('prime_pi(10**8)')\n-625 loops, best of 3: 721 \u00b5s per loop\n+625 loops, best of 3: 663 \u00b5s per loop\n sage: timeit('prime_pi(1000)')\n 625 loops, best of 3: 304 ns per loop\n ```\n \n This doesn't cost very much memory, since everything is stored as 32-bit ints, but `prime_range` is currently built on top of pari, which poses a number of problems, but the primary concern is that it is a memory hog when sieving to a large upper bound (important for plotting purposes).\n \n-I know that this implementation fails to give correct output on 64-bit systems somewhere between `9.5*10**15` and `9.75*10**15`, for issues that I have been unable to determine. I have limited input to be `< 2**49`, which I am fairly confident to be safe, as I have done a fair bit of testing in this range trying to debug this issue (despite it taking hours per call). I would appreciate testing on 32-bit platforms.\n+I know that this implementation starts to fail to give correct output on 64-bit systems somewhere between `9.5*10**15` and `9.75*10**15`, for issues that I have been unable to determine. I have limited input to be `< 2**49`, which I am fairly confident is safe, as I have done a fair bit of testing in this range trying to debug this issue (despite it taking hours per call). I would appreciate testing on 32-bit platforms.\n \n-A lot of the speed of this algorithm relies on the `__cached_count` method, which is essentially a binary search (with a simple adjustment in the beginning that takes advantage of the density of the primes). This is the fastest type of binary search I know of, but if anyone knows of a way to speed it up, it could have a significant effect.\n+A lot of the speed of this algorithm relies on the `__cached_count` method, which is essentially a binary search (with a simple adjustment in the beginning that takes advantage of the density of the primes). This is the fastest type of binary search I know of, but if anyone knows of a way to speed it up, it could have a significant effect. (Thanks to Yann for his suggestion)\n \n Finally, I have introduced the `legendres_formula` method, which takes two arguments, `x` and `a`, and returns the number of positive integers less than `x` that are not divisible by the first `a` primes. This function is core to all combinatorial methods for computing the prime counting function, so I figured that I would make this publicly accessible now that I have clean code.\n \n-Apply trac_11475.patch\n+Apply trac_11475v2.patch\n``````\n",
    "created_at": "2011-06-15T06:18:58Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118482",
    "user": "https://github.com/ohanar"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -34,7 +34,7 @@
 sage: timeit('prime_pi(100)')
 625 loops, best of 3: 331 ns per loop
 sage: timeit('prime_pi(1000)')
-625 loops, best of 3: 963 ns per loop
+625 loops, best of 3: 838 ns per loop
 ```
 Old:
 
@@ -45,18 +45,18 @@
 625 loops, best of 3: 2.72 µs per loop
 ```
 
-There is also 25-40% speedup for larger input:
+There is also 35-50% speedup for larger input:
 
 New:
 
 ```
 sage: timeit('prime_pi(10**8)')
-125 loops, best of 3: 2.69 ms per loop
+125 loops, best of 3: 2.5 ms per loop
 sage: timeit('prime_pi(10**10)')
-5 loops, best of 3: 127 ms per loop
+5 loops, best of 3: 116 ms per loop
 sage: time prime_pi(10**12)
 37607912018
-Time: CPU 6.80 s, Wall: 6.80 s
+Time: CPU 6.30 s, Wall: 6.29 s
 ```
 Old:
 
@@ -70,23 +70,23 @@
 Time: CPU 8.65 s, Wall: 8.64 s
 ```
 
-Primes are now cached, which can give a huge speedup when making smaller calls after larger calls: (run after previous commands)
+Primes are now cached, which can give a significant speedup when making smaller calls after larger calls: (run after previous commands)
 
 ```
 sage: timeit('prime_pi(10**10)')
-5 loops, best of 3: 64.6 ms per loop
+5 loops, best of 3: 59.6 ms per loop
 sage: timeit('prime_pi(10**8)')
-625 loops, best of 3: 721 µs per loop
+625 loops, best of 3: 663 µs per loop
 sage: timeit('prime_pi(1000)')
 625 loops, best of 3: 304 ns per loop
 ```
 
 This doesn't cost very much memory, since everything is stored as 32-bit ints, but `prime_range` is currently built on top of pari, which poses a number of problems, but the primary concern is that it is a memory hog when sieving to a large upper bound (important for plotting purposes).
 
-I know that this implementation fails to give correct output on 64-bit systems somewhere between `9.5*10**15` and `9.75*10**15`, for issues that I have been unable to determine. I have limited input to be `< 2**49`, which I am fairly confident to be safe, as I have done a fair bit of testing in this range trying to debug this issue (despite it taking hours per call). I would appreciate testing on 32-bit platforms.
+I know that this implementation starts to fail to give correct output on 64-bit systems somewhere between `9.5*10**15` and `9.75*10**15`, for issues that I have been unable to determine. I have limited input to be `< 2**49`, which I am fairly confident is safe, as I have done a fair bit of testing in this range trying to debug this issue (despite it taking hours per call). I would appreciate testing on 32-bit platforms.
 
-A lot of the speed of this algorithm relies on the `__cached_count` method, which is essentially a binary search (with a simple adjustment in the beginning that takes advantage of the density of the primes). This is the fastest type of binary search I know of, but if anyone knows of a way to speed it up, it could have a significant effect.
+A lot of the speed of this algorithm relies on the `__cached_count` method, which is essentially a binary search (with a simple adjustment in the beginning that takes advantage of the density of the primes). This is the fastest type of binary search I know of, but if anyone knows of a way to speed it up, it could have a significant effect. (Thanks to Yann for his suggestion)
 
 Finally, I have introduced the `legendres_formula` method, which takes two arguments, `x` and `a`, and returns the number of positive integers less than `x` that are not divisible by the first `a` primes. This function is core to all combinatorial methods for computing the prime counting function, so I figured that I would make this publicly accessible now that I have clean code.
 
-Apply trac_11475.patch
+Apply trac_11475v2.patch
``````




---

archive/issue_comments_118483.json:
```json
{
    "body": "Makes use of Yann's suggested improvement.",
    "created_at": "2011-06-15T06:19:56Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118483",
    "user": "https://github.com/ohanar"
}
```

Makes use of Yann's suggested improvement.



---

archive/attachments_015121.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_11475v2.patch",
    "asset_url": "tarball://root/attachments/ticket11475/trac_11475v2.patch",
    "created_at": "2011-06-15T17:14:15Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket11475/trac_11475v2.patch",
    "user": "https://github.com/nexttime"
}
```



---

archive/issue_comments_118484.json:
```json
{
    "body": "<a id='comment:8'></a>\nAttachment [trac_11475v2.patch](https://github.com/sagemath/sage/files/ticket11475/trac_11475v2.patch) by @nexttime created at 2011-06-15 17:14:15\n\nAndrew, do you have some examples of wrong prime counts (beyond 2<sup>49</sup>), and if so, on what kind of systems does one experience them?\n\nWhile the old implementation was said to fail on (at least some) 32-bit systems for large inputs, the new one in contrast fails on 64-bit systems?\n\n(More or less just curious; perhaps I'll *one day*<sup>TM</sup> try to track this down, depending on the affected system(s) as well.)",
    "created_at": "2011-06-15T17:14:15Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118484",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:8'></a>
Attachment [trac_11475v2.patch](https://github.com/sagemath/sage/files/ticket11475/trac_11475v2.patch) by @nexttime created at 2011-06-15 17:14:15

Andrew, do you have some examples of wrong prime counts (beyond 2<sup>49</sup>), and if so, on what kind of systems does one experience them?

While the old implementation was said to fail on (at least some) 32-bit systems for large inputs, the new one in contrast fails on 64-bit systems?

(More or less just curious; perhaps I'll *one day*<sup>TM</sup> try to track this down, depending on the affected system(s) as well.)



---

archive/issue_comments_118485.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [leif](#comment%3A8):\n> Andrew, do you have some examples of wrong prime counts (beyond 2<sup>49</sup>), and if so, on what kind of systems does one experience them?\n\n\nI did most of my testing on mod.math and sage.math, which is ubuntu linux (64-bit). I don't have failing results any longer, but I can tell you that I discovered the issue with `10**16`, and I also know that it fails for `9.75*10**15`. Give me 7-8 hours and I'll get you the output for those inputs.\n> \n> While the old implementation was said to fail on (at least some) 32-bit systems for large inputs, the new one in contrast fails on 64-bit systems?\n\n\nI don't know how the new one behaves on 32-bit systems, since I have done literally no testing. I hope it does better than the old one, since I used stdint this time around (and the only real difference between my 64-bit vs 32-bit implementation is the use of pointers in the later).\n> \n> (More or less just curious; perhaps I'll *one day*<sup>TM</sup> try to track this down, depending on the affected system(s) as well.)\n",
    "created_at": "2011-06-15T18:17:19Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118485",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:9'></a>
Replying to [leif](#comment%3A8):
> Andrew, do you have some examples of wrong prime counts (beyond 2<sup>49</sup>), and if so, on what kind of systems does one experience them?


I did most of my testing on mod.math and sage.math, which is ubuntu linux (64-bit). I don't have failing results any longer, but I can tell you that I discovered the issue with `10**16`, and I also know that it fails for `9.75*10**15`. Give me 7-8 hours and I'll get you the output for those inputs.
> 
> While the old implementation was said to fail on (at least some) 32-bit systems for large inputs, the new one in contrast fails on 64-bit systems?


I don't know how the new one behaves on 32-bit systems, since I have done literally no testing. I hope it does better than the old one, since I used stdint this time around (and the only real difference between my 64-bit vs 32-bit implementation is the use of pointers in the later).
> 
> (More or less just curious; perhaps I'll *one day*<sup>TM</sup> try to track this down, depending on the affected system(s) as well.)




---

archive/issue_comments_118486.json:
```json
{
    "body": "<a id='comment:10'></a>\nApply only trac_11475v2.patch",
    "created_at": "2011-06-15T20:31:59Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118486",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:10'></a>
Apply only trac_11475v2.patch



---

archive/issue_comments_118487.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [robertwb](#comment%3A10):\n> Apply only trac_11475v2.patch\n\n\n:D",
    "created_at": "2011-06-15T20:35:12Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118487",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:11'></a>
Replying to [robertwb](#comment%3A10):
> Apply only trac_11475v2.patch


:D



---

archive/issue_comments_118488.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -89,4 +89,6 @@\n \n Finally, I have introduced the `legendres_formula` method, which takes two arguments, `x` and `a`, and returns the number of positive integers less than `x` that are not divisible by the first `a` primes. This function is core to all combinatorial methods for computing the prime counting function, so I figured that I would make this publicly accessible now that I have clean code.\n \n-Apply trac_11475v2.patch\n+---\n+\n+Apply only [attachment:trac_11475v2.patch].\n``````\n",
    "created_at": "2011-06-15T20:35:12Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118488",
    "user": "https://github.com/nexttime"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -89,4 +89,6 @@
 
 Finally, I have introduced the `legendres_formula` method, which takes two arguments, `x` and `a`, and returns the number of positive integers less than `x` that are not divisible by the first `a` primes. This function is core to all combinatorial methods for computing the prime counting function, so I figured that I would make this publicly accessible now that I have clean code.
 
-Apply trac_11475v2.patch
+---
+
+Apply only [attachment:trac_11475v2.patch].
``````




---

archive/issue_comments_118489.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -87,7 +87,7 @@\n \n A lot of the speed of this algorithm relies on the `__cached_count` method, which is essentially a binary search (with a simple adjustment in the beginning that takes advantage of the density of the primes). This is the fastest type of binary search I know of, but if anyone knows of a way to speed it up, it could have a significant effect. (Thanks to Yann for his suggestion)\n \n-Finally, I have introduced the `legendres_formula` method, which takes two arguments, `x` and `a`, and returns the number of positive integers less than `x` that are not divisible by the first `a` primes. This function is core to all combinatorial methods for computing the prime counting function, so I figured that I would make this publicly accessible now that I have clean code.\n+Finally, I have introduced the `legendres_formula` method, which takes two arguments, `x` and `a`, and returns the number of positive integers not larger than `x` that are not divisible by -- i.e. co-prime to -- each of the first `a` primes. This function is core to all combinatorial methods for computing the prime counting function, so I figured that I would make this publicly accessible now that I have clean code.\n \n ---\n \n``````\n",
    "created_at": "2011-06-15T20:47:21Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118489",
    "user": "https://github.com/nexttime"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -87,7 +87,7 @@
 
 A lot of the speed of this algorithm relies on the `__cached_count` method, which is essentially a binary search (with a simple adjustment in the beginning that takes advantage of the density of the primes). This is the fastest type of binary search I know of, but if anyone knows of a way to speed it up, it could have a significant effect. (Thanks to Yann for his suggestion)
 
-Finally, I have introduced the `legendres_formula` method, which takes two arguments, `x` and `a`, and returns the number of positive integers less than `x` that are not divisible by the first `a` primes. This function is core to all combinatorial methods for computing the prime counting function, so I figured that I would make this publicly accessible now that I have clean code.
+Finally, I have introduced the `legendres_formula` method, which takes two arguments, `x` and `a`, and returns the number of positive integers not larger than `x` that are not divisible by -- i.e. co-prime to -- each of the first `a` primes. This function is core to all combinatorial methods for computing the prime counting function, so I figured that I would make this publicly accessible now that I have clean code.
 
 ---
 
``````




---

archive/attachments_015122.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_11475v3.patch",
    "asset_url": "tarball://root/attachments/ticket11475/trac_11475v3.patch",
    "created_at": "2011-06-15T23:12:33Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket11475/trac_11475v3.patch",
    "user": "https://github.com/ohanar"
}
```



---

archive/issue_comments_118490.json:
```json
{
    "body": "Attachment [trac_11475v3.patch](https://github.com/sagemath/sage/files/ticket11475/trac_11475v3.patch) by @ohanar created at 2011-06-15 23:12:33\n\nFixes doctests, and changed __cached_primes again to improve speed",
    "created_at": "2011-06-15T23:12:33Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118490",
    "user": "https://github.com/ohanar"
}
```

Attachment [trac_11475v3.patch](https://github.com/sagemath/sage/files/ticket11475/trac_11475v3.patch) by @ohanar created at 2011-06-15 23:12:33

Fixes doctests, and changed __cached_primes again to improve speed



---

archive/issue_comments_118491.json:
```json
{
    "body": "<a id='comment:13'></a>\nApply only trac_11475v3.patch",
    "created_at": "2011-06-15T23:17:53Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118491",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:13'></a>
Apply only trac_11475v3.patch



---

archive/issue_comments_118492.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -34,7 +34,7 @@\n sage: timeit('prime_pi(100)')\n 625 loops, best of 3: 331 ns per loop\n sage: timeit('prime_pi(1000)')\n-625 loops, best of 3: 838 ns per loop\n+625 loops, best of 3: 782 ns per loop\n ```\n Old:\n \n@@ -45,18 +45,18 @@\n 625 loops, best of 3: 2.72 \u00b5s per loop\n ```\n \n-There is also 35-50% speedup for larger input:\n+There is also a 45-60% speedup for larger input:\n \n New:\n \n ```\n sage: timeit('prime_pi(10**8)')\n-125 loops, best of 3: 2.5 ms per loop\n+125 loops, best of 3: 2.31 ms per loop\n sage: timeit('prime_pi(10**10)')\n-5 loops, best of 3: 116 ms per loop\n+5 loops, best of 3: 108 ms per loop\n sage: time prime_pi(10**12)\n 37607912018\n-Time: CPU 6.30 s, Wall: 6.29 s\n+Time: CPU 5.74 s, Wall: 5.75 s\n ```\n Old:\n \n@@ -74,11 +74,11 @@\n \n ```\n sage: timeit('prime_pi(10**10)')\n-5 loops, best of 3: 59.6 ms per loop\n+5 loops, best of 3: 54.6 ms per loop\n sage: timeit('prime_pi(10**8)')\n-625 loops, best of 3: 663 \u00b5s per loop\n+625 loops, best of 3: 604 \u00b5s per loop\n sage: timeit('prime_pi(1000)')\n-625 loops, best of 3: 304 ns per loop\n+625 loops, best of 3: 342 ns per loop\n ```\n \n This doesn't cost very much memory, since everything is stored as 32-bit ints, but `prime_range` is currently built on top of pari, which poses a number of problems, but the primary concern is that it is a memory hog when sieving to a large upper bound (important for plotting purposes).\n@@ -91,4 +91,4 @@\n \n ---\n \n-Apply only [attachment:trac_11475v2.patch].\n+Apply only [attachment:trac_11475v3.patch].\n``````\n",
    "created_at": "2011-06-15T23:19:44Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118492",
    "user": "https://github.com/ohanar"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -34,7 +34,7 @@
 sage: timeit('prime_pi(100)')
 625 loops, best of 3: 331 ns per loop
 sage: timeit('prime_pi(1000)')
-625 loops, best of 3: 838 ns per loop
+625 loops, best of 3: 782 ns per loop
 ```
 Old:
 
@@ -45,18 +45,18 @@
 625 loops, best of 3: 2.72 µs per loop
 ```
 
-There is also 35-50% speedup for larger input:
+There is also a 45-60% speedup for larger input:
 
 New:
 
 ```
 sage: timeit('prime_pi(10**8)')
-125 loops, best of 3: 2.5 ms per loop
+125 loops, best of 3: 2.31 ms per loop
 sage: timeit('prime_pi(10**10)')
-5 loops, best of 3: 116 ms per loop
+5 loops, best of 3: 108 ms per loop
 sage: time prime_pi(10**12)
 37607912018
-Time: CPU 6.30 s, Wall: 6.29 s
+Time: CPU 5.74 s, Wall: 5.75 s
 ```
 Old:
 
@@ -74,11 +74,11 @@
 
 ```
 sage: timeit('prime_pi(10**10)')
-5 loops, best of 3: 59.6 ms per loop
+5 loops, best of 3: 54.6 ms per loop
 sage: timeit('prime_pi(10**8)')
-625 loops, best of 3: 663 µs per loop
+625 loops, best of 3: 604 µs per loop
 sage: timeit('prime_pi(1000)')
-625 loops, best of 3: 304 ns per loop
+625 loops, best of 3: 342 ns per loop
 ```
 
 This doesn't cost very much memory, since everything is stored as 32-bit ints, but `prime_range` is currently built on top of pari, which poses a number of problems, but the primary concern is that it is a memory hog when sieving to a large upper bound (important for plotting purposes).
@@ -91,4 +91,4 @@
 
 ---
 
-Apply only [attachment:trac_11475v2.patch].
+Apply only [attachment:trac_11475v3.patch].
``````




---

archive/issue_comments_118493.json:
```json
{
    "body": "<a id='comment:16'></a>\nReplying to [leif](#comment%3A8):\n> Andrew, do you have some examples of wrong prime counts (beyond 2<sup>49</sup>), and if so, on what kind of systems does one experience them?\n\n\n\n```\nsage: time prime_pi(9.75*10**15)\n272450165623660\nTime: CPU 25614.37 s, Wall: 25614.47 s\n```\n\nThe correct value is `272450167482953` (http://www.ieeta.pt/~tos/primes.html). I also computed `prime_pi(10**16)` but in a moment of confusion, I killed the process before I grabbed the value. If you want it I can start running it again with my current version of the code (~3-5% faster than the latest patch).",
    "created_at": "2011-06-16T03:29:23Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118493",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:16'></a>
Replying to [leif](#comment%3A8):
> Andrew, do you have some examples of wrong prime counts (beyond 2<sup>49</sup>), and if so, on what kind of systems does one experience them?



```
sage: time prime_pi(9.75*10**15)
272450165623660
Time: CPU 25614.37 s, Wall: 25614.47 s
```

The correct value is `272450167482953` (http://www.ieeta.pt/~tos/primes.html). I also computed `prime_pi(10**16)` but in a moment of confusion, I killed the process before I grabbed the value. If you want it I can start running it again with my current version of the code (~3-5% faster than the latest patch).



---

archive/issue_comments_118494.json:
```json
{
    "body": "<a id='comment:17'></a>\nReplying to [ohanar](#comment%3A16):\n> Replying to [leif](#comment%3A8):\n> > Andrew, do you have some examples of wrong prime counts (beyond 2<sup>49</sup>), and if so, on what kind of systems does one experience them?\n\n> \n\n```\nsage: time prime_pi(9.75*10**15)\n272450165623660\nTime: CPU 25614.37 s, Wall: 25614.47 s\n```\n> \n> The correct value is `272450167482953` (http://www.ieeta.pt/~tos/primes.html). I also computed `prime_pi(10**16)` but in a moment of confusion, I killed the process before I grabbed the value. If you want it I can start running it again with my current version of the code (~3-5% faster than the latest patch).\n\n\nNever mind. I thought you had collected a bunch of false results during development. If (apparently) all platforms are affected, it should be easier to track this down - rather than flaws due to e.g. Apple \"specifics\"... ;-)\n\nBtw, I have a large collection of correct prime counts here, so if eventually the sysloads drop, I'll by myself check some results against your new implementation.\n\nAnyway, anybody feel free to compute more values above our current limit and post them here, whether correct or not. :-)",
    "created_at": "2011-06-16T04:09:30Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118494",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:17'></a>
Replying to [ohanar](#comment%3A16):
> Replying to [leif](#comment%3A8):
> > Andrew, do you have some examples of wrong prime counts (beyond 2<sup>49</sup>), and if so, on what kind of systems does one experience them?

> 

```
sage: time prime_pi(9.75*10**15)
272450165623660
Time: CPU 25614.37 s, Wall: 25614.47 s
```
> 
> The correct value is `272450167482953` (http://www.ieeta.pt/~tos/primes.html). I also computed `prime_pi(10**16)` but in a moment of confusion, I killed the process before I grabbed the value. If you want it I can start running it again with my current version of the code (~3-5% faster than the latest patch).


Never mind. I thought you had collected a bunch of false results during development. If (apparently) all platforms are affected, it should be easier to track this down - rather than flaws due to e.g. Apple "specifics"... ;-)

Btw, I have a large collection of correct prime counts here, so if eventually the sysloads drop, I'll by myself check some results against your new implementation.

Anyway, anybody feel free to compute more values above our current limit and post them here, whether correct or not. :-)



---

archive/attachments_015123.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_11475v4.patch",
    "asset_url": "tarball://root/attachments/ticket11475/trac_11475v4.patch",
    "created_at": "2011-06-17T00:20:57Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket11475/trac_11475v4.patch",
    "user": "https://github.com/ohanar"
}
```



---

archive/issue_comments_118495.json:
```json
{
    "body": "Attachment [trac_11475v4.patch](https://github.com/sagemath/sage/files/ticket11475/trac_11475v4.patch) by @ohanar created at 2011-06-17 00:20:57\n\nSome major speed improvements using ~4kB of tables",
    "created_at": "2011-06-17T00:20:57Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118495",
    "user": "https://github.com/ohanar"
}
```

Attachment [trac_11475v4.patch](https://github.com/sagemath/sage/files/ticket11475/trac_11475v4.patch) by @ohanar created at 2011-06-17 00:20:57

Some major speed improvements using ~4kB of tables



---

archive/issue_comments_118496.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -33,30 +33,30 @@\n ```\n sage: timeit('prime_pi(100)')\n 625 loops, best of 3: 331 ns per loop\n-sage: timeit('prime_pi(1000)')\n-625 loops, best of 3: 782 ns per loop\n+sage: timeit('prime_pi(10000)')\n+625 loops, best of 3: 971 ns per loop\n ```\n Old:\n \n ```\n sage: timeit('prime_pi(100)')\n 625 loops, best of 3: 1.71 \u00b5s per loop\n-sage: timeit('prime_pi(1000)')\n-625 loops, best of 3: 2.72 \u00b5s per loop\n+sage: timeit('prime_pi(10000)')\n+625 loops, best of 3: 5.56 \u00b5s per loop\n ```\n \n-There is also a 45-60% speedup for larger input:\n+There is also a ~3x speedup for larger input:\n \n New:\n \n ```\n sage: timeit('prime_pi(10**8)')\n-125 loops, best of 3: 2.31 ms per loop\n+125 loops, best of 3: 759 \u00b5s per loop\n sage: timeit('prime_pi(10**10)')\n-5 loops, best of 3: 108 ms per loop\n+5 loops, best of 3: 47.4 ms per loop\n sage: time prime_pi(10**12)\n 37607912018\n-Time: CPU 5.74 s, Wall: 5.75 s\n+Time: CPU 2.86 s, Wall: 2.86 s\n ```\n Old:\n \n@@ -74,11 +74,11 @@\n \n ```\n sage: timeit('prime_pi(10**10)')\n-5 loops, best of 3: 54.6 ms per loop\n+5 loops, best of 3: 27.4 ms per loop\n sage: timeit('prime_pi(10**8)')\n-625 loops, best of 3: 604 \u00b5s per loop\n-sage: timeit('prime_pi(1000)')\n-625 loops, best of 3: 342 ns per loop\n+625 loops, best of 3: 325 \u00b5s per loop\n+sage: timeit('prime_pi(10000)')\n+625 loops, best of 3: 343 ns per loop\n ```\n \n This doesn't cost very much memory, since everything is stored as 32-bit ints, but `prime_range` is currently built on top of pari, which poses a number of problems, but the primary concern is that it is a memory hog when sieving to a large upper bound (important for plotting purposes).\n@@ -91,4 +91,4 @@\n \n ---\n \n-Apply only [attachment:trac_11475v3.patch].\n+Apply only [attachment:trac_11475v4.patch].\n``````\n",
    "created_at": "2011-06-17T00:27:55Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118496",
    "user": "https://github.com/ohanar"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -33,30 +33,30 @@
 ```
 sage: timeit('prime_pi(100)')
 625 loops, best of 3: 331 ns per loop
-sage: timeit('prime_pi(1000)')
-625 loops, best of 3: 782 ns per loop
+sage: timeit('prime_pi(10000)')
+625 loops, best of 3: 971 ns per loop
 ```
 Old:
 
 ```
 sage: timeit('prime_pi(100)')
 625 loops, best of 3: 1.71 µs per loop
-sage: timeit('prime_pi(1000)')
-625 loops, best of 3: 2.72 µs per loop
+sage: timeit('prime_pi(10000)')
+625 loops, best of 3: 5.56 µs per loop
 ```
 
-There is also a 45-60% speedup for larger input:
+There is also a ~3x speedup for larger input:
 
 New:
 
 ```
 sage: timeit('prime_pi(10**8)')
-125 loops, best of 3: 2.31 ms per loop
+125 loops, best of 3: 759 µs per loop
 sage: timeit('prime_pi(10**10)')
-5 loops, best of 3: 108 ms per loop
+5 loops, best of 3: 47.4 ms per loop
 sage: time prime_pi(10**12)
 37607912018
-Time: CPU 5.74 s, Wall: 5.75 s
+Time: CPU 2.86 s, Wall: 2.86 s
 ```
 Old:
 
@@ -74,11 +74,11 @@
 
 ```
 sage: timeit('prime_pi(10**10)')
-5 loops, best of 3: 54.6 ms per loop
+5 loops, best of 3: 27.4 ms per loop
 sage: timeit('prime_pi(10**8)')
-625 loops, best of 3: 604 µs per loop
-sage: timeit('prime_pi(1000)')
-625 loops, best of 3: 342 ns per loop
+625 loops, best of 3: 325 µs per loop
+sage: timeit('prime_pi(10000)')
+625 loops, best of 3: 343 ns per loop
 ```
 
 This doesn't cost very much memory, since everything is stored as 32-bit ints, but `prime_range` is currently built on top of pari, which poses a number of problems, but the primary concern is that it is a memory hog when sieving to a large upper bound (important for plotting purposes).
@@ -91,4 +91,4 @@
 
 ---
 
-Apply only [attachment:trac_11475v3.patch].
+Apply only [attachment:trac_11475v4.patch].
``````




---

archive/issue_comments_118497.json:
```json
{
    "body": "<a id='comment:19'></a>\nAn update:\n\nv4: added a table of `prime_pi` values that can be stored in a byte -- using this with the `__cached_primes` method gave a giant speedup. Since the sum at the beginning of `__phi` (and `__phi32`) differs from `16*(x/77)` by a small factor that only depends on `x%2310`, so adding a table with these factors results in another large speedup. These tables take a total of ~4kB.\n\nv5: the tables introduced a significant initialization time for `prime_pi`, and William asked me to fix this, so `prime_pi` (and legendres_formula) only initialize these tables on an initial call -- so initialization time is now ~650ns:\n\n```\nsage: timeit('sage.functions.prime_pi.PrimePi()')\n625 loops, best of 3: 627 ns per loop\n```\n\nBoth Yann and I have tested `9.75*10^15` again and got the correct result, I also did `10^16`. We both ran it on 64-bit GNU/Linux systems. So the issue I was encountering may have been due to boundary issues with the `__cached_primes` method (which have been rewritten over the course of the patches). I kept the limit in since I haven't yet tested this thoroughly.",
    "created_at": "2011-06-17T21:12:06Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118497",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:19'></a>
An update:

v4: added a table of `prime_pi` values that can be stored in a byte -- using this with the `__cached_primes` method gave a giant speedup. Since the sum at the beginning of `__phi` (and `__phi32`) differs from `16*(x/77)` by a small factor that only depends on `x%2310`, so adding a table with these factors results in another large speedup. These tables take a total of ~4kB.

v5: the tables introduced a significant initialization time for `prime_pi`, and William asked me to fix this, so `prime_pi` (and legendres_formula) only initialize these tables on an initial call -- so initialization time is now ~650ns:

```
sage: timeit('sage.functions.prime_pi.PrimePi()')
625 loops, best of 3: 627 ns per loop
```

Both Yann and I have tested `9.75*10^15` again and got the correct result, I also did `10^16`. We both ran it on 64-bit GNU/Linux systems. So the issue I was encountering may have been due to boundary issues with the `__cached_primes` method (which have been rewritten over the course of the patches). I kept the limit in since I haven't yet tested this thoroughly.



---

archive/attachments_015124.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_11475v5.patch",
    "asset_url": "tarball://root/attachments/ticket11475/trac_11475v5.patch",
    "created_at": "2011-06-17T21:13:34Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket11475/trac_11475v5.patch",
    "user": "https://github.com/ohanar"
}
```



---

archive/issue_comments_118498.json:
```json
{
    "body": "Attachment [trac_11475v5.patch](https://github.com/sagemath/sage/files/ticket11475/trac_11475v5.patch) by @ohanar created at 2011-06-17 21:13:34\n\nReduced initialization time",
    "created_at": "2011-06-17T21:13:34Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118498",
    "user": "https://github.com/ohanar"
}
```

Attachment [trac_11475v5.patch](https://github.com/sagemath/sage/files/ticket11475/trac_11475v5.patch) by @ohanar created at 2011-06-17 21:13:34

Reduced initialization time



---

archive/issue_comments_118499.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -91,4 +91,4 @@\n \n ---\n \n-Apply only [attachment:trac_11475v4.patch].\n+Apply only [attachment:trac_11475v5.patch].\n``````\n",
    "created_at": "2011-06-17T21:13:48Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118499",
    "user": "https://github.com/ohanar"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -91,4 +91,4 @@
 
 ---
 
-Apply only [attachment:trac_11475v4.patch].
+Apply only [attachment:trac_11475v5.patch].
``````




---

archive/issue_comments_118500.json:
```json
{
    "body": "<a id='comment:21'></a>\nI've so far only tested a little (on 64-bit Linux; dead old 32-bit box still building Sage), but already found one wrong result **with patch v3**:\n\n```\n  502000000000000  15296923904889   # 11475v3\n  502000000000000  15296922045596   # correct result, (at least) double-checked\n```\n\nNote that 502*10<sup>12</sup> is *below* 2<sup>49</sup> (562.949.953.421.312).\n\nAs my machines are still busy, you could perhaps check if the newer version(s) give the correct result.",
    "created_at": "2011-06-17T23:21:03Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118500",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:21'></a>
I've so far only tested a little (on 64-bit Linux; dead old 32-bit box still building Sage), but already found one wrong result **with patch v3**:

```
  502000000000000  15296923904889   # 11475v3
  502000000000000  15296922045596   # correct result, (at least) double-checked
```

Note that 502*10<sup>12</sup> is *below* 2<sup>49</sup> (562.949.953.421.312).

As my machines are still busy, you could perhaps check if the newer version(s) give the correct result.



---

archive/issue_comments_118501.json:
```json
{
    "body": "<a id='comment:22'></a>\nWorks on sage.math with 11475v5:\n\n```\nsage: time prime_pi(502000000000000)\n15296922045596\nTime: CPU 723.40 s, Wall: 723.43 s\n```",
    "created_at": "2011-06-17T23:49:15Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118501",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:22'></a>
Works on sage.math with 11475v5:

```
sage: time prime_pi(502000000000000)
15296922045596
Time: CPU 723.40 s, Wall: 723.43 s
```



---

archive/issue_comments_118502.json:
```json
{
    "body": "<a id='comment:23'></a>\nReplying to [ohanar](#comment%3A22):\n> Works on sage.math with 11475v5:\n\n\n```\n sage: time prime_pi(502000000000000)\n 15296922045596\n Time: CPU 723.40 s, Wall: 723.43 s\n```\n\nYep, here too; with both v4 and v5 (64-bit Linux).",
    "created_at": "2011-06-18T00:05:47Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118502",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:23'></a>
Replying to [ohanar](#comment%3A22):
> Works on sage.math with 11475v5:


```
 sage: time prime_pi(502000000000000)
 15296922045596
 Time: CPU 723.40 s, Wall: 723.43 s
```

Yep, here too; with both v4 and v5 (64-bit Linux).



---

archive/issue_comments_118503.json:
```json
{
    "body": "<a id='comment:24'></a>\n\n```\n  580000000000000  17596211452162\n^CException KeyboardInterrupt in 'sage.functions.prime_pi.PrimePi.__pi' ignored\n  581000000000000               0\n^CException KeyboardInterrupt in 'sage.functions.prime_pi.PrimePi.__pi' ignored\n  582000000000000               0\n^CException KeyboardInterrupt in 'sage.functions.prime_pi.PrimePi.__pi' ignored\n  583000000000000               0\n^CException KeyboardInterrupt in 'sage.functions.prime_pi.PrimePi.__pi' ignored\n  584000000000000               0\n^CException KeyboardInterrupt in 'sage.functions.prime_pi.PrimePi.__pi' ignored\n  585000000000000               0\n^CException KeyboardInterrupt in 'sage.functions.prime_pi.PrimePi.__pi' ignored\n  586000000000000               0\n```\nHmm, really?",
    "created_at": "2011-06-18T04:51:58Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118503",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:24'></a>

```
  580000000000000  17596211452162
^CException KeyboardInterrupt in 'sage.functions.prime_pi.PrimePi.__pi' ignored
  581000000000000               0
^CException KeyboardInterrupt in 'sage.functions.prime_pi.PrimePi.__pi' ignored
  582000000000000               0
^CException KeyboardInterrupt in 'sage.functions.prime_pi.PrimePi.__pi' ignored
  583000000000000               0
^CException KeyboardInterrupt in 'sage.functions.prime_pi.PrimePi.__pi' ignored
  584000000000000               0
^CException KeyboardInterrupt in 'sage.functions.prime_pi.PrimePi.__pi' ignored
  585000000000000               0
^CException KeyboardInterrupt in 'sage.functions.prime_pi.PrimePi.__pi' ignored
  586000000000000               0
```
Hmm, really?



---

archive/issue_comments_118504.json:
```json
{
    "body": "<a id='comment:25'></a>\nReplying to [leif](#comment%3A24):\n> \n> ```\n>   580000000000000  17596211452162\n> ^CException KeyboardInterrupt in 'sage.functions.prime_pi.PrimePi.__pi' ignored\n>   581000000000000               0\n> ^CException KeyboardInterrupt in 'sage.functions.prime_pi.PrimePi.__pi' ignored\n>   582000000000000               0\n> ^CException KeyboardInterrupt in 'sage.functions.prime_pi.PrimePi.__pi' ignored\n>   583000000000000               0\n> ^CException KeyboardInterrupt in 'sage.functions.prime_pi.PrimePi.__pi' ignored\n>   584000000000000               0\n> ^CException KeyboardInterrupt in 'sage.functions.prime_pi.PrimePi.__pi' ignored\n>   585000000000000               0\n> ^CException KeyboardInterrupt in 'sage.functions.prime_pi.PrimePi.__pi' ignored\n>   586000000000000               0\n> ```\n> Hmm, really?\n\n\nOops, thankfully easily fixed. Shouldn't occur in the next patch (whenever that is).",
    "created_at": "2011-06-18T06:29:59Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118504",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:25'></a>
Replying to [leif](#comment%3A24):
> 
> ```
>   580000000000000  17596211452162
> ^CException KeyboardInterrupt in 'sage.functions.prime_pi.PrimePi.__pi' ignored
>   581000000000000               0
> ^CException KeyboardInterrupt in 'sage.functions.prime_pi.PrimePi.__pi' ignored
>   582000000000000               0
> ^CException KeyboardInterrupt in 'sage.functions.prime_pi.PrimePi.__pi' ignored
>   583000000000000               0
> ^CException KeyboardInterrupt in 'sage.functions.prime_pi.PrimePi.__pi' ignored
>   584000000000000               0
> ^CException KeyboardInterrupt in 'sage.functions.prime_pi.PrimePi.__pi' ignored
>   585000000000000               0
> ^CException KeyboardInterrupt in 'sage.functions.prime_pi.PrimePi.__pi' ignored
>   586000000000000               0
> ```
> Hmm, really?


Oops, thankfully easily fixed. Shouldn't occur in the next patch (whenever that is).



---

archive/issue_comments_118505.json:
```json
{
    "body": "<a id='comment:26'></a>\nOk, here are my first 32-bit tests (with patch v5):\n\n```\nsage -t  \"devel/sage-11475v5/sage/functions/prime_pi.pyx\"   \n**********************************************************************\nFile \"/home/leif/Sage/sage-4.7/devel/sage-11475v5/sage/functions/prime_pi.pyx\", line 126:\n    sage: prime_pi(10**10)\nExpected:\n    455052511\nGot:\n    498132213\n**********************************************************************\n1 items had failures:\n   1 of  14 in __main__.example_1\n***Test Failed*** 1 failures.\nFor whitespace errors, see the file /home/leif/.sage//tmp/.doctest_prime_pi.py\n         [6.1 s]\n \n----------------------------------------------------------------------\nThe following tests failed:\n\n\n        sage -t  \"devel/sage-11475v5/sage/functions/prime_pi.pyx\"\nTotal time for all tests: 6.1 seconds\n\nreal    0m6.293s\nuser    0m5.328s\nsys     0m0.760s\n```\n\nWith long tests included, some unhandled overflows occur:\n\n```\nsage -t -long \"devel/sage-11475v5/sage/functions/prime_pi.pyx\"\nException OverflowError: 'long int too large to convert to int' in 'sage.functions.prime_pi.PrimePi.__sieve' ignored\nException OverflowError: 'long int too large to convert to int' in 'sage.functions.prime_pi.PrimePi.__sieve' ignored\nException OverflowError: 'long int too large to convert to int' in 'sage.functions.prime_pi.PrimePi.__sieve' ignored\nException OverflowError: 'long int too large to convert to int' in 'sage.functions.prime_pi.PrimePi.__sieve' ignored\nException OverflowError: 'long int too large to convert to int' in 'sage.functions.prime_pi.PrimePi.__sieve' ignored\nException OverflowError: 'long int too large to convert to int' in 'sage.functions.prime_pi.PrimePi.__sieve' ignored\nException OverflowError: 'long int too large to convert to int' in 'sage.functions.prime_pi.PrimePi.__sieve' ignored\nException OverflowError: 'long int too large to convert to int' in 'sage.functions.prime_pi.PrimePi.__sieve' ignored\nException OverflowError: 'long int too large to convert to int' in 'sage.functions.prime_pi.PrimePi.__sieve' ignored\nException OverflowError: 'long int too large to convert to int' in 'sage.functions.prime_pi.PrimePi.__sieve' ignored\nException OverflowError: 'long int too large to convert to int' in 'sage.functions.prime_pi.PrimePi.__sieve' ignored\n**********************************************************************\nFile \"/home/leif/Sage/sage-4.7/devel/sage-11475v5/sage/functions/prime_pi.pyx\", line 126:\n    sage: prime_pi(10**10)\nExpected:\n    455052511\nGot:\n    498132213\n**********************************************************************\nFile \"/home/leif/Sage/sage-4.7/devel/sage-11475v5/sage/functions/prime_pi.pyx\", line 231:\n    sage: for n in (42,41..32): prime_pi(2**n) # long time (21s on mod.math, 2011)\nExpected:\n    156661034233\n    80316571436\n    41203088796\n    21151907950\n    10866266172\n    5586502348\n    2874398515\n    1480206279\n    762939111\n    393615806\n    203280221\nGot:\n    2072485352\n    555689055\n    4249350341\n    1916569322\n    829105263\n    2484680881\n    3345496393\n    1649125207\n    813719441\n    403824770\n    203621732\n**********************************************************************\n2 items had failures:\n   1 of  14 in __main__.example_1\n   1 of  14 in __main__.example_4\n***Test Failed*** 2 failures.\nFor whitespace errors, see the file /home/leif/.sage//tmp/.doctest_prime_pi.py\n         [52.1 s]\n \n----------------------------------------------------------------------\nThe following tests failed:\n\n\n        sage -t -long \"devel/sage-11475v5/sage/functions/prime_pi.pyx\"\nTotal time for all tests: 52.2 seconds\n\nreal    0m52.318s\nuser    0m49.923s\nsys     0m0.956s\n```\n\nThis is on Ubuntu 7.10 :) (P4 Northwood, gcc 4.2.1) with Sage 4.7.",
    "created_at": "2011-06-18T14:40:38Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118505",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:26'></a>
Ok, here are my first 32-bit tests (with patch v5):

```
sage -t  "devel/sage-11475v5/sage/functions/prime_pi.pyx"   
**********************************************************************
File "/home/leif/Sage/sage-4.7/devel/sage-11475v5/sage/functions/prime_pi.pyx", line 126:
    sage: prime_pi(10**10)
Expected:
    455052511
Got:
    498132213
**********************************************************************
1 items had failures:
   1 of  14 in __main__.example_1
***Test Failed*** 1 failures.
For whitespace errors, see the file /home/leif/.sage//tmp/.doctest_prime_pi.py
         [6.1 s]
 
----------------------------------------------------------------------
The following tests failed:


        sage -t  "devel/sage-11475v5/sage/functions/prime_pi.pyx"
Total time for all tests: 6.1 seconds

real    0m6.293s
user    0m5.328s
sys     0m0.760s
```

With long tests included, some unhandled overflows occur:

```
sage -t -long "devel/sage-11475v5/sage/functions/prime_pi.pyx"
Exception OverflowError: 'long int too large to convert to int' in 'sage.functions.prime_pi.PrimePi.__sieve' ignored
Exception OverflowError: 'long int too large to convert to int' in 'sage.functions.prime_pi.PrimePi.__sieve' ignored
Exception OverflowError: 'long int too large to convert to int' in 'sage.functions.prime_pi.PrimePi.__sieve' ignored
Exception OverflowError: 'long int too large to convert to int' in 'sage.functions.prime_pi.PrimePi.__sieve' ignored
Exception OverflowError: 'long int too large to convert to int' in 'sage.functions.prime_pi.PrimePi.__sieve' ignored
Exception OverflowError: 'long int too large to convert to int' in 'sage.functions.prime_pi.PrimePi.__sieve' ignored
Exception OverflowError: 'long int too large to convert to int' in 'sage.functions.prime_pi.PrimePi.__sieve' ignored
Exception OverflowError: 'long int too large to convert to int' in 'sage.functions.prime_pi.PrimePi.__sieve' ignored
Exception OverflowError: 'long int too large to convert to int' in 'sage.functions.prime_pi.PrimePi.__sieve' ignored
Exception OverflowError: 'long int too large to convert to int' in 'sage.functions.prime_pi.PrimePi.__sieve' ignored
Exception OverflowError: 'long int too large to convert to int' in 'sage.functions.prime_pi.PrimePi.__sieve' ignored
**********************************************************************
File "/home/leif/Sage/sage-4.7/devel/sage-11475v5/sage/functions/prime_pi.pyx", line 126:
    sage: prime_pi(10**10)
Expected:
    455052511
Got:
    498132213
**********************************************************************
File "/home/leif/Sage/sage-4.7/devel/sage-11475v5/sage/functions/prime_pi.pyx", line 231:
    sage: for n in (42,41..32): prime_pi(2**n) # long time (21s on mod.math, 2011)
Expected:
    156661034233
    80316571436
    41203088796
    21151907950
    10866266172
    5586502348
    2874398515
    1480206279
    762939111
    393615806
    203280221
Got:
    2072485352
    555689055
    4249350341
    1916569322
    829105263
    2484680881
    3345496393
    1649125207
    813719441
    403824770
    203621732
**********************************************************************
2 items had failures:
   1 of  14 in __main__.example_1
   1 of  14 in __main__.example_4
***Test Failed*** 2 failures.
For whitespace errors, see the file /home/leif/.sage//tmp/.doctest_prime_pi.py
         [52.1 s]
 
----------------------------------------------------------------------
The following tests failed:


        sage -t -long "devel/sage-11475v5/sage/functions/prime_pi.pyx"
Total time for all tests: 52.2 seconds

real    0m52.318s
user    0m49.923s
sys     0m0.956s
```

This is on Ubuntu 7.10 :) (P4 Northwood, gcc 4.2.1) with Sage 4.7.



---

archive/issue_events_090547.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2011-06-18T14:40:38Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90547"
}
```



---

archive/issue_events_090548.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2011-06-18T14:40:38Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90548"
}
```



---

archive/issue_comments_118506.json:
```json
{
    "body": "<a id='comment:27'></a>\nUnfortunate, but kind of expected. It'll probably take a day or two for me to set up a 32-bit vm to try to debug the issue (it isn't blatantly obvious to me what is going wrong).",
    "created_at": "2011-06-18T21:55:54Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118506",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:27'></a>
Unfortunate, but kind of expected. It'll probably take a day or two for me to set up a 32-bit vm to try to debug the issue (it isn't blatantly obvious to me what is going wrong).



---

archive/issue_comments_118507.json:
```json
{
    "body": "<a id='comment:28'></a>\nReplying to [ohanar](#comment%3A27):\n> (it isn't blatantly obvious to me what is going wrong).\n\n\nYep, especially the \"long int doesn't fit into int\" reminds me of 16-bit systems... 8/",
    "created_at": "2011-06-18T22:01:26Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118507",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:28'></a>
Replying to [ohanar](#comment%3A27):
> (it isn't blatantly obvious to me what is going wrong).


Yep, especially the "long int doesn't fit into int" reminds me of 16-bit systems... 8/



---

archive/issue_comments_118508.json:
```json
{
    "body": "fixes issue on 32-bit systems",
    "created_at": "2011-06-19T08:44:16Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118508",
    "user": "https://github.com/ohanar"
}
```

fixes issue on 32-bit systems



---

archive/issue_comments_118509.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -91,4 +91,4 @@\n \n ---\n \n-Apply only [attachment:trac_11475v5.patch].\n+Apply only [attachment:trac_11475v6.patch].\n``````\n",
    "created_at": "2011-06-19T08:44:48Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118509",
    "user": "https://github.com/ohanar"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -91,4 +91,4 @@
 
 ---
 
-Apply only [attachment:trac_11475v5.patch].
+Apply only [attachment:trac_11475v6.patch].
``````




---

archive/issue_events_090549.json:
```json
{
    "actor": "https://github.com/ohanar",
    "created_at": "2011-06-19T08:44:48Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90549"
}
```



---

archive/issue_events_090550.json:
```json
{
    "actor": "https://github.com/ohanar",
    "created_at": "2011-06-19T08:44:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90550"
}
```



---

archive/attachments_015125.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_11475v6.patch",
    "asset_url": "tarball://root/attachments/ticket11475/trac_11475v6.patch",
    "created_at": "2011-06-19T08:44:48Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket11475/trac_11475v6.patch",
    "user": "https://github.com/ohanar"
}
```



---

archive/issue_comments_118510.json:
```json
{
    "body": "<a id='comment:29'></a>\nAttachment [trac_11475v6.patch](https://github.com/sagemath/sage/files/ticket11475/trac_11475v6.patch) by @ohanar created at 2011-06-19 08:44:48",
    "created_at": "2011-06-19T08:44:48Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118510",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:29'></a>
Attachment [trac_11475v6.patch](https://github.com/sagemath/sage/files/ticket11475/trac_11475v6.patch) by @ohanar created at 2011-06-19 08:44:48



---

archive/issue_comments_118511.json:
```json
{
    "body": "<a id='comment:30'></a>\nHopefully that was the only issue with 32-bit systems. Basically gmp wants a 32-bit int for mpz_set_ui on 32-bit systems, so I gave it what it wanted (this was also causing the issue with the `__sieve` function, since I use the `mpz_sqrt` function to calculate the argument).\n\nI am currently doing some more thorough testing with large values on a 64-bit machine, so that we can be sure there isn't any more breakage on the stable platform.",
    "created_at": "2011-06-19T08:51:45Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118511",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:30'></a>
Hopefully that was the only issue with 32-bit systems. Basically gmp wants a 32-bit int for mpz_set_ui on 32-bit systems, so I gave it what it wanted (this was also causing the issue with the `__sieve` function, since I use the `mpz_sqrt` function to calculate the argument).

I am currently doing some more thorough testing with large values on a 64-bit machine, so that we can be sure there isn't any more breakage on the stable platform.



---

archive/issue_comments_118512.json:
```json
{
    "body": "<a id='comment:31'></a>\nReplying to [ohanar](#comment%3A30):\n> Hopefully that was the only issue with 32-bit systems.\n\n\nv6 passes long tests on the 32-bit Ubuntu 7.10 machine (in about a minute). More to come.",
    "created_at": "2011-06-19T10:14:27Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118512",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:31'></a>
Replying to [ohanar](#comment%3A30):
> Hopefully that was the only issue with 32-bit systems.


v6 passes long tests on the 32-bit Ubuntu 7.10 machine (in about a minute). More to come.



---

archive/issue_comments_118513.json:
```json
{
    "body": "<a id='comment:32'></a>\nApply only trac_11475v6.patch",
    "created_at": "2011-06-20T02:29:05Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118513",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:32'></a>
Apply only trac_11475v6.patch



---

archive/issue_comments_118514.json:
```json
{
    "body": "<a id='comment:33'></a>\nI have verified that `prime_pi` gives correct output for `i*10**12` with `0 <= i <= 1000` on x86_64 :). I am probably going to remove the bound flag and instead put a warning about larger values not being well tested if/when they are called.\n\nUnfortunately, I have also come across an issue with solaris 10 sparc (t2.math). The root of the cause is that `mpz_export` has the bit ordering arguments flipped. I am not aware of another way to get unsigned ints out of gmp integers, nor am I aware of a way to check the platform from cython. Also, I don't know if other platforms have this same issue (solaris86 or mac powerpc in particular), so if someone could test that, please let me know.",
    "created_at": "2011-06-21T04:08:34Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118514",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:33'></a>
I have verified that `prime_pi` gives correct output for `i*10**12` with `0 <= i <= 1000` on x86_64 :). I am probably going to remove the bound flag and instead put a warning about larger values not being well tested if/when they are called.

Unfortunately, I have also come across an issue with solaris 10 sparc (t2.math). The root of the cause is that `mpz_export` has the bit ordering arguments flipped. I am not aware of another way to get unsigned ints out of gmp integers, nor am I aware of a way to check the platform from cython. Also, I don't know if other platforms have this same issue (solaris86 or mac powerpc in particular), so if someone could test that, please let me know.



---

archive/issue_events_090551.json:
```json
{
    "actor": "https://github.com/ohanar",
    "created_at": "2011-06-21T04:08:34Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90551"
}
```



---

archive/issue_events_090552.json:
```json
{
    "actor": "https://github.com/ohanar",
    "created_at": "2011-06-21T04:08:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90552"
}
```



---

archive/attachments_015126.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_11475v8.patch",
    "asset_url": "tarball://root/attachments/ticket11475/trac_11475v8.patch",
    "created_at": "2011-06-21T05:12:41Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket11475/trac_11475v8.patch",
    "user": "https://github.com/ohanar"
}
```



---

archive/issue_comments_118515.json:
```json
{
    "body": "Attachment [trac_11475v8.patch](https://github.com/sagemath/sage/files/ticket11475/trac_11475v8.patch) by @ohanar created at 2011-06-21 05:12:41\n\n100% doctest coverage + slightly faster init + solaris/sparc fix",
    "created_at": "2011-06-21T05:12:41Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118515",
    "user": "https://github.com/ohanar"
}
```

Attachment [trac_11475v8.patch](https://github.com/sagemath/sage/files/ticket11475/trac_11475v8.patch) by @ohanar created at 2011-06-21 05:12:41

100% doctest coverage + slightly faster init + solaris/sparc fix



---

archive/issue_comments_118516.json:
```json
{
    "body": "<a id='comment:34'></a>\nApply only trac_11475v8.patch",
    "created_at": "2011-06-21T05:13:50Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118516",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:34'></a>
Apply only trac_11475v8.patch



---

archive/issue_events_090553.json:
```json
{
    "actor": "https://github.com/ohanar",
    "created_at": "2011-06-21T05:13:50Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90553"
}
```



---

archive/issue_events_090554.json:
```json
{
    "actor": "https://github.com/ohanar",
    "created_at": "2011-06-21T05:13:50Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90554"
}
```



---

archive/issue_comments_118517.json:
```json
{
    "body": "<a id='comment:35'></a>\nReplying to [ohanar](#comment%3A33):\n> I have verified that `prime_pi` gives correct output for `i*10**12` with `0 <= i <= 1000` on x86_64 :).\n\n\nBesides a couple of other values on individual machines, I've successfully computed pi(2<sup>k</sup>) for k=0...53 and pi(10<sup>k</sup>) for k=0...16 on each of three different machines (two of them 32-bit; all with patch *version 6*).\n\nSome computations are still in progress, but so far I could also verify the results of `prime_pi(2**54)` and `prime_pi(2**55)` (on at least one machine). I've also played a little with \"`legendres_formula()`\".\n\n\n\n\n> I am probably going to remove the bound flag and instead put a warning about larger values not being well tested if/when they are called.\n\n\nYes, I also think we can or should drop any \"artificial\" limit now, though I must admit I haven't really looked at the code yet...\n\n---\n\nI wonder if `legendres_formula()` shouldn't be renamed to `legendre_phi()` - better names appreciated, but the latter ( \\phi(x,a) ) seems to be quite established in literature, and `legendre_phi` would be analogous to e.g. `euler_phi` in Sage. (I know Wolfram and others call \"it\" - i.e., IMHO the method computing the respective function rather than the function itself - *Legendre's Formula* as well, but it's not that unambiguous.)\n\nI'd also mention in its docstring it's called the *partial sieve function*.",
    "created_at": "2011-06-23T02:35:48Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118517",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:35'></a>
Replying to [ohanar](#comment%3A33):
> I have verified that `prime_pi` gives correct output for `i*10**12` with `0 <= i <= 1000` on x86_64 :).


Besides a couple of other values on individual machines, I've successfully computed pi(2<sup>k</sup>) for k=0...53 and pi(10<sup>k</sup>) for k=0...16 on each of three different machines (two of them 32-bit; all with patch *version 6*).

Some computations are still in progress, but so far I could also verify the results of `prime_pi(2**54)` and `prime_pi(2**55)` (on at least one machine). I've also played a little with "`legendres_formula()`".




> I am probably going to remove the bound flag and instead put a warning about larger values not being well tested if/when they are called.


Yes, I also think we can or should drop any "artificial" limit now, though I must admit I haven't really looked at the code yet...

---

I wonder if `legendres_formula()` shouldn't be renamed to `legendre_phi()` - better names appreciated, but the latter ( \phi(x,a) ) seems to be quite established in literature, and `legendre_phi` would be analogous to e.g. `euler_phi` in Sage. (I know Wolfram and others call "it" - i.e., IMHO the method computing the respective function rather than the function itself - *Legendre's Formula* as well, but it's not that unambiguous.)

I'd also mention in its docstring it's called the *partial sieve function*.



---

archive/issue_comments_118518.json:
```json
{
    "body": "<a id='comment:36'></a>\nReplying to [leif](#comment%3A35):\n> Replying to [ohanar](#comment%3A33):\n> > I am probably going to remove the bound flag and instead put a warning about larger values not being well tested if/when they are called.\n\n> \n> Yes, I also think we can or should drop any \"artificial\" limit now, though I must admit I haven't really looked at the code yet...\n\n\nAh, I see, you already removed the restriction in patch v8 (and also added warnings w.r.t. seemingly \"endless\" computations, which I also wanted to suggest).\n\nThere's a small typo in `__call__()`'s docstring (the `2**32` should read `2**64`):\n\n```\n        This implementation uses unsigned 64-bit ints and thus does not\n        support `x >= 2**32`::\n            \n            sage: prime_pi(2^64)\n            Traceback (most recent call last):\n            ...\n            NotImplementedError: computation of prime_pi for x >= 2^64 is not implemented\n```\n\nAlso, there's a mixture of both kinds of exponentiation operators (`^` and `**`) throughout the [doc]strings; I'm not sure if we shouldn't use just one notation.",
    "created_at": "2011-06-24T05:04:59Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118518",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:36'></a>
Replying to [leif](#comment%3A35):
> Replying to [ohanar](#comment%3A33):
> > I am probably going to remove the bound flag and instead put a warning about larger values not being well tested if/when they are called.

> 
> Yes, I also think we can or should drop any "artificial" limit now, though I must admit I haven't really looked at the code yet...


Ah, I see, you already removed the restriction in patch v8 (and also added warnings w.r.t. seemingly "endless" computations, which I also wanted to suggest).

There's a small typo in `__call__()`'s docstring (the `2**32` should read `2**64`):

```
        This implementation uses unsigned 64-bit ints and thus does not
        support `x >= 2**32`::
            
            sage: prime_pi(2^64)
            Traceback (most recent call last):
            ...
            NotImplementedError: computation of prime_pi for x >= 2^64 is not implemented
```

Also, there's a mixture of both kinds of exponentiation operators (`^` and `**`) throughout the [doc]strings; I'm not sure if we shouldn't use just one notation.



---

archive/issue_comments_118519.json:
```json
{
    "body": "<a id='comment:37'></a>\nReplying to [leif](#comment%3A35):\n> Replying to [ohanar](#comment%3A33):\n> > I have verified that `prime_pi` gives correct output for `i*10**12` with `0 <= i <= 1000` on x86_64 :).\n\n> \n> Besides a couple of other values on individual machines,\n\n\nWhich machines have you had issues with? Everything I have tested with v8 has worked (this includes x86 and x86_64 linux, 64bit Snow Leopard, and Sparc Solaris 10).\n\n---\n> I wonder if `legendres_formula()` shouldn't be renamed to `legendre_phi()` - better names appreciated, but the latter ( \\phi(x,a) ) seems to be quite established in literature, and `legendre_phi` would be analogous to e.g. `euler_phi` in Sage.\n\n\nMakes sense to me, if no one has an objection to the idea, I'll make the change.\n\n> I'd also mention in its docstring it's called the *partial sieve function*.\n\n\nSounds good to me.\n\n---\nReplying to [leif](#comment%3A36):\n> Also, there's a mixture of both kinds of exponentiation operators (`^` and `**`) throughout the [doc]strings; I'm not sure if we shouldn't use just one notation.\n\n\nWill do -- probably `^` since it is more consumer friendly.",
    "created_at": "2011-06-24T06:05:41Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118519",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:37'></a>
Replying to [leif](#comment%3A35):
> Replying to [ohanar](#comment%3A33):
> > I have verified that `prime_pi` gives correct output for `i*10**12` with `0 <= i <= 1000` on x86_64 :).

> 
> Besides a couple of other values on individual machines,


Which machines have you had issues with? Everything I have tested with v8 has worked (this includes x86 and x86_64 linux, 64bit Snow Leopard, and Sparc Solaris 10).

---
> I wonder if `legendres_formula()` shouldn't be renamed to `legendre_phi()` - better names appreciated, but the latter ( \phi(x,a) ) seems to be quite established in literature, and `legendre_phi` would be analogous to e.g. `euler_phi` in Sage.


Makes sense to me, if no one has an objection to the idea, I'll make the change.

> I'd also mention in its docstring it's called the *partial sieve function*.


Sounds good to me.

---
Replying to [leif](#comment%3A36):
> Also, there's a mixture of both kinds of exponentiation operators (`^` and `**`) throughout the [doc]strings; I'm not sure if we shouldn't use just one notation.


Will do -- probably `^` since it is more consumer friendly.



---

archive/issue_comments_118520.json:
```json
{
    "body": "<a id='comment:38'></a>\nReplying to [ohanar](#comment%3A37):\n> Replying to [leif](#comment%3A35):\n> > Replying to [ohanar](#comment%3A33):\n> > > I have verified that `prime_pi` gives correct output for `i*10**12` with `0 <= i <= 1000` on x86_64 :).\n\n> > \n> > Besides a couple of other values on individual machines,\n\n> Which machines have you had issues with?\n\nOh, I didn't get any wrong results; I just meant I've also tested `prime_pi(x)` with some \"random\" values (besides the mentioned powers of 2 and ten), but not systematically on all machines (all Linux boxes; Pentium4 Northwood, P4 Prescott and Core2).",
    "created_at": "2011-06-24T06:27:49Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118520",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:38'></a>
Replying to [ohanar](#comment%3A37):
> Replying to [leif](#comment%3A35):
> > Replying to [ohanar](#comment%3A33):
> > > I have verified that `prime_pi` gives correct output for `i*10**12` with `0 <= i <= 1000` on x86_64 :).

> > 
> > Besides a couple of other values on individual machines,

> Which machines have you had issues with?

Oh, I didn't get any wrong results; I just meant I've also tested `prime_pi(x)` with some "random" values (besides the mentioned powers of 2 and ten), but not systematically on all machines (all Linux boxes; Pentium4 Northwood, P4 Prescott and Core2).



---

archive/issue_comments_118521.json:
```json
{
    "body": "<a id='comment:39'></a>\nComputation of `prime_pi(2**56)` just finished with the correct result on one of the 32-bit machines :-) (took 2 days+).\n\n[Updated description w.r.t. (now obsolete) limitation / potentially wrong results for inputs exceeding 2<sup>49</sup> *with earlier versions*.]",
    "created_at": "2011-06-24T13:54:46Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118521",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:39'></a>
Computation of `prime_pi(2**56)` just finished with the correct result on one of the 32-bit machines :-) (took 2 days+).

[Updated description w.r.t. (now obsolete) limitation / potentially wrong results for inputs exceeding 2<sup>49</sup> *with earlier versions*.]



---

archive/issue_comments_118522.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -81,14 +81,14 @@\n 625 loops, best of 3: 343 ns per loop\n ```\n \n-This doesn't cost very much memory, since everything is stored as 32-bit ints, but `prime_range` is currently built on top of pari, which poses a number of problems, but the primary concern is that it is a memory hog when sieving to a large upper bound (important for plotting purposes).\n+This doesn't cost very much memory, since everything is stored as 32-bit ints, but `prime_range()` is currently built on top of PARI, which poses a number of problems, but the primary concern is that it is a memory hog when sieving to a large upper bound (important for plotting purposes).\n \n-I know that this implementation starts to fail to give correct output on 64-bit systems somewhere between `9.5*10**15` and `9.75*10**15`, for issues that I have been unable to determine. I have limited input to be `< 2**49`, which I am fairly confident is safe, as I have done a fair bit of testing in this range trying to debug this issue (despite it taking hours per call). I would appreciate testing on 32-bit platforms.\n+An earlier version of this implementation started to fail to give correct output on 64-bit systems somewhere between `9.5*10**15` and `9.75*10**15`, for issues that I had previously been unable to determine, so I had initially limited input to be `< 2**49`, which I am fairly confident is safe, as I have done a fair bit of testing in this range trying to debug this issue (despite it taking hours per call). I would appreciate testing on 32-bit platforms.\n \n A lot of the speed of this algorithm relies on the `__cached_count` method, which is essentially a binary search (with a simple adjustment in the beginning that takes advantage of the density of the primes). This is the fastest type of binary search I know of, but if anyone knows of a way to speed it up, it could have a significant effect. (Thanks to Yann for his suggestion)\n \n-Finally, I have introduced the `legendres_formula` method, which takes two arguments, `x` and `a`, and returns the number of positive integers not larger than `x` that are not divisible by -- i.e. co-prime to -- each of the first `a` primes. This function is core to all combinatorial methods for computing the prime counting function, so I figured that I would make this publicly accessible now that I have clean code.\n+Finally, I have introduced the `legendres_formula` method, which takes two arguments, `x` and `a`, and returns the number of positive integers not larger than `x` that are not divisible by any -- i.e. co-prime to each -- of the first `a` primes. This function is core to all combinatorial methods for computing the prime counting function, so I figured that I would make this publicly accessible now that I have clean code.\n \n ---\n \n-Apply only [attachment:trac_11475v6.patch].\n+Apply only [attachment:trac_11475v8.patch].\n``````\n",
    "created_at": "2011-06-24T13:54:46Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118522",
    "user": "https://github.com/nexttime"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -81,14 +81,14 @@
 625 loops, best of 3: 343 ns per loop
 ```
 
-This doesn't cost very much memory, since everything is stored as 32-bit ints, but `prime_range` is currently built on top of pari, which poses a number of problems, but the primary concern is that it is a memory hog when sieving to a large upper bound (important for plotting purposes).
+This doesn't cost very much memory, since everything is stored as 32-bit ints, but `prime_range()` is currently built on top of PARI, which poses a number of problems, but the primary concern is that it is a memory hog when sieving to a large upper bound (important for plotting purposes).
 
-I know that this implementation starts to fail to give correct output on 64-bit systems somewhere between `9.5*10**15` and `9.75*10**15`, for issues that I have been unable to determine. I have limited input to be `< 2**49`, which I am fairly confident is safe, as I have done a fair bit of testing in this range trying to debug this issue (despite it taking hours per call). I would appreciate testing on 32-bit platforms.
+An earlier version of this implementation started to fail to give correct output on 64-bit systems somewhere between `9.5*10**15` and `9.75*10**15`, for issues that I had previously been unable to determine, so I had initially limited input to be `< 2**49`, which I am fairly confident is safe, as I have done a fair bit of testing in this range trying to debug this issue (despite it taking hours per call). I would appreciate testing on 32-bit platforms.
 
 A lot of the speed of this algorithm relies on the `__cached_count` method, which is essentially a binary search (with a simple adjustment in the beginning that takes advantage of the density of the primes). This is the fastest type of binary search I know of, but if anyone knows of a way to speed it up, it could have a significant effect. (Thanks to Yann for his suggestion)
 
-Finally, I have introduced the `legendres_formula` method, which takes two arguments, `x` and `a`, and returns the number of positive integers not larger than `x` that are not divisible by -- i.e. co-prime to -- each of the first `a` primes. This function is core to all combinatorial methods for computing the prime counting function, so I figured that I would make this publicly accessible now that I have clean code.
+Finally, I have introduced the `legendres_formula` method, which takes two arguments, `x` and `a`, and returns the number of positive integers not larger than `x` that are not divisible by any -- i.e. co-prime to each -- of the first `a` primes. This function is core to all combinatorial methods for computing the prime counting function, so I figured that I would make this publicly accessible now that I have clean code.
 
 ---
 
-Apply only [attachment:trac_11475v6.patch].
+Apply only [attachment:trac_11475v8.patch].
``````




---

archive/attachments_015127.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_11475v9.patch",
    "asset_url": "tarball://root/attachments/ticket11475/trac_11475v9.patch",
    "created_at": "2011-06-28T08:18:11Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket11475/trac_11475v9.patch",
    "user": "https://github.com/ohanar"
}
```



---

archive/issue_comments_118523.json:
```json
{
    "body": "Attachment [trac_11475v9.patch](https://github.com/sagemath/sage/files/ticket11475/trac_11475v9.patch) by @ohanar created at 2011-06-28 08:18:11\n\nSee comment #40",
    "created_at": "2011-06-28T08:18:11Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118523",
    "user": "https://github.com/ohanar"
}
```

Attachment [trac_11475v9.patch](https://github.com/sagemath/sage/files/ticket11475/trac_11475v9.patch) by @ohanar created at 2011-06-28 08:18:11

See comment #40



---

archive/issue_comments_118524.json:
```json
{
    "body": "<a id='comment:40'></a>\nSo through the updates, I haven't been keeping `legendres_formula` up to date. I am posting a patch that should fix the bugs that were present for the past few versions (primarily, calling it with a relatively small `x` in comparison to `a` would give an extremely wrong answer due to overflow issues). I have also changed the name, so it now is called either `legendre_phi` or `partial_sieve_function`.\n\nThe patch also makes all documentation use `^`, there are no longer any instances of `**`.\n\nThe patch also touches up on `__phi` and `__phi32` -- cleaning up code, adding a few comments, and makes a simple optimization to reduce boolean checks for small `x` values (~10% speedup for large input).\n\nI'm hoping this will be the final patch for this ticket, so that I don't go into the double digits for version numbers :-).\n\nApply only trac_11475v9.patch",
    "created_at": "2011-06-28T08:18:33Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118524",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:40'></a>
So through the updates, I haven't been keeping `legendres_formula` up to date. I am posting a patch that should fix the bugs that were present for the past few versions (primarily, calling it with a relatively small `x` in comparison to `a` would give an extremely wrong answer due to overflow issues). I have also changed the name, so it now is called either `legendre_phi` or `partial_sieve_function`.

The patch also makes all documentation use `^`, there are no longer any instances of `**`.

The patch also touches up on `__phi` and `__phi32` -- cleaning up code, adding a few comments, and makes a simple optimization to reduce boolean checks for small `x` values (~10% speedup for large input).

I'm hoping this will be the final patch for this ticket, so that I don't go into the double digits for version numbers :-).

Apply only trac_11475v9.patch



---

archive/issue_comments_118525.json:
```json
{
    "body": "<a id='comment:41'></a>\nThe new version comes in the right moment as the slow 32-bit machine just finished computing `prime_pi(2^57)` (successfully; still with v6 though). No separate timings, but pi(2<sup>54</sup>) ... pi(2<sup>57</sup>) took 7.5 days in total. :-)\n\nAt first glance, there are only a few typos:\n\n* There's a superfluous `+` in the computation of `self.__tabS[i]` (continuation line).\n* The 2<sup>49</sup> remains renitent:\n\n```\n    cdef uint64_t __pi(self, uint64_t x) except -1: \n        r\"\"\" \n        Returns :math:`\\pi(x)` and assumes :math:`self.__maxSieve < x < 2^{49}` \n        \"\"\" \n```\n* `s/`number of primes`/`number of positive integers`/`:\n\n```\n    cdef uint64_t __phi(self, uint64_t x, uint64_t i): \n        r\"\"\" \n        Legendre's formula: returns the number of primes :math:`\\leq` ``x`` \n        that are not divisible by the first ``i`` primes \n        \"\"\"\n```",
    "created_at": "2011-06-28T10:33:04Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118525",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:41'></a>
The new version comes in the right moment as the slow 32-bit machine just finished computing `prime_pi(2^57)` (successfully; still with v6 though). No separate timings, but pi(2<sup>54</sup>) ... pi(2<sup>57</sup>) took 7.5 days in total. :-)

At first glance, there are only a few typos:

* There's a superfluous `+` in the computation of `self.__tabS[i]` (continuation line).
* The 2<sup>49</sup> remains renitent:

```
    cdef uint64_t __pi(self, uint64_t x) except -1: 
        r""" 
        Returns :math:`\pi(x)` and assumes :math:`self.__maxSieve < x < 2^{49}` 
        """ 
```
* `s/`number of primes`/`number of positive integers`/`:

```
    cdef uint64_t __phi(self, uint64_t x, uint64_t i): 
        r""" 
        Legendre's formula: returns the number of primes :math:`\leq` ``x`` 
        that are not divisible by the first ``i`` primes 
        """
```



---

archive/issue_comments_118526.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -91,4 +91,4 @@\n \n ---\n \n-Apply only [attachment:trac_11475v8.patch].\n+Apply only [attachment:trac_11475v9.patch].\n``````\n",
    "created_at": "2011-06-28T10:33:04Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118526",
    "user": "https://github.com/nexttime"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -91,4 +91,4 @@
 
 ---
 
-Apply only [attachment:trac_11475v8.patch].
+Apply only [attachment:trac_11475v9.patch].
``````




---

archive/issue_comments_118527.json:
```json
{
    "body": "<a id='comment:42'></a>\nSo far passed all [long] tests on Ubuntu 7.10 x86 (Sage 4.7) and Ubuntu 9.04 x86_64 (Sage 4.7.1.alpha3; patch to `module_list.py` applies with 1 line offset).\n\nThat's of course a bit funny (I don't mind):\n\n```\nsage: legendre_phi(2^63,0)\ncomputation of legendre_phi for large x can take minutes, hours, or days depending on the size of x\ncomputation of legendre_phi for x >= 10^15 has not been thoroughly tested, be cautious of the result\n9223372036854775808\nsage: \n```\nWe may also add \"*or weeks*\", but the current version is faster than the previous ones and **much** faster than the current version in Sage of course (not to mention its odd limitation).\n\nThere are opportunities for further improvements (e.g. copying the whole list of primes when we need more; perhaps some more comments / documentation), but these can IMHO be left to follow-up tickets.\n\nIn principle positive review from me (minus the typos), just hesitating to give it at this point without having studied the code more thoroughly.",
    "created_at": "2011-06-28T12:07:38Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118527",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:42'></a>
So far passed all [long] tests on Ubuntu 7.10 x86 (Sage 4.7) and Ubuntu 9.04 x86_64 (Sage 4.7.1.alpha3; patch to `module_list.py` applies with 1 line offset).

That's of course a bit funny (I don't mind):

```
sage: legendre_phi(2^63,0)
computation of legendre_phi for large x can take minutes, hours, or days depending on the size of x
computation of legendre_phi for x >= 10^15 has not been thoroughly tested, be cautious of the result
9223372036854775808
sage: 
```
We may also add "*or weeks*", but the current version is faster than the previous ones and **much** faster than the current version in Sage of course (not to mention its odd limitation).

There are opportunities for further improvements (e.g. copying the whole list of primes when we need more; perhaps some more comments / documentation), but these can IMHO be left to follow-up tickets.

In principle positive review from me (minus the typos), just hesitating to give it at this point without having studied the code more thoroughly.



---

archive/issue_comments_118528.json:
```json
{
    "body": "**Reviewer:** Yann Laigle-Chapuy, Leif Leonhardy",
    "created_at": "2011-06-28T12:07:38Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118528",
    "user": "https://github.com/nexttime"
}
```

**Reviewer:** Yann Laigle-Chapuy, Leif Leonhardy



---

archive/issue_comments_118529.json:
```json
{
    "body": "<a id='comment:43'></a>\nAnother corner case:\n\n```\nsage: legendre_phi(1000,10^10)\n---------------------------------------------------------------------------\nNotImplementedError                       Traceback (most recent call last)\n\n/home/leif/Sage/sage-4.7.1.alpha3/devel/sage-11475v9/<ipython console> in <module>()\n\n/home/leif/Sage/sage-4.7.1.alpha3/local/lib/python2.6/site-packages/sage/functions/prime_pi.so in sage.functions.prime_pi.legendre_phi (sage/functions/prime_pi.c:5888)()\n\n/home/leif/Sage/sage-4.7.1.alpha3/local/lib/python2.6/site-packages/sage/functions/prime_pi.so in sage.functions.prime_pi.legendre_phi (sage/functions/prime_pi.c:5517)()\n\nNotImplementedError: computing legendre_phi for a > prime_pi(2^32-1) not implemented\nsage: \n```\n(The message is a bit misleading by the way, since we limit **`x`** to 64 bits, and therefore the result is independent of `a >= 2^32`. If at all, I'd also give the numerical upper limit for `a`, i.e. 203280221. But as I said, there isn't really any limit on `a`.)\n\n\n\nAlso, **don't try this at home**:\n\n```\nsage: time legendre_phi(1000,10^8)\n```\n(I fortunately could kill the process before the almost freezed machine went out of swap space. Apparently computing the list of primes is uninterruptable, which worsens the situation.)",
    "created_at": "2011-06-28T13:05:27Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118529",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:43'></a>
Another corner case:

```
sage: legendre_phi(1000,10^10)
---------------------------------------------------------------------------
NotImplementedError                       Traceback (most recent call last)

/home/leif/Sage/sage-4.7.1.alpha3/devel/sage-11475v9/<ipython console> in <module>()

/home/leif/Sage/sage-4.7.1.alpha3/local/lib/python2.6/site-packages/sage/functions/prime_pi.so in sage.functions.prime_pi.legendre_phi (sage/functions/prime_pi.c:5888)()

/home/leif/Sage/sage-4.7.1.alpha3/local/lib/python2.6/site-packages/sage/functions/prime_pi.so in sage.functions.prime_pi.legendre_phi (sage/functions/prime_pi.c:5517)()

NotImplementedError: computing legendre_phi for a > prime_pi(2^32-1) not implemented
sage: 
```
(The message is a bit misleading by the way, since we limit **`x`** to 64 bits, and therefore the result is independent of `a >= 2^32`. If at all, I'd also give the numerical upper limit for `a`, i.e. 203280221. But as I said, there isn't really any limit on `a`.)



Also, **don't try this at home**:

```
sage: time legendre_phi(1000,10^8)
```
(I fortunately could kill the process before the almost freezed machine went out of swap space. Apparently computing the list of primes is uninterruptable, which worsens the situation.)



---

archive/issue_comments_118530.json:
```json
{
    "body": "<a id='comment:44'></a>\nReplying to [leif](#comment%3A43):\n> The message is a bit misleading by the way, since we limit **`x`** to 64 bits, and therefore the result is independent of `a >= 2^32`.\n\n\nMore precisely: independent of `a >= prime_pi(2^32)`. ;-)",
    "created_at": "2011-06-28T13:16:59Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118530",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:44'></a>
Replying to [leif](#comment%3A43):
> The message is a bit misleading by the way, since we limit **`x`** to 64 bits, and therefore the result is independent of `a >= 2^32`.


More precisely: independent of `a >= prime_pi(2^32)`. ;-)



---

archive/issue_comments_118531.json:
```json
{
    "body": "<a id='comment:45'></a>\nI'd also use `int_fast8_t` and `uint_fast8_t` instead of `int8_t` and `uint8_t`, since size doesn't really matter there:\n\n```patch\ndiff --git a/sage/functions/prime_pi.pyx b/sage/functions/prime_pi.pyx\n--- a/sage/functions/prime_pi.pyx\n+++ b/sage/functions/prime_pi.pyx\n@@ -32,7 +32,7 @@\n include '../ext/stdsage.pxi'\n include '../ext/interrupt.pxi'\n \n-from libc.stdint cimport int8_t, uint8_t, uint32_t, uint64_t\n+from libc.stdint cimport int_fast8_t, uint_fast8_t, uint32_t, uint64_t\n from sage.rings.integer cimport Integer\n from sage.rings.real_mpfr import RealLiteral, create_RealNumber, RR\n from sage.rings.arith import nth_prime\n@@ -134,8 +134,8 @@\n     cdef uint32_t __numPrimes\n     cdef uint32_t __maxSieve\n     cdef uint64_t __maxSieve64\n-    cdef int8_t[2310] __tabS\n-    cdef uint8_t[1619] __smallPi\n+    cdef int_fast8_t[2310] __tabS\n+    cdef uint_fast8_t[1619] __smallPi\n \n     def __dealloc__(self):\n         if self.__numPrimes:\n```",
    "created_at": "2011-06-28T14:23:05Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118531",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:45'></a>
I'd also use `int_fast8_t` and `uint_fast8_t` instead of `int8_t` and `uint8_t`, since size doesn't really matter there:

```patch
diff --git a/sage/functions/prime_pi.pyx b/sage/functions/prime_pi.pyx
--- a/sage/functions/prime_pi.pyx
+++ b/sage/functions/prime_pi.pyx
@@ -32,7 +32,7 @@
 include '../ext/stdsage.pxi'
 include '../ext/interrupt.pxi'
 
-from libc.stdint cimport int8_t, uint8_t, uint32_t, uint64_t
+from libc.stdint cimport int_fast8_t, uint_fast8_t, uint32_t, uint64_t
 from sage.rings.integer cimport Integer
 from sage.rings.real_mpfr import RealLiteral, create_RealNumber, RR
 from sage.rings.arith import nth_prime
@@ -134,8 +134,8 @@
     cdef uint32_t __numPrimes
     cdef uint32_t __maxSieve
     cdef uint64_t __maxSieve64
-    cdef int8_t[2310] __tabS
-    cdef uint8_t[1619] __smallPi
+    cdef int_fast8_t[2310] __tabS
+    cdef uint_fast8_t[1619] __smallPi
 
     def __dealloc__(self):
         if self.__numPrimes:
```



---

archive/issue_comments_118532.json:
```json
{
    "body": "<a id='comment:46'></a>\nReplying to [leif](#comment%3A43):\n> Another corner case:\n> \n> ```\n> sage: legendre_phi(1000,10^10)\n> ---------------------------------------------------------------------------\n> NotImplementedError                       Traceback (most recent call last)\n> \n> /home/leif/Sage/sage-4.7.1.alpha3/devel/sage-11475v9/<ipython console> in <module>()\n> \n> /home/leif/Sage/sage-4.7.1.alpha3/local/lib/python2.6/site-packages/sage/functions/prime_pi.so in sage.functions.prime_pi.legendre_phi (sage/functions/prime_pi.c:5888)()\n> \n> /home/leif/Sage/sage-4.7.1.alpha3/local/lib/python2.6/site-packages/sage/functions/prime_pi.so in sage.functions.prime_pi.legendre_phi (sage/functions/prime_pi.c:5517)()\n> \n> NotImplementedError: computing legendre_phi for a > prime_pi(2^32-1) not implemented\n> sage: \n> ```\n> (The message is a bit misleading by the way, since we limit **`x`** to 64 bits, and therefore the result is independent of `a >= 2^32`. If at all, I'd also give the numerical upper limit for `a`, i.e. 203280221. But as I said, there isn't really any limit on `a`.)\n\n\nOf course, I wrote the method as a wrapper for __phi, so I was mainly thinking of what I needed to call that method. I can easily remove this bound.\n> \n> Also, **don't try this at home**:\n> \n> ```\n> sage: time legendre_phi(1000,10^8)\n> ```\n> (I fortunately could kill the process before the almost freezed machine went out of swap space. Apparently computing the list of primes is uninterruptable, which worsens the situation.)\n\n\nWhen fixing the above issue, I can fix this. This same issue will appear for very large `x` for `prime_pi`, this can be blamed on PARI -- it stores the primes inefficiently and will use ~17GB for a sieve up to `2**32-1` (my code should use ~1GB at this size). I can implement a custom sieve if it this poses much of an issue (eventually though something needs to be done to fix `prime_range`).",
    "created_at": "2011-06-28T17:27:24Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118532",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:46'></a>
Replying to [leif](#comment%3A43):
> Another corner case:
> 
> ```
> sage: legendre_phi(1000,10^10)
> ---------------------------------------------------------------------------
> NotImplementedError                       Traceback (most recent call last)
> 
> /home/leif/Sage/sage-4.7.1.alpha3/devel/sage-11475v9/<ipython console> in <module>()
> 
> /home/leif/Sage/sage-4.7.1.alpha3/local/lib/python2.6/site-packages/sage/functions/prime_pi.so in sage.functions.prime_pi.legendre_phi (sage/functions/prime_pi.c:5888)()
> 
> /home/leif/Sage/sage-4.7.1.alpha3/local/lib/python2.6/site-packages/sage/functions/prime_pi.so in sage.functions.prime_pi.legendre_phi (sage/functions/prime_pi.c:5517)()
> 
> NotImplementedError: computing legendre_phi for a > prime_pi(2^32-1) not implemented
> sage: 
> ```
> (The message is a bit misleading by the way, since we limit **`x`** to 64 bits, and therefore the result is independent of `a >= 2^32`. If at all, I'd also give the numerical upper limit for `a`, i.e. 203280221. But as I said, there isn't really any limit on `a`.)


Of course, I wrote the method as a wrapper for __phi, so I was mainly thinking of what I needed to call that method. I can easily remove this bound.
> 
> Also, **don't try this at home**:
> 
> ```
> sage: time legendre_phi(1000,10^8)
> ```
> (I fortunately could kill the process before the almost freezed machine went out of swap space. Apparently computing the list of primes is uninterruptable, which worsens the situation.)


When fixing the above issue, I can fix this. This same issue will appear for very large `x` for `prime_pi`, this can be blamed on PARI -- it stores the primes inefficiently and will use ~17GB for a sieve up to `2**32-1` (my code should use ~1GB at this size). I can implement a custom sieve if it this poses much of an issue (eventually though something needs to be done to fix `prime_range`).



---

archive/issue_comments_118533.json:
```json
{
    "body": "<a id='comment:47'></a>\nReplying to [ohanar](#comment%3A46):\n> Replying to [leif](#comment%3A43):\n> > (I fortunately could kill the process before the almost freezed machine went out of swap space. Apparently computing the list of primes is uninterruptable, which worsens the situation.)\n\n> \n> When fixing the above issue, I can fix this. This same issue will appear for very large `x` for `prime_pi`, this can be blamed on PARI -- it stores the primes inefficiently and will use ~17GB for a sieve up to `2**32-1`.\n\n\nOuch. (Or should it read 1.7 GB, with ~8 bytes per prime? Otherwise there would be a real hardware limit - max. 2 or 4 GB address space - on 32-bit machines and OSs I haven't yet met during the tests.)\n\nI thought the huge memory consumption was mostly the fault of `prime_range()` (and Python), and to some extent of having up to three or four lists or arrays of primes at the same time (PARI + Python + perhaps two Cython arrays while copying).\n\nWould using Python ints (`py_ints=True` parameter to `prime_range()`) alleviate the situation in any way?\n\nOne could also request the primes in chunks rather than the whole interval at once, or implement some generator class or function that calls PARI.\n\nUsing `sage_realloc()` would also reduce the (peak) physical memory requirement. \n\n\n\n\n> I can implement a custom sieve if this poses much of an issue (eventually though something needs to be done to fix `prime_range`).\n\n\nHmmm. I thought we could avoid using `prime_range()` *later*, on a follow-up, e.g. by directly accessing PARI from Cython. But feel free to implement or use some other sieve / function.\n\nAt least potentially freezing the machine (which IMHO is an OS problem) isn't very user-friendly, especially in educational software I think...",
    "created_at": "2011-06-28T20:10:15Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118533",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:47'></a>
Replying to [ohanar](#comment%3A46):
> Replying to [leif](#comment%3A43):
> > (I fortunately could kill the process before the almost freezed machine went out of swap space. Apparently computing the list of primes is uninterruptable, which worsens the situation.)

> 
> When fixing the above issue, I can fix this. This same issue will appear for very large `x` for `prime_pi`, this can be blamed on PARI -- it stores the primes inefficiently and will use ~17GB for a sieve up to `2**32-1`.


Ouch. (Or should it read 1.7 GB, with ~8 bytes per prime? Otherwise there would be a real hardware limit - max. 2 or 4 GB address space - on 32-bit machines and OSs I haven't yet met during the tests.)

I thought the huge memory consumption was mostly the fault of `prime_range()` (and Python), and to some extent of having up to three or four lists or arrays of primes at the same time (PARI + Python + perhaps two Cython arrays while copying).

Would using Python ints (`py_ints=True` parameter to `prime_range()`) alleviate the situation in any way?

One could also request the primes in chunks rather than the whole interval at once, or implement some generator class or function that calls PARI.

Using `sage_realloc()` would also reduce the (peak) physical memory requirement. 




> I can implement a custom sieve if this poses much of an issue (eventually though something needs to be done to fix `prime_range`).


Hmmm. I thought we could avoid using `prime_range()` *later*, on a follow-up, e.g. by directly accessing PARI from Cython. But feel free to implement or use some other sieve / function.

At least potentially freezing the machine (which IMHO is an OS problem) isn't very user-friendly, especially in educational software I think...



---

archive/issue_comments_118534.json:
```json
{
    "body": "<a id='comment:48'></a>\nReplying to [leif](#comment%3A47):\n> Replying to [ohanar](#comment%3A46):\n> > This same issue will appear for very large `x` for `prime_pi`, this can be blamed on PARI -- it stores the primes inefficiently and will use ~17GB for a sieve up to `2**32-1`.\n\n\nThat might have been the case with older PARI versions; if I do\n\n```\nsage: time pari.init_primes(2^32)\nTime: CPU 13.42 s, Wall: 18.47 s\n```\nthe whole process just occupies about 283 MB (89 MB thereof basic Sage). And yes, all have been computed, as one can \"verify\" with e.g. the time it takes to get some primes around the current \"end\":\n\n```\nsage: prime_range(2^32,2^32+100) # immediate answer if init_primes(2^32) has been called in advance\n[4294967311, 4294967357, 4294967371, 4294967377, 4294967387, 4294967389]\n```\n\nThe fatal things are commands like this:\n\n```\nsage: prime_range(2^30)[-1]\n```\nwhich turns the relative prime offsets stored by PARI (hardly more than one byte per prime on average) into a list of boxed integers.",
    "created_at": "2011-06-28T22:56:12Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118534",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:48'></a>
Replying to [leif](#comment%3A47):
> Replying to [ohanar](#comment%3A46):
> > This same issue will appear for very large `x` for `prime_pi`, this can be blamed on PARI -- it stores the primes inefficiently and will use ~17GB for a sieve up to `2**32-1`.


That might have been the case with older PARI versions; if I do

```
sage: time pari.init_primes(2^32)
Time: CPU 13.42 s, Wall: 18.47 s
```
the whole process just occupies about 283 MB (89 MB thereof basic Sage). And yes, all have been computed, as one can "verify" with e.g. the time it takes to get some primes around the current "end":

```
sage: prime_range(2^32,2^32+100) # immediate answer if init_primes(2^32) has been called in advance
[4294967311, 4294967357, 4294967371, 4294967377, 4294967387, 4294967389]
```

The fatal things are commands like this:

```
sage: prime_range(2^30)[-1]
```
which turns the relative prime offsets stored by PARI (hardly more than one byte per prime on average) into a list of boxed integers.



---

archive/issue_comments_118535.json:
```json
{
    "body": "<a id='comment:49'></a>\nReplying to [leif](#comment%3A47):\n> Using `sage_realloc()` would also reduce the (peak) physical memory requirement. \n\n\nHow long has sage had `sage_realloc`? I could have sworn that it didn't exist a year ago.\n\n> > I can implement a custom sieve if this poses much of an issue (eventually though something needs to be done to fix `prime_range`).\n\n> \n> Hmmm. I thought we could avoid using `prime_range()` *later*, on a follow-up, e.g. by directly accessing PARI from Cython. But feel free to implement or use some other sieve / function.\n\n\nI have am working on v10, which will primarily change the `__sieve` function to directly access PARI and use `sage_realloc`. I have this working on 64-bit linux right now:\n\n```\nsage: get_memory_usage()\n844.1484375\nsage: time legendre_phi(1000,10^8)\n1\nTime: CPU 22.55 s, Wall: 22.54 s\nsage: get_memory_usage()\n1406.78515625\n```\n\nObviously I haven't made all the changes that I need to with `legendre_phi`, however it removes the potentially insane memory issues with using `prime_range`. Worst case scenario for storage now:\n\n```\nsage: time legendre_phi(1000, 203280221)\n1\nTime: CPU 46.85 s, Wall: 46.86 s\nsage: get_memory_usage()\n1975.58203125\n```",
    "created_at": "2011-06-29T07:14:25Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118535",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:49'></a>
Replying to [leif](#comment%3A47):
> Using `sage_realloc()` would also reduce the (peak) physical memory requirement. 


How long has sage had `sage_realloc`? I could have sworn that it didn't exist a year ago.

> > I can implement a custom sieve if this poses much of an issue (eventually though something needs to be done to fix `prime_range`).

> 
> Hmmm. I thought we could avoid using `prime_range()` *later*, on a follow-up, e.g. by directly accessing PARI from Cython. But feel free to implement or use some other sieve / function.


I have am working on v10, which will primarily change the `__sieve` function to directly access PARI and use `sage_realloc`. I have this working on 64-bit linux right now:

```
sage: get_memory_usage()
844.1484375
sage: time legendre_phi(1000,10^8)
1
Time: CPU 22.55 s, Wall: 22.54 s
sage: get_memory_usage()
1406.78515625
```

Obviously I haven't made all the changes that I need to with `legendre_phi`, however it removes the potentially insane memory issues with using `prime_range`. Worst case scenario for storage now:

```
sage: time legendre_phi(1000, 203280221)
1
Time: CPU 46.85 s, Wall: 46.86 s
sage: get_memory_usage()
1975.58203125
```



---

archive/issue_comments_118536.json:
```json
{
    "body": "<a id='comment:50'></a>\nJust for the record:\n\nThe second 32-bit machine just successfully computed `prime_pi(2^58)` (still patch version 6), which took about ten days on an already fully loaded system.",
    "created_at": "2011-07-01T11:41:49Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118536",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:50'></a>
Just for the record:

The second 32-bit machine just successfully computed `prime_pi(2^58)` (still patch version 6), which took about ten days on an already fully loaded system.



---

archive/attachments_015128.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_11475v10.patch",
    "asset_url": "tarball://root/attachments/ticket11475/trac_11475v10.patch",
    "created_at": "2011-07-04T05:43:23Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket11475/trac_11475v10.patch",
    "user": "https://github.com/ohanar"
}
```



---

archive/issue_comments_118537.json:
```json
{
    "body": "Attachment [trac_11475v10.patch](https://github.com/sagemath/sage/files/ticket11475/trac_11475v10.patch) by @ohanar created at 2011-07-04 05:43:23\n\nrewrote __sieve (now goes directly through pari) + some significant changes to legendre_phi",
    "created_at": "2011-07-04T05:43:23Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118537",
    "user": "https://github.com/ohanar"
}
```

Attachment [trac_11475v10.patch](https://github.com/sagemath/sage/files/ticket11475/trac_11475v10.patch) by @ohanar created at 2011-07-04 05:43:23

rewrote __sieve (now goes directly through pari) + some significant changes to legendre_phi



---

archive/issue_comments_118538.json:
```json
{
    "body": "<a id='comment:51'></a>\nBeen busy, but I finally managed to get another patch (after running into quite a number of issues). This has some pretty significant changes -- specifically to `legendre_phi` and `__sieve`.\n\n`legendre_phi` now has keyboard interrupt support :). Also, it removes the limit to `a` as well as make some other improvements to speed for various special cases.\n\n`__sieve` was rewritten to remove the use of `prime_range` and now works directly through PARI. Also `sage_realloc` was added (I wasn't aware that sage had `realloc`, I could have sworn that I tried using it before with no luck).\n\nApply only trac_11475v10.patch",
    "created_at": "2011-07-04T05:51:12Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118538",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:51'></a>
Been busy, but I finally managed to get another patch (after running into quite a number of issues). This has some pretty significant changes -- specifically to `legendre_phi` and `__sieve`.

`legendre_phi` now has keyboard interrupt support :). Also, it removes the limit to `a` as well as make some other improvements to speed for various special cases.

`__sieve` was rewritten to remove the use of `prime_range` and now works directly through PARI. Also `sage_realloc` was added (I wasn't aware that sage had `realloc`, I could have sworn that I tried using it before with no luck).

Apply only trac_11475v10.patch



---

archive/issue_comments_118539.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -91,4 +91,4 @@\n \n ---\n \n-Apply only [attachment:trac_11475v9.patch].\n+Apply only [attachment:trac_11475v10.patch].\n``````\n",
    "created_at": "2011-07-04T11:55:16Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118539",
    "user": "https://github.com/nexttime"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -91,4 +91,4 @@
 
 ---
 
-Apply only [attachment:trac_11475v9.patch].
+Apply only [attachment:trac_11475v10.patch].
``````




---

archive/attachments_015129.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_11475-v10_reviewer_1.sagelib.patch",
    "asset_url": "tarball://root/attachments/ticket11475/trac_11475-v10_reviewer_1.sagelib.patch",
    "created_at": "2011-07-08T14:30:23Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket11475/trac_11475-v10_reviewer_1.sagelib.patch",
    "user": "https://github.com/nexttime"
}
```



---

archive/issue_comments_118540.json:
```json
{
    "body": "Attachment [trac_11475-v10_reviewer_1.sagelib.patch](https://github.com/sagemath/sage/files/ticket11475/trac_11475-v10_reviewer_1.sagelib.patch) by @nexttime created at 2011-07-08 14:30:23\n\nSage library patch. Apply on top of Andrew's v10. (Actually also based on Sage 4.7.1.alpha4.)",
    "created_at": "2011-07-08T14:30:23Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118540",
    "user": "https://github.com/nexttime"
}
```

Attachment [trac_11475-v10_reviewer_1.sagelib.patch](https://github.com/sagemath/sage/files/ticket11475/trac_11475-v10_reviewer_1.sagelib.patch) by @nexttime created at 2011-07-08 14:30:23

Sage library patch. Apply on top of Andrew's v10. (Actually also based on Sage 4.7.1.alpha4.)



---

archive/issue_comments_118541.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -91,4 +91,8 @@\n \n ---\n \n-Apply only [attachment:trac_11475v10.patch].\n+Apply\n+1. [attachment:trac_11475v10.patch]\n+2. [attachment:trac_11475-v10_reviewer_1.sagelib.patch]\n+to the **Sage library**.\n+\n``````\n",
    "created_at": "2011-07-08T15:22:29Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118541",
    "user": "https://github.com/nexttime"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -91,4 +91,8 @@
 
 ---
 
-Apply only [attachment:trac_11475v10.patch].
+Apply
+1. [attachment:trac_11475v10.patch]
+2. [attachment:trac_11475-v10_reviewer_1.sagelib.patch]
+to the **Sage library**.
+
``````




---

archive/issue_comments_118542.json:
```json
{
    "body": "<a id='comment:53'></a>\nI've added a reviewer patch to Andrew's version 10:\n\n* PARI's `diffptr` is `uint8_t*` (actually `unsigned char*` or `byteptr`); using `uint_fast8_t*` there would fail on any machine on which `sizeof(uint8_t) != sizeof(uint_fast8_t)`.\n* Use the more portable `ptrdiff_t` for \"`__diffptrOff`\" (which will then also be smaller on 32-bit machines).\n* Change order of libraries in `module_list.py`, as PARI also depends on GMP, to support dumber linkers (necessary for at least Cygwin I guess).\n* `stdint.h` is C99, so add the corresponding compiler flag.\n\nThe superfluous `+` is still in, missed to fix that in my reviewer patch.\n\nI haven't yet really looked at the rest of the new code (i.e., v10), only performed the standard tests (`-long`) on both Ubuntu 9.04 x86 and x86_64 (Sage 4.7 and Sage 4.7.1.alpha4, respectively), which passed (seemingly slightly faster, but I may be wrong ;-) ).\n\nThe `module_list.py` part of Andrew's v10 patch applies to Sage 4.7.1.alpha4, too, but with an offset of -26 lines, so should perhaps be rebased.\n\n(Unfortunately my second 32-bit machine apparently died, on which I mainly tested `prime_pi()` for larger values previously.)",
    "created_at": "2011-07-08T15:22:29Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118542",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:53'></a>
I've added a reviewer patch to Andrew's version 10:

* PARI's `diffptr` is `uint8_t*` (actually `unsigned char*` or `byteptr`); using `uint_fast8_t*` there would fail on any machine on which `sizeof(uint8_t) != sizeof(uint_fast8_t)`.
* Use the more portable `ptrdiff_t` for "`__diffptrOff`" (which will then also be smaller on 32-bit machines).
* Change order of libraries in `module_list.py`, as PARI also depends on GMP, to support dumber linkers (necessary for at least Cygwin I guess).
* `stdint.h` is C99, so add the corresponding compiler flag.

The superfluous `+` is still in, missed to fix that in my reviewer patch.

I haven't yet really looked at the rest of the new code (i.e., v10), only performed the standard tests (`-long`) on both Ubuntu 9.04 x86 and x86_64 (Sage 4.7 and Sage 4.7.1.alpha4, respectively), which passed (seemingly slightly faster, but I may be wrong ;-) ).

The `module_list.py` part of Andrew's v10 patch applies to Sage 4.7.1.alpha4, too, but with an offset of -26 lines, so should perhaps be rebased.

(Unfortunately my second 32-bit machine apparently died, on which I mainly tested `prime_pi()` for larger values previously.)



---

archive/issue_comments_118543.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,40 +1,14 @@\n I have rewritten the `prime_pi` method from scratch, it is much cleaner and less hacky this time (as I have learned more about coding), however it is still based on the same algorithm as before (no LMO yet, although I intend to take a stab at it later this year). This was developed in parallel with a method to count primes in residue classes (ticket forthcoming).\n \n-The new version deals with a variety of input in a better fashion, without a too significant effect on timings: (all timings were done on mod.math)\n-\n-New:\n-\n-```\n-sage: timeit('prime_pi(1)')\n-625 loops, best of 3: 282 ns per loop\n-sage: timeit('prime_pi(0.5)')\n-625 loops, best of 3: 4.19 \u00b5s per loop\n-sage: timeit('prime_pi(sqrt(2))')\n-625 loops, best of 3: 384 \u00b5s per loop\n-sage: timeit('prime_pi(mod(1, 2))')\n-625 loops, best of 3: 8.94 \u00b5s per loop\n-```\n-Old:\n-\n-```\n-sage: timeit('prime_pi(1)')\n-625 loops, best of 3: 280 ns per loop\n-sage: timeit('prime_pi(0.5)')\n-625 loops, best of 3: 3.92 \u00b5s per loop\n-sage: timeit('prime_pi(sqrt(2))')\n-625 loops, best of 3: 383 \u00b5s per loop\n-sage: timeit('prime_pi(mod(1, 2))')\n-625 loops, best of 3: 7.38 \u00b5s per loop\n-```\n The overhead for small input `>= 2` is rather large in the current `prime_pi`, this has been dramatically improved:\n \n New:\n \n ```\n sage: timeit('prime_pi(100)')\n-625 loops, best of 3: 331 ns per loop\n+625 loops, best of 3: 475 ns per loop\n sage: timeit('prime_pi(10000)')\n-625 loops, best of 3: 971 ns per loop\n+625 loops, best of 3: 483 ns per loop\n ```\n Old:\n \n@@ -45,18 +19,18 @@\n 625 loops, best of 3: 5.56 \u00b5s per loop\n ```\n \n-There is also a ~3x speedup for larger input:\n+There is also a ~5x speedup (conservatively) for larger input:\n \n New:\n \n ```\n sage: timeit('prime_pi(10**8)')\n-125 loops, best of 3: 759 \u00b5s per loop\n+625 loops, best of 3: 530 \u00b5s per loop\n sage: timeit('prime_pi(10**10)')\n-5 loops, best of 3: 47.4 ms per loop\n+5 loops, best of 3: 27.1 ms per loop\n sage: time prime_pi(10**12)\n 37607912018\n-Time: CPU 2.86 s, Wall: 2.86 s\n+Time: CPU 1.53 s, Wall: 1.53 s\n ```\n Old:\n \n@@ -70,29 +44,26 @@\n Time: CPU 8.65 s, Wall: 8.64 s\n ```\n \n-Primes are now cached, which can give a significant speedup when making smaller calls after larger calls: (run after previous commands)\n+The user can also give a second argument to use additional memory for a potential speedup. All primes less than the second argument are used in computing pi(x). For example:\n \n ```\n-sage: timeit('prime_pi(10**10)')\n-5 loops, best of 3: 27.4 ms per loop\n-sage: timeit('prime_pi(10**8)')\n-625 loops, best of 3: 325 \u00b5s per loop\n-sage: timeit('prime_pi(10000)')\n-625 loops, best of 3: 343 ns per loop\n+sage: time prime_pi(10**12, 10**8)\n+37607912018\n+Time: CPU 0.92 s, Wall: 0.92 s\n+sage: time prime_pi(10**12, 10**8)    # pari's prime table is now cached\n+37607912018\n+Time: CPU 0.58 s, Wall: 0.58 s\n ```\n-\n-This doesn't cost very much memory, since everything is stored as 32-bit ints, but `prime_range()` is currently built on top of PARI, which poses a number of problems, but the primary concern is that it is a memory hog when sieving to a large upper bound (important for plotting purposes).\n \n An earlier version of this implementation started to fail to give correct output on 64-bit systems somewhere between `9.5*10**15` and `9.75*10**15`, for issues that I had previously been unable to determine, so I had initially limited input to be `< 2**49`, which I am fairly confident is safe, as I have done a fair bit of testing in this range trying to debug this issue (despite it taking hours per call). I would appreciate testing on 32-bit platforms.\n \n-A lot of the speed of this algorithm relies on the `__cached_count` method, which is essentially a binary search (with a simple adjustment in the beginning that takes advantage of the density of the primes). This is the fastest type of binary search I know of, but if anyone knows of a way to speed it up, it could have a significant effect. (Thanks to Yann for his suggestion)\n+A lot of the speed of this algorithm relies on the `__cached_count` method, which is essentially a binary search (with a simple adjustment in the beginning that takes advantage of the density of the primes). This is the fastest type of binary search I know of, but if anyone knows of a way to speed it up, it could have a significant effect.\n+\n+The other big contributor to the speed is the `__smallPi` table, which stores the values of pi(x) for `x < 2**16`. This is used in the same manner as  `__cached_count`, but is of course much faster.\n \n Finally, I have introduced the `legendres_formula` method, which takes two arguments, `x` and `a`, and returns the number of positive integers not larger than `x` that are not divisible by any -- i.e. co-prime to each -- of the first `a` primes. This function is core to all combinatorial methods for computing the prime counting function, so I figured that I would make this publicly accessible now that I have clean code.\n \n ---\n \n-Apply\n-1. [attachment:trac_11475v10.patch]\n-2. [attachment:trac_11475-v10_reviewer_1.sagelib.patch]\n-to the **Sage library**.\n+Apply [attachment:trac_11475mk2.patch] to the **Sage library**.\n \n``````\n",
    "created_at": "2011-09-10T08:45:38Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118543",
    "user": "https://github.com/ohanar"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,40 +1,14 @@
 I have rewritten the `prime_pi` method from scratch, it is much cleaner and less hacky this time (as I have learned more about coding), however it is still based on the same algorithm as before (no LMO yet, although I intend to take a stab at it later this year). This was developed in parallel with a method to count primes in residue classes (ticket forthcoming).
 
-The new version deals with a variety of input in a better fashion, without a too significant effect on timings: (all timings were done on mod.math)
-
-New:
-
-```
-sage: timeit('prime_pi(1)')
-625 loops, best of 3: 282 ns per loop
-sage: timeit('prime_pi(0.5)')
-625 loops, best of 3: 4.19 µs per loop
-sage: timeit('prime_pi(sqrt(2))')
-625 loops, best of 3: 384 µs per loop
-sage: timeit('prime_pi(mod(1, 2))')
-625 loops, best of 3: 8.94 µs per loop
-```
-Old:
-
-```
-sage: timeit('prime_pi(1)')
-625 loops, best of 3: 280 ns per loop
-sage: timeit('prime_pi(0.5)')
-625 loops, best of 3: 3.92 µs per loop
-sage: timeit('prime_pi(sqrt(2))')
-625 loops, best of 3: 383 µs per loop
-sage: timeit('prime_pi(mod(1, 2))')
-625 loops, best of 3: 7.38 µs per loop
-```
 The overhead for small input `>= 2` is rather large in the current `prime_pi`, this has been dramatically improved:
 
 New:
 
 ```
 sage: timeit('prime_pi(100)')
-625 loops, best of 3: 331 ns per loop
+625 loops, best of 3: 475 ns per loop
 sage: timeit('prime_pi(10000)')
-625 loops, best of 3: 971 ns per loop
+625 loops, best of 3: 483 ns per loop
 ```
 Old:
 
@@ -45,18 +19,18 @@
 625 loops, best of 3: 5.56 µs per loop
 ```
 
-There is also a ~3x speedup for larger input:
+There is also a ~5x speedup (conservatively) for larger input:
 
 New:
 
 ```
 sage: timeit('prime_pi(10**8)')
-125 loops, best of 3: 759 µs per loop
+625 loops, best of 3: 530 µs per loop
 sage: timeit('prime_pi(10**10)')
-5 loops, best of 3: 47.4 ms per loop
+5 loops, best of 3: 27.1 ms per loop
 sage: time prime_pi(10**12)
 37607912018
-Time: CPU 2.86 s, Wall: 2.86 s
+Time: CPU 1.53 s, Wall: 1.53 s
 ```
 Old:
 
@@ -70,29 +44,26 @@
 Time: CPU 8.65 s, Wall: 8.64 s
 ```
 
-Primes are now cached, which can give a significant speedup when making smaller calls after larger calls: (run after previous commands)
+The user can also give a second argument to use additional memory for a potential speedup. All primes less than the second argument are used in computing pi(x). For example:
 
 ```
-sage: timeit('prime_pi(10**10)')
-5 loops, best of 3: 27.4 ms per loop
-sage: timeit('prime_pi(10**8)')
-625 loops, best of 3: 325 µs per loop
-sage: timeit('prime_pi(10000)')
-625 loops, best of 3: 343 ns per loop
+sage: time prime_pi(10**12, 10**8)
+37607912018
+Time: CPU 0.92 s, Wall: 0.92 s
+sage: time prime_pi(10**12, 10**8)    # pari's prime table is now cached
+37607912018
+Time: CPU 0.58 s, Wall: 0.58 s
 ```
-
-This doesn't cost very much memory, since everything is stored as 32-bit ints, but `prime_range()` is currently built on top of PARI, which poses a number of problems, but the primary concern is that it is a memory hog when sieving to a large upper bound (important for plotting purposes).
 
 An earlier version of this implementation started to fail to give correct output on 64-bit systems somewhere between `9.5*10**15` and `9.75*10**15`, for issues that I had previously been unable to determine, so I had initially limited input to be `< 2**49`, which I am fairly confident is safe, as I have done a fair bit of testing in this range trying to debug this issue (despite it taking hours per call). I would appreciate testing on 32-bit platforms.
 
-A lot of the speed of this algorithm relies on the `__cached_count` method, which is essentially a binary search (with a simple adjustment in the beginning that takes advantage of the density of the primes). This is the fastest type of binary search I know of, but if anyone knows of a way to speed it up, it could have a significant effect. (Thanks to Yann for his suggestion)
+A lot of the speed of this algorithm relies on the `__cached_count` method, which is essentially a binary search (with a simple adjustment in the beginning that takes advantage of the density of the primes). This is the fastest type of binary search I know of, but if anyone knows of a way to speed it up, it could have a significant effect.
+
+The other big contributor to the speed is the `__smallPi` table, which stores the values of pi(x) for `x < 2**16`. This is used in the same manner as  `__cached_count`, but is of course much faster.
 
 Finally, I have introduced the `legendres_formula` method, which takes two arguments, `x` and `a`, and returns the number of positive integers not larger than `x` that are not divisible by any -- i.e. co-prime to each -- of the first `a` primes. This function is core to all combinatorial methods for computing the prime counting function, so I figured that I would make this publicly accessible now that I have clean code.
 
 ---
 
-Apply
-1. [attachment:trac_11475v10.patch]
-2. [attachment:trac_11475-v10_reviewer_1.sagelib.patch]
-to the **Sage library**.
+Apply [attachment:trac_11475mk2.patch] to the **Sage library**.
 
``````




---

archive/issue_comments_118544.json:
```json
{
    "body": "<a id='comment:54'></a>\nSo how the prime list is created and managed was bothering me. Specifically, its initiation code uses a bit of a hack to figure out whether or not it was called by init_tables and also uses `pari(n).primepi()`, which without #11741 can be quite buggy for larger n; it can consume a rather large amount of memory if the user gives a large input; and the user does not have any option on how big it is.\n\nSo I've completely rewritten the initiation method, it now recursively calls the pi method to determine the length of the prime list. I've also completely I've removed the caching part of the code, since we can quickly copy the primes over from pari's list, and instead added an optional second argument that allows the user to use additional memory if so desired. I've also tweaked the size of the smallPi list to give another significant speedup (roughly 50% faster than the last patch), as well as made a couple of simplifications in phi32.\n\nBeyond those changes, I've refactored a lot of code, replaced cython code with python for the non-critical sections in order to improve readability, reverted the plot method to something very close to its original state (since we are no longer caching), and folded in Leif's reviewer patch. The code is now 552 lines versus the previous 625.",
    "created_at": "2011-09-10T08:45:38Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118544",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:54'></a>
So how the prime list is created and managed was bothering me. Specifically, its initiation code uses a bit of a hack to figure out whether or not it was called by init_tables and also uses `pari(n).primepi()`, which without #11741 can be quite buggy for larger n; it can consume a rather large amount of memory if the user gives a large input; and the user does not have any option on how big it is.

So I've completely rewritten the initiation method, it now recursively calls the pi method to determine the length of the prime list. I've also completely I've removed the caching part of the code, since we can quickly copy the primes over from pari's list, and instead added an optional second argument that allows the user to use additional memory if so desired. I've also tweaked the size of the smallPi list to give another significant speedup (roughly 50% faster than the last patch), as well as made a couple of simplifications in phi32.

Beyond those changes, I've refactored a lot of code, replaced cython code with python for the non-critical sections in order to improve readability, reverted the plot method to something very close to its original state (since we are no longer caching), and folded in Leif's reviewer patch. The code is now 552 lines versus the previous 625.



---

archive/issue_comments_118545.json:
```json
{
    "body": "<a id='comment:55'></a>\nApply trac_11475mk2.patch\n\n(for patchbot)",
    "created_at": "2012-03-11T15:36:12Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118545",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:55'></a>
Apply trac_11475mk2.patch

(for patchbot)



---

archive/issue_events_090555.json:
```json
{
    "actor": "https://github.com/loefflerd",
    "created_at": "2012-03-14T11:25:43Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90555"
}
```



---

archive/issue_events_090556.json:
```json
{
    "actor": "https://github.com/loefflerd",
    "created_at": "2012-03-14T11:25:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90556"
}
```



---

archive/issue_comments_118546.json:
```json
{
    "body": "<a id='comment:56'></a>\nAccording to the patchbot logs there are some issues with documentation formatting:\n\n```\ndocstring of sage.functions.prime_pi.legendre_phi:39: WARNING: Duplicate explicit target name: \"rao2011\".\ndocstring of sage.functions.prime_pi.partial_sieve_function:39: WARNING: Duplicate explicit target name: \"rao2011\".\ndocstring of sage.functions.prime_pi.legendre_phi:39: WARNING: duplicate citation RAO2011, other instance in /storage/masiao/sage-5.0.beta8/devel/sage/doc/en/reference/sage/functions/prime_pi.rst\ndocstring of sage.functions.prime_pi.partial_sieve_function:39: WARNING: duplicate citation RAO2011, other instance in /storage/masiao/sage-5.0.beta8/devel/sage/doc/en/reference/sage/functions/prime_pi.rst\n```\n\nThis is basically because there should be only one copy of the bibliography entry in the file, rather than having it afresh in every docstring that cites it.\n\nAlso, shouldn't the class PrimePi derive from sage.symbolic.function.BuiltinFunction, rather from the base Object class?",
    "created_at": "2012-03-14T11:25:43Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118546",
    "user": "https://github.com/loefflerd"
}
```

<a id='comment:56'></a>
According to the patchbot logs there are some issues with documentation formatting:

```
docstring of sage.functions.prime_pi.legendre_phi:39: WARNING: Duplicate explicit target name: "rao2011".
docstring of sage.functions.prime_pi.partial_sieve_function:39: WARNING: Duplicate explicit target name: "rao2011".
docstring of sage.functions.prime_pi.legendre_phi:39: WARNING: duplicate citation RAO2011, other instance in /storage/masiao/sage-5.0.beta8/devel/sage/doc/en/reference/sage/functions/prime_pi.rst
docstring of sage.functions.prime_pi.partial_sieve_function:39: WARNING: duplicate citation RAO2011, other instance in /storage/masiao/sage-5.0.beta8/devel/sage/doc/en/reference/sage/functions/prime_pi.rst
```

This is basically because there should be only one copy of the bibliography entry in the file, rather than having it afresh in every docstring that cites it.

Also, shouldn't the class PrimePi derive from sage.symbolic.function.BuiltinFunction, rather from the base Object class?



---

archive/issue_comments_118547.json:
```json
{
    "body": "<a id='comment:57'></a>\nOk, both issues should be resolved -- it should now work properly in the symbolic ring.",
    "created_at": "2012-03-15T09:29:46Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118547",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:57'></a>
Ok, both issues should be resolved -- it should now work properly in the symbolic ring.



---

archive/issue_events_090557.json:
```json
{
    "actor": "https://github.com/ohanar",
    "created_at": "2012-03-15T09:29:46Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90557"
}
```



---

archive/issue_events_090558.json:
```json
{
    "actor": "https://github.com/ohanar",
    "created_at": "2012-03-15T09:29:46Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90558"
}
```



---

archive/issue_comments_118548.json:
```json
{
    "body": "<a id='comment:58'></a>\nApply trac_11475mk2.patch",
    "created_at": "2012-03-18T16:54:36Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118548",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:58'></a>
Apply trac_11475mk2.patch



---

archive/issue_events_090559.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2012-05-26T06:47:05Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90559"
}
```



---

archive/issue_events_090560.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2012-05-26T06:47:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90560"
}
```



---

archive/issue_comments_118549.json:
```json
{
    "body": "<a id='comment:59'></a>\nworks good to me.",
    "created_at": "2012-05-26T06:47:05Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118549",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:59'></a>
works good to me.



---

archive/issue_comments_118550.json:
```json
{
    "body": "<a id='comment:60'></a>\nOn the plus side, this fixes some of #6876.  On the down side:\n\n```\nWARNING: we draw the plot of ``prime_pi`` as a stairstep function with \nexplicitly drawn vertical lines where the function jumps. Technically \nTechnically there should not be any vertical lines, but they make the \ngraph look much better, so we include them. Use the option \n``vertical_lines=False`` to turn these off. \n```\nI'm adding a fix for the latter, and a doctest for the former.  Shouldn't affect anything.",
    "created_at": "2012-05-26T20:36:10Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118550",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:60'></a>
On the plus side, this fixes some of #6876.  On the down side:

```
WARNING: we draw the plot of ``prime_pi`` as a stairstep function with 
explicitly drawn vertical lines where the function jumps. Technically 
Technically there should not be any vertical lines, but they make the 
graph look much better, so we include them. Use the option 
``vertical_lines=False`` to turn these off. 
```
I'm adding a fix for the latter, and a doctest for the former.  Shouldn't affect anything.



---

archive/issue_comments_118551.json:
```json
{
    "body": "**Changing reviewer** from \"Yann Laigle-Chapuy, Leif Leonhardy\" to \"Yann Laigle-Chapuy, Leif Leonhardy, William Stein, Karl-Dieter Crisman\".",
    "created_at": "2012-05-26T20:36:40Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118551",
    "user": "https://github.com/kcrisman"
}
```

**Changing reviewer** from "Yann Laigle-Chapuy, Leif Leonhardy" to "Yann Laigle-Chapuy, Leif Leonhardy, William Stein, Karl-Dieter Crisman".



---

archive/issue_comments_118552.json:
```json
{
    "body": "**Changing keywords** from \"primes, prime counting, prime_pi\" to \"primes, prime counting, prime_pi sd40.5\".",
    "created_at": "2012-05-26T20:36:40Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118552",
    "user": "https://github.com/kcrisman"
}
```

**Changing keywords** from "primes, prime counting, prime_pi" to "primes, prime counting, prime_pi sd40.5".



---

archive/issue_comments_118553.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -65,5 +65,5 @@\n \n ---\n \n-Apply [attachment:trac_11475mk2.patch] to the **Sage library**.\n+Apply [attachment:trac_11475mk2.patch] and [attachment:trac_11475-reviewer.patch] to the **Sage library**.\n \n``````\n",
    "created_at": "2012-05-26T20:38:58Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118553",
    "user": "https://github.com/kcrisman"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -65,5 +65,5 @@
 
 ---
 
-Apply [attachment:trac_11475mk2.patch] to the **Sage library**.
+Apply [attachment:trac_11475mk2.patch] and [attachment:trac_11475-reviewer.patch] to the **Sage library**.
 
``````




---

archive/issue_comments_118554.json:
```json
{
    "body": "<a id='comment:62'></a>\nPatchbot: Apply trac_11475mk2.patch and trac_11475-reviewer.patch.",
    "created_at": "2012-05-26T20:38:58Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118554",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:62'></a>
Patchbot: Apply trac_11475mk2.patch and trac_11475-reviewer.patch.



---

archive/attachments_015130.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_11475-reviewer.patch",
    "asset_url": "tarball://root/attachments/ticket11475/trac_11475-reviewer.patch",
    "created_at": "2012-05-26T21:43:37Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket11475/trac_11475-reviewer.patch",
    "user": "https://github.com/kcrisman"
}
```



---

archive/issue_comments_118555.json:
```json
{
    "body": "Attachment [trac_11475-reviewer.patch](https://github.com/sagemath/sage/files/ticket11475/trac_11475-reviewer.patch) by @kcrisman created at 2012-05-26 21:43:37",
    "created_at": "2012-05-26T21:43:37Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118555",
    "user": "https://github.com/kcrisman"
}
```

Attachment [trac_11475-reviewer.patch](https://github.com/sagemath/sage/files/ticket11475/trac_11475-reviewer.patch) by @kcrisman created at 2012-05-26 21:43:37



---

archive/issue_comments_118556.json:
```json
{
    "body": "<a id='comment:63'></a>\nWilliam pointed out that this didn't fix #6876 quite how we want, so just fixing the typo.",
    "created_at": "2012-05-26T21:44:08Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118556",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:63'></a>
William pointed out that this didn't fix #6876 quite how we want, so just fixing the typo.



---

archive/issue_comments_118557.json:
```json
{
    "body": "<a id='comment:64'></a>\nThis fails on arando (Linux Ubuntu 12.04 i686, 32 bit):\n\n```\nsage -t  --long -force_lib devel/sage/sage/functions/prime_pi.pyx\n**********************************************************************\nFile \"/var/lib/buildbot/build/sage/arando-1/arando_full/build/sage-5.1.beta4/devel/sage-main/sage/functions/prime_pi.pyx\", line 123:\n    sage: prime_pi(10^10)\nExpected:\n    455052511\nGot:\n    70462980\n**********************************************************************\nFile \"/var/lib/buildbot/build/sage/arando-1/arando_full/build/sage-5.1.beta4/devel/sage-main/sage/functions/prime_pi.pyx\", line 231:\n    sage: for i in (32..42): prime_pi(2^i) # long time (13s on sage.math, 2011)\nExpected:\n    203280221\n    393615806\n    762939111\n    1480206279\n    2874398515\n    5586502348\n    10866266172\n    21151907950\n    41203088796\n    80316571436\n    156661034233\nGot:\n    0\n    0\n    0\n    0\n    0\n    0\n    0\n    0\n    0\n    0\n    0\n**********************************************************************\n```",
    "created_at": "2012-06-13T17:25:37Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118557",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:64'></a>
This fails on arando (Linux Ubuntu 12.04 i686, 32 bit):

```
sage -t  --long -force_lib devel/sage/sage/functions/prime_pi.pyx
**********************************************************************
File "/var/lib/buildbot/build/sage/arando-1/arando_full/build/sage-5.1.beta4/devel/sage-main/sage/functions/prime_pi.pyx", line 123:
    sage: prime_pi(10^10)
Expected:
    455052511
Got:
    70462980
**********************************************************************
File "/var/lib/buildbot/build/sage/arando-1/arando_full/build/sage-5.1.beta4/devel/sage-main/sage/functions/prime_pi.pyx", line 231:
    sage: for i in (32..42): prime_pi(2^i) # long time (13s on sage.math, 2011)
Expected:
    203280221
    393615806
    762939111
    1480206279
    2874398515
    5586502348
    10866266172
    21151907950
    41203088796
    80316571436
    156661034233
Got:
    0
    0
    0
    0
    0
    0
    0
    0
    0
    0
    0
**********************************************************************
```



---

archive/issue_events_090561.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-06-13T17:25:37Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90561"
}
```



---

archive/issue_events_090562.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-06-13T17:25:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90562"
}
```



---

archive/issue_comments_118558.json:
```json
{
    "body": "<a id='comment:65'></a>\nOn hawk (OpenSolaris i386), it actually Segmentation Faults.",
    "created_at": "2012-06-13T17:45:59Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118558",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:65'></a>
On hawk (OpenSolaris i386), it actually Segmentation Faults.



---

archive/issue_events_090563.json:
```json
{
    "actor": "https://github.com/ohanar",
    "created_at": "2012-06-15T22:22:56Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90563"
}
```



---

archive/issue_events_090564.json:
```json
{
    "actor": "https://github.com/ohanar",
    "created_at": "2012-06-15T22:22:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90564"
}
```



---

archive/issue_comments_118559.json:
```json
{
    "body": "<a id='comment:67'></a>\npatchbot: apply trac_11475mk2.patch trac_11475-reviewer.patch",
    "created_at": "2012-06-15T22:32:01Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118559",
    "user": "https://github.com/kini"
}
```

<a id='comment:67'></a>
patchbot: apply trac_11475mk2.patch trac_11475-reviewer.patch



---

archive/issue_comments_118560.json:
```json
{
    "body": "<a id='comment:68'></a>\npatchbot: apply trac_11475mk2.patch trac_11475-reviewer.patch",
    "created_at": "2012-06-16T00:18:15Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118560",
    "user": "https://github.com/kini"
}
```

<a id='comment:68'></a>
patchbot: apply trac_11475mk2.patch trac_11475-reviewer.patch



---

archive/issue_events_090565.json:
```json
{
    "actor": "https://github.com/kini",
    "created_at": "2012-06-16T01:59:37Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90565"
}
```



---

archive/issue_events_090566.json:
```json
{
    "actor": "https://github.com/kini",
    "created_at": "2012-06-16T01:59:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90566"
}
```



---

archive/issue_comments_118561.json:
```json
{
    "body": "<a id='comment:69'></a>\nJeroen: now it passes on arando. Can you check on hawk?",
    "created_at": "2012-06-16T01:59:37Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118561",
    "user": "https://github.com/kini"
}
```

<a id='comment:69'></a>
Jeroen: now it passes on arando. Can you check on hawk?



---

archive/issue_events_090567.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-06-18T13:33:32Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "milestone": "sage-5.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90567"
}
```



---

archive/issue_events_090568.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-06-18T13:33:32Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "milestone": "sage-5.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90568"
}
```



---

archive/issue_events_090569.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-07-07T22:29:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90569"
}
```



---

archive/issue_events_090570.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-07-07T22:29:20Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90570"
}
```



---

archive/issue_comments_118562.json:
```json
{
    "body": "**Merged:** sage-5.2.beta1",
    "created_at": "2012-07-07T22:29:20Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118562",
    "user": "https://github.com/jdemeyer"
}
```

**Merged:** sage-5.2.beta1



---

archive/issue_comments_118563.json:
```json
{
    "body": "<a id='comment:72'></a>\nWhy does this ticket make random whitespace changes to `sage/functions/all.py`? This is total BS. This just breaks patches on trac and wastes other people's time. For example \n#11143 doesn't apply any more.",
    "created_at": "2012-07-08T11:30:36Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118563",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:72'></a>
Why does this ticket make random whitespace changes to `sage/functions/all.py`? This is total BS. This just breaks patches on trac and wastes other people's time. For example 
#11143 doesn't apply any more.



---

archive/issue_comments_118564.json:
```json
{
    "body": "**Changing merged** from \"sage-5.2.beta1\" to \"\".",
    "created_at": "2012-07-11T08:49:05Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118564",
    "user": "https://github.com/jdemeyer"
}
```

**Changing merged** from "sage-5.2.beta1" to "".



---

archive/issue_events_090571.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-07-11T08:49:05Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "milestone": "sage-5.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90571"
}
```



---

archive/issue_events_090572.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-07-11T08:49:05Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "milestone": "sage-5.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90572"
}
```



---

archive/issue_comments_118565.json:
```json
{
    "body": "<a id='comment:73'></a>\nOn bsd.math (OS X 10.6 x86_64), I still get\n\n```\nsage -t  --long -force_lib devel/sage/sage/modular/abvar/torsion_subgroup.py\n**********************************************************************\nFile \"/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.2.beta1/devel/sage-main/sage/modular/abvar/torsion_subgroup.py\", line 316:\n    sage: G.multiple_of_order()\nException raised:\n    Traceback (most recent call last):\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.2.beta1/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.2.beta1/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.2.beta1/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_9[7]>\", line 1, in <module>\n        G.multiple_of_order()###line 316:\n    sage: G.multiple_of_order()\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.2.beta1/local/lib/python/site-packages/sage/modular/abvar/torsion_subgroup.py\", line 375, in multiple_of_order\n        f = A.hecke_polynomial(p)\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.2.beta1/local/lib/python/site-packages/sage/modular/abvar/abvar.py\", line 2239, in hecke_polynomial\n        f = self._compute_hecke_polynomial(n, var=var)\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.2.beta1/local/lib/python/site-packages/sage/modular/abvar/abvar.py\", line 3800, in _compute_hecke_polynomial\n        return sqrt_poly(self.modular_symbols().hecke_polynomial(n, var))\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.2.beta1/local/lib/python/site-packages/sage/modular/hecke/module.py\", line 1460, in hecke_polynomial\n        return self.hecke_operator(n).charpoly(var)\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.2.beta1/local/lib/python/site-packages/sage/modular/hecke/hecke_operator.py\", line 274, in charpoly\n        return self.matrix().charpoly(var)\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.2.beta1/local/lib/python/site-packages/sage/modular/hecke/hecke_operator.py\", line 747, in matrix\n        self.__matrix = self.parent().hecke_matrix(self.__n, *args, **kwds)\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.2.beta1/local/lib/python/site-packages/sage/modular/hecke/algebra.py\", line 589, in hecke_matrix\n        return self.__M.hecke_matrix(n, *args, **kwds)\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.2.beta1/local/lib/python/site-packages/sage/modular/hecke/module.py\", line 1351, in hecke_matrix\n        T = self._compute_hecke_matrix(n)\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.2.beta1/local/lib/python/site-packages/sage/modular/hecke/submodule.py\", line 239, in _compute_hecke_matrix\n        return A.restrict(self.free_module(), check=check)\n      File \"matrix2.pyx\", line 4202, in sage.matrix.matrix2.Matrix.restrict (sage/matrix/matrix2.c:23293)\n      File \"element.pyx\", line 2736, in sage.structure.element.Matrix.__mul__ (sage/structure/element.c:19170)\n      File \"coerce.pyx\", line 740, in sage.structure.coerce.CoercionModel_cache_maps.bin_op (sage/structure/coerce.c:6778)\n      File \"action.pyx\", line 147, in sage.matrix.action.MatrixMatrixAction._call_ (sage/matrix/action.c:3098)\n      File \"matrix_rational_dense.pyx\", line 1047, in sage.matrix.matrix_rational_dense.Matrix_rational_dense._matrix_times_matrix_ (sage/matrix/matrix_rational_dense.c:12115)\n      File \"matrix_rational_dense.pyx\", line 1090, in sage.matrix.matrix_rational_dense.Matrix_rational_dense._multiply_over_integers (sage/matrix/matrix_rational_dense.c:12248)\n    RuntimeError: Segmentation fault\n**********************************************************************\n```",
    "created_at": "2012-07-11T08:49:05Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118565",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:73'></a>
On bsd.math (OS X 10.6 x86_64), I still get

```
sage -t  --long -force_lib devel/sage/sage/modular/abvar/torsion_subgroup.py
**********************************************************************
File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.2.beta1/devel/sage-main/sage/modular/abvar/torsion_subgroup.py", line 316:
    sage: G.multiple_of_order()
Exception raised:
    Traceback (most recent call last):
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.2.beta1/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.2.beta1/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.2.beta1/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_9[7]>", line 1, in <module>
        G.multiple_of_order()###line 316:
    sage: G.multiple_of_order()
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.2.beta1/local/lib/python/site-packages/sage/modular/abvar/torsion_subgroup.py", line 375, in multiple_of_order
        f = A.hecke_polynomial(p)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.2.beta1/local/lib/python/site-packages/sage/modular/abvar/abvar.py", line 2239, in hecke_polynomial
        f = self._compute_hecke_polynomial(n, var=var)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.2.beta1/local/lib/python/site-packages/sage/modular/abvar/abvar.py", line 3800, in _compute_hecke_polynomial
        return sqrt_poly(self.modular_symbols().hecke_polynomial(n, var))
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.2.beta1/local/lib/python/site-packages/sage/modular/hecke/module.py", line 1460, in hecke_polynomial
        return self.hecke_operator(n).charpoly(var)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.2.beta1/local/lib/python/site-packages/sage/modular/hecke/hecke_operator.py", line 274, in charpoly
        return self.matrix().charpoly(var)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.2.beta1/local/lib/python/site-packages/sage/modular/hecke/hecke_operator.py", line 747, in matrix
        self.__matrix = self.parent().hecke_matrix(self.__n, *args, **kwds)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.2.beta1/local/lib/python/site-packages/sage/modular/hecke/algebra.py", line 589, in hecke_matrix
        return self.__M.hecke_matrix(n, *args, **kwds)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.2.beta1/local/lib/python/site-packages/sage/modular/hecke/module.py", line 1351, in hecke_matrix
        T = self._compute_hecke_matrix(n)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.2.beta1/local/lib/python/site-packages/sage/modular/hecke/submodule.py", line 239, in _compute_hecke_matrix
        return A.restrict(self.free_module(), check=check)
      File "matrix2.pyx", line 4202, in sage.matrix.matrix2.Matrix.restrict (sage/matrix/matrix2.c:23293)
      File "element.pyx", line 2736, in sage.structure.element.Matrix.__mul__ (sage/structure/element.c:19170)
      File "coerce.pyx", line 740, in sage.structure.coerce.CoercionModel_cache_maps.bin_op (sage/structure/coerce.c:6778)
      File "action.pyx", line 147, in sage.matrix.action.MatrixMatrixAction._call_ (sage/matrix/action.c:3098)
      File "matrix_rational_dense.pyx", line 1047, in sage.matrix.matrix_rational_dense.Matrix_rational_dense._matrix_times_matrix_ (sage/matrix/matrix_rational_dense.c:12115)
      File "matrix_rational_dense.pyx", line 1090, in sage.matrix.matrix_rational_dense.Matrix_rational_dense._multiply_over_integers (sage/matrix/matrix_rational_dense.c:12248)
    RuntimeError: Segmentation fault
**********************************************************************
```



---

archive/issue_comments_118566.json:
```json
{
    "body": "<a id='comment:74'></a>\nDo either of these cause a segfault?:\n\n```python\nsage: prime_pi(2**15)\n3512\nsage: prime_pi(2**10-1)\n172\n```\nThose are the only two calls made to `prime_pi` made by that doctest.",
    "created_at": "2012-07-11T09:43:51Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118566",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:74'></a>
Do either of these cause a segfault?:

```python
sage: prime_pi(2**15)
3512
sage: prime_pi(2**10-1)
172
```
Those are the only two calls made to `prime_pi` made by that doctest.



---

archive/issue_comments_118567.json:
```json
{
    "body": "<a id='comment:75'></a>\nReplying to [ohanar](#comment%3A74):\n> Do either of these cause a segfault?:\n> \n> ```python\n> sage: prime_pi(2**15)\n> 3512\n> sage: prime_pi(2**10-1)\n> 172\n> ```\n\nNo.",
    "created_at": "2012-07-11T11:14:54Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118567",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:75'></a>
Replying to [ohanar](#comment%3A74):
> Do either of these cause a segfault?:
> 
> ```python
> sage: prime_pi(2**15)
> 3512
> sage: prime_pi(2**10-1)
> 172
> ```

No.



---

archive/issue_comments_118568.json:
```json
{
    "body": "real patch",
    "created_at": "2012-10-07T05:47:02Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118568",
    "user": "https://github.com/ohanar"
}
```

real patch



---

archive/attachments_015131.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_11475mk2.patch",
    "asset_url": "tarball://root/attachments/ticket11475/trac_11475mk2.patch",
    "created_at": "2012-10-07T05:49:39Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket11475/trac_11475mk2.patch",
    "user": "https://github.com/ohanar"
}
```



---

archive/issue_comments_118569.json:
```json
{
    "body": "<a id='comment:76'></a>\nAttachment [trac_11475mk2.patch](https://github.com/sagemath/sage/files/ticket11475/trac_11475mk2.patch) by @ohanar created at 2012-10-07 05:49:39\n\nOk, OSX issue should now be fixed (all tests pass for me on bsd.math now).",
    "created_at": "2012-10-07T05:49:39Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118569",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:76'></a>
Attachment [trac_11475mk2.patch](https://github.com/sagemath/sage/files/ticket11475/trac_11475mk2.patch) by @ohanar created at 2012-10-07 05:49:39

Ok, OSX issue should now be fixed (all tests pass for me on bsd.math now).



---

archive/issue_events_090573.json:
```json
{
    "actor": "https://github.com/ohanar",
    "created_at": "2012-10-07T05:49:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90573"
}
```



---

archive/issue_events_090574.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "milestone": "sage-5.11",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90574"
}
```



---

archive/issue_events_090575.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90575"
}
```



---

archive/issue_comments_118570.json:
```json
{
    "body": "**Branch:** [u/ohanar/prime_pi](https://github.com/sagemath/sagetrac-mirror/tree/u/ohanar/prime_pi)",
    "created_at": "2013-09-02T02:12:24Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118570",
    "user": "https://github.com/ohanar"
}
```

**Branch:** [u/ohanar/prime_pi](https://github.com/sagemath/sagetrac-mirror/tree/u/ohanar/prime_pi)



---

archive/issue_comments_118571.json:
```json
{
    "body": "<a id='comment:78'></a>\nthis patch has bit-rotted, I'll upload a git branch in a moment",
    "created_at": "2013-09-02T02:12:24Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118571",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:78'></a>
this patch has bit-rotted, I'll upload a git branch in a moment



---

archive/issue_comments_118572.json:
```json
{
    "body": "**Dependencies:** #15138",
    "created_at": "2013-09-02T02:12:24Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118572",
    "user": "https://github.com/ohanar"
}
```

**Dependencies:** #15138



---

archive/issue_comments_118573.json:
```json
{
    "body": "**Commit:** [e3e33e62cc19bf93b5236e7d1177482bd52b8a9e](https://github.com/sagemath/sagetrac-mirror/commit/e3e33e62cc19bf93b5236e7d1177482bd52b8a9e)",
    "created_at": "2013-09-02T02:12:46Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118573",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Commit:** [e3e33e62cc19bf93b5236e7d1177482bd52b8a9e](https://github.com/sagemath/sagetrac-mirror/commit/e3e33e62cc19bf93b5236e7d1177482bd52b8a9e)



---

archive/issue_comments_118574.json:
```json
{
    "body": "<a id='comment:79'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td>[changeset:e3e33e6]</td><td><code>Trac 11475 reviewer patch - very minor prime_pi plot doc improvement</code></td></tr><tr><td>[changeset:a3a0edd]</td><td><code>fix doctest</code></td></tr><tr><td>[changeset:ef57887]</td><td><code>remove trailing \\'s and other little cleanup</code></td></tr><tr><td>[changeset:ed701d3]</td><td><code>prime_pi: fix off by 1 mallocing issue</code></td></tr><tr><td>[changeset:bc36b43]</td><td><code>5x speedup to prime_pi</code></td></tr></table>\n",
    "created_at": "2013-09-02T02:12:46Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118574",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:79'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td>[changeset:e3e33e6]</td><td><code>Trac 11475 reviewer patch - very minor prime_pi plot doc improvement</code></td></tr><tr><td>[changeset:a3a0edd]</td><td><code>fix doctest</code></td></tr><tr><td>[changeset:ef57887]</td><td><code>remove trailing \'s and other little cleanup</code></td></tr><tr><td>[changeset:ed701d3]</td><td><code>prime_pi: fix off by 1 mallocing issue</code></td></tr><tr><td>[changeset:bc36b43]</td><td><code>5x speedup to prime_pi</code></td></tr></table>




---

archive/issue_events_090576.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "milestone": "sage-6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90576"
}
```



---

archive/issue_events_090577.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90577"
}
```



---

archive/issue_events_090578.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90578"
}
```



---

archive/issue_events_090579.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90579"
}
```



---

archive/issue_comments_118575.json:
```json
{
    "body": "<a id='comment:82'></a>\nThe patchbot experienced some glitches on this ticket, so I tested it again; all tests pass and the documentation builds.  From the comments, it appears that the ticket was already closed, then reopened because of a segfault on OS X 10.6 x86_64, and that this bug was subsequently fixed.  Hence let's put it back to positive review.",
    "created_at": "2014-05-07T20:12:35Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118575",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:82'></a>
The patchbot experienced some glitches on this ticket, so I tested it again; all tests pass and the documentation builds.  From the comments, it appears that the ticket was already closed, then reopened because of a segfault on OS X 10.6 x86_64, and that this bug was subsequently fixed.  Hence let's put it back to positive review.



---

archive/issue_events_090580.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2014-05-07T20:12:35Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90580"
}
```



---

archive/issue_events_090581.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2014-05-07T20:12:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90581"
}
```



---

archive/issue_comments_118576.json:
```json
{
    "body": "**Changing branch** from \"[u/ohanar/prime_pi](https://github.com/sagemath/sagetrac-mirror/tree/u/ohanar/prime_pi)\" to \"[e3e33e62cc19bf93b5236e7d1177482bd52b8a9e](https://github.com/sagemath/sagetrac-mirror/commit/e3e33e62cc19bf93b5236e7d1177482bd52b8a9e)\".",
    "created_at": "2014-05-12T11:34:52Z",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11475#issuecomment-118576",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/ohanar/prime_pi](https://github.com/sagemath/sagetrac-mirror/tree/u/ohanar/prime_pi)" to "[e3e33e62cc19bf93b5236e7d1177482bd52b8a9e](https://github.com/sagemath/sagetrac-mirror/commit/e3e33e62cc19bf93b5236e7d1177482bd52b8a9e)".



---

archive/issue_events_090582.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-05-12T11:34:52Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90582"
}
```



---

archive/issue_events_090583.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-05-12T11:34:52Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/11475",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11475#event-90583"
}
```
