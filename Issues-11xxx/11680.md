# Issue 11680: support extra_compile_args (e.g., C99) when loading/attaching .pyx (cython) files, and when using %cython in the notebook

archive/issues_011508.json:
```json
{
    "body": "Right now, the following file `foo.pyx` cannot be just loaded into Sage:\n\n```\nfrom sage.rings.rational cimport Rational\nfrom sage.rings.polynomial.polynomial_rational_flint cimport Polynomial_rational_flint\nfrom sage.libs.flint.fmpq_poly cimport (fmpq_poly_get_coeff_mpq, fmpq_poly_set_coeff_mpq,\n                                        fmpq_poly_length)\n\ndef evaluate_at_power_of_gen(Polynomial_rational_flint f, unsigned long n):\n    assert n >= 1\n    cdef Polynomial_rational_flint res = f._new()\n    cdef unsigned long k\n    cdef Rational z = Rational(0)\n    for k in range(fmpq_poly_length(f.__poly)):\n        fmpq_poly_get_coeff_mpq(z.value, f.__poly, k)\n        fmpq_poly_set_coeff_mpq(res.__poly, n*k, z.value)\n    return res\n```\n\nThe main reason is that there is no way to tell Sage (i.e., the file `cython.py`) that the code needs to have the extra compile flag:\n\n```\n              extra_compile_args = ['-std=c99'],\n```\n\nCurrently `devel/sage/sage/misc/cython.py` supports \"clang\", \"clib\", and \"cinclude\" pragmas.  But none of these let us add an `extra_compile_arg` or use C99.\n\n---\n\nApply [attachment:trac_11680.patch](https://github.com/sagemath/sage/files/ticket11680/trac_11680.patch) to the Sage library.\n\n\n**Assignee:** @jasongrout\n\n**CC:**  @robertwb\n\n**Keywords:** sd32\n\n**Author:** Martin Albrecht\n\n**Reviewer:** William Stein, Leif Leonhardy\n\n**Merged:** sage-4.7.2.alpha3\n\nIssue created by migration from https://trac.sagemath.org/ticket/11680\n\n",
    "closed_at": "2011-09-12T19:38:32Z",
    "created_at": "2011-08-12T07:34:01Z",
    "labels": [
        "component: misc",
        "minor",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-4.7.2",
    "title": "support extra_compile_args (e.g., C99) when loading/attaching .pyx (cython) files, and when using %cython in the notebook",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/11680",
    "user": "https://github.com/williamstein"
}
```
Right now, the following file `foo.pyx` cannot be just loaded into Sage:

```
from sage.rings.rational cimport Rational
from sage.rings.polynomial.polynomial_rational_flint cimport Polynomial_rational_flint
from sage.libs.flint.fmpq_poly cimport (fmpq_poly_get_coeff_mpq, fmpq_poly_set_coeff_mpq,
                                        fmpq_poly_length)

def evaluate_at_power_of_gen(Polynomial_rational_flint f, unsigned long n):
    assert n >= 1
    cdef Polynomial_rational_flint res = f._new()
    cdef unsigned long k
    cdef Rational z = Rational(0)
    for k in range(fmpq_poly_length(f.__poly)):
        fmpq_poly_get_coeff_mpq(z.value, f.__poly, k)
        fmpq_poly_set_coeff_mpq(res.__poly, n*k, z.value)
    return res
```

The main reason is that there is no way to tell Sage (i.e., the file `cython.py`) that the code needs to have the extra compile flag:

```
              extra_compile_args = ['-std=c99'],
```

Currently `devel/sage/sage/misc/cython.py` supports "clang", "clib", and "cinclude" pragmas.  But none of these let us add an `extra_compile_arg` or use C99.

---

Apply [attachment:trac_11680.patch](https://github.com/sagemath/sage/files/ticket11680/trac_11680.patch) to the Sage library.


**Assignee:** @jasongrout

**CC:**  @robertwb

**Keywords:** sd32

**Author:** Martin Albrecht

**Reviewer:** William Stein, Leif Leonhardy

**Merged:** sage-4.7.2.alpha3

Issue created by migration from https://trac.sagemath.org/ticket/11680





---

archive/issue_comments_122772.json:
```json
{
    "body": "<a id='comment:1'></a>\nSo what do you propose?\n\nSince `c99` is actually also *a program* (and could be considered a language of its own), I'd suggest to both support\n\n```python\n#clang c99\n```\n**and** some other way to specify \"flags\" or compile-time options, perhaps also to the linker.\n\nAFAIK there's currently not even a way to specify `cython` options in a `.pyx` file.\n\nAllowing / using strings that get passed literally to the compiler driver (and perhaps also directly to the linker) is very flexible, but the Cython files may of course get less portable (which is perhaps a minor issue for the Sage library, at least at the moment).\n\n---\n\nWhat Cython needs, too, is some kind of conditional compilation (\u00e0 la `#ifdef` etc.) anyway... ;-)",
    "created_at": "2011-08-12T12:03:57Z",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11680#issuecomment-122772",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:1'></a>
So what do you propose?

Since `c99` is actually also *a program* (and could be considered a language of its own), I'd suggest to both support

```python
#clang c99
```
**and** some other way to specify "flags" or compile-time options, perhaps also to the linker.

AFAIK there's currently not even a way to specify `cython` options in a `.pyx` file.

Allowing / using strings that get passed literally to the compiler driver (and perhaps also directly to the linker) is very flexible, but the Cython files may of course get less portable (which is perhaps a minor issue for the Sage library, at least at the moment).

---

What Cython needs, too, is some kind of conditional compilation (Ã  la `#ifdef` etc.) anyway... ;-)



---

archive/issue_comments_122773.json:
```json
{
    "body": "<a id='comment:2'></a>\nleif -- I have no proposal, I just want *something*, anything, that actually works, so I can get back to work.",
    "created_at": "2011-08-12T17:12:59Z",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11680#issuecomment-122773",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:2'></a>
leif -- I have no proposal, I just want *something*, anything, that actually works, so I can get back to work.



---

archive/issue_comments_122774.json:
```json
{
    "body": "<a id='comment:3'></a>\nReplying to [was](#comment%3A2):\n> leif -- I have no proposal, I just want *something*, anything, that actually works, so I can get back to work. \n\n\nDo you need or imagine any other \"generic\" options (other than for compiling as C99 code) which you'd rather like to specify \"non-verbatim\", i.e., without using  a string to be directly passed to e.g. `gcc`?",
    "created_at": "2011-08-12T18:36:09Z",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11680#issuecomment-122774",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:3'></a>
Replying to [was](#comment%3A2):
> leif -- I have no proposal, I just want *something*, anything, that actually works, so I can get back to work. 


Do you need or imagine any other "generic" options (other than for compiling as C99 code) which you'd rather like to specify "non-verbatim", i.e., without using  a string to be directly passed to e.g. `gcc`?



---

archive/issue_comments_122775.json:
```json
{
    "body": "<a id='comment:4'></a>\nIn addition to\n\n```python\n#clang C99\n```\nI could imagine having\n\n```python\n#coptions keyword1 keyword2 keyword3\n```\nwhich are then mapped to the appropriate flags and passed to their respective component (`cython`, the C or C++ compiler, or the linker).\n\nThis should be quite flexible, since changes to the flags effectively used (e.g for different compilers or compiler versions) would be limited to `sage.misc.cython*`.\n\n\n\n\nI don't know if we'd in addition need something like\n\n```python\n#cpragma \"CFLAGS\" \"-D_XPG6 --some-very-rare-and-specific-options another_argument\"\n#cpragma \"LDFLAGS\" \"-L/unusual/location\"\n```\netc.",
    "created_at": "2011-08-12T19:06:54Z",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11680#issuecomment-122775",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:4'></a>
In addition to

```python
#clang C99
```
I could imagine having

```python
#coptions keyword1 keyword2 keyword3
```
which are then mapped to the appropriate flags and passed to their respective component (`cython`, the C or C++ compiler, or the linker).

This should be quite flexible, since changes to the flags effectively used (e.g for different compilers or compiler versions) would be limited to `sage.misc.cython*`.




I don't know if we'd in addition need something like

```python
#cpragma "CFLAGS" "-D_XPG6 --some-very-rare-and-specific-options another_argument"
#cpragma "LDFLAGS" "-L/unusual/location"
```
etc.



---

archive/issue_comments_122776.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [leif](#comment%3A4):\n> I don't know if we'd in addition need something like\n\n\n```python\n #cpragma \"CFLAGS\" \"-D_XPG6 --some-very-rare-and-specific-options another_argument\"\n #cpragma \"LDFLAGS\" \"-L/unusual/location\"\n```\n> etc.\n\n\nWe could even extend this to conditionals (e.g. depending on the operating system):\n\n```python\n#cpragma \"CFLAGS\" SunOS, HP-UX ? \"-D_XPG6\" : \"\"\n```\nwhere `SunOS` etc. are arbitrary predefined predicates.\n\n(Using `&&` and `||` there would perhaps be more appropriate, besides the ternary `? :` expression. `!` for negation shouldn't be necessary, though also desirable.)",
    "created_at": "2011-08-12T19:35:57Z",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11680#issuecomment-122776",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:5'></a>
Replying to [leif](#comment%3A4):
> I don't know if we'd in addition need something like


```python
 #cpragma "CFLAGS" "-D_XPG6 --some-very-rare-and-specific-options another_argument"
 #cpragma "LDFLAGS" "-L/unusual/location"
```
> etc.


We could even extend this to conditionals (e.g. depending on the operating system):

```python
#cpragma "CFLAGS" SunOS, HP-UX ? "-D_XPG6" : ""
```
where `SunOS` etc. are arbitrary predefined predicates.

(Using `&&` and `||` there would perhaps be more appropriate, besides the ternary `? :` expression. `!` for negation shouldn't be necessary, though also desirable.)



---

archive/issue_comments_122777.json:
```json
{
    "body": "<a id='comment:6'></a>\nJust noticed `sage/misc/cython.py` is more complicated than I expected (and not fully up-to-date, e.g. w.r.t. `cython`'s `--cplus` option, which isn't used yet), but adding at least support for C99 should be easy.\n\nWill give it a try...\n\nAny nice Cython examples to test with?",
    "created_at": "2011-08-12T20:36:12Z",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11680#issuecomment-122777",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:6'></a>
Just noticed `sage/misc/cython.py` is more complicated than I expected (and not fully up-to-date, e.g. w.r.t. `cython`'s `--cplus` option, which isn't used yet), but adding at least support for C99 should be easy.

Will give it a try...

Any nice Cython examples to test with?



---

archive/issue_comments_122778.json:
```json
{
    "body": "test file to demonstrate behaviour",
    "created_at": "2011-08-22T06:16:47Z",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11680#issuecomment-122778",
    "user": "https://github.com/malb"
}
```

test file to demonstrate behaviour



---

archive/issue_comments_122779.json:
```json
{
    "body": "**Author:** Martin Albrecht",
    "created_at": "2011-08-22T06:20:28Z",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11680#issuecomment-122779",
    "user": "https://github.com/malb"
}
```

**Author:** Martin Albrecht



---

archive/attachments_015448.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "test.spyx",
    "asset_url": "tarball://root/attachments/ticket11680/test.spyx",
    "created_at": "2011-08-22T06:20:28Z",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket11680/test.spyx",
    "user": "https://github.com/malb"
}
```



---

archive/issue_comments_122780.json:
```json
{
    "body": "<a id='comment:7'></a>\nAttachment [test.spyx](https://github.com/sagemath/sage/files/ticket11680/test.spyx) by @malb created at 2011-08-22 06:20:28\n\nHi, I've addeded cflags which are just passed to extra_compile_args. I only fixed enough things in cython.py such that the attached test.spyx works, e.g. I didn't fix adding `--cplus` etc.",
    "created_at": "2011-08-22T06:20:28Z",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11680#issuecomment-122780",
    "user": "https://github.com/malb"
}
```

<a id='comment:7'></a>
Attachment [test.spyx](https://github.com/sagemath/sage/files/ticket11680/test.spyx) by @malb created at 2011-08-22 06:20:28

Hi, I've addeded cflags which are just passed to extra_compile_args. I only fixed enough things in cython.py such that the attached test.spyx works, e.g. I didn't fix adding `--cplus` etc.



---

archive/issue_events_093142.json:
```json
{
    "actor": "https://github.com/malb",
    "created_at": "2011-08-22T06:20:28Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11680#event-93142"
}
```



---

archive/issue_comments_122781.json:
```json
{
    "body": "<a id='comment:8'></a>\nHmmm, the naming isn't very clear.\n\nI'd use some plural form for `cfile`, i.e. `cfiles`, or something else, e.g. `csources`, which clearly indicates that these are additional, \"arbitrary\" source files to also be compiled into the extension module.\n\n`cargs` is similarly ambiguous, as the `c` refers to Cython, not C, but the \"args\" are passed to the C or C++ compiler rather than to `cython` itself.\n\n(I admit that `clib` and `cinclude` could perhaps have better names, or at least the plural form, as well; especially for the latter it isn't clear that its parameters are or can be actually *search paths*.)\n\n\n\n\nFor compiling C99, I still prefer having `#clang C99` (case-insensitive for all languages btw.).\n\nP.S.: Now I'm happy *I* didn't also work on this yesterday... ;-)",
    "created_at": "2011-08-22T06:52:24Z",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11680#issuecomment-122781",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:8'></a>
Hmmm, the naming isn't very clear.

I'd use some plural form for `cfile`, i.e. `cfiles`, or something else, e.g. `csources`, which clearly indicates that these are additional, "arbitrary" source files to also be compiled into the extension module.

`cargs` is similarly ambiguous, as the `c` refers to Cython, not C, but the "args" are passed to the C or C++ compiler rather than to `cython` itself.

(I admit that `clib` and `cinclude` could perhaps have better names, or at least the plural form, as well; especially for the latter it isn't clear that its parameters are or can be actually *search paths*.)




For compiling C99, I still prefer having `#clang C99` (case-insensitive for all languages btw.).

P.S.: Now I'm happy *I* didn't also work on this yesterday... ;-)



---

archive/issue_comments_122782.json:
```json
{
    "body": "<a id='comment:9'></a>\n1. The code looks great!\n\n2. There are no tests at all of the new functionality.  Add tests somehow.\n\n3. TODO Later: Make it so typing `cython?` results in one seeing documentation for all pragma's.  This is now #11712.",
    "created_at": "2011-08-22T06:54:21Z",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11680#issuecomment-122782",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:9'></a>
1. The code looks great!

2. There are no tests at all of the new functionality.  Add tests somehow.

3. TODO Later: Make it so typing `cython?` results in one seeing documentation for all pragma's.  This is now #11712.



---

archive/issue_comments_122783.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [was](#comment%3A9):\n> 2. There are no tests at all of the new functionality.  Add tests somehow.\n\n\nDone, I added only one test, though. It seems sufficient.",
    "created_at": "2011-08-22T07:00:18Z",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11680#issuecomment-122783",
    "user": "https://github.com/malb"
}
```

<a id='comment:10'></a>
Replying to [was](#comment%3A9):
> 2. There are no tests at all of the new functionality.  Add tests somehow.


Done, I added only one test, though. It seems sufficient.



---

archive/issue_comments_122784.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [leif](#comment%3A8):\n> Hmmm, the naming isn't very clear.\n\n\nAgreed.\n\n> I'd use some plural form for `cfile`, i.e. `cfiles`, or something else, e.g. `csources`, which clearly indicates that these are additional, \"arbitrary\" source files to also be compiled into the extension module.\n\n\nThose weren't added in this ticket.\n\n> `cargs` is similarly ambiguous, as the `c` refers to Cython, not C, but the \"args\" are passed to the C or C++ compiler rather than to `cython` itself.\n\n\nYep, the whole cprefix thingy is ambiguous. Perhaps there should be another ticket where the whole system is overhauled?\n\n> (I admit that `clib` and `cinclude` could perhaps have better names, or at least the plural form, as well; especially for the latter it isn't clear that its parameters are or can be actually *search paths*.)\n\n\nThese weren't added in this ticket.\n\n> For compiling C99, I still prefer having `#clang C99` (case-insensitive for all languages btw.).\n\n\nI have no preference either way. GCC treats it as an option. Hence, I think it's okay to have it as part of `cargs`.\n\n> P.S.: Now I'm happy *I* didn't also work on this yesterday... ;-)\n\n\nBut you could work on a more general ticket tomorrow ;-)",
    "created_at": "2011-08-22T07:03:06Z",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11680#issuecomment-122784",
    "user": "https://github.com/malb"
}
```

<a id='comment:11'></a>
Replying to [leif](#comment%3A8):
> Hmmm, the naming isn't very clear.


Agreed.

> I'd use some plural form for `cfile`, i.e. `cfiles`, or something else, e.g. `csources`, which clearly indicates that these are additional, "arbitrary" source files to also be compiled into the extension module.


Those weren't added in this ticket.

> `cargs` is similarly ambiguous, as the `c` refers to Cython, not C, but the "args" are passed to the C or C++ compiler rather than to `cython` itself.


Yep, the whole cprefix thingy is ambiguous. Perhaps there should be another ticket where the whole system is overhauled?

> (I admit that `clib` and `cinclude` could perhaps have better names, or at least the plural form, as well; especially for the latter it isn't clear that its parameters are or can be actually *search paths*.)


These weren't added in this ticket.

> For compiling C99, I still prefer having `#clang C99` (case-insensitive for all languages btw.).


I have no preference either way. GCC treats it as an option. Hence, I think it's okay to have it as part of `cargs`.

> P.S.: Now I'm happy *I* didn't also work on this yesterday... ;-)


But you could work on a more general ticket tomorrow ;-)



---

archive/issue_comments_122785.json:
```json
{
    "body": "<a id='comment:12'></a>\nI was refereeing the patch and fixed a doctest failure in it (?).  Then I decided I wanted that .pyx file in my original input in a doctest, and setup infrastructure to do that, and did it.   So the new patch (which is merged with yours, with both our names) is longer than your original patch.  Since I'm happy with yours, if you (=malb) can review this (especially my new code), then it is reviewed.",
    "created_at": "2011-08-23T09:38:08Z",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11680#issuecomment-122785",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:12'></a>
I was refereeing the patch and fixed a doctest failure in it (?).  Then I decided I wanted that .pyx file in my original input in a doctest, and setup infrastructure to do that, and did it.   So the new patch (which is merged with yours, with both our names) is longer than your original patch.  Since I'm happy with yours, if you (=malb) can review this (especially my new code), then it is reviewed.



---

archive/issue_comments_122786.json:
```json
{
    "body": "<a id='comment:13'></a>\nPatch looks good but I wonder whether we should support replacing `<SAGE_ROOT>` with `SAGE_ROOT` not only in tests but in general. It'd make pyx files more portable.",
    "created_at": "2011-08-23T20:39:56Z",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11680#issuecomment-122786",
    "user": "https://github.com/malb"
}
```

<a id='comment:13'></a>
Patch looks good but I wonder whether we should support replacing `<SAGE_ROOT>` with `SAGE_ROOT` not only in tests but in general. It'd make pyx files more portable.



---

archive/attachments_015449.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_11680.patch",
    "asset_url": "tarball://root/attachments/ticket11680/trac_11680.patch",
    "created_at": "2011-08-23T20:55:10Z",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket11680/trac_11680.patch",
    "user": "https://github.com/malb"
}
```



---

archive/issue_comments_122787.json:
```json
{
    "body": "Attachment [trac_11680.patch](https://github.com/sagemath/sage/files/ticket11680/trac_11680.patch) by @malb created at 2011-08-23 20:55:10",
    "created_at": "2011-08-23T20:55:10Z",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11680#issuecomment-122787",
    "user": "https://github.com/malb"
}
```

Attachment [trac_11680.patch](https://github.com/sagemath/sage/files/ticket11680/trac_11680.patch) by @malb created at 2011-08-23 20:55:10



---

archive/issue_comments_122788.json:
```json
{
    "body": "<a id='comment:14'></a>\nI am happy with this version if you are.",
    "created_at": "2011-08-23T20:55:33Z",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11680#issuecomment-122788",
    "user": "https://github.com/malb"
}
```

<a id='comment:14'></a>
I am happy with this version if you are.



---

archive/issue_comments_122789.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [malb](#comment%3A14):\n> I am happy with this version if you are.\n\n\nYep. Positive review :-)\n\nRegarding `$SAGE_ROOT`, let's do that for sure, but as another ticket.",
    "created_at": "2011-08-23T20:58:15Z",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11680#issuecomment-122789",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:15'></a>
Replying to [malb](#comment%3A14):
> I am happy with this version if you are.


Yep. Positive review :-)

Regarding `$SAGE_ROOT`, let's do that for sure, but as another ticket.



---

archive/issue_events_093143.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2011-08-23T20:58:53Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11680#event-93143"
}
```



---

archive/issue_events_093144.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2011-08-23T20:58:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11680#event-93144"
}
```



---

archive/issue_comments_122790.json:
```json
{
    "body": "**Changing keywords** from \"\" to \"sd32\".",
    "created_at": "2011-08-24T23:49:01Z",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11680#issuecomment-122790",
    "user": "https://github.com/williamstein"
}
```

**Changing keywords** from "" to "sd32".



---

archive/issue_comments_122791.json:
```json
{
    "body": "<a id='comment:18'></a>\nWhen #11761 gets approved, we can move using `# distutils: language = c++` which is understood by Cython and can be used to specify any Extension options. See http://wiki.cython.org/enhancements/distutils_preprocessing",
    "created_at": "2011-09-01T17:58:28Z",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11680#issuecomment-122791",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:18'></a>
When #11761 gets approved, we can move using `# distutils: language = c++` which is understood by Cython and can be used to specify any Extension options. See http://wiki.cython.org/enhancements/distutils_preprocessing



---

archive/issue_comments_122792.json:
```json
{
    "body": "<a id='comment:19'></a>\nShouldn't we make this ticket depend on #11761 then and adapt it accordingly? It doesn't seem to be a good idea to change the syntax that often?",
    "created_at": "2011-09-05T18:39:17Z",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11680#issuecomment-122792",
    "user": "https://github.com/malb"
}
```

<a id='comment:19'></a>
Shouldn't we make this ticket depend on #11761 then and adapt it accordingly? It doesn't seem to be a good idea to change the syntax that often?



---

archive/issue_comments_122793.json:
```json
{
    "body": "<a id='comment:20'></a>\nReplying to [malb](#comment%3A19):\n> Shouldn't we make this ticket depend on #11761 then and adapt it accordingly? It doesn't seem to be a good idea to change the syntax that often?\n\n\nIMHO not until #11761 has positive review. (Otherwise we'd need a *negative* dependence, invalidating this ticket when #11761 gets merged.)\n\nYou can open a follow-up ticket based on #11761 though, changing the syntax used here.\n\nOr change the syntax used here, and don't make this ticket depend on Cython 0.15... ;-)",
    "created_at": "2011-09-05T19:05:43Z",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11680#issuecomment-122793",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:20'></a>
Replying to [malb](#comment%3A19):
> Shouldn't we make this ticket depend on #11761 then and adapt it accordingly? It doesn't seem to be a good idea to change the syntax that often?


IMHO not until #11761 has positive review. (Otherwise we'd need a *negative* dependence, invalidating this ticket when #11761 gets merged.)

You can open a follow-up ticket based on #11761 though, changing the syntax used here.

Or change the syntax used here, and don't make this ticket depend on Cython 0.15... ;-)



---

archive/issue_comments_122794.json:
```json
{
    "body": "**Reviewer:** William Stein, Leif Leonhardy",
    "created_at": "2011-09-05T19:05:43Z",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11680#issuecomment-122794",
    "user": "https://github.com/nexttime"
}
```

**Reviewer:** William Stein, Leif Leonhardy



---

archive/issue_comments_122795.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,7 +1,6 @@\n-Right now, the following file foo.pyx cannot be just loaded into Sage:\n+Right now, the following file `foo.pyx` cannot be just loaded into Sage:\n \n ```\n-\n from sage.rings.rational cimport Rational\n from sage.rings.polynomial.polynomial_rational_flint cimport Polynomial_rational_flint\n from sage.libs.flint.fmpq_poly cimport (fmpq_poly_get_coeff_mpq, fmpq_poly_set_coeff_mpq,\n@@ -18,10 +17,15 @@\n     return res\n ```\n \n-The main reason is that there is no way to tell Sage (i.e., the file cython.py) that the code needs to have the extra compile flag:\n+The main reason is that there is no way to tell Sage (i.e., the file `cython.py`) that the code needs to have the extra compile flag:\n \n ```\n               extra_compile_args = ['-std=c99'],\n ```\n \n-Currently devel/sage/sage/misc/cython.py defines \"clang\", \"clib\", and \"cinclude\".  But none of these let us add an extra_compile_arg or use c99. \n+Currently `devel/sage/sage/misc/cython.py` supports \"clang\", \"clib\", and \"cinclude\" pragmas.  But none of these let us add an `extra_compile_arg` or use C99.\n+\n+---\n+\n+Apply [attachment:trac_11680.patch](https://github.com/sagemath/sage/files/ticket11680/trac_11680.patch) to the Sage library.\n+\n``````\n",
    "created_at": "2011-09-08T13:48:56Z",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11680#issuecomment-122795",
    "user": "https://github.com/nexttime"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,7 +1,6 @@
-Right now, the following file foo.pyx cannot be just loaded into Sage:
+Right now, the following file `foo.pyx` cannot be just loaded into Sage:
 
 ```
-
 from sage.rings.rational cimport Rational
 from sage.rings.polynomial.polynomial_rational_flint cimport Polynomial_rational_flint
 from sage.libs.flint.fmpq_poly cimport (fmpq_poly_get_coeff_mpq, fmpq_poly_set_coeff_mpq,
@@ -18,10 +17,15 @@
     return res
 ```
 
-The main reason is that there is no way to tell Sage (i.e., the file cython.py) that the code needs to have the extra compile flag:
+The main reason is that there is no way to tell Sage (i.e., the file `cython.py`) that the code needs to have the extra compile flag:
 
 ```
               extra_compile_args = ['-std=c99'],
 ```
 
-Currently devel/sage/sage/misc/cython.py defines "clang", "clib", and "cinclude".  But none of these let us add an extra_compile_arg or use c99. 
+Currently `devel/sage/sage/misc/cython.py` supports "clang", "clib", and "cinclude" pragmas.  But none of these let us add an `extra_compile_arg` or use C99.
+
+---
+
+Apply [attachment:trac_11680.patch](https://github.com/sagemath/sage/files/ticket11680/trac_11680.patch) to the Sage library.
+
``````




---

archive/issue_comments_122796.json:
```json
{
    "body": "**Merged:** sage-4.7.2.alpha3",
    "created_at": "2011-09-12T19:38:32Z",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11680#issuecomment-122796",
    "user": "https://github.com/nexttime"
}
```

**Merged:** sage-4.7.2.alpha3



---

archive/issue_events_093145.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2011-09-12T19:38:32Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11680#event-93145"
}
```



---

archive/issue_events_093146.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2011-09-12T19:38:32Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11680#event-93146"
}
```



---

archive/issue_comments_122797.json:
```json
{
    "body": "<a id='comment:23'></a>\nThe patch here seems to be leaving some .c and .html files lying around during doctests.  I think we can fix this with this:\n\n```diff\ndiff --git a/sage/misc/cython.py b/sage/misc/cython.py\n--- a/sage/misc/cython.py\n+++ b/sage/misc/cython.py\n@@ -17,7 +17,7 @@ AUTHORS:\n \n import os, sys, platform\n \n-from misc import SPYX_TMP, SAGE_ROOT, SAGE_LOCAL\n+from misc import SPYX_TMP, SAGE_ROOT, SAGE_LOCAL, SAGE_TMP\n from sage.misc.misc import UNAME\n \n def cblas():\n@@ -627,6 +627,7 @@ def compile_and_load(code):\n     file = tmp_filename() + \".pyx\"\n     open(file,'w').write(code)\n     from sage.server.support import cython_import\n+    os.chdir(SAGE_TMP)\n     return cython_import(file)\n```\nIs this a good idea?  Can anyone confirm that the patch here is responsible for those files?  If so, we should open up a follow-up ticket.",
    "created_at": "2011-10-01T17:54:57Z",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11680#issuecomment-122797",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:23'></a>
The patch here seems to be leaving some .c and .html files lying around during doctests.  I think we can fix this with this:

```diff
diff --git a/sage/misc/cython.py b/sage/misc/cython.py
--- a/sage/misc/cython.py
+++ b/sage/misc/cython.py
@@ -17,7 +17,7 @@ AUTHORS:
 
 import os, sys, platform
 
-from misc import SPYX_TMP, SAGE_ROOT, SAGE_LOCAL
+from misc import SPYX_TMP, SAGE_ROOT, SAGE_LOCAL, SAGE_TMP
 from sage.misc.misc import UNAME
 
 def cblas():
@@ -627,6 +627,7 @@ def compile_and_load(code):
     file = tmp_filename() + ".pyx"
     open(file,'w').write(code)
     from sage.server.support import cython_import
+    os.chdir(SAGE_TMP)
     return cython_import(file)
```
Is this a good idea?  Can anyone confirm that the patch here is responsible for those files?  If so, we should open up a follow-up ticket.



---

archive/issue_comments_122798.json:
```json
{
    "body": "<a id='comment:24'></a>\nRevisiting this, I don't think the `TESTS` dictionary and the `import_test()` function should be part of the module itself at all, as they provide no functionality. (I actually reviewed an earlier version of the patch.)\n\nThey should either be part of *the docstring* as an -- of course longer -- example, or somewhere in `sage/tests/`.\n\n\n\n\nW.r.t. the temporary files:\n\nI think it is a more general problem that Cython apparently puts temporary files into the current working directory, just mangling the original path, and, secondly, not deleting them afterwards.\n\nI'm pretty sure I've seen similar files sporadically occurring without ever getting deleted in previous releases (i.e., e.g. last year).",
    "created_at": "2011-10-01T18:37:27Z",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11680#issuecomment-122798",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:24'></a>
Revisiting this, I don't think the `TESTS` dictionary and the `import_test()` function should be part of the module itself at all, as they provide no functionality. (I actually reviewed an earlier version of the patch.)

They should either be part of *the docstring* as an -- of course longer -- example, or somewhere in `sage/tests/`.




W.r.t. the temporary files:

I think it is a more general problem that Cython apparently puts temporary files into the current working directory, just mangling the original path, and, secondly, not deleting them afterwards.

I'm pretty sure I've seen similar files sporadically occurring without ever getting deleted in previous releases (i.e., e.g. last year).



---

archive/issue_comments_122799.json:
```json
{
    "body": "<a id='comment:25'></a>\nP.S.: But John's suggestion is IMHO -- perhaps as a temporary fix only -- ok here (in that it should fix the issue in an easy way), since using `sage.server.support.cython_import()` *for this purpose* is simply an abuse of that function... ;-)\n\nMaybe we should also use `create_local_c_file=False`; I guess that also suppresses the HTML counterpart.",
    "created_at": "2011-10-01T18:50:34Z",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11680#issuecomment-122799",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:25'></a>
P.S.: But John's suggestion is IMHO -- perhaps as a temporary fix only -- ok here (in that it should fix the issue in an easy way), since using `sage.server.support.cython_import()` *for this purpose* is simply an abuse of that function... ;-)

Maybe we should also use `create_local_c_file=False`; I guess that also suppresses the HTML counterpart.



---

archive/issue_comments_122800.json:
```json
{
    "body": "<a id='comment:26'></a>\nReplying to [leif](#comment%3A25):\n> Maybe we should also use `create_local_c_file=False`; I guess that also suppresses the HTML counterpart.\n\n\nFWIW, the following fixes the issue for me, **without** changing the current working directory:\n\n```diff\ndiff --git a/sage/misc/cython.py b/sage/misc/cython.py\n--- a/sage/misc/cython.py\n+++ b/sage/misc/cython.py\n@@ -627,7 +627,8 @@\n     file = tmp_filename() + \".pyx\"\n     open(file,'w').write(code)\n     from sage.server.support import cython_import\n-    return cython_import(file)\n+    # return cython_import(file, create_local_c_file=False, annotate=False)\n+    return cython_import(file, create_local_c_file=False)\n \n \n TESTS = {\n```\n\nThe line I've commented out does **not** work, since `cython_import()` doesn't propagate the `annotate` keyword to `sage.misc.cython.cython()` (i.e., it doesn't take such a keyword argument), which is perhaps a bug by itself.\n\nHowever, using just `create_local_c_file=False` is sufficient.",
    "created_at": "2011-10-01T19:11:33Z",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11680#issuecomment-122800",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:26'></a>
Replying to [leif](#comment%3A25):
> Maybe we should also use `create_local_c_file=False`; I guess that also suppresses the HTML counterpart.


FWIW, the following fixes the issue for me, **without** changing the current working directory:

```diff
diff --git a/sage/misc/cython.py b/sage/misc/cython.py
--- a/sage/misc/cython.py
+++ b/sage/misc/cython.py
@@ -627,7 +627,8 @@
     file = tmp_filename() + ".pyx"
     open(file,'w').write(code)
     from sage.server.support import cython_import
-    return cython_import(file)
+    # return cython_import(file, create_local_c_file=False, annotate=False)
+    return cython_import(file, create_local_c_file=False)
 
 
 TESTS = {
```

The line I've commented out does **not** work, since `cython_import()` doesn't propagate the `annotate` keyword to `sage.misc.cython.cython()` (i.e., it doesn't take such a keyword argument), which is perhaps a bug by itself.

However, using just `create_local_c_file=False` is sufficient.



---

archive/issue_comments_122801.json:
```json
{
    "body": "<a id='comment:27'></a>\nWe definitely want `create_local_c_file=False`, not just `annotate=False`, because there are c files being created as well.  I've created #11887 to deal with this.",
    "created_at": "2011-10-01T19:44:08Z",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11680#issuecomment-122801",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:27'></a>
We definitely want `create_local_c_file=False`, not just `annotate=False`, because there are c files being created as well.  I've created #11887 to deal with this.



---

archive/issue_comments_122802.json:
```json
{
    "body": "<a id='comment:28'></a>\nReplying to [jhpalmieri](#comment%3A27):\n> We definitely want `create_local_c_file=False`, not just `annotate=False`\n\n\nI meant *both* of course, but disabling the former apparently also disables the latter.",
    "created_at": "2011-10-01T19:51:50Z",
    "issue": "https://github.com/sagemath/sage/issues/11680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11680#issuecomment-122802",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:28'></a>
Replying to [jhpalmieri](#comment%3A27):
> We definitely want `create_local_c_file=False`, not just `annotate=False`


I meant *both* of course, but disabling the former apparently also disables the latter.
