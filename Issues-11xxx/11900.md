# Issue 11900: Serious regression caused by #9138

archive/issues_011728.json:
```json
{
    "body": "At [sage-devel](http://groups.google.com/group/sage-devel/browse_thread/thread/d885434ba9c22d66), Jeroen reported a massive regression in elliptic curve computations. The regression was introduced in the transition from sage-4.7.2.alpha2 to sage-4.7.2.alpha3.\n\nIt seems that #9138 is responsible, at least for a big part of the regression. With unpatched sage-4.7.2.alpha2, we find\n\n```\nsage: E = J0(46).endomorphism_ring()\nsage: %time g = E.gens()\nCPU times: user 5.54 s, sys: 0.15 s, total: 5.69 s\nWall time: 5.81 s\n```\nAdding #9138 and its dependency, we obtain\n\n```\nsage: E = J0(46).endomorphism_ring()\nsage: %time g = E.gens()\nCPU times: user 8.72 s, sys: 0.18 s, total: 8.89 s\nWall time: 8.92 s\n```\n\nIt turns out that much time is wasted for calls to `sage.categories.Category.join` and to `sage.categories.Category.hom_category`.\n\nWhen caching these two methods, one can reduce the speed difference to something like that (sage-4.7.2.alpha3 plus #11115 plus an experimental patch for the caching):\n\n```\nsage: E = J0(46).endomorphism_ring()\nsage: %time g = E.gens()\nCPU times: user 6.82 s, sys: 0.16 s, total: 6.98 s\nWall time: 7.40 s\n```\nHowever, that's still far from good. After caching join and hom_category, there is still too much time spent (according to %prun) for the initialisation of matrix spaces.\n\n__Apply__\n\n* [attachment:trac11900_category_speedup_combined.patch]\n* [attachment:trac11900_only_fix_singleton_hash.patch]\n* [attachment:trac11900_doctest.patch]\n\n**CC:**  @jdemeyer @nthiery @malb\n\n**Keywords:** categories regression\n\n**Reviewer:** Jeroen Demeyer, Nicolas M. Thi\u00e9ry, Simon King, Jason Grout\n\n**Author:** Simon King\n\n**Merged:** sage-5.0.beta0\n\n**Dependencies:** #11319, #9138, #11911, #9562\n\n**Resolution:** fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/11900\n\n",
    "closed_at": "2012-01-18T08:08:32Z",
    "created_at": "2011-10-05T20:54:11Z",
    "labels": [
        "component: performance",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.0",
    "title": "Serious regression caused by #9138",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11900",
    "user": "https://github.com/simon-king-jena"
}
```
At [sage-devel](http://groups.google.com/group/sage-devel/browse_thread/thread/d885434ba9c22d66), Jeroen reported a massive regression in elliptic curve computations. The regression was introduced in the transition from sage-4.7.2.alpha2 to sage-4.7.2.alpha3.

It seems that #9138 is responsible, at least for a big part of the regression. With unpatched sage-4.7.2.alpha2, we find

```
sage: E = J0(46).endomorphism_ring()
sage: %time g = E.gens()
CPU times: user 5.54 s, sys: 0.15 s, total: 5.69 s
Wall time: 5.81 s
```
Adding #9138 and its dependency, we obtain

```
sage: E = J0(46).endomorphism_ring()
sage: %time g = E.gens()
CPU times: user 8.72 s, sys: 0.18 s, total: 8.89 s
Wall time: 8.92 s
```

It turns out that much time is wasted for calls to `sage.categories.Category.join` and to `sage.categories.Category.hom_category`.

When caching these two methods, one can reduce the speed difference to something like that (sage-4.7.2.alpha3 plus #11115 plus an experimental patch for the caching):

```
sage: E = J0(46).endomorphism_ring()
sage: %time g = E.gens()
CPU times: user 6.82 s, sys: 0.16 s, total: 6.98 s
Wall time: 7.40 s
```
However, that's still far from good. After caching join and hom_category, there is still too much time spent (according to %prun) for the initialisation of matrix spaces.

__Apply__

* [attachment:trac11900_category_speedup_combined.patch]
* [attachment:trac11900_only_fix_singleton_hash.patch]
* [attachment:trac11900_doctest.patch]

**CC:**  @jdemeyer @nthiery @malb

**Keywords:** categories regression

**Reviewer:** Jeroen Demeyer, Nicolas M. Thiéry, Simon King, Jason Grout

**Author:** Simon King

**Merged:** sage-5.0.beta0

**Dependencies:** #11319, #9138, #11911, #9562

**Resolution:** fixed

Issue created by migration from https://trac.sagemath.org/ticket/11900





---

archive/issue_events_037125.json:
```json
{
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "label": "critical",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11900#event-37125"
}
```



---

archive/issue_events_037126.json:
```json
{
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "label": "blocker",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11900#event-37126"
}
```



---

archive/issue_comments_168636.json:
```json
{
    "body": "<a id='comment:2'></a>\nIt seems that some time is spent for creating a homset, when creating a matrix space. \n\nIn fact, during initialisation, a special map from the basering is created for coercion. That has been introduced in #9138 because otherwise coercion from the base ring to the matrix space is too slow.\n\nHowever, it might be better to *not* create the coerce map during initialisation. After all, it is a waste of time to create it when eventually it is not used. Perhaps that is what is happening here?",
    "created_at": "2011-10-05T21:20:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168636",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:2'></a>
It seems that some time is spent for creating a homset, when creating a matrix space. 

In fact, during initialisation, a special map from the basering is created for coercion. That has been introduced in #9138 because otherwise coercion from the base ring to the matrix space is too slow.

However, it might be better to *not* create the coerce map during initialisation. After all, it is a waste of time to create it when eventually it is not used. Perhaps that is what is happening here?



---

archive/issue_comments_168637.json:
```json
{
    "body": "<a id='comment:3'></a>\nWhen avoiding initialisation of coercion from the base ring into a matrix space,(in addition to caching hom_category and join), I get\n\n```\nsage: E = J0(46).endomorphism_ring()\nsage: %time g = E.gens()\nCPU times: user 6.83 s, sys: 0.22 s, total: 7.05 s\nWall time: 7.07 s\n```",
    "created_at": "2011-10-05T21:47:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168637",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:3'></a>
When avoiding initialisation of coercion from the base ring into a matrix space,(in addition to caching hom_category and join), I get

```
sage: E = J0(46).endomorphism_ring()
sage: %time g = E.gens()
CPU times: user 6.83 s, sys: 0.22 s, total: 7.05 s
Wall time: 7.07 s
```



---

archive/issue_comments_168638.json:
```json
{
    "body": "<a id='comment:4'></a>\nThe next problematic call seems to be `__get__` of some lazy attribute. But I don't know yet which it is.",
    "created_at": "2011-10-05T21:51:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168638",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:4'></a>
The next problematic call seems to be `__get__` of some lazy attribute. But I don't know yet which it is.



---

archive/issue_comments_168639.json:
```json
{
    "body": "<a id='comment:5'></a>\nNext finding: It could be that the cache for matrix spaces is broken. I inserted a print statement into the initialisation of `MatrixSpace_generic` that shows base_ring,nrows,ncols and the sparsity.\n\nBy the cache implemented in the `MatrixSpace` constructor, no quadrupel should occur twice, but in fact the space of dense 8 by 8 matrices over `GF(46337)` and other instances occurs several times. Could it be that the matrix space is *directly* constructed, i.e., breaking the cache?",
    "created_at": "2011-10-05T22:15:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168639",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:5'></a>
Next finding: It could be that the cache for matrix spaces is broken. I inserted a print statement into the initialisation of `MatrixSpace_generic` that shows base_ring,nrows,ncols and the sparsity.

By the cache implemented in the `MatrixSpace` constructor, no quadrupel should occur twice, but in fact the space of dense 8 by 8 matrices over `GF(46337)` and other instances occurs several times. Could it be that the matrix space is *directly* constructed, i.e., breaking the cache?



---

archive/issue_comments_168640.json:
```json
{
    "body": "<a id='comment:6'></a>\nReplying to [SimonKing](#comment%3A5):\n> By the cache implemented in the `MatrixSpace` constructor, no quadrupel should occur twice, but in fact the space of dense 8 by 8 matrices over `GF(46337)` and other instances occurs several times. Could it be that the matrix space is *directly* constructed, i.e., breaking the cache?\n\n\nNo, it is differently: The cache uses weak references. In fact, garbage collection is to blame for the double construction of matrix spaces.",
    "created_at": "2011-10-05T22:26:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168640",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:6'></a>
Replying to [SimonKing](#comment%3A5):
> By the cache implemented in the `MatrixSpace` constructor, no quadrupel should occur twice, but in fact the space of dense 8 by 8 matrices over `GF(46337)` and other instances occurs several times. Could it be that the matrix space is *directly* constructed, i.e., breaking the cache?


No, it is differently: The cache uses weak references. In fact, garbage collection is to blame for the double construction of matrix spaces.



---

archive/issue_comments_168641.json:
```json
{
    "body": "<a id='comment:7'></a>\nWhen I use strong references for caching matrix spaces (in addition to the previous changes), I get\n\n```\nsage: E = J0(46).endomorphism_ring()\nsage: %time g = E.gens()\nCPU times: user 6.15 s, sys: 0.16 s, total: 6.31 s\nWall time: 6.33 s\n```\n\nOf course, one wouldn't like to have all the matrix spaces hanging around. But perhaps it is an option to temporarily turn garbage collection off.\n\nHowever, the computation of `E.gens()` actually requires the construction of many *different* matrix spaces. So, making matrix space creation faster certainly is the best option.",
    "created_at": "2011-10-06T05:12:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168641",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:7'></a>
When I use strong references for caching matrix spaces (in addition to the previous changes), I get

```
sage: E = J0(46).endomorphism_ring()
sage: %time g = E.gens()
CPU times: user 6.15 s, sys: 0.16 s, total: 6.31 s
Wall time: 6.33 s
```

Of course, one wouldn't like to have all the matrix spaces hanging around. But perhaps it is an option to temporarily turn garbage collection off.

However, the computation of `E.gens()` actually requires the construction of many *different* matrix spaces. So, making matrix space creation faster certainly is the best option.



---

archive/issue_comments_168642.json:
```json
{
    "body": "<a id='comment:8'></a>\nAnother time seems to be uselessly spent on a generic method of free module elements: list().\n\nSuch a small method ought to be as fast as possible and should thus be overridden in sub-classes. But `sage.modules.vector_integer_dense.Vector_integer_dense` does not override the list() method.",
    "created_at": "2011-10-06T05:25:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168642",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:8'></a>
Another time seems to be uselessly spent on a generic method of free module elements: list().

Such a small method ought to be as fast as possible and should thus be overridden in sub-classes. But `sage.modules.vector_integer_dense.Vector_integer_dense` does not override the list() method.



---

archive/issue_comments_168643.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [SimonKing](#comment%3A8):\n> Such a small method ought to be as fast as possible and should thus be overridden in sub-classes. But `sage.modules.vector_integer_dense.Vector_integer_dense` does not override the list() method.\n\n\nNeither do `sage.modules.vector_rational_dense.Vector_rational_dense`.",
    "created_at": "2011-10-06T05:43:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168643",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:9'></a>
Replying to [SimonKing](#comment%3A8):
> Such a small method ought to be as fast as possible and should thus be overridden in sub-classes. But `sage.modules.vector_integer_dense.Vector_integer_dense` does not override the list() method.


Neither do `sage.modules.vector_rational_dense.Vector_rational_dense`.



---

archive/issue_comments_168644.json:
```json
{
    "body": "<a id='comment:10'></a>\nIf the initialisation of matrix spaces is changed such that `Parent.__init__` (and thus the full category framework) is *not* called, then I'm down to\n\n```\nsage: E = J0(46).endomorphism_ring()\nsage: %time g = E.gens()\nCPU times: user 5.65 s, sys: 0.16 s, total: 5.82 s\nWall time: 5.83 s\n```\n\nAs a consequence, the `TestSuite` of matrix spaces would not fully work, but perhaps it would be worth it. I'll ask sage-devel.",
    "created_at": "2011-10-06T06:04:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168644",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:10'></a>
If the initialisation of matrix spaces is changed such that `Parent.__init__` (and thus the full category framework) is *not* called, then I'm down to

```
sage: E = J0(46).endomorphism_ring()
sage: %time g = E.gens()
CPU times: user 5.65 s, sys: 0.16 s, total: 5.82 s
Wall time: 5.83 s
```

As a consequence, the `TestSuite` of matrix spaces would not fully work, but perhaps it would be worth it. I'll ask sage-devel.



---

archive/issue_comments_168645.json:
```json
{
    "body": "<a id='comment:11'></a>\nThe next surprise is that (even if one avoids category initialisation of matrix spaces) *many* covariant constructions (quotients and subquotients) are called - that is another reason why `Category.join()` is called so often.\n\nPart of the problem may be that `sage.categories.CovariantConstructionCategory.category_of` has been defined as `@`class_method in #8881, not as `@`cached_function (one can see in the code that cached_function has been considered, but was commented out). So, perhaps it is worth while to try that change?\n\nBut first I need to find out where the quotients and subquotients actually arise.",
    "created_at": "2011-10-06T09:22:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168645",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:11'></a>
The next surprise is that (even if one avoids category initialisation of matrix spaces) *many* covariant constructions (quotients and subquotients) are called - that is another reason why `Category.join()` is called so often.

Part of the problem may be that `sage.categories.CovariantConstructionCategory.category_of` has been defined as `@`class_method in #8881, not as `@`cached_function (one can see in the code that cached_function has been considered, but was commented out). So, perhaps it is worth while to try that change?

But first I need to find out where the quotients and subquotients actually arise.



---

archive/issue_comments_168646.json:
```json
{
    "body": "<a id='comment:12'></a>\nYes!!\n\nWhen I use a cache for `category_of`, we have\n\n```\nsage: E = J0(46).endomorphism_ring()\nsage: %time g = E.gens() \nCPU times: user 5.54 s, sys: 0.19 s, total: 5.74 s\nWall time: 5.75 s\n```\nand at least this instance of a regression has gone! I don't know how much of it is due to the fact that I also have #11115 applied, but let me first finish the patch and then we'll see.",
    "created_at": "2011-10-06T09:32:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168646",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:12'></a>
Yes!!

When I use a cache for `category_of`, we have

```
sage: E = J0(46).endomorphism_ring()
sage: %time g = E.gens() 
CPU times: user 5.54 s, sys: 0.19 s, total: 5.74 s
Wall time: 5.75 s
```
and at least this instance of a regression has gone! I don't know how much of it is due to the fact that I also have #11115 applied, but let me first finish the patch and then we'll see.



---

archive/issue_comments_168647.json:
```json
{
    "body": "<a id='comment:13'></a>\nI have attached a preliminary patch, if someone already wants to have a look. I need to do more tests (and run doctests), but up to now it seems that it fixes the regression.\n\n**__Changes for Matrix Spaces__**\n\nMatrix spaces will not make use of the category framework by default. But I introduced a new method that makes them use the category framework after initialisation:\n\n```\n            sage: MS = MatrixSpace(QQ,8)\n            sage: TestSuite(MS).run()\n            Failure in _test_category:\n            Traceback (most recent call last):\n            ...\n            AssertionError: category of self improperly initialized\n            ------------------------------------------------------------\n            The following tests failed: _test_category\n            sage: type(MS)\n            <class 'sage.matrix.matrix_space.MatrixSpace_generic'>\n            sage: MS.full_category_initialisation()\n            sage: TestSuite(MS).run()\n            sage: type(MS)\n            <class 'sage.matrix.matrix_space.MatrixSpace_generic_with_category'>\n```\n\nMinor change: I made `__matrix_class` a lazy attribute.\n\n**__Changes for categories__**\n\nI turn `hom_category` in a cached method - the result is cached anyway, and thus it makes sense to cache as early as possible, in order to reduce the overhead, and in order to benefit from #11115.\n\nI also cache the class method `category_of` in sage.categories.covariant_functorial_construction. According to a commented-out line, caching has been attempted anyway, but since it needs to be a class method, caching has not been possible by simply using a decorator.\n\n**__Vectors__**\n\nI added custom `list()` methods for both integral and rational dense vectors. Here is the speed difference (the timing is with patch attached):\n\n```\nsage: v = vector(ZZ,range(100))\nsage: %timeit L = v.list()\n625 loops, best of 3: 11 \u00b5s per loop\n# was 17 \u00b5s per loop in sage-4.7.2.alpha2\nsage: v = vector(QQ,range(100))\nsage: %timeit L = v.list()\n625 loops, best of 3: 24 \u00b5s per loop\n# was 27.7 \u00b5s per loop in sage-4.7.2.alpha2\n```\nThe difference is small, but one should benefit from it.\n\n**__Doc formatting__**\n\nI corrected some wrong formatting in the documentation of dense integral and rational vectors.",
    "created_at": "2011-10-06T10:19:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168647",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:13'></a>
I have attached a preliminary patch, if someone already wants to have a look. I need to do more tests (and run doctests), but up to now it seems that it fixes the regression.

**__Changes for Matrix Spaces__**

Matrix spaces will not make use of the category framework by default. But I introduced a new method that makes them use the category framework after initialisation:

```
            sage: MS = MatrixSpace(QQ,8)
            sage: TestSuite(MS).run()
            Failure in _test_category:
            Traceback (most recent call last):
            ...
            AssertionError: category of self improperly initialized
            ------------------------------------------------------------
            The following tests failed: _test_category
            sage: type(MS)
            <class 'sage.matrix.matrix_space.MatrixSpace_generic'>
            sage: MS.full_category_initialisation()
            sage: TestSuite(MS).run()
            sage: type(MS)
            <class 'sage.matrix.matrix_space.MatrixSpace_generic_with_category'>
```

Minor change: I made `__matrix_class` a lazy attribute.

**__Changes for categories__**

I turn `hom_category` in a cached method - the result is cached anyway, and thus it makes sense to cache as early as possible, in order to reduce the overhead, and in order to benefit from #11115.

I also cache the class method `category_of` in sage.categories.covariant_functorial_construction. According to a commented-out line, caching has been attempted anyway, but since it needs to be a class method, caching has not been possible by simply using a decorator.

**__Vectors__**

I added custom `list()` methods for both integral and rational dense vectors. Here is the speed difference (the timing is with patch attached):

```
sage: v = vector(ZZ,range(100))
sage: %timeit L = v.list()
625 loops, best of 3: 11 µs per loop
# was 17 µs per loop in sage-4.7.2.alpha2
sage: v = vector(QQ,range(100))
sage: %timeit L = v.list()
625 loops, best of 3: 24 µs per loop
# was 27.7 µs per loop in sage-4.7.2.alpha2
```
The difference is small, but one should benefit from it.

**__Doc formatting__**

I corrected some wrong formatting in the documentation of dense integral and rational vectors.



---

archive/issue_comments_168648.json:
```json
{
    "body": "**Dependencies:** #9138",
    "created_at": "2011-10-06T10:19:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168648",
    "user": "https://github.com/simon-king-jena"
}
```

**Dependencies:** #9138



---

archive/issue_comments_168649.json:
```json
{
    "body": "**Author:** Simon King",
    "created_at": "2011-10-06T10:19:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168649",
    "user": "https://github.com/simon-king-jena"
}
```

**Author:** Simon King



---

archive/issue_comments_168650.json:
```json
{
    "body": "<a id='comment:14'></a>\nThe crucial question: Does it fix the speed regression?\n\nHere are Jeroen's examples from sage-devel.\n\n**sage-4.7.2.alpha2**\n\n```\nsage: %time D = J0(46).endomorphism_ring().discriminant()\nCPU times: user 5.60 s, sys: 0.21 s, total: 5.81 s\nWall time: 5.83 s\nsage: %time TestSuite(CrystalOfTableaux(['B',4],shape=[2,1,1,0])).run()\nCPU times: user 7.08 s, sys: 0.03 s, total: 7.11 s\nWall time: 7.75 s\nsage: W.<z> = CyclotomicField(13)\nsage: %time M = Matrix(W, 2, 3, [10^30*(1-z)^13, 1, 2, 3, 4, z]).echelon_form()\nCPU times: user 3.29 s, sys: 0.03 s, total: 3.32 s\nWall time: 3.38 s\nsage: %time L = EllipticCurve('960d1').prove_BSD()\nCPU times: user 3.73 s, sys: 0.04 s, total: 3.78 s\nWall time: 4.01 s\nsage: def test(E):\n....:     for p in prime_range(10000):\n....:         if p != 389:\n....:             G = E.change_ring(GF(p)).abelian_group()\n....:             \nsage: E = EllipticCurve('389a')\nsage: %time test(E)\nCPU times: user 16.47 s, sys: 0.04 s, total: 16.50 s\nWall time: 16.73 s\nsage: %time for E in cremona_curves([11..100]): S = E.integral_points(both_signs=False)\nCPU times: user 13.88 s, sys: 0.06 s, total: 13.94 s\nWall time: 14.01 s\n```\n\n**sage-4.7.2.alpha2 plus #9138 and its dependency**\n\n```\nsage: %time D = J0(46).endomorphism_ring().discriminant()\nCPU times: user 8.80 s, sys: 0.15 s, total: 8.95 s\nWall time: 8.98 s\nsage: %time TestSuite(CrystalOfTableaux(['B',4],shape=[2,1,1,0])).run()\nCPU times: user 7.11 s, sys: 0.03 s, total: 7.14 s\nWall time: 7.48 s\nsage: W.<z> = CyclotomicField(13)\nsage: %time M = Matrix(W, 2, 3, [10^30*(1-z)^13, 1, 2, 3, 4, z]).echelon_form()\nCPU times: user 6.07 s, sys: 0.02 s, total: 6.09 s\nWall time: 6.13 s\nsage: %time L = EllipticCurve('960d1').prove_BSD()\nCPU times: user 10.10 s, sys: 0.07 s, total: 10.17 s\nWall time: 10.55 s\nsage: def test(E):\n....:     for p in prime_range(10000):\n....:         if p != 389:\n....:             G = E.change_ring(GF(p)).abelian_group()\n....:             \nsage: E = EllipticCurve('389a')\nsage: %time test(E)\nCPU times: user 23.03 s, sys: 0.05 s, total: 23.08 s\nWall time: 23.18 s\nsage: %time for E in cremona_curves([11..100]): S = E.integral_points(both_signs=False)\nCPU times: user 16.29 s, sys: 0.05 s, total: 16.34 s\nWall time: 16.48 s\n```\n\n**sage-4.7.2.alpha2 plus #9138 and its dependency plus the patch from here**\n\n```\nsage: %time D = J0(46).endomorphism_ring().discriminant()\nCPU times: user 6.02 s, sys: 0.20 s, total: 6.22 s\nWall time: 6.23 s\nsage: %time TestSuite(CrystalOfTableaux(['B',4],shape=[2,1,1,0])).run()\nCPU times: user 7.11 s, sys: 0.01 s, total: 7.12 s\nWall time: 7.39 s\nsage: W.<z> = CyclotomicField(13)\nsage: %time M = Matrix(W, 2, 3, [10^30*(1-z)^13, 1, 2, 3, 4, z]).echelon_form()\nCPU times: user 3.81 s, sys: 0.04 s, total: 3.84 s\nWall time: 3.85 s\nsage: %time L = EllipticCurve('960d1').prove_BSD()\nCPU times: user 6.11 s, sys: 0.07 s, total: 6.18 s\nWall time: 6.20 s\nsage: def test(E):\n....:     for p in prime_range(10000):\n....:         if p != 389:\n....:             G = E.change_ring(GF(p)).abelian_group()\n....:             \nsage: E = EllipticCurve('389a')\nsage: %time test(E)\nCPU times: user 18.11 s, sys: 0.07 s, total: 18.17 s\nWall time: 18.23 s\nsage: %time for E in cremona_curves([11..100]): S = E.integral_points(both_signs=False)\nCPU times: user 13.13 s, sys: 0.05 s, total: 13.18 s\nWall time: 13.22 s\n```\n\n**__Conclusion__**\n\n#9138 is indeed responsible for all but one regression. The only exception is the test suite for `CrytalOfTableaux`; it has already been argued on sage-devel that it is actually not a regression, since the test suite became much longer by #11183.\n\nThe patch from here fixes most regressions. Problematic remain the `EllipticCurve('960d1').prove_BSD()` and the `E.change_ring(GF(p)).abelian_group()` tests.",
    "created_at": "2011-10-06T10:55:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168650",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:14'></a>
The crucial question: Does it fix the speed regression?

Here are Jeroen's examples from sage-devel.

**sage-4.7.2.alpha2**

```
sage: %time D = J0(46).endomorphism_ring().discriminant()
CPU times: user 5.60 s, sys: 0.21 s, total: 5.81 s
Wall time: 5.83 s
sage: %time TestSuite(CrystalOfTableaux(['B',4],shape=[2,1,1,0])).run()
CPU times: user 7.08 s, sys: 0.03 s, total: 7.11 s
Wall time: 7.75 s
sage: W.<z> = CyclotomicField(13)
sage: %time M = Matrix(W, 2, 3, [10^30*(1-z)^13, 1, 2, 3, 4, z]).echelon_form()
CPU times: user 3.29 s, sys: 0.03 s, total: 3.32 s
Wall time: 3.38 s
sage: %time L = EllipticCurve('960d1').prove_BSD()
CPU times: user 3.73 s, sys: 0.04 s, total: 3.78 s
Wall time: 4.01 s
sage: def test(E):
....:     for p in prime_range(10000):
....:         if p != 389:
....:             G = E.change_ring(GF(p)).abelian_group()
....:             
sage: E = EllipticCurve('389a')
sage: %time test(E)
CPU times: user 16.47 s, sys: 0.04 s, total: 16.50 s
Wall time: 16.73 s
sage: %time for E in cremona_curves([11..100]): S = E.integral_points(both_signs=False)
CPU times: user 13.88 s, sys: 0.06 s, total: 13.94 s
Wall time: 14.01 s
```

**sage-4.7.2.alpha2 plus #9138 and its dependency**

```
sage: %time D = J0(46).endomorphism_ring().discriminant()
CPU times: user 8.80 s, sys: 0.15 s, total: 8.95 s
Wall time: 8.98 s
sage: %time TestSuite(CrystalOfTableaux(['B',4],shape=[2,1,1,0])).run()
CPU times: user 7.11 s, sys: 0.03 s, total: 7.14 s
Wall time: 7.48 s
sage: W.<z> = CyclotomicField(13)
sage: %time M = Matrix(W, 2, 3, [10^30*(1-z)^13, 1, 2, 3, 4, z]).echelon_form()
CPU times: user 6.07 s, sys: 0.02 s, total: 6.09 s
Wall time: 6.13 s
sage: %time L = EllipticCurve('960d1').prove_BSD()
CPU times: user 10.10 s, sys: 0.07 s, total: 10.17 s
Wall time: 10.55 s
sage: def test(E):
....:     for p in prime_range(10000):
....:         if p != 389:
....:             G = E.change_ring(GF(p)).abelian_group()
....:             
sage: E = EllipticCurve('389a')
sage: %time test(E)
CPU times: user 23.03 s, sys: 0.05 s, total: 23.08 s
Wall time: 23.18 s
sage: %time for E in cremona_curves([11..100]): S = E.integral_points(both_signs=False)
CPU times: user 16.29 s, sys: 0.05 s, total: 16.34 s
Wall time: 16.48 s
```

**sage-4.7.2.alpha2 plus #9138 and its dependency plus the patch from here**

```
sage: %time D = J0(46).endomorphism_ring().discriminant()
CPU times: user 6.02 s, sys: 0.20 s, total: 6.22 s
Wall time: 6.23 s
sage: %time TestSuite(CrystalOfTableaux(['B',4],shape=[2,1,1,0])).run()
CPU times: user 7.11 s, sys: 0.01 s, total: 7.12 s
Wall time: 7.39 s
sage: W.<z> = CyclotomicField(13)
sage: %time M = Matrix(W, 2, 3, [10^30*(1-z)^13, 1, 2, 3, 4, z]).echelon_form()
CPU times: user 3.81 s, sys: 0.04 s, total: 3.84 s
Wall time: 3.85 s
sage: %time L = EllipticCurve('960d1').prove_BSD()
CPU times: user 6.11 s, sys: 0.07 s, total: 6.18 s
Wall time: 6.20 s
sage: def test(E):
....:     for p in prime_range(10000):
....:         if p != 389:
....:             G = E.change_ring(GF(p)).abelian_group()
....:             
sage: E = EllipticCurve('389a')
sage: %time test(E)
CPU times: user 18.11 s, sys: 0.07 s, total: 18.17 s
Wall time: 18.23 s
sage: %time for E in cremona_curves([11..100]): S = E.integral_points(both_signs=False)
CPU times: user 13.13 s, sys: 0.05 s, total: 13.18 s
Wall time: 13.22 s
```

**__Conclusion__**

#9138 is indeed responsible for all but one regression. The only exception is the test suite for `CrytalOfTableaux`; it has already been argued on sage-devel that it is actually not a regression, since the test suite became much longer by #11183.

The patch from here fixes most regressions. Problematic remain the `EllipticCurve('960d1').prove_BSD()` and the `E.change_ring(GF(p)).abelian_group()` tests.



---

archive/issue_comments_168651.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2011-10-06T10:57:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168651",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_168652.json:
```json
{
    "body": "<a id='comment:15'></a>\nThe patch is updated.\n\nI did not run the doc tests yet, and also I think one should try to fix the remaining regression, but I turn it into \"needs review\".",
    "created_at": "2011-10-06T10:57:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168652",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:15'></a>
The patch is updated.

I did not run the doc tests yet, and also I think one should try to fix the remaining regression, but I turn it into "needs review".



---

archive/issue_comments_168653.json:
```json
{
    "body": "<a id='comment:16'></a>\nDoing some timing...\n\nI am afraid I will not be able to review your patch because I am too unfamiliar with the matter that the patch deals with.\n\nNote that your patch applies with \"fuzz 2\" against a vanilla sage-4.7.2.alpha3, you probably should make a clean version.",
    "created_at": "2011-10-06T15:28:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168653",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:16'></a>
Doing some timing...

I am afraid I will not be able to review your patch because I am too unfamiliar with the matter that the patch deals with.

Note that your patch applies with "fuzz 2" against a vanilla sage-4.7.2.alpha3, you probably should make a clean version.



---

archive/issue_comments_168654.json:
```json
{
    "body": "<a id='comment:17'></a>\nWith sage-4.7.2.alpha2 plus #9138 plus #11734 (which is a blocker for 4.7.2 merged in alpha3) and the latest patch, I get\n\n```\nsage: %time D = J0(46).endomorphism_ring().discriminant()\nCPU times: user 5.52 s, sys: 0.19 s, total: 5.72 s\nWall time: 5.74 s\nsage: %time TestSuite(CrystalOfTableaux(['B',4],shape=[2,1,1,0])).run()\nCPU times: user 7.05 s, sys: 0.02 s, total: 7.06 s\nWall time: 7.28 s\nsage: W.<z> = CyclotomicField(13)\nsage: %time M = Matrix(W, 2, 3, [10^30*(1-z)^13, 1, 2, 3, 4, z]).echelon_form()\nCPU times: user 3.70 s, sys: 0.01 s, total: 3.71 s\nWall time: 3.73 s\nsage: %time L = EllipticCurve('960d1').prove_BSD()\nCPU times: user 6.26 s, sys: 0.04 s, total: 6.30 s\nWall time: 6.31 s\nsage: def test(E):\n....:     for p in prime_range(10000):\n....:         if p != 389:\n....:             G = E.change_ring(GF(p)).abelian_group()\n....:             \nsage: E = EllipticCurve('389a')\nsage: %time test(E)\nCPU times: user 18.45 s, sys: 0.06 s, total: 18.51 s\nWall time: 18.56 s\nsage: %time for E in cremona_curves([11..100]): S = E.integral_points(both_signs=False)\nCPU times: user 12.54 s, sys: 0.02 s, total: 12.56 s\nWall time: 12.63 s\n```",
    "created_at": "2011-10-06T15:31:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168654",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:17'></a>
With sage-4.7.2.alpha2 plus #9138 plus #11734 (which is a blocker for 4.7.2 merged in alpha3) and the latest patch, I get

```
sage: %time D = J0(46).endomorphism_ring().discriminant()
CPU times: user 5.52 s, sys: 0.19 s, total: 5.72 s
Wall time: 5.74 s
sage: %time TestSuite(CrystalOfTableaux(['B',4],shape=[2,1,1,0])).run()
CPU times: user 7.05 s, sys: 0.02 s, total: 7.06 s
Wall time: 7.28 s
sage: W.<z> = CyclotomicField(13)
sage: %time M = Matrix(W, 2, 3, [10^30*(1-z)^13, 1, 2, 3, 4, z]).echelon_form()
CPU times: user 3.70 s, sys: 0.01 s, total: 3.71 s
Wall time: 3.73 s
sage: %time L = EllipticCurve('960d1').prove_BSD()
CPU times: user 6.26 s, sys: 0.04 s, total: 6.30 s
Wall time: 6.31 s
sage: def test(E):
....:     for p in prime_range(10000):
....:         if p != 389:
....:             G = E.change_ring(GF(p)).abelian_group()
....:             
sage: E = EllipticCurve('389a')
sage: %time test(E)
CPU times: user 18.45 s, sys: 0.06 s, total: 18.51 s
Wall time: 18.56 s
sage: %time for E in cremona_curves([11..100]): S = E.integral_points(both_signs=False)
CPU times: user 12.54 s, sys: 0.02 s, total: 12.56 s
Wall time: 12.63 s
```



---

archive/issue_comments_168655.json:
```json
{
    "body": "<a id='comment:18'></a>\nReplying to [jdemeyer](#comment%3A16):\n> \n> Note that your patch applies with \"fuzz 2\" against a vanilla sage-4.7.2.alpha3, you probably should make a clean version.\n\n\nReally? Did you test the latest patch?\n\nAnyway. For me, the priority is to first get it working.",
    "created_at": "2011-10-06T15:32:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168655",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:18'></a>
Replying to [jdemeyer](#comment%3A16):
> 
> Note that your patch applies with "fuzz 2" against a vanilla sage-4.7.2.alpha3, you probably should make a clean version.


Really? Did you test the latest patch?

Anyway. For me, the priority is to first get it working.



---

archive/issue_comments_168656.json:
```json
{
    "body": "<a id='comment:19'></a>\nReplying to [SimonKing](#comment%3A18):\n> Really? Did you test the latest patch?\n\nI think so.\n\n> Anyway. For me, the priority is to first get it working.\n  \nI agree, but I thougt you should know...",
    "created_at": "2011-10-06T15:34:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168656",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:19'></a>
Replying to [SimonKing](#comment%3A18):
> Really? Did you test the latest patch?

I think so.

> Anyway. For me, the priority is to first get it working.
  
I agree, but I thougt you should know...



---

archive/issue_comments_168657.json:
```json
{
    "body": "<a id='comment:20'></a>\nIndeed, there is some fuzz. I'll take care of that in the next patch version.",
    "created_at": "2011-10-06T16:01:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168657",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:20'></a>
Indeed, there is some fuzz. I'll take care of that in the next patch version.



---

archive/issue_comments_168658.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2011-10-06T16:07:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168658",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_168659.json:
```json
{
    "body": "<a id='comment:21'></a>\nSo far, I did not cache join (only hom_category). That should be done next.",
    "created_at": "2011-10-06T16:07:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168659",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:21'></a>
So far, I did not cache join (only hom_category). That should be done next.



---

archive/issue_comments_168660.json:
```json
{
    "body": "<a id='comment:22'></a>\n(this also posted to sage-devel)\n\n\nSome updated timings below, all times are best-out-of-3 wall times, in seconds. Patch #11900 is in progress so the timing is with the current patch. \"baseline\" means sage-4.7.2.alpha3 without #9138.  Clearly, the slowdown of elltest2.sage is not due to #9138. Also Singular does not cause a slowdown.\n\n```\ncyclomat.sage:\nsage-4.7.2.alpha2:           6.9\nbaseline:                    7.3\nbaseline + #9138 + #11900:   7.4\nbaseline + #11339 + #10903:  6.8\n\nellbsd.sage:\nsage-4.7.2.alpha2:           7.5\nbaseline:                    7.3\nbaseline + #9138 + #11900:  12.4\nbaseline + #11339 + #10903:  7.4\n\nelltest1.sage:\nsage-4.7.2.alpha2:          27.0\nbaseline:                   24.4\nbaseline + #9138 + #11900:  31.7\nbaseline + #11339 + #10903: 24.7\n\nelltest2.sage:\nsage-4.7.2.alpha2:          19.6\nbaseline:                   63.8\nbaseline + #9138 + #11900:  62.3\nbaseline + #11339 + #10903: 62.9\n\nJ0_46_disc.sage\nsage-4.7.2.alpha2:           8.9\nbaseline:                    8.2\nbaseline + #9138 + #11900:   8.8\nbaseline + #11339 + #10903:  8.4\n```",
    "created_at": "2011-10-06T16:25:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168660",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'></a>
(this also posted to sage-devel)


Some updated timings below, all times are best-out-of-3 wall times, in seconds. Patch #11900 is in progress so the timing is with the current patch. "baseline" means sage-4.7.2.alpha3 without #9138.  Clearly, the slowdown of elltest2.sage is not due to #9138. Also Singular does not cause a slowdown.

```
cyclomat.sage:
sage-4.7.2.alpha2:           6.9
baseline:                    7.3
baseline + #9138 + #11900:   7.4
baseline + #11339 + #10903:  6.8

ellbsd.sage:
sage-4.7.2.alpha2:           7.5
baseline:                    7.3
baseline + #9138 + #11900:  12.4
baseline + #11339 + #10903:  7.4

elltest1.sage:
sage-4.7.2.alpha2:          27.0
baseline:                   24.4
baseline + #9138 + #11900:  31.7
baseline + #11339 + #10903: 24.7

elltest2.sage:
sage-4.7.2.alpha2:          19.6
baseline:                   63.8
baseline + #9138 + #11900:  62.3
baseline + #11339 + #10903: 62.9

J0_46_disc.sage
sage-4.7.2.alpha2:           8.9
baseline:                    8.2
baseline + #9138 + #11900:   8.8
baseline + #11339 + #10903:  8.4
```



---

archive/issue_comments_168661.json:
```json
{
    "body": "<a id='comment:23'></a>\nOK, the timings indicate that I should now focus on\n\n```\nL = EllipticCurve('960d1').prove_BSD()\n```\nand\n\n```\nE = EllipticCurve('389a')\nfor p in prime_range(10000):\n\tif p != 389:\n\t\tG = E.change_ring(GF(p)).abelian_group()\n```",
    "created_at": "2011-10-06T18:12:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168661",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:23'></a>
OK, the timings indicate that I should now focus on

```
L = EllipticCurve('960d1').prove_BSD()
```
and

```
E = EllipticCurve('389a')
for p in prime_range(10000):
	if p != 389:
		G = E.change_ring(GF(p)).abelian_group()
```



---

archive/issue_comments_168662.json:
```json
{
    "body": "<a id='comment:24'></a>\nThe remaining slowness seems to be related with the initialisation of multivariate polynomial rings (implemented in libsingular). As for matrices, it seems to be a problem that #9138 constructs the coercion from the base ring during initialisation, and not when it is first requested.\n\nThe difference between matrix spaces and libsingular polynomial rings is that the latter does not use the new coercion model yet. I'll try to fix that, and hope that it will reduce the regression.",
    "created_at": "2011-10-06T18:50:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168662",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:24'></a>
The remaining slowness seems to be related with the initialisation of multivariate polynomial rings (implemented in libsingular). As for matrices, it seems to be a problem that #9138 constructs the coercion from the base ring during initialisation, and not when it is first requested.

The difference between matrix spaces and libsingular polynomial rings is that the latter does not use the new coercion model yet. I'll try to fix that, and hope that it will reduce the regression.



---

archive/issue_comments_168663.json:
```json
{
    "body": "<a id='comment:25'></a>\nImplementing the new coercion for libsingular will not be easy, but it seems that it will pay off: It seems to me that some tests in _coerce_c_impl are done each time an element is coerced, rather than once, just for the parent of that element.",
    "created_at": "2011-10-06T19:06:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168663",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:25'></a>
Implementing the new coercion for libsingular will not be easy, but it seems that it will pay off: It seems to me that some tests in _coerce_c_impl are done each time an element is coerced, rather than once, just for the parent of that element.



---

archive/issue_comments_168664.json:
```json
{
    "body": "<a id='comment:26'></a>\nI managed to implement the new coercion model for libsingular rings, therefore cc to Martin.\n\nOne trick to make that work: One should acknowledge that polynomial rings are unique parents (unless one destroys uniqueness on purpose), thus, the hash can be `id(self)` and `__cmp__` can be identity of objects.\n\nWhat has hash and cmp to do with the new coercion model? There was a custom `__richcmp__` in the code. It somehow managed to trigger a test for the old coercion model. And unfortunately, if replaces `__cmp__` by `_element_constructor_` then the test for the *old* coercion model raises an exception, even though `_element_constructor_` is supposed to be a tool of the *new* model.\n\nI think that in a different ticket, one can build on top of that and replace the current (and always repeated!) coercion tests on elements by tests that are done *once* for the parent of these elements. That would improve the performance.\n\nPerhaps that was not a very clear explanation. Anyway.\n\nWith the new coercion, it becomes possible to avoid the construction of a coercion from the base ring during initialisation.\n\nIn addition, I am working on a simplification of the choice of category during `PolynomialRing_generic.__init__`. It uses `sage.rings.categories.Category.join`, but could actually directly construct a `JoinCategory`, since all the additional work in `sage.rings.categories.Category.join` is not needed. Since `join()` eats a lot of time in the benchmarks, I am confident that we will see an improvement.\n\nThat's the plan, now I have to do tests...",
    "created_at": "2011-10-07T14:14:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168664",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:26'></a>
I managed to implement the new coercion model for libsingular rings, therefore cc to Martin.

One trick to make that work: One should acknowledge that polynomial rings are unique parents (unless one destroys uniqueness on purpose), thus, the hash can be `id(self)` and `__cmp__` can be identity of objects.

What has hash and cmp to do with the new coercion model? There was a custom `__richcmp__` in the code. It somehow managed to trigger a test for the old coercion model. And unfortunately, if replaces `__cmp__` by `_element_constructor_` then the test for the *old* coercion model raises an exception, even though `_element_constructor_` is supposed to be a tool of the *new* model.

I think that in a different ticket, one can build on top of that and replace the current (and always repeated!) coercion tests on elements by tests that are done *once* for the parent of these elements. That would improve the performance.

Perhaps that was not a very clear explanation. Anyway.

With the new coercion, it becomes possible to avoid the construction of a coercion from the base ring during initialisation.

In addition, I am working on a simplification of the choice of category during `PolynomialRing_generic.__init__`. It uses `sage.rings.categories.Category.join`, but could actually directly construct a `JoinCategory`, since all the additional work in `sage.rings.categories.Category.join` is not needed. Since `join()` eats a lot of time in the benchmarks, I am confident that we will see an improvement.

That's the plan, now I have to do tests...



---

archive/issue_comments_168665.json:
```json
{
    "body": "New coercion for libsingular; faster category choice for polynomial rings.",
    "created_at": "2011-10-07T14:24:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168665",
    "user": "https://github.com/simon-king-jena"
}
```

New coercion for libsingular; faster category choice for polynomial rings.



---

archive/issue_comments_168666.json:
```json
{
    "body": "<a id='comment:27'></a>\nAttachment [trac11900_polynomial_coercion_and_categories.patch](tarball://root/attachments/some-uuid/ticket11900/trac11900_polynomial_coercion_and_categories.patch) by @simon-king-jena created at 2011-10-07 14:34:23\n\nI have attached a second patch, in which I implemented the ideas sketched above. Doc tests need work (I guess some old tests will need to be rewritten).\n\nThere is some improvement in the timings, With sage-4.7.2.alpha3 and both patches applied, I get:\n\n```\nsage: %time L = EllipticCurve('960d1').prove_BSD()\nCPU times: user 5.01 s, sys: 0.06 s, total: 5.07 s\nWall time: 5.22 s\n```\nSage-4.7.2.alpha2 took 4.01 s on that example. Thus, with the second patch, we \"only\" have half of the regression that we had after the first patch, and only one fifth of the regression without both patches.\n\nThe other critical example became:\n\n```\nsage: E = EllipticCurve('389a')\nsage: %time test(E)\nCPU times: user 15.93 s, sys: 0.04 s, total: 15.97 s\nWall time: 16.03 s\n```\nSage-4.7.2.alpha2 took 16.73 s. Hence, here we actually have a slight improvement, where we previously had a drastic regression.\n\nI need more tests, but I think that I can now hope to \"rescue\" #9138.",
    "created_at": "2011-10-07T14:34:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168666",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:27'></a>
Attachment [trac11900_polynomial_coercion_and_categories.patch](tarball://root/attachments/some-uuid/ticket11900/trac11900_polynomial_coercion_and_categories.patch) by @simon-king-jena created at 2011-10-07 14:34:23

I have attached a second patch, in which I implemented the ideas sketched above. Doc tests need work (I guess some old tests will need to be rewritten).

There is some improvement in the timings, With sage-4.7.2.alpha3 and both patches applied, I get:

```
sage: %time L = EllipticCurve('960d1').prove_BSD()
CPU times: user 5.01 s, sys: 0.06 s, total: 5.07 s
Wall time: 5.22 s
```
Sage-4.7.2.alpha2 took 4.01 s on that example. Thus, with the second patch, we "only" have half of the regression that we had after the first patch, and only one fifth of the regression without both patches.

The other critical example became:

```
sage: E = EllipticCurve('389a')
sage: %time test(E)
CPU times: user 15.93 s, sys: 0.04 s, total: 15.97 s
Wall time: 16.03 s
```
Sage-4.7.2.alpha2 took 16.73 s. Hence, here we actually have a slight improvement, where we previously had a drastic regression.

I need more tests, but I think that I can now hope to "rescue" #9138.



---

archive/issue_comments_168667.json:
```json
{
    "body": "<a id='comment:28'></a>\nRunning the `L = EllipticCurve('960d1').prove_BSD()` example with %prun, I find that a considerable amount of time is spent for calling cached functions. That is not the case with sage-4.7.2.alpha2 plus #11342. I guess that comes from the caching for the `join()` method in my first patch.\n\nI see two ways to proceed: Test whether #11115 turns the increased use of cached function into an advantage. Or try to find out what cached function is actually called, and from where, and reduce it.",
    "created_at": "2011-10-07T15:43:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168667",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:28'></a>
Running the `L = EllipticCurve('960d1').prove_BSD()` example with %prun, I find that a considerable amount of time is spent for calling cached functions. That is not the case with sage-4.7.2.alpha2 plus #11342. I guess that comes from the caching for the `join()` method in my first patch.

I see two ways to proceed: Test whether #11115 turns the increased use of cached function into an advantage. Or try to find out what cached function is actually called, and from where, and reduce it.



---

archive/issue_comments_168668.json:
```json
{
    "body": "<a id='comment:29'></a>\nFor the record: #11115 makes the cached function disappear from %prun (but that's no surprise, since %prun can not see through Cython). So, I have to try the second alternative.",
    "created_at": "2011-10-07T15:56:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168668",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:29'></a>
For the record: #11115 makes the cached function disappear from %prun (but that's no surprise, since %prun can not see through Cython). So, I have to try the second alternative.



---

archive/issue_comments_168669.json:
```json
{
    "body": "<a id='comment:30'></a>\nReplying to [SimonKing](#comment%3A29):\n> For the record: #11115 makes the cached function disappear from %prun (but that's no surprise, since %prun can not see through Cython)...\n\n\nI forgot to continue the phrase: ..., but the timing did not improve. That is why I have to try the second alternative.",
    "created_at": "2011-10-07T16:07:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168669",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:30'></a>
Replying to [SimonKing](#comment%3A29):
> For the record: #11115 makes the cached function disappear from %prun (but that's no surprise, since %prun can not see through Cython)...


I forgot to continue the phrase: ..., but the timing did not improve. That is why I have to try the second alternative.



---

archive/issue_comments_168670.json:
```json
{
    "body": "<a id='comment:31'></a>\nStill, there is too much time spent on the initialisation of polynomial rings. And the reason seems to be the construction of the parent class of the categories.\n\nA polynomial ring over a finite prime field F belongs to the category of Commutative Algebras of F (by #9138). In order to provide the ring with the correct class (`PolynomialRing_dense_mod_p_with_category` in this case), one needs to have the parent class of `CommutativeAlgebras(F)`. But this involves to know the parent classes of F algebras, F vector spaces, F bimodules, F left modules, F right modules, and rings.\n\nDuring the elliptic curve computation, F varies. Hence, all the base classes need to be computed over and over again.\n\nI wonder whether it is possible to make the parent class of a category *independent* of the base (here: F) of the category. Then, one could avoid the creation of about 5000 dynamic classes during the elliptic curve computation. I guess that's a question to sage-combinat-devel.\n\nHow might this work? Perhaps make the parent class of a category a class attribute: `Algebras(F).parent_class` depends on `F`, but `Algebras(F).__class__.parent_class` would be independent of F. Or perhaps one should better introduce a central cache for the parent and element classes, so that `Algebras(F).parent_class` is just a pointer to `parent_class_cache[sage.categories.algebras.Algebras]`.",
    "created_at": "2011-10-07T16:39:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168670",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:31'></a>
Still, there is too much time spent on the initialisation of polynomial rings. And the reason seems to be the construction of the parent class of the categories.

A polynomial ring over a finite prime field F belongs to the category of Commutative Algebras of F (by #9138). In order to provide the ring with the correct class (`PolynomialRing_dense_mod_p_with_category` in this case), one needs to have the parent class of `CommutativeAlgebras(F)`. But this involves to know the parent classes of F algebras, F vector spaces, F bimodules, F left modules, F right modules, and rings.

During the elliptic curve computation, F varies. Hence, all the base classes need to be computed over and over again.

I wonder whether it is possible to make the parent class of a category *independent* of the base (here: F) of the category. Then, one could avoid the creation of about 5000 dynamic classes during the elliptic curve computation. I guess that's a question to sage-combinat-devel.

How might this work? Perhaps make the parent class of a category a class attribute: `Algebras(F).parent_class` depends on `F`, but `Algebras(F).__class__.parent_class` would be independent of F. Or perhaps one should better introduce a central cache for the parent and element classes, so that `Algebras(F).parent_class` is just a pointer to `parent_class_cache[sage.categories.algebras.Algebras]`.



---

archive/issue_comments_168671.json:
```json
{
    "body": "<a id='comment:32'></a>\nReplying to [SimonKing](#comment%3A31):\n> Still, there is too much time spent on the initialisation of polynomial rings. And the reason seems to be the construction of the parent class of the categories.\n> \n> A polynomial ring over a finite prime field F belongs to the category of Commutative Algebras of F (by #9138). In order to provide the ring with the correct class (`PolynomialRing_dense_mod_p_with_category` in this case), one needs to have the parent class of `CommutativeAlgebras(F)`. But this involves to know the parent classes of F algebras, F vector spaces, F bimodules, F left modules, F right modules, and rings.\n> \n> During the elliptic curve computation, F varies. Hence, all the base classes need to be computed over and over again.\n> \n> I wonder whether it is possible to make the parent class of a category *independent* of the base (here: F) of the category. Then, one could avoid the creation of about 5000 dynamic classes during the elliptic curve computation. I guess that's a question to sage-combinat-devel.\n> \n> How might this work? Perhaps make the parent class of a category a class attribute: `Algebras(F).parent_class` depends on `F`, but `Algebras(F).__class__.parent_class` would be independent of F. Or perhaps one should better introduce a central cache for the parent and element classes, so that `Algebras(F).parent_class` is just a pointer to `parent_class_cache[sage.categories.algebras.Algebras]`.\n\n\nActually that was the original intent; see the discussion around line 240 of category.py: two categories sharing the same inheritance diagram for their parent class would actually share that parent class. The implementation was simple: there was a cache on the dynamic class creation. There are two issues though:\n\n- How to pickle such a class: the only solution I found was to pickle it as Algebras(F).parent_class; but this requires to store \"Algebras(F)\" as part of the parent class, which prevents sharing. Better solutions welcome!\n\n- Even if the above is changed, this would still require the creation of the categories Algebras(F) (and super categories) for all F, which could take some time.\n\n- I had had similar issues with the coercion system with MuPAD (the factoring code was creating zillions of fields, which crowded the coercion graph). So I already thought about modeling simultaneously a bunch of parents/categories having the exact same properties as a single template object (say in the coercion graph). But I did not come up with great solutions yet.\n\n- One needs to be a bit carefull, as the inheritance diagram may depend on F. For example, Algebras(F).parent_class derives from VectorSpaces(F).parent_class iff F is a field.\n\n\nOnce again, I am glad you are working on those category optimizations!\n\nAltogether your proposals look very good. I am just unsure about short\ncircuiting \"Category.join\", but I would need to look more in\ndetail. Maybe we would need to add an abstraction layer in\nbetween. Anyway go ahead with whatever works for fixing #11900, and if\nwe find something better, we can do it in a later patch.",
    "created_at": "2011-10-07T17:07:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168671",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:32'></a>
Replying to [SimonKing](#comment%3A31):
> Still, there is too much time spent on the initialisation of polynomial rings. And the reason seems to be the construction of the parent class of the categories.
> 
> A polynomial ring over a finite prime field F belongs to the category of Commutative Algebras of F (by #9138). In order to provide the ring with the correct class (`PolynomialRing_dense_mod_p_with_category` in this case), one needs to have the parent class of `CommutativeAlgebras(F)`. But this involves to know the parent classes of F algebras, F vector spaces, F bimodules, F left modules, F right modules, and rings.
> 
> During the elliptic curve computation, F varies. Hence, all the base classes need to be computed over and over again.
> 
> I wonder whether it is possible to make the parent class of a category *independent* of the base (here: F) of the category. Then, one could avoid the creation of about 5000 dynamic classes during the elliptic curve computation. I guess that's a question to sage-combinat-devel.
> 
> How might this work? Perhaps make the parent class of a category a class attribute: `Algebras(F).parent_class` depends on `F`, but `Algebras(F).__class__.parent_class` would be independent of F. Or perhaps one should better introduce a central cache for the parent and element classes, so that `Algebras(F).parent_class` is just a pointer to `parent_class_cache[sage.categories.algebras.Algebras]`.


Actually that was the original intent; see the discussion around line 240 of category.py: two categories sharing the same inheritance diagram for their parent class would actually share that parent class. The implementation was simple: there was a cache on the dynamic class creation. There are two issues though:

- How to pickle such a class: the only solution I found was to pickle it as Algebras(F).parent_class; but this requires to store "Algebras(F)" as part of the parent class, which prevents sharing. Better solutions welcome!

- Even if the above is changed, this would still require the creation of the categories Algebras(F) (and super categories) for all F, which could take some time.

- I had had similar issues with the coercion system with MuPAD (the factoring code was creating zillions of fields, which crowded the coercion graph). So I already thought about modeling simultaneously a bunch of parents/categories having the exact same properties as a single template object (say in the coercion graph). But I did not come up with great solutions yet.

- One needs to be a bit carefull, as the inheritance diagram may depend on F. For example, Algebras(F).parent_class derives from VectorSpaces(F).parent_class iff F is a field.


Once again, I am glad you are working on those category optimizations!

Altogether your proposals look very good. I am just unsure about short
circuiting "Category.join", but I would need to look more in
detail. Maybe we would need to add an abstraction layer in
between. Anyway go ahead with whatever works for fixing #11900, and if
we find something better, we can do it in a later patch.



---

archive/issue_comments_168672.json:
```json
{
    "body": "<a id='comment:33'></a>\nReplying to [nthiery](#comment%3A32):\n> Altogether your proposals look very good. I am just unsure about short\n> circuiting \"Category.join\", but I would need to look more in\n> detail.\n\n\nWhich of the two work-arounds do you mean? The caching (so that the cache already happens when calling `Category.join(L)`, not only when creating the `JoinCategory`)? Or the attempt to directly create the `JoinCategory` during creation of a polynomial ring?\n\nI think the latter is justified by having only few cases: It can be `UniqueFactorisationDomain`, `IntegralDomain` or `EuclideanDomain`, and it can be commutative or not. So, one can directly write down the result, rather than calling the `Category.join(...)` mechanism. Of course, one needs to verify that I wrote it down correctly.",
    "created_at": "2011-10-07T17:45:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168672",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:33'></a>
Replying to [nthiery](#comment%3A32):
> Altogether your proposals look very good. I am just unsure about short
> circuiting "Category.join", but I would need to look more in
> detail.


Which of the two work-arounds do you mean? The caching (so that the cache already happens when calling `Category.join(L)`, not only when creating the `JoinCategory`)? Or the attempt to directly create the `JoinCategory` during creation of a polynomial ring?

I think the latter is justified by having only few cases: It can be `UniqueFactorisationDomain`, `IntegralDomain` or `EuclideanDomain`, and it can be commutative or not. So, one can directly write down the result, rather than calling the `Category.join(...)` mechanism. Of course, one needs to verify that I wrote it down correctly.



---

archive/issue_comments_168673.json:
```json
{
    "body": "<a id='comment:34'></a>\nReplying to [SimonKing](#comment%3A33):\n> Replying to [nthiery](#comment%3A32):\n> Which of the two work-arounds do you mean? \n\n\nActually both :-)\n\n> The caching (so that the cache already happens when calling\n> `Category.join(L)`, not only when creating the `JoinCategory`)? Or\n> the attempt to directly create the `JoinCategory` during creation of\n> a polynomial ring?\n\n\nThis might induce some quite big caching, since a given join may be\ncreated in many different ways (order of arguments, ...). That being\nsaid, maybe that's not so bad. Also, I need to check how this evolves\nwith the upcoming \"more category constructions\" patch. Anyway, I guess\nwe can wait until we actually meet the issue with that cache, if we\ndo, before removing it again.\n\n> I think the latter is justified by having only few cases: It can be `UniqueFactorisationDomain`, `IntegralDomain` or `EuclideanDomain`, and it can be commutative or not. So, one can directly write down the result, rather than calling the `Category.join(...)` mechanism. Of course, one needs to verify that I wrote it down correctly.\n\n\nThe only potential issue is about the order of the categories in the join. Having everything go through Category.join makes it easier to maintain consistency, and make it evolve if needed. But if this remains a it is a well documented and well motivated exception, that could be ok. It's not worst than the order appearing in all the super_categories methods.\n\nCheers,\n                    Nicolas",
    "created_at": "2011-10-07T20:12:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168673",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:34'></a>
Replying to [SimonKing](#comment%3A33):
> Replying to [nthiery](#comment%3A32):
> Which of the two work-arounds do you mean? 


Actually both :-)

> The caching (so that the cache already happens when calling
> `Category.join(L)`, not only when creating the `JoinCategory`)? Or
> the attempt to directly create the `JoinCategory` during creation of
> a polynomial ring?


This might induce some quite big caching, since a given join may be
created in many different ways (order of arguments, ...). That being
said, maybe that's not so bad. Also, I need to check how this evolves
with the upcoming "more category constructions" patch. Anyway, I guess
we can wait until we actually meet the issue with that cache, if we
do, before removing it again.

> I think the latter is justified by having only few cases: It can be `UniqueFactorisationDomain`, `IntegralDomain` or `EuclideanDomain`, and it can be commutative or not. So, one can directly write down the result, rather than calling the `Category.join(...)` mechanism. Of course, one needs to verify that I wrote it down correctly.


The only potential issue is about the order of the categories in the join. Having everything go through Category.join makes it easier to maintain consistency, and make it evolve if needed. But if this remains a it is a well documented and well motivated exception, that could be ok. It's not worst than the order appearing in all the super_categories methods.

Cheers,
                    Nicolas



---

archive/issue_comments_168674.json:
```json
{
    "body": "<a id='comment:35'></a>\nBefore I sleep, just a brief report.\n\nIt seems to be perfectly alright if one lets parent and element classes rely on the default pickling of dynamic classes. This alone suffices to have\n\n```\n  sage: Algebras(GF(3)).parent_class is Algebras(GF(5)).parent_class\n  True\n  sage: loads(dumps(Algebras(GF(3)).parent_class)) is Algebras(GF(5)).parent_class\n  True\n  sage: Algebras(GF(3)).parent_class is Algebras(ZZ).parent_class\n  False\n  sage: Coalgebras(QQ).parent_class is Coalgebras(FractionField(QQ[x])).parent_class\n  True \n```\nThe latter was mentioned as \"todo\" in category.py\n\nAnd:\n\n```\nsage: %time L = EllipticCurve('960d1').prove_BSD()\nCPU times: user 3.85 s, sys: 0.08 s, total: 3.93 s\nWall time: 4.08 s\n```\n\nIn other words, the regression for `prove_BSD` disappears!\n\nI certainly need to add some doc tests for the new feature, and also it will probably be needed to fix old tests. But I am confident that I can post a new patch tomorrow, that may be enough to fix the regression completely.",
    "created_at": "2011-10-07T20:47:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168674",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:35'></a>
Before I sleep, just a brief report.

It seems to be perfectly alright if one lets parent and element classes rely on the default pickling of dynamic classes. This alone suffices to have

```
  sage: Algebras(GF(3)).parent_class is Algebras(GF(5)).parent_class
  True
  sage: loads(dumps(Algebras(GF(3)).parent_class)) is Algebras(GF(5)).parent_class
  True
  sage: Algebras(GF(3)).parent_class is Algebras(ZZ).parent_class
  False
  sage: Coalgebras(QQ).parent_class is Coalgebras(FractionField(QQ[x])).parent_class
  True 
```
The latter was mentioned as "todo" in category.py

And:

```
sage: %time L = EllipticCurve('960d1').prove_BSD()
CPU times: user 3.85 s, sys: 0.08 s, total: 3.93 s
Wall time: 4.08 s
```

In other words, the regression for `prove_BSD` disappears!

I certainly need to add some doc tests for the new feature, and also it will probably be needed to fix old tests. But I am confident that I can post a new patch tomorrow, that may be enough to fix the regression completely.



---

archive/issue_comments_168675.json:
```json
{
    "body": "<a id='comment:36'></a>\nReplying to [nthiery](#comment%3A34):\n> > The caching (so that the cache already happens when calling\n> > `Category.join(L)`, not only when creating the `JoinCategory`)? Or\n> > the attempt to directly create the `JoinCategory` during creation of\n> > a polynomial ring?\n\n> \n> This might induce some quite big caching, since a given join may be\n> created in many different ways (order of arguments, ...).\n\n\nI thought that the join does depend on the order of the input categories. If it doesn't, one could always use frozen sets as key, rather than tuples.\n\n> > I think the latter is justified by having only few cases: It can be `UniqueFactorisationDomain`, `IntegralDomain` or `EuclideanDomain`, and it can be commutative or not. So, one can directly write down the result, rather than calling the `Category.join(...)` mechanism. Of course, one needs to verify that I wrote it down correctly.\n\n> \n> The only potential issue is about the order of the categories in the join. Having everything go through Category.join makes it easier to maintain consistency, and make it evolve if needed.\n\n\nOK. If join changes the order of arguments in future versions of Sage, then we should change the five or six hard-coded categories that my patch uses in the initialisation of polynomial rings.\n\nI suggest to add doc tests of the form\n\n```\nsage: P.<x> = ZZ[]\nsage: P.category() is Category.join([CommutativeAlgebras(ZZ), UniqueFactorizationDomains()])\nTrue\n```\n(that should be the answer, but with the current patch it is only the join of `Algebras(ZZ)` with `UniqueFactorizationDomains()`. So, that needs to bee fixed as well.\n\nHaving such tests would detect incompatible changes in the order of base categories in the join.",
    "created_at": "2011-10-07T20:59:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168675",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:36'></a>
Replying to [nthiery](#comment%3A34):
> > The caching (so that the cache already happens when calling
> > `Category.join(L)`, not only when creating the `JoinCategory`)? Or
> > the attempt to directly create the `JoinCategory` during creation of
> > a polynomial ring?

> 
> This might induce some quite big caching, since a given join may be
> created in many different ways (order of arguments, ...).


I thought that the join does depend on the order of the input categories. If it doesn't, one could always use frozen sets as key, rather than tuples.

> > I think the latter is justified by having only few cases: It can be `UniqueFactorisationDomain`, `IntegralDomain` or `EuclideanDomain`, and it can be commutative or not. So, one can directly write down the result, rather than calling the `Category.join(...)` mechanism. Of course, one needs to verify that I wrote it down correctly.

> 
> The only potential issue is about the order of the categories in the join. Having everything go through Category.join makes it easier to maintain consistency, and make it evolve if needed.


OK. If join changes the order of arguments in future versions of Sage, then we should change the five or six hard-coded categories that my patch uses in the initialisation of polynomial rings.

I suggest to add doc tests of the form

```
sage: P.<x> = ZZ[]
sage: P.category() is Category.join([CommutativeAlgebras(ZZ), UniqueFactorizationDomains()])
True
```
(that should be the answer, but with the current patch it is only the join of `Algebras(ZZ)` with `UniqueFactorizationDomains()`. So, that needs to bee fixed as well.

Having such tests would detect incompatible changes in the order of base categories in the join.



---

archive/issue_comments_168676.json:
```json
{
    "body": "**Work_Issues:** fiy doctests, fix categories for polynomial rings",
    "created_at": "2011-10-07T20:59:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168676",
    "user": "https://github.com/simon-king-jena"
}
```

**Work_Issues:** fiy doctests, fix categories for polynomial rings



---

archive/issue_comments_168677.json:
```json
{
    "body": "<a id='comment:37'></a>\nConcerning \"Choice of categories for polynomial rings\", I suggest to add a function somewhere (perhaps in sage/rings/polynomial/multi_polynomial_ring.py) that takes the category of the base ring and the number of generators as arguments, and returns the appropriate category of the polynomial ring.\n\nThat would certainly be better (and easier to maintain and also easier to cache and thus more efficient) than to choose the category in the different `__init__` methods of different kinds of polynomial rings.",
    "created_at": "2011-10-08T08:42:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168677",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:37'></a>
Concerning "Choice of categories for polynomial rings", I suggest to add a function somewhere (perhaps in sage/rings/polynomial/multi_polynomial_ring.py) that takes the category of the base ring and the number of generators as arguments, and returns the appropriate category of the polynomial ring.

That would certainly be better (and easier to maintain and also easier to cache and thus more efficient) than to choose the category in the different `__init__` methods of different kinds of polynomial rings.



---

archive/issue_events_037127.json:
```json
{
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "label": "blocker",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11900#event-37127"
}
```



---

archive/issue_comments_168678.json:
```json
{
    "body": "<a id='comment:39'></a>\nIn order to keep patches small, my plan is to provide two patches. The first will be an update of the \"polynomial categories and coercion\" patch. The second shall deal with parent/element classes of categories, which is a separate issue.\n\n**Concerning the \"polynomial categories and coercion\":**\n\n__Choice of category__\n\nReplying to [SimonKing](#comment%3A37):\n> I suggest to add a function somewhere (perhaps in sage/rings/polynomial/multi_polynomial_ring.py) that takes the category of the base ring and the number of generators as arguments, and returns the appropriate category of the polynomial ring.\n\n\nThat seems to work fine. Since I directly construct a `JoinCategory` rather than calling `Category.join`, it is a little faster, and it is certainly easier to maintain than the current approach.\n\n__Easier detection of ring structures__\n\nCurrently, if one wants to test whether a parent is a Euclidean domain, one has to do `P in EuclideanDomains()`, which boils down to `P.category().is_subcategory(EuclideanDomains())`. That implies the construction of all super-categories of `P.category()` and is thus rather slow.\n\nI guess it would be *much* faster to add parent methods that tell whether the ring has a certain structure, and to simply ask `P.is_euclidean_domain()`.\n\nSimilar parent methods should exist for `Fields()`, `Rings()`, `CommutativeRings()` and `IntegralDomains()`.",
    "created_at": "2011-10-09T07:36:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168678",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:39'></a>
In order to keep patches small, my plan is to provide two patches. The first will be an update of the "polynomial categories and coercion" patch. The second shall deal with parent/element classes of categories, which is a separate issue.

**Concerning the "polynomial categories and coercion":**

__Choice of category__

Replying to [SimonKing](#comment%3A37):
> I suggest to add a function somewhere (perhaps in sage/rings/polynomial/multi_polynomial_ring.py) that takes the category of the base ring and the number of generators as arguments, and returns the appropriate category of the polynomial ring.


That seems to work fine. Since I directly construct a `JoinCategory` rather than calling `Category.join`, it is a little faster, and it is certainly easier to maintain than the current approach.

__Easier detection of ring structures__

Currently, if one wants to test whether a parent is a Euclidean domain, one has to do `P in EuclideanDomains()`, which boils down to `P.category().is_subcategory(EuclideanDomains())`. That implies the construction of all super-categories of `P.category()` and is thus rather slow.

I guess it would be *much* faster to add parent methods that tell whether the ring has a certain structure, and to simply ask `P.is_euclidean_domain()`.

Similar parent methods should exist for `Fields()`, `Rings()`, `CommutativeRings()` and `IntegralDomains()`.



---

archive/issue_comments_168679.json:
```json
{
    "body": "<a id='comment:40'></a>\nQuestion to the release manager: How shall we proceed with re-mergin #9138? Shall that be done on #9138 (so that we have two separate tickets)? Or shall both merging and fixing #9138 be done here?",
    "created_at": "2011-10-09T11:08:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168679",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:40'></a>
Question to the release manager: How shall we proceed with re-mergin #9138? Shall that be done on #9138 (so that we have two separate tickets)? Or shall both merging and fixing #9138 be done here?



---

archive/issue_comments_168680.json:
```json
{
    "body": "<a id='comment:41'></a>\nReplying to [SimonKing](#comment%3A40):\n> Question to the release manager: How shall we proceed with re-mergin #9138? Shall that be done on #9138 (so that we have two separate tickets)? Or shall both merging and fixing #9138 be done here?\n\n\nI don't really understand your question but let me answer something anyway: I would leave #9138 as it is and put all fixes on #11900.  When #11900 is finished, I will merge #9138 and #11900 at the same time.\n\nSomething else: Singular (#10903) will likely be merged in sage-4.7.2.alpha4.  This will require some of these patches to be rebased.  You may want to have a look at [http://boxen.math.washington.edu/home/release/sage-4.7.2.alpha4/](http://boxen.math.washington.edu/home/release/sage-4.7.2.alpha4/)",
    "created_at": "2011-10-09T11:15:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168680",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:41'></a>
Replying to [SimonKing](#comment%3A40):
> Question to the release manager: How shall we proceed with re-mergin #9138? Shall that be done on #9138 (so that we have two separate tickets)? Or shall both merging and fixing #9138 be done here?


I don't really understand your question but let me answer something anyway: I would leave #9138 as it is and put all fixes on #11900.  When #11900 is finished, I will merge #9138 and #11900 at the same time.

Something else: Singular (#10903) will likely be merged in sage-4.7.2.alpha4.  This will require some of these patches to be rebased.  You may want to have a look at [http://boxen.math.washington.edu/home/release/sage-4.7.2.alpha4/](http://boxen.math.washington.edu/home/release/sage-4.7.2.alpha4/)



---

archive/issue_comments_168681.json:
```json
{
    "body": "<a id='comment:42'></a>\nIn the doc of `sage.categories.category.Category.all_super_categories`, there is stated:\n\n```\n        FIXME:\n\n        - make sure that this is compatible with the python algorithm\n          for method resolution and make it O(n+m)\n```\n\nI think that would be an excellent idea, because the category hierarchy (determined by `all_super_categories`) and the method resolution order of the parent classes should be the same.\n\nI doubt whether Python's mro is O(n+m), though. I know Python's mro algorithm and could implement it, but certainly it could be imported from somewhere, so that my programming effort is not needed here.",
    "created_at": "2011-10-09T11:19:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168681",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:42'></a>
In the doc of `sage.categories.category.Category.all_super_categories`, there is stated:

```
        FIXME:

        - make sure that this is compatible with the python algorithm
          for method resolution and make it O(n+m)
```

I think that would be an excellent idea, because the category hierarchy (determined by `all_super_categories`) and the method resolution order of the parent classes should be the same.

I doubt whether Python's mro is O(n+m), though. I know Python's mro algorithm and could implement it, but certainly it could be imported from somewhere, so that my programming effort is not needed here.



---

archive/issue_comments_168682.json:
```json
{
    "body": "<a id='comment:43'></a>\nReplying to [jdemeyer](#comment%3A41):\n> I don't really understand your question but let me answer something anyway: I would leave #9138 as it is and put all fixes on #11900.  When #11900 is finished, I will merge #9138 and #11900 at the same time.\n\n\nI asked because there was another case where a patch was unmerged, and the release manager insisted on having a *separate* ticket for merging it again - so, he did not simply re-opened the old ticket for that purpose. \n \n> Something else: Singular (#10903) will likely be merged in sage-4.7.2.alpha4.  This will require some of these patches to be rebased.  You may want to have a look at [http://boxen.math.washington.edu/home/release/sage-4.7.2.alpha4/](http://boxen.math.washington.edu/home/release/sage-4.7.2.alpha4/)\n\n\nOK. Is alpha4 \"official\", or is it currently an alpha-prerelease only?",
    "created_at": "2011-10-09T11:22:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168682",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:43'></a>
Replying to [jdemeyer](#comment%3A41):
> I don't really understand your question but let me answer something anyway: I would leave #9138 as it is and put all fixes on #11900.  When #11900 is finished, I will merge #9138 and #11900 at the same time.


I asked because there was another case where a patch was unmerged, and the release manager insisted on having a *separate* ticket for merging it again - so, he did not simply re-opened the old ticket for that purpose. 
 
> Something else: Singular (#10903) will likely be merged in sage-4.7.2.alpha4.  This will require some of these patches to be rebased.  You may want to have a look at [http://boxen.math.washington.edu/home/release/sage-4.7.2.alpha4/](http://boxen.math.washington.edu/home/release/sage-4.7.2.alpha4/)


OK. Is alpha4 "official", or is it currently an alpha-prerelease only?



---

archive/issue_comments_168683.json:
```json
{
    "body": "<a id='comment:44'></a>\nReplying to [SimonKing](#comment%3A43):\n> Is alpha4 \"official\", or is it currently an alpha-prerelease only?\n\n\nIt is currently in testing.  So if no unexpected issues arise, it should be released as it is now.",
    "created_at": "2011-10-09T20:37:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168683",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:44'></a>
Replying to [SimonKing](#comment%3A43):
> Is alpha4 "official", or is it currently an alpha-prerelease only?


It is currently in testing.  So if no unexpected issues arise, it should be released as it is now.



---

archive/issue_comments_168684.json:
```json
{
    "body": "<a id='comment:45'></a>\nReplying to [SimonKing](#comment%3A42):\n> In the doc of `sage.categories.category.Category.all_super_categories`, there is stated:\n> \n> ```\n>         FIXME:\n> \n>         - make sure that this is compatible with the python algorithm\n>           for method resolution and make it O(n+m)\n> ```\n> \n> I think that would be an excellent idea, because the category hierarchy (determined by `all_super_categories`) and the method resolution order of the parent classes should be the same.\n\n\n\nHowever, I think that it should be dealt with on a different ticket, since I don't see how it would help here.\n\nI still see much time spent in `all_super_categories`. I just found that `self.all_super_categores()` does *not* start with `C.all_super_categories()` for C in `self.super_categories()`. That is certainly not very efficient, because it is effectively computing `C.all_supercategories()` repeatedly.",
    "created_at": "2011-10-10T09:05:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168684",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:45'></a>
Replying to [SimonKing](#comment%3A42):
> In the doc of `sage.categories.category.Category.all_super_categories`, there is stated:
> 
> ```
>         FIXME:
> 
>         - make sure that this is compatible with the python algorithm
>           for method resolution and make it O(n+m)
> ```
> 
> I think that would be an excellent idea, because the category hierarchy (determined by `all_super_categories`) and the method resolution order of the parent classes should be the same.



However, I think that it should be dealt with on a different ticket, since I don't see how it would help here.

I still see much time spent in `all_super_categories`. I just found that `self.all_super_categores()` does *not* start with `C.all_super_categories()` for C in `self.super_categories()`. That is certainly not very efficient, because it is effectively computing `C.all_supercategories()` repeatedly.



---

archive/issue_comments_168685.json:
```json
{
    "body": "**Changing work_issues** from \"fiy doctests, fix categories for polynomial rings\" to \"fiy doctests, fix categories for polynomial rings, improve all_super_categories\".",
    "created_at": "2011-10-10T09:05:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168685",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing work_issues** from "fiy doctests, fix categories for polynomial rings" to "fiy doctests, fix categories for polynomial rings, improve all_super_categories".



---

archive/issue_comments_168686.json:
```json
{
    "body": "<a id='comment:46'></a>\nReplying to [SimonKing](#comment%3A45):\n> I still see much time spent in `all_super_categories`. I just found that `self.all_super_categores()` does *not* start with `C.all_super_categories()` for C in `self.super_categories()`. That is certainly not very efficient, because it is effectively computing `C.all_supercategories()` repeatedly.\n\n\nIndeed, it can be improved. And then, the benchmark finally becomes\n\n```\nsage: %time L = EllipticCurve('960d1').prove_BSD()\nCPU times: user 3.60 s, sys: 0.11 s, total: 3.71 s\nWall time: 4.02 s\n```\n\n__Conclusion__\n\nI will not change the order of all_super_categories, and I will not unify the parent classes of different categories - that shall be on a separate ticket.\n\nHowever, I will \n* make libsingular polynomial rings use the new coercion framework, \n* avoid the construction of a coercion from the base ring at initialisation of matrix spaces and polynomial rings,\n* create an external function for choosing the category of a polynomial ring, avoiding the overhead of the `join()` method,\n* add parent methods that provide a faster way of determining algebraic structures than the classical `P in CommutativeRings()`\n* improve the performance of `all_super_categories()`.",
    "created_at": "2011-10-10T11:17:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168686",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:46'></a>
Replying to [SimonKing](#comment%3A45):
> I still see much time spent in `all_super_categories`. I just found that `self.all_super_categores()` does *not* start with `C.all_super_categories()` for C in `self.super_categories()`. That is certainly not very efficient, because it is effectively computing `C.all_supercategories()` repeatedly.


Indeed, it can be improved. And then, the benchmark finally becomes

```
sage: %time L = EllipticCurve('960d1').prove_BSD()
CPU times: user 3.60 s, sys: 0.11 s, total: 3.71 s
Wall time: 4.02 s
```

__Conclusion__

I will not change the order of all_super_categories, and I will not unify the parent classes of different categories - that shall be on a separate ticket.

However, I will 
* make libsingular polynomial rings use the new coercion framework, 
* avoid the construction of a coercion from the base ring at initialisation of matrix spaces and polynomial rings,
* create an external function for choosing the category of a polynomial ring, avoiding the overhead of the `join()` method,
* add parent methods that provide a faster way of determining algebraic structures than the classical `P in CommutativeRings()`
* improve the performance of `all_super_categories()`.



---

archive/issue_comments_168687.json:
```json
{
    "body": "**Changing work_issues** from \"fiy doctests, fix categories for polynomial rings, improve all_super_categories\" to \"fix doctests, fix libsingular pickling\".",
    "created_at": "2011-10-10T12:00:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168687",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing work_issues** from "fiy doctests, fix categories for polynomial rings, improve all_super_categories" to "fix doctests, fix libsingular pickling".



---

archive/issue_comments_168688.json:
```json
{
    "body": "<a id='comment:47'></a>\nI found a pickling bug for libsingular polynomia rings.\n\nFirst session:\n\n```\nsage: P.<foo,bar> = PolynomialRing(QQ)\nsage: save(P,'tmp')\n```\n\nSecond session:\n\n```\nsage: Q = load('tmp.sobj')\nsage: P.<foo,bar> = PolynomialRing(QQ)\nsage: Q is P\nFalse\nsage: Q2 = load('tmp.sobj')\nsage: Q2 is P\nTrue\nsage: Q2 is Q\nFalse\n```\n\nSince I am fixing coercion of libsingular polynomial rings anyway, I'll fix the bug here.",
    "created_at": "2011-10-10T12:00:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168688",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:47'></a>
I found a pickling bug for libsingular polynomia rings.

First session:

```
sage: P.<foo,bar> = PolynomialRing(QQ)
sage: save(P,'tmp')
```

Second session:

```
sage: Q = load('tmp.sobj')
sage: P.<foo,bar> = PolynomialRing(QQ)
sage: Q is P
False
sage: Q2 = load('tmp.sobj')
sage: Q2 is P
True
sage: Q2 is Q
False
```

Since I am fixing coercion of libsingular polynomial rings anyway, I'll fix the bug here.



---

archive/issue_comments_168689.json:
```json
{
    "body": "<a id='comment:48'></a>\nReplying to [SimonKing](#comment%3A47):\n> Since I am fixing coercion of libsingular polynomial rings anyway, I'll fix the bug here.\n\n\nOn the other hand, I was occasionally told to produce smaller patches. So, I created #11911 (which should be easy to review) and make it a dependency.",
    "created_at": "2011-10-10T12:32:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168689",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:48'></a>
Replying to [SimonKing](#comment%3A47):
> Since I am fixing coercion of libsingular polynomial rings anyway, I'll fix the bug here.


On the other hand, I was occasionally told to produce smaller patches. So, I created #11911 (which should be easy to review) and make it a dependency.



---

archive/issue_comments_168690.json:
```json
{
    "body": "**Changing dependencies** from \"#9138\" to \"#9138 #11911\".",
    "created_at": "2011-10-10T12:32:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168690",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing dependencies** from "#9138" to "#9138 #11911".



---

archive/issue_comments_168691.json:
```json
{
    "body": "<a id='comment:49'></a>\nToo bad, the coercion for libsingular seems broken. That will be more work than I thought.",
    "created_at": "2011-10-10T13:23:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168691",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:49'></a>
Too bad, the coercion for libsingular seems broken. That will be more work than I thought.



---

archive/issue_comments_168692.json:
```json
{
    "body": "<a id='comment:50'></a>\nThe broken coercion was relatively easy to fix. I am now returning to some further tuning of the timings. For example, I found that during initialisation of one multivariate polynomial ring, it is tested ten times (!) whether `base_ring in Rings()` or `base_ring in Fields()`. \n\nhat seems like a waste of time (should be done less often), and also it is faster to do `base_ring.is_ring()` if `is_ring` is a parent method.",
    "created_at": "2011-10-10T16:50:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168692",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:50'></a>
The broken coercion was relatively easy to fix. I am now returning to some further tuning of the timings. For example, I found that during initialisation of one multivariate polynomial ring, it is tested ten times (!) whether `base_ring in Rings()` or `base_ring in Fields()`. 

hat seems like a waste of time (should be done less often), and also it is faster to do `base_ring.is_ring()` if `is_ring` is a parent method.



---

archive/issue_comments_168693.json:
```json
{
    "body": "**Changing work_issues** from \"fix doctests, fix libsingular pickling\" to \"fix doctests\".",
    "created_at": "2011-10-10T16:50:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168693",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing work_issues** from "fix doctests, fix libsingular pickling" to "fix doctests".



---

archive/issue_comments_168694.json:
```json
{
    "body": "<a id='comment:51'></a>\nPS: I did another benchmark.\n\n```\nsage: def test():\n....:     for p in prime_range(10000):\n....:         P = GF(p)['t','x','z']\n....:         \nsage: %time test()\nCPU times: user 1.14 s, sys: 0.02 s, total: 1.17 s\nWall time: 1.17 s\n```\nwith sage-4.6.2. I becomes more than two seconds with #9138.",
    "created_at": "2011-10-10T16:51:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168694",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:51'></a>
PS: I did another benchmark.

```
sage: def test():
....:     for p in prime_range(10000):
....:         P = GF(p)['t','x','z']
....:         
sage: %time test()
CPU times: user 1.14 s, sys: 0.02 s, total: 1.17 s
Wall time: 1.17 s
```
with sage-4.6.2. I becomes more than two seconds with #9138.



---

archive/issue_comments_168695.json:
```json
{
    "body": "<a id='comment:52'></a>\nHi Simon,\n\nReplying to [SimonKing](#comment%3A50):\n> and also it is faster to do `base_ring.is_ring()` if `is_ring` is a parent method.\n\n\nI thought that you had optimized the `in` containment to make it as\nfast as a method call? Besides, as far as I remember from previous\ndiscussions, we had agreed on the following:\n\n- X in Fields() would return whether X is already known to be a\n  field.\n\n- X.is_field() would return whether X *is* a field, possibly\n  launching a costly computation if needed, and possibly updating the\n  category afterward\n\nFinally, to do dispatching in category code, the preferred idiom would\nbe X in Fields(). Roughly speaking, operations on an element depend on\nits declared parent, operations on a parent depend on its declared\ncategory.\n\nCheers,\n                            Nicolas",
    "created_at": "2011-10-11T08:25:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168695",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:52'></a>
Hi Simon,

Replying to [SimonKing](#comment%3A50):
> and also it is faster to do `base_ring.is_ring()` if `is_ring` is a parent method.


I thought that you had optimized the `in` containment to make it as
fast as a method call? Besides, as far as I remember from previous
discussions, we had agreed on the following:

- X in Fields() would return whether X is already known to be a
  field.

- X.is_field() would return whether X *is* a field, possibly
  launching a costly computation if needed, and possibly updating the
  category afterward

Finally, to do dispatching in category code, the preferred idiom would
be X in Fields(). Roughly speaking, operations on an element depend on
its declared parent, operations on a parent depend on its declared
category.

Cheers,
                            Nicolas



---

archive/issue_comments_168696.json:
```json
{
    "body": "<a id='comment:53'></a>\nHi Nicolas,\n\nReplying to [nthiery](#comment%3A52):\n> Replying to [SimonKing](#comment%3A50):\n> > and also it is faster to do `base_ring.is_ring()` if `is_ring` is a parent method.\n\n> \n> I thought that you had optimized the `in` containment to make it as\n> fast as a method call?\n\n\nThat's #10667 and needs much more work than this. My aim *here* is to try and find a sufficiently good solution, so that #9138 can be rescued.\n\nIt could very well be that some of the changes (e.g. the use of `is_ring`) will be reverted by #10667, and replaced with a better solution. But I simply wouldn't like to wait another couple of months for #10667 to be finished - it would be a shame to postpone #9138 (which happens to be a dependency for #10667) such a long time.\n\n>  - X in Fields() would return whether X is already known to be a field. \n \n>\n>  - X.is_field() would return whether X *is* a field, possibly\n>    launching a costly computation if needed, and possibly updating the\n>    category afterward\n\n\nYou are mistaken. Please look at the `__contains__` method of `Fields()`. It dispatches to `sage.rings.fields.is_Field`, which dispatches to `P.is_field()`.\n\nBesides, in cases where this is a problem, there is a `proof=False` option for is_field. I would accept to argue that `P in Fields()` should be preserved, because of the difficulty of testing field-ness, and because it is not tested so often.\n\nBut `P in Rings()` is tested often and is too slow. X in Rings()` takes an awful lot of time and is one of the four main causes for the regression. Bear in mind what `X in Rings()` involves:\n* Calling `Rings()`, which will be faster by #11115 (cached methods), but currently is not cheap. Thus, defining `_Rings = Rings()` once in a module and then testing `X in _Rings` is already an improvement.\n* Calling `C=X.category()` - that's relatively cheap.\n* Calling `C.is_subcategory(_Rings)`, which is cached. However, in the elliptic curves code, `C` takes around 1000 different values, thus, caching really doesn't help here.\n* is_subcategory involves constructing `C.all_super_categories()`. Again, 1000 times in the elliptic curves code. Note that this is because of #9138: Before, C would constantly be `CommutativeRings()`, but with #9138, it is `CommutativeAlgebras(F)` for different fields F.\n\nNote that all_super_categories *__alone__* already takes 2 seconds in the `%time L = EllipticCurve('960d1').prove_BSD()` example! That's a third of the total computation time! The `P in C` idiom is to blame for a part of it, and `Category.join` is to blame for the rest.\n\nIt is much faster to define and use a parent method `is_ring` in the category of rings. Moreover, the base class `sage.rings.ring.Ring` also has a method `is_ring`, which is even faster than a method inherited from the category. Here is an example:\n\n```\nsage: R = Rings()\nsage: MS = MatrixSpace(QQ,3)\nsage: %timeit MS in R\n625 loops, best of 3: 10.2 \u00b5s per loop\nsage: %timeit MS.is_ring() # inherited from the category\n625 loops, best of 3: 4.3 \u00b5s per loop\nsage: P.<x,y> = PolynomialRing(GF(127))\nsage: %timeit P.is_ring() # inherited from the base class\n625 loops, best of 3: 392 ns per loop\n```\n\nOn the long run, I would prefer to have fast containers (see #10667), so that one can do \n\n```python\nO = Rings().objects()\nfor P in {many different parents with different categories]:\n    if P in O:\n        ...\n```\nBut for now, I'd prefer a fast work-around.\n\n**__Summary__**\n\nThe four main causes for the regression from #9138 are:\n* `P in Rings()` is too slow (because it calls `is_subcategory`). #10667 will make it fast, on the long run, but for now it is easier and faster to add a parent method `is_ring` that returns True for rings.\n* `Category.join` also involves calling `is_subcategory` too often. Fortunately, in many cases, the categories to be joined are known up to the base ring. Thus, it is possible to write down `JoinCategory` directly.\n* `C.is_subcategory(C2)` is too slow, since `C.all_super_categories()` is too slow. I provide a faster (but equivalent) algorithm here.\n* `C.parent_class` is too slow. In my not-yet-posted patch, I make it a little faster by calling `dynamic_class_internal.f` directly, thus, completely avoiding the `cached_function` overhead. `C.parent_class` should only depend on the base ring when absolutely necessary, but that will be dealt with on a different ticket.",
    "created_at": "2011-10-11T10:53:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168696",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:53'></a>
Hi Nicolas,

Replying to [nthiery](#comment%3A52):
> Replying to [SimonKing](#comment%3A50):
> > and also it is faster to do `base_ring.is_ring()` if `is_ring` is a parent method.

> 
> I thought that you had optimized the `in` containment to make it as
> fast as a method call?


That's #10667 and needs much more work than this. My aim *here* is to try and find a sufficiently good solution, so that #9138 can be rescued.

It could very well be that some of the changes (e.g. the use of `is_ring`) will be reverted by #10667, and replaced with a better solution. But I simply wouldn't like to wait another couple of months for #10667 to be finished - it would be a shame to postpone #9138 (which happens to be a dependency for #10667) such a long time.

>  - X in Fields() would return whether X is already known to be a field. 
 
>
>  - X.is_field() would return whether X *is* a field, possibly
>    launching a costly computation if needed, and possibly updating the
>    category afterward


You are mistaken. Please look at the `__contains__` method of `Fields()`. It dispatches to `sage.rings.fields.is_Field`, which dispatches to `P.is_field()`.

Besides, in cases where this is a problem, there is a `proof=False` option for is_field. I would accept to argue that `P in Fields()` should be preserved, because of the difficulty of testing field-ness, and because it is not tested so often.

But `P in Rings()` is tested often and is too slow. X in Rings()` takes an awful lot of time and is one of the four main causes for the regression. Bear in mind what `X in Rings()` involves:
* Calling `Rings()`, which will be faster by #11115 (cached methods), but currently is not cheap. Thus, defining `_Rings = Rings()` once in a module and then testing `X in _Rings` is already an improvement.
* Calling `C=X.category()` - that's relatively cheap.
* Calling `C.is_subcategory(_Rings)`, which is cached. However, in the elliptic curves code, `C` takes around 1000 different values, thus, caching really doesn't help here.
* is_subcategory involves constructing `C.all_super_categories()`. Again, 1000 times in the elliptic curves code. Note that this is because of #9138: Before, C would constantly be `CommutativeRings()`, but with #9138, it is `CommutativeAlgebras(F)` for different fields F.

Note that all_super_categories *__alone__* already takes 2 seconds in the `%time L = EllipticCurve('960d1').prove_BSD()` example! That's a third of the total computation time! The `P in C` idiom is to blame for a part of it, and `Category.join` is to blame for the rest.

It is much faster to define and use a parent method `is_ring` in the category of rings. Moreover, the base class `sage.rings.ring.Ring` also has a method `is_ring`, which is even faster than a method inherited from the category. Here is an example:

```
sage: R = Rings()
sage: MS = MatrixSpace(QQ,3)
sage: %timeit MS in R
625 loops, best of 3: 10.2 µs per loop
sage: %timeit MS.is_ring() # inherited from the category
625 loops, best of 3: 4.3 µs per loop
sage: P.<x,y> = PolynomialRing(GF(127))
sage: %timeit P.is_ring() # inherited from the base class
625 loops, best of 3: 392 ns per loop
```

On the long run, I would prefer to have fast containers (see #10667), so that one can do 

```python
O = Rings().objects()
for P in {many different parents with different categories]:
    if P in O:
        ...
```
But for now, I'd prefer a fast work-around.

**__Summary__**

The four main causes for the regression from #9138 are:
* `P in Rings()` is too slow (because it calls `is_subcategory`). #10667 will make it fast, on the long run, but for now it is easier and faster to add a parent method `is_ring` that returns True for rings.
* `Category.join` also involves calling `is_subcategory` too often. Fortunately, in many cases, the categories to be joined are known up to the base ring. Thus, it is possible to write down `JoinCategory` directly.
* `C.is_subcategory(C2)` is too slow, since `C.all_super_categories()` is too slow. I provide a faster (but equivalent) algorithm here.
* `C.parent_class` is too slow. In my not-yet-posted patch, I make it a little faster by calling `dynamic_class_internal.f` directly, thus, completely avoiding the `cached_function` overhead. `C.parent_class` should only depend on the base ring when absolutely necessary, but that will be dealt with on a different ticket.



---

archive/issue_comments_168697.json:
```json
{
    "body": "<a id='comment:54'></a>\nReplying to [SimonKing](#comment%3A53):\n> > I thought that you had optimized the `in` containment to make it as\n> > fast as a method call?\n\n> \n> That's #10667 and needs much more work than this. My aim *here* is to try and find a sufficiently good solution, so that #9138 can be rescued.\n> \n> It could very well be that some of the changes (e.g. the use of `is_ring`) will be reverted by #10667, and replaced with a better solution. But I simply wouldn't like to wait another couple of months for #10667 to be finished - it would be a shame to postpone #9138 (which happens to be a dependency for #10667) such a long time.\n\n\nOk, yes, I am perfectly fine with using is_ring as a temporary measure\nin critical and documented spots.\n\nIn general, +1 on getting #11900 in quickly even if it is not perfect,\nand thanks for all your work on that!\n\nFor the long run, I still would strongly argue for aiming at the \"X in\nFields()\" idiom, if it can be made fast enough. It is more conceptual\nand versatile. But let's not waste time on that now, and postpone the\ndiscussion to your visit in Orsay.\n\n> >  - X in Fields() would return whether X is already known to be a field. \n \n> >\n> >  - X.is_field() would return whether X *is* a field, possibly\n> >    launching a costly computation if needed, and possibly updating the\n> >    category afterward\n \n> \n> You are mistaken. Please look at the `__contains__` method of `Fields()`. It dispatches to `sage.rings.fields.is_Field`, which dispatches to `P.is_field()`.\n\n\nI know: I wrote this backward compatibility hack :-)\n\nWhat I described was the would-be clean plan for the future.\n\nCheers,\n                        Nicolas",
    "created_at": "2011-10-11T11:17:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168697",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:54'></a>
Replying to [SimonKing](#comment%3A53):
> > I thought that you had optimized the `in` containment to make it as
> > fast as a method call?

> 
> That's #10667 and needs much more work than this. My aim *here* is to try and find a sufficiently good solution, so that #9138 can be rescued.
> 
> It could very well be that some of the changes (e.g. the use of `is_ring`) will be reverted by #10667, and replaced with a better solution. But I simply wouldn't like to wait another couple of months for #10667 to be finished - it would be a shame to postpone #9138 (which happens to be a dependency for #10667) such a long time.


Ok, yes, I am perfectly fine with using is_ring as a temporary measure
in critical and documented spots.

In general, +1 on getting #11900 in quickly even if it is not perfect,
and thanks for all your work on that!

For the long run, I still would strongly argue for aiming at the "X in
Fields()" idiom, if it can be made fast enough. It is more conceptual
and versatile. But let's not waste time on that now, and postpone the
discussion to your visit in Orsay.

> >  - X in Fields() would return whether X is already known to be a field. 
 
> >
> >  - X.is_field() would return whether X *is* a field, possibly
> >    launching a costly computation if needed, and possibly updating the
> >    category afterward
 
> 
> You are mistaken. Please look at the `__contains__` method of `Fields()`. It dispatches to `sage.rings.fields.is_Field`, which dispatches to `P.is_field()`.


I know: I wrote this backward compatibility hack :-)

What I described was the would-be clean plan for the future.

Cheers,
                        Nicolas



---

archive/issue_comments_168698.json:
```json
{
    "body": "<a id='comment:55'></a>\nNot good. I got numerous doctest errors.\n\nWhile it seems that postponing coercion from the base ring was good idea for matrix spaces (see first patch), it seems that the new coercion model for libsingular rings has no effect on the performance. So, I tend to leave that for a different ticket and try to simplify my patches.",
    "created_at": "2011-10-11T13:27:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168698",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:55'></a>
Not good. I got numerous doctest errors.

While it seems that postponing coercion from the base ring was good idea for matrix spaces (see first patch), it seems that the new coercion model for libsingular rings has no effect on the performance. So, I tend to leave that for a different ticket and try to simplify my patches.



---

archive/issue_comments_168699.json:
```json
{
    "body": "<a id='comment:56'></a>\nOne question: Would you agree that a category with a base ring (such that modules over the integers, having the integers as base ring) can never be a super-category of a category without a base (such as the category of commutative rings)?\n\nIf your answer is \"yes\" then one can get an \"early abort\" (hence, a speed-up) in `is_subcategory`. It would require to add a `self.base()` method to tensor categories and Cartesian product categories, in both cases returning `self.base_category().base()`.",
    "created_at": "2011-10-11T14:03:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168699",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:56'></a>
One question: Would you agree that a category with a base ring (such that modules over the integers, having the integers as base ring) can never be a super-category of a category without a base (such as the category of commutative rings)?

If your answer is "yes" then one can get an "early abort" (hence, a speed-up) in `is_subcategory`. It would require to add a `self.base()` method to tensor categories and Cartesian product categories, in both cases returning `self.base_category().base()`.



---

archive/issue_comments_168700.json:
```json
{
    "body": "<a id='comment:57'></a>\nReplying to [SimonKing](#comment%3A56):\n> One question: Would you agree that a category with a base ring (such that modules over the integers, having the integers as base ring) can never be a super-category of a category without a base (such as the category of commutative rings)?\n\n\nRoughly speaking yes; in any cases, that's currently true AFAIK. However, we might want to someday model the fact that any ring is a ZZ-module (or maybe not).",
    "created_at": "2011-10-11T14:28:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168700",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:57'></a>
Replying to [SimonKing](#comment%3A56):
> One question: Would you agree that a category with a base ring (such that modules over the integers, having the integers as base ring) can never be a super-category of a category without a base (such as the category of commutative rings)?


Roughly speaking yes; in any cases, that's currently true AFAIK. However, we might want to someday model the fact that any ring is a ZZ-module (or maybe not).



---

archive/issue_comments_168701.json:
```json
{
    "body": "<a id='comment:58'></a>\nReplying to [nthiery](#comment%3A57):\n> Replying to [SimonKing](#comment%3A56):\n> Roughly speaking yes; in any cases, that's currently true AFAIK.\n\n\nNo it isn't. That's why I asked:\n\n```\nsage: M = ModulesWithBasis(QQ)\nsage: M.base()\nRational Field\nsage: P = M.CartesianProducts()\nsage: hasattr(P,'base')\nFalse\nsage: P.is_subcategory(M)\nTrue\n```\n\nThus, P has no base, but is a sub-category of a category with base.\n\n> However, we might want to someday model the fact that any ring is a ZZ-module (or maybe not).\n\n\nThat would probably just mean that the category of rings gets a base as well, namely ZZ.",
    "created_at": "2011-10-11T14:34:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168701",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:58'></a>
Replying to [nthiery](#comment%3A57):
> Replying to [SimonKing](#comment%3A56):
> Roughly speaking yes; in any cases, that's currently true AFAIK.


No it isn't. That's why I asked:

```
sage: M = ModulesWithBasis(QQ)
sage: M.base()
Rational Field
sage: P = M.CartesianProducts()
sage: hasattr(P,'base')
False
sage: P.is_subcategory(M)
True
```

Thus, P has no base, but is a sub-category of a category with base.

> However, we might want to someday model the fact that any ring is a ZZ-module (or maybe not).


That would probably just mean that the category of rings gets a base as well, namely ZZ.



---

archive/issue_comments_168702.json:
```json
{
    "body": "<a id='comment:59'></a>\nReplying to [SimonKing](#comment%3A58):\n> sage: M = ModulesWithBasis(QQ)\n> sage: M.base()\n> Rational Field\n> sage: P = M.CartesianProducts()\n> sage: hasattr(P,'base')\n> False\n\n\nAnd with my not-yet-submitted patch, `P.base()` would return QQ. It's the same with my patch for #10667, by the way.",
    "created_at": "2011-10-11T14:35:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168702",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:59'></a>
Replying to [SimonKing](#comment%3A58):
> sage: M = ModulesWithBasis(QQ)
> sage: M.base()
> Rational Field
> sage: P = M.CartesianProducts()
> sage: hasattr(P,'base')
> False


And with my not-yet-submitted patch, `P.base()` would return QQ. It's the same with my patch for #10667, by the way.



---

archive/issue_comments_168703.json:
```json
{
    "body": "<a id='comment:60'></a>\nHooray! When I reverted libsingular rings using the old coercion model and confined the changes to matrices and categories, I only get few doctest errors:\n\n```\nsage -t  devel/sage-main/sage/matrix/matrix2.pyx # 5 doctests failed\nsage -t  devel/sage-main/sage/rings/finite_rings/integer_mod_ring.py # 3 doctests failed\nsage -t  devel/sage-main/sage/rings/ring.pyx # 2 doctests failed\nsage -t  devel/sage-main/sage/rings/morphism.pyx # 4 doctests failed\nsage -t  devel/sage-main/sage/categories/cartesian_product.py # 1 doctests failed\nsage -t  devel/sage-main/sage/categories/modules_with_basis.py # 1 doctests failed\n```\nThat seems manageable.",
    "created_at": "2011-10-11T20:26:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168703",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:60'></a>
Hooray! When I reverted libsingular rings using the old coercion model and confined the changes to matrices and categories, I only get few doctest errors:

```
sage -t  devel/sage-main/sage/matrix/matrix2.pyx # 5 doctests failed
sage -t  devel/sage-main/sage/rings/finite_rings/integer_mod_ring.py # 3 doctests failed
sage -t  devel/sage-main/sage/rings/ring.pyx # 2 doctests failed
sage -t  devel/sage-main/sage/rings/morphism.pyx # 4 doctests failed
sage -t  devel/sage-main/sage/categories/cartesian_product.py # 1 doctests failed
sage -t  devel/sage-main/sage/categories/modules_with_basis.py # 1 doctests failed
```
That seems manageable.



---

archive/issue_comments_168704.json:
```json
{
    "body": "<a id='comment:61'></a>\nThe doctest failures will be sufficiently easy to fix.\n\nIt will hardly be possible to have #9138 without any regression: After all, the initialisation of a good category takes its time. Therefore, I am trying to improve various frequently used category operations (is_subcategory, all_super_categories, testing ring-ness and field-ness, parent class construction) so that in the end the regression is tolerable.\n\nIn addition, I am now trying to look at the concrete examples. I still see that in the `prove_BSD` example the same polynomial rings are constructed repeatedly. So far, I am mystified: Looking at the code, garbage collection of the polynomial ring should simply not happen.",
    "created_at": "2011-10-12T12:33:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168704",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:61'></a>
The doctest failures will be sufficiently easy to fix.

It will hardly be possible to have #9138 without any regression: After all, the initialisation of a good category takes its time. Therefore, I am trying to improve various frequently used category operations (is_subcategory, all_super_categories, testing ring-ness and field-ness, parent class construction) so that in the end the regression is tolerable.

In addition, I am now trying to look at the concrete examples. I still see that in the `prove_BSD` example the same polynomial rings are constructed repeatedly. So far, I am mystified: Looking at the code, garbage collection of the polynomial ring should simply not happen.



---

archive/issue_comments_168705.json:
```json
{
    "body": "<a id='comment:62'></a>\nOops, I was mistaken: I thought that every univariate polynomial ring was constructed twice. But in fact, it is only *stored in cache* twice, namely under different keys (see sage.rings.polynomial.polynomial_ring_constructor._single_variate). So, there is no starting point for an improvement here.",
    "created_at": "2011-10-12T12:57:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168705",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:62'></a>
Oops, I was mistaken: I thought that every univariate polynomial ring was constructed twice. But in fact, it is only *stored in cache* twice, namely under different keys (see sage.rings.polynomial.polynomial_ring_constructor._single_variate). So, there is no starting point for an improvement here.



---

archive/issue_comments_168706.json:
```json
{
    "body": "Attachment [trac11900_no_categories_for_matrices.patch](tarball://root/attachments/some-uuid/ticket11900/trac11900_no_categories_for_matrices.patch) by @simon-king-jena created at 2011-10-12 15:34:38\n\nPostpone category initialisation for matrix spaces",
    "created_at": "2011-10-12T15:34:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168706",
    "user": "https://github.com/simon-king-jena"
}
```

Attachment [trac11900_no_categories_for_matrices.patch](tarball://root/attachments/some-uuid/ticket11900/trac11900_no_categories_for_matrices.patch) by @simon-king-jena created at 2011-10-12 15:34:38

Postpone category initialisation for matrix spaces



---

archive/issue_comments_168707.json:
```json
{
    "body": "Attachment [trac11900_category_speedup.patch](tarball://root/attachments/some-uuid/ticket11900/trac11900_category_speedup.patch) by @simon-king-jena created at 2011-10-12 15:35:27\n\nImprove performance of various category operations. Introduce base() to more categories.",
    "created_at": "2011-10-12T15:35:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168707",
    "user": "https://github.com/simon-king-jena"
}
```

Attachment [trac11900_category_speedup.patch](tarball://root/attachments/some-uuid/ticket11900/trac11900_category_speedup.patch) by @simon-king-jena created at 2011-10-12 15:35:27

Improve performance of various category operations. Introduce base() to more categories.



---

archive/issue_comments_168708.json:
```json
{
    "body": "**Changing work_issues** from \"fix doctests\" to \"\".",
    "created_at": "2011-10-12T15:42:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168708",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing work_issues** from "fix doctests" to "".



---

archive/issue_comments_168709.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2011-10-12T15:42:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168709",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_168710.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -28,3 +28,9 @@\n Wall time: 7.40 s\n ```\n However, that's still far from good. After caching join and hom_category, there is still too much time spent (according to %prun) for the initialisation of matrix spaces.\n+\n+\n+Apply:\n+\n+* [attachment:trac11900_no_categories_for_matrices.patch]\n+* [attachment:trac11900_category_speedup.patch]\n``````\n",
    "created_at": "2011-10-12T15:42:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168710",
    "user": "https://github.com/simon-king-jena"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -28,3 +28,9 @@
 Wall time: 7.40 s
 ```
 However, that's still far from good. After caching join and hom_category, there is still too much time spent (according to %prun) for the initialisation of matrix spaces.
+
+
+Apply:
+
+* [attachment:trac11900_no_categories_for_matrices.patch]
+* [attachment:trac11900_category_speedup.patch]
``````




---

archive/issue_comments_168711.json:
```json
{
    "body": "<a id='comment:63'></a>\nI think \"new coercion model for libsingular\" does not really fit to this ticket. Hence, I am not doing it in my new patch anymore.\n\nIt fixes many slownesses of the category framework that became unbearable with #9138. I am convinced that further tweaks are possible. For example, base ring independence of parent and element classes would have a significant impact on efficiency. But again, I believe that that should be on a different ticket.\n\nAll doc tests pass and thus it is \"needs review\". I'm now trying to collect some evidence supporting my patches.\n\nApply trac11900_no_categories_for_matrices.patch trac11900_category_speedup.patch",
    "created_at": "2011-10-12T15:42:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168711",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:63'></a>
I think "new coercion model for libsingular" does not really fit to this ticket. Hence, I am not doing it in my new patch anymore.

It fixes many slownesses of the category framework that became unbearable with #9138. I am convinced that further tweaks are possible. For example, base ring independence of parent and element classes would have a significant impact on efficiency. But again, I believe that that should be on a different ticket.

All doc tests pass and thus it is "needs review". I'm now trying to collect some evidence supporting my patches.

Apply trac11900_no_categories_for_matrices.patch trac11900_category_speedup.patch



---

archive/issue_comments_168712.json:
```json
{
    "body": "<a id='comment:64'></a>\nHere are some timings. I compare \n (1) sage-4.7.2.alpha2, \n (2) sage-4.7.2.alpha3-prerelease and\n (3) sage-4.7.2.alpha3 with the patches from here.\n\nI am restarting before each new test, so that caches created in one test won't influence the other tests.\n\n__Creation of matrix spaces__\n\n(1)\n\n```\nsage: def test():\n....:     for i in xrange(5000):\n....:         MS = MatrixSpace(QQ,i)\n....:         \nsage: %time test()\nCPU times: user 0.38 s, sys: 0.00 s, total: 0.38 s\nWall time: 0.38 s\n```\n\n(2) The coercion from the base ring is initialised during matrix space initialisation. That involves a lot of category computations and is slow:\n\n```\nsage: def test():\n....:     for i in xrange(5000):\n....:         MS = MatrixSpace(QQ,i)\n....:         \nsage: %time test()\nCPU times: user 1.85 s, sys: 0.03 s, total: 1.88 s\nWall time: 1.88 s\n```\n\n(3) Since matrix spaces are often considered mere containers, not rings or modules, the first patch does no initialisation of the category during initialisation of the matrix space. There is a method that can do the full category initialisation *after* matrix space initialisation.\n\n```\nsage: def test():\n....:     for i in xrange(5000):\n....:         MS = MatrixSpace(QQ,i)\n....:         \nsage: %time test()\nCPU times: user 0.26 s, sys: 0.00 s, total: 0.27 s\nWall time: 0.27 s\n```\n\n__Creation of finite fields__\n\n(1)\n\n```\nsage: def test():\n....:     for p in prime_range(10000):\n....:         P = GF(p)\n....:         \nsage: %time test()\nCPU times: user 0.60 s, sys: 0.00 s, total: 0.60 s\nWall time: 0.61 s\n```\n\n(2) It is slower by a factor of more than 10. %prun reveals that most time is spent in `Category.join`.\n\n```\nsage: def test():\n....:     for p in prime_range(10000):\n....:         P = GF(p)\n....:         \nsage: %time test()\nCPU times: user 6.59 s, sys: 0.00 s, total: 6.60 s\nWall time: 6.62 s\n```\n\n(3) The drastic slow-down observed in (2) has not totally vanished, but I hope this is good enough for now:\n\n```\nsage: def test():\n....:     for p in prime_range(10000):\n....:         P = GF(p)\n....:         \nsage: %time test()\nCPU times: user 0.82 s, sys: 0.01 s, total: 0.83 s\nWall time: 0.83 s\n```\n\n__Creation of polynomial rings__\n\n(1)\n\n```\nsage: def test():\n....:     for p in prime_range(10000):\n....:         P = GF(p)['x']\n....:         P = GF(p)['x','y']\n....:         \nsage: %time test()\nCPU times: user 2.41 s, sys: 0.05 s, total: 2.46 s\nWall time: 2.53 s\n```\n\n(2) Since I am creating polynomial rings over finite fields, part of the overhead comes from what we have seen in the previous example. However, there must be an additional slowness, since the creation of finite fields apparently only contributes 6 seconds.\n\n```\nsage: def test():\n....:     for p in prime_range(10000):\n....:         P = GF(p)['x']\n....:         P = GF(p)['x','y']\n....:         \nsage: %time test()\nCPU times: user 13.15 s, sys: 0.05 s, total: 13.20 s\nWall time: 13.27 s\n```\n\n(3) Here, it seems that additional improvements are needed: It is still much slower than without #9138.\n\n```\nsage: def test():\n....:     for p in prime_range(10000):\n....:         P = GF(p)['x']\n....:         P = GF(p)['x','y']\n....:         \nsage: %time test()\nCPU times: user 6.54 s, sys: 0.08 s, total: 6.62 s\nWall time: 6.68 s\n```\n\n__is_subcategory using base__\n\n(1) and (2)\n\n```\nsage: L = [CommutativeAlgebras(GF(p)) for p in prime_range(10000)]\nsage: A = Algebras(GF(5))\nsage: %time _ = [B.is_subcategory(A) for B in L]\nCPU times: user 0.95 s, sys: 0.00 s, total: 0.96 s\nWall time: 0.96 s\n```\n\n(3) I think an early abort strategy taking into account the base rings of categories makes sense.\n\n```\nsage: L = [CommutativeAlgebras(GF(p)) for p in prime_range(10000)]\nsage: A = Algebras(GF(5))\nsage: %time _ = [B.is_subcategory(A) for B in L]\nCPU times: user 0.04 s, sys: 0.02 s, total: 0.06 s\nWall time: 0.06 s\n```\n\n**__The Elliptic Curve Tests__**\n\nRecall that only two of them remained critical: `L = EllipticCurve('960d1').prove_BSD()` and the `change_ring(...).abelian_group()` test.\n\n__prove_BSD()__\n(1)\n\n```\nsage: %time L = EllipticCurve('960d1').prove_BSD()\nCPU times: user 3.74 s, sys: 0.11 s, total: 3.85 s\nWall time: 5.05 s\n```\n\n(2) Given the timings above, this should be almost entirely due to finite field and polynomial ring creation.\n\n```\nsage: %time L = EllipticCurve('960d1').prove_BSD()\nCPU times: user 9.37 s, sys: 0.16 s, total: 9.53 s\nWall time: 10.89 s\n```\n\n(3) I am not totally happy, yet:\n\n```\nsage: %time L = EllipticCurve('960d1').prove_BSD()\nCPU times: user 5.63 s, sys: 0.10 s, total: 5.72 s\nWall time: 5.87 s\n```\n\n__abelian_group()__\n\n(1)\n\n```\nsage: def test():\n....:     E = EllipticCurve('389a')\n....:     for p in prime_range(10000):\n....:         if p != 389:\n....:             G = E.change_ring(GF(p)).abelian_group()\n....:             \nsage: %time test()\nCPU times: user 16.57 s, sys: 0.08 s, total: 16.65 s\nWall time: 16.77 s\n```\n\n(2)\n\n```\nsage: def test():\n....:     E = EllipticCurve('389a')\n....:     for p in prime_range(10000):\n....:         if p != 389:\n....:             G = E.change_ring(GF(p)).abelian_group()\n....:             \nsage: %time test()\nCPU times: user 26.87 s, sys: 0.10 s, total: 26.97 s\nWall time: 27.16 s\n```\n\n(3)\n\n```\nsage: def test():\n....:     E = EllipticCurve('389a')\n....:     for p in prime_range(10000):\n....:         if p != 389:\n....:             G = E.change_ring(GF(p)).abelian_group()\n....:             \nsage: %time test()\nCPU times: user 19.29 s, sys: 0.08 s, total: 19.37 s\nWall time: 19.54 s\n```\n\nI am not totally happy with the performance, yet. But I think it makes sense that someone has a look at the current snap shot of patches.",
    "created_at": "2011-10-12T17:04:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168712",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:64'></a>
Here are some timings. I compare 
 (1) sage-4.7.2.alpha2, 
 (2) sage-4.7.2.alpha3-prerelease and
 (3) sage-4.7.2.alpha3 with the patches from here.

I am restarting before each new test, so that caches created in one test won't influence the other tests.

__Creation of matrix spaces__

(1)

```
sage: def test():
....:     for i in xrange(5000):
....:         MS = MatrixSpace(QQ,i)
....:         
sage: %time test()
CPU times: user 0.38 s, sys: 0.00 s, total: 0.38 s
Wall time: 0.38 s
```

(2) The coercion from the base ring is initialised during matrix space initialisation. That involves a lot of category computations and is slow:

```
sage: def test():
....:     for i in xrange(5000):
....:         MS = MatrixSpace(QQ,i)
....:         
sage: %time test()
CPU times: user 1.85 s, sys: 0.03 s, total: 1.88 s
Wall time: 1.88 s
```

(3) Since matrix spaces are often considered mere containers, not rings or modules, the first patch does no initialisation of the category during initialisation of the matrix space. There is a method that can do the full category initialisation *after* matrix space initialisation.

```
sage: def test():
....:     for i in xrange(5000):
....:         MS = MatrixSpace(QQ,i)
....:         
sage: %time test()
CPU times: user 0.26 s, sys: 0.00 s, total: 0.27 s
Wall time: 0.27 s
```

__Creation of finite fields__

(1)

```
sage: def test():
....:     for p in prime_range(10000):
....:         P = GF(p)
....:         
sage: %time test()
CPU times: user 0.60 s, sys: 0.00 s, total: 0.60 s
Wall time: 0.61 s
```

(2) It is slower by a factor of more than 10. %prun reveals that most time is spent in `Category.join`.

```
sage: def test():
....:     for p in prime_range(10000):
....:         P = GF(p)
....:         
sage: %time test()
CPU times: user 6.59 s, sys: 0.00 s, total: 6.60 s
Wall time: 6.62 s
```

(3) The drastic slow-down observed in (2) has not totally vanished, but I hope this is good enough for now:

```
sage: def test():
....:     for p in prime_range(10000):
....:         P = GF(p)
....:         
sage: %time test()
CPU times: user 0.82 s, sys: 0.01 s, total: 0.83 s
Wall time: 0.83 s
```

__Creation of polynomial rings__

(1)

```
sage: def test():
....:     for p in prime_range(10000):
....:         P = GF(p)['x']
....:         P = GF(p)['x','y']
....:         
sage: %time test()
CPU times: user 2.41 s, sys: 0.05 s, total: 2.46 s
Wall time: 2.53 s
```

(2) Since I am creating polynomial rings over finite fields, part of the overhead comes from what we have seen in the previous example. However, there must be an additional slowness, since the creation of finite fields apparently only contributes 6 seconds.

```
sage: def test():
....:     for p in prime_range(10000):
....:         P = GF(p)['x']
....:         P = GF(p)['x','y']
....:         
sage: %time test()
CPU times: user 13.15 s, sys: 0.05 s, total: 13.20 s
Wall time: 13.27 s
```

(3) Here, it seems that additional improvements are needed: It is still much slower than without #9138.

```
sage: def test():
....:     for p in prime_range(10000):
....:         P = GF(p)['x']
....:         P = GF(p)['x','y']
....:         
sage: %time test()
CPU times: user 6.54 s, sys: 0.08 s, total: 6.62 s
Wall time: 6.68 s
```

__is_subcategory using base__

(1) and (2)

```
sage: L = [CommutativeAlgebras(GF(p)) for p in prime_range(10000)]
sage: A = Algebras(GF(5))
sage: %time _ = [B.is_subcategory(A) for B in L]
CPU times: user 0.95 s, sys: 0.00 s, total: 0.96 s
Wall time: 0.96 s
```

(3) I think an early abort strategy taking into account the base rings of categories makes sense.

```
sage: L = [CommutativeAlgebras(GF(p)) for p in prime_range(10000)]
sage: A = Algebras(GF(5))
sage: %time _ = [B.is_subcategory(A) for B in L]
CPU times: user 0.04 s, sys: 0.02 s, total: 0.06 s
Wall time: 0.06 s
```

**__The Elliptic Curve Tests__**

Recall that only two of them remained critical: `L = EllipticCurve('960d1').prove_BSD()` and the `change_ring(...).abelian_group()` test.

__prove_BSD()__
(1)

```
sage: %time L = EllipticCurve('960d1').prove_BSD()
CPU times: user 3.74 s, sys: 0.11 s, total: 3.85 s
Wall time: 5.05 s
```

(2) Given the timings above, this should be almost entirely due to finite field and polynomial ring creation.

```
sage: %time L = EllipticCurve('960d1').prove_BSD()
CPU times: user 9.37 s, sys: 0.16 s, total: 9.53 s
Wall time: 10.89 s
```

(3) I am not totally happy, yet:

```
sage: %time L = EllipticCurve('960d1').prove_BSD()
CPU times: user 5.63 s, sys: 0.10 s, total: 5.72 s
Wall time: 5.87 s
```

__abelian_group()__

(1)

```
sage: def test():
....:     E = EllipticCurve('389a')
....:     for p in prime_range(10000):
....:         if p != 389:
....:             G = E.change_ring(GF(p)).abelian_group()
....:             
sage: %time test()
CPU times: user 16.57 s, sys: 0.08 s, total: 16.65 s
Wall time: 16.77 s
```

(2)

```
sage: def test():
....:     E = EllipticCurve('389a')
....:     for p in prime_range(10000):
....:         if p != 389:
....:             G = E.change_ring(GF(p)).abelian_group()
....:             
sage: %time test()
CPU times: user 26.87 s, sys: 0.10 s, total: 26.97 s
Wall time: 27.16 s
```

(3)

```
sage: def test():
....:     E = EllipticCurve('389a')
....:     for p in prime_range(10000):
....:         if p != 389:
....:             G = E.change_ring(GF(p)).abelian_group()
....:             
sage: %time test()
CPU times: user 19.29 s, sys: 0.08 s, total: 19.37 s
Wall time: 19.54 s
```

I am not totally happy with the performance, yet. But I think it makes sense that someone has a look at the current snap shot of patches.



---

archive/issue_comments_168713.json:
```json
{
    "body": "<a id='comment:65'></a>\nHere is `%prun test(L)` for the following test of univariate polynomial ring creation:\n\n```\nsage: L = [GF(p) for p in prime_range(10000)]\nsage: def test(L):\n....:     for K in L:\n....:         P = K['x']\n....:         \n```\n\n(1)\n\n```\n   ncalls  tottime  percall  cumtime  percall filename:lineno(function)\n     3686    0.215    0.000    0.412    0.000 homset.py:248(__init__)\n     1229    0.193    0.000    1.047    0.001 polynomial_ring.py:235(__init__)\n7372/3686    0.094    0.000    0.126    0.000 lazy_attribute.py:493(__get__)\n     3686    0.070    0.000    0.629    0.000 homset.py:40(Hom)\n     1229    0.054    0.000    0.054    0.000 {method '_unset_coercions_used' of 'sage.structure.parent.Parent' objects}\n    25803    0.040    0.000    0.113    0.000 {hasattr}\n    23346    0.039    0.000    0.039    0.000 {method 'fix_to_pos' of 'sage.misc.function_mangling.ArgumentFixer' objects}\n     1229    0.039    0.000    0.226    0.000 {method '_populate_coercion_lists_' of 'sage.structure.parent.Parent' objects}\n    14745    0.036    0.000    0.098    0.000 classcall_metaclass.py:131(__call__)\n     1228    0.035    0.000    0.314    0.000 finite_field_prime_modn.py:128(_coerce_map_from_)\n    17203    0.032    0.000    0.064    0.000 cachefunc.py:147(__call__)\n     1229    0.031    0.000    1.103    0.001 polynomial_ring.py:1954(__init__)\n     3687    0.025    0.000    0.030    0.000 polynomial_ring.py:673(__hash__)\n    17200    0.023    0.000    0.023    0.000 finite_field_prime_modn.py:223(order)\n     1229    0.020    0.000    1.169    0.001 polynomial_ring_constructor.py:443(_single_variate)\n6144/6143    0.018    0.000    0.038    0.000 cachefunc.py:505(__call__)\n     1229    0.014    0.000    0.016    0.000 {method 'is_prime' of 'sage.rings.integer.Integer' objects}\n     1229    0.013    0.000    1.065    0.001 polynomial_ring.py:1874(__init__)\n        1    0.013    0.013    1.201    1.201 <ipython console>:1(test)\n     6143    0.011    0.000    0.067    0.000 category.py:974(hom_category)\n     1229    0.011    0.000    0.153    0.000 {method '_Hom_' of 'sage.rings.finite_rings.finite_field_base.FiniteField' objects}\n     1229    0.011    0.000    1.189    0.001 polynomial_ring_constructor.py:48(PolynomialRing)\n     3688    0.010    0.000    0.041    0.000 {method 'has_key' of 'dict' objects}\n    14748    0.009    0.000    0.009    0.000 {isinstance}\n     1229    0.008    0.000    0.142    0.000 homset.py:29(__init__)\n     1229    0.007    0.000    0.009    0.000 polynomial_ring_constructor.py:427(_get_from_cache)\n     1229    0.007    0.000    0.009    0.000 {sage.structure.parent_gens.normalize_names}\n    14744    0.007    0.000    0.010    0.000 unique_representation.py:514(__hash__)\n     7372    0.007    0.000    0.007    0.000 {getattr}\n     1228    0.007    0.000    0.007    0.000 {sage.rings.finite_rings.integer_mod.IntegerMod}\n     2458    0.006    0.000    0.014    0.000 dynamic_class.py:122(dynamic_class)\n```\n\n(2) As you can see, an awful lot of the time is spent for creation of the parent classes and for is_subcategory() tests:\n\n```\n   ncalls  tottime  percall  cumtime  percall filename:lineno(function)\n    11055    0.877    0.000    0.879    0.000 dynamic_class.py:258(dynamic_class_internal)\n320769/3687    0.510    0.000    1.812    0.000 category.py:588(add_successors)\n9826/1229    0.421    0.000    1.457    0.001 category.py:628(parent_class)\n374826/34402    0.398    0.000    2.701    0.000 cachefunc.py:505(__call__)\n72485/61432    0.381    0.000    2.185    0.000 cachefunc.py:147(__call__)\n     9826    0.269    0.000    0.765    0.000 unique_representation.py:435(__classcall__)\n     3687    0.232    0.000    2.245    0.001 category.py:554(all_super_categories)\n   121627    0.219    0.000    0.219    0.000 {method 'fix_to_pos' of 'sage.misc.function_mangling.ArgumentFixer' objects}00    6.292    0.005 polynomial_ring.py:237(__init__)\n     6144    0.217    0.000    0.555    0.000 homset.py:287(__init__)\n22114/7373    0.179    0.000    1.670    0.000 lazy_attribute.py:493(__get__)\n58971/45462    0.164    0.000    1.228    0.000 classcall_metaclass.py:131(__call__)\n     9826    0.157    0.000    0.211    0.000 category.py:323(__init__)\n   486657    0.145    0.000    0.189    0.000 unique_representation.py:514(__hash__)\n     9832    0.114    0.000    2.485    0.000 category.py:679(is_subcategory)\n4916/2458    0.104    0.000    0.613    0.000 {method 'coerce_map_from' of 'sage.structure.parent.Parent' objects}7    0.000    0.208    0.000 {hasattr}\n    56514    0.081    0.000    0.081    0.000 finite_field_prime_modn.py:224(order)\n     6144    0.078    0.000    1.513    0.000 homset.py:39(Hom)\n     3687    0.068    0.000    2.231    0.001 category.py:868(join)\n     7369    0.060    0.000    0.350    0.000 category_types.py:262(__init__)\n     1229    0.058    0.000    0.058    0.000 {method '_unset_coercions_used' of 'sage.structure.parent.Parent' objects}.000    0.170    0.000 cachefunc.py:804(__get__)\n    79885    0.051    0.000    0.079    0.000 {method 'add' of 'set' objects}\n   396967    0.050    0.000    0.050    0.000 {method 'append' of 'list' objects}\n2458/1229    0.047    0.000    0.628    0.001 polynomial_ring.py:470(_coerce_map_from_)\n    14742    0.046    0.000    1.190    0.000 dynamic_class.py:122(dynamic_class)\n```\n\n(3) To my surprise, with my patches, the picture remains the same. I'll try to fix it.\n\n```\n   ncalls  tottime  percall  cumtime  percall filename:lineno(function)\n    11061    1.211    0.000    1.213    0.000 dynamic_class.py:258(dynamic_class_internal)\n67595/6145    0.660    0.000    2.958    0.000 category.py:702(is_subcategory)\n191717/34406    0.636    0.000    3.132    0.000 cachefunc.py:505(__call__)\n   172054    0.501    0.000    0.501    0.000 {method 'fix_to_pos' of 'sage.misc.function_mangling.ArgumentFixer' objects}/22121    0.251    0.000    4.792    0.000 cachefunc.py:147(__call__)\n     1229    0.233    0.000    5.394    0.004 polynomial_ring.py:246(__init__)\n146251/14748    0.163    0.000    2.788    0.000 category.py:757(<genexpr>)\n     9831    0.159    0.000    0.213    0.000 category.py:350(__init__)\n77426/7373    0.098    0.000    2.973    0.000 cachefunc.py:733(_instance_call)\n   130272    0.097    0.000    0.097    0.000 {getattr}\n   121667    0.096    0.000    0.514    0.000 cachefunc.py:559(get_key)\n36868/23350    0.095    0.000    0.810    0.000 classcall_metaclass.py:131(__call__)\n   167141    0.087    0.000    0.087    0.000 {isinstance}\n   226131    0.086    0.000    0.112    0.000 unique_representation.py:514(__hash__)\n9832/1229    0.069    0.000    1.315    0.001 category.py:651(parent_class)\n     3687    0.065    0.000    3.283    0.001 category.py:62(_join)\n     7373    0.059    0.000    0.332    0.000 category_types.py:262(__init__)\n76198/13519    0.055    0.000    2.885    0.000 {any}\n    18434    0.055    0.000    0.175    0.000 cachefunc.py:804(__get__)\n    35633    0.054    0.000    0.054    0.000 finite_field_prime_modn.py:224(order)\n12288/2457    0.051    0.000    1.361    0.001 lazy_attribute.py:493(__get__)\n     9831    0.046    0.000    0.509    0.000 unique_representation.py:435(__classcall__)\n    18434    0.038    0.000    0.080    0.000 cachefunc.py:457(__init__)\n     1228    0.037    0.000    0.202    0.000 finite_field_prime_modn.py:129(_coerce_map_from_)\n     1228    0.036    0.000    0.088    0.000 homset.py:287(__init__)\n    11061    0.036    0.000    1.384    0.000 dynamic_class.py:122(dynamic_class)\n```",
    "created_at": "2011-10-12T17:15:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168713",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:65'></a>
Here is `%prun test(L)` for the following test of univariate polynomial ring creation:

```
sage: L = [GF(p) for p in prime_range(10000)]
sage: def test(L):
....:     for K in L:
....:         P = K['x']
....:         
```

(1)

```
   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
     3686    0.215    0.000    0.412    0.000 homset.py:248(__init__)
     1229    0.193    0.000    1.047    0.001 polynomial_ring.py:235(__init__)
7372/3686    0.094    0.000    0.126    0.000 lazy_attribute.py:493(__get__)
     3686    0.070    0.000    0.629    0.000 homset.py:40(Hom)
     1229    0.054    0.000    0.054    0.000 {method '_unset_coercions_used' of 'sage.structure.parent.Parent' objects}
    25803    0.040    0.000    0.113    0.000 {hasattr}
    23346    0.039    0.000    0.039    0.000 {method 'fix_to_pos' of 'sage.misc.function_mangling.ArgumentFixer' objects}
     1229    0.039    0.000    0.226    0.000 {method '_populate_coercion_lists_' of 'sage.structure.parent.Parent' objects}
    14745    0.036    0.000    0.098    0.000 classcall_metaclass.py:131(__call__)
     1228    0.035    0.000    0.314    0.000 finite_field_prime_modn.py:128(_coerce_map_from_)
    17203    0.032    0.000    0.064    0.000 cachefunc.py:147(__call__)
     1229    0.031    0.000    1.103    0.001 polynomial_ring.py:1954(__init__)
     3687    0.025    0.000    0.030    0.000 polynomial_ring.py:673(__hash__)
    17200    0.023    0.000    0.023    0.000 finite_field_prime_modn.py:223(order)
     1229    0.020    0.000    1.169    0.001 polynomial_ring_constructor.py:443(_single_variate)
6144/6143    0.018    0.000    0.038    0.000 cachefunc.py:505(__call__)
     1229    0.014    0.000    0.016    0.000 {method 'is_prime' of 'sage.rings.integer.Integer' objects}
     1229    0.013    0.000    1.065    0.001 polynomial_ring.py:1874(__init__)
        1    0.013    0.013    1.201    1.201 <ipython console>:1(test)
     6143    0.011    0.000    0.067    0.000 category.py:974(hom_category)
     1229    0.011    0.000    0.153    0.000 {method '_Hom_' of 'sage.rings.finite_rings.finite_field_base.FiniteField' objects}
     1229    0.011    0.000    1.189    0.001 polynomial_ring_constructor.py:48(PolynomialRing)
     3688    0.010    0.000    0.041    0.000 {method 'has_key' of 'dict' objects}
    14748    0.009    0.000    0.009    0.000 {isinstance}
     1229    0.008    0.000    0.142    0.000 homset.py:29(__init__)
     1229    0.007    0.000    0.009    0.000 polynomial_ring_constructor.py:427(_get_from_cache)
     1229    0.007    0.000    0.009    0.000 {sage.structure.parent_gens.normalize_names}
    14744    0.007    0.000    0.010    0.000 unique_representation.py:514(__hash__)
     7372    0.007    0.000    0.007    0.000 {getattr}
     1228    0.007    0.000    0.007    0.000 {sage.rings.finite_rings.integer_mod.IntegerMod}
     2458    0.006    0.000    0.014    0.000 dynamic_class.py:122(dynamic_class)
```

(2) As you can see, an awful lot of the time is spent for creation of the parent classes and for is_subcategory() tests:

```
   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
    11055    0.877    0.000    0.879    0.000 dynamic_class.py:258(dynamic_class_internal)
320769/3687    0.510    0.000    1.812    0.000 category.py:588(add_successors)
9826/1229    0.421    0.000    1.457    0.001 category.py:628(parent_class)
374826/34402    0.398    0.000    2.701    0.000 cachefunc.py:505(__call__)
72485/61432    0.381    0.000    2.185    0.000 cachefunc.py:147(__call__)
     9826    0.269    0.000    0.765    0.000 unique_representation.py:435(__classcall__)
     3687    0.232    0.000    2.245    0.001 category.py:554(all_super_categories)
   121627    0.219    0.000    0.219    0.000 {method 'fix_to_pos' of 'sage.misc.function_mangling.ArgumentFixer' objects}00    6.292    0.005 polynomial_ring.py:237(__init__)
     6144    0.217    0.000    0.555    0.000 homset.py:287(__init__)
22114/7373    0.179    0.000    1.670    0.000 lazy_attribute.py:493(__get__)
58971/45462    0.164    0.000    1.228    0.000 classcall_metaclass.py:131(__call__)
     9826    0.157    0.000    0.211    0.000 category.py:323(__init__)
   486657    0.145    0.000    0.189    0.000 unique_representation.py:514(__hash__)
     9832    0.114    0.000    2.485    0.000 category.py:679(is_subcategory)
4916/2458    0.104    0.000    0.613    0.000 {method 'coerce_map_from' of 'sage.structure.parent.Parent' objects}7    0.000    0.208    0.000 {hasattr}
    56514    0.081    0.000    0.081    0.000 finite_field_prime_modn.py:224(order)
     6144    0.078    0.000    1.513    0.000 homset.py:39(Hom)
     3687    0.068    0.000    2.231    0.001 category.py:868(join)
     7369    0.060    0.000    0.350    0.000 category_types.py:262(__init__)
     1229    0.058    0.000    0.058    0.000 {method '_unset_coercions_used' of 'sage.structure.parent.Parent' objects}.000    0.170    0.000 cachefunc.py:804(__get__)
    79885    0.051    0.000    0.079    0.000 {method 'add' of 'set' objects}
   396967    0.050    0.000    0.050    0.000 {method 'append' of 'list' objects}
2458/1229    0.047    0.000    0.628    0.001 polynomial_ring.py:470(_coerce_map_from_)
    14742    0.046    0.000    1.190    0.000 dynamic_class.py:122(dynamic_class)
```

(3) To my surprise, with my patches, the picture remains the same. I'll try to fix it.

```
   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
    11061    1.211    0.000    1.213    0.000 dynamic_class.py:258(dynamic_class_internal)
67595/6145    0.660    0.000    2.958    0.000 category.py:702(is_subcategory)
191717/34406    0.636    0.000    3.132    0.000 cachefunc.py:505(__call__)
   172054    0.501    0.000    0.501    0.000 {method 'fix_to_pos' of 'sage.misc.function_mangling.ArgumentFixer' objects}/22121    0.251    0.000    4.792    0.000 cachefunc.py:147(__call__)
     1229    0.233    0.000    5.394    0.004 polynomial_ring.py:246(__init__)
146251/14748    0.163    0.000    2.788    0.000 category.py:757(<genexpr>)
     9831    0.159    0.000    0.213    0.000 category.py:350(__init__)
77426/7373    0.098    0.000    2.973    0.000 cachefunc.py:733(_instance_call)
   130272    0.097    0.000    0.097    0.000 {getattr}
   121667    0.096    0.000    0.514    0.000 cachefunc.py:559(get_key)
36868/23350    0.095    0.000    0.810    0.000 classcall_metaclass.py:131(__call__)
   167141    0.087    0.000    0.087    0.000 {isinstance}
   226131    0.086    0.000    0.112    0.000 unique_representation.py:514(__hash__)
9832/1229    0.069    0.000    1.315    0.001 category.py:651(parent_class)
     3687    0.065    0.000    3.283    0.001 category.py:62(_join)
     7373    0.059    0.000    0.332    0.000 category_types.py:262(__init__)
76198/13519    0.055    0.000    2.885    0.000 {any}
    18434    0.055    0.000    0.175    0.000 cachefunc.py:804(__get__)
    35633    0.054    0.000    0.054    0.000 finite_field_prime_modn.py:224(order)
12288/2457    0.051    0.000    1.361    0.001 lazy_attribute.py:493(__get__)
     9831    0.046    0.000    0.509    0.000 unique_representation.py:435(__classcall__)
    18434    0.038    0.000    0.080    0.000 cachefunc.py:457(__init__)
     1228    0.037    0.000    0.202    0.000 finite_field_prime_modn.py:129(_coerce_map_from_)
     1228    0.036    0.000    0.088    0.000 homset.py:287(__init__)
    11061    0.036    0.000    1.384    0.000 dynamic_class.py:122(dynamic_class)
```



---

archive/issue_comments_168714.json:
```json
{
    "body": "<a id='comment:66'></a>\nARRGH, I am so unbelievably stupid!! I forgot to apply my second patch! All the timings for (3) above were only with the first patch!!!\n\nOn the bright side, it shows that my first patch isn't bad at all.\n\nBut I think it still makes sense to add the second as well. Here are the timings with both patches.\n\n__Creation of finite fields__\n\n```\nsage: def test():\n....:     for p in prime_range(10000):\n....:         P = GF(p)\n....:         \nsage: %time test()\nCPU times: user 0.68 s, sys: 0.02 s, total: 0.70 s\nWall time: 0.71 s\n```\n\n__Creation of polynomial rings__\n\n```\nsage: def test():\n....:     for p in prime_range(10000):\n....:         P = GF(p)['x']\n....:         P = GF(p)['x','y']\n....:         \nsage: %time test()\nCPU times: user 4.32 s, sys: 0.07 s, total: 4.39 s\nWall time: 4.40 s\n```\n\n**__The Elliptic Curve Tests__**\n\n__prove_BSD()__\n\n```\nsage: %time L = EllipticCurve('960d1').prove_BSD()\nCPU times: user 4.20 s, sys: 0.07 s, total: 4.27 s\nWall time: 4.46 s\n```\n\n__abelian_group()__\n\n```\nsage: def test():\n....:     E = EllipticCurve('389a')\n....:     for p in prime_range(10000):\n....:         if p != 389:\n....:             G = E.change_ring(GF(p)).abelian_group()\n....:             \nsage: %time test()\nCPU times: user 18.02 s, sys: 0.09 s, total: 18.11 s\nWall time: 18.16 s\n```\n\nIn conclusion, the original problem has almost vanished.",
    "created_at": "2011-10-12T17:31:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168714",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:66'></a>
ARRGH, I am so unbelievably stupid!! I forgot to apply my second patch! All the timings for (3) above were only with the first patch!!!

On the bright side, it shows that my first patch isn't bad at all.

But I think it still makes sense to add the second as well. Here are the timings with both patches.

__Creation of finite fields__

```
sage: def test():
....:     for p in prime_range(10000):
....:         P = GF(p)
....:         
sage: %time test()
CPU times: user 0.68 s, sys: 0.02 s, total: 0.70 s
Wall time: 0.71 s
```

__Creation of polynomial rings__

```
sage: def test():
....:     for p in prime_range(10000):
....:         P = GF(p)['x']
....:         P = GF(p)['x','y']
....:         
sage: %time test()
CPU times: user 4.32 s, sys: 0.07 s, total: 4.39 s
Wall time: 4.40 s
```

**__The Elliptic Curve Tests__**

__prove_BSD()__

```
sage: %time L = EllipticCurve('960d1').prove_BSD()
CPU times: user 4.20 s, sys: 0.07 s, total: 4.27 s
Wall time: 4.46 s
```

__abelian_group()__

```
sage: def test():
....:     E = EllipticCurve('389a')
....:     for p in prime_range(10000):
....:         if p != 389:
....:             G = E.change_ring(GF(p)).abelian_group()
....:             
sage: %time test()
CPU times: user 18.02 s, sys: 0.09 s, total: 18.11 s
Wall time: 18.16 s
```

In conclusion, the original problem has almost vanished.



---

archive/issue_comments_168715.json:
```json
{
    "body": "<a id='comment:67'></a>\nNote that with both patches applied, the creation of multivariate polynomial rings is faster than the creation of univariate rings:\n\n```\nsage: L = [GF(p) for p in prime_range(10000)]\nsage: def test():\n....:     for p in prime_range(10000):\n....:         P = GF(p)['x']\n....:         \nsage: def test2():\n....:     for p in prime_range(10000):\n....:         P = GF(p)['x','y']\n....:         \nsage: %time test()\nCPU times: user 2.56 s, sys: 0.04 s, total: 2.60 s\nWall time: 2.61 s\nsage: %time test2()\nCPU times: user 1.22 s, sys: 0.02 s, total: 1.24 s\nWall time: 1.24 s\n```\n\nThe computation time with sage-4.6.2 has only been 1.25 s for test() and 0.67 s for test2(). I doubt that a regression in the polynomial ring creation can be avoided, when we really want category support for polynomial rings. However, I'll do my best to improve it.",
    "created_at": "2011-10-13T09:37:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168715",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:67'></a>
Note that with both patches applied, the creation of multivariate polynomial rings is faster than the creation of univariate rings:

```
sage: L = [GF(p) for p in prime_range(10000)]
sage: def test():
....:     for p in prime_range(10000):
....:         P = GF(p)['x']
....:         
sage: def test2():
....:     for p in prime_range(10000):
....:         P = GF(p)['x','y']
....:         
sage: %time test()
CPU times: user 2.56 s, sys: 0.04 s, total: 2.60 s
Wall time: 2.61 s
sage: %time test2()
CPU times: user 1.22 s, sys: 0.02 s, total: 1.24 s
Wall time: 1.24 s
```

The computation time with sage-4.6.2 has only been 1.25 s for test() and 0.67 s for test2(). I doubt that a regression in the polynomial ring creation can be avoided, when we really want category support for polynomial rings. However, I'll do my best to improve it.



---

archive/issue_comments_168716.json:
```json
{
    "body": "<a id='comment:68'></a>\nHere is another innocent-looking detail that could have some impact: When many categories are created, it is essential that they are quickly initialised. By default, their name is determined from the type name at initialisation time - and that is costly.\n\nThe name should only be computed when needed - that calls for a lazy attribute. If a name is given explicitly, the name can still be overridden.",
    "created_at": "2011-10-13T09:58:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168716",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:68'></a>
Here is another innocent-looking detail that could have some impact: When many categories are created, it is essential that they are quickly initialised. By default, their name is determined from the type name at initialisation time - and that is costly.

The name should only be computed when needed - that calls for a lazy attribute. If a name is given explicitly, the name can still be overridden.



---

archive/issue_comments_168717.json:
```json
{
    "body": "<a id='comment:69'></a>\nReplying to [SimonKing](#comment%3A68):\n> Here is another innocent-looking detail that could have some impact: When many categories are created, it is essential that they are quickly initialised. By default, their name is determined from the type name at initialisation time - and that is costly.\n> \n> The name should only be computed when needed - that calls for a lazy attribute. If a name is given explicitly, the name can still be overridden.\n\n\n+1",
    "created_at": "2011-10-13T12:58:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168717",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:69'></a>
Replying to [SimonKing](#comment%3A68):
> Here is another innocent-looking detail that could have some impact: When many categories are created, it is essential that they are quickly initialised. By default, their name is determined from the type name at initialisation time - and that is costly.
> 
> The name should only be computed when needed - that calls for a lazy attribute. If a name is given explicitly, the name can still be overridden.


+1



---

archive/issue_comments_168718.json:
```json
{
    "body": "<a id='comment:70'></a>\nHi Simon, thanks for all this work!  I will certainly do tests of these patches, to see whether they don't break anything and also timing tests.  However, I will not review the patches themselves, I am not at all familiar with coercion.",
    "created_at": "2011-10-15T13:09:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168718",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:70'></a>
Hi Simon, thanks for all this work!  I will certainly do tests of these patches, to see whether they don't break anything and also timing tests.  However, I will not review the patches themselves, I am not at all familiar with coercion.



---

archive/issue_comments_168719.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -34,3 +34,4 @@\n \n * [attachment:trac11900_no_categories_for_matrices.patch]\n * [attachment:trac11900_category_speedup.patch]\n+* [attachment:trac11900_further_tweaks.patch]\n``````\n",
    "created_at": "2011-10-15T13:47:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168719",
    "user": "https://github.com/simon-king-jena"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -34,3 +34,4 @@
 
 * [attachment:trac11900_no_categories_for_matrices.patch]
 * [attachment:trac11900_category_speedup.patch]
+* [attachment:trac11900_further_tweaks.patch]
``````




---

archive/issue_comments_168720.json:
```json
{
    "body": "<a id='comment:71'></a>\nReplying to [jdemeyer](#comment%3A70):\n> Hi Simon, thanks for all this work!  I will certainly do tests of these patches, to see whether they don't break anything and also timing tests. \n\n\nBefore you start: I just added another patch. The patch is not tested yet. It fixes some more doc string formatting, and it provides some smaller improvements. For example, it removes import statements from `__init__` methods. It also introduces a cached function that computes the category used for a homset - the same computation used to happen *repeatedly* during homset creation. Also, the string representation is now only computed when needed - not during initialisation.\n\nThe effect of these improvements is certainly not as evident as what is done in the first patch. Nevertheless, since elliptic curve computations involve the creation of thousands of polynomial rings over finite fields, it is noticeable.\n\nApply trac11900_no_categories_for_matrices.patch trac11900_category_speedup.patch trac11900_further_tweaks.patch",
    "created_at": "2011-10-15T13:47:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168720",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:71'></a>
Replying to [jdemeyer](#comment%3A70):
> Hi Simon, thanks for all this work!  I will certainly do tests of these patches, to see whether they don't break anything and also timing tests. 


Before you start: I just added another patch. The patch is not tested yet. It fixes some more doc string formatting, and it provides some smaller improvements. For example, it removes import statements from `__init__` methods. It also introduces a cached function that computes the category used for a homset - the same computation used to happen *repeatedly* during homset creation. Also, the string representation is now only computed when needed - not during initialisation.

The effect of these improvements is certainly not as evident as what is done in the first patch. Nevertheless, since elliptic curve computations involve the creation of thousands of polynomial rings over finite fields, it is noticeable.

Apply trac11900_no_categories_for_matrices.patch trac11900_category_speedup.patch trac11900_further_tweaks.patch



---

archive/issue_comments_168721.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2011-10-16T07:58:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168721",
    "user": "https://github.com/jdemeyer"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_168722.json:
```json
{
    "body": "<a id='comment:72'></a>\nIn a preliminary testing version of sage-4.7.3.alpha0, I get two doctest failures:\n\n```\nsage -t  \"devel/sage/sage/categories/finite_enumerated_sets.py\"\n**********************************************************************\nFile \"/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.3.alpha0/devel/sage/sage/categories/finite_enumerated_sets.py\", line 58:\n    sage: FiniteEnumeratedSets()(GF(3))\nException raised:\n    Traceback (most recent call last):\n      File \"/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.3.alpha0/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.3.alpha0/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.3.alpha0/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_3[2]>\", line 1, in <module>\n        FiniteEnumeratedSets()(GF(Integer(3)))###line 58:\n    sage: FiniteEnumeratedSets()(GF(3))\n      File \"/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.3.alpha0/local/lib/python/site-packages/sage/categories/category.py\", line 485, in\n__call__\n        return self._call_(x, *args, **opts)\n      File \"/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.3.alpha0/local/lib/python/site-packages/sage/categories/finite_enumerated_sets.py\",\n line 75, in _call_\n        return EnumeratedSets()._call_(X)\n      File \"/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.3.alpha0/local/lib/python/site-packages/sage/categories/enumerated_sets.py\", line 1\n27, in _call_\n        raise NotImplementedError\n    NotImplementedError\n**********************************************************************\n```\nand\n\n```\nsage -t  \"devel/sage/sage/rings/residue_field.pyx\"\n**********************************************************************\nFile \"/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.3.alpha0/devel/sage/sage/rings/residue_field.pyx\", line 422:\n    sage: F.category()\nExpected:\n    Category of finite fields\nGot:\n    Category of fields\n**********************************************************************\n```",
    "created_at": "2011-10-16T07:58:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168722",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:72'></a>
In a preliminary testing version of sage-4.7.3.alpha0, I get two doctest failures:

```
sage -t  "devel/sage/sage/categories/finite_enumerated_sets.py"
**********************************************************************
File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.3.alpha0/devel/sage/sage/categories/finite_enumerated_sets.py", line 58:
    sage: FiniteEnumeratedSets()(GF(3))
Exception raised:
    Traceback (most recent call last):
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.3.alpha0/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.3.alpha0/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.3.alpha0/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_3[2]>", line 1, in <module>
        FiniteEnumeratedSets()(GF(Integer(3)))###line 58:
    sage: FiniteEnumeratedSets()(GF(3))
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.3.alpha0/local/lib/python/site-packages/sage/categories/category.py", line 485, in
__call__
        return self._call_(x, *args, **opts)
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.3.alpha0/local/lib/python/site-packages/sage/categories/finite_enumerated_sets.py",
 line 75, in _call_
        return EnumeratedSets()._call_(X)
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.3.alpha0/local/lib/python/site-packages/sage/categories/enumerated_sets.py", line 1
27, in _call_
        raise NotImplementedError
    NotImplementedError
**********************************************************************
```
and

```
sage -t  "devel/sage/sage/rings/residue_field.pyx"
**********************************************************************
File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.3.alpha0/devel/sage/sage/rings/residue_field.pyx", line 422:
    sage: F.category()
Expected:
    Category of finite fields
Got:
    Category of fields
**********************************************************************
```



---

archive/issue_comments_168723.json:
```json
{
    "body": "<a id='comment:73'></a>\nReplying to [jdemeyer](#comment%3A72):\n>     sage: FiniteEnumeratedSets()(GF(3))\n\n> Exception raised:\n\nYep. As I said, the last patch wasn't tested, yet.",
    "created_at": "2011-10-16T08:06:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168723",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:73'></a>
Replying to [jdemeyer](#comment%3A72):
>     sage: FiniteEnumeratedSets()(GF(3))

> Exception raised:

Yep. As I said, the last patch wasn't tested, yet.



---

archive/issue_comments_168724.json:
```json
{
    "body": "<a id='comment:74'></a>\nActually, I believe that `FiniteEnumeratedSets()._call_(X)` is flawed anyway: It returns `return EnumeratedSets()._call_(X)`, thus, does not relate with finiteness. On the other hand, `EnumeratedSets()._call_` returns a finite enumerated set, or raises an error.\n\nThe problem actually comes from the fact that the last patch accidentally changed the category of `GF(3)` from `FiniteFields()` to `Fields()`. So, that's a bug.",
    "created_at": "2011-10-16T08:16:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168724",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:74'></a>
Actually, I believe that `FiniteEnumeratedSets()._call_(X)` is flawed anyway: It returns `return EnumeratedSets()._call_(X)`, thus, does not relate with finiteness. On the other hand, `EnumeratedSets()._call_` returns a finite enumerated set, or raises an error.

The problem actually comes from the fact that the last patch accidentally changed the category of `GF(3)` from `FiniteFields()` to `Fields()`. So, that's a bug.



---

archive/issue_comments_168725.json:
```json
{
    "body": "<a id='comment:75'></a>\nI wonder: What is the correct category for a finite field? Category of finite fields? Or Join of Category of subquotients of monoids and Category of quotients of semigroups and Category of finite fields? The latter would come out of the initialisation as a quotient ring, that is part of the initialisation of a finite field.",
    "created_at": "2011-10-16T08:33:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168725",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:75'></a>
I wonder: What is the correct category for a finite field? Category of finite fields? Or Join of Category of subquotients of monoids and Category of quotients of semigroups and Category of finite fields? The latter would come out of the initialisation as a quotient ring, that is part of the initialisation of a finite field.



---

archive/issue_comments_168726.json:
```json
{
    "body": "<a id='comment:76'></a>\nPS: I would argue as follows.\n\n* Currently, the category of a finite field is `FiniteFields()`, without quotient ring stuff. So, let's be conservative and keep it.\n* Currently, `FiniteField_prime_modn` is both initialised as a `FiniteField` and as a `QuotientRing`. With my patch, for saving time, it is just initialised as a `Parent` with the category of finite fields, and then as a quotient ring, which *overrides* that category. \n* That sounds like a vaste of time. Therefore, `QuotientRing.__init__` should only try to determine a \"category with quotient stuff in it\" when the category has not been initialised before.\n\nDoing so yields the following  timing (which is even a little better then pre-#9138):\n\n```\nsage: def test():\n....:     for p in prime_range(10000):\n....:         P = GF(p)\n....:\nsage: %time test()\nCPU times: user 0.49 s, sys: 0.01 s, total: 0.50 s\nWall time: 0.51 s\n```\n\nI'll update my patch in a few minutes.",
    "created_at": "2011-10-16T08:58:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168726",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:76'></a>
PS: I would argue as follows.

* Currently, the category of a finite field is `FiniteFields()`, without quotient ring stuff. So, let's be conservative and keep it.
* Currently, `FiniteField_prime_modn` is both initialised as a `FiniteField` and as a `QuotientRing`. With my patch, for saving time, it is just initialised as a `Parent` with the category of finite fields, and then as a quotient ring, which *overrides* that category. 
* That sounds like a vaste of time. Therefore, `QuotientRing.__init__` should only try to determine a "category with quotient stuff in it" when the category has not been initialised before.

Doing so yields the following  timing (which is even a little better then pre-#9138):

```
sage: def test():
....:     for p in prime_range(10000):
....:         P = GF(p)
....:
sage: %time test()
CPU times: user 0.49 s, sys: 0.01 s, total: 0.50 s
Wall time: 0.51 s
```

I'll update my patch in a few minutes.



---

archive/issue_comments_168727.json:
```json
{
    "body": "Attachment [trac11900_further_tweaks.patch](tarball://root/attachments/some-uuid/ticket11900/trac11900_further_tweaks.patch) by @simon-king-jena created at 2011-10-16 09:01:35\n\nSome further improvements of field/ring/homset creation",
    "created_at": "2011-10-16T09:01:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168727",
    "user": "https://github.com/simon-king-jena"
}
```

Attachment [trac11900_further_tweaks.patch](tarball://root/attachments/some-uuid/ticket11900/trac11900_further_tweaks.patch) by @simon-king-jena created at 2011-10-16 09:01:35

Some further improvements of field/ring/homset creation



---

archive/issue_comments_168728.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2011-10-16T09:03:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168728",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_168729.json:
```json
{
    "body": "<a id='comment:77'></a>\nI have updated the \"further tweaks\" patch. The two failing tests that Jeroen mentioned pass with the new patch version, and the timing for the creation of a finite field slightly improved.",
    "created_at": "2011-10-16T09:03:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168729",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:77'></a>
I have updated the "further tweaks" patch. The two failing tests that Jeroen mentioned pass with the new patch version, and the timing for the creation of a finite field slightly improved.



---

archive/issue_comments_168730.json:
```json
{
    "body": "<a id='comment:78'></a>\nA very pleasant result:\n\nI was running the doc tests in sage/schemes (which seem to be the most critical). With sage-4.7.2.alpha2 (hence, without #9138), I obtain:\n\n```\nAll tests passed!\nTotal time for all tests: 663.5 seconds\n```\nWith sage-4.7.2.alpha3 (hence, with #9138) and the patches from #11911 and here, I obtain\n\n```\nAll tests passed!\nTotal time for all tests: 597.0 seconds\n```\n\nIn other words: The regression from #9138 apparently turned into a speed-up!\n\nAt Jeroen: You mentioned that you would not review it, because you are not so familiar with coercion. However, my own impression is that coercion plays almost no role in my patches (note that \"new coercion for polynomial rings\" is *not* part of the patches - it will be moved to a different ticket).",
    "created_at": "2011-10-16T12:09:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168730",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:78'></a>
A very pleasant result:

I was running the doc tests in sage/schemes (which seem to be the most critical). With sage-4.7.2.alpha2 (hence, without #9138), I obtain:

```
All tests passed!
Total time for all tests: 663.5 seconds
```
With sage-4.7.2.alpha3 (hence, with #9138) and the patches from #11911 and here, I obtain

```
All tests passed!
Total time for all tests: 597.0 seconds
```

In other words: The regression from #9138 apparently turned into a speed-up!

At Jeroen: You mentioned that you would not review it, because you are not so familiar with coercion. However, my own impression is that coercion plays almost no role in my patches (note that "new coercion for polynomial rings" is *not* part of the patches - it will be moved to a different ticket).



---

archive/issue_comments_168731.json:
```json
{
    "body": "<a id='comment:79'></a>\nReplying to [SimonKing](#comment%3A78):\n> In other words: The regression from #9138 apparently turned into a speed-up!\n\nThat would be highly impressive it this is true!\n\nWe'll see about the reviewing.  As said, first I want to test that it works and do some timings myself.",
    "created_at": "2011-10-16T16:00:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168731",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:79'></a>
Replying to [SimonKing](#comment%3A78):
> In other words: The regression from #9138 apparently turned into a speed-up!

That would be highly impressive it this is true!

We'll see about the reviewing.  As said, first I want to test that it works and do some timings myself.



---

archive/issue_comments_168732.json:
```json
{
    "body": "<a id='comment:80'></a>\nReplying to [jdemeyer](#comment%3A79):\n> Replying to [SimonKing](#comment%3A78):\n> > In other words: The regression from #9138 apparently turned into a speed-up!\n\n> That would be highly impressive it this is true!\n\nI am impressed, but not really surprised! The category code (and related) had not been fine tuned, and Simon is getting ever more an expert at that :-)\n\n\n> We'll see about the reviewing.  As said, first I want to test that it works and do some timings myself.\n\n\nI should mention that I won't have time to do a detailed review. But I am following closely Simon's comments, and any lack of comment from me means I am +1 on his detailed proposed changes.",
    "created_at": "2011-10-16T20:15:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168732",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:80'></a>
Replying to [jdemeyer](#comment%3A79):
> Replying to [SimonKing](#comment%3A78):
> > In other words: The regression from #9138 apparently turned into a speed-up!

> That would be highly impressive it this is true!

I am impressed, but not really surprised! The category code (and related) had not been fine tuned, and Simon is getting ever more an expert at that :-)


> We'll see about the reviewing.  As said, first I want to test that it works and do some timings myself.


I should mention that I won't have time to do a detailed review. But I am following closely Simon's comments, and any lack of comment from me means I am +1 on his detailed proposed changes.



---

archive/issue_comments_168733.json:
```json
{
    "body": "<a id='comment:81'></a>\nReplying to [SimonKing](#comment%3A76):\n>  * Currently, the category of a finite field is `FiniteFields()`, without quotient ring stuff. So, let's be conservative and keep it.\n\n\n+1, in particular since the upcoming #10963 is touching quite some the Finite* categories, and I'd like to reduce risks of conflicts.\n\nCheers,\n                     Nicolas",
    "created_at": "2011-10-16T20:19:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168733",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:81'></a>
Replying to [SimonKing](#comment%3A76):
>  * Currently, the category of a finite field is `FiniteFields()`, without quotient ring stuff. So, let's be conservative and keep it.


+1, in particular since the upcoming #10963 is touching quite some the Finite* categories, and I'd like to reduce risks of conflicts.

Cheers,
                     Nicolas



---

archive/issue_comments_168734.json:
```json
{
    "body": "<a id='comment:82'></a>\nI repeated the `sage -t sage/schemes` test. The improvement is smaller than in the first run, but I still see an improvement:\n\n* 648.1 s with unpatched sage-4.7.2.alpha2\n* 664.9 s with unpatched sage-4.7.2.alpha3\n* 599.6 s with sage-4.7.2.alpha3 plus the patches.\n\nHowever, it has only been 583.3 s in unpatched sage-4.6.2. Has the number of tests in sage/schemes increased since 4.6.2?",
    "created_at": "2011-10-16T20:46:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168734",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:82'></a>
I repeated the `sage -t sage/schemes` test. The improvement is smaller than in the first run, but I still see an improvement:

* 648.1 s with unpatched sage-4.7.2.alpha2
* 664.9 s with unpatched sage-4.7.2.alpha3
* 599.6 s with sage-4.7.2.alpha3 plus the patches.

However, it has only been 583.3 s in unpatched sage-4.6.2. Has the number of tests in sage/schemes increased since 4.6.2?



---

archive/issue_comments_168735.json:
```json
{
    "body": "<a id='comment:83'></a>\nPasses `make ptestlong` on sage.math.washington.edu.",
    "created_at": "2011-10-17T06:55:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168735",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:83'></a>
Passes `make ptestlong` on sage.math.washington.edu.



---

archive/issue_comments_168736.json:
```json
{
    "body": "<a id='comment:84'></a>\nNew timings using the same test files as before.  Timings are best-out-of-3 wall times.  \"baseline\" is actually sage-4.7.2.alpha3 minus various patches (#11587, #9138).  \"sage-4.7.3.alpha0\" is a *preliminary* version of sage-4.7.3.alpha0, including the new PARI (#11130) and MPIR (#8664).\n\n```\n*** cyclomat.sage ***\nsage-4.7.2.alpha2:      6.4s\nbaseline:               5.7s\nbaseline+#9138+#11900:  5.7s\nsage-4.7.3.alpha0:      6.6s\n\n*** ellbsd.sage ***\nsage-4.7.2.alpha2:      6.8s\nbaseline:               5.9s\nbaseline+#9138+#11900:  7.7s\nsage-4.7.3.alpha0:      6.4s\n\n*** elltest1.sage ***\nsage-4.7.2.alpha2:     23.5s\nbaseline:              22.4s\nbaseline+#9138+#11900: 25.9s\nsage-4.7.3.alpha0:     23.4s\n\n*** elltest2.sage ***\nsage-4.7.2.alpha2:     18.5s\nbaseline:              18.0s\nbaseline+#9138+#11900: 16.5s\nsage-4.7.3.alpha0:     17.7s\n\n*** J0_46_disc.sage ***\nsage-4.7.2.alpha2:      8.3s\nbaseline:               7.7s\nbaseline+#9138+#11900:  8.0s\nsage-4.7.3.alpha0:      9.6s\n```\n\nThis is **some** slowdown noticable in some tests, but it's not clear whether it is real, as there is quite some variation of runtime with some of these tests.",
    "created_at": "2011-10-17T13:09:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168736",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:84'></a>
New timings using the same test files as before.  Timings are best-out-of-3 wall times.  "baseline" is actually sage-4.7.2.alpha3 minus various patches (#11587, #9138).  "sage-4.7.3.alpha0" is a *preliminary* version of sage-4.7.3.alpha0, including the new PARI (#11130) and MPIR (#8664).

```
*** cyclomat.sage ***
sage-4.7.2.alpha2:      6.4s
baseline:               5.7s
baseline+#9138+#11900:  5.7s
sage-4.7.3.alpha0:      6.6s

*** ellbsd.sage ***
sage-4.7.2.alpha2:      6.8s
baseline:               5.9s
baseline+#9138+#11900:  7.7s
sage-4.7.3.alpha0:      6.4s

*** elltest1.sage ***
sage-4.7.2.alpha2:     23.5s
baseline:              22.4s
baseline+#9138+#11900: 25.9s
sage-4.7.3.alpha0:     23.4s

*** elltest2.sage ***
sage-4.7.2.alpha2:     18.5s
baseline:              18.0s
baseline+#9138+#11900: 16.5s
sage-4.7.3.alpha0:     17.7s

*** J0_46_disc.sage ***
sage-4.7.2.alpha2:      8.3s
baseline:               7.7s
baseline+#9138+#11900:  8.0s
sage-4.7.3.alpha0:      9.6s
```

This is **some** slowdown noticable in some tests, but it's not clear whether it is real, as there is quite some variation of runtime with some of these tests.



---

archive/issue_comments_168737.json:
```json
{
    "body": "<a id='comment:85'></a>\nHi Jeroen,\n\nI understand your results that cyclomat.sage, elltest2.sage and J0_46_disc.sage are fine, while ellbsd.sage and elltest1.sage remain problematic. \n\nI did five runs for each of the problematic tests, with sage-4.7.2.alpha2 and sage-4.7.2.alpha3+patches.\n\n__ellbsd.sage__\n\n4.7.2.alpha2\n\n```\nking@mpc622:/mnt/local/king/SAGE/debug/sage-4.7.2.alpha2$ time ./sage ellbsd.sage\n\nreal    0m6.344s\nuser    0m5.180s\nsys     0m0.380s\nking@mpc622:/mnt/local/king/SAGE/debug/sage-4.7.2.alpha2$ time ./sage ellbsd.sage\n\nreal    0m5.331s\nuser    0m4.932s\nsys     0m0.308s\nking@mpc622:/mnt/local/king/SAGE/debug/sage-4.7.2.alpha2$ time ./sage ellbsd.sage\n\nreal    0m5.260s\nuser    0m4.812s\nsys     0m0.356s\nking@mpc622:/mnt/local/king/SAGE/debug/sage-4.7.2.alpha2$ time ./sage ellbsd.sage\n\nreal    0m5.270s\nuser    0m4.848s\nsys     0m0.336s\nking@mpc622:/mnt/local/king/SAGE/debug/sage-4.7.2.alpha2$ time ./sage ellbsd.sage\n\nreal    0m5.215s\nuser    0m4.836s\nsys     0m0.288s\n```\n\npatched 4.7.2.alpha3\n\n```\nking@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage ellbsd.sage\n\nreal    0m6.392s\nuser    0m5.756s\nsys     0m0.496s\nking@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage ellbsd.sage\n\nreal    0m5.928s\nuser    0m5.448s\nsys     0m0.384s\nking@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage ellbsd.sage\n\nreal    0m5.654s\nuser    0m5.236s\nsys     0m0.368s\nking@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage ellbsd.sage\n\nreal    0m5.576s\nuser    0m5.204s\nsys     0m0.340s\nking@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage ellbsd.sage\n\nreal    0m5.599s\nuser    0m5.156s\nsys     0m0.364s\n```\n\n\n__elltest1.sage__\n\n4.7.2.alpha2\n\n```\nking@mpc622:/mnt/local/king/SAGE/debug/sage-4.7.2.alpha2$ time ./sage elltest1.sage\n\nreal    0m19.189s\nuser    0m18.669s\nsys     0m0.352s\nking@mpc622:/mnt/local/king/SAGE/debug/sage-4.7.2.alpha2$ time ./sage elltest1.sage\n\nreal    0m18.909s\nuser    0m18.417s\nsys     0m0.380s\nking@mpc622:/mnt/local/king/SAGE/debug/sage-4.7.2.alpha2$ time ./sage elltest1.sage\n\nreal    0m19.463s\nuser    0m19.085s\nsys     0m0.260s\nking@mpc622:/mnt/local/king/SAGE/debug/sage-4.7.2.alpha2$ time ./sage elltest1.sage\n\nreal    0m19.607s\nuser    0m19.205s\nsys     0m0.276s\nking@mpc622:/mnt/local/king/SAGE/debug/sage-4.7.2.alpha2$ time ./sage elltest1.sage\n\nreal    0m18.897s\nuser    0m18.445s\nsys     0m0.328s\n```\n\n4.7.2.alpha3+patches\n\n```\nking@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage elltest1.sage\n\nreal    0m18.420s\nuser    0m17.989s\nsys     0m0.308s\nking@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage elltest1.sage\n\nreal    0m18.273s\nuser    0m17.833s\nsys     0m0.372s\nking@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage elltest1.sage\n\nreal    0m18.461s\nuser    0m17.997s\nsys     0m0.380s\nking@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage elltest1.sage\n\nreal    0m18.416s\nuser    0m18.005s\nsys     0m0.348s\nking@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage elltest1.sage\n\nreal    0m19.687s\nuser    0m18.997s\nsys     0m0.588s\n```\n\n**__Conclusion__**\n\nI see a rather small slow-down in the first test, when comparing sage-4.7.2.alpha2 with \"baseline+#9138+#11900\"; it is smaller than the regression that you observe. \n\nI can not confirm the slow-down that you observe in the second test: Here, I actually find a slight speed-up.\n\nMy setting is different, as I replace \"baseline+#9138+#11900\" with \"sage-4.7.2.alpha3+#11900\". Just to be on the safe side, here you see what I was working with:\n\n```\nking@mpc622:/mnt/local/king/SAGE/debug/sage-4.7.2.alpha2/devel/sage$ hg qtop\nKeine Patches angewendet\n```\nversus\n\n```\nking@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3/devel/sage$ hg qapplied\ntrac11911_libsingular_pickling.patch\ntrac11900_no_categories_for_matrices.patch\ntrac11900_category_speedup.patch\ntrac11900_further_tweaks.patch\n```",
    "created_at": "2011-10-17T19:59:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168737",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:85'></a>
Hi Jeroen,

I understand your results that cyclomat.sage, elltest2.sage and J0_46_disc.sage are fine, while ellbsd.sage and elltest1.sage remain problematic. 

I did five runs for each of the problematic tests, with sage-4.7.2.alpha2 and sage-4.7.2.alpha3+patches.

__ellbsd.sage__

4.7.2.alpha2

```
king@mpc622:/mnt/local/king/SAGE/debug/sage-4.7.2.alpha2$ time ./sage ellbsd.sage

real    0m6.344s
user    0m5.180s
sys     0m0.380s
king@mpc622:/mnt/local/king/SAGE/debug/sage-4.7.2.alpha2$ time ./sage ellbsd.sage

real    0m5.331s
user    0m4.932s
sys     0m0.308s
king@mpc622:/mnt/local/king/SAGE/debug/sage-4.7.2.alpha2$ time ./sage ellbsd.sage

real    0m5.260s
user    0m4.812s
sys     0m0.356s
king@mpc622:/mnt/local/king/SAGE/debug/sage-4.7.2.alpha2$ time ./sage ellbsd.sage

real    0m5.270s
user    0m4.848s
sys     0m0.336s
king@mpc622:/mnt/local/king/SAGE/debug/sage-4.7.2.alpha2$ time ./sage ellbsd.sage

real    0m5.215s
user    0m4.836s
sys     0m0.288s
```

patched 4.7.2.alpha3

```
king@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage ellbsd.sage

real    0m6.392s
user    0m5.756s
sys     0m0.496s
king@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage ellbsd.sage

real    0m5.928s
user    0m5.448s
sys     0m0.384s
king@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage ellbsd.sage

real    0m5.654s
user    0m5.236s
sys     0m0.368s
king@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage ellbsd.sage

real    0m5.576s
user    0m5.204s
sys     0m0.340s
king@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage ellbsd.sage

real    0m5.599s
user    0m5.156s
sys     0m0.364s
```


__elltest1.sage__

4.7.2.alpha2

```
king@mpc622:/mnt/local/king/SAGE/debug/sage-4.7.2.alpha2$ time ./sage elltest1.sage

real    0m19.189s
user    0m18.669s
sys     0m0.352s
king@mpc622:/mnt/local/king/SAGE/debug/sage-4.7.2.alpha2$ time ./sage elltest1.sage

real    0m18.909s
user    0m18.417s
sys     0m0.380s
king@mpc622:/mnt/local/king/SAGE/debug/sage-4.7.2.alpha2$ time ./sage elltest1.sage

real    0m19.463s
user    0m19.085s
sys     0m0.260s
king@mpc622:/mnt/local/king/SAGE/debug/sage-4.7.2.alpha2$ time ./sage elltest1.sage

real    0m19.607s
user    0m19.205s
sys     0m0.276s
king@mpc622:/mnt/local/king/SAGE/debug/sage-4.7.2.alpha2$ time ./sage elltest1.sage

real    0m18.897s
user    0m18.445s
sys     0m0.328s
```

4.7.2.alpha3+patches

```
king@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage elltest1.sage

real    0m18.420s
user    0m17.989s
sys     0m0.308s
king@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage elltest1.sage

real    0m18.273s
user    0m17.833s
sys     0m0.372s
king@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage elltest1.sage

real    0m18.461s
user    0m17.997s
sys     0m0.380s
king@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage elltest1.sage

real    0m18.416s
user    0m18.005s
sys     0m0.348s
king@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage elltest1.sage

real    0m19.687s
user    0m18.997s
sys     0m0.588s
```

**__Conclusion__**

I see a rather small slow-down in the first test, when comparing sage-4.7.2.alpha2 with "baseline+#9138+#11900"; it is smaller than the regression that you observe. 

I can not confirm the slow-down that you observe in the second test: Here, I actually find a slight speed-up.

My setting is different, as I replace "baseline+#9138+#11900" with "sage-4.7.2.alpha3+#11900". Just to be on the safe side, here you see what I was working with:

```
king@mpc622:/mnt/local/king/SAGE/debug/sage-4.7.2.alpha2/devel/sage$ hg qtop
Keine Patches angewendet
```
versus

```
king@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3/devel/sage$ hg qapplied
trac11911_libsingular_pickling.patch
trac11900_no_categories_for_matrices.patch
trac11900_category_speedup.patch
trac11900_further_tweaks.patch
```



---

archive/issue_comments_168738.json:
```json
{
    "body": "<a id='comment:86'></a>\nThis ticket is related with #11935. There, the time for creation of parent and element classes of categories over different base rings is avoided. With the patches from here and the second of the two patches from #11935 applied to sage-4.7.2.alpha3, I find:\n\n```\nking@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage ellbsd.sage \n\nreal\t0m4.873s\nuser\t0m4.408s\nsys\t0m0.364s\nking@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage ellbsd.sage \n\nreal\t0m4.957s\nuser\t0m4.528s\nsys\t0m0.388s\nking@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage ellbsd.sage \n\nreal\t0m4.620s\nuser\t0m4.288s\nsys\t0m0.280s\nking@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage ellbsd.sage \n\nreal\t0m4.615s\nuser\t0m4.256s\nsys\t0m0.308s\nking@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage ellbsd.sage \n\nreal\t0m4.721s\nuser\t0m4.344s\nsys\t0m0.344s\n```\nand\n\n```\nking@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage elltest1.sage \n\nreal\t0m16.435s\nuser\t0m16.025s\nsys\t0m0.292s\nking@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage elltest1.sage \n\nreal\t0m16.981s\nuser\t0m16.565s\nsys\t0m0.304s\nking@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage elltest1.sage \n\nreal\t0m16.626s\nuser\t0m16.173s\nsys\t0m0.396s\nking@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage elltest1.sage \n\nreal\t0m16.950s\nuser\t0m16.493s\nsys\t0m0.384s\nking@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage elltest1.sage \n\nreal\t0m16.946s\nuser\t0m16.461s\nsys\t0m0.412s\n```\n\nThe result with the first patch from #11935 (one has to pick one of the two patches) is similar. That shows how much speed up is still possible with a clever usage of categories. But the methods used there go beyond what I am doing here - that's why I opened a separate ticket.",
    "created_at": "2011-10-18T12:48:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168738",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:86'></a>
This ticket is related with #11935. There, the time for creation of parent and element classes of categories over different base rings is avoided. With the patches from here and the second of the two patches from #11935 applied to sage-4.7.2.alpha3, I find:

```
king@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage ellbsd.sage 

real	0m4.873s
user	0m4.408s
sys	0m0.364s
king@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage ellbsd.sage 

real	0m4.957s
user	0m4.528s
sys	0m0.388s
king@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage ellbsd.sage 

real	0m4.620s
user	0m4.288s
sys	0m0.280s
king@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage ellbsd.sage 

real	0m4.615s
user	0m4.256s
sys	0m0.308s
king@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage ellbsd.sage 

real	0m4.721s
user	0m4.344s
sys	0m0.344s
```
and

```
king@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage elltest1.sage 

real	0m16.435s
user	0m16.025s
sys	0m0.292s
king@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage elltest1.sage 

real	0m16.981s
user	0m16.565s
sys	0m0.304s
king@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage elltest1.sage 

real	0m16.626s
user	0m16.173s
sys	0m0.396s
king@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage elltest1.sage 

real	0m16.950s
user	0m16.493s
sys	0m0.384s
king@mpc622:/mnt/local/king/SAGE/rebase/sage-4.7.2.alpha3$ time ./sage elltest1.sage 

real	0m16.946s
user	0m16.461s
sys	0m0.412s
```

The result with the first patch from #11935 (one has to pick one of the two patches) is similar. That shows how much speed up is still possible with a clever usage of categories. But the methods used there go beyond what I am doing here - that's why I opened a separate ticket.



---

archive/issue_comments_168739.json:
```json
{
    "body": "<a id='comment:87'></a>\nWith the second patch of #11935 added, all the testcases above are indeed faster than sage-4.7.2.alpha3-baseline (without #9138).",
    "created_at": "2011-10-19T18:48:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168739",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:87'></a>
With the second patch of #11935 added, all the testcases above are indeed faster than sage-4.7.2.alpha3-baseline (without #9138).



---

archive/issue_comments_168740.json:
```json
{
    "body": "<a id='comment:88'></a>\nThe patch bot starts with sage-4.7.1 and is unable to apply certain patches. Bad luck. But they should apply cleanly against sage-4.7.2.alpha4.",
    "created_at": "2011-10-24T15:23:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168740",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:88'></a>
The patch bot starts with sage-4.7.1 and is unable to apply certain patches. Bad luck. But they should apply cleanly against sage-4.7.2.alpha4.



---

archive/issue_comments_168741.json:
```json
{
    "body": "<a id='comment:89'></a>\nFWIW: Here is an example that should show that the regression is fixed.\n\nI tested `./sage -t devel/sage/sage/schemes/`. I obtain the following total running times:\n\n* With sage-4.7.3.alpha0: 621.9 seconds\n* plus #9138:  665.2 seconds\n* plus #11900: 595.4 seconds        \n\n```\nsage: (621.9-595.4)/621.9\n0.0426113523074449\nsage: (621.9-665.2)/621.9\n-0.0696253416948063\n```\nSo, the 7% regression from #9138 has been turned into a 4% speed-up.",
    "created_at": "2011-10-29T13:06:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168741",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:89'></a>
FWIW: Here is an example that should show that the regression is fixed.

I tested `./sage -t devel/sage/sage/schemes/`. I obtain the following total running times:

* With sage-4.7.3.alpha0: 621.9 seconds
* plus #9138:  665.2 seconds
* plus #11900: 595.4 seconds        

```
sage: (621.9-595.4)/621.9
0.0426113523074449
sage: (621.9-665.2)/621.9
-0.0696253416948063
```
So, the 7% regression from #9138 has been turned into a 4% speed-up.



---

archive/issue_comments_168742.json:
```json
{
    "body": "<a id='comment:90'></a>\nI hope you can find a reviewer to look at the code, I sent a message to sage-devel.",
    "created_at": "2011-10-31T11:41:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168742",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:90'></a>
I hope you can find a reviewer to look at the code, I sent a message to sage-devel.



---

archive/issue_events_037128.json:
```json
{
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "label": "critical",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11900#event-37128"
}
```



---

archive/issue_comments_168743.json:
```json
{
    "body": "**Reviewer:** Jeroen Demeyer",
    "created_at": "2011-10-31T11:41:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168743",
    "user": "https://github.com/jdemeyer"
}
```

**Reviewer:** Jeroen Demeyer



---

archive/issue_comments_168744.json:
```json
{
    "body": "<a id='comment:91'></a>\nJeroen's message is:\n\n```\nSimon King has a big patch at #11900 to speed-up categories.  There were\nsome regressions at #9138, this patch fixes all of these and moreover,\neven speeds up some things.  This patch is quite important, there are\nvarious tickets depending on it.\n\nI have already checked that the patch works and that it fixes all\nobvious regressions from #9138. Somebody with some understanding of\ncategories really needs to look at the code and review it.\n```",
    "created_at": "2011-10-31T16:03:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168744",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:91'></a>
Jeroen's message is:

```
Simon King has a big patch at #11900 to speed-up categories.  There were
some regressions at #9138, this patch fixes all of these and moreover,
even speeds up some things.  This patch is quite important, there are
various tickets depending on it.

I have already checked that the patch works and that it fixes all
obvious regressions from #9138. Somebody with some understanding of
categories really needs to look at the code and review it.
```



---

archive/issue_comments_168745.json:
```json
{
    "body": "Milestone sage-4.7.3 deleted",
    "created_at": "2011-11-03T16:14:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168745",
    "user": "https://github.com/jdemeyer"
}
```

Milestone sage-4.7.3 deleted



---

archive/issue_events_037129.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2011-11-06T12:21:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "milestone": "sage-4.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11900#event-37129"
}
```



---

archive/issue_comments_168746.json:
```json
{
    "body": "<a id='comment:93'></a>\nThe purpose of this ticket is explicit: Speed. I must admit that the code by which I obtain speed is sometimes a bit messy, specifically in `is_subcategory`, where I introduce additional special cases in a method that should be fairly generic.\n\nThere is a follow-up ticket #11943 that is concerned with consistency of the category graph. Question: Is it ok to keep the messy code from here and leave cleaning of `is_subcategory` to #11943?",
    "created_at": "2011-11-06T12:21:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168746",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:93'></a>
The purpose of this ticket is explicit: Speed. I must admit that the code by which I obtain speed is sometimes a bit messy, specifically in `is_subcategory`, where I introduce additional special cases in a method that should be fairly generic.

There is a follow-up ticket #11943 that is concerned with consistency of the category graph. Question: Is it ok to keep the messy code from here and leave cleaning of `is_subcategory` to #11943?



---

archive/issue_comments_168747.json:
```json
{
    "body": "<a id='comment:94'></a>\nReplying to [SimonKing](#comment%3A93):\n> The purpose of this ticket is explicit: Speed. I must admit that the code by which I obtain speed is sometimes a bit messy, specifically in `is_subcategory`, where I introduce additional special cases in a method that should be fairly generic.\n> \n> There is a follow-up ticket #11943 that is concerned with consistency of the category graph. Question: Is it ok to keep the messy code from here and leave cleaning of `is_subcategory` to #11943?\n\n\nIf that makes your life easier, I say go for it. Anyway, it's likely\nthat the second patch will go in very soon after, if not in the same\nrelease.\n\nCheers,\n\t\t\t\t\tNicolas",
    "created_at": "2011-11-06T21:29:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168747",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:94'></a>
Replying to [SimonKing](#comment%3A93):
> The purpose of this ticket is explicit: Speed. I must admit that the code by which I obtain speed is sometimes a bit messy, specifically in `is_subcategory`, where I introduce additional special cases in a method that should be fairly generic.
> 
> There is a follow-up ticket #11943 that is concerned with consistency of the category graph. Question: Is it ok to keep the messy code from here and leave cleaning of `is_subcategory` to #11943?


If that makes your life easier, I say go for it. Anyway, it's likely
that the second patch will go in very soon after, if not in the same
release.

Cheers,
					Nicolas



---

archive/issue_comments_168748.json:
```json
{
    "body": "<a id='comment:95'></a>\nReplying to [nthiery](#comment%3A94):\n> > There is a follow-up ticket #11943 that is concerned with consistency of the category graph. Question: Is it ok to keep the messy code from here and leave cleaning of `is_subcategory` to #11943?\n\n> \n> If that makes your life easier, I say go for it.\n\n\nThank you! Yes, it would make life easier for me, because otherwise I'd need to take part of my changes from #11943, use it to change the patch from here, and then also update the patch from #11943.",
    "created_at": "2011-11-07T09:30:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168748",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:95'></a>
Replying to [nthiery](#comment%3A94):
> > There is a follow-up ticket #11943 that is concerned with consistency of the category graph. Question: Is it ok to keep the messy code from here and leave cleaning of `is_subcategory` to #11943?

> 
> If that makes your life easier, I say go for it.


Thank you! Yes, it would make life easier for me, because otherwise I'd need to take part of my changes from #11943, use it to change the patch from here, and then also update the patch from #11943.



---

archive/issue_comments_168749.json:
```json
{
    "body": "<a id='comment:96'></a>\nWe discussed this patch quite some with Simon. One of the issue that\ncame up is whether it was ok to replace the nice idiom `X in Fields()`\n(or friends) with `X.is_field()` when time is critical. I consider\nthat those two idioms have different semantic: `X in Fields()` means:\ndo we already know that `X` is a ring (that is, X.category() is a\nsubcategory of has Fields()), whereas X.is_field() may launch an\nexpensive computation to detect whether X is actually a field or not.\n\nThe change was motivated by the fact that, in may important cases, ``X.is_field()``\nis much faster than ``X in Fields()``:\n\n```\n    sage: R = QQ['x']\n    sage: %timeit R.is_field()\n    625 loops, best of 3: 442 ns per loop\n    sage: %timeit R in Fields()\n    625 loops, best of 3: 18 \u00b5s per loop\n```\n\nHowever, after experimenting together, we found out that the\ndifference can most likely be made not so significant.\nThe patch I just attached is a good step in that direction.\nSimon is currently experimenting with an implementation of\nCython methods within Python classes.\n\nHopefully, with that patch or some variant thereof, the changes ``X in\nFields()`` -> ``X.is_field()`` in trac11900_category_speedup.patch can\nbe reverted while still solving the original regression.\n\nCheers,\n                          Nicolas",
    "created_at": "2011-11-17T15:44:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168749",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:96'></a>
We discussed this patch quite some with Simon. One of the issue that
came up is whether it was ok to replace the nice idiom `X in Fields()`
(or friends) with `X.is_field()` when time is critical. I consider
that those two idioms have different semantic: `X in Fields()` means:
do we already know that `X` is a ring (that is, X.category() is a
subcategory of has Fields()), whereas X.is_field() may launch an
expensive computation to detect whether X is actually a field or not.

The change was motivated by the fact that, in may important cases, ``X.is_field()``
is much faster than ``X in Fields()``:

```
    sage: R = QQ['x']
    sage: %timeit R.is_field()
    625 loops, best of 3: 442 ns per loop
    sage: %timeit R in Fields()
    625 loops, best of 3: 18 µs per loop
```

However, after experimenting together, we found out that the
difference can most likely be made not so significant.
The patch I just attached is a good step in that direction.
Simon is currently experimenting with an implementation of
Cython methods within Python classes.

Hopefully, with that patch or some variant thereof, the changes ``X in
Fields()`` -> ``X.is_field()`` in trac11900_category_speedup.patch can
be reverted while still solving the original regression.

Cheers,
                          Nicolas



---

archive/issue_comments_168750.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2011-11-17T15:44:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168750",
    "user": "https://github.com/nthiery"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_168751.json:
```json
{
    "body": "<a id='comment:97'></a>\nReplying to [nthiery](#comment%3A96):\n> The change was motivated by the fact that, in may important cases, ``X.is_field()``\n> is much faster than ``X in Fields()``:\n> ...\n> Hopefully, with that patch or some variant thereof, the changes ``X in\n> Fields()`` -> ``X.is_field()`` in trac11900_category_speedup.patch can\n> be reverted while still solving the original regression.\n\n\nI hope so! I think that the following makes sense: We change here the `__contains__` method for `Rings()`, because that is what is needed most. The change shall be: Instead of creating the list of all super categories and then searching `Rings()` in that list, one should test whether the parent class of is a subclass of the parent class of `Rings()`. In particular, this can be put into Cython, where IIRC subclass checks are much faster than in Python.\n\nOn the long run, we could think of making subclass check of parent_class the default way of testing is_subcategory (this is one of the things we had discusses). Of course, when sharing parent classes (as in #11935), this has to be weakened.",
    "created_at": "2011-11-17T19:23:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168751",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:97'></a>
Replying to [nthiery](#comment%3A96):
> The change was motivated by the fact that, in may important cases, ``X.is_field()``
> is much faster than ``X in Fields()``:
> ...
> Hopefully, with that patch or some variant thereof, the changes ``X in
> Fields()`` -> ``X.is_field()`` in trac11900_category_speedup.patch can
> be reverted while still solving the original regression.


I hope so! I think that the following makes sense: We change here the `__contains__` method for `Rings()`, because that is what is needed most. The change shall be: Instead of creating the list of all super categories and then searching `Rings()` in that list, one should test whether the parent class of is a subclass of the parent class of `Rings()`. In particular, this can be put into Cython, where IIRC subclass checks are much faster than in Python.

On the long run, we could think of making subclass check of parent_class the default way of testing is_subcategory (this is one of the things we had discusses). Of course, when sharing parent classes (as in #11935), this has to be weakened.



---

archive/issue_comments_168752.json:
```json
{
    "body": "<a id='comment:98'></a>\nHi Nicolas, it seems that your \"singleton\" patch does not contain the pyx file.\n\nBy the way, since is_subcategory is used by `__contains__`, I would somehow prefer to not cythonise `__contains__` but cythonise `is_subcategory` instead.\n\nAnyway. Since the change concerns \"speedup for category framework\", the new stuff shall remain on *this* ticket. Do we agree on that?\n\nOf course, after cythonising is_subcategory, I need to change my patches from #11943 and #11935 as well. In particular #11935 will be tricky, because the idea of \"testing subcategories via subclasses of the parent class\" will not work if parent classes are shared. But that problem shall be dealt with there and not here.",
    "created_at": "2011-11-18T11:02:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168752",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:98'></a>
Hi Nicolas, it seems that your "singleton" patch does not contain the pyx file.

By the way, since is_subcategory is used by `__contains__`, I would somehow prefer to not cythonise `__contains__` but cythonise `is_subcategory` instead.

Anyway. Since the change concerns "speedup for category framework", the new stuff shall remain on *this* ticket. Do we agree on that?

Of course, after cythonising is_subcategory, I need to change my patches from #11943 and #11935 as well. In particular #11935 will be tricky, because the idea of "testing subcategories via subclasses of the parent class" will not work if parent classes are shared. But that problem shall be dealt with there and not here.



---

archive/issue_comments_168753.json:
```json
{
    "body": "An experimental implementation of optimized base class for singleton categories",
    "created_at": "2011-11-18T12:51:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168753",
    "user": "https://github.com/nthiery"
}
```

An experimental implementation of optimized base class for singleton categories



---

archive/issue_comments_168754.json:
```json
{
    "body": "<a id='comment:99'></a>\nAttachment [trac_11900-category_singleton-nt.patch](tarball://root/attachments/some-uuid/ticket11900/trac_11900-category_singleton-nt.patch) by @nthiery created at 2011-11-18 13:05:24\n\nReplying to [SimonKing](#comment%3A98):\n> Hi Nicolas, it seems that your \"singleton\" patch does not contain the pyx file.\n\n\nOops! Fixed!\n\n> By the way, since is_subcategory is used by `__contains__`, I would somehow prefer to not cythonise `__contains__` but cythonise `is_subcategory` instead.\n\n\nI see your point.\n\nHowever, one would need to use the subcategory_hook: in `x in\nRings()`, the is_subcategory that is called is that of the category of\nx, not of Rings(). So altogether it might be not as fast as when\ncythonizing __contains__. Also, since the optimized code for\n__contains__ is small, I can live with the tiny code duplication due\nto the \"manual inlining of is_subcategory\" in __contains__.\n\n> Anyway. Since the change concerns \"speedup for category framework\", the new stuff shall remain on *this* ticket. Do we agree on that?\n\n\nDefinitely.\n\n> Of course, after cythonising is_subcategory, I need to change my patches from #11943 and #11935 as well. In particular #11935 will be tricky, because the idea of \"testing subcategories via subclasses of the parent class\" will not work if parent classes are shared. But that problem shall be dealt with there and not here.\n\n\nAh, I see, you are thinking of cythonizing is_subcategories via\nparent_class for *all* categories. Hmm, I haven't yet made up my mind\nabout this. Unless it brings a clear general improvement (and not only\nfor the specific regression this patch is about), shalle we not postpone\nthat to later, and stick to a more local change (only about Rings and friends)?\n\nCheers,\n\t\t\tNicolas",
    "created_at": "2011-11-18T13:05:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168754",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:99'></a>
Attachment [trac_11900-category_singleton-nt.patch](tarball://root/attachments/some-uuid/ticket11900/trac_11900-category_singleton-nt.patch) by @nthiery created at 2011-11-18 13:05:24

Replying to [SimonKing](#comment%3A98):
> Hi Nicolas, it seems that your "singleton" patch does not contain the pyx file.


Oops! Fixed!

> By the way, since is_subcategory is used by `__contains__`, I would somehow prefer to not cythonise `__contains__` but cythonise `is_subcategory` instead.


I see your point.

However, one would need to use the subcategory_hook: in `x in
Rings()`, the is_subcategory that is called is that of the category of
x, not of Rings(). So altogether it might be not as fast as when
cythonizing __contains__. Also, since the optimized code for
__contains__ is small, I can live with the tiny code duplication due
to the "manual inlining of is_subcategory" in __contains__.

> Anyway. Since the change concerns "speedup for category framework", the new stuff shall remain on *this* ticket. Do we agree on that?


Definitely.

> Of course, after cythonising is_subcategory, I need to change my patches from #11943 and #11935 as well. In particular #11935 will be tricky, because the idea of "testing subcategories via subclasses of the parent class" will not work if parent classes are shared. But that problem shall be dealt with there and not here.


Ah, I see, you are thinking of cythonizing is_subcategories via
parent_class for *all* categories. Hmm, I haven't yet made up my mind
about this. Unless it brings a clear general improvement (and not only
for the specific regression this patch is about), shalle we not postpone
that to later, and stick to a more local change (only about Rings and friends)?

Cheers,
			Nicolas



---

archive/issue_comments_168755.json:
```json
{
    "body": "<a id='comment:0'></a>\n`@`lazy_class_attribute? I didn't know about that!\n\nApparently there are further changes that the patch does not provide: Shouldn't there also be a change telling that Rings and Fields *is* a Category_singleton? So, replace \"class Rings(Category)\" by \"class Rings(Category_singleton)\"?",
    "created_at": "2011-11-18T13:30:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168755",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:0'></a>
`@`lazy_class_attribute? I didn't know about that!

Apparently there are further changes that the patch does not provide: Shouldn't there also be a change telling that Rings and Fields *is* a Category_singleton? So, replace "class Rings(Category)" by "class Rings(Category_singleton)"?



---

archive/issue_comments_168756.json:
```json
{
    "body": "<a id='comment:101'></a>\nReplying to [nthiery](#comment%3A99):\n> Ah, I see, you are thinking of cythonizing is_subcategories via\n> parent_class for *all* categories.\n\n\nYes! Currently it would work, even for join categories. On the other hand, this could be a rather big change (so, better on a different ticket.\n\n> Hmm, I haven't yet made up my mind\n> about this. Unless it brings a clear general improvement (and not only\n> for the specific regression this patch is about), shalle we not postpone\n> that to later, and stick to a more local change (only about Rings and friends)?\n\n\nOK.\n\nI don't know if we can do the change for Fields, though. Fields has a special `__contains__` method, and I don't know if #9138 has really been strong enough to make it possible to use the default `__contains__` instead.\n\nDesign question:\n\nApparently you suggest to implement a subclass of Category, so that Rings and Fields and so on inherit form this class rather than from Category. The other approach we discussed was to define cython functions and plug these functions into methods of python classes. I suggest that we do a couple of benchmarks, to see what's fastest. Doing that now...",
    "created_at": "2011-11-18T13:36:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168756",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:101'></a>
Replying to [nthiery](#comment%3A99):
> Ah, I see, you are thinking of cythonizing is_subcategories via
> parent_class for *all* categories.


Yes! Currently it would work, even for join categories. On the other hand, this could be a rather big change (so, better on a different ticket.

> Hmm, I haven't yet made up my mind
> about this. Unless it brings a clear general improvement (and not only
> for the specific regression this patch is about), shalle we not postpone
> that to later, and stick to a more local change (only about Rings and friends)?


OK.

I don't know if we can do the change for Fields, though. Fields has a special `__contains__` method, and I don't know if #9138 has really been strong enough to make it possible to use the default `__contains__` instead.

Design question:

Apparently you suggest to implement a subclass of Category, so that Rings and Fields and so on inherit form this class rather than from Category. The other approach we discussed was to define cython functions and plug these functions into methods of python classes. I suggest that we do a couple of benchmarks, to see what's fastest. Doing that now...



---

archive/issue_comments_168757.json:
```json
{
    "body": "<a id='comment:2'></a>\nYou write that the Category_singleton uses an optimized class call. It is indeed slightly faster than the usual classcall, as it seems:\n\n```\nsage: from sage.categories.category_singleton import Category_singleton \nsage: class MyRingsSingleton(Category_singleton): \n....:     super_categories = Rings.__dict__['super_categories'] \n....:     \nsage: MR = MyRingsSingleton()\nsage: MR\nCategory of my rings singleton\nsage: %timeit MyRingsSingleton()\n625 loops, best of 3: 5.28 \u00b5s per loop\nsage: %timeit Rings()\n625 loops, best of 3: 6.92 \u00b5s per loop\nsage: %timeit MyRingsSingleton()\n625 loops, best of 3: 3.39 \u00b5s per loop\nsage: %timeit Rings()\n625 loops, best of 3: 6.92 \u00b5s per loop\nsage: %timeit MyRingsSingleton()\n625 loops, best of 3: 3.38 \u00b5s per loop\nsage: %timeit Rings()\n625 loops, best of 3: 7.02 \u00b5s per loop\n```\n\nI don't know why the first \"timeit\" for `MyRingsSingleton` is so match slower than the other two runs.",
    "created_at": "2011-11-18T14:14:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168757",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:2'></a>
You write that the Category_singleton uses an optimized class call. It is indeed slightly faster than the usual classcall, as it seems:

```
sage: from sage.categories.category_singleton import Category_singleton 
sage: class MyRingsSingleton(Category_singleton): 
....:     super_categories = Rings.__dict__['super_categories'] 
....:     
sage: MR = MyRingsSingleton()
sage: MR
Category of my rings singleton
sage: %timeit MyRingsSingleton()
625 loops, best of 3: 5.28 µs per loop
sage: %timeit Rings()
625 loops, best of 3: 6.92 µs per loop
sage: %timeit MyRingsSingleton()
625 loops, best of 3: 3.39 µs per loop
sage: %timeit Rings()
625 loops, best of 3: 6.92 µs per loop
sage: %timeit MyRingsSingleton()
625 loops, best of 3: 3.38 µs per loop
sage: %timeit Rings()
625 loops, best of 3: 7.02 µs per loop
```

I don't know why the first "timeit" for `MyRingsSingleton` is so match slower than the other two runs.



---

archive/issue_comments_168758.json:
```json
{
    "body": "<a id='comment:103'></a>\nReplying to [SimonKing](#comment%3A102):\n> You write that the Category_singleton uses an optimized class call. It is indeed slightly faster \n\n\n\"slightly\" is ironical, as it is a factor of nearly two.",
    "created_at": "2011-11-18T14:15:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168758",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:103'></a>
Replying to [SimonKing](#comment%3A102):
> You write that the Category_singleton uses an optimized class call. It is indeed slightly faster 


"slightly" is ironical, as it is a factor of nearly two.



---

archive/issue_comments_168759.json:
```json
{
    "body": "<a id='comment:4'></a>\nOMG, just for fun I made the same \"benchmark\" for the creation of the rational field, and look what I found:\n\n```\nsage: %timeit RationalField()\n625 loops, best of 3: 75.4 \u00b5s per loop\n```\n\nThat's bad!",
    "created_at": "2011-11-18T14:17:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168759",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:4'></a>
OMG, just for fun I made the same "benchmark" for the creation of the rational field, and look what I found:

```
sage: %timeit RationalField()
625 loops, best of 3: 75.4 µs per loop
```

That's bad!



---

archive/issue_comments_168760.json:
```json
{
    "body": "<a id='comment:105'></a>\nReplying to [SimonKing](#comment%3A100):\n> Apparently there are further changes that the patch does not\n> provide: Shouldn't there also be a change telling that Rings and\n> Fields *is* a Category_singleton? So, replace \"class\n> Rings(Category)\" by \"class Rings(Category_singleton)\"?\n\n\nYes, that's definitely the intention if we decide to go for this\napproach. At this point, it's just an experiment, so I did not bother\nimplementing it.",
    "created_at": "2011-11-18T14:44:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168760",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:105'></a>
Replying to [SimonKing](#comment%3A100):
> Apparently there are further changes that the patch does not
> provide: Shouldn't there also be a change telling that Rings and
> Fields *is* a Category_singleton? So, replace "class
> Rings(Category)" by "class Rings(Category_singleton)"?


Yes, that's definitely the intention if we decide to go for this
approach. At this point, it's just an experiment, so I did not bother
implementing it.



---

archive/issue_comments_168761.json:
```json
{
    "body": "<a id='comment:106'></a>\nReplying to [SimonKing](#comment%3A103):\n> Replying to [SimonKing](#comment%3A102):\n> > You write that the Category_singleton uses an optimized class call. It is indeed slightly faster \n\n> \n> \"slightly\" is ironical, as it is a factor of nearly two.\n\n\n:-)\n\nOne can expect more progress by:\n- cythonizing ConstantFunction\n- cythonizing ClassCallMetaclass.__classcall__\n\nThis probably should eventually be generalized to a Singleton subclass of UniqueRepresentation.",
    "created_at": "2011-11-18T14:49:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168761",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:106'></a>
Replying to [SimonKing](#comment%3A103):
> Replying to [SimonKing](#comment%3A102):
> > You write that the Category_singleton uses an optimized class call. It is indeed slightly faster 

> 
> "slightly" is ironical, as it is a factor of nearly two.


:-)

One can expect more progress by:
- cythonizing ConstantFunction
- cythonizing ClassCallMetaclass.__classcall__

This probably should eventually be generalized to a Singleton subclass of UniqueRepresentation.



---

archive/issue_comments_168762.json:
```json
{
    "body": "<a id='comment:7'></a>\nI changed `Rings(Category)` into `Rings(Category_singleton)` (but then had to remove the `rings_contains` function in the pyx file, by cyclic import).\n\nFirst, because of your optimisation of the classcall, one has\n\n```\nsage: %timeit Rings()\n625 loops, best of 3: 3.42 \u00b5s per loop\n```\nSecond, one has\n\n```\nsage: R = Rings()\nsage: P.<x,y,z> = QQ[]\nsage: P in R\nTrue\nsage: %timeit P in R\n625 loops, best of 3: 1.38 \u00b5s per loop\n```\n\nUsing `PyType_IsSubtype` from sage/ext/python_type.pxi, one comes down to 1.08 \u00b5s.\n\nYou use a lazy class attribute not only for the classcall, but also for the containment test. If one writes the containment test directly as a method (recall: We are here in a cython file!), one has 1.53 \u00b5s. So, to my surprise, the lazy class attribute trick works well also for performance!\n\nUsing a similar approach for computing the hash works as well. Namely, for a singleton class, it should be fine if the hash of the (single) instance is not id of the instance but id of the class. With the following code\n\n```python\ncdef class hash_c(object):\n    cdef long n\n    def __init__(self, cls):\n        self.n = id(cls)\n    def __call__(self):\n        return self.n\n\nclass Category_singleton(Category):\n    ...\n    @lazy_class_attribute\n    def __hash__(cls):\n        return hash_c(cls)\n```\nI obtain\n\n```\nsage: %timeit {R:1}\n625 loops, best of 3: 695 ns per loop\n```\nWithout that trick, it is 1.46 \u00b5s.",
    "created_at": "2011-11-18T16:04:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168762",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:7'></a>
I changed `Rings(Category)` into `Rings(Category_singleton)` (but then had to remove the `rings_contains` function in the pyx file, by cyclic import).

First, because of your optimisation of the classcall, one has

```
sage: %timeit Rings()
625 loops, best of 3: 3.42 µs per loop
```
Second, one has

```
sage: R = Rings()
sage: P.<x,y,z> = QQ[]
sage: P in R
True
sage: %timeit P in R
625 loops, best of 3: 1.38 µs per loop
```

Using `PyType_IsSubtype` from sage/ext/python_type.pxi, one comes down to 1.08 µs.

You use a lazy class attribute not only for the classcall, but also for the containment test. If one writes the containment test directly as a method (recall: We are here in a cython file!), one has 1.53 µs. So, to my surprise, the lazy class attribute trick works well also for performance!

Using a similar approach for computing the hash works as well. Namely, for a singleton class, it should be fine if the hash of the (single) instance is not id of the instance but id of the class. With the following code

```python
cdef class hash_c(object):
    cdef long n
    def __init__(self, cls):
        self.n = id(cls)
    def __call__(self):
        return self.n

class Category_singleton(Category):
    ...
    @lazy_class_attribute
    def __hash__(cls):
        return hash_c(cls)
```
I obtain

```
sage: %timeit {R:1}
625 loops, best of 3: 695 ns per loop
```
Without that trick, it is 1.46 µs.



---

archive/issue_comments_168763.json:
```json
{
    "body": "<a id='comment:8'></a>\nAnd the very good news is:\n\n```\nsage: R = Rings()\nsage: MS = MatrixSpace(QQ,2)\nsage: MS.is_ring.__module__\n'sage.categories.rings'\nsage: %timeit MS.is_ring()\n625 loops, best of 3: 3.94 \u00b5s per loop\nsage: %timeit MS in R\n625 loops, best of 3: 1.41 \u00b5s per loop\n```\n\nSo, the parent method is_ring that I introduced for speed reasons is now not the fastest thing to do. However, we still have\n\n```\nsage: P.<x,y,z> = QQ[]\nsage: %timeit P.is_ring()   # that's a cython method defined for sage.rings.ring.Ring\n625 loops, best of 3: 400 ns per loop\n```\nand\n\n```\nsage: %timeit MS in Rings()  # Adding the time needed to call Rings()\n625 loops, best of 3: 5.09 \u00b5s per loop\n```",
    "created_at": "2011-11-18T16:16:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168763",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:8'></a>
And the very good news is:

```
sage: R = Rings()
sage: MS = MatrixSpace(QQ,2)
sage: MS.is_ring.__module__
'sage.categories.rings'
sage: %timeit MS.is_ring()
625 loops, best of 3: 3.94 µs per loop
sage: %timeit MS in R
625 loops, best of 3: 1.41 µs per loop
```

So, the parent method is_ring that I introduced for speed reasons is now not the fastest thing to do. However, we still have

```
sage: P.<x,y,z> = QQ[]
sage: %timeit P.is_ring()   # that's a cython method defined for sage.rings.ring.Ring
625 loops, best of 3: 400 ns per loop
```
and

```
sage: %timeit MS in Rings()  # Adding the time needed to call Rings()
625 loops, best of 3: 5.09 µs per loop
```



---

archive/issue_comments_168764.json:
```json
{
    "body": "<a id='comment:9'></a>\nAnother improvement: It is very easy to cythonise `ConstantFunction`. Doing so improves the time for calling `Rings()`, for example:\n\n```\nsage: P.<x,y,z> = QQ[]\nsage: %timeit Rings()\n625 loops, best of 3: 2.05 \u00b5s per loop\nsage: P in Rings()\nTrue\nsage: %timeit P in Rings()\n625 loops, best of 3: 3.24 \u00b5s per loop\n```",
    "created_at": "2011-11-18T16:31:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168764",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:9'></a>
Another improvement: It is very easy to cythonise `ConstantFunction`. Doing so improves the time for calling `Rings()`, for example:

```
sage: P.<x,y,z> = QQ[]
sage: %timeit Rings()
625 loops, best of 3: 2.05 µs per loop
sage: P in Rings()
True
sage: %timeit P in Rings()
625 loops, best of 3: 3.24 µs per loop
```



---

archive/issue_comments_168765.json:
```json
{
    "body": "<a id='comment:0'></a>\nI have attached a new patch, which is your patch but with the modifications I explained above.",
    "created_at": "2011-11-18T16:36:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168765",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:0'></a>
I have attached a new patch, which is your patch but with the modifications I explained above.



---

archive/issue_comments_168766.json:
```json
{
    "body": "<a id='comment:111'></a>\nReplying to [SimonKing](#comment%3A110):\n> I have attached a new patch, which is your patch but with the modifications I explained above.\n\n\nThat all sounds good! Do you mind folding the different ideas we agreed upon in a single overview patch (unless you insist on keeping some of the changes cleanly separated). Then I'll do a final review and it will be good to go!\n\nCheers,\n                         Nicolas",
    "created_at": "2011-11-18T22:53:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168766",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:111'></a>
Replying to [SimonKing](#comment%3A110):
> I have attached a new patch, which is your patch but with the modifications I explained above.


That all sounds good! Do you mind folding the different ideas we agreed upon in a single overview patch (unless you insist on keeping some of the changes cleanly separated). Then I'll do a final review and it will be good to go!

Cheers,
                         Nicolas



---

archive/issue_comments_168767.json:
```json
{
    "body": "**Changing reviewer** from \"Jeroen Demeyer\" to \"Jeroen Demeyer, Nicolas M. Thi\u00e9ry\".",
    "created_at": "2011-11-18T22:53:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168767",
    "user": "https://github.com/nthiery"
}
```

**Changing reviewer** from "Jeroen Demeyer" to "Jeroen Demeyer, Nicolas M. Thiéry".



---

archive/issue_comments_168768.json:
```json
{
    "body": "**Work_Issues:** finalize the patch with the different ideas that have been explored",
    "created_at": "2011-11-18T22:53:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168768",
    "user": "https://github.com/nthiery"
}
```

**Work_Issues:** finalize the patch with the different ideas that have been explored



---

archive/issue_comments_168769.json:
```json
{
    "body": "<a id='comment:112'></a>\nReplying to [nthiery](#comment%3A111):\n> Replying to [SimonKing](#comment%3A110):\n> > I have attached a new patch, which is your patch but with the modifications I explained above.\n\n> \n> That all sounds good! Do you mind folding the different ideas we agreed upon in a single overview patch\n\n\nDo you mean \"combine the four patches into one\"? Or are there ideas concerning singleton that we discussed (for *this* ticket; I know that we had further ideas for other tickets) and are not included in the singleton patch yet?\n\nI succeeded to save yet another bit of time: Use the fact that the argument of `__contains__` should be a `CategoryObject`, or it is no object in a category.\n\nMoreover, I found that it is both easier and slightly faster to use `ConstantFunction` for the `__hash__`. \n\nAnd finally, I tried to get rid of the custom `__contains__` method of Fields(). It should all use categories by now.\n\nCurrent timings are:\n\n```\nsage: MS = MatrixSpace(QQ,2)\nsage: P.<x,y,z> = QQ[]\nsage: RC = Rings()\nsage: FC = Fields()\nsage: F3 = GF(3)\nsage: %timeit Rings()\n625 loops, best of 3: 2.04 \u00b5s per loop\nsage: %timeit Fields()\n625 loops, best of 3: 2.08 \u00b5s per loop\nsage: %timeit MS in RC\n625 loops, best of 3: 726 ns per loop\nsage: %timeit MS in FC\n625 loops, best of 3: 793 ns per loop\nsage: %timeit F3 in RC\n625 loops, best of 3: 667 ns per loop\nsage: %timeit F3 in FC\n625 loops, best of 3: 671 ns per loop\nsage: %timeit {FC:1,RC:2}\n625 loops, best of 3: 1.37 \u00b5s per loop\nsage: %timeit hash(FC)\n625 loops, best of 3: 352 ns per loop\n```\n\nThe patch still needs work: Documentation needs to be written, and tests need to pass (I didn't try yet). But of course you can already see whether you might like the result.\n\nApply trac11900_no_categories_for_matrices.patch trac11900_category_speedup.patch trac11900_further_tweaks.patch trac_11900-category_singleton-sk.patch",
    "created_at": "2011-11-18T23:49:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168769",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:112'></a>
Replying to [nthiery](#comment%3A111):
> Replying to [SimonKing](#comment%3A110):
> > I have attached a new patch, which is your patch but with the modifications I explained above.

> 
> That all sounds good! Do you mind folding the different ideas we agreed upon in a single overview patch


Do you mean "combine the four patches into one"? Or are there ideas concerning singleton that we discussed (for *this* ticket; I know that we had further ideas for other tickets) and are not included in the singleton patch yet?

I succeeded to save yet another bit of time: Use the fact that the argument of `__contains__` should be a `CategoryObject`, or it is no object in a category.

Moreover, I found that it is both easier and slightly faster to use `ConstantFunction` for the `__hash__`. 

And finally, I tried to get rid of the custom `__contains__` method of Fields(). It should all use categories by now.

Current timings are:

```
sage: MS = MatrixSpace(QQ,2)
sage: P.<x,y,z> = QQ[]
sage: RC = Rings()
sage: FC = Fields()
sage: F3 = GF(3)
sage: %timeit Rings()
625 loops, best of 3: 2.04 µs per loop
sage: %timeit Fields()
625 loops, best of 3: 2.08 µs per loop
sage: %timeit MS in RC
625 loops, best of 3: 726 ns per loop
sage: %timeit MS in FC
625 loops, best of 3: 793 ns per loop
sage: %timeit F3 in RC
625 loops, best of 3: 667 ns per loop
sage: %timeit F3 in FC
625 loops, best of 3: 671 ns per loop
sage: %timeit {FC:1,RC:2}
625 loops, best of 3: 1.37 µs per loop
sage: %timeit hash(FC)
625 loops, best of 3: 352 ns per loop
```

The patch still needs work: Documentation needs to be written, and tests need to pass (I didn't try yet). But of course you can already see whether you might like the result.

Apply trac11900_no_categories_for_matrices.patch trac11900_category_speedup.patch trac11900_further_tweaks.patch trac_11900-category_singleton-sk.patch



---

archive/issue_comments_168770.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -35,3 +35,4 @@\n * [attachment:trac11900_no_categories_for_matrices.patch]\n * [attachment:trac11900_category_speedup.patch]\n * [attachment:trac11900_further_tweaks.patch]\n+* [attachment:trac_11900-category_singleton-sk.patch]\n``````\n",
    "created_at": "2011-11-18T23:49:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168770",
    "user": "https://github.com/simon-king-jena"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -35,3 +35,4 @@
 * [attachment:trac11900_no_categories_for_matrices.patch]
 * [attachment:trac11900_category_speedup.patch]
 * [attachment:trac11900_further_tweaks.patch]
+* [attachment:trac_11900-category_singleton-sk.patch]
``````




---

archive/issue_comments_168771.json:
```json
{
    "body": "<a id='comment:3'></a>\nAh yes! One of the things that should be done in the finalisation of the patch is: Revert the use of `is_ring`, as `P in Rings()` is now competitive. But is there more to do than that and the documentation?",
    "created_at": "2011-11-18T23:52:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168771",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:3'></a>
Ah yes! One of the things that should be done in the finalisation of the patch is: Revert the use of `is_ring`, as `P in Rings()` is now competitive. But is there more to do than that and the documentation?



---

archive/issue_comments_168772.json:
```json
{
    "body": "<a id='comment:4'></a>\nFor the record: With the latest patches, one gets some doctest errors, but they seem managable:\n\n```\n        sage -t  devel/sage-main/sage/rings/polynomial/polynomial_quotient_ring.py # 6 doctests failed\n        sage -t  devel/sage-main/sage/categories/pushout.py # 1 doctests failed\n        sage -t  devel/sage-main/sage/rings/polynomial/polynomial_quotient_ring_element.py # 6 doctests failed\n        sage -t  devel/sage-main/sage/combinat/debruijn_sequence.pyx # 21 doctests failed\n        sage -t  devel/sage-main/sage/misc/constant_function.pyx # 2 doctests failed\n        sage -t  devel/sage-main/sage/categories/category_singleton.pyx # 1 doctests failed\n```\n\nConcerning timings, I find with sage-4.7.2+#9138+the stuff from here the following results for the benchmarks that I posted five weeks ago. By \"vanilla sage\", I mean sage-4.7.2.alpha2 unpatched (copying the timings from above):\n\n__Creation of Matrix spaces__\n\nIt is as with the previous patch versions, hence, faster than vanilla sage sage (0.38 s cpu):\n\n```\nsage: def test():\n....:     for i in xrange(5000):\n....:         MS = MatrixSpace(QQ,i)\n....:\nsage: %time test()\nCPU times: user 0.25 s, sys: 0.01 s, total: 0.26 s\nWall time: 0.26 s\n```\n\n__Creation of finite fields__\n\nIt is faster than with the previous patches. Even better, it is now faster than vanilla sage (0.60 s cpu), which has not been the case with the previous patches:\n\n```\nsage: def test():\n....:     for p in prime_range(10000):\n....:         P = GF(p)\n....:\nsage: %time test()\nCPU times: user 0.53 s, sys: 0.00 s, total: 0.53 s\nWall time: 0.53 s\n```\n\n__Creation of polynomial rings__\n\nIt is slower than vanilla sage (2.41 s cpu), but a bit faster than what I had with the patches 5 weeks ago (4.32 s CPU):\n\n```\nsage: def test():\n....:     for p in prime_range(10000):\n....:         P = GF(p)['x']\n....:         P = GF(p)['x','y']\n....:\nsage: %time test()\nCPU times: user 3.92 s, sys: 0.05 s, total: 3.97 s\nWall time: 3.98 s\n```\n\n**__The two critical elliptic curve tests__**\n\nRecall that the following two were most critical and were the reason for creating this ticket:\n\n```\nsage: %time L = EllipticCurve('960d1').prove_BSD()\nCPU times: user 3.96 s, sys: 0.08 s, total: 4.04 s\nWall time: 4.25 s\n```\nThat's about as fast as vanilla sage (CPU time went up a bit, wall time went down a bit)\n\n```\nsage: def test():\n....:     E = EllipticCurve('389a')\n....:     for p in prime_range(10000):\n....:         if p != 389:\n....:             G = E.change_ring(GF(p)).abelian_group()\n....:\nsage: %time test()\nCPU times: user 16.53 s, sys: 0.14 s, total: 16.67 s\nWall time: 16.72 s\n```\nAgain, that can very well compete with vanilla sage (16.57 s cpu, 16.77 s wall).\n\n**__TODO__**\n\nInstead of `P.is_ring()`, define `_Rings = Rings()` and test `P in _Rings`. Nicolas, please tell whether I forgot further things todo on this ticket.",
    "created_at": "2011-11-19T09:02:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168772",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:4'></a>
For the record: With the latest patches, one gets some doctest errors, but they seem managable:

```
        sage -t  devel/sage-main/sage/rings/polynomial/polynomial_quotient_ring.py # 6 doctests failed
        sage -t  devel/sage-main/sage/categories/pushout.py # 1 doctests failed
        sage -t  devel/sage-main/sage/rings/polynomial/polynomial_quotient_ring_element.py # 6 doctests failed
        sage -t  devel/sage-main/sage/combinat/debruijn_sequence.pyx # 21 doctests failed
        sage -t  devel/sage-main/sage/misc/constant_function.pyx # 2 doctests failed
        sage -t  devel/sage-main/sage/categories/category_singleton.pyx # 1 doctests failed
```

Concerning timings, I find with sage-4.7.2+#9138+the stuff from here the following results for the benchmarks that I posted five weeks ago. By "vanilla sage", I mean sage-4.7.2.alpha2 unpatched (copying the timings from above):

__Creation of Matrix spaces__

It is as with the previous patch versions, hence, faster than vanilla sage sage (0.38 s cpu):

```
sage: def test():
....:     for i in xrange(5000):
....:         MS = MatrixSpace(QQ,i)
....:
sage: %time test()
CPU times: user 0.25 s, sys: 0.01 s, total: 0.26 s
Wall time: 0.26 s
```

__Creation of finite fields__

It is faster than with the previous patches. Even better, it is now faster than vanilla sage (0.60 s cpu), which has not been the case with the previous patches:

```
sage: def test():
....:     for p in prime_range(10000):
....:         P = GF(p)
....:
sage: %time test()
CPU times: user 0.53 s, sys: 0.00 s, total: 0.53 s
Wall time: 0.53 s
```

__Creation of polynomial rings__

It is slower than vanilla sage (2.41 s cpu), but a bit faster than what I had with the patches 5 weeks ago (4.32 s CPU):

```
sage: def test():
....:     for p in prime_range(10000):
....:         P = GF(p)['x']
....:         P = GF(p)['x','y']
....:
sage: %time test()
CPU times: user 3.92 s, sys: 0.05 s, total: 3.97 s
Wall time: 3.98 s
```

**__The two critical elliptic curve tests__**

Recall that the following two were most critical and were the reason for creating this ticket:

```
sage: %time L = EllipticCurve('960d1').prove_BSD()
CPU times: user 3.96 s, sys: 0.08 s, total: 4.04 s
Wall time: 4.25 s
```
That's about as fast as vanilla sage (CPU time went up a bit, wall time went down a bit)

```
sage: def test():
....:     E = EllipticCurve('389a')
....:     for p in prime_range(10000):
....:         if p != 389:
....:             G = E.change_ring(GF(p)).abelian_group()
....:
sage: %time test()
CPU times: user 16.53 s, sys: 0.14 s, total: 16.67 s
Wall time: 16.72 s
```
Again, that can very well compete with vanilla sage (16.57 s cpu, 16.77 s wall).

**__TODO__**

Instead of `P.is_ring()`, define `_Rings = Rings()` and test `P in _Rings`. Nicolas, please tell whether I forgot further things todo on this ticket.



---

archive/issue_comments_168773.json:
```json
{
    "body": "<a id='comment:115'></a>\nReplying to [SimonKing](#comment%3A113):\n> Ah yes! One of the things that should be done in the finalisation of the patch is: Revert the use of `is_ring`, as `P in Rings()` is now competitive. But is there more to do than that and the documentation?\n\n\nAs far as I remember, this is it indeed. \n\nAnd yes, I meant to combine all four patches for this ticket into one (it makes it easier to get an overview). Thanks!\n\nCheers,\n                                  Nicolas",
    "created_at": "2011-11-19T09:09:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168773",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:115'></a>
Replying to [SimonKing](#comment%3A113):
> Ah yes! One of the things that should be done in the finalisation of the patch is: Revert the use of `is_ring`, as `P in Rings()` is now competitive. But is there more to do than that and the documentation?


As far as I remember, this is it indeed. 

And yes, I meant to combine all four patches for this ticket into one (it makes it easier to get an overview). Thanks!

Cheers,
                                  Nicolas



---

archive/issue_comments_168774.json:
```json
{
    "body": "<a id='comment:6'></a>\nSome of the errors are due to the fact that still some fields are not initialised as fields. For example: Laurent series rings.\n\n```\nsage: P = QQ[['x']]\nsage: F = Frac(P)\nsage: F.is_field()\nTrue\nsage: F.category()\nCategory of rings\n```\nSo, here is yet another case of a parent whose category should better be properly initialised.",
    "created_at": "2011-11-19T12:02:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168774",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:6'></a>
Some of the errors are due to the fact that still some fields are not initialised as fields. For example: Laurent series rings.

```
sage: P = QQ[['x']]
sage: F = Frac(P)
sage: F.is_field()
True
sage: F.category()
Category of rings
```
So, here is yet another case of a parent whose category should better be properly initialised.



---

archive/issue_comments_168775.json:
```json
{
    "body": "**Changing work_issues** from \"finalize the patch with the different ideas that have been explored\" to \"Laurent series rings are fields. Add docs. Don't use is_ring and friends\".",
    "created_at": "2011-11-19T12:02:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168775",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing work_issues** from "finalize the patch with the different ideas that have been explored" to "Laurent series rings are fields. Add docs. Don't use is_ring and friends".



---

archive/issue_comments_168776.json:
```json
{
    "body": "<a id='comment:7'></a>\nMost doctest errors are easy to fix. So, let us discuss the errors for polynomial quotient rings.\n\nI guess polynomial quotient rings are the reason why `is_field` and the custom implementation of `sage.categories.fields.Fields.__contains__` (which does call `is_field`) have originally been introduced: It is often a waste of time to test *during initialisation* whether a polyonomial quotient ring is a field or not.\n\nBy the way, `is_field` is currently not cached, but of course should be.\n\nSo, what shall we do? Perhaps this is one of the cases where we don't want to fully initialise the category during `__init__`?\n\nI would argue as follows:\n\n* If we do `Q in Fields()` for a polynomial quotient ring Q, then currently (that's to say: before my patch) `Q.is_field()` is called. In other words: Currently, `Q in Fields()` does trigger a potentially expensive computation, but that computation is not done during initialisation.\n* Our aim is to get rid of the custom `Fields.__contains__`. Since `Q in Fields()` currently triggers a potentially expensive test, it should be OK if this is also done in future.\n* When using the default `Category_singleton.__contains__` for `Fields()`, then `Q in Fields()` involves calling `Q.category().parent_class`. Hence, `Q.category()` could be the right spot for triggering the field test.\n\n__Suggestion__\n\nDuring `__init__`, a polynomial quotient ring should be initialised as an object in the category of commutative algebras (not rings, as it is now). Moreover, polynomial quotient rings should have a custom `category()` method, different from the one inherited from `CategoryObject`.\n\nIf `Q.category()` is called, then it shall be tested whether Q is a field. If it is, then the category initialisation is repeated with the correct category.\n\n__Implementation__\n\nFor that purpose I'd implement a new method (perhaps called `_refine_category(self, category)`) for category objects: `P._refine_category(C)` will change the original category into its join with `C`.\n\nAfter using this method, the custom `Q.category()` method would override itself by the usual one. In other words, I imagine something like the following for polynomial quotient rings:\n\n```python\nimport types\ndef category(self):\n    if self.is_field():\n        self._refine_category(Fields())\n    cat = CategoryObject.category(self)\n    self.category = types.MethodType(CategoryObject.category, self, CategoryObject)\n    return cat\n```",
    "created_at": "2011-11-19T20:48:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168776",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:7'></a>
Most doctest errors are easy to fix. So, let us discuss the errors for polynomial quotient rings.

I guess polynomial quotient rings are the reason why `is_field` and the custom implementation of `sage.categories.fields.Fields.__contains__` (which does call `is_field`) have originally been introduced: It is often a waste of time to test *during initialisation* whether a polyonomial quotient ring is a field or not.

By the way, `is_field` is currently not cached, but of course should be.

So, what shall we do? Perhaps this is one of the cases where we don't want to fully initialise the category during `__init__`?

I would argue as follows:

* If we do `Q in Fields()` for a polynomial quotient ring Q, then currently (that's to say: before my patch) `Q.is_field()` is called. In other words: Currently, `Q in Fields()` does trigger a potentially expensive computation, but that computation is not done during initialisation.
* Our aim is to get rid of the custom `Fields.__contains__`. Since `Q in Fields()` currently triggers a potentially expensive test, it should be OK if this is also done in future.
* When using the default `Category_singleton.__contains__` for `Fields()`, then `Q in Fields()` involves calling `Q.category().parent_class`. Hence, `Q.category()` could be the right spot for triggering the field test.

__Suggestion__

During `__init__`, a polynomial quotient ring should be initialised as an object in the category of commutative algebras (not rings, as it is now). Moreover, polynomial quotient rings should have a custom `category()` method, different from the one inherited from `CategoryObject`.

If `Q.category()` is called, then it shall be tested whether Q is a field. If it is, then the category initialisation is repeated with the correct category.

__Implementation__

For that purpose I'd implement a new method (perhaps called `_refine_category(self, category)`) for category objects: `P._refine_category(C)` will change the original category into its join with `C`.

After using this method, the custom `Q.category()` method would override itself by the usual one. In other words, I imagine something like the following for polynomial quotient rings:

```python
import types
def category(self):
    if self.is_field():
        self._refine_category(Fields())
    cat = CategoryObject.category(self)
    self.category = types.MethodType(CategoryObject.category, self, CategoryObject)
    return cat
```



---

archive/issue_comments_168777.json:
```json
{
    "body": "<a id='comment:8'></a>\nHmm. This will be more difficult than I thought: There are lots of `is_field` methods in Sage. Apparently some of them are not cached. It would probably not be feasible to have a custom `category()` method in all cases.\n\nWhat could one do instead?\n\nI see the following options:\n\n1. We could remove the custom `__contains__` method and restrict ourselves to fixing the case of `PolynomialQuotientRing` in the way I indicated. After all, this is the only case of failing doctests.\n2. We could remove the custom `__contains__` method and the category stuff for all parents with an `is_field()` method.\n3. We could preserve the custom `__contains__` method of `Fields()`, but ensure that the potentially time-consuming additional tests are cached. Instead of caching all `is_field()` methods (there are quite many), I suggest to use a cache on the function `sage.rings.field.is_Field`. Namely, this is what is really called in the custom `__contains__` method.\n\nI think the first solution is not really a solution. The second is too much for this ticket. The third seems fine to me, though. What do you think?\n\nIn more detail: We introduce the `_refine_category()` method to `CategoryObject`. We impose a cache on `sage.rings.field.is_Field`. In `sage.rings.field.is_Field`, we use `_refine_category()` on those rings that were found to be a field.\n\nSince `is_Field` is cached, the `_refine_category()` method will be called at most once, and `sage.categories.fields.Fields.__contains__` will also be faster because of the cache.",
    "created_at": "2011-11-19T22:33:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168777",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:8'></a>
Hmm. This will be more difficult than I thought: There are lots of `is_field` methods in Sage. Apparently some of them are not cached. It would probably not be feasible to have a custom `category()` method in all cases.

What could one do instead?

I see the following options:

1. We could remove the custom `__contains__` method and restrict ourselves to fixing the case of `PolynomialQuotientRing` in the way I indicated. After all, this is the only case of failing doctests.
2. We could remove the custom `__contains__` method and the category stuff for all parents with an `is_field()` method.
3. We could preserve the custom `__contains__` method of `Fields()`, but ensure that the potentially time-consuming additional tests are cached. Instead of caching all `is_field()` methods (there are quite many), I suggest to use a cache on the function `sage.rings.field.is_Field`. Namely, this is what is really called in the custom `__contains__` method.

I think the first solution is not really a solution. The second is too much for this ticket. The third seems fine to me, though. What do you think?

In more detail: We introduce the `_refine_category()` method to `CategoryObject`. We impose a cache on `sage.rings.field.is_Field`. In `sage.rings.field.is_Field`, we use `_refine_category()` on those rings that were found to be a field.

Since `is_Field` is cached, the `_refine_category()` method will be called at most once, and `sage.categories.fields.Fields.__contains__` will also be faster because of the cache.



---

archive/issue_comments_168778.json:
```json
{
    "body": "<a id='comment:9'></a>\nOne slight complication: The current implementation of `Fields.__contains__` starts with calling `super(Fields,self).__contains__`. But the latter is a lazy class attribute - and thus overrides `Fields.__contains__`.\n\nProbably it is needed to avoid the call to `super`.",
    "created_at": "2011-11-20T12:33:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168778",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:9'></a>
One slight complication: The current implementation of `Fields.__contains__` starts with calling `super(Fields,self).__contains__`. But the latter is a lazy class attribute - and thus overrides `Fields.__contains__`.

Probably it is needed to avoid the call to `super`.



---

archive/issue_comments_168779.json:
```json
{
    "body": "<a id='comment:0'></a>\nWhat I now did: `Fields.__contains__` uses a helper that compares parent classes (the same that is used by `Category_singleton`). If that fails, then `is_field()` is called. If it turns out to be a field then the category is updated.\n\nWithout the singleton patch:\n\n```\nsage: P.<x> = QQ[]\nsage: Q = P.quotient(x^2+2)\nsage: Q in Fields()\nTrue\nsage: _Fields = Fields()\nsage: %timeit Q in _Fields\n625 loops, best of 3: 21.1 \u00b5s per loop\nsage: isinstance(Q, Fields().parent_class)\nFalse\n```\nIt is so slow, because `Q.category()` gives the wrong answer, thus `is_Field` must be called, hence, `Q.is_field()` is called, and it is not cached.\n\nWith my experimental (not yet published) patch, we would get\n\n```\nsage: P.<x> = QQ[]\nsage: Q = P.quotient(x^2+2)\nsage: isinstance(Q, Fields().parent_class)\nFalse\nsage: Q in Fields()\nTrue\nsage: isinstance(Q, Fields().parent_class)\nTrue\nsage: _Fields = Fields()\nsage: %timeit Q in _Fields\n625 loops, best of 3: 662 ns per loop\n```\n\nIn other words: In the first place, Q is not initialised as a field. But if `Q in Fields()` returns true (which is because of calling `is_Field`) then the category of Q is refined. Hence, the next time of calling `Q in Fields()` the shortcut of Category_singleton can be used.\n\nWhat do you think?",
    "created_at": "2011-11-20T13:04:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168779",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:0'></a>
What I now did: `Fields.__contains__` uses a helper that compares parent classes (the same that is used by `Category_singleton`). If that fails, then `is_field()` is called. If it turns out to be a field then the category is updated.

Without the singleton patch:

```
sage: P.<x> = QQ[]
sage: Q = P.quotient(x^2+2)
sage: Q in Fields()
True
sage: _Fields = Fields()
sage: %timeit Q in _Fields
625 loops, best of 3: 21.1 µs per loop
sage: isinstance(Q, Fields().parent_class)
False
```
It is so slow, because `Q.category()` gives the wrong answer, thus `is_Field` must be called, hence, `Q.is_field()` is called, and it is not cached.

With my experimental (not yet published) patch, we would get

```
sage: P.<x> = QQ[]
sage: Q = P.quotient(x^2+2)
sage: isinstance(Q, Fields().parent_class)
False
sage: Q in Fields()
True
sage: isinstance(Q, Fields().parent_class)
True
sage: _Fields = Fields()
sage: %timeit Q in _Fields
625 loops, best of 3: 662 ns per loop
```

In other words: In the first place, Q is not initialised as a field. But if `Q in Fields()` returns true (which is because of calling `is_Field`) then the category of Q is refined. Hence, the next time of calling `Q in Fields()` the shortcut of Category_singleton can be used.

What do you think?



---

archive/issue_comments_168780.json:
```json
{
    "body": "<a id='comment:1'></a>\nThere is something wrong with Category_singleton: It cant' be subclassed.\n\n```\nsage: class Test(Rings):\n....:     pass\n....:\nsage: T = Test()\nsage: T\nCategory of rings\n```\n\nIn other words, making `__classcall__` a lazy class attribute won't work, since subclasses need a different `__classcall__`.\n\nOr do you see a mechanism that allows for subclassing?\n\nThe problem occurs if one makes `EnumeratedSets` inherit from Category_singleton, since `DeBruijnSequences` subclass enumerated sets.",
    "created_at": "2011-11-20T15:05:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168780",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:1'></a>
There is something wrong with Category_singleton: It cant' be subclassed.

```
sage: class Test(Rings):
....:     pass
....:
sage: T = Test()
sage: T
Category of rings
```

In other words, making `__classcall__` a lazy class attribute won't work, since subclasses need a different `__classcall__`.

Or do you see a mechanism that allows for subclassing?

The problem occurs if one makes `EnumeratedSets` inherit from Category_singleton, since `DeBruijnSequences` subclass enumerated sets.



---

archive/issue_comments_168781.json:
```json
{
    "body": "<a id='comment:122'></a>\nReplying to [SimonKing](#comment%3A121):\n> There is something wrong with Category_singleton: It cant' be subclassed.\n> \n> \n> ```\n> sage: class Test(Rings):\n> ....:     pass\n> ....:\n> sage: T = Test()\n> sage: T\n> Category of rings\n> ```\n> \n> In other words, making `__classcall__` a lazy class attribute won't work, since subclasses need a different `__classcall__`.\n> \n> Or do you see a mechanism that allows for subclassing?\n> \n> The problem occurs if one makes `EnumeratedSets` inherit from Category_singleton, since `DeBruijnSequences` subclass enumerated sets.\n\n\nI still need to thing about the rest. For that issue, maybe Category_singleton should define __classcall_private__ instead of __classcall__ (see ClasscallMetaclass for the difference)?\nHmm, no, that probably won't work since we want to subclass Category_singleton. I assume the wrong thing is that DeBruijnSequences subclasses EnumeratedSets, where the intention probably was to be a subcategory.\n\nCheers,\n                                    Nicolas",
    "created_at": "2011-11-20T16:05:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168781",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:122'></a>
Replying to [SimonKing](#comment%3A121):
> There is something wrong with Category_singleton: It cant' be subclassed.
> 
> 
> ```
> sage: class Test(Rings):
> ....:     pass
> ....:
> sage: T = Test()
> sage: T
> Category of rings
> ```
> 
> In other words, making `__classcall__` a lazy class attribute won't work, since subclasses need a different `__classcall__`.
> 
> Or do you see a mechanism that allows for subclassing?
> 
> The problem occurs if one makes `EnumeratedSets` inherit from Category_singleton, since `DeBruijnSequences` subclass enumerated sets.


I still need to thing about the rest. For that issue, maybe Category_singleton should define __classcall_private__ instead of __classcall__ (see ClasscallMetaclass for the difference)?
Hmm, no, that probably won't work since we want to subclass Category_singleton. I assume the wrong thing is that DeBruijnSequences subclasses EnumeratedSets, where the intention probably was to be a subcategory.

Cheers,
                                    Nicolas



---

archive/issue_comments_168782.json:
```json
{
    "body": "<a id='comment:123'></a>\nReplying to [nthiery](#comment%3A122):\n> I assume the wrong thing is that DeBruijnSequences subclasses EnumeratedSets, where the intention probably was to be a subcategory.\n\n\nProbably.\n\nAnother possibility: `Category_singleton.__classcall__` should be a usual class method, but store the unique instance in an attribute (say, `_inst`) of the class - or, to be precise, in the dictionary of the class. Then, we could do something like\n\n```python\nclass Category_singleton(Category):\n    @staticmethod\n    def __classcall__(object cls):\n        try:\n            return (<dict>cls.__dict__)['_inst']\n        except KeyError:\n            inst = Category.__classcall__(cls)\n            cls._inst = inst\n            return inst\n```\n\nThen, I get\n\n```\nsage: from sage.categories.category_singleton import Category_singleton\nsage: %timeit S=Category_singleton()\n625 loops, best of 3: 2.13 \u00b5s per loop\nsage: %timeit S=Singleton()\n625 loops, best of 3: 2.07 \u00b5s per loop\n```\n\nSo, the timing seems ok, and it is subclassable:\n\n```\nsage: class Test(Singleton): pass\n....:\nsage: Singleton()\nCategory of singleton\nsage: Test()\nCategory of test\n```",
    "created_at": "2011-11-20T17:10:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168782",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:123'></a>
Replying to [nthiery](#comment%3A122):
> I assume the wrong thing is that DeBruijnSequences subclasses EnumeratedSets, where the intention probably was to be a subcategory.


Probably.

Another possibility: `Category_singleton.__classcall__` should be a usual class method, but store the unique instance in an attribute (say, `_inst`) of the class - or, to be precise, in the dictionary of the class. Then, we could do something like

```python
class Category_singleton(Category):
    @staticmethod
    def __classcall__(object cls):
        try:
            return (<dict>cls.__dict__)['_inst']
        except KeyError:
            inst = Category.__classcall__(cls)
            cls._inst = inst
            return inst
```

Then, I get

```
sage: from sage.categories.category_singleton import Category_singleton
sage: %timeit S=Category_singleton()
625 loops, best of 3: 2.13 µs per loop
sage: %timeit S=Singleton()
625 loops, best of 3: 2.07 µs per loop
```

So, the timing seems ok, and it is subclassable:

```
sage: class Test(Singleton): pass
....:
sage: Singleton()
Category of singleton
sage: Test()
Category of test
```



---

archive/issue_comments_168783.json:
```json
{
    "body": "<a id='comment:4'></a>\nProbably my suggestion on `__classcall__` is insufficient, since `__contains__` is implemented as a lazy class attribute as well.\n\nSo, first option: Work around the lazy class attributes, by dispatching similar to what I indicated above. \n\nSecond option: Don't allow subclassing of singletons. In that case, `DeBruijnSequence` needs to copy the `_call_` method from enumerated sets, and of course declare enumerated sets as a super category.\n\nOr perhaps there is a way around: We could use a classcall similar to what I did in my previous post and add two lines that override the values of `__contains__` and `__hash__` obtained from super-classes.\n\nWell, I need to experiment a bit...",
    "created_at": "2011-11-20T18:03:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168783",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:4'></a>
Probably my suggestion on `__classcall__` is insufficient, since `__contains__` is implemented as a lazy class attribute as well.

So, first option: Work around the lazy class attributes, by dispatching similar to what I indicated above. 

Second option: Don't allow subclassing of singletons. In that case, `DeBruijnSequence` needs to copy the `_call_` method from enumerated sets, and of course declare enumerated sets as a super category.

Or perhaps there is a way around: We could use a classcall similar to what I did in my previous post and add two lines that override the values of `__contains__` and `__hash__` obtained from super-classes.

Well, I need to experiment a bit...



---

archive/issue_comments_168784.json:
```json
{
    "body": "<a id='comment:5'></a>\nI think I can make subclassing work. I get\n\n```\nsage: class Test(Rings): pass\n....:\nsage: Test()\nCategory of test\nsage: Rings()\nCategory of rings\nsage: ZZ in Rings()\nTrue\nsage: ZZ in Test()\nFalse\nsage: hash(Rings())\n15828944\nsage: hash(Test())\n76231760\nsage: %timeit Rings()\n625 loops, best of 3: 2.44 \u00b5s per loop\nsage: %timeit Test()\n625 loops, best of 3: 2.58 \u00b5s per loop\n```\n\nHowever, De Bruijn sequences would still not work as they are written now: They are no singletons.\n\nSo, questions to you:\n\n* Do we want to allow for subclasses? If we don't, shall the attempt to create a subclass of a subclass of Category_singleton result in an error?\n* Should the attempt to do `Category_singleton()` result in an error? Namely, this would destroy *all* attempts to create a new singleton category in that session.\n* Do we want that `EnumeratedSets` is a singleton? Then de Bruijn sequences have to change.",
    "created_at": "2011-11-20T18:29:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168784",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:5'></a>
I think I can make subclassing work. I get

```
sage: class Test(Rings): pass
....:
sage: Test()
Category of test
sage: Rings()
Category of rings
sage: ZZ in Rings()
True
sage: ZZ in Test()
False
sage: hash(Rings())
15828944
sage: hash(Test())
76231760
sage: %timeit Rings()
625 loops, best of 3: 2.44 µs per loop
sage: %timeit Test()
625 loops, best of 3: 2.58 µs per loop
```

However, De Bruijn sequences would still not work as they are written now: They are no singletons.

So, questions to you:

* Do we want to allow for subclasses? If we don't, shall the attempt to create a subclass of a subclass of Category_singleton result in an error?
* Should the attempt to do `Category_singleton()` result in an error? Namely, this would destroy *all* attempts to create a new singleton category in that session.
* Do we want that `EnumeratedSets` is a singleton? Then de Bruijn sequences have to change.



---

archive/issue_comments_168785.json:
```json
{
    "body": "<a id='comment:126'></a>\nI'd of course appreciate your answer to my questions, but here is how I would answer:\n\nReplying to [SimonKing](#comment%3A125):\n>  * Do we want to allow for subclasses?\n\n\nWe don't. Subclassing a singleton means that it is not a singleton.\n\n> If we don't, shall the attempt to create a subclass of a subclass of Category_singleton result in an error?\n\n\nI think a big fat warning in the docs should be enough.\n\n>  * Should the attempt to do `Category_singleton()` result in an error? Namely, this would destroy *all* attempts to create a new singleton category in that session.\n\n\nIt might be reasonable.\n\n>  * Do we want that `EnumeratedSets` is a singleton? Then de Bruijn sequences have to change.\n\n\nI think we do want that enumerated sets form a singleton. I really don't see why de Bruijn sequences are not simply copying the `_call_` method from the enumerated sets.",
    "created_at": "2011-11-20T18:41:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168785",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:126'></a>
I'd of course appreciate your answer to my questions, but here is how I would answer:

Replying to [SimonKing](#comment%3A125):
>  * Do we want to allow for subclasses?


We don't. Subclassing a singleton means that it is not a singleton.

> If we don't, shall the attempt to create a subclass of a subclass of Category_singleton result in an error?


I think a big fat warning in the docs should be enough.

>  * Should the attempt to do `Category_singleton()` result in an error? Namely, this would destroy *all* attempts to create a new singleton category in that session.


It might be reasonable.

>  * Do we want that `EnumeratedSets` is a singleton? Then de Bruijn sequences have to change.


I think we do want that enumerated sets form a singleton. I really don't see why de Bruijn sequences are not simply copying the `_call_` method from the enumerated sets.



---

archive/issue_comments_168786.json:
```json
{
    "body": "<a id='comment:127'></a>\nReplying to [SimonKing](#comment%3A126):\n> I'd of course appreciate your answer to my questions, but here is how I would answer:\n> \n> Replying to [SimonKing](#comment%3A125):\n> >  * Do we want to allow for subclasses?\n \n> \n> We don't. Subclassing a singleton means that it is not a singleton.\n\n\n+1 (just to be pedantic: Subclassing a concrete singleton class means that ...)\n\n> > If we don't, shall the attempt to create a subclass of a subclass of Category_singleton result in an error?\n\n> \n> I think a big fat warning in the docs should be enough.\n\n\n+1. The above should be just explained.\n\n> >  * Should the attempt to do `Category_singleton()` result in an error? Namely, this would destroy *all* attempts to create a new singleton category in that session.\n \n> \n> It might be reasonable.\n\n\nCategory_singleton() won't pass the TestSuite since it contains abstract methods. I think this is enough.\n\n> >  * Do we want that `EnumeratedSets` is a singleton? Then de Bruijn sequences have to change.\n \n> \n> I think we do want that enumerated sets form a singleton. \n\n\n+1. But we don't necessarily have to do it in this patch if this is inconvenient.\n\n>  I really don't see why de Bruijn sequences are not simply copying the `_call_` method from the enumerated sets.\n\n\nEspecially since the copy can easily be done with something like:\n\n```\nclass DeBruijnSequences\n    ...\n\n    _call_ = EnumeratedSets.__dict__['_call_']\n```\n\nFeel free to postpone that (making EnumeratedSets a singleton+fixing de BruijnSequences) to a later patch. Though.\n\nI need to check what exactly is the use case for their _call_ method. Maybe a candidate for CategoryMethods in the long run.",
    "created_at": "2011-11-20T20:33:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168786",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:127'></a>
Replying to [SimonKing](#comment%3A126):
> I'd of course appreciate your answer to my questions, but here is how I would answer:
> 
> Replying to [SimonKing](#comment%3A125):
> >  * Do we want to allow for subclasses?
 
> 
> We don't. Subclassing a singleton means that it is not a singleton.


+1 (just to be pedantic: Subclassing a concrete singleton class means that ...)

> > If we don't, shall the attempt to create a subclass of a subclass of Category_singleton result in an error?

> 
> I think a big fat warning in the docs should be enough.


+1. The above should be just explained.

> >  * Should the attempt to do `Category_singleton()` result in an error? Namely, this would destroy *all* attempts to create a new singleton category in that session.
 
> 
> It might be reasonable.


Category_singleton() won't pass the TestSuite since it contains abstract methods. I think this is enough.

> >  * Do we want that `EnumeratedSets` is a singleton? Then de Bruijn sequences have to change.
 
> 
> I think we do want that enumerated sets form a singleton. 


+1. But we don't necessarily have to do it in this patch if this is inconvenient.

>  I really don't see why de Bruijn sequences are not simply copying the `_call_` method from the enumerated sets.


Especially since the copy can easily be done with something like:

```
class DeBruijnSequences
    ...

    _call_ = EnumeratedSets.__dict__['_call_']
```

Feel free to postpone that (making EnumeratedSets a singleton+fixing de BruijnSequences) to a later patch. Though.

I need to check what exactly is the use case for their _call_ method. Maybe a candidate for CategoryMethods in the long run.



---

archive/issue_comments_168787.json:
```json
{
    "body": "<a id='comment:128'></a>\nReplying to [nthiery](#comment%3A127):\n> Replying to [SimonKing](#comment%3A126):\n> > > If we don't, shall the attempt to create a subclass of a subclass of Category_singleton result in an error?\n\n> > \n> > I think a big fat warning in the docs should be enough.\n\n> \n> +1. The above should be just explained.\n\n\nMeanwhile I think raising an error would not hurt. Namely, `__classcall__` can easily test whether the given class is anything that is not a direct subclass of Category_singleton. Hence, subclassing Rings will be illegal, and calling Category_singleton() will also be illegal. And moreover, this test would only happen *once*, namely before creating the unique instance of the singleton. So, if will have no performance penalty for `%timeit Rings()`.\n \n> > I think we do want that enumerated sets form a singleton. \n\n> \n> +1. But we don't necessarily have to do it in this patch if this is inconvenient.\n\n\nOK. I am now testing a patch version where `EnumeratedSets` is the only singleton that is not implemented using `Category_singleton`.\n\n> Especially since the copy can easily be done with something like:\n> \n> ```\n> class DeBruijnSequences\n>     ...\n> \n>     _call_ = EnumeratedSets.__dict__['_call_']\n> ```\n\n\nCan it use a method of one class for another class that is not a subclass?\n\nYou are right that it should be a use case of category methods (IIRC these are methods that are inherited by subcategories).",
    "created_at": "2011-11-20T22:08:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168787",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:128'></a>
Replying to [nthiery](#comment%3A127):
> Replying to [SimonKing](#comment%3A126):
> > > If we don't, shall the attempt to create a subclass of a subclass of Category_singleton result in an error?

> > 
> > I think a big fat warning in the docs should be enough.

> 
> +1. The above should be just explained.


Meanwhile I think raising an error would not hurt. Namely, `__classcall__` can easily test whether the given class is anything that is not a direct subclass of Category_singleton. Hence, subclassing Rings will be illegal, and calling Category_singleton() will also be illegal. And moreover, this test would only happen *once*, namely before creating the unique instance of the singleton. So, if will have no performance penalty for `%timeit Rings()`.
 
> > I think we do want that enumerated sets form a singleton. 

> 
> +1. But we don't necessarily have to do it in this patch if this is inconvenient.


OK. I am now testing a patch version where `EnumeratedSets` is the only singleton that is not implemented using `Category_singleton`.

> Especially since the copy can easily be done with something like:
> 
> ```
> class DeBruijnSequences
>     ...
> 
>     _call_ = EnumeratedSets.__dict__['_call_']
> ```


Can it use a method of one class for another class that is not a subclass?

You are right that it should be a use case of category methods (IIRC these are methods that are inherited by subcategories).



---

archive/issue_comments_168788.json:
```json
{
    "body": "<a id='comment:129'></a>\nReplying to [SimonKing](#comment%3A128):\n> Meanwhile I think raising an error would not hurt. Namely, `__classcall__` can easily test whether the given class is anything that is not a direct subclass of Category_singleton. Hence, subclassing Rings will be illegal, and calling Category_singleton() will also be illegal. And moreover, this test would only happen *once*, namely before creating the unique instance of the singleton. So, if will have no performance penalty for `%timeit Rings()`.\n\n>\n> OK. I am now testing a patch version where `EnumeratedSets` is the only singleton that is not implemented using `Category_singleton`.\n\n\n+1 on both.\n\n> > Especially since the copy can easily be done with something like:\n> > \n> > ```\n> > class DeBruijnSequences\n> >     ...\n> > \n> >     _call_ = EnumeratedSets.__dict__['_call_']\n> > ```\n\n> \n> Can it use a method of one class for another class that is not a subclass?\n\n\nYup: unlike EnumeratedSets._call_, EnumeratedSets.__dict__['_call_']\nis the original Python *function*, before it was transformed into a\nmethod of EnumeratedSets. Not the nicest idiom on earth, but the trick\nworks ...\n\nCheers,\n\t\t\t\tNicolas",
    "created_at": "2011-11-20T22:27:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168788",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:129'></a>
Replying to [SimonKing](#comment%3A128):
> Meanwhile I think raising an error would not hurt. Namely, `__classcall__` can easily test whether the given class is anything that is not a direct subclass of Category_singleton. Hence, subclassing Rings will be illegal, and calling Category_singleton() will also be illegal. And moreover, this test would only happen *once*, namely before creating the unique instance of the singleton. So, if will have no performance penalty for `%timeit Rings()`.

>
> OK. I am now testing a patch version where `EnumeratedSets` is the only singleton that is not implemented using `Category_singleton`.


+1 on both.

> > Especially since the copy can easily be done with something like:
> > 
> > ```
> > class DeBruijnSequences
> >     ...
> > 
> >     _call_ = EnumeratedSets.__dict__['_call_']
> > ```

> 
> Can it use a method of one class for another class that is not a subclass?


Yup: unlike EnumeratedSets._call_, EnumeratedSets.__dict__['_call_']
is the original Python *function*, before it was transformed into a
method of EnumeratedSets. Not the nicest idiom on earth, but the trick
works ...

Cheers,
				Nicolas



---

archive/issue_comments_168789.json:
```json
{
    "body": "<a id='comment:0'></a>\nI really don't know. Do we want to properly initialise the category of a polynomial quotient ring? If we do, then we also need to provide it with implementations of `lift`, `ambient` and `retract`.\n\nSo, I see two options:\n\n* Provide a polynomial quotient ring just with the category of commutative algebras over its base field, so that the test suites pass for now. Deal with a proper initialisation (adding lift, ambient, retract) as `Algebras(base_ring).Quotients()` on a different ticket.\n* Bloat this ticket up even more.\n\nI prefer the first approach. I want to get this ticket finally off my plate. I really need #9138, and the longer it has to wait, the worse.",
    "created_at": "2011-11-21T11:48:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168789",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:0'></a>
I really don't know. Do we want to properly initialise the category of a polynomial quotient ring? If we do, then we also need to provide it with implementations of `lift`, `ambient` and `retract`.

So, I see two options:

* Provide a polynomial quotient ring just with the category of commutative algebras over its base field, so that the test suites pass for now. Deal with a proper initialisation (adding lift, ambient, retract) as `Algebras(base_ring).Quotients()` on a different ticket.
* Bloat this ticket up even more.

I prefer the first approach. I want to get this ticket finally off my plate. I really need #9138, and the longer it has to wait, the worse.



---

archive/issue_comments_168790.json:
```json
{
    "body": "<a id='comment:1'></a>\nARGL!!\n\nThe attempt to fix the category framework for polynomial quotient rings would end in a mess. I won't do it, at least not on this ticket.",
    "created_at": "2011-11-21T12:03:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168790",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:1'></a>
ARGL!!

The attempt to fix the category framework for polynomial quotient rings would end in a mess. I won't do it, at least not on this ticket.



---

archive/issue_comments_168791.json:
```json
{
    "body": "<a id='comment:2'></a>\nAnd here is why it is a mess.\n\n`PolynomialQuotientRingElement` has, of course, a `_mul_` method. But when one defines the element class of a polnyomial quotient ring, then this `_mul_` method is OVERRIDDEN by the category stuff, namely by `_mul_parent`. That must not happen.",
    "created_at": "2011-11-21T12:21:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168791",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:2'></a>
And here is why it is a mess.

`PolynomialQuotientRingElement` has, of course, a `_mul_` method. But when one defines the element class of a polnyomial quotient ring, then this `_mul_` method is OVERRIDDEN by the category stuff, namely by `_mul_parent`. That must not happen.



---

archive/issue_comments_168792.json:
```json
{
    "body": "<a id='comment:3'></a>\nThe culprit is `__init_extra__` in sage.categories.magmas, which does:\n\n```\n        def __init_extra__(self):\n            \"\"\"\n                sage: S = Semigroups().example(\"free\")\n                sage: S('a') * S('b') # indirect doctest\n                'ab'\n                sage: S('a').__class__._mul_ == S('a').__class__._mul_parent\n                True\n            \"\"\"\n            # This should instead register the multiplication to the coercion model\n            # But this is not yet implemented in the coercion model\n            if (self.product != self.product_from_element_class_mul) and hasattr(self, \"element_class\") and hasattr(self.element_class, \"_mul_parent\"):\n                self.element_class._mul_ = self.element_class._mul_parent\n```\n\nIn other words, an EXISTING AND PROBABLY OPTIMIZED _mul_ is overridden by some generic slow stuff. So, I have to find out why this line is executed (it shouldn't).",
    "created_at": "2011-11-21T12:28:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168792",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:3'></a>
The culprit is `__init_extra__` in sage.categories.magmas, which does:

```
        def __init_extra__(self):
            """
                sage: S = Semigroups().example("free")
                sage: S('a') * S('b') # indirect doctest
                'ab'
                sage: S('a').__class__._mul_ == S('a').__class__._mul_parent
                True
            """
            # This should instead register the multiplication to the coercion model
            # But this is not yet implemented in the coercion model
            if (self.product != self.product_from_element_class_mul) and hasattr(self, "element_class") and hasattr(self.element_class, "_mul_parent"):
                self.element_class._mul_ = self.element_class._mul_parent
```

In other words, an EXISTING AND PROBABLY OPTIMIZED _mul_ is overridden by some generic slow stuff. So, I have to find out why this line is executed (it shouldn't).



---

archive/issue_comments_168793.json:
```json
{
    "body": "<a id='comment:4'></a>\nAha! It is an actual bug!\n\nNamely, there are different parent methods called `product` defined in sage.categories.magmas: For Magmas, for Cartesian products of magmas, and for subquotients of magmas. Only in the first case is defined `product_from_element_class_mul = product`. So, if we have a quotient of a magma, then ALWAYS we will have `self.product!=self.product_from_element_class_mul`, and thus ALWAYS will the custom `_mul_` of elements be overridden by the generic stuff.\n\nI'm fixing that, and then I can also have the category framework with a proper quotient category for polynomial quotient rings.",
    "created_at": "2011-11-21T12:35:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168793",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:4'></a>
Aha! It is an actual bug!

Namely, there are different parent methods called `product` defined in sage.categories.magmas: For Magmas, for Cartesian products of magmas, and for subquotients of magmas. Only in the first case is defined `product_from_element_class_mul = product`. So, if we have a quotient of a magma, then ALWAYS we will have `self.product!=self.product_from_element_class_mul`, and thus ALWAYS will the custom `_mul_` of elements be overridden by the generic stuff.

I'm fixing that, and then I can also have the category framework with a proper quotient category for polynomial quotient rings.



---

archive/issue_comments_168794.json:
```json
{
    "body": "Attachment [trac_11900-category_singleton-sk.patch](tarball://root/attachments/some-uuid/ticket11900/trac_11900-category_singleton-sk.patch) by @simon-king-jena created at 2011-11-21 15:16:14\n\nImplement `Category_singleton`, cythonise `ConstantFunction`, and use both for most categories. Use categories for polynomial quotient rings",
    "created_at": "2011-11-21T15:16:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168794",
    "user": "https://github.com/simon-king-jena"
}
```

Attachment [trac_11900-category_singleton-sk.patch](tarball://root/attachments/some-uuid/ticket11900/trac_11900-category_singleton-sk.patch) by @simon-king-jena created at 2011-11-21 15:16:14

Implement `Category_singleton`, cythonise `ConstantFunction`, and use both for most categories. Use categories for polynomial quotient rings



---

archive/issue_comments_168795.json:
```json
{
    "body": "<a id='comment:5'></a>\nI have updated my last patch. I added some documentation, including a big fat warning concerning subclasses of subclasses of Category_singleton. In addition, I make sure that using Category_singleton *directly* does not destroy the cache of its subclasses. And I make polynomial quotient rings use categories.\n\nHowever, it is not \"needs review\" yet, because I still have to remove the use of `is_ring` and `is_field`, and also I will eventually produce a combined patch.",
    "created_at": "2011-11-21T15:18:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168795",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:5'></a>
I have updated my last patch. I added some documentation, including a big fat warning concerning subclasses of subclasses of Category_singleton. In addition, I make sure that using Category_singleton *directly* does not destroy the cache of its subclasses. And I make polynomial quotient rings use categories.

However, it is not "needs review" yet, because I still have to remove the use of `is_ring` and `is_field`, and also I will eventually produce a combined patch.



---

archive/issue_comments_168796.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -30,9 +30,4 @@\n However, that's still far from good. After caching join and hom_category, there is still too much time spent (according to %prun) for the initialisation of matrix spaces.\n \n \n-Apply:\n-\n-* [attachment:trac11900_no_categories_for_matrices.patch]\n-* [attachment:trac11900_category_speedup.patch]\n-* [attachment:trac11900_further_tweaks.patch]\n-* [attachment:trac_11900-category_singleton-sk.patch]\n+Apply [attachment:trac11900_category_speedup_combined.patch]\n``````\n",
    "created_at": "2011-11-21T17:01:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168796",
    "user": "https://github.com/simon-king-jena"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -30,9 +30,4 @@
 However, that's still far from good. After caching join and hom_category, there is still too much time spent (according to %prun) for the initialisation of matrix spaces.
 
 
-Apply:
-
-* [attachment:trac11900_no_categories_for_matrices.patch]
-* [attachment:trac11900_category_speedup.patch]
-* [attachment:trac11900_further_tweaks.patch]
-* [attachment:trac_11900-category_singleton-sk.patch]
+Apply [attachment:trac11900_category_speedup_combined.patch]
``````




---

archive/issue_comments_168797.json:
```json
{
    "body": "<a id='comment:6'></a>\nI attached a file that combines the previous patches.\n\nIn addition, it uses `... in _Rings` with `_Rings=Rings()` in many cases. However, I am now running doctests, and I get at least one error because of that. Apparently some ring is initialised as ring, but should better be a commutative ring.\n\nAlso I didn't check that all changes are documented.\n\nSo, still \"needs work\". But perhaps you like to have a look already...\n\nApply trac11900_category_speedup_combined.patch",
    "created_at": "2011-11-21T17:01:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168797",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:6'></a>
I attached a file that combines the previous patches.

In addition, it uses `... in _Rings` with `_Rings=Rings()` in many cases. However, I am now running doctests, and I get at least one error because of that. Apparently some ring is initialised as ring, but should better be a commutative ring.

Also I didn't check that all changes are documented.

So, still "needs work". But perhaps you like to have a look already...

Apply trac11900_category_speedup_combined.patch



---

archive/issue_comments_168798.json:
```json
{
    "body": "<a id='comment:7'></a>\nIt is frustrating. I thought it should all be fine by now, but no: Several errors.\n\nIt used to work fine before I replaced the use of \"is_...\". So, now I am wondering: Should one perhaps use a general mechanism for singletons similar to what I do for fields?\n\nThat's to say, if one has a category \"Category of <name>s\", then it should on the one hand provide a method \"is_<name>\" that constantly returns true, and on the other hand the `__contains__` method should try whether some \"is_<name>\" method exists for the parent, and act accordingly (thus, refine the category of the parent if the parent turns out to be commutative).\n\nJust some random thoughts before leaving the office.. :(",
    "created_at": "2011-11-21T17:10:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168798",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:7'></a>
It is frustrating. I thought it should all be fine by now, but no: Several errors.

It used to work fine before I replaced the use of "is_...". So, now I am wondering: Should one perhaps use a general mechanism for singletons similar to what I do for fields?

That's to say, if one has a category "Category of <name>s", then it should on the one hand provide a method "is_<name>" that constantly returns true, and on the other hand the `__contains__` method should try whether some "is_<name>" method exists for the parent, and act accordingly (thus, refine the category of the parent if the parent turns out to be commutative).

Just some random thoughts before leaving the office.. :(



---

archive/issue_comments_168799.json:
```json
{
    "body": "<a id='comment:8'></a>\nI think the ideas stated in my previous post are too radical.\n\nBut it seems that many of the errors can be fixed by using base classes as one should. For example, both Laurent polynomial and Laurent series rings inherit from `CommutativeRing`, but they only call the `__init__` method of `ParentWithBase`.\n\nI'll see how far this works...",
    "created_at": "2011-11-21T18:46:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168799",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:8'></a>
I think the ideas stated in my previous post are too radical.

But it seems that many of the errors can be fixed by using base classes as one should. For example, both Laurent polynomial and Laurent series rings inherit from `CommutativeRing`, but they only call the `__init__` method of `ParentWithBase`.

I'll see how far this works...



---

archive/issue_comments_168800.json:
```json
{
    "body": "<a id='comment:9'></a>\nThe Weyl groups example is problematic. Reason seems to be that the logic behind \"overriding the custom _mul_ method with generic stuff\" doesn't apply to that example.",
    "created_at": "2011-11-21T21:47:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168800",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:9'></a>
The Weyl groups example is problematic. Reason seems to be that the logic behind "overriding the custom _mul_ method with generic stuff" doesn't apply to that example.



---

archive/issue_comments_168801.json:
```json
{
    "body": "<a id='comment:0'></a>\nI fixed the \"when to override _mul_\" logic.\n\nAlso, I fixed some instances of a very bad phenomenon: There are many parents that inherit from classes such as `sage.rings.ring.Field` or `sage.rings.ring.CommutativeRing` -- but then they only call `ParentWithGens.__init__`!\n\nFor example, consider `CFF.__init__`. Before #9138, we used to have a custom `Field.category()` method, but I think there are only very rare cases in which `CategoryObject.category()` needs to be overridden. Moreover, #9138 made `Field.__init__` initialise the category. But that won't help if we have subclasses of `Field` that are not calling `Field.__init__`. That is so annoying!\n\nAccording to `search_src('ParentWithGens\\.__init__')`, in order to really fix all issues, we'd still have to look at\n\n```\ntensor/differential_forms.py:110:        ParentWithGens.__init__(self, SR, \\\ngroups/group.pyx:55:        sage.structure.parent_gens.ParentWithGens.__init__(self,\nrings/real_mpfi.pyx:451:        ParentWithGens.__init__(self, self, tuple([]), False, category = Fields())\nrings/multi_power_series_ring.py:305:        ParentWithGens.__init__(self, base_ring, name_list)\nrings/complex_field.py:185:        ParentWithGens.__init__(self, self._real_field(), ('I',), False, category = Fields())\nrings/integer_ring.pyx:236:        ParentWithGens.__init__(self, self, ('x',), normalize=False, category = EuclideanDomains())\nrings/complex_mpc.pyx:297:        ParentWithGens.__init__(self, self._real_field(), ('I',), False)\nrings/complex_double.pyx:158:        ParentWithGens.__init__(self, self, ('I',), normalize=False, category = Fields())\nrings/complex_interval_field.py:144:        ParentWithGens.__init__(self, self._real_field(), ('I',), False, category = Fields())\nrings/infinity.py:472:        ParentWithGens.__init__(self, self, names=('oo',), normalize=False)\nrings/infinity.py:783:        ParentWithGens.__init__(self, self, names=('oo',), normalize=False)\nrings/real_mpfr.pyx:308:        ParentWithGens.__init__(self, self, tuple([]), False, category = Fields())\nrings/rational_field.py:213:        ParentWithGens.__init__(self, self, category = QuotientFields())\nrings/number_field/number_field.py:1005:        ParentWithGens.__init__(self, QQ, name, category=category)\ncoding/linear_code.py:706:        ParentWithGens.__init__(self, base_ring)\n```\n\nThis should go on a different ticket, that I am opening in a minute. Here, I'll just fix enough of these cases so that doc tests pass.",
    "created_at": "2011-11-22T07:58:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168801",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:0'></a>
I fixed the "when to override _mul_" logic.

Also, I fixed some instances of a very bad phenomenon: There are many parents that inherit from classes such as `sage.rings.ring.Field` or `sage.rings.ring.CommutativeRing` -- but then they only call `ParentWithGens.__init__`!

For example, consider `CFF.__init__`. Before #9138, we used to have a custom `Field.category()` method, but I think there are only very rare cases in which `CategoryObject.category()` needs to be overridden. Moreover, #9138 made `Field.__init__` initialise the category. But that won't help if we have subclasses of `Field` that are not calling `Field.__init__`. That is so annoying!

According to `search_src('ParentWithGens\.__init__')`, in order to really fix all issues, we'd still have to look at

```
tensor/differential_forms.py:110:        ParentWithGens.__init__(self, SR, \
groups/group.pyx:55:        sage.structure.parent_gens.ParentWithGens.__init__(self,
rings/real_mpfi.pyx:451:        ParentWithGens.__init__(self, self, tuple([]), False, category = Fields())
rings/multi_power_series_ring.py:305:        ParentWithGens.__init__(self, base_ring, name_list)
rings/complex_field.py:185:        ParentWithGens.__init__(self, self._real_field(), ('I',), False, category = Fields())
rings/integer_ring.pyx:236:        ParentWithGens.__init__(self, self, ('x',), normalize=False, category = EuclideanDomains())
rings/complex_mpc.pyx:297:        ParentWithGens.__init__(self, self._real_field(), ('I',), False)
rings/complex_double.pyx:158:        ParentWithGens.__init__(self, self, ('I',), normalize=False, category = Fields())
rings/complex_interval_field.py:144:        ParentWithGens.__init__(self, self._real_field(), ('I',), False, category = Fields())
rings/infinity.py:472:        ParentWithGens.__init__(self, self, names=('oo',), normalize=False)
rings/infinity.py:783:        ParentWithGens.__init__(self, self, names=('oo',), normalize=False)
rings/real_mpfr.pyx:308:        ParentWithGens.__init__(self, self, tuple([]), False, category = Fields())
rings/rational_field.py:213:        ParentWithGens.__init__(self, self, category = QuotientFields())
rings/number_field/number_field.py:1005:        ParentWithGens.__init__(self, QQ, name, category=category)
coding/linear_code.py:706:        ParentWithGens.__init__(self, base_ring)
```

This should go on a different ticket, that I am opening in a minute. Here, I'll just fix enough of these cases so that doc tests pass.



---

archive/issue_comments_168802.json:
```json
{
    "body": "**Changing work_issues** from \"Laurent series rings are fields. Add docs. Don't use is_ring and friends\" to \"Laurent series rings are fields. CFF is a field.\".",
    "created_at": "2011-11-22T07:58:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168802",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing work_issues** from "Laurent series rings are fields. Add docs. Don't use is_ring and friends" to "Laurent series rings are fields. CFF is a field.".



---

archive/issue_comments_168803.json:
```json
{
    "body": "<a id='comment:1'></a>\nThe follow-up ticket will be #12071.",
    "created_at": "2011-11-22T08:06:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168803",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:1'></a>
The follow-up ticket will be #12071.



---

archive/issue_comments_168804.json:
```json
{
    "body": "<a id='comment:2'></a>\nIn your combined patch, it seems you wanted to rename (`hg rename`) constant_function.py to constant_function.pyx but instead you simply deleted `constant_function.py`.\n\nNote that renaming is better than deleting the old file and adding the new file, since renaming is tracked by hg.",
    "created_at": "2011-11-22T08:48:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168804",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>
In your combined patch, it seems you wanted to rename (`hg rename`) constant_function.py to constant_function.pyx but instead you simply deleted `constant_function.py`.

Note that renaming is better than deleting the old file and adding the new file, since renaming is tracked by hg.



---

archive/issue_comments_168805.json:
```json
{
    "body": "<a id='comment:143'></a>\nReplying to [jdemeyer](#comment%3A142):\n> In your combined patch, it seems you wanted to rename (`hg rename`) constant_function.py to constant_function.pyx but instead you simply deleted `constant_function.py`.\n\n\nI didn't. Mercurial did. In fact I had `hg add`ed the pyx file. But later, it somehow disappeared from the patch. Thank you for pointing that out.\n\n> Note that renaming is better than deleting the old file and adding the new file, since renaming is tracked by hg.\n\n\nHow can I rename it *now*? I already did delete the old and add the new file. So, how can I tell mercurial that it should instead rename the old file and incorporate the changes that I also did?",
    "created_at": "2011-11-22T09:25:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168805",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:143'></a>
Replying to [jdemeyer](#comment%3A142):
> In your combined patch, it seems you wanted to rename (`hg rename`) constant_function.py to constant_function.pyx but instead you simply deleted `constant_function.py`.


I didn't. Mercurial did. In fact I had `hg add`ed the pyx file. But later, it somehow disappeared from the patch. Thank you for pointing that out.

> Note that renaming is better than deleting the old file and adding the new file, since renaming is tracked by hg.


How can I rename it *now*? I already did delete the old and add the new file. So, how can I tell mercurial that it should instead rename the old file and incorporate the changes that I also did?



---

archive/issue_comments_168806.json:
```json
{
    "body": "<a id='comment:144'></a>\nReplying to [SimonKing](#comment%3A143):\n> Replying to [jdemeyer](#comment%3A142):\n> > In your combined patch, it seems you wanted to rename (`hg rename`) constant_function.py to constant_function.pyx but instead you simply deleted `constant_function.py`.\n\n> \n> I didn't. Mercurial did. In fact I had `hg add`ed the pyx file. But later, it somehow disappeared from the patch. Thank you for pointing that out.\n\n\nPS: I remember that I had a similar issue in the past. Then someone told me that I had to put things into my .hgrc file that ensure that new files will be part of the patch. Since then it worked - until today.",
    "created_at": "2011-11-22T09:29:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168806",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:144'></a>
Replying to [SimonKing](#comment%3A143):
> Replying to [jdemeyer](#comment%3A142):
> > In your combined patch, it seems you wanted to rename (`hg rename`) constant_function.py to constant_function.pyx but instead you simply deleted `constant_function.py`.

> 
> I didn't. Mercurial did. In fact I had `hg add`ed the pyx file. But later, it somehow disappeared from the patch. Thank you for pointing that out.


PS: I remember that I had a similar issue in the past. Then someone told me that I had to put things into my .hgrc file that ensure that new files will be part of the patch. Since then it worked - until today.



---

archive/issue_comments_168807.json:
```json
{
    "body": "<a id='comment:145'></a>\nReplying to [SimonKing](#comment%3A143):\n> How can I rename it *now*? I already did delete the old and add the new file. So, how can I tell mercurial that it should instead rename the old file and incorporate the changes that I also did?\n\n\nBrute force, but this should do the job:\n\n```\n    hg qpop\n    # edit the patch, and remove all hunks about constant_function.*\n    hg qpush\n    hg mv constant_function.py constant_function.pyx\n```",
    "created_at": "2011-11-22T09:33:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168807",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:145'></a>
Replying to [SimonKing](#comment%3A143):
> How can I rename it *now*? I already did delete the old and add the new file. So, how can I tell mercurial that it should instead rename the old file and incorporate the changes that I also did?


Brute force, but this should do the job:

```
    hg qpop
    # edit the patch, and remove all hunks about constant_function.*
    hg qpush
    hg mv constant_function.py constant_function.pyx
```



---

archive/issue_comments_168808.json:
```json
{
    "body": "<a id='comment:146'></a>\nReplying to [nthiery](#comment%3A145):\n> Replying to [SimonKing](#comment%3A143):\n> Brute force, but this should do the job:\n\n\nYep. Meanwhile I managed to fix it as well, with brute force. Submitting a hopefully final patch version in a few minutes.",
    "created_at": "2011-11-22T09:41:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168808",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:146'></a>
Replying to [nthiery](#comment%3A145):
> Replying to [SimonKing](#comment%3A143):
> Brute force, but this should do the job:


Yep. Meanwhile I managed to fix it as well, with brute force. Submitting a hopefully final patch version in a few minutes.



---

archive/issue_comments_168809.json:
```json
{
    "body": "<a id='comment:7'></a>\nSorry, it takes a bit longer. I had forgotten to add some doc tests.\n\nNicolas, there is one change we talked about in Paris: The new `_category_for_hom` (which factors out the algorithm used inside the `Hom` function) is not using `_meet_`, but could use it. IIRC, you made such change, right? So, I should do as well.",
    "created_at": "2011-11-22T10:29:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168809",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:7'></a>
Sorry, it takes a bit longer. I had forgotten to add some doc tests.

Nicolas, there is one change we talked about in Paris: The new `_category_for_hom` (which factors out the algorithm used inside the `Hom` function) is not using `_meet_`, but could use it. IIRC, you made such change, right? So, I should do as well.



---

archive/issue_comments_168810.json:
```json
{
    "body": "Attachment [trac_11900-review-nt.patch](tarball://root/attachments/some-uuid/ticket11900/trac_11900-review-nt.patch) by @nthiery created at 2011-11-22 10:35:48\n\nSimplification and refactorization of the logic in hom + typos",
    "created_at": "2011-11-22T10:35:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168810",
    "user": "https://github.com/nthiery"
}
```

Attachment [trac_11900-review-nt.patch](tarball://root/attachments/some-uuid/ticket11900/trac_11900-review-nt.patch) by @nthiery created at 2011-11-22 10:35:48

Simplification and refactorization of the logic in hom + typos



---

archive/issue_comments_168811.json:
```json
{
    "body": "<a id='comment:148'></a>\nReplying to [SimonKing](#comment%3A147):\n> Nicolas, there is one change we talked about in Paris: The new `_category_for_hom` (which factors out the algorithm used inside the `Hom` function) is not using `_meet_`, but could use it. IIRC, you made such change, right? So, I should do as well.\n\n\nIndeed; sorry, I should have posted the patch here since we did not get to work with the Sage-Combinat queue. Please merge it in your patch as you feel appropriate.",
    "created_at": "2011-11-22T10:37:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168811",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:148'></a>
Replying to [SimonKing](#comment%3A147):
> Nicolas, there is one change we talked about in Paris: The new `_category_for_hom` (which factors out the algorithm used inside the `Hom` function) is not using `_meet_`, but could use it. IIRC, you made such change, right? So, I should do as well.


Indeed; sorry, I should have posted the patch here since we did not get to work with the Sage-Combinat queue. Please merge it in your patch as you feel appropriate.



---

archive/issue_comments_168812.json:
```json
{
    "body": "<a id='comment:149'></a>\nReplying to [nthiery](#comment%3A148):\n> Indeed; sorry, I should have posted the patch here since we did not get to work with the Sage-Combinat queue. Please merge it in your patch as you feel appropriate.\n\n\nMeanwhile I wonder whether that change shouldn't better be put on a different ticket. Namely, using the meet instead of the current algorithm (recall: The algorithm used in _category_for_hom was used before, I merely factored it out) actually would change things.\n\nNamely, the meet may return a join category. But the current algorithm for determining the category for a homset will not return a join category, unless the categories of both parents coincide.\n\nExample:\n\n```\nsage: Algebras(QQ)._meet_(Category.join([Fields(), ModulesWithBasis(QQ)]))\nJoin of Category of rings and Category of vector spaces over Rational Field\nsage: PA = Parent(category=Algebras(QQ))\nsage: PJ = Parent(category=Category.join([Fields(), ModulesWithBasis(QQ)]))\nsage: H = Hom(PA,PJ); H\nSet of Homomorphisms from <type 'sage.structure.parent.Parent'> to <type 'sage.structure.parent.Parent'>\nsage: H.category()\nCategory of hom sets in Category of rings\nsage: H.category().base_category\nCategory of rings\n```\n\nUsing the meet would be a non-trivial change that probably has little to do with a speedup. So, better move it to another ticket, isn't it?",
    "created_at": "2011-11-22T10:57:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168812",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:149'></a>
Replying to [nthiery](#comment%3A148):
> Indeed; sorry, I should have posted the patch here since we did not get to work with the Sage-Combinat queue. Please merge it in your patch as you feel appropriate.


Meanwhile I wonder whether that change shouldn't better be put on a different ticket. Namely, using the meet instead of the current algorithm (recall: The algorithm used in _category_for_hom was used before, I merely factored it out) actually would change things.

Namely, the meet may return a join category. But the current algorithm for determining the category for a homset will not return a join category, unless the categories of both parents coincide.

Example:

```
sage: Algebras(QQ)._meet_(Category.join([Fields(), ModulesWithBasis(QQ)]))
Join of Category of rings and Category of vector spaces over Rational Field
sage: PA = Parent(category=Algebras(QQ))
sage: PJ = Parent(category=Category.join([Fields(), ModulesWithBasis(QQ)]))
sage: H = Hom(PA,PJ); H
Set of Homomorphisms from <type 'sage.structure.parent.Parent'> to <type 'sage.structure.parent.Parent'>
sage: H.category()
Category of hom sets in Category of rings
sage: H.category().base_category
Category of rings
```

Using the meet would be a non-trivial change that probably has little to do with a speedup. So, better move it to another ticket, isn't it?



---

archive/issue_comments_168813.json:
```json
{
    "body": "<a id='comment:150'></a>\nReplying to [SimonKing](#comment%3A149):\n> Using the meet would be a non-trivial change that probably has little to do with a speedup. So, better move it to another ticket, isn't it? \n\n\nIt's indeed a bug fix; so feel free to postpone it. Maybe in that case your factoring out could be postponned as well to that same ticket, to keep related changes together?",
    "created_at": "2011-11-22T11:05:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168813",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:150'></a>
Replying to [SimonKing](#comment%3A149):
> Using the meet would be a non-trivial change that probably has little to do with a speedup. So, better move it to another ticket, isn't it? 


It's indeed a bug fix; so feel free to postpone it. Maybe in that case your factoring out could be postponned as well to that same ticket, to keep related changes together?



---

archive/issue_comments_168814.json:
```json
{
    "body": "<a id='comment:151'></a>\nReplying to [nthiery](#comment%3A150):\n> Replying to [SimonKing](#comment%3A149):\n> It's indeed a bug fix; so feel free to postpone it. Maybe in that case your factoring out could be postponned as well to that same ticket, to keep related changes together?\n\n\nI am not so sure. If I remember correctly, factoring out and using cached method on it does provide a speed-up, and so does contribute to the purpose of this ticket.\n\nI'll test after lunch whether I can show the speed-up in a more or less realistic example.",
    "created_at": "2011-11-22T11:10:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168814",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:151'></a>
Replying to [nthiery](#comment%3A150):
> Replying to [SimonKing](#comment%3A149):
> It's indeed a bug fix; so feel free to postpone it. Maybe in that case your factoring out could be postponned as well to that same ticket, to keep related changes together?


I am not so sure. If I remember correctly, factoring out and using cached method on it does provide a speed-up, and so does contribute to the purpose of this ticket.

I'll test after lunch whether I can show the speed-up in a more or less realistic example.



---

archive/issue_comments_168815.json:
```json
{
    "body": "<a id='comment:2'></a>\nI tried to construct an example, but to my surprise I found no benefit, except of course that factoring the code out should be considered a clearer code.\n\nI am now trying whether using the meet (and caching the meet) helps.",
    "created_at": "2011-11-22T11:53:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168815",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:2'></a>
I tried to construct an example, but to my surprise I found no benefit, except of course that factoring the code out should be considered a clearer code.

I am now trying whether using the meet (and caching the meet) helps.



---

archive/issue_comments_168816.json:
```json
{
    "body": "<a id='comment:153'></a>\nReplying to [SimonKing](#comment%3A152):\n> I am now trying whether using the meet (and caching the meet) helps.\n\n\nIt seems that it doesn't make things faster.\n\nAnyway. I am now running doctests for the version that uses the meet. If there are non-trivial errors then I'll postpone it. Otherwise, I'll include it in the patch here.",
    "created_at": "2011-11-22T12:21:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168816",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:153'></a>
Replying to [SimonKing](#comment%3A152):
> I am now trying whether using the meet (and caching the meet) helps.


It seems that it doesn't make things faster.

Anyway. I am now running doctests for the version that uses the meet. If there are non-trivial errors then I'll postpone it. Otherwise, I'll include it in the patch here.



---

archive/issue_comments_168817.json:
```json
{
    "body": "<a id='comment:154'></a>\nReplying to [nthiery](#comment%3A148):\n> Indeed; sorry, I should have posted the patch here since we did not get to work with the Sage-Combinat queue. Please merge it in your patch as you feel appropriate.\n\n\nToo bad. I did not realise that you had actually posted a patch. I made some of your changes myself, and now I have a hard time to merge your patch into mine.",
    "created_at": "2011-11-22T15:09:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168817",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:154'></a>
Replying to [nthiery](#comment%3A148):
> Indeed; sorry, I should have posted the patch here since we did not get to work with the Sage-Combinat queue. Please merge it in your patch as you feel appropriate.


Too bad. I did not realise that you had actually posted a patch. I made some of your changes myself, and now I have a hard time to merge your patch into mine.



---

archive/issue_comments_168818.json:
```json
{
    "body": "<a id='comment:5'></a>\nReport on merging your reviewer patch:\n\n* Using your changes in category.py, in particular caching of _meet_ and using a short patch in the case that the `self.is_subcategory(other)`.\n* If we use the _meet_ in sage/categories/homset.py then technically the algorithm already is factored out. So, I won't have a new function `_category_for_homset` anymore.\n* I am using your changes in finite_field_prime_modn.py.\n\nI will post a combined patch in a few minutes.",
    "created_at": "2011-11-22T15:17:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168818",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:5'></a>
Report on merging your reviewer patch:

* Using your changes in category.py, in particular caching of _meet_ and using a short patch in the case that the `self.is_subcategory(other)`.
* If we use the _meet_ in sage/categories/homset.py then technically the algorithm already is factored out. So, I won't have a new function `_category_for_homset` anymore.
* I am using your changes in finite_field_prime_modn.py.

I will post a combined patch in a few minutes.



---

archive/issue_comments_168819.json:
```json
{
    "body": "**Changing author** from \"Simon King\" to \"Simon King, Nicolas M. Thi\u00e9ry\".",
    "created_at": "2011-11-22T15:25:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168819",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing author** from "Simon King" to "Simon King, Nicolas M. Thiéry".



---

archive/issue_comments_168820.json:
```json
{
    "body": "<a id='comment:6'></a>\nFinally I have posted a combined patch that also includes the recent ideas on _meet_, adds several doctests and fixes some of the missing calls to `__init__` of base classes I was mentioning.\n\nIt also comprises Nicolas' review patch, with the only exception that I am now not using a separate function for computing the category of a homset.\n\nIf I see that correctly, all new stuff is backed up by doc tests. I did a complete test *without* using the review patch. I'm testing the latest patch version now, but I think it is \"needs review\"!\n\nI think Nicolas is an author as well: He provided the original implementation of Category_singleton.\n\nApply trac11900_category_speedup_combined.patch",
    "created_at": "2011-11-22T15:25:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168820",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:6'></a>
Finally I have posted a combined patch that also includes the recent ideas on _meet_, adds several doctests and fixes some of the missing calls to `__init__` of base classes I was mentioning.

It also comprises Nicolas' review patch, with the only exception that I am now not using a separate function for computing the category of a homset.

If I see that correctly, all new stuff is backed up by doc tests. I did a complete test *without* using the review patch. I'm testing the latest patch version now, but I think it is "needs review"!

I think Nicolas is an author as well: He provided the original implementation of Category_singleton.

Apply trac11900_category_speedup_combined.patch



---

archive/issue_comments_168821.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2011-11-22T15:25:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168821",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_168822.json:
```json
{
    "body": "**Changing work_issues** from \"Laurent series rings are fields. CFF is a field.\" to \"\".",
    "created_at": "2011-11-22T15:25:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168822",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing work_issues** from "Laurent series rings are fields. CFF is a field." to "".



---

archive/issue_comments_168823.json:
```json
{
    "body": "<a id='comment:7'></a>\n`sage -testall -long` has almost been successful: I got one rather trivial error.\n\n```\nFile \"/mnt/local/king/SAGE/stable/sage-4.7.2/devel/sage/sage/rings/residue_field\n.pyx\", line 422:\n    sage: F.category()\nExpected:\n    Category of finite fields\nGot:\n    Join of Category of subquotients of monoids and Category of quotients of semigroups and Category of finite fields\n```\n\nCould this perhaps be taken care of in a reviewer patch? Or perhaps I'll fix it tomorrow morning",
    "created_at": "2011-11-22T21:32:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168823",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:7'></a>
`sage -testall -long` has almost been successful: I got one rather trivial error.

```
File "/mnt/local/king/SAGE/stable/sage-4.7.2/devel/sage/sage/rings/residue_field
.pyx", line 422:
    sage: F.category()
Expected:
    Category of finite fields
Got:
    Join of Category of subquotients of monoids and Category of quotients of semigroups and Category of finite fields
```

Could this perhaps be taken care of in a reviewer patch? Or perhaps I'll fix it tomorrow morning



---

archive/issue_comments_168824.json:
```json
{
    "body": "<a id='comment:158'></a>\nReplying to [SimonKing](#comment%3A157):\n> `sage -testall -long` has almost been successful: I got one rather trivial error.\n\n\nAnd even better: That test defines two residue fields F and k. For both, it skips two tests from the `TestSuite` (\"_test_elements\" and \"_test_pickling\"). But actually the whole test suite is fine now!",
    "created_at": "2011-11-22T21:52:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168824",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:158'></a>
Replying to [SimonKing](#comment%3A157):
> `sage -testall -long` has almost been successful: I got one rather trivial error.


And even better: That test defines two residue fields F and k. For both, it skips two tests from the `TestSuite` ("_test_elements" and "_test_pickling"). But actually the whole test suite is fine now!



---

archive/issue_comments_168825.json:
```json
{
    "body": "<a id='comment:9'></a>\nI have updated the patch. It now includes the doctest fixes for the residue fields, and in particular it runs the full test suite for residue fields now.\n\nOne question, though: The residue field example comprises two different kind of residue fields. The category of the first (called k in the example) is just `Fields()`. The category of the other is the more complicated one, with quotients etc. It could be a good idea to see why that happens. But not here...\n\nApply trac11900_category_speedup_combined.patch",
    "created_at": "2011-11-23T07:13:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168825",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:9'></a>
I have updated the patch. It now includes the doctest fixes for the residue fields, and in particular it runs the full test suite for residue fields now.

One question, though: The residue field example comprises two different kind of residue fields. The category of the first (called k in the example) is just `Fields()`. The category of the other is the more complicated one, with quotients etc. It could be a good idea to see why that happens. But not here...

Apply trac11900_category_speedup_combined.patch



---

archive/issue_comments_168826.json:
```json
{
    "body": "<a id='comment:160'></a>\nReplying to [SimonKing](#comment%3A159):\n> I have updated the patch. It now includes the doctest fixes for the residue fields, and in particular it runs the full test suite for residue fields now.\n> \n> One question, though: The residue field example comprises two different kind of residue fields. The category of the first (called k in the example) is just `Fields()`. The category of the other is the more complicated one, with quotients etc. It could be a good idea to see why that happens. But not here...\n> \n> Apply trac11900_category_speedup_combined.patch \n\n\nThanks for all your work! It sounds good from your description. I'll try to review the patch by the end of this week.\n\nAh sorry, one more thing I should have though about earlier: all the Finite* categories will be refactored in the upcoming 10963, where will inherit from something else. To avoid a lot of trivial rebasing, do you mind if we postpone their singletonification to that later ticket?\n\nIf you agree, let me know if you prefer to strip those hunks out of the patch yourself, or let me do it.\n\nCheers,\n                        Nicolas",
    "created_at": "2011-11-23T09:10:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168826",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:160'></a>
Replying to [SimonKing](#comment%3A159):
> I have updated the patch. It now includes the doctest fixes for the residue fields, and in particular it runs the full test suite for residue fields now.
> 
> One question, though: The residue field example comprises two different kind of residue fields. The category of the first (called k in the example) is just `Fields()`. The category of the other is the more complicated one, with quotients etc. It could be a good idea to see why that happens. But not here...
> 
> Apply trac11900_category_speedup_combined.patch 


Thanks for all your work! It sounds good from your description. I'll try to review the patch by the end of this week.

Ah sorry, one more thing I should have though about earlier: all the Finite* categories will be refactored in the upcoming 10963, where will inherit from something else. To avoid a lot of trivial rebasing, do you mind if we postpone their singletonification to that later ticket?

If you agree, let me know if you prefer to strip those hunks out of the patch yourself, or let me do it.

Cheers,
                        Nicolas



---

archive/issue_comments_168827.json:
```json
{
    "body": "<a id='comment:161'></a>\nReplying to [SimonKing](#comment%3A156):\n\n> I think Nicolas is an author as well: He provided the original implementation of Category_singleton.\n\n\nWell, you really did 95% of the work and I would like you to be credited accordingly. If that was a research paper, I would be at best in the acknowledgement section. I suggest instead to:\n\n* Add myself as an author in Category_singleton.pyx (so that I take the blames for what's broken in there) in my reviewer patch.\n* Remove myself from the author list for this ticket.\n\nCheers,\n\n  Nicolas",
    "created_at": "2011-11-23T09:16:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168827",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:161'></a>
Replying to [SimonKing](#comment%3A156):

> I think Nicolas is an author as well: He provided the original implementation of Category_singleton.


Well, you really did 95% of the work and I would like you to be credited accordingly. If that was a research paper, I would be at best in the acknowledgement section. I suggest instead to:

* Add myself as an author in Category_singleton.pyx (so that I take the blames for what's broken in there) in my reviewer patch.
* Remove myself from the author list for this ticket.

Cheers,

  Nicolas



---

archive/issue_comments_168828.json:
```json
{
    "body": "<a id='comment:162'></a>\nReplying to [nthiery](#comment%3A161):\n>  * Add myself as an author in Category_singleton.pyx\n\n\nIndeed. There, my only contribution was to add some documentation and raise an error that makes Category_singleton safer to use.\n\nOK. But I thinkt this should really be a reviewer patch. Please make sure that you start with the most recent version of my patch -- the version that already includes most of what you did in the \"review-nt\" patch.\n\nAnd I wouldn't mind to have the \"`FiniteBla`\" stuff be usual categories for now, even though eventually they shall be singletons as well.\n\nI am looking forward to your reviewer patch and will now focus on rebasing #11943 and #11935.",
    "created_at": "2011-11-23T09:37:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168828",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:162'></a>
Replying to [nthiery](#comment%3A161):
>  * Add myself as an author in Category_singleton.pyx


Indeed. There, my only contribution was to add some documentation and raise an error that makes Category_singleton safer to use.

OK. But I thinkt this should really be a reviewer patch. Please make sure that you start with the most recent version of my patch -- the version that already includes most of what you did in the "review-nt" patch.

And I wouldn't mind to have the "`FiniteBla`" stuff be usual categories for now, even though eventually they shall be singletons as well.

I am looking forward to your reviewer patch and will now focus on rebasing #11943 and #11935.



---

archive/issue_comments_168829.json:
```json
{
    "body": "<a id='comment:3'></a>\nI have been through the patch, and have a *preliminary* reviewer patch which I am about to upload. There are still a couple things I'd like to do before posting my final reviewer patch:\n\n- Avoid introducing new EXAMPLE instead of EXAMPLES\n\n- use check=True/False instead of category_checked=False/True, for consistency with other similar use cases in Sage\n\n  (please argue if you prefer check_category rather than just check)\n\n- Look again at is_Field, and in particular document the behaviour\n\n- Finish removing some duplication in the __init__ method of Ring/...\n\n- Revert the changes to the FiniteCategories (if that's alright with you, this will be done by stripping the combined patch, rather than undoing the changes in the reviewer patch)\n\n- I forgot what we had discussed about CartesianProducts.base: whether we should drop this method for the time being, or keep it.\n\nBy the way: I am not keen on calling one() in the initialization, as\ncalculating one() may be very costly. In general, in our former\nexperience with MuPAD-Combinat and Sage, creating elements (with\nan_element, ...) early in the initialization has been a repeated\nsource of problems. When it is about sanity check, this can be\npostponed to the TestSuite.\n\nHowever, this ticket contains a lot of urgent and good stuff, and get\nsoon into Sage, so this comment is for a later ticket.\n\nI created another followup ticket: #12099",
    "created_at": "2011-11-30T07:11:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168829",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:3'></a>
I have been through the patch, and have a *preliminary* reviewer patch which I am about to upload. There are still a couple things I'd like to do before posting my final reviewer patch:

- Avoid introducing new EXAMPLE instead of EXAMPLES

- use check=True/False instead of category_checked=False/True, for consistency with other similar use cases in Sage

  (please argue if you prefer check_category rather than just check)

- Look again at is_Field, and in particular document the behaviour

- Finish removing some duplication in the __init__ method of Ring/...

- Revert the changes to the FiniteCategories (if that's alright with you, this will be done by stripping the combined patch, rather than undoing the changes in the reviewer patch)

- I forgot what we had discussed about CartesianProducts.base: whether we should drop this method for the time being, or keep it.

By the way: I am not keen on calling one() in the initialization, as
calculating one() may be very costly. In general, in our former
experience with MuPAD-Combinat and Sage, creating elements (with
an_element, ...) early in the initialization has been a repeated
source of problems. When it is about sanity check, this can be
postponed to the TestSuite.

However, this ticket contains a lot of urgent and good stuff, and get
soon into Sage, so this comment is for a later ticket.

I created another followup ticket: #12099



---

archive/issue_comments_168830.json:
```json
{
    "body": "<a id='comment:4'></a>\nHi Nicolas,\n\nDo I understand correctly that you plan to do these things in your final reviewer patch? Or do you ask me to do the changes?\n\nBest regards,\nSimon",
    "created_at": "2011-11-30T10:12:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168830",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:4'></a>
Hi Nicolas,

Do I understand correctly that you plan to do these things in your final reviewer patch? Or do you ask me to do the changes?

Best regards,
Simon



---

archive/issue_comments_168831.json:
```json
{
    "body": "<a id='comment:165'></a>\nReplying to [SimonKing](#comment%3A164):\n> Do I understand correctly that you plan to do these things in your final reviewer patch? \n\n\nIndeed!",
    "created_at": "2011-11-30T13:45:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168831",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:165'></a>
Replying to [SimonKing](#comment%3A164):
> Do I understand correctly that you plan to do these things in your final reviewer patch? 


Indeed!



---

archive/issue_comments_168832.json:
```json
{
    "body": "<a id='comment:6'></a>\nHi!\n\nI am almost done (updated patch attached; please look at what I did for the __init__ in IntegralDomain and subclasses). However, I have a problem: with sage 4.8.alpha2 on Ubuntu Oneiric, with the two patches:\n\n```\n9138_flat.patch\ntrac11900_category_speedup_combined.patch\n```\nI am getting a lot of segmentation faults that I don't get without those patches. See the attached log (not: it is actually the log with my patch on top, but I am getting at least the same segfault in sage.structure.element without my patch; I'll post an updated log tomorrow morning).\n\nAny clues?",
    "created_at": "2011-12-03T00:32:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168832",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:6'></a>
Hi!

I am almost done (updated patch attached; please look at what I did for the __init__ in IntegralDomain and subclasses). However, I have a problem: with sage 4.8.alpha2 on Ubuntu Oneiric, with the two patches:

```
9138_flat.patch
trac11900_category_speedup_combined.patch
```
I am getting a lot of segmentation faults that I don't get without those patches. See the attached log (not: it is actually the log with my patch on top, but I am getting at least the same segfault in sage.structure.element without my patch; I'll post an updated log tomorrow morning).

Any clues?



---

archive/issue_comments_168833.json:
```json
{
    "body": "Attachment [trac11900-review-nt.patch](tarball://root/attachments/some-uuid/ticket11900/trac11900-review-nt.patch) by @nthiery created at 2011-12-03 00:33:39",
    "created_at": "2011-12-03T00:33:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168833",
    "user": "https://github.com/nthiery"
}
```

Attachment [trac11900-review-nt.patch](tarball://root/attachments/some-uuid/ticket11900/trac11900-review-nt.patch) by @nthiery created at 2011-12-03 00:33:39



---

archive/issue_comments_168834.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2011-12-03T10:03:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168834",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_168835.json:
```json
{
    "body": "**Work_Issues:** Segmentation faults",
    "created_at": "2011-12-03T10:03:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168835",
    "user": "https://github.com/simon-king-jena"
}
```

**Work_Issues:** Segmentation faults



---

archive/issue_comments_168836.json:
```json
{
    "body": "<a id='comment:7'></a>\nThe segmentation faults seem indeed related with the patches from here: Category_singleton is mentioned in the errors. Since I don't get the errors with sage-4.7.2 and IIRC also not with sage-4.8.alpha0, I a afraid I have to install yet another alpha version...",
    "created_at": "2011-12-03T10:03:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168836",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:7'></a>
The segmentation faults seem indeed related with the patches from here: Category_singleton is mentioned in the errors. Since I don't get the errors with sage-4.7.2 and IIRC also not with sage-4.8.alpha0, I a afraid I have to install yet another alpha version...



---

archive/issue_comments_168837.json:
```json
{
    "body": "<a id='comment:8'></a>\nWe need a rebase anyway: One hunk in matrix_space.py fails with sage-4.8.alpha3 (I guess this is because of a blocker for sage-4.8 that has recently been merged).",
    "created_at": "2011-12-03T15:31:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168837",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:8'></a>
We need a rebase anyway: One hunk in matrix_space.py fails with sage-4.8.alpha3 (I guess this is because of a blocker for sage-4.8 that has recently been merged).



---

archive/issue_comments_168838.json:
```json
{
    "body": "<a id='comment:9'></a>\nNo, it wasn't the blocker, it is the M4RIE ticket #9562.",
    "created_at": "2011-12-03T15:35:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168838",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:9'></a>
No, it wasn't the blocker, it is the M4RIE ticket #9562.



---

archive/issue_comments_168839.json:
```json
{
    "body": "Test failures with 4.8 alpha2 with the combined patch (but not my reviewer's patch) and dependency",
    "created_at": "2011-12-03T16:15:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168839",
    "user": "https://github.com/nthiery"
}
```

Test failures with 4.8 alpha2 with the combined patch (but not my reviewer's patch) and dependency



---

archive/issue_comments_168840.json:
```json
{
    "body": "<a id='comment:0'></a>\nAttachment [testlog](tarball://root/attachments/some-uuid/ticket11900/testlog) by @simon-king-jena created at 2011-12-03 16:15:29\n\nNicolas, could you try again with sage-4.8.alpha3?\n\nNamely, I get\n\n```\n$ ../../sage -t sage/structure/element.pyx                                                    sage -t  \"devel/sage-main/sage/structure/element.pyx\"\n         [5.4 s]\n\n----------------------------------------------------------------------\nAll tests passed!\nTotal time for all tests: 5.5 seconds\n```\nwith\n\n```\nking@mpc622:/mnt/local/king/SAGE/rebase/sage-4.8.alpha3/devel/sage$ hg qapplied\n9138_flat.patch\ntrac11900_category_speedup_combined.patch\n```",
    "created_at": "2011-12-03T16:15:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168840",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:0'></a>
Attachment [testlog](tarball://root/attachments/some-uuid/ticket11900/testlog) by @simon-king-jena created at 2011-12-03 16:15:29

Nicolas, could you try again with sage-4.8.alpha3?

Namely, I get

```
$ ../../sage -t sage/structure/element.pyx                                                    sage -t  "devel/sage-main/sage/structure/element.pyx"
         [5.4 s]

----------------------------------------------------------------------
All tests passed!
Total time for all tests: 5.5 seconds
```
with

```
king@mpc622:/mnt/local/king/SAGE/rebase/sage-4.8.alpha3/devel/sage$ hg qapplied
9138_flat.patch
trac11900_category_speedup_combined.patch
```



---

archive/issue_comments_168841.json:
```json
{
    "body": "<a id='comment:1'></a>\nAlso when having applied your patch as well, at least one of the tests in which you have observed a segfault works fine:\n\n```\nking@mpc622:/mnt/local/king/SAGE/rebase/sage-4.8.alpha3/devel/sage$ ../../sage -t sage/structure/element.pyx\nsage -t  \"devel/sage-main/sage/structure/element.pyx\"\n         [3.5 s]\n\n----------------------------------------------------------------------\nAll tests passed!\nTotal time for all tests: 3.5 seconds\n```\n\nActually note that with your patch it is only 3.5 seconds, while with my patch it is only 5.5 seconds.\n\nI am now running all long tests. I have read your patch, and it looks very reasonable. I'd appreciate if you could re-run the tests with sage-4.8.alpha3.",
    "created_at": "2011-12-03T16:28:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168841",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:1'></a>
Also when having applied your patch as well, at least one of the tests in which you have observed a segfault works fine:

```
king@mpc622:/mnt/local/king/SAGE/rebase/sage-4.8.alpha3/devel/sage$ ../../sage -t sage/structure/element.pyx
sage -t  "devel/sage-main/sage/structure/element.pyx"
         [3.5 s]

----------------------------------------------------------------------
All tests passed!
Total time for all tests: 3.5 seconds
```

Actually note that with your patch it is only 3.5 seconds, while with my patch it is only 5.5 seconds.

I am now running all long tests. I have read your patch, and it looks very reasonable. I'd appreciate if you could re-run the tests with sage-4.8.alpha3.



---

archive/issue_comments_168842.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2011-12-03T16:28:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168842",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_168843.json:
```json
{
    "body": "<a id='comment:2'></a>\nOk, I'll download and compile alpha3 now. Answer late tonight ...\n\nFor information, I ran the test with -verbose on my machine, and the segfault can be triggered with\n\n```\n    sage: vector([])\n```",
    "created_at": "2011-12-03T17:13:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168843",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:2'></a>
Ok, I'll download and compile alpha3 now. Answer late tonight ...

For information, I ran the test with -verbose on my machine, and the segfault can be triggered with

```
    sage: vector([])
```



---

archive/issue_comments_168844.json:
```json
{
    "body": "<a id='comment:173'></a>\nReplying to [nthiery](#comment%3A172):\n> For information, I ran the test with -verbose on my machine, and the segfault can be triggered with\n>     sage: vector([])\n\n\nThen it's fixed with alpha3:\n\n```\nking@mpc622:/mnt/local/king/SAGE/rebase/sage-4.8.alpha3$ ./sage\n----------------------------------------------------------------------\n----------------------------------------------------------------------\n**********************************************************************\n*                                                                    *\n* Warning: this is a prerelease version, and it may be unstable.     *\n*                                                                    *\n**********************************************************************\nsage: vector([])\n()\n```\nwith #9138 and the two patches from here applied.\n| Sage Version 4.8.alpha3, Release Date: 2011-12-02                  |\n| Type notebook() for the GUI, and license() for information.        |\n\nI guess one should try to find out what ticket has changed the relevant bits in the vector creation, and list it as dependency.",
    "created_at": "2011-12-03T17:24:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168844",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:173'></a>
Replying to [nthiery](#comment%3A172):
> For information, I ran the test with -verbose on my machine, and the segfault can be triggered with
>     sage: vector([])


Then it's fixed with alpha3:

```
king@mpc622:/mnt/local/king/SAGE/rebase/sage-4.8.alpha3$ ./sage
----------------------------------------------------------------------
----------------------------------------------------------------------
**********************************************************************
*                                                                    *
* Warning: this is a prerelease version, and it may be unstable.     *
*                                                                    *
**********************************************************************
sage: vector([])
()
```
with #9138 and the two patches from here applied.
| Sage Version 4.8.alpha3, Release Date: 2011-12-02                  |
| Type notebook() for the GUI, and license() for information.        |

I guess one should try to find out what ticket has changed the relevant bits in the vector creation, and list it as dependency.



---

archive/issue_comments_168845.json:
```json
{
    "body": "<a id='comment:4'></a>\nWith the setting described in my previous post, I get\n\n```\n$ ./sage -testall -long\n...\nThe following tests failed:\n\n\n        sage -t  -long -force_lib \"devel/sage/sage/misc/constant_function.pyx\"\n        sage -t  -long -force_lib \"devel/sage/sage/categories/vector_spaces.py\"\nTotal time for all tests: 7980.3 seconds\n```\n\nThat seems doable. I will try to solve it, update my patch probably tomorrow (needs to be rebased anyway), and then it will hopefully be solved.",
    "created_at": "2011-12-03T20:37:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168845",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:4'></a>
With the setting described in my previous post, I get

```
$ ./sage -testall -long
...
The following tests failed:


        sage -t  -long -force_lib "devel/sage/sage/misc/constant_function.pyx"
        sage -t  -long -force_lib "devel/sage/sage/categories/vector_spaces.py"
Total time for all tests: 7980.3 seconds
```

That seems doable. I will try to solve it, update my patch probably tomorrow (needs to be rebased anyway), and then it will hopefully be solved.



---

archive/issue_comments_168846.json:
```json
{
    "body": "**Changing work_issues** from \"Segmentation faults\" to \"Doctest errors, rebase rel #9562\".",
    "created_at": "2011-12-03T20:37:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168846",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing work_issues** from "Segmentation faults" to "Doctest errors, rebase rel #9562".



---

archive/issue_comments_168847.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2011-12-03T20:37:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168847",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_168848.json:
```json
{
    "body": "**Changing work_issues** from \"Doctest errors, rebase rel #9562\" to \"Rebase first patch rel #9562; update reviewer patch\".",
    "created_at": "2011-12-03T20:57:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168848",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing work_issues** from "Doctest errors, rebase rel #9562" to "Rebase first patch rel #9562; update reviewer patch".



---

archive/issue_comments_168849.json:
```json
{
    "body": "<a id='comment:5'></a>\nBoth our patches need to be change. Namely, I need to rebase mine because of #9562 and you need to modify yours, because it introduces the two errors that I indicated in the previous post.\n\nFirst error: By my patch, `_value` is a cdef attribute of constant functions, thus, one can not access it in a doc test. Therefore, I had changed the corresponding doctest. But your patch re-introduces that test.\n\nSo, please remove the hunk\n\n```\ndiff --git a/sage/misc/constant_function.pyx b/sage/misc/constant_function.pyx\n--- a/sage/misc/constant_function.pyx\n+++ b/sage/misc/constant_function.pyx\n@@ -64,7 +64,7 @@ cdef class ConstantFunction(SageObject):\n         \"\"\"\n         EXAMPLES::\n\n-            sage: ConstantFunction(1)()\n+            sage: ConstantFunction(1)._value\n             1\n         \"\"\"\n         self._value = value\n```\nfrom your patch.\n\nSecond error: There is one error message saying \"base ring must be a field.\" But your reviewer patch changes one example, so that the same error message is expected *without* the dot in the end.\n\nI am talking about the hunk\n\n```\ndiff --git a/sage/categories/vector_spaces.py b/sage/categories/vector_spaces.py\n--- a/sage/categories/vector_spaces.py\n+++ b/sage/categories/vector_spaces.py\n@@ -32,36 +32,33 @@ class VectorSpaces(Category_module):\n...\n...\n             sage: VectorSpaces(ZZ)\n             Traceback (most recent call last):\n             ...\n-            AssertionError: The base ring must be a field.\n+            AssertionError: The base ring must be a field\n\n+        With ``check=False``, the check is disabled, possibly enabling\n+        incorrect inputs::\n+\n+            sage: VectorSpaces(ZZ, check=False)\n+            Category of vector spaces over Integer Ring\n```",
    "created_at": "2011-12-03T20:57:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168849",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:5'></a>
Both our patches need to be change. Namely, I need to rebase mine because of #9562 and you need to modify yours, because it introduces the two errors that I indicated in the previous post.

First error: By my patch, `_value` is a cdef attribute of constant functions, thus, one can not access it in a doc test. Therefore, I had changed the corresponding doctest. But your patch re-introduces that test.

So, please remove the hunk

```
diff --git a/sage/misc/constant_function.pyx b/sage/misc/constant_function.pyx
--- a/sage/misc/constant_function.pyx
+++ b/sage/misc/constant_function.pyx
@@ -64,7 +64,7 @@ cdef class ConstantFunction(SageObject):
         """
         EXAMPLES::

-            sage: ConstantFunction(1)()
+            sage: ConstantFunction(1)._value
             1
         """
         self._value = value
```
from your patch.

Second error: There is one error message saying "base ring must be a field." But your reviewer patch changes one example, so that the same error message is expected *without* the dot in the end.

I am talking about the hunk

```
diff --git a/sage/categories/vector_spaces.py b/sage/categories/vector_spaces.py
--- a/sage/categories/vector_spaces.py
+++ b/sage/categories/vector_spaces.py
@@ -32,36 +32,33 @@ class VectorSpaces(Category_module):
...
...
             sage: VectorSpaces(ZZ)
             Traceback (most recent call last):
             ...
-            AssertionError: The base ring must be a field.
+            AssertionError: The base ring must be a field

+        With ``check=False``, the check is disabled, possibly enabling
+        incorrect inputs::
+
+            sage: VectorSpaces(ZZ, check=False)
+            Category of vector spaces over Integer Ring
```



---

archive/issue_comments_168850.json:
```json
{
    "body": "**Changing dependencies** from \"#9138 #11911\" to \"#9138 #11911 #10595 #9562\".",
    "created_at": "2011-12-03T21:08:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168850",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing dependencies** from "#9138 #11911" to "#9138 #11911 #10595 #9562".



---

archive/issue_comments_168851.json:
```json
{
    "body": "<a id='comment:6'></a>\nIt could be that I found the ticket that is responsible for making `vector([])` work: #10595, which was merged in sage-4.8.alpha3. I have updated the list of dependencies accordingly.",
    "created_at": "2011-12-03T21:08:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168851",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:6'></a>
It could be that I found the ticket that is responsible for making `vector([])` work: #10595, which was merged in sage-4.8.alpha3. I have updated the list of dependencies accordingly.



---

archive/issue_comments_168852.json:
```json
{
    "body": "<a id='comment:7'></a>\nNo, sorry, I did not read carefully enough: #10595 was merged in sage-4.7.alpha3, not 4.8.alpha3. So, it was probably something else.",
    "created_at": "2011-12-03T21:10:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168852",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:7'></a>
No, sorry, I did not read carefully enough: #10595 was merged in sage-4.7.alpha3, not 4.8.alpha3. So, it was probably something else.



---

archive/issue_comments_168853.json:
```json
{
    "body": "**Changing dependencies** from \"#9138 #11911 #10595 #9562\" to \"#9138 #11911 #9562\".",
    "created_at": "2011-12-03T21:10:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168853",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing dependencies** from "#9138 #11911 #10595 #9562" to "#9138 #11911 #9562".



---

archive/issue_comments_168854.json:
```json
{
    "body": "**Changing work_issues** from \"Rebase first patch rel #9562; update reviewer patch\" to \"Update reviewer patch\".",
    "created_at": "2011-12-03T21:38:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168854",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing work_issues** from "Rebase first patch rel #9562; update reviewer patch" to "Update reviewer patch".



---

archive/issue_comments_168855.json:
```json
{
    "body": "<a id='comment:8'></a>\nI have updated my patch, rebased against the M4RIE ticket.",
    "created_at": "2011-12-03T21:38:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168855",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:8'></a>
I have updated my patch, rebased against the M4RIE ticket.



---

archive/issue_comments_168856.json:
```json
{
    "body": "<a id='comment:179'></a>\nReplying to [SimonKing](#comment%3A175):\n> First error: By my patch, `_value` is a cdef attribute of constant functions, thus, one can not access it in a doc test. Therefore, I had changed the corresponding doctest. But your patch re-introduces that test.\n\n\nAh, I see, that was the rationale! Sorry; I'll redo my undo :-)\n\n> Second error: There is one error message saying \"base ring must be a field.\" But your reviewer patch changes one example, so that the same error message is expected *without* the dot in the end.\n\n\nOk, will do when the upgrade/compilation will be over (but that will be tomorrow)\n\nCheers,\n\t\t\t\tNicolas",
    "created_at": "2011-12-03T23:11:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168856",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:179'></a>
Replying to [SimonKing](#comment%3A175):
> First error: By my patch, `_value` is a cdef attribute of constant functions, thus, one can not access it in a doc test. Therefore, I had changed the corresponding doctest. But your patch re-introduces that test.


Ah, I see, that was the rationale! Sorry; I'll redo my undo :-)

> Second error: There is one error message saying "base ring must be a field." But your reviewer patch changes one example, so that the same error message is expected *without* the dot in the end.


Ok, will do when the upgrade/compilation will be over (but that will be tomorrow)

Cheers,
				Nicolas



---

archive/issue_comments_168857.json:
```json
{
    "body": "<a id='comment:180'></a>\nReplying to [nthiery](#comment%3A179):\n> Ok, will do when the upgrade/compilation will be over (but that will be tomorrow)\n\n\nArgl, I don't manage to compile alpha3 on my laptop. I sent a mail on sage-release, but I have no idea how much time this could be. Sorry, but I am stuck now.\n\nIn case you have a bit of spare time, the quickest would be for you to take over. What needs to be done:\n\n- remove the chunk about ConstantFunctions in my reviewer patch\n- fold in my reviewer patch in yours\n- fix the trivial doctest failure mentionned above\n- remove all chunks in the resulting patch about Finite*\n- CartesianProducts.base: did not we decide to remove it? I don't remember; do as you feel appropriate\n- EXAMPLE:: -> EXAMPLES::\n- There might be a couple `base_checked` options left after my patch; change those to the standard check=\n- Check that all tests pass\n\nAnd then a last quick check from met, and that will be good to go!\n\nCheers!\n                      Nicolas",
    "created_at": "2011-12-04T13:50:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168857",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:180'></a>
Replying to [nthiery](#comment%3A179):
> Ok, will do when the upgrade/compilation will be over (but that will be tomorrow)


Argl, I don't manage to compile alpha3 on my laptop. I sent a mail on sage-release, but I have no idea how much time this could be. Sorry, but I am stuck now.

In case you have a bit of spare time, the quickest would be for you to take over. What needs to be done:

- remove the chunk about ConstantFunctions in my reviewer patch
- fold in my reviewer patch in yours
- fix the trivial doctest failure mentionned above
- remove all chunks in the resulting patch about Finite*
- CartesianProducts.base: did not we decide to remove it? I don't remember; do as you feel appropriate
- EXAMPLE:: -> EXAMPLES::
- There might be a couple `base_checked` options left after my patch; change those to the standard check=
- Check that all tests pass

And then a last quick check from met, and that will be good to go!

Cheers!
                      Nicolas



---

archive/issue_comments_168858.json:
```json
{
    "body": "<a id='comment:181'></a>\nReplying to [nthiery](#comment%3A180):\n>  - remove all chunks in the resulting patch about Finite*\n\n\nI don't understand this one. Do you mean, I shall remove doctest stuff such as\n\n```\n+        sage: Category.join((Modules(ZZ), FiniteFields()), as_list=True)\n+        [Category of modules over Integer Ring, Category of finite fields]\n```\n\n```\n+        sage: sage.categories.algebra_functor.AlgebrasCategory.category_of(FiniteMonoids(), QQ)\n+        Category of monoid algebras over Rational Field\n```\nor also this:\n\n```\n-class FiniteCoxeterGroups(Category):\n+class FiniteCoxeterGroups(Category_singleton):\n```\nand\n\n```\n-class FiniteCrystals(Category):\n+class FiniteCrystals(Category_singleton):\n```\n?\n\n>  - CartesianProducts.base: did not we decide to remove it? I don't remember; do as you feel appropriate\n\n\nI think we said that it should be fine for base_ring at least. But I think we also said that this ticket should work stand-alone, and resulting messy code will be taken care of in #11943 and #11935.\n\nLet's see what breaks when I remove that method.\n\n>  - EXAMPLE:: -> EXAMPLES::\n\n\nSorry, I produced rather many `EXAMPLE::`s.",
    "created_at": "2011-12-05T10:29:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168858",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:181'></a>
Replying to [nthiery](#comment%3A180):
>  - remove all chunks in the resulting patch about Finite*


I don't understand this one. Do you mean, I shall remove doctest stuff such as

```
+        sage: Category.join((Modules(ZZ), FiniteFields()), as_list=True)
+        [Category of modules over Integer Ring, Category of finite fields]
```

```
+        sage: sage.categories.algebra_functor.AlgebrasCategory.category_of(FiniteMonoids(), QQ)
+        Category of monoid algebras over Rational Field
```
or also this:

```
-class FiniteCoxeterGroups(Category):
+class FiniteCoxeterGroups(Category_singleton):
```
and

```
-class FiniteCrystals(Category):
+class FiniteCrystals(Category_singleton):
```
?

>  - CartesianProducts.base: did not we decide to remove it? I don't remember; do as you feel appropriate


I think we said that it should be fine for base_ring at least. But I think we also said that this ticket should work stand-alone, and resulting messy code will be taken care of in #11943 and #11935.

Let's see what breaks when I remove that method.

>  - EXAMPLE:: -> EXAMPLES::


Sorry, I produced rather many `EXAMPLE::`s.



---

archive/issue_comments_168859.json:
```json
{
    "body": "<a id='comment:2'></a>\nThe doc tests aren't finished, but I observed several errors that are due to not having the `base()` method for Cartesian products.\n\nSo, I'd prefer to keep `base()` in, so that it works, and then take care of the problem in a nicer way in #11943 or #11935.\n\nAnd please, tell me what the problem is with the \"Finite*\" stuff, and to what extent I have to change things: Only new doctests that use \"Finite*\", or should I also not use `Category_singleton` on \"Finite*\"?\n\nBest regards,\n\nSimon",
    "created_at": "2011-12-05T11:14:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168859",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:2'></a>
The doc tests aren't finished, but I observed several errors that are due to not having the `base()` method for Cartesian products.

So, I'd prefer to keep `base()` in, so that it works, and then take care of the problem in a nicer way in #11943 or #11935.

And please, tell me what the problem is with the "Finite*" stuff, and to what extent I have to change things: Only new doctests that use "Finite*", or should I also not use `Category_singleton` on "Finite*"?

Best regards,

Simon



---

archive/issue_comments_168860.json:
```json
{
    "body": "<a id='comment:183'></a>\nReplying to [SimonKing](#comment%3A182):\n> The doc tests aren't finished, but I observed several errors that are due to not having the `base()` method for Cartesian products.\n> \n> So, I'd prefer to keep `base()` in, so that it works, and then take care of the problem in a nicer way in #11943 or #11935.\n\n\nOk, keep it!\n\n> And please, tell me what the problem is with the \"Finite*\" stuff, and to what extent I have to change things: Only new doctests that use \"Finite*\", or should I also not use `Category_singleton` on \"Finite*\"?\n\n\nIt is *only* about not using `Category_singleton` for Finite* stuff, since those will be refactored soon anyway, so we might as well not create a conflict for nothing.\n\nThanks!\n                  Nicolas",
    "created_at": "2011-12-05T11:33:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168860",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:183'></a>
Replying to [SimonKing](#comment%3A182):
> The doc tests aren't finished, but I observed several errors that are due to not having the `base()` method for Cartesian products.
> 
> So, I'd prefer to keep `base()` in, so that it works, and then take care of the problem in a nicer way in #11943 or #11935.


Ok, keep it!

> And please, tell me what the problem is with the "Finite*" stuff, and to what extent I have to change things: Only new doctests that use "Finite*", or should I also not use `Category_singleton` on "Finite*"?


It is *only* about not using `Category_singleton` for Finite* stuff, since those will be refactored soon anyway, so we might as well not create a conflict for nothing.

Thanks!
                  Nicolas



---

archive/issue_comments_168861.json:
```json
{
    "body": "<a id='comment:184'></a>\nReplying to [nthiery](#comment%3A183):\n> It is *only* about not using `Category_singleton` for Finite* stuff, since those will be refactored soon anyway, so we might as well not create a conflict for nothing.\n\n\nI see. I'll change it accordingly and will then test whether there is a regression. Currently (that's to say when we keep the `base()` method) all doc tests pass.",
    "created_at": "2011-12-05T12:30:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168861",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:184'></a>
Replying to [nthiery](#comment%3A183):
> It is *only* about not using `Category_singleton` for Finite* stuff, since those will be refactored soon anyway, so we might as well not create a conflict for nothing.


I see. I'll change it accordingly and will then test whether there is a regression. Currently (that's to say when we keep the `base()` method) all doc tests pass.



---

archive/issue_comments_168862.json:
```json
{
    "body": "<a id='comment:185'></a>\nReplying to [SimonKing](#comment%3A184):\n> I see. I'll change it accordingly and will then test whether there is a regression. Currently (that's to say when we keep the `base()` method) all doc tests pass.\n\n\nExcellent. Thanks!",
    "created_at": "2011-12-05T13:39:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168862",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:185'></a>
Replying to [SimonKing](#comment%3A184):
> I see. I'll change it accordingly and will then test whether there is a regression. Currently (that's to say when we keep the `base()` method) all doc tests pass.


Excellent. Thanks!



---

archive/issue_comments_168863.json:
```json
{
    "body": "General speedup for the category framework, using Category_singleton for Finite*",
    "created_at": "2011-12-05T15:50:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168863",
    "user": "https://github.com/simon-king-jena"
}
```

General speedup for the category framework, using Category_singleton for Finite*



---

archive/issue_comments_168864.json:
```json
{
    "body": "**Changing reviewer** from \"Jeroen Demeyer, Nicolas M. Thi\u00e9ry\" to \"Jeroen Demeyer, Nicolas M. Thi\u00e9ry, Simon King\".",
    "created_at": "2011-12-05T15:57:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168864",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing reviewer** from "Jeroen Demeyer, Nicolas M. Thiéry" to "Jeroen Demeyer, Nicolas M. Thiéry, Simon King".



---

archive/issue_comments_168865.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -31,3 +31,4 @@\n \n \n Apply [attachment:trac11900_category_speedup_combined.patch]\n+or [attachment:trac11900_category_speedup_combined_Finitesingleton.patch] at your choice.\n``````\n",
    "created_at": "2011-12-05T15:57:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168865",
    "user": "https://github.com/simon-king-jena"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -31,3 +31,4 @@
 
 
 Apply [attachment:trac11900_category_speedup_combined.patch]
+or [attachment:trac11900_category_speedup_combined_Finitesingleton.patch] at your choice.
``````




---

archive/issue_comments_168866.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2011-12-05T15:57:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168866",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_168867.json:
```json
{
    "body": "<a id='comment:6'></a>\nAttachment [trac11900_category_speedup_combined_Finitesingleton.patch](tarball://root/attachments/some-uuid/ticket11900/trac11900_category_speedup_combined_Finitesingleton.patch) by @simon-king-jena created at 2011-12-05 15:57:24\n\nI have attached two patches. Both of them combine the ideas of Nicolas and myself. The `base()` method is left in; this shall be taken care of at #11943 (I'll mark it as \"todo\" there, if it hasn't already been done).\n\nWith each patch (plus #9138), all doctests pass when starting with sage-4.8.alpha3. I was of course reading Nicolas' patches before including them, and I give his contribution a positive review.\n\nFor the record, I repeated all benchmarks that were discussed here. The main data are obtained with *not* using Category_singleton for Finite*. The timings with using Category_singleton and the timings with sage 4.6.2 are also given, namely in the comments.\n\n```\nsage: E = J0(46).endomorphism_ring()\nsage: %time g = E.gens()\nCPU times: user 5.61 s, sys: 0.19 s, total: 5.80 s\nWall time: 5.95 s  # 5.61 s\n# 4.6.2: 6.35 s\n```\n\n```\nsage: %time L = EllipticCurve('960d1').prove_BSD()\nCPU times: user 4.23 s, sys: 0.09 s, total: 4.32 s\nWall time: 4.66 s  # 4.84 s\n# 4.6.2: 4.69 s\n```\n\n```\nsage: def test(E):\n....:     for p in prime_range(10000):\n....:         if p != 389:\n....:             G = E.change_ring(GF(p)).abelian_group()\n....:             \nsage: E = EllipticCurve('389a')\nsage: %time test(E)\nCPU times: user 17.42 s, sys: 0.12 s, total: 17.54 s\nWall time: 17.60 s   # 17.59 s\n# 4.6.2: 15.97 s\n```\n\n```\nsage: %time for E in cremona_curves([11..100]): S = E.integral_points(both_signs=False)\nCPU times: user 12.46 s, sys: 0.08 s, total: 12.55 s\nWall time: 12.66 s   # 12.86 s\n# 4.6.2: 14.05 s\n```\n\n```\nsage: %time D = J0(46).endomorphism_ring().discriminant()\nCPU times: user 5.10 s, sys: 0.22 s, total: 5.32 s\nWall time: 5.33 s    # 5.74 s\n# 4.6.2: 6.20 s\n```\n\n```\nsage: W.<z> = CyclotomicField(13)\nsage: %time M = Matrix(W, 2, 3, [10^30*(1-z)^13, 1, 2, 3, 4, z]).echelon_form()\nCPU times: user 3.87 s, sys: 0.06 s, total: 3.92 s\nWall time: 3.94 s    # 3.37 s\n# 4.6.2: 3.46 s\n```\n\n```\nsage: R = Rings()\nsage: MS = MatrixSpace(QQ,3)\nsage: %timeit MS in R\n625 loops, best of 3: 765 ns per loop  # 774 ns\n# 4.6.2: 10.1 \u00b5s\nsage: %timeit MS.is_ring()\n625 loops, best of 3: 4.18 \u00b5s per loop # 3.88 \u00b5s\n# 4.6.2: BOOM\n```\n\n```\nsage: def test():\n....:     for i in xrange(5000):\n....:         MS = MatrixSpace(QQ,i)\n....:         \nsage: %time test()\nCPU times: user 0.25 s, sys: 0.00 s, total: 0.25 s\nWall time: 0.25 s   # 0.30 s\n# 4.6.2: 0.37 s\n```\n\n```\nsage: def test():\n....:     for p in prime_range(10000):\n....:         P = GF(p)\n....:         \nsage: %time test()\nCPU times: user 0.60 s, sys: 0.00 s, total: 0.60 s\nWall time: 0.60 s   # 0.66 s\n# 4.6.2: 0.57 s\n```\n\n```\nsage: L = [CommutativeAlgebras(GF(p)) for p in prime_range(10000)]\nsage: A = Algebras(GF(5))\nsage: %time _ = [B.is_subcategory(A) for B in L]\nCPU times: user 0.06 s, sys: 0.00 s, total: 0.06 s\nWall time: 0.07 s   # 0.06 s\n# 4.6.2: 0.97 s\n```\n\n```\nsage: v = vector(ZZ,range(100))\nsage: %timeit L = v.list()\n625 loops, best of 3: 11.7 \u00b5s per loop  # 12.1 \u00b5s\n# 4.6.2: 16.4 \u00b5s\nsage: v = vector(QQ,range(100))\nsage: %timeit L = v.list()\n625 loops, best of 3: 23.5 \u00b5s per loop  # 23.8 \u00b5s\n# 4.6.2: 24.5 \u00b5s\n```\n\nThe following is still not good, but I think #11935 will solve that problem:\n\n```\nsage: def test():\n....:     for p in prime_range(10000):\n....:         P = GF(p)['t','x','z']\n....:         \nsage: %time test()\nCPU times: user 2.84 s, sys: 0.05 s, total: 2.89 s\nWall time: 2.90 s    # 2.97 s\n# 4.6.2: 1.22 s\n```\n\n**__Left to do__**\n\nThe final reviewer (i.e., Nicolas, I presume) should decide whether we want to have [attachment:trac11900_category_speedup_combined_Finitesingleton.patch] or [attachment:trac11900_category_speedup_combined.patch].",
    "created_at": "2011-12-05T15:57:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168867",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:6'></a>
Attachment [trac11900_category_speedup_combined_Finitesingleton.patch](tarball://root/attachments/some-uuid/ticket11900/trac11900_category_speedup_combined_Finitesingleton.patch) by @simon-king-jena created at 2011-12-05 15:57:24

I have attached two patches. Both of them combine the ideas of Nicolas and myself. The `base()` method is left in; this shall be taken care of at #11943 (I'll mark it as "todo" there, if it hasn't already been done).

With each patch (plus #9138), all doctests pass when starting with sage-4.8.alpha3. I was of course reading Nicolas' patches before including them, and I give his contribution a positive review.

For the record, I repeated all benchmarks that were discussed here. The main data are obtained with *not* using Category_singleton for Finite*. The timings with using Category_singleton and the timings with sage 4.6.2 are also given, namely in the comments.

```
sage: E = J0(46).endomorphism_ring()
sage: %time g = E.gens()
CPU times: user 5.61 s, sys: 0.19 s, total: 5.80 s
Wall time: 5.95 s  # 5.61 s
# 4.6.2: 6.35 s
```

```
sage: %time L = EllipticCurve('960d1').prove_BSD()
CPU times: user 4.23 s, sys: 0.09 s, total: 4.32 s
Wall time: 4.66 s  # 4.84 s
# 4.6.2: 4.69 s
```

```
sage: def test(E):
....:     for p in prime_range(10000):
....:         if p != 389:
....:             G = E.change_ring(GF(p)).abelian_group()
....:             
sage: E = EllipticCurve('389a')
sage: %time test(E)
CPU times: user 17.42 s, sys: 0.12 s, total: 17.54 s
Wall time: 17.60 s   # 17.59 s
# 4.6.2: 15.97 s
```

```
sage: %time for E in cremona_curves([11..100]): S = E.integral_points(both_signs=False)
CPU times: user 12.46 s, sys: 0.08 s, total: 12.55 s
Wall time: 12.66 s   # 12.86 s
# 4.6.2: 14.05 s
```

```
sage: %time D = J0(46).endomorphism_ring().discriminant()
CPU times: user 5.10 s, sys: 0.22 s, total: 5.32 s
Wall time: 5.33 s    # 5.74 s
# 4.6.2: 6.20 s
```

```
sage: W.<z> = CyclotomicField(13)
sage: %time M = Matrix(W, 2, 3, [10^30*(1-z)^13, 1, 2, 3, 4, z]).echelon_form()
CPU times: user 3.87 s, sys: 0.06 s, total: 3.92 s
Wall time: 3.94 s    # 3.37 s
# 4.6.2: 3.46 s
```

```
sage: R = Rings()
sage: MS = MatrixSpace(QQ,3)
sage: %timeit MS in R
625 loops, best of 3: 765 ns per loop  # 774 ns
# 4.6.2: 10.1 µs
sage: %timeit MS.is_ring()
625 loops, best of 3: 4.18 µs per loop # 3.88 µs
# 4.6.2: BOOM
```

```
sage: def test():
....:     for i in xrange(5000):
....:         MS = MatrixSpace(QQ,i)
....:         
sage: %time test()
CPU times: user 0.25 s, sys: 0.00 s, total: 0.25 s
Wall time: 0.25 s   # 0.30 s
# 4.6.2: 0.37 s
```

```
sage: def test():
....:     for p in prime_range(10000):
....:         P = GF(p)
....:         
sage: %time test()
CPU times: user 0.60 s, sys: 0.00 s, total: 0.60 s
Wall time: 0.60 s   # 0.66 s
# 4.6.2: 0.57 s
```

```
sage: L = [CommutativeAlgebras(GF(p)) for p in prime_range(10000)]
sage: A = Algebras(GF(5))
sage: %time _ = [B.is_subcategory(A) for B in L]
CPU times: user 0.06 s, sys: 0.00 s, total: 0.06 s
Wall time: 0.07 s   # 0.06 s
# 4.6.2: 0.97 s
```

```
sage: v = vector(ZZ,range(100))
sage: %timeit L = v.list()
625 loops, best of 3: 11.7 µs per loop  # 12.1 µs
# 4.6.2: 16.4 µs
sage: v = vector(QQ,range(100))
sage: %timeit L = v.list()
625 loops, best of 3: 23.5 µs per loop  # 23.8 µs
# 4.6.2: 24.5 µs
```

The following is still not good, but I think #11935 will solve that problem:

```
sage: def test():
....:     for p in prime_range(10000):
....:         P = GF(p)['t','x','z']
....:         
sage: %time test()
CPU times: user 2.84 s, sys: 0.05 s, total: 2.89 s
Wall time: 2.90 s    # 2.97 s
# 4.6.2: 1.22 s
```

**__Left to do__**

The final reviewer (i.e., Nicolas, I presume) should decide whether we want to have [attachment:trac11900_category_speedup_combined_Finitesingleton.patch] or [attachment:trac11900_category_speedup_combined.patch].



---

archive/issue_comments_168868.json:
```json
{
    "body": "**Changing author** from \"Simon King, Nicolas M. Thi\u00e9ry\" to \"Simon King\".",
    "created_at": "2011-12-09T14:44:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168868",
    "user": "https://github.com/nthiery"
}
```

**Changing author** from "Simon King, Nicolas M. Thiéry" to "Simon King".



---

archive/issue_comments_168869.json:
```json
{
    "body": "<a id='comment:187'></a>\nReplying to [SimonKing](#comment%3A186):\n> I have attached two patches. Both of them combine the ideas of Nicolas and myself. The `base()` method is left in; this shall be taken care of at #11943 (I'll mark it as \"todo\" there, if it hasn't already been done).\n\n\n> The final reviewer (i.e., Nicolas, I presume) should decide whether we want to have [attachment:trac11900_category_speedup_combined_Finitesingleton.patch] or [attachment:trac11900_category_speedup_combined.patch].\n\n\nSince the timing are not decisive in one direction or the other, I\nvote for [attachment:trac11900_category_speedup_combined.patch] which\nreduces the risks of conflicts with #10963. I have just been through\nall of it, and it is good enough to go.\n\nPositive review! Thanks for all your hard work!\n\nPS for the release manager: I haven't run myself the tests since alpha3 segfaults on my Ubuntu 11.10 box.\n\nPS for Simon: Just a remark for next time: in a patch which is likely to conflict\nwith other patches lying around on the same topics, please refrain\nfrom doing syntactical improvements (like EXAMPLE -> EXAMPLES) in\nchunks where nothing else is changed otherwise. Also, the workaround\nfor super(Fields).__contains__ in Fields is a code smell. We should\ninstead find a way to make our Cython __contains__ behave properly\nwith inheritance. In a future patch!",
    "created_at": "2011-12-09T14:44:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168869",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:187'></a>
Replying to [SimonKing](#comment%3A186):
> I have attached two patches. Both of them combine the ideas of Nicolas and myself. The `base()` method is left in; this shall be taken care of at #11943 (I'll mark it as "todo" there, if it hasn't already been done).


> The final reviewer (i.e., Nicolas, I presume) should decide whether we want to have [attachment:trac11900_category_speedup_combined_Finitesingleton.patch] or [attachment:trac11900_category_speedup_combined.patch].


Since the timing are not decisive in one direction or the other, I
vote for [attachment:trac11900_category_speedup_combined.patch] which
reduces the risks of conflicts with #10963. I have just been through
all of it, and it is good enough to go.

Positive review! Thanks for all your hard work!

PS for the release manager: I haven't run myself the tests since alpha3 segfaults on my Ubuntu 11.10 box.

PS for Simon: Just a remark for next time: in a patch which is likely to conflict
with other patches lying around on the same topics, please refrain
from doing syntactical improvements (like EXAMPLE -> EXAMPLES) in
chunks where nothing else is changed otherwise. Also, the workaround
for super(Fields).__contains__ in Fields is a code smell. We should
instead find a way to make our Cython __contains__ behave properly
with inheritance. In a future patch!



---

archive/issue_comments_168870.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2011-12-09T14:44:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168870",
    "user": "https://github.com/nthiery"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_168871.json:
```json
{
    "body": "<a id='comment:8'></a>\nI posted a comment at #11943: should I wait until #11943 also gets a positive review in order to merge #9138, #11900 and #11943 together?",
    "created_at": "2011-12-09T14:57:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168871",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>
I posted a comment at #11943: should I wait until #11943 also gets a positive review in order to merge #9138, #11900 and #11943 together?



---

archive/issue_comments_168872.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -29,6 +29,4 @@\n ```\n However, that's still far from good. After caching join and hom_category, there is still too much time spent (according to %prun) for the initialisation of matrix spaces.\n \n-\n Apply [attachment:trac11900_category_speedup_combined.patch]\n-or [attachment:trac11900_category_speedup_combined_Finitesingleton.patch] at your choice.\n``````\n",
    "created_at": "2011-12-09T14:57:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168872",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -29,6 +29,4 @@
 ```
 However, that's still far from good. After caching join and hom_category, there is still too much time spent (according to %prun) for the initialisation of matrix spaces.
 
-
 Apply [attachment:trac11900_category_speedup_combined.patch]
-or [attachment:trac11900_category_speedup_combined_Finitesingleton.patch] at your choice.
``````




---

archive/issue_comments_168873.json:
```json
{
    "body": "<a id='comment:189'></a>\nReplying to [jdemeyer](#comment%3A188):\n> I posted a comment at #11943: should I wait until #11943 also gets a positive review in order to merge #9138, #11900 and #11943 together?\n\n\nNo, please go ahead! I might not get the time to review #11943 instantly, and the earlier #11900 and friends are in, the better!\n\nThanks :-)",
    "created_at": "2011-12-09T17:11:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168873",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:189'></a>
Replying to [jdemeyer](#comment%3A188):
> I posted a comment at #11943: should I wait until #11943 also gets a positive review in order to merge #9138, #11900 and #11943 together?


No, please go ahead! I might not get the time to review #11943 instantly, and the earlier #11900 and friends are in, the better!

Thanks :-)



---

archive/issue_comments_168874.json:
```json
{
    "body": "<a id='comment:190'></a>\nReplying to [nthiery](#comment%3A189):\n> Replying to [jdemeyer](#comment%3A188):\n> > I posted a comment at #11943: should I wait until #11943 also gets a positive review in order to merge #9138, #11900 and #11943 together?\n\n> \n> No, please go ahead! I might not get the time to review #11943 instantly, and the earlier #11900 and friends are in, the better!\n> \n> Thanks :-)\n\n\nIn any case, I was planning to postpone these tickets to sage-5.0 (which is scheduled to come after sage-4.8).  The sage-4.8 release is getting close to being finished and I prefer not to merge the big tickets #9138 and #11900 at this point.  They change a lot of core functionality of Sage, so there could be some unexpected consequences.",
    "created_at": "2011-12-09T20:13:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168874",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:190'></a>
Replying to [nthiery](#comment%3A189):
> Replying to [jdemeyer](#comment%3A188):
> > I posted a comment at #11943: should I wait until #11943 also gets a positive review in order to merge #9138, #11900 and #11943 together?

> 
> No, please go ahead! I might not get the time to review #11943 instantly, and the earlier #11900 and friends are in, the better!
> 
> Thanks :-)


In any case, I was planning to postpone these tickets to sage-5.0 (which is scheduled to come after sage-4.8).  The sage-4.8 release is getting close to being finished and I prefer not to merge the big tickets #9138 and #11900 at this point.  They change a lot of core functionality of Sage, so there could be some unexpected consequences.



---

archive/issue_events_037130.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-12-09T20:13:59Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "milestone": "sage-4.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11900#event-37130"
}
```



---

archive/issue_events_037131.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-12-09T20:13:59Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "milestone": "sage-5.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11900#event-37131"
}
```



---

archive/issue_comments_168875.json:
```json
{
    "body": "<a id='comment:191'></a>\nReplying to [jdemeyer](#comment%3A190):\n> In any case, I was planning to postpone these tickets to sage-5.0 (which is scheduled to come after sage-4.8).  The sage-4.8 release is getting close to being finished and I prefer not to merge the big tickets #9138 and #11900 at this point.  They change a lot of core functionality of Sage, so there could be some unexpected consequences.\n\n\nHmm, it would have been really helpful to have a clean base to work on\nfor the bunch of followup patches. That especially since #9138\nrequires recompiling most of the Sage library, which makes it very\ninconvenient to handle in a patch queue.\n\nCheers,\n                          Nicolas",
    "created_at": "2011-12-09T20:33:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168875",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:191'></a>
Replying to [jdemeyer](#comment%3A190):
> In any case, I was planning to postpone these tickets to sage-5.0 (which is scheduled to come after sage-4.8).  The sage-4.8 release is getting close to being finished and I prefer not to merge the big tickets #9138 and #11900 at this point.  They change a lot of core functionality of Sage, so there could be some unexpected consequences.


Hmm, it would have been really helpful to have a clean base to work on
for the bunch of followup patches. That especially since #9138
requires recompiling most of the Sage library, which makes it very
inconvenient to handle in a patch queue.

Cheers,
                          Nicolas



---

archive/issue_comments_168876.json:
```json
{
    "body": "<a id='comment:192'></a>\nReplying to [nthiery](#comment%3A191):\n> Hmm, it would have been really helpful to have a clean base to work on\n> for the bunch of followup patches. That especially since #9138\n> requires recompiling most of the Sage library, which makes it very\n> inconvenient to handle in a patch queue.\n\n\nWell, you could simply leave #9138 at the bottom of the queue, so you would need to recompile only once.  Or truly import the patch (not qimport, but import).\n\nIf this is really an obstruction to you, I could easily make available a sage-5.0 pre-prerelease with the few patches related to #9138.",
    "created_at": "2011-12-09T21:44:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168876",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:192'></a>
Replying to [nthiery](#comment%3A191):
> Hmm, it would have been really helpful to have a clean base to work on
> for the bunch of followup patches. That especially since #9138
> requires recompiling most of the Sage library, which makes it very
> inconvenient to handle in a patch queue.


Well, you could simply leave #9138 at the bottom of the queue, so you would need to recompile only once.  Or truly import the patch (not qimport, but import).

If this is really an obstruction to you, I could easily make available a sage-5.0 pre-prerelease with the few patches related to #9138.



---

archive/issue_comments_168877.json:
```json
{
    "body": "<a id='comment:193'></a>\nReplying to [jdemeyer](#comment%3A192):\n> Well, you could simply leave #9138 at the bottom of the queue, so you would need to recompile only once.  Or truly import the patch (not qimport, but import).\n\n\nI forgot to mention one piece of information: we would need to\nintegrate this in the Sage-Combinat queue, which is used by people of\nvarying technical strength. So most of them use the Sage-Combinat\nscript which is not clever enough to not unapply those patches that\nhaven't changed.\n\n> If this is really an obstruction to you, I could easily make available a sage-5.0 pre-prerelease with the few patches related to #9138.\n\n\nThat probably would work. Or just call it an alpha0 to not change the\nusual workflow. Simon?",
    "created_at": "2011-12-09T22:02:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168877",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:193'></a>
Replying to [jdemeyer](#comment%3A192):
> Well, you could simply leave #9138 at the bottom of the queue, so you would need to recompile only once.  Or truly import the patch (not qimport, but import).


I forgot to mention one piece of information: we would need to
integrate this in the Sage-Combinat queue, which is used by people of
varying technical strength. So most of them use the Sage-Combinat
script which is not clever enough to not unapply those patches that
haven't changed.

> If this is really an obstruction to you, I could easily make available a sage-5.0 pre-prerelease with the few patches related to #9138.


That probably would work. Or just call it an alpha0 to not change the
usual workflow. Simon?



---

archive/issue_comments_168878.json:
```json
{
    "body": "<a id='comment:194'></a>\nReplying to [nthiery](#comment%3A193):\n> Replying to [jdemeyer](#comment%3A192):\n> > If this is really an obstruction to you, I could easily make available a sage-5.0 pre-prerelease with the few patches related to #9138.\n\n> \n> That probably would work. Or just call it an alpha0 to not change the\n> usual workflow. Simon?\n\n\nIt doesn't really matter for the project I'm doing for a living: I can always use these \"few\" patches (namely #9138, #11900, #11115, #11068, #4539, #7797) privately, even if they are not part of the official distribution.\n\nSo having it in sage-5.0.alpha0 or .prerelease seems fine to me.",
    "created_at": "2011-12-09T22:16:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168878",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:194'></a>
Replying to [nthiery](#comment%3A193):
> Replying to [jdemeyer](#comment%3A192):
> > If this is really an obstruction to you, I could easily make available a sage-5.0 pre-prerelease with the few patches related to #9138.

> 
> That probably would work. Or just call it an alpha0 to not change the
> usual workflow. Simon?


It doesn't really matter for the project I'm doing for a living: I can always use these "few" patches (namely #9138, #11900, #11115, #11068, #4539, #7797) privately, even if they are not part of the official distribution.

So having it in sage-5.0.alpha0 or .prerelease seems fine to me.



---

archive/issue_comments_168879.json:
```json
{
    "body": "<a id='comment:195'></a>\nReplying to [nthiery](#comment%3A193):\n> That probably would work. Or just call it an alpha0 to not change the\n> usual workflow. Simon?\n\nI will go for sage-5.0.prealpha0 (to indicate that it has more of an unofficial status).",
    "created_at": "2011-12-10T20:21:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168879",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:195'></a>
Replying to [nthiery](#comment%3A193):
> That probably would work. Or just call it an alpha0 to not change the
> usual workflow. Simon?

I will go for sage-5.0.prealpha0 (to indicate that it has more of an unofficial status).



---

archive/issue_comments_168880.json:
```json
{
    "body": "**Changing status** from positive_review to needs_work.",
    "created_at": "2011-12-19T11:27:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168880",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing status** from positive_review to needs_work.



---

archive/issue_comments_168881.json:
```json
{
    "body": "<a id='comment:6'></a>\nI am afraid this needs work\n\n```\nsage: None in Rings()\n```\nresults in a segfault, with the patch. I'll fix it after the status reports of the Sage-Flint days are over.",
    "created_at": "2011-12-19T11:27:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168881",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:6'></a>
I am afraid this needs work

```
sage: None in Rings()
```
results in a segfault, with the patch. I'll fix it after the status reports of the Sage-Flint days are over.



---

archive/issue_comments_168882.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2011-12-19T12:07:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168882",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_168883.json:
```json
{
    "body": "<a id='comment:7'></a>\nI have updated my patch. It is tested whether the argument is None.\n\nIf it is not None, then the argument is tried to be assigned to a cdef'ed variable of type `CategoryObject`. While it is possible to assign None to it (which is the reason for the segfault), every non-None object that is not of the right type will produce a type error, which is then caught.\n\nIn other words, my fix should be correct. I added a test for the fix. Needs review!",
    "created_at": "2011-12-19T12:07:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168883",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:7'></a>
I have updated my patch. It is tested whether the argument is None.

If it is not None, then the argument is tried to be assigned to a cdef'ed variable of type `CategoryObject`. While it is possible to assign None to it (which is the reason for the segfault), every non-None object that is not of the right type will produce a type error, which is then caught.

In other words, my fix should be correct. I added a test for the fix. Needs review!



---

archive/issue_comments_168884.json:
```json
{
    "body": "<a id='comment:8'></a>\nI just had a look at the ``in Rings()`` code. Maybe Cython should be\ncomplaining when trying to assign None to a variable of a given\ntype. In any cases, testing for None sounds good for the time\nbeing. On the other hand, I am now puzzled by the code just below\n(sorry if I missed it before):\n\n```\n\n    except TypeError: # this is for objects that aren't CategoryObjects \n        try: \n\t    return PyType_IsSubtype(<type>(x.category().parent_class), self._parent_class_of_category) \n \texcept AttributeError: \n \t    return False \n```\n\nIf ``x`` is not a category object, does it make sense to call\nx.category()?  Shouldn't this just always return False? Otherwise,\nthere should be an example in the doctests illustrating this.\n\nCheers,\n\t\t\tNicolas",
    "created_at": "2011-12-20T16:08:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168884",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:8'></a>
I just had a look at the ``in Rings()`` code. Maybe Cython should be
complaining when trying to assign None to a variable of a given
type. In any cases, testing for None sounds good for the time
being. On the other hand, I am now puzzled by the code just below
(sorry if I missed it before):

```

    except TypeError: # this is for objects that aren't CategoryObjects 
        try: 
	    return PyType_IsSubtype(<type>(x.category().parent_class), self._parent_class_of_category) 
 	except AttributeError: 
 	    return False 
```

If ``x`` is not a category object, does it make sense to call
x.category()?  Shouldn't this just always return False? Otherwise,
there should be an example in the doctests illustrating this.

Cheers,
			Nicolas



---

archive/issue_comments_168885.json:
```json
{
    "body": "<a id='comment:199'></a>\nReplying to [nthiery](#comment%3A198):\n> I just had a look at the ``in Rings()`` code. Maybe Cython should be\n> complaining when trying to assign None to a variable of a given\n> type.\n\n\nI'm not sure. I think the idea is the same as having a point (in C) point to NULL.\n\n> If ``x`` is not a category object, does it make sense to call\n> x.category()?  Shouldn't this just always return False? Otherwise,\n> there should be an example in the doctests illustrating this.\n\n\nI guess that is the same problem that hit me in #11521: There are objects that aren't `CategoryObject` instances. Any integer is an example.\n\nI don't remember if actually doc tests would fail if we simplify the code. But I guess I wrote that for a reason. Well, let's simply try...",
    "created_at": "2011-12-20T16:46:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168885",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:199'></a>
Replying to [nthiery](#comment%3A198):
> I just had a look at the ``in Rings()`` code. Maybe Cython should be
> complaining when trying to assign None to a variable of a given
> type.


I'm not sure. I think the idea is the same as having a point (in C) point to NULL.

> If ``x`` is not a category object, does it make sense to call
> x.category()?  Shouldn't this just always return False? Otherwise,
> there should be an example in the doctests illustrating this.


I guess that is the same problem that hit me in #11521: There are objects that aren't `CategoryObject` instances. Any integer is an example.

I don't remember if actually doc tests would fail if we simplify the code. But I guess I wrote that for a reason. Well, let's simply try...



---

archive/issue_comments_168886.json:
```json
{
    "body": "<a id='comment:0'></a>\nIndeed, when simply returning False, one gets an error:\n\n```\nsage -t  devel/sage-main/sage/categories/fields.py\n**********************************************************************\nFile \"/home/simon/SAGE/sage-4.8.alpha3/devel/sage-main/sage/categories/fields.py\", line 87:\n    sage: GR in Fields()\nExpected:\n    True\nGot:\n    False\n```\n\nHere, `GR = gap('Rationals')`, equipped with a callable attribute `GR.category()` that returns `Fields()`.",
    "created_at": "2011-12-20T16:50:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168886",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:0'></a>
Indeed, when simply returning False, one gets an error:

```
sage -t  devel/sage-main/sage/categories/fields.py
**********************************************************************
File "/home/simon/SAGE/sage-4.8.alpha3/devel/sage-main/sage/categories/fields.py", line 87:
    sage: GR in Fields()
Expected:
    True
Got:
    False
```

Here, `GR = gap('Rationals')`, equipped with a callable attribute `GR.category()` that returns `Fields()`.



---

archive/issue_comments_168887.json:
```json
{
    "body": "<a id='comment:1'></a>\nI tried to apply the patch to 4.7.2 but it failed:\n\n```\nsage: hg_sage.import_patch(\"/tmp/trac11900_category_speedup_combined.patch\")\ncd \"/usr/local/sage-4.7.2/sage/devel/sage\" && hg import   \"/tmp/trac11900_category_speedup_combined.patch\"\napplying /tmp/trac11900_category_speedup_combined.patch\npatching file sage/categories/algebras.py\nHunk #2 FAILED at 116\nHunk #3 FAILED at 127\n2 out of 3 hunks FAILED -- saving rejects to file sage/categories/algebras.py.rej\n...\nHunk #1 FAILED at 82\n1 out of 2 hunks FAILED -- saving rejects to file sage/structure/category_object.pyx.rej\nabort: patch failed to apply\n```\nPaul",
    "created_at": "2011-12-20T20:37:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168887",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:1'></a>
I tried to apply the patch to 4.7.2 but it failed:

```
sage: hg_sage.import_patch("/tmp/trac11900_category_speedup_combined.patch")
cd "/usr/local/sage-4.7.2/sage/devel/sage" && hg import   "/tmp/trac11900_category_speedup_combined.patch"
applying /tmp/trac11900_category_speedup_combined.patch
patching file sage/categories/algebras.py
Hunk #2 FAILED at 116
Hunk #3 FAILED at 127
2 out of 3 hunks FAILED -- saving rejects to file sage/categories/algebras.py.rej
...
Hunk #1 FAILED at 82
1 out of 2 hunks FAILED -- saving rejects to file sage/structure/category_object.pyx.rej
abort: patch failed to apply
```
Paul



---

archive/issue_comments_168888.json:
```json
{
    "body": "<a id='comment:202'></a>\nReplying to [zimmerma](#comment%3A201):\n> I tried to apply the patch to 4.7.2 but it failed:\n> \n> ```\n> sage: hg_sage.import_patch(\"/tmp/trac11900_category_speedup_combined.patch\")\n\n\nDid you also apply all three dependencies?",
    "created_at": "2011-12-20T21:18:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168888",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:202'></a>
Replying to [zimmerma](#comment%3A201):
> I tried to apply the patch to 4.7.2 but it failed:
> 
> ```
> sage: hg_sage.import_patch("/tmp/trac11900_category_speedup_combined.patch")


Did you also apply all three dependencies?



---

archive/issue_comments_168889.json:
```json
{
    "body": "<a id='comment:203'></a>\nReplying to [SimonKing](#comment%3A202):\n> Did you also apply all three dependencies?\n\n\nno, sorry, but since #9562 itself requires to apply other patches, this is too complex\nfor me. I will wait until 4.8 is out, or maybe until 4.8.alpha5 finishes compiling on\nmy Ubuntu 11.10 system.\n\nPaul",
    "created_at": "2011-12-21T17:20:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168889",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:203'></a>
Replying to [SimonKing](#comment%3A202):
> Did you also apply all three dependencies?


no, sorry, but since #9562 itself requires to apply other patches, this is too complex
for me. I will wait until 4.8 is out, or maybe until 4.8.alpha5 finishes compiling on
my Ubuntu 11.10 system.

Paul



---

archive/issue_comments_168890.json:
```json
{
    "body": "<a id='comment:204'></a>\nReplying to [SimonKing](#comment%3A200):\n> Indeed, when simply returning False, one gets an error:\n> \n> ```\n> sage -t  devel/sage-main/sage/categories/fields.py\n> **********************************************************************\n> File \"/home/simon/SAGE/sage-4.8.alpha3/devel/sage-main/sage/categories/fields.py\", line 87:\n>     sage: GR in Fields()\n> Expected:\n>     True\n> Got:\n>     False\n> ```\n> \n> Here, `GR = gap('Rationals')`, equipped with a callable attribute `GR.category()` that returns `Fields()`.\n\n\nOk. Then please add this as a doctest of \"in Rings()\" containment, and then you can put a positive review on my behalf.\n\nCheers,\n                          Nicolas",
    "created_at": "2011-12-22T01:53:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168890",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:204'></a>
Replying to [SimonKing](#comment%3A200):
> Indeed, when simply returning False, one gets an error:
> 
> ```
> sage -t  devel/sage-main/sage/categories/fields.py
> **********************************************************************
> File "/home/simon/SAGE/sage-4.8.alpha3/devel/sage-main/sage/categories/fields.py", line 87:
>     sage: GR in Fields()
> Expected:
>     True
> Got:
>     False
> ```
> 
> Here, `GR = gap('Rationals')`, equipped with a callable attribute `GR.category()` that returns `Fields()`.


Ok. Then please add this as a doctest of "in Rings()" containment, and then you can put a positive review on my behalf.

Cheers,
                          Nicolas



---

archive/issue_comments_168891.json:
```json
{
    "body": "<a id='comment:205'></a>\nReplying to [nthiery](#comment%3A204):\n> Ok. Then please add this as a doctest of \"in Rings()\" containment, ...\n\n\nWhat do you mean by that? Shall I have a `GR.category()` be defined, and then test `GR in Rings()`?",
    "created_at": "2011-12-22T08:25:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168891",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:205'></a>
Replying to [nthiery](#comment%3A204):
> Ok. Then please add this as a doctest of "in Rings()" containment, ...


What do you mean by that? Shall I have a `GR.category()` be defined, and then test `GR in Rings()`?



---

archive/issue_comments_168892.json:
```json
{
    "body": "<a id='comment:206'></a>\nReplying to [SimonKing](#comment%3A205):\n> Replying to [nthiery](#comment%3A204):\n> > Ok. Then please add this as a doctest of \"in Rings()\" containment, ...\n  \n> \n> What do you mean by that? Shall I have a `GR.category()` be defined, and then test `GR in Rings()`?\n\n\nAh, I see; I had not noticed that GR was equiped with a category method specifically in that example (which I probably wrote ...). Then, I would add this to the documentation ``in Rings()``:\n\n```\nCurrently, an object is considered *in* a category as soon as it has a\ncategory method returning an appropriate value::\n\n    sage: class A:\n    ....:     def category(self): return Fields()\n    ....:         \n    sage: \n    sage: A() in Rings()\n    True\n\nThis feature will most likely be deprecated in favor of having the\nclass ``A`` derive from :class:`CategoryObject`.\n```\n\nMaybe even ``is`` rather than ``will most likely be``.\n\nCheers,\n                        Nicolas",
    "created_at": "2011-12-23T09:52:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168892",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:206'></a>
Replying to [SimonKing](#comment%3A205):
> Replying to [nthiery](#comment%3A204):
> > Ok. Then please add this as a doctest of "in Rings()" containment, ...
  
> 
> What do you mean by that? Shall I have a `GR.category()` be defined, and then test `GR in Rings()`?


Ah, I see; I had not noticed that GR was equiped with a category method specifically in that example (which I probably wrote ...). Then, I would add this to the documentation ``in Rings()``:

```
Currently, an object is considered *in* a category as soon as it has a
category method returning an appropriate value::

    sage: class A:
    ....:     def category(self): return Fields()
    ....:         
    sage: 
    sage: A() in Rings()
    True

This feature will most likely be deprecated in favor of having the
class ``A`` derive from :class:`CategoryObject`.
```

Maybe even ``is`` rather than ``will most likely be``.

Cheers,
                        Nicolas



---

archive/issue_comments_168893.json:
```json
{
    "body": "<a id='comment:7'></a>\nI get one test failure (including also #9958):\n\n```\nsage -t  -force_lib devel/sage/sage/categories/category_singleton.pyx\n**********************************************************************\nFile \"/mnt/usb1/scratch/jdemeyer/merger/sage-5.0.prealpha0/devel/sage-main/sage/categories/category_singleton.pyx\", line 266:\n    sage: hash(Rings()) == hash(Rings)     # indirect doctest\nExpected:\n    True\nGot:\n    False\n**********************************************************************\n```",
    "created_at": "2011-12-23T16:28:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168893",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>
I get one test failure (including also #9958):

```
sage -t  -force_lib devel/sage/sage/categories/category_singleton.pyx
**********************************************************************
File "/mnt/usb1/scratch/jdemeyer/merger/sage-5.0.prealpha0/devel/sage-main/sage/categories/category_singleton.pyx", line 266:
    sage: hash(Rings()) == hash(Rings)     # indirect doctest
Expected:
    True
Got:
    False
**********************************************************************
```



---

archive/issue_comments_168894.json:
```json
{
    "body": "<a id='comment:8'></a>\nHow can this possibly be? The code of `Category_singleton` explicitly says that the hash of the unique instance is the same as the hash of the class. I'll try to google whether the hash behaviour has changed between Python 2.6 and 2.7.",
    "created_at": "2011-12-23T16:41:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168894",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:8'></a>
How can this possibly be? The code of `Category_singleton` explicitly says that the hash of the unique instance is the same as the hash of the class. I'll try to google whether the hash behaviour has changed between Python 2.6 and 2.7.



---

archive/issue_comments_168895.json:
```json
{
    "body": "<a id='comment:9'></a>\nIs the 5.0 prealpha available somewhere? #9958 looks rather complicated, and I wouldn't like to apply it all by myself.\n\nAnd google did not tell me whether the hash implementation has significantly changed between 2.6 and 2.7.",
    "created_at": "2011-12-23T17:04:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168895",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:9'></a>
Is the 5.0 prealpha available somewhere? #9958 looks rather complicated, and I wouldn't like to apply it all by myself.

And google did not tell me whether the hash implementation has significantly changed between 2.6 and 2.7.



---

archive/issue_comments_168896.json:
```json
{
    "body": "<a id='comment:210'></a>\nReplying to [SimonKing](#comment%3A209):\n> Is the 5.0 prealpha available somewhere? #9958 looks rather complicated, and I wouldn't like to apply it all by myself.\n\nI am working on it, it should be done by tomorrow.\n\n> And google did not tell me whether the hash implementation has significantly changed between 2.6 and 2.7.\n\nThe hash for integers certainly changed, see #11986.",
    "created_at": "2011-12-24T01:09:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168896",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:210'></a>
Replying to [SimonKing](#comment%3A209):
> Is the 5.0 prealpha available somewhere? #9958 looks rather complicated, and I wouldn't like to apply it all by myself.

I am working on it, it should be done by tomorrow.

> And google did not tell me whether the hash implementation has significantly changed between 2.6 and 2.7.

The hash for integers certainly changed, see #11986.



---

archive/issue_comments_168897.json:
```json
{
    "body": "<a id='comment:1'></a>\nI can confirm the problem with `category_singleton.pyx` is really caused by #9958+#11986.",
    "created_at": "2011-12-24T01:10:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168897",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:1'></a>
I can confirm the problem with `category_singleton.pyx` is really caused by #9958+#11986.



---

archive/issue_comments_168898.json:
```json
{
    "body": "<a id='comment:2'></a>\nBy \"something changed with the hash between 2.6 and 2.7\", I did not mean that the value of the hash changed. What I meant was: Has the way of calling the provided `__hash__` method changed?\n\nIn the patch, we turn the hash of a Category_singleton into a lazy class attribute:\n\n```\n    @lazy_class_attribute \n    def __hash__(cls): \n        return ConstantFunction(id(cls)) \n```\n\nIs there any change between python2.6 and python2.7 that would affect this code?",
    "created_at": "2011-12-24T11:38:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168898",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:2'></a>
By "something changed with the hash between 2.6 and 2.7", I did not mean that the value of the hash changed. What I meant was: Has the way of calling the provided `__hash__` method changed?

In the patch, we turn the hash of a Category_singleton into a lazy class attribute:

```
    @lazy_class_attribute 
    def __hash__(cls): 
        return ConstantFunction(id(cls)) 
```

Is there any change between python2.6 and python2.7 that would affect this code?



---

archive/issue_comments_168899.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2011-12-24T15:12:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168899",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_168900.json:
```json
{
    "body": "<a id='comment:3'></a>\nI am now trying a different approach: I introduce a cdef class `FastHashable_class`. It has a cdef int attribute _hash, and `__hash__` simply returns `self._hash`. I make `Category_singleton` inherit from this class and from `Category`. In the `__classcall__` method, I assign the value of `_hash` appropriately.\n\nFirst tests show that the hash method will be even faster than with the current patch, and since it uses a straight forward `__hash__` method (not a lazy class attribute) it is likely to work in Python 2.7.\n\nPreparing a patch now...",
    "created_at": "2011-12-24T15:12:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168900",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:3'></a>
I am now trying a different approach: I introduce a cdef class `FastHashable_class`. It has a cdef int attribute _hash, and `__hash__` simply returns `self._hash`. I make `Category_singleton` inherit from this class and from `Category`. In the `__classcall__` method, I assign the value of `_hash` appropriately.

First tests show that the hash method will be even faster than with the current patch, and since it uses a straight forward `__hash__` method (not a lazy class attribute) it is likely to work in Python 2.7.

Preparing a patch now...



---

archive/issue_comments_168901.json:
```json
{
    "body": "<a id='comment:4'></a>\nThe following timings are on a different machine than the timings above, but I think they show that the new hash method is pretty good:\n\n```\nsage: timeit(\"Rings()\",number=10000)\n10000 loops, best of 3: 981 ns per loop\nsage: R = Rings()\nsage: timeit(\"hash(R)\",number=10000)\n10000 loops, best of 3: 107 ns per loop\n```\n\nThe tests at least in sage/categories pass, so, I put it back to \"needs review\"\n\nApply trac11900_category_speedup_combined.patch",
    "created_at": "2011-12-24T15:31:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168901",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:4'></a>
The following timings are on a different machine than the timings above, but I think they show that the new hash method is pretty good:

```
sage: timeit("Rings()",number=10000)
10000 loops, best of 3: 981 ns per loop
sage: R = Rings()
sage: timeit("hash(R)",number=10000)
10000 loops, best of 3: 107 ns per loop
```

The tests at least in sage/categories pass, so, I put it back to "needs review"

Apply trac11900_category_speedup_combined.patch



---

archive/issue_comments_168902.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2011-12-24T15:31:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168902",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_168903.json:
```json
{
    "body": "<a id='comment:5'></a>\nPS:\n\nAccording to Nicolas' request, I've added some documentation, but in fact I did it into sage/categories/category.py.",
    "created_at": "2011-12-24T15:39:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168903",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:5'></a>
PS:

According to Nicolas' request, I've added some documentation, but in fact I did it into sage/categories/category.py.



---

archive/issue_comments_168904.json:
```json
{
    "body": "<a id='comment:6'></a>\nNow works with Python 2.7.",
    "created_at": "2011-12-27T11:33:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168904",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>
Now works with Python 2.7.



---

archive/issue_comments_168905.json:
```json
{
    "body": "<a id='comment:7'></a>\nPlease rebase this to #11319, otherwise the patch applies with fuzz 2.",
    "created_at": "2011-12-29T07:11:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168905",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>
Please rebase this to #11319, otherwise the patch applies with fuzz 2.



---

archive/issue_comments_168906.json:
```json
{
    "body": "**Changing dependencies** from \"#9138 #11911 #9562\" to \"#11319, #9138, #11911, #9562\".",
    "created_at": "2011-12-29T07:11:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168906",
    "user": "https://github.com/jdemeyer"
}
```

**Changing dependencies** from "#9138 #11911 #9562" to "#11319, #9138, #11911, #9562".



---

archive/issue_comments_168907.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2011-12-29T07:11:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168907",
    "user": "https://github.com/jdemeyer"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_168908.json:
```json
{
    "body": "Attachment [trac11900_category_speedup_combined.patch](tarball://root/attachments/some-uuid/ticket11900/trac11900_category_speedup_combined.patch) by @simon-king-jena created at 2011-12-29 14:27:48\n\nGeneral speedup for the category framework.",
    "created_at": "2011-12-29T14:27:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168908",
    "user": "https://github.com/simon-king-jena"
}
```

Attachment [trac11900_category_speedup_combined.patch](tarball://root/attachments/some-uuid/ticket11900/trac11900_category_speedup_combined.patch) by @simon-king-jena created at 2011-12-29 14:27:48

General speedup for the category framework.



---

archive/issue_comments_168909.json:
```json
{
    "body": "<a id='comment:8'></a>\nDone!",
    "created_at": "2011-12-29T14:28:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168909",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:8'></a>
Done!



---

archive/issue_comments_168910.json:
```json
{
    "body": "**Changing work_issues** from \"Update reviewer patch\" to \"\".",
    "created_at": "2011-12-29T14:28:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168910",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing work_issues** from "Update reviewer patch" to "".



---

archive/issue_comments_168911.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2011-12-29T14:28:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168911",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_168912.json:
```json
{
    "body": "<a id='comment:9'></a>\nAFAIU, the current version of the patch is in sage-5.0.prealpha0. I hope this will make it more easy to finish reviewing the patch!",
    "created_at": "2012-01-05T12:57:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168912",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:9'></a>
AFAIU, the current version of the patch is in sage-5.0.prealpha0. I hope this will make it more easy to finish reviewing the patch!



---

archive/issue_comments_168913.json:
```json
{
    "body": "<a id='comment:220'></a>\nReplying to [SimonKing](#comment%3A219):\n> AFAIU, the current version of the patch is in sage-5.0.prealpha0. I hope this will make it more easy to finish reviewing the patch!\n\n\nI have been through the patch, and it looks good to me. Thanks so much Simon for your hard work on this! It goes far beyond the extra mile.\n\nI am running the tests on my machine. I'll set a positive review when it's done. In case I forget to: if in three hours you have not heard from me, you can set a positive review on my behalf.\n\nJust one note: I hope nobody had a pile of patches on top of the matrix/vector space code, since the many little doc improvements there (like EXAMPLES: -> EXAMPLES::) will force quite some rebasing. Please make this in a separate ticket next time, or just leave it to whoever is working on those files.\n\nCheers,\n                            Nicolas",
    "created_at": "2012-01-09T09:14:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168913",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:220'></a>
Replying to [SimonKing](#comment%3A219):
> AFAIU, the current version of the patch is in sage-5.0.prealpha0. I hope this will make it more easy to finish reviewing the patch!


I have been through the patch, and it looks good to me. Thanks so much Simon for your hard work on this! It goes far beyond the extra mile.

I am running the tests on my machine. I'll set a positive review when it's done. In case I forget to: if in three hours you have not heard from me, you can set a positive review on my behalf.

Just one note: I hope nobody had a pile of patches on top of the matrix/vector space code, since the many little doc improvements there (like EXAMPLES: -> EXAMPLES::) will force quite some rebasing. Please make this in a separate ticket next time, or just leave it to whoever is working on those files.

Cheers,
                            Nicolas



---

archive/issue_comments_168914.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2012-01-09T09:14:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168914",
    "user": "https://github.com/nthiery"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_168915.json:
```json
{
    "body": "<a id='comment:1'></a>\nAll tests passed on Ubuntu 11.10 (after replacing readline with the latest version from #11970). To be precise:\n\n- sage/schemes/elliptic_curves/lseries_ell.py first timed out, but that probably was because I suspended my laptop in the mean time. The test passed when I launched them individually\n\n- sage/misc/preparser.py failed (see attached log). It did not fail when I relauched it individually.",
    "created_at": "2012-01-09T12:16:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168915",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:1'></a>
All tests passed on Ubuntu 11.10 (after replacing readline with the latest version from #11970). To be precise:

- sage/schemes/elliptic_curves/lseries_ell.py first timed out, but that probably was because I suspended my laptop in the mean time. The test passed when I launched them individually

- sage/misc/preparser.py failed (see attached log). It did not fail when I relauched it individually.



---

archive/issue_comments_168916.json:
```json
{
    "body": "Attachment [testlog.2](tarball://root/attachments/some-uuid/ticket11900/testlog.2) by @nthiery created at 2012-01-09 12:17:30\n\nFor the record: a non reproducible failure in devel/sage/sage/misc/preparser.py",
    "created_at": "2012-01-09T12:17:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168916",
    "user": "https://github.com/nthiery"
}
```

Attachment [testlog.2](tarball://root/attachments/some-uuid/ticket11900/testlog.2) by @nthiery created at 2012-01-09 12:17:30

For the record: a non reproducible failure in devel/sage/sage/misc/preparser.py



---

archive/issue_comments_168917.json:
```json
{
    "body": "<a id='comment:2'></a>\nBad news: this breaks on OS X 10.6.  With sage-4.8.alpha5 + #9138 + #11900, sage fails to start up:\n\n```\nbsd:sage-4.8.alpha5 jdemeyer$ ./sage\n----------------------------------------------------------------------\n----------------------------------------------------------------------\n**********************************************************************\n*                                                                    *\n* Warning: this is a prerelease version, and it may be unstable.     *\n*                                                                    *\n**********************************************************************\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n| Sage Version 4.8.alpha5, Release Date: 2011-12-20                  |\n| Type notebook() for the GUI, and license() for information.        |\n\n/Users/jdemeyer/sage-4.8.alpha5/local/lib/python2.6/site-packages/IPython/ipmaker.pyc in force_import(modname, force_reload)\n     61         reload(sys.modules[modname])\n     62     else:\n---> 63         __import__(modname)\n     64\n     65\n\n/Users/jdemeyer/sage-4.8.alpha5/local/bin/ipy_profile_sage.py in <module>()\n      5     preparser(True)\n      6\n----> 7     import sage.all_cmdline\n      8     sage.all_cmdline._init_cmdline(globals())\n      9\n\n/Users/jdemeyer/sage-4.8.alpha5/local/lib/python2.6/site-packages/sage/all_cmdline.py in <module>()\n     12 try:\n     13\n---> 14     from sage.all import *\n     15     from sage.calculus.predefined import x\n     16     preparser(on=True)\n\n/Users/jdemeyer/sage-4.8.alpha5/local/lib/python2.6/site-packages/sage/all.py in <module>()\n     66 from time                import sleep\n     67\n---> 68 from sage.misc.all       import *         # takes a while\n     69\n     70 from sage.misc.sh import sh\n\n/Users/jdemeyer/sage-4.8.alpha5/local/lib/python2.6/site-packages/sage/misc/all.py in <module>()\n     79 from func_persist import func_persist\n     80\n---> 81 from functional import (additive_order,\n     82                         sqrt as numerical_sqrt,\n     83                         arg,\n\n/Users/jdemeyer/sage-4.8.alpha5/local/lib/python2.6/site-packages/sage/misc/functional.py in <module>()\n     34\n     35\n---> 36 from sage.rings.complex_double import CDF\n     37 from sage.rings.real_double import RDF, RealDoubleElement\n     38\n\n/Users/jdemeyer/sage-4.8.alpha5/local/bin/complex_double.pyx in init sage.rings.complex_double (sage/rings/complex_double.c:15152)()\n     90\n     91\n---> 92\n     93\n     94\n\nUsers/jdemeyer/sage-4.8.alpha5/local/lib/python2.6/site-packages/sage/rings/complex_field.pyc in ComplexField(prec, names)\n     85         if not C is None:\n     86             return C\n---> 87     C = ComplexField_class(prec)\n     88     cache[prec] = weakref.ref(C)\n     89     return C\n\n/Users/jdemeyer/sage-4.8.alpha5/local/lib/python2.6/site-packages/sage/rings/complex_field.pyc in __init__(self, prec)\n    185         ParentWithGens.__init__(self, self._real_field(), ('I',), False, category = Fields())\n    186 #        self._populate_coercion_lists_()\n--> 187         self._populate_coercion_lists_(coerce_list=[complex_number.RRtoCC(self._real_field(), self)])\n    188\n    189     def __reduce__(self):\n\n/Users/jdemeyer/sage-4.8.alpha5/local/lib/python2.6/site-packages/sage/rings/complex_number.so in sage.rings.complex_number.RRtoCC.__init__ (sage/rings/complex_number.c:14411)()\n   2261\n   2262\n-> 2263\n   2264\n   2265\n\n/Users/jdemeyer/sage-4.8.alpha5/local/lib/python2.6/site-packages/sage/categories/map.so in sage.categories.map.Map.__init__ (sage/categories/map.c:2234)()\n    121\n    122\n--> 123\n    124\n    125\n\nUsers/jdemeyer/sage-4.8.alpha5/local/lib/python2.6/site-packages/sage/categories/homset.pyc in Hom(X, Y, category)\n    199     # For the moment, this is the category, for compatibility with the current implementations\n    200     # of Homset in rings, schemes, ...\n--> 201     H = category.hom_category().parent_class(X, Y, category = category)\n    202\n    203     ##_cache[key] = weakref.ref(H)\n\n/Users/jdemeyer/sage-4.8.alpha5/local/lib/python2.6/site-packages/sage/categories/homset.pyc in __init__(self, X, Y, category, base, check)\n    339             #    raise TypeError, \"Y (=%s) must be in category (=%s)\"%(Y, category)\n    340\n--> 341         Parent.__init__(self, base = base, category = category.hom_category())\n    342\n    343     def _repr_(self):\n\n/Users/jdemeyer/sage-4.8.alpha5/local/lib/python2.6/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.__init__ (sage/structure/parent.c:4197)()\n    515\n    516\n--> 517\n    518\n    519\n\n/Users/jdemeyer/sage-4.8.alpha5/local/lib/python2.6/site-packages/sage/structure/parent.so in sage.structure.parent.Parent._init_category_ (sage/structure/parent.c:4711)()\n    564\n    565\n--> 566\n    567\n    568\n\n/Users/jdemeyer/sage-4.8.alpha5/local/lib/python2.6/site-packages/sage/structure/dynamic_class.pyc in dynamic_class(name, bases, cls, reduction, doccls)\n    254     assert(type(name) is str)\n    255     #    assert(cls is None or issubtype(type(cls), type) or type(cls) is classobj)\n--> 256     return dynamic_class_internal(name, bases, cls, reduction, doccls)\n    257\n    258 @cached_function\n\n/Users/jdemeyer/sage-4.8.alpha5/local/lib/python2.6/site-packages/sage/misc/cachefunc.pyc in __call__(self, *args, **kwds)\n    176             return self.cache[k]\n    177         except KeyError:\n--> 178             w = self.f(*args, **kwds)\n    179             self.cache[k] = w\n    180             return w\n\n/Users/jdemeyer/sage-4.8.alpha5/local/lib/python2.6/site-packages/sage/structure/dynamic_class.pyc in dynamic_class_internal(name, bases, cls, reduction, doccls)\n    341         if type(base) is ClasscallMetaclass:\n    342             metaclass = DynamicClasscallMetaclass\n--> 343     return metaclass(name, bases, methods)\n    344\n    345 class DynamicMetaclass(type):\n\nTypeError: duplicate base class Sets.HomCategory.parent_class\nError importing ipy_profile_sage - perhaps you should run %upgrade?\nWARNING: Loading of ipy_profile_sage failed.\n\nsage:\n```\n\nWith only #9138 applied, it works.",
    "created_at": "2012-01-14T15:12:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168917",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>
Bad news: this breaks on OS X 10.6.  With sage-4.8.alpha5 + #9138 + #11900, sage fails to start up:

```
bsd:sage-4.8.alpha5 jdemeyer$ ./sage
----------------------------------------------------------------------
----------------------------------------------------------------------
**********************************************************************
*                                                                    *
* Warning: this is a prerelease version, and it may be unstable.     *
*                                                                    *
**********************************************************************
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
| Sage Version 4.8.alpha5, Release Date: 2011-12-20                  |
| Type notebook() for the GUI, and license() for information.        |

/Users/jdemeyer/sage-4.8.alpha5/local/lib/python2.6/site-packages/IPython/ipmaker.pyc in force_import(modname, force_reload)
     61         reload(sys.modules[modname])
     62     else:
---> 63         __import__(modname)
     64
     65

/Users/jdemeyer/sage-4.8.alpha5/local/bin/ipy_profile_sage.py in <module>()
      5     preparser(True)
      6
----> 7     import sage.all_cmdline
      8     sage.all_cmdline._init_cmdline(globals())
      9

/Users/jdemeyer/sage-4.8.alpha5/local/lib/python2.6/site-packages/sage/all_cmdline.py in <module>()
     12 try:
     13
---> 14     from sage.all import *
     15     from sage.calculus.predefined import x
     16     preparser(on=True)

/Users/jdemeyer/sage-4.8.alpha5/local/lib/python2.6/site-packages/sage/all.py in <module>()
     66 from time                import sleep
     67
---> 68 from sage.misc.all       import *         # takes a while
     69
     70 from sage.misc.sh import sh

/Users/jdemeyer/sage-4.8.alpha5/local/lib/python2.6/site-packages/sage/misc/all.py in <module>()
     79 from func_persist import func_persist
     80
---> 81 from functional import (additive_order,
     82                         sqrt as numerical_sqrt,
     83                         arg,

/Users/jdemeyer/sage-4.8.alpha5/local/lib/python2.6/site-packages/sage/misc/functional.py in <module>()
     34
     35
---> 36 from sage.rings.complex_double import CDF
     37 from sage.rings.real_double import RDF, RealDoubleElement
     38

/Users/jdemeyer/sage-4.8.alpha5/local/bin/complex_double.pyx in init sage.rings.complex_double (sage/rings/complex_double.c:15152)()
     90
     91
---> 92
     93
     94

Users/jdemeyer/sage-4.8.alpha5/local/lib/python2.6/site-packages/sage/rings/complex_field.pyc in ComplexField(prec, names)
     85         if not C is None:
     86             return C
---> 87     C = ComplexField_class(prec)
     88     cache[prec] = weakref.ref(C)
     89     return C

/Users/jdemeyer/sage-4.8.alpha5/local/lib/python2.6/site-packages/sage/rings/complex_field.pyc in __init__(self, prec)
    185         ParentWithGens.__init__(self, self._real_field(), ('I',), False, category = Fields())
    186 #        self._populate_coercion_lists_()
--> 187         self._populate_coercion_lists_(coerce_list=[complex_number.RRtoCC(self._real_field(), self)])
    188
    189     def __reduce__(self):

/Users/jdemeyer/sage-4.8.alpha5/local/lib/python2.6/site-packages/sage/rings/complex_number.so in sage.rings.complex_number.RRtoCC.__init__ (sage/rings/complex_number.c:14411)()
   2261
   2262
-> 2263
   2264
   2265

/Users/jdemeyer/sage-4.8.alpha5/local/lib/python2.6/site-packages/sage/categories/map.so in sage.categories.map.Map.__init__ (sage/categories/map.c:2234)()
    121
    122
--> 123
    124
    125

Users/jdemeyer/sage-4.8.alpha5/local/lib/python2.6/site-packages/sage/categories/homset.pyc in Hom(X, Y, category)
    199     # For the moment, this is the category, for compatibility with the current implementations
    200     # of Homset in rings, schemes, ...
--> 201     H = category.hom_category().parent_class(X, Y, category = category)
    202
    203     ##_cache[key] = weakref.ref(H)

/Users/jdemeyer/sage-4.8.alpha5/local/lib/python2.6/site-packages/sage/categories/homset.pyc in __init__(self, X, Y, category, base, check)
    339             #    raise TypeError, "Y (=%s) must be in category (=%s)"%(Y, category)
    340
--> 341         Parent.__init__(self, base = base, category = category.hom_category())
    342
    343     def _repr_(self):

/Users/jdemeyer/sage-4.8.alpha5/local/lib/python2.6/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.__init__ (sage/structure/parent.c:4197)()
    515
    516
--> 517
    518
    519

/Users/jdemeyer/sage-4.8.alpha5/local/lib/python2.6/site-packages/sage/structure/parent.so in sage.structure.parent.Parent._init_category_ (sage/structure/parent.c:4711)()
    564
    565
--> 566
    567
    568

/Users/jdemeyer/sage-4.8.alpha5/local/lib/python2.6/site-packages/sage/structure/dynamic_class.pyc in dynamic_class(name, bases, cls, reduction, doccls)
    254     assert(type(name) is str)
    255     #    assert(cls is None or issubtype(type(cls), type) or type(cls) is classobj)
--> 256     return dynamic_class_internal(name, bases, cls, reduction, doccls)
    257
    258 @cached_function

/Users/jdemeyer/sage-4.8.alpha5/local/lib/python2.6/site-packages/sage/misc/cachefunc.pyc in __call__(self, *args, **kwds)
    176             return self.cache[k]
    177         except KeyError:
--> 178             w = self.f(*args, **kwds)
    179             self.cache[k] = w
    180             return w

/Users/jdemeyer/sage-4.8.alpha5/local/lib/python2.6/site-packages/sage/structure/dynamic_class.pyc in dynamic_class_internal(name, bases, cls, reduction, doccls)
    341         if type(base) is ClasscallMetaclass:
    342             metaclass = DynamicClasscallMetaclass
--> 343     return metaclass(name, bases, methods)
    344
    345 class DynamicMetaclass(type):

TypeError: duplicate base class Sets.HomCategory.parent_class
Error importing ipy_profile_sage - perhaps you should run %upgrade?
WARNING: Loading of ipy_profile_sage failed.

sage:
```

With only #9138 applied, it works.



---

archive/issue_comments_168918.json:
```json
{
    "body": "**Changing status** from positive_review to needs_work.",
    "created_at": "2012-01-14T15:12:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168918",
    "user": "https://github.com/jdemeyer"
}
```

**Changing status** from positive_review to needs_work.



---

archive/issue_comments_168919.json:
```json
{
    "body": "<a id='comment:3'></a>\nStrange.\n\nHow could the operating system have an influence on whether two parent classes coincide or not?\n\nSince #11943 deals with the consistency of method resolution order of parent classes: Could you try whether the problem disappears when you also apply #11943?",
    "created_at": "2012-01-14T15:31:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168919",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:3'></a>
Strange.

How could the operating system have an influence on whether two parent classes coincide or not?

Since #11943 deals with the consistency of method resolution order of parent classes: Could you try whether the problem disappears when you also apply #11943?



---

archive/issue_comments_168920.json:
```json
{
    "body": "<a id='comment:224'></a>\nReplying to [SimonKing](#comment%3A223):\n> Since #11943 deals with the consistency of method resolution order of parent classes: Could you try whether the problem disappears when you also apply #11943?\n\nNo, it remains the same.",
    "created_at": "2012-01-14T18:14:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168920",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:224'></a>
Replying to [SimonKing](#comment%3A223):
> Since #11943 deals with the consistency of method resolution order of parent classes: Could you try whether the problem disappears when you also apply #11943?

No, it remains the same.



---

archive/issue_comments_168921.json:
```json
{
    "body": "<a id='comment:225'></a>\nReplying to [jdemeyer](#comment%3A224):\n> Replying to [SimonKing](#comment%3A223):\n> > Since #11943 deals with the consistency of method resolution order of parent classes: Could you try whether the problem disappears when you also apply #11943?\n\n> No, it remains the same.\n\nI don't understand how the operating system could possibly matter here. I hope that someone on sage-devel can grant me with access to some OS X 10.6 computer.",
    "created_at": "2012-01-14T20:57:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168921",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:225'></a>
Replying to [jdemeyer](#comment%3A224):
> Replying to [SimonKing](#comment%3A223):
> > Since #11943 deals with the consistency of method resolution order of parent classes: Could you try whether the problem disappears when you also apply #11943?

> No, it remains the same.

I don't understand how the operating system could possibly matter here. I hope that someone on sage-devel can grant me with access to some OS X 10.6 computer.



---

archive/issue_comments_168922.json:
```json
{
    "body": "<a id='comment:6'></a>\nIt turns out that, for whatever reason, the category of sets is *not* a unique object on OS X, even though it should be cached as the unique instance of a category singleton.\n\nAfter starting sage on bsd.math, ignore the error and do\n\n```\nsage: from sage.categories.sets_cat import Sets\nsage: S is Sets()\nFalse\n```\n\nAgain, I don't see how OS X could be able to break the cache, but it does.",
    "created_at": "2012-01-16T09:33:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168922",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:6'></a>
It turns out that, for whatever reason, the category of sets is *not* a unique object on OS X, even though it should be cached as the unique instance of a category singleton.

After starting sage on bsd.math, ignore the error and do

```
sage: from sage.categories.sets_cat import Sets
sage: S is Sets()
False
```

Again, I don't see how OS X could be able to break the cache, but it does.



---

archive/issue_comments_168923.json:
```json
{
    "body": "<a id='comment:7'></a>\nSorry, I meant\n\n```\nsage: Sets() is Sets()\nFalse\n```",
    "created_at": "2012-01-16T09:36:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168923",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:7'></a>
Sorry, I meant

```
sage: Sets() is Sets()
False
```



---

archive/issue_comments_168924.json:
```json
{
    "body": "<a id='comment:8'></a>\nAha! That's how an influence of the operating system is possible:\n\n```\nsage: Sets.__classcall__\n---------------------------------------------------------------------------\nOverflowError                             Traceback (most recent call last)\n\n/scratch/sking/sage-5.0.prealpha1/local/bin/<ipython console> in <module>()\n\n/scratch/sking/sage-5.0.prealpha1/local/lib/python2.7/site-packages/sage/misc/lazy_attribute.pyc in __get__(self, _, cls)\n    647             1\n    648         \"\"\"\n--> 649         result = self.f(cls)\n    650         if result is NotImplemented:\n    651             return getattr(super(cls, cls),self.f.__name__)\n\n/scratch/sking/sage-5.0.prealpha1/local/lib/python2.7/site-packages/sage/categories/category_singleton.so in sage.categories.category_singleton.Category_singleton.__classcall__ (sage/categories/category_singleton.c:1453)()\n\nOverflowError: value too large to convert to int\n```\n\nIn other words, lazy class attribute does not work on OS X!\n\nJeroen, you said that sage works on OS X with #9138. Do you mean that all tests pass? Including tests for lazy_class_attribute (I hope there are some tests)?",
    "created_at": "2012-01-16T09:40:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168924",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:8'></a>
Aha! That's how an influence of the operating system is possible:

```
sage: Sets.__classcall__
---------------------------------------------------------------------------
OverflowError                             Traceback (most recent call last)

/scratch/sking/sage-5.0.prealpha1/local/bin/<ipython console> in <module>()

/scratch/sking/sage-5.0.prealpha1/local/lib/python2.7/site-packages/sage/misc/lazy_attribute.pyc in __get__(self, _, cls)
    647             1
    648         """
--> 649         result = self.f(cls)
    650         if result is NotImplemented:
    651             return getattr(super(cls, cls),self.f.__name__)

/scratch/sking/sage-5.0.prealpha1/local/lib/python2.7/site-packages/sage/categories/category_singleton.so in sage.categories.category_singleton.Category_singleton.__classcall__ (sage/categories/category_singleton.c:1453)()

OverflowError: value too large to convert to int
```

In other words, lazy class attribute does not work on OS X!

Jeroen, you said that sage works on OS X with #9138. Do you mean that all tests pass? Including tests for lazy_class_attribute (I hope there are some tests)?



---

archive/issue_comments_168925.json:
```json
{
    "body": "<a id='comment:9'></a>\nGot it!\n\n`CategorySingleton` inherits from `FastHashableClass`, which stores its hash in a cdef attribute. By mistake, I made it `cdef int _hash`. It should better be `cdef Py_ssize_t _hash` or so.",
    "created_at": "2012-01-16T09:47:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168925",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:9'></a>
Got it!

`CategorySingleton` inherits from `FastHashableClass`, which stores its hash in a cdef attribute. By mistake, I made it `cdef int _hash`. It should better be `cdef Py_ssize_t _hash` or so.



---

archive/issue_comments_168926.json:
```json
{
    "body": "<a id='comment:230'></a>\nReplying to [SimonKing](#comment%3A228):\n> Jeroen, you said that sage works on OS X with #9138. Do you mean that all tests pass?\n\nI don't think I tested that, just that it started up.",
    "created_at": "2012-01-16T09:53:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168926",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:230'></a>
Replying to [SimonKing](#comment%3A228):
> Jeroen, you said that sage works on OS X with #9138. Do you mean that all tests pass?

I don't think I tested that, just that it started up.



---

archive/issue_comments_168927.json:
```json
{
    "body": "<a id='comment:1'></a>\nFixed and ready for review! The problem has not been in `lazy_class_attribute` but in the classcall method of `Category_singleton` in combination with a too short type used in `FastHashable_class`.\n\nApply trac11900_category_speedup_combined.patch trac11900_fix_singleton_hash.patch",
    "created_at": "2012-01-16T09:56:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168927",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:1'></a>
Fixed and ready for review! The problem has not been in `lazy_class_attribute` but in the classcall method of `Category_singleton` in combination with a too short type used in `FastHashable_class`.

Apply trac11900_category_speedup_combined.patch trac11900_fix_singleton_hash.patch



---

archive/issue_comments_168928.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -29,4 +29,7 @@\n ```\n However, that's still far from good. After caching join and hom_category, there is still too much time spent (according to %prun) for the initialisation of matrix spaces.\n \n-Apply [attachment:trac11900_category_speedup_combined.patch]\n+__Apply__\n+\n+* [attachment:trac11900_category_speedup_combined.patch]\n+* [attachment:trac11900_fix_singleton_hash.patch]\n``````\n",
    "created_at": "2012-01-16T09:56:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168928",
    "user": "https://github.com/simon-king-jena"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -29,4 +29,7 @@
 ```
 However, that's still far from good. After caching join and hom_category, there is still too much time spent (according to %prun) for the initialisation of matrix spaces.
 
-Apply [attachment:trac11900_category_speedup_combined.patch]
+__Apply__
+
+* [attachment:trac11900_category_speedup_combined.patch]
+* [attachment:trac11900_fix_singleton_hash.patch]
``````




---

archive/issue_comments_168929.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2012-01-16T09:56:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168929",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_168930.json:
```json
{
    "body": "<a id='comment:233'></a>\nReplying to [SimonKing](#comment%3A231):\n> Fixed and ready for review! The problem has not been in `lazy_class_attribute` but in the classcall method of `Category_singleton` in combination with a too short type used in `FastHashable_class`.\n> \n> Apply trac11900_category_speedup_combined.patch trac11900_fix_singleton_hash.patch\n\n\nGood catch Simon!\n\nGiven that this issue was non trivial to pinpoint, do you see a way to add a doctest to FastHashClass? Say with a small class returning a large hash that would cause the same overflow on OS X?\n\nWith that, and assuming that all test pass, I am happy to put back the positive review.\n\nCheers,\n                                      Nicolas",
    "created_at": "2012-01-16T10:21:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168930",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:233'></a>
Replying to [SimonKing](#comment%3A231):
> Fixed and ready for review! The problem has not been in `lazy_class_attribute` but in the classcall method of `Category_singleton` in combination with a too short type used in `FastHashable_class`.
> 
> Apply trac11900_category_speedup_combined.patch trac11900_fix_singleton_hash.patch


Good catch Simon!

Given that this issue was non trivial to pinpoint, do you see a way to add a doctest to FastHashClass? Say with a small class returning a large hash that would cause the same overflow on OS X?

With that, and assuming that all test pass, I am happy to put back the positive review.

Cheers,
                                      Nicolas



---

archive/issue_comments_168931.json:
```json
{
    "body": "<a id='comment:234'></a>\nReplying to [nthiery](#comment%3A233):\n> Given that this issue was non trivial to pinpoint, do you see a way to add a doctest to FastHashClass? Say with a small class returning a large hash that would cause the same overflow on OS X?\n\n\n`FastHashable_class._hash` must be explicitly assigned - i.e., one could try to create an example that would crash on machines where the biggest `Py_ssize_t` does not fit into an `int`, by explicitly assigning such value. `CategorySingleton` assigns `id(cls)` to the attribute `_hash` of the unique instance of `cls` - and `Sets` happens to have an address that doesn't fit into an int.\n\nCheers,\nSimon",
    "created_at": "2012-01-16T10:30:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168931",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:234'></a>
Replying to [nthiery](#comment%3A233):
> Given that this issue was non trivial to pinpoint, do you see a way to add a doctest to FastHashClass? Say with a small class returning a large hash that would cause the same overflow on OS X?


`FastHashable_class._hash` must be explicitly assigned - i.e., one could try to create an example that would crash on machines where the biggest `Py_ssize_t` does not fit into an `int`, by explicitly assigning such value. `CategorySingleton` assigns `id(cls)` to the attribute `_hash` of the unique instance of `cls` - and `Sets` happens to have an address that doesn't fit into an int.

Cheers,
Simon



---

archive/issue_comments_168932.json:
```json
{
    "body": "<a id='comment:5'></a>\nToo bad. In order to create an example, it would be needed to write a little cython example, which cimports `FastHashable_class`. But in order to do so, it would be needed to add a pxd header file. Is it worth it?",
    "created_at": "2012-01-16T10:40:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168932",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:5'></a>
Too bad. In order to create an example, it would be needed to write a little cython example, which cimports `FastHashable_class`. But in order to do so, it would be needed to add a pxd header file. Is it worth it?



---

archive/issue_comments_168933.json:
```json
{
    "body": "<a id='comment:6'></a>\nSorry, there *is* a header file. And I think it is OK to include `FastHashable_class` in the existing header.",
    "created_at": "2012-01-16T10:53:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168933",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:6'></a>
Sorry, there *is* a header file. And I think it is OK to include `FastHashable_class` in the existing header.



---

archive/issue_comments_168934.json:
```json
{
    "body": "Fix `FastHashable_class._hash`",
    "created_at": "2012-01-16T11:04:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168934",
    "user": "https://github.com/simon-king-jena"
}
```

Fix `FastHashable_class._hash`



---

archive/issue_comments_168935.json:
```json
{
    "body": "<a id='comment:7'></a>\nAttachment [trac11900_fix_singleton_hash.patch](tarball://root/attachments/some-uuid/ticket11900/trac11900_fix_singleton_hash.patch) by @simon-king-jena created at 2012-01-16 11:06:20\n\nI have added a test and updated my patch accordingly. The new test does work on OS X, but the full test suite isn't finished yet.\n\nApply trac11900_category_speedup_combined.patch trac11900_fix_singleton_hash.patch",
    "created_at": "2012-01-16T11:06:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168935",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:7'></a>
Attachment [trac11900_fix_singleton_hash.patch](tarball://root/attachments/some-uuid/ticket11900/trac11900_fix_singleton_hash.patch) by @simon-king-jena created at 2012-01-16 11:06:20

I have added a test and updated my patch accordingly. The new test does work on OS X, but the full test suite isn't finished yet.

Apply trac11900_category_speedup_combined.patch trac11900_fix_singleton_hash.patch



---

archive/issue_comments_168936.json:
```json
{
    "body": "<a id='comment:8'></a>\nHooray, `make ptest` works on bsd.math, and now I am starting `make ptestlong`! However, I think the reviewer should run the test suite as well, just to be on the safe side.",
    "created_at": "2012-01-16T11:52:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168936",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:8'></a>
Hooray, `make ptest` works on bsd.math, and now I am starting `make ptestlong`! However, I think the reviewer should run the test suite as well, just to be on the safe side.



---

archive/issue_comments_168937.json:
```json
{
    "body": "<a id='comment:9'></a>\nFWIW, `make ptestlong` works for me.",
    "created_at": "2012-01-16T12:58:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168937",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:9'></a>
FWIW, `make ptestlong` works for me.



---

archive/issue_comments_168938.json:
```json
{
    "body": "<a id='comment:0'></a>\nThis new patch fixes the startup problem for me!  Hooray! Thanks!",
    "created_at": "2012-01-16T14:15:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168938",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:0'></a>
This new patch fixes the startup problem for me!  Hooray! Thanks!



---

archive/issue_comments_168939.json:
```json
{
    "body": "Attachment [trac11900_doctest.patch](tarball://root/attachments/some-uuid/ticket11900/trac11900_doctest.patch) by @jdemeyer created at 2012-01-16 14:16:17",
    "created_at": "2012-01-16T14:16:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168939",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [trac11900_doctest.patch](tarball://root/attachments/some-uuid/ticket11900/trac11900_doctest.patch) by @jdemeyer created at 2012-01-16 14:16:17



---

archive/issue_comments_168940.json:
```json
{
    "body": "Attachment [trac11900_only_fix_singleton_hash.patch](tarball://root/attachments/some-uuid/ticket11900/trac11900_only_fix_singleton_hash.patch) by @jdemeyer created at 2012-01-16 14:16:27",
    "created_at": "2012-01-16T14:16:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168940",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [trac11900_only_fix_singleton_hash.patch](tarball://root/attachments/some-uuid/ticket11900/trac11900_only_fix_singleton_hash.patch) by @jdemeyer created at 2012-01-16 14:16:27



---

archive/issue_comments_168941.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -32,4 +32,5 @@\n __Apply__\n \n * [attachment:trac11900_category_speedup_combined.patch]\n-* [attachment:trac11900_fix_singleton_hash.patch]\n+* [attachment:trac11900_only_fix_singleton_hash.patch]\n+* [attachment:trac11900_doctest.patch]\n``````\n",
    "created_at": "2012-01-16T14:18:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168941",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -32,4 +32,5 @@
 __Apply__
 
 * [attachment:trac11900_category_speedup_combined.patch]
-* [attachment:trac11900_fix_singleton_hash.patch]
+* [attachment:trac11900_only_fix_singleton_hash.patch]
+* [attachment:trac11900_doctest.patch]
``````




---

archive/issue_comments_168942.json:
```json
{
    "body": "<a id='comment:1'></a>\nI moved the doctest to a new file `sage/tests/cython.pyx`.  This way, we don't require `cython` at test-time, only at build time.",
    "created_at": "2012-01-16T14:18:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168942",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:1'></a>
I moved the doctest to a new file `sage/tests/cython.pyx`.  This way, we don't require `cython` at test-time, only at build time.



---

archive/issue_comments_168943.json:
```json
{
    "body": "<a id='comment:2'></a>\nSage also starts up with jdemeyer's change, and the sage/tests/cython.pyx file passes (OSX 10.6.8).  From Simon's comments, apparently this is only part of the necessary review.  Hopefully someone with a faster machine can run testlong.",
    "created_at": "2012-01-16T14:26:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168943",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:2'></a>
Sage also starts up with jdemeyer's change, and the sage/tests/cython.pyx file passes (OSX 10.6.8).  From Simon's comments, apparently this is only part of the necessary review.  Hopefully someone with a faster machine can run testlong.



---

archive/issue_comments_168944.json:
```json
{
    "body": "<a id='comment:243'></a>\nReplying to [jason](#comment%3A242):\n> Sage also starts up with jdemeyer's change, and the sage/tests/cython.pyx file passes (OSX 10.6.8).  From Simon's comments, apparently this is only part of the necessary review.\n\nYes, the first big patch [attachment:trac11900_category_speedup_combined.patch] already got positive_review.\n\nI can run `make ptestlong` but don't wait for that to review this patch.",
    "created_at": "2012-01-16T14:28:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168944",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:243'></a>
Replying to [jason](#comment%3A242):
> Sage also starts up with jdemeyer's change, and the sage/tests/cython.pyx file passes (OSX 10.6.8).  From Simon's comments, apparently this is only part of the necessary review.

Yes, the first big patch [attachment:trac11900_category_speedup_combined.patch] already got positive_review.

I can run `make ptestlong` but don't wait for that to review this patch.



---

archive/issue_comments_168945.json:
```json
{
    "body": "<a id='comment:4'></a>\nIf starting up is all that is necessary, then positive review.  Simon's explanation also makes sense to me, but I haven't been keeping up on this ticket enough to understand it well enough to check the explanation very deeply.",
    "created_at": "2012-01-16T14:46:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168945",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:4'></a>
If starting up is all that is necessary, then positive review.  Simon's explanation also makes sense to me, but I haven't been keeping up on this ticket enough to understand it well enough to check the explanation very deeply.



---

archive/issue_comments_168946.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2012-01-16T14:46:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168946",
    "user": "https://github.com/jasongrout"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_168947.json:
```json
{
    "body": "**Changing reviewer** from \"Jeroen Demeyer, Nicolas M. Thi\u00e9ry, Simon King\" to \"Jeroen Demeyer, Nicolas M. Thi\u00e9ry, Simon King, Jason Grout\".",
    "created_at": "2012-01-16T14:52:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168947",
    "user": "https://github.com/jdemeyer"
}
```

**Changing reviewer** from "Jeroen Demeyer, Nicolas M. Thiéry, Simon King" to "Jeroen Demeyer, Nicolas M. Thiéry, Simon King, Jason Grout".



---

archive/issue_comments_168948.json:
```json
{
    "body": "<a id='comment:6'></a>\nI'm seeing this error on `bsd.math` but that's unrelated to this ticket:\n\n```\nsage -t  --long -force_lib devel/sage/sage/schemes/generic/toric_divisor.py\n**********************************************************************\nFile \"/Users/jdemeyer/sage-4.8.alpha5/devel/sage-main/sage/schemes/generic/toric_divisor.py\", line 1590:\n    sage: supp.Vrepresentation()\nExpected:\n    [A vertex at (-1, 1), A vertex at (0, 2), A vertex at (0, -1), A vertex at (3, -1)]\nGot:\n    [A vertex at (-1, 1), A vertex at (0, 2), A vertex at (3, -1), A vertex at (0, -1)]\n**********************************************************************\n```",
    "created_at": "2012-01-16T14:55:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168948",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>
I'm seeing this error on `bsd.math` but that's unrelated to this ticket:

```
sage -t  --long -force_lib devel/sage/sage/schemes/generic/toric_divisor.py
**********************************************************************
File "/Users/jdemeyer/sage-4.8.alpha5/devel/sage-main/sage/schemes/generic/toric_divisor.py", line 1590:
    sage: supp.Vrepresentation()
Expected:
    [A vertex at (-1, 1), A vertex at (0, 2), A vertex at (0, -1), A vertex at (3, -1)]
Got:
    [A vertex at (-1, 1), A vertex at (0, 2), A vertex at (3, -1), A vertex at (0, -1)]
**********************************************************************
```



---

archive/issue_comments_168949.json:
```json
{
    "body": "<a id='comment:7'></a>\nApart from that, everything is fine on `bsd.math` (sage-4.8.alpha5 + #9138 + #11900).",
    "created_at": "2012-01-16T14:59:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168949",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>
Apart from that, everything is fine on `bsd.math` (sage-4.8.alpha5 + #9138 + #11900).



---

archive/issue_comments_168950.json:
```json
{
    "body": "<a id='comment:8'></a>\nHi Jeroen,\n\nIs it really a problem to have `cython(...)` in doctests? I have used `cython(...)` in the past, for example when testing introspection (namely, cython creates a temporary file, so that introspection is easy).\n\nAha, is it because some people do not have gcc but install a Sage-binary?",
    "created_at": "2012-01-16T15:08:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168950",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:8'></a>
Hi Jeroen,

Is it really a problem to have `cython(...)` in doctests? I have used `cython(...)` in the past, for example when testing introspection (namely, cython creates a temporary file, so that introspection is easy).

Aha, is it because some people do not have gcc but install a Sage-binary?



---

archive/issue_comments_168951.json:
```json
{
    "body": "<a id='comment:249'></a>\nReplying to [SimonKing](#comment%3A248):\n> Aha, is it because some people do not have gcc but install a Sage-binary?\n\n\nStandard (non-optional) tests are allowed to depend on gcc.  I don't know if this is written in stone anywhere, but there have been many such standard tests in the past.  They aren't a problem for buildbots, since they always have GCC installed.  \n\nIf nothing else, it is very important to test that calling the compiler from Sage does work.",
    "created_at": "2012-01-16T15:23:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168951",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:249'></a>
Replying to [SimonKing](#comment%3A248):
> Aha, is it because some people do not have gcc but install a Sage-binary?


Standard (non-optional) tests are allowed to depend on gcc.  I don't know if this is written in stone anywhere, but there have been many such standard tests in the past.  They aren't a problem for buildbots, since they always have GCC installed.  

If nothing else, it is very important to test that calling the compiler from Sage does work.



---

archive/issue_comments_168952.json:
```json
{
    "body": "<a id='comment:250'></a>\nReplying to [was](#comment%3A249):\n> Replying to [SimonKing](#comment%3A248):\n> > Aha, is it because some people do not have gcc but install a Sage-binary?\n\n> \n> Standard (non-optional) tests are allowed to depend on gcc.\n\nReally?  I thought the opposite is true.\n\nI know there are some doctests marked\n\n```\n# optional -- gcc\n```\nFor example in `sage/misc/cython.py`",
    "created_at": "2012-01-16T19:46:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168952",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:250'></a>
Replying to [was](#comment%3A249):
> Replying to [SimonKing](#comment%3A248):
> > Aha, is it because some people do not have gcc but install a Sage-binary?

> 
> Standard (non-optional) tests are allowed to depend on gcc.

Really?  I thought the opposite is true.

I know there are some doctests marked

```
# optional -- gcc
```
For example in `sage/misc/cython.py`



---

archive/issue_events_037132.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-01-18T08:08:32Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11900#event-37132"
}
```



---

archive/issue_comments_168953.json:
```json
{
    "body": "**Merged:** sage-5.0.beta0",
    "created_at": "2012-01-18T08:08:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168953",
    "user": "https://github.com/jdemeyer"
}
```

**Merged:** sage-5.0.beta0



---

archive/issue_comments_168954.json:
```json
{
    "body": "**Resolution:** fixed",
    "created_at": "2012-01-18T08:08:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168954",
    "user": "https://github.com/jdemeyer"
}
```

**Resolution:** fixed



---

archive/issue_comments_168955.json:
```json
{
    "body": "<a id='comment:2'></a>\nthank you very much Simon for your work on this ticket (and on #715). Only a few people\nhave the necessary knowledge to work on speed regressions and memory leaks, but solving\nsuch issues is crucial so that Sage is really usable in research.\n\nPaul Zimmermann",
    "created_at": "2012-01-18T08:23:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168955",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:2'></a>
thank you very much Simon for your work on this ticket (and on #715). Only a few people
have the necessary knowledge to work on speed regressions and memory leaks, but solving
such issues is crucial so that Sage is really usable in research.

Paul Zimmermann



---

archive/issue_comments_168956.json:
```json
{
    "body": "<a id='comment:3'></a>\nSmall question: is there are particular reason for writing\n\n```\nself.__dict__.__delitem__('element_class')\n```\ninstead of\n\n```\ndel self.__dict__['element_class']\n```\nThe latter is faster because it bypasses the lookup of the `__delitem__` attribute. I'm changing this in #24270.",
    "created_at": "2017-11-23T09:32:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168956",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'></a>
Small question: is there are particular reason for writing

```
self.__dict__.__delitem__('element_class')
```
instead of

```
del self.__dict__['element_class']
```
The latter is faster because it bypasses the lookup of the `__delitem__` attribute. I'm changing this in #24270.



---

archive/issue_comments_168957.json:
```json
{
    "body": "<a id='comment:254'></a>\nReplying to [jdemeyer](#comment%3A253):\n> Small question: is there are particular reason for writing\n> \n> ```\n> self.__dict__.__delitem__('element_class')\n> ```\n> instead of\n> \n> ```\n> del self.__dict__['element_class']\n> ```\n> The latter is faster because it bypasses the lookup of the `__delitem__` attribute. I'm changing this in #24270.\n\n\nWhen I wrote that line, I was ignorant of the difference in performance. Actually I even thought that `del self.__dict__['element_class']` was *slower*, since I expected that the Python interpreter first needs to translate that statement into an attribute lookup that it subsequently has to do anyway.\n\nMeanwhile I know better and wouldn't write it again in that way.\n\nOnce again: I HATE THE TRAC WEB INTERFACE!!! While I write these lines, every few seconds the browser window becomes blank and (when I start scrolling and continue writing) reappears in a totally different place. It is a VERY SERIOUS pain in the neck!",
    "created_at": "2017-11-23T09:41:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11900#issuecomment-168957",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:254'></a>
Replying to [jdemeyer](#comment%3A253):
> Small question: is there are particular reason for writing
> 
> ```
> self.__dict__.__delitem__('element_class')
> ```
> instead of
> 
> ```
> del self.__dict__['element_class']
> ```
> The latter is faster because it bypasses the lookup of the `__delitem__` attribute. I'm changing this in #24270.


When I wrote that line, I was ignorant of the difference in performance. Actually I even thought that `del self.__dict__['element_class']` was *slower*, since I expected that the Python interpreter first needs to translate that statement into an attribute lookup that it subsequently has to do anyway.

Meanwhile I know better and wouldn't write it again in that way.

Once again: I HATE THE TRAC WEB INTERFACE!!! While I write these lines, every few seconds the browser window becomes blank and (when I start scrolling and continue writing) reappears in a totally different place. It is a VERY SERIOUS pain in the neck!
