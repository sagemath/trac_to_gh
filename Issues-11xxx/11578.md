# Issue 11578: elliptic curve isogeny: error in documentation and a comment

archive/issues_011406.json:
```json
{
    "body": "The isogeny code claims to check whether the input is valid, but it does not.  The algorithm checks only that the polynomial defines a subset of the n-torsion, not that it describes a *subgroup*.  This tiny patches fixes the documentation to not blatantly lie. \n\nAlso, there is a \"vast\" that should be \"fast\" in a comment.  \n\nAssignee: @JohnCremona\n\nResolution: fixed\n\nAuthor: William Stein\n\nReviewer: Dan Shumow\n\nMerged: sage-4.7.2.alpha1\n\nIssue created by migration from https://trac.sagemath.org/ticket/11578\n\n",
    "closed_at": "2011-07-28T10:24:13Z",
    "created_at": "2011-07-05T22:19:58Z",
    "labels": [
        "component: elliptic curves",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.7.2",
    "title": "elliptic curve isogeny: error in documentation and a comment",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11578",
    "user": "https://github.com/williamstein"
}
```
The isogeny code claims to check whether the input is valid, but it does not.  The algorithm checks only that the polynomial defines a subset of the n-torsion, not that it describes a *subgroup*.  This tiny patches fixes the documentation to not blatantly lie. 

Also, there is a "vast" that should be "fast" in a comment.  

Assignee: @JohnCremona

Resolution: fixed

Author: William Stein

Reviewer: Dan Shumow

Merged: sage-4.7.2.alpha1

Issue created by migration from https://trac.sagemath.org/ticket/11578





---

archive/issue_comments_160760.json:
```json
{
    "body": "Changing assignee from tbd to @JohnCremona.",
    "created_at": "2011-07-05T22:20:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11578",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11578#issuecomment-160760",
    "user": "https://github.com/williamstein"
}
```

Changing assignee from tbd to @JohnCremona.



---

archive/issue_comments_160761.json:
```json
{
    "body": "<a id='comment:2'></a>\nNote: The docstring in this patch is invalid ReST, i.e., the bulleted list is misformated.  This is the case for dozens (!) of the docstrings in this file.  Fixing this should be done later as a single separate patch.",
    "created_at": "2011-07-05T22:33:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11578",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11578#issuecomment-160761",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:2'></a>
Note: The docstring in this patch is invalid ReST, i.e., the bulleted list is misformated.  This is the case for dozens (!) of the docstrings in this file.  Fixing this should be done later as a single separate patch.



---

archive/issue_comments_160762.json:
```json
{
    "body": "<a id='comment:3'></a>\nAttachment [trac_11578.patch](tarball://root/attachments/some-uuid/ticket11578/trac_11578.patch) by @williamstein created at 2011-07-05 22:34:07",
    "created_at": "2011-07-05T22:34:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11578",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11578#issuecomment-160762",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:3'></a>
Attachment [trac_11578.patch](tarball://root/attachments/some-uuid/ticket11578/trac_11578.patch) by @williamstein created at 2011-07-05 22:34:07



---

archive/issue_comments_160763.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-07-05T22:34:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11578",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11578#issuecomment-160763",
    "user": "https://github.com/williamstein"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_160764.json:
```json
{
    "body": "<a id='comment:4'></a>\nPositive review from Dan Shumow (original author of the code): \"Looks good to me. -D\"",
    "created_at": "2011-07-05T22:56:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11578",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11578#issuecomment-160764",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:4'></a>
Positive review from Dan Shumow (original author of the code): "Looks good to me. -D"



---

archive/issue_comments_160765.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-07-05T22:56:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11578",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11578#issuecomment-160765",
    "user": "https://github.com/williamstein"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_160766.json:
```json
{
    "body": "<a id='comment:5'></a>\nComment (about the comment and examples added):  I have code (written by Kimi Tsukazaki) which checks properly that a given kernel polynomial is genuine, which I have been meaning to make into a patch for a long time.  It is not very cheap to run though, so we would need to have a \"check=False\" parameter.",
    "created_at": "2011-07-06T08:49:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11578",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11578#issuecomment-160766",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:5'></a>
Comment (about the comment and examples added):  I have code (written by Kimi Tsukazaki) which checks properly that a given kernel polynomial is genuine, which I have been meaning to make into a patch for a long time.  It is not very cheap to run though, so we would need to have a "check=False" parameter.



---

archive/issue_comments_160767.json:
```json
{
    "body": "<a id='comment:6'></a>\nI also now have code that does this, which I wrote with my REU students.  It is also not for free speedwise.  Here is all the relevant code (this actually finds the whole isogeny class over any number field, using isogenies up to a given degree):\n\n```\n#########################################################\n#############       isogeny classes   ###############\n#########################################################\n        \ndef ap(E,p):\n    return E.change_ring(p.residue_field()).trace_of_frobenius()\n\nR.<ch> = GF(2)[]    \ndef frob(E,p):\n    t = ap(E,p)\n    return ch^2 - ap(E, p)*ch + int(p.norm())\n   \ndef disc(E, p):\n    t = ap(E, p)\n    return t^2 - 4*p.norm()\n\ndef isogeny_primes(E, norm_bound, isog_degree_bound):          #Returns prime for which E has an isogeny\n    P = [p for p in sqrt5.ideals_of_bounded_norm(norm_bound) if p.is_prime() and E.has_good_reduction(p)]\n    w = set(primes(isog_degree_bound+1))\n    i = 0\n    w.remove(2)\n    while len(w) > 0 and i < len(P):\n        d = disc(E, P[i])\n        w = [ell for ell in w if not (legendre_symbol(d,ell) == -1)]\n        i = i +1\n    i = 0\n    while i < len(P):\n        if frob(E,P[i]).is_irreducible():\n            break\n        i = i+1    \n    if i == len(P):\n        w.insert(0,2)     \n    return w\n\ndef closed_under_multiplication_by_m(E, f, m):\n    \"\"\"\n    INPUT:\n        - E -- elliptic curve in *short* Weierstrass form\n        - f -- a polynomial that defines a finite subset S of E[p] that is closed under [-1]\n        - m -- integer m >= 2 coprime to p.\n        \n    We assume that p is odd.\n        \n    OUTPUT:\n        - True if [m]*S = S, and False otherwise.\n    \"\"\"\n    K = E.base_field()\n    h = E.multiplication_by_m(m, x_only=True)\n    n = h.numerator(); d = h.denominator()\n    S.<x, Z> = K[]\n    psi = n.parent().hom([x,0])\n    tau = f.parent().hom([x])    \n    r = tau(f).resultant(psi(n)-Z*psi(d), x)\n    r0 = S.hom([0,f.parent().gen()])(r)\n    return r0.monic() == f.monic()\n\ndef is_subgroup(E, f, p):\n    \"\"\"\n    INPUT:\n        - E -- elliptic curve in *short* Weierstrass form\n        - f -- a polynomial that defines a finite subset S of E[p] that is closed under [-1]\n        - p -- an odd prime\n        \n    OUTPUT:\n        - True exactly if S union {0} is a group.\n    \"\"\"\n    m = primitive_root(p)\n    return closed_under_multiplication_by_m(E, f, m)\n\ndef isogeny_class_computation(E, p):\n    if p != 2:\n        E = E.short_weierstrass_model()\n        F = E.division_polynomial(p).change_ring(K)\n        candidates = [f for f in divisors(F) if f.degree() == (p-1)/2 and is_subgroup(E,f,p)]\n        v = []\n        w = [] \n        for f in candidates:\n            try:\n                v.append(E.change_ring(K).isogeny(f).codomain())\n                w.append(f)\n            except ValueError:\n                pass\n        v = [F.change_ring(K).global_minimal_model() for F in v]\n        return v\n    else:\n        w = [Q for Q in E.torsion_subgroup() if order(Q)==2]\n        v = [E.isogeny(E(Q)).codomain() for Q in w]\n        return v\n        \ndef curve_isogeny_vector(E):            #Returns isogeny class and adjacency matrix\n    curve_list = [E]\n    i = 0\n    Adj = matrix(50)\n    ins = 1\n    norm_bound, isog_degree_bound = 500,500\n    while i < len(curve_list):\n        isolist = isogeny_primes(curve_list[i],norm_bound, isog_degree_bound)\n        for p in isolist:\n            for F in isogeny_class_computation(curve_list[i],p):\n                bool = True\n                for G in curve_list:\n                    if F.is_isomorphic(G):\n                        bool = False\n                        Adj[i,curve_list.index(G)]=p      #if a curve in the isogeny class computation is isom\n                        Adj[curve_list.index(G),i]=p      #to a curve already in the list, we want a line\n                        \n                if bool:\n                    curve_list.append(F)\n                    Adj[i,ins]=p\n                    Adj[ins,i]=p\n                    ins += 1\n        i+=1  \n    Adj = Adj.submatrix(nrows=len(curve_list),ncols=len(curve_list))\n    return {'curve_list':curve_list, 'adjacency_matrix':Adj, 'norm_bound':norm_bound, 'isog_degree_bound':isog_degree_bound, 'subgroup_checked':True}\n```",
    "created_at": "2011-07-14T10:27:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11578",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11578#issuecomment-160767",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:6'></a>
I also now have code that does this, which I wrote with my REU students.  It is also not for free speedwise.  Here is all the relevant code (this actually finds the whole isogeny class over any number field, using isogenies up to a given degree):

```
#########################################################
#############       isogeny classes   ###############
#########################################################
        
def ap(E,p):
    return E.change_ring(p.residue_field()).trace_of_frobenius()

R.<ch> = GF(2)[]    
def frob(E,p):
    t = ap(E,p)
    return ch^2 - ap(E, p)*ch + int(p.norm())
   
def disc(E, p):
    t = ap(E, p)
    return t^2 - 4*p.norm()

def isogeny_primes(E, norm_bound, isog_degree_bound):          #Returns prime for which E has an isogeny
    P = [p for p in sqrt5.ideals_of_bounded_norm(norm_bound) if p.is_prime() and E.has_good_reduction(p)]
    w = set(primes(isog_degree_bound+1))
    i = 0
    w.remove(2)
    while len(w) > 0 and i < len(P):
        d = disc(E, P[i])
        w = [ell for ell in w if not (legendre_symbol(d,ell) == -1)]
        i = i +1
    i = 0
    while i < len(P):
        if frob(E,P[i]).is_irreducible():
            break
        i = i+1    
    if i == len(P):
        w.insert(0,2)     
    return w

def closed_under_multiplication_by_m(E, f, m):
    """
    INPUT:
        - E -- elliptic curve in *short* Weierstrass form
        - f -- a polynomial that defines a finite subset S of E[p] that is closed under [-1]
        - m -- integer m >= 2 coprime to p.
        
    We assume that p is odd.
        
    OUTPUT:
        - True if [m]*S = S, and False otherwise.
    """
    K = E.base_field()
    h = E.multiplication_by_m(m, x_only=True)
    n = h.numerator(); d = h.denominator()
    S.<x, Z> = K[]
    psi = n.parent().hom([x,0])
    tau = f.parent().hom([x])    
    r = tau(f).resultant(psi(n)-Z*psi(d), x)
    r0 = S.hom([0,f.parent().gen()])(r)
    return r0.monic() == f.monic()

def is_subgroup(E, f, p):
    """
    INPUT:
        - E -- elliptic curve in *short* Weierstrass form
        - f -- a polynomial that defines a finite subset S of E[p] that is closed under [-1]
        - p -- an odd prime
        
    OUTPUT:
        - True exactly if S union {0} is a group.
    """
    m = primitive_root(p)
    return closed_under_multiplication_by_m(E, f, m)

def isogeny_class_computation(E, p):
    if p != 2:
        E = E.short_weierstrass_model()
        F = E.division_polynomial(p).change_ring(K)
        candidates = [f for f in divisors(F) if f.degree() == (p-1)/2 and is_subgroup(E,f,p)]
        v = []
        w = [] 
        for f in candidates:
            try:
                v.append(E.change_ring(K).isogeny(f).codomain())
                w.append(f)
            except ValueError:
                pass
        v = [F.change_ring(K).global_minimal_model() for F in v]
        return v
    else:
        w = [Q for Q in E.torsion_subgroup() if order(Q)==2]
        v = [E.isogeny(E(Q)).codomain() for Q in w]
        return v
        
def curve_isogeny_vector(E):            #Returns isogeny class and adjacency matrix
    curve_list = [E]
    i = 0
    Adj = matrix(50)
    ins = 1
    norm_bound, isog_degree_bound = 500,500
    while i < len(curve_list):
        isolist = isogeny_primes(curve_list[i],norm_bound, isog_degree_bound)
        for p in isolist:
            for F in isogeny_class_computation(curve_list[i],p):
                bool = True
                for G in curve_list:
                    if F.is_isomorphic(G):
                        bool = False
                        Adj[i,curve_list.index(G)]=p      #if a curve in the isogeny class computation is isom
                        Adj[curve_list.index(G),i]=p      #to a curve already in the list, we want a line
                        
                if bool:
                    curve_list.append(F)
                    Adj[i,ins]=p
                    Adj[ins,i]=p
                    ins += 1
        i+=1  
    Adj = Adj.submatrix(nrows=len(curve_list),ncols=len(curve_list))
    return {'curve_list':curve_list, 'adjacency_matrix':Adj, 'norm_bound':norm_bound, 'isog_degree_bound':isog_degree_bound, 'subgroup_checked':True}
```



---

archive/issue_comments_160768.json:
```json
{
    "body": "Reviewer: Dan Shumow",
    "created_at": "2011-07-22T17:16:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11578",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11578#issuecomment-160768",
    "user": "https://github.com/jdemeyer"
}
```

Reviewer: Dan Shumow



---

archive/issue_comments_160769.json:
```json
{
    "body": "Author: William Stein",
    "created_at": "2011-07-22T17:16:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11578",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11578#issuecomment-160769",
    "user": "https://github.com/jdemeyer"
}
```

Author: William Stein



---

archive/issue_comments_160770.json:
```json
{
    "body": "Merged: sage-4.7.2.alpha1",
    "created_at": "2011-07-28T10:24:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11578",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11578#issuecomment-160770",
    "user": "https://github.com/jdemeyer"
}
```

Merged: sage-4.7.2.alpha1



---

archive/issue_events_035962.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-07-28T10:24:13Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/11578",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11578#event-35962"
}
```



---

archive/issue_comments_160771.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-07-28T10:24:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11578",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11578#issuecomment-160771",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
