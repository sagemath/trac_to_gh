# Issue 11338: Fix signals/interrupts in sage-doctest

archive/issues_011166.json:
```json
{
    "body": "When a doctest gets the dreaded **Unhandled SIGSEGV...**, the doctest script doesn't know how to handle this if the killed process is the child of `/bin/sh`, not `/bin/sh` itself.  Newer versions of `bash` automatically do `execve()` instead of `fork()` when there is only one command to run, so the problem does not appear then.  The fix is to always `exec` or even better, not using a shell at all.  Consider [attachment:sigdie.py].  Running this on forking shells gives:\n\n```\nsage -t  \"/home/jdemeyer/sigdie.py\"\n/home/jdemeyer/sage/sage-4.7.alpha5/local/lib/libcsage.so(print_backtrace+0x31)[0x7f66bf2dd415]\n[...]\n/lib/libpython2.6.so.1.0(Py_Main+0xb4e)[0x7f66c2aa4e7e]\n/lib/libc.so.6(__libc_start_main+0xf4)[0x7f66c1da11c4]\npython[0x400619]\n\n------------------------------------------------------------------------\nUnhandled SIGSEGV: A segmentation fault occurred in Sage.\nThis probably occurred because a *compiled* component of Sage has a bug\nin it and is not properly wrapped with sig_on(), sig_off(). You might\nwant to run Sage under gdb with 'sage -gdb' to debug this.\nSage will now terminate.\n------------------------------------------------------------------------\nSegmentation fault\n\n         [2.8 s]\n\n----------------------------------------------------------------------\nThe following tests failed:\n\n\n        sage -t  \"/home/jdemeyer/sigdie.py\"\nTotal time for all tests: 2.9 seconds\n```\nwhen it should give:\n\n```\nsage -t  \"devel/sage/sage/testdoctest/sigdie.py\"\nThe doctested process was killed by signal 11\n         [6.3 s]\n\n----------------------------------------------------------------------\nThe following tests failed:\n\n\n        sage -t  \"devel/sage/sage/testdoctest/sigdie.py\" # Killed/crashed\nTotal time for all tests: 6.4 seconds\n```\n\nAnother sympton is that a doctest TIME OUT kills the wrong process: it kills the shell, not the actual Python command.\n\nAssignee: tbd\n\nCC:  @kini\n\nReviewer: Jeroen Demeyer\n\nResolution: duplicate\n\nIssue created by migration from https://trac.sagemath.org/ticket/11338\n\n",
    "closed_at": "2013-03-07T08:11:51Z",
    "created_at": "2011-05-16T19:41:50Z",
    "labels": [
        "component: scripts",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Fix signals/interrupts in sage-doctest",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11338",
    "user": "https://github.com/jdemeyer"
}
```
When a doctest gets the dreaded **Unhandled SIGSEGV...**, the doctest script doesn't know how to handle this if the killed process is the child of `/bin/sh`, not `/bin/sh` itself.  Newer versions of `bash` automatically do `execve()` instead of `fork()` when there is only one command to run, so the problem does not appear then.  The fix is to always `exec` or even better, not using a shell at all.  Consider [attachment:sigdie.py].  Running this on forking shells gives:

```
sage -t  "/home/jdemeyer/sigdie.py"
/home/jdemeyer/sage/sage-4.7.alpha5/local/lib/libcsage.so(print_backtrace+0x31)[0x7f66bf2dd415]
[...]
/lib/libpython2.6.so.1.0(Py_Main+0xb4e)[0x7f66c2aa4e7e]
/lib/libc.so.6(__libc_start_main+0xf4)[0x7f66c1da11c4]
python[0x400619]

------------------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred in Sage.
This probably occurred because a *compiled* component of Sage has a bug
in it and is not properly wrapped with sig_on(), sig_off(). You might
want to run Sage under gdb with 'sage -gdb' to debug this.
Sage will now terminate.
------------------------------------------------------------------------
Segmentation fault

         [2.8 s]

----------------------------------------------------------------------
The following tests failed:


        sage -t  "/home/jdemeyer/sigdie.py"
Total time for all tests: 2.9 seconds
```
when it should give:

```
sage -t  "devel/sage/sage/testdoctest/sigdie.py"
The doctested process was killed by signal 11
         [6.3 s]

----------------------------------------------------------------------
The following tests failed:


        sage -t  "devel/sage/sage/testdoctest/sigdie.py" # Killed/crashed
Total time for all tests: 6.4 seconds
```

Another sympton is that a doctest TIME OUT kills the wrong process: it kills the shell, not the actual Python command.

Assignee: tbd

CC:  @kini

Reviewer: Jeroen Demeyer

Resolution: duplicate

Issue created by migration from https://trac.sagemath.org/ticket/11338





---

archive/issue_comments_122319.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2011-05-16T19:42:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11338#issuecomment-122319",
    "user": "https://github.com/jdemeyer"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_122320.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to scripts.",
    "created_at": "2011-05-16T19:42:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11338#issuecomment-122320",
    "user": "https://github.com/jdemeyer"
}
```

Changing component from PLEASE CHANGE to scripts.



---

archive/issue_comments_122321.json:
```json
{
    "body": "Doctest showing the failure (1)",
    "created_at": "2011-05-16T20:29:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11338#issuecomment-122321",
    "user": "https://github.com/jdemeyer"
}
```

Doctest showing the failure (1)



---

archive/issue_comments_122322.json:
```json
{
    "body": "<a id='comment:4'></a>Attachment [sigdie.py](tarball://root/attachments/some-uuid/ticket11338/sigdie.py) by @jdemeyer created at 2011-05-16 20:30:41",
    "created_at": "2011-05-16T20:30:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11338#issuecomment-122322",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>Attachment [sigdie.py](tarball://root/attachments/some-uuid/ticket11338/sigdie.py) by @jdemeyer created at 2011-05-16 20:30:41



---

archive/issue_comments_122323.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2012-03-30T13:50:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11338#issuecomment-122323",
    "user": "https://github.com/jdemeyer"
}
```

Changing priority from major to critical.



---

archive/issue_comments_122324.json:
```json
{
    "body": "<a id='comment:11'></a>Superseded by #12415.",
    "created_at": "2013-02-28T15:57:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11338#issuecomment-122324",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>Superseded by #12415.



---

archive/issue_events_029412.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-28T15:57:06Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11338",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11338#event-29412"
}
```



---

archive/issue_comments_122325.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-02-28T15:57:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11338#issuecomment-122325",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_122326.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-02-28T15:57:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11338#issuecomment-122326",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_029413.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-03-07T08:11:51Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/11338",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11338#event-29413"
}
```



---

archive/issue_comments_122327.json:
```json
{
    "body": "Resolution: duplicate",
    "created_at": "2013-03-07T08:11:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11338#issuecomment-122327",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: duplicate
