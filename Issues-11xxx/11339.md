# Issue 11339: Refcounting for Singular rings

archive/issues_011167.json:
```json
{
    "body": "# Ref counting for Singular rings\n\nPython makes no guarantees that destructors are called if circular references are involved. This patch implements an extra Python proxy layer that correctly refcounts Singular rings. In contrast to our earlier code, it will release the singular rings once they are no longer in use. This triggers various issues in Sage/libSingular that are dealt with in the follow-up ticket #10903\n\n# Historic discussion\n\nAs [described for the Sage on Gentoo project](https://github.com/cschwan/sage-on-gentoo/issues/51#issuecomment-1181259), there is a problem in how parts of sage use `__deallocate__` in their Cython code. I've actually traced an instance of [groebner_strategy.pyx](http://hg.sagemath.org/sage-main/file/361a4ad7d52c/sage/libs/singular/groebner_strategy.pyx#l134) causing segmentation faults under Python 2.7.\n\nWhat happens is that the garbage collector invokes the [tp_clear](http://docs.python.org/c-api/typeobj.html#tp_clear) function for the object. Its implementation is provided by Cython, and one of its effects is that every python reference will be set to `None`. A bit later on, [tp_dealloc](http://docs.python.org/c-api/typeobj.html#tp_dealloc) is called and invokes the `__deallocate__` method. By that time, `_parent` is `None`, so accessing `_parent._ring` is a bad idea, and in this case it turns out to be null.\n\nOthers have had similar problems before. There are [crude workarounds](http://stackoverflow.com/questions/4501938/how-can-c-object-lifetimes-be-correctly-managed-in-cython) floating around. I guess a proper solution would be twaking cython to allow custom code in the tp_clear function. In other words, have a \"magic\" mehod `__clear__` similar to the magic `__deallocate__`. But I'll wait for comments here first, before taking this to cython upstream. Perhaps people with more experience have better solutions to offer. And I won't mind if you decide to take this to Cython devs yourselves.\n\n# Apply\n\nApply:\n* [attachment:trac_11339_refcount_singular_rings.patch]\n* [attachment:trac_11339_refcount_singular_polynomials.patch]\n\n\nDepends on #10903\n\n**Assignee:** drkirkby\n\n**CC:**  @kiwifb @robertwb @burcin @malb @simon-king-jena @nexttime\n\n**Keywords:** sd31\n\n**Author:** Volker Braun, Martin von Gagern\n\n**Reviewer:** Fran\u00e7ois Bissey, Steven Trogdon, Martin Albrecht\n\n**Merged:** sage-4.7.2.alpha4\n\n**Dependencies:** #10903 (for doctests)\n\nIssue created by migration from https://trac.sagemath.org/ticket/11339\n\n",
    "closed_at": "2011-10-07T19:11:39Z",
    "created_at": "2011-05-16T21:05:24Z",
    "labels": [
        "component: algebra",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-4.7.2",
    "title": "Refcounting for Singular rings",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/11339",
    "user": "https://github.com/gagern"
}
```
# Ref counting for Singular rings

Python makes no guarantees that destructors are called if circular references are involved. This patch implements an extra Python proxy layer that correctly refcounts Singular rings. In contrast to our earlier code, it will release the singular rings once they are no longer in use. This triggers various issues in Sage/libSingular that are dealt with in the follow-up ticket #10903

# Historic discussion

As [described for the Sage on Gentoo project](https://github.com/cschwan/sage-on-gentoo/issues/51#issuecomment-1181259), there is a problem in how parts of sage use `__deallocate__` in their Cython code. I've actually traced an instance of [groebner_strategy.pyx](http://hg.sagemath.org/sage-main/file/361a4ad7d52c/sage/libs/singular/groebner_strategy.pyx#l134) causing segmentation faults under Python 2.7.

What happens is that the garbage collector invokes the [tp_clear](http://docs.python.org/c-api/typeobj.html#tp_clear) function for the object. Its implementation is provided by Cython, and one of its effects is that every python reference will be set to `None`. A bit later on, [tp_dealloc](http://docs.python.org/c-api/typeobj.html#tp_dealloc) is called and invokes the `__deallocate__` method. By that time, `_parent` is `None`, so accessing `_parent._ring` is a bad idea, and in this case it turns out to be null.

Others have had similar problems before. There are [crude workarounds](http://stackoverflow.com/questions/4501938/how-can-c-object-lifetimes-be-correctly-managed-in-cython) floating around. I guess a proper solution would be twaking cython to allow custom code in the tp_clear function. In other words, have a "magic" mehod `__clear__` similar to the magic `__deallocate__`. But I'll wait for comments here first, before taking this to cython upstream. Perhaps people with more experience have better solutions to offer. And I won't mind if you decide to take this to Cython devs yourselves.

# Apply

Apply:
* [attachment:trac_11339_refcount_singular_rings.patch]
* [attachment:trac_11339_refcount_singular_polynomials.patch]


Depends on #10903

**Assignee:** drkirkby

**CC:**  @kiwifb @robertwb @burcin @malb @simon-king-jena @nexttime

**Keywords:** sd31

**Author:** Volker Braun, Martin von Gagern

**Reviewer:** François Bissey, Steven Trogdon, Martin Albrecht

**Merged:** sage-4.7.2.alpha4

**Dependencies:** #10903 (for doctests)

Issue created by migration from https://trac.sagemath.org/ticket/11339





---

archive/issue_comments_116239.json:
```json
{
    "body": "<a id='comment:2'></a>\nThe documentation is fairly clear, you are only allowed to touch C data structures in `__dealloc__`: http://docs.cython.org/src/userguide/special_methods.html#finalization-method-dealloc\n\nReally, this shows the difference between the C++ and the Python object model. In Python, executing constructors/destructors in derived classes is optional and leaves a lot of freedom to the programmer. Because of the garbage collection you can allocate resources wherever you want. By comparison, C++ is very strict and essentially forces you to use RAII. This is why there is no try/finally in C++. Which is why there is necessarily some tension in Cython between C++ and Python object instantiation/finalization.\n\nHaving said that, it seems like the cleanest solution would be if Cython would also call the Python destructor `__del__` according to the normal Python rules (why `__clear__`?). Then the Python and C++ object model could just peacefully coexist. The lifetime of a cdef class would be\n\n```\n__cinit__()    # always called\n__init__()     # not necessarily called for derived classes\n... do something ...\n__del__()      # not necessarily called for derived classes\n__dealloc__()  # always called\n```",
    "created_at": "2011-05-17T09:40:39Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116239",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:2'></a>
The documentation is fairly clear, you are only allowed to touch C data structures in `__dealloc__`: http://docs.cython.org/src/userguide/special_methods.html#finalization-method-dealloc

Really, this shows the difference between the C++ and the Python object model. In Python, executing constructors/destructors in derived classes is optional and leaves a lot of freedom to the programmer. Because of the garbage collection you can allocate resources wherever you want. By comparison, C++ is very strict and essentially forces you to use RAII. This is why there is no try/finally in C++. Which is why there is necessarily some tension in Cython between C++ and Python object instantiation/finalization.

Having said that, it seems like the cleanest solution would be if Cython would also call the Python destructor `__del__` according to the normal Python rules (why `__clear__`?). Then the Python and C++ object model could just peacefully coexist. The lifetime of a cdef class would be

```
__cinit__()    # always called
__init__()     # not necessarily called for derived classes
... do something ...
__del__()      # not necessarily called for derived classes
__dealloc__()  # always called
```



---

archive/issue_comments_116240.json:
```json
{
    "body": "<a id='comment:3'></a>\nThanks for your input Volker. I think we should definitely put some work in libs/singular to have some `__del__` and `__dealloc__` functions. I think the current state of things in there is a bit messy. I remember reading about `__del__` in the python doc about garbage collection and wondering why singular_ring_delete in libs/singular/rings.pyx wasn't a `__del__` method instead as its intent is clear.",
    "created_at": "2011-05-17T11:36:31Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116240",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:3'></a>
Thanks for your input Volker. I think we should definitely put some work in libs/singular to have some `__del__` and `__dealloc__` functions. I think the current state of things in there is a bit messy. I remember reading about `__del__` in the python doc about garbage collection and wondering why singular_ring_delete in libs/singular/rings.pyx wasn't a `__del__` method instead as its intent is clear.



---

archive/issue_comments_116241.json:
```json
{
    "body": "<a id='comment:4'></a>\nJust to clarify, right now Cython extension classes do not call the Python destructor `__del__` upon finalization, so Sage can't rely on this mechanism. I'm not quite sure if it is an intentional thing or if the Cython devs just haven't gotten around to implementing it. Maybe we can hack on that on Sage Days 31 since both Robert and Burcin will be around :-)",
    "created_at": "2011-05-17T11:43:39Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116241",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:4'></a>
Just to clarify, right now Cython extension classes do not call the Python destructor `__del__` upon finalization, so Sage can't rely on this mechanism. I'm not quite sure if it is an intentional thing or if the Cython devs just haven't gotten around to implementing it. Maybe we can hack on that on Sage Days 31 since both Robert and Burcin will be around :-)



---

archive/issue_comments_116242.json:
```json
{
    "body": "<a id='comment:5'></a>\nOK, well something as to be done about this if we want to move to python-2.7. I think this problem is probably the biggest issue in the way of #9958 there are a few other things to look at but that's the only one producing a segfault.",
    "created_at": "2011-05-17T11:53:55Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116242",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:5'></a>
OK, well something as to be done about this if we want to move to python-2.7. I think this problem is probably the biggest issue in the way of #9958 there are a few other things to look at but that's the only one producing a segfault.



---

archive/issue_comments_116243.json:
```json
{
    "body": "<a id='comment:6'></a>\nI notice that [PyTypeObject](http://svn.python.org/view/python/branches/release27-maint/Include/object.h?revision=84346&view=markup) has a member `tp_del` which is not included in [the documentation](http://docs.python.org/c-api/typeobj.html). So perhaps it's as simple as associating a function with that slot. Otoh, perhaps there is a reason that member isn't documented. The single reply to [Python issue 4934](http://bugs.python.org/issue4934) doesn't rule out that possibility.",
    "created_at": "2011-05-17T12:21:09Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116243",
    "user": "https://github.com/gagern"
}
```

<a id='comment:6'></a>
I notice that [PyTypeObject](http://svn.python.org/view/python/branches/release27-maint/Include/object.h?revision=84346&view=markup) has a member `tp_del` which is not included in [the documentation](http://docs.python.org/c-api/typeobj.html). So perhaps it's as simple as associating a function with that slot. Otoh, perhaps there is a reason that member isn't documented. The single reply to [Python issue 4934](http://bugs.python.org/issue4934) doesn't rule out that possibility.



---

archive/issue_comments_116244.json:
```json
{
    "body": "Workaround patch",
    "created_at": "2011-06-03T10:50:52Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116244",
    "user": "https://github.com/gagern"
}
```

Workaround patch



---

archive/attachments_014864.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "bug11339a.patch",
    "asset_url": "tarball://root/attachments/ticket11339/bug11339a.patch",
    "created_at": "2011-06-03T10:51:10Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket11339/bug11339a.patch",
    "user": "https://github.com/gagern"
}
```



---

archive/issue_comments_116245.json:
```json
{
    "body": "Attachment [bug11339a.patch](https://github.com/sagemath/sage/files/ticket11339/bug11339a.patch) by @gagern created at 2011-06-03 10:51:10\n\nWorkaround hg bundle",
    "created_at": "2011-06-03T10:51:10Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116245",
    "user": "https://github.com/gagern"
}
```

Attachment [bug11339a.patch](https://github.com/sagemath/sage/files/ticket11339/bug11339a.patch) by @gagern created at 2011-06-03 10:51:10

Workaround hg bundle



---

archive/attachments_014865.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "bug11339a.bundle",
    "asset_url": "tarball://root/attachments/ticket11339/bug11339a.bundle",
    "created_at": "2011-06-14T03:15:57Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket11339/bug11339a.bundle",
    "user": "https://github.com/kiwifb"
}
```



---

archive/issue_comments_116246.json:
```json
{
    "body": "<a id='comment:8'></a>\nAttachment [bug11339a.bundle](https://github.com/sagemath/sage/files/ticket11339/bug11339a.bundle) by @kiwifb created at 2011-06-14 03:15:57\n\nFor the record this works with sage-on-gentoo with python-2.7.1 so as far as I am concerned it works as advertised so far. I can do a review against a vanilla sage using python-2.6 later this week provided that I get the all clear to go back to work (we got a couple more earthquakes down here - the magnitude 6 one was scary but very few people got hurt).\n\nWhat is the \"workaround hg bundle\" Martin? I can reformat things if needed.",
    "created_at": "2011-06-14T03:15:57Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116246",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:8'></a>
Attachment [bug11339a.bundle](https://github.com/sagemath/sage/files/ticket11339/bug11339a.bundle) by @kiwifb created at 2011-06-14 03:15:57

For the record this works with sage-on-gentoo with python-2.7.1 so as far as I am concerned it works as advertised so far. I can do a review against a vanilla sage using python-2.6 later this week provided that I get the all clear to go back to work (we got a couple more earthquakes down here - the magnitude 6 one was scary but very few people got hurt).

What is the "workaround hg bundle" Martin? I can reformat things if needed.



---

archive/issue_events_089062.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2011-06-14T03:15:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89062"
}
```



---

archive/issue_comments_116247.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [fbissey](#comment%3A8):\n> What is the \"workaround hg bundle\" Martin? I can reformat things if needed.\n\n\nIt's what I perceived to be the hg equivalent of a \"bzr send\": a file which describes a number of hg commits inclusing metadata, so that other hg users can pull from it.\nSee hg manual for [unbundle](http://www.selenic.com/mercurial/hg.1.html#unbundle) and related documentation.",
    "created_at": "2011-06-14T20:58:58Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116247",
    "user": "https://github.com/gagern"
}
```

<a id='comment:9'></a>
Replying to [fbissey](#comment%3A8):
> What is the "workaround hg bundle" Martin? I can reformat things if needed.


It's what I perceived to be the hg equivalent of a "bzr send": a file which describes a number of hg commits inclusing metadata, so that other hg users can pull from it.
See hg manual for [unbundle](http://www.selenic.com/mercurial/hg.1.html#unbundle) and related documentation.



---

archive/issue_comments_116248.json:
```json
{
    "body": "<a id='comment:10'></a>\nHi Martin, Steve sent me a note about it earlier this morning. The patch is the only thing necessary here, am I right?",
    "created_at": "2011-06-14T21:32:34Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116248",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:10'></a>
Hi Martin, Steve sent me a note about it earlier this morning. The patch is the only thing necessary here, am I right?



---

archive/issue_comments_116249.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [fbissey](#comment%3A8):\n\n> For the record this works with sage-on-gentoo with python-2.7.1 so as far as I am concerned it works as advertised so far. I can do a review against a vanilla sage using python-2.6 later this week provided that I get the all clear to go back to work (we got a couple more earthquakes down here - the magnitude 6 one was scary but very few people got hurt). What is the \"workaround hg bundle\" Martin? I can reformat things if needed.\n\n\nThis patch works fine for me too on sage-on-gentoo with python-2.7.1. I have applied this patch to the vanilla sage-4.7.1.alpha2 (python-2.6.4.p10) spkg and all long tests pass. I have also applied the patch along with the patches and required spkgs in ticket\u00a0#9958\u00a0to the sage-4.7.1.alpha2 (python-2.7.1) spkg and all the tests that failed without this patch because of segfaults, i.e.\n\nsage -t \u00a0-force_lib \"devel/sage/sage/schemes/generic/scheme.py\"\n\nsage -t \u00a0-force_lib \"devel/sage/sage/rings/morphism.pyx\" \u00a0 \u00a0\n\nsage -t \u00a0-force_lib \"devel/sage/sage/rings/homset.py\"\n\nnow pass.",
    "created_at": "2011-06-14T23:16:54Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116249",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:11'></a>
Replying to [fbissey](#comment%3A8):

> For the record this works with sage-on-gentoo with python-2.7.1 so as far as I am concerned it works as advertised so far. I can do a review against a vanilla sage using python-2.6 later this week provided that I get the all clear to go back to work (we got a couple more earthquakes down here - the magnitude 6 one was scary but very few people got hurt). What is the "workaround hg bundle" Martin? I can reformat things if needed.


This patch works fine for me too on sage-on-gentoo with python-2.7.1. I have applied this patch to the vanilla sage-4.7.1.alpha2 (python-2.6.4.p10) spkg and all long tests pass. I have also applied the patch along with the patches and required spkgs in ticket #9958 to the sage-4.7.1.alpha2 (python-2.7.1) spkg and all the tests that failed without this patch because of segfaults, i.e.

sage -t  -force_lib "devel/sage/sage/schemes/generic/scheme.py"

sage -t  -force_lib "devel/sage/sage/rings/morphism.pyx"    

sage -t  -force_lib "devel/sage/sage/rings/homset.py"

now pass.



---

archive/issue_comments_116250.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -3,3 +3,6 @@\n What happens is that the garbage collector invokes the [tp_clear](http://docs.python.org/c-api/typeobj.html#tp_clear) function for the object. Its implementation is provided by Cython, and one of its effects is that every python reference will be set to `None`. A bit later on, [tp_dealloc](http://docs.python.org/c-api/typeobj.html#tp_dealloc) is called and invokes the `__deallocate__` method. By that time, `_parent` is `None`, so accessing `_parent._ring` is a bad idea, and in this case it turns out to be null.\n \n Others have had similar problems before. There are [crude workarounds](http://stackoverflow.com/questions/4501938/how-can-c-object-lifetimes-be-correctly-managed-in-cython) floating around. I guess a proper solution would be twaking cython to allow custom code in the tp_clear function. In other words, have a \"magic\" mehod `__clear__` similar to the magic `__deallocate__`. But I'll wait for comments here first, before taking this to cython upstream. Perhaps people with more experience have better solutions to offer. And I won't mind if you decide to take this to Cython devs yourselves.\n+\n+Apply:\n+* [attachment:bug11339a.patch]\n``````\n",
    "created_at": "2011-06-14T23:58:40Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116250",
    "user": "https://github.com/kiwifb"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -3,3 +3,6 @@
 What happens is that the garbage collector invokes the [tp_clear](http://docs.python.org/c-api/typeobj.html#tp_clear) function for the object. Its implementation is provided by Cython, and one of its effects is that every python reference will be set to `None`. A bit later on, [tp_dealloc](http://docs.python.org/c-api/typeobj.html#tp_dealloc) is called and invokes the `__deallocate__` method. By that time, `_parent` is `None`, so accessing `_parent._ring` is a bad idea, and in this case it turns out to be null.
 
 Others have had similar problems before. There are [crude workarounds](http://stackoverflow.com/questions/4501938/how-can-c-object-lifetimes-be-correctly-managed-in-cython) floating around. I guess a proper solution would be twaking cython to allow custom code in the tp_clear function. In other words, have a "magic" mehod `__clear__` similar to the magic `__deallocate__`. But I'll wait for comments here first, before taking this to cython upstream. Perhaps people with more experience have better solutions to offer. And I won't mind if you decide to take this to Cython devs yourselves.
+
+Apply:
+* [attachment:bug11339a.patch]
``````




---

archive/issue_comments_116251.json:
```json
{
    "body": "**Reviewer:** Fran\u00e7ois Bissey, Steven Trogdon",
    "created_at": "2011-06-14T23:58:40Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116251",
    "user": "https://github.com/kiwifb"
}
```

**Reviewer:** François Bissey, Steven Trogdon



---

archive/issue_events_089063.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2011-06-14T23:58:40Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89063"
}
```



---

archive/issue_events_089064.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2011-06-14T23:58:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89064"
}
```



---

archive/issue_comments_116252.json:
```json
{
    "body": "<a id='comment:12'></a>\nI am giving this a positive review on my and Steve's observations. I unfortunately won't be able to run some extra tests before Monday it seems.",
    "created_at": "2011-06-14T23:58:40Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116252",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:12'></a>
I am giving this a positive review on my and Steve's observations. I unfortunately won't be able to run some extra tests before Monday it seems.



---

archive/issue_comments_116253.json:
```json
{
    "body": "<a id='comment:13'></a>\nAs it is, the patch is spectacularly ugly. I agree that it works, but we should investigate alternatives. It is not a particularly pressing issue since Sage is not going to switch to Python-2.7 this week. I'll have a closer look at it with Burcin duing this week at SD31.",
    "created_at": "2011-06-15T00:07:16Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116253",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:13'></a>
As it is, the patch is spectacularly ugly. I agree that it works, but we should investigate alternatives. It is not a particularly pressing issue since Sage is not going to switch to Python-2.7 this week. I'll have a closer look at it with Burcin duing this week at SD31.



---

archive/issue_events_089065.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-06-15T00:07:16Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89065"
}
```



---

archive/issue_events_089066.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-06-15T00:07:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89066"
}
```



---

archive/issue_comments_116254.json:
```json
{
    "body": "<a id='comment:14'></a>\nI am ok with this. I don't plan to push python-2.7.1 in 4.7.1.\n \nI would like most of the other pending bits and pieces that will make testing easier to be in 4.7.1 however. It would be nice if at least some testing could be done in 4.7.2 and really land it by the next release.",
    "created_at": "2011-06-15T00:13:32Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116254",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:14'></a>
I am ok with this. I don't plan to push python-2.7.1 in 4.7.1.
 
I would like most of the other pending bits and pieces that will make testing easier to be in 4.7.1 however. It would be nice if at least some testing could be done in 4.7.2 and really land it by the next release.



---

archive/issue_comments_116255.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [vbraun](#comment%3A13):\n> As it is, the patch is spectacularly ugly. [...] we should investigate alternatives.\n\n\nI agree, that's why I titled the patch \"workaround\" instead of \"solution\". I can't think of a way to address this in sage alone, though, as in my opinion a proper solution would entail modifications to cython as discussed above.",
    "created_at": "2011-06-15T08:56:19Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116255",
    "user": "https://github.com/gagern"
}
```

<a id='comment:15'></a>
Replying to [vbraun](#comment%3A13):
> As it is, the patch is spectacularly ugly. [...] we should investigate alternatives.


I agree, that's why I titled the patch "workaround" instead of "solution". I can't think of a way to address this in sage alone, though, as in my opinion a proper solution would entail modifications to cython as discussed above.



---

archive/issue_comments_116256.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -5,4 +5,4 @@\n Others have had similar problems before. There are [crude workarounds](http://stackoverflow.com/questions/4501938/how-can-c-object-lifetimes-be-correctly-managed-in-cython) floating around. I guess a proper solution would be twaking cython to allow custom code in the tp_clear function. In other words, have a \"magic\" mehod `__clear__` similar to the magic `__deallocate__`. But I'll wait for comments here first, before taking this to cython upstream. Perhaps people with more experience have better solutions to offer. And I won't mind if you decide to take this to Cython devs yourselves.\n \n Apply:\n-* [attachment:bug11339a.patch]\n+* [attachment:trac_11339_illegal_use_of__deallocate__in_libsingular.patch]\n``````\n",
    "created_at": "2011-06-18T07:45:30Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116256",
    "user": "https://github.com/vbraun"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -5,4 +5,4 @@
 Others have had similar problems before. There are [crude workarounds](http://stackoverflow.com/questions/4501938/how-can-c-object-lifetimes-be-correctly-managed-in-cython) floating around. I guess a proper solution would be twaking cython to allow custom code in the tp_clear function. In other words, have a "magic" mehod `__clear__` similar to the magic `__deallocate__`. But I'll wait for comments here first, before taking this to cython upstream. Perhaps people with more experience have better solutions to offer. And I won't mind if you decide to take this to Cython devs yourselves.
 
 Apply:
-* [attachment:bug11339a.patch]
+* [attachment:trac_11339_illegal_use_of__deallocate__in_libsingular.patch]
``````




---

archive/issue_comments_116257.json:
```json
{
    "body": "<a id='comment:16'></a>\nIn the case at hand we don't really need the Cython class `GroebnerStrategy._parent`, only the C struct `GroebnerStrategy._parent._ring` is used in `__deallocate__()`. I've made a minimal patch that adds a `cdef ring *_parent_ring` data member to `GroebnerStrategy` to keep track of the ring only. Because it refers to a C struct, it is safe to access it the Cython destructor. Because parents are immutable we don't have to worry about the `ring *` pointer becoming invalid. \n\nThe patch should fix the crash, but I don't have a Sage-on-Python-2.7 install to test it. Can somebody give it a try?",
    "created_at": "2011-06-18T07:45:30Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116257",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:16'></a>
In the case at hand we don't really need the Cython class `GroebnerStrategy._parent`, only the C struct `GroebnerStrategy._parent._ring` is used in `__deallocate__()`. I've made a minimal patch that adds a `cdef ring *_parent_ring` data member to `GroebnerStrategy` to keep track of the ring only. Because it refers to a C struct, it is safe to access it the Cython destructor. Because parents are immutable we don't have to worry about the `ring *` pointer becoming invalid. 

The patch should fix the crash, but I don't have a Sage-on-Python-2.7 install to test it. Can somebody give it a try?



---

archive/issue_comments_116258.json:
```json
{
    "body": "**Author:** Volker Braun, Martin von Gagern",
    "created_at": "2011-06-18T07:45:30Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116258",
    "user": "https://github.com/vbraun"
}
```

**Author:** Volker Braun, Martin von Gagern



---

archive/issue_events_089067.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-06-18T07:45:30Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89067"
}
```



---

archive/issue_events_089068.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-06-18T07:45:30Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89068"
}
```



---

archive/issue_comments_116259.json:
```json
{
    "body": "**Changing keywords** from \"\" to \"sd31\".",
    "created_at": "2011-06-18T07:45:30Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116259",
    "user": "https://github.com/vbraun"
}
```

**Changing keywords** from "" to "sd31".



---

archive/issue_comments_116260.json:
```json
{
    "body": "Initial patch",
    "created_at": "2011-06-18T07:45:45Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116260",
    "user": "https://github.com/vbraun"
}
```

Initial patch



---

archive/attachments_014866.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_11339_illegal_use_of__deallocate__in_libsingular.patch",
    "asset_url": "tarball://root/attachments/ticket11339/trac_11339_illegal_use_of__deallocate__in_libsingular.patch",
    "created_at": "2011-06-18T08:52:47Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket11339/trac_11339_illegal_use_of__deallocate__in_libsingular.patch",
    "user": "https://github.com/gagern"
}
```



---

archive/issue_comments_116261.json:
```json
{
    "body": "<a id='comment:17'></a>\nAttachment [trac_11339_illegal_use_of__deallocate__in_libsingular.patch](https://github.com/sagemath/sage/files/ticket11339/trac_11339_illegal_use_of__deallocate__in_libsingular.patch) by @gagern created at 2011-06-18 08:52:47\n\nReplying to [vbraun](#comment%3A16):\n\nI had considered keeping only that C pointer, but decided against it.\n\n> Because parents are immutable we don't have to worry about the `ring *`\n> pointer becoming invalid.\n\n\nCan you explain this in more detail? Why does the parent object being immutable help in keeping the pointer valid? Do you mean that the parent cython object doesn't change it's ring member? That is correct, but not enough to make the approach safe: if you don't keep a reference to the parent python object around, python might decide to garbage-collect that first, leading to a call to the singula function rDelete. I guess that function at least frees the memory, so if you are unlucky, some thread will overwrite the memory that ring points to with completely different data. Of course, in most cases you'd be lucky, so you wouldn't notice the problem. But unless singular does some reference counting of its own in such a way that a rDelete call on the parent won't have immediate effect, your approach isn't safe.",
    "created_at": "2011-06-18T08:52:47Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116261",
    "user": "https://github.com/gagern"
}
```

<a id='comment:17'></a>
Attachment [trac_11339_illegal_use_of__deallocate__in_libsingular.patch](https://github.com/sagemath/sage/files/ticket11339/trac_11339_illegal_use_of__deallocate__in_libsingular.patch) by @gagern created at 2011-06-18 08:52:47

Replying to [vbraun](#comment%3A16):

I had considered keeping only that C pointer, but decided against it.

> Because parents are immutable we don't have to worry about the `ring *`
> pointer becoming invalid.


Can you explain this in more detail? Why does the parent object being immutable help in keeping the pointer valid? Do you mean that the parent cython object doesn't change it's ring member? That is correct, but not enough to make the approach safe: if you don't keep a reference to the parent python object around, python might decide to garbage-collect that first, leading to a call to the singula function rDelete. I guess that function at least frees the memory, so if you are unlucky, some thread will overwrite the memory that ring points to with completely different data. Of course, in most cases you'd be lucky, so you wouldn't notice the problem. But unless singular does some reference counting of its own in such a way that a rDelete call on the parent won't have immediate effect, your approach isn't safe.



---

archive/issue_comments_116262.json:
```json
{
    "body": "<a id='comment:18'></a>\nReplying to [vbraun](#comment%3A16):\n\n> The patch should fix the crash, but I don't have a Sage-on-Python-2.7 install to test it. Can somebody give it a try?\n\n\nHere, the new patch doesn't solve the segfault problems when applied to sage-on-gentoo. In testing vanilla Sage with python-2.7.1 I've been patching the Sage spkg and then building. So my sage-main isn't a pristine sage-4.7.1.alpha2 with python-2.7.1. However the last patch that I've applied is the bug11339a patch. So, I cloned Sage to the patchset just prior to this last patch, apply the new patch and issued 'sage -ba'. The 3 tests listed #comment:11\u00a0all segfault. Let me know if you think my results are \"overly\" tainted.",
    "created_at": "2011-06-18T18:57:36Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116262",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:18'></a>
Replying to [vbraun](#comment%3A16):

> The patch should fix the crash, but I don't have a Sage-on-Python-2.7 install to test it. Can somebody give it a try?


Here, the new patch doesn't solve the segfault problems when applied to sage-on-gentoo. In testing vanilla Sage with python-2.7.1 I've been patching the Sage spkg and then building. So my sage-main isn't a pristine sage-4.7.1.alpha2 with python-2.7.1. However the last patch that I've applied is the bug11339a patch. So, I cloned Sage to the patchset just prior to this last patch, apply the new patch and issued 'sage -ba'. The 3 tests listed #comment:11 all segfault. Let me know if you think my results are "overly" tainted.



---

archive/issue_comments_116263.json:
```json
{
    "body": "<a id='comment:19'></a>\nReplying to [vbraun](#comment%3A16):\n> In the case at hand we don't really need the Cython class `GroebnerStrategy._parent`, only the C struct `GroebnerStrategy._parent._ring` is used in `__deallocate__()`. I've made a minimal patch that adds a `cdef ring *_parent_ring` data member to `GroebnerStrategy` to keep track of the ring only. Because it refers to a C struct, it is safe to access it the Cython destructor. Because parents are immutable we don't have to worry about the `ring *` pointer becoming invalid. \n> \n> The patch should fix the crash, but I don't have a Sage-on-Python-2.7 install to test it. Can somebody give it a try?\n\n\n\nDoes it depend on other patches that are post 4.7.1.alpha2? The feedback so far is that it doesn't work but I noticed there was some work in singular and rings in alpha3 and alpha4. Would it rely on any of these fixes?",
    "created_at": "2011-06-18T20:36:02Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116263",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:19'></a>
Replying to [vbraun](#comment%3A16):
> In the case at hand we don't really need the Cython class `GroebnerStrategy._parent`, only the C struct `GroebnerStrategy._parent._ring` is used in `__deallocate__()`. I've made a minimal patch that adds a `cdef ring *_parent_ring` data member to `GroebnerStrategy` to keep track of the ring only. Because it refers to a C struct, it is safe to access it the Cython destructor. Because parents are immutable we don't have to worry about the `ring *` pointer becoming invalid. 
> 
> The patch should fix the crash, but I don't have a Sage-on-Python-2.7 install to test it. Can somebody give it a try?



Does it depend on other patches that are post 4.7.1.alpha2? The feedback so far is that it doesn't work but I noticed there was some work in singular and rings in alpha3 and alpha4. Would it rely on any of these fixes?



---

archive/issue_comments_116264.json:
```json
{
    "body": "<a id='comment:20'></a>\nhum, after looking at the tickets there are not so many that could have an influence (#11218 and #11186 and they would be long shot). Must have been stuff that I have seen on trac but not yet merged.",
    "created_at": "2011-06-18T21:02:38Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116264",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:20'></a>
hum, after looking at the tickets there are not so many that could have an influence (#11218 and #11186 and they would be long shot). Must have been stuff that I have seen on trac but not yet merged.



---

archive/issue_comments_116265.json:
```json
{
    "body": "<a id='comment:21'></a>\nBy immutable I meant that the ring of the Parent object can't change. But I wasn't aware that the parent is part of the cycle that the garbage collector is trying to break, then it won't work of course. \n\nActually, if the cycle is Parent <-> GroebnerStrategy then I don't understand Martin's orginal patch. By manually increasing the refcount of Parent by one, the garbage collector should conclude that an external reference is keeping the cycle alive, right? Hence `__dealloc__` would never be run. This fixes the crash, of course, but at the cost of leaking memory?\n\nI'm leaning towards refcounting the libsingular rings in C. This would be rather easy to implement, I think.\n\nAlso, Burcin told me that the need to explicitly reset the ring after the groebner strategy is going to go away in the future. But I would wager that Sage is going to transition to Python 3 first ;-)",
    "created_at": "2011-06-18T21:19:39Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116265",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:21'></a>
By immutable I meant that the ring of the Parent object can't change. But I wasn't aware that the parent is part of the cycle that the garbage collector is trying to break, then it won't work of course. 

Actually, if the cycle is Parent <-> GroebnerStrategy then I don't understand Martin's orginal patch. By manually increasing the refcount of Parent by one, the garbage collector should conclude that an external reference is keeping the cycle alive, right? Hence `__dealloc__` would never be run. This fixes the crash, of course, but at the cost of leaking memory?

I'm leaning towards refcounting the libsingular rings in C. This would be rather easy to implement, I think.

Also, Burcin told me that the need to explicitly reset the ring after the groebner strategy is going to go away in the future. But I would wager that Sage is going to transition to Python 3 first ;-)



---

archive/issue_events_089069.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-06-18T21:19:39Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89069"
}
```



---

archive/issue_events_089070.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-06-18T21:19:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89070"
}
```



---

archive/issue_comments_116266.json:
```json
{
    "body": "<a id='comment:22'></a>\nReplying to [vbraun](#comment%3A21):\n> But I wasn't aware that the parent is part of the cycle that the\n> garbage collector is trying to break, then it won't work of course. \n> \n> Actually, if the cycle is Parent <-> GroebnerStrategy then I don't understand\n> Martin's orginal patch.\n\n\nI'm not sure there really is a cycle. I had interpreted the situation in such a way that tp_clear will be called for unreachable objects just in case there might be some kind of cycle between them. So there might be no actual cycle involved at all, or it might be with some other member object. One requirement is that the function does cut all cycles, which should work as the parent shouldn't be referring back to the Gr\u00f6bner strategy. So by keeping the reference in one direction, we satisfy tp_clear and still manage to finalize things. As a bonus, we ensure their finalization in the correct order.\n\nBut I might be completely off target with my above understanding. Someone with intricate knowledge of python, its evolution, as well as cython, might know better.\n\nUntil then, someone could add breakpoints to see if the finalizer is executed with my patch in place. Don't have the time just now, but might do it myself in a week or so if you remind me.",
    "created_at": "2011-06-18T21:40:38Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116266",
    "user": "https://github.com/gagern"
}
```

<a id='comment:22'></a>
Replying to [vbraun](#comment%3A21):
> But I wasn't aware that the parent is part of the cycle that the
> garbage collector is trying to break, then it won't work of course. 
> 
> Actually, if the cycle is Parent <-> GroebnerStrategy then I don't understand
> Martin's orginal patch.


I'm not sure there really is a cycle. I had interpreted the situation in such a way that tp_clear will be called for unreachable objects just in case there might be some kind of cycle between them. So there might be no actual cycle involved at all, or it might be with some other member object. One requirement is that the function does cut all cycles, which should work as the parent shouldn't be referring back to the Gröbner strategy. So by keeping the reference in one direction, we satisfy tp_clear and still manage to finalize things. As a bonus, we ensure their finalization in the correct order.

But I might be completely off target with my above understanding. Someone with intricate knowledge of python, its evolution, as well as cython, might know better.

Until then, someone could add breakpoints to see if the finalizer is executed with my patch in place. Don't have the time just now, but might do it myself in a week or so if you remind me.



---

archive/issue_comments_116267.json:
```json
{
    "body": "<a id='comment:23'></a>\nThe Python docs say \"The `tp_clear` member function is used to break reference cycles in cyclic garbage detected by the garbage collector.\", so there must have been a cycle involving the `GroebnerStrategy` instance.\n\nI looked a bit at the source and we definitely have cycles ideal<->`GroebnerStrategy`. Both refer to the parent ring, and this explains why `tp_clear` was called on `GroebnerStrategy`. I haven't found a place where the parent refers back to the cycle. In this situation Martin's patch should work as we can get rid of the cycle while the parent has positive refcount. It could be that Python 2.7 got smarter and deletes the parent together with the cycle while Python 2.6 first deleted the cycle and only then noticed that nothing else refers to the parent any more. This would explain why Martin's patch works but my attempt of blindly accessing the ring C structure fails on Python 2.7. \n\nThere is a lot of stuff that could conceivably create a larger cycle involving the parent even though I haven't found one. For one, the parent keeps a reference to the \"one\" element. Even then, I think it is too dangerous to make the hidden assumption that there are no complete cycles involving the parents. Somebody is bound to trip over this sooner or later.",
    "created_at": "2011-06-18T22:48:15Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116267",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:23'></a>
The Python docs say "The `tp_clear` member function is used to break reference cycles in cyclic garbage detected by the garbage collector.", so there must have been a cycle involving the `GroebnerStrategy` instance.

I looked a bit at the source and we definitely have cycles ideal<->`GroebnerStrategy`. Both refer to the parent ring, and this explains why `tp_clear` was called on `GroebnerStrategy`. I haven't found a place where the parent refers back to the cycle. In this situation Martin's patch should work as we can get rid of the cycle while the parent has positive refcount. It could be that Python 2.7 got smarter and deletes the parent together with the cycle while Python 2.6 first deleted the cycle and only then noticed that nothing else refers to the parent any more. This would explain why Martin's patch works but my attempt of blindly accessing the ring C structure fails on Python 2.7. 

There is a lot of stuff that could conceivably create a larger cycle involving the parent even though I haven't found one. For one, the parent keeps a reference to the "one" element. Even then, I think it is too dangerous to make the hidden assumption that there are no complete cycles involving the parents. Somebody is bound to trip over this sooner or later.



---

archive/issue_comments_116268.json:
```json
{
    "body": "<a id='comment:24'></a>\nWe got this crash in the parent destructor, but look whats in the element destructor:\n\n```\n    def __dealloc__(self):\n        # TODO: Warn otherwise!\n        # for some mysterious reason, various things may be NULL in some cases\n        if self._parent is not <ParentWithBase>None and (<MPolynomialRing_libsingular>self._parent)._ring != NULL and self._poly != NULL:\n            p_Delete(&self._poly, (<MPolynomialRing_libsingular>self._parent)._ring)\n```",
    "created_at": "2011-06-19T16:25:11Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116268",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:24'></a>
We got this crash in the parent destructor, but look whats in the element destructor:

```
    def __dealloc__(self):
        # TODO: Warn otherwise!
        # for some mysterious reason, various things may be NULL in some cases
        if self._parent is not <ParentWithBase>None and (<MPolynomialRing_libsingular>self._parent)._ring != NULL and self._poly != NULL:
            p_Delete(&self._poly, (<MPolynomialRing_libsingular>self._parent)._ring)
```



---

archive/issue_events_089071.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-06-22T21:48:22Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "component: porting",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89071"
}
```



---

archive/issue_events_089072.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-06-22T21:48:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "component: algebra",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89072"
}
```



---

archive/issue_comments_116269.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -5,4 +5,6 @@\n Others have had similar problems before. There are [crude workarounds](http://stackoverflow.com/questions/4501938/how-can-c-object-lifetimes-be-correctly-managed-in-cython) floating around. I guess a proper solution would be twaking cython to allow custom code in the tp_clear function. In other words, have a \"magic\" mehod `__clear__` similar to the magic `__deallocate__`. But I'll wait for comments here first, before taking this to cython upstream. Perhaps people with more experience have better solutions to offer. And I won't mind if you decide to take this to Cython devs yourselves.\n \n Apply:\n-* [attachment:trac_11339_illegal_use_of__deallocate__in_libsingular.patch]\n+* [attachment:trac_11339_refcount_singular_rings.patch]\n+* [attachment:trac_11339_refcount_singular_polynomials.patch]\n+\n``````\n",
    "created_at": "2011-06-22T21:48:22Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116269",
    "user": "https://github.com/vbraun"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -5,4 +5,6 @@
 Others have had similar problems before. There are [crude workarounds](http://stackoverflow.com/questions/4501938/how-can-c-object-lifetimes-be-correctly-managed-in-cython) floating around. I guess a proper solution would be twaking cython to allow custom code in the tp_clear function. In other words, have a "magic" mehod `__clear__` similar to the magic `__deallocate__`. But I'll wait for comments here first, before taking this to cython upstream. Perhaps people with more experience have better solutions to offer. And I won't mind if you decide to take this to Cython devs yourselves.
 
 Apply:
-* [attachment:trac_11339_illegal_use_of__deallocate__in_libsingular.patch]
+* [attachment:trac_11339_refcount_singular_rings.patch]
+* [attachment:trac_11339_refcount_singular_polynomials.patch]
+
``````




---

archive/issue_comments_116270.json:
```json
{
    "body": "<a id='comment:25'></a>\nOk this should fix it now for good. The first patch introduces refcounting for Singular ring pointers and uses it in `GroebnerStrategy`, and the second updates `MPolynomialRing_libsingular` and `MPolynomial_libsingular`. Please give it a try with Python-2.7...",
    "created_at": "2011-06-22T21:48:22Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116270",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:25'></a>
Ok this should fix it now for good. The first patch introduces refcounting for Singular ring pointers and uses it in `GroebnerStrategy`, and the second updates `MPolynomialRing_libsingular` and `MPolynomial_libsingular`. Please give it a try with Python-2.7...



---

archive/issue_events_089073.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-06-22T21:48:22Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89073"
}
```



---

archive/issue_events_089074.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-06-22T21:48:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89074"
}
```



---

archive/issue_comments_116271.json:
```json
{
    "body": "<a id='comment:26'></a>\nI have boldly pushed it to the sage-on-gentoo tree and can report that it works fine with python-2.7.1 there on 4.7.1.alpha2. It solved the problem we had but another doctest crashed that looked completely unrelated until I looked at the backtrace:\n\n```\nsage -t -long  -force_lib devel/sage-main/sage/crypto/mq/sr.py # Killed/crashed\n```\nand here is it says when I add -verbose\n\n```\nTrying:\n    from sage.crypto.mq.sr import test_consistency###line 3336:_sage_    >>> from sage.crypto.mq.sr import test_consistency\nExpecting nothing\nok\nTrying:\n    test_consistency(Integer(1))  # long time (80s on sage.math, 2011)###line 3337:_sage_    >>> test_consistency(1)  # long time (80s on sage.math, 2011)\nExpecting:\n    True\n/usr/lib64/libcsage.so(print_backtrace+0x24)[0x7f5259023554]\n/usr/lib64/libcsage.so(sigdie+0x1d)[0x7f52590235ed]\n/usr/lib64/libcsage.so(sage_signal_handler+0x131)[0x7f5259023761]\n/lib64/libpthread.so.0(+0xfee0)[0x7f525ca80ee0]\n/usr/lib64/libsingular.so.3(_Z7na_CopyP7snumberP9sip_sring+0x79)[0x7f523cc17d47]\n/usr/lib64/libsingular.so.3(_Z6pSubstP8spolyreciS0_+0x535)[0x7f523cc41734]\n/usr/lib64/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_libsingular.so(+0x548e9)[0x7f523c5de8e9]\n/usr/lib64/libpython2.7.so.1.0(PyCFunction_Call+0x76)[0x7f525cd0e1ab]\n/usr/lib64/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x53b6)[0x7f525cd68414]\n/usr/lib64/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x85f)[0x7f525cd69b65]\n/usr/lib64/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x4d3a)[0x7f525cd67d98]\n/usr/lib64/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x85f)[0x7f525cd69b65]\n/usr/lib64/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x4d3a)[0x7f525cd67d98]\n/usr/lib64/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x85f)[0x7f525cd69b65]\n/usr/lib64/libpython2.7.so.1.0(PyEval_EvalCode+0x3b)[0x7f525cd69c23]\n/usr/lib64/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x2597)[0x7f525cd655f5]\n/usr/lib64/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x85f)[0x7f525cd69b65]\n/usr/lib64/libpython2.7.so.1.0(+0x6ca97)[0x7f525ccfba97]\n/usr/lib64/libpython2.7.so.1.0(PyObject_Call+0x75)[0x7f525ccd9539]\n/usr/lib64/libpython2.7.so.1.0(+0x552a9)[0x7f525cce42a9]\n/usr/lib64/libpython2.7.so.1.0(PyObject_Call+0x75)[0x7f525ccd9539]\n/usr/lib64/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x4ea0)[0x7f525cd67efe]\n/usr/lib64/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x85f)[0x7f525cd69b65]\n/usr/lib64/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x4d3a)[0x7f525cd67d98]\n/usr/lib64/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x85f)[0x7f525cd69b65]\n/usr/lib64/libpython2.7.so.1.0(+0x6ca97)[0x7f525ccfba97]\n/usr/lib64/libpython2.7.so.1.0(PyObject_Call+0x75)[0x7f525ccd9539]\n/usr/lib64/libpython2.7.so.1.0(+0x552a9)[0x7f525cce42a9]\n/usr/lib64/libpython2.7.so.1.0(PyObject_Call+0x75)[0x7f525ccd9539]\n/usr/lib64/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x4ea0)[0x7f525cd67efe]\n/usr/lib64/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x85f)[0x7f525cd69b65]\n/usr/lib64/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x4d3a)[0x7f525cd67d98]\n/usr/lib64/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x85f)[0x7f525cd69b65]\n/usr/lib64/libpython2.7.so.1.0(+0x6ca97)[0x7f525ccfba97]\n/usr/lib64/libpython2.7.so.1.0(PyObject_Call+0x75)[0x7f525ccd9539]\n/usr/lib64/libpython2.7.so.1.0(+0x552a9)[0x7f525cce42a9]\n/usr/lib64/libpython2.7.so.1.0(PyObject_Call+0x75)[0x7f525ccd9539]\n/usr/lib64/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x4ea0)[0x7f525cd67efe]\n/usr/lib64/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x85f)[0x7f525cd69b65]\n/usr/lib64/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x4d3a)[0x7f525cd67d98]\n/usr/lib64/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x85f)[0x7f525cd69b65]\n/usr/lib64/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x4d3a)[0x7f525cd67d98]\n/usr/lib64/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x85f)[0x7f525cd69b65]\n/usr/lib64/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x4d3a)[0x7f525cd67d98]\n/usr/lib64/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x85f)[0x7f525cd69b65]\n/usr/lib64/libpython2.7.so.1.0(PyEval_EvalCode+0x3b)[0x7f525cd69c23]\n/usr/lib64/libpython2.7.so.1.0(+0xf3a14)[0x7f525cd82a14]\n/usr/lib64/libpython2.7.so.1.0(PyRun_FileExFlags+0xb1)[0x7f525cd83719]\n/usr/lib64/libpython2.7.so.1.0(PyRun_SimpleFileExFlags+0x33c)[0x7f525cd8421a]\n/usr/lib64/libpython2.7.so.1.0(PyRun_AnyFileExFlags+0x6e)[0x7f525cd84ac1]\n/usr/lib64/libpython2.7.so.1.0(Py_Main+0xb92)[0x7f525cd9424a]\n/usr/bin/python2.7(main+0x7f)[0x4009e3]\n/lib64/libc.so.6(__libc_start_main+0xfd)[0x7f525c70acdd]\n/usr/bin/python2.7[0x4008a9]\n\n------------------------------------------------------------------------\nUnhandled SIGSEGV: A segmentation fault occurred in Sage.\nThis probably occurred because a *compiled* component of Sage has a bug\nin it and is not properly wrapped with sig_on(), sig_off(). You might\nwant to run Sage under gdb with 'sage -gdb' to debug this.\nSage will now terminate.\n------------------------------------------------------------------------\n```\nIt should be double checked with a vanilla install in case it just reveals a problem with my libsingular ebuild.",
    "created_at": "2011-06-22T22:56:57Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116271",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:26'></a>
I have boldly pushed it to the sage-on-gentoo tree and can report that it works fine with python-2.7.1 there on 4.7.1.alpha2. It solved the problem we had but another doctest crashed that looked completely unrelated until I looked at the backtrace:

```
sage -t -long  -force_lib devel/sage-main/sage/crypto/mq/sr.py # Killed/crashed
```
and here is it says when I add -verbose

```
Trying:
    from sage.crypto.mq.sr import test_consistency###line 3336:_sage_    >>> from sage.crypto.mq.sr import test_consistency
Expecting nothing
ok
Trying:
    test_consistency(Integer(1))  # long time (80s on sage.math, 2011)###line 3337:_sage_    >>> test_consistency(1)  # long time (80s on sage.math, 2011)
Expecting:
    True
/usr/lib64/libcsage.so(print_backtrace+0x24)[0x7f5259023554]
/usr/lib64/libcsage.so(sigdie+0x1d)[0x7f52590235ed]
/usr/lib64/libcsage.so(sage_signal_handler+0x131)[0x7f5259023761]
/lib64/libpthread.so.0(+0xfee0)[0x7f525ca80ee0]
/usr/lib64/libsingular.so.3(_Z7na_CopyP7snumberP9sip_sring+0x79)[0x7f523cc17d47]
/usr/lib64/libsingular.so.3(_Z6pSubstP8spolyreciS0_+0x535)[0x7f523cc41734]
/usr/lib64/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_libsingular.so(+0x548e9)[0x7f523c5de8e9]
/usr/lib64/libpython2.7.so.1.0(PyCFunction_Call+0x76)[0x7f525cd0e1ab]
/usr/lib64/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x53b6)[0x7f525cd68414]
/usr/lib64/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x85f)[0x7f525cd69b65]
/usr/lib64/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x4d3a)[0x7f525cd67d98]
/usr/lib64/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x85f)[0x7f525cd69b65]
/usr/lib64/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x4d3a)[0x7f525cd67d98]
/usr/lib64/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x85f)[0x7f525cd69b65]
/usr/lib64/libpython2.7.so.1.0(PyEval_EvalCode+0x3b)[0x7f525cd69c23]
/usr/lib64/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x2597)[0x7f525cd655f5]
/usr/lib64/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x85f)[0x7f525cd69b65]
/usr/lib64/libpython2.7.so.1.0(+0x6ca97)[0x7f525ccfba97]
/usr/lib64/libpython2.7.so.1.0(PyObject_Call+0x75)[0x7f525ccd9539]
/usr/lib64/libpython2.7.so.1.0(+0x552a9)[0x7f525cce42a9]
/usr/lib64/libpython2.7.so.1.0(PyObject_Call+0x75)[0x7f525ccd9539]
/usr/lib64/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x4ea0)[0x7f525cd67efe]
/usr/lib64/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x85f)[0x7f525cd69b65]
/usr/lib64/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x4d3a)[0x7f525cd67d98]
/usr/lib64/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x85f)[0x7f525cd69b65]
/usr/lib64/libpython2.7.so.1.0(+0x6ca97)[0x7f525ccfba97]
/usr/lib64/libpython2.7.so.1.0(PyObject_Call+0x75)[0x7f525ccd9539]
/usr/lib64/libpython2.7.so.1.0(+0x552a9)[0x7f525cce42a9]
/usr/lib64/libpython2.7.so.1.0(PyObject_Call+0x75)[0x7f525ccd9539]
/usr/lib64/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x4ea0)[0x7f525cd67efe]
/usr/lib64/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x85f)[0x7f525cd69b65]
/usr/lib64/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x4d3a)[0x7f525cd67d98]
/usr/lib64/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x85f)[0x7f525cd69b65]
/usr/lib64/libpython2.7.so.1.0(+0x6ca97)[0x7f525ccfba97]
/usr/lib64/libpython2.7.so.1.0(PyObject_Call+0x75)[0x7f525ccd9539]
/usr/lib64/libpython2.7.so.1.0(+0x552a9)[0x7f525cce42a9]
/usr/lib64/libpython2.7.so.1.0(PyObject_Call+0x75)[0x7f525ccd9539]
/usr/lib64/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x4ea0)[0x7f525cd67efe]
/usr/lib64/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x85f)[0x7f525cd69b65]
/usr/lib64/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x4d3a)[0x7f525cd67d98]
/usr/lib64/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x85f)[0x7f525cd69b65]
/usr/lib64/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x4d3a)[0x7f525cd67d98]
/usr/lib64/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x85f)[0x7f525cd69b65]
/usr/lib64/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x4d3a)[0x7f525cd67d98]
/usr/lib64/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x85f)[0x7f525cd69b65]
/usr/lib64/libpython2.7.so.1.0(PyEval_EvalCode+0x3b)[0x7f525cd69c23]
/usr/lib64/libpython2.7.so.1.0(+0xf3a14)[0x7f525cd82a14]
/usr/lib64/libpython2.7.so.1.0(PyRun_FileExFlags+0xb1)[0x7f525cd83719]
/usr/lib64/libpython2.7.so.1.0(PyRun_SimpleFileExFlags+0x33c)[0x7f525cd8421a]
/usr/lib64/libpython2.7.so.1.0(PyRun_AnyFileExFlags+0x6e)[0x7f525cd84ac1]
/usr/lib64/libpython2.7.so.1.0(Py_Main+0xb92)[0x7f525cd9424a]
/usr/bin/python2.7(main+0x7f)[0x4009e3]
/lib64/libc.so.6(__libc_start_main+0xfd)[0x7f525c70acdd]
/usr/bin/python2.7[0x4008a9]

------------------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred in Sage.
This probably occurred because a *compiled* component of Sage has a bug
in it and is not properly wrapped with sig_on(), sig_off(). You might
want to run Sage under gdb with 'sage -gdb' to debug this.
Sage will now terminate.
------------------------------------------------------------------------
```
It should be double checked with a vanilla install in case it just reveals a problem with my libsingular ebuild.



---

archive/issue_comments_116272.json:
```json
{
    "body": "<a id='comment:27'></a>\nI had similar problems, but I thought I fixed them and it did pass tests on my machine. In my experience, they always go away if we leak the ring (which is essentially what we did before) instead of cleaning up after we are done with it. I have a suspicion that, although almost all take a ring as argument, some Singular functions require `currRing` to be set. This is why I added the inlined `_check_ring()` function to each `MPolynomial_libsingular` method to make sure that we have the right `currRing`. \n\nI've added a superfluous `p_Normalize` call to `MPolynomial_libsingular.__dealloc__`, this is likely the point where you are crashing. You'll get a more useful backtrace if you paste the offending doctest into `sage -gdb` and then use \"bt\".\n\nMaybe somebody who is more familiar with the Singular api can chime in and explain precisely where you have to call `rChangeCurrRing` and where you don't need to.",
    "created_at": "2011-06-22T23:51:50Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116272",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:27'></a>
I had similar problems, but I thought I fixed them and it did pass tests on my machine. In my experience, they always go away if we leak the ring (which is essentially what we did before) instead of cleaning up after we are done with it. I have a suspicion that, although almost all take a ring as argument, some Singular functions require `currRing` to be set. This is why I added the inlined `_check_ring()` function to each `MPolynomial_libsingular` method to make sure that we have the right `currRing`. 

I've added a superfluous `p_Normalize` call to `MPolynomial_libsingular.__dealloc__`, this is likely the point where you are crashing. You'll get a more useful backtrace if you paste the offending doctest into `sage -gdb` and then use "bt".

Maybe somebody who is more familiar with the Singular api can chime in and explain precisely where you have to call `rChangeCurrRing` and where you don't need to.



---

archive/issue_events_089075.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-06-22T23:51:50Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89075"
}
```



---

archive/issue_events_089076.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-06-22T23:51:50Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "needs info",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89076"
}
```



---

archive/issue_comments_116273.json:
```json
{
    "body": "<a id='comment:28'></a>\nIt is one of these annoying one which doesn't seem to happen when you run under gdb. May be I'll have to try a bigger portion of the sequence of commands tested.",
    "created_at": "2011-06-22T23:59:52Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116273",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:28'></a>
It is one of these annoying one which doesn't seem to happen when you run under gdb. May be I'll have to try a bigger portion of the sequence of commands tested.



---

archive/issue_comments_116274.json:
```json
{
    "body": "<a id='comment:29'></a>\nReplying to [vbraun](#comment%3A25):\n\n> Ok this should fix it now for good. The first patch introduces refcounting for Singular ring pointers and uses it in `GroebnerStrategy`, and the second updates `MPolynomialRing_libsingular` and `MPolynomial_libsingular`. Please give it a try with Python-2.7...\n\n\nOK, I applied both the singular_rings and singular_polynomials patches to the 4.7.1.alpha2 that I have and built Sage as in [comment:18](#comment%3A18)\u00a0. As noted above this is not a pristine 4.7.1.alpha2, but has other python-2.7 related patches included; tickets #11377, #11244, #9958, #11376\u00a0and\u00a0#10764. There are no segfaults. The testsuite looks like the results when the bug11339a.patch was applied. And I don't get the Killed doctest mentioned by Fran\u00e7ois. Now with just the singular_rings patch I also get no segfaults or crashes. Should I get a crash? I can't see that any of the applied patches could affect things. I will build from scratch, just to make sure.",
    "created_at": "2011-06-23T00:49:53Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116274",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:29'></a>
Replying to [vbraun](#comment%3A25):

> Ok this should fix it now for good. The first patch introduces refcounting for Singular ring pointers and uses it in `GroebnerStrategy`, and the second updates `MPolynomialRing_libsingular` and `MPolynomial_libsingular`. Please give it a try with Python-2.7...


OK, I applied both the singular_rings and singular_polynomials patches to the 4.7.1.alpha2 that I have and built Sage as in [comment:18](#comment%3A18) . As noted above this is not a pristine 4.7.1.alpha2, but has other python-2.7 related patches included; tickets #11377, #11244, #9958, #11376 and #10764. There are no segfaults. The testsuite looks like the results when the bug11339a.patch was applied. And I don't get the Killed doctest mentioned by François. Now with just the singular_rings patch I also get no segfaults or crashes. Should I get a crash? I can't see that any of the applied patches could affect things. I will build from scratch, just to make sure.



---

archive/issue_comments_116275.json:
```json
{
    "body": "<a id='comment:30'></a>\nOK so a proper backtrace. Note that the failing test is marked \"long\".\n\n```\nProgram received signal SIGSEGV, Segmentation fault.\n0x00007fffd79c2d47 in p_Copy (p=0x1, r=0x7ffff445fc38) at pInline2.h:441\n441     pInline2.h: No such file or directory.\n        in pInline2.h\n(gdb) bt\n#0  0x00007fffd79c2d47 in p_Copy (p=0x1, r=0x7ffff445fc38) at pInline2.h:441\n#1  na_Copy (p=0x1, r=0x7ffff445fc38) at longalg.cc:1005\n#2  0x00007fffd79ec734 in p_Head (p=<value optimized out>, n=<value optimized out>, e=0x7fffd0d832d0) at pInline1.h:152\n#3  pSubst (p=<value optimized out>, n=<value optimized out>, e=0x7fffd0d832d0) at polys.cc:970\n#4  0x00007fffd7387998 in __pyx_pf_4sage_5rings_10polynomial_28multi_polynomial_libsingular_23MPolynomial_libsingular_33subs (\n    __pyx_v_self=0x4d1b370, __pyx_args=<value optimized out>, __pyx_kwds=<value optimized out>)\n    at sage/rings/polynomial/multi_polynomial_libsingular.cpp:19922\n#5  0x00007ffff7aac1ab in PyCFunction_Call (func=0x4ce4908, arg=0x4ea41d0, kw=<value optimized out>) at Objects/methodobject.c:85\n#6  0x00007ffff7b06414 in ext_do_call (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4322\n#7  PyEval_EvalFrameEx (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:2704\n#8  0x00007ffff7b07b65 in PyEval_EvalCodeEx (co=0x1798b30, globals=<value optimized out>, locals=<value optimized out>, \n    args=<value optimized out>, argcount=2, kws=0x5244750, kwcount=0, defs=0x0, defcount=0, closure=0x0) at Python/ceval.c:3252\n#9  0x00007ffff7b05d98 in fast_function (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4108\n#10 call_function (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4033\n#11 PyEval_EvalFrameEx (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:2665\n#12 0x00007ffff7b07b65 in PyEval_EvalCodeEx (co=0x3cc92b0, globals=<value optimized out>, locals=<value optimized out>, \n    args=<value optimized out>, argcount=1, kws=0x523abe8, kwcount=0, defs=0x3ccb6a8, defcount=1, closure=0x0)\n    at Python/ceval.c:3252\n#13 0x00007ffff7b05d98 in fast_function (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4108\n#14 call_function (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4033\n#15 PyEval_EvalFrameEx (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:2665\n#16 0x00007ffff7b07b65 in PyEval_EvalCodeEx (co=0x4e985b0, globals=<value optimized out>, locals=<value optimized out>, \n    args=<value optimized out>, argcount=0, kws=0x0, kwcount=0, defs=0x0, defcount=0, closure=0x0) at Python/ceval.c:3252\n#17 0x00007ffff7b07c23 in PyEval_EvalCode (co=<value optimized out>, globals=<value optimized out>, locals=<value optimized out>)\n    at Python/ceval.c:666\n#18 0x00007ffff7b035f5 in exec_statement (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4709\n#19 PyEval_EvalFrameEx (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:1879\n#20 0x00007ffff7b07b65 in PyEval_EvalCodeEx (co=0x4bddc30, globals=<value optimized out>, locals=<value optimized out>, \n    args=<value optimized out>, argcount=5, kws=0x0, kwcount=0, defs=0x0, defcount=0, closure=0x0) at Python/ceval.c:3252\n#21 0x00007ffff7a99a97 in function_call (func=0x4bafc08, arg=0x552fdd0, kw=0x0) at Objects/funcobject.c:526\n#22 0x00007ffff7a77539 in PyObject_Call (func=0x4bafc08, arg=0x552fdd0, kw=0x0) at Objects/abstract.c:2529\n#23 0x00007ffff7a822a9 in instancemethod_call (func=0x4bafc08, arg=0x552fdd0, kw=0x0) at Objects/classobject.c:2578\n#24 0x00007ffff7a77539 in PyObject_Call (func=0x5450410, arg=0x552fdd0, kw=0x0) at Objects/abstract.c:2529\n#25 0x00007ffff7b05efe in do_call (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4230\n#26 call_function (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4035\n#27 PyEval_EvalFrameEx (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:2665\n#28 0x00007ffff7b07b65 in PyEval_EvalCodeEx (co=0x4c38c30, globals=<value optimized out>, locals=<value optimized out>, \n    args=<value optimized out>, argcount=5, kws=0x52444f8, kwcount=0, defs=0x0, defcount=0, closure=0x0) at Python/ceval.c:3252\n#29 0x00007ffff7b05d98 in fast_function (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4108\n#30 call_function (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4033\n#31 PyEval_EvalFrameEx (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:2665\n#32 0x00007ffff7b07b65 in PyEval_EvalCodeEx (co=0x4bddd30, globals=<value optimized out>, locals=<value optimized out>, \n    args=<value optimized out>, argcount=4, kws=0x0, kwcount=0, defs=0x0, defcount=0, closure=0x0) at Python/ceval.c:3252\n#33 0x00007ffff7a99a97 in function_call (func=0x4bafc80, arg=0x5522050, kw=0x0) at Objects/funcobject.c:526\n#34 0x00007ffff7a77539 in PyObject_Call (func=0x4bafc80, arg=0x5522050, kw=0x0) at Objects/abstract.c:2529\n#35 0x00007ffff7a822a9 in instancemethod_call (func=0x4bafc80, arg=0x5522050, kw=0x0) at Objects/classobject.c:2578\n#36 0x00007ffff7a77539 in PyObject_Call (func=0x5453500, arg=0x5522050, kw=0x0) at Objects/abstract.c:2529\n#37 0x00007ffff7b05efe in do_call (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4230\n#38 call_function (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4035\n#39 PyEval_EvalFrameEx (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:2665\n#40 0x00007ffff7b07b65 in PyEval_EvalCodeEx (co=0x7ffff289de30, globals=<value optimized out>, locals=<value optimized out>, \n    args=<value optimized out>, argcount=4, kws=0x5181330, kwcount=0, defs=0x0, defcount=0, closure=0x0) at Python/ceval.c:3252\n#41 0x00007ffff7b05d98 in fast_function (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4108\n#42 call_function (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4033\n#43 PyEval_EvalFrameEx (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:2665\n#44 0x00007ffff7b07b65 in PyEval_EvalCodeEx (co=0x4bddeb0, globals=<value optimized out>, locals=<value optimized out>, \n    args=<value optimized out>, argcount=2, kws=0x4c3b618, kwcount=3, defs=0x4bae108, defcount=3, closure=0x0)\n    at Python/ceval.c:3252\n#45 0x00007ffff7a99a97 in function_call (func=0x4bafde8, arg=0x4b2e680, kw=0x473aa50) at Objects/funcobject.c:526\n#46 0x00007ffff7a77539 in PyObject_Call (func=0x4bafde8, arg=0x4b2e680, kw=0x473aa50) at Objects/abstract.c:2529\n#47 0x00007ffff7a822a9 in instancemethod_call (func=0x4bafde8, arg=0x4b2e680, kw=0x473aa50) at Objects/classobject.c:2578\n#48 0x00007ffff7a77539 in PyObject_Call (func=0x37d84b0, arg=0x4b2e680, kw=0x473aa50) at Objects/abstract.c:2529\n#49 0x00007ffff7b05efe in do_call (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4230\n#50 call_function (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4035\n#51 PyEval_EvalFrameEx (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:2665\n#52 0x00007ffff7b07b65 in PyEval_EvalCodeEx (co=0x7ffff7ec41b0, globals=<value optimized out>, locals=<value optimized out>, \n    args=<value optimized out>, argcount=2, kws=0x4c68d60, kwcount=0, defs=0x49f56a8, defcount=3, closure=0x0)\n    at Python/ceval.c:3252\n#53 0x00007ffff7b05d98 in fast_function (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4108\n#54 call_function (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4033\n#55 PyEval_EvalFrameEx (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:2665\n#56 0x00007ffff7b07b65 in PyEval_EvalCodeEx (co=0x4bd88b0, globals=<value optimized out>, locals=<value optimized out>, \n    args=<value optimized out>, argcount=0, kws=0x46212b0, kwcount=10, defs=0x4bb8288, defcount=10, closure=0x0)\n    at Python/ceval.c:3252\n#57 0x00007ffff7b05d98 in fast_function (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4108\n#58 call_function (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4033\n#59 PyEval_EvalFrameEx (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:2665\n#60 0x00007ffff7b07b65 in PyEval_EvalCodeEx (co=0x4c38ab0, globals=<value optimized out>, locals=<value optimized out>, \n    args=<value optimized out>, argcount=1, kws=0x6cae88, kwcount=3, defs=0x4bb8068, defcount=10, closure=0x0)\n    at Python/ceval.c:3252\n#61 0x00007ffff7b05d98 in fast_function (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4108\n#62 call_function (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4033\n#63 PyEval_EvalFrameEx (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:2665\n#64 0x00007ffff7b07b65 in PyEval_EvalCodeEx (co=0x7ffff7eb7eb0, globals=<value optimized out>, locals=<value optimized out>, \n    args=<value optimized out>, argcount=0, kws=0x0, kwcount=0, defs=0x0, defcount=0, closure=0x0) at Python/ceval.c:3252\n#65 0x00007ffff7b07c23 in PyEval_EvalCode (co=<value optimized out>, globals=<value optimized out>, locals=<value optimized out>)\n    at Python/ceval.c:666\n#66 0x00007ffff7b20a14 in run_mod (mod=<value optimized out>, filename=<value optimized out>, globals=0x640f60, locals=0x640f60, \n    flags=<value optimized out>, arena=<value optimized out>) at Python/pythonrun.c:1346\n#67 0x00007ffff7b21719 in PyRun_FileExFlags (fp=0x6a0530, filename=0x7fffffffddc1 \"/home/fbissey/.sage/tmp/.doctest_sr.py\", \n    start=257, globals=0x640f60, locals=0x640f60, closeit=1, flags=0x7fffffffd870) at Python/pythonrun.c:1332\n#68 0x00007ffff7b2221a in PyRun_SimpleFileExFlags (fp=0x6a0530, filename=<value optimized out>, closeit=1, flags=0x7fffffffd870)\n    at Python/pythonrun.c:936\n#69 0x00007ffff7b22ac1 in PyRun_AnyFileExFlags (fp=0x6a0530, filename=0x7fffffffddc1 \"/home/fbissey/.sage/tmp/.doctest_sr.py\", \n    closeit=1, flags=0x7fffffffd870) at Python/pythonrun.c:740\n#70 0x00007ffff7b3224a in Py_Main (argc=<value optimized out>, argv=0x7fffffffd9b8) at Modules/main.c:606\n#71 0x00000000004009e3 in main (argc=2, argv=0x7fffffffd9b8) at ./Modules/python.c:46\n```\nI didn't realize you could do something like\n\n```\nsage -t -long  -force_lib devel/sage-main/sage/crypto/mq/sr.py -gdb\n```\nhandy...",
    "created_at": "2011-06-23T03:34:14Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116275",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:30'></a>
OK so a proper backtrace. Note that the failing test is marked "long".

```
Program received signal SIGSEGV, Segmentation fault.
0x00007fffd79c2d47 in p_Copy (p=0x1, r=0x7ffff445fc38) at pInline2.h:441
441     pInline2.h: No such file or directory.
        in pInline2.h
(gdb) bt
#0  0x00007fffd79c2d47 in p_Copy (p=0x1, r=0x7ffff445fc38) at pInline2.h:441
#1  na_Copy (p=0x1, r=0x7ffff445fc38) at longalg.cc:1005
#2  0x00007fffd79ec734 in p_Head (p=<value optimized out>, n=<value optimized out>, e=0x7fffd0d832d0) at pInline1.h:152
#3  pSubst (p=<value optimized out>, n=<value optimized out>, e=0x7fffd0d832d0) at polys.cc:970
#4  0x00007fffd7387998 in __pyx_pf_4sage_5rings_10polynomial_28multi_polynomial_libsingular_23MPolynomial_libsingular_33subs (
    __pyx_v_self=0x4d1b370, __pyx_args=<value optimized out>, __pyx_kwds=<value optimized out>)
    at sage/rings/polynomial/multi_polynomial_libsingular.cpp:19922
#5  0x00007ffff7aac1ab in PyCFunction_Call (func=0x4ce4908, arg=0x4ea41d0, kw=<value optimized out>) at Objects/methodobject.c:85
#6  0x00007ffff7b06414 in ext_do_call (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4322
#7  PyEval_EvalFrameEx (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:2704
#8  0x00007ffff7b07b65 in PyEval_EvalCodeEx (co=0x1798b30, globals=<value optimized out>, locals=<value optimized out>, 
    args=<value optimized out>, argcount=2, kws=0x5244750, kwcount=0, defs=0x0, defcount=0, closure=0x0) at Python/ceval.c:3252
#9  0x00007ffff7b05d98 in fast_function (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4108
#10 call_function (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4033
#11 PyEval_EvalFrameEx (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:2665
#12 0x00007ffff7b07b65 in PyEval_EvalCodeEx (co=0x3cc92b0, globals=<value optimized out>, locals=<value optimized out>, 
    args=<value optimized out>, argcount=1, kws=0x523abe8, kwcount=0, defs=0x3ccb6a8, defcount=1, closure=0x0)
    at Python/ceval.c:3252
#13 0x00007ffff7b05d98 in fast_function (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4108
#14 call_function (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4033
#15 PyEval_EvalFrameEx (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:2665
#16 0x00007ffff7b07b65 in PyEval_EvalCodeEx (co=0x4e985b0, globals=<value optimized out>, locals=<value optimized out>, 
    args=<value optimized out>, argcount=0, kws=0x0, kwcount=0, defs=0x0, defcount=0, closure=0x0) at Python/ceval.c:3252
#17 0x00007ffff7b07c23 in PyEval_EvalCode (co=<value optimized out>, globals=<value optimized out>, locals=<value optimized out>)
    at Python/ceval.c:666
#18 0x00007ffff7b035f5 in exec_statement (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4709
#19 PyEval_EvalFrameEx (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:1879
#20 0x00007ffff7b07b65 in PyEval_EvalCodeEx (co=0x4bddc30, globals=<value optimized out>, locals=<value optimized out>, 
    args=<value optimized out>, argcount=5, kws=0x0, kwcount=0, defs=0x0, defcount=0, closure=0x0) at Python/ceval.c:3252
#21 0x00007ffff7a99a97 in function_call (func=0x4bafc08, arg=0x552fdd0, kw=0x0) at Objects/funcobject.c:526
#22 0x00007ffff7a77539 in PyObject_Call (func=0x4bafc08, arg=0x552fdd0, kw=0x0) at Objects/abstract.c:2529
#23 0x00007ffff7a822a9 in instancemethod_call (func=0x4bafc08, arg=0x552fdd0, kw=0x0) at Objects/classobject.c:2578
#24 0x00007ffff7a77539 in PyObject_Call (func=0x5450410, arg=0x552fdd0, kw=0x0) at Objects/abstract.c:2529
#25 0x00007ffff7b05efe in do_call (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4230
#26 call_function (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4035
#27 PyEval_EvalFrameEx (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:2665
#28 0x00007ffff7b07b65 in PyEval_EvalCodeEx (co=0x4c38c30, globals=<value optimized out>, locals=<value optimized out>, 
    args=<value optimized out>, argcount=5, kws=0x52444f8, kwcount=0, defs=0x0, defcount=0, closure=0x0) at Python/ceval.c:3252
#29 0x00007ffff7b05d98 in fast_function (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4108
#30 call_function (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4033
#31 PyEval_EvalFrameEx (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:2665
#32 0x00007ffff7b07b65 in PyEval_EvalCodeEx (co=0x4bddd30, globals=<value optimized out>, locals=<value optimized out>, 
    args=<value optimized out>, argcount=4, kws=0x0, kwcount=0, defs=0x0, defcount=0, closure=0x0) at Python/ceval.c:3252
#33 0x00007ffff7a99a97 in function_call (func=0x4bafc80, arg=0x5522050, kw=0x0) at Objects/funcobject.c:526
#34 0x00007ffff7a77539 in PyObject_Call (func=0x4bafc80, arg=0x5522050, kw=0x0) at Objects/abstract.c:2529
#35 0x00007ffff7a822a9 in instancemethod_call (func=0x4bafc80, arg=0x5522050, kw=0x0) at Objects/classobject.c:2578
#36 0x00007ffff7a77539 in PyObject_Call (func=0x5453500, arg=0x5522050, kw=0x0) at Objects/abstract.c:2529
#37 0x00007ffff7b05efe in do_call (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4230
#38 call_function (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4035
#39 PyEval_EvalFrameEx (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:2665
#40 0x00007ffff7b07b65 in PyEval_EvalCodeEx (co=0x7ffff289de30, globals=<value optimized out>, locals=<value optimized out>, 
    args=<value optimized out>, argcount=4, kws=0x5181330, kwcount=0, defs=0x0, defcount=0, closure=0x0) at Python/ceval.c:3252
#41 0x00007ffff7b05d98 in fast_function (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4108
#42 call_function (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4033
#43 PyEval_EvalFrameEx (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:2665
#44 0x00007ffff7b07b65 in PyEval_EvalCodeEx (co=0x4bddeb0, globals=<value optimized out>, locals=<value optimized out>, 
    args=<value optimized out>, argcount=2, kws=0x4c3b618, kwcount=3, defs=0x4bae108, defcount=3, closure=0x0)
    at Python/ceval.c:3252
#45 0x00007ffff7a99a97 in function_call (func=0x4bafde8, arg=0x4b2e680, kw=0x473aa50) at Objects/funcobject.c:526
#46 0x00007ffff7a77539 in PyObject_Call (func=0x4bafde8, arg=0x4b2e680, kw=0x473aa50) at Objects/abstract.c:2529
#47 0x00007ffff7a822a9 in instancemethod_call (func=0x4bafde8, arg=0x4b2e680, kw=0x473aa50) at Objects/classobject.c:2578
#48 0x00007ffff7a77539 in PyObject_Call (func=0x37d84b0, arg=0x4b2e680, kw=0x473aa50) at Objects/abstract.c:2529
#49 0x00007ffff7b05efe in do_call (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4230
#50 call_function (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4035
#51 PyEval_EvalFrameEx (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:2665
#52 0x00007ffff7b07b65 in PyEval_EvalCodeEx (co=0x7ffff7ec41b0, globals=<value optimized out>, locals=<value optimized out>, 
    args=<value optimized out>, argcount=2, kws=0x4c68d60, kwcount=0, defs=0x49f56a8, defcount=3, closure=0x0)
    at Python/ceval.c:3252
#53 0x00007ffff7b05d98 in fast_function (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4108
#54 call_function (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4033
#55 PyEval_EvalFrameEx (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:2665
#56 0x00007ffff7b07b65 in PyEval_EvalCodeEx (co=0x4bd88b0, globals=<value optimized out>, locals=<value optimized out>, 
    args=<value optimized out>, argcount=0, kws=0x46212b0, kwcount=10, defs=0x4bb8288, defcount=10, closure=0x0)
    at Python/ceval.c:3252
#57 0x00007ffff7b05d98 in fast_function (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4108
#58 call_function (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4033
#59 PyEval_EvalFrameEx (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:2665
#60 0x00007ffff7b07b65 in PyEval_EvalCodeEx (co=0x4c38ab0, globals=<value optimized out>, locals=<value optimized out>, 
    args=<value optimized out>, argcount=1, kws=0x6cae88, kwcount=3, defs=0x4bb8068, defcount=10, closure=0x0)
    at Python/ceval.c:3252
#61 0x00007ffff7b05d98 in fast_function (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4108
#62 call_function (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:4033
#63 PyEval_EvalFrameEx (f=<value optimized out>, throwflag=<value optimized out>) at Python/ceval.c:2665
#64 0x00007ffff7b07b65 in PyEval_EvalCodeEx (co=0x7ffff7eb7eb0, globals=<value optimized out>, locals=<value optimized out>, 
    args=<value optimized out>, argcount=0, kws=0x0, kwcount=0, defs=0x0, defcount=0, closure=0x0) at Python/ceval.c:3252
#65 0x00007ffff7b07c23 in PyEval_EvalCode (co=<value optimized out>, globals=<value optimized out>, locals=<value optimized out>)
    at Python/ceval.c:666
#66 0x00007ffff7b20a14 in run_mod (mod=<value optimized out>, filename=<value optimized out>, globals=0x640f60, locals=0x640f60, 
    flags=<value optimized out>, arena=<value optimized out>) at Python/pythonrun.c:1346
#67 0x00007ffff7b21719 in PyRun_FileExFlags (fp=0x6a0530, filename=0x7fffffffddc1 "/home/fbissey/.sage/tmp/.doctest_sr.py", 
    start=257, globals=0x640f60, locals=0x640f60, closeit=1, flags=0x7fffffffd870) at Python/pythonrun.c:1332
#68 0x00007ffff7b2221a in PyRun_SimpleFileExFlags (fp=0x6a0530, filename=<value optimized out>, closeit=1, flags=0x7fffffffd870)
    at Python/pythonrun.c:936
#69 0x00007ffff7b22ac1 in PyRun_AnyFileExFlags (fp=0x6a0530, filename=0x7fffffffddc1 "/home/fbissey/.sage/tmp/.doctest_sr.py", 
    closeit=1, flags=0x7fffffffd870) at Python/pythonrun.c:740
#70 0x00007ffff7b3224a in Py_Main (argc=<value optimized out>, argv=0x7fffffffd9b8) at Modules/main.c:606
#71 0x00000000004009e3 in main (argc=2, argv=0x7fffffffd9b8) at ./Modules/python.c:46
```
I didn't realize you could do something like

```
sage -t -long  -force_lib devel/sage-main/sage/crypto/mq/sr.py -gdb
```
handy...



---

archive/issue_comments_116276.json:
```json
{
    "body": "<a id='comment:31'></a>\nSince we can even add \"-verbose\" I should add this bit of output:\n\n```\nTrying:\n    test_consistency(Integer(1))  # long time (80s on sage.math, 2011)###line 3337:_sage_    >>> test_consistency(1)  # long time (80s on sage.math, 2011)\nExpecting:\n    True\n\nProgram received signal SIGSEGV, Segmentation fault.\n0x00007fffd79c2d47 in p_Copy (p=0x1, r=0x7ffff445fc38) at pInline2.h:441\n441     pInline2.h: No such file or directory.\n        in pInline2.h\n```\nSo it looks like the segfault is after the test has completed, probably when sage is quitting as happened to Steve when he tried to run the test while disabling the garbage collection (before we had any patches what so ever).",
    "created_at": "2011-06-23T03:39:16Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116276",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:31'></a>
Since we can even add "-verbose" I should add this bit of output:

```
Trying:
    test_consistency(Integer(1))  # long time (80s on sage.math, 2011)###line 3337:_sage_    >>> test_consistency(1)  # long time (80s on sage.math, 2011)
Expecting:
    True

Program received signal SIGSEGV, Segmentation fault.
0x00007fffd79c2d47 in p_Copy (p=0x1, r=0x7ffff445fc38) at pInline2.h:441
441     pInline2.h: No such file or directory.
        in pInline2.h
```
So it looks like the segfault is after the test has completed, probably when sage is quitting as happened to Steve when he tried to run the test while disabling the garbage collection (before we had any patches what so ever).



---

archive/issue_comments_116277.json:
```json
{
    "body": "<a id='comment:32'></a>\nI've just completed the testsuite after building vanilla sage-4.7.1.alpha2 from scratch. The patches from tickets #11377, #11244, #9958, #11376 and #10764 along with the patches of this ticket were used to create a patched sage-4.7.1.alpha2 spkg before the build. The results are identical to those reported earlier. There are no segfaults and no Killed/crashed tests.\n\nOn my sage-on-gentoo install on x86 in prefix there no segfaults; however, I have one Killed/crashed doctest which I didn't have when using the\u00a0bug11339a patch.\n\nsage -t -long -force_lib \"devel/sage-main/sage/libs/singular/option.pyx\" -gdb\n\n```\n\nProgram received signal SIGSEGV, Segmentation fault.\n0xb3b16d29 in _nlDelete_NoImm(snumber**) () from /storage/strogdon/gentoo/usr/lib/libsingular.so.3\n(gdb) bt\n#0  0xb3b16d29 in _nlDelete_NoImm(snumber**) () from /storage/strogdon/gentoo/usr/lib/libsingular.so.3\n#1  0xb3bd831d in p_Delete__FieldQ_LengthGeneral_OrdGeneral () from /storage/strogdon/gentoo/usr/lib/libsingular.so.3\n#2  0xb3acde01 in id_Delete(sip_sideal**, sip_sring*) () from /storage/strogdon/gentoo/usr/lib/libsingular.so.3\n#3  0xb3a70736 in sleftv::CleanUp(sip_sring*) () from /storage/strogdon/gentoo/usr/lib/libsingular.so.3\n#4  0xb37f490e in __pyx_f_4sage_4libs_8singular_8function_free_leftv(sleftv*) () from /storage/strogdon/gentoo/usr/lib/python2.7/site-packages/sage/libs/singular/function.so\n#5  0xb3805653 in __pyx_f_4sage_4libs_8singular_8function_call_function(__pyx_obj_4sage_4libs_8singular_8function_SingularFunction*, _object*, __pyx_obj_4sage_5rings_10polynomial_28multi_polynomial_libsingular_MPolynomialRing_libsingular*, __pyx_opt_args_4sage_4libs_8singular_8function_call_function*) () from /storage/strogdon/gentoo/usr/lib/python2.7/site-packages/sage/libs/singular/function.so\n#6  0xb3806843 in __pyx_pf_4sage_4libs_8singular_8function_16SingularFunction_2__call__(_object*, _object*, _object*) () from /storage/strogdon/gentoo/usr/lib/python2.7/site-packages/sage/libs/singular/function.so\n#7  0xb7e9fffb in PyObject_Call () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#8  0xb7f3a0a4 in PyEval_EvalFrameEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#9  0xb7f3c8e1 in PyEval_EvalCodeEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#10 0xb7f3ca34 in PyEval_EvalCode () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#11 0xb7f3bbb2 in PyEval_EvalFrameEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#12 0xb7f3c8e1 in PyEval_EvalCodeEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#13 0xb7ec7c58 in function_call () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#14 0xb7e9fffb in PyObject_Call () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#15 0xb7eafaae in instancemethod_call () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#16 0xb7e9fffb in PyObject_Call () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#17 0xb7f3a0a4 in PyEval_EvalFrameEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#18 0xb7f3c8e1 in PyEval_EvalCodeEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#19 0xb7f3ab11 in PyEval_EvalFrameEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#20 0xb7f3c8e1 in PyEval_EvalCodeEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#21 0xb7ec7c58 in function_call () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#22 0xb7e9fffb in PyObject_Call () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#23 0xb7eafaae in instancemethod_call () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#24 0xb7e9fffb in PyObject_Call () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#25 0xb7f3a0a4 in PyEval_EvalFrameEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#26 0xb7f3c8e1 in PyEval_EvalCodeEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#27 0xb7f3ab11 in PyEval_EvalFrameEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#28 0xb7f3c8e1 in PyEval_EvalCodeEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#29 0xb7ec7d43 in function_call () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#30 0xb7e9fffb in PyObject_Call () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#31 0xb7eafaae in instancemethod_call () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#32 0xb7e9fffb in PyObject_Call () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#33 0xb7f3a0a4 in PyEval_EvalFrameEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#34 0xb7f3c8e1 in PyEval_EvalCodeEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#35 0xb7f3ab11 in PyEval_EvalFrameEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#36 0xb7f3c8e1 in PyEval_EvalCodeEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#37 0xb7f3ab11 in PyEval_EvalFrameEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#38 0xb7f3c8e1 in PyEval_EvalCodeEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#39 0xb7f3ab11 in PyEval_EvalFrameEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#40 0xb7f3c8e1 in PyEval_EvalCodeEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#41 0xb7f3ca34 in PyEval_EvalCode () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#42 0xb7f5659c in run_mod () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#43 0xb7f57483 in PyRun_FileExFlags () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#44 0xb7f5815c in PyRun_SimpleFileExFlags () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#45 0xb7f58cf2 in PyRun_AnyFileExFlags () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#46 0xb7f6a35f in Py_Main () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0\n#47 0x0804888b in main ()\n```",
    "created_at": "2011-06-23T05:41:10Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116277",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:32'></a>
I've just completed the testsuite after building vanilla sage-4.7.1.alpha2 from scratch. The patches from tickets #11377, #11244, #9958, #11376 and #10764 along with the patches of this ticket were used to create a patched sage-4.7.1.alpha2 spkg before the build. The results are identical to those reported earlier. There are no segfaults and no Killed/crashed tests.

On my sage-on-gentoo install on x86 in prefix there no segfaults; however, I have one Killed/crashed doctest which I didn't have when using the bug11339a patch.

sage -t -long -force_lib "devel/sage-main/sage/libs/singular/option.pyx" -gdb

```

Program received signal SIGSEGV, Segmentation fault.
0xb3b16d29 in _nlDelete_NoImm(snumber**) () from /storage/strogdon/gentoo/usr/lib/libsingular.so.3
(gdb) bt
#0  0xb3b16d29 in _nlDelete_NoImm(snumber**) () from /storage/strogdon/gentoo/usr/lib/libsingular.so.3
#1  0xb3bd831d in p_Delete__FieldQ_LengthGeneral_OrdGeneral () from /storage/strogdon/gentoo/usr/lib/libsingular.so.3
#2  0xb3acde01 in id_Delete(sip_sideal**, sip_sring*) () from /storage/strogdon/gentoo/usr/lib/libsingular.so.3
#3  0xb3a70736 in sleftv::CleanUp(sip_sring*) () from /storage/strogdon/gentoo/usr/lib/libsingular.so.3
#4  0xb37f490e in __pyx_f_4sage_4libs_8singular_8function_free_leftv(sleftv*) () from /storage/strogdon/gentoo/usr/lib/python2.7/site-packages/sage/libs/singular/function.so
#5  0xb3805653 in __pyx_f_4sage_4libs_8singular_8function_call_function(__pyx_obj_4sage_4libs_8singular_8function_SingularFunction*, _object*, __pyx_obj_4sage_5rings_10polynomial_28multi_polynomial_libsingular_MPolynomialRing_libsingular*, __pyx_opt_args_4sage_4libs_8singular_8function_call_function*) () from /storage/strogdon/gentoo/usr/lib/python2.7/site-packages/sage/libs/singular/function.so
#6  0xb3806843 in __pyx_pf_4sage_4libs_8singular_8function_16SingularFunction_2__call__(_object*, _object*, _object*) () from /storage/strogdon/gentoo/usr/lib/python2.7/site-packages/sage/libs/singular/function.so
#7  0xb7e9fffb in PyObject_Call () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#8  0xb7f3a0a4 in PyEval_EvalFrameEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#9  0xb7f3c8e1 in PyEval_EvalCodeEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#10 0xb7f3ca34 in PyEval_EvalCode () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#11 0xb7f3bbb2 in PyEval_EvalFrameEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#12 0xb7f3c8e1 in PyEval_EvalCodeEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#13 0xb7ec7c58 in function_call () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#14 0xb7e9fffb in PyObject_Call () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#15 0xb7eafaae in instancemethod_call () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#16 0xb7e9fffb in PyObject_Call () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#17 0xb7f3a0a4 in PyEval_EvalFrameEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#18 0xb7f3c8e1 in PyEval_EvalCodeEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#19 0xb7f3ab11 in PyEval_EvalFrameEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#20 0xb7f3c8e1 in PyEval_EvalCodeEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#21 0xb7ec7c58 in function_call () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#22 0xb7e9fffb in PyObject_Call () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#23 0xb7eafaae in instancemethod_call () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#24 0xb7e9fffb in PyObject_Call () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#25 0xb7f3a0a4 in PyEval_EvalFrameEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#26 0xb7f3c8e1 in PyEval_EvalCodeEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#27 0xb7f3ab11 in PyEval_EvalFrameEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#28 0xb7f3c8e1 in PyEval_EvalCodeEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#29 0xb7ec7d43 in function_call () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#30 0xb7e9fffb in PyObject_Call () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#31 0xb7eafaae in instancemethod_call () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#32 0xb7e9fffb in PyObject_Call () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#33 0xb7f3a0a4 in PyEval_EvalFrameEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#34 0xb7f3c8e1 in PyEval_EvalCodeEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#35 0xb7f3ab11 in PyEval_EvalFrameEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#36 0xb7f3c8e1 in PyEval_EvalCodeEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#37 0xb7f3ab11 in PyEval_EvalFrameEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#38 0xb7f3c8e1 in PyEval_EvalCodeEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#39 0xb7f3ab11 in PyEval_EvalFrameEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#40 0xb7f3c8e1 in PyEval_EvalCodeEx () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#41 0xb7f3ca34 in PyEval_EvalCode () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#42 0xb7f5659c in run_mod () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#43 0xb7f57483 in PyRun_FileExFlags () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#44 0xb7f5815c in PyRun_SimpleFileExFlags () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#45 0xb7f58cf2 in PyRun_AnyFileExFlags () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#46 0xb7f6a35f in Py_Main () from /storage/strogdon/gentoo/usr/lib/libpython2.7.so.1.0
#47 0x0804888b in main ()
```



---

archive/issue_comments_116278.json:
```json
{
    "body": "<a id='comment:33'></a>\nReplying to [vbraun](#comment%3A27):\n\nHi, first: thanks for cleaning up the mess that no-doubt I made.\n\n> I had similar problems, but I thought I fixed them and it did pass tests on my \n> machine. In my experience, they always go away if we leak the ring (which is \n> essentially what we did before) instead of cleaning up after we are done with it. \n\n\nAh, this might also explain #5949 then.\n\n> I have a suspicion that, although almost all take a ring as argument, some Singular \n> functions require `currRing` to be set. \n\n\nThe API is as follows: `pXXX` does assume the `currRing` to be set, whereas `p_XXX` does not. However, sometimes there are bugs, i.e. you call `p_XXX` and it crashes unless `currRing` is set.\n\n> This is why I added the inlined  `_check_ring()` function to each `MPolynomial_libsingular` method to make \n> sure that we have the right `currRing`. \n\n\nTBH, I don't like this blanket approach, did you run into specific problems? If so, I'd add a check to those functions instead of hiding bugs by forcing the ring.",
    "created_at": "2011-06-23T10:07:53Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116278",
    "user": "https://github.com/malb"
}
```

<a id='comment:33'></a>
Replying to [vbraun](#comment%3A27):

Hi, first: thanks for cleaning up the mess that no-doubt I made.

> I had similar problems, but I thought I fixed them and it did pass tests on my 
> machine. In my experience, they always go away if we leak the ring (which is 
> essentially what we did before) instead of cleaning up after we are done with it. 


Ah, this might also explain #5949 then.

> I have a suspicion that, although almost all take a ring as argument, some Singular 
> functions require `currRing` to be set. 


The API is as follows: `pXXX` does assume the `currRing` to be set, whereas `p_XXX` does not. However, sometimes there are bugs, i.e. you call `p_XXX` and it crashes unless `currRing` is set.

> This is why I added the inlined  `_check_ring()` function to each `MPolynomial_libsingular` method to make 
> sure that we have the right `currRing`. 


TBH, I don't like this blanket approach, did you run into specific problems? If so, I'd add a check to those functions instead of hiding bugs by forcing the ring.



---

archive/issue_comments_116279.json:
```json
{
    "body": "<a id='comment:34'></a>\nReplying to [malb](#comment%3A33):\n> The API is as follows: `pXXX` does assume the `currRing` to be set, whereas `p_XXX` does not. However, sometimes there are bugs, i.e. you call `p_XXX` and it crashes unless `currRing` is set.\n\n\nI guessed that much, but a documented list of exceptions to that rule might be nice :-)\n\n> TBH, I don't like this blanket approach, did you run into specific problems? If so, I'd add a check to those functions instead of hiding bugs by forcing the ring.\n\n\nIn principle I agree, but its probably more productive to first produce a working version and then see if it still works if we remove the blanket `rChangeCurrRing`. Right now I'm not sure if that is the underlying problem. I didn't find any 100% reliable testcase but in some cases adding the extra ring switch fixed segfaults, but only to reappear in other places.",
    "created_at": "2011-06-23T10:40:38Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116279",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:34'></a>
Replying to [malb](#comment%3A33):
> The API is as follows: `pXXX` does assume the `currRing` to be set, whereas `p_XXX` does not. However, sometimes there are bugs, i.e. you call `p_XXX` and it crashes unless `currRing` is set.


I guessed that much, but a documented list of exceptions to that rule might be nice :-)

> TBH, I don't like this blanket approach, did you run into specific problems? If so, I'd add a check to those functions instead of hiding bugs by forcing the ring.


In principle I agree, but its probably more productive to first produce a working version and then see if it still works if we remove the blanket `rChangeCurrRing`. Right now I'm not sure if that is the underlying problem. I didn't find any 100% reliable testcase but in some cases adding the extra ring switch fixed segfaults, but only to reappear in other places.



---

archive/issue_comments_116280.json:
```json
{
    "body": "<a id='comment:35'></a>\nThe updated polynomials patch fixes another place where potentially the wrong singular ring was used, which would explain the data corruption. Please give it a try!\n\nI'm pretty sure that `p_Normalize` requires `currRing` to be set. In the polynomials destructor, I have\n\n```\n    ### If you suspect that the poly data was corrupted, then this is a good way to trigger a segfault:\n    rChangeCurrRing(self._parent_ring)\n    p_Normalize(self._poly, self._parent_ring)\n```\nThis is useful for debugging because `p_Normalize` will touch all coefficients of the polynomial. The destructor is typically called long after the actual computations so it is very likely that the `currRing` has changed by then. If I reverse the order of the two lines, then I get segfaults all over the Sage library. However, because it relies on the finalization order, they are usually in varying places and often disappear if you just paste the doctest into Sage.",
    "created_at": "2011-06-23T13:17:30Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116280",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:35'></a>
The updated polynomials patch fixes another place where potentially the wrong singular ring was used, which would explain the data corruption. Please give it a try!

I'm pretty sure that `p_Normalize` requires `currRing` to be set. In the polynomials destructor, I have

```
    ### If you suspect that the poly data was corrupted, then this is a good way to trigger a segfault:
    rChangeCurrRing(self._parent_ring)
    p_Normalize(self._poly, self._parent_ring)
```
This is useful for debugging because `p_Normalize` will touch all coefficients of the polynomial. The destructor is typically called long after the actual computations so it is very likely that the `currRing` has changed by then. If I reverse the order of the two lines, then I get segfaults all over the Sage library. However, because it relies on the finalization order, they are usually in varying places and often disappear if you just paste the doctest into Sage.



---

archive/issue_events_089077.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-06-23T13:17:30Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "needs info",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89077"
}
```



---

archive/issue_events_089078.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-06-23T13:17:30Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89078"
}
```



---

archive/issue_comments_116281.json:
```json
{
    "body": "<a id='comment:36'></a>\nIt seems to have taken care of my problem. Thanks Volker. Now we should wait to see if it did something for Steve.",
    "created_at": "2011-06-23T22:30:50Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116281",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:36'></a>
It seems to have taken care of my problem. Thanks Volker. Now we should wait to see if it did something for Steve.



---

archive/issue_comments_116282.json:
```json
{
    "body": "<a id='comment:37'></a>\nReplying to [vbraun](#comment%3A35):\n\n> The updated polynomials patch fixes another place where potentially the wrong singular ring was used, which would explain the data corruption. Please give it a try!\n\n\nMy vanilla sage-4.7.1.alpha2 has no segfaults or Killed/crashed tests with the new patch. The patch seems to cure the doctest failure (option.pyx) I had on my sage-on-gentoo install on x86. However on amd64 (sage-on-gentoo) I have a Segmentation fault with the doctest\n\n```\nsage -t -long \u00a0-force_lib devel/sage-main/sage/schemes/elliptic_curves/ell_curve_isogeny.py\n```\n\nI'll attach files of the Segmentation fault and debug/backtrace.",
    "created_at": "2011-06-24T03:57:57Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116282",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:37'></a>
Replying to [vbraun](#comment%3A35):

> The updated polynomials patch fixes another place where potentially the wrong singular ring was used, which would explain the data corruption. Please give it a try!


My vanilla sage-4.7.1.alpha2 has no segfaults or Killed/crashed tests with the new patch. The patch seems to cure the doctest failure (option.pyx) I had on my sage-on-gentoo install on x86. However on amd64 (sage-on-gentoo) I have a Segmentation fault with the doctest

```
sage -t -long  -force_lib devel/sage-main/sage/schemes/elliptic_curves/ell_curve_isogeny.py
```

I'll attach files of the Segmentation fault and debug/backtrace.



---

archive/issue_comments_116283.json:
```json
{
    "body": "Segmentation fault associated with",
    "created_at": "2011-06-24T04:01:12Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116283",
    "user": "https://github.com/strogdon"
}
```

Segmentation fault associated with



---

archive/attachments_014867.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "ell_curve_isogeny.segfault.bz2",
    "asset_url": "tarball://root/attachments/ticket11339/ell_curve_isogeny.segfault.bz2",
    "created_at": "2011-06-24T04:03:31Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket11339/ell_curve_isogeny.segfault.bz2",
    "user": "https://github.com/strogdon"
}
```



---

archive/issue_comments_116284.json:
```json
{
    "body": "Attachment [ell_curve_isogeny.segfault.bz2](https://github.com/sagemath/sage/files/ticket11339/ell_curve_isogeny.segfault.bz2) by @strogdon created at 2011-06-24 04:03:31\n\nell_curve_isogeny.py debug/backtrace",
    "created_at": "2011-06-24T04:03:31Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116284",
    "user": "https://github.com/strogdon"
}
```

Attachment [ell_curve_isogeny.segfault.bz2](https://github.com/sagemath/sage/files/ticket11339/ell_curve_isogeny.segfault.bz2) by @strogdon created at 2011-06-24 04:03:31

ell_curve_isogeny.py debug/backtrace



---

archive/attachments_014868.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "ell_curve_isogeny.gdb.bz2",
    "asset_url": "tarball://root/attachments/ticket11339/ell_curve_isogeny.gdb.bz2",
    "created_at": "2011-06-24T18:53:27Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket11339/ell_curve_isogeny.gdb.bz2",
    "user": "https://github.com/nexttime"
}
```



---

archive/issue_comments_116285.json:
```json
{
    "body": "<a id='comment:38'></a>\nAttachment [ell_curve_isogeny.gdb.bz2](https://github.com/sagemath/sage/files/ticket11339/ell_curve_isogeny.gdb.bz2) by @nexttime created at 2011-06-24 18:53:27",
    "created_at": "2011-06-24T18:53:27Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116285",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:38'></a>
Attachment [ell_curve_isogeny.gdb.bz2](https://github.com/sagemath/sage/files/ticket11339/ell_curve_isogeny.gdb.bz2) by @nexttime created at 2011-06-24 18:53:27



---

archive/issue_comments_116286.json:
```json
{
    "body": "<a id='comment:39'></a>\nI built a sage spkg with Singular's polynomials debugging turned on (`PDEBUG=2`) and now Singular spits out tons of memory allocation errors during Sage startup (turns out Sage does some high-degree polynomial computations during startup). Can somebody who understands Singular better comment on whether those are real errors?\n\nhttp://www.stp.dias.ie/~vbraun/Sage/spkg/singularDEBUG-3-1-1-4.p9.spkg\n\nNote that its not as easy as turning on `SAGE_DEBUG`; the Singular spkg-install does set a configure option in that case but its not doing anything. I also had to fix up an instance where an `#ifdef PDEBUG` replaced a libSingular function by a macro.",
    "created_at": "2011-06-25T12:11:23Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116286",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:39'></a>
I built a sage spkg with Singular's polynomials debugging turned on (`PDEBUG=2`) and now Singular spits out tons of memory allocation errors during Sage startup (turns out Sage does some high-degree polynomial computations during startup). Can somebody who understands Singular better comment on whether those are real errors?

http://www.stp.dias.ie/~vbraun/Sage/spkg/singularDEBUG-3-1-1-4.p9.spkg

Note that its not as easy as turning on `SAGE_DEBUG`; the Singular spkg-install does set a configure option in that case but its not doing anything. I also had to fix up an instance where an `#ifdef PDEBUG` replaced a libSingular function by a macro.



---

archive/issue_events_089079.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-06-25T12:11:23Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89079"
}
```



---

archive/issue_events_089080.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-06-25T12:11:23Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "needs info",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89080"
}
```



---

archive/issue_comments_116287.json:
```json
{
    "body": "<a id='comment:40'></a>\nI sent and e-mail to [libsingular-devel], cf. http://groups.google.com/group/libsingular-devel/browse_thread/thread/71fcd01208f107ca",
    "created_at": "2011-06-25T13:54:34Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116287",
    "user": "https://github.com/malb"
}
```

<a id='comment:40'></a>
I sent and e-mail to [libsingular-devel], cf. http://groups.google.com/group/libsingular-devel/browse_thread/thread/71fcd01208f107ca



---

archive/issue_comments_116288.json:
```json
{
    "body": "<a id='comment:41'></a>\nThe omalloc error gets triggered by fraction field conversions. If you take out some stuff from ell_curve_isogeny.py then you can start up Sage just fine. I'll attach a patch for debugging purposes.\n\nThe omalloc errors appear with or without my patches on this ticket, by the way.",
    "created_at": "2011-06-25T14:00:17Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116288",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:41'></a>
The omalloc error gets triggered by fraction field conversions. If you take out some stuff from ell_curve_isogeny.py then you can start up Sage just fine. I'll attach a patch for debugging purposes.

The omalloc errors appear with or without my patches on this ticket, by the way.



---

archive/attachments_014869.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "remove_polys.patch",
    "asset_url": "tarball://root/attachments/ticket11339/remove_polys.patch",
    "created_at": "2011-06-25T14:01:02Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket11339/remove_polys.patch",
    "user": "https://github.com/vbraun"
}
```



---

archive/issue_comments_116289.json:
```json
{
    "body": "Attachment [remove_polys.patch](https://github.com/sagemath/sage/files/ticket11339/remove_polys.patch) by @vbraun created at 2011-06-25 14:01:02\n\nRemove some initialization form ell_curve_isogeny.py for debugging.",
    "created_at": "2011-06-25T14:01:02Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116289",
    "user": "https://github.com/vbraun"
}
```

Attachment [remove_polys.patch](https://github.com/sagemath/sage/files/ticket11339/remove_polys.patch) by @vbraun created at 2011-06-25 14:01:02

Remove some initialization form ell_curve_isogeny.py for debugging.



---

archive/issue_comments_116290.json:
```json
{
    "body": "<a id='comment:42'></a>\nJust for the record while I am working on stuff. It seems there are no problems on amd64 all the problems seem to arise on the x86 side. So I upgraded to 4.7.1.alpha3 and ran the long tests on my 2003 x86 box. 16 hours later I have three doctests crashes that may be related (currently setting proper debugging on that box) and i seem to have lost the test.log :P - just great. Anyway I'll have a look at the extra debugging in libsingular. If there is a problem with omalloc could we switch to the system malloc? I think there is an option for that (whether it is working or not is another matter).",
    "created_at": "2011-06-26T20:28:45Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116290",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:42'></a>
Just for the record while I am working on stuff. It seems there are no problems on amd64 all the problems seem to arise on the x86 side. So I upgraded to 4.7.1.alpha3 and ran the long tests on my 2003 x86 box. 16 hours later I have three doctests crashes that may be related (currently setting proper debugging on that box) and i seem to have lost the test.log :P - just great. Anyway I'll have a look at the extra debugging in libsingular. If there is a problem with omalloc could we switch to the system malloc? I think there is an option for that (whether it is working or not is another matter).



---

archive/issue_comments_116291.json:
```json
{
    "body": "<a id='comment:43'></a>\nOne was: sage/modular/modform/element.py, now that I have started to include debugging info it seems to behave, may be it was the load.",
    "created_at": "2011-06-26T20:37:05Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116291",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:43'></a>
One was: sage/modular/modform/element.py, now that I have started to include debugging info it seems to behave, may be it was the load.



---

archive/issue_comments_116292.json:
```json
{
    "body": "<a id='comment:44'></a>\nOK back to singular problems. On my OS X (10.5.8 32bits) box I got another test crash:\n\n```\nsage -t -long  -force_lib devel/sage-main/sage/rings/polynomial/toy_buchberger.py\n```\nand the following backtrace\n\n```\nProgram received signal EXC_BAD_ACCESS, Could not access memory.\nReason: KERN_PROTECTION_FAILURE at address: 0x0000001a\n0x062ad4e5 in nlNormalize ()\n(gdb) bt\n#0  0x062ad4e5 in nlNormalize ()\n#1  0x062ad78b in nlInt ()\n#2  0x06cdcca6 in __pyx_f_4sage_4libs_8singular_8singular_si2sa ()\n#3  0x06bb7f07 in __pyx_f_4sage_5rings_10polynomial_28multi_polynomial_libsingular_23MPolynomial_libsingular__hash_c ()\n#4  0x06b5c263 in __pyx_pf_4sage_5rings_10polynomial_28multi_polynomial_libsingular_23MPolynomial_libsingular_6__hash__ ()\n#5  0x00203ee4 in set_add_key ()\n#6  0x00203f39 in set_add ()\n#7  0x00255e2b in PyEval_EvalFrameEx ()\n```\nThis is with 4.7.1.alpha4. I'll try again on the linux x86 box this weekend (and not lose the logs this time). It may be the last test I run on that box for a while.",
    "created_at": "2011-07-07T23:13:15Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116292",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:44'></a>
OK back to singular problems. On my OS X (10.5.8 32bits) box I got another test crash:

```
sage -t -long  -force_lib devel/sage-main/sage/rings/polynomial/toy_buchberger.py
```
and the following backtrace

```
Program received signal EXC_BAD_ACCESS, Could not access memory.
Reason: KERN_PROTECTION_FAILURE at address: 0x0000001a
0x062ad4e5 in nlNormalize ()
(gdb) bt
#0  0x062ad4e5 in nlNormalize ()
#1  0x062ad78b in nlInt ()
#2  0x06cdcca6 in __pyx_f_4sage_4libs_8singular_8singular_si2sa ()
#3  0x06bb7f07 in __pyx_f_4sage_5rings_10polynomial_28multi_polynomial_libsingular_23MPolynomial_libsingular__hash_c ()
#4  0x06b5c263 in __pyx_pf_4sage_5rings_10polynomial_28multi_polynomial_libsingular_23MPolynomial_libsingular_6__hash__ ()
#5  0x00203ee4 in set_add_key ()
#6  0x00203f39 in set_add ()
#7  0x00255e2b in PyEval_EvalFrameEx ()
```
This is with 4.7.1.alpha4. I'll try again on the linux x86 box this weekend (and not lose the logs this time). It may be the last test I run on that box for a while.



---

archive/issue_comments_116293.json:
```json
{
    "body": "<a id='comment:45'></a>\nReplying to [fbissey](#comment%3A44):\n\n> OK back to singular problems. On my OS X (10.5.8 32bits) box I got another test crash: ` sage -t -long  -force_lib devel/sage-main/sage/rings/polynomial/toy_buchberger.py `\n\n\nI get the same failure on amd64 (vanilla sage-4.7.1.alpha4) but with a slightly different backtrace. Here is the beginning of the backtrace:\n\n```\nProgram received signal SIGSEGV, Segmentation fault.\nnlNormalize (x=@0x7fffffffac68) at longrat.cc:1221\n1221    longrat.cc: No such file or directory.\n        in longrat.cc\n(gdb) bt\n#0  nlNormalize (x=@0x7fffffffac68) at longrat.cc:1221\n#1  0x00007fffdb2caafe in nlInt (i=@0x7fffffffac68, r=<value optimized out>)\n    at longrat.cc:494\n#2  0x00007fffda13f4f1 in __pyx_f_4sage_4libs_8singular_8singular_si2sa (\n    __pyx_v_n=0x2, __pyx_v__ring=0x7fffdb0a3760, __pyx_v_base=0x4964000)\n    at sage/libs/singular/singular.cpp:5508\n#3  0x00007fffdabf216a in __pyx_f_4sage_5rings_10polynomial_28multi_polynomial_libsingular_23MPolynomial_libsingular__hash_c (__pyx_v_self=<value optimized out>)\n    at sage/rings/polynomial/multi_polynomial_libsingular.cpp:18417\n#4  0x00007fffdabdc66b in __pyx_pf_4sage_5rings_10polynomial_28multi_polynomial_libsingular_23MPolynomial_libsingular_6__hash__ (__pyx_v_self=<value optimized out>)\n    at sage/rings/polynomial/multi_polynomial_libsingular.cpp:14965\n#5  0x00007ffff7a8dde8 in set_add_key (so=0x483b138, key=0x495b9b0)\n    at Objects/setobject.c:386\n#6  0x00007ffff7a8de39 in set_add (so=<value optimized out>, \n    key=<value optimized out>) at Objects/setobject.c:1837\n#7  0x00007ffff7af0fa4 in call_function (oparg=<value optimized out>, \n    pp_stack=0x7fffffffae50) at Python/ceval.c:4000\n#8  PyEval_EvalFrameEx (f=<value optimized out>, throwflag=<value optimized out>)\n    at Python/ceval.c:2665\n#9  0x00007ffff7af1824 in fast_function (nk=<value optimized out>, \n    na=<value optimized out>, n=<value optimized out>, pp_stack=0x7fffffffafc0, \n    func=0x152da28) at Python/ceval.c:4098\n```\nI get no crashes when running the testsuite on x86.",
    "created_at": "2011-07-08T00:26:09Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116293",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:45'></a>
Replying to [fbissey](#comment%3A44):

> OK back to singular problems. On my OS X (10.5.8 32bits) box I got another test crash: ` sage -t -long  -force_lib devel/sage-main/sage/rings/polynomial/toy_buchberger.py `


I get the same failure on amd64 (vanilla sage-4.7.1.alpha4) but with a slightly different backtrace. Here is the beginning of the backtrace:

```
Program received signal SIGSEGV, Segmentation fault.
nlNormalize (x=@0x7fffffffac68) at longrat.cc:1221
1221    longrat.cc: No such file or directory.
        in longrat.cc
(gdb) bt
#0  nlNormalize (x=@0x7fffffffac68) at longrat.cc:1221
#1  0x00007fffdb2caafe in nlInt (i=@0x7fffffffac68, r=<value optimized out>)
    at longrat.cc:494
#2  0x00007fffda13f4f1 in __pyx_f_4sage_4libs_8singular_8singular_si2sa (
    __pyx_v_n=0x2, __pyx_v__ring=0x7fffdb0a3760, __pyx_v_base=0x4964000)
    at sage/libs/singular/singular.cpp:5508
#3  0x00007fffdabf216a in __pyx_f_4sage_5rings_10polynomial_28multi_polynomial_libsingular_23MPolynomial_libsingular__hash_c (__pyx_v_self=<value optimized out>)
    at sage/rings/polynomial/multi_polynomial_libsingular.cpp:18417
#4  0x00007fffdabdc66b in __pyx_pf_4sage_5rings_10polynomial_28multi_polynomial_libsingular_23MPolynomial_libsingular_6__hash__ (__pyx_v_self=<value optimized out>)
    at sage/rings/polynomial/multi_polynomial_libsingular.cpp:14965
#5  0x00007ffff7a8dde8 in set_add_key (so=0x483b138, key=0x495b9b0)
    at Objects/setobject.c:386
#6  0x00007ffff7a8de39 in set_add (so=<value optimized out>, 
    key=<value optimized out>) at Objects/setobject.c:1837
#7  0x00007ffff7af0fa4 in call_function (oparg=<value optimized out>, 
    pp_stack=0x7fffffffae50) at Python/ceval.c:4000
#8  PyEval_EvalFrameEx (f=<value optimized out>, throwflag=<value optimized out>)
    at Python/ceval.c:2665
#9  0x00007ffff7af1824 in fast_function (nk=<value optimized out>, 
    na=<value optimized out>, n=<value optimized out>, pp_stack=0x7fffffffafc0, 
    func=0x152da28) at Python/ceval.c:4098
```
I get no crashes when running the testsuite on x86.



---

archive/issue_comments_116294.json:
```json
{
    "body": "<a id='comment:46'></a>\nyes you have more details. Traces with gdb on OS X is just difficult. But I don't get that one on any of my two amd64 boxes. I will try that particular test on x86.",
    "created_at": "2011-07-08T02:31:45Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116294",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:46'></a>
yes you have more details. Traces with gdb on OS X is just difficult. But I don't get that one on any of my two amd64 boxes. I will try that particular test on x86.



---

archive/issue_comments_116295.json:
```json
{
    "body": "<a id='comment:47'></a>\ni get the failure in sage/schemes/elliptic_curves/ell_curve_isogeny.py on my x86 box same backtrace as [comment:35](#comment%3A35) - sage/modular/modform/element.py still seem to play up, it crashes when I run sage -testall but not when I run it individually. Note that I don't parallel testing on that machine. Wait a minute it crashed after I added -long.\n\n```\nsage -t -long -force_lib \"devel/sage/sage/modular/modform/element.py\"\nThe doctested process was killed by signal 8\n         [62.7 s]\n \n----------------------------------------------------------------------\nThe following tests failed:\n\n\n        sage -t -long -force_lib \"devel/sage/sage/modular/modform/element.py\" # Killed/crashed\nTotal time for all tests: 62.7 seconds\n```\nUnfortunately it disappear again when in gdb:\n\n```\nfrancois@vrooom ~ $ sage -t -long -force_lib \"devel/sage/sage/modular/modform/element.py\" -gdb\nsage -t -long -force_lib -gdb \"devel/sage/sage/modular/modform/element.py\"\n********************************************************************************\nType r at the (gdb) prompt to run the doctests.\nType bt if there is a crash to see a traceback.\n********************************************************************************\nGNU gdb (Gentoo 7.2 p1) 7.2\nCopyright (C) 2010 Free Software Foundation, Inc.\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.  Type \"show copying\"\nand \"show warranty\" for details.\nThis GDB was configured as \"i686-pc-linux-gnu\".\nFor bug reporting instructions, please see:\n<http://bugs.gentoo.org/>...\nReading symbols from /usr/bin/python...(no debugging symbols found)...done.\n(gdb) run\nStarting program: /usr/bin/python /home/francois/.sage/tmp/.doctest_element.py\nprocess 27984 is executing new program: /usr/bin/python2.7\n[Thread debugging using libthread_db enabled]\nTraceback (most recent call last):\n  File \"/usr/share/gdb/auto-load/usr/lib/gcc/i686-pc-linux-gnu/4.5.2/libstdc++.so.6.0.14-gdb.py\", line 59, in <module>\n    from libstdcxx.v6.printers import register_libstdcxx_printers\nImportError: No module named libstdcxx.v6.printers\n\nProgram exited normally.\n```",
    "created_at": "2011-07-09T03:27:10Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116295",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:47'></a>
i get the failure in sage/schemes/elliptic_curves/ell_curve_isogeny.py on my x86 box same backtrace as [comment:35](#comment%3A35) - sage/modular/modform/element.py still seem to play up, it crashes when I run sage -testall but not when I run it individually. Note that I don't parallel testing on that machine. Wait a minute it crashed after I added -long.

```
sage -t -long -force_lib "devel/sage/sage/modular/modform/element.py"
The doctested process was killed by signal 8
         [62.7 s]
 
----------------------------------------------------------------------
The following tests failed:


        sage -t -long -force_lib "devel/sage/sage/modular/modform/element.py" # Killed/crashed
Total time for all tests: 62.7 seconds
```
Unfortunately it disappear again when in gdb:

```
francois@vrooom ~ $ sage -t -long -force_lib "devel/sage/sage/modular/modform/element.py" -gdb
sage -t -long -force_lib -gdb "devel/sage/sage/modular/modform/element.py"
********************************************************************************
Type r at the (gdb) prompt to run the doctests.
Type bt if there is a crash to see a traceback.
********************************************************************************
GNU gdb (Gentoo 7.2 p1) 7.2
Copyright (C) 2010 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "i686-pc-linux-gnu".
For bug reporting instructions, please see:
<http://bugs.gentoo.org/>...
Reading symbols from /usr/bin/python...(no debugging symbols found)...done.
(gdb) run
Starting program: /usr/bin/python /home/francois/.sage/tmp/.doctest_element.py
process 27984 is executing new program: /usr/bin/python2.7
[Thread debugging using libthread_db enabled]
Traceback (most recent call last):
  File "/usr/share/gdb/auto-load/usr/lib/gcc/i686-pc-linux-gnu/4.5.2/libstdc++.so.6.0.14-gdb.py", line 59, in <module>
    from libstdcxx.v6.printers import register_libstdcxx_printers
ImportError: No module named libstdcxx.v6.printers

Program exited normally.
```



---

archive/issue_comments_116296.json:
```json
{
    "body": "<a id='comment:48'></a>\nDisregard sage/modular/modform/element.py. Our old friend ATLAS-3.9.xx is responsible for that one. With -verbose:\n\n```\nTrying:\n    f = ModularForms(Gamma1(Integer(3)), Integer(7)).gen(0)###line 1016:_sage_    >>> f = ModularForms(Gamma1(3), 7).0\nExpecting nothing\nok\nTrying:\n    f*f###line 1017:_sage_    >>> f*f\nExpecting:\n    q^2 - 54*q^4 + 128*q^5 + O(q^6)\n/usr/lib/libcsage.so(print_backtrace+0x40)[0xb6e35acf]\n/usr/lib/libcsage.so(sigdie+0x22)[0xb6e35b92]\n/usr/lib/libcsage.so(sage_signal_handler+0x1a3)[0xb6e35d84]\n[0xb77cc400]\n/usr/lib/libgmp.so.3(__gmpz_set_d+0x49)[0xb689a2b9]\n/usr/lib/libiml.so.0(ChineseRemainder+0x1af)[0xb3055b1f]\n\n------------------------------------------------------------------------\nUnhandled SIGFPE: An unhandled floating point exception occurred in Sage.\nThis probably occurred because a *compiled* component of Sage has a bug\nin it and is not properly wrapped with sig_on(), sig_off(). You might\nwant to run Sage under gdb with 'sage -gdb' to debug this.\nSage will now terminate.\n------------------------------------------------------------------------\nThe doctested process was killed by signal 8\n```",
    "created_at": "2011-07-09T03:31:11Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116296",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:48'></a>
Disregard sage/modular/modform/element.py. Our old friend ATLAS-3.9.xx is responsible for that one. With -verbose:

```
Trying:
    f = ModularForms(Gamma1(Integer(3)), Integer(7)).gen(0)###line 1016:_sage_    >>> f = ModularForms(Gamma1(3), 7).0
Expecting nothing
ok
Trying:
    f*f###line 1017:_sage_    >>> f*f
Expecting:
    q^2 - 54*q^4 + 128*q^5 + O(q^6)
/usr/lib/libcsage.so(print_backtrace+0x40)[0xb6e35acf]
/usr/lib/libcsage.so(sigdie+0x22)[0xb6e35b92]
/usr/lib/libcsage.so(sage_signal_handler+0x1a3)[0xb6e35d84]
[0xb77cc400]
/usr/lib/libgmp.so.3(__gmpz_set_d+0x49)[0xb689a2b9]
/usr/lib/libiml.so.0(ChineseRemainder+0x1af)[0xb3055b1f]

------------------------------------------------------------------------
Unhandled SIGFPE: An unhandled floating point exception occurred in Sage.
This probably occurred because a *compiled* component of Sage has a bug
in it and is not properly wrapped with sig_on(), sig_off(). You might
want to run Sage under gdb with 'sage -gdb' to debug this.
Sage will now terminate.
------------------------------------------------------------------------
The doctested process was killed by signal 8
```



---

archive/issue_comments_116297.json:
```json
{
    "body": "<a id='comment:49'></a>\nSomething is wrong with atlas-3.9.x and linbox. \n\nI built libSingular with debugging turned on, but that shows lots and lots of errors. I'm not sure if all of them are actual bugs, but I think its likely that they are the origin of the segfaults. See https://groups.google.com/d/msg/libsingular-devel/cfzQEgjxB8o/dvb2Efc-7pIJ",
    "created_at": "2011-07-09T20:01:22Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116297",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:49'></a>
Something is wrong with atlas-3.9.x and linbox. 

I built libSingular with debugging turned on, but that shows lots and lots of errors. I'm not sure if all of them are actual bugs, but I think its likely that they are the origin of the segfaults. See https://groups.google.com/d/msg/libsingular-devel/cfzQEgjxB8o/dvb2Efc-7pIJ



---

archive/issue_comments_116298.json:
```json
{
    "body": "<a id='comment:50'></a>\nReplying to [vbraun](#comment%3A49):\n> Something is wrong with atlas-3.9.x and linbox. \n\n\nI know about that. I have known about a similar problem with iml for longer [https://github.com/cschwan/sage-on-gentoo/issues/3](https://github.com/cschwan/sage-on-gentoo/issues/3). Both iml and linbox fail after calling a routine called (or including the words) ChineseRemainder which uses results from calls to cblas_dgemv and cblas_dgemm but this comment really belongs to #10508.\n\n> \n> I built libSingular with debugging turned on, but that shows lots and lots of errors. I'm not sure if all of them are actual bugs, but I think its likely that they are the origin of the segfaults. See https://groups.google.com/d/msg/libsingular-devel/cfzQEgjxB8o/dvb2Efc-7pIJ\n\n\nI know this is a slow time of the year in the northern emisphere (starting semester two tomorrow down under) but nothing since June 27th? May be the thread should be bumped or something.",
    "created_at": "2011-07-10T02:25:47Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116298",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:50'></a>
Replying to [vbraun](#comment%3A49):
> Something is wrong with atlas-3.9.x and linbox. 


I know about that. I have known about a similar problem with iml for longer [https://github.com/cschwan/sage-on-gentoo/issues/3](https://github.com/cschwan/sage-on-gentoo/issues/3). Both iml and linbox fail after calling a routine called (or including the words) ChineseRemainder which uses results from calls to cblas_dgemv and cblas_dgemm but this comment really belongs to #10508.

> 
> I built libSingular with debugging turned on, but that shows lots and lots of errors. I'm not sure if all of them are actual bugs, but I think its likely that they are the origin of the segfaults. See https://groups.google.com/d/msg/libsingular-devel/cfzQEgjxB8o/dvb2Efc-7pIJ


I know this is a slow time of the year in the northern emisphere (starting semester two tomorrow down under) but nothing since June 27th? May be the thread should be bumped or something.



---

archive/issue_comments_116299.json:
```json
{
    "body": "<a id='comment:51'></a>\nStill got the failure schemes/elliptic_curves/ell_curve_isogeny.py on amd64 with 4.7.2_alpha0. That's the only killed doctest so far on this set up.",
    "created_at": "2011-08-08T23:29:27Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116299",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:51'></a>
Still got the failure schemes/elliptic_curves/ell_curve_isogeny.py on amd64 with 4.7.2_alpha0. That's the only killed doctest so far on this set up.



---

archive/issue_comments_116300.json:
```json
{
    "body": "<a id='comment:52'></a>\nHere's an update since 4.7.2.alpha1 has been released. refcount_singular_polynomials.patch applies just fine but there is fuzz with refcount_singular_rings.patch\n\n```\n\napplying /storage/sage/patches/trac_11339_refcount_singular_rings.patch\n\npatching file sage/libs/singular/ring.pyx\n\nHunk #1 succeeded at 57 with fuzz 2 (offset 5 lines).\n\n```\nI get the following failures (killed/crashed):\n\nx86:\n\nsage -t -long  -force_lib devel/sage-main/sage/crypto/mq/mpolynomialsystem.py\n\namd64:\n\nsage -t -long  -force_lib devel/sage-main/sage/schemes/elliptic_curves/ell_number_field.py\n\nsage -t -long  -force_lib devel/sage-main/sage/crypto/mq/mpolynomialsystem.py\n\nsage -t -long  -force_lib devel/sage-main/sage/crypto/mq/sr.py",
    "created_at": "2011-08-22T04:48:39Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116300",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:52'></a>
Here's an update since 4.7.2.alpha1 has been released. refcount_singular_polynomials.patch applies just fine but there is fuzz with refcount_singular_rings.patch

```

applying /storage/sage/patches/trac_11339_refcount_singular_rings.patch

patching file sage/libs/singular/ring.pyx

Hunk #1 succeeded at 57 with fuzz 2 (offset 5 lines).

```
I get the following failures (killed/crashed):

x86:

sage -t -long  -force_lib devel/sage-main/sage/crypto/mq/mpolynomialsystem.py

amd64:

sage -t -long  -force_lib devel/sage-main/sage/schemes/elliptic_curves/ell_number_field.py

sage -t -long  -force_lib devel/sage-main/sage/crypto/mq/mpolynomialsystem.py

sage -t -long  -force_lib devel/sage-main/sage/crypto/mq/sr.py



---

archive/issue_comments_116301.json:
```json
{
    "body": "<a id='comment:53'></a>\nReplying to [strogdon](#comment%3A52):\n> Here's an update since 4.7.2.alpha1 has been released. refcount_singular_polynomials.patch applies just fine but there is fuzz with refcount_singular_rings.patch\n> \n> ```\n> \n> applying /storage/sage/patches/trac_11339_refcount_singular_rings.patch\n> \n> patching file sage/libs/singular/ring.pyx\n> \n> Hunk #1 succeeded at 57 with fuzz 2 (offset 5 lines).\n> \n> ```\n> I get the following failures (killed/crashed):\n> \n> x86:\n> \n> sage -t -long  -force_lib devel/sage-main/sage/crypto/mq/mpolynomialsystem.py\n> \n> amd64:\n> \n> sage -t -long  -force_lib devel/sage-main/sage/schemes/elliptic_curves/ell_number_field.py\n> \n> sage -t -long  -force_lib devel/sage-main/sage/crypto/mq/mpolynomialsystem.py\n> \n> sage -t -long  -force_lib devel/sage-main/sage/crypto/mq/sr.py\n\n\n\nVanilla or sage-on-gentoo (sog) variety? So far for sog I still only have the sage/schemes/elliptic_curves/ell_curve_isogeny.py crash but nothing else on amd64. \n\nMy linux-x86 box is \"decommissioned\", I'll look on x86 OS X next.\n\nHaven't had time to try vanilla.",
    "created_at": "2011-08-22T05:03:45Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116301",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:53'></a>
Replying to [strogdon](#comment%3A52):
> Here's an update since 4.7.2.alpha1 has been released. refcount_singular_polynomials.patch applies just fine but there is fuzz with refcount_singular_rings.patch
> 
> ```
> 
> applying /storage/sage/patches/trac_11339_refcount_singular_rings.patch
> 
> patching file sage/libs/singular/ring.pyx
> 
> Hunk #1 succeeded at 57 with fuzz 2 (offset 5 lines).
> 
> ```
> I get the following failures (killed/crashed):
> 
> x86:
> 
> sage -t -long  -force_lib devel/sage-main/sage/crypto/mq/mpolynomialsystem.py
> 
> amd64:
> 
> sage -t -long  -force_lib devel/sage-main/sage/schemes/elliptic_curves/ell_number_field.py
> 
> sage -t -long  -force_lib devel/sage-main/sage/crypto/mq/mpolynomialsystem.py
> 
> sage -t -long  -force_lib devel/sage-main/sage/crypto/mq/sr.py



Vanilla or sage-on-gentoo (sog) variety? So far for sog I still only have the sage/schemes/elliptic_curves/ell_curve_isogeny.py crash but nothing else on amd64. 

My linux-x86 box is "decommissioned", I'll look on x86 OS X next.

Haven't had time to try vanilla.



---

archive/issue_comments_116302.json:
```json
{
    "body": "<a id='comment:54'></a>\nReplying to [fbissey](#comment%3A53):\n\n> Replying to [strogdon](#comment%3A52):\n> > Here's an update since 4.7.2.alpha1 has been released. refcount_singular_polynomials.patch applies just fine but there is fuzz with refcount_singular_rings.patch ` applying /storage/sage/patches/trac_11339_refcount_singular_rings.patch patching file sage/libs/singular/ring.pyx Hunk #1 succeeded at 57 with fuzz 2 (offset 5 lines). ` I get the following failures (killed/crashed): x86: sage -t -long  -force_lib devel/sage-main/sage/crypto/mq/mpolynomialsystem.py amd64: sage -t -long  -force_lib devel/sage-main/sage/schemes/elliptic_curves/ell_number_field.py sage -t -long  -force_lib devel/sage-main/sage/crypto/mq/mpolynomialsystem.py sage -t -long  -force_lib devel/sage-main/sage/crypto/mq/sr.py\n\n> Vanilla or sage-on-gentoo (sog) variety? So far for sog I still only have the sage/schemes/elliptic_curves/ell_curve_isogeny.py crash but nothing else on amd64.  My linux-x86 box is \"decommissioned\", I'll look on x86 OS X next. Haven't had time to try vanilla.\n\nThis is for vanilla Sage. I've just started on sage-on-gentoo builds.",
    "created_at": "2011-08-22T05:11:45Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116302",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:54'></a>
Replying to [fbissey](#comment%3A53):

> Replying to [strogdon](#comment%3A52):
> > Here's an update since 4.7.2.alpha1 has been released. refcount_singular_polynomials.patch applies just fine but there is fuzz with refcount_singular_rings.patch ` applying /storage/sage/patches/trac_11339_refcount_singular_rings.patch patching file sage/libs/singular/ring.pyx Hunk #1 succeeded at 57 with fuzz 2 (offset 5 lines). ` I get the following failures (killed/crashed): x86: sage -t -long  -force_lib devel/sage-main/sage/crypto/mq/mpolynomialsystem.py amd64: sage -t -long  -force_lib devel/sage-main/sage/schemes/elliptic_curves/ell_number_field.py sage -t -long  -force_lib devel/sage-main/sage/crypto/mq/mpolynomialsystem.py sage -t -long  -force_lib devel/sage-main/sage/crypto/mq/sr.py

> Vanilla or sage-on-gentoo (sog) variety? So far for sog I still only have the sage/schemes/elliptic_curves/ell_curve_isogeny.py crash but nothing else on amd64.  My linux-x86 box is "decommissioned", I'll look on x86 OS X next. Haven't had time to try vanilla.

This is for vanilla Sage. I've just started on sage-on-gentoo builds.



---

archive/issue_comments_116303.json:
```json
{
    "body": "<a id='comment:55'></a>\ntrac_11339_refcount_singular_polynomials.patch doesn't apply on top of 4.7.2.alpha2, I believe the conflict is with #7654 but I could be wrong.",
    "created_at": "2011-08-24T23:56:59Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116303",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:55'></a>
trac_11339_refcount_singular_polynomials.patch doesn't apply on top of 4.7.2.alpha2, I believe the conflict is with #7654 but I could be wrong.



---

archive/issue_comments_116304.json:
```json
{
    "body": "<a id='comment:56'></a>\n\n```\nleif@californication:~/Sage/sage-4.7.2.alpha2-gcc-4.5.1/devel/sage-9958-11339$ ../../sage -hg import -v ~/Sage/patches/trac_11339_refcount_singular_polynomials.patch \napplying /home/leif/Sage/patches/trac_11339_refcount_singular_polynomials.patch\npatching file sage/rings/polynomial/multi_polynomial_libsingular.pxd\npatching file sage/rings/polynomial/multi_polynomial_libsingular.pyx\nHunk #13 FAILED at 727\nHunk #14 FAILED at 741\nHunk #15 FAILED at 763\nHunk #16 FAILED at 773\nHunk #17 FAILED at 825\nHunk #18 succeeded at 910 with fuzz 2 (offset 72 lines).\nHunk #19 FAILED at 875\nHunk #20 succeeded at 961 (offset 75 lines).\nHunk #21 succeeded at 980 (offset 75 lines).\nHunk #22 succeeded at 1006 (offset 75 lines).\n...\n```\n(The first patch still applies, with offsets.)\n\nI'm not going to fix that...",
    "created_at": "2011-08-29T07:11:23Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116304",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:56'></a>

```
leif@californication:~/Sage/sage-4.7.2.alpha2-gcc-4.5.1/devel/sage-9958-11339$ ../../sage -hg import -v ~/Sage/patches/trac_11339_refcount_singular_polynomials.patch 
applying /home/leif/Sage/patches/trac_11339_refcount_singular_polynomials.patch
patching file sage/rings/polynomial/multi_polynomial_libsingular.pxd
patching file sage/rings/polynomial/multi_polynomial_libsingular.pyx
Hunk #13 FAILED at 727
Hunk #14 FAILED at 741
Hunk #15 FAILED at 763
Hunk #16 FAILED at 773
Hunk #17 FAILED at 825
Hunk #18 succeeded at 910 with fuzz 2 (offset 72 lines).
Hunk #19 FAILED at 875
Hunk #20 succeeded at 961 (offset 75 lines).
Hunk #21 succeeded at 980 (offset 75 lines).
Hunk #22 succeeded at 1006 (offset 75 lines).
...
```
(The first patch still applies, with offsets.)

I'm not going to fix that...



---

archive/issue_events_089081.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2011-08-29T07:11:23Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "needs info",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89081"
}
```



---

archive/issue_events_089082.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2011-08-29T07:11:23Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89082"
}
```



---

archive/issue_comments_116305.json:
```json
{
    "body": "**Work_Issues:** Rebase on Sage 4.7.2.alpha2.",
    "created_at": "2011-08-29T07:11:23Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116305",
    "user": "https://github.com/nexttime"
}
```

**Work_Issues:** Rebase on Sage 4.7.2.alpha2.



---

archive/issue_events_089083.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2011-08-29T07:12:34Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89083"
}
```



---

archive/issue_events_089084.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2011-08-29T07:12:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89084"
}
```



---

archive/issue_comments_116306.json:
```json
{
    "body": "<a id='comment:57'></a>\nTrac, why can't I switch from \"needs info\" to \"needs work\"?!?",
    "created_at": "2011-08-29T07:12:34Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116306",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:57'></a>
Trac, why can't I switch from "needs info" to "needs work"?!?



---

archive/issue_comments_116307.json:
```json
{
    "body": "<a id='comment:58'></a>\nReplying to [leif](#comment%3A56):\n>\n\n```\n leif@californication:~/Sage/sage-4.7.2.alpha2-gcc-4.5.1/devel/sage-9958-11339$ ../../sage -hg import -v ~/Sage/patches/trac_11339_refcount_singular_polynomials.patch \n applying /home/leif/Sage/patches/trac_11339_refcount_singular_polynomials.patch\n patching file sage/rings/polynomial/multi_polynomial_libsingular.pxd\n patching file sage/rings/polynomial/multi_polynomial_libsingular.pyx\n Hunk #13 FAILED at 727\n Hunk #14 FAILED at 741\n Hunk #15 FAILED at 763\n Hunk #16 FAILED at 773\n Hunk #17 FAILED at 825\n Hunk #18 succeeded at 910 with fuzz 2 (offset 72 lines).\n Hunk #19 FAILED at 875\n ...\n```\n\nThat's due to #7654. I just wonder why, according to trac, Martin attached (or updated) the patch 11 days ago, but:\n\n```\nleif@californication:~/Sage/sage-4.7.2.alpha2-gcc-4.5.1/devel/sage-9958-11339$ ../../sage -hg log sage/rings/polynomial/multi_polynomial_libsingular.pyx\nchangeset:   16029:f8df02b7396c\nuser:        Martin Albrecht <martinralbrecht@googlemail.com>\ndate:        Sat Jun 25 15:51:22 2011 +0100\nsummary:     Trac #7654: #7654 fix MPolynomial_libsingular.__call__ to accept more inputs \nand fail gracefully\n\n```",
    "created_at": "2011-08-29T07:33:47Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116307",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:58'></a>
Replying to [leif](#comment%3A56):
>

```
 leif@californication:~/Sage/sage-4.7.2.alpha2-gcc-4.5.1/devel/sage-9958-11339$ ../../sage -hg import -v ~/Sage/patches/trac_11339_refcount_singular_polynomials.patch 
 applying /home/leif/Sage/patches/trac_11339_refcount_singular_polynomials.patch
 patching file sage/rings/polynomial/multi_polynomial_libsingular.pxd
 patching file sage/rings/polynomial/multi_polynomial_libsingular.pyx
 Hunk #13 FAILED at 727
 Hunk #14 FAILED at 741
 Hunk #15 FAILED at 763
 Hunk #16 FAILED at 773
 Hunk #17 FAILED at 825
 Hunk #18 succeeded at 910 with fuzz 2 (offset 72 lines).
 Hunk #19 FAILED at 875
 ...
```

That's due to #7654. I just wonder why, according to trac, Martin attached (or updated) the patch 11 days ago, but:

```
leif@californication:~/Sage/sage-4.7.2.alpha2-gcc-4.5.1/devel/sage-9958-11339$ ../../sage -hg log sage/rings/polynomial/multi_polynomial_libsingular.pyx
changeset:   16029:f8df02b7396c
user:        Martin Albrecht <martinralbrecht@googlemail.com>
date:        Sat Jun 25 15:51:22 2011 +0100
summary:     Trac #7654: #7654 fix MPolynomial_libsingular.__call__ to accept more inputs 
and fail gracefully

```



---

archive/issue_comments_116308.json:
```json
{
    "body": "<a id='comment:59'></a>\nI've verified that (except for the meta data, including the dates, and one line number) the patch attached to #7654 and the one Jeroen merged into Sage 4.7.2.alpha2 are the same. Still weird...",
    "created_at": "2011-08-29T07:53:19Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116308",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:59'></a>
I've verified that (except for the meta data, including the dates, and one line number) the patch attached to #7654 and the one Jeroen merged into Sage 4.7.2.alpha2 are the same. Still weird...



---

archive/issue_comments_116309.json:
```json
{
    "body": "<a id='comment:60'></a>\nReplying to [leif](#comment%3A59):\n> I've verified that (except for the meta data, including the dates, and one line number) the patch attached to #7654 and the one Jeroen merged into Sage 4.7.2.alpha2 are the same. Still weird...\n\n\nThe line number is weird, otherwise doesn't Jeroen merge script add stuff to make sure there is proper metadata in the patch?\n\nNote also that we are playing a \"wack a mole\" game here. You fix things in one place and suddenly you get a new failure in another. So refreshing Volker's patch is just the beginning....",
    "created_at": "2011-08-29T12:39:21Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116309",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:60'></a>
Replying to [leif](#comment%3A59):
> I've verified that (except for the meta data, including the dates, and one line number) the patch attached to #7654 and the one Jeroen merged into Sage 4.7.2.alpha2 are the same. Still weird...


The line number is weird, otherwise doesn't Jeroen merge script add stuff to make sure there is proper metadata in the patch?

Note also that we are playing a "wack a mole" game here. You fix things in one place and suddenly you get a new failure in another. So refreshing Volker's patch is just the beginning....



---

archive/attachments_014870.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_11339_refcount_singular_rings.patch",
    "asset_url": "tarball://root/attachments/ticket11339/trac_11339_refcount_singular_rings.patch",
    "created_at": "2011-09-26T19:21:32Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket11339/trac_11339_refcount_singular_rings.patch",
    "user": "https://github.com/vbraun"
}
```



---

archive/issue_comments_116310.json:
```json
{
    "body": "Attachment [trac_11339_refcount_singular_rings.patch](https://github.com/sagemath/sage/files/ticket11339/trac_11339_refcount_singular_rings.patch) by @vbraun created at 2011-09-26 19:21:32\n\nUpdated patch",
    "created_at": "2011-09-26T19:21:32Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116310",
    "user": "https://github.com/vbraun"
}
```

Attachment [trac_11339_refcount_singular_rings.patch](https://github.com/sagemath/sage/files/ticket11339/trac_11339_refcount_singular_rings.patch) by @vbraun created at 2011-09-26 19:21:32

Updated patch



---

archive/issue_comments_116311.json:
```json
{
    "body": "Updated patch",
    "created_at": "2011-09-26T19:21:43Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116311",
    "user": "https://github.com/vbraun"
}
```

Updated patch



---

archive/attachments_014871.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_11339_refcount_singular_polynomials.patch",
    "asset_url": "tarball://root/attachments/ticket11339/trac_11339_refcount_singular_polynomials.patch",
    "created_at": "2011-09-26T19:22:48Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket11339/trac_11339_refcount_singular_polynomials.patch",
    "user": "https://github.com/vbraun"
}
```



---

archive/issue_comments_116312.json:
```json
{
    "body": "<a id='comment:61'></a>\nAttachment [trac_11339_refcount_singular_polynomials.patch](https://github.com/sagemath/sage/files/ticket11339/trac_11339_refcount_singular_polynomials.patch) by @vbraun created at 2011-09-26 19:22:48\n\nI've rebased the patches on top of sage-4.7.2.alpha2. There are still a few segfaults from deleting rings, but at least we can reproduce them with the patches ;-)",
    "created_at": "2011-09-26T19:22:48Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116312",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:61'></a>
Attachment [trac_11339_refcount_singular_polynomials.patch](https://github.com/sagemath/sage/files/ticket11339/trac_11339_refcount_singular_polynomials.patch) by @vbraun created at 2011-09-26 19:22:48

I've rebased the patches on top of sage-4.7.2.alpha2. There are still a few segfaults from deleting rings, but at least we can reproduce them with the patches ;-)



---

archive/issue_comments_116313.json:
```json
{
    "body": "<a id='comment:62'></a>\nSomething for SD34? :P",
    "created_at": "2011-09-27T15:01:58Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116313",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:62'></a>
Something for SD34? :P



---

archive/issue_events_089085.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2011-09-27T15:01:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "critical",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89085"
}
```



---

archive/issue_comments_116314.json:
```json
{
    "body": "<a id='comment:63'></a>\nAside from the segfaults, with the new patches I get the following additional failurers. The failures \"seem\" to be associated with the patches in that I don't get them when I use Martin's patches.\n\namd64:\n\n```\nsage -t -long \u00a0-force_lib devel/sage-trans_16037.16051/sage/misc/sageinspect.py\nsage -t -long \u00a0-force_lib devel/sage-trans_16037.16051/sage/schemes/plane_conics/con_field.py\nsage -t -long \u00a0-force_lib devel/sage-trans_16037.16051/sage/schemes/hyperelliptic_curves/hyperelliptic_finite_field.py\n```\nx86:\n\n```\nsage -t -long  -force_lib devel/sage-trans_16037.16051/sage/misc/sageinspect.py\nsage -t -long  -force_lib devel/sage-trans_16037.16051/sage/schemes/plane_conics/con_field.py\n```\nHere is a brief summary of the failures.\n\nsageinspect.py (partial output given):\n\n```\nExpected:\n    (['cdef class MPolynomialRing_libsingular(MPolynomialRing_generic):\\n',\n      \"    def __init__(self, base_ring, n, names, order='degrevlex'):\\n\",\n    ...\n      '          M.append(new_MP(self, p_Copy(tempvector,_ring)))\\n',\n      '          return M\\n'], ...)\nGot:\n    (['cdef class MPolynomialRing_libsingular(MPolynomialRing_generic):\\n', '\\n', '    def\n __cinit__(self):\\n', '\n```\ncon_field.py:\n\n```\nFile \"/storage/sage/sage-4.7.2.alpha2/devel/sage-trans_16037.16051/sage/schemes/plane_conics/con_field.py\", line 234:\n    sage: C.is_smooth()\nExpected:\n    True\nGot:\n    False\n```\nhyperelliptic_curves/hyperelliptic_finite_field.py:\n\n```\nFile \"/storage/sage/sage-4.7.2.alpha2/devel/sage-trans_16037.16051/sage/schemes/hyperelliptic_curves/hyperelliptic_finite_field.py\", line 269:\n    sage: set(C._points_cache_sqrt()) == set(C._points_cache_sqrt(brute_force=True))\nException raised:\n    Traceback (most recent call last):\n      File \"/storage/sage/sage-4.7.2.alpha2/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/storage/sage/sage-4.7.2.alpha2/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/storage/sage/sage-4.7.2.alpha2/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_5[5]>\", line 1, in <module>\n        set(C._points_cache_sqrt()) == set(C._points_cache_sqrt(brute_force=True))###line 269:\n    sage: set(C._points_cache_sqrt()) == set(C._points_cache_sqrt(brute_force=True))\n      File \"/storage/sage/sage-4.7.2.alpha2/local/lib/python/site-packages/sage/schemes/hyperelliptic_curves/hyperelliptic_finite_field.py\", line 296, in _points_cache_sqrt\n        points.append(self.point([x, -y, one], check=True))\n      File \"/storage/sage/sage-4.7.2.alpha2/local/lib/python/site-packages/sage/schemes/generic/scheme.py\", line 256, in point\n        return self._point_class(self, v, check=check)\n      File \"/storage/sage/sage-4.7.2.alpha2/local/lib/python/site-packages/sage/schemes/generic/algebraic_scheme.py\", line 528, in _point_class\n        return self.__A._point_class(*args, **kwds)\n      File \"/storage/sage/sage-4.7.2.alpha2/local/lib/python/site-packages/sage/schemes/generic/projective_space.py\", line 561, in _point_class\n        return morphism.SchemeMorphism_projective_coordinates_field(*args, **kwds)\n      File \"/storage/sage/sage-4.7.2.alpha2/local/lib/python/site-packages/sage/schemes/generic/morphism.py\", line 676, in __init__\n        X.codomain()._check_satisfies_equations(v)\n      File \"/storage/sage/sage-4.7.2.alpha2/local/lib/python/site-packages/sage/schemes/generic/algebraic_scheme.py\", line 902, in _check_satisfies_equations\n        raise TypeError, \"Coordinates %s do not define a point on %s\"%(coords,self)\n    TypeError: Coordinates [2, 2, 1] do not define a point on Hyperelliptic Curve over Finite Field of size 7 defined by y^2 = x^3 + x^2 + 6\n```",
    "created_at": "2011-09-27T19:20:17Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116314",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:63'></a>
Aside from the segfaults, with the new patches I get the following additional failurers. The failures "seem" to be associated with the patches in that I don't get them when I use Martin's patches.

amd64:

```
sage -t -long  -force_lib devel/sage-trans_16037.16051/sage/misc/sageinspect.py
sage -t -long  -force_lib devel/sage-trans_16037.16051/sage/schemes/plane_conics/con_field.py
sage -t -long  -force_lib devel/sage-trans_16037.16051/sage/schemes/hyperelliptic_curves/hyperelliptic_finite_field.py
```
x86:

```
sage -t -long  -force_lib devel/sage-trans_16037.16051/sage/misc/sageinspect.py
sage -t -long  -force_lib devel/sage-trans_16037.16051/sage/schemes/plane_conics/con_field.py
```
Here is a brief summary of the failures.

sageinspect.py (partial output given):

```
Expected:
    (['cdef class MPolynomialRing_libsingular(MPolynomialRing_generic):\n',
      "    def __init__(self, base_ring, n, names, order='degrevlex'):\n",
    ...
      '          M.append(new_MP(self, p_Copy(tempvector,_ring)))\n',
      '          return M\n'], ...)
Got:
    (['cdef class MPolynomialRing_libsingular(MPolynomialRing_generic):\n', '\n', '    def
 __cinit__(self):\n', '
```
con_field.py:

```
File "/storage/sage/sage-4.7.2.alpha2/devel/sage-trans_16037.16051/sage/schemes/plane_conics/con_field.py", line 234:
    sage: C.is_smooth()
Expected:
    True
Got:
    False
```
hyperelliptic_curves/hyperelliptic_finite_field.py:

```
File "/storage/sage/sage-4.7.2.alpha2/devel/sage-trans_16037.16051/sage/schemes/hyperelliptic_curves/hyperelliptic_finite_field.py", line 269:
    sage: set(C._points_cache_sqrt()) == set(C._points_cache_sqrt(brute_force=True))
Exception raised:
    Traceback (most recent call last):
      File "/storage/sage/sage-4.7.2.alpha2/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/storage/sage/sage-4.7.2.alpha2/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/storage/sage/sage-4.7.2.alpha2/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_5[5]>", line 1, in <module>
        set(C._points_cache_sqrt()) == set(C._points_cache_sqrt(brute_force=True))###line 269:
    sage: set(C._points_cache_sqrt()) == set(C._points_cache_sqrt(brute_force=True))
      File "/storage/sage/sage-4.7.2.alpha2/local/lib/python/site-packages/sage/schemes/hyperelliptic_curves/hyperelliptic_finite_field.py", line 296, in _points_cache_sqrt
        points.append(self.point([x, -y, one], check=True))
      File "/storage/sage/sage-4.7.2.alpha2/local/lib/python/site-packages/sage/schemes/generic/scheme.py", line 256, in point
        return self._point_class(self, v, check=check)
      File "/storage/sage/sage-4.7.2.alpha2/local/lib/python/site-packages/sage/schemes/generic/algebraic_scheme.py", line 528, in _point_class
        return self.__A._point_class(*args, **kwds)
      File "/storage/sage/sage-4.7.2.alpha2/local/lib/python/site-packages/sage/schemes/generic/projective_space.py", line 561, in _point_class
        return morphism.SchemeMorphism_projective_coordinates_field(*args, **kwds)
      File "/storage/sage/sage-4.7.2.alpha2/local/lib/python/site-packages/sage/schemes/generic/morphism.py", line 676, in __init__
        X.codomain()._check_satisfies_equations(v)
      File "/storage/sage/sage-4.7.2.alpha2/local/lib/python/site-packages/sage/schemes/generic/algebraic_scheme.py", line 902, in _check_satisfies_equations
        raise TypeError, "Coordinates %s do not define a point on %s"%(coords,self)
    TypeError: Coordinates [2, 2, 1] do not define a point on Hyperelliptic Curve over Finite Field of size 7 defined by y^2 = x^3 + x^2 + 6
```



---

archive/issue_comments_116315.json:
```json
{
    "body": "<a id='comment:64'></a>\nI have seen the error on sageinspect.py before. Did you send it to me privately? I cannot seem to find where it was mentioned in inbox or my logs. You get cython code as output while the test is expecting c++ code to be returned.",
    "created_at": "2011-09-27T21:33:15Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116315",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:64'></a>
I have seen the error on sageinspect.py before. Did you send it to me privately? I cannot seem to find where it was mentioned in inbox or my logs. You get cython code as output while the test is expecting c++ code to be returned.



---

archive/issue_comments_116316.json:
```json
{
    "body": "<a id='comment:65'></a>\nStill about sageinspect.py, this is stuff added in #11298, did you apply #11734 to your branch?\n\nMy own list of stuff that seem singular related is:\n\n```\n\tsage -t -long  -force_lib devel/sage-main/sage/crypto/mq/sr.py # Killed/crashed\n\tsage -t -long  -force_lib devel/sage-main/sage/schemes/elliptic_curves/ell_curve_isogeny.py # Killed/crashed\n\tsage -t -long  -force_lib devel/sage-main/sage/schemes/elliptic_curves/ell_generic.py # Killed/crashed\n\tsage -t -long  -force_lib devel/sage-main/sage/rings/polynomial/multi_polynomial_ideal.py # Killed/crashed\n\tsage -t -long  -force_lib devel/sage-main/sage/schemes/generic/algebraic_scheme.py # Killed/crashed\n        sage -t -long  -force_lib devel/sage-main/sage/schemes/plane_conics/con_field.py # 1 doctests failed\n```",
    "created_at": "2011-09-27T22:44:13Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116316",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:65'></a>
Still about sageinspect.py, this is stuff added in #11298, did you apply #11734 to your branch?

My own list of stuff that seem singular related is:

```
	sage -t -long  -force_lib devel/sage-main/sage/crypto/mq/sr.py # Killed/crashed
	sage -t -long  -force_lib devel/sage-main/sage/schemes/elliptic_curves/ell_curve_isogeny.py # Killed/crashed
	sage -t -long  -force_lib devel/sage-main/sage/schemes/elliptic_curves/ell_generic.py # Killed/crashed
	sage -t -long  -force_lib devel/sage-main/sage/rings/polynomial/multi_polynomial_ideal.py # Killed/crashed
	sage -t -long  -force_lib devel/sage-main/sage/schemes/generic/algebraic_scheme.py # Killed/crashed
        sage -t -long  -force_lib devel/sage-main/sage/schemes/plane_conics/con_field.py # 1 doctests failed
```



---

archive/issue_comments_116317.json:
```json
{
    "body": "<a id='comment:66'></a>\nForgot\n\n```\n\tsage -t -long  -force_lib devel/sage-main/sage/schemes/plane_conics/con_finite_field.py # Killed/crashed\n```",
    "created_at": "2011-09-27T22:44:47Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116317",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:66'></a>
Forgot

```
	sage -t -long  -force_lib devel/sage-main/sage/schemes/plane_conics/con_finite_field.py # Killed/crashed
```



---

archive/issue_comments_116318.json:
```json
{
    "body": "<a id='comment:67'></a>\nReplying to [fbissey](#comment%3A65):\n\n> Still about sageinspect.py, this is stuff added in #11298, did you apply #11734 to your branch? My own list of stuff that seem singular related is:\n\n\nNo I hadn't applied that patch to my branch. However, after doing so sageinspect.py fails the same way on both x86 and amd64. Now here on sage-on-gentoo, where #11734 has been applied, sageinspect.py fails on amd64 but passed on x86 with the new refcount patches. This probably doesn't belong with this ticket even though there appears to be some connection.",
    "created_at": "2011-09-27T23:40:19Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116318",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:67'></a>
Replying to [fbissey](#comment%3A65):

> Still about sageinspect.py, this is stuff added in #11298, did you apply #11734 to your branch? My own list of stuff that seem singular related is:


No I hadn't applied that patch to my branch. However, after doing so sageinspect.py fails the same way on both x86 and amd64. Now here on sage-on-gentoo, where #11734 has been applied, sageinspect.py fails on amd64 but passed on x86 with the new refcount patches. This probably doesn't belong with this ticket even though there appears to be some connection.



---

archive/issue_comments_116319.json:
```json
{
    "body": "<a id='comment:68'></a>\nReplying to [strogdon](#comment%3A67):\n\n> Replying to [fbissey](#comment%3A65):\n> > Still about sageinspect.py, this is stuff added in #11298, did you apply #11734 to your branch? My own list of stuff that seem singular related is:\n\n> No I hadn't applied that patch to my branch. However, after doing so sageinspect.py fails the same way on both x86 and amd64. Now here on sage-on-gentoo, where #11734 has been applied, sageinspect.py fails on amd64 but passed on x86 with the new refcount patches. This probably doesn't belong with this ticket even though there appears to be some connection.\n\nI was mistaken, sageinspect.py also fails here on x86 [sage-on-gentoo] with the new refcount patches and the patch from\u00a0#11734.",
    "created_at": "2011-09-28T00:22:53Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116319",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:68'></a>
Replying to [strogdon](#comment%3A67):

> Replying to [fbissey](#comment%3A65):
> > Still about sageinspect.py, this is stuff added in #11298, did you apply #11734 to your branch? My own list of stuff that seem singular related is:

> No I hadn't applied that patch to my branch. However, after doing so sageinspect.py fails the same way on both x86 and amd64. Now here on sage-on-gentoo, where #11734 has been applied, sageinspect.py fails on amd64 but passed on x86 with the new refcount patches. This probably doesn't belong with this ticket even though there appears to be some connection.

I was mistaken, sageinspect.py also fails here on x86 [sage-on-gentoo] with the new refcount patches and the patch from #11734.



---

archive/issue_comments_116320.json:
```json
{
    "body": "<a id='comment:69'></a>\nI pushed Volker's latest patches for 4.7.2.alpha2 only 2 hours ago, before that I had reverted to Martin's initial patch. So mistake was easy.",
    "created_at": "2011-09-28T00:34:06Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116320",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:69'></a>
I pushed Volker's latest patches for 4.7.2.alpha2 only 2 hours ago, before that I had reverted to Martin's initial patch. So mistake was easy.



---

archive/issue_comments_116321.json:
```json
{
    "body": "<a id='comment:70'></a>\nI fixed (most?) of the issues discussed here over at #10903. Unfortunately, I mixed my fixes up with the general update to Singular 3-1-4 (not yet released). In any case, the two tickets are effectively merged. My bad!",
    "created_at": "2011-09-29T14:36:56Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116321",
    "user": "https://github.com/malb"
}
```

<a id='comment:70'></a>
I fixed (most?) of the issues discussed here over at #10903. Unfortunately, I mixed my fixes up with the general update to Singular 3-1-4 (not yet released). In any case, the two tickets are effectively merged. My bad!



---

archive/issue_comments_116322.json:
```json
{
    "body": "<a id='comment:71'></a>\nPatches look good though, so I'll give this a positive review once we fixed all the bugs uncovered by them in #10902.",
    "created_at": "2011-09-29T15:11:29Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116322",
    "user": "https://github.com/malb"
}
```

<a id='comment:71'></a>
Patches look good though, so I'll give this a positive review once we fixed all the bugs uncovered by them in #10902.



---

archive/issue_comments_116323.json:
```json
{
    "body": "<a id='comment:72'></a>\nReplying to [malb](#comment%3A71):\n> Patches look good though, so I'll give this a positive review once we fixed all the bugs uncovered by them in #10902.\n\n\n#10903!",
    "created_at": "2011-09-29T15:11:51Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116323",
    "user": "https://github.com/malb"
}
```

<a id='comment:72'></a>
Replying to [malb](#comment%3A71):
> Patches look good though, so I'll give this a positive review once we fixed all the bugs uncovered by them in #10902.


#10903!



---

archive/issue_comments_116324.json:
```json
{
    "body": "<a id='comment:73'></a>\nReplying to [malb](#comment%3A72):\n\n> Replying to [malb](#comment%3A71):\n> > Patches look good though, so I'll give this a positive review once we fixed all the bugs uncovered by them in #10902.\n\n> #10903!\n\nWith the singular SPKG and the patches (both of them) from #10903 I get no segfaults for the long tests on both x86 and amd64. However, there is one test on x86 that usually takes a very long time that now fails. It may be singular-related.\n\n```\nsage -t -long  -force_lib devel/sage-singular.16054/sage/schemes/elliptic_curves/ell_rational_field.py\n  ***   Warning: new stack size = 1003360 (0.957 Mbytes).\n  ***   Warning: new stack size = 1003360 (0.957 Mbytes).\nSaturation index bound = 265\nWARNING: saturation at primes p > 97 will not be done;\npoints may be unsaturated at primes between 97 and index bound\nFailed to saturate MW basis at primes [ ]\nSaturation index bound = 265\nWARNING: saturation at primes p > 199 will not be done;\npoints may be unsaturated at primes between 199 and index bound\nFailed to saturate MW basis at primes [ ]\nSaturation index bound = 265\nWARNING: saturation at primes p > 97 will not be done;\npoints may be unsaturated at primes between 97 and index bound\nFailed to saturate MW basis at primes [ ]\nSaturation index bound = 265\nWARNING: saturation at primes p > 199 will not be done;\npoints may be unsaturated at primes between 199 and index bound\nFailed to saturate MW basis at primes [ ]\nAfter 10 attempts at enlargement, giving up!\n--points not proved 2-saturated,\n2-saturation failed!\nFailed to saturate MW basis at primes [ 2 ]\n2 After 10 attempts at enlargement, giving up!\n--points not proved 2-saturated,\n2-saturation failed!\nFailed to saturate MW basis at primes [ 2 ]\n2 **********************************************************************\nFile \"/storage/sage/sage-4.7.2.alpha2/devel/sage-singular.16054/sage/schemes/elliptic_curves/ell_rational_field.py\", line 3884:\n    sage: E1.isogeny_class(algorithm=\"sage\")\nException raised:\n    Traceback (most recent call last):\n      File \"/storage/sage/sage-4.7.2.alpha2/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/storage/sage/sage-4.7.2.alpha2/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/storage/sage/sage-4.7.2.alpha2/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_80[16]>\", line 1, in <module>\n        E1.isogeny_class(algorithm=\"sage\")###line 3884:\n    sage: E1.isogeny_class(algorithm=\"sage\")\n      File \"/storage/sage/sage-4.7.2.alpha2/local/lib/python/site-packages/sage/schemes/elliptic_curves/ell_rational_field.py\", line 3954, in isogeny_class\n        isogs = E.isogenies_prime_degree(l_list)\n      File \"/storage/sage/sage-4.7.2.alpha2/local/lib/python/site-packages/sage/schemes/elliptic_curves/ell_rational_field.py\", line 4054, in isogenies_prime_degree\n        return isogenies_sporadic_Q(self)\n      File \"/storage/sage/sage-4.7.2.alpha2/local/lib/python/site-packages/sage/schemes/elliptic_curves/ell_curve_isogeny.py\", line 4179, in isogenies_sporadic_Q\n        return isogenies_sporadic_Q(E, Integer(163))\n      File \"/storage/sage/sage-4.7.2.alpha2/local/lib/python/site-packages/sage/schemes/elliptic_curves/ell_curve_isogeny.py\", line 4162, in isogenies_sporadic_Q\n        isog = Ew.isogeny(kernel=ker, degree=l, model=\"minimal\", check=False)\n      File \"/storage/sage/sage-4.7.2.alpha2/local/lib/python/site-packages/sage/schemes/elliptic_curves/ell_field.py\", line 806, in isogeny\n        return EllipticCurveIsogeny(self, kernel, codomain, degree, model, check=check)\n      File \"/storage/sage/sage-4.7.2.alpha2/local/lib/python/site-packages/sage/schemes/elliptic_curves/ell_curve_isogeny.py\", line 914, in __init__\n        self.__init_from_kernel_polynomial(kernel, degree)\n      File \"/storage/sage/sage-4.7.2.alpha2/local/lib/python/site-packages/sage/schemes/elliptic_curves/ell_curve_isogeny.py\", line 2069, in __init_from_kernel_polynomial\n        (phi, omega, v, w, n, d) = self.__init_odd_kernel_polynomial(E, psi)\n      File \"/storage/sage/sage-4.7.2.alpha2/local/lib/python/site-packages/sage/schemes/elliptic_curves/ell_curve_isogeny.py\", line 2257, in __init_odd_kernel_polynomial\n        psi_coeffs = psi.univariate_polynomial().list()\n      File \"multi_polynomial_libsingular.pyx\", line 3369, in sage.rings.polynomial.multi_polynomial_libsingular.MPolynomial_libsingular.univariate_polynomial (sage/rings/polynomial/multi_polynomial_libsingular.cpp:22055)\n    IndexError: list assignment index out of range\n```",
    "created_at": "2011-09-29T20:28:00Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116324",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:73'></a>
Replying to [malb](#comment%3A72):

> Replying to [malb](#comment%3A71):
> > Patches look good though, so I'll give this a positive review once we fixed all the bugs uncovered by them in #10902.

> #10903!

With the singular SPKG and the patches (both of them) from #10903 I get no segfaults for the long tests on both x86 and amd64. However, there is one test on x86 that usually takes a very long time that now fails. It may be singular-related.

```
sage -t -long  -force_lib devel/sage-singular.16054/sage/schemes/elliptic_curves/ell_rational_field.py
  ***   Warning: new stack size = 1003360 (0.957 Mbytes).
  ***   Warning: new stack size = 1003360 (0.957 Mbytes).
Saturation index bound = 265
WARNING: saturation at primes p > 97 will not be done;
points may be unsaturated at primes between 97 and index bound
Failed to saturate MW basis at primes [ ]
Saturation index bound = 265
WARNING: saturation at primes p > 199 will not be done;
points may be unsaturated at primes between 199 and index bound
Failed to saturate MW basis at primes [ ]
Saturation index bound = 265
WARNING: saturation at primes p > 97 will not be done;
points may be unsaturated at primes between 97 and index bound
Failed to saturate MW basis at primes [ ]
Saturation index bound = 265
WARNING: saturation at primes p > 199 will not be done;
points may be unsaturated at primes between 199 and index bound
Failed to saturate MW basis at primes [ ]
After 10 attempts at enlargement, giving up!
--points not proved 2-saturated,
2-saturation failed!
Failed to saturate MW basis at primes [ 2 ]
2 After 10 attempts at enlargement, giving up!
--points not proved 2-saturated,
2-saturation failed!
Failed to saturate MW basis at primes [ 2 ]
2 **********************************************************************
File "/storage/sage/sage-4.7.2.alpha2/devel/sage-singular.16054/sage/schemes/elliptic_curves/ell_rational_field.py", line 3884:
    sage: E1.isogeny_class(algorithm="sage")
Exception raised:
    Traceback (most recent call last):
      File "/storage/sage/sage-4.7.2.alpha2/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/storage/sage/sage-4.7.2.alpha2/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/storage/sage/sage-4.7.2.alpha2/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_80[16]>", line 1, in <module>
        E1.isogeny_class(algorithm="sage")###line 3884:
    sage: E1.isogeny_class(algorithm="sage")
      File "/storage/sage/sage-4.7.2.alpha2/local/lib/python/site-packages/sage/schemes/elliptic_curves/ell_rational_field.py", line 3954, in isogeny_class
        isogs = E.isogenies_prime_degree(l_list)
      File "/storage/sage/sage-4.7.2.alpha2/local/lib/python/site-packages/sage/schemes/elliptic_curves/ell_rational_field.py", line 4054, in isogenies_prime_degree
        return isogenies_sporadic_Q(self)
      File "/storage/sage/sage-4.7.2.alpha2/local/lib/python/site-packages/sage/schemes/elliptic_curves/ell_curve_isogeny.py", line 4179, in isogenies_sporadic_Q
        return isogenies_sporadic_Q(E, Integer(163))
      File "/storage/sage/sage-4.7.2.alpha2/local/lib/python/site-packages/sage/schemes/elliptic_curves/ell_curve_isogeny.py", line 4162, in isogenies_sporadic_Q
        isog = Ew.isogeny(kernel=ker, degree=l, model="minimal", check=False)
      File "/storage/sage/sage-4.7.2.alpha2/local/lib/python/site-packages/sage/schemes/elliptic_curves/ell_field.py", line 806, in isogeny
        return EllipticCurveIsogeny(self, kernel, codomain, degree, model, check=check)
      File "/storage/sage/sage-4.7.2.alpha2/local/lib/python/site-packages/sage/schemes/elliptic_curves/ell_curve_isogeny.py", line 914, in __init__
        self.__init_from_kernel_polynomial(kernel, degree)
      File "/storage/sage/sage-4.7.2.alpha2/local/lib/python/site-packages/sage/schemes/elliptic_curves/ell_curve_isogeny.py", line 2069, in __init_from_kernel_polynomial
        (phi, omega, v, w, n, d) = self.__init_odd_kernel_polynomial(E, psi)
      File "/storage/sage/sage-4.7.2.alpha2/local/lib/python/site-packages/sage/schemes/elliptic_curves/ell_curve_isogeny.py", line 2257, in __init_odd_kernel_polynomial
        psi_coeffs = psi.univariate_polynomial().list()
      File "multi_polynomial_libsingular.pyx", line 3369, in sage.rings.polynomial.multi_polynomial_libsingular.MPolynomial_libsingular.univariate_polynomial (sage/rings/polynomial/multi_polynomial_libsingular.cpp:22055)
    IndexError: list assignment index out of range
```



---

archive/issue_comments_116325.json:
```json
{
    "body": "<a id='comment:74'></a>\nIt looks singular related but it doesn't immediately ring a bell. I'd guess some strategically placed `rChangeCurrRing` would fix the issue, but the problem is to find where to put it.",
    "created_at": "2011-09-29T21:09:43Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116325",
    "user": "https://github.com/malb"
}
```

<a id='comment:74'></a>
It looks singular related but it doesn't immediately ring a bell. I'd guess some strategically placed `rChangeCurrRing` would fix the issue, but the problem is to find where to put it.



---

archive/issue_comments_116326.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,9 +1,17 @@\n+# Ref counting for Singular rings\n+\n+Python makes no guarantees that destructors are called if circular references are involved. This patch implements an extra Python proxy layer that correctly refcounts Singular rings. In contrast to our earlier code, it will release the singular rings once they are no longer in use. This triggers various issues in Sage/libSingular that are dealt with in the follow-up ticket #10903\n+\n+# Historic discussion\n+\n As [described for the Sage on Gentoo project](https://github.com/cschwan/sage-on-gentoo/issues/51#issuecomment-1181259), there is a problem in how parts of sage use `__deallocate__` in their Cython code. I've actually traced an instance of [groebner_strategy.pyx](http://hg.sagemath.org/sage-main/file/361a4ad7d52c/sage/libs/singular/groebner_strategy.pyx#l134) causing segmentation faults under Python 2.7.\n \n What happens is that the garbage collector invokes the [tp_clear](http://docs.python.org/c-api/typeobj.html#tp_clear) function for the object. Its implementation is provided by Cython, and one of its effects is that every python reference will be set to `None`. A bit later on, [tp_dealloc](http://docs.python.org/c-api/typeobj.html#tp_dealloc) is called and invokes the `__deallocate__` method. By that time, `_parent` is `None`, so accessing `_parent._ring` is a bad idea, and in this case it turns out to be null.\n \n Others have had similar problems before. There are [crude workarounds](http://stackoverflow.com/questions/4501938/how-can-c-object-lifetimes-be-correctly-managed-in-cython) floating around. I guess a proper solution would be twaking cython to allow custom code in the tp_clear function. In other words, have a \"magic\" mehod `__clear__` similar to the magic `__deallocate__`. But I'll wait for comments here first, before taking this to cython upstream. Perhaps people with more experience have better solutions to offer. And I won't mind if you decide to take this to Cython devs yourselves.\n \n+# Apply\n+\n Apply:\n * [attachment:trac_11339_refcount_singular_rings.patch]\n * [attachment:trac_11339_refcount_singular_polynomials.patch]\n``````\n",
    "created_at": "2011-10-01T21:34:09Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116326",
    "user": "https://github.com/vbraun"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,9 +1,17 @@
+# Ref counting for Singular rings
+
+Python makes no guarantees that destructors are called if circular references are involved. This patch implements an extra Python proxy layer that correctly refcounts Singular rings. In contrast to our earlier code, it will release the singular rings once they are no longer in use. This triggers various issues in Sage/libSingular that are dealt with in the follow-up ticket #10903
+
+# Historic discussion
+
 As [described for the Sage on Gentoo project](https://github.com/cschwan/sage-on-gentoo/issues/51#issuecomment-1181259), there is a problem in how parts of sage use `__deallocate__` in their Cython code. I've actually traced an instance of [groebner_strategy.pyx](http://hg.sagemath.org/sage-main/file/361a4ad7d52c/sage/libs/singular/groebner_strategy.pyx#l134) causing segmentation faults under Python 2.7.
 
 What happens is that the garbage collector invokes the [tp_clear](http://docs.python.org/c-api/typeobj.html#tp_clear) function for the object. Its implementation is provided by Cython, and one of its effects is that every python reference will be set to `None`. A bit later on, [tp_dealloc](http://docs.python.org/c-api/typeobj.html#tp_dealloc) is called and invokes the `__deallocate__` method. By that time, `_parent` is `None`, so accessing `_parent._ring` is a bad idea, and in this case it turns out to be null.
 
 Others have had similar problems before. There are [crude workarounds](http://stackoverflow.com/questions/4501938/how-can-c-object-lifetimes-be-correctly-managed-in-cython) floating around. I guess a proper solution would be twaking cython to allow custom code in the tp_clear function. In other words, have a "magic" mehod `__clear__` similar to the magic `__deallocate__`. But I'll wait for comments here first, before taking this to cython upstream. Perhaps people with more experience have better solutions to offer. And I won't mind if you decide to take this to Cython devs yourselves.
 
+# Apply
+
 Apply:
 * [attachment:trac_11339_refcount_singular_rings.patch]
 * [attachment:trac_11339_refcount_singular_polynomials.patch]
``````




---

archive/issue_events_089086.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-10-01T21:34:09Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "rename": {
        "from": "Illegal use of __deallocate__ in cython (pyx) code",
        "to": "Refcounting for Cython rings"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89086"
}
```



---

archive/issue_events_089087.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-10-01T21:34:09Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89087"
}
```



---

archive/issue_events_089088.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-10-01T21:34:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89088"
}
```



---

archive/issue_comments_116327.json:
```json
{
    "body": "<a id='comment:75'></a>\nI am setting this bug to Needs Review. The two patches here will correctly refcount the Singular rings, and the reviewer should focus on that aspect. They also make Sage crash because of issues in the libSingular interface. The latter will be dealt with in #10903. Please report any crashes in Sage on #10903, and not here.",
    "created_at": "2011-10-01T21:34:09Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116327",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:75'></a>
I am setting this bug to Needs Review. The two patches here will correctly refcount the Singular rings, and the reviewer should focus on that aspect. They also make Sage crash because of issues in the libSingular interface. The latter will be dealt with in #10903. Please report any crashes in Sage on #10903, and not here.



---

archive/issue_events_089089.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-10-01T21:34:55Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "rename": {
        "from": "Refcounting for Cython rings",
        "to": "Refcounting for Singular rings"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89089"
}
```



---

archive/issue_comments_116328.json:
```json
{
    "body": "**Changing reviewer** from \"Fran\u00e7ois Bissey, Steven Trogdon\" to \"Fran\u00e7ois Bissey, Steven Trogdon, Martin Albrecht\".",
    "created_at": "2011-10-03T14:49:48Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116328",
    "user": "https://github.com/malb"
}
```

**Changing reviewer** from "François Bissey, Steven Trogdon" to "François Bissey, Steven Trogdon, Martin Albrecht".



---

archive/issue_events_089090.json:
```json
{
    "actor": "https://github.com/malb",
    "created_at": "2011-10-03T14:49:48Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89090"
}
```



---

archive/issue_events_089091.json:
```json
{
    "actor": "https://github.com/malb",
    "created_at": "2011-10-03T14:49:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89091"
}
```



---

archive/issue_comments_116329.json:
```json
{
    "body": "<a id='comment:77'></a>\nI read the patch and we're reasonably certain we caught all bugs these patches uncovered (not introduced!), so: positive review.",
    "created_at": "2011-10-03T14:49:48Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116329",
    "user": "https://github.com/malb"
}
```

<a id='comment:77'></a>
I read the patch and we're reasonably certain we caught all bugs these patches uncovered (not introduced!), so: positive review.



---

archive/issue_events_089092.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-10-04T08:50:54Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89092"
}
```



---

archive/issue_events_089093.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-10-04T08:50:54Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89093"
}
```



---

archive/issue_comments_116330.json:
```json
{
    "body": "<a id='comment:78'></a>\nThis seems to conflict with #11856.",
    "created_at": "2011-10-04T08:50:54Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116330",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:78'></a>
This seems to conflict with #11856.



---

archive/issue_comments_116331.json:
```json
{
    "body": "**Changing work_issues** from \"Rebase on Sage 4.7.2.alpha2.\" to \"Conflict with #11856\".",
    "created_at": "2011-10-04T08:50:54Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116331",
    "user": "https://github.com/jdemeyer"
}
```

**Changing work_issues** from "Rebase on Sage 4.7.2.alpha2." to "Conflict with #11856".



---

archive/issue_events_089094.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2011-10-04T08:59:21Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89094"
}
```



---

archive/issue_events_089095.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2011-10-04T08:59:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89095"
}
```



---

archive/issue_comments_116332.json:
```json
{
    "body": "<a id='comment:79'></a>\nIt seems that it will be easier to rebase my patch from #11892. So, I reinstate the positive review and will change #11892.",
    "created_at": "2011-10-04T08:59:21Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116332",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:79'></a>
It seems that it will be easier to rebase my patch from #11892. So, I reinstate the positive review and will change #11892.



---

archive/issue_comments_116333.json:
```json
{
    "body": "<a id='comment:80'></a>\nReplying to [SimonKing](#comment%3A79):\n> It seems that it will be easier to rebase my patch from #11892. So, I reinstate the positive review and will change #11892.\n\n\nSorry, I meant to change #11856...",
    "created_at": "2011-10-04T08:59:55Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116333",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:80'></a>
Replying to [SimonKing](#comment%3A79):
> It seems that it will be easier to rebase my patch from #11892. So, I reinstate the positive review and will change #11892.


Sorry, I meant to change #11856...



---

archive/issue_comments_116334.json:
```json
{
    "body": "**Changing work_issues** from \"Conflict with #11856\" to \"\".",
    "created_at": "2011-10-04T09:12:58Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116334",
    "user": "https://github.com/jdemeyer"
}
```

**Changing work_issues** from "Conflict with #11856" to "".



---

archive/issue_comments_116335.json:
```json
{
    "body": "<a id='comment:82'></a>\nFor the record: The conflicts with #11856 and also another conflict with #11068 were caused by cosmetic changes introduced by the first patch. Both are resolved now.",
    "created_at": "2011-10-04T09:24:15Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116335",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:82'></a>
For the record: The conflicts with #11856 and also another conflict with #11068 were caused by cosmetic changes introduced by the first patch. Both are resolved now.



---

archive/issue_comments_116336.json:
```json
{
    "body": "<a id='comment:83'></a>\nIt is amazing how many patches of mine fail for trivial reasons because of this ticket. E.g., introspection: One of my examples for introspection of code fails, because `__cinint__` was introduced. So, in addition to #11856 and #11068, I'll have to change at least a third patch as well.",
    "created_at": "2011-10-04T11:32:14Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116336",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:83'></a>
It is amazing how many patches of mine fail for trivial reasons because of this ticket. E.g., introspection: One of my examples for introspection of code fails, because `__cinint__` was introduced. So, in addition to #11856 and #11068, I'll have to change at least a third patch as well.



---

archive/issue_comments_116337.json:
```json
{
    "body": "<a id='comment:84'></a>\nYou should run the tests with your patches applied on top of sage-4.7.2.alpha3. At least with the alpha3-prerelease, I get some doctest errors, for example `sage -t  \"devel/sage-main/sage/misc/sageinspect.py\"`.\n\nSo, it seems it would have been better to change this patch, not #11856 and #11068. Too bad.",
    "created_at": "2011-10-04T11:47:57Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116337",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:84'></a>
You should run the tests with your patches applied on top of sage-4.7.2.alpha3. At least with the alpha3-prerelease, I get some doctest errors, for example `sage -t  "devel/sage-main/sage/misc/sageinspect.py"`.

So, it seems it would have been better to change this patch, not #11856 and #11068. Too bad.



---

archive/issue_events_089096.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2011-10-04T11:47:57Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89096"
}
```



---

archive/issue_events_089097.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2011-10-04T11:47:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89097"
}
```



---

archive/issue_comments_116338.json:
```json
{
    "body": "<a id='comment:85'></a>\nThe doctest failure in sage/misc/sageinspect (would have been nice if it would have used its own module as a doctest example btw) is fixed in #10903. There are no doctest failures if you use sage-4.7.2.alpha3 + #11339 + #10903. Really the two tickets should be one but thats not how it panned out historically.",
    "created_at": "2011-10-04T12:35:24Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116338",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:85'></a>
The doctest failure in sage/misc/sageinspect (would have been nice if it would have used its own module as a doctest example btw) is fixed in #10903. There are no doctest failures if you use sage-4.7.2.alpha3 + #11339 + #10903. Really the two tickets should be one but thats not how it panned out historically.



---

archive/issue_events_089098.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-10-04T12:35:24Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89098"
}
```



---

archive/issue_events_089099.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-10-04T12:35:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89099"
}
```



---

archive/issue_comments_116339.json:
```json
{
    "body": "<a id='comment:86'></a>\nReplying to [vbraun](#comment%3A85):\n> The doctest failure in sage/misc/sageinspect (would have been nice if it would have used its own module as a doctest example btw) is fixed in #10903. There are no doctest failures if you use sage-4.7.2.alpha3 + #11339 + #10903. Really the two tickets should be one but thats not how it panned out historically.\n\n\nSo we have a cyclic dependency now... \n\nSomehow matches the ticket's title.",
    "created_at": "2011-10-04T12:40:49Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116339",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:86'></a>
Replying to [vbraun](#comment%3A85):
> The doctest failure in sage/misc/sageinspect (would have been nice if it would have used its own module as a doctest example btw) is fixed in #10903. There are no doctest failures if you use sage-4.7.2.alpha3 + #11339 + #10903. Really the two tickets should be one but thats not how it panned out historically.


So we have a cyclic dependency now... 

Somehow matches the ticket's title.



---

archive/issue_comments_116340.json:
```json
{
    "body": "<a id='comment:87'></a>\nQuestion to the release manager: How are the odds that both #11339/#10903 and #11856 (which both fix critical bugs) will be merged into sage-4.7.2? \n\nIf #11339/#10903 are ready to be merged then I guess one can easily modify #11856 so that it matches (it is just a different line break in one hunk). And #11068 was shifted to sage-4.7.3 anyway, so, it can wait.",
    "created_at": "2011-10-04T12:45:06Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116340",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:87'></a>
Question to the release manager: How are the odds that both #11339/#10903 and #11856 (which both fix critical bugs) will be merged into sage-4.7.2? 

If #11339/#10903 are ready to be merged then I guess one can easily modify #11856 so that it matches (it is just a different line break in one hunk). And #11068 was shifted to sage-4.7.3 anyway, so, it can wait.



---

archive/issue_comments_116341.json:
```json
{
    "body": "<a id='comment:88'></a>\nReplying to [vbraun](#comment%3A85):\n> The doctest failure in sage/misc/sageinspect (would have been nice if it would have used its own module as a doctest example btw) ...\n\n\nThe point was to have a cdef class, but sageinspect is pure Python, so it wouldn't have been a good example.",
    "created_at": "2011-10-04T12:47:20Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116341",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:88'></a>
Replying to [vbraun](#comment%3A85):
> The doctest failure in sage/misc/sageinspect (would have been nice if it would have used its own module as a doctest example btw) ...


The point was to have a cdef class, but sageinspect is pure Python, so it wouldn't have been a good example.



---

archive/issue_comments_116342.json:
```json
{
    "body": "<a id='comment:89'></a>\nJeroen said that Singular will go into sage-4.7.2 on sage-release. This should be #11339 + #10903 + #11856, preferably in that order.",
    "created_at": "2011-10-04T12:55:36Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116342",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:89'></a>
Jeroen said that Singular will go into sage-4.7.2 on sage-release. This should be #11339 + #10903 + #11856, preferably in that order.



---

archive/issue_comments_116343.json:
```json
{
    "body": "<a id='comment:90'></a>\nReplying to [vbraun](#comment%3A89):\n> Jeroen said that Singular will go into sage-4.7.2 on sage-release. This should be #11339 + #10903 + #11856, preferably in that order. \n\n\nExactly.  Just make sure you clearly state the order in which patches have to be applied.  The \"cyclic\" dependency is not really a problem as these tickets will be merged together anyway.",
    "created_at": "2011-10-04T12:57:45Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116343",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:90'></a>
Replying to [vbraun](#comment%3A89):
> Jeroen said that Singular will go into sage-4.7.2 on sage-release. This should be #11339 + #10903 + #11856, preferably in that order. 


Exactly.  Just make sure you clearly state the order in which patches have to be applied.  The "cyclic" dependency is not really a problem as these tickets will be merged together anyway.



---

archive/issue_comments_116344.json:
```json
{
    "body": "<a id='comment:91'></a>\nReplying to [jdemeyer](#comment%3A90):\n> The \"cyclic\" dependency is not really a problem as these tickets will be merged together anyway.\n\n\nI'll implement merging strongly connected components... ;-)",
    "created_at": "2011-10-04T13:04:53Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116344",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:91'></a>
Replying to [jdemeyer](#comment%3A90):
> The "cyclic" dependency is not really a problem as these tickets will be merged together anyway.


I'll implement merging strongly connected components... ;-)



---

archive/issue_events_089100.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2011-10-04T13:09:51Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89100"
}
```



---

archive/issue_events_089101.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2011-10-04T13:09:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89101"
}
```



---

archive/issue_comments_116345.json:
```json
{
    "body": "<a id='comment:92'></a>\nGreat, #11339 together with #10903 really seem to fix it. So, let it be a positive review, then. I will rebase #11856 now, and #11068 can wait a little.",
    "created_at": "2011-10-04T13:09:51Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116345",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:92'></a>
Great, #11339 together with #10903 really seem to fix it. So, let it be a positive review, then. I will rebase #11856 now, and #11068 can wait a little.



---

archive/issue_comments_116346.json:
```json
{
    "body": "<a id='comment:93'></a>\nFor the record: I made #11856 depend on #10903. So, it should all be good now...",
    "created_at": "2011-10-04T13:17:33Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116346",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:93'></a>
For the record: I made #11856 depend on #10903. So, it should all be good now...



---

archive/issue_comments_116347.json:
```json
{
    "body": "**Dependencies:** #10903 (for doctests)",
    "created_at": "2011-10-04T21:14:52Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116347",
    "user": "https://github.com/jdemeyer"
}
```

**Dependencies:** #10903 (for doctests)



---

archive/issue_events_089102.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-10-07T19:11:39Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89102"
}
```



---

archive/issue_events_089103.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-10-07T19:11:39Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11339#event-89103"
}
```



---

archive/issue_comments_116348.json:
```json
{
    "body": "**Merged:** sage-4.7.2.alpha4",
    "created_at": "2011-10-07T19:11:39Z",
    "issue": "https://github.com/sagemath/sage/issues/11339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11339#issuecomment-116348",
    "user": "https://github.com/jdemeyer"
}
```

**Merged:** sage-4.7.2.alpha4
