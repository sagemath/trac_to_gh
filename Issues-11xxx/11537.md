# Issue 11537: units in polynomial rings with prime power characteristic

archive/issues_011365.json:
```json
{
    "body": "```\nsage: p = 101\nsage: S.<t> = PolynomialRing(ZZ.quotient_ring(p^3))\nsage: f = 1+p*t^2\nsage: f.is_unit()\nTrue\n```\n\n```\nsage: S.<t> = PolynomialRing(ZZ.quotient_ring(p^3),1)\nsage: t = S.0\nsage: f = 1+p*t^2\nsage: f.is_unit()\nFalse\nsage: f.inverse_of_unit()\n...\nArithmeticError: Element is not a unit.\n```\n\n```\nsage: S1.<t> = PolynomialRing(ZZ.quotient_ring(p^3),1)\nsage: S2.<tt> = PolynomialRing(ZZ.quotient_ring(p^3))\nsage: S1\nMultivariate Polynomial Ring in t over Ring of integers modulo 1030301\nsage: S2\nUnivariate Polynomial Ring in tt over Ring of integers modulo 1030301\nsage: S1 == S2\nFalse\n```\n\n\nAssignee: @aghitza\n\nStopgaps: todo\n\nAuthor: Mark Saaltink\n\nBranch: u/vdelecroix/11537\n\nStatus: needs_work\n\nDependencies: #22454\n\nCommit: 718b0e2c0526e6000f1608ddfc2853f0c4bd19c0\n\nIssue created by migration from https://trac.sagemath.org/ticket/11537\n\n",
    "created_at": "2011-06-23T19:38:16Z",
    "labels": [
        "component: algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "units in polynomial rings with prime power characteristic",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11537",
    "user": "https://github.com/tdupu"
}
```
```
sage: p = 101
sage: S.<t> = PolynomialRing(ZZ.quotient_ring(p^3))
sage: f = 1+p*t^2
sage: f.is_unit()
True
```

```
sage: S.<t> = PolynomialRing(ZZ.quotient_ring(p^3),1)
sage: t = S.0
sage: f = 1+p*t^2
sage: f.is_unit()
False
sage: f.inverse_of_unit()
...
ArithmeticError: Element is not a unit.
```

```
sage: S1.<t> = PolynomialRing(ZZ.quotient_ring(p^3),1)
sage: S2.<tt> = PolynomialRing(ZZ.quotient_ring(p^3))
sage: S1
Multivariate Polynomial Ring in t over Ring of integers modulo 1030301
sage: S2
Univariate Polynomial Ring in tt over Ring of integers modulo 1030301
sage: S1 == S2
False
```


Assignee: @aghitza

Stopgaps: todo

Author: Mark Saaltink

Branch: u/vdelecroix/11537

Status: needs_work

Dependencies: #22454

Commit: 718b0e2c0526e6000f1608ddfc2853f0c4bd19c0

Issue created by migration from https://trac.sagemath.org/ticket/11537





---

archive/issue_comments_125715.json:
```json
{
    "body": "Attachment [units_mod_p.sws](tarball://root/attachments/some-uuid/ticket11537/units_mod_p.sws) by @tdupu created at 2011-06-23 19:38:39",
    "created_at": "2011-06-23T19:38:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125715",
    "user": "https://github.com/tdupu"
}
```

Attachment [units_mod_p.sws](tarball://root/attachments/some-uuid/ticket11537/units_mod_p.sws) by @tdupu created at 2011-06-23 19:38:39



---

archive/issue_comments_125716.json:
```json
{
    "body": "<a id='comment:1'></a>--There are lots of \"inverse_of_unit\" methods one should implement while they are fixing this the attached notebook shows one way this can be done from prime power characteristic.",
    "created_at": "2011-06-23T19:42:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125716",
    "user": "https://github.com/tdupu"
}
```

<a id='comment:1'></a>--There are lots of "inverse_of_unit" methods one should implement while they are fixing this the attached notebook shows one way this can be done from prime power characteristic.



---

archive/issue_events_030157.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11537#event-30157"
}
```



---

archive/issue_events_030158.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11537#event-30158"
}
```



---

archive/issue_events_030159.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11537#event-30159"
}
```



---

archive/issue_events_030160.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11537#event-30160"
}
```



---

archive/issue_events_030161.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11537#event-30161"
}
```



---

archive/issue_events_030162.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11537#event-30162"
}
```



---

archive/issue_events_030163.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11537#event-30163"
}
```



---

archive/issue_comments_125717.json:
```json
{
    "body": "<a id='comment:8'></a>New commits:",
    "created_at": "2017-03-06T16:51:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125717",
    "user": "https://trac.sagemath.org/admin/accounts/users/msaaltink"
}
```

<a id='comment:8'></a>New commits:



---

archive/issue_comments_125718.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-03-06T16:51:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125718",
    "user": "https://trac.sagemath.org/admin/accounts/users/msaaltink"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_125719.json:
```json
{
    "body": "<a id='comment:9'></a>-1 on removing the specialized code that uses Singular; at least I strongly suspect that is faster. You should be able to specify quickly in which cases you should punt up to the generic code. Also, don't use `$x$` for latex, instead use ``x``.",
    "created_at": "2017-03-07T17:35:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125719",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:9'></a>-1 on removing the specialized code that uses Singular; at least I strongly suspect that is faster. You should be able to specify quickly in which cases you should punt up to the generic code. Also, don't use `$x$` for latex, instead use ``x``.



---

archive/issue_comments_125720.json:
```json
{
    "body": "<a id='comment:10'></a>Re: \"-1 on removing the specialized code that uses Singular\":   Yes, it is fast, but does not get the correct answers.  The same goes for libsingular's p_IsUnit. For some reason I am having trouble finding the documentation in libsingular that explains these two functions so do not know if they are even supposed to work in these non-integral domains.  I think the safest thing for now is to use the generic code to get the correct answer.\n\nI'll look into the latex issue and push something soon.",
    "created_at": "2017-03-07T20:39:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125720",
    "user": "https://trac.sagemath.org/admin/accounts/users/msaaltink"
}
```

<a id='comment:10'></a>Re: "-1 on removing the specialized code that uses Singular":   Yes, it is fast, but does not get the correct answers.  The same goes for libsingular's p_IsUnit. For some reason I am having trouble finding the documentation in libsingular that explains these two functions so do not know if they are even supposed to work in these non-integral domains.  I think the safest thing for now is to use the generic code to get the correct answer.

I'll look into the latex issue and push something soon.



---

archive/issue_comments_125721.json:
```json
{
    "body": "<a id='comment:11'></a>As I said, I would probably send it up to the generic case when the base ring is not something nice. Probably a good condition is if the domain is known to be an integral domain, then use the specialized code. You should also post a bug report to Singular if using this in general is expected to work (provided you can find such information).",
    "created_at": "2017-03-07T21:07:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125721",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:11'></a>As I said, I would probably send it up to the generic case when the base ring is not something nice. Probably a good condition is if the domain is known to be an integral domain, then use the specialized code. You should also post a bug report to Singular if using this in general is expected to work (provided you can find such information).



---

archive/issue_comments_125722.json:
```json
{
    "body": "<a id='comment:12'></a>I asked about the Singular functions used here, in the Singular forum, post 2582 (https://www.singular.uni-kl.de/forum/viewtopic.php?f=10&t=2582).  The answer (from \"hannes\") is quite clear:\n\n```\np_Invers: is only a helper routine for the 3-argument forms of jet [...]\nIt should not be used otherwise: is a static routine in newer releases\nFurthermore, the coefficients must be from a field.\n\np_IsUnit: is currently only used to simplify ideals,\nand currently defined as: p is a constant polynomial and the constant is a unit.\nI will try to extend that.....but it is of low priority.\n```\n\nSo I think the specialized code in multi_polynomial_libsingular canniot be relied on, and we should stick with the generic code.  The Singular documentation offers no other functions that look useful here.",
    "created_at": "2017-03-10T01:48:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125722",
    "user": "https://trac.sagemath.org/admin/accounts/users/msaaltink"
}
```

<a id='comment:12'></a>I asked about the Singular functions used here, in the Singular forum, post 2582 (https://www.singular.uni-kl.de/forum/viewtopic.php?f=10&t=2582).  The answer (from "hannes") is quite clear:

```
p_Invers: is only a helper routine for the 3-argument forms of jet [...]
It should not be used otherwise: is a static routine in newer releases
Furthermore, the coefficients must be from a field.

p_IsUnit: is currently only used to simplify ideals,
and currently defined as: p is a constant polynomial and the constant is a unit.
I will try to extend that.....but it is of low priority.
```

So I think the specialized code in multi_polynomial_libsingular canniot be relied on, and we should stick with the generic code.  The Singular documentation offers no other functions that look useful here.



---

archive/issue_comments_125723.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-03-10T03:39:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125723",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_125724.json:
```json
{
    "body": "<a id='comment:14'></a>I have made the change from $x$ to `x` in the above commit.  This makes the documentation look better in the interactive console, which is not something I knew after reading the developer guide's section on Latex (http://doc.sagemath.org/html/en/developer/coding_basics.html#section-latex-typeset).",
    "created_at": "2017-03-11T21:14:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125724",
    "user": "https://trac.sagemath.org/admin/accounts/users/msaaltink"
}
```

<a id='comment:14'></a>I have made the change from $x$ to `x` in the above commit.  This makes the documentation look better in the interactive console, which is not something I knew after reading the developer guide's section on Latex (http://doc.sagemath.org/html/en/developer/coding_basics.html#section-latex-typeset).



---

archive/issue_comments_125725.json:
```json
{
    "body": "<a id='comment:15'></a>branch does not apply on latest beta",
    "created_at": "2017-05-21T20:00:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125725",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:15'></a>branch does not apply on latest beta



---

archive/issue_comments_125726.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-05-21T20:00:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125726",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_125727.json:
```json
{
    "body": "<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-22T15:23:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125727",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_125728.json:
```json
{
    "body": "<a id='comment:17'></a>Merged in the latest 'develop' branch, as suggested in the \"advanced git\" section of the developer guide for this situation.  I would have thought a rebase would be easier.",
    "created_at": "2017-05-22T15:27:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125728",
    "user": "https://trac.sagemath.org/admin/accounts/users/msaaltink"
}
```

<a id='comment:17'></a>Merged in the latest 'develop' branch, as suggested in the "advanced git" section of the developer guide for this situation.  I would have thought a rebase would be easier.



---

archive/issue_comments_125729.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-05-22T15:27:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125729",
    "user": "https://trac.sagemath.org/admin/accounts/users/msaaltink"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_125730.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-22T16:17:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125730",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_125731.json:
```json
{
    "body": "<a id='comment:19'></a>1) Because it is private, the function `_inverse_of_unit_polynomial` and its documentation will not appear in the reference manual. I would prefer to have it public and have pointers from the various methods (via `:func:XXX`) to this function. These are implementation details but which might be of importance for advanced users. The algorithm in only explained in the function.\n\n2) Wouldn't be easy to fix the following?\n\n```\nsage: R(5).inverse_of_unit()\nTraceback (most recent call last):\n...\nAttributeError: <class 'sage.rings.polynomial.infinite_polynomial_element.InfinitePolynomial_sparse'>\nhas no attribute constant_coefficient\n```\n\n3) As far as I understand, singular call works in some cases. If this is the case, you would better keep it. You can easily make something like the following that is also done in other places in Sage\n\n```\n    def inverse_of_unit(self, algorithm=None):\n        if algorithm is None:\n             ... set algorithm to what is best ...\n\n        if algorithm == 'singular':\n             if self.base_ring().is_not_appropriate():\n                 raise ValueError('does not work')\n              ... singular imple ...\n         elif algorithm == 'generic':\n             ... what is provide in the branch ...\n         else:\n             raise ValueError('unknown algorithm %s' %algorithm)\n```",
    "created_at": "2017-05-22T17:55:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125731",
    "user": "https://github.com/videlec"
}
```

<a id='comment:19'></a>1) Because it is private, the function `_inverse_of_unit_polynomial` and its documentation will not appear in the reference manual. I would prefer to have it public and have pointers from the various methods (via `:func:XXX`) to this function. These are implementation details but which might be of importance for advanced users. The algorithm in only explained in the function.

2) Wouldn't be easy to fix the following?

```
sage: R(5).inverse_of_unit()
Traceback (most recent call last):
...
AttributeError: <class 'sage.rings.polynomial.infinite_polynomial_element.InfinitePolynomial_sparse'>
has no attribute constant_coefficient
```

3) As far as I understand, singular call works in some cases. If this is the case, you would better keep it. You can easily make something like the following that is also done in other places in Sage

```
    def inverse_of_unit(self, algorithm=None):
        if algorithm is None:
             ... set algorithm to what is best ...

        if algorithm == 'singular':
             if self.base_ring().is_not_appropriate():
                 raise ValueError('does not work')
              ... singular imple ...
         elif algorithm == 'generic':
             ... what is provide in the branch ...
         else:
             raise ValueError('unknown algorithm %s' %algorithm)
```



---

archive/issue_comments_125732.json:
```json
{
    "body": "<a id='comment:20'></a>1) Good idea; I'll make those changes.\n\n2) The fix is not as easy as I had hoped.  I have a branch open on ticket 22514 to fix this, but the way these constant infinite polynomials get created is hard to pin down---there are strange coercion things happening.  I'll get back at it and hope to have a fix soon.\n\n3) The singular call works only when the polynomial is constant, so that all we do is invert the constant coefficient in the base ring.  I don't see this as worth going to singular for.",
    "created_at": "2017-05-23T02:38:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125732",
    "user": "https://trac.sagemath.org/admin/accounts/users/msaaltink"
}
```

<a id='comment:20'></a>1) Good idea; I'll make those changes.

2) The fix is not as easy as I had hoped.  I have a branch open on ticket 22514 to fix this, but the way these constant infinite polynomials get created is hard to pin down---there are strange coercion things happening.  I'll get back at it and hope to have a fix soon.

3) The singular call works only when the polynomial is constant, so that all we do is invert the constant coefficient in the base ring.  I don't see this as worth going to singular for.



---

archive/issue_comments_125733.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [comment:20 msaaltink]:\n> 3) The singular call works only when the polynomial is constant, so that all we do is invert the constant coefficient in the base ring. I don't see this as worth going to singular for.\n\n\nIndeed. So if Singular is that bad, remove the code. Do not put comments everywhere. You can keep a line or two of explanations\n\n```\n# Singular seems not able to invert non-constant polynomial.\n# We use the generic function created in trac ticket #11537\n```",
    "created_at": "2017-05-23T06:33:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125733",
    "user": "https://github.com/videlec"
}
```

<a id='comment:21'></a>Replying to [comment:20 msaaltink]:
> 3) The singular call works only when the polynomial is constant, so that all we do is invert the constant coefficient in the base ring. I don't see this as worth going to singular for.


Indeed. So if Singular is that bad, remove the code. Do not put comments everywhere. You can keep a line or two of explanations

```
# Singular seems not able to invert non-constant polynomial.
# We use the generic function created in trac ticket #11537
```



---

archive/issue_comments_125734.json:
```json
{
    "body": "<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-24T00:10:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125734",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_125735.json:
```json
{
    "body": "<a id='comment:23'></a>4) Could you add some checks that the parent is indeed correct, e.g.\n\n```\nsage: R.<x> = Zmod(32)[]\nsage: inverse_of_unit_polynomial(1 + 4*x)\n16*x^2 + 28*x + 1\nsage: inverse_of_unit_polynomial(1 + 4*x) is R\nTrue\n```\n\n5) I do not see where the following error is tested\n\n```\nexcept AttributeError:\n    v =  ~u # many rings don't implement inverse_of_unit\n    if v.parent() is not p.base_ring():\n        raise NotImplementedError\n```\n\n6) In order to avoid coercion, it would be better to define `mp1 = m + 1` and use it in the loop. In the same veine, change `while p*i != 1` to `while not (p * i).is_one()`",
    "created_at": "2017-06-01T18:49:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125735",
    "user": "https://github.com/videlec"
}
```

<a id='comment:23'></a>4) Could you add some checks that the parent is indeed correct, e.g.

```
sage: R.<x> = Zmod(32)[]
sage: inverse_of_unit_polynomial(1 + 4*x)
16*x^2 + 28*x + 1
sage: inverse_of_unit_polynomial(1 + 4*x) is R
True
```

5) I do not see where the following error is tested

```
except AttributeError:
    v =  ~u # many rings don't implement inverse_of_unit
    if v.parent() is not p.base_ring():
        raise NotImplementedError
```

6) In order to avoid coercion, it would be better to define `mp1 = m + 1` and use it in the loop. In the same veine, change `while p*i != 1` to `while not (p * i).is_one()`



---

archive/issue_comments_125736.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-06-01T18:49:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125736",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_events_030164.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2017-06-01T18:49:23Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11537#event-30164"
}
```



---

archive/issue_events_030165.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2017-06-01T18:49:23Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "milestone": "sage-8.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11537#event-30165"
}
```



---

archive/issue_comments_125737.json:
```json
{
    "body": "<a id='comment:24'></a>4) Do you mean that I should add a run-time check of some sort, or did you mean I should add an EXAMPLE or TEST?\n\n5) In context, that code is\n\n```\n    try:\n        v = u.inverse_of_unit()\n    except AttributeError:\n        v =  ~u # many rings don't implement inverse_of_unit\n```\nPerhaps the comment is misplaced; the except block is executed in cases where `v = u.inverse_of_unit()` is not implemented - which is for many rings.  Perhaps I should also check for `NotImplementedError`.   The fallback is to use `~v` if it is in the correct ring---sometimes it is in the fraction field.  I will try clarifying the comment.\n\n6. Good idea; I'll do that.",
    "created_at": "2017-06-02T16:51:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125737",
    "user": "https://trac.sagemath.org/admin/accounts/users/msaaltink"
}
```

<a id='comment:24'></a>4) Do you mean that I should add a run-time check of some sort, or did you mean I should add an EXAMPLE or TEST?

5) In context, that code is

```
    try:
        v = u.inverse_of_unit()
    except AttributeError:
        v =  ~u # many rings don't implement inverse_of_unit
```
Perhaps the comment is misplaced; the except block is executed in cases where `v = u.inverse_of_unit()` is not implemented - which is for many rings.  Perhaps I should also check for `NotImplementedError`.   The fallback is to use `~v` if it is in the correct ring---sometimes it is in the fraction field.  I will try clarifying the comment.

6. Good idea; I'll do that.



---

archive/issue_comments_125738.json:
```json
{
    "body": "<a id='comment:25'></a>Replying to [comment:24 msaaltink]:\n> 4) Do you mean that I should add a run-time check of some sort, or did you mean I should add an EXAMPLE or TEST?\n\n\nNot at runtime. Only inside `EXAMPLES` or/and `TESTS` (but it can still be rather exhaustive).\n\n> 5) In context, that code is\n> \n> ```\n>     try:\n>         v = u.inverse_of_unit()\n>     except AttributeError:\n>         v =  ~u # many rings don't implement inverse_of_unit\n> ```\n> Perhaps the comment is misplaced; the except block is executed in cases where `v = u.inverse_of_unit()` is not implemented - which is for many rings.  Perhaps I should also check for `NotImplementedError`.   The fallback is to use `~v` if it is in the correct ring---sometimes it is in the fraction field.  I will try clarifying the comment.\n\n\nIt was not my point. My comment was about the two lines\n\n```\n    if v.parent() is not p.base_ring():\n        raise NotImplementedError\n```\nThis `NotImplementedError` does not appear in doctests.",
    "created_at": "2017-06-02T16:57:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125738",
    "user": "https://github.com/videlec"
}
```

<a id='comment:25'></a>Replying to [comment:24 msaaltink]:
> 4) Do you mean that I should add a run-time check of some sort, or did you mean I should add an EXAMPLE or TEST?


Not at runtime. Only inside `EXAMPLES` or/and `TESTS` (but it can still be rather exhaustive).

> 5) In context, that code is
> 
> ```
>     try:
>         v = u.inverse_of_unit()
>     except AttributeError:
>         v =  ~u # many rings don't implement inverse_of_unit
> ```
> Perhaps the comment is misplaced; the except block is executed in cases where `v = u.inverse_of_unit()` is not implemented - which is for many rings.  Perhaps I should also check for `NotImplementedError`.   The fallback is to use `~v` if it is in the correct ring---sometimes it is in the fraction field.  I will try clarifying the comment.


It was not my point. My comment was about the two lines

```
    if v.parent() is not p.base_ring():
        raise NotImplementedError
```
This `NotImplementedError` does not appear in doctests.



---

archive/issue_comments_125739.json:
```json
{
    "body": "<a id='comment:26'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-06-23T16:40:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125739",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:26'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_125740.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-06-23T16:45:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125740",
    "user": "https://trac.sagemath.org/admin/accounts/users/msaaltink"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_125741.json:
```json
{
    "body": "<a id='comment:27'></a>The last set of comments have been addressed in this latest commit:\n\n4) has been done, with 3 more test cases\n\n5) this condition is now tested.\n\n6) `m + 1` cannot be pulled out of the loop because `m` is changed on every iteration.  I did however make the change from `p*i != 1` to `not (p*i).is_one()`.",
    "created_at": "2017-06-23T16:45:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125741",
    "user": "https://trac.sagemath.org/admin/accounts/users/msaaltink"
}
```

<a id='comment:27'></a>The last set of comments have been addressed in this latest commit:

4) has been done, with 3 more test cases

5) this condition is now tested.

6) `m + 1` cannot be pulled out of the loop because `m` is changed on every iteration.  I did however make the change from `p*i != 1` to `not (p*i).is_one()`.



---

archive/issue_comments_125742.json:
```json
{
    "body": "<a id='comment:28'></a>Matrices form a non-commutative ring... you expect your algorithm to work in this case? Anyway, I am not sure it is good idea to use this in tests as it is completely broken\n\n```\nsage: M=MatrixSpace(QQ, 2, 2); S.<y> = M[]\nsage: p = M.one() + y * M([0,2,0,0])\nsage: inverse_of_unit_polynomial(p)\nTraceback (most recent call last):\n...\nAttributeError: 'MatrixSpace_with_category' object has no attribute 'is_integral_domain'\n```",
    "created_at": "2017-06-24T14:59:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125742",
    "user": "https://github.com/videlec"
}
```

<a id='comment:28'></a>Matrices form a non-commutative ring... you expect your algorithm to work in this case? Anyway, I am not sure it is good idea to use this in tests as it is completely broken

```
sage: M=MatrixSpace(QQ, 2, 2); S.<y> = M[]
sage: p = M.one() + y * M([0,2,0,0])
sage: inverse_of_unit_polynomial(p)
Traceback (most recent call last):
...
AttributeError: 'MatrixSpace_with_category' object has no attribute 'is_integral_domain'
```



---

archive/issue_comments_125743.json:
```json
{
    "body": "<a id='comment:29'></a>and doctest failure\n\n```\nsage -t --long --warn-long 75.4 rings/polynomial/polynomial_element.pyx\n**********************************************************************\nFile \"rings/polynomial/polynomial_element.pyx\", line 9680, in sage.rings.polynomial.polynomial_element.inverse_of_unit_polynomial\nFailed example:\n    inverse_of_unit_polynomial(S(1))\nExpected:\n    Traceback (most recent call last):\n    ...\n    NotImplementedError: Base ring, Full MatrixSpace of 2 by 2 dense matrices over Univariate Polynomial Ring in x over Integer Ring, does not implement inverse_of_unit.\nGot:\n    [1 0]\n    [0 1]\n**********************************************************************\n```",
    "created_at": "2017-06-24T15:03:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125743",
    "user": "https://github.com/videlec"
}
```

<a id='comment:29'></a>and doctest failure

```
sage -t --long --warn-long 75.4 rings/polynomial/polynomial_element.pyx
**********************************************************************
File "rings/polynomial/polynomial_element.pyx", line 9680, in sage.rings.polynomial.polynomial_element.inverse_of_unit_polynomial
Failed example:
    inverse_of_unit_polynomial(S(1))
Expected:
    Traceback (most recent call last):
    ...
    NotImplementedError: Base ring, Full MatrixSpace of 2 by 2 dense matrices over Univariate Polynomial Ring in x over Integer Ring, does not implement inverse_of_unit.
Got:
    [1 0]
    [0 1]
**********************************************************************
```



---

archive/issue_comments_125744.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-06-24T15:03:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125744",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_125745.json:
```json
{
    "body": "<a id='comment:30'></a>That is strange; the doctest succeeds for me.  However, as you point out, it is not good to use a noncommutative base ring.  I do not think I then have a test for the condition triggering the `NotImplementedError`, as the place this situation used to occur was in polynomial rings, and is fixed by this patch.  Still, I'm reluctant to take the untested code out, as a ring could be added in future that also has this feature (no `inverse_of_unit` and `~` taking us to a different ring).  Would it be cheating for me to create such a ring in the doctest?",
    "created_at": "2017-06-24T16:42:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125745",
    "user": "https://trac.sagemath.org/admin/accounts/users/msaaltink"
}
```

<a id='comment:30'></a>That is strange; the doctest succeeds for me.  However, as you point out, it is not good to use a noncommutative base ring.  I do not think I then have a test for the condition triggering the `NotImplementedError`, as the place this situation used to occur was in polynomial rings, and is fixed by this patch.  Still, I'm reluctant to take the untested code out, as a ring could be added in future that also has this feature (no `inverse_of_unit` and `~` taking us to a different ring).  Would it be cheating for me to create such a ring in the doctest?



---

archive/issue_comments_125746.json:
```json
{
    "body": "<a id='comment:31'></a>Note that I did the testing on top of beta12 which might explain the changes.",
    "created_at": "2017-06-24T18:32:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125746",
    "user": "https://github.com/videlec"
}
```

<a id='comment:31'></a>Note that I did the testing on top of beta12 which might explain the changes.



---

archive/issue_comments_125747.json:
```json
{
    "body": "<a id='comment:32'></a>Replying to [comment:30 msaaltink]:\n> Would it be cheating for me to create such a ring in the doctest?\n\n\nYes!",
    "created_at": "2017-06-24T18:46:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125747",
    "user": "https://github.com/videlec"
}
```

<a id='comment:32'></a>Replying to [comment:30 msaaltink]:
> Would it be cheating for me to create such a ring in the doctest?


Yes!



---

archive/issue_comments_125748.json:
```json
{
    "body": "<a id='comment:33'></a>When I try to build a complicated base ring, `is_nilpotent` or `is_unit` is not implemented.\n\nKeep the code the way it is, but merge with beta12 and fix the doctest.",
    "created_at": "2017-06-24T18:57:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125748",
    "user": "https://github.com/videlec"
}
```

<a id='comment:33'></a>When I try to build a complicated base ring, `is_nilpotent` or `is_unit` is not implemented.

Keep the code the way it is, but merge with beta12 and fix the doctest.



---

archive/issue_comments_125749.json:
```json
{
    "body": "<a id='comment:34'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-06-29T15:19:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125749",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:34'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_125750.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-06-29T15:20:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125750",
    "user": "https://trac.sagemath.org/admin/accounts/users/msaaltink"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_125751.json:
```json
{
    "body": "<a id='comment:36'></a>does not apply",
    "created_at": "2017-07-04T15:58:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125751",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:36'></a>does not apply



---

archive/issue_comments_125752.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-07-04T15:58:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125752",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_125753.json:
```json
{
    "body": "<a id='comment:37'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-04T22:57:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125753",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:37'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_125754.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-07-04T22:58:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125754",
    "user": "https://trac.sagemath.org/admin/accounts/users/msaaltink"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_125755.json:
```json
{
    "body": "<a id='comment:39'></a>I added a commit to introduce `constant_coefficient` for infinite polynomial rings. Please review.\n\n---\nNew commits:",
    "created_at": "2017-07-06T07:57:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125755",
    "user": "https://github.com/videlec"
}
```

<a id='comment:39'></a>I added a commit to introduce `constant_coefficient` for infinite polynomial rings. Please review.

---
New commits:



---

archive/issue_comments_125756.json:
```json
{
    "body": "<a id='comment:40'></a>While this is a straightforward change that makes an additional test case work, I had really hoped for a more comprehensive answer to the problems identified in trac #22514.  In my opinion, the right fix is to ensure that the `_p` attribute on an infinite polynomial is always in fact a polynomial, which would fix the `constant coefficient` problem as well as the many others identified in #22514.  That fix, if made, would make this new method unnecessary.",
    "created_at": "2017-07-06T15:14:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125756",
    "user": "https://trac.sagemath.org/admin/accounts/users/msaaltink"
}
```

<a id='comment:40'></a>While this is a straightforward change that makes an additional test case work, I had really hoped for a more comprehensive answer to the problems identified in trac #22514.  In my opinion, the right fix is to ensure that the `_p` attribute on an infinite polynomial is always in fact a polynomial, which would fix the `constant coefficient` problem as well as the many others identified in #22514.  That fix, if made, would make this new method unnecessary.



---

archive/issue_comments_125757.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-07-06T15:25:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125757",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_125758.json:
```json
{
    "body": "<a id='comment:41'></a>I would be happy to have it the other way around, but then you should first fix #22514. Your branch attached to this ticket introduces a regression which is not good.",
    "created_at": "2017-07-06T15:25:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125758",
    "user": "https://github.com/videlec"
}
```

<a id='comment:41'></a>I would be happy to have it the other way around, but then you should first fix #22514. Your branch attached to this ticket introduces a regression which is not good.



---

archive/issue_comments_125759.json:
```json
{
    "body": "<a id='comment:42'></a>Note that many methods would be simplified if the attribute `_p` would consistently be a polynomial...",
    "created_at": "2017-07-06T15:27:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125759",
    "user": "https://github.com/videlec"
}
```

<a id='comment:42'></a>Note that many methods would be simplified if the attribute `_p` would consistently be a polynomial...



---

archive/issue_comments_125760.json:
```json
{
    "body": "<a id='comment:43'></a>I have pushed a proposed fix for #22514; if accepted it will make commit 718b0e2 unnecessary and will allow the test case for constant elements of an `InfinitePolynomialRing` to be successful.",
    "created_at": "2017-07-09T20:36:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11537#issuecomment-125760",
    "user": "https://trac.sagemath.org/admin/accounts/users/msaaltink"
}
```

<a id='comment:43'></a>I have pushed a proposed fix for #22514; if accepted it will make commit 718b0e2 unnecessary and will allow the test case for constant elements of an `InfinitePolynomialRing` to be successful.
