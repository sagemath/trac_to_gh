# Issue 11812: traceback with load and attach of .sage files

archive/issues_011640.json:
```json
{
    "body": "When debugging code that is loaded into or attached to a Sage session from a .sage file,\nthe tracebacks are not very informative: they refer to <string> instead\nof to the file name, and give no line numbers or code snippets. This\nmakes it hard to find out where the error is.\n\nThe patch fixes this for attach, but not for load (because of efficiency reasons).\n\nApply [attachment:11812.3.patch]\n\n---\n\nExample:\n\nSuppose I have some files loaded with \"load\" or \"attach\", and one of them is a .sage file with\n\n```\nclass Bar():\n     def function_with_common_name(self):\n         # lots of lines of code\n         1/0\n         # lots of lines of code\n\n# other classes that also have functions named function_with_common_name\n\ndef foo():\n     # lots of lines of code\n     a = Bar()\n     a.function_with_common_name()\n     # lots of lines of code\n```\n\nNow I do\n\n```\nsage: foo()\n---------------------------------------------------------------------------\nZeroDivisionError                         Traceback (most recent call last)\n\n/home/marco/<ipython console> in <module>()\n\n/home/marco/<string> in foo()\n\n/home/marco/<string> in function_with_common_name(self)\n\n/usr/local/sage/sage-4.6.2/local/lib/python2.6/site-packages/sage/structure/element.so\nin sage.structure.element.RingElement.__div__\n(sage/structure/element.c:11981)()\n\n/usr/local/sage/sage-4.6.2/local/lib/python2.6/site-packages/sage/rings/integer.so\nin sage.rings.integer.Integer._div_ (sage/rings/integer.c:11944)()\n\n/usr/local/sage/sage-4.6.2/local/lib/python2.6/site-packages/sage/rings/integer_ring.so\nin sage.rings.integer_ring.IntegerRing_class._div\n(sage/rings/integer_ring.c:5142)()\n\nZeroDivisionError: Rational division by zero\n```\n\nThen to find the bug using this traceback, I would need to search my\nfiles to find all functions named \"function_with_common_name\" that are\ncalled from functions named \"foo\" for a line that could cause a division\nby zero... \n\nMore details:\n[http://groups.google.com/group/sage-devel/browse_thread/thread/761f69944e21efd4](http://groups.google.com/group/sage-devel/browse_thread/thread/761f69944e21efd4)\n\n\nAssignee: @jasongrout\n\nCC:  johanbosman\n\nKeywords: load attach traceback\n\nReviewer: Johan Bosman\n\nAuthor: Marco Streng\n\nMerged: sage-4.8.alpha0\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/11812\n\n",
    "closed_at": "2011-10-19T18:52:48Z",
    "created_at": "2011-09-18T09:12:00Z",
    "labels": [
        "component: misc",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.8",
    "title": "traceback with load and attach of .sage files",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11812",
    "user": "https://github.com/mstreng"
}
```
When debugging code that is loaded into or attached to a Sage session from a .sage file,
the tracebacks are not very informative: they refer to <string> instead
of to the file name, and give no line numbers or code snippets. This
makes it hard to find out where the error is.

The patch fixes this for attach, but not for load (because of efficiency reasons).

Apply [attachment:11812.3.patch]

---

Example:

Suppose I have some files loaded with "load" or "attach", and one of them is a .sage file with

```
class Bar():
     def function_with_common_name(self):
         # lots of lines of code
         1/0
         # lots of lines of code

# other classes that also have functions named function_with_common_name

def foo():
     # lots of lines of code
     a = Bar()
     a.function_with_common_name()
     # lots of lines of code
```

Now I do

```
sage: foo()
---------------------------------------------------------------------------
ZeroDivisionError                         Traceback (most recent call last)

/home/marco/<ipython console> in <module>()

/home/marco/<string> in foo()

/home/marco/<string> in function_with_common_name(self)

/usr/local/sage/sage-4.6.2/local/lib/python2.6/site-packages/sage/structure/element.so
in sage.structure.element.RingElement.__div__
(sage/structure/element.c:11981)()

/usr/local/sage/sage-4.6.2/local/lib/python2.6/site-packages/sage/rings/integer.so
in sage.rings.integer.Integer._div_ (sage/rings/integer.c:11944)()

/usr/local/sage/sage-4.6.2/local/lib/python2.6/site-packages/sage/rings/integer_ring.so
in sage.rings.integer_ring.IntegerRing_class._div
(sage/rings/integer_ring.c:5142)()

ZeroDivisionError: Rational division by zero
```

Then to find the bug using this traceback, I would need to search my
files to find all functions named "function_with_common_name" that are
called from functions named "foo" for a line that could cause a division
by zero... 

More details:
[http://groups.google.com/group/sage-devel/browse_thread/thread/761f69944e21efd4](http://groups.google.com/group/sage-devel/browse_thread/thread/761f69944e21efd4)


Assignee: @jasongrout

CC:  johanbosman

Keywords: load attach traceback

Reviewer: Johan Bosman

Author: Marco Streng

Merged: sage-4.8.alpha0

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/11812





---

archive/issue_comments_160912.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -50,7 +50,12 @@\n ZeroDivisionError: Rational division by zero\n ```\n \n-The cause of the problem was pinpointed by Cornado PLG and he gives the following fix:\n+Then to find the bug using this traceback, I would need to search my\n+files to find all functions named \"function_with_common_name\" that are\n+called from functions named \"foo\" for a line that could cause a division\n+by zero... \n+\n+The cause of the problem was pinpointed by Conrado PLG and he gives the following fix:\n \n Search preparser.py for `elif fpath.endswith('.sage')` and change to the code below:\n \n@@ -63,6 +68,24 @@\n         execfile(fpath + '.py', globals) \n ```\n \n+After that change, the traceback contains the information that I want:\n+\n+```\n+/Users/marcostreng/tmp/foo.sage.py in foo()\n+     10 def foo():\n+     11      # lots of lines of code\n+     12      a = Bar()\n+---> 13      a.function_with_common_name()\n+     14      # lots of lines of code\n+\n+/Users/marcostreng/tmp/foo.sage.py in function_with_common_name(self)\n+      3      def function_with_common_name(self):\n+      4          # lots of lines of code\n+----> 5          _sage_const_1 /_sage_const_0 \n+      6          # lots of lines of code\n+      7 \n+```\n+\n For an explanation of why this works, and for a discussion of what would be the best way to fix this, see\n [http://groups.google.com/group/sage-devel/browse_thread/thread/761f69944e21efd4](http://groups.google.com/group/sage-devel/browse_thread/thread/761f69944e21efd4)\n \n``````\n",
    "created_at": "2011-09-18T09:26:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160912",
    "user": "https://github.com/mstreng"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -50,7 +50,12 @@
 ZeroDivisionError: Rational division by zero
 ```
 
-The cause of the problem was pinpointed by Cornado PLG and he gives the following fix:
+Then to find the bug using this traceback, I would need to search my
+files to find all functions named "function_with_common_name" that are
+called from functions named "foo" for a line that could cause a division
+by zero... 
+
+The cause of the problem was pinpointed by Conrado PLG and he gives the following fix:
 
 Search preparser.py for `elif fpath.endswith('.sage')` and change to the code below:
 
@@ -63,6 +68,24 @@
         execfile(fpath + '.py', globals) 
 ```
 
+After that change, the traceback contains the information that I want:
+
+```
+/Users/marcostreng/tmp/foo.sage.py in foo()
+     10 def foo():
+     11      # lots of lines of code
+     12      a = Bar()
+---> 13      a.function_with_common_name()
+     14      # lots of lines of code
+
+/Users/marcostreng/tmp/foo.sage.py in function_with_common_name(self)
+      3      def function_with_common_name(self):
+      4          # lots of lines of code
+----> 5          _sage_const_1 /_sage_const_0 
+      6          # lots of lines of code
+      7 
+```
+
 For an explanation of why this works, and for a discussion of what would be the best way to fix this, see
 [http://groups.google.com/group/sage-devel/browse_thread/thread/761f69944e21efd4](http://groups.google.com/group/sage-devel/browse_thread/thread/761f69944e21efd4)
 
``````




---

archive/issue_comments_160913.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -89,3 +89,6 @@\n For an explanation of why this works, and for a discussion of what would be the best way to fix this, see\n [http://groups.google.com/group/sage-devel/browse_thread/thread/761f69944e21efd4](http://groups.google.com/group/sage-devel/browse_thread/thread/761f69944e21efd4)\n \n+Of course a patch should also include a doctest to prevent all this from happening again.\n+\n+\n``````\n",
    "created_at": "2011-09-18T14:09:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160913",
    "user": "https://github.com/mstreng"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -89,3 +89,6 @@
 For an explanation of why this works, and for a discussion of what would be the best way to fix this, see
 [http://groups.google.com/group/sage-devel/browse_thread/thread/761f69944e21efd4](http://groups.google.com/group/sage-devel/browse_thread/thread/761f69944e21efd4)
 
+Of course a patch should also include a doctest to prevent all this from happening again.
+
+
``````




---

archive/issue_comments_160914.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -2,6 +2,10 @@\n the tracebacks are not very informative: they refer to <string> instead\n of to the file name, and give no line numbers or code snippets. This\n makes it hard to find out where the error is.\n+\n+The patch fixes this for attach, but not for load (because of efficiency reasons).\n+\n+Apply [attachment:trac_11812-traceback_attach.patch]\n \n Example:\n \n@@ -55,40 +59,6 @@\n called from functions named \"foo\" for a line that could cause a division\n by zero... \n \n-The cause of the problem was pinpointed by Conrado PLG and he gives the following fix:\n-\n-Search preparser.py for `elif fpath.endswith('.sage')` and change to the code below:\n-\n-```\n-    elif fpath.endswith('.sage'):\n-        s = preparse_file(open(fpath).read())\n-        f = open(fpath + '.py', 'w')\n-        f.write(s)\n-        f.close()\n-        execfile(fpath + '.py', globals) \n-```\n-\n-After that change, the traceback contains the information that I want:\n-\n-```\n-/Users/marcostreng/tmp/foo.sage.py in foo()\n-     10 def foo():\n-     11      # lots of lines of code\n-     12      a = Bar()\n----> 13      a.function_with_common_name()\n-     14      # lots of lines of code\n-\n-/Users/marcostreng/tmp/foo.sage.py in function_with_common_name(self)\n-      3      def function_with_common_name(self):\n-      4          # lots of lines of code\n-----> 5          _sage_const_1 /_sage_const_0 \n-      6          # lots of lines of code\n-      7 \n-```\n-\n-For an explanation of why this works, and for a discussion of what would be the best way to fix this, see\n+More details:\n [http://groups.google.com/group/sage-devel/browse_thread/thread/761f69944e21efd4](http://groups.google.com/group/sage-devel/browse_thread/thread/761f69944e21efd4)\n \n-Of course a patch should also include a doctest to prevent all this from happening again.\n-\n-\n``````\n",
    "created_at": "2011-09-22T14:35:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160914",
    "user": "https://github.com/mstreng"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -2,6 +2,10 @@
 the tracebacks are not very informative: they refer to <string> instead
 of to the file name, and give no line numbers or code snippets. This
 makes it hard to find out where the error is.
+
+The patch fixes this for attach, but not for load (because of efficiency reasons).
+
+Apply [attachment:trac_11812-traceback_attach.patch]
 
 Example:
 
@@ -55,40 +59,6 @@
 called from functions named "foo" for a line that could cause a division
 by zero... 
 
-The cause of the problem was pinpointed by Conrado PLG and he gives the following fix:
-
-Search preparser.py for `elif fpath.endswith('.sage')` and change to the code below:
-
-```
-    elif fpath.endswith('.sage'):
-        s = preparse_file(open(fpath).read())
-        f = open(fpath + '.py', 'w')
-        f.write(s)
-        f.close()
-        execfile(fpath + '.py', globals) 
-```
-
-After that change, the traceback contains the information that I want:
-
-```
-/Users/marcostreng/tmp/foo.sage.py in foo()
-     10 def foo():
-     11      # lots of lines of code
-     12      a = Bar()
----> 13      a.function_with_common_name()
-     14      # lots of lines of code
-
-/Users/marcostreng/tmp/foo.sage.py in function_with_common_name(self)
-      3      def function_with_common_name(self):
-      4          # lots of lines of code
-----> 5          _sage_const_1 /_sage_const_0 
-      6          # lots of lines of code
-      7 
-```
-
-For an explanation of why this works, and for a discussion of what would be the best way to fix this, see
+More details:
 [http://groups.google.com/group/sage-devel/browse_thread/thread/761f69944e21efd4](http://groups.google.com/group/sage-devel/browse_thread/thread/761f69944e21efd4)
 
-Of course a patch should also include a doctest to prevent all this from happening again.
-
-
``````




---

archive/issue_comments_160915.json:
```json
{
    "body": "<a id='comment:3'></a>Attachment [trac_11812-traceback_attach.patch](tarball://root/attachments/some-uuid/ticket11812/trac_11812-traceback_attach.patch) by @mstreng created at 2011-09-22 14:35:50",
    "created_at": "2011-09-22T14:35:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160915",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:3'></a>Attachment [trac_11812-traceback_attach.patch](tarball://root/attachments/some-uuid/ticket11812/trac_11812-traceback_attach.patch) by @mstreng created at 2011-09-22 14:35:50



---

archive/issue_comments_160916.json:
```json
{
    "body": "<a id='comment:4'></a>All tests passed on sage 4.7",
    "created_at": "2011-09-22T15:37:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160916",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:4'></a>All tests passed on sage 4.7



---

archive/issue_comments_160917.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-09-22T15:37:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160917",
    "user": "https://github.com/mstreng"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_160918.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2011-09-22T19:06:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160918",
    "user": "https://github.com/mstreng"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_160919.json:
```json
{
    "body": "<a id='comment:5'></a>Judging from the patchbot results, it doesn't seem to work after all.\n\nWhat exactly does spawn('sage') do? It always started a Sage session of the same Sage version and the same Sage installation when I tried it out (it was not in the PATH, but it was in the working directory). Maybe it doesn't work on all machines or it depends on the working directory?\n\nAny idea of how to do these tests so that they succeed with patch and fail without?",
    "created_at": "2011-09-22T19:06:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160919",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:5'></a>Judging from the patchbot results, it doesn't seem to work after all.

What exactly does spawn('sage') do? It always started a Sage session of the same Sage version and the same Sage installation when I tried it out (it was not in the PATH, but it was in the working directory). Maybe it doesn't work on all machines or it depends on the working directory?

Any idea of how to do these tests so that they succeed with patch and fail without?



---

archive/issue_comments_160920.json:
```json
{
    "body": "<a id='comment:6'></a>only apply 11812.patch",
    "created_at": "2011-10-07T14:56:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160920",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:6'></a>only apply 11812.patch



---

archive/issue_comments_160921.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -5,7 +5,9 @@\n \n The patch fixes this for attach, but not for load (because of efficiency reasons).\n \n-Apply [attachment:trac_11812-traceback_attach.patch]\n+Apply [attachment:11812.patch]\n+\n+---\n \n Example:\n \n``````\n",
    "created_at": "2011-10-07T14:56:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160921",
    "user": "https://github.com/mstreng"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -5,7 +5,9 @@
 
 The patch fixes this for attach, but not for load (because of efficiency reasons).
 
-Apply [attachment:trac_11812-traceback_attach.patch]
+Apply [attachment:11812.patch]
+
+---
 
 Example:
 
``````




---

archive/issue_comments_160922.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2011-10-07T14:56:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160922",
    "user": "https://github.com/mstreng"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_160923.json:
```json
{
    "body": "<a id='comment:7'></a>A few minor issues:\n\n* `if preparse_to_file == None:` should be `if preparse_to_file `**`is`**` None:`.\n\n* There's some mark-up missing in the docstrings (also in parts you didn't add).\n \n* In docstrings, Python identifiers (constants, function and variable names etc.) and the like should be enclosed in double backticks (```name```, which means Courier / typewriter font); ``name`` in contrast yields typesetting in *math* mode.\n\n\n\n\nI'm not sure what your problem with doctests involving tracebacks exactly was; we have a couple of such tests (not needing to call `sage` or use the `PExpect` interface); they just look slightly different to what you get in a real Sage session.\n\nYou can also use continuation lines in examples and doctests by the way, but again they're (currently still) a bit different such that you cannot directly paste them from a Sage session, i.e., you have to use the Python form instead of Sage's (cf. #10458).",
    "created_at": "2011-10-10T02:59:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160923",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:7'></a>A few minor issues:

* `if preparse_to_file == None:` should be `if preparse_to_file `**`is`**` None:`.

* There's some mark-up missing in the docstrings (also in parts you didn't add).
 
* In docstrings, Python identifiers (constants, function and variable names etc.) and the like should be enclosed in double backticks (```name```, which means Courier / typewriter font); ``name`` in contrast yields typesetting in *math* mode.




I'm not sure what your problem with doctests involving tracebacks exactly was; we have a couple of such tests (not needing to call `sage` or use the `PExpect` interface); they just look slightly different to what you get in a real Sage session.

You can also use continuation lines in examples and doctests by the way, but again they're (currently still) a bit different such that you cannot directly paste them from a Sage session, i.e., you have to use the Python form instead of Sage's (cf. #10458).



---

archive/issue_comments_160924.json:
```json
{
    "body": "simpler patch: fixes the problem without adding complicated new doctests",
    "created_at": "2011-10-10T10:30:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160924",
    "user": "https://github.com/mstreng"
}
```

simpler patch: fixes the problem without adding complicated new doctests



---

archive/issue_comments_160925.json:
```json
{
    "body": "<a id='comment:8'></a>Attachment [11812.patch](tarball://root/attachments/some-uuid/ticket11812/11812.patch) by @mstreng created at 2011-10-10 10:54:17\n\nReplying to [leif](#comment%3A7):\n>  * `if preparse_to_file == None:` should be `if preparse_to_file `**`is`**` None:`.\n>  * There's some mark-up missing in the docstrings (also in parts you didn't add).\n\n\nThanks, all corrected (I think).\n\n>  * In docstrings, Python identifiers (constants, function and variable names etc.) and the like should be enclosed in double backticks (```name```, which means Courier / typewriter font); ``name`` in contrast yields typesetting in *math* mode.\n\n\nNot sure what you mean: I don't see where in this docstring single backticks are or should be used. I did add some double backticks though.\n\n\n> I'm not sure what your problem with doctests involving tracebacks exactly was; we have a couple of such tests (not needing to call `sage` or use the `PExpect` interface); they just look slightly different to what you get in a real Sage session.\n\n\nThe problem with the doctest is that I couldn't create a test that really checks whether #11812 was fixed:\n\n* The content of the traceback in the example `sage: attach('myfile.sage')` on line 1573 of [attachment:trac_11812-traceback_attach.patch] is ignored in doctests according to [this link](http://docs.python.org/library/doctest.html#what-about-exceptions). And indeed, that example passes the doctests even with #11812 not applied.\n\n* The test with pexpect in that attachment seemed to work on my computer, but doesn't really, according to [patchbot](http://patchbot.sagemath.org/log/11812/linux/ubuntu/hardy/sage.math.washington.edu/2011-09-22%2008:56:39%20-0700). The problem is that I don't quite understand which sage installation is used in this test.\n\nSo I had to remove the test. As the example isn't tested anyway, I decided to keep things simple by removing that as well and adding a few explanatory comments to the code.",
    "created_at": "2011-10-10T10:54:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160925",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:8'></a>Attachment [11812.patch](tarball://root/attachments/some-uuid/ticket11812/11812.patch) by @mstreng created at 2011-10-10 10:54:17

Replying to [leif](#comment%3A7):
>  * `if preparse_to_file == None:` should be `if preparse_to_file `**`is`**` None:`.
>  * There's some mark-up missing in the docstrings (also in parts you didn't add).


Thanks, all corrected (I think).

>  * In docstrings, Python identifiers (constants, function and variable names etc.) and the like should be enclosed in double backticks (```name```, which means Courier / typewriter font); ``name`` in contrast yields typesetting in *math* mode.


Not sure what you mean: I don't see where in this docstring single backticks are or should be used. I did add some double backticks though.


> I'm not sure what your problem with doctests involving tracebacks exactly was; we have a couple of such tests (not needing to call `sage` or use the `PExpect` interface); they just look slightly different to what you get in a real Sage session.


The problem with the doctest is that I couldn't create a test that really checks whether #11812 was fixed:

* The content of the traceback in the example `sage: attach('myfile.sage')` on line 1573 of [attachment:trac_11812-traceback_attach.patch] is ignored in doctests according to [this link](http://docs.python.org/library/doctest.html#what-about-exceptions). And indeed, that example passes the doctests even with #11812 not applied.

* The test with pexpect in that attachment seemed to work on my computer, but doesn't really, according to [patchbot](http://patchbot.sagemath.org/log/11812/linux/ubuntu/hardy/sage.math.washington.edu/2011-09-22%2008:56:39%20-0700). The problem is that I don't quite understand which sage installation is used in this test.

So I had to remove the test. As the example isn't tested anyway, I decided to keep things simple by removing that as well and adding a few explanatory comments to the code.



---

archive/issue_comments_160926.json:
```json
{
    "body": "<a id='comment:9'></a>I would like to remind the patchbot to apply 11812.patch only.",
    "created_at": "2011-10-10T10:55:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160926",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:9'></a>I would like to remind the patchbot to apply 11812.patch only.



---

archive/issue_comments_160927.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-10-13T10:53:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160927",
    "user": "https://github.com/mstreng"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_160928.json:
```json
{
    "body": "<a id='comment:10'></a>Oops, this patch works only from the moment you attach the file until the moment it changes: if I change my file in another terminal, and then do `sage: foo()` again, it gets reloaded without good tracebacks.",
    "created_at": "2011-10-13T10:53:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160928",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:10'></a>Oops, this patch works only from the moment you attach the file until the moment it changes: if I change my file in another terminal, and then do `sage: foo()` again, it gets reloaded without good tracebacks.



---

archive/issue_comments_160929.json:
```json
{
    "body": "<a id='comment:11'></a>I'm writing a new patch.\n\nUnrelated to that, see also #11925.",
    "created_at": "2011-10-15T09:06:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160929",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:11'></a>I'm writing a new patch.

Unrelated to that, see also #11925.



---

archive/issue_comments_160930.json:
```json
{
    "body": "Attachment [11812.2.patch](tarball://root/attachments/some-uuid/ticket11812/11812.2.patch) by @mstreng created at 2011-10-16 13:45:03",
    "created_at": "2011-10-16T13:45:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160930",
    "user": "https://github.com/mstreng"
}
```

Attachment [11812.2.patch](tarball://root/attachments/some-uuid/ticket11812/11812.2.patch) by @mstreng created at 2011-10-16 13:45:03



---

archive/issue_comments_160931.json:
```json
{
    "body": "Changing author from \"\" to \"Marco Streng\"",
    "created_at": "2011-10-16T13:47:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160931",
    "user": "https://github.com/mstreng"
}
```

Changing author from "" to "Marco Streng"



---

archive/issue_comments_160932.json:
```json
{
    "body": "<a id='comment:12'></a>New patch that does work. Apply 11812.3.patch only.\n(testing now)",
    "created_at": "2011-10-16T13:47:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160932",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:12'></a>New patch that does work. Apply 11812.3.patch only.
(testing now)



---

archive/issue_comments_160933.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -5,7 +5,7 @@\n \n The patch fixes this for attach, but not for load (because of efficiency reasons).\n \n-Apply [attachment:11812.patch]\n+Apply [attachment:11812.3.patch]\n \n ---\n \n``````\n",
    "created_at": "2011-10-16T13:47:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160933",
    "user": "https://github.com/mstreng"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -5,7 +5,7 @@
 
 The patch fixes this for attach, but not for load (because of efficiency reasons).
 
-Apply [attachment:11812.patch]
+Apply [attachment:11812.3.patch]
 
 ---
 
``````




---

archive/issue_comments_160934.json:
```json
{
    "body": "<a id='comment:13'></a>Attachment [11812.3.patch](tarball://root/attachments/some-uuid/ticket11812/11812.3.patch) by @mstreng created at 2011-10-16 16:25:43\n\nAll tests pass!!",
    "created_at": "2011-10-16T16:25:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160934",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:13'></a>Attachment [11812.3.patch](tarball://root/attachments/some-uuid/ticket11812/11812.3.patch) by @mstreng created at 2011-10-16 16:25:43

All tests pass!!



---

archive/issue_comments_160935.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-10-16T16:25:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160935",
    "user": "https://github.com/mstreng"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_160936.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-10-17T12:42:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160936",
    "user": "https://trac.sagemath.org/admin/accounts/users/johanbosman"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_160937.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Johan Bosman\"",
    "created_at": "2011-10-17T12:42:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160937",
    "user": "https://trac.sagemath.org/admin/accounts/users/johanbosman"
}
```

Changing reviewer from "" to "Johan Bosman"



---

archive/issue_comments_160938.json:
```json
{
    "body": "<a id='comment:14'></a>Looks good. ;).",
    "created_at": "2011-10-17T12:42:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160938",
    "user": "https://trac.sagemath.org/admin/accounts/users/johanbosman"
}
```

<a id='comment:14'></a>Looks good. ;).



---

archive/issue_comments_160939.json:
```json
{
    "body": "Changing keywords from \"\" to \"load attach traceback\".",
    "created_at": "2011-10-18T08:57:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160939",
    "user": "https://github.com/mstreng"
}
```

Changing keywords from "" to "load attach traceback".



---

archive/issue_comments_160940.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [johanbosman](#comment%3A14):\n\nThanks!",
    "created_at": "2011-10-18T08:57:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160940",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:16'></a>Replying to [johanbosman](#comment%3A14):

Thanks!



---

archive/issue_comments_160941.json:
```json
{
    "body": "Changing merged from \"\" to \"sage-4.7.3.alpha0\"",
    "created_at": "2011-10-19T18:52:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160941",
    "user": "https://github.com/jdemeyer"
}
```

Changing merged from "" to "sage-4.7.3.alpha0"



---

archive/issue_comments_160942.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-10-19T18:52:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160942",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_031133.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-10-19T18:52:48Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11812#event-31133"
}
```



---

archive/issue_comments_160943.json:
```json
{
    "body": "Milestone sage-4.7.3 deleted",
    "created_at": "2011-11-03T16:14:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160943",
    "user": "https://github.com/jdemeyer"
}
```

Milestone sage-4.7.3 deleted



---

archive/issue_comments_160944.json:
```json
{
    "body": "Changing merged from \"sage-4.7.3.alpha0\" to \"sage-4.8.alpha0\"",
    "created_at": "2011-11-03T16:17:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160944",
    "user": "https://github.com/jdemeyer"
}
```

Changing merged from "sage-4.7.3.alpha0" to "sage-4.8.alpha0"



---

archive/issue_events_031134.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-11-03T16:17:36Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "milestone": "sage-4.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11812#event-31134"
}
```



---

archive/issue_comments_160945.json:
```json
{
    "body": "Replying to [ticket:11812 mstreng]:\n> The patch fixes this for attach, but not for load (because of efficiency reasons).\n\n\nWhat exactly are these \"efficiency reasons\"? Are people really executing `load` or `attach` in tight loops? I think that one should **always** have good tracebacks, so I would always use temporary files.",
    "created_at": "2014-11-20T18:32:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160945",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [ticket:11812 mstreng]:
> The patch fixes this for attach, but not for load (because of efficiency reasons).


What exactly are these "efficiency reasons"? Are people really executing `load` or `attach` in tight loops? I think that one should **always** have good tracebacks, so I would always use temporary files.



---

archive/issue_comments_160946.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [jdemeyer](#comment%3A20):\n> Replying to [ticket:11812 mstreng]:\n> > The patch fixes this for attach, but not for load (because of efficiency reasons).\n\n> \n> What exactly are these \"efficiency reasons\"?\n\n\nWith a temporary file, there is a good traceback, but working with files can be slow. When precompiling in memory, it is faster, but that is not implemented in a way that yields good tracebacks.\n\n> Are people really executing `load` or `attach` in tight loops?\n\n\nI can't imagine that anyone would do that.\n\n> I think that one should **always** have good tracebacks, so I would always use temporary files.\n\n\nI completely agree. However, it seemed during the original discussion that I was the only one who always wanted good tracebacks. And someone made the switch to memory on purpose, for efficiency reasons.",
    "created_at": "2014-11-21T07:50:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160946",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:21'></a>Replying to [jdemeyer](#comment%3A20):
> Replying to [ticket:11812 mstreng]:
> > The patch fixes this for attach, but not for load (because of efficiency reasons).

> 
> What exactly are these "efficiency reasons"?


With a temporary file, there is a good traceback, but working with files can be slow. When precompiling in memory, it is faster, but that is not implemented in a way that yields good tracebacks.

> Are people really executing `load` or `attach` in tight loops?


I can't imagine that anyone would do that.

> I think that one should **always** have good tracebacks, so I would always use temporary files.


I completely agree. However, it seemed during the original discussion that I was the only one who always wanted good tracebacks. And someone made the switch to memory on purpose, for efficiency reasons.



---

archive/issue_comments_160947.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [mstreng](#comment%3A21):\n> With a temporary file, there is a good traceback, but working with files can be slow. When precompiling in memory, it is faster, but that is not implemented in a way that yields good tracebacks.\n\nI am thinking about #71 and it *might* be possible to have a traceback for a preparsed-in-memory file by re-preparsing the file when showing the traceback. I still have to check if that actually works.\n\n> And someone made the switch to memory on purpose\n\nIndeed.\n\n> for efficiency reasons.\n\nThat's not clear to me, maybe it was just to simplify the code?",
    "created_at": "2014-11-21T09:35:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160947",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'></a>Replying to [mstreng](#comment%3A21):
> With a temporary file, there is a good traceback, but working with files can be slow. When precompiling in memory, it is faster, but that is not implemented in a way that yields good tracebacks.

I am thinking about #71 and it *might* be possible to have a traceback for a preparsed-in-memory file by re-preparsing the file when showing the traceback. I still have to check if that actually works.

> And someone made the switch to memory on purpose

Indeed.

> for efficiency reasons.

That's not clear to me, maybe it was just to simplify the code?



---

archive/issue_comments_160948.json:
```json
{
    "body": "<a id='comment:23'></a>Replying to [jdemeyer](#comment%3A22):\n> I am thinking about #71 and it *might* be possible to have a traceback for a preparsed-in-memory file by re-preparsing the file when showing the traceback. I still have to check if that actually works.\n\n\nSounds good.\n\nAnyway, to get good tracebacks by default also for load, all you need to do is change\n\n```\nload_debug_mode = False \nattach_debug_mode = True \n```\nboth to `True` in sage/misc/preparser.py, except that the name `debug_mode` is a bit confusing when it is the default.\n\n> maybe it was just to simplify the code?\n\n\nSimplifying and improving the code was indeed the purpose of #7514, where the switch to memory was made. The efficiency reason for the switch to memory was suggested to me by various people, not including the author of #7514.",
    "created_at": "2014-11-21T10:26:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11812",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11812#issuecomment-160948",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:23'></a>Replying to [jdemeyer](#comment%3A22):
> I am thinking about #71 and it *might* be possible to have a traceback for a preparsed-in-memory file by re-preparsing the file when showing the traceback. I still have to check if that actually works.


Sounds good.

Anyway, to get good tracebacks by default also for load, all you need to do is change

```
load_debug_mode = False 
attach_debug_mode = True 
```
both to `True` in sage/misc/preparser.py, except that the name `debug_mode` is a bit confusing when it is the default.

> maybe it was just to simplify the code?


Simplifying and improving the code was indeed the purpose of #7514, where the switch to memory was made. The efficiency reason for the switch to memory was suggested to me by various people, not including the author of #7514.
