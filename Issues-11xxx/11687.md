# Issue 11687: Sanitize `sage-env`

archive/issues_011515.json:
```json
{
    "body": "Assignee: @nexttime\n\nCC:  @kini\n\nKeywords: BUILD sage-spkg pkg-config .pc pkgconfig PKG_CONFIG_PATH SAGE_PATH Cygwin environment variables\n\nThere are currently a couple of issues with `sage-env`; approximately ordered by importance:\n\n* The definition of `UNAME` (currently on line 458) has to be moved up, preferably right before `PATH` etc. get set / modified (currently around line 135), and `$UNAME` should be used consistently.\n* We should save the original, unmodified `PATH` (to `SAGE_ORIG_PATH`), analoguous to `SAGE_ORIG_LD_LIBRARY_PATH` etc., and perhaps record this in `SAGE_ORIG_PATH_SET`. This should also be done close to the top, of course before modifying `PATH`. (#10202 also suggests / introduces this.)\n* There's partially useless code like\n\n```sh\nif [ \"$LDFLAGS\" = \"\" ]; then\n    LDFLAGS=\"\"          && export LDFLAGS\nfi\n```\n* *All* variables that are expected to be either \"`yes`\", \"`no`\" or empty / unset should be checked for [in]valid settings, and perhaps normalized (i.e., for example set to \"`no`\" in case they're empty or not set). \n\n  We currently only do this for `SAGE64`\n* The *default* for `CFLAG64` (`-m64`) and similar should be set in `sage-env`, not each and every `spkg-install`.\n\n---\n\nWe should IMHO also save the original settings of `CC`, `CFLAGS`, `LD`, `LDFLAGS`, `MAKE` etc., since it is otherwise impossible for scripts (like the `spkg-install`s) to determine whether or which parts of the current settings were made by Sage, and which originate from the user (intentionally or not, e.g. from system-wide or default `.*rc` files).\n\nA better approach would be to have and use `SAGE_CC` etc. instead, but this would require changes to all spkgs and other build-related files.\n\n---\n\nSome of the rather minor issues can be fixed on their own / follow-up tickets, but it would be odd to have a dozen \"concurring\" tickets all modifying `sage-env` at the same time.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/11687\n\n",
    "closed_at": "2015-06-18T17:57:54Z",
    "created_at": "2011-08-14T06:18:37Z",
    "labels": [
        "component: scripts",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.8",
    "title": "Sanitize `sage-env`",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11687",
    "user": "https://github.com/nexttime"
}
```
Assignee: @nexttime

CC:  @kini

Keywords: BUILD sage-spkg pkg-config .pc pkgconfig PKG_CONFIG_PATH SAGE_PATH Cygwin environment variables

There are currently a couple of issues with `sage-env`; approximately ordered by importance:

* The definition of `UNAME` (currently on line 458) has to be moved up, preferably right before `PATH` etc. get set / modified (currently around line 135), and `$UNAME` should be used consistently.
* We should save the original, unmodified `PATH` (to `SAGE_ORIG_PATH`), analoguous to `SAGE_ORIG_LD_LIBRARY_PATH` etc., and perhaps record this in `SAGE_ORIG_PATH_SET`. This should also be done close to the top, of course before modifying `PATH`. (#10202 also suggests / introduces this.)
* There's partially useless code like

```sh
if [ "$LDFLAGS" = "" ]; then
    LDFLAGS=""          && export LDFLAGS
fi
```
* *All* variables that are expected to be either "`yes`", "`no`" or empty / unset should be checked for [in]valid settings, and perhaps normalized (i.e., for example set to "`no`" in case they're empty or not set). 

  We currently only do this for `SAGE64`
* The *default* for `CFLAG64` (`-m64`) and similar should be set in `sage-env`, not each and every `spkg-install`.

---

We should IMHO also save the original settings of `CC`, `CFLAGS`, `LD`, `LDFLAGS`, `MAKE` etc., since it is otherwise impossible for scripts (like the `spkg-install`s) to determine whether or which parts of the current settings were made by Sage, and which originate from the user (intentionally or not, e.g. from system-wide or default `.*rc` files).

A better approach would be to have and use `SAGE_CC` etc. instead, but this would require changes to all spkgs and other build-related files.

---

Some of the rather minor issues can be fixed on their own / follow-up tickets, but it would be odd to have a dozen "concurring" tickets all modifying `sage-env` at the same time.


Issue created by migration from https://trac.sagemath.org/ticket/11687





---

archive/issue_comments_128904.json:
```json
{
    "body": "We could also define (and export) `PKG_CONFIG_TOP_BUILD_DIR`, namely to `${SAGE_ROOT}/local`, and use\n\n```\nprefix=${pc_top_builddir}\n```\nor, a bit more flexible, define it to just `${SAGE_ROOT}` and use\n\n```\nprefix=${pc_top_builddir}/local\n```\nin all `pkg-config` (`*.pc`) files, which avoids wrapping `pkg-config` just to add `--define-variable=SAGE_ROOT=\"${SAGE_ROOT}\"` to each invocation.\n\nThis is even safer than using\n\n```\nprefix=$${SAGE_ROOT}/local\n```\nthough I haven't [yet] encountered problems with the latter. (The `$$` has the same meaning as in Makefiles, i.e. escapes the `$` such that the resulting environment variable will be interpreted -- or substituted -- later, by the shell.)",
    "created_at": "2011-08-14T08:42:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11687#issuecomment-128904",
    "user": "https://github.com/nexttime"
}
```

We could also define (and export) `PKG_CONFIG_TOP_BUILD_DIR`, namely to `${SAGE_ROOT}/local`, and use

```
prefix=${pc_top_builddir}
```
or, a bit more flexible, define it to just `${SAGE_ROOT}` and use

```
prefix=${pc_top_builddir}/local
```
in all `pkg-config` (`*.pc`) files, which avoids wrapping `pkg-config` just to add `--define-variable=SAGE_ROOT="${SAGE_ROOT}"` to each invocation.

This is even safer than using

```
prefix=$${SAGE_ROOT}/local
```
though I haven't [yet] encountered problems with the latter. (The `$$` has the same meaning as in Makefiles, i.e. escapes the `$` such that the resulting environment variable will be interpreted -- or substituted -- later, by the shell.)



---

archive/issue_comments_128905.json:
```json
{
    "body": "Since there is already a lot of progress on #11021, can we finish that one off and have this ticket depend on that one?",
    "created_at": "2011-08-14T15:08:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11687#issuecomment-128905",
    "user": "https://github.com/jhpalmieri"
}
```

Since there is already a lot of progress on #11021, can we finish that one off and have this ticket depend on that one?



---

archive/issue_comments_128906.json:
```json
{
    "body": "Replying to [comment:4 jhpalmieri]:\n> Since there is already a lot of progress on #11021, can we finish that one off and have this ticket depend on that one?\n\n\nCurrently sorting out what to fix where and in which order.\n\n#11021 doesn't change much, and I intended to attach a couple of small patches to `sage-env` here for independent issues, so that they should all apply in almost random order, with just line numbers changing.\n\nWe can then leave out individual patches here in case other tickets already fix things.\n\n---\n\nI'll hopefully return to #11021 today and [try to] finish it, though I originally planned other things... ;-)",
    "created_at": "2011-08-14T15:54:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11687#issuecomment-128906",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:4 jhpalmieri]:
> Since there is already a lot of progress on #11021, can we finish that one off and have this ticket depend on that one?


Currently sorting out what to fix where and in which order.

#11021 doesn't change much, and I intended to attach a couple of small patches to `sage-env` here for independent issues, so that they should all apply in almost random order, with just line numbers changing.

We can then leave out individual patches here in case other tickets already fix things.

---

I'll hopefully return to #11021 today and [try to] finish it, though I originally planned other things... ;-)



---

archive/issue_comments_128907.json:
```json
{
    "body": "Replying to [comment:6 leif]:\n> Replying to [comment:4 jhpalmieri]:\n> > Since there is already a lot of progress on #11021, can we finish that one off and have this ticket depend on that one?\n\n> \n> Currently sorting out what to fix where and in which order.\n\n\nI think I'll also add `pkg-config`-related code *there* (to `sage-spkg`, right before `sage-make_relative` is called).",
    "created_at": "2011-08-14T17:39:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11687#issuecomment-128907",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:6 leif]:
> Replying to [comment:4 jhpalmieri]:
> > Since there is already a lot of progress on #11021, can we finish that one off and have this ticket depend on that one?

> 
> Currently sorting out what to fix where and in which order.


I think I'll also add `pkg-config`-related code *there* (to `sage-spkg`, right before `sage-make_relative` is called).



---

archive/issue_comments_128908.json:
```json
{
    "body": "Replying to [ticket:11687 leif]:\n>  * `BUILD` (used by `sage-spkg`) isn't exported, which wasn't really a problem until we started to (fully) source `sage-env` only once (#10469, cf. #11021 and #4949 for the impact on `sage-spkg`).\n\n\n#11765 adds a note on the necessity to always *export* variables in `sage-env`.\n\n\n\n\n>  * `PKG_CONFIG_PATH` is only changed if it is empty / undefined. We have to *prepend* `$SAGE_ROOT/local/lib/pkgconfig` in case it is not. (Cf. #11681, #11686; #10202).\n\n\nThis is now fixed by a small patch at #11765, currently needing review.",
    "created_at": "2011-08-31T18:19:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11687#issuecomment-128908",
    "user": "https://github.com/nexttime"
}
```

Replying to [ticket:11687 leif]:
>  * `BUILD` (used by `sage-spkg`) isn't exported, which wasn't really a problem until we started to (fully) source `sage-env` only once (#10469, cf. #11021 and #4949 for the impact on `sage-spkg`).


#11765 adds a note on the necessity to always *export* variables in `sage-env`.




>  * `PKG_CONFIG_PATH` is only changed if it is empty / undefined. We have to *prepend* `$SAGE_ROOT/local/lib/pkgconfig` in case it is not. (Cf. #11681, #11686; #10202).


This is now fixed by a small patch at #11765, currently needing review.



---

archive/issue_comments_128909.json:
```json
{
    "body": "Removed some points which is no longer relevant.",
    "created_at": "2012-03-22T10:41:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11687#issuecomment-128909",
    "user": "https://github.com/jdemeyer"
}
```

Removed some points which is no longer relevant.



---

archive/issue_comments_128910.json:
```json
{
    "body": "Replying to [comment:9 jdemeyer]:\n> Removed some points which is no longer relevant.\n\n\nI guess you meant \"are\". ;-)\n\nProgress!  (Although I'd just add \"Fixed by #.....\", so one immediately sees where something got fixed and whether the corresponding ticket is already merged, e.g. if a problem reappears.)",
    "created_at": "2012-03-22T11:32:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11687#issuecomment-128910",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:9 jdemeyer]:
> Removed some points which is no longer relevant.


I guess you meant "are". ;-)

Progress!  (Although I'd just add "Fixed by #.....", so one immediately sees where something got fixed and whether the corresponding ticket is already merged, e.g. if a problem reappears.)



---

archive/issue_comments_128911.json:
```json
{
    "body": "Changing priority from critical to minor.",
    "created_at": "2013-02-08T14:21:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11687#issuecomment-128911",
    "user": "https://github.com/jdemeyer"
}
```

Changing priority from critical to minor.



---

archive/issue_events_030694.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11687",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11687#event-30694"
}
```



---

archive/issue_comments_128912.json:
```json
{
    "body": "See #15652 for the `-fno-strict-aliasing` issue.",
    "created_at": "2014-01-09T10:25:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11687#issuecomment-128912",
    "user": "https://github.com/jdemeyer"
}
```

See #15652 for the `-fno-strict-aliasing` issue.



---

archive/issue_events_030695.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11687",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11687#event-30695"
}
```



---

archive/issue_events_030696.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11687",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11687#event-30696"
}
```



---

archive/issue_events_030697.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11687",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11687#event-30697"
}
```



---

archive/issue_events_030698.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11687",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11687#event-30698"
}
```



---

archive/issue_events_030699.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11687",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11687#event-30699"
}
```



---

archive/issue_events_030700.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11687",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11687#event-30700"
}
```



---

archive/issue_comments_128913.json:
```json
{
    "body": "Here is a first proposal, gathering the UNAME setting in one single place.\n\n---\nNew commits:",
    "created_at": "2014-10-21T12:57:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11687#issuecomment-128913",
    "user": "https://github.com/fchapoton"
}
```

Here is a first proposal, gathering the UNAME setting in one single place.

---
New commits:



---

archive/issue_comments_128914.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-10-21T12:57:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11687#issuecomment-128914",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_128915.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-10-21T12:59:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11687#issuecomment-128915",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_128916.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-12-09T20:52:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11687#issuecomment-128916",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_events_030701.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2015-06-17T13:58:43Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11687",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11687#event-30701"
}
```



---

archive/issue_events_030702.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2015-06-17T13:58:43Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11687",
    "milestone": "sage-6.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11687#event-30702"
}
```



---

archive/issue_comments_128917.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-06-17T14:42:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11687#issuecomment-128917",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_030703.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-06-18T17:57:54Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/11687",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11687#event-30703"
}
```



---

archive/issue_comments_128918.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-06-18T17:57:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11687#issuecomment-128918",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
