# Issue 11232: we should not build patch on Cygwin on Windows 7

archive/issues_011060.json:
```json
{
    "body": "On Windows 7 an executable named patch.exe will not run (UAC prevents this), unless\nit is accompanied by patch.exe.manifest.\nSee\nhttp://cygwin.com/ml/cygwin/2009-03/msg00010.html\n\nSo we just should not build it there, and use the Cygwin's patch instead. \nI hope Cygwin's native 2.5.8 patch is good enough.\n\nThe modified patch spkg is here:\n\n[http://boxen.math.washington.edu/home/jdemeyer/spkg/patch-2.5.9.p2.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/patch-2.5.9.p2.spkg)\n\n(tested on Linux and on Win 7 with and without patch installed)\n\n\nAssignee: tbd\n\nCC:  drkirkby\n\nReviewer: David Kirkby, Karl-Dieter Crisman\n\nAuthor: Dima Pasechnik\n\nMerged: sage-4.7.2.alpha0\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/11232\n\n",
    "closed_at": "2011-07-22T12:50:33Z",
    "created_at": "2011-04-21T13:31:34Z",
    "labels": [
        "component: porting: cygwin",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.7.2",
    "title": "we should not build patch on Cygwin on Windows 7",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11232",
    "user": "https://github.com/dimpase"
}
```
On Windows 7 an executable named patch.exe will not run (UAC prevents this), unless
it is accompanied by patch.exe.manifest.
See
http://cygwin.com/ml/cygwin/2009-03/msg00010.html

So we just should not build it there, and use the Cygwin's patch instead. 
I hope Cygwin's native 2.5.8 patch is good enough.

The modified patch spkg is here:

[http://boxen.math.washington.edu/home/jdemeyer/spkg/patch-2.5.9.p2.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/patch-2.5.9.p2.spkg)

(tested on Linux and on Win 7 with and without patch installed)


Assignee: tbd

CC:  drkirkby

Reviewer: David Kirkby, Karl-Dieter Crisman

Author: Dima Pasechnik

Merged: sage-4.7.2.alpha0

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/11232





---

archive/issue_comments_126731.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -4,6 +4,7 @@\n http://cygwin.com/ml/cygwin/2009-03/msg00010.html\n \n So we just should not build it there, and use the Cygwin's patch instead. I'll post a patch for patch spkg here later today.\n+I hope Cygwin's native 2.5.8 patch is good enough.\n \n Comment: 1\n \n``````\n",
    "created_at": "2011-04-21T14:03:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11232#issuecomment-126731",
    "user": "https://github.com/dimpase"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -4,6 +4,7 @@
 http://cygwin.com/ml/cygwin/2009-03/msg00010.html
 
 So we just should not build it there, and use the Cygwin's patch instead. I'll post a patch for patch spkg here later today.
+I hope Cygwin's native 2.5.8 patch is good enough.
 
 Comment: 1
 
``````




---

archive/issue_comments_126732.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,15 @@\n+On Windows 7 an executable named patch.exe will not run (UAC prevents this), unless\n+it is accompanied by patch.exe.manifest.\n+See\n+http://cygwin.com/ml/cygwin/2009-03/msg00010.html\n+\n+So we just should not build it there, and use the Cygwin's patch instead. \n+I hope Cygwin's native 2.5.8 patch is good enough.\n+\n+The modified patch spkg is here:\n+http://boxen.math.washington.edu/home/dima/packages/patch-2.5.9.p1.spkg\n+\n+(tested on Linux and on Win 7 with and without patch installed)\n \n \n Comment: 1\n``````\n",
    "created_at": "2011-04-21T16:51:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11232#issuecomment-126732",
    "user": "https://github.com/dimpase"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,15 @@
+On Windows 7 an executable named patch.exe will not run (UAC prevents this), unless
+it is accompanied by patch.exe.manifest.
+See
+http://cygwin.com/ml/cygwin/2009-03/msg00010.html
+
+So we just should not build it there, and use the Cygwin's patch instead. 
+I hope Cygwin's native 2.5.8 patch is good enough.
+
+The modified patch spkg is here:
+http://boxen.math.washington.edu/home/dima/packages/patch-2.5.9.p1.spkg
+
+(tested on Linux and on Win 7 with and without patch installed)
 
 
 Comment: 1
``````




---

archive/issue_comments_126733.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-04-21T16:51:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11232#issuecomment-126733",
    "user": "https://github.com/dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_126734.json:
```json
{
    "body": "<a id='comment:3'></a>The test is not working. I changed it a little, so it worked on Solaris instead of Cygwin. My changes are:\n\n```\nif [ \"x$UNAME\" = xSunOS ] ; then\n   if ! patch --version | grep >/dev/null 'patch '; then\n      echo \"On Cygwin you must have patch installed\"\n      echo \"via the Cygwin setup.exe program\"\n      exit 1\n   fi\n   exit 0\nfi\n```\n\nthen I created a script called 'patch', which just echos \"foo\"\n\n```\ndrkirkby@laptop:~/patch-2.5.9.p1$ patch\nfoo\n```\n\nNow when I run spkg-install, it does not detect I don't have a usable 'patch; command:\n\n```\ndrkirkby@laptop:~/patch-2.5.9.p1$ ./spkg-install\nSAGE_LOCAL undefined ... exiting\nMaybe run 'sage -sh'?\ndrkirkby@laptop:~/patch-2.5.9.p1$ \n```\n\nThere's no message I need to install patch. \n\nI'm not sure exactly what you are trying to achieve here - this is not the way I would write a test. But the exit code of grep should be 0 in the case of a match and non-zero for the case of no match or an error. \n\nI would also suggest putting the test to see if 'SAGE_ROOT' is set at the top, as it is with every other package. \n\nA better place to check for the existence of 'patch' is actually in the prereq script, as we should let users know as soon as possible if their system needs extra things installed. \n\nDave",
    "created_at": "2011-04-21T18:59:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11232#issuecomment-126734",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

<a id='comment:3'></a>The test is not working. I changed it a little, so it worked on Solaris instead of Cygwin. My changes are:

```
if [ "x$UNAME" = xSunOS ] ; then
   if ! patch --version | grep >/dev/null 'patch '; then
      echo "On Cygwin you must have patch installed"
      echo "via the Cygwin setup.exe program"
      exit 1
   fi
   exit 0
fi
```

then I created a script called 'patch', which just echos "foo"

```
drkirkby@laptop:~/patch-2.5.9.p1$ patch
foo
```

Now when I run spkg-install, it does not detect I don't have a usable 'patch; command:

```
drkirkby@laptop:~/patch-2.5.9.p1$ ./spkg-install
SAGE_LOCAL undefined ... exiting
Maybe run 'sage -sh'?
drkirkby@laptop:~/patch-2.5.9.p1$ 
```

There's no message I need to install patch. 

I'm not sure exactly what you are trying to achieve here - this is not the way I would write a test. But the exit code of grep should be 0 in the case of a match and non-zero for the case of no match or an error. 

I would also suggest putting the test to see if 'SAGE_ROOT' is set at the top, as it is with every other package. 

A better place to check for the existence of 'patch' is actually in the prereq script, as we should let users know as soon as possible if their system needs extra things installed. 

Dave



---

archive/issue_comments_126735.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-04-21T18:59:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11232#issuecomment-126735",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_126736.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-04-22T02:19:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11232#issuecomment-126736",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_126737.json:
```json
{
    "body": "<a id='comment:4'></a>Replying to [comment:3 drkirkby]:\n\nOK, I've updated the spkg-install in the spkg (same location) to do the test on the existence of SAGE_ROOT first.\n\nThe logic of the CYGWIN-specific test is that it runs 'patch --version' and exits with 1 if the output\ndoes not contain 'patch '; otherwise, it exits with 0.\nThis test is shamelessly stolen from the bottom of spkg-install, where it tests for the version (I only removed the version part).",
    "created_at": "2011-04-22T02:19:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11232#issuecomment-126737",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:4'></a>Replying to [comment:3 drkirkby]:

OK, I've updated the spkg-install in the spkg (same location) to do the test on the existence of SAGE_ROOT first.

The logic of the CYGWIN-specific test is that it runs 'patch --version' and exits with 1 if the output
does not contain 'patch '; otherwise, it exits with 0.
This test is shamelessly stolen from the bottom of spkg-install, where it tests for the version (I only removed the version part).



---

archive/issue_comments_126738.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:4 dimpase]:\n> Replying to [comment:3 drkirkby]:\n> \n\n\nreasons for actually trying to run patch, not only testing for existence, are obvious --- it tests more (especially given that nasty UAC \"manifest\" stuff). I did not put it into prereq, as other packages like this (e.g. Atlas) do it this way, too, so I merely conform to what is already done.",
    "created_at": "2011-04-22T04:49:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11232#issuecomment-126738",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:5'></a>Replying to [comment:4 dimpase]:
> Replying to [comment:3 drkirkby]:
> 


reasons for actually trying to run patch, not only testing for existence, are obvious --- it tests more (especially given that nasty UAC "manifest" stuff). I did not put it into prereq, as other packages like this (e.g. Atlas) do it this way, too, so I merely conform to what is already done.



---

archive/issue_comments_126739.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2011-04-22T10:21:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11232#issuecomment-126739",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_126740.json:
```json
{
    "body": "<a id='comment:6'></a>If Cygwin needs *patch* installed this should be checked early on. We test that a Fortran compiler exists well before we start to use it. Why should *patch* be any different? \n\nExiting on Cygwin is sensible if there' no need to install *patch*, but testing if the program exists should in my opinion be done much earlier on. I believe the way to do that is probably to use `AC_CHECK_PROG` in the 'prereq' part of Sage. \n\nAlso note running *patch* with no arguments will leave it there sitting for input. \n\nWould it not be better to install *patch.exe.manifest* from \n\nhttp://cygwin.com/ml/cygwin/2009-03/msg00010.html\n\n? Then we could install *patch* the same way as any other program, and know it behaves the same, as we have the same version. \n\nSomething along the lines of \n\n```\nif [ \"x$UNAME\" = xCYGWIN ] ; then\n  cp patches/patch.exe.manifest \"$SAGE_LOCAL/bin\"\nfi\n```\n\nCan you attach a Mercurial patch for review purposes, so we can see what you are trying to do. The ticket is much more informative if it has the changes attached. \n\nDave",
    "created_at": "2011-04-22T10:21:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11232#issuecomment-126740",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

<a id='comment:6'></a>If Cygwin needs *patch* installed this should be checked early on. We test that a Fortran compiler exists well before we start to use it. Why should *patch* be any different? 

Exiting on Cygwin is sensible if there' no need to install *patch*, but testing if the program exists should in my opinion be done much earlier on. I believe the way to do that is probably to use `AC_CHECK_PROG` in the 'prereq' part of Sage. 

Also note running *patch* with no arguments will leave it there sitting for input. 

Would it not be better to install *patch.exe.manifest* from 

http://cygwin.com/ml/cygwin/2009-03/msg00010.html

? Then we could install *patch* the same way as any other program, and know it behaves the same, as we have the same version. 

Something along the lines of 

```
if [ "x$UNAME" = xCYGWIN ] ; then
  cp patches/patch.exe.manifest "$SAGE_LOCAL/bin"
fi
```

Can you attach a Mercurial patch for review purposes, so we can see what you are trying to do. The ticket is much more informative if it has the changes attached. 

Dave



---

archive/issue_comments_126741.json:
```json
{
    "body": "<a id='comment:7'></a>BTW, \n\nhttp://cygwin.com/ml/cygwin/2009-03/msg00034.html\n\nsays \"The latest patch package 2.5.8-9 comes already with a manifest file.\"\n\nIt seems to me the method proposed here is far from optimal. \n\nDave",
    "created_at": "2011-04-22T10:27:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11232#issuecomment-126741",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

<a id='comment:7'></a>BTW, 

http://cygwin.com/ml/cygwin/2009-03/msg00034.html

says "The latest patch package 2.5.8-9 comes already with a manifest file."

It seems to me the method proposed here is far from optimal. 

Dave



---

archive/issue_comments_126742.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2011-04-22T10:27:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11232#issuecomment-126742",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_comments_126743.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:7 drkirkby]:\n> BTW, \n> \n> http://cygwin.com/ml/cygwin/2009-03/msg00034.html\n> \n> says \"The latest patch package 2.5.8-9 comes already with a manifest file.\"\n> \n> It seems to me the method proposed here is far from optimal. \n\n\nI wasted few hours yesterday trying this path. It is NOT merely copying an extra file somewhere. One has to use a Microsoft installer to cook up this \"security exception\", or an equivalent convoluted procedure requiring editing the registry and god knows what else (reading MS documentation on this stuff makes your head spin...)\n\n\n\n\n> \n> Dave",
    "created_at": "2011-04-22T10:54:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11232#issuecomment-126743",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:8'></a>Replying to [comment:7 drkirkby]:
> BTW, 
> 
> http://cygwin.com/ml/cygwin/2009-03/msg00034.html
> 
> says "The latest patch package 2.5.8-9 comes already with a manifest file."
> 
> It seems to me the method proposed here is far from optimal. 


I wasted few hours yesterday trying this path. It is NOT merely copying an extra file somewhere. One has to use a Microsoft installer to cook up this "security exception", or an equivalent convoluted procedure requiring editing the registry and god knows what else (reading MS documentation on this stuff makes your head spin...)




> 
> Dave



---

archive/issue_comments_126744.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:6 drkirkby]:\n> If Cygwin needs *patch* installed this should be checked early on. We test that a Fortran compiler exists well before we start to use it. Why should *patch* be any different? \n\n\nwhy should patch be different from Atlas? I went the way it was done for Atlas.\nOK, there is an inconsistency in design here, as you point out, \nbut it's a minor and fixable one---if one has plenty of time and a Windows machine at hand to test things. But the gain would be small.\n\n> \n> Exiting on Cygwin is sensible if there' no need to install *patch*, but testing if the program exists should in my opinion be done much earlier on. I believe the way to do that is probably to use `AC_CHECK_PROG` in the 'prereq' part of Sage. \n> \n> Also note running *patch* with no arguments will leave it there sitting for input. \n\n\nwell, yes, it would. Hence there is an argument...\n\n\n> Can you attach a Mercurial patch for review purposes, so we can see what you are trying to do. The ticket is much more informative if it has the changes attached. \n\n\nif you untar the spkg file and do \n\n```\nhg diff -r3:6\n```\n\nyou will see the difference. Do we need to post perfectly reproducible things like this here?",
    "created_at": "2011-04-22T11:06:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11232#issuecomment-126744",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:9'></a>Replying to [comment:6 drkirkby]:
> If Cygwin needs *patch* installed this should be checked early on. We test that a Fortran compiler exists well before we start to use it. Why should *patch* be any different? 


why should patch be different from Atlas? I went the way it was done for Atlas.
OK, there is an inconsistency in design here, as you point out, 
but it's a minor and fixable one---if one has plenty of time and a Windows machine at hand to test things. But the gain would be small.

> 
> Exiting on Cygwin is sensible if there' no need to install *patch*, but testing if the program exists should in my opinion be done much earlier on. I believe the way to do that is probably to use `AC_CHECK_PROG` in the 'prereq' part of Sage. 
> 
> Also note running *patch* with no arguments will leave it there sitting for input. 


well, yes, it would. Hence there is an argument...


> Can you attach a Mercurial patch for review purposes, so we can see what you are trying to do. The ticket is much more informative if it has the changes attached. 


if you untar the spkg file and do 

```
hg diff -r3:6
```

you will see the difference. Do we need to post perfectly reproducible things like this here?



---

archive/issue_comments_126745.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-04-22T11:06:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11232#issuecomment-126745",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_126746.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:9 dimpase]:\n> Replying to [comment:6 drkirkby]:\n> > If Cygwin needs *patch* installed this should be checked early on. We test that a Fortran compiler exists well before we start to use it. Why should *patch* be any different? \n\n> \n> why should patch be different from Atlas? \n\n\nBecause the ATLAS method is incorrect. That's a good enough reason for me. Two wrongs don't make a right. \n\nThe ATLAS spkg-install happens to be very poor in many respects. It is a very small Python script that calls a large bash script. I don't think we should use ATLAS as a model. \n\n> I went the way it was done for Atlas.\n\n\nNumerous tests for programs are performed - gcc, g++, gfortran, m4, bash. There's a test for the maths library too. All these checks for prerequisites are done at the start. Just because one package happens to do it the wrong way, does not mean we should copy that. \n\n> OK, there is an inconsistency in design here, as you point out, \n> but it's a minor and fixable one---if one has plenty of time and a Windows machine at hand to test things. But the gain would be small.\n\n\nIf it's minor and fixable is should be fixed. I don't think its a good idea to let a build progress any further than necessary if it is obvious it is going to fail. \n\n> > Exiting on Cygwin is sensible if there' no need to install *patch*, but testing if the program exists should in my opinion be done much earlier on. I believe the way to do that is probably to use `AC_CHECK_PROG` in the 'prereq' part of Sage. \n> > \n> > Also note running *patch* with no arguments will leave it there sitting for input. \n\n> \n> well, yes, it would. Hence there is an argument...\n\n\n> > Can you attach a Mercurial patch for review purposes, so we can see what you are trying to do. The ticket is much more informative if it has the changes attached. \n\n> \n> if you untar the spkg file and do \n> \n> ```\n> hg diff -r3:6\n> ```\n> \n> you will see the difference. Do we need to post perfectly reproducible things like this here?\n\n\nWell 99% of people do attach patches, which makes review a lot easier. It also leaves a record for others to see what is proposed and why specific solutions were rejected. \n\nAnyway, I'm not happy with this approach to solving an issue with *patch*, when it's clear there are better ways that don't copy a method that's clearly flawed. I'm not going to put it back to \"needs_work\" again, as clearly you feel differently. You might find another reviewer who is happy with this method. \n\nDave",
    "created_at": "2011-04-22T12:02:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11232#issuecomment-126746",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

<a id='comment:10'></a>Replying to [comment:9 dimpase]:
> Replying to [comment:6 drkirkby]:
> > If Cygwin needs *patch* installed this should be checked early on. We test that a Fortran compiler exists well before we start to use it. Why should *patch* be any different? 

> 
> why should patch be different from Atlas? 


Because the ATLAS method is incorrect. That's a good enough reason for me. Two wrongs don't make a right. 

The ATLAS spkg-install happens to be very poor in many respects. It is a very small Python script that calls a large bash script. I don't think we should use ATLAS as a model. 

> I went the way it was done for Atlas.


Numerous tests for programs are performed - gcc, g++, gfortran, m4, bash. There's a test for the maths library too. All these checks for prerequisites are done at the start. Just because one package happens to do it the wrong way, does not mean we should copy that. 

> OK, there is an inconsistency in design here, as you point out, 
> but it's a minor and fixable one---if one has plenty of time and a Windows machine at hand to test things. But the gain would be small.


If it's minor and fixable is should be fixed. I don't think its a good idea to let a build progress any further than necessary if it is obvious it is going to fail. 

> > Exiting on Cygwin is sensible if there' no need to install *patch*, but testing if the program exists should in my opinion be done much earlier on. I believe the way to do that is probably to use `AC_CHECK_PROG` in the 'prereq' part of Sage. 
> > 
> > Also note running *patch* with no arguments will leave it there sitting for input. 

> 
> well, yes, it would. Hence there is an argument...


> > Can you attach a Mercurial patch for review purposes, so we can see what you are trying to do. The ticket is much more informative if it has the changes attached. 

> 
> if you untar the spkg file and do 
> 
> ```
> hg diff -r3:6
> ```
> 
> you will see the difference. Do we need to post perfectly reproducible things like this here?


Well 99% of people do attach patches, which makes review a lot easier. It also leaves a record for others to see what is proposed and why specific solutions were rejected. 

Anyway, I'm not happy with this approach to solving an issue with *patch*, when it's clear there are better ways that don't copy a method that's clearly flawed. I'm not going to put it back to "needs_work" again, as clearly you feel differently. You might find another reviewer who is happy with this method. 

Dave



---

archive/issue_comments_126747.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:10 drkirkby]:\nOne reason to have this patch in anyway is that with the current build system it is perfectly possible to install the patch spkg after the build is done (sage-spkg does not check prereqs). And the absence of the current patch to the patch spkg would create a problem, as the Sage's patch will break.\n\nThis is a general weakness of the Sage build system, that also manifests elsewhere (e.g. it's possible to nuke any standard package this way, if there is an optional package of the same name, e.g. GLPK is an example).\nBut this needs another ticket.",
    "created_at": "2011-04-24T11:59:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11232#issuecomment-126747",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:11'></a>Replying to [comment:10 drkirkby]:
One reason to have this patch in anyway is that with the current build system it is perfectly possible to install the patch spkg after the build is done (sage-spkg does not check prereqs). And the absence of the current patch to the patch spkg would create a problem, as the Sage's patch will break.

This is a general weakness of the Sage build system, that also manifests elsewhere (e.g. it's possible to nuke any standard package this way, if there is an optional package of the same name, e.g. GLPK is an example).
But this needs another ticket.



---

archive/issue_comments_126748.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:11 dimpase]:\n> Replying to [comment:10 drkirkby]:\n> One reason to have this patch in anyway is that with the current build system it is perfectly possible to install the patch spkg after the build is done (sage-spkg does not check prereqs). And the absence of the current patch to the patch spkg would create a problem, as the Sage's patch will break.\n\n\nYes, it is possible to do that. But normally one would type \"make\" and let it do the work. If you manually install items in an abnormal order, you should either know what you are doing or expect a failed installation. \n\n> This is a general weakness of the Sage build system, that also manifests elsewhere (e.g. it's possible to nuke any standard package this way, if there is an optional package of the same name, e.g. GLPK is an example).\n> But this needs another ticket.\n\n\nWell, it's just crazy we have an old optional package with the same name is a current one in Sage. But that's an entirely different issue. I have created a ticket for that - #11247. \n\nIf someone wants to screw up their Sage build it is not hard (I've done it myself), but we should try to prevent it as much as possible. Hence checking they have the right perquisites should be done at the start of the build process.",
    "created_at": "2011-04-24T17:39:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11232#issuecomment-126748",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

<a id='comment:12'></a>Replying to [comment:11 dimpase]:
> Replying to [comment:10 drkirkby]:
> One reason to have this patch in anyway is that with the current build system it is perfectly possible to install the patch spkg after the build is done (sage-spkg does not check prereqs). And the absence of the current patch to the patch spkg would create a problem, as the Sage's patch will break.


Yes, it is possible to do that. But normally one would type "make" and let it do the work. If you manually install items in an abnormal order, you should either know what you are doing or expect a failed installation. 

> This is a general weakness of the Sage build system, that also manifests elsewhere (e.g. it's possible to nuke any standard package this way, if there is an optional package of the same name, e.g. GLPK is an example).
> But this needs another ticket.


Well, it's just crazy we have an old optional package with the same name is a current one in Sage. But that's an entirely different issue. I have created a ticket for that - #11247. 

If someone wants to screw up their Sage build it is not hard (I've done it myself), but we should try to prevent it as much as possible. Hence checking they have the right perquisites should be done at the start of the build process.



---

archive/issue_comments_126749.json:
```json
{
    "body": "<a id='comment:13'></a>I want to point out that the patch spkg is a prerequisite of almost every other spkg, so practically, anything in its spkg-install script will happen very early in the installation procedure.  I think that if we are requiring \"patch\" to be installed on cygwin, then it should be mentioned in the Cygwin section of the installation guide (#11237).",
    "created_at": "2011-04-25T19:46:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11232#issuecomment-126749",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:13'></a>I want to point out that the patch spkg is a prerequisite of almost every other spkg, so practically, anything in its spkg-install script will happen very early in the installation procedure.  I think that if we are requiring "patch" to be installed on cygwin, then it should be mentioned in the Cygwin section of the installation guide (#11237).



---

archive/issue_comments_126750.json:
```json
{
    "body": "<a id='comment:14'></a>One reasonable option is to check if the file '`/usr/bin/patch`' exists on Cygwin. Checking if the file exists does not need it to be executed, so I assume that Windows 7 will not object. \n\nAlthough I've not tested this, adding something like these 4 lines\n\n```\nif [ \"x`uname | sed 's/WIN.\\+/WIN/'`\" = xCYGWIN ] && [ ! -f /usr/bin/patch ] ; then\n   echo \"On Cygwin one must 'patch' on Cygwin fist. Do it by ...\"\n   exit 1\nfi\n```\n\nto the script `$SAGE_ROOT/spkg/base/prereq-0.8-install` would allow one to check if patch is installed early on, before we start building .spkg's. \n\nThe steps to that would be something like:\n\n* Add the above 4 lines to `$SAGE_ROOT/spkg/base/prereq-0.8-install`\n* Change the 10<sup>th</sup> line of `$SAGE_ROOT/spkg/base/prereq-0.8-install` to be '`TARGET=prereq-0.9`'\n* Rename `$SAGE_ROOT/spkg/base/prereq-0.8-install` to `spkg/base/prereq-0.9-install`\n* extract the tar file prereq-0.8.tar\n* rename the directory {{$SAGE_ROOT/spkg/base/prereq-0.8}}} to {{$SAGE_ROOT/spkg/base/prereq-0.9}}}\n* Create the tar file  {{$SAGE_ROOT/spkg/base/prereq-0.9.tar}}} by just taring up {{$SAGE_ROOT/spkg/base/prereq-0.9}}}\n* Remove {{$SAGE_ROOT/spkg/base/prereq-0.8.tar}}} (that file is not under revision control). \n\nIf that was done, there would be an early test for 'patch'.\n\nIn that case, patch-2.5.9.p1.spkg would just need to exit with an exit code of 0 on Cygwin.\n\nDoes that sound sensible? I don't think its as good as building patch, but might be easier to implement. \n\nAs John says, the documentation would need to document this, but that can be added on another ticket. \n\nAs long as the updated .spkg and the changes to `$SAGE_ROOT/spkg/base/prereq-0.9-install` were merged together, I think that is a reasonable compromise. \n\nWhatever changes are made, please attach a patch to the ticket so we can see what is being done. \n\nDave",
    "created_at": "2011-04-25T21:23:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11232#issuecomment-126750",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

<a id='comment:14'></a>One reasonable option is to check if the file '`/usr/bin/patch`' exists on Cygwin. Checking if the file exists does not need it to be executed, so I assume that Windows 7 will not object. 

Although I've not tested this, adding something like these 4 lines

```
if [ "x`uname | sed 's/WIN.\+/WIN/'`" = xCYGWIN ] && [ ! -f /usr/bin/patch ] ; then
   echo "On Cygwin one must 'patch' on Cygwin fist. Do it by ..."
   exit 1
fi
```

to the script `$SAGE_ROOT/spkg/base/prereq-0.8-install` would allow one to check if patch is installed early on, before we start building .spkg's. 

The steps to that would be something like:

* Add the above 4 lines to `$SAGE_ROOT/spkg/base/prereq-0.8-install`
* Change the 10<sup>th</sup> line of `$SAGE_ROOT/spkg/base/prereq-0.8-install` to be '`TARGET=prereq-0.9`'
* Rename `$SAGE_ROOT/spkg/base/prereq-0.8-install` to `spkg/base/prereq-0.9-install`
* extract the tar file prereq-0.8.tar
* rename the directory {{$SAGE_ROOT/spkg/base/prereq-0.8}}} to {{$SAGE_ROOT/spkg/base/prereq-0.9}}}
* Create the tar file  {{$SAGE_ROOT/spkg/base/prereq-0.9.tar}}} by just taring up {{$SAGE_ROOT/spkg/base/prereq-0.9}}}
* Remove {{$SAGE_ROOT/spkg/base/prereq-0.8.tar}}} (that file is not under revision control). 

If that was done, there would be an early test for 'patch'.

In that case, patch-2.5.9.p1.spkg would just need to exit with an exit code of 0 on Cygwin.

Does that sound sensible? I don't think its as good as building patch, but might be easier to implement. 

As John says, the documentation would need to document this, but that can be added on another ticket. 

As long as the updated .spkg and the changes to `$SAGE_ROOT/spkg/base/prereq-0.9-install` were merged together, I think that is a reasonable compromise. 

Whatever changes are made, please attach a patch to the ticket so we can see what is being done. 

Dave



---

archive/issue_comments_126751.json:
```json
{
    "body": "<a id='comment:15'></a>This is only a problem on Windows 7, as far as we can tell.",
    "created_at": "2011-06-15T23:54:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11232#issuecomment-126751",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:15'></a>This is only a problem on Windows 7, as far as we can tell.



---

archive/issue_comments_126752.json:
```json
{
    "body": "For review purposes only",
    "created_at": "2011-06-22T16:52:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11232#issuecomment-126752",
    "user": "https://github.com/kcrisman"
}
```

For review purposes only



---

archive/issue_comments_126753.json:
```json
{
    "body": "<a id='comment:16'></a>Attachment [11232-diff.patch](tarball://root/attachments/some-uuid/ticket11232/11232-diff.patch) by @kcrisman created at 2011-06-22 16:53:01",
    "created_at": "2011-06-22T16:53:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11232#issuecomment-126753",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:16'></a>Attachment [11232-diff.patch](tarball://root/attachments/some-uuid/ticket11232/11232-diff.patch) by @kcrisman created at 2011-06-22 16:53:01



---

archive/issue_comments_126754.json:
```json
{
    "body": "<a id='comment:17'></a>Sage builds on Cygwin on XP (where it wasn't a problem, however, so we'd need to require patch on all Cygwins) with this spkg, and appears to be building (currently well in, at gsl) on Win 7 with this spkg.  \n\nI'm pretty sure that patch is used on packages before that, n'est pas?  Given David's comments and the evident nature of the patch to only affect Cygwin, I'd say this is ready for positive review as longa s we can confirm that.  Or if my build makes it even further :)",
    "created_at": "2011-06-27T20:55:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11232#issuecomment-126754",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:17'></a>Sage builds on Cygwin on XP (where it wasn't a problem, however, so we'd need to require patch on all Cygwins) with this spkg, and appears to be building (currently well in, at gsl) on Win 7 with this spkg.  

I'm pretty sure that patch is used on packages before that, n'est pas?  Given David's comments and the evident nature of the patch to only affect Cygwin, I'd say this is ready for positive review as longa s we can confirm that.  Or if my build makes it even further :)



---

archive/issue_comments_126755.json:
```json
{
    "body": "<a id='comment:18'></a>The build made it all the way.  This is Cygwin-only.  We will add patch to the list of needs at [the wiki](CygwinPort) and then add all of those things to prereq when Cygwin is actually supported.  This seems like a good work flow, that allows continuing unburdened work on the Cygwin port while recognizing that all prerequisites should be found for supported platforms.",
    "created_at": "2011-06-28T18:17:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11232#issuecomment-126755",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:18'></a>The build made it all the way.  This is Cygwin-only.  We will add patch to the list of needs at [the wiki](CygwinPort) and then add all of those things to prereq when Cygwin is actually supported.  This seems like a good work flow, that allows continuing unburdened work on the Cygwin port while recognizing that all prerequisites should be found for supported platforms.



---

archive/issue_comments_126756.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-06-28T18:17:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11232#issuecomment-126756",
    "user": "https://github.com/kcrisman"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_029087.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-07-03T11:21:29Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "milestone": "sage-4.7.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11232#event-29087"
}
```



---

archive/issue_events_029088.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-07-22T12:50:33Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11232#event-29088"
}
```



---

archive/issue_comments_126757.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-07-22T12:50:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11232#issuecomment-126757",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_126758.json:
```json
{
    "body": "<a id='comment:21'></a>New spkg with all files owner-writable: [http://boxen.math.washington.edu/home/jdemeyer/spkg/patch-2.5.9.p2.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/patch-2.5.9.p2.spkg)",
    "created_at": "2011-08-16T09:34:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11232#issuecomment-126758",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'></a>New spkg with all files owner-writable: [http://boxen.math.washington.edu/home/jdemeyer/spkg/patch-2.5.9.p2.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/patch-2.5.9.p2.spkg)



---

archive/issue_comments_126759.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,16 @@\n+On Windows 7 an executable named patch.exe will not run (UAC prevents this), unless\n+it is accompanied by patch.exe.manifest.\n+See\n+http://cygwin.com/ml/cygwin/2009-03/msg00010.html\n+\n+So we just should not build it there, and use the Cygwin's patch instead. \n+I hope Cygwin's native 2.5.8 patch is good enough.\n+\n+The modified patch spkg is here:\n+\n+[http://boxen.math.washington.edu/home/jdemeyer/spkg/patch-2.5.9.p2.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/patch-2.5.9.p2.spkg)\n+\n+(tested on Linux and on Win 7 with and without patch installed)\n \n \n Comment: 1\n``````\n",
    "created_at": "2011-08-16T09:34:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11232#issuecomment-126759",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,16 @@
+On Windows 7 an executable named patch.exe will not run (UAC prevents this), unless
+it is accompanied by patch.exe.manifest.
+See
+http://cygwin.com/ml/cygwin/2009-03/msg00010.html
+
+So we just should not build it there, and use the Cygwin's patch instead. 
+I hope Cygwin's native 2.5.8 patch is good enough.
+
+The modified patch spkg is here:
+
+[http://boxen.math.washington.edu/home/jdemeyer/spkg/patch-2.5.9.p2.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/patch-2.5.9.p2.spkg)
+
+(tested on Linux and on Win 7 with and without patch installed)
 
 
 Comment: 1
``````




---

archive/issue_comments_126760.json:
```json
{
    "body": "<a id='comment:22'></a>I think the right solution here would have been to install a patch.exe.manifest file, but I'll implement that in a later ticket.",
    "created_at": "2012-12-19T11:24:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11232#issuecomment-126760",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:22'></a>I think the right solution here would have been to install a patch.exe.manifest file, but I'll implement that in a later ticket.



---

archive/issue_comments_126761.json:
```json
{
    "body": "<a id='comment:23'></a>Replying to [comment:22 jpflori]:\n> I think the right solution here would have been to install a patch.exe.manifest file, but I'll implement that in a later ticket.\n\nI cannot resist quoting my own comment above:\n\n* It is NOT merely copying an extra file somewhere. One has to use a Microsoft installer to cook up this \"security exception\", or an equivalent convoluted procedure requiring editing the registry and god knows what else (reading MS documentation on this stuff makes your head spin...)\n\nIn short, I don't see a point, as one can just use `patch` from `cygwin` instead.",
    "created_at": "2012-12-19T11:43:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11232#issuecomment-126761",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:23'></a>Replying to [comment:22 jpflori]:
> I think the right solution here would have been to install a patch.exe.manifest file, but I'll implement that in a later ticket.

I cannot resist quoting my own comment above:

* It is NOT merely copying an extra file somewhere. One has to use a Microsoft installer to cook up this "security exception", or an equivalent convoluted procedure requiring editing the registry and god knows what else (reading MS documentation on this stuff makes your head spin...)

In short, I don't see a point, as one can just use `patch` from `cygwin` instead.



---

archive/issue_comments_126762.json:
```json
{
    "body": "<a id='comment:24'></a>On my system just copying a manifest file is enough.",
    "created_at": "2012-12-19T11:48:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11232#issuecomment-126762",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:24'></a>On my system just copying a manifest file is enough.



---

archive/issue_comments_126763.json:
```json
{
    "body": "<a id='comment:25'></a>(And that is exactly what Cygwin does for its own patch IIRC.)",
    "created_at": "2012-12-19T11:48:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11232#issuecomment-126763",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:25'></a>(And that is exactly what Cygwin does for its own patch IIRC.)



---

archive/issue_comments_126764.json:
```json
{
    "body": "<a id='comment:26'></a>Replying to [comment:25 jpflori]:\n> (And that is exactly what Cygwin does for its own patch IIRC.)\n\nIt was not enough when I tried this; it might depend upon the Windows version (enterprise/business/home/leisure/recreation :-)), type of account, position of the planets, servicepack level, etc etc etc. \nI don't think we need to reinvent the wheel by not using what Cygwin provides. \n\nIt could also be that if you have one patch.exe installed somewhere, and try to install another one, then you are in trouble...",
    "created_at": "2012-12-19T12:14:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11232#issuecomment-126764",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:26'></a>Replying to [comment:25 jpflori]:
> (And that is exactly what Cygwin does for its own patch IIRC.)

It was not enough when I tried this; it might depend upon the Windows version (enterprise/business/home/leisure/recreation :-)), type of account, position of the planets, servicepack level, etc etc etc. 
I don't think we need to reinvent the wheel by not using what Cygwin provides. 

It could also be that if you have one patch.exe installed somewhere, and try to install another one, then you are in trouble...



---

archive/issue_comments_126765.json:
```json
{
    "body": "<a id='comment:27'></a>A subtility we encountered we Jeroen was that the manifest file had to be executable.",
    "created_at": "2012-12-19T12:41:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11232",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11232#issuecomment-126765",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:27'></a>A subtility we encountered we Jeroen was that the manifest file had to be executable.
