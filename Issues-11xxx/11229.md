# Issue 11229: magma mode in 4.7 notebook broken

archive/issues_011229.json:
```json
{
    "body": "Keywords: magma notebook interface\n\nSee also \n[this sage-devel thread](https://groups.google.com/group/sage-devel/browse_thread/thread/b47e2be73baa9703/5f8fedf0fbbaddc0?hl=en%05f8fedf0fbbaddc0)\n\nIt seems that magma mode in the 4.7 notebook is broken. I observed the following session after verifying John Cremona's report about syncing problems. I suspect sync is lost due to the multiple commands. Note that none of the print commands seem to get executed (no output is observed) and that for \"print 7;\" the line \"print 6;\" gets echoed (this has probably very little to do with the \"print 7;\" command itself)\n\n```\na:=1;\nb:=2;\nc:=3;\n///\nb:=2;\nc:=3;\n```\n\n```\nprint 4;\n///\n```\n\n```\nd:=4;\nprint 5;\n///\n```\n\n```\nprint 6;\n///\n```\n\n```\nprint 7;\n///\nprint 6;\n```\n\n---\n\nApply only [attachment:trac_11401v2.2.patch] to the Sage library.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/11401\n\n",
    "closed_at": "2011-09-12T19:29:19Z",
    "created_at": "2011-05-30T06:47:48Z",
    "labels": [
        "component: interfaces",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.7.2",
    "title": "magma mode in 4.7 notebook broken",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11229",
    "user": "https://github.com/nbruin"
}
```
Keywords: magma notebook interface

See also 
[this sage-devel thread](https://groups.google.com/group/sage-devel/browse_thread/thread/b47e2be73baa9703/5f8fedf0fbbaddc0?hl=en%05f8fedf0fbbaddc0)

It seems that magma mode in the 4.7 notebook is broken. I observed the following session after verifying John Cremona's report about syncing problems. I suspect sync is lost due to the multiple commands. Note that none of the print commands seem to get executed (no output is observed) and that for "print 7;" the line "print 6;" gets echoed (this has probably very little to do with the "print 7;" command itself)

```
a:=1;
b:=2;
c:=3;
///
b:=2;
c:=3;
```

```
print 4;
///
```

```
d:=4;
print 5;
///
```

```
print 6;
///
```

```
print 7;
///
print 6;
```

---

Apply only [attachment:trac_11401v2.2.patch] to the Sage library.


Issue created by migration from https://trac.sagemath.org/ticket/11401





---

archive/issue_comments_123429.json:
```json
{
    "body": "Could this be caused by #9705?",
    "created_at": "2011-05-30T08:00:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11229#issuecomment-123429",
    "user": "https://github.com/jdemeyer"
}
```

Could this be caused by #9705?



---

archive/issue_comments_123430.json:
```json
{
    "body": "> Could this be caused by #9705?\n\nI guess it could be caused by its fix ... The cells there execute without problem for me in 4.7 and those cells do contain multiple commands that do not produce output. It seems that the input (in one cell)\n\n```\na:=1;\nb:=2;\n```\nreliably knocks the interface out of sync. So probably if someone who know how these interfaces work, looks at the strings that are passed back and forth, it will become apparent quite quickly.\n\nI don't think the problem is confined to the notebook either. I observed:\n\n```\nsage: magma.execute(\"\"\"\n....: a:=1;\n....: b:=2;\n....: \"\"\")\n'b:=2;'\nsage: magma.execute(\"print 3;\")\n''\n```",
    "created_at": "2011-05-30T16:10:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11229#issuecomment-123430",
    "user": "https://github.com/nbruin"
}
```

> Could this be caused by #9705?

I guess it could be caused by its fix ... The cells there execute without problem for me in 4.7 and those cells do contain multiple commands that do not produce output. It seems that the input (in one cell)

```
a:=1;
b:=2;
```
reliably knocks the interface out of sync. So probably if someone who know how these interfaces work, looks at the strings that are passed back and forth, it will become apparent quite quickly.

I don't think the problem is confined to the notebook either. I observed:

```
sage: magma.execute("""
....: a:=1;
....: b:=2;
....: """)
'b:=2;'
sage: magma.execute("print 3;")
''
```



---

archive/issue_comments_123431.json:
```json
{
    "body": "straightforward fix",
    "created_at": "2011-06-22T20:10:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11229#issuecomment-123431",
    "user": "https://github.com/nbruin"
}
```

straightforward fix



---

archive/issue_comments_123432.json:
```json
{
    "body": "Attachment [trac_11401.patch](tarball://root/attachments/some-uuid/ticket11401/trac_11401.patch) by @nbruin created at 2011-06-22 20:13:51\n\nPerhaps a little too naive of a fix and perhaps focussing a little too much on the symptom rather than the cause, but if newlines are causing problems, why not just replace them with spaces? In magma syntax, both newline and space are whitespace characters and those are all treated the same.\nAttached fix does pass\n\n```\nsage -t --optional --long magma.py\n```\nwhich I suppose contains all magma interfacing doctests?",
    "created_at": "2011-06-22T20:13:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11229#issuecomment-123432",
    "user": "https://github.com/nbruin"
}
```

Attachment [trac_11401.patch](tarball://root/attachments/some-uuid/ticket11401/trac_11401.patch) by @nbruin created at 2011-06-22 20:13:51

Perhaps a little too naive of a fix and perhaps focussing a little too much on the symptom rather than the cause, but if newlines are causing problems, why not just replace them with spaces? In magma syntax, both newline and space are whitespace characters and those are all treated the same.
Attached fix does pass

```
sage -t --optional --long magma.py
```
which I suppose contains all magma interfacing doctests?



---

archive/issue_comments_123433.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-06-22T20:13:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11229#issuecomment-123433",
    "user": "https://github.com/nbruin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_123434.json:
```json
{
    "body": "I think I now have a proper fix for the problem. The problem is indeed caused by the fix of #9705.\nThe matter is the following (and this will be true for a lot of interfaces):\n- Magma essentially responds to each newline with a new prompt. So, when you are feeding input to magma via its stdin, the most straightforward way is to do this line by line and eat the prompts as you go along. This happened before the fix of #9705.\n- The decision to transfer via file or via stdin was made on a line-by-line basis. So, newlines inside expressions could lead to input being split over several files and/or a bit of stdin. This caused #9705. The fix introduced there solves the problem by introducing split_lines. With split_lines=False, one can end up with multi-line input in expect._eval_line. When _eval_line decides to communicate those lines via stdin then there is a mismatch between the number of prompts generated and the number expected.\n\nThe solution in `trac_11401v2.patch` is to move the decision to use files to \"eval\". This makes it possible to either transmit all code via a temp file or to send the input line-by-line to stdin (and those lines will never trigger file use). I think this is also more efficient because it favours transfer in bigger blocks (before the #9705 fix, input consisting of many short lines would still be communicated via stdin. Now it will be communicated via one tmp file)\n\nThis means that the `split_lines` option can now take 3 values. The option \"use one file OR split lines\" is the right behaviour for magma and probably for most other interfaces too.\n\nI have also added a doctest testing that #11401 is fixed. I also reintroduced the newlines in the test for #9705. Those are actually essential for testing (the version without newlines always worked as expected).",
    "created_at": "2011-09-01T05:17:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11229#issuecomment-123434",
    "user": "https://github.com/nbruin"
}
```

I think I now have a proper fix for the problem. The problem is indeed caused by the fix of #9705.
The matter is the following (and this will be true for a lot of interfaces):
- Magma essentially responds to each newline with a new prompt. So, when you are feeding input to magma via its stdin, the most straightforward way is to do this line by line and eat the prompts as you go along. This happened before the fix of #9705.
- The decision to transfer via file or via stdin was made on a line-by-line basis. So, newlines inside expressions could lead to input being split over several files and/or a bit of stdin. This caused #9705. The fix introduced there solves the problem by introducing split_lines. With split_lines=False, one can end up with multi-line input in expect._eval_line. When _eval_line decides to communicate those lines via stdin then there is a mismatch between the number of prompts generated and the number expected.

The solution in `trac_11401v2.patch` is to move the decision to use files to "eval". This makes it possible to either transmit all code via a temp file or to send the input line-by-line to stdin (and those lines will never trigger file use). I think this is also more efficient because it favours transfer in bigger blocks (before the #9705 fix, input consisting of many short lines would still be communicated via stdin. Now it will be communicated via one tmp file)

This means that the `split_lines` option can now take 3 values. The option "use one file OR split lines" is the right behaviour for magma and probably for most other interfaces too.

I have also added a doctest testing that #11401 is fixed. I also reintroduced the newlines in the test for #9705. Those are actually essential for testing (the version without newlines always worked as expected).



---

archive/issue_comments_123435.json:
```json
{
    "body": "Changing component from notebook to interfaces.",
    "created_at": "2011-09-01T05:33:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11229#issuecomment-123435",
    "user": "https://github.com/nbruin"
}
```

Changing component from notebook to interfaces.



---

archive/issue_comments_123436.json:
```json
{
    "body": "I don't have a machine without Magma to test this on, but I'm pretty sure that the examples \"`sage: magma.eval(\"a:=3;\\nb:=5;\")`\" and \"`magma.eval(\"[a,b];\")`\" need \"`# optional - magma`\".\n\nps. for the patchbot which didn't seem to have gotten the message:\napply trac_11401v2.patch",
    "created_at": "2011-09-02T10:43:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11229#issuecomment-123436",
    "user": "https://github.com/mstreng"
}
```

I don't have a machine without Magma to test this on, but I'm pretty sure that the examples "`sage: magma.eval("a:=3;\nb:=5;")`" and "`magma.eval("[a,b];")`" need "`# optional - magma`".

ps. for the patchbot which didn't seem to have gotten the message:
apply trac_11401v2.patch



---

archive/issue_comments_123437.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-09-02T10:43:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11229#issuecomment-123437",
    "user": "https://github.com/mstreng"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_123438.json:
```json
{
    "body": "Attachment [trac_11401v2.patch](tarball://root/attachments/some-uuid/ticket11401/trac_11401v2.patch) by @nbruin created at 2011-09-02 15:54:35\n\n(commit message + \"optional -- magma\" for examples)",
    "created_at": "2011-09-02T15:54:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11229#issuecomment-123438",
    "user": "https://github.com/nbruin"
}
```

Attachment [trac_11401v2.patch](tarball://root/attachments/some-uuid/ticket11401/trac_11401v2.patch) by @nbruin created at 2011-09-02 15:54:35

(commit message + "optional -- magma" for examples)



---

archive/issue_comments_123439.json:
```json
{
    "body": "Good catch! fixed.\n\n(amnesic patchbot: apply trac_11401v2.patch)",
    "created_at": "2011-09-02T15:57:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11229#issuecomment-123439",
    "user": "https://github.com/nbruin"
}
```

Good catch! fixed.

(amnesic patchbot: apply trac_11401v2.patch)



---

archive/issue_comments_123440.json:
```json
{
    "body": "Remove assignee jason, mpatel, was.",
    "created_at": "2011-09-02T15:57:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11229#issuecomment-123440",
    "user": "https://github.com/nbruin"
}
```

Remove assignee jason, mpatel, was.



---

archive/issue_comments_123441.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-09-02T16:05:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11229#issuecomment-123441",
    "user": "https://github.com/nbruin"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_123442.json:
```json
{
    "body": "Why are you changing the example for \"Verify that trac 9705 is fixed\"? I don't see why one is better than the other.\n\nTo check for myself that your new version of that test really verifies that trac 9705 is fixed, I would have to install a pre-#9705 version of Sage and see that that test fails. That's a bit more work than I would like to do.\n\nPatchbot, would you apply trac_11401v2.patch please?",
    "created_at": "2011-09-02T21:27:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11229#issuecomment-123442",
    "user": "https://github.com/mstreng"
}
```

Why are you changing the example for "Verify that trac 9705 is fixed"? I don't see why one is better than the other.

To check for myself that your new version of that test really verifies that trac 9705 is fixed, I would have to install a pre-#9705 version of Sage and see that that test fails. That's a bit more work than I would like to do.

Patchbot, would you apply trac_11401v2.patch please?



---

archive/issue_comments_123443.json:
```json
{
    "body": "All tests pass. Patch looks good. I haven't tried the notebook, but the patch does what it should do to multi-line magma.eval.\n\nThat leaves just the one question about the changed #9705 doctest.",
    "created_at": "2011-09-02T21:55:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11229#issuecomment-123443",
    "user": "https://github.com/mstreng"
}
```

All tests pass. Patch looks good. I haven't tried the notebook, but the patch does what it should do to multi-line magma.eval.

That leaves just the one question about the changed #9705 doctest.



---

archive/issue_comments_123444.json:
```json
{
    "body": "Replying to [comment:10 mstreng]:\n> Why are you changing the example for \"Verify that trac 9705 is fixed\"? I don't see why one is better than the other.\n\n\nBecause the example without newlines runs OK both with and without the fix of #9705, so the test is not verifying any change in behaviour. The problem described in #9705 arose when one magma statement was spread over multiple lines and one line was passed over stdin and another line via a \"load\" command. Without newlines, such splits wouldn't occur anyway.\n\nIf people can't find a fix for the \"\\n\" in the tests, I guess we could write it in the following way:\n\n```\nsage: import commands\nsage: newline=commands.getoutput(\"echo; echo\")\nsage: command=(\n        \"_<x>:=PolynomialRing(Rationals());\"+newline+\n        \"repeat\"+newline+\n        \"  g:=3*b*x^4+18*c*x^3-6*b^2*x^2-6*b*c*x-b^3-9*c^2 where b:=Random([-10..10]) where c:=Random([-10..10]);\"+newline+\n        \"until Roots(g) ne [];\")\nsage: magma.eval(command)\n```",
    "created_at": "2011-09-02T22:28:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11229#issuecomment-123444",
    "user": "https://github.com/nbruin"
}
```

Replying to [comment:10 mstreng]:
> Why are you changing the example for "Verify that trac 9705 is fixed"? I don't see why one is better than the other.


Because the example without newlines runs OK both with and without the fix of #9705, so the test is not verifying any change in behaviour. The problem described in #9705 arose when one magma statement was spread over multiple lines and one line was passed over stdin and another line via a "load" command. Without newlines, such splits wouldn't occur anyway.

If people can't find a fix for the "\n" in the tests, I guess we could write it in the following way:

```
sage: import commands
sage: newline=commands.getoutput("echo; echo")
sage: command=(
        "_<x>:=PolynomialRing(Rationals());"+newline+
        "repeat"+newline+
        "  g:=3*b*x^4+18*c*x^3-6*b^2*x^2-6*b*c*x-b^3-9*c^2 where b:=Random([-10..10]) where c:=Random([-10..10]);"+newline+
        "until Roots(g) ne [];")
sage: magma.eval(command)
```



---

archive/issue_comments_123445.json:
```json
{
    "body": "Attachment [trac_11401v2.2.patch](tarball://root/attachments/some-uuid/ticket11401/trac_11401v2.2.patch) by @nbruin created at 2011-09-03 19:54:44\n\ncompliant commit-message and fix for newlines",
    "created_at": "2011-09-03T19:54:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11229#issuecomment-123445",
    "user": "https://github.com/nbruin"
}
```

Attachment [trac_11401v2.2.patch](tarball://root/attachments/some-uuid/ticket11401/trac_11401v2.2.patch) by @nbruin created at 2011-09-03 19:54:44

compliant commit-message and fix for newlines



---

archive/issue_comments_123446.json:
```json
{
    "body": "OK, latest version should provide proper formatting of documentation _and_ have newlines in doctests. The doc formatting is surprisingly fragile in the face of multi-line strings, so manually adding the newline characters seems to be the best idea. Plus, second lines of multiline strings get preparsed by the doctester! That wreaks havoc with magma code (Integer(3) etc.)\n\nDear patchbot, would you be so kind to just apply trac_11401v2.2.patch please?",
    "created_at": "2011-09-03T19:59:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11229#issuecomment-123446",
    "user": "https://github.com/nbruin"
}
```

OK, latest version should provide proper formatting of documentation _and_ have newlines in doctests. The doc formatting is surprisingly fragile in the face of multi-line strings, so manually adding the newline characters seems to be the best idea. Plus, second lines of multiline strings get preparsed by the doctester! That wreaks havoc with magma code (Integer(3) etc.)

Dear patchbot, would you be so kind to just apply trac_11401v2.2.patch please?



---

archive/issue_comments_123447.json:
```json
{
    "body": "That new version looks good, and does the trick.\n\nI'm glad you didn't really do `newline=commands.getoutput(\"echo; echo\")`",
    "created_at": "2011-09-05T08:07:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11229#issuecomment-123447",
    "user": "https://github.com/mstreng"
}
```

That new version looks good, and does the trick.

I'm glad you didn't really do `newline=commands.getoutput("echo; echo")`



---

archive/issue_comments_123448.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-09-05T08:07:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11229#issuecomment-123448",
    "user": "https://github.com/mstreng"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_123449.json:
```json
{
    "body": "Please use proper URLs, or in this case, trac wiki mark-up (\"`[attachment:here_comes_the_filename]`\") to reference attached patches in the description.",
    "created_at": "2011-09-08T15:45:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11229#issuecomment-123449",
    "user": "https://github.com/nexttime"
}
```

Please use proper URLs, or in this case, trac wiki mark-up ("`[attachment:here_comes_the_filename]`") to reference attached patches in the description.



---

archive/issue_events_029596.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2011-09-12T19:29:19Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/11229",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11229#event-29596"
}
```



---

archive/issue_comments_123450.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-09-12T19:29:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11229#issuecomment-123450",
    "user": "https://github.com/nexttime"
}
```

Resolution: fixed
