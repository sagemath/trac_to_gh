# Issue 11500: Problem with accumulating 3D plots over a parameter

archive/issues_011328.json:
```json
{
    "body": "When creating several layers that interpolate between two surfaces, only one layer is output when accumulating the layers via a loop.  No problem if the layers are explicitly coded.\n\nIn the looped version, it appears that the plot3d commands are only executed at show() time and therefore only use the final value of the loop parameter.  All of the layers are created on top of each other at that final parameter value.\n\nThis works:\n\nP += plot3d(lambda x,y: H(x,y,tiers[2]/10),(x,-1,1),(y,-1,1),opacity=0.2)\n\nP += plot3d(lambda x,y: H(x,y,tiers[5]/10),(x,-1,1),(y,-1,1),opacity=0.2)\n\nP += plot3d(lambda x,y: H(x,y,tiers[8]/10),(x,-1,1),(y,-1,1),opacity=0.2)\n\nshow(P)\n\nThis does not:\n\nfor r in ratios:\n\n    P += plot3d(lambda x,y: H(x,y,r),(x,-1,1),(y,-1,1),opacity=0.2)  # layer\n\nshow(P)\n\nExample worksheet is attached.\n\n**Assignee:** @jasongrout, @williamstein\n\n**CC:**  @kcrisman\n\n**Keywords:** plot3d\n\n**Status:** new\n\nIssue created by migration from https://trac.sagemath.org/ticket/11500\n\n",
    "created_at": "2011-06-16T05:38:06Z",
    "labels": [
        "component: graphics",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "Problem with accumulating 3D plots over a parameter",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11500",
    "user": "https://trac.sagemath.org/admin/accounts/users/travis"
}
```
When creating several layers that interpolate between two surfaces, only one layer is output when accumulating the layers via a loop.  No problem if the layers are explicitly coded.

In the looped version, it appears that the plot3d commands are only executed at show() time and therefore only use the final value of the loop parameter.  All of the layers are created on top of each other at that final parameter value.

This works:

P += plot3d(lambda x,y: H(x,y,tiers[2]/10),(x,-1,1),(y,-1,1),opacity=0.2)

P += plot3d(lambda x,y: H(x,y,tiers[5]/10),(x,-1,1),(y,-1,1),opacity=0.2)

P += plot3d(lambda x,y: H(x,y,tiers[8]/10),(x,-1,1),(y,-1,1),opacity=0.2)

show(P)

This does not:

for r in ratios:

    P += plot3d(lambda x,y: H(x,y,r),(x,-1,1),(y,-1,1),opacity=0.2)  # layer

show(P)

Example worksheet is attached.

**Assignee:** @jasongrout, @williamstein

**CC:**  @kcrisman

**Keywords:** plot3d

**Status:** new

Issue created by migration from https://trac.sagemath.org/ticket/11500





---

archive/attachments_015161.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "Plot3d bug.sws",
    "asset_url": "tarball://root/attachments/some-uuid/ticket11500/Plot3d bug.sws",
    "created_at": "2011-06-16T05:43:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11500",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.sws",
    "user": "https://trac.sagemath.org/admin/accounts/users/travis"
}
```



---

archive/issue_comments_147685.json:
```json
{
    "body": "<a id='comment:1'></a>\n",
    "created_at": "2011-06-16T05:43:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11500#issuecomment-147685",
    "user": "https://trac.sagemath.org/admin/accounts/users/travis"
}
```

<a id='comment:1'></a>




---

archive/issue_comments_147686.json:
```json
{
    "body": "<a id='comment:2'></a>\nJohn, try to copy a minimal example with code so that people don't have to upload it to look at this ticket :)  Thanks for getting the spelling right :)",
    "created_at": "2011-06-16T05:48:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11500#issuecomment-147686",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:2'></a>
John, try to copy a minimal example with code so that people don't have to upload it to look at this ticket :)  Thanks for getting the spelling right :)



---

archive/issue_comments_147687.json:
```json
{
    "body": "<a id='comment:3'></a>\nI don't think there is any guarantee that the function is actually executed when the plot3d command is called, is there?  You are exposing this because the lambda function does not create a new scope.  If instead you use a def function instead of a lambda function, things should work fine.\n\nI agree that it is confusing.  I'm trying to decide if it is \"wrong\".\n\nI've published this worksheet here: http://sagenb.org/home/pub/2823/",
    "created_at": "2011-06-16T06:25:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11500#issuecomment-147687",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:3'></a>
I don't think there is any guarantee that the function is actually executed when the plot3d command is called, is there?  You are exposing this because the lambda function does not create a new scope.  If instead you use a def function instead of a lambda function, things should work fine.

I agree that it is confusing.  I'm trying to decide if it is "wrong".

I've published this worksheet here: http://sagenb.org/home/pub/2823/



---

archive/issue_comments_147688.json:
```json
{
    "body": "<a id='comment:4'></a>\nOkay, after thinking about it and discussing this with KDC, I think the current behavior is wrong. I agree with kcrisman that the plot3d command should \"freeze\" the variables by creating a closure (or a fast_callable object) when it stores the function.",
    "created_at": "2011-06-16T07:34:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11500#issuecomment-147688",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:4'></a>
Okay, after thinking about it and discussing this with KDC, I think the current behavior is wrong. I agree with kcrisman that the plot3d command should "freeze" the variables by creating a closure (or a fast_callable object) when it stores the function.



---

archive/issue_comments_147689.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -2,4 +2,22 @@\n \n In the looped version, it appears that the plot3d commands are only executed at show() time and therefore only use the final value of the loop parameter.  All of the layers are created on top of each other at that final parameter value.\n \n+This works:\n+\n+P += plot3d(lambda x,y: H(x,y,tiers[2]/10),(x,-1,1),(y,-1,1),opacity=0.2)\n+\n+P += plot3d(lambda x,y: H(x,y,tiers[5]/10),(x,-1,1),(y,-1,1),opacity=0.2)\n+\n+P += plot3d(lambda x,y: H(x,y,tiers[8]/10),(x,-1,1),(y,-1,1),opacity=0.2)\n+\n+show(P)\n+\n+This does not:\n+\n+for r in ratios:\n+\n+    P += plot3d(lambda x,y: H(x,y,r),(x,-1,1),(y,-1,1),opacity=0.2)  # layer\n+\n+show(P)\n+\n Example worksheet is attached.\n``````\n",
    "created_at": "2011-06-16T16:07:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11500#issuecomment-147689",
    "user": "https://trac.sagemath.org/admin/accounts/users/travis"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -2,4 +2,22 @@
 
 In the looped version, it appears that the plot3d commands are only executed at show() time and therefore only use the final value of the loop parameter.  All of the layers are created on top of each other at that final parameter value.
 
+This works:
+
+P += plot3d(lambda x,y: H(x,y,tiers[2]/10),(x,-1,1),(y,-1,1),opacity=0.2)
+
+P += plot3d(lambda x,y: H(x,y,tiers[5]/10),(x,-1,1),(y,-1,1),opacity=0.2)
+
+P += plot3d(lambda x,y: H(x,y,tiers[8]/10),(x,-1,1),(y,-1,1),opacity=0.2)
+
+show(P)
+
+This does not:
+
+for r in ratios:
+
+    P += plot3d(lambda x,y: H(x,y,r),(x,-1,1),(y,-1,1),opacity=0.2)  # layer
+
+show(P)
+
 Example worksheet is attached.
``````




---

archive/issue_comments_147690.json:
```json
{
    "body": "**Changing assignee** from @jasongrout, @qed777, @williamstein to @jasongrout, @williamstein.",
    "created_at": "2012-07-16T17:52:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11500#issuecomment-147690",
    "user": "https://github.com/kcrisman"
}
```

**Changing assignee** from @jasongrout, @qed777, @williamstein to @jasongrout, @williamstein.



---

archive/issue_events_035097.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11500",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11500#event-35097"
}
```



---

archive/issue_events_035098.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11500",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11500#event-35098"
}
```



---

archive/issue_events_035099.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11500",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11500#event-35099"
}
```



---

archive/issue_events_035100.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11500",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11500#event-35100"
}
```



---

archive/issue_events_035101.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11500",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11500#event-35101"
}
```



---

archive/issue_events_035102.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11500",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11500#event-35102"
}
```



---

archive/issue_events_035103.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11500",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11500#event-35103"
}
```
