# Issue 11312: Speed up the computation of the Hilbert basis of a cone

archive/issues_011140.json:
```json
{
    "body": "My first implementation of the Hilbert basis eventually uses PALP to compute the points in the parallelotope spanned by the rays of a simplicial cone. This can be done much faster with just the Smith normal form of the ray matrix.\n\nThis makes it easy to compute the points in the semi-open parallelotope, so the actual number of semigroup generators is sometimes less than the PALP version (which computed the integral points in the closure). As a pleasant side effect, arbitrary dimension cones work now as we are no longer limited to PALP's compile-time bounds.\n\n**Apply:**\n\n1. [attachment:trac_11312_speed_up_Hilbert_cone.2.patch]\n\n**Assignee:** mhampton\n\n**CC:**  @novoselt @zafeirakopoulos\n\n**Keywords:** sd31\n\n**Author:** Volker Braun\n\n**Reviewer:** Andrey Novoseltsev\n\n**Merged:** sage-4.7.2.alpha0\n\nIssue created by migration from https://trac.sagemath.org/ticket/11312\n\n",
    "closed_at": "2011-07-22T12:51:45Z",
    "created_at": "2011-05-08T11:27:47Z",
    "labels": [
        "component: geometry",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.7.2",
    "title": "Speed up the computation of the Hilbert basis of a cone",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11312",
    "user": "https://github.com/vbraun"
}
```
My first implementation of the Hilbert basis eventually uses PALP to compute the points in the parallelotope spanned by the rays of a simplicial cone. This can be done much faster with just the Smith normal form of the ray matrix.

This makes it easy to compute the points in the semi-open parallelotope, so the actual number of semigroup generators is sometimes less than the PALP version (which computed the integral points in the closure). As a pleasant side effect, arbitrary dimension cones work now as we are no longer limited to PALP's compile-time bounds.

**Apply:**

1. [attachment:trac_11312_speed_up_Hilbert_cone.2.patch]

**Assignee:** mhampton

**CC:**  @novoselt @zafeirakopoulos

**Keywords:** sd31

**Author:** Volker Braun

**Reviewer:** Andrey Novoseltsev

**Merged:** sage-4.7.2.alpha0

Issue created by migration from https://trac.sagemath.org/ticket/11312





---

archive/issue_comments_143842.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2011-05-08T11:32:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11312#issuecomment-143842",
    "user": "https://github.com/vbraun"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_143843.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,3 +1,3 @@\n My first implementation of the Hilbert basis eventually uses PALP to compute the points in the parallelotope spanned by the rays of a simplicial cone. This can be done much faster with just the Smith normal form of the ray matrix.\n \n-This makes it easy to compute the points in the semi-open parallelotope, so the actual number of semigroup generators is sometimes less than the PALP version (which computed the integral points in the closure). \n+This makes it easy to compute the points in the semi-open parallelotope, so the actual number of semigroup generators is sometimes less than the PALP version (which computed the integral points in the closure). As a pleasant side effect, arbitrary dimension cones work now as we are no longer limited to PALP's compile-time bounds.\n``````\n",
    "created_at": "2011-05-08T11:32:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11312#issuecomment-143843",
    "user": "https://github.com/vbraun"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,3 +1,3 @@
 My first implementation of the Hilbert basis eventually uses PALP to compute the points in the parallelotope spanned by the rays of a simplicial cone. This can be done much faster with just the Smith normal form of the ray matrix.
 
-This makes it easy to compute the points in the semi-open parallelotope, so the actual number of semigroup generators is sometimes less than the PALP version (which computed the integral points in the closure). 
+This makes it easy to compute the points in the semi-open parallelotope, so the actual number of semigroup generators is sometimes less than the PALP version (which computed the integral points in the closure). As a pleasant side effect, arbitrary dimension cones work now as we are no longer limited to PALP's compile-time bounds.
``````




---

archive/issue_comments_143844.json:
```json
{
    "body": "**Work_Issues:** non-full-dimensional errors",
    "created_at": "2011-05-21T01:29:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11312#issuecomment-143844",
    "user": "https://github.com/novoselt"
}
```

**Work_Issues:** non-full-dimensional errors



---

archive/issue_comments_143845.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2011-05-21T01:29:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11312#issuecomment-143845",
    "user": "https://github.com/novoselt"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_143846.json:
```json
{
    "body": "<a id='comment:2'></a>\nThe speed-up looks impressive! About 20x on trivial examples (no surprise here since we are avoiding system calls to both cdd and PALP), on a \"complicated\" 6-d example that I picked the new version worked for 15sec and the old one didn't finish before my patience ran out ;-) Am I right that this speed is partially due to taking into account the special structure of the polytopes in which you are computing integral points?\n\nThere are, however, issues with non-full-dimensional cones::\n\n```\nsage: Cone([(1,1), (-1,1)], check=False).Hilbert_basis()\n(N(1, 1), N(-1, 1), N(0, 1))\nsage: Cone([(1,1,0), (-1,1,0)], check=False).Hilbert_basis()\n(N(1, 1, 0), N(-1, 1, 0))\n```",
    "created_at": "2011-05-21T01:29:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11312#issuecomment-143846",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:2'></a>
The speed-up looks impressive! About 20x on trivial examples (no surprise here since we are avoiding system calls to both cdd and PALP), on a "complicated" 6-d example that I picked the new version worked for 15sec and the old one didn't finish before my patience ran out ;-) Am I right that this speed is partially due to taking into account the special structure of the polytopes in which you are computing integral points?

There are, however, issues with non-full-dimensional cones::

```
sage: Cone([(1,1), (-1,1)], check=False).Hilbert_basis()
(N(1, 1), N(-1, 1), N(0, 1))
sage: Cone([(1,1,0), (-1,1,0)], check=False).Hilbert_basis()
(N(1, 1, 0), N(-1, 1, 0))
```



---

archive/issue_comments_143847.json:
```json
{
    "body": "**Reviewer:** Andrey Novoseltsev",
    "created_at": "2011-05-21T01:29:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11312#issuecomment-143847",
    "user": "https://github.com/novoselt"
}
```

**Reviewer:** Andrey Novoseltsev



---

archive/issue_comments_143848.json:
```json
{
    "body": "<a id='comment:3'></a>\nI think I'm just implementing the same algorithm as PALP would use to enumerate the points in the parallelotope spanned by the rays, though I'm not sure. Essentially you have to compute the Smith form to enumerate the points, the rest is a simple loop. I'll try to get some more info about Palp's inner workings out of Harald Skarke at the Kreuzer Memorial conference. \n\nAnd thanks for catching the non-full dimensional cone bug, I should have thought about that but didn't.",
    "created_at": "2011-05-21T02:15:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11312#issuecomment-143848",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:3'></a>
I think I'm just implementing the same algorithm as PALP would use to enumerate the points in the parallelotope spanned by the rays, though I'm not sure. Essentially you have to compute the Smith form to enumerate the points, the rest is a simple loop. I'll try to get some more info about Palp's inner workings out of Harald Skarke at the Kreuzer Memorial conference. 

And thanks for catching the non-full dimensional cone bug, I should have thought about that but didn't.



---

archive/issue_comments_143849.json:
```json
{
    "body": "<a id='comment:4'></a>\nFixed:\n\n```\nsage: Cone([(1,1), (-1,1)], check=False).Hilbert_basis()\n(N(1, 1), N(-1, 1), N(0, 1))\nsage: Cone([(1,1,0), (-1,1,0)], check=False).Hilbert_basis()\n(N(1, 1, 0), N(-1, 1, 0), N(0, 1, 0))\n```",
    "created_at": "2011-06-03T21:59:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11312#issuecomment-143849",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:4'></a>
Fixed:

```
sage: Cone([(1,1), (-1,1)], check=False).Hilbert_basis()
(N(1, 1), N(-1, 1), N(0, 1))
sage: Cone([(1,1,0), (-1,1,0)], check=False).Hilbert_basis()
(N(1, 1, 0), N(-1, 1, 0), N(0, 1, 0))
```



---

archive/issue_comments_143850.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2011-06-03T21:59:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11312#issuecomment-143850",
    "user": "https://github.com/vbraun"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_143851.json:
```json
{
    "body": "<a id='comment:5'></a>\nOn further thought, I think its better to also remove non-primitive vectors from the semigroup generators. The new version of the patch saves a few generators, which should speed up the Hilbert basis a little bit.",
    "created_at": "2011-06-04T22:22:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11312#issuecomment-143851",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:5'></a>
On further thought, I think its better to also remove non-primitive vectors from the semigroup generators. The new version of the patch saves a few generators, which should speed up the Hilbert basis a little bit.



---

archive/issue_comments_143852.json:
```json
{
    "body": "<a id='comment:6'></a>\nNew version of the patch breaks out the `parallelotope_points()` function so it can be reused in #11429",
    "created_at": "2011-06-05T19:34:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11312#issuecomment-143852",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:6'></a>
New version of the patch breaks out the `parallelotope_points()` function so it can be reused in #11429



---

archive/issue_comments_143853.json:
```json
{
    "body": "**Changing work_issues** from \"non-full-dimensional errors\" to \"\".",
    "created_at": "2011-06-05T19:34:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11312#issuecomment-143853",
    "user": "https://github.com/vbraun"
}
```

**Changing work_issues** from "non-full-dimensional errors" to "".



---

archive/issue_comments_143854.json:
```json
{
    "body": "**Work_Issues:** One long test fails in cone module",
    "created_at": "2011-06-14T21:45:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11312#issuecomment-143854",
    "user": "https://github.com/novoselt"
}
```

**Work_Issues:** One long test fails in cone module



---

archive/issue_comments_143855.json:
```json
{
    "body": "**Changing keywords** from \"\" to \"sd31\".",
    "created_at": "2011-06-14T21:45:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11312#issuecomment-143855",
    "user": "https://github.com/novoselt"
}
```

**Changing keywords** from "" to "sd31".



---

archive/issue_comments_143856.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2011-06-14T21:45:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11312#issuecomment-143856",
    "user": "https://github.com/novoselt"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_143857.json:
```json
{
    "body": "<a id='comment:9'></a>\nAs the patch has to be adjusted one more time anyway - what do you think about creating some kind of `sage.geometry.misc` module for \"helper functions\"? Names and rays normalization functions are also natural candidates to go there. This will reduce the potential for circular imports and clarify the structure. `cone.parallelotope_points` seems a bit strange ;-)",
    "created_at": "2011-06-16T20:07:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11312#issuecomment-143857",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:9'></a>
As the patch has to be adjusted one more time anyway - what do you think about creating some kind of `sage.geometry.misc` module for "helper functions"? Names and rays normalization functions are also natural candidates to go there. This will reduce the potential for circular imports and clarify the structure. `cone.parallelotope_points` seems a bit strange ;-)



---

archive/issue_comments_143858.json:
```json
{
    "body": "<a id='comment:10'></a>\nAh, this particular function is moved to another place in the next patch anyway!",
    "created_at": "2011-06-16T20:14:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11312#issuecomment-143858",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:10'></a>
Ah, this particular function is moved to another place in the next patch anyway!



---

archive/issue_comments_143859.json:
```json
{
    "body": "Updated patch",
    "created_at": "2011-06-17T03:19:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11312#issuecomment-143859",
    "user": "https://github.com/vbraun"
}
```

Updated patch



---

archive/issue_comments_143860.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2011-06-17T03:21:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11312#issuecomment-143860",
    "user": "https://github.com/vbraun"
}
```

**Changing status** from needs_work to needs_review.



---

archive/attachments_014824.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_11312_speed_up_Hilbert_cone.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket11312/trac_11312_speed_up_Hilbert_cone.patch",
    "created_at": "2011-06-17T03:21:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11312",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/vbraun"
}
```



---

archive/issue_comments_143861.json:
```json
{
    "body": "<a id='comment:11'></a>\nGood catch! I fixed the offending doctest. Up to the ordering the Hilbert bases before and after the patch are the same, of course.",
    "created_at": "2011-06-17T03:21:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11312#issuecomment-143861",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:11'></a>
Good catch! I fixed the offending doctest. Up to the ordering the Hilbert bases before and after the patch are the same, of course.



---

archive/issue_comments_143862.json:
```json
{
    "body": "<a id='comment:12'></a>\nAll works now!",
    "created_at": "2011-06-17T06:59:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11312#issuecomment-143862",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:12'></a>
All works now!



---

archive/issue_comments_143863.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2011-06-17T06:59:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11312#issuecomment-143863",
    "user": "https://github.com/novoselt"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_143864.json:
```json
{
    "body": "Two corrections to REST formatting",
    "created_at": "2011-06-17T18:24:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11312#issuecomment-143864",
    "user": "https://github.com/novoselt"
}
```

Two corrections to REST formatting



---

archive/issue_comments_143865.json:
```json
{
    "body": "**Changing work_issues** from \"One long test fails in cone module\" to \"\".",
    "created_at": "2011-06-17T18:31:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11312#issuecomment-143865",
    "user": "https://github.com/novoselt"
}
```

**Changing work_issues** from "One long test fails in cone module" to "".



---

archive/issue_comments_143866.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,3 +1,7 @@\n My first implementation of the Hilbert basis eventually uses PALP to compute the points in the parallelotope spanned by the rays of a simplicial cone. This can be done much faster with just the Smith normal form of the ray matrix.\n \n This makes it easy to compute the points in the semi-open parallelotope, so the actual number of semigroup generators is sometimes less than the PALP version (which computed the integral points in the closure). As a pleasant side effect, arbitrary dimension cones work now as we are no longer limited to PALP's compile-time bounds.\n+\n+**Apply:**\n+\n+1. [attachment:trac_11312_speed_up_Hilbert_cone.2.patch]\n``````\n",
    "created_at": "2011-06-17T18:31:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11312#issuecomment-143866",
    "user": "https://github.com/novoselt"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,3 +1,7 @@
 My first implementation of the Hilbert basis eventually uses PALP to compute the points in the parallelotope spanned by the rays of a simplicial cone. This can be done much faster with just the Smith normal form of the ray matrix.
 
 This makes it easy to compute the points in the semi-open parallelotope, so the actual number of semigroup generators is sometimes less than the PALP version (which computed the integral points in the closure). As a pleasant side effect, arbitrary dimension cones work now as we are no longer limited to PALP's compile-time bounds.
+
+**Apply:**
+
+1. [attachment:trac_11312_speed_up_Hilbert_cone.2.patch]
``````




---

archive/attachments_014825.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_11312_speed_up_Hilbert_cone.2.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket11312/trac_11312_speed_up_Hilbert_cone.2.patch",
    "created_at": "2011-06-17T18:31:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11312",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/novoselt"
}
```



---

archive/issue_comments_143867.json:
```json
{
    "body": "<a id='comment:13'></a>\nI have made tiny adjustments to the patch to make the documentation compile without warnings, I'll leave it at positive review. (Added one column and replaced a quote with a backward one.)\n\nVolker: subsequent patches may need to be rebased.",
    "created_at": "2011-06-17T18:31:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11312#issuecomment-143867",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:13'></a>
I have made tiny adjustments to the patch to make the documentation compile without warnings, I'll leave it at positive review. (Added one column and replaced a quote with a backward one.)

Volker: subsequent patches may need to be rebased.



---

archive/issue_events_034388.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-06-18T08:41:18Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11312",
    "milestone": "sage-4.7.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11312#event-34388"
}
```



---

archive/issue_comments_143868.json:
```json
{
    "body": "**Merged:** sage-4.7.2.alpha0",
    "created_at": "2011-07-22T12:51:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11312#issuecomment-143868",
    "user": "https://github.com/jdemeyer"
}
```

**Merged:** sage-4.7.2.alpha0



---

archive/issue_events_034389.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-07-22T12:51:45Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/11312",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11312#event-34389"
}
```
