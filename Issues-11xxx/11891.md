# Issue 11891: NumberField(...).pari_polynomial() should return an integral polynomial

archive/issues_011719.json:
```json
{
    "assignees": [
        "https://github.com/loefflerd"
    ],
    "body": "<div id=\"comment:0\"></div>\n\nMostly, PARI only works with number fields defined by monic integral polynomials.  A few functions (like `factornf()`) also work for non-monic polynomials.  In these cases, PARI always requires the polynomial to have integer coefficients.  So, PARI prefers `2*x^2 - 1` over `x^2 - 1/2` for defining a number field.  The `NumberField` method `pari_polynomial` should reflect this.\n\nThis change allows one to define number field towers with non-integral polynomials.  Example from vanilla sage-4.7.1:\n\n```\nsage: k.<a, c> = NumberField([x^2 + 1/3, x^2 + 1/4])\n---------------------------------------------------------------------------\nPariError                                 Traceback (most recent call last)\n\n/home/jdemeyer/<ipython console> in <module>()\n\n/usr/local/src/sage-4.7.1/local/lib/python2.6/site-packages/sage/rings/number_field/number_field.pyc in NumberField(polynomial, name, check, names, cache, embedding, latex_name, assume_disc_small, maximize_at_primes)\n    435\n    436     if isinstance(polynomial, (list, tuple)):\n--> 437         return NumberFieldTower(polynomial, name, embeddings=embedding)\n    438\n    439     name = sage.structure.parent_gens.normalize_names(1, name)\n\n/usr/local/src/sage-4.7.1/local/lib/python2.6/site-packages/sage/rings/number_field/number_field.pyc in NumberFieldTower(v, names, check, embeddings)\n    622     #    return z\n    623     #else:\n--> 624     return w.extension(f, name, check=check, embedding=embeddings[0])\n    625\n    626\n\n/usr/local/src/sage-4.7.1/local/lib/python2.6/site-packages/sage/rings/number_field/number_field.pyc in extension(self, poly, name, names, check, embedding)\n   3570             raise TypeError, \"the variable name must be specified.\"\n   3571         from sage.rings.number_field.number_field_rel import NumberField_relative\n-> 3572         return NumberField_relative(self, poly, str(name), check=check, embedding=embedding)\n   3573\n   3574     def factor(self, n):\n\n/usr/local/src/sage-4.7.1/local/lib/python2.6/site-packages/sage/rings/number_field/number_field_rel.pyc in __init__(self, base, polynomial, name, latex_name, names, check, embedding)\n    293\n    294         if check:\n--> 295             if not self.pari_relative_polynomial().polisirreducible():\n    296                 # this is *much* faster than\n    297                 # polynomial.is_irreducible() at some point in the\n\n/usr/local/src/sage-4.7.1/local/lib/python2.6/site-packages/sage/libs/pari/gen.so in sage.libs.pari.gen._pari_trap (sage/libs/pari/gen.c:47834)()\n\nPariError: inconsistent data (12)\n```\nWith the patch, this works.\n\nThis patch also fixes\n\n```\nsage: K.<I> = NumberField(x^2+1)\nsage: K.pari_polynomial('I')\n0\n```\nby raising `PariError` instead.\n\nBy chance, it also fixes `_division_field()` for elliptic curves which now *always* returns an absolute field.\n\nCC:  @JohnCremona\n\nComponent: **number fields**\n\nAuthor: **Jeroen Demeyer**\n\nReviewer: **Luis Felipe Tabera Alonso**\n\nMerged: **sage-4.8.alpha0**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/11891_\n\n",
    "closed_at": "2011-10-20T09:21:15Z",
    "created_at": "2011-10-03T14:52:21Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20number%20fields",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-4.8",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "NumberField(...).pari_polynomial() should return an integral polynomial",
    "type": "issue",
    "updated_at": "2011-11-03T16:18:36Z",
    "url": "https://github.com/sagemath/sage/issues/11891",
    "user": "https://github.com/jdemeyer"
}
```
<div id="comment:0"></div>

Mostly, PARI only works with number fields defined by monic integral polynomials.  A few functions (like `factornf()`) also work for non-monic polynomials.  In these cases, PARI always requires the polynomial to have integer coefficients.  So, PARI prefers `2*x^2 - 1` over `x^2 - 1/2` for defining a number field.  The `NumberField` method `pari_polynomial` should reflect this.

This change allows one to define number field towers with non-integral polynomials.  Example from vanilla sage-4.7.1:

```
sage: k.<a, c> = NumberField([x^2 + 1/3, x^2 + 1/4])
---------------------------------------------------------------------------
PariError                                 Traceback (most recent call last)

/home/jdemeyer/<ipython console> in <module>()

/usr/local/src/sage-4.7.1/local/lib/python2.6/site-packages/sage/rings/number_field/number_field.pyc in NumberField(polynomial, name, check, names, cache, embedding, latex_name, assume_disc_small, maximize_at_primes)
    435
    436     if isinstance(polynomial, (list, tuple)):
--> 437         return NumberFieldTower(polynomial, name, embeddings=embedding)
    438
    439     name = sage.structure.parent_gens.normalize_names(1, name)

/usr/local/src/sage-4.7.1/local/lib/python2.6/site-packages/sage/rings/number_field/number_field.pyc in NumberFieldTower(v, names, check, embeddings)
    622     #    return z
    623     #else:
--> 624     return w.extension(f, name, check=check, embedding=embeddings[0])
    625
    626

/usr/local/src/sage-4.7.1/local/lib/python2.6/site-packages/sage/rings/number_field/number_field.pyc in extension(self, poly, name, names, check, embedding)
   3570             raise TypeError, "the variable name must be specified."
   3571         from sage.rings.number_field.number_field_rel import NumberField_relative
-> 3572         return NumberField_relative(self, poly, str(name), check=check, embedding=embedding)
   3573
   3574     def factor(self, n):

/usr/local/src/sage-4.7.1/local/lib/python2.6/site-packages/sage/rings/number_field/number_field_rel.pyc in __init__(self, base, polynomial, name, latex_name, names, check, embedding)
    293
    294         if check:
--> 295             if not self.pari_relative_polynomial().polisirreducible():
    296                 # this is *much* faster than
    297                 # polynomial.is_irreducible() at some point in the

/usr/local/src/sage-4.7.1/local/lib/python2.6/site-packages/sage/libs/pari/gen.so in sage.libs.pari.gen._pari_trap (sage/libs/pari/gen.c:47834)()

PariError: inconsistent data (12)
```
With the patch, this works.

This patch also fixes

```
sage: K.<I> = NumberField(x^2+1)
sage: K.pari_polynomial('I')
0
```
by raising `PariError` instead.

By chance, it also fixes `_division_field()` for elliptic curves which now *always* returns an absolute field.

CC:  @JohnCremona

Component: **number fields**

Author: **Jeroen Demeyer**

Reviewer: **Luis Felipe Tabera Alonso**

Merged: **sage-4.8.alpha0**

_Issue created by migration from https://trac.sagemath.org/ticket/11891_





---

archive/issue_events_158694.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-10-03T14:52:21Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/11891",
    "milestone_number": null,
    "milestone_title": "sage-4.7.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11891#event-158694"
}
```



---

archive/issue_events_158695.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-10-03T14:52:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11891",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20number%20fields",
    "label_color": "0000ff",
    "label_name": "c: number fields",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11891#event-158695"
}
```



---

archive/issue_events_158696.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-10-03T14:52:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11891",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11891#event-158696"
}
```



---

archive/issue_events_158697.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-10-03T14:52:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11891",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11891#event-158697"
}
```



---

archive/issue_events_158698.json:
```json
{
    "actor": "https://github.com/loefflerd",
    "created_at": "2011-10-03T14:52:21Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/11891",
    "subject": "https://github.com/jdemeyer",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11891#event-158698"
}
```



---

archive/issue_comments_124855.json:
```json
{
    "body": "Author: **Jeroen Demeyer**",
    "created_at": "2011-10-04T13:33:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11891#issuecomment-124855",
    "user": "https://github.com/jdemeyer"
}
```

Author: **Jeroen Demeyer**



---

archive/issue_comments_124856.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,44 @@\n Mostly, PARI only works with number fields defined by monic integral polynomials.  A few functions (like `factornf()`) also work for non-monic polynomials.  In these cases, PARI always requires the polynomial to have integer coefficients.  So, PARI prefers `2*x^2 - 1` over `x^2 - 1/2` for defining a number field.  The `NumberField` method `pari_polynomial` should reflect this.\n+\n+This change allows allows one to define number field towers with non-integral polynomials.  Example from vanilla sage-4.7.1:\n+\n+```\n+sage: k.<a, c> = NumberField([x^2 + 1/3, x^2 + 1/4])\n+---------------------------------------------------------------------------\n+PariError                                 Traceback (most recent call last)\n+\n+/home/jdemeyer/<ipython console> in <module>()\n+\n+/usr/local/src/sage-4.7.1/local/lib/python2.6/site-packages/sage/rings/number_field/number_field.pyc in NumberField(polynomial, name, check, names, cache, embedding, latex_name, assume_disc_small, maximize_at_primes)\n+    435\n+    436     if isinstance(polynomial, (list, tuple)):\n+--> 437         return NumberFieldTower(polynomial, name, embeddings=embedding)\n+    438\n+    439     name = sage.structure.parent_gens.normalize_names(1, name)\n+\n+/usr/local/src/sage-4.7.1/local/lib/python2.6/site-packages/sage/rings/number_field/number_field.pyc in NumberFieldTower(v, names, check, embeddings)\n+    622     #    return z\n+    623     #else:\n+--> 624     return w.extension(f, name, check=check, embedding=embeddings[0])\n+    625\n+    626\n+\n+/usr/local/src/sage-4.7.1/local/lib/python2.6/site-packages/sage/rings/number_field/number_field.pyc in extension(self, poly, name, names, check, embedding)\n+   3570             raise TypeError, \"the variable name must be specified.\"\n+   3571         from sage.rings.number_field.number_field_rel import NumberField_relative\n+-> 3572         return NumberField_relative(self, poly, str(name), check=check, embedding=embedding)\n+   3573\n+   3574     def factor(self, n):\n+\n+/usr/local/src/sage-4.7.1/local/lib/python2.6/site-packages/sage/rings/number_field/number_field_rel.pyc in __init__(self, base, polynomial, name, latex_name, names, check, embedding)\n+    293\n+    294         if check:\n+--> 295             if not self.pari_relative_polynomial().polisirreducible():\n+    296                 # this is *much* faster than\n+    297                 # polynomial.is_irreducible() at some point in the\n+\n+/usr/local/src/sage-4.7.1/local/lib/python2.6/site-packages/sage/libs/pari/gen.so in sage.libs.pari.gen._pari_trap (sage/libs/pari/gen.c:47834)()\n+\n+PariError: inconsistent data (12)\n+```\n+With the patch, this works.\n``````\n",
    "created_at": "2011-10-04T13:33:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11891#issuecomment-124856",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,44 @@
 Mostly, PARI only works with number fields defined by monic integral polynomials.  A few functions (like `factornf()`) also work for non-monic polynomials.  In these cases, PARI always requires the polynomial to have integer coefficients.  So, PARI prefers `2*x^2 - 1` over `x^2 - 1/2` for defining a number field.  The `NumberField` method `pari_polynomial` should reflect this.
+
+This change allows allows one to define number field towers with non-integral polynomials.  Example from vanilla sage-4.7.1:
+
+```
+sage: k.<a, c> = NumberField([x^2 + 1/3, x^2 + 1/4])
+---------------------------------------------------------------------------
+PariError                                 Traceback (most recent call last)
+
+/home/jdemeyer/<ipython console> in <module>()
+
+/usr/local/src/sage-4.7.1/local/lib/python2.6/site-packages/sage/rings/number_field/number_field.pyc in NumberField(polynomial, name, check, names, cache, embedding, latex_name, assume_disc_small, maximize_at_primes)
+    435
+    436     if isinstance(polynomial, (list, tuple)):
+--> 437         return NumberFieldTower(polynomial, name, embeddings=embedding)
+    438
+    439     name = sage.structure.parent_gens.normalize_names(1, name)
+
+/usr/local/src/sage-4.7.1/local/lib/python2.6/site-packages/sage/rings/number_field/number_field.pyc in NumberFieldTower(v, names, check, embeddings)
+    622     #    return z
+    623     #else:
+--> 624     return w.extension(f, name, check=check, embedding=embeddings[0])
+    625
+    626
+
+/usr/local/src/sage-4.7.1/local/lib/python2.6/site-packages/sage/rings/number_field/number_field.pyc in extension(self, poly, name, names, check, embedding)
+   3570             raise TypeError, "the variable name must be specified."
+   3571         from sage.rings.number_field.number_field_rel import NumberField_relative
+-> 3572         return NumberField_relative(self, poly, str(name), check=check, embedding=embedding)
+   3573
+   3574     def factor(self, n):
+
+/usr/local/src/sage-4.7.1/local/lib/python2.6/site-packages/sage/rings/number_field/number_field_rel.pyc in __init__(self, base, polynomial, name, latex_name, names, check, embedding)
+    293
+    294         if check:
+--> 295             if not self.pari_relative_polynomial().polisirreducible():
+    296                 # this is *much* faster than
+    297                 # polynomial.is_irreducible() at some point in the
+
+/usr/local/src/sage-4.7.1/local/lib/python2.6/site-packages/sage/libs/pari/gen.so in sage.libs.pari.gen._pari_trap (sage/libs/pari/gen.c:47834)()
+
+PariError: inconsistent data (12)
+```
+With the patch, this works.
``````




---

archive/issue_events_158699.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-10-04T14:55:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11891",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11891#event-158699"
}
```



---

archive/issue_comments_124857.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,6 @@\n Mostly, PARI only works with number fields defined by monic integral polynomials.  A few functions (like `factornf()`) also work for non-monic polynomials.  In these cases, PARI always requires the polynomial to have integer coefficients.  So, PARI prefers `2*x^2 - 1` over `x^2 - 1/2` for defining a number field.  The `NumberField` method `pari_polynomial` should reflect this.\n \n-This change allows allows one to define number field towers with non-integral polynomials.  Example from vanilla sage-4.7.1:\n+This change allows one to define number field towers with non-integral polynomials.  Example from vanilla sage-4.7.1:\n \n ```\n sage: k.<a, c> = NumberField([x^2 + 1/3, x^2 + 1/4])\n``````\n",
    "created_at": "2011-10-04T14:55:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11891#issuecomment-124857",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,6 @@
 Mostly, PARI only works with number fields defined by monic integral polynomials.  A few functions (like `factornf()`) also work for non-monic polynomials.  In these cases, PARI always requires the polynomial to have integer coefficients.  So, PARI prefers `2*x^2 - 1` over `x^2 - 1/2` for defining a number field.  The `NumberField` method `pari_polynomial` should reflect this.
 
-This change allows allows one to define number field towers with non-integral polynomials.  Example from vanilla sage-4.7.1:
+This change allows one to define number field towers with non-integral polynomials.  Example from vanilla sage-4.7.1:
 
 ```
 sage: k.<a, c> = NumberField([x^2 + 1/3, x^2 + 1/4])
``````




---

archive/issue_events_158700.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-10-04T14:55:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/11891",
    "milestone_number": null,
    "milestone_title": "sage-4.7.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11891#event-158700"
}
```



---

archive/issue_events_158701.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-10-04T14:55:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/11891",
    "milestone_number": null,
    "milestone_title": "sage-4.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11891#event-158701"
}
```



---

archive/issue_comments_124858.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nThe code looks good, and passes tests, and it means we can at least compute discriminants. \n\nThe first and second things I try still don't work though, and I'm curious what you think about this:\n\n```\nsage: k.<a, c> = NumberField([x^2 + 1/3, x^2 + 1/4])\nsage: k\nNumber Field in a with defining polynomial x^2 + 1/3 over its base field\nsage: a+c\n  ***   Warning: non-monic polynomial. Result of the form [nf,c].\nERROR: An unexpected error occurred while tokenizing input\n... \nBOOM!\nsage: k.relative_discriminant()\n  ***   Warning: non-monic polynomial. Result of the form [nf,c].\nBOOM!\n```\n\n\nSide Remarks: 1. I've always intended to just rewrite number fields to completely use\n\n```\nsage.schemes.elliptic_curves.heegner.make_monic\n```\nbehind the scenes, and do *everything* that involves PARI in all cases using a monic integral polynomial, and only convert to the user's representation for input and output.  I wish I had done that when I was first writing number fields. \n\n\n2. This is disturbing:\n\n```\nsage: K.<I> = NumberField(x^2+1)\nsage: K.pari_polynomial()\nx^2 + 1\nsage: K.pari_polynomial('I')\n0\n```\nI would rather get an error message in the latter case.  What do you think?  If you agree, could you open a ticket?\n\n\nAnyway, I'll wait for your comments...",
    "created_at": "2011-10-04T17:17:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11891#issuecomment-124858",
    "user": "https://github.com/williamstein"
}
```

<div id="comment:3" align="right">comment:3</div>

The code looks good, and passes tests, and it means we can at least compute discriminants. 

The first and second things I try still don't work though, and I'm curious what you think about this:

```
sage: k.<a, c> = NumberField([x^2 + 1/3, x^2 + 1/4])
sage: k
Number Field in a with defining polynomial x^2 + 1/3 over its base field
sage: a+c
  ***   Warning: non-monic polynomial. Result of the form [nf,c].
ERROR: An unexpected error occurred while tokenizing input
... 
BOOM!
sage: k.relative_discriminant()
  ***   Warning: non-monic polynomial. Result of the form [nf,c].
BOOM!
```


Side Remarks: 1. I've always intended to just rewrite number fields to completely use

```
sage.schemes.elliptic_curves.heegner.make_monic
```
behind the scenes, and do *everything* that involves PARI in all cases using a monic integral polynomial, and only convert to the user's representation for input and output.  I wish I had done that when I was first writing number fields. 


2. This is disturbing:

```
sage: K.<I> = NumberField(x^2+1)
sage: K.pari_polynomial()
x^2 + 1
sage: K.pari_polynomial('I')
0
```
I would rather get an error message in the latter case.  What do you think?  If you agree, could you open a ticket?


Anyway, I'll wait for your comments...



---

archive/issue_comments_124859.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nReplying to [@williamstein](#comment%3A3):\n> The code looks good, and passes tests, and it means we can at least compute discriminants. \n> \n> The first and second things I try still don't work though, and I'm curious what you think about this:\n> \n> ```\n> sage: k.<a, c> = NumberField([x^2 + 1/3, x^2 + 1/4])\n> sage: k\n> Number Field in a with defining polynomial x^2 + 1/3 over its base field\n> sage: a+c\n>   ***   Warning: non-monic polynomial. Result of the form [nf,c].\n> ERROR: An unexpected error occurred while tokenizing input\n> ... \n> BOOM!\n> sage: k.relative_discriminant()\n>   ***   Warning: non-monic polynomial. Result of the form [nf,c].\n> BOOM!\n> ```\n> \n> \n> Side Remarks: 1. I've always intended to just rewrite number fields to completely use\n> \n> ```\n> sage.schemes.elliptic_curves.heegner.make_monic\n> ```\n> behind the scenes, and do *everything* that involves PARI in all cases using a monic integral polynomial, and only convert to the user's representation for input and output.  I wish I had done that when I was first writing number fields.\n\nI never intended this ticket to completely fix non-integral/non-monic number fields.  I can have a look at the error messages above and try to fix them, but I also do not want to put too much effort.  The main motivation for this ticket was to support #11890, for which it seems to work.\n\n> 2. This is disturbing:\n> \n> ```\n> sage: K.<I> = NumberField(x^2+1)\n> sage: K.pari_polynomial()\n> x^2 + 1\n> sage: K.pari_polynomial('I')\n> 0\n> ```\n> I would rather get an error message in the latter case.\n\nOkay, that should be fixable (currently, we simply substitute instead of creating a polynomial with a given variable).",
    "created_at": "2011-10-04T18:20:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11891#issuecomment-124859",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:4" align="right">comment:4</div>

Replying to [@williamstein](#comment%3A3):
> The code looks good, and passes tests, and it means we can at least compute discriminants. 
> 
> The first and second things I try still don't work though, and I'm curious what you think about this:
> 
> ```
> sage: k.<a, c> = NumberField([x^2 + 1/3, x^2 + 1/4])
> sage: k
> Number Field in a with defining polynomial x^2 + 1/3 over its base field
> sage: a+c
>   ***   Warning: non-monic polynomial. Result of the form [nf,c].
> ERROR: An unexpected error occurred while tokenizing input
> ... 
> BOOM!
> sage: k.relative_discriminant()
>   ***   Warning: non-monic polynomial. Result of the form [nf,c].
> BOOM!
> ```
> 
> 
> Side Remarks: 1. I've always intended to just rewrite number fields to completely use
> 
> ```
> sage.schemes.elliptic_curves.heegner.make_monic
> ```
> behind the scenes, and do *everything* that involves PARI in all cases using a monic integral polynomial, and only convert to the user's representation for input and output.  I wish I had done that when I was first writing number fields.

I never intended this ticket to completely fix non-integral/non-monic number fields.  I can have a look at the error messages above and try to fix them, but I also do not want to put too much effort.  The main motivation for this ticket was to support #11890, for which it seems to work.

> 2. This is disturbing:
> 
> ```
> sage: K.<I> = NumberField(x^2+1)
> sage: K.pari_polynomial()
> x^2 + 1
> sage: K.pari_polynomial('I')
> 0
> ```
> I would rather get an error message in the latter case.

Okay, that should be fixable (currently, we simply substitute instead of creating a polynomial with a given variable).



---

archive/issue_events_158702.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-10-04T18:20:24Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11891",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11891#event-158702"
}
```



---

archive/issue_events_158703.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-10-04T18:20:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11891",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11891#event-158703"
}
```



---

archive/issue_comments_124860.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nThis seems to cause a doctest failure in elliptic curves.  Given the severity of the failure, it is surprising that there is only one failure:\n\n```\nsage -t -long \"devel/sage/sage/schemes/elliptic_curves/gal_reps.py\"\n**********************************************************************\nFile \"/usr/local/src/sage-4.7.2.alpha2/devel/sage/sage/schemes/elliptic_curves/gal_reps.py\", line 257:\n    sage: L = _division_field(E,5); L   # long time (4s on sage.math, 2011)\nExpected:\n    Number Field in a with defining polynomial Y^2 + Y - 7544/9663480699587560272216796875*b^18 - 922862/10473721227685546875*b^12 - 2459197/170278453125*b^6 - 859421/1661 over its base field\nGot:\n    Number Field in b with defining polynomial x^48 + 24*x^47 - 2634*x^46 - 64906*x^45 + 2726775*x^44 + 70841232*x^43 + 224413842693*x^42 + 4701700599732*x^41 - 3592508072137596/5*x^40 - 15012293781179144*x^39 + 968283011174870355*x^38 + 20267256109653557724*x^37 + 12067484020318191883430*x^36 + 1074616923704149785005406/5*x^35 - 36733858365780941833244052*x^34 - 645743028366047451133249842*x^33 + 220969510763490262549458235143/5*x^32 + 3821508904338000023273602548048/5*x^31 - 116959091827892505647463476639056/5*x^30 - 410999736248972608356551138775366*x^29 - 14893829970063945547808915701339152/5*x^28 - 65364599206437988881942239704947194/5*x^27 + 67673426654602996794997806980859832818/5*x^26 + 881882930983056033772717698410508954006/5*x^25 - 222881687343119655077359346112642829420824/25*x^24 - 2895120823335191010101881263518064564214338/25*x^23 + 45001727573606034388747893503112487075055856/25*x^22 + 123791333776720160716501836669886842723129232/5*x^21 + 33784656476525285313173627304265791556761499182/25*x^20 + 315309937263412002519549766396743184287341740362/25*x^19 - 29809326189907478934703273836943134749630766073937/25*x^18 - 277139669604549129326940625213109992460300794466472/25*x^17 + 48267417458901196371693187503590931071511693353624403/125*x^16 + 417747951937480880271176634423393038757023573062901214/125*x^15 + 2007263826796309855277267487981686566625095650300775449/125*x^14 + 6629329384200142639862088631838847849519261327732912678/125*x^13 - 7890086815228540044028318696011082482007739165946890467526/125*x^12 - 47407282438244289856698339380010252170030182743016263979758/125*x^11 + 3298070588288796211686670268348031992948626610010905491413867/125*x^10 + 16925026780847521477088033404397720576309067225732939278573654/125*x^9 - 12606276975554600131707859641843171596158942063398834295739121081/3125*x^8 - 52976903401697668325123474606327892765221094244312074003749191524/3125*x^7 - 1938266538684772533113390852600216820719603074035866039130578333001/3125*x^6 - 5627590284654484129751875434157935192705922694236805197727447225544/3125*x^5 + 285380988605606088041604497638523394233117370690633546039125252974974/625*x^4 + 2863126544037648956156470697472798773649141080128520101958284622979502/3125*x^3 - 292971118345690446877843351574720458113286307337430973163488739432371577/3125*x^2 - 294403610592013769220290971977947932182340270515731034223504446414069348/3125*x + 128890191901531504726282929609520479109501654595823184011440588325811602871/15625\n**********************************************************************\n```",
    "created_at": "2011-10-04T19:41:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11891#issuecomment-124860",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:5" align="right">comment:5</div>

This seems to cause a doctest failure in elliptic curves.  Given the severity of the failure, it is surprising that there is only one failure:

```
sage -t -long "devel/sage/sage/schemes/elliptic_curves/gal_reps.py"
**********************************************************************
File "/usr/local/src/sage-4.7.2.alpha2/devel/sage/sage/schemes/elliptic_curves/gal_reps.py", line 257:
    sage: L = _division_field(E,5); L   # long time (4s on sage.math, 2011)
Expected:
    Number Field in a with defining polynomial Y^2 + Y - 7544/9663480699587560272216796875*b^18 - 922862/10473721227685546875*b^12 - 2459197/170278453125*b^6 - 859421/1661 over its base field
Got:
    Number Field in b with defining polynomial x^48 + 24*x^47 - 2634*x^46 - 64906*x^45 + 2726775*x^44 + 70841232*x^43 + 224413842693*x^42 + 4701700599732*x^41 - 3592508072137596/5*x^40 - 15012293781179144*x^39 + 968283011174870355*x^38 + 20267256109653557724*x^37 + 12067484020318191883430*x^36 + 1074616923704149785005406/5*x^35 - 36733858365780941833244052*x^34 - 645743028366047451133249842*x^33 + 220969510763490262549458235143/5*x^32 + 3821508904338000023273602548048/5*x^31 - 116959091827892505647463476639056/5*x^30 - 410999736248972608356551138775366*x^29 - 14893829970063945547808915701339152/5*x^28 - 65364599206437988881942239704947194/5*x^27 + 67673426654602996794997806980859832818/5*x^26 + 881882930983056033772717698410508954006/5*x^25 - 222881687343119655077359346112642829420824/25*x^24 - 2895120823335191010101881263518064564214338/25*x^23 + 45001727573606034388747893503112487075055856/25*x^22 + 123791333776720160716501836669886842723129232/5*x^21 + 33784656476525285313173627304265791556761499182/25*x^20 + 315309937263412002519549766396743184287341740362/25*x^19 - 29809326189907478934703273836943134749630766073937/25*x^18 - 277139669604549129326940625213109992460300794466472/25*x^17 + 48267417458901196371693187503590931071511693353624403/125*x^16 + 417747951937480880271176634423393038757023573062901214/125*x^15 + 2007263826796309855277267487981686566625095650300775449/125*x^14 + 6629329384200142639862088631838847849519261327732912678/125*x^13 - 7890086815228540044028318696011082482007739165946890467526/125*x^12 - 47407282438244289856698339380010252170030182743016263979758/125*x^11 + 3298070588288796211686670268348031992948626610010905491413867/125*x^10 + 16925026780847521477088033404397720576309067225732939278573654/125*x^9 - 12606276975554600131707859641843171596158942063398834295739121081/3125*x^8 - 52976903401697668325123474606327892765221094244312074003749191524/3125*x^7 - 1938266538684772533113390852600216820719603074035866039130578333001/3125*x^6 - 5627590284654484129751875434157935192705922694236805197727447225544/3125*x^5 + 285380988605606088041604497638523394233117370690633546039125252974974/625*x^4 + 2863126544037648956156470697472798773649141080128520101958284622979502/3125*x^3 - 292971118345690446877843351574720458113286307337430973163488739432371577/3125*x^2 - 294403610592013769220290971977947932182340270515731034223504446414069348/3125*x + 128890191901531504726282929609520479109501654595823184011440588325811602871/15625
**********************************************************************
```



---

archive/issue_events_158704.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-10-07T13:49:07Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11891",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11891#event-158704"
}
```



---

archive/issue_events_158705.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-10-07T13:49:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11891",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11891#event-158705"
}
```



---

archive/issue_comments_124861.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nAttachment: **[11891.patch.gz](https://github.com/sagemath/sage/files/ticket11891/11891.patch.gz)**\n\nNew patch, not yet fully tested.",
    "created_at": "2011-10-07T13:49:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11891#issuecomment-124861",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:6" align="right">comment:6</div>

Attachment: **[11891.patch.gz](https://github.com/sagemath/sage/files/ticket11891/11891.patch.gz)**

New patch, not yet fully tested.



---

archive/issue_comments_124862.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -42,3 +42,14 @@\n PariError: inconsistent data (12)\n ```\n With the patch, this works.\n+\n+This patch also fixes\n+\n+```\n+sage: K.<I> = NumberField(x^2+1)\n+sage: K.pari_polynomial('I')\n+0\n+```\n+by raising `PariError` instead.\n+\n+By chance, it also fixes `_division_field()` for elliptic curves which now *always* returns an absolute field.\n``````\n",
    "created_at": "2011-10-07T13:49:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11891#issuecomment-124862",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -42,3 +42,14 @@
 PariError: inconsistent data (12)
 ```
 With the patch, this works.
+
+This patch also fixes
+
+```
+sage: K.<I> = NumberField(x^2+1)
+sage: K.pari_polynomial('I')
+0
+```
+by raising `PariError` instead.
+
+By chance, it also fixes `_division_field()` for elliptic curves which now *always* returns an absolute field.
``````




---

archive/issue_comments_124863.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nWith the new patch, all long tests in `sage/rings` and `sage/schemes/elliptic_curves` pass.  Needs review.",
    "created_at": "2011-10-07T14:58:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11891#issuecomment-124863",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:7" align="right">comment:7</div>

With the new patch, all long tests in `sage/rings` and `sage/schemes/elliptic_curves` pass.  Needs review.



---

archive/issue_comments_124864.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nLooks ok to me.\n\nfully tested in sage-4.7.1. The code and the tests seem fine. It does not allow to operate in towers of numberfields with nonintegral generators, but neither worked in previous Sage versions.\n\nI have a question regarding pari_relative_polynomial in number_field_rel\n\nThe output of this method will be a monic polynomial. So we may have non-trivial denominators. Is this OK?",
    "created_at": "2011-10-09T15:29:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11891#issuecomment-124864",
    "user": "https://github.com/lftabera"
}
```

<div id="comment:8" align="right">comment:8</div>

Looks ok to me.

fully tested in sage-4.7.1. The code and the tests seem fine. It does not allow to operate in towers of numberfields with nonintegral generators, but neither worked in previous Sage versions.

I have a question regarding pari_relative_polynomial in number_field_rel

The output of this method will be a monic polynomial. So we may have non-trivial denominators. Is this OK?



---

archive/issue_comments_124865.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nReplying to [@lftabera](#comment%3A8):\n> The output of this method will be a monic polynomial. So we may have non-trivial denominators. Is this OK?\n\nIt's the only way.  There is no meaningful definition of the \"denominator\" of a polynomial over a number field.  So in order to get something canonical, let's take the monic polynomial.",
    "created_at": "2011-10-09T20:46:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11891#issuecomment-124865",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:9" align="right">comment:9</div>

Replying to [@lftabera](#comment%3A8):
> The output of this method will be a monic polynomial. So we may have non-trivial denominators. Is this OK?

It's the only way.  There is no meaningful definition of the "denominator" of a polynomial over a number field.  So in order to get something canonical, let's take the monic polynomial.



---

archive/issue_comments_124866.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@jdemeyer](#comment%3A9):\n> Replying to [@lftabera](#comment%3A8):\n> > The output of this method will be a monic polynomial. So we may have non-trivial denominators. Is this OK?\n> \n> It's the only way.  There is no meaningful definition of the \"denominator\" of a polynomial over a number field. \n\nPedantic point:  you can define a denominator ideal sensibly (exercise), just as for number field elements.  But that's not really relevant!\n\nAny reason why Luis did not give a positive review?  I have added his name to the Reviewers field",
    "created_at": "2011-10-09T21:31:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11891#issuecomment-124866",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@jdemeyer](#comment%3A9):
> Replying to [@lftabera](#comment%3A8):
> > The output of this method will be a monic polynomial. So we may have non-trivial denominators. Is this OK?
> 
> It's the only way.  There is no meaningful definition of the "denominator" of a polynomial over a number field. 

Pedantic point:  you can define a denominator ideal sensibly (exercise), just as for number field elements.  But that's not really relevant!

Any reason why Luis did not give a positive review?  I have added his name to the Reviewers field



---

archive/issue_comments_124867.json:
```json
{
    "body": "Reviewer: **Luis Felipe Tabera Alonso**",
    "created_at": "2011-10-09T21:31:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11891#issuecomment-124867",
    "user": "https://github.com/JohnCremona"
}
```

Reviewer: **Luis Felipe Tabera Alonso**



---

archive/issue_comments_124868.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nI have not finish yet...",
    "created_at": "2011-10-09T21:46:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11891#issuecomment-124868",
    "user": "https://github.com/lftabera"
}
```

<div id="comment:11" align="right">comment:11</div>

I have not finish yet...



---

archive/issue_comments_124869.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nNow I am done, positive review.",
    "created_at": "2011-10-10T15:22:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11891#issuecomment-124869",
    "user": "https://github.com/lftabera"
}
```

<div id="comment:12" align="right">comment:12</div>

Now I am done, positive review.



---

archive/issue_events_158706.json:
```json
{
    "actor": "https://github.com/lftabera",
    "created_at": "2011-10-10T15:22:50Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11891",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11891#event-158706"
}
```



---

archive/issue_events_158707.json:
```json
{
    "actor": "https://github.com/lftabera",
    "created_at": "2011-10-10T15:22:50Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/11891",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11891#event-158707"
}
```



---

archive/issue_comments_124870.json:
```json
{
    "body": "Merged: **sage-4.7.3.alpha0**",
    "created_at": "2011-10-20T09:21:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11891#issuecomment-124870",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-4.7.3.alpha0**



---

archive/issue_events_158708.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-10-20T09:21:15Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/11891",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11891#event-158708"
}
```



---

archive/issue_events_158709.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-10-20T09:21:15Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/11891",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11891#event-158709"
}
```



---

archive/issue_events_158710.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-11-03T16:14:43Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/11891",
    "milestone_number": null,
    "milestone_title": "sage-4.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11891#event-158710"
}
```



---

archive/issue_comments_124871.json:
```json
{
    "body": "Milestone sage-4.7.3 deleted",
    "created_at": "2011-11-03T16:14:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11891#issuecomment-124871",
    "user": "https://github.com/jdemeyer"
}
```

Milestone sage-4.7.3 deleted



---

archive/issue_comments_124872.json:
```json
{
    "body": "Changed merged from **sage-4.7.3.alpha0** to **sage-4.8.alpha0**",
    "created_at": "2011-11-03T16:18:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/11891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/11891#issuecomment-124872",
    "user": "https://github.com/jdemeyer"
}
```

Changed merged from **sage-4.7.3.alpha0** to **sage-4.8.alpha0**



---

archive/issue_events_158711.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-11-03T16:18:36Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/11891",
    "milestone_number": null,
    "milestone_title": "sage-4.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/11891#event-158711"
}
```
