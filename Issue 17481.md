# Issue 17481: Further clean-up of expect.py

archive/issues_017481.json:
```json
{
    "body": "\n\nIssue created by migration from https://trac.sagemath.org/ticket/17718\n\n",
    "created_at": "2015-02-03T09:33:17Z",
    "labels": [
        "interfaces",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.6",
    "title": "Further clean-up of expect.py",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17481",
    "user": "@jdemeyer"
}
```


Issue created by migration from https://trac.sagemath.org/ticket/17718





---

archive/issue_comments_233576.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-02-03T11:26:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17481#issuecomment-233576",
    "user": "@jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_233577.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-02-03T11:26:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17481#issuecomment-233577",
    "user": "@jdemeyer"
}
```

New commits:



---

archive/issue_comments_233578.json:
```json
{
    "body": "Why\n\n```\n if self.silent:\n-     return\n+     return self.interface\n```\n\nIf this is necessary, could you add a doctest?",
    "created_at": "2015-02-04T21:17:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17481#issuecomment-233578",
    "user": "@videlec"
}
```

Why

```
 if self.silent:
-     return
+     return self.interface
```

If this is necessary, could you add a doctest?



---

archive/issue_comments_233579.json:
```json
{
    "body": "Replying to [comment:3 vdelecroix]:\n> Why\n> {{{\n>  if self.silent:\n> -     return\n> +     return self.interface\n> }}}\n> If this is necessary, could you add a doctest?\nIt's to allow `with StdOutContext(...) as ...` as opposed to just `with StdOutContext(...)`.\n\nSo it's covered by this doctest change:\n\n```diff\n-sage: with StdOutContext(gp):\n-...       gp('1+1')\n-...\n+sage: with StdOutContext(Gp()) as g:\n+....:     g('1+1')\n```\n",
    "created_at": "2015-02-05T07:52:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17481#issuecomment-233579",
    "user": "@jdemeyer"
}
```

Replying to [comment:3 vdelecroix]:
> Why
> {{{
>  if self.silent:
> -     return
> +     return self.interface
> }}}
> If this is necessary, could you add a doctest?
It's to allow `with StdOutContext(...) as ...` as opposed to just `with StdOutContext(...)`.

So it's covered by this doctest change:

```diff
-sage: with StdOutContext(gp):
-...       gp('1+1')
-...
+sage: with StdOutContext(Gp()) as g:
+....:     g('1+1')
```




---

archive/issue_comments_233580.json:
```json
{
    "body": "Why that extra commit?",
    "created_at": "2015-02-05T13:23:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17481#issuecomment-233580",
    "user": "@jdemeyer"
}
```

Why that extra commit?



---

archive/issue_comments_233581.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-02-05T13:23:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17481#issuecomment-233581",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_233582.json:
```json
{
    "body": "Replying to [comment:6 jdemeyer]:\n> Why that extra commit?\n\nAs the commit message says: to make the optional test involving octave pass also when the tests are run with `--optional=octave`, not `--optional=sage,octave`.",
    "created_at": "2015-02-05T13:28:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17481#issuecomment-233582",
    "user": "@mezzarobba"
}
```

Replying to [comment:6 jdemeyer]:
> Why that extra commit?

As the commit message says: to make the optional test involving octave pass also when the tests are run with `--optional=octave`, not `--optional=sage,octave`.



---

archive/issue_comments_233583.json:
```json
{
    "body": "Replying to [comment:7 mmezzarobba]:\n> Replying to [comment:6 jdemeyer]:\n> > Why that extra commit?\n> \n> As the commit message says: to make the optional test involving octave pass also when the tests are run with `--optional=octave`, not `--optional=sage,octave`.\nI'm not aware of any general rule that tests should pass when run with `./sage -t --optional=octave`. I prefer to have as few tests as possible optional.",
    "created_at": "2015-02-05T13:31:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17481#issuecomment-233583",
    "user": "@jdemeyer"
}
```

Replying to [comment:7 mmezzarobba]:
> Replying to [comment:6 jdemeyer]:
> > Why that extra commit?
> 
> As the commit message says: to make the optional test involving octave pass also when the tests are run with `--optional=octave`, not `--optional=sage,octave`.
I'm not aware of any general rule that tests should pass when run with `./sage -t --optional=octave`. I prefer to have as few tests as possible optional.



---

archive/issue_comments_233584.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-02-05T13:32:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17481#issuecomment-233584",
    "user": "@jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_233585.json:
```json
{
    "body": "In any case, this could be discussed in a different ticket.",
    "created_at": "2015-02-05T13:32:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17481#issuecomment-233585",
    "user": "@jdemeyer"
}
```

In any case, this could be discussed in a different ticket.



---

archive/issue_comments_233586.json:
```json
{
    "body": "Replying to [comment:8 jdemeyer]:\n> I'm not aware of any general rule that tests should pass when run with `./sage -t --optional=octave`.\n\nWhat is the point of having an option `--optional=octave` that does not imply `--optional=sage`, then?\n\n> I prefer to have as few tests as possible optional.\n\nI agree in principle, but here I don't think the example without its `optional` part is a meaningful test case.\n\nAnyway, I'm fine with leaving that change out if you prefer.",
    "created_at": "2015-02-05T13:55:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17481#issuecomment-233586",
    "user": "@mezzarobba"
}
```

Replying to [comment:8 jdemeyer]:
> I'm not aware of any general rule that tests should pass when run with `./sage -t --optional=octave`.

What is the point of having an option `--optional=octave` that does not imply `--optional=sage`, then?

> I prefer to have as few tests as possible optional.

I agree in principle, but here I don't think the example without its `optional` part is a meaningful test case.

Anyway, I'm fine with leaving that change out if you prefer.



---

archive/issue_comments_233587.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-02-05T13:55:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17481#issuecomment-233587",
    "user": "@mezzarobba"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_233588.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2015-02-21T12:13:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17481#issuecomment-233588",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_233589.json:
```json
{
    "body": "This leads to random failures in the R interface on my desktop (Haswell-E Linux x86_64, background computation running)\n\n```\nsage -t --long src/sage/interfaces/r.py\n**********************************************************************\nFile \"src/sage/interfaces/r.py\", line 24, in sage.interfaces.r\nFailed example:\n    1/x\nExpected:\n    [1] 0.09615385 0.17857143 0.32258065 0.15625000 0.04608295\nGot:\n    <BLANKLINE>\n\ncommand timed out: 1200 seconds without output running ['./sage', '-t', '-p', '8', '--all', '--long', '--logfile=logs/ptestlong.log'], attempting to kill\nprocess killed by signal 9\nprogram finished with exit code -1\nelapsedTime=2461.278640\n```\n",
    "created_at": "2015-02-21T12:13:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17481#issuecomment-233589",
    "user": "@vbraun"
}
```

This leads to random failures in the R interface on my desktop (Haswell-E Linux x86_64, background computation running)

```
sage -t --long src/sage/interfaces/r.py
**********************************************************************
File "src/sage/interfaces/r.py", line 24, in sage.interfaces.r
Failed example:
    1/x
Expected:
    [1] 0.09615385 0.17857143 0.32258065 0.15625000 0.04608295
Got:
    <BLANKLINE>

command timed out: 1200 seconds without output running ['./sage', '-t', '-p', '8', '--all', '--long', '--logfile=logs/ptestlong.log'], attempting to kill
process killed by signal 9
program finished with exit code -1
elapsedTime=2461.278640
```




---

archive/issue_comments_233590.json:
```json
{
    "body": "another failed example (seems to be falling over a prompt in the R docs if you are unlucky with the timing):\n\n```\n$ SAGE_PEXPECT_LOG=yes sage -bt --long --verbose src/sage/interfaces/r.py \n[...]\nTrying (line 1955):    print length._sage_doc_()\nExpecting:\n    length                 package:base                 R Documentation\n    ...\n    <BLANKLINE>\nok [0.04 s]\nTrying (line 1959):    sig_on_count()\nExpecting:\n    0\nok [0.00 s]\nTrying (line 1969):    length = r.length\nExpecting nothing\nok [0.00 s]\nTrying (line 1970):    print length._sage_src_()\nExpecting:\nTrying (line 1970):    print length._sage_src_()\nExpecting:\n    function (x)  .Primitive(\"length\")\nok [0.00 s]\nTrying (line 1973):    sig_on_count()\nExpecting:\n    0\nok [0.00 s]\nTrying (line 1981):    length = r.length\nExpecting nothing\nok [0.00 s]\nTrying (line 1982):    length([1,2,3])\nExpecting:\n    [1] 3\n... hangs ...\n```\n\npexpect log:\n\n```\n[...]\nExamples:\n\n     length(diag(4))  # = 16 (4 x 4)\n     length(options())  # 12 or more\n     length(y ~ x1 + x2 + x3)  # 3\n     length(expression(x, {y <- x^2; y+2}, x^y))  # 3\n     \n     ## from example(warpbreaks)\n     require(stats)\n     \n     fm1 <- lm(breaks ~ wool * tension, data = warpbreaks)\n     length(fm1$call)      # 3, lm() and two arguments.\n     length(formula(fm1))  # 3, ~ lhs rhs\n     \n\n__SAGE__R__PROMPT__> 1+310416896;\n[1] 310416897\n__SAGE__R__PROMPT__> length\nlength\nfunction (x)  .Primitive(\"length\")\n__SAGE__R__PROMPT__> 1+1371999567;\n[1] 1.372e+09\n__SAGE__R__PROMPT__> \ufffd\nquit(save=\"no\")\n\n__SAGE__R__PROMPT__> \n__SAGE__R__PROMPT__> ^C\nquit(save=\"no\")\n\nsage2 <- 1\nsage2 <- 1\n1+1305756531;\nquit(save=\"no\")\n```\n",
    "created_at": "2015-02-21T12:37:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17481#issuecomment-233590",
    "user": "@vbraun"
}
```

another failed example (seems to be falling over a prompt in the R docs if you are unlucky with the timing):

```
$ SAGE_PEXPECT_LOG=yes sage -bt --long --verbose src/sage/interfaces/r.py 
[...]
Trying (line 1955):    print length._sage_doc_()
Expecting:
    length                 package:base                 R Documentation
    ...
    <BLANKLINE>
ok [0.04 s]
Trying (line 1959):    sig_on_count()
Expecting:
    0
ok [0.00 s]
Trying (line 1969):    length = r.length
Expecting nothing
ok [0.00 s]
Trying (line 1970):    print length._sage_src_()
Expecting:
Trying (line 1970):    print length._sage_src_()
Expecting:
    function (x)  .Primitive("length")
ok [0.00 s]
Trying (line 1973):    sig_on_count()
Expecting:
    0
ok [0.00 s]
Trying (line 1981):    length = r.length
Expecting nothing
ok [0.00 s]
Trying (line 1982):    length([1,2,3])
Expecting:
    [1] 3
... hangs ...
```

pexpect log:

```
[...]
Examples:

     length(diag(4))  # = 16 (4 x 4)
     length(options())  # 12 or more
     length(y ~ x1 + x2 + x3)  # 3
     length(expression(x, {y <- x^2; y+2}, x^y))  # 3
     
     ## from example(warpbreaks)
     require(stats)
     
     fm1 <- lm(breaks ~ wool * tension, data = warpbreaks)
     length(fm1$call)      # 3, lm() and two arguments.
     length(formula(fm1))  # 3, ~ lhs rhs
     

__SAGE__R__PROMPT__> 1+310416896;
[1] 310416897
__SAGE__R__PROMPT__> length
length
function (x)  .Primitive("length")
__SAGE__R__PROMPT__> 1+1371999567;
[1] 1.372e+09
__SAGE__R__PROMPT__> ï¿½
quit(save="no")

__SAGE__R__PROMPT__> 
__SAGE__R__PROMPT__> ^C
quit(save="no")

sage2 <- 1
sage2 <- 1
1+1305756531;
quit(save="no")
```




---

archive/issue_comments_233591.json:
```json
{
    "body": "Replying to [comment:11 vbraun]:\n> This leads to random failures in the R interface on my desktop\nAre you really sure that this is caused by this ticket? The point is that this ticket is really a clean-up ticket, with almost no functional changes.",
    "created_at": "2015-02-21T13:08:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17481#issuecomment-233591",
    "user": "@jdemeyer"
}
```

Replying to [comment:11 vbraun]:
> This leads to random failures in the R interface on my desktop
Are you really sure that this is caused by this ticket? The point is that this ticket is really a clean-up ticket, with almost no functional changes.



---

archive/issue_comments_233592.json:
```json
{
    "body": "Well maybe it triggers a pre-existing bug. All I know for sure is that doctests get stuck in R on my machine with it.",
    "created_at": "2015-02-21T13:17:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17481#issuecomment-233592",
    "user": "@vbraun"
}
```

Well maybe it triggers a pre-existing bug. All I know for sure is that doctests get stuck in R on my machine with it.



---

archive/issue_comments_233593.json:
```json
{
    "body": "How common is this failure?",
    "created_at": "2015-02-21T15:52:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17481#issuecomment-233593",
    "user": "@jdemeyer"
}
```

How common is this failure?



---

archive/issue_comments_233594.json:
```json
{
    "body": "Maybe 50% when the system is under load...",
    "created_at": "2015-02-21T16:25:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17481#issuecomment-233594",
    "user": "@vbraun"
}
```

Maybe 50% when the system is under load...



---

archive/issue_comments_233595.json:
```json
{
    "body": "When I have some time, I'll try to reproduce it. The only possible reason that I can think of is the change `self._interrupt()` -> `self.interrupt()`\n\nIf that's the cause, I suggest to just revert that.",
    "created_at": "2015-02-21T17:50:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17481#issuecomment-233595",
    "user": "@jdemeyer"
}
```

When I have some time, I'll try to reproduce it. The only possible reason that I can think of is the change `self._interrupt()` -> `self.interrupt()`

If that's the cause, I suggest to just revert that.



---

archive/issue_comments_233596.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-02-22T09:33:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17481#issuecomment-233596",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_233597.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-02-22T09:33:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17481#issuecomment-233597",
    "user": "@jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_233598.json:
```json
{
    "body": "I confirm the issue and this should fix it.",
    "created_at": "2015-02-22T09:33:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17481#issuecomment-233598",
    "user": "@jdemeyer"
}
```

I confirm the issue and this should fix it.



---

archive/issue_comments_233599.json:
```json
{
    "body": "Patchbot says fine. Tests in `interfaces` on my machine pass too. As the code was already reviewed by others I dare to set positive.",
    "created_at": "2015-02-25T15:04:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17481#issuecomment-233599",
    "user": "@rwst"
}
```

Patchbot says fine. Tests in `interfaces` on my machine pass too. As the code was already reviewed by others I dare to set positive.



---

archive/issue_comments_233600.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-02-25T15:04:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17481#issuecomment-233600",
    "user": "@rwst"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_233601.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-02-26T07:11:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17481#issuecomment-233601",
    "user": "@vbraun"
}
```

Resolution: fixed
