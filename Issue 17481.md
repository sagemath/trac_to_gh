# Issue 17481: Further clean-up of expect.py

Issue created by migration from https://trac.sagemath.org/ticket/17718

Original creator: jdemeyer

Original creation time: 2015-02-03 09:33:17




---

Comment by jdemeyer created at 2015-02-03 11:26:24

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2015-02-03 11:26:24

New commits:


---

Comment by vdelecroix created at 2015-02-04 21:17:20

Why

```
 if self.silent:
-     return
+     return self.interface
```

If this is necessary, could you add a doctest?


---

Comment by jdemeyer created at 2015-02-05 07:52:09

Replying to [comment:3 vdelecroix]:
> Why
> {{{
>  if self.silent:
> -     return
> +     return self.interface
> }}}
> If this is necessary, could you add a doctest?
It's to allow `with StdOutContext(...) as ...` as opposed to just `with StdOutContext(...)`.

So it's covered by this doctest change:

```diff
-sage: with StdOutContext(gp):
-...       gp('1+1')
-...
+sage: with StdOutContext(Gp()) as g:
+....:     g('1+1')
```



---

Comment by jdemeyer created at 2015-02-05 13:23:39

Why that extra commit?


---

Comment by jdemeyer created at 2015-02-05 13:23:39

Changing status from needs_review to needs_work.


---

Comment by mmezzarobba created at 2015-02-05 13:28:01

Replying to [comment:6 jdemeyer]:
> Why that extra commit?

As the commit message says: to make the optional test involving octave pass also when the tests are run with `--optional=octave`, not `--optional=sage,octave`.


---

Comment by jdemeyer created at 2015-02-05 13:31:45

Replying to [comment:7 mmezzarobba]:
> Replying to [comment:6 jdemeyer]:
> > Why that extra commit?
> 
> As the commit message says: to make the optional test involving octave pass also when the tests are run with `--optional=octave`, not `--optional=sage,octave`.
I'm not aware of any general rule that tests should pass when run with `./sage -t --optional=octave`. I prefer to have as few tests as possible optional.


---

Comment by jdemeyer created at 2015-02-05 13:32:27

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-02-05 13:32:27

In any case, this could be discussed in a different ticket.


---

Comment by mmezzarobba created at 2015-02-05 13:55:51

Replying to [comment:8 jdemeyer]:
> I'm not aware of any general rule that tests should pass when run with `./sage -t --optional=octave`.

What is the point of having an option `--optional=octave` that does not imply `--optional=sage`, then?

> I prefer to have as few tests as possible optional.

I agree in principle, but here I don't think the example without its `optional` part is a meaningful test case.

Anyway, I'm fine with leaving that change out if you prefer.


---

Comment by mmezzarobba created at 2015-02-05 13:55:51

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-02-21 12:13:39

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2015-02-21 12:13:39

This leads to random failures in the R interface on my desktop (Haswell-E Linux x86_64, background computation running)

```
sage -t --long src/sage/interfaces/r.py
**********************************************************************
File "src/sage/interfaces/r.py", line 24, in sage.interfaces.r
Failed example:
    1/x
Expected:
    [1] 0.09615385 0.17857143 0.32258065 0.15625000 0.04608295
Got:
    <BLANKLINE>

command timed out: 1200 seconds without output running ['./sage', '-t', '-p', '8', '--all', '--long', '--logfile=logs/ptestlong.log'], attempting to kill
process killed by signal 9
program finished with exit code -1
elapsedTime=2461.278640
```



---

Comment by vbraun created at 2015-02-21 12:37:13

another failed example (seems to be falling over a prompt in the R docs if you are unlucky with the timing):

```
$ SAGE_PEXPECT_LOG=yes sage -bt --long --verbose src/sage/interfaces/r.py 
[...]
Trying (line 1955):    print length._sage_doc_()
Expecting:
    length                 package:base                 R Documentation
    ...
    <BLANKLINE>
ok [0.04 s]
Trying (line 1959):    sig_on_count()
Expecting:
    0
ok [0.00 s]
Trying (line 1969):    length = r.length
Expecting nothing
ok [0.00 s]
Trying (line 1970):    print length._sage_src_()
Expecting:
Trying (line 1970):    print length._sage_src_()
Expecting:
    function (x)  .Primitive("length")
ok [0.00 s]
Trying (line 1973):    sig_on_count()
Expecting:
    0
ok [0.00 s]
Trying (line 1981):    length = r.length
Expecting nothing
ok [0.00 s]
Trying (line 1982):    length([1,2,3])
Expecting:
    [1] 3
... hangs ...
```

pexpect log:

```
[...]
Examples:

     length(diag(4))  # = 16 (4 x 4)
     length(options())  # 12 or more
     length(y ~ x1 + x2 + x3)  # 3
     length(expression(x, {y <- x^2; y+2}, x^y))  # 3
     
     ## from example(warpbreaks)
     require(stats)
     
     fm1 <- lm(breaks ~ wool * tension, data = warpbreaks)
     length(fm1$call)      # 3, lm() and two arguments.
     length(formula(fm1))  # 3, ~ lhs rhs
     

__SAGE__R__PROMPT__> 1+310416896;
[1] 310416897
__SAGE__R__PROMPT__> length
length
function (x)  .Primitive("length")
__SAGE__R__PROMPT__> 1+1371999567;
[1] 1.372e+09
__SAGE__R__PROMPT__> ï¿½
quit(save="no")

__SAGE__R__PROMPT__> 
__SAGE__R__PROMPT__> ^C
quit(save="no")

sage2 <- 1
sage2 <- 1
1+1305756531;
quit(save="no")
```



---

Comment by jdemeyer created at 2015-02-21 13:08:35

Replying to [comment:11 vbraun]:
> This leads to random failures in the R interface on my desktop
Are you really sure that this is caused by this ticket? The point is that this ticket is really a clean-up ticket, with almost no functional changes.


---

Comment by vbraun created at 2015-02-21 13:17:41

Well maybe it triggers a pre-existing bug. All I know for sure is that doctests get stuck in R on my machine with it.


---

Comment by jdemeyer created at 2015-02-21 15:52:38

How common is this failure?


---

Comment by vbraun created at 2015-02-21 16:25:59

Maybe 50% when the system is under load...


---

Comment by jdemeyer created at 2015-02-21 17:50:45

When I have some time, I'll try to reproduce it. The only possible reason that I can think of is the change `self._interrupt()` -> `self.interrupt()`

If that's the cause, I suggest to just revert that.


---

Comment by git created at 2015-02-22 09:33:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-02-22 09:33:47

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-02-22 09:33:47

I confirm the issue and this should fix it.


---

Comment by rws created at 2015-02-25 15:04:55

Patchbot says fine. Tests in `interfaces` on my machine pass too. As the code was already reviewed by others I dare to set positive.


---

Comment by rws created at 2015-02-25 15:04:55

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-02-26 07:11:08

Resolution: fixed
