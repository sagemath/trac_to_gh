# Issue 31884: Replace MapCombinatorialClass

Issue created by migration from https://trac.sagemath.org/ticket/32121

Original creator: mkoeppe

Original creation time: 2021-07-04 02:54:05

CC:  tscrim chapoton roed @mwageringel

`EnumeratedSets.ParentMethods.map` uses `MapCombinatorialClass`.

`map`'s docstring explains that that class needs to be refactored to use categories.

Part of #12913 (Meta-ticket: Deprecate `CombinatorialClass` in favor of the `EnumeratedSet`'s categories)


---

Comment by git created at 2021-07-04 19:58:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-04 21:09:58

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-07-04 21:26:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-04 21:34:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-04 21:35:20

Here's an attempt


---

Comment by git created at 2021-07-04 22:05:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-04 23:16:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-05 03:02:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-06 05:43:46

Help with extending the doctests with examples relevant for combinatorics and algebra would be very welcome.


---

Comment by mkoeppe created at 2021-07-18 19:19:04

Changing status from new to needs_review.


---

Comment by git created at 2021-07-19 02:13:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-07-28 01:38:58

Sorry for being a bit slow to get to this.

This class is not so widely used within the codebase. I can only find:

- combinat/set_partition_ordered.py: `fatter()`
- combinat/root_systems/root_lattice_realizations.py: `negative_roots()`
- combinat/composition.py: `finer()` and `fatter()`
- combinat/free_module.py: The indices for the tensor product of CFMs

So if it works fine for these files, then it is a full replacement. These also are fairly extensively tested already I think. Thus, I don't think new tests are necessarily needed.


---

Comment by git created at 2021-08-02 00:58:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-08-02 00:58:50

Rebased, partially squashed, on 9.4.rc0


---

Comment by tscrim created at 2021-08-03 07:07:27

A few trivial failures, but also a more deeper issue:

```
sage -t --long --random-seed=0 src/sage/categories/finite_dimensional_modules_with_basis.py  # 1 doctest failed
sage -t --long --random-seed=0 src/sage/combinat/free_module.py  # 1 doctest failed
sage -t --long --random-seed=0 src/sage/categories/enumerated_sets.py  # 2 doctests failed
```

Additionally, there are many places that need some doctests. Would you like me to add them?


---

Comment by tscrim created at 2021-08-03 07:07:27

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-08-03 13:06:05

Any help on the ticket is welcome! I won't be able to work on it before mid August


---

Comment by tscrim created at 2021-10-06 06:29:23

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2021-10-06 06:29:23

I finally got around to working on this. I have made some tweaks, and I also fixed a few bugs. The biggest was moving the generic `image()` definition to the category. This was conflicting with the `image` defined for `ModulesWithBasis()`. There are still a few things that need doctests, but I don't know how to effectively doctest them (other than with something trivial).
----
New commits:


---

Comment by git created at 2021-11-06 01:58:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-09 06:41:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-19 18:31:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-19 18:47:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-19 18:59:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-19 19:11:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-19 19:13:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-19 19:24:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-19 19:43:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-19 19:53:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-02-19 19:55:17

I think this is ready now


---

Comment by git created at 2022-02-19 21:14:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2022-02-20 06:42:37

Thank you. Just a few more little things:

- Since `_star` is only called in one place, I think it should just be done inline. This will also save you from having to write a docstring/test for it.
- `lift` and `retract` need doctests.
- `MapCombinatorialClass`, `_an_element_`, and `ImageSet` are missing periods at the end of their one-line descriptions.
- In both `map()` docs:
  {{{#!diff
-        Use ``is_injective=False`` to get a correct result in this case.
+        Use ``is_injective=False`` to get a correct result in this case::
 
             sage: P.map(len, is_injective=False).list()
             [1, 2, 3, 4]
  }}}
  {{{#!diff
         INPUT:
 
         - ``is_injective`` -- boolean (default: ``True``) whether to assume
-          that ``f`` is injective.
+          that ``f`` is injective
  }}}
- I am not sure how I feel about being so detailed in the code copyright declaration. I understand the legal reason, but it is a bit tedious to maintain (it is already out of date) and might create legal issues with the license (including some people may not be claiming copyright as they did not change that statement). This is probably more towards bikeshedding though...


---

Comment by mkoeppe created at 2022-02-20 21:58:18

Replying to [comment:42 tscrim]:
> I am not sure how I feel about being so detailed in the code copyright declaration. I understand the legal reason,

More importantly perhaps, it looks much better if there is year for year activity by several authors. If copyright notices stop in 2006 because the updating work has been neglected, the file and perhaps the whole project looks stale to the casual observer.

> it is a bit tedious to maintain (it is already out of date)

It does not have to be perfect. And if it looks updated, people will be motivated to keep it updated.

> and might create legal issues with the license (including some people may not be claiming copyright as they did not change that statement). 

Copyright is established whether there is intent or not, whenever there is a copyrightable change in a given year.


---

Comment by git created at 2022-02-20 22:03:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-20 22:22:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2022-02-21 05:49:16

Thank you. Green bot => positive review.


---

Comment by mkoeppe created at 2022-02-21 20:14:40

Patchbot failures are unrelated.


---

Comment by mkoeppe created at 2022-02-21 20:14:40

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-02-24 19:02:06

This doctest seems to be random

```
**********************************************************************
File "src/sage/sets/image_set.py", line 275, in sage.sets.image_set.ImageSet
Failed example:
    ImageSet(sos, Set([(3, 4), (3, -4)]))
Expected:
    Image of
     {(3, -4), (3, 4)} by
     The map (x, y) |--> x^2 + y^2 from Vector space of dimension 2 over Symbolic Ring
Got:
    Image of {(3, 4), (3, -4)} by The map (x, y) |--> x^2 + y^2 from Vector space of dimension 2 over Symbolic Ring
**********************************************************************
1 item had failures:
   1 of   9 in sage.sets.image_set.ImageSet
    [52 tests, 1 failure, 0.25 s]
----------------------------------------------------------------------
sage -t --long --random-seed=0 src/sage/sets/image_set.py  # 1 doctest failed
----------------------------------------------------------------------
```



---

Comment by vbraun created at 2022-02-24 19:02:06

Changing status from positive_review to needs_work.


---

Comment by git created at 2022-02-24 22:44:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-02-24 22:44:13

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2022-02-27 22:00:43

Resolution: fixed
