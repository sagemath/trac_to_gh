# Issue 15492: Graphics3d with fractional opacity will not save image

Issue created by migration from https://trac.sagemath.org/ticket/15729

Original creator: niles

Original creation time: 2014-01-24 22:05:00

CC:  slelievre

Giving opacity as a fraction breaks the save method.  No error is raised and no image is created.


```
plot3d(lambda x, y: x^2 + y^2, (-2,2), (-2,2),opacity=8/10).save('~/tmp.png')
```


This appears to be a problem with tachyon not handling fractions.  Here is another example with an error message (shown with the keyword `verbosity=2`):


```
sage: S = sphere(opacity=8/10, aspect_ratio=[1,1,1], verbosity='2')
sage: S.save('~/tmp.png')
```




```
tachyon /Users/njohnson/.sage/temp/galileo/2623/tmp_zkpq5K.dat  -format PNG  -o ~/tmp.png  -res 500 500  +V ; rm -f "/Users/njohnson/.sage/temp/galileo/2623/tmp_zkpq5K.dat"
Tachyon Parallel/Multiprocessor Ray Tracer   Version 0.98.9   
Copyright 1994-2010,    John E. Stone <john.stone@gmail.com> 
------------------------------------------------------------ 
Parse Error:
   Encountered a syntax error in file /Users/njohnson/.sage/temp/galileo/2623/tmp_zkpq5K.dat
   Expected to find TEXFUNC
   Actually found: Color
   Error occured at or prior to file offset 656, line 29
   Error position is only approximate, but should be close

Parse Error:
   Encountered a syntax error in file /Users/njohnson/.sage/temp/galileo/2623/tmp_zkpq5K.dat
   Expected to find an object or other declaration
   Actually found: .4
   Error occured at or prior to file offset 660, line 29
   Error position is only approximate, but should be close

Parser failed due to an input file syntax error.
Aborting render.
```


Changing opacity to .8 in this example works as expected.


---

Comment by yzh created at 2018-04-04 17:05:18

New commits:


---

Comment by yzh created at 2018-04-04 17:05:18

Changing status from new to needs_review.


---

Comment by jipilab created at 2018-04-04 22:53:46

Looks good.

Could you add a test to show that the mentioned bug is fixed?


---

Comment by jipilab created at 2018-04-04 22:53:57

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-04-04 23:07:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by yzh created at 2018-04-04 23:09:15

Changing status from needs_work to needs_review.


---

Comment by yzh created at 2018-04-04 23:09:15

Changing keywords from "" to "IMA-PolyGeom, opacity".


---

Comment by jipilab created at 2018-04-05 20:48:51

There are 2 failed doctests:


```
File "src/sage/plot/plot3d/index_face_set.pyx", line 964, in sage.plot.plot3d.index_face_set.IndexFaceSet.json_repr
Failed example:
    G.json_repr(G.default_render_params())
Expected:
    ['{"vertices":[{"x":0,"y":0,"z":1},{"x":1,"y":1,"z":1},{"x":2,"y":0,"z":1}], "faces":[[0,1,2]], "color":"#0000ff", "opacity":1}']
Got:
    ['{"vertices":[{"x":0,"y":0,"z":1},{"x":1,"y":1,"z":1},{"x":2,"y":0,"z":1}], "faces":[[0,1,2]], "color":"#0000ff", "opacity":1.0}']
**********************************************************************
File "src/sage/plot/plot3d/index_face_set.pyx", line 976, in sage.plot.plot3d.index_face_set.IndexFaceSet.json_repr
Failed example:
    S.json_repr(S.default_render_params())
Expected:
    ['{"vertices":[{"x":2,"y":0,"z":0},..., "face_colors":["#ff0000","#ff9900","#cbff00","#33ff00"], "opacity":1}']
Got:
    ['{"vertices":[{"x":2,"y":0,"z":0},{"x":0,"y":2,"z":0},{"x":0,"y":0,"z":2},{"x":0,"y":1,"z":1},{"x":1,"y":0,"z":1},{"x":1,"y":1,"z":0}], "faces":[[0,4,5],[3,4,5],[2,3,4],[1,3,5]], "face_colors":["#ff0000","#ff9900","#cbff00","#33ff00"], "opacity":1.0}']
```



---

Comment by jipilab created at 2018-04-05 20:48:51

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-04-05 20:56:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slelievre created at 2018-04-06 06:43:59

Don't forget to set back to needs_review once reviewer comments are dealt with.


---

Comment by yzh created at 2018-04-06 14:20:37

Changing status from needs_work to needs_review.


---

Comment by jipilab created at 2018-04-06 16:56:18

Looks good to me. Once the bot give a green light, I would put positive review.


---

Comment by chapoton created at 2018-04-06 18:18:05

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2018-04-06 18:18:05

See patchbot report:

```
File "src/sage/plot/plot3d/base.pyx", line 329, in sage.plot.plot3d.base.Graphics3d._rich_repr_canvas3d
Failed example:
    out.canvas3d.get()
Expected:
    '[{"vertices":[{"x":0,"y":0,"z":-1},..., "color":"#6666ff", "opacity":1}]'
Got:
    '[{"vertices":[{"x":0,"y":0,"z":-1},..., "color":"#6666ff", "opacity":1.0}]'
```



---

Comment by git created at 2018-04-06 18:45:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by yzh created at 2018-04-06 18:46:35

Changing status from needs_work to needs_review.


---

Comment by jipilab created at 2018-04-06 22:39:06

Changing status from needs_review to positive_review.


---

Comment by jipilab created at 2018-04-06 22:39:06

It looks good to me.


---

Comment by vbraun created at 2018-05-08 17:27:41

Resolution: fixed
