# Issue 18511: Python library to bootstrap Sage

Issue created by migration from Trac.

Original creator: vbraun

Original creation time: 2015-06-20 13:09:28

CC:  ncohen




---

Comment by vbraun created at 2015-06-20 13:13:14

Changing component from PLEASE CHANGE to build.


---

Comment by vbraun created at 2015-06-20 13:13:14

Changing type from PLEASE CHANGE to defect.


---

Comment by git created at 2015-06-21 10:51:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2015-06-21 10:57:34

Changing status from new to needs_review.


---

Comment by vbraun created at 2015-06-21 10:57:34

Changing priority from major to blocker.


---

Comment by vbraun created at 2015-06-21 10:57:34

Now with testing:

```
$ tox
[...]
  py26: commands succeeded
  py27: commands succeeded
  py33: commands succeeded
  py34: commands succeeded
  congratulations :)
```



---

Comment by ncohen created at 2015-06-21 11:00:22

Can you explain in detail what you do in this branch? You make many changes, this ticket is now a blocker, and it takes a *LONG* time to figure it all out from looking at the diff.


---

Comment by vbraun created at 2015-06-21 11:07:32

* No actual functionality changed
* `sage-download-file` code is refactored into a package 
* Tests added for everything
* Output is explained in the README, no more if `self.verbose: printflush` hacks
* `sage-pkg` command to translate between package names and tarball filenames (and maybe query for package types in the future)


---

Comment by jdemeyer created at 2015-06-25 08:27:17

`sage-pkg` was the command to create old-style packages, now it's something completely different. Since we still support old-style packages, can't you rename this script?

Also: why is this a blocker? There is nothing in the description or comments justifying that.


---

Comment by jdemeyer created at 2015-06-25 08:31:56

About the directory structure: wouldn't it be simpler to keep the scripts in `src/bin` (they can still `import sage_bootstrap`) and then not use the redundant `sage_bootstrap/sage_bootstrap` subdirectory?


---

Comment by jdemeyer created at 2015-06-25 08:49:37

I honestly have no idea what `tox` does, but I tried it anyway:

```
jdemeyer`@`tamiyo:/usr/local/src/sage-config/src/sage_bootstrap$ uname -a
Linux tamiyo 3.17.7-gentoo #1 SMP PREEMPT Wed Dec 31 20:06:39 CET 2014 x86_64 Intel(R) Core(TM) i7-2640M CPU `@` 2.80GHz GenuineIntel GNU/Linux
```


```
jdemeyer`@`tamiyo:/usr/local/src/sage-config/src/sage_bootstrap$ python --version
Python 3.3.2
```


```
jdemeyer`@`tamiyo:/usr/local/src/sage-config/src/sage_bootstrap$ tox --version
1.8.1 imported from /usr/lib64/python3.3/site-packages/tox/__init__.py
```


```
jdemeyer`@`tamiyo:/usr/local/src/sage-config/src/sage_bootstrap$ tox
GLOB sdist-make: /usr/local/src/sage-config/src/sage_bootstrap/setup.py
py26 create: /usr/local/src/sage-config/src/sage_bootstrap/.tox/py26
ERROR: InterpreterNotFound: python2.6
py27 inst-nodeps: /usr/local/src/sage-config/src/sage_bootstrap/.tox/dist/sage_bootstrap-1.0.zip
py27 runtests: PYTHONHASHSEED='1210919353'
py27 runtests: commands[0] | python2.7 -m unittest discover
.......E.......
======================================================================
ERROR: test_checksum (test.test_tarball.TarballTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "/usr/local/src/sage-config/src/sage_bootstrap/test/test_tarball.py", line 40, in test_checksum
    self.assertTrue(tarball.checksum_verifies())
  File "/usr/local/src/sage-config/src/sage_bootstrap/sage_bootstrap/tarball.py", line 83, in checksum_verifies
    sha1 = self._compute_sha1()
  File "/usr/local/src/sage-config/src/sage_bootstrap/sage_bootstrap/tarball.py", line 73, in _compute_sha1
    return self._compute_hash(hashlib.sha1())
  File "/usr/local/src/sage-config/src/sage_bootstrap/sage_bootstrap/tarball.py", line 63, in _compute_hash
    with open(self.upstream_fqn, 'rb') as f:
IOError: [Errno 2] No such file or directory: '/usr/local/src/sage-config/upstream/configure-99.tar.gz'

----------------------------------------------------------------------
Ran 15 tests in 6.914s

FAILED (errors=1)
ERROR: InvocationError: '/usr/local/src/sage-config/src/sage_bootstrap/.tox/py27/bin/python2.7 -m unittest discover'
py33 inst-nodeps: /usr/local/src/sage-config/src/sage_bootstrap/.tox/dist/sage_bootstrap-1.0.zip
py33 runtests: PYTHONHASHSEED='1210919353'
py33 runtests: commands[0] | python3.3 -m unittest discover
..../usr/local/src/sage-config/src/sage_bootstrap/sage_bootstrap/download.py:121: DeprecationWarning: FancyURLopener style of invoking requests is deprecated. Use newer urlopen functions/methods
  opener = urllib.FancyURLopener()
...........
----------------------------------------------------------------------
Ran 15 tests in 0.741s

OK
py34 create: /usr/local/src/sage-config/src/sage_bootstrap/.tox/py34
ERROR: InterpreterNotFound: python3.4
_______________________________________________________________________________ summary ________________________________________________________________________________
SKIPPED:  py26: InterpreterNotFound: python2.6
ERROR:   py27: commands failed
  py33: commands succeeded
SKIPPED:  py34: InterpreterNotFound: python3.4
```


Also, I'm a bit confused by

```
ERROR: InterpreterNotFound: python3.4
```

followed later by

```
SKIPPED:  py34: InterpreterNotFound: python3.4
```



---

Comment by jdemeyer created at 2015-06-25 08:50:26

What would it take to support Python <= 2.5 or Python <= 3.2? I don't know how common these are, but if they can be supported with minimal effort, perhaps it should be done.


---

Comment by vbraun created at 2015-06-25 09:17:06

I don't think there is any currently supported OS that ships with those python versions, so its most likely a waste of time to try.


---

Comment by vbraun created at 2015-06-25 09:19:03

Blocker because it fixes the firewall issue from #18723 and that ticket was a blocker.


---

Comment by vbraun created at 2015-06-25 09:25:31

I don't mind renaming the script, but I don't see the point of avoiding name collisions with historical Sage versions. My plan is to export all new-style package management functions via sage-pkg so its the obvious name for that.

tox (which is pretty much the standard for cross python version testing) is configured to not fail if a python version is not found (see tox.ini)

scripts in src/bin end up being installed in SAGE_LOCAL (and globally if Sage is every packaged / packageable). Build tools shouldn't be globally installed. Really sage-bootstrap only makes sense if you have the source lying around, so why pretend otherwise.


---

Comment by jdemeyer created at 2015-06-25 09:32:36

Replying to [comment:14 vbraun]:
> I don't mind renaming the script, but I don't see the point of avoiding name collisions with historical Sage versions.
It's a name collision with _current_ Sage versions. And `sage --pkg` is still currently documented in [http://doc.sagemath.org/html/en/developer/packaging_old_spkgs.html#the-file-spkg-txt](http://doc.sagemath.org/html/en/developer/packaging_old_spkgs.html#the-file-spkg-txt)

> tox (which is pretty much the standard for cross python version testing) is configured to not fail if a python version is not found (see tox.ini)
Sure, but it is confusing to see `ERROR: InterpreterNotFound: python3.4` if it's not really an error. But if that's the way how `tox` works, so be it.


---

Comment by jdemeyer created at 2015-06-25 09:36:42

Replying to [comment:13 vbraun]:
> Blocker because it fixes the firewall issue from #18723 and that ticket was a blocker.
I just don't like if blockers are complicated tickets like this. Why not apply the simple fix of #18723 as blocker and make #18748 a normal ticket?


---

Comment by vbraun created at 2015-06-25 09:41:46

THis is a rather simple ticket IMHO, it just refactors a script and adds testing.


---

Comment by jdemeyer created at 2015-06-25 09:43:08

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-06-25 09:43:08

Wouldn't it be a lot better to move `sage_bootstrap` to the `$SAGE_ROOT/build` directory? That's where the Sage packages reside, so it would make sense to move the package build system also to `build`.


---

Comment by jdemeyer created at 2015-06-25 09:44:48

Replying to [comment:17 vbraun]:
> THis is a rather simple ticket
Really?

```
28 files changed, 1518 insertions, 460 deletions
```



---

Comment by jdemeyer created at 2015-06-25 09:47:14

You have inconsistent indentation (not multiples of 4 spaces) in `src/sage_bootstrap/sage_bootstrap/stdio.py`


---

Comment by vbraun created at 2015-06-25 09:47:52

Well thats because a lot of testing was added. Really its an obvious improvement. 

I don't think source code should reside in SAGE_ROOT/build

What about the old `sage-pkg`, move it to `sage-old-pkg`? Or are we going to keep it forever?


---

Comment by jdemeyer created at 2015-06-25 09:53:14

Replying to [comment:21 vbraun]:
> I don't think source code should reside in SAGE_ROOT/build
First of all, we already have source code there (`$SAGE_ROOT/build/install`). You will probably argue that this is a build script, not source code. But then your module is really also a build script, not source code (especially given that it's not installed).

Currently `$SAGE_ROOT/src` is essentially the _Sage library_, i.e. the Python package `sage`. I don't see how build scripts for Sage _packages_ belong there.


---

Comment by vbraun created at 2015-06-25 09:55:28

You didn't complain about `sage-download-file` being in `src/bin/`, so why complain now? There is much more than the Sage Python library in `src`.


---

Comment by jdemeyer created at 2015-06-25 09:57:12

Replying to [comment:21 vbraun]:
> Or are we going to keep it forever?
It's not even deprecated, so I would keep it for now. There are people still creating new old-style packages, see #18514 for example.

You could call your new script `sage-packages` or something...


---

Comment by jdemeyer created at 2015-06-25 10:06:04

Replying to [comment:23 vbraun]:
> You didn't complain about `sage-download-file` being in `src/bin/`, so why complain now?
We currently have only 1 place to put scripts and that's in `$SAGE_ROOT/src/bin`. You're creating a second place, so it makes sense to think what is the best location. After this ticket is merged, we should move more scripts to `sage_bootstrap/bin`, in particular `sage-spkg` and maybe even `$SAGE_ROOT/build/install` and `$SAGE_ROOT/build/pipestatus`. If `sage_bootstrap` would be in `$SAGE_ROOT/build`, that would lead to a clean separation of the complete build system for packages in `$SAGE_ROOT/build`.

I always found it awkward that we have a top-level `Makefile` calling a scipt `build/install` running make on `build/Makefile` which then runs `src/bin/sage-spkg` which in turn runs `build/pkgs/*/spkg-install`. That's a mess. This ticket creates an opportunity to start cleaning this up, let's do it right from the beginning.


---

Comment by vbraun created at 2015-06-25 10:40:54

I'm happy to reorganize /build but I don't think we should do it in this ticket. IMHO the makefile stuff should first move to /build/make (or so) to make  space for build/sage_bootstrap, build/setup.py, build/tox.ini, .... Otherwise you end up with /build/src/sage_bootstrap which is just duplicating src. Feel free to open another ticket.


---

Comment by jdemeyer created at 2015-06-25 10:59:56

Replying to [comment:26 vbraun]:
> I'm happy to reorganize /build but I don't think we should do it in this ticket.
+1

> IMHO the makefile stuff should first move to /build/make (or so) to make  space for build/sage_bootstrap
What's wrong with creating `build/sage_bootstrap` _without_ moving the "makefile stuff" first? Independently of whether `build/install` and friends should be moved, what influence does it have on the present ticket?

I think it's stupid to first create `$SAGE_ROOT/src/sage_bootstrap` on this ticket and then immediately move it to a different place. Just put it in the correct place from the beginning...


---

Comment by vbraun created at 2015-06-25 11:12:55

then you end up with setup.py and Makefile in the same directory.... IMHO super-confusing.


---

Comment by jdemeyer created at 2015-06-25 12:17:55

Replying to [comment:28 vbraun]:
> then you end up with setup.py and Makefile in the same directory.... IMHO super-confusing.
I see your point, but I don't find it strong enough as an argument for why `$SAGE_ROOT/src/sage_bootstrap/sage_bootstrap` is better than `$SAGE_ROOT/build/sage_bootstrap`.

Can we get rid of that `setup.py`? Move it? Rename it?


---

Comment by jdemeyer created at 2015-06-25 12:20:25

Replying to [comment:28 vbraun]:
> IMHO super-confusing.
That can be solved with a simple comment like

```
#
# This setup.py file is only used for tox testing of the
# sage_bootstrap package, do not actually execute it!
#
# For building Sage packages, see "install", "deps" and "Makefile".
#
```



---

Comment by vbraun created at 2015-06-25 19:56:30

Afaik setup.py can't have a different name. It certainly shouldn't be renamed. I'm fine with making /build a Python package, but then everything should have a sane directory layout. And moving stuff is super-easy in git, its a matter of minutes. So why do it now when /build is not ready for it?


---

Comment by git created at 2015-06-25 20:09:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2015-06-25 20:15:52

I opened #18788 to reorganize /build


---

Comment by vbraun created at 2015-06-25 20:16:09

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-06-26 06:21:35

Replying to [comment:31 vbraun]:
> And moving stuff is super-easy in git, its a matter of minutes.
Moving the files physically, sure. But that's only a very small part of the effort of moving files. All the code referring to those files needs to be changed, everything has to be tested again...

> So why do it now when /build is not ready for it?
First of all, I don't agree with the premise that "`build` is not ready for it". I really don't see the problem. Second, like I already said: I would avoid having to move things in the future.


---

Comment by jdemeyer created at 2015-06-26 06:36:13

Replying to [comment:28 vbraun]:
> then you end up with setup.py and Makefile in the same directory.... IMHO super-confusing.
Let me remind you that we have had this in `$SAGE_ROOT/src` for a while and nobody ever complained...


---

Comment by vbraun created at 2015-06-26 07:36:39

Replying to [comment:35 jdemeyer]:
> All the code referring to those files needs to be changed

The scripts are found via the PATH, thats the only thing that needs to be changed.

> Second, like I already said: I would avoid having to move things in the future.

I wasn't the one who complained that this ticket does too much at once ;-)


---

Comment by jdemeyer created at 2015-06-26 08:36:06

Replying to [comment:37 vbraun]:
> I wasn't the one who complained that this ticket does too much at once ;-)
I'm not asking to do more in this ticket. I'm only asking to do it in such a way that we don't need a second ticket to move `sage_bootstrap`.


---

Comment by dimpase created at 2015-07-04 10:27:14

I don't see much change from the old setup:

```
$ sage -f hg
Attempting to download package hg
>>> Checking online list of optional packages.
>>> Checking online list of experimental packages.
>>> Checking online list of standard packages.
>>> Checking online list of huge packages.
>>> Checking online list of archive packages.
ERROR [download|run:133]: [Errno 404] Not Found: '//www.mirrorservice.org/sites/www.sagemath.org//spkg/archive/list'
sed: can't read /home/dima/.sage//archive.list: No such file or directory
Error: could not find a package matching hg on http://www.mirrorservice.org/sites/www.sagemath.org//spkg
```


should we have `sage -reset_mirrors` ?


---

Comment by vbraun created at 2015-07-04 10:49:20

I should have said: This ticket is about standard packages. Since `hg` is optional it is unrelated. But if you can't build "standard" Sage then this ticket might help.


---

Comment by dimpase created at 2015-07-05 21:01:31

what is `tox` and what is it doing? Perhaps it should go to another ticket, as it looks totally orthogonal to the stated purpose of refactoring what we have.


---

Comment by vbraun created at 2015-07-05 21:25:54

https://tox.readthedocs.org

The whole point of the refactoring is to make stuff testable


---

Comment by jhpalmieri created at 2015-07-06 03:06:37

Why are some of the files not listed in `MANIFEST` (e.g., `tox.ini`, `test/capture.py`)?


---

Comment by vbraun created at 2015-07-06 07:22:36

The manifest is auto-generated by tox/distutils to build a package for testing purposes. Its contents don't really matter apart from that. The tox config file arguably doesn't belong there, so I'd count that as a plus. If we were to use the manifest for anything then we would have to add a `Manifest.in` to fine-tune the inclusion rules.


---

Comment by jhpalmieri created at 2015-07-07 00:03:31

Minor questions:

- In `package.py`, are the lines

```
    def __eq__(self, other):
        return self.tarball == other.tarball
```

 there just for testing via `tox`, or do they serve another purpose?
- There are some blank spaces on several otherwise empty lines in `tarball.py`. Do we care?

Overall, the code is just a relocation of old code, so that's okay. I'm not sure about the whole idea of moving it. Seems okay to me, but it doesn't strike me as very high on the priority list.

Less minor questions and comments:
- What does `sage-package` do? The file itself should contain some information; you shouldn't have to run it to get its usage message. Maybe the same could be said for `sage-download-file`, but at least the name is somewhat self-explanatory. I think you should add a line or two there, also. Probably in `README`, too, for example after the sentence

```
This is a utility libary for dealing with third-party tarballs and
building Sage. 
```

 (Something like "The main entry points are sage-download-file and sage-package, which are used as follows: ...". Note also that "libary" is currently misspelled.)
- In addition, I think that each python file in `sage_bootstrap` could have a bit more documentation, illustrating how to use it. I don't really want to have to read the source code to figure out this sort of thing. For `download.py`, for example, mention `Download(...).run()`.
- Add the link `​https://tox.readthedocs.org` to `README`. Maybe we should all know about tox already, but that doesn't seem to be the case.


---

Comment by vbraun created at 2015-07-07 07:36:28

Replying to [comment:45 jhpalmieri]:
> - In `package.py`, are the lines
> {{{
>     def __eq__(self, other):
>         return self.tarball == other.tarball
> }}}
>  there just for testing via `tox`, or do they serve another purpose?

They are used for testing in unittest.TestCase.assertEqual, doesn't really have anything to do with tox (which is just the test runner) besides that.

> - There are some blank spaces on several otherwise empty lines in `tarball.py`. Do we care?

I don't. 

> Overall, the code is just a relocation of old code, so that's okay. I'm not sure about the whole idea of moving it. Seems okay to me, but it doesn't strike me as very high on the priority list.

The old script was already too long to fit comfortably into one file, with added testing its can't fit into one file. So it has to grow into a package.

> Less minor questions and comments:
> - What does `sage-package` do?

It mostly makes the release manager's job easier because you don't have to log into the server and associated tarball names to package names by hand, which wastes my preciously little available time.

I'm happy to add a line of documentation here or there but unlike the math part this is **not** a library for Python novices. IMHO its not too much to ask to google for "tox", thats bound to produce way more relevant and informative information than I can possibly be.


---

Comment by jhpalmieri created at 2015-07-07 17:48:27

Replying to [comment:46 vbraun]:
> I'm happy to add a line of documentation here or there but unlike the math part this is **not** a library for Python novices. IMHO its not too much to ask to google for "tox", thats bound to produce way more relevant and informative information than I can possibly be.

Here is some documentation for the main scripts. I think that few of the Python files could use a bit more information: the current descriptions for `package.py` and maybe `tarball.py` are too terse.


---

Comment by jhpalmieri created at 2015-07-07 17:49:21

New commits:


---

Comment by git created at 2015-07-12 14:27:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2015-07-12 14:28:50

Done, still needs review


---

Comment by jhpalmieri created at 2015-07-12 16:10:02

I get an error with tox:

```
$ tox 
GLOB sdist-make: /Users/palmieri/Desktop/Sage_stuff/git/sage/src/sage_bootstrap/setup.py
py26 create: /Users/palmieri/Desktop/Sage_stuff/git/sage/src/sage_bootstrap/.tox/py26
py26 installdeps: unittest2
py26 inst: /Users/palmieri/Desktop/Sage_stuff/git/sage/src/sage_bootstrap/.tox/dist/sage_bootstrap-1.0.zip
py26 installed: argparse==1.3.0,linecache2==1.0.0,sage-bootstrap==1.0,six==1.9.0,traceback2==1.4.0,unittest2==1.1.0,wheel==0.24.0
py26 runtests: PYTHONHASHSEED='2708481092'
py26 runtests: commands[0] | unit2 discover
............E..
======================================================================
ERROR: test_package (test.test_package.PackageTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "/Users/palmieri/Desktop/Sage_stuff/git/sage/src/sage_bootstrap/test/test_package.py", line 34, in test_package
    self.assertIsInstance(pkg.tarball, Tarball)
AttributeError: 'PackageTestCase' object has no attribute 'assertIsInstance'

----------------------------------------------------------------------
Ran 15 tests in 1.056s

FAILED (errors=1)
ERROR: InvocationError: '/Users/palmieri/Desktop/Sage_stuff/git/sage/src/sage_bootstrap/.tox/py26/bin/unit2 discover'
```



---

Comment by git created at 2015-07-12 17:26:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2015-07-12 17:27:01

Thanks, ``assertIsInstance` is Python 2.7+, fixed


---

Comment by jhpalmieri created at 2015-07-13 04:25:33

Okay, one more addition to the documentation. If you're happy with this, you can set this to positive review.


---

Comment by vbraun created at 2015-07-13 07:47:17

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-07-13 17:58:42

Resolution: fixed
