# Issue 26039: py3: misc fixes for sage.modules

Issue created by migration from https://trac.sagemath.org/ticket/26276

Original creator: embray

Original creation time: 2018-09-13 16:20:53

Uploading all remaining `sage.modules` fixes from my Python 3 branch.

This is a bit diverse but I think it's a small enough set of fixes to be grouped together.  Also fixes some Python 2 bugs that were sort of left as "known failures".


---

Comment by embray created at 2018-09-13 16:21:16

Changing status from new to needs_review.


---

Comment by embray created at 2018-09-13 16:23:41

With these fixes I have all of `./sage -t --long src/sage/modules/` passing.


---

Comment by chapoton created at 2018-09-16 06:24:41

the branch is now red


---

Comment by chapoton created at 2018-09-16 06:24:41

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-09-17 11:34:38

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-09-17 11:34:51

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2018-09-17 12:37:58

Two things from a very quick lookover:

The `iter` here seems pointless as the result is an iterator:

```
return iter(self._entries.iteritems())
```


In Cython, you can still use `iteritems` on a `dict` in Python3 (from what Jeroen as said in the past). So this change should not be needed:

```diff
                 e = entries_dict
                 entries_dict = {}
                 try:
-                    for k, x in e.iteritems():
+                    for k, x in e.items():
                         x = coefficient_ring(x)
                         if x:
                             entries_dict[k] = x
```

(unless `e` needs a typecast to `dict`).


---

Comment by embray created at 2018-09-17 12:40:41

It's not pointless.  On Python 3 it's needed.  The value returned by `self._entries.iteritems()` is technically not an iterator strangely enough.


---

Comment by tscrim created at 2018-09-17 22:00:04

That is a bit strange, but okay, it will be what it has to be. I guess it shouldn't affect the timings of things. Although we probably want to leave a quick comment so someone less versed in Python3 doesn't have the same thought I had and remove the `iter`.

I do think we should still revert the other change.


---

Comment by embray created at 2018-09-18 17:47:44

It's not that strange.  On Python 3, `dict.keys()`, `dict.values()`, and `dict.items()` return views:


```python
>>> d = {}
>>> it = d.items()
>>> it
dict_items([])
>>> d['a'] = 1
>>> it
dict_items([('a', 1)])
>>> next(it)
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
TypeError: 'dict_items' object is not an iterator
>>> next(iter(it))
('a', 1)
```



---

Comment by tscrim created at 2018-09-18 23:44:30

I guess on Python3, Cython just considers `iteritems` as a replacement for `items` and gives the view.

Now feel free to call me paranoid, but I am a little worried about the extra indirection by defining the `_on_basis` method. Since that forms the key part of the code and can be called very frequently, it could have some significant impact:

```
sage: from sage.modules.with_basis.morphism import ModuleMorphismFromMatrix
....: X = CombinatorialFreeModule(ZZ, [1,2]); X.rename("X"); x = X.basis()
....: Y = CombinatorialFreeModule(ZZ, [3,4]); Y.rename("Y"); y = Y.basis()
....: m = matrix([[1, 2], [3, 5]])
....: phi = ModuleMorphismFromMatrix(matrix=m, domain=X, codomain=Y, side="right")
....: 
sage: %timeit phi(X.an_element())
The slowest run took 36.14 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 3.91 µs per loop
```

vs your branch

```
sage: %timeit phi(X.an_element())
The slowest run took 25.64 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 4.32 µs per loop
```

which is around a 10% slowdown. So I am not sure this is the best way forward as the pickling problem might be better addressed with a custom `__reduce__` method. How much of those changes are necessary for Python3?


---

Comment by chapoton created at 2018-09-19 08:43:11

Could we keep the changes in `src/sage/modules/with_basis/morphism.py` for another ticket then ?


---

Comment by tscrim created at 2018-09-19 09:40:55

I would move it to another ticket if it is not necessary for Python3.


---

Comment by embray created at 2018-09-19 10:26:16

I would suggest that if that code needs to perform on a level where even a method call is too much unacceptable overhead, that it be rewritten in Cython then.

I also considered a custom `__reduce__` method, but I do feel that shoving a method of some object into an attribute of another object has a certain code smell to it.


---

Comment by tscrim created at 2018-09-19 11:08:16

Replying to [comment:13 embray]:
> I would suggest that if that code needs to perform on a level where even a method call is too much unacceptable overhead, that it be rewritten in Cython then.

Yes, I think it should. These get used all over the place in things like the combinatorial Hopf algebra code. Although it may not have been done previously because of stuff with the category framework, multiple inheritance, concerns about increased debugging difficult, or just a previous lack of interest.

> I also considered a custom `__reduce__` method, but I do feel that shoving a method of some object into an attribute of another object has a certain code smell to it.

I think that is a bad way to look at it. I would say it should be more like you are passing a function as input, which then gets called as part of the computation.


---

Comment by embray created at 2018-09-19 12:04:12

That's fair, though I probably might have instead explicitly made a lambda that wraps the dict in a closure and calls its getitem.  But maybe that's a distinction without a difference (and that would still have a problem with pickling).

I'll take another look at it.  I'm curious to see what happens as a first pass if I just redo some of that module in Cython.


---

Comment by chapoton created at 2018-10-23 12:51:19

Can we please start to move again here, and if necessary keep the changes in `src/sage/modules/with_basis/morphism.py` for another ticket ?


---

Comment by tscrim created at 2018-10-23 13:08:46

Replying to [comment:16 chapoton]:
> Can we please start to move again here, and if necessary keep the changes in `src/sage/modules/with_basis/morphism.py` for another ticket ?

Yes, I think that would be good (and in that ticket, I might also Cythonize it too).


---

Comment by chapoton created at 2018-11-04 13:14:40

here is a branch without the changes in `src/sage/modules/with_basis/morphism.py`

The old branch is kept at u/embray/sage-modules/misc
----
New commits:


---

Comment by tscrim created at 2018-11-04 14:31:35

One last little thing:

```diff
-                    for k, x in e.iteritems():
+                    for k, x in e.items():
```

Since `e` is a `dict` in a Cython file, I think it would be better to do

```diff
-                    for k, x in e.iteritems():
+                    for k, x in (<dict> e).iteritems():
```

Once changed (or if you don't think it is a good idea), then you can set a positive review.


---

Comment by git created at 2018-11-04 17:31:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-11-04 17:32:13

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2018-11-04 17:32:13

done, thanks. Setting to positive


---

Comment by embray created at 2018-11-06 10:31:51

Replying to [comment:20 tscrim]:
> Since `e` is a `dict` in a Cython file, I think it would be better to do
> {{{#!diff
> -                    for k, x in e.iteritems():
> +                    for k, x in (<dict> e).iteritems():
> }}}
> Once changed (or if you don't think it is a good idea), then you can set a positive review.

Why this?  `e` is already declared `cdef dict` earlier in the method, so I'm not sure why you would want to add `<dict> e` here?


---

Comment by tscrim created at 2018-11-06 12:55:44

Replying to [comment:23 embray]:
> Why this?  `e` is already declared `cdef dict` earlier in the method, so I'm not sure why you would want to add `<dict> e` here?

Because I missed it being defined. `>_<` Oh well, it doesn't really hurt anything by being there.


---

Comment by embray created at 2018-11-06 13:07:36

I agree.  It's redundant but let's just leave it.


---

Comment by vbraun created at 2018-11-07 11:27:23

Resolution: fixed
