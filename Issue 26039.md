# Issue 26039: py3: misc fixes for sage.modules

archive/issues_026039.json:
```json
{
    "body": "Uploading all remaining `sage.modules` fixes from my Python 3 branch.\n\nThis is a bit diverse but I think it's a small enough set of fixes to be grouped together.  Also fixes some Python 2 bugs that were sort of left as \"known failures\".\n\nIssue created by migration from https://trac.sagemath.org/ticket/26276\n\n",
    "created_at": "2018-09-13T16:20:53Z",
    "labels": [
        "python3",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.5",
    "title": "py3: misc fixes for sage.modules",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26039",
    "user": "embray"
}
```
Uploading all remaining `sage.modules` fixes from my Python 3 branch.

This is a bit diverse but I think it's a small enough set of fixes to be grouped together.  Also fixes some Python 2 bugs that were sort of left as "known failures".

Issue created by migration from https://trac.sagemath.org/ticket/26276





---

archive/issue_comments_367259.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-09-13T16:21:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26039#issuecomment-367259",
    "user": "embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_367260.json:
```json
{
    "body": "With these fixes I have all of `./sage -t --long src/sage/modules/` passing.",
    "created_at": "2018-09-13T16:23:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26039#issuecomment-367260",
    "user": "embray"
}
```

With these fixes I have all of `./sage -t --long src/sage/modules/` passing.



---

archive/issue_comments_367261.json:
```json
{
    "body": "the branch is now red",
    "created_at": "2018-09-16T06:24:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26039#issuecomment-367261",
    "user": "chapoton"
}
```

the branch is now red



---

archive/issue_comments_367262.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-09-16T06:24:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26039#issuecomment-367262",
    "user": "chapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_367263.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-09-17T11:34:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26039#issuecomment-367263",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_367264.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-09-17T11:34:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26039#issuecomment-367264",
    "user": "embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_367265.json:
```json
{
    "body": "Two things from a very quick lookover:\n\nThe `iter` here seems pointless as the result is an iterator:\n\n```\nreturn iter(self._entries.iteritems())\n```\n\n\nIn Cython, you can still use `iteritems` on a `dict` in Python3 (from what Jeroen as said in the past). So this change should not be needed:\n\n```diff\n                 e = entries_dict\n                 entries_dict = {}\n                 try:\n-                    for k, x in e.iteritems():\n+                    for k, x in e.items():\n                         x = coefficient_ring(x)\n                         if x:\n                             entries_dict[k] = x\n```\n\n(unless `e` needs a typecast to `dict`).",
    "created_at": "2018-09-17T12:37:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26039#issuecomment-367265",
    "user": "tscrim"
}
```

Two things from a very quick lookover:

The `iter` here seems pointless as the result is an iterator:

```
return iter(self._entries.iteritems())
```


In Cython, you can still use `iteritems` on a `dict` in Python3 (from what Jeroen as said in the past). So this change should not be needed:

```diff
                 e = entries_dict
                 entries_dict = {}
                 try:
-                    for k, x in e.iteritems():
+                    for k, x in e.items():
                         x = coefficient_ring(x)
                         if x:
                             entries_dict[k] = x
```

(unless `e` needs a typecast to `dict`).



---

archive/issue_comments_367266.json:
```json
{
    "body": "It's not pointless.  On Python 3 it's needed.  The value returned by `self._entries.iteritems()` is technically not an iterator strangely enough.",
    "created_at": "2018-09-17T12:40:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26039#issuecomment-367266",
    "user": "embray"
}
```

It's not pointless.  On Python 3 it's needed.  The value returned by `self._entries.iteritems()` is technically not an iterator strangely enough.



---

archive/issue_comments_367267.json:
```json
{
    "body": "That is a bit strange, but okay, it will be what it has to be. I guess it shouldn't affect the timings of things. Although we probably want to leave a quick comment so someone less versed in Python3 doesn't have the same thought I had and remove the `iter`.\n\nI do think we should still revert the other change.",
    "created_at": "2018-09-17T22:00:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26039#issuecomment-367267",
    "user": "tscrim"
}
```

That is a bit strange, but okay, it will be what it has to be. I guess it shouldn't affect the timings of things. Although we probably want to leave a quick comment so someone less versed in Python3 doesn't have the same thought I had and remove the `iter`.

I do think we should still revert the other change.



---

archive/issue_comments_367268.json:
```json
{
    "body": "It's not that strange.  On Python 3, `dict.keys()`, `dict.values()`, and `dict.items()` return views:\n\n\n```python\n>>> d = {}\n>>> it = d.items()\n>>> it\ndict_items([])\n>>> d['a'] = 1\n>>> it\ndict_items([('a', 1)])\n>>> next(it)\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\nTypeError: 'dict_items' object is not an iterator\n>>> next(iter(it))\n('a', 1)\n```\n",
    "created_at": "2018-09-18T17:47:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26039#issuecomment-367268",
    "user": "embray"
}
```

It's not that strange.  On Python 3, `dict.keys()`, `dict.values()`, and `dict.items()` return views:


```python
>>> d = {}
>>> it = d.items()
>>> it
dict_items([])
>>> d['a'] = 1
>>> it
dict_items([('a', 1)])
>>> next(it)
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
TypeError: 'dict_items' object is not an iterator
>>> next(iter(it))
('a', 1)
```




---

archive/issue_comments_367269.json:
```json
{
    "body": "I guess on Python3, Cython just considers `iteritems` as a replacement for `items` and gives the view.\n\nNow feel free to call me paranoid, but I am a little worried about the extra indirection by defining the `_on_basis` method. Since that forms the key part of the code and can be called very frequently, it could have some significant impact:\n\n```\nsage: from sage.modules.with_basis.morphism import ModuleMorphismFromMatrix\n....: X = CombinatorialFreeModule(ZZ, [1,2]); X.rename(\"X\"); x = X.basis()\n....: Y = CombinatorialFreeModule(ZZ, [3,4]); Y.rename(\"Y\"); y = Y.basis()\n....: m = matrix([[1, 2], [3, 5]])\n....: phi = ModuleMorphismFromMatrix(matrix=m, domain=X, codomain=Y, side=\"right\")\n....: \nsage: %timeit phi(X.an_element())\nThe slowest run took 36.14 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 3.91 \u00b5s per loop\n```\n\nvs your branch\n\n```\nsage: %timeit phi(X.an_element())\nThe slowest run took 25.64 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 4.32 \u00b5s per loop\n```\n\nwhich is around a 10% slowdown. So I am not sure this is the best way forward as the pickling problem might be better addressed with a custom `__reduce__` method. How much of those changes are necessary for Python3?",
    "created_at": "2018-09-18T23:44:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26039#issuecomment-367269",
    "user": "tscrim"
}
```

I guess on Python3, Cython just considers `iteritems` as a replacement for `items` and gives the view.

Now feel free to call me paranoid, but I am a little worried about the extra indirection by defining the `_on_basis` method. Since that forms the key part of the code and can be called very frequently, it could have some significant impact:

```
sage: from sage.modules.with_basis.morphism import ModuleMorphismFromMatrix
....: X = CombinatorialFreeModule(ZZ, [1,2]); X.rename("X"); x = X.basis()
....: Y = CombinatorialFreeModule(ZZ, [3,4]); Y.rename("Y"); y = Y.basis()
....: m = matrix([[1, 2], [3, 5]])
....: phi = ModuleMorphismFromMatrix(matrix=m, domain=X, codomain=Y, side="right")
....: 
sage: %timeit phi(X.an_element())
The slowest run took 36.14 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 3.91 µs per loop
```

vs your branch

```
sage: %timeit phi(X.an_element())
The slowest run took 25.64 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 4.32 µs per loop
```

which is around a 10% slowdown. So I am not sure this is the best way forward as the pickling problem might be better addressed with a custom `__reduce__` method. How much of those changes are necessary for Python3?



---

archive/issue_comments_367270.json:
```json
{
    "body": "Could we keep the changes in `src/sage/modules/with_basis/morphism.py` for another ticket then ?",
    "created_at": "2018-09-19T08:43:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26039#issuecomment-367270",
    "user": "chapoton"
}
```

Could we keep the changes in `src/sage/modules/with_basis/morphism.py` for another ticket then ?



---

archive/issue_comments_367271.json:
```json
{
    "body": "I would move it to another ticket if it is not necessary for Python3.",
    "created_at": "2018-09-19T09:40:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26039#issuecomment-367271",
    "user": "tscrim"
}
```

I would move it to another ticket if it is not necessary for Python3.



---

archive/issue_comments_367272.json:
```json
{
    "body": "I would suggest that if that code needs to perform on a level where even a method call is too much unacceptable overhead, that it be rewritten in Cython then.\n\nI also considered a custom `__reduce__` method, but I do feel that shoving a method of some object into an attribute of another object has a certain code smell to it.",
    "created_at": "2018-09-19T10:26:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26039#issuecomment-367272",
    "user": "embray"
}
```

I would suggest that if that code needs to perform on a level where even a method call is too much unacceptable overhead, that it be rewritten in Cython then.

I also considered a custom `__reduce__` method, but I do feel that shoving a method of some object into an attribute of another object has a certain code smell to it.



---

archive/issue_comments_367273.json:
```json
{
    "body": "Replying to [comment:13 embray]:\n> I would suggest that if that code needs to perform on a level where even a method call is too much unacceptable overhead, that it be rewritten in Cython then.\n\nYes, I think it should. These get used all over the place in things like the combinatorial Hopf algebra code. Although it may not have been done previously because of stuff with the category framework, multiple inheritance, concerns about increased debugging difficult, or just a previous lack of interest.\n\n> I also considered a custom `__reduce__` method, but I do feel that shoving a method of some object into an attribute of another object has a certain code smell to it.\n\nI think that is a bad way to look at it. I would say it should be more like you are passing a function as input, which then gets called as part of the computation.",
    "created_at": "2018-09-19T11:08:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26039#issuecomment-367273",
    "user": "tscrim"
}
```

Replying to [comment:13 embray]:
> I would suggest that if that code needs to perform on a level where even a method call is too much unacceptable overhead, that it be rewritten in Cython then.

Yes, I think it should. These get used all over the place in things like the combinatorial Hopf algebra code. Although it may not have been done previously because of stuff with the category framework, multiple inheritance, concerns about increased debugging difficult, or just a previous lack of interest.

> I also considered a custom `__reduce__` method, but I do feel that shoving a method of some object into an attribute of another object has a certain code smell to it.

I think that is a bad way to look at it. I would say it should be more like you are passing a function as input, which then gets called as part of the computation.



---

archive/issue_comments_367274.json:
```json
{
    "body": "That's fair, though I probably might have instead explicitly made a lambda that wraps the dict in a closure and calls its getitem.  But maybe that's a distinction without a difference (and that would still have a problem with pickling).\n\nI'll take another look at it.  I'm curious to see what happens as a first pass if I just redo some of that module in Cython.",
    "created_at": "2018-09-19T12:04:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26039#issuecomment-367274",
    "user": "embray"
}
```

That's fair, though I probably might have instead explicitly made a lambda that wraps the dict in a closure and calls its getitem.  But maybe that's a distinction without a difference (and that would still have a problem with pickling).

I'll take another look at it.  I'm curious to see what happens as a first pass if I just redo some of that module in Cython.



---

archive/issue_comments_367275.json:
```json
{
    "body": "Can we please start to move again here, and if necessary keep the changes in `src/sage/modules/with_basis/morphism.py` for another ticket ?",
    "created_at": "2018-10-23T12:51:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26039#issuecomment-367275",
    "user": "chapoton"
}
```

Can we please start to move again here, and if necessary keep the changes in `src/sage/modules/with_basis/morphism.py` for another ticket ?



---

archive/issue_comments_367276.json:
```json
{
    "body": "Replying to [comment:16 chapoton]:\n> Can we please start to move again here, and if necessary keep the changes in `src/sage/modules/with_basis/morphism.py` for another ticket ?\n\nYes, I think that would be good (and in that ticket, I might also Cythonize it too).",
    "created_at": "2018-10-23T13:08:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26039#issuecomment-367276",
    "user": "tscrim"
}
```

Replying to [comment:16 chapoton]:
> Can we please start to move again here, and if necessary keep the changes in `src/sage/modules/with_basis/morphism.py` for another ticket ?

Yes, I think that would be good (and in that ticket, I might also Cythonize it too).



---

archive/issue_comments_367277.json:
```json
{
    "body": "here is a branch without the changes in `src/sage/modules/with_basis/morphism.py`\n\nThe old branch is kept at u/embray/sage-modules/misc\n----\nNew commits:",
    "created_at": "2018-11-04T13:14:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26039#issuecomment-367277",
    "user": "chapoton"
}
```

here is a branch without the changes in `src/sage/modules/with_basis/morphism.py`

The old branch is kept at u/embray/sage-modules/misc
----
New commits:



---

archive/issue_comments_367278.json:
```json
{
    "body": "One last little thing:\n\n```diff\n-                    for k, x in e.iteritems():\n+                    for k, x in e.items():\n```\n\nSince `e` is a `dict` in a Cython file, I think it would be better to do\n\n```diff\n-                    for k, x in e.iteritems():\n+                    for k, x in (<dict> e).iteritems():\n```\n\nOnce changed (or if you don't think it is a good idea), then you can set a positive review.",
    "created_at": "2018-11-04T14:31:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26039#issuecomment-367278",
    "user": "tscrim"
}
```

One last little thing:

```diff
-                    for k, x in e.iteritems():
+                    for k, x in e.items():
```

Since `e` is a `dict` in a Cython file, I think it would be better to do

```diff
-                    for k, x in e.iteritems():
+                    for k, x in (<dict> e).iteritems():
```

Once changed (or if you don't think it is a good idea), then you can set a positive review.



---

archive/issue_comments_367279.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-11-04T17:31:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26039#issuecomment-367279",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_367280.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-11-04T17:32:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26039#issuecomment-367280",
    "user": "chapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_367281.json:
```json
{
    "body": "done, thanks. Setting to positive",
    "created_at": "2018-11-04T17:32:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26039#issuecomment-367281",
    "user": "chapoton"
}
```

done, thanks. Setting to positive



---

archive/issue_comments_367282.json:
```json
{
    "body": "Replying to [comment:20 tscrim]:\n> Since `e` is a `dict` in a Cython file, I think it would be better to do\n> {{{#!diff\n> -                    for k, x in e.iteritems():\n> +                    for k, x in (<dict> e).iteritems():\n> }}}\n> Once changed (or if you don't think it is a good idea), then you can set a positive review.\n\nWhy this?  `e` is already declared `cdef dict` earlier in the method, so I'm not sure why you would want to add `<dict> e` here?",
    "created_at": "2018-11-06T10:31:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26039#issuecomment-367282",
    "user": "embray"
}
```

Replying to [comment:20 tscrim]:
> Since `e` is a `dict` in a Cython file, I think it would be better to do
> {{{#!diff
> -                    for k, x in e.iteritems():
> +                    for k, x in (<dict> e).iteritems():
> }}}
> Once changed (or if you don't think it is a good idea), then you can set a positive review.

Why this?  `e` is already declared `cdef dict` earlier in the method, so I'm not sure why you would want to add `<dict> e` here?



---

archive/issue_comments_367283.json:
```json
{
    "body": "Replying to [comment:23 embray]:\n> Why this?  `e` is already declared `cdef dict` earlier in the method, so I'm not sure why you would want to add `<dict> e` here?\n\nBecause I missed it being defined. `>_<` Oh well, it doesn't really hurt anything by being there.",
    "created_at": "2018-11-06T12:55:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26039#issuecomment-367283",
    "user": "tscrim"
}
```

Replying to [comment:23 embray]:
> Why this?  `e` is already declared `cdef dict` earlier in the method, so I'm not sure why you would want to add `<dict> e` here?

Because I missed it being defined. `>_<` Oh well, it doesn't really hurt anything by being there.



---

archive/issue_comments_367284.json:
```json
{
    "body": "I agree.  It's redundant but let's just leave it.",
    "created_at": "2018-11-06T13:07:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26039#issuecomment-367284",
    "user": "embray"
}
```

I agree.  It's redundant but let's just leave it.



---

archive/issue_comments_367285.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-11-07T11:27:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26039",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26039#issuecomment-367285",
    "user": "vbraun"
}
```

Resolution: fixed
