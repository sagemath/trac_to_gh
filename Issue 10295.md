# Issue 10295: Singular interface wasting time by calling select.select() too often

archive/issues_010295.json:
```json
{
    "body": "Assignee: was\n\nCC:  was wjp alexanderdreyer malb leif\n\nKeywords: Singular, _eval_line, synchronization, synchronisation\n\nThere are two fundamental differences between the Singular and the Gap interfaces:\n\n1. The Singular interface uses a synchronisation method in each call to its eval method. Gap doesn't.\n2. The Gap interface deletes variables by declaring that their name may be overwritten. This is not possible in Singular, since Singular variables are statically typed. Thus, the Singular interface explicitly kills the underlying variable in Singular, which requires one call to _eval_line for each variable that is to be deleted.\n\nUnfortunately, waiting for the prompt to appear in a pseudo terminal may be very costly on some systems, since select.select() may be very slow - see #10294. So, additional calls to _eval_line should be strictly avoided!\n\nThe first point makes me wonder: Why has the synchronisation method become necessary for Singular but not for Gap?\n\nThe second point makes me wonder whether it is really necessary to use one _eval_line for each single deletion.\n\nMoreover, I wonder whether the two points are actually related: I could imagine that synchronisation became necessary when garbage collection, accidentally performed inside an _eval_line, and thus sending an _eval_line inside an outer _eval_line, caused a dead lock in the outer _eval_line. Was that the case, historically?\n\nSuggestions:\n\n1. `singular.eval(cmd)` is currently simply passing `cmd` to _eval_line, after synchronisation and after killing unused variables. I suggest to add the code for killing unused variables to `cmd`, thus using _eval_line only once.\n2. If my above guess on the role of synchronisation is correct, then one could simply drop synchronisation after implementing my first suggestion.\n\nThis is related with #10294 and perhaps with #10295. Cc to William and Willem-Jan, since they wrote the synchronisation code.\n\nIssue created by migration from https://trac.sagemath.org/ticket/10296\n\n",
    "created_at": "2010-11-20T09:20:13Z",
    "labels": [
        "interfaces",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.0",
    "title": "Singular interface wasting time by calling select.select() too often",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10295",
    "user": "SimonKing"
}
```
Assignee: was

CC:  was wjp alexanderdreyer malb leif

Keywords: Singular, _eval_line, synchronization, synchronisation

There are two fundamental differences between the Singular and the Gap interfaces:

1. The Singular interface uses a synchronisation method in each call to its eval method. Gap doesn't.
2. The Gap interface deletes variables by declaring that their name may be overwritten. This is not possible in Singular, since Singular variables are statically typed. Thus, the Singular interface explicitly kills the underlying variable in Singular, which requires one call to _eval_line for each variable that is to be deleted.

Unfortunately, waiting for the prompt to appear in a pseudo terminal may be very costly on some systems, since select.select() may be very slow - see #10294. So, additional calls to _eval_line should be strictly avoided!

The first point makes me wonder: Why has the synchronisation method become necessary for Singular but not for Gap?

The second point makes me wonder whether it is really necessary to use one _eval_line for each single deletion.

Moreover, I wonder whether the two points are actually related: I could imagine that synchronisation became necessary when garbage collection, accidentally performed inside an _eval_line, and thus sending an _eval_line inside an outer _eval_line, caused a dead lock in the outer _eval_line. Was that the case, historically?

Suggestions:

1. `singular.eval(cmd)` is currently simply passing `cmd` to _eval_line, after synchronisation and after killing unused variables. I suggest to add the code for killing unused variables to `cmd`, thus using _eval_line only once.
2. If my above guess on the role of synchronisation is correct, then one could simply drop synchronisation after implementing my first suggestion.

This is related with #10294 and perhaps with #10295. Cc to William and Willem-Jan, since they wrote the synchronisation code.

Issue created by migration from https://trac.sagemath.org/ticket/10296





---

archive/issue_comments_105318.json:
```json
{
    "body": "Committing the kills in `singular.eval` by prepending stuff to the given command turned out to break a lot of doc tests, since they test against the given command showing up in the output. But I think one could be even closer to the Gap interface. \n\nRecall that in the Gap interface, variables are freed by allowing to re-use their names. So, memory allocated in Gap is only freed when the old variable is actually overwritten.\n\nIn Singular, memory is freed by the command `kill`. I suggest to use this command not inside `singular.eval` but inside `SingularElement.__init__`: It is put in front of the command that creates the new variable. Then, the analogy between Gap and Singular interfaces is rather close: Memory in Gap or in Singular is freed only when a new Element is created -- by overwriting the old stuff in the case of Gap, or by killing the old stuff in the case of Singular.\n\nMoreover, I removed the synchronisation code, since it seems to me that synchronisation is not really necessary if the garbage collection is not using an additional _eval_line (which is the case with my suggestion).\n\nSo, there remains only *one* call to select.select when creating a new Singular element, rather than two plus the number of old variables to be killed. \n\nIndeed, my approach reduces the overhead in using the Singular interface by 2/3 in the test above!\n\nBut there occur two doctest failures, that I have to deal with now.",
    "created_at": "2010-11-20T12:35:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105318",
    "user": "SimonKing"
}
```

Committing the kills in `singular.eval` by prepending stuff to the given command turned out to break a lot of doc tests, since they test against the given command showing up in the output. But I think one could be even closer to the Gap interface. 

Recall that in the Gap interface, variables are freed by allowing to re-use their names. So, memory allocated in Gap is only freed when the old variable is actually overwritten.

In Singular, memory is freed by the command `kill`. I suggest to use this command not inside `singular.eval` but inside `SingularElement.__init__`: It is put in front of the command that creates the new variable. Then, the analogy between Gap and Singular interfaces is rather close: Memory in Gap or in Singular is freed only when a new Element is created -- by overwriting the old stuff in the case of Gap, or by killing the old stuff in the case of Singular.

Moreover, I removed the synchronisation code, since it seems to me that synchronisation is not really necessary if the garbage collection is not using an additional _eval_line (which is the case with my suggestion).

So, there remains only *one* call to select.select when creating a new Singular element, rather than two plus the number of old variables to be killed. 

Indeed, my approach reduces the overhead in using the Singular interface by 2/3 in the test above!

But there occur two doctest failures, that I have to deal with now.



---

archive/issue_comments_105319.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2010-11-23T12:34:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105319",
    "user": "SimonKing"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_105320.json:
```json
{
    "body": "My patch does the following.\n\n**__Garbage Collection__**\n\nIn the Singular interface, freeing the memory used for old variables in Singular  requires to send a \"kill\" command to Singular, presumably by _eval_line.\n\nA problem would result if garbage collection would create such _eval_line inside an outer _eval_line: The inner _eval_line would cause the outer _eval_line to hang forever. I guess this was the reason why the del method does not actually delete the variables but only marks them for deletion; the actual deletion is postponed to the next use of \"eval\".\n\nI guess that for the same reason, synchronisation is done at the beginning of \"eval\".  **Please correct me, if the reason for synchronising so frequently is different!**\n\nI suggest to do the deletions a bit less frequently, namely in the \"set\" method rather than in the \"eval\" method. Moreover, I suggest to send the kill command not by a separate _eval_line (one for each old variable), but to prepend the join of all kill commands to the command that creates the new variable.\n\nSince killing does not require an additional _eval_line, nesting can not occur. So, synchronisation is not needed.\n\n**__Overhead Reduction__**\n\nAs mentioned in the ticket description, calling _eval_line frequently is bad, since waiting for the Singular prompt in the output of a pseudo terminal produces a massive overhead (up to 22ms per call) on some machines.\n\nMy patch removes synchronisation (which avoids one call to _eval_line per call to  eval), and killing old variables does not require any additional _eval_line. So, in the example proposed in the ticket description, the wall time drops by 2/3!\n\n**__Miscellaneous__**\n\nSynchronisation used to fail with an `AttributeError` for the GAP interface. It is fixed by the patch.\n\nI tried to make everything more stable, by giving more opportunities to detect that the interface crashed, and restarting if necessary.\n\nOf course, I added documentation and tests that (I think) cover all issues mentioned here. Moreover, I added tests covering some optional arguments to _eval_line.\n\nFor me, `sage -testall` passes. Hence, ready for review!",
    "created_at": "2010-11-23T12:34:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105320",
    "user": "SimonKing"
}
```

My patch does the following.

**__Garbage Collection__**

In the Singular interface, freeing the memory used for old variables in Singular  requires to send a "kill" command to Singular, presumably by _eval_line.

A problem would result if garbage collection would create such _eval_line inside an outer _eval_line: The inner _eval_line would cause the outer _eval_line to hang forever. I guess this was the reason why the del method does not actually delete the variables but only marks them for deletion; the actual deletion is postponed to the next use of "eval".

I guess that for the same reason, synchronisation is done at the beginning of "eval".  **Please correct me, if the reason for synchronising so frequently is different!**

I suggest to do the deletions a bit less frequently, namely in the "set" method rather than in the "eval" method. Moreover, I suggest to send the kill command not by a separate _eval_line (one for each old variable), but to prepend the join of all kill commands to the command that creates the new variable.

Since killing does not require an additional _eval_line, nesting can not occur. So, synchronisation is not needed.

**__Overhead Reduction__**

As mentioned in the ticket description, calling _eval_line frequently is bad, since waiting for the Singular prompt in the output of a pseudo terminal produces a massive overhead (up to 22ms per call) on some machines.

My patch removes synchronisation (which avoids one call to _eval_line per call to  eval), and killing old variables does not require any additional _eval_line. So, in the example proposed in the ticket description, the wall time drops by 2/3!

**__Miscellaneous__**

Synchronisation used to fail with an `AttributeError` for the GAP interface. It is fixed by the patch.

I tried to make everything more stable, by giving more opportunities to detect that the interface crashed, and restarting if necessary.

Of course, I added documentation and tests that (I think) cover all issues mentioned here. Moreover, I added tests covering some optional arguments to _eval_line.

For me, `sage -testall` passes. Hence, ready for review!



---

archive/issue_comments_105321.json:
```json
{
    "body": "The old patch needed to be rebased.\n\nThe new patch version should apply on top of `sage-4.6.1.alpha3`. I am now running doctests, but I'll keep it \"needs review\" for now.",
    "created_at": "2010-12-29T16:36:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105321",
    "user": "SimonKing"
}
```

The old patch needed to be rebased.

The new patch version should apply on top of `sage-4.6.1.alpha3`. I am now running doctests, but I'll keep it "needs review" for now.



---

archive/issue_comments_105322.json:
```json
{
    "body": "Not good. There are several timeouts in the tests. I need to work on it.",
    "created_at": "2010-12-29T17:21:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105322",
    "user": "SimonKing"
}
```

Not good. There are several timeouts in the tests. I need to work on it.



---

archive/issue_comments_105323.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2010-12-29T17:21:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105323",
    "user": "SimonKing"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_105324.json:
```json
{
    "body": "Replying to [comment:5 SimonKing]:\n> Not good. There are several timeouts in the tests.\n\nIt seems that I forgot `sage -b`. I repeated the tests that previously had a timeout, and now it is fine.\n\nI put it back to \"needs review\".",
    "created_at": "2010-12-29T17:55:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105324",
    "user": "SimonKing"
}
```

Replying to [comment:5 SimonKing]:
> Not good. There are several timeouts in the tests.

It seems that I forgot `sage -b`. I repeated the tests that previously had a timeout, and now it is fine.

I put it back to "needs review".



---

archive/issue_comments_105325.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2010-12-29T17:55:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105325",
    "user": "SimonKing"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_105326.json:
```json
{
    "body": "Since the nagbot currently does not seem to send messages: I hope you don't mind that I'm sending a reminder about speeding up the Singular pexpect interface.",
    "created_at": "2011-01-18T07:18:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105326",
    "user": "SimonKing"
}
```

Since the nagbot currently does not seem to send messages: I hope you don't mind that I'm sending a reminder about speeding up the Singular pexpect interface.



---

archive/issue_comments_105327.json:
```json
{
    "body": "I am sorry to nag you again - could someone take a look at the patch? The patchbot has no complaints at that point.",
    "created_at": "2011-02-11T07:58:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105327",
    "user": "SimonKing"
}
```

I am sorry to nag you again - could someone take a look at the patch? The patchbot has no complaints at that point.



---

archive/issue_comments_105328.json:
```json
{
    "body": "Too late...\n\nMeanwhile the patchbot finds some errors. I try to find the reason.",
    "created_at": "2011-03-08T15:15:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105328",
    "user": "SimonKing"
}
```

Too late...

Meanwhile the patchbot finds some errors. I try to find the reason.



---

archive/issue_comments_105329.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-03-08T15:15:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105329",
    "user": "SimonKing"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_105330.json:
```json
{
    "body": "Apparently, a `StdOutContext` was recently introduced, and the expected output for one doctest has changed by my patch. I changed the test slightly, so that now it should work.",
    "created_at": "2011-03-08T16:05:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105330",
    "user": "SimonKing"
}
```

Apparently, a `StdOutContext` was recently introduced, and the expected output for one doctest has changed by my patch. I changed the test slightly, so that now it should work.



---

archive/issue_comments_105331.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-03-08T16:05:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105331",
    "user": "SimonKing"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_105332.json:
```json
{
    "body": "I think reducing the overhead in the Singular pexpect interface by 2/3 is a good thing. But the ticket is starting to become old.\n\nReview, anyone?",
    "created_at": "2011-04-09T07:08:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105332",
    "user": "SimonKing"
}
```

I think reducing the overhead in the Singular pexpect interface by 2/3 is a good thing. But the ticket is starting to become old.

Review, anyone?



---

archive/issue_comments_105333.json:
```json
{
    "body": "Changing type from defect to enhancement.",
    "created_at": "2011-04-09T15:46:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105333",
    "user": "malb"
}
```

Changing type from defect to enhancement.



---

archive/issue_comments_105334.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-04-09T15:46:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105334",
    "user": "malb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_105335.json:
```json
{
    "body": "* the patch applies cleanly against 4.7.alpha3\n  * long doctests pass\n  * the patch is well documented \n  * the patch does look okay\n\nSo all good. The only caveat: I cannot claim I thought long and hard about the possible implications of changing this stuff. But unless someone comes up with a good example why Simon's approach is wrong, I'd say positive review.",
    "created_at": "2011-04-09T15:46:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105335",
    "user": "malb"
}
```

* the patch applies cleanly against 4.7.alpha3
  * long doctests pass
  * the patch is well documented 
  * the patch does look okay

So all good. The only caveat: I cannot claim I thought long and hard about the possible implications of changing this stuff. But unless someone comes up with a good example why Simon's approach is wrong, I'd say positive review.



---

archive/issue_comments_105336.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2011-04-12T13:46:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105336",
    "user": "jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_105337.json:
```json
{
    "body": "This will need to be rebased because it conflicts with #7377.",
    "created_at": "2011-04-12T13:46:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105337",
    "user": "jdemeyer"
}
```

This will need to be rebased because it conflicts with #7377.



---

archive/issue_comments_105338.json:
```json
{
    "body": "Replying to [comment:13 jdemeyer]:\n> This will need to be rebased because it conflicts with #7377.\n\nReally unfortunate. Apparently, in order to apply #7377 to my sage-4.6.2, I also need to import further patches.",
    "created_at": "2011-04-12T14:40:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105338",
    "user": "SimonKing"
}
```

Replying to [comment:13 jdemeyer]:
> This will need to be rebased because it conflicts with #7377.

Really unfortunate. Apparently, in order to apply #7377 to my sage-4.6.2, I also need to import further patches.



---

archive/issue_comments_105339.json:
```json
{
    "body": "Replying to [comment:14 SimonKing]:\n> Replying to [comment:13 jdemeyer]:\n> > This will need to be rebased because it conflicts with #7377.\n> \n> Really unfortunate. Apparently, in order to apply #7377 to my sage-4.6.2, I also need to import further patches. \n\nThe easiest solution is probably to download [http://boxen.math.washington.edu/home/release/sage-4.7.alpha5/sage-4.7.alpha5.tar](http://boxen.math.washington.edu/home/release/sage-4.7.alpha5/sage-4.7.alpha5.tar) which includes #7377.  This version of Sage is not released and will certainly change and might have doctest failures but at least it gives you a target to rebase to.",
    "created_at": "2011-04-12T15:22:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105339",
    "user": "jdemeyer"
}
```

Replying to [comment:14 SimonKing]:
> Replying to [comment:13 jdemeyer]:
> > This will need to be rebased because it conflicts with #7377.
> 
> Really unfortunate. Apparently, in order to apply #7377 to my sage-4.6.2, I also need to import further patches. 

The easiest solution is probably to download [http://boxen.math.washington.edu/home/release/sage-4.7.alpha5/sage-4.7.alpha5.tar](http://boxen.math.washington.edu/home/release/sage-4.7.alpha5/sage-4.7.alpha5.tar) which includes #7377.  This version of Sage is not released and will certainly change and might have doctest failures but at least it gives you a target to rebase to.



---

archive/issue_comments_105340.json:
```json
{
    "body": "It is really *really* unfortunate. The changes to the gap interface (so that gap restarts after quitting, instead of throwing an error) are now not working any more.",
    "created_at": "2011-04-13T08:38:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105340",
    "user": "SimonKing"
}
```

It is really *really* unfortunate. The changes to the gap interface (so that gap restarts after quitting, instead of throwing an error) are now not working any more.



---

archive/issue_comments_105341.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-04-13T09:38:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105341",
    "user": "SimonKing"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_105342.json:
```json
{
    "body": "I updated my patch. It should now apply to sage-4.7.alpha5. The long tests in `sage/interfaces/` all pass.\n\nReplying to [comment:16 SimonKing]:\n> It is really *really* unfortunate. The changes to the gap interface (so that gap restarts after quitting, instead of throwing an error) are now not working any more.\n\nThe reason for that was a typo when I applied one of the hunks manually.\n\nNote that I changed `.interrupt()` into `.interrupt(timeout=1)`  in two doctests. I don't know why, but they failed in about half of the cases. With the timeout parameter, they pass in 10 out of 10 runs.\n\nDoes that suffice to return to the positive review?\n\nIn any case, I am now running all long doctests.",
    "created_at": "2011-04-13T09:38:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105342",
    "user": "SimonKing"
}
```

I updated my patch. It should now apply to sage-4.7.alpha5. The long tests in `sage/interfaces/` all pass.

Replying to [comment:16 SimonKing]:
> It is really *really* unfortunate. The changes to the gap interface (so that gap restarts after quitting, instead of throwing an error) are now not working any more.

The reason for that was a typo when I applied one of the hunks manually.

Note that I changed `.interrupt()` into `.interrupt(timeout=1)`  in two doctests. I don't know why, but they failed in about half of the cases. With the timeout parameter, they pass in 10 out of 10 runs.

Does that suffice to return to the positive review?

In any case, I am now running all long doctests.



---

archive/issue_comments_105343.json:
```json
{
    "body": "Replying to [comment:17 SimonKing]:\n> Note that I changed `.interrupt()` into `.interrupt(timeout=1)`  in two doctests. I don't know why, but they failed in about half of the cases. With the timeout parameter, they pass in 10 out of 10 runs.\n> \n> Does that suffice to return to the positive review?\n> \n> In any case, I am now running all long doctests.\n\nFWIW: The long doctests all pass.",
    "created_at": "2011-04-13T11:26:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105343",
    "user": "SimonKing"
}
```

Replying to [comment:17 SimonKing]:
> Note that I changed `.interrupt()` into `.interrupt(timeout=1)`  in two doctests. I don't know why, but they failed in about half of the cases. With the timeout parameter, they pass in 10 out of 10 runs.
> 
> Does that suffice to return to the positive review?
> 
> In any case, I am now running all long doctests.

FWIW: The long doctests all pass.



---

archive/issue_comments_105344.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-04-13T11:50:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105344",
    "user": "malb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_105345.json:
```json
{
    "body": "yes, back to positive review.",
    "created_at": "2011-04-13T11:50:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105345",
    "user": "malb"
}
```

yes, back to positive review.



---

archive/issue_comments_105346.json:
```json
{
    "body": "Replying to [comment:17 SimonKing]:\n> Note that I changed `.interrupt()` into `.interrupt(timeout=1)`  in two doctests. I don't know why, but they failed in about half of the cases. With the timeout parameter, they pass in 10 out of 10 runs.\n\nI haven't looked at the patch in detail, but unexplained behaviour related to synchronization/interrupts in a patch modifying synchronization sounds a bit scary, and a reason to think about it some more...",
    "created_at": "2011-04-13T12:01:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105346",
    "user": "wjp"
}
```

Replying to [comment:17 SimonKing]:
> Note that I changed `.interrupt()` into `.interrupt(timeout=1)`  in two doctests. I don't know why, but they failed in about half of the cases. With the timeout parameter, they pass in 10 out of 10 runs.

I haven't looked at the patch in detail, but unexplained behaviour related to synchronization/interrupts in a patch modifying synchronization sounds a bit scary, and a reason to think about it some more...



---

archive/issue_comments_105347.json:
```json
{
    "body": "Replying to [comment:20 wjp]:\n> I haven't looked at the patch in detail, but unexplained behaviour related to synchronization/interrupts in a patch modifying synchronization sounds a bit scary, and a reason to think about it some more...\n\nFor the record: The test in question is new.\n\nIn sage-4.6 (as I just tested on sage.math), the test would in fact not work at all: When you do\n\n```\nsage: cutoff = singular._eval_using_file_cutoff \nsage: singular._eval_using_file_cutoff = 4 \nsage: singular._eval_line('for(int i=1;i<=3;i++){i=1;};', wait_for_prompt=False) \n```\n\nthen you needed to interrupt it manually.\n\nNow, the problem is that after the lines above, `sage: singular.interrupt()` is supposed to return `False`, which it always did on the command line, but in some (not all) doctest runs returns `True`.\n\nSince we wouldn't have been able to test it without my patch, we actually don't know \n  (1) whether the instability existed before and was uncovered by the patch, \n  (2) whether the problem was introduced by my patch, or\n  (3) whether the problem was a result of the changes to the pexpect interface in #7377.\n\nThe latter could actually be the case: Today was the first time ever that the `singular.interrupt()` example was problematic - and it was the first time that I worked with the patches from #7377.",
    "created_at": "2011-04-13T12:20:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105347",
    "user": "SimonKing"
}
```

Replying to [comment:20 wjp]:
> I haven't looked at the patch in detail, but unexplained behaviour related to synchronization/interrupts in a patch modifying synchronization sounds a bit scary, and a reason to think about it some more...

For the record: The test in question is new.

In sage-4.6 (as I just tested on sage.math), the test would in fact not work at all: When you do

```
sage: cutoff = singular._eval_using_file_cutoff 
sage: singular._eval_using_file_cutoff = 4 
sage: singular._eval_line('for(int i=1;i<=3;i++){i=1;};', wait_for_prompt=False) 
```

then you needed to interrupt it manually.

Now, the problem is that after the lines above, `sage: singular.interrupt()` is supposed to return `False`, which it always did on the command line, but in some (not all) doctest runs returns `True`.

Since we wouldn't have been able to test it without my patch, we actually don't know 
  (1) whether the instability existed before and was uncovered by the patch, 
  (2) whether the problem was introduced by my patch, or
  (3) whether the problem was a result of the changes to the pexpect interface in #7377.

The latter could actually be the case: Today was the first time ever that the `singular.interrupt()` example was problematic - and it was the first time that I worked with the patches from #7377.



---

archive/issue_comments_105348.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-04-13T19:45:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105348",
    "user": "jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_105349.json:
```json
{
    "body": "Replying to [comment:21 SimonKing]:\n> The latter could actually be the case: Today was the first time ever that the `singular.interrupt()` example was problematic - and it was the first time that I worked with the patches from #7377.\n\nI have decided *not* to merge #7377 in the sage-4.7 cycle.  I will merge it in sage-4.7.1.alpha0, such that potential issues with #7377 can be sorted out.",
    "created_at": "2011-04-14T18:30:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105349",
    "user": "jdemeyer"
}
```

Replying to [comment:21 SimonKing]:
> The latter could actually be the case: Today was the first time ever that the `singular.interrupt()` example was problematic - and it was the first time that I worked with the patches from #7377.

I have decided *not* to merge #7377 in the sage-4.7 cycle.  I will merge it in sage-4.7.1.alpha0, such that potential issues with #7377 can be sorted out.



---

archive/issue_comments_105350.json:
```json
{
    "body": "Shouldn't this ticket then re-opened as well?\n\nAnd should I perhaps provide two patch versions here, one depending on #7377 and one independent?",
    "created_at": "2011-04-14T18:38:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105350",
    "user": "SimonKing"
}
```

Shouldn't this ticket then re-opened as well?

And should I perhaps provide two patch versions here, one depending on #7377 and one independent?



---

archive/issue_comments_105351.json:
```json
{
    "body": "Replying to [comment:25 SimonKing]:\n> Shouldn't this ticket then re-opened as well?\n> \n> And should I perhaps provide two patch versions here, one depending on #7377 and one independent?\n\nFor the moment, the plan is still to merge #7377 in sage-4.7.1.alpha0 together with #10296 and a fixed #10818.  So for the moment, I think we can leave this ticket as it is.",
    "created_at": "2011-04-14T18:47:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105351",
    "user": "jdemeyer"
}
```

Replying to [comment:25 SimonKing]:
> Shouldn't this ticket then re-opened as well?
> 
> And should I perhaps provide two patch versions here, one depending on #7377 and one independent?

For the moment, the plan is still to merge #7377 in sage-4.7.1.alpha0 together with #10296 and a fixed #10818.  So for the moment, I think we can leave this ticket as it is.



---

archive/issue_comments_105352.json:
```json
{
    "body": "I've ran more than 100 tests of expect.py and gap.py without \"timeout=1\" (so using the default value of timeout=0.3) on Sage 4.7.alpha3 + #7377 + #10818 + #10296, built from scratch on debian unstable/experimental amd64, intel core 2 quad, and everything passed.\n\nBy the way, hg failed to apply the patch, I had to manually apply the following hunk:\n\n\n```\n--- gap.py\n+++ gap.py\n@@ -475,46 +532,45 @@\n\n```\n\nThe only difference is that the tests are obviously longer with a greater value of timeout.\n\nCould anyone else check whether the default value of timeout gives a random behavior, at least as often as every two times?",
    "created_at": "2011-04-15T11:13:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105352",
    "user": "jpflori"
}
```

I've ran more than 100 tests of expect.py and gap.py without "timeout=1" (so using the default value of timeout=0.3) on Sage 4.7.alpha3 + #7377 + #10818 + #10296, built from scratch on debian unstable/experimental amd64, intel core 2 quad, and everything passed.

By the way, hg failed to apply the patch, I had to manually apply the following hunk:


```
--- gap.py
+++ gap.py
@@ -475,46 +532,45 @@

```

The only difference is that the tests are obviously longer with a greater value of timeout.

Could anyone else check whether the default value of timeout gives a random behavior, at least as often as every two times?



---

archive/issue_comments_105353.json:
```json
{
    "body": "Replying to [comment:27 jpflori]:\n> I've ran more than 100 tests of expect.py and gap.py without \"timeout=1\" (so using the default value of timeout=0.3) on Sage 4.7.alpha3 + #7377 + #10818 + #10296, built from scratch on debian unstable/experimental amd64, intel core 2 quad, and everything passed.\n\nQuite a relief...\n\nI have Debian GNU/Linux squeeze/sid, and I think our administrator did patch the kernel in order to make pseudo-Tty faster. The reason is that, without that kernel patch, the overhead of all pexpect interfaces is abundant. It is, of course, imaginable that the kernel patch is responsible for the flaky behaviour of the test on my machine.",
    "created_at": "2011-04-15T12:01:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105353",
    "user": "SimonKing"
}
```

Replying to [comment:27 jpflori]:
> I've ran more than 100 tests of expect.py and gap.py without "timeout=1" (so using the default value of timeout=0.3) on Sage 4.7.alpha3 + #7377 + #10818 + #10296, built from scratch on debian unstable/experimental amd64, intel core 2 quad, and everything passed.

Quite a relief...

I have Debian GNU/Linux squeeze/sid, and I think our administrator did patch the kernel in order to make pseudo-Tty faster. The reason is that, without that kernel patch, the overhead of all pexpect interfaces is abundant. It is, of course, imaginable that the kernel patch is responsible for the flaky behaviour of the test on my machine.



---

archive/issue_comments_105354.json:
```json
{
    "body": "Ok, I've now done 500 tests of both without problems.",
    "created_at": "2011-04-15T13:53:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105354",
    "user": "jpflori"
}
```

Ok, I've now done 500 tests of both without problems.



---

archive/issue_comments_105355.json:
```json
{
    "body": "I get many failures on the buildbot, mainly on non-Linux systems (e.g. OS X, Solaris).  The failures look like the following:\n\n```\nsage -t -long  -force_lib devel/sage/sage/interfaces/expect.py\n**********************************************************************\nFile \"/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/devel/sage-main/sage/interfaces/expect.py\", line 702:\n    sage: singular._eval_line_using_file('def a=3;')\nException raised:\n    Traceback (most recent call last):\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_15[5]>\", line 1, in <module>\n        singular._eval_line_using_file('def a=3;')###line 702:\n    sage: singular._eval_line_using_file('def a=3;')\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/local/lib/python/site-packages/sage/interfaces/expect.py\", line 731, in _eval_line_using_file\n        s = self._eval_line(self._read_in_file_command(tmp_to_use), allow_use_file=False)\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/local/lib/python/site-packages/sage/interfaces/expect.py\", line 841, in _eval_line\n        raise RuntimeError, \"%s\\nError evaluating %s in %s\"%(msg, line, self)\n    RuntimeError: [Errno 5] Input/output error\n    Error evaluating < \"/tmp/dot_sage.gjyZgjfltL/temp/bsd.local/8324//interface//tmp8502\"; in Singular\n**********************************************************************\n[..many more similar errors..]\n\n\nsage -t -long  -force_lib devel/sage/sage/interfaces/gap.py\n**********************************************************************\nFile \"/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/devel/sage-main/sage/interfaces/gap.py\", line 521:\n    sage: a = gap(3)\nException raised:\n    Traceback (most recent call last):\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_9[10]>\", line 1, in <module>\n        a = gap(Integer(3))###line 521:\n    sage: a = gap(3)\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/local/lib/python/site-packages/sage/interfaces/interface.py\", line 201, in __call__\n        return self._coerce_from_special_method(x)\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/local/lib/python/site-packages/sage/interfaces/interface.py\", line 227, in _coerce_from_special_method\n        return (x.__getattribute__(s))(self)\n      File \"sage_object.pyx\", line 463, in sage.structure.sage_object.SageObject._gap_ (sage/structure/sage_object.c:3988)\n      File \"sage_object.pyx\", line 439, in sage.structure.sage_object.SageObject._interface_ (sage/structure/sage_object.c:3628)\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/local/lib/python/site-packages/sage/interfaces/interface.py\", line 199, in __call__\n        return cls(self, x, name=name)\n      File \"/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/local/lib/python/site-packages/sage/interfaces/expect.py\", line 1286, in __init__\n        raise TypeError, x\n    TypeError: Error evaluating $sage9:=3;; in Gap\n**********************************************************************\n```\n",
    "created_at": "2011-05-03T12:27:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105355",
    "user": "jdemeyer"
}
```

I get many failures on the buildbot, mainly on non-Linux systems (e.g. OS X, Solaris).  The failures look like the following:

```
sage -t -long  -force_lib devel/sage/sage/interfaces/expect.py
**********************************************************************
File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/devel/sage-main/sage/interfaces/expect.py", line 702:
    sage: singular._eval_line_using_file('def a=3;')
Exception raised:
    Traceback (most recent call last):
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_15[5]>", line 1, in <module>
        singular._eval_line_using_file('def a=3;')###line 702:
    sage: singular._eval_line_using_file('def a=3;')
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/local/lib/python/site-packages/sage/interfaces/expect.py", line 731, in _eval_line_using_file
        s = self._eval_line(self._read_in_file_command(tmp_to_use), allow_use_file=False)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/local/lib/python/site-packages/sage/interfaces/expect.py", line 841, in _eval_line
        raise RuntimeError, "%s\nError evaluating %s in %s"%(msg, line, self)
    RuntimeError: [Errno 5] Input/output error
    Error evaluating < "/tmp/dot_sage.gjyZgjfltL/temp/bsd.local/8324//interface//tmp8502"; in Singular
**********************************************************************
[..many more similar errors..]


sage -t -long  -force_lib devel/sage/sage/interfaces/gap.py
**********************************************************************
File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/devel/sage-main/sage/interfaces/gap.py", line 521:
    sage: a = gap(3)
Exception raised:
    Traceback (most recent call last):
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_9[10]>", line 1, in <module>
        a = gap(Integer(3))###line 521:
    sage: a = gap(3)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/local/lib/python/site-packages/sage/interfaces/interface.py", line 201, in __call__
        return self._coerce_from_special_method(x)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/local/lib/python/site-packages/sage/interfaces/interface.py", line 227, in _coerce_from_special_method
        return (x.__getattribute__(s))(self)
      File "sage_object.pyx", line 463, in sage.structure.sage_object.SageObject._gap_ (sage/structure/sage_object.c:3988)
      File "sage_object.pyx", line 439, in sage.structure.sage_object.SageObject._interface_ (sage/structure/sage_object.c:3628)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/local/lib/python/site-packages/sage/interfaces/interface.py", line 199, in __call__
        return cls(self, x, name=name)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/local/lib/python/site-packages/sage/interfaces/expect.py", line 1286, in __init__
        raise TypeError, x
    TypeError: Error evaluating $sage9:=3;; in Gap
**********************************************************************
```




---

archive/issue_comments_105356.json:
```json
{
    "body": "Changing status from closed to new.",
    "created_at": "2011-05-03T12:27:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105356",
    "user": "jdemeyer"
}
```

Changing status from closed to new.



---

archive/issue_comments_105357.json:
```json
{
    "body": "Resolution changed from fixed to ",
    "created_at": "2011-05-03T12:27:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105357",
    "user": "jdemeyer"
}
```

Resolution changed from fixed to 



---

archive/issue_comments_105358.json:
```json
{
    "body": "That's bad. Perhaps its a difference in new line / carriage return characters?\n\nProbably I need to build sage on bsd.math before being able to test.",
    "created_at": "2011-05-03T14:17:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105358",
    "user": "SimonKing"
}
```

That's bad. Perhaps its a difference in new line / carriage return characters?

Probably I need to build sage on bsd.math before being able to test.



---

archive/issue_comments_105359.json:
```json
{
    "body": "Replying to [comment:31 SimonKing]:\n> That's bad. Perhaps its a difference in new line / carriage return characters?\n`RuntimeError: [Errno 5] Input/output error` seems to indicate something more low-level related to the OS (for example, the handling of pseudo-tty's).\n\n> Probably I need to build sage on bsd.math before being able to test.\nYou can start working from the non-released sage-4.7.1.alpha0: [http://boxen.math.washington.edu/home/release/sage-4.7.1.alpha0/sage-4.7.1.alpha0.tar](http://boxen.math.washington.edu/home/release/sage-4.7.1.alpha0/sage-4.7.1.alpha0.tar).  This currently includes #7377 but not #10296, but this is of course subject to change.",
    "created_at": "2011-05-03T16:29:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105359",
    "user": "jdemeyer"
}
```

Replying to [comment:31 SimonKing]:
> That's bad. Perhaps its a difference in new line / carriage return characters?
`RuntimeError: [Errno 5] Input/output error` seems to indicate something more low-level related to the OS (for example, the handling of pseudo-tty's).

> Probably I need to build sage on bsd.math before being able to test.
You can start working from the non-released sage-4.7.1.alpha0: [http://boxen.math.washington.edu/home/release/sage-4.7.1.alpha0/sage-4.7.1.alpha0.tar](http://boxen.math.washington.edu/home/release/sage-4.7.1.alpha0/sage-4.7.1.alpha0.tar).  This currently includes #7377 but not #10296, but this is of course subject to change.



---

archive/issue_comments_105360.json:
```json
{
    "body": "Replying to [comment:32 jdemeyer]:\n> You can start working from the non-released sage-4.7.1.alpha0: [http://boxen.math.washington.edu/home/release/sage-4.7.1.alpha0/sage-4.7.1.alpha0.tar](http://boxen.math.washington.edu/home/release/sage-4.7.1.alpha0/sage-4.7.1.alpha0.tar).  This currently includes #7377 but not #10296, but this is of course subject to change.\n\nThank you, but the compilation of sage-4.7 on bsd.math is already in the final stages (building documentation, if I am not mistaken).",
    "created_at": "2011-05-03T16:39:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105360",
    "user": "SimonKing"
}
```

Replying to [comment:32 jdemeyer]:
> You can start working from the non-released sage-4.7.1.alpha0: [http://boxen.math.washington.edu/home/release/sage-4.7.1.alpha0/sage-4.7.1.alpha0.tar](http://boxen.math.washington.edu/home/release/sage-4.7.1.alpha0/sage-4.7.1.alpha0.tar).  This currently includes #7377 but not #10296, but this is of course subject to change.

Thank you, but the compilation of sage-4.7 on bsd.math is already in the final stages (building documentation, if I am not mistaken).



---

archive/issue_comments_105361.json:
```json
{
    "body": "Replying to [comment:32 jdemeyer]:\n> `RuntimeError: [Errno 5] Input/output error` seems to indicate something more low-level related to the OS (for example, the handling of pseudo-tty's).\n\nThat could be. I already found: If you quit gap by sending \"quit;\" through the gap interface (by gap.eval) and then try to evaluate a command, then you get a different error or error message on bsd.math than on my computer.\n\nWhat my patch did was to search for \"EOL\" in the error message, which should be fast and suffices on my computer (Linux). If it does not suffice (as on bsd.math) then one could still test gap._expect.isalive(). That's slower, but apparently more robust.\n\nThe other error you are reporting seems similar in spirit, but is in a different place.",
    "created_at": "2011-05-03T20:41:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105361",
    "user": "SimonKing"
}
```

Replying to [comment:32 jdemeyer]:
> `RuntimeError: [Errno 5] Input/output error` seems to indicate something more low-level related to the OS (for example, the handling of pseudo-tty's).

That could be. I already found: If you quit gap by sending "quit;" through the gap interface (by gap.eval) and then try to evaluate a command, then you get a different error or error message on bsd.math than on my computer.

What my patch did was to search for "EOL" in the error message, which should be fast and suffices on my computer (Linux). If it does not suffice (as on bsd.math) then one could still test gap._expect.isalive(). That's slower, but apparently more robust.

The other error you are reporting seems similar in spirit, but is in a different place.



---

archive/issue_comments_105362.json:
```json
{
    "body": "I just submitted a new patch that solves part of the problem: There are different error types raised on linux and non-linux machines if a pexpect interfaces crashes. But there are some doctest failures left, so, it still needs work.",
    "created_at": "2011-05-04T07:17:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105362",
    "user": "SimonKing"
}
```

I just submitted a new patch that solves part of the problem: There are different error types raised on linux and non-linux machines if a pexpect interfaces crashes. But there are some doctest failures left, so, it still needs work.



---

archive/issue_comments_105363.json:
```json
{
    "body": "The problem with the remaining doctest failures is that my patch introduces a new argument `first_call` to `sage.interfaces.expect.Expect._eval_line`: The idea is to restart the interface if it is crashed unexpectedly and then re-eval the line, but only once, to avoid infinite loops. The `first_call` argument tells whether it is the first evaluation, or the re-evaluation after a crash.\n\nBut some interfaces override `_eval_line` and don't know about the new argument. It should thus be added.",
    "created_at": "2011-05-04T07:29:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105363",
    "user": "SimonKing"
}
```

The problem with the remaining doctest failures is that my patch introduces a new argument `first_call` to `sage.interfaces.expect.Expect._eval_line`: The idea is to restart the interface if it is crashed unexpectedly and then re-eval the line, but only once, to avoid infinite loops. The `first_call` argument tells whether it is the first evaluation, or the re-evaluation after a crash.

But some interfaces override `_eval_line` and don't know about the new argument. It should thus be added.



---

archive/issue_comments_105364.json:
```json
{
    "body": "Fortunately I can do some optional tests (e.g. maple) on bsd.math. It revealed another problem: Some code relies on a specific error message. But in my patch, that error is caught and replaced by a generic error telling that the interface crashed. That should be taken care of as well.",
    "created_at": "2011-05-04T08:42:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105364",
    "user": "SimonKing"
}
```

Fortunately I can do some optional tests (e.g. maple) on bsd.math. It revealed another problem: Some code relies on a specific error message. But in my patch, that error is caught and replaced by a generic error telling that the interface crashed. That should be taken care of as well.



---

archive/issue_comments_105365.json:
```json
{
    "body": "Make the automatic restart of pexpect interfaces work on non-linux machines",
    "created_at": "2011-05-04T09:10:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105365",
    "user": "SimonKing"
}
```

Make the automatic restart of pexpect interfaces work on non-linux machines



---

archive/issue_comments_105366.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-05-04T09:12:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105366",
    "user": "SimonKing"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_105367.json:
```json
{
    "body": "Attachment [trac10296_expect_on_nonlinux.patch](tarball://root/attachments/some-uuid/ticket10296/trac10296_expect_on_nonlinux.patch) by SimonKing created at 2011-05-04 09:12:33\n\nI think I got it solved: The long doctests in sage/interfaces pass both on my machine and on bsd.math. This is based on sage-4.7.\n\nIn addition, the optional tests of sage/interfaces/maple.py pass on bsd.math as well, with the exception of those that fail with pure sage-4.7 anyway (see #11288).\n\nDepends on #7377.",
    "created_at": "2011-05-04T09:12:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105367",
    "user": "SimonKing"
}
```

Attachment [trac10296_expect_on_nonlinux.patch](tarball://root/attachments/some-uuid/ticket10296/trac10296_expect_on_nonlinux.patch) by SimonKing created at 2011-05-04 09:12:33

I think I got it solved: The long doctests in sage/interfaces pass both on my machine and on bsd.math. This is based on sage-4.7.

In addition, the optional tests of sage/interfaces/maple.py pass on bsd.math as well, with the exception of those that fail with pure sage-4.7 anyway (see #11288).

Depends on #7377.



---

archive/issue_comments_105368.json:
```json
{
    "body": "PS: Since the new patch is not totally trivial, I think someone should look at it, i.e., not simply restoring the old positive review.",
    "created_at": "2011-05-04T12:03:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105368",
    "user": "SimonKing"
}
```

PS: Since the new patch is not totally trivial, I think someone should look at it, i.e., not simply restoring the old positive review.



---

archive/issue_comments_105369.json:
```json
{
    "body": "*bump*\n\nAny reviewers?",
    "created_at": "2011-05-25T13:47:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105369",
    "user": "jdemeyer"
}
```

*bump*

Any reviewers?



---

archive/issue_comments_105370.json:
```json
{
    "body": "Actually from the description of the first patch it could help with some problems in #9958 so I will take a look and test them on linux and OS X.",
    "created_at": "2011-05-25T18:36:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105370",
    "user": "fbissey"
}
```

Actually from the description of the first patch it could help with some problems in #9958 so I will take a look and test them on linux and OS X.



---

archive/issue_comments_105371.json:
```json
{
    "body": "On OS X 10.5.8 with 4.7.1.alpha1 I get the following after applying the patch\n\n```\nsage -t -long \"devel/sage/sage/interfaces/gap.py\"           \n**********************************************************************\nFile \"/Users/frb15/Desktop/sage-4.7.1.alpha1/devel/sage/sage/interfaces/gap.py\", line 514:\n    sage: gap.interrupt(timeout=1)\nExpected:\n    True\nGot:\n    False\n**********************************************************************\n```\n\nThis is a test introduced in [attachment:trac10296_singular_overhead.patch]",
    "created_at": "2011-05-27T04:41:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105371",
    "user": "fbissey"
}
```

On OS X 10.5.8 with 4.7.1.alpha1 I get the following after applying the patch

```
sage -t -long "devel/sage/sage/interfaces/gap.py"           
**********************************************************************
File "/Users/frb15/Desktop/sage-4.7.1.alpha1/devel/sage/sage/interfaces/gap.py", line 514:
    sage: gap.interrupt(timeout=1)
Expected:
    True
Got:
    False
**********************************************************************
```

This is a test introduced in [attachment:trac10296_singular_overhead.patch]



---

archive/issue_comments_105372.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-05-27T04:41:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105372",
    "user": "fbissey"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_105373.json:
```json
{
    "body": "Replying to [comment:42 fbissey]:\n> On OS X 10.5.8 with 4.7.1.alpha1 I get the following after applying the patch\n> {{{\n> sage -t -long \"devel/sage/sage/interfaces/gap.py\"           \n> **********************************************************************\n> File \"/Users/frb15/Desktop/sage-4.7.1.alpha1/devel/sage/sage/interfaces/gap.py\", line 514:\n>     sage: gap.interrupt(timeout=1)\n> Expected:\n>     True\n> Got:\n>     False\n> **********************************************************************\n> }}}\n\nThat test is really annoying. I tried to make it more reliable by adding the timeout parameter, but apparently it does not work like that.\n\nHowever, the main point is that without the patch, we had\n\n```\nsage: cutoff = gap._eval_using_file_cutoff \nsage: gap._eval_using_file_cutoff = 4 \nsage: gap._eval_line('while(1=1) do i:=1;; od;', wait_for_prompt=False) \n<Runs forever>\n```\n\nIn other words, we would not even come to the line `gap.interrupt()`.\n\nI would not mind if the new test simply made sure that no error is raised. It does not matter, IMHO, whether we have the return value `True` or `False`. So, perhaps change it into\n\n```\nsage: gap.interrupt(timeout=1) is not None\nTrue\n```\n\nor\n\n```\nsage: gap.interrupt(timeout=1)\n...\n```\n\n\n?",
    "created_at": "2011-05-27T05:42:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105373",
    "user": "SimonKing"
}
```

Replying to [comment:42 fbissey]:
> On OS X 10.5.8 with 4.7.1.alpha1 I get the following after applying the patch
> {{{
> sage -t -long "devel/sage/sage/interfaces/gap.py"           
> **********************************************************************
> File "/Users/frb15/Desktop/sage-4.7.1.alpha1/devel/sage/sage/interfaces/gap.py", line 514:
>     sage: gap.interrupt(timeout=1)
> Expected:
>     True
> Got:
>     False
> **********************************************************************
> }}}

That test is really annoying. I tried to make it more reliable by adding the timeout parameter, but apparently it does not work like that.

However, the main point is that without the patch, we had

```
sage: cutoff = gap._eval_using_file_cutoff 
sage: gap._eval_using_file_cutoff = 4 
sage: gap._eval_line('while(1=1) do i:=1;; od;', wait_for_prompt=False) 
<Runs forever>
```

In other words, we would not even come to the line `gap.interrupt()`.

I would not mind if the new test simply made sure that no error is raised. It does not matter, IMHO, whether we have the return value `True` or `False`. So, perhaps change it into

```
sage: gap.interrupt(timeout=1) is not None
True
```

or

```
sage: gap.interrupt(timeout=1)
...
```


?



---

archive/issue_comments_105374.json:
```json
{
    "body": "Replying to [comment:43 SimonKing]:\n> Replying to [comment:42 fbissey]:\n> > On OS X 10.5.8 with 4.7.1.alpha1 I get the following after applying the patch\n> > {{{\n> > sage -t -long \"devel/sage/sage/interfaces/gap.py\"           \n> > **********************************************************************\n> > File \"/Users/frb15/Desktop/sage-4.7.1.alpha1/devel/sage/sage/interfaces/gap.py\", line 514:\n> >     sage: gap.interrupt(timeout=1)\n> > Expected:\n> >     True\n> > Got:\n> >     False\n> > **********************************************************************\n> > }}}\n> \n> That test is really annoying. I tried to make it more reliable by adding the timeout parameter, but apparently it does not work like that.\n> \n> However, the main point is that without the patch, we had\n> {{{\n> sage: cutoff = gap._eval_using_file_cutoff \n> sage: gap._eval_using_file_cutoff = 4 \n> sage: gap._eval_line('while(1=1) do i:=1;; od;', wait_for_prompt=False) \n> <Runs forever>\n> }}}\n> In other words, we would not even come to the line `gap.interrupt()`.\n> \n> I would not mind if the new test simply made sure that no error is raised. It does not matter, IMHO, whether we have the return value `True` or `False`. So, perhaps change it into\n> {{{\n> sage: gap.interrupt(timeout=1) is not None\n> True\n> }}}\n> or\n> {{{\n> sage: gap.interrupt(timeout=1)\n> ...\n> }}}\n> \n> ?\nThe later one would imply that the output is random, but we would miss it if an error was raised so I guess the former would be better. \n\n```\ngap.interrupt(timeout=1) is not None\n```\n\nhas my vote.",
    "created_at": "2011-05-30T03:32:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105374",
    "user": "fbissey"
}
```

Replying to [comment:43 SimonKing]:
> Replying to [comment:42 fbissey]:
> > On OS X 10.5.8 with 4.7.1.alpha1 I get the following after applying the patch
> > {{{
> > sage -t -long "devel/sage/sage/interfaces/gap.py"           
> > **********************************************************************
> > File "/Users/frb15/Desktop/sage-4.7.1.alpha1/devel/sage/sage/interfaces/gap.py", line 514:
> >     sage: gap.interrupt(timeout=1)
> > Expected:
> >     True
> > Got:
> >     False
> > **********************************************************************
> > }}}
> 
> That test is really annoying. I tried to make it more reliable by adding the timeout parameter, but apparently it does not work like that.
> 
> However, the main point is that without the patch, we had
> {{{
> sage: cutoff = gap._eval_using_file_cutoff 
> sage: gap._eval_using_file_cutoff = 4 
> sage: gap._eval_line('while(1=1) do i:=1;; od;', wait_for_prompt=False) 
> <Runs forever>
> }}}
> In other words, we would not even come to the line `gap.interrupt()`.
> 
> I would not mind if the new test simply made sure that no error is raised. It does not matter, IMHO, whether we have the return value `True` or `False`. So, perhaps change it into
> {{{
> sage: gap.interrupt(timeout=1) is not None
> True
> }}}
> or
> {{{
> sage: gap.interrupt(timeout=1)
> ...
> }}}
> 
> ?
The later one would imply that the output is random, but we would miss it if an error was raised so I guess the former would be better. 

```
gap.interrupt(timeout=1) is not None
```

has my vote.



---

archive/issue_comments_105375.json:
```json
{
    "body": "The \"idling\" doctests (on e.g. Ubuntu) are really annoying, especially when doing `testlong` rather than `ptestlong`...\n\nCan someone (finish? and) review this, or what's stopping it?",
    "created_at": "2011-07-22T06:36:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105375",
    "user": "leif"
}
```

The "idling" doctests (on e.g. Ubuntu) are really annoying, especially when doing `testlong` rather than `ptestlong`...

Can someone (finish? and) review this, or what's stopping it?



---

archive/issue_comments_105376.json:
```json
{
    "body": "Replying to [comment:45 leif]:\n> The \"idling\" doctests (on e.g. Ubuntu) are really annoying, especially when doing `testlong` rather than `ptestlong`...\n> \n> Can someone (finish? and) review this, or what's stopping it?\n\nI think the problem was that a couple of weeks ago I had other things on my mind, and thus I forgot to do the change into `gap.interrupt(timeout=1) is not None`. I guess I'll do it now.",
    "created_at": "2011-07-22T08:45:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105376",
    "user": "SimonKing"
}
```

Replying to [comment:45 leif]:
> The "idling" doctests (on e.g. Ubuntu) are really annoying, especially when doing `testlong` rather than `ptestlong`...
> 
> Can someone (finish? and) review this, or what's stopping it?

I think the problem was that a couple of weeks ago I had other things on my mind, and thus I forgot to do the change into `gap.interrupt(timeout=1) is not None`. I guess I'll do it now.



---

archive/issue_comments_105377.json:
```json
{
    "body": "Replying to [comment:46 SimonKing]:\n> Replying to [comment:45 leif]:\n> > The \"idling\" doctests (on e.g. Ubuntu) are really annoying, especially when doing `testlong` rather than `ptestlong`...\n> I think the problem was that a couple of weeks ago I had other things on my mind, and thus I forgot to do the change into `gap.interrupt(timeout=1) is not None`. I guess I'll do it now.\n\nThat would be nice. Some tests (e.g. `sandpile`) here take more than 20 minutes each when running `make testlong`, which is totally odd.",
    "created_at": "2011-07-22T08:56:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105377",
    "user": "leif"
}
```

Replying to [comment:46 SimonKing]:
> Replying to [comment:45 leif]:
> > The "idling" doctests (on e.g. Ubuntu) are really annoying, especially when doing `testlong` rather than `ptestlong`...
> I think the problem was that a couple of weeks ago I had other things on my mind, and thus I forgot to do the change into `gap.interrupt(timeout=1) is not None`. I guess I'll do it now.

That would be nice. Some tests (e.g. `sandpile`) here take more than 20 minutes each when running `make testlong`, which is totally odd.



---

archive/issue_comments_105378.json:
```json
{
    "body": "Also, the first patch doesn't apply to sage-4.7.rc2. So, I'll take care of that as well.\n\nConcerning idleness: It seems that there is a certain kernel patch for Ubuntu that improves the pexpect performance. Namely, the problem with some OS like Ubuntu is that the latency of pseudo-tty is to much (if I understood correctly). After our sysadmin applied that patch, the problem vanished.\n\nSo, the main problem with pexpect on some platforms is not a Sage problem. That said, reducing the traffic in the pexpect interface is a good idea anyway...",
    "created_at": "2011-07-22T10:13:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105378",
    "user": "SimonKing"
}
```

Also, the first patch doesn't apply to sage-4.7.rc2. So, I'll take care of that as well.

Concerning idleness: It seems that there is a certain kernel patch for Ubuntu that improves the pexpect performance. Namely, the problem with some OS like Ubuntu is that the latency of pseudo-tty is to much (if I understood correctly). After our sysadmin applied that patch, the problem vanished.

So, the main problem with pexpect on some platforms is not a Sage problem. That said, reducing the traffic in the pexpect interface is a good idea anyway...



---

archive/issue_comments_105379.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-07-22T10:22:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105379",
    "user": "SimonKing"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_105380.json:
```json
{
    "body": "I have updated the first patch, which should now apply against sage-4.7.1.rc2. I have changed the doctest in question, so that now it is only tested that interrupting gap has worked.\n\nFor the patchbot:\n\nApply trac10296_singular_overhead.patch trac10296_expect_on_nonlinux.patch",
    "created_at": "2011-07-22T10:22:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105380",
    "user": "SimonKing"
}
```

I have updated the first patch, which should now apply against sage-4.7.1.rc2. I have changed the doctest in question, so that now it is only tested that interrupting gap has worked.

For the patchbot:

Apply trac10296_singular_overhead.patch trac10296_expect_on_nonlinux.patch



---

archive/issue_comments_105381.json:
```json
{
    "body": "Attachment [trac10296_singular_overhead.patch](tarball://root/attachments/some-uuid/ticket10296/trac10296_singular_overhead.patch) by SimonKing created at 2011-08-01 15:57:50\n\nModify garbage collection in Singular interface, which reduces the overhead. Synchronization of Gap interface.",
    "created_at": "2011-08-01T15:57:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105381",
    "user": "SimonKing"
}
```

Attachment [trac10296_singular_overhead.patch](tarball://root/attachments/some-uuid/ticket10296/trac10296_singular_overhead.patch) by SimonKing created at 2011-08-01 15:57:50

Modify garbage collection in Singular interface, which reduces the overhead. Synchronization of Gap interface.



---

archive/issue_comments_105382.json:
```json
{
    "body": "I had to rebase the first patch against sage-4.7.1.rc1. I had a typo in my previous post: The old patch was relative sage-4.7.rc2, not 4.7.1.rc2.\n\nApply trac10296_singular_overhead.patch trac10296_expect_on_nonlinux.patch \n\nBy the way: It still needs review...",
    "created_at": "2011-08-01T15:59:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105382",
    "user": "SimonKing"
}
```

I had to rebase the first patch against sage-4.7.1.rc1. I had a typo in my previous post: The old patch was relative sage-4.7.rc2, not 4.7.1.rc2.

Apply trac10296_singular_overhead.patch trac10296_expect_on_nonlinux.patch 

By the way: It still needs review...



---

archive/issue_comments_105383.json:
```json
{
    "body": "Any reviewer for a patch that improves the performance of the Singular pexpect interface?",
    "created_at": "2011-08-30T10:22:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105383",
    "user": "SimonKing"
}
```

Any reviewer for a patch that improves the performance of the Singular pexpect interface?



---

archive/issue_comments_105384.json:
```json
{
    "body": "patchbot claims tests failed but the full log shows all tests passed. Not sure what happened there. I'm running ptestlong on sage.math now.",
    "created_at": "2011-08-30T12:41:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105384",
    "user": "malb"
}
```

patchbot claims tests failed but the full log shows all tests passed. Not sure what happened there. I'm running ptestlong on sage.math now.



---

archive/issue_comments_105385.json:
```json
{
    "body": "I re-read the patches and I still think they are good, so I'm close to a positive review. One - perhaps nitpicking - point though: shouldn't `first_call` be `restart_if_needed` or something? \"First call\" isn't very telling what it does?",
    "created_at": "2011-08-30T13:52:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105385",
    "user": "malb"
}
```

I re-read the patches and I still think they are good, so I'm close to a positive review. One - perhaps nitpicking - point though: shouldn't `first_call` be `restart_if_needed` or something? "First call" isn't very telling what it does?



---

archive/issue_comments_105386.json:
```json
{
    "body": "Replying to [comment:53 malb]:\n> I re-read the patches and I still think they are good, so I'm close to a positive review. One - perhaps nitpicking - point though: shouldn't `first_call` be `restart_if_needed` or something? \"First call\" isn't very telling what it does?\n\nThat sounds like a good idea.",
    "created_at": "2011-08-30T14:12:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105386",
    "user": "SimonKing"
}
```

Replying to [comment:53 malb]:
> I re-read the patches and I still think they are good, so I'm close to a positive review. One - perhaps nitpicking - point though: shouldn't `first_call` be `restart_if_needed` or something? "First call" isn't very telling what it does?

That sounds like a good idea.



---

archive/issue_comments_105387.json:
```json
{
    "body": "Attachment [trac_10296-restart_if_needed.patch](tarball://root/attachments/some-uuid/ticket10296/trac_10296-restart_if_needed.patch) by mhansen created at 2011-12-18 14:41:55\n\nI've added a patch which makes this change.  Let's get this in.",
    "created_at": "2011-12-18T14:41:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105387",
    "user": "mhansen"
}
```

Attachment [trac_10296-restart_if_needed.patch](tarball://root/attachments/some-uuid/ticket10296/trac_10296-restart_if_needed.patch) by mhansen created at 2011-12-18 14:41:55

I've added a patch which makes this change.  Let's get this in.



---

archive/issue_comments_105388.json:
```json
{
    "body": "Martin, can you look whether my patches together with Mike's improvement of the wording is fine?\n\nApply trac10296_singular_overhead.patch trac10296_expect_on_nonlinux.patch trac_10296-restart_if_needed.patch",
    "created_at": "2012-03-02T09:52:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105388",
    "user": "SimonKing"
}
```

Martin, can you look whether my patches together with Mike's improvement of the wording is fine?

Apply trac10296_singular_overhead.patch trac10296_expect_on_nonlinux.patch trac_10296-restart_if_needed.patch



---

archive/issue_comments_105389.json:
```json
{
    "body": "Hi,\n\n* [attachment:trac_10296-restart_if_needed.patch] has no commit message\n* I get lots of errors when applying [attachment:trac10296_expect_on_nonlinux.patch] to 5.0-beta6?",
    "created_at": "2012-03-02T17:31:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105389",
    "user": "malb"
}
```

Hi,

* [attachment:trac_10296-restart_if_needed.patch] has no commit message
* I get lots of errors when applying [attachment:trac10296_expect_on_nonlinux.patch] to 5.0-beta6?



---

archive/issue_comments_105390.json:
```json
{
    "body": "Bad. Needs work, then...\n\nConcerning the missing commit message: I think I'll produce a combined patch with a commit message.",
    "created_at": "2012-03-02T18:10:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105390",
    "user": "SimonKing"
}
```

Bad. Needs work, then...

Concerning the missing commit message: I think I'll produce a combined patch with a commit message.



---

archive/issue_comments_105391.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-03-02T18:10:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105391",
    "user": "SimonKing"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_105392.json:
```json
{
    "body": "The first patch only applies with fuzz 2, because of #11431 (-> new dependency). The conflict is in the author list, easy to fix.",
    "created_at": "2012-03-03T07:52:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105392",
    "user": "SimonKing"
}
```

The first patch only applies with fuzz 2, because of #11431 (-> new dependency). The conflict is in the author list, easy to fix.



---

archive/issue_comments_105393.json:
```json
{
    "body": "I produced a combined patch and verified that it cleanly applies on sage-5.0.beta6.\n\nI started doctests without the patch, and later I will repeat with the patch. But for now it needs review...\n\nApply trac10296_singular_overhead_combined.patch",
    "created_at": "2012-03-03T08:16:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105393",
    "user": "SimonKing"
}
```

I produced a combined patch and verified that it cleanly applies on sage-5.0.beta6.

I started doctests without the patch, and later I will repeat with the patch. But for now it needs review...

Apply trac10296_singular_overhead_combined.patch



---

archive/issue_comments_105394.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-03-03T08:16:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105394",
    "user": "SimonKing"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_105395.json:
```json
{
    "body": "FWIW: The doc tests of sage-5.0.beta6 with the combined patch applied pass.",
    "created_at": "2012-03-03T11:45:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105395",
    "user": "SimonKing"
}
```

FWIW: The doc tests of sage-5.0.beta6 with the combined patch applied pass.



---

archive/issue_comments_105396.json:
```json
{
    "body": "I only have some very minor comments:\n\n* Could you escape EOFError with \"``\" backquotes so it's printed as code\n* You wrote: \"Since nesting of _eval_line can not occur during garbage collection\" can you explain that, I am not sure I understand.\n* why did you indent REMARK etc. further in pid()?",
    "created_at": "2012-03-03T13:41:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105396",
    "user": "malb"
}
```

I only have some very minor comments:

* Could you escape EOFError with "``" backquotes so it's printed as code
* You wrote: "Since nesting of _eval_line can not occur during garbage collection" can you explain that, I am not sure I understand.
* why did you indent REMARK etc. further in pid()?



---

archive/issue_comments_105397.json:
```json
{
    "body": "Replying to [comment:62 malb]:\n> I only have some very minor comments:\n> \n>  * Could you escape EOFError with \"``\" backquotes so it's printed as code\n\nDone\n\n>  * You wrote: \"Since nesting of _eval_line can not occur during garbage collection\" can you explain that, I am not sure I understand.\n\nI elaborated the comment.\n\nWithout my patch, garbage collection would result in a call to _eval_line. So, if garbage collection occurs while being in _eval_line, we would have two nested calls to _eval_line. The inner _eval_line would receive the Singular prompt and return. The outer _eval_line would also wait for a Singular prompt -- but Singular would not provide a second prompt. Result: A deadlock.\n\nTo my understanding, this is why synchronisation of the Singular interface was necessary. But with my patch, garbage collection does not involve an additional call to _eval_line, and thus the deadlock is prevented without synchronisation.\n\n>  * why did you indent REMARK etc. further in pid()?\n\nTo the contrary, the first line of the doc string of pid() needed to be indented more! Fixed with the new patch version.\n\nApply trac10296_singular_overhead_combined.patch",
    "created_at": "2012-03-03T14:32:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105397",
    "user": "SimonKing"
}
```

Replying to [comment:62 malb]:
> I only have some very minor comments:
> 
>  * Could you escape EOFError with "``" backquotes so it's printed as code

Done

>  * You wrote: "Since nesting of _eval_line can not occur during garbage collection" can you explain that, I am not sure I understand.

I elaborated the comment.

Without my patch, garbage collection would result in a call to _eval_line. So, if garbage collection occurs while being in _eval_line, we would have two nested calls to _eval_line. The inner _eval_line would receive the Singular prompt and return. The outer _eval_line would also wait for a Singular prompt -- but Singular would not provide a second prompt. Result: A deadlock.

To my understanding, this is why synchronisation of the Singular interface was necessary. But with my patch, garbage collection does not involve an additional call to _eval_line, and thus the deadlock is prevented without synchronisation.

>  * why did you indent REMARK etc. further in pid()?

To the contrary, the first line of the doc string of pid() needed to be indented more! Fixed with the new patch version.

Apply trac10296_singular_overhead_combined.patch



---

archive/issue_comments_105398.json:
```json
{
    "body": "Modify garbage collection in Singular interface, which reduces the overhead. Synchronization of Gap interface. Cope with non-linux pexpect errors",
    "created_at": "2012-03-03T14:38:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105398",
    "user": "SimonKing"
}
```

Modify garbage collection in Singular interface, which reduces the overhead. Synchronization of Gap interface. Cope with non-linux pexpect errors



---

archive/issue_comments_105399.json:
```json
{
    "body": "Attachment [trac10296_singular_overhead_combined.patch](tarball://root/attachments/some-uuid/ticket10296/trac10296_singular_overhead_combined.patch) by SimonKing created at 2012-03-03 14:40:27\n\nOops, I only had a single backtick around `EOFError` -- hence, it would be typeset as `LaTeX`. So, I have updated my patch, with double backticks around `EOFError`.",
    "created_at": "2012-03-03T14:40:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105399",
    "user": "SimonKing"
}
```

Attachment [trac10296_singular_overhead_combined.patch](tarball://root/attachments/some-uuid/ticket10296/trac10296_singular_overhead_combined.patch) by SimonKing created at 2012-03-03 14:40:27

Oops, I only had a single backtick around `EOFError` -- hence, it would be typeset as `LaTeX`. So, I have updated my patch, with double backticks around `EOFError`.



---

archive/issue_comments_105400.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-03-03T15:22:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105400",
    "user": "malb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_105401.json:
```json
{
    "body": "I am satisfied.\n\nBut out of curiosity, do you have a simple before/after benchmark you could add to this *ticket*?",
    "created_at": "2012-03-03T15:22:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105401",
    "user": "malb"
}
```

I am satisfied.

But out of curiosity, do you have a simple before/after benchmark you could add to this *ticket*?



---

archive/issue_comments_105402.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-03-13T08:21:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105402",
    "user": "jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_105403.json:
```json
{
    "body": "There is a doctest error on OpenSolaris, please have a look at #12687.",
    "created_at": "2012-03-18T11:23:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105403",
    "user": "jdemeyer"
}
```

There is a doctest error on OpenSolaris, please have a look at #12687.



---

archive/issue_comments_105404.json:
```json
{
    "body": "I have also seen the following error:\n\n```\nsage -t  --long -force_lib devel/sage/sage/interfaces/expect.py\n**********************************************************************\nFile \"/home/buildbot/build/sage/cleo-1/cleo_full/build/sage-5.0.beta9/devel/sage-main/sage/interfaces/expect.py\", line 829:\n    sage: singular.interrupt(timeout=1)\nExpected:\n    False\nGot:\n    True\n**********************************************************************\n```\n\n\nWhat does that mean?  It is really a failure or should we just increase the timeout?",
    "created_at": "2012-03-21T13:54:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105404",
    "user": "jdemeyer"
}
```

I have also seen the following error:

```
sage -t  --long -force_lib devel/sage/sage/interfaces/expect.py
**********************************************************************
File "/home/buildbot/build/sage/cleo-1/cleo_full/build/sage-5.0.beta9/devel/sage-main/sage/interfaces/expect.py", line 829:
    sage: singular.interrupt(timeout=1)
Expected:
    False
Got:
    True
**********************************************************************
```


What does that mean?  It is really a failure or should we just increase the timeout?



---

archive/issue_comments_105405.json:
```json
{
    "body": "Replying to [comment:68 jdemeyer]:\n> What does that mean?  It is really a failure or should we just increase the timeout?\n\nThat error has always been mysterious to me.\n\nFrankly, I need a break, in the sense of I need to focus on my main project (cohomology and ext algebras) and on my family. Martin, would you be able to take over?",
    "created_at": "2012-03-21T14:56:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105405",
    "user": "SimonKing"
}
```

Replying to [comment:68 jdemeyer]:
> What does that mean?  It is really a failure or should we just increase the timeout?

That error has always been mysterious to me.

Frankly, I need a break, in the sense of I need to focus on my main project (cohomology and ext algebras) and on my family. Martin, would you be able to take over?



---

archive/issue_comments_105406.json:
```json
{
    "body": "Replying to [comment:69 SimonKing]:\n> Replying to [comment:68 jdemeyer]:\n> > What does that mean?  It is really a failure or should we just increase the timeout?\n> \n> That error has always been mysterious to me.\n> \n> Frankly, I need a break, in the sense of I need to focus on my main project (cohomology and ext algebras) and on my family.\n\nYes, have a \"break\". :-)\n\n\n\n\nSince cleo is not the fastest machine, and I assume the above occurred when doctesting in parallel, I would either ignore it (if it doesn't happen too often), or try with increasing the timeout (to a few seconds) and if that helps, change the doctest permanently.\n\nFor the test I don't think it matters whether we wait 1 or 5 seconds, probably even more; it's only important that Singular finally *does* get interrupted (within perhaps at most half a minute, say).",
    "created_at": "2012-03-21T15:13:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10295",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10295#issuecomment-105406",
    "user": "leif"
}
```

Replying to [comment:69 SimonKing]:
> Replying to [comment:68 jdemeyer]:
> > What does that mean?  It is really a failure or should we just increase the timeout?
> 
> That error has always been mysterious to me.
> 
> Frankly, I need a break, in the sense of I need to focus on my main project (cohomology and ext algebras) and on my family.

Yes, have a "break". :-)




Since cleo is not the fastest machine, and I assume the above occurred when doctesting in parallel, I would either ignore it (if it doesn't happen too often), or try with increasing the timeout (to a few seconds) and if that helps, change the doctest permanently.

For the test I don't think it matters whether we wait 1 or 5 seconds, probably even more; it's only important that Singular finally *does* get interrupted (within perhaps at most half a minute, say).
