# Issue 10295: Singular interface wasting time by calling select.select() too often

Issue created by migration from https://trac.sagemath.org/ticket/10296

Original creator: SimonKing

Original creation time: 2010-11-20 09:20:13

Assignee: was

CC:  was wjp alexanderdreyer malb leif

Keywords: Singular, _eval_line, synchronization, synchronisation

There are two fundamental differences between the Singular and the Gap interfaces:

 1. The Singular interface uses a synchronisation method in each call to its eval method. Gap doesn't.
 2. The Gap interface deletes variables by declaring that their name may be overwritten. This is not possible in Singular, since Singular variables are statically typed. Thus, the Singular interface explicitly kills the underlying variable in Singular, which requires one call to _eval_line for each variable that is to be deleted.

Unfortunately, waiting for the prompt to appear in a pseudo terminal may be very costly on some systems, since select.select() may be very slow - see #10294. So, additional calls to _eval_line should be strictly avoided!

The first point makes me wonder: Why has the synchronisation method become necessary for Singular but not for Gap?

The second point makes me wonder whether it is really necessary to use one _eval_line for each single deletion.

Moreover, I wonder whether the two points are actually related: I could imagine that synchronisation became necessary when garbage collection, accidentally performed inside an _eval_line, and thus sending an _eval_line inside an outer _eval_line, caused a dead lock in the outer _eval_line. Was that the case, historically?

Suggestions:

 1. `singular.eval(cmd)` is currently simply passing `cmd` to _eval_line, after synchronisation and after killing unused variables. I suggest to add the code for killing unused variables to `cmd`, thus using _eval_line only once.
 2. If my above guess on the role of synchronisation is correct, then one could simply drop synchronisation after implementing my first suggestion.

This is related with #10294 and perhaps with #10295. Cc to William and Willem-Jan, since they wrote the synchronisation code.


---

Comment by SimonKing created at 2010-11-20 12:35:28

Committing the kills in `singular.eval` by prepending stuff to the given command turned out to break a lot of doc tests, since they test against the given command showing up in the output. But I think one could be even closer to the Gap interface. 

Recall that in the Gap interface, variables are freed by allowing to re-use their names. So, memory allocated in Gap is only freed when the old variable is actually overwritten.

In Singular, memory is freed by the command `kill`. I suggest to use this command not inside `singular.eval` but inside `SingularElement.__init__`: It is put in front of the command that creates the new variable. Then, the analogy between Gap and Singular interfaces is rather close: Memory in Gap or in Singular is freed only when a new Element is created -- by overwriting the old stuff in the case of Gap, or by killing the old stuff in the case of Singular.

Moreover, I removed the synchronisation code, since it seems to me that synchronisation is not really necessary if the garbage collection is not using an additional _eval_line (which is the case with my suggestion).

So, there remains only _one_ call to select.select when creating a new Singular element, rather than two plus the number of old variables to be killed. 

Indeed, my approach reduces the overhead in using the Singular interface by 2/3 in the test above!

But there occur two doctest failures, that I have to deal with now.


---

Comment by SimonKing created at 2010-11-23 12:34:31

Changing status from new to needs_review.


---

Comment by SimonKing created at 2010-11-23 12:34:31

My patch does the following.

*__Garbage Collection__*

In the Singular interface, freeing the memory used for old variables in Singular  requires to send a "kill" command to Singular, presumably by _eval_line.

A problem would result if garbage collection would create such _eval_line inside an outer _eval_line: The inner _eval_line would cause the outer _eval_line to hang forever. I guess this was the reason why the del method does not actually delete the variables but only marks them for deletion; the actual deletion is postponed to the next use of "eval".

I guess that for the same reason, synchronisation is done at the beginning of "eval".  *Please correct me, if the reason for synchronising so frequently is different!*

I suggest to do the deletions a bit less frequently, namely in the "set" method rather than in the "eval" method. Moreover, I suggest to send the kill command not by a separate _eval_line (one for each old variable), but to prepend the join of all kill commands to the command that creates the new variable.

Since killing does not require an additional _eval_line, nesting can not occur. So, synchronisation is not needed.

*__Overhead Reduction__*

As mentioned in the ticket description, calling _eval_line frequently is bad, since waiting for the Singular prompt in the output of a pseudo terminal produces a massive overhead (up to 22ms per call) on some machines.

My patch removes synchronisation (which avoids one call to _eval_line per call to  eval), and killing old variables does not require any additional _eval_line. So, in the example proposed in the ticket description, the wall time drops by 2/3!

*__Miscellaneous__*

Synchronisation used to fail with an `AttributeError` for the GAP interface. It is fixed by the patch.

I tried to make everything more stable, by giving more opportunities to detect that the interface crashed, and restarting if necessary.

Of course, I added documentation and tests that (I think) cover all issues mentioned here. Moreover, I added tests covering some optional arguments to _eval_line.

For me, `sage -testall` passes. Hence, ready for review!


---

Comment by SimonKing created at 2010-12-29 16:36:42

The old patch needed to be rebased.

The new patch version should apply on top of `sage-4.6.1.alpha3`. I am now running doctests, but I'll keep it "needs review" for now.


---

Comment by SimonKing created at 2010-12-29 17:21:01

Not good. There are several timeouts in the tests. I need to work on it.


---

Comment by SimonKing created at 2010-12-29 17:21:01

Changing status from needs_review to needs_work.


---

Comment by SimonKing created at 2010-12-29 17:55:30

Replying to [comment:5 SimonKing]:
> Not good. There are several timeouts in the tests.

It seems that I forgot `sage -b`. I repeated the tests that previously had a timeout, and now it is fine.

I put it back to "needs review".


---

Comment by SimonKing created at 2010-12-29 17:55:30

Changing status from needs_work to needs_review.


---

Comment by SimonKing created at 2011-01-18 07:18:14

Since the nagbot currently does not seem to send messages: I hope you don't mind that I'm sending a reminder about speeding up the Singular pexpect interface.


---

Comment by SimonKing created at 2011-02-11 07:58:36

I am sorry to nag you again - could someone take a look at the patch? The patchbot has no complaints at that point.


---

Comment by SimonKing created at 2011-03-08 15:15:51

Too late...

Meanwhile the patchbot finds some errors. I try to find the reason.


---

Comment by SimonKing created at 2011-03-08 15:15:51

Changing status from needs_review to needs_work.


---

Comment by SimonKing created at 2011-03-08 16:05:53

Apparently, a `StdOutContext` was recently introduced, and the expected output for one doctest has changed by my patch. I changed the test slightly, so that now it should work.


---

Comment by SimonKing created at 2011-03-08 16:05:53

Changing status from needs_work to needs_review.


---

Comment by SimonKing created at 2011-04-09 07:08:13

I think reducing the overhead in the Singular pexpect interface by 2/3 is a good thing. But the ticket is starting to become old.

Review, anyone?


---

Comment by malb created at 2011-04-09 15:46:23

Changing type from defect to enhancement.


---

Comment by malb created at 2011-04-09 15:46:23

Changing status from needs_review to positive_review.


---

Comment by malb created at 2011-04-09 15:46:23

* the patch applies cleanly against 4.7.alpha3
 * long doctests pass
 * the patch is well documented 
 * the patch does look okay

So all good. The only caveat: I cannot claim I thought long and hard about the possible implications of changing this stuff. But unless someone comes up with a good example why Simon's approach is wrong, I'd say positive review.


---

Comment by jdemeyer created at 2011-04-12 13:46:17

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2011-04-12 13:46:17

This will need to be rebased because it conflicts with #7377.


---

Comment by SimonKing created at 2011-04-12 14:40:33

Replying to [comment:13 jdemeyer]:
> This will need to be rebased because it conflicts with #7377.

Really unfortunate. Apparently, in order to apply #7377 to my sage-4.6.2, I also need to import further patches.


---

Comment by jdemeyer created at 2011-04-12 15:22:17

Replying to [comment:14 SimonKing]:
> Replying to [comment:13 jdemeyer]:
> > This will need to be rebased because it conflicts with #7377.
> 
> Really unfortunate. Apparently, in order to apply #7377 to my sage-4.6.2, I also need to import further patches. 

The easiest solution is probably to download [http://boxen.math.washington.edu/home/release/sage-4.7.alpha5/sage-4.7.alpha5.tar](http://boxen.math.washington.edu/home/release/sage-4.7.alpha5/sage-4.7.alpha5.tar) which includes #7377.  This version of Sage is not released and will certainly change and might have doctest failures but at least it gives you a target to rebase to.


---

Comment by SimonKing created at 2011-04-13 08:38:00

It is really _really_ unfortunate. The changes to the gap interface (so that gap restarts after quitting, instead of throwing an error) are now not working any more.


---

Comment by SimonKing created at 2011-04-13 09:38:05

Changing status from needs_work to needs_review.


---

Comment by SimonKing created at 2011-04-13 09:38:05

I updated my patch. It should now apply to sage-4.7.alpha5. The long tests in `sage/interfaces/` all pass.

Replying to [comment:16 SimonKing]:
> It is really _really_ unfortunate. The changes to the gap interface (so that gap restarts after quitting, instead of throwing an error) are now not working any more.

The reason for that was a typo when I applied one of the hunks manually.

Note that I changed `.interrupt()` into `.interrupt(timeout=1)`  in two doctests. I don't know why, but they failed in about half of the cases. With the timeout parameter, they pass in 10 out of 10 runs.

Does that suffice to return to the positive review?

In any case, I am now running all long doctests.


---

Comment by SimonKing created at 2011-04-13 11:26:55

Replying to [comment:17 SimonKing]:
> Note that I changed `.interrupt()` into `.interrupt(timeout=1)`  in two doctests. I don't know why, but they failed in about half of the cases. With the timeout parameter, they pass in 10 out of 10 runs.
> 
> Does that suffice to return to the positive review?
> 
> In any case, I am now running all long doctests.

FWIW: The long doctests all pass.


---

Comment by malb created at 2011-04-13 11:50:49

Changing status from needs_review to positive_review.


---

Comment by malb created at 2011-04-13 11:50:49

yes, back to positive review.


---

Comment by wjp created at 2011-04-13 12:01:18

Replying to [comment:17 SimonKing]:
> Note that I changed `.interrupt()` into `.interrupt(timeout=1)`  in two doctests. I don't know why, but they failed in about half of the cases. With the timeout parameter, they pass in 10 out of 10 runs.

I haven't looked at the patch in detail, but unexplained behaviour related to synchronization/interrupts in a patch modifying synchronization sounds a bit scary, and a reason to think about it some more...


---

Comment by SimonKing created at 2011-04-13 12:20:15

Replying to [comment:20 wjp]:
> I haven't looked at the patch in detail, but unexplained behaviour related to synchronization/interrupts in a patch modifying synchronization sounds a bit scary, and a reason to think about it some more...

For the record: The test in question is new.

In sage-4.6 (as I just tested on sage.math), the test would in fact not work at all: When you do

```
sage: cutoff = singular._eval_using_file_cutoff 
sage: singular._eval_using_file_cutoff = 4 
sage: singular._eval_line('for(int i=1;i<=3;i++){i=1;};', wait_for_prompt=False) 
```

then you needed to interrupt it manually.

Now, the problem is that after the lines above, `sage: singular.interrupt()` is supposed to return `False`, which it always did on the command line, but in some (not all) doctest runs returns `True`.

Since we wouldn't have been able to test it without my patch, we actually don't know 
  (1) whether the instability existed before and was uncovered by the patch, 
  (2) whether the problem was introduced by my patch, or
  (3) whether the problem was a result of the changes to the pexpect interface in #7377.

The latter could actually be the case: Today was the first time ever that the `singular.interrupt()` example was problematic - and it was the first time that I worked with the patches from #7377.


---

Comment by jdemeyer created at 2011-04-13 19:45:28

Resolution: fixed


---

Comment by jdemeyer created at 2011-04-14 18:30:41

Replying to [comment:21 SimonKing]:
> The latter could actually be the case: Today was the first time ever that the `singular.interrupt()` example was problematic - and it was the first time that I worked with the patches from #7377.

I have decided _not_ to merge #7377 in the sage-4.7 cycle.  I will merge it in sage-4.7.1.alpha0, such that potential issues with #7377 can be sorted out.


---

Comment by SimonKing created at 2011-04-14 18:38:43

Shouldn't this ticket then re-opened as well?

And should I perhaps provide two patch versions here, one depending on #7377 and one independent?


---

Comment by jdemeyer created at 2011-04-14 18:47:56

Replying to [comment:25 SimonKing]:
> Shouldn't this ticket then re-opened as well?
> 
> And should I perhaps provide two patch versions here, one depending on #7377 and one independent?

For the moment, the plan is still to merge #7377 in sage-4.7.1.alpha0 together with #10296 and a fixed #10818.  So for the moment, I think we can leave this ticket as it is.


---

Comment by jpflori created at 2011-04-15 11:13:57

I've ran more than 100 tests of expect.py and gap.py without "timeout=1" (so using the default value of timeout=0.3) on Sage 4.7.alpha3 + #7377 + #10818 + #10296, built from scratch on debian unstable/experimental amd64, intel core 2 quad, and everything passed.

By the way, hg failed to apply the patch, I had to manually apply the following hunk:


```
--- gap.py
+++ gap.py
@@ -475,46 +532,45 @@

```

The only difference is that the tests are obviously longer with a greater value of timeout.

Could anyone else check whether the default value of timeout gives a random behavior, at least as often as every two times?


---

Comment by SimonKing created at 2011-04-15 12:01:09

Replying to [comment:27 jpflori]:
> I've ran more than 100 tests of expect.py and gap.py without "timeout=1" (so using the default value of timeout=0.3) on Sage 4.7.alpha3 + #7377 + #10818 + #10296, built from scratch on debian unstable/experimental amd64, intel core 2 quad, and everything passed.

Quite a relief...

I have Debian GNU/Linux squeeze/sid, and I think our administrator did patch the kernel in order to make pseudo-Tty faster. The reason is that, without that kernel patch, the overhead of all pexpect interfaces is abundant. It is, of course, imaginable that the kernel patch is responsible for the flaky behaviour of the test on my machine.


---

Comment by jpflori created at 2011-04-15 13:53:47

Ok, I've now done 500 tests of both without problems.


---

Comment by jdemeyer created at 2011-05-03 12:27:27

I get many failures on the buildbot, mainly on non-Linux systems (e.g. OS X, Solaris).  The failures look like the following:

```
sage -t -long  -force_lib devel/sage/sage/interfaces/expect.py
**********************************************************************
File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/devel/sage-main/sage/interfaces/expect.py", line 702:
    sage: singular._eval_line_using_file('def a=3;')
Exception raised:
    Traceback (most recent call last):
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_15[5]>", line 1, in <module>
        singular._eval_line_using_file('def a=3;')###line 702:
    sage: singular._eval_line_using_file('def a=3;')
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/local/lib/python/site-packages/sage/interfaces/expect.py", line 731, in _eval_line_using_file
        s = self._eval_line(self._read_in_file_command(tmp_to_use), allow_use_file=False)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/local/lib/python/site-packages/sage/interfaces/expect.py", line 841, in _eval_line
        raise RuntimeError, "%s\nError evaluating %s in %s"%(msg, line, self)
    RuntimeError: [Errno 5] Input/output error
    Error evaluating < "/tmp/dot_sage.gjyZgjfltL/temp/bsd.local/8324//interface//tmp8502"; in Singular
**********************************************************************
[..many more similar errors..]


sage -t -long  -force_lib devel/sage/sage/interfaces/gap.py
**********************************************************************
File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/devel/sage-main/sage/interfaces/gap.py", line 521:
    sage: a = gap(3)
Exception raised:
    Traceback (most recent call last):
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_9[10]>", line 1, in <module>
        a = gap(Integer(3))###line 521:
    sage: a = gap(3)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/local/lib/python/site-packages/sage/interfaces/interface.py", line 201, in __call__
        return self._coerce_from_special_method(x)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/local/lib/python/site-packages/sage/interfaces/interface.py", line 227, in _coerce_from_special_method
        return (x.__getattribute__(s))(self)
      File "sage_object.pyx", line 463, in sage.structure.sage_object.SageObject._gap_ (sage/structure/sage_object.c:3988)
      File "sage_object.pyx", line 439, in sage.structure.sage_object.SageObject._interface_ (sage/structure/sage_object.c:3628)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/local/lib/python/site-packages/sage/interfaces/interface.py", line 199, in __call__
        return cls(self, x, name=name)
      File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-4.7.1.alpha0/local/lib/python/site-packages/sage/interfaces/expect.py", line 1286, in __init__
        raise TypeError, x
    TypeError: Error evaluating $sage9:=3;; in Gap
**********************************************************************
```



---

Comment by jdemeyer created at 2011-05-03 12:27:27

Changing status from closed to new.


---

Comment by jdemeyer created at 2011-05-03 12:27:27

Resolution changed from fixed to 


---

Comment by SimonKing created at 2011-05-03 14:17:00

That's bad. Perhaps its a difference in new line / carriage return characters?

Probably I need to build sage on bsd.math before being able to test.


---

Comment by jdemeyer created at 2011-05-03 16:29:39

Replying to [comment:31 SimonKing]:
> That's bad. Perhaps its a difference in new line / carriage return characters?
`RuntimeError: [Errno 5] Input/output error` seems to indicate something more low-level related to the OS (for example, the handling of pseudo-tty's).

> Probably I need to build sage on bsd.math before being able to test.
You can start working from the non-released sage-4.7.1.alpha0: [http://boxen.math.washington.edu/home/release/sage-4.7.1.alpha0/sage-4.7.1.alpha0.tar](http://boxen.math.washington.edu/home/release/sage-4.7.1.alpha0/sage-4.7.1.alpha0.tar).  This currently includes #7377 but not #10296, but this is of course subject to change.


---

Comment by SimonKing created at 2011-05-03 16:39:02

Replying to [comment:32 jdemeyer]:
> You can start working from the non-released sage-4.7.1.alpha0: [http://boxen.math.washington.edu/home/release/sage-4.7.1.alpha0/sage-4.7.1.alpha0.tar](http://boxen.math.washington.edu/home/release/sage-4.7.1.alpha0/sage-4.7.1.alpha0.tar).  This currently includes #7377 but not #10296, but this is of course subject to change.

Thank you, but the compilation of sage-4.7 on bsd.math is already in the final stages (building documentation, if I am not mistaken).


---

Comment by SimonKing created at 2011-05-03 20:41:50

Replying to [comment:32 jdemeyer]:
> `RuntimeError: [Errno 5] Input/output error` seems to indicate something more low-level related to the OS (for example, the handling of pseudo-tty's).

That could be. I already found: If you quit gap by sending "quit;" through the gap interface (by gap.eval) and then try to evaluate a command, then you get a different error or error message on bsd.math than on my computer.

What my patch did was to search for "EOL" in the error message, which should be fast and suffices on my computer (Linux). If it does not suffice (as on bsd.math) then one could still test gap._expect.isalive(). That's slower, but apparently more robust.

The other error you are reporting seems similar in spirit, but is in a different place.


---

Comment by SimonKing created at 2011-05-04 07:17:26

I just submitted a new patch that solves part of the problem: There are different error types raised on linux and non-linux machines if a pexpect interfaces crashes. But there are some doctest failures left, so, it still needs work.


---

Comment by SimonKing created at 2011-05-04 07:29:40

The problem with the remaining doctest failures is that my patch introduces a new argument `first_call` to `sage.interfaces.expect.Expect._eval_line`: The idea is to restart the interface if it is crashed unexpectedly and then re-eval the line, but only once, to avoid infinite loops. The `first_call` argument tells whether it is the first evaluation, or the re-evaluation after a crash.

But some interfaces override `_eval_line` and don't know about the new argument. It should thus be added.


---

Comment by SimonKing created at 2011-05-04 08:42:15

Fortunately I can do some optional tests (e.g. maple) on bsd.math. It revealed another problem: Some code relies on a specific error message. But in my patch, that error is caught and replaced by a generic error telling that the interface crashed. That should be taken care of as well.


---

Comment by SimonKing created at 2011-05-04 09:10:11

Make the automatic restart of pexpect interfaces work on non-linux machines


---

Comment by SimonKing created at 2011-05-04 09:12:33

Changing status from new to needs_review.


---

Attachment

I think I got it solved: The long doctests in sage/interfaces pass both on my machine and on bsd.math. This is based on sage-4.7.

In addition, the optional tests of sage/interfaces/maple.py pass on bsd.math as well, with the exception of those that fail with pure sage-4.7 anyway (see #11288).

Depends on #7377.


---

Comment by SimonKing created at 2011-05-04 12:03:03

PS: Since the new patch is not totally trivial, I think someone should look at it, i.e., not simply restoring the old positive review.


---

Comment by jdemeyer created at 2011-05-25 13:47:29

*bump*

Any reviewers?


---

Comment by fbissey created at 2011-05-25 18:36:21

Actually from the description of the first patch it could help with some problems in #9958 so I will take a look and test them on linux and OS X.


---

Comment by fbissey created at 2011-05-27 04:41:41

On OS X 10.5.8 with 4.7.1.alpha1 I get the following after applying the patch

```
sage -t -long "devel/sage/sage/interfaces/gap.py"           
**********************************************************************
File "/Users/frb15/Desktop/sage-4.7.1.alpha1/devel/sage/sage/interfaces/gap.py", line 514:
    sage: gap.interrupt(timeout=1)
Expected:
    True
Got:
    False
**********************************************************************
```

This is a test introduced in [attachment:trac10296_singular_overhead.patch]


---

Comment by fbissey created at 2011-05-27 04:41:41

Changing status from needs_review to needs_work.


---

Comment by SimonKing created at 2011-05-27 05:42:43

Replying to [comment:42 fbissey]:
> On OS X 10.5.8 with 4.7.1.alpha1 I get the following after applying the patch
> {{{
> sage -t -long "devel/sage/sage/interfaces/gap.py"           
> **********************************************************************
> File "/Users/frb15/Desktop/sage-4.7.1.alpha1/devel/sage/sage/interfaces/gap.py", line 514:
>     sage: gap.interrupt(timeout=1)
> Expected:
>     True
> Got:
>     False
> **********************************************************************
> }}}

That test is really annoying. I tried to make it more reliable by adding the timeout parameter, but apparently it does not work like that.

However, the main point is that without the patch, we had

```
sage: cutoff = gap._eval_using_file_cutoff 
sage: gap._eval_using_file_cutoff = 4 
sage: gap._eval_line('while(1=1) do i:=1;; od;', wait_for_prompt=False) 
<Runs forever>
```

In other words, we would not even come to the line `gap.interrupt()`.

I would not mind if the new test simply made sure that no error is raised. It does not matter, IMHO, whether we have the return value `True` or `False`. So, perhaps change it into

```
sage: gap.interrupt(timeout=1) is not None
True
```

or

```
sage: gap.interrupt(timeout=1)
...
```


?


---

Comment by fbissey created at 2011-05-30 03:32:01

Replying to [comment:43 SimonKing]:
> Replying to [comment:42 fbissey]:
> > On OS X 10.5.8 with 4.7.1.alpha1 I get the following after applying the patch
> > {{{
> > sage -t -long "devel/sage/sage/interfaces/gap.py"           
> > **********************************************************************
> > File "/Users/frb15/Desktop/sage-4.7.1.alpha1/devel/sage/sage/interfaces/gap.py", line 514:
> >     sage: gap.interrupt(timeout=1)
> > Expected:
> >     True
> > Got:
> >     False
> > **********************************************************************
> > }}}
> 
> That test is really annoying. I tried to make it more reliable by adding the timeout parameter, but apparently it does not work like that.
> 
> However, the main point is that without the patch, we had
> {{{
> sage: cutoff = gap._eval_using_file_cutoff 
> sage: gap._eval_using_file_cutoff = 4 
> sage: gap._eval_line('while(1=1) do i:=1;; od;', wait_for_prompt=False) 
> <Runs forever>
> }}}
> In other words, we would not even come to the line `gap.interrupt()`.
> 
> I would not mind if the new test simply made sure that no error is raised. It does not matter, IMHO, whether we have the return value `True` or `False`. So, perhaps change it into
> {{{
> sage: gap.interrupt(timeout=1) is not None
> True
> }}}
> or
> {{{
> sage: gap.interrupt(timeout=1)
> ...
> }}}
> 
> ?
The later one would imply that the output is random, but we would miss it if an error was raised so I guess the former would be better. 

```
gap.interrupt(timeout=1) is not None
```

has my vote.


---

Comment by leif created at 2011-07-22 06:36:49

The "idling" doctests (on e.g. Ubuntu) are really annoying, especially when doing `testlong` rather than `ptestlong`...

Can someone (finish? and) review this, or what's stopping it?


---

Comment by SimonKing created at 2011-07-22 08:45:46

Replying to [comment:45 leif]:
> The "idling" doctests (on e.g. Ubuntu) are really annoying, especially when doing `testlong` rather than `ptestlong`...
> 
> Can someone (finish? and) review this, or what's stopping it?

I think the problem was that a couple of weeks ago I had other things on my mind, and thus I forgot to do the change into `gap.interrupt(timeout=1) is not None`. I guess I'll do it now.


---

Comment by leif created at 2011-07-22 08:56:25

Replying to [comment:46 SimonKing]:
> Replying to [comment:45 leif]:
> > The "idling" doctests (on e.g. Ubuntu) are really annoying, especially when doing `testlong` rather than `ptestlong`...
> I think the problem was that a couple of weeks ago I had other things on my mind, and thus I forgot to do the change into `gap.interrupt(timeout=1) is not None`. I guess I'll do it now.

That would be nice. Some tests (e.g. `sandpile`) here take more than 20 minutes each when running `make testlong`, which is totally odd.


---

Comment by SimonKing created at 2011-07-22 10:13:09

Also, the first patch doesn't apply to sage-4.7.rc2. So, I'll take care of that as well.

Concerning idleness: It seems that there is a certain kernel patch for Ubuntu that improves the pexpect performance. Namely, the problem with some OS like Ubuntu is that the latency of pseudo-tty is to much (if I understood correctly). After our sysadmin applied that patch, the problem vanished.

So, the main problem with pexpect on some platforms is not a Sage problem. That said, reducing the traffic in the pexpect interface is a good idea anyway...


---

Comment by SimonKing created at 2011-07-22 10:22:55

Changing status from needs_work to needs_review.


---

Comment by SimonKing created at 2011-07-22 10:22:55

I have updated the first patch, which should now apply against sage-4.7.1.rc2. I have changed the doctest in question, so that now it is only tested that interrupting gap has worked.

For the patchbot:

Apply trac10296_singular_overhead.patch trac10296_expect_on_nonlinux.patch


---

Attachment

Modify garbage collection in Singular interface, which reduces the overhead. Synchronization of Gap interface.


---

Comment by SimonKing created at 2011-08-01 15:59:33

I had to rebase the first patch against sage-4.7.1.rc1. I had a typo in my previous post: The old patch was relative sage-4.7.rc2, not 4.7.1.rc2.

Apply trac10296_singular_overhead.patch trac10296_expect_on_nonlinux.patch 

By the way: It still needs review...


---

Comment by SimonKing created at 2011-08-30 10:22:11

Any reviewer for a patch that improves the performance of the Singular pexpect interface?


---

Comment by malb created at 2011-08-30 12:41:21

patchbot claims tests failed but the full log shows all tests passed. Not sure what happened there. I'm running ptestlong on sage.math now.


---

Comment by malb created at 2011-08-30 13:52:51

I re-read the patches and I still think they are good, so I'm close to a positive review. One - perhaps nitpicking - point though: shouldn't `first_call` be `restart_if_needed` or something? "First call" isn't very telling what it does?


---

Comment by SimonKing created at 2011-08-30 14:12:37

Replying to [comment:53 malb]:
> I re-read the patches and I still think they are good, so I'm close to a positive review. One - perhaps nitpicking - point though: shouldn't `first_call` be `restart_if_needed` or something? "First call" isn't very telling what it does?

That sounds like a good idea.


---

Attachment

I've added a patch which makes this change.  Let's get this in.


---

Comment by SimonKing created at 2012-03-02 09:52:20

Martin, can you look whether my patches together with Mike's improvement of the wording is fine?

Apply trac10296_singular_overhead.patch trac10296_expect_on_nonlinux.patch trac_10296-restart_if_needed.patch


---

Comment by malb created at 2012-03-02 17:31:40

Hi,

 * [attachment:trac_10296-restart_if_needed.patch] has no commit message
 * I get lots of errors when applying [attachment:trac10296_expect_on_nonlinux.patch] to 5.0-beta6?


---

Comment by SimonKing created at 2012-03-02 18:10:11

Bad. Needs work, then...

Concerning the missing commit message: I think I'll produce a combined patch with a commit message.


---

Comment by SimonKing created at 2012-03-02 18:10:11

Changing status from needs_review to needs_work.


---

Comment by SimonKing created at 2012-03-03 07:52:09

The first patch only applies with fuzz 2, because of #11431 (-> new dependency). The conflict is in the author list, easy to fix.


---

Comment by SimonKing created at 2012-03-03 08:16:33

I produced a combined patch and verified that it cleanly applies on sage-5.0.beta6.

I started doctests without the patch, and later I will repeat with the patch. But for now it needs review...

Apply trac10296_singular_overhead_combined.patch


---

Comment by SimonKing created at 2012-03-03 08:16:33

Changing status from needs_work to needs_review.


---

Comment by SimonKing created at 2012-03-03 11:45:20

FWIW: The doc tests of sage-5.0.beta6 with the combined patch applied pass.


---

Comment by malb created at 2012-03-03 13:41:39

I only have some very minor comments:

 * Could you escape EOFError with "``" backquotes so it's printed as code
 * You wrote: "Since nesting of _eval_line can not occur during garbage collection" can you explain that, I am not sure I understand.
 * why did you indent REMARK etc. further in pid()?


---

Comment by SimonKing created at 2012-03-03 14:32:58

Replying to [comment:62 malb]:
> I only have some very minor comments:
> 
>  * Could you escape EOFError with "``" backquotes so it's printed as code

Done

>  * You wrote: "Since nesting of _eval_line can not occur during garbage collection" can you explain that, I am not sure I understand.

I elaborated the comment.

Without my patch, garbage collection would result in a call to _eval_line. So, if garbage collection occurs while being in _eval_line, we would have two nested calls to _eval_line. The inner _eval_line would receive the Singular prompt and return. The outer _eval_line would also wait for a Singular prompt -- but Singular would not provide a second prompt. Result: A deadlock.

To my understanding, this is why synchronisation of the Singular interface was necessary. But with my patch, garbage collection does not involve an additional call to _eval_line, and thus the deadlock is prevented without synchronisation.

>  * why did you indent REMARK etc. further in pid()?

To the contrary, the first line of the doc string of pid() needed to be indented more! Fixed with the new patch version.

Apply trac10296_singular_overhead_combined.patch


---

Comment by SimonKing created at 2012-03-03 14:38:45

Modify garbage collection in Singular interface, which reduces the overhead. Synchronization of Gap interface. Cope with non-linux pexpect errors


---

Attachment

Oops, I only had a single backtick around `EOFError` -- hence, it would be typeset as `LaTeX`. So, I have updated my patch, with double backticks around `EOFError`.


---

Comment by malb created at 2012-03-03 15:22:16

Changing status from needs_review to positive_review.


---

Comment by malb created at 2012-03-03 15:22:16

I am satisfied.

But out of curiosity, do you have a simple before/after benchmark you could add to this *ticket*?


---

Comment by jdemeyer created at 2012-03-13 08:21:51

Resolution: fixed


---

Comment by jdemeyer created at 2012-03-18 11:23:02

There is a doctest error on OpenSolaris, please have a look at #12687.


---

Comment by jdemeyer created at 2012-03-21 13:54:01

I have also seen the following error:

```
sage -t  --long -force_lib devel/sage/sage/interfaces/expect.py
**********************************************************************
File "/home/buildbot/build/sage/cleo-1/cleo_full/build/sage-5.0.beta9/devel/sage-main/sage/interfaces/expect.py", line 829:
    sage: singular.interrupt(timeout=1)
Expected:
    False
Got:
    True
**********************************************************************
```


What does that mean?  It is really a failure or should we just increase the timeout?


---

Comment by SimonKing created at 2012-03-21 14:56:51

Replying to [comment:68 jdemeyer]:
> What does that mean?  It is really a failure or should we just increase the timeout?

That error has always been mysterious to me.

Frankly, I need a break, in the sense of I need to focus on my main project (cohomology and ext algebras) and on my family. Martin, would you be able to take over?


---

Comment by leif created at 2012-03-21 15:13:42

Replying to [comment:69 SimonKing]:
> Replying to [comment:68 jdemeyer]:
> > What does that mean?  It is really a failure or should we just increase the timeout?
> 
> That error has always been mysterious to me.
> 
> Frankly, I need a break, in the sense of I need to focus on my main project (cohomology and ext algebras) and on my family.

Yes, have a "break". :-)




Since cleo is not the fastest machine, and I assume the above occurred when doctesting in parallel, I would either ignore it (if it doesn't happen too often), or try with increasing the timeout (to a few seconds) and if that helps, change the doctest permanently.

For the test I don't think it matters whether we wait 1 or 5 seconds, probably even more; it's only important that Singular finally _does_ get interrupted (within perhaps at most half a minute, say).
