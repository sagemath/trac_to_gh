# Issue 27845: giacpy_sage-0.6.7 compiles with CC instead of CXX

Issue created by migration from https://trac.sagemath.org/ticket/28082

Original creator: @mwageringel

Original creation time: 2019-06-29 08:24:02

CC:  fbissey frederichan

In Sage 8.8, giacpy_sage fails to build – apparently, because it is using CC instead of CXX with c++11 standard options.

The logs are attached (OS X 10.13.6). This was originally reported on [sage-devel](https://groups.google.com/d/msg/sage-devel/OCweUCoikXc/Nuazv8TRAgAJ).


---

Attachment


---

Comment by fbissey created at 2019-06-29 08:37:15

Note that it happens also on linux

```
[giacpy_sage-0.6.7]     creating build/temp.linux-x86_64-2.7
[giacpy_sage-0.6.7]     gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -fPIC -I/home/fbissey/sandbox/git-fork/sage/local/lib/python2.7/site-packages/sage/cpython -I/home/fbissey/sandbox/git-fork/sage/local/lib/python2.7/site-packages/sage/libs/ntl -I/home/fbissey/sandbox/git-fork/sage/local/lib/python2.7/site-packages/cysignals -I/home/fbissey/sandbox/git-fork/sage/local/include -I/home/fbissey/sandbox/git-fork/sage/local/lib/python2.7/site-packages -I/home/fbissey/sandbox/git-fork/sage/local/lib/python2.7/site-packages/sage/ext -I/home/fbissey/sandbox/git-fork/sage/local/include/python2.7 -I/home/fbissey/sandbox/git-fork/sage/local/lib/python2.7/site-packages/numpy/core/include -I/home/fbissey/sandbox/git-fork/sage/local/include/python2.7 -c giacpy_sage.cpp -o build/temp.linux-x86_64-2.7/giacpy_sage.o
```

This is probably an issue where python doesn't identify the code as C++ properly. Note that the sage-on-gentoo package properly use g++ for the same code.

```
creating /dev/shm/portage/dev-python/giacpy_sage-0.6.7-r2/work/giacpy_sage-0.6.7-python2_7/temp.linux-x86_64-2.7
x86_64-pc-linux-gnu-g++ -march=native -O2 -pipe -fPIC -I/dev/shm/portage/dev-python/giacpy_sage-0.6.7-r2/work/giacpy_sage-0.6.7 -I/usr/lib64/python2.7/site-packages/sage/cpython -I/usr/lib64/python2.7/site-packages/sage/libs/ntl -I/usr/lib64/python2.7/site-packages/cysignals -I/usr/include -I/usr/lib64/python2.7/site-packages -I/usr/lib64/python2.7/site-packages/sage/ext -I/usr/include/python2.7 -I/usr/lib64/python2.7/site-packages/numpy/core/include -I/usr/include/python2.7 -c giacpy_sage.cpp -o /dev/shm/portage/dev-python/giacpy_sage-0.6.7-r2/work/giacpy_sage-0.6.7-python2_7/temp.linux-x86_64-2.7/giacpy_sage.o
```

there may be another bug on track about C++ support in distutils.


---

Comment by embray created at 2019-07-01 12:19:59

Replying to [comment:1 fbissey]:
> Note that it happens also on linux

On what Linux?  If this happened on any Linux I don't see how this would have passed the buildbots.


---

Comment by @mwageringel created at 2019-07-01 17:21:36

Replying to [comment:2 embray]:
> On what Linux?  If this happened on any Linux I don't see how this would have passed the buildbots.

For me, this happens on CentOS Linux release 7.6.1810 (Core). Do the bots also build optional packages?


---

Comment by @mwageringel created at 2019-07-01 17:26:11

Replying to [comment:1 fbissey]:
> there may be another bug on track about C++ support in distutils.

Indeed, there is #7028. See also https://bugs.python.org/issue1222585. Apparently, Gentoo includes that patch.

There are discussions about this starting at ticket:12426#comment:114 and ticket:23341#comment:8.


---

Comment by fbissey created at 2019-07-01 20:50:51

Replying to [comment:4 gh-mwageringel]:
> Replying to [comment:1 fbissey]:
> > there may be another bug on track about C++ support in distutils.
> 
> Indeed, there is #7028. See also https://bugs.python.org/issue1222585. Apparently, Gentoo includes that patch.
> 

And that's why the sage-on-gentoo package works properly but vanilla sage on the same OS doesn't.

> There are discussions about this starting at ticket:12426#comment:114 and ticket:23341#comment:8.

If I am being honest we had this discussion for a while and I thought we had included the distutils patch in sage because it threaten to break the sage library in a few places. May be we have a work around that I forgot about.


---

Comment by jdemeyer created at 2019-07-02 21:11:15

The problem is not that `gcc` is used instead of `g++`. The problem is that `-std=c++11` is missing from the compiler flags. That looks like an upstream bug.


---

Comment by fbissey created at 2019-07-02 21:14:43

But if `giacpy_sage` was using CXX instead of CC it would automatically get that flag. That being said, yes that flag should be added upstream. But I am not sure what happens when you use `gcc -std=c++11`, I think you'll get a message that this is a g++ option not a gcc one.


---

Comment by jdemeyer created at 2019-07-02 21:17:43

Replying to [comment:8 fbissey]:
> But I am not sure what happens when you use `gcc -std=c++11`, I think you'll get a message that this is a g++ option not a gcc one.

The language is decided by the source file, not whether the compiler is invoked as `gcc` or `g++`. So `gcc -std=c++11` should work just fine.


---

Comment by fbissey created at 2019-07-02 21:21:27

Replying to [comment:9 jdemeyer]:
> Replying to [comment:8 fbissey]:
> > But I am not sure what happens when you use `gcc -std=c++11`, I think you'll get a message that this is a g++ option not a gcc one.
> 
> The language is decided by the source file, not whether the compiler is invoked as `gcc` or `g++`. So `gcc -std=c++11` should work just fine.

I am skeptical but I am willing to see if that works.


---

Comment by frederichan created at 2019-07-03 08:23:20

I try to understand what happens. Don't you have similar problems with pplpy?

In giacpy_sage there is a
`language="c++"`
in setup.py but should I also add 
`# distutils: language = c++`
in giacpy_sage.pyx?

About the c++ standard used, we mainly want to use the same as the giac library so why isn't the default behaviour the same? or is there some environment variable missed by giacpy_sage?


---

Comment by fbissey created at 2019-07-03 08:29:22

I just had a look and `pplpy` exhibit the same behavior. g++ is only used when linking. gcc is used for compilation. `pplpy` doesn't seem to be hit by trouble coming from the c++11 standard and is successfully compiled.


---

Comment by embray created at 2019-07-03 12:02:05

Replying to [comment:10 fbissey]:
> Replying to [comment:9 jdemeyer]:
> > Replying to [comment:8 fbissey]:
> > > But I am not sure what happens when you use `gcc -std=c++11`, I think you'll get a message that this is a g++ option not a gcc one.
> > 
> > The language is decided by the source file, not whether the compiler is invoked as `gcc` or `g++`. So `gcc -std=c++11` should work just fine.
> 
> I am skeptical but I am willing to see if that works.

`gcc` and `g++` are just front-ends to multiple different programs, including different compilers (for c and c++ among others), linkers, and others.  There are differences between whether you invoke `gcc` or `g++` though.  Namely, in the case of `g++`, it _always_ assumes you are working on a C++ project (whether you're compiling `.c` sources or `.cpp` sources), so even for apparently "plain C" files it will link in the C++ stdlib since it's assumed to be part of a C++ project.


---

Comment by frederichan created at 2019-07-03 14:09:19

So it looks that files in `src/sage/libs` such as `ppl.pyx` are cythonized with:


```
extra_compile_args": [
            "-fno-strict-aliasing", 
            "-DCYTHON_CLINE_IN_TRACEBACK=1", 
            "-std=c++11"
        ]
```


but files in external packages such as `giacpy_sage.pyx` or `ppl/linear_algebra.pyx` from ppl2py are not cythonized with this option. So what should  an external package do in setup.py to follow the sagelib behaviour for extra_compile_args  on various platform?


---

Comment by fbissey created at 2019-07-19 00:57:22

Replying to [comment:14 frederichan]:
> So it looks that files in `src/sage/libs` such as `ppl.pyx` are cythonized with:
> 
> {{{
> extra_compile_args": [
>             "-fno-strict-aliasing", 
>             "-DCYTHON_CLINE_IN_TRACEBACK=1", 
>             "-std=c++11"
>         ]
> }}}
> 
> but files in external packages such as `giacpy_sage.pyx` or `ppl/linear_algebra.pyx` from ppl2py are not cythonized with this option. So what should  an external package do in setup.py to follow the sagelib behaviour for extra_compile_args  on various platform?

Let's try to go back to this. `extra_compile_args` is a standard distutils option and is already used in `giacpy_sage`'s setup.py

```
                   extra_compile_args=conf["CXXFLAGS"],
```

You would be excused to think that this is enough to make sure the compilation follow C++11 standard. However the way the autoconf macro we are using works is to ensure that we have C++11 compliant compiler. I repeat: compiler. Which means that `-std=c++11` is added to `CXX` not `CXXFLAGS`.

Now if what Jeroen says gcc's front end being able to recognise c++ code, adding a line `EXPORT CXXFLAGS="${CXXFLAGS} -std=c++11"` before `sdh_pip_install` in `spkg-install` for `giacpy_sage` should be enough to fix the issue.


---

Comment by @mwageringel created at 2019-07-19 22:27:10

Actually, `conf["CXXFLAGS"]` is defined within `setup.py` of giacpy_sage, so it does not seem like environment variables have an effect on this. In fact, I suppose it would be preferable to set this within `setup.py`, since then giacpy_sage can be installed like any package, i.e. independently from `spkg-install`. This works for me:


```diff
--- a/setup.py
+++ b/setup.py
@@ -9,7 +9,7 @@ from distutils.extension import Extension
 from Cython.Build import cythonize


-conf = {'CXXFLAGS' : [], 'LDFLAGS' : []}
+conf = {'CXXFLAGS' : ['-std=c++11'], 'LDFLAGS' : []}

 libraries=['giac']
 library_dirs=[SAGE_LOCAL+'/lib']
```



---

Comment by dimpase created at 2019-08-02 09:59:35

looks like an upstream bug, one should not ignore CXXFLAGS.


---

Comment by fbissey created at 2019-08-02 10:02:57

I am not completely sure about this. Does `conf` override anything mentioned in it or is it just default if they are not defined?


---

Comment by fbissey created at 2019-08-02 10:07:46

Looks to me as if it is getting my FLAGS from the compilation lines I am seeing.


---

Comment by frederichan created at 2019-08-02 15:48:31

So I have add the -std=c++11 in the extra_compil_args in setup.py.
cf: https://gitlab.math.univ-paris-diderot.fr/han/giacpy-sage/blob/master/setup.py
(and fixed a doctest)

On fedora 29 it gives with sage 8.9beta4:


```
gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -fPIC -I/home/fred-dev/sage/develop/sage/local/lib/python2.7/site-packages/sage/cpython -I/home/fred-dev/sage/develop/sage/local/lib/python2.7/site-packages/sage/libs/ntl -I/home/fred-dev/sage/develop/sage/local/lib/python2.7/site-packages/cysignals -I/home/fred-dev/sage/develop/sage/local/include -I/home/fred-dev/sage/develop/sage/local/lib/python2.7/site-packages -I/home/fred-dev/sage/develop/sage/local/lib/python2.7/site-packages/sage/ext -I/home/fred-dev/sage/develop/sage/local/include/python2.7 -I/home/fred-dev/sage/develop/sage/local/lib/python2.7/site-packages/numpy/core/include -I/home/fred-dev/sage/develop/sage/local/include/python2.7 -c giacpy_sage.cpp -o build/temp.linux-x86_64-2.7/giacpy_sage.o -std=c++11
    In file included from /home/fred-dev/sage/develop/sage/local/include/giac/poly.h:25,
                     from /home/fred-dev/sage/develop/sage/local/include/giac/giac.h:5,
                     from giacpy_sage.cpp:665:
    /home/fred-dev/sage/develop/sage/local/include/giac/index.h:32: warning: ignoring #pragma anon_unions  [-Wunknown-pragmas]
     #pragma anon_unions

    creating build/lib.linux-x86_64-2.7
    g++ -pthread -shared -L/home/fred-dev/sage/develop/sage/local/lib -Wl,-rpath,/home/fred-dev/sage/develop/sage/local/lib -L/home/fred-dev/sage/develop/sage/local/lib -Wl,-rpath,/home/fred-dev/sage/develop/sage/local/lib build/temp.linux-x86_64-2.7/giacpy_sage.o -L/home/fred-dev/sage/develop/sage/local/lib -L/home/fred-dev/sage/develop/sage/local/lib -lgmp -lgiac -lpython2.7 -o build/lib.linux-x86_64-2.7/giacpy_sage.so -lpari
    running install_lib
```

so the -std=c++11 is given to gcc. The built/runtime are OK but they were also OK without -std=c++11 on this system.

Basically we just want to follow the behaviour of what is done to extra_compil_args in  _sage/src/setup.py_ It seems to also use -std=c++11 but I also saw some gnu++11.


---

Comment by git created at 2019-08-02 15:52:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by frederichan created at 2019-08-02 15:52:45

New commits:


---

Comment by frederichan created at 2019-08-02 15:56:14

Changing status from new to needs_review.


---

Comment by dimpase created at 2019-08-02 16:00:51

a proper fix should not hardcode the value of -std= parameter. Rather it should infer it from what it is for giac, or you might create an ABI mismatch.


---

Comment by frederichan created at 2019-08-03 13:01:07

Yes but not only giac. The first error appearing in the original attachment was around NTL includes because giacpy_sage uses

```
from sage.rings.integer cimport Integer
```

So giacpy_sage must also follow what does the sage/src/setup.py do for other cython modules. And for c++ ones sage/src/setup.py adds the -std=c++11  to extra_compil_args.

I have tried to add giacpy_sage to sage/src/module_list.py  without any flags and let sage/src/setup.py built giacpy_sage, and the -std=c++11 was indeed added.

I have put on a public branch because I don't know a better solution.


---

Comment by @mwageringel created at 2019-10-07 03:28:15

Changing status from needs_review to positive_review.


---

Comment by @mwageringel created at 2019-10-07 03:28:15

Dima and I have had another look at this. The underlying problem seems to be that Sage sets `CXX` to something like `g++ -std=gnu++11`, but distutils invokes a C compiler which is just `gcc`, so the `-std=gnu++11` flag is not passed in the compile command.

Solving this by setting `extra_compile_args` to `-std=c++11` is correct in the sense that this is also what is done elsewhere in Sage to overcome this problem, for example in `sage/libs/polybori/decl.pxd` and `sage/libs/pynac/pynac.pxd`. With the new giacpy_sage version, everything seems to work, so I am setting this to positive.


---

Comment by vbraun created at 2019-10-07 22:06:45


```
Connecting to webusers.imj-prg.fr (webusers.imj-prg.fr)|134.157.100.46|:80... failed: Connection timed out.
```



---

Comment by dimpase created at 2019-10-07 22:23:03

Replying to [comment:28 vbraun]:
> {{{
> Connecting to webusers.imj-prg.fr (webusers.imj-prg.fr)|134.157.100.46|:80... failed: Connection timed out.
> }}}
works for me (from USA):

```
$ wget http://webusers.imj-prg.fr/~frederic.han/xcas/giacpy/sage/giacpy_sage-0.6.8.tar.gz
--2019-10-07 23:20:43--  http://webusers.imj-prg.fr/~frederic.han/xcas/giacpy/sage/giacpy_sage-0.6.8.tar.gz
Resolving webusers.imj-prg.fr... 134.157.100.46
Connecting to webusers.imj-prg.fr|134.157.100.46|:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 45807 (45K) [application/x-gzip]
Saving to: ‘giacpy_sage-0.6.8.tar.gz’

giacpy_sage-0.6.8.tar.gz          100%[==========================================================>]  44.73K   201KB/s    in 0.2s    

2019-10-07 23:20:44 (201 KB/s) - ‘giacpy_sage-0.6.8.tar.gz’ saved [45807/45807]

```



---

Attachment


---

Comment by vbraun created at 2019-10-10 21:42:36

Resolution: fixed
