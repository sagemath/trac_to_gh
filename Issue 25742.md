# Issue 25742: py3: pynac bug with logb on int

Issue created by migration from https://trac.sagemath.org/ticket/25979

Original creator: embray

Original creation time: 2018-07-31 10:29:10

CC:  rws

On Python 2:


```
sage: from sage.functions.log import logb
sage: logb(7, 2)
log(7)/log2
sage: logb(int(7), 2)
log(7)/log(2)
```


On Python 3:


```
sage: from sage.functions.log import logb
sage: logb(7, 2)
log(7)/log(2)
sage: logb(int(7), 2)
1
```


This was causing quite a few confusing bugs before I realized the subtle difference of `Integer` vs `int` that was causing the bug.  I'm not sure if it affect other functions too.


---

Comment by embray created at 2018-07-31 10:54:27

It only seems to be if the first argument is an `int`; the type of the base doesn't seem to matter.


---

Comment by embray created at 2018-07-31 11:18:50

Not 100% sure if related, but an interesting difference on Python 2 and 3:

py2:


```
sage: SR.coerce(Integer(7))._dbgprint()
7 (numeric) @0x603ced1f0, hash=0x7, flags=0x7, type MPZ
sage: SR.coerce(int(7))._dbgprint()
7 (numeric) @0x6016ab100, hash=0x7, flags=0x7, type LONG
```


py3:


```
sage: SR.coerce(Integer(7))._dbgprint()
7 (numeric) @0x4ce0820, hash=0x7, flags=0x7, type LONG
sage: SR.coerce(int(7))._dbgprint()
7 (numeric) @0x4ce0820, hash=0x7, flags=0x7, type MPZ
```


I don't think these are the exact same pynac versions either, so it's not clear to me yet where that difference is coming from.


---

Comment by embray created at 2018-07-31 11:46:55

Something like this seems to fix it, and makes more sense in terms of integer representation:


```diff
diff --git a/src/sage/symbolic/ring.pyx b/src/sage/symbolic/ring.pyx
index 6ebb377..c9c44ee 100644
--- a/src/sage/symbolic/ring.pyx
+++ b/src/sage/symbolic/ring.pyx
@@ -14,6 +14,7 @@ The symbolic ring
 #*****************************************************************************
 from __future__ import absolute_import

+from sage.arith.long cimport integer_check_long_py
 from sage.ext.cplusplus cimport ccrepr

 from sage.libs.pynac.pynac cimport *
@@ -331,6 +332,9 @@ cdef class SymbolicRing(CommutativeRing):
             TypeError: positive characteristic not allowed in symbolic computations
         """
         cdef GEx exp
+        cdef int err = 0
+        cdef long x_long
+
         if is_Expression(x):
             if (<Expression>x)._parent is self:
                 return x
@@ -342,8 +346,8 @@ cdef class SymbolicRing(CommutativeRing):
             try:
                 from sage.calculus.calculus import symbolic_expression_from_string
                 return self(symbolic_expression_from_string(x))
-            except SyntaxError as err:
-                msg, s, pos = err.args
+            except SyntaxError as exc:
+                msg, s, pos = exc.args
                 raise TypeError("%s: %s !!! %s" %
                         (msg, bytes_to_str(s[:pos]), bytes_to_str(s[pos:])))

@@ -361,10 +365,11 @@ cdef class SymbolicRing(CommutativeRing):
                 from sage.symbolic.constants import NaN
                 return NaN
             exp = x
-        elif isinstance(x, long):
-            exp = x
-        elif isinstance(x, int):
-            exp = GEx(<long>x)
+        elif integer_check_long_py(x, &x_long, &err):
+            if not err:
+                exp = GEx(x_long)
+            else:
+                exp = x
         elif x is infinity:
             return new_Expression_from_GEx(self, g_Infinity)
         elif x is minus_infinity:
```



---

Comment by embray created at 2018-07-31 11:56:58

Despite the above fix, there is still an apparent problem:


```
sage: logb(2**30, 2)
30
sage: logb(2**31, 2)
1
sage: logb(2**32, 2)
1
sage: logb(2**33, 2)
1
```


...and so on.


---

Comment by embray created at 2018-07-31 12:28:45

I'm still getting:


```
sage: SR.coerce(Integer(2**30))._dbgprint()
1073741824 (numeric) @0x3b29c60, hash=0x40000000, flags=0x7, type LONG
sage: SR.coerce(Integer(2**31))._dbgprint()
2147483648 (numeric) @0x3b29c60, hash=0x80000000, flags=0x7, type MPZ
```


This is originating from `ginac/numeric.cpp`, specifically:


```
void set_from(Type& t, Value& v, long& hash, mpz_t bigint)
{
        if (mpz_fits_sint_p(bigint)) {
                t = LONG;
                v._long = mpz_get_si(bigint);
                hash = (v._long==-1) ? -2 : v._long;
        }
        else {
                t = MPZ;
                mpz_init_set(v._bigint, bigint);
                hash = _mpz_pythonhash(v._bigint);
        }
}
```


One, perhaps na√Øve, question I have is why `mpz_fits_sint_p` and not `mpz_fits_slong_p`?


---

Comment by embray created at 2018-07-31 12:42:15

So there's still a discrepancy between creating a pynac numeric from an `Integer` versus an `int` depending on what the value is.  With my patch above, it will create a `LONG` type numeric up to `int(2**63 - 1)`, or up to `Integer(2**31 - 1)`.

But regardless, the `logb` function is broken for MPZ numerics.


---

Comment by embray created at 2018-07-31 12:55:21

I found it; small two character bug in pynac (and maybe upstream in ginac?):


```diff
diff --git a/ginac/numeric.cpp b/ginac/numeric.cpp
index 78643df..1b8a6cb 100644
--- a/ginac/numeric.cpp
+++ b/ginac/numeric.cpp
@@ -3758,7 +3758,7 @@ const numeric numeric::ratlog(const numeric &b, bool& israt) const {
                 return c;
         }
         if (b.t == LONG)
-                return ratlog(to_bigint(), israt);
+                return ratlog(b.to_bigint(), israt);
         if (t == LONG)
                 return to_bigint().ratlog(b, israt);
         if (t == MPZ and b.t == MPZ) {

```



---

Comment by chapoton created at 2018-12-18 19:29:49

`@`rws, please make a pynac release


---

Comment by embray created at 2018-12-28 14:10:15

Retargeting some of my tickets (somewhat optimistically for now).


---

Comment by chapoton created at 2019-01-02 14:47:50

see pynac update ticket in #26995


---

Comment by chapoton created at 2019-01-25 08:41:55

one still needs to add a doctest ?


---

Comment by chapoton created at 2019-02-22 18:19:12

Changing status from new to needs_review.


---

Comment by chapoton created at 2019-02-22 18:19:12

doctest added
----
New commits:


---

Comment by tscrim created at 2019-02-22 23:29:20

LGTM.


---

Comment by tscrim created at 2019-02-22 23:29:20

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-02-23 23:14:46

Resolution: fixed
