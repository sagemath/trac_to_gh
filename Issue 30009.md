# Issue 30009: Support interacts in JupyterLab

Issue created by migration from https://trac.sagemath.org/ticket/30246

Original creator: slelievre

Original creation time: 2020-07-29 11:56:57

CC:  slelievre

Keywords: jupyterlab

Before this ticket: interacts don't work in JupyterLab.

Reported at:

- [Ask Sage question 50194: Interact in Jupyterlab vs Jupyter](https://ask.sagemath.org/question/50194)
- comment to an answer at [Ask Sage question 52707](https://ask.sagemath.org/question/52707)

Related:

- #29728: Meta-ticket: improve compatibility with the Python library



---

Comment by mkoeppe created at 2020-08-18 18:02:25

Could this just be a documentation issue? Is it documented somewhere what extensions need to be installed in jupyterlab so that sage works?


---

Comment by @jcamp0x2a created at 2020-08-21 18:01:27

Replying to [comment:1 mkoeppe]:
> Could this just be a documentation issue? Is it documented somewhere what extensions need to be installed in jupyterlab so that sage works?

I was able to get interacts working in jupyterlab 2.2.5 using the following command:
[ipywidgets install instructions](https://github.com/jupyter-widgets/ipywidgets#install)


```
./sage --jupyter labextension install @jupyter-widgets/jupyterlab-manager@2.0
```


This requires nodejs >= 10 to be installed though. Looks like jupyterlab's extension ecosystem is all based on npm. Grabbing the extension tarball directly, still need node for bundling. (webpack, if I remember; been awhile since I've done anything with node.)

So unless we want to make nodejs an optional->standard package as well, maybe just leave it to the user to install and make a note in the documentation regarding interact functionality? Similar to how imagemagick and ffmpeg are noted in [animated plots](https://doc.sagemath.org/html/en/reference/plotting/sage/plot/animate.html).


---

Comment by mkoeppe created at 2020-08-21 18:15:40

Is installation via https://pypi.org/project/nodeenv/ an option?


---

Comment by @jcamp0x2a created at 2020-08-21 21:48:04

Replying to [comment:4 mkoeppe]:
> Is installation via https://pypi.org/project/nodeenv/ an option?

Cool stuff. I was indeed able to get interacts working without a system nodejs using `./sage --pip install nodeenv` and creating a nodeenv to do the jupyter-widgets extension installation. Since node isn't needed for running jupyterlab, that nodeenv could probably get wiped out automatically following installation.

Not having node though does prevent you from browsing/installing other extensions in the extensions sidebar of jupyterlab. I played around with modifying the main sage script to activate the nodeenv when using `./sage -n jupyterlab` and was able to install, for example, the [jupyterlab-toc](https://github.com/jupyterlab/jupyterlab-toc) extension and use it without issue.

I'll continue experimenting with this for a bit longer, do some tidying up, and push a branch for review.


---

Comment by @jcamp0x2a created at 2020-08-22 21:41:51

Changing status from new to needs_review.


---

Comment by @jcamp0x2a created at 2020-08-22 21:41:51

I've pushed a branch for review. It adds 4 new optional packages: nodeenv, nodejs, jupyterlab, and jupyterlab_widgets. The last one, jupyterlab_widgets, gets you everything.

I opted to break them up in this way for (1) convenience in packaging them and (2) flexibility in installing them. For example, if you just want the JupyterLab client and don't care about interacts or other extensions or if you don't want JupyterLab but would like nodejs present in your Sage environment for some other purpose. Please let me know if you'd prefer a different structuring.

Shell scripting isn't my forte, so I welcome any feedback regarding coding conventions and best practices!


---

Comment by @jcamp0x2a created at 2020-08-22 21:43:54

I suppose this also includes what should've been worked under #26059 first and separately (just the jupyterlab package). I apologize for that; got carried away :)


---

Comment by slelievre created at 2020-08-22 22:04:38

Replying to [comment:7 gh-jcamp0x2a]:
> includes what should've been worked under #26059
> first and separately

We can mark the other ticket as solved by this one.

I would use https in the home page url for JupyterLab.


---

Comment by git created at 2020-08-22 23:17:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-08-23 23:44:12

This looks great overall.

I'm getting the following with this branch (without installing any packages):

```
./sage -h
/Users/mkoeppe/s/sage/sage-rebasing/src/bin/sage-env: line 69: cd: /Users/mkoeppe/s/sage/sage-rebasing/local/share/nodejs/: No such file or directory
SageMath version 9.2.beta10, Release Date: 2020-08-23
...
  --notebook=[...]    -- start the Sage notebook (valid options are
                         'default', 'jupyter', and 'export')
                         Current default is 'export' from sagenb to jupyter
  -n, --notebook      -- shortcut for --notebook=default
...
$ ./sage -n jupyterlab
/Users/mkoeppe/s/sage/sage-rebasing/src/bin/sage-env: line 69: cd: /Users/mkoeppe/s/sage/sage-rebasing/local/share/nodejs/: No such file or directory
Jupyterlab is not installed (at least not in this Sage installation).
You can install it by running
  sage --pip install jupyterlab
```



---

Comment by mkoeppe created at 2020-08-23 23:44:40

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-08-24 02:02:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-24 02:13:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @jcamp0x2a created at 2020-08-24 02:22:34

Changing status from needs_work to needs_review.


---

Comment by @jcamp0x2a created at 2020-08-24 02:22:34

Thank you for catching that! 

I've pushed a couple more changes, the first making sure to check that `nodeenv_activate` symlink exists before trying to resolve it, and the second mentioning to the user to install using `sage -i jupyterlab` instead of `sage --pip install jupyterlab`.

Oh, do you happen to know of a good way to uninstall Sage packages? I tested these last couple changes by manually removing/moving files around in SAGE_LOCAL. I'd like to get back to a state without, for example, jupyterlab for testing, but I'd also like to avoid having to do a full clean and rebuild. I suppose I could be doing this in a VM and just snapshot and rollback.


---

Comment by tmonteil created at 2020-08-25 12:26:29

Changing status from needs_review to needs_work.


---

Comment by tmonteil created at 2020-08-25 12:26:29

This ticket breaks the patchbots (at least the ones i run). It seems due to some modification in `src/bin/sage-env` that tries to cd into a nonexistent `local/share/nodejs` directory. When the patchbots run:


```
./sage --python --version
```


They get:


```
/home/sagemath/sage-9.1/src/bin/sage-env: line 69: cd: /home/sagemath/sage-9.1/local/share/nodejs/: No such file or directory
Python 3.7.3
```


The error should be catched (e.g. stderr could be redirected to `/dev/null`).


---

Comment by tmonteil created at 2020-08-25 12:39:17

Changing status from needs_work to needs_review.


---

Comment by tmonteil created at 2020-08-25 12:39:17

Apparently, you fixed the issue already, sorry for the noise, let us see if the patchbots are happy now.


---

Comment by @jcamp0x2a created at 2020-08-25 15:54:05

Replying to [comment:16 tmonteil]:
> Apparently, you fixed the issue already, sorry for the noise, let us see if the patchbots are happy now.

No worries. Thank you for running those patchbots.


---

Comment by mkoeppe created at 2020-08-27 01:00:49

Changing priority from major to critical.


---

Comment by mkoeppe created at 2020-08-27 01:06:37

Replying to [comment:14 gh-jcamp0x2a]:
>  mentioning to the user to install using `sage -i jupyterlab` instead of `sage --pip install jupyterlab`.

Would it perhaps be better to direct the user to do `sage -i jupyterlab_widgets` so that a full-featured jupyterlab is installed?


---

Comment by mkoeppe created at 2020-08-27 01:10:08

Also, could you update the help messages in `src/bin/sage` so that jupyterlab is mentioned as an option. (Also I would guess that the default that is mentioned there is not correct.)


---

Comment by mkoeppe created at 2020-08-27 01:22:42

on macOS:

```
[nodejs-12.18.3] usage: grep [-abcDEFGHhIiJLlmnOoqRSsUVvwxZ] [-A num] [-B num] [-C[num]]
[nodejs-12.18.3] 	[-e pattern] [-f file] [--binary-files=value] [--color=when]
[nodejs-12.18.3] 	[--context[=num]] [--directories=action] [--label] [--line-buffered]
[nodejs-12.18.3] 	[--null] [pattern] [file ...]
[nodejs-12.18.3] Error determining which nodejs version to install ... exiting
```



---

Comment by mkoeppe created at 2020-08-27 01:24:29

`grep -P` is not portable


---

Comment by mkoeppe created at 2020-08-27 01:24:40

Changing status from needs_review to needs_work.


---

Comment by @jcamp0x2a created at 2020-08-27 05:29:30

Replying to [comment:19 mkoeppe]:
> Would it perhaps be better to direct the user to do `sage -i jupyterlab_widgets` so that a full-featured jupyterlab is installed?
I will update the message to suggest jupyterlab_widgets by default, with a short aside about a minimal installation using just jupyterlab.

Replying to [comment:20 mkoeppe]:
> Also, could you update the help messages in `src/bin/sage` so that jupyterlab is mentioned as an option. (Also I would guess that the default that is mentioned there is not correct.)
I will add mention of jupyterlab to the help messages. I'm not sure I understand you about the default. The help messages I see list jupyter as the default, and indeed running `sage -n` or `sage -n default` starts jupyter.

Replying to [comment:22 mkoeppe]:
> `grep -P` is not portable
I should know better. I remember this bit me on Solaris a few years ago, too. I will fix this.


---

Comment by git created at 2020-08-27 16:55:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @jcamp0x2a created at 2020-08-27 17:03:09

Upon re-reading the basic help message, I saw what you mentioned about the default needing to be updated. I've pushed changes that I believe address your feedback items.

I also came across `sage --notebook --help` which had already mentioned jupyterlab and so didn't need updating, but I found that it also mentions an ipython option:


```
--notebook [NOTEBOOK], -n [NOTEBOOK], -notebook [NOTEBOOK]
                      The notebook to run [one of: default, ipython,
                      jupyter, jupyterlab, export]. Default is jupyter
```


Looking at the code in `src/bin/sage-notebook`, this option is currently just an alias for jupyter. Would it be valuable to mention this option in the basic and/or advanced help messages for sage as well?


---

Comment by @jcamp0x2a created at 2020-08-27 17:03:09

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-08-28 04:53:38

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-08-28 04:53:38

This works for me on macOS and is looking great overall.

I have added dependencies to make sure that a parallel build works correctly.
----
New commits:


---

Comment by @jcamp0x2a created at 2020-08-28 16:17:49

Replying to [comment:28 mkoeppe]:
> This works for me on macOS and is looking great overall.
> 
> I have added dependencies to make sure that a parallel build works correctly.

Awesome! Thank you for all your time and assistance on this ticket.


---

Comment by vbraun created at 2020-09-01 23:00:19

Resolution: fixed


---

Comment by charpent created at 2020-09-04 11:22:37

Minor booboo : after (successful) installlation, `jupyterlab_widgets` is still marked as not installed:


```
charpent@zen-book-flip:/usr/local/sage-exp$ ./sage -optional | grep jupyter
gap_jupyter.............................0.9 (0.9)
jupyterlab..............................2.2.6 (2.2.6)
jupyterlab_widgets......................none (2.0)
pari_jupyter............................1.3.2 (1.3.2)
r_jupyter...............................none (not_installed)
singular_jupyter........................0.9.7 (0.9.7)
```


Untidy, and potentially confusing...


---

Comment by @jcamp0x2a created at 2020-09-04 16:00:49

I believe the version in parentheses is the installed version while the other is the available version. I'm not sure why the available version isn't displayed since there is a package-version.txt present for jupyterlab_widgets, but I'm thinking this may be a problem for "script" packages in general. For example:


```
$ ./sage --installed | grep none
jupyterlab_widgets......................none (2.0)
nodejs..................................none (12.18.3)
sage_conf...............................none (none)
sagelib.................................none (9.2.beta10)
zope_interface..........................none (none)
```



---

Comment by dimpase created at 2020-10-24 22:05:28

Has anyone figured out how to use MathJax in JupyterLab markdown cells?
