# Issue 25976: py3: fix doctests in finance/

Issue created by migration from https://trac.sagemath.org/ticket/26213

Original creator: chapoton

Original creation time: 2018-09-07 14:11:04

CC:  embray jdemeyer




---

Comment by chapoton created at 2018-09-07 14:11:24

New commits:


---

Comment by chapoton created at 2018-09-07 14:11:24

Changing status from new to needs_review.


---

Comment by vklein created at 2018-09-07 14:57:26

The two tests use the doctest tag `# py2`. Therefore it fails with python2.


---

Comment by git created at 2018-09-07 15:00:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-09-07 15:00:09

thanks, fixed


---

Comment by vklein created at 2018-09-07 15:11:06

With python3, i get :


```
sage -t src/sage/finance/stock.py
**********************************************************************
File "src/sage/finance/stock.py", line 573, in sage.finance.stock.Stock.load_from_file
Failed example:
    finance.Stock("AAPL").load_from_file("I am not a file") # py3
Expected:
    Traceback (most recent call last):
    ...
    FileNotFoundError: [Errno 2] No such file or directory: 'I am not a file'
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/home/vklein/odk/sage/local/lib/python3.6/site-packages/sage/doctest/forker.py", line 650, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/vklein/odk/sage/local/lib/python3.6/site-packages/sage/doctest/forker.py", line 1061, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.finance.stock.Stock.load_from_file[4]>", line 1, in <module>
        finance.Stock("AAPL").load_from_file("I am not a file") # py3
      File "/home/vklein/odk/sage/local/lib/python3.6/site-packages/sage/finance/stock.py", line 578, in load_from_file
        file_obj = open(file, 'r')
    FileNotFoundError: [Errno 2] No such file or directory: 'I am not a file'

```


And if i add a `<BLANKLINE>` in the doctest expected result :



```
sage -t src/sage/finance/stock.py
**********************************************************************
File "src/sage/finance/stock.py", line 573, in sage.finance.stock.Stock.load_from_file
Failed example:
    finance.Stock("AAPL").load_from_file("I am not a file") # py3
Exception raised:
    Traceback (most recent call last):
      File "/home/vklein/odk/sage/local/lib/python3.6/site-packages/sage/doctest/forker.py", line 650, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/vklein/odk/sage/local/lib/python3.6/site-packages/sage/doctest/forker.py", line 1061, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.finance.stock.Stock.load_from_file[4]>", line 1, in <module>
        finance.Stock("AAPL").load_from_file("I am not a file") # py3
      File "/home/vklein/odk/sage/local/lib/python3.6/site-packages/sage/finance/stock.py", line 579, in load_from_file
        file_obj = open(file, 'r')
    FileNotFoundError: [Errno 2] No such file or directory: 'I am not a file'

```


It behave as if the Error is not catched by the doctest framework.


---

Comment by chapoton created at 2018-09-07 15:19:35

Then let us ask for help.. Erik or Jeroen, any idea ?


---

Comment by vklein created at 2018-09-07 15:24:07

To simplify i have tested the following doctest :


```
sage: raise NameError("test")
Traceback (most recent call last):
...
NameError: test
sage: raise FileNotFoundError("test")
Traceback (most recent call last):
...
FileNotFoundError: test
```


The first test pass and the second fails.


---

Comment by git created at 2018-09-10 18:49:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-09-10 18:51:38

ok. So the reason is that there is in sage doctesting framework a mechanism that modifies some subexceptions of OSError in python3, and replace them with OSError.

Should be good to go now. Unless Erik (`@`embray) has a better idea ?


---

Comment by vklein created at 2018-09-11 07:28:57

Indeed, it's the #25676 ticket.


---

Comment by vklein created at 2018-09-11 07:35:52

It's ok for me. I let Eric pass it in positive review.


---

Comment by embray created at 2018-09-11 13:57:53

Because of #25676 this shouldn't require separate `#py2` and `#py3` cases at all, unless I missed a case in #25676.


---

Comment by chapoton created at 2018-09-11 13:59:10

Well, I tried and it did not work. Because you are busy on other stuff, I thought it was good enough for the moment.


---

Comment by embray created at 2018-09-11 14:09:58

This is pretty low priority though (I would argue even trivial) so I don't see any reason to rush to a fix.  I can have a look at it.


---

Comment by embray created at 2018-09-11 14:13:53

Weird. I don't even have that test locally.  Was it just added in 8.4.beta4?


---

Comment by chapoton created at 2018-09-11 14:26:23

last modified seven years ago..


---

Comment by embray created at 2018-09-11 14:33:25

Oh I see now.  In my branch I just removed that test completely because it was pointless.  All it's testing is that the `open(...)` built-in raises an exception if the given file does not exist (duh).  There's nothing in that code that even does anything special in that case, so the test is not useful at all.


---

Comment by embray created at 2018-09-11 14:37:03

I have some other minor cleanup in that file as well, such as replacing `open()` with `with open()`.  I think I missed the spurious semicolon you had.  This is my diff to the file:


```diff
diff --git a/src/sage/finance/stock.py b/src/sage/finance/stock.py
index 1c9ba47..dfab025 100644
--- a/src/sage/finance/stock.py
+++ b/src/sage/finance/stock.py
@@ -124,7 +124,7 @@ class OHLC:
             True
         """
         return not (self == other)
-
+

 class Stock:
     """
@@ -562,18 +562,11 @@ class Stock:
             1212407640 187.75 188.00 187.75 188.00       2000,
             1212405780 187.80 187.80 187.80 187.80        100
             ]
-
-        This tests a file that doesn't exist::
-
-            sage: finance.Stock("AAPL").load_from_file("I am not a file")
-            Traceback (most recent call last):
-            ...
-            IOError: [Errno 2] No such file or directory: 'I am not a file'
         """
-        file_obj = open(file, 'r')
-        R = file_obj.read();
+        with open(file, 'r') as fobj:
+            R = fobj.read()
+
         self.__historical = self._load_from_csv(R)
-        file_obj.close()
         return self.__historical
```


Still weird that it's failing for you though.  I might temporarily restore the test just to investigate a little.  But I still think it should just be deleted entirely.


---

Comment by embray created at 2018-09-11 14:39:15

For that matter the `'r'` argument to `open()` is superfluous as well.


---

Comment by embray created at 2018-09-11 14:47:13

Ah, I see the problem.  There are two classes of exception name mappings surrounding `OSError`: One is classes in Python 2 that have just been replaced with `OSError` (of which `IOError` happens to be one).  The other is new-to-Python 3 specialized subclasses of `OSError` for specific errnos, such as `FileNotFoundError`.

On Python 3 the doctester code treats either one case, or the other.  But in this case it should treat both by mapping `IOError -> OSError -> FileNotFoundError`.  I'll make a ticket.


---

Comment by chapoton created at 2018-09-11 14:47:56

ok. Let us remove the useless doctest here.


---

Comment by git created at 2018-09-11 14:50:31

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2018-09-11 14:52:01

done, ready for review again


---

Comment by embray created at 2018-09-11 14:59:39

Changing status from needs_review to positive_review.


---

Comment by embray created at 2018-09-11 15:00:13

Changing priority from major to trivial.


---

Comment by embray created at 2018-09-11 15:00:13

In case it helps Volker.


---

Comment by vbraun created at 2018-09-12 19:58:27

Resolution: fixed
