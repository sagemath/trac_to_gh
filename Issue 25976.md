# Issue 25976: py3: fix doctests in finance/

archive/issues_025976.json:
```json
{
    "body": "CC:  @embray @jdemeyer\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/26213\n\n",
    "created_at": "2018-09-07T14:11:04Z",
    "labels": [
        "component: python3"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.4",
    "title": "py3: fix doctests in finance/",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25976",
    "user": "https://github.com/fchapoton"
}
```
CC:  @embray @jdemeyer



Issue created by migration from https://trac.sagemath.org/ticket/26213





---

archive/issue_comments_365935.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-09-07T14:11:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25976",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25976#issuecomment-365935",
    "user": "https://github.com/fchapoton"
}
```

New commits:



---

archive/issue_comments_365936.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-09-07T14:11:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25976",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25976#issuecomment-365936",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_365937.json:
```json
{
    "body": "The two tests use the doctest tag `# py2`. Therefore it fails with python2.",
    "created_at": "2018-09-07T14:57:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25976",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25976#issuecomment-365937",
    "user": "https://github.com/vinklein"
}
```

The two tests use the doctest tag `# py2`. Therefore it fails with python2.



---

archive/issue_comments_365938.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-09-07T15:00:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25976",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25976#issuecomment-365938",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_365939.json:
```json
{
    "body": "thanks, fixed",
    "created_at": "2018-09-07T15:00:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25976",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25976#issuecomment-365939",
    "user": "https://github.com/fchapoton"
}
```

thanks, fixed



---

archive/issue_comments_365940.json:
```json
{
    "body": "With python3, i get :\n\n\n```\nsage -t src/sage/finance/stock.py\n**********************************************************************\nFile \"src/sage/finance/stock.py\", line 573, in sage.finance.stock.Stock.load_from_file\nFailed example:\n    finance.Stock(\"AAPL\").load_from_file(\"I am not a file\") # py3\nExpected:\n    Traceback (most recent call last):\n    ...\n    FileNotFoundError: [Errno 2] No such file or directory: 'I am not a file'\nGot:\n    <BLANKLINE>\n    Traceback (most recent call last):\n      File \"/home/vklein/odk/sage/local/lib/python3.6/site-packages/sage/doctest/forker.py\", line 650, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/vklein/odk/sage/local/lib/python3.6/site-packages/sage/doctest/forker.py\", line 1061, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.finance.stock.Stock.load_from_file[4]>\", line 1, in <module>\n        finance.Stock(\"AAPL\").load_from_file(\"I am not a file\") # py3\n      File \"/home/vklein/odk/sage/local/lib/python3.6/site-packages/sage/finance/stock.py\", line 578, in load_from_file\n        file_obj = open(file, 'r')\n    FileNotFoundError: [Errno 2] No such file or directory: 'I am not a file'\n\n```\n\n\nAnd if i add a `<BLANKLINE>` in the doctest expected result :\n\n\n\n```\nsage -t src/sage/finance/stock.py\n**********************************************************************\nFile \"src/sage/finance/stock.py\", line 573, in sage.finance.stock.Stock.load_from_file\nFailed example:\n    finance.Stock(\"AAPL\").load_from_file(\"I am not a file\") # py3\nException raised:\n    Traceback (most recent call last):\n      File \"/home/vklein/odk/sage/local/lib/python3.6/site-packages/sage/doctest/forker.py\", line 650, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/vklein/odk/sage/local/lib/python3.6/site-packages/sage/doctest/forker.py\", line 1061, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.finance.stock.Stock.load_from_file[4]>\", line 1, in <module>\n        finance.Stock(\"AAPL\").load_from_file(\"I am not a file\") # py3\n      File \"/home/vklein/odk/sage/local/lib/python3.6/site-packages/sage/finance/stock.py\", line 579, in load_from_file\n        file_obj = open(file, 'r')\n    FileNotFoundError: [Errno 2] No such file or directory: 'I am not a file'\n\n```\n\n\nIt behave as if the Error is not catched by the doctest framework.",
    "created_at": "2018-09-07T15:11:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25976",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25976#issuecomment-365940",
    "user": "https://github.com/vinklein"
}
```

With python3, i get :


```
sage -t src/sage/finance/stock.py
**********************************************************************
File "src/sage/finance/stock.py", line 573, in sage.finance.stock.Stock.load_from_file
Failed example:
    finance.Stock("AAPL").load_from_file("I am not a file") # py3
Expected:
    Traceback (most recent call last):
    ...
    FileNotFoundError: [Errno 2] No such file or directory: 'I am not a file'
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/home/vklein/odk/sage/local/lib/python3.6/site-packages/sage/doctest/forker.py", line 650, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/vklein/odk/sage/local/lib/python3.6/site-packages/sage/doctest/forker.py", line 1061, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.finance.stock.Stock.load_from_file[4]>", line 1, in <module>
        finance.Stock("AAPL").load_from_file("I am not a file") # py3
      File "/home/vklein/odk/sage/local/lib/python3.6/site-packages/sage/finance/stock.py", line 578, in load_from_file
        file_obj = open(file, 'r')
    FileNotFoundError: [Errno 2] No such file or directory: 'I am not a file'

```


And if i add a `<BLANKLINE>` in the doctest expected result :



```
sage -t src/sage/finance/stock.py
**********************************************************************
File "src/sage/finance/stock.py", line 573, in sage.finance.stock.Stock.load_from_file
Failed example:
    finance.Stock("AAPL").load_from_file("I am not a file") # py3
Exception raised:
    Traceback (most recent call last):
      File "/home/vklein/odk/sage/local/lib/python3.6/site-packages/sage/doctest/forker.py", line 650, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/vklein/odk/sage/local/lib/python3.6/site-packages/sage/doctest/forker.py", line 1061, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.finance.stock.Stock.load_from_file[4]>", line 1, in <module>
        finance.Stock("AAPL").load_from_file("I am not a file") # py3
      File "/home/vklein/odk/sage/local/lib/python3.6/site-packages/sage/finance/stock.py", line 579, in load_from_file
        file_obj = open(file, 'r')
    FileNotFoundError: [Errno 2] No such file or directory: 'I am not a file'

```


It behave as if the Error is not catched by the doctest framework.



---

archive/issue_comments_365941.json:
```json
{
    "body": "Then let us ask for help.. Erik or Jeroen, any idea ?",
    "created_at": "2018-09-07T15:19:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25976",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25976#issuecomment-365941",
    "user": "https://github.com/fchapoton"
}
```

Then let us ask for help.. Erik or Jeroen, any idea ?



---

archive/issue_comments_365942.json:
```json
{
    "body": "To simplify i have tested the following doctest :\n\n\n```\nsage: raise NameError(\"test\")\nTraceback (most recent call last):\n...\nNameError: test\nsage: raise FileNotFoundError(\"test\")\nTraceback (most recent call last):\n...\nFileNotFoundError: test\n```\n\n\nThe first test pass and the second fails.",
    "created_at": "2018-09-07T15:24:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25976",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25976#issuecomment-365942",
    "user": "https://github.com/vinklein"
}
```

To simplify i have tested the following doctest :


```
sage: raise NameError("test")
Traceback (most recent call last):
...
NameError: test
sage: raise FileNotFoundError("test")
Traceback (most recent call last):
...
FileNotFoundError: test
```


The first test pass and the second fails.



---

archive/issue_comments_365943.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-09-10T18:49:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25976",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25976#issuecomment-365943",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_365944.json:
```json
{
    "body": "ok. So the reason is that there is in sage doctesting framework a mechanism that modifies some subexceptions of OSError in python3, and replace them with OSError.\n\nShould be good to go now. Unless Erik (`@`embray) has a better idea ?",
    "created_at": "2018-09-10T18:51:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25976",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25976#issuecomment-365944",
    "user": "https://github.com/fchapoton"
}
```

ok. So the reason is that there is in sage doctesting framework a mechanism that modifies some subexceptions of OSError in python3, and replace them with OSError.

Should be good to go now. Unless Erik (`@`embray) has a better idea ?



---

archive/issue_comments_365945.json:
```json
{
    "body": "Indeed, it's the #25676 ticket.",
    "created_at": "2018-09-11T07:28:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25976",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25976#issuecomment-365945",
    "user": "https://github.com/vinklein"
}
```

Indeed, it's the #25676 ticket.



---

archive/issue_comments_365946.json:
```json
{
    "body": "It's ok for me. I let Eric pass it in positive review.",
    "created_at": "2018-09-11T07:35:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25976",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25976#issuecomment-365946",
    "user": "https://github.com/vinklein"
}
```

It's ok for me. I let Eric pass it in positive review.



---

archive/issue_comments_365947.json:
```json
{
    "body": "Because of #25676 this shouldn't require separate `#py2` and `#py3` cases at all, unless I missed a case in #25676.",
    "created_at": "2018-09-11T13:57:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25976",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25976#issuecomment-365947",
    "user": "https://github.com/embray"
}
```

Because of #25676 this shouldn't require separate `#py2` and `#py3` cases at all, unless I missed a case in #25676.



---

archive/issue_comments_365948.json:
```json
{
    "body": "Well, I tried and it did not work. Because you are busy on other stuff, I thought it was good enough for the moment.",
    "created_at": "2018-09-11T13:59:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25976",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25976#issuecomment-365948",
    "user": "https://github.com/fchapoton"
}
```

Well, I tried and it did not work. Because you are busy on other stuff, I thought it was good enough for the moment.



---

archive/issue_comments_365949.json:
```json
{
    "body": "This is pretty low priority though (I would argue even trivial) so I don't see any reason to rush to a fix.  I can have a look at it.",
    "created_at": "2018-09-11T14:09:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25976",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25976#issuecomment-365949",
    "user": "https://github.com/embray"
}
```

This is pretty low priority though (I would argue even trivial) so I don't see any reason to rush to a fix.  I can have a look at it.



---

archive/issue_comments_365950.json:
```json
{
    "body": "Weird. I don't even have that test locally.  Was it just added in 8.4.beta4?",
    "created_at": "2018-09-11T14:13:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25976",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25976#issuecomment-365950",
    "user": "https://github.com/embray"
}
```

Weird. I don't even have that test locally.  Was it just added in 8.4.beta4?



---

archive/issue_comments_365951.json:
```json
{
    "body": "last modified seven years ago..",
    "created_at": "2018-09-11T14:26:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25976",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25976#issuecomment-365951",
    "user": "https://github.com/fchapoton"
}
```

last modified seven years ago..



---

archive/issue_comments_365952.json:
```json
{
    "body": "Oh I see now.  In my branch I just removed that test completely because it was pointless.  All it's testing is that the `open(...)` built-in raises an exception if the given file does not exist (duh).  There's nothing in that code that even does anything special in that case, so the test is not useful at all.",
    "created_at": "2018-09-11T14:33:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25976",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25976#issuecomment-365952",
    "user": "https://github.com/embray"
}
```

Oh I see now.  In my branch I just removed that test completely because it was pointless.  All it's testing is that the `open(...)` built-in raises an exception if the given file does not exist (duh).  There's nothing in that code that even does anything special in that case, so the test is not useful at all.



---

archive/issue_comments_365953.json:
```json
{
    "body": "I have some other minor cleanup in that file as well, such as replacing `open()` with `with open()`.  I think I missed the spurious semicolon you had.  This is my diff to the file:\n\n\n```diff\ndiff --git a/src/sage/finance/stock.py b/src/sage/finance/stock.py\nindex 1c9ba47..dfab025 100644\n--- a/src/sage/finance/stock.py\n+++ b/src/sage/finance/stock.py\n@@ -124,7 +124,7 @@ class OHLC:\n             True\n         \"\"\"\n         return not (self == other)\n-\n+\n\n class Stock:\n     \"\"\"\n@@ -562,18 +562,11 @@ class Stock:\n             1212407640 187.75 188.00 187.75 188.00       2000,\n             1212405780 187.80 187.80 187.80 187.80        100\n             ]\n-\n-        This tests a file that doesn't exist::\n-\n-            sage: finance.Stock(\"AAPL\").load_from_file(\"I am not a file\")\n-            Traceback (most recent call last):\n-            ...\n-            IOError: [Errno 2] No such file or directory: 'I am not a file'\n         \"\"\"\n-        file_obj = open(file, 'r')\n-        R = file_obj.read();\n+        with open(file, 'r') as fobj:\n+            R = fobj.read()\n+\n         self.__historical = self._load_from_csv(R)\n-        file_obj.close()\n         return self.__historical\n```\n\n\nStill weird that it's failing for you though.  I might temporarily restore the test just to investigate a little.  But I still think it should just be deleted entirely.",
    "created_at": "2018-09-11T14:37:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25976",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25976#issuecomment-365953",
    "user": "https://github.com/embray"
}
```

I have some other minor cleanup in that file as well, such as replacing `open()` with `with open()`.  I think I missed the spurious semicolon you had.  This is my diff to the file:


```diff
diff --git a/src/sage/finance/stock.py b/src/sage/finance/stock.py
index 1c9ba47..dfab025 100644
--- a/src/sage/finance/stock.py
+++ b/src/sage/finance/stock.py
@@ -124,7 +124,7 @@ class OHLC:
             True
         """
         return not (self == other)
-
+

 class Stock:
     """
@@ -562,18 +562,11 @@ class Stock:
             1212407640 187.75 188.00 187.75 188.00       2000,
             1212405780 187.80 187.80 187.80 187.80        100
             ]
-
-        This tests a file that doesn't exist::
-
-            sage: finance.Stock("AAPL").load_from_file("I am not a file")
-            Traceback (most recent call last):
-            ...
-            IOError: [Errno 2] No such file or directory: 'I am not a file'
         """
-        file_obj = open(file, 'r')
-        R = file_obj.read();
+        with open(file, 'r') as fobj:
+            R = fobj.read()
+
         self.__historical = self._load_from_csv(R)
-        file_obj.close()
         return self.__historical
```


Still weird that it's failing for you though.  I might temporarily restore the test just to investigate a little.  But I still think it should just be deleted entirely.



---

archive/issue_comments_365954.json:
```json
{
    "body": "For that matter the `'r'` argument to `open()` is superfluous as well.",
    "created_at": "2018-09-11T14:39:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25976",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25976#issuecomment-365954",
    "user": "https://github.com/embray"
}
```

For that matter the `'r'` argument to `open()` is superfluous as well.



---

archive/issue_comments_365955.json:
```json
{
    "body": "Ah, I see the problem.  There are two classes of exception name mappings surrounding `OSError`: One is classes in Python 2 that have just been replaced with `OSError` (of which `IOError` happens to be one).  The other is new-to-Python 3 specialized subclasses of `OSError` for specific errnos, such as `FileNotFoundError`.\n\nOn Python 3 the doctester code treats either one case, or the other.  But in this case it should treat both by mapping `IOError -> OSError -> FileNotFoundError`.  I'll make a ticket.",
    "created_at": "2018-09-11T14:47:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25976",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25976#issuecomment-365955",
    "user": "https://github.com/embray"
}
```

Ah, I see the problem.  There are two classes of exception name mappings surrounding `OSError`: One is classes in Python 2 that have just been replaced with `OSError` (of which `IOError` happens to be one).  The other is new-to-Python 3 specialized subclasses of `OSError` for specific errnos, such as `FileNotFoundError`.

On Python 3 the doctester code treats either one case, or the other.  But in this case it should treat both by mapping `IOError -> OSError -> FileNotFoundError`.  I'll make a ticket.



---

archive/issue_comments_365956.json:
```json
{
    "body": "ok. Let us remove the useless doctest here.",
    "created_at": "2018-09-11T14:47:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25976",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25976#issuecomment-365956",
    "user": "https://github.com/fchapoton"
}
```

ok. Let us remove the useless doctest here.



---

archive/issue_comments_365957.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-09-11T14:50:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25976",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25976#issuecomment-365957",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_365958.json:
```json
{
    "body": "done, ready for review again",
    "created_at": "2018-09-11T14:52:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25976",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25976#issuecomment-365958",
    "user": "https://github.com/fchapoton"
}
```

done, ready for review again



---

archive/issue_comments_365959.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-09-11T14:59:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25976",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25976#issuecomment-365959",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_365960.json:
```json
{
    "body": "Changing priority from major to trivial.",
    "created_at": "2018-09-11T15:00:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25976",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25976#issuecomment-365960",
    "user": "https://github.com/embray"
}
```

Changing priority from major to trivial.



---

archive/issue_comments_365961.json:
```json
{
    "body": "In case it helps Volker.",
    "created_at": "2018-09-11T15:00:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25976",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25976#issuecomment-365961",
    "user": "https://github.com/embray"
}
```

In case it helps Volker.



---

archive/issue_comments_365962.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-09-12T19:58:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25976",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25976#issuecomment-365962",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
