# Issue 33966: Find and uninstall broken installed SPKGs and wheels

archive/issues_033966.json:
```json
{
    "body": "CC:  dimpase jhpalmieri nbruin charpent\n\nWe can inspect the installation records in `$SAGE_LOCAL/var/lib/sage/installed/` by running `ldd` on any shared libraries and uninstall them if they refer to nonexisting libraries.\n\nIssue created by migration from https://trac.sagemath.org/ticket/34203\n\n",
    "created_at": "2022-07-20T22:20:39Z",
    "labels": [
        "build",
        "major",
        "enhancement"
    ],
    "title": "Find and uninstall broken installed SPKGs and wheels",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33966",
    "user": "mkoeppe"
}
```
CC:  dimpase jhpalmieri nbruin charpent

We can inspect the installation records in `$SAGE_LOCAL/var/lib/sage/installed/` by running `ldd` on any shared libraries and uninstall them if they refer to nonexisting libraries.

Issue created by migration from https://trac.sagemath.org/ticket/34203





---

archive/issue_comments_482247.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-07-21T00:00:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482247",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_482248.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-07-21T00:21:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482248",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_482249.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-07-21T00:46:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482249",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_482250.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-07-21T01:36:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482250",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_482251.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-07-21T02:00:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482251",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_482252.json:
```json
{
    "body": "Ready for testing on macOS.",
    "created_at": "2022-07-21T02:02:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482252",
    "user": "mkoeppe"
}
```

Ready for testing on macOS.



---

archive/issue_comments_482253.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-07-21T02:19:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482253",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_482254.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-07-21T03:03:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482254",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_482255.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-07-21T03:33:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482255",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_482256.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-07-21T03:45:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482256",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_482257.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-07-21T04:33:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482257",
    "user": "mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_482258.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-07-21T06:05:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482258",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_482259.json:
```json
{
    "body": "Cherry-picked / updated the commit from #29097.",
    "created_at": "2022-07-21T06:06:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482259",
    "user": "mkoeppe"
}
```

Cherry-picked / updated the commit from #29097.



---

archive/issue_comments_482260.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2022-07-21T06:39:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482260",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_482261.json:
```json
{
    "body": "This also finds a strange bug in our `suitesparse` installation on macOS:\nThe installation record (`local/var/lib/sage/installed/suitesparse-5.10.1`) contains paths in the temporary build directory (`var/tmp/sage/build/suitesparse-5.10.1`).\nI've opened #34206 for this",
    "created_at": "2022-07-21T16:47:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482261",
    "user": "mkoeppe"
}
```

This also finds a strange bug in our `suitesparse` installation on macOS:
The installation record (`local/var/lib/sage/installed/suitesparse-5.10.1`) contains paths in the temporary build directory (`var/tmp/sage/build/suitesparse-5.10.1`).
I've opened #34206 for this



---

archive/issue_comments_482262.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2022-07-21T23:01:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482262",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_482263.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2022-07-21T23:10:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482263",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_482264.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-07-23T21:54:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482264",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_482265.json:
```json
{
    "body": "Hi Nils, I developed this ticket as a solution for last time that you complained about people breaking your build. Care to review?",
    "created_at": "2022-08-22T23:04:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482265",
    "user": "mkoeppe"
}
```

Hi Nils, I developed this ticket as a solution for last time that you complained about people breaking your build. Care to review?



---

archive/issue_comments_482266.json:
```json
{
    "body": "Can you explain what \"package\" means in `list-broken-packages`? I ran the command and saw\n\n```\nusage: sage-spkg-installcheck [-h] [-v] spkg [sage_local]\nsage-spkg-installcheck: error: argument spkg: 'stack_data' is not a known spkg\n```\n\nfollowed by the suggestion to run `make stack_data-SAGE_VENV-uninstall`. Is `stack_data` actually broken, or is the \"usage\" message indication of something else going wrong? And what is `stack_data`, since it's not an spkg?",
    "created_at": "2022-09-12T22:54:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482266",
    "user": "jhpalmieri"
}
```

Can you explain what "package" means in `list-broken-packages`? I ran the command and saw

```
usage: sage-spkg-installcheck [-h] [-v] spkg [sage_local]
sage-spkg-installcheck: error: argument spkg: 'stack_data' is not a known spkg
```

followed by the suggestion to run `make stack_data-SAGE_VENV-uninstall`. Is `stack_data` actually broken, or is the "usage" message indication of something else going wrong? And what is `stack_data`, since it's not an spkg?



---

archive/issue_comments_482267.json:
```json
{
    "body": "Replying to [comment:44 John Palmieri]:\n> Can you explain what \"package\" means in `list-broken-packages`? \n\nAn SPKG",
    "created_at": "2022-09-12T22:56:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482267",
    "user": "mkoeppe"
}
```

Replying to [comment:44 John Palmieri]:
> Can you explain what "package" means in `list-broken-packages`? 

An SPKG



---

archive/issue_comments_482268.json:
```json
{
    "body": "Replying to [comment:44 John Palmieri]:\n>  Is `stack_data` actually broken, or is the \"usage\" message indication of something else going wrong? And what is `stack_data`, since it's not an spkg?\n\nIt's broken as follows: You have an installation of it (from some other branch), but it's not (per what is currently in `build/pkgs`) an SPKG.",
    "created_at": "2022-09-12T23:07:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482268",
    "user": "mkoeppe"
}
```

Replying to [comment:44 John Palmieri]:
>  Is `stack_data` actually broken, or is the "usage" message indication of something else going wrong? And what is `stack_data`, since it's not an spkg?

It's broken as follows: You have an installation of it (from some other branch), but it's not (per what is currently in `build/pkgs`) an SPKG.



---

archive/issue_comments_482269.json:
```json
{
    "body": "In 9.7.rc1, `stack_data` of course is a package, so after merging 9.7.rc1, this will no longer be reported as \"broken\".",
    "created_at": "2022-09-12T23:08:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482269",
    "user": "mkoeppe"
}
```

In 9.7.rc1, `stack_data` of course is a package, so after merging 9.7.rc1, this will no longer be reported as "broken".



---

archive/issue_comments_482270.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-12T23:08:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482270",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_482271.json:
```json
{
    "body": "And here's that merge commit.",
    "created_at": "2022-09-12T23:09:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482271",
    "user": "mkoeppe"
}
```

And here's that merge commit.



---

archive/issue_comments_482272.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-13T00:27:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482272",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_482273.json:
```json
{
    "body": "Should this have a nonzero return code if some packages are broken?",
    "created_at": "2022-09-14T21:33:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482273",
    "user": "jhpalmieri"
}
```

Should this have a nonzero return code if some packages are broken?



---

archive/issue_comments_482274.json:
```json
{
    "body": "From its name `list-broken-packages`, I tend to say that it should not indicate a failure like that",
    "created_at": "2022-09-14T21:36:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482274",
    "user": "mkoeppe"
}
```

From its name `list-broken-packages`, I tend to say that it should not indicate a failure like that



---

archive/issue_comments_482275.json:
```json
{
    "body": "I think I agree but I wanted to ask.",
    "created_at": "2022-09-14T21:39:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482275",
    "user": "jhpalmieri"
}
```

I think I agree but I wanted to ask.



---

archive/issue_comments_482276.json:
```json
{
    "body": "It is possible that some could want to do `make -j list-broken-packages && do something else`, but I don't see a concrete example.",
    "created_at": "2022-09-14T21:40:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482276",
    "user": "jhpalmieri"
}
```

It is possible that some could want to do `make -j list-broken-packages && do something else`, but I don't see a concrete example.



---

archive/issue_comments_482277.json:
```json
{
    "body": "Yes, I thought about this, but I'd say that this whole thing is a strictly manual operation, which doesn't lend itself to scripting.",
    "created_at": "2022-09-14T21:53:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482277",
    "user": "mkoeppe"
}
```

Yes, I thought about this, but I'd say that this whole thing is a strictly manual operation, which doesn't lend itself to scripting.



---

archive/issue_comments_482278.json:
```json
{
    "body": "For the new package `auditwheel_or_delocate`, it seems that potentially both are used on Linux, only `delocate` on OS X. If that's right, then the `SPKG.rst` should be modified. \n\nInstalling `auditwheel` via pip also installs `pyelftools`, and `patchelf` is listed as a dependency on the PyPI page. Do we need to create a new package `pyelftools`, too? Is `patchelf` really required, or is it only necessary if one is trying to fix files, not just detect whether they're broken?",
    "created_at": "2022-09-14T21:56:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482278",
    "user": "jhpalmieri"
}
```

For the new package `auditwheel_or_delocate`, it seems that potentially both are used on Linux, only `delocate` on OS X. If that's right, then the `SPKG.rst` should be modified. 

Installing `auditwheel` via pip also installs `pyelftools`, and `patchelf` is listed as a dependency on the PyPI page. Do we need to create a new package `pyelftools`, too? Is `patchelf` really required, or is it only necessary if one is trying to fix files, not just detect whether they're broken?



---

archive/issue_comments_482279.json:
```json
{
    "body": "The comment \"and delete the rest\" does not seem to be accurate (and I think it's fine not to delete the old stamp files here).",
    "created_at": "2022-09-14T22:00:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482279",
    "user": "jhpalmieri"
}
```

The comment "and delete the rest" does not seem to be accurate (and I think it's fine not to delete the old stamp files here).



---

archive/issue_comments_482280.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-14T22:15:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482280",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_482281.json:
```json
{
    "body": "Replying to [comment:56 John Palmieri]:\n> Installing `auditwheel` via pip also installs `pyelftools`, and `patchelf` is listed as a dependency on the PyPI page. Do we need to create a new package `pyelftools`, too?\n\nNot needed - that's what makes optional \"pip\" packages so convenient.\n\n> Is `patchelf` really required, or is it only necessary if one is trying to fix files, not just detect whether they're broken?\n\nRight, it's only needed for repairing wheels. But it's best not try to circumvent the declared dependencies. \n\nThe scipy upgrade (#34081) will bring a patchelf, by the way.",
    "created_at": "2022-09-14T22:21:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482281",
    "user": "mkoeppe"
}
```

Replying to [comment:56 John Palmieri]:
> Installing `auditwheel` via pip also installs `pyelftools`, and `patchelf` is listed as a dependency on the PyPI page. Do we need to create a new package `pyelftools`, too?

Not needed - that's what makes optional "pip" packages so convenient.

> Is `patchelf` really required, or is it only necessary if one is trying to fix files, not just detect whether they're broken?

Right, it's only needed for repairing wheels. But it's best not try to circumvent the declared dependencies. 

The scipy upgrade (#34081) will bring a patchelf, by the way.



---

archive/issue_comments_482282.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-14T22:24:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482282",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_482283.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-09-14T22:30:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482283",
    "user": "jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_482284.json:
```json
{
    "body": "Great, I think this is ready to go now.",
    "created_at": "2022-09-14T22:30:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482284",
    "user": "jhpalmieri"
}
```

Great, I think this is ready to go now.



---

archive/issue_comments_482285.json:
```json
{
    "body": "Thank you!",
    "created_at": "2022-09-14T22:36:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482285",
    "user": "mkoeppe"
}
```

Thank you!



---

archive/issue_comments_482286.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-09-20T20:22:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33966#issuecomment-482286",
    "user": "vbraun"
}
```

Resolution: fixed
