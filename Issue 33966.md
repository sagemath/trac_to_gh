# Issue 33966: Find and uninstall broken installed SPKGs and wheels

Issue created by migration from https://trac.sagemath.org/ticket/34203

Original creator: mkoeppe

Original creation time: 2022-07-20 22:20:39

CC:  dimpase jhpalmieri nbruin charpent

We can inspect the installation records in `$SAGE_LOCAL/var/lib/sage/installed/` by running `ldd` on any shared libraries and uninstall them if they refer to nonexisting libraries.


---

Comment by git created at 2022-07-21 00:00:40

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-07-21 00:21:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-21 00:46:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-21 01:36:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-21 02:00:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-07-21 02:02:37

Ready for testing on macOS.


---

Comment by git created at 2022-07-21 02:19:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-21 03:03:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-21 03:33:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-21 03:45:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-07-21 04:33:20

Changing status from new to needs_review.


---

Comment by git created at 2022-07-21 06:05:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-07-21 06:06:17

Cherry-picked / updated the commit from #29097.


---

Comment by git created at 2022-07-21 06:39:25

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mkoeppe created at 2022-07-21 16:47:01

This also finds a strange bug in our `suitesparse` installation on macOS:
The installation record (`local/var/lib/sage/installed/suitesparse-5.10.1`) contains paths in the temporary build directory (`var/tmp/sage/build/suitesparse-5.10.1`).
I've opened #34206 for this


---

Comment by git created at 2022-07-21 23:01:18

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2022-07-21 23:10:11

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2022-07-23 21:54:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-08-22 23:04:52

Hi Nils, I developed this ticket as a solution for last time that you complained about people breaking your build. Care to review?


---

Comment by jhpalmieri created at 2022-09-12 22:54:32

Can you explain what "package" means in `list-broken-packages`? I ran the command and saw

```
usage: sage-spkg-installcheck [-h] [-v] spkg [sage_local]
sage-spkg-installcheck: error: argument spkg: 'stack_data' is not a known spkg
```

followed by the suggestion to run `make stack_data-SAGE_VENV-uninstall`. Is `stack_data` actually broken, or is the "usage" message indication of something else going wrong? And what is `stack_data`, since it's not an spkg?


---

Comment by mkoeppe created at 2022-09-12 22:56:34

Replying to [comment:44 John Palmieri]:
> Can you explain what "package" means in `list-broken-packages`? 

An SPKG


---

Comment by mkoeppe created at 2022-09-12 23:07:00

Replying to [comment:44 John Palmieri]:
>  Is `stack_data` actually broken, or is the "usage" message indication of something else going wrong? And what is `stack_data`, since it's not an spkg?

It's broken as follows: You have an installation of it (from some other branch), but it's not (per what is currently in `build/pkgs`) an SPKG.


---

Comment by mkoeppe created at 2022-09-12 23:08:41

In 9.7.rc1, `stack_data` of course is a package, so after merging 9.7.rc1, this will no longer be reported as "broken".


---

Comment by git created at 2022-09-12 23:08:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-09-12 23:09:21

And here's that merge commit.


---

Comment by git created at 2022-09-13 00:27:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2022-09-14 21:33:09

Should this have a nonzero return code if some packages are broken?


---

Comment by mkoeppe created at 2022-09-14 21:36:57

From its name `list-broken-packages`, I tend to say that it should not indicate a failure like that


---

Comment by jhpalmieri created at 2022-09-14 21:39:11

I think I agree but I wanted to ask.


---

Comment by jhpalmieri created at 2022-09-14 21:40:11

It is possible that some could want to do `make -j list-broken-packages && do something else`, but I don't see a concrete example.


---

Comment by mkoeppe created at 2022-09-14 21:53:22

Yes, I thought about this, but I'd say that this whole thing is a strictly manual operation, which doesn't lend itself to scripting.


---

Comment by jhpalmieri created at 2022-09-14 21:56:01

For the new package `auditwheel_or_delocate`, it seems that potentially both are used on Linux, only `delocate` on OS X. If that's right, then the `SPKG.rst` should be modified. 

Installing `auditwheel` via pip also installs `pyelftools`, and `patchelf` is listed as a dependency on the PyPI page. Do we need to create a new package `pyelftools`, too? Is `patchelf` really required, or is it only necessary if one is trying to fix files, not just detect whether they're broken?


---

Comment by jhpalmieri created at 2022-09-14 22:00:21

The comment "and delete the rest" does not seem to be accurate (and I think it's fine not to delete the old stamp files here).


---

Comment by git created at 2022-09-14 22:15:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-09-14 22:21:49

Replying to [comment:56 John Palmieri]:
> Installing `auditwheel` via pip also installs `pyelftools`, and `patchelf` is listed as a dependency on the PyPI page. Do we need to create a new package `pyelftools`, too?

Not needed - that's what makes optional "pip" packages so convenient.

> Is `patchelf` really required, or is it only necessary if one is trying to fix files, not just detect whether they're broken?

Right, it's only needed for repairing wheels. But it's best not try to circumvent the declared dependencies. 

The scipy upgrade (#34081) will bring a patchelf, by the way.


---

Comment by git created at 2022-09-14 22:24:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2022-09-14 22:30:50

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2022-09-14 22:30:50

Great, I think this is ready to go now.


---

Comment by mkoeppe created at 2022-09-14 22:36:45

Thank you!


---

Comment by vbraun created at 2022-09-20 20:22:59

Resolution: fixed
