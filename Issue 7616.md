# Issue 7616: fix bug in trivial number field extensions

Issue created by migration from https://trac.sagemath.org/ticket/7616

Original creator: rlm

Original creation time: 2009-12-07 19:59:24

Assignee: davidloeffler

CC:  craigcitro robertwb was

When testing my new S-units code with trivial examples, I found this corner case bug, but it took Robert Bradshaw and me hours to track down the cause, which I believe is in the code from #1083.


---

Comment by rlm created at 2009-12-07 20:01:39

Changing status from new to needs_review.


---

Comment by rlm created at 2009-12-07 20:01:48

Changing assignee from davidloeffler to rlm.


---

Comment by craigcitro created at 2009-12-07 21:22:31

So I'm a little confused by the first example in this patch. In particular, I think the new returned answer is *incorrect* as I currently understand `K.extension` -- `K.extension(y)` should give the field we get by taking the quotient of `R` by the ideal generated by `y`, which is just `K` again -- but in particular, `y0` *should* map to 0. (I think that could explain why it seems like the relative number field code looked like it was returning wrong answers ...)


---

Comment by craigcitro created at 2009-12-07 22:18:00

Aha, I misunderstood. This isn't going to change `K.extension(y)` -- it's going to change `K.extension(y).gens()`, which is currently wrong. In particular, if you look at the comments on #2767 (where this bug was actually introduced), I was assuming that the polynomial generating the relative extension was of the form `x-a`, where `a` was any *nonzero* value. As the example in the patch points out, `a` might be 0. `:)`

I need to finish reading the Pari docs, but it looks like this extra entry in the Pari RNF is exactly what we want. Review coming shortly.


---

Comment by cremona created at 2009-12-10 21:45:49

Robert -- care to tell us what will be in your S-units code?  Something relevant to descent perhaps?  I would like to open a ticket to implement so-called Selmer groups of number fields, i.e. K(S,m) = subgroup of `K<sup>*/(K</sup>*)^m` consisting of all elements whose valuations at primes outside S are multiples of m.  This is used in m-descent.   The main cases are for prime m, but I also need m=4 and m=6.  I have implementations of all this in Magma which I could port.

Sorry, this is a bit off-topic...


---

Comment by craigcitro created at 2009-12-20 18:58:15

Changing status from needs_review to needs_work.


---

Comment by craigcitro created at 2009-12-20 18:58:15

There's a long email thread about this between the Roberts and I, but I realized I should at least make a note here to keep other people up to date (in particular, I think John C is itching to see this in!) We're getting closer and closer, but unfortunately the current patch isn't it. (I think we can make Robert's previous patch work, but I won't have a chance to get to it until tonight.) Here's an example that blows up:


```
sage: K.<a> = NumberField(x^5+2) ; R.<y> = K[] ; L.<x0> = K.extension(y + a**2)
sage: L(a)
... RuntimeError ...
```


I'm going to have some time to work tonight (barring my daughter not sleeping), and I think we can finish this off then. The problem is that each case where this works also produces other weird bugs/issues ... in any event, ETA is soon for a working patch.


---

Comment by cremona created at 2009-12-20 19:26:46

Sounds good.  If it's still needing work tomorrow I'll probably have some time to look at it -- or review it if fixed.


---

Comment by rlm created at 2009-12-20 22:33:50

Changing status from needs_work to needs_review.


---

Comment by rlm created at 2009-12-20 22:34:43

Robert -- hope it's okay to remove you from the author block... Let me know if not.


---

Comment by fwclarke created at 2009-12-21 07:53:03

Changing status from needs_review to needs_work.


---

Comment by fwclarke created at 2009-12-21 07:53:03

After the patch (with 4.3.rc0):

```
sage: K.<a> = QuadraticField(-3)
sage: L.<b> = K.extension(x - 5)
sage: a*b
5*a
```

The result was `0` before.

But

```
sage: b
---------------------------------------------------------------------------
IndexError 
...
IndexError: tuple index out of range
```

The result was `5` before.


---

Comment by craigcitro created at 2009-12-21 20:22:57

I've got a patch that I'm cleaning up that fixes the original issue, and cleans up a lot of random other stuff as well. Unfortunately, I can't post it until later tonight ... 

Interestingly, I didn't get the error that fwclarke was seeing with RLM's patch, but I did get a *different* error, similar to the one I mentioned above -- though it was now a wrong answer, not a `RuntimeError`. I'll write more later ...


---

Comment by rlm created at 2009-12-22 07:00:38

Changing status from needs_work to needs_review.


---

Comment by rlm created at 2009-12-22 07:00:38

Replying to [comment:10 fwclarke]:
> After the patch (with 4.3.rc0):
> {{{
> sage: K.<a> = QuadraticField(-3)
> sage: L.<b> = K.extension(x - 5)
> sage: a*b
> 5*a
> }}}
> The result was `0` before.

Since b == 5, this is correct.

> But
> {{{
> sage: b
> ---------------------------------------------------------------------------
> IndexError 
> ...
> IndexError: tuple index out of range
> }}}
> The result was `5` before.

I've fixed this, and posted a new patch.


---

Comment by rlm created at 2009-12-22 07:20:35

This example should go in doctests, as well:

```
sage: K.<a> = NumberField(x^5+2)
sage: R.<y> = K[]
sage: D.<x0> = K.extension(y + a + 1)
sage: D(a)
a
```



---

Comment by rlm created at 2009-12-22 07:20:35

Changing status from needs_review to needs_work.


---

Comment by craigcitro created at 2009-12-22 07:37:21

Changing status from needs_work to needs_review.


---

Comment by craigcitro created at 2009-12-22 07:37:21

So I'm attaching another patch, which uses a slightly different fix. In particular, I use the various fields returned by Pari's `rnfequation`. I think that this should do something equivalent to what RLM's patch does. It does have the advantage of being faster, since I don't have to do all the `quo_rem` business to invert a polynomial. (I'm also seeing an issue with RLM's most recent patch which he isn't, so I don't know if it's cosmic rays or something serious ...) 

I'm not sure what the best plan is -- if RLM is happy with my patch, I'm happy to have someone else (Francis Clarke? John Cremona?) also take a quick look (at least confirm that it works and passes doctests!), and then ultimately merge that. In any event, I'm moving to `needs_review`.


---

Attachment

(New version of my patch -- identical except for formatting and grammar in a long comment block.)


---

Comment by rlm created at 2009-12-22 07:55:28

I'm happy with Craig's patch. I'm deleting mine to avoid confusion. Perhaps John could review it, since I'm already entangled?


---

Comment by cremona created at 2009-12-22 09:22:20

OK, I'm looking at it now and wil report back soon.


---

Comment by cremona created at 2009-12-22 10:00:23

Disclaimer:   Since I did not follow all the discussions between the 2/3 of you, and the only patch I looked at is the most recent one ( trac_7616_alt.patch ) I may be blind to some of the issues here.

The patch applies fine to 4.3.rc0 and all tests in sage/rings/number_fields pass.

The new code is very well documented both with explanations of what is being done and why, with references to the underlying pari structures, and with lots of examples.  (I also tried some of my own).

It looks fine to me:  I suggest that the best way forward is to pass this, and if there are some problems further down the line then the explanations inserted here as comments will make it easier to deal with them.  Since I know that rlm ran into this problem while working on his S-units and S-class group code, we may find such issues sooner rather than later;  never mind.


---

Comment by cremona created at 2009-12-22 10:00:23

Changing status from needs_review to positive_review.


---

Comment by mhansen created at 2010-01-03 21:42:20

Resolution: fixed
