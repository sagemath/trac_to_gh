# Issue 22815: Provide coercion for gmpy2 numbers

Issue created by migration from Trac.

Original creator: vklein

Original creation time: 2017-05-22 10:18:18

CC:  vdelecroix jdemeyer

Provide coercion for gmpy2 numbers for operations -, +, * and /
This ticket follow the discussion about coercion for gmpy2 numbers #22928.


---

Comment by vklein created at 2017-05-22 10:19:07

Set assignee to vklein.


---

Comment by jdemeyer created at 2017-05-22 10:26:39

Replying to [ticket:23052 vklein]:
> Provide coercion for gmpy2 numbers for operations -, +, * and /

This makes no sense to me. What does it mean to provide coercion for *certain operations* only?


---

Comment by vklein created at 2017-05-22 11:22:26

You're right, description updated


---

Comment by jdemeyer created at 2017-05-22 11:44:02

Thanks for the clarification.


---

Comment by vdelecroix created at 2019-03-03 10:19:23

I don't think that this feature is desirable. The behavior should be the same as with `cypari2`

```
sage: import cypari2
sage: pari = cypari2.Pari()
sage: type(pari(1) + 1)
<type 'cypari2.gen.Gen'>
sage: type(1 + pari(1))
<type 'cypari2.gen.Gen'>
```

Mixing `gmpy2` numbers with sage numbers currently raise errors

```
sage: import gmpy2
sage: type(gmpy2.mpz(1) + 1)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-2-eeaeca1c122b> in <module>()
----> 1 type(gmpy2.mpz(Integer(1)) + Integer(1))

/opt/sage/local/lib/python2.7/site-packages/sage/rings/integer.pyx in sage.rings.integer.Integer.__add__ (build/cythonized/sage/rings/integer.c:11460)()
   1683             return y
   1684 
-> 1685         return coercion_model.bin_op(left, right, operator.add)
   1686 
   1687     cpdef _add_(self, right):

/opt/sage/local/lib/python2.7/site-packages/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel.bin_op (build/cythonized/sage/structure/coerce.c:11110)()
   1208         # We should really include the underlying error.
   1209         # This causes so much headache.
-> 1210         raise bin_op_exception(op, x, y)
   1211 
   1212     cpdef canonical_coercion(self, x, y):

TypeError: unsupported operand parent(s) for +: '<type 'mpz'>' and 'Integer Ring'
sage: type(1 + gmpy2.mpz(1))
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-3-ea356a02d58b> in <module>()
----> 1 type(Integer(1) + gmpy2.mpz(Integer(1)))

/opt/sage/local/lib/python2.7/site-packages/sage/rings/integer.pyx in sage.rings.integer.Integer.__add__ (build/cythonized/sage/rings/integer.c:11460)()
   1683             return y
   1684 
-> 1685         return coercion_model.bin_op(left, right, operator.add)
   1686 
   1687     cpdef _add_(self, right):

/opt/sage/local/lib/python2.7/site-packages/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel.bin_op (build/cythonized/sage/structure/coerce.c:11110)()
   1208         # We should really include the underlying error.
   1209         # This causes so much headache.
-> 1210         raise bin_op_exception(op, x, y)
   1211 
   1212     cpdef canonical_coercion(self, x, y):

TypeError: unsupported operand parent(s) for +: 'Integer Ring' and '<type 'mpz'>'
```



---

Comment by vdelecroix created at 2019-03-03 10:22:30

To make this work, one has to modify the various binary operators in `gmpy2` (e.g. `GMPy_Integer_Add`).


---

Comment by jdemeyer created at 2019-03-03 10:53:04

Replying to [comment:8 vdelecroix]:
> To make this work, one has to modify the various binary operators in `gmpy2` (e.g. `GMPy_Integer_Add`).

This is obviously the right thing to do. Given that

```
sage: from gmpy2 import mpz
sage: mpz(1) + int(1)
mpz(2)
```

works, it's actually strange that

```
sage: from gmpy2 import mpz
sage: mpz(1) + Integer(1)
Traceback (most recent call last):
...
TypeError: unsupported operand parent(s) for +: '<type 'mpz'>' and 'Integer Ring'
```

doesn't work.


---

Comment by vdelecroix created at 2019-03-03 10:54:26

Let me update the ticket description then.


---

Comment by vdelecroix created at 2019-03-03 10:59:13

Changing component from packages: optional to packages: standard.


---

Comment by vdelecroix created at 2019-03-03 10:59:13

Changing type from enhancement to defect.


---

Comment by vklein created at 2019-03-07 09:47:21

The gmpy2 pull request [#217](https://github.com/aleaxit/gmpy/pull/217) has been merged this morning.\\
Should we make a patch based on this or wait for the next gmpy2 release ?


---

Comment by vdelecroix created at 2019-03-07 12:50:32

Replying to [comment:14 vklein]:
> The gmpy2 pull request [#217](https://github.com/aleaxit/gmpy/pull/217) has been merged this morning.

This is a great news. Thanks for the work!

> Should we make a patch based on this or wait for the next gmpy2 release ?

Do we have a schedule for the next gmpy2 release? Since gmpy2 becomes a standard package for the next Sage release it would be nice if it would happen before.

Otherwise, I am not a big fan of using patches that are integrated upstream but not released yet.


---

Comment by vdelecroix created at 2019-03-07 12:52:57

Replying to [comment:15 vdelecroix]:
> Replying to [comment:14 vklein]:
> > Should we make a patch based on this or wait for the next gmpy2 release ?
> 
> Do we have a schedule for the next gmpy2 release? Since gmpy2 becomes a standard package for the next Sage release it would be nice if it would happen before.

Somehow [#199](https://github.com/aleaxit/gmpy/issues/199) is a bit of an answer.


---

Comment by vklein created at 2019-03-08 09:40:28

After some talk with vdelecroix we agree to make a gmpy2 patch with [#217](https://github.com/aleaxit/gmpy/pull/217).
----
New commits:


---

Comment by vklein created at 2019-03-08 09:40:28

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2019-03-08 18:46:20

You create a lot of warnings with the macros. This should be fixed.

```
gmpy2-2.1.0a4.p1]     src/gmpy2_cache.c: In function 'GMPy_MPZ_NewInit':
[gmpy2-2.1.0a4.p1]     src/gmpy2_convert.h:44:60: warning: suggest parentheses around '&&' within '||' [-Wparentheses]
[gmpy2-2.1.0a4.p1]      #define HAS_STRICT_MPZ_CONVERSION(x) HAS_MPZ_CONVERSION(x) && \
[gmpy2-2.1.0a4.p1]                                                                 ^
[gmpy2-2.1.0a4.p1]     src/gmpy2_convert.h:52:25: note: in expansion of macro 'HAS_STRICT_MPZ_CONVERSION'
[gmpy2-2.1.0a4.p1]                              HAS_STRICT_MPZ_CONVERSION(x))
[gmpy2-2.1.0a4.p1]                              ^
[gmpy2-2.1.0a4.p1]     src/gmpy2_convert.h:61:25: note: in expansion of macro 'IS_INTEGER'
[gmpy2-2.1.0a4.p1]      #define IS_RATIONAL(x) (IS_INTEGER(x) || IS_RATIONAL_ONLY(x))
[gmpy2-2.1.0a4.p1]                              ^
[gmpy2-2.1.0a4.p1]     src/gmpy2_convert.h:64:21: note: in expansion of macro 'IS_RATIONAL'
[gmpy2-2.1.0a4.p1]      #define IS_REAL(x) (IS_RATIONAL(x) || IS_REAL_ONLY(x))
[gmpy2-2.1.0a4.p1]                          ^
[gmpy2-2.1.0a4.p1]     src/gmpy2_cache.c:191:9: note: in expansion of macro 'IS_REAL'
[gmpy2-2.1.0a4.p1]          if (IS_REAL(n)) {
[gmpy2-2.1.0a4.p1]              ^
[gmpy2-2.1.0a4.p1]     src/gmpy2_convert.h:46:62: warning: suggest parentheses around '&&' within '||' [-Wparentheses]
[gmpy2-2.1.0a4.p1]      #define HAS_STRICT_MPFR_CONVERSION(x) HAS_MPFR_CONVERSION(x) && \
[gmpy2-2.1.0a4.p1]                                                                   ^
[gmpy2-2.1.0a4.p1]     src/gmpy2_convert.h:63:63: note: in expansion of macro 'HAS_STRICT_MPFR_CONVERSION'
[gmpy2-2.1.0a4.p1]      #define IS_REAL_ONLY(x) (MPFR_Check(x) || PyFloat_Check(x) || HAS_STRICT_MPFR_CONVERSION(x))
[gmpy2-2.1.0a4.p1]                                                                    ^
[gmpy2-2.1.0a4.p1]     src/gmpy2_convert.h:64:39: note: in expansion of macro 'IS_REAL_ONLY'
[gmpy2-2.1.0a4.p1]      #define IS_REAL(x) (IS_RATIONAL(x) || IS_REAL_ONLY(x))
[gmpy2-2.1.0a4.p1]                                            ^
[gmpy2-2.1.0a4.p1]     src/gmpy2_cache.c:191:9: note: in expansion of macro 'IS_REAL'
[gmpy2-2.1.0a4.p1]          if (IS_REAL(n)) {
[gmpy2-2.1.0a4.p1]              ^
```



---

Comment by vdelecroix created at 2019-03-08 18:46:20

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-03-11 08:35:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vklein created at 2019-03-11 08:35:54

Warnings fixed.


---

Comment by vklein created at 2019-03-11 08:35:54

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2019-03-11 15:18:44

some failures...

```
Doctesting 3797 files using 14 threads.
sage -t --long src/sage/arith/misc.py
**********************************************************************
File "src/sage/arith/misc.py", line 3120, in sage.arith.misc.crt
Failed example:
    crt(mpz(2), mpz(3), mpz(7), mpz(11))
Expected:
    58
Got:
    mpz(58)
**********************************************************************
File "src/sage/arith/misc.py", line 3122, in sage.arith.misc.crt
Failed example:
    crt(mpz(2), 3, mpz(7), numpy.int8(11))
Expected:
    58
Got:
    mpz(58)
**********************************************************************
1 item had failures:
   2 of  37 in sage.arith.misc.crt
    [1056 tests, 2 failures, 30.02 s]
----------------------------------------------------------------------
sage -t --long src/sage/arith/misc.py  # 2 doctests failed
----------------------------------------------------------------------
```



---

Comment by vdelecroix created at 2019-03-11 15:18:44

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-03-11 17:30:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vklein created at 2019-03-11 17:32:16

function `sage.arith.misc.crt` fixed


---

Comment by vklein created at 2019-03-11 17:32:16

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2019-03-11 19:00:02

The patch that you called `PR217.patch` comes from two pull requests ([#217](https://github.com/aleaxit/gmpy/pull/217) and [#218](https://github.com/aleaxit/gmpy/pull/218)). You would better change the name of the patch and mention very explicitely in the header of the patch the urls of the actual pull requests.


---

Comment by git created at 2019-03-12 07:31:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vklein created at 2019-03-12 07:32:27

Patch renamed and links added.


---

Comment by vdelecroix created at 2019-03-12 08:47:24

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-03-14 18:13:58

Resolution: fixed
