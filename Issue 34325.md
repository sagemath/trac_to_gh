# Issue 34325: refactor multiple zeta values

archive/issues_034325.json:
```json
{
    "body": "CC:  vdelecroix tscrim\n\nThis ticket mainly aims to separate the auxiliary F-algebra in another file.\n\nThis file implements a better custom-made F-algebra, with additional useful methods.\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/34562\n\n",
    "created_at": "2022-09-20T09:42:46Z",
    "labels": [
        "number theory",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "refactor multiple zeta values",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34325",
    "user": "chapoton"
}
```
CC:  vdelecroix tscrim

This ticket mainly aims to separate the auxiliary F-algebra in another file.

This file implements a better custom-made F-algebra, with additional useful methods.



Issue created by migration from https://trac.sagemath.org/ticket/34562





---

archive/issue_comments_486800.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-09-20T09:43:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34325",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34325#issuecomment-486800",
    "user": "chapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_486801.json:
```json
{
    "body": "New commits:",
    "created_at": "2022-09-20T09:43:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34325",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34325#issuecomment-486801",
    "user": "chapoton"
}
```

New commits:



---

archive/issue_comments_486802.json:
```json
{
    "body": "Some quick comments about the `F_algebra`:\n\n- The element's `coefficients` should return the nonzero coefficients, but the current implementation has different behavior.\n- There should be a `from_vector` method on the parent. This is useful for the linear algebra methods.\n- The `NN` can be a little funky when it comes to lazy imports not resolving correctly (#16522). It would be better to use `NonNegativeIntegers()` unless you specifically are looking for the algebraic aspects.\n- Is there a reason why you are nailing `Indices` in the module level memory? It seems like the `str_to_index` is better as a method of the `F_algebra` and then you could access it by `self._indices` there (or `self.parent()._indices`).\n- Instead of the recursive `basis_f_odd_iterator`, is it faster to use the iterators from `WeightedIntegerVectors` and `Permutations_mset` (which operate on lists)? It is a slightly more involved implementation, but I don't know how important speed is here.\n- For the `product_on_basis`, it might be faster to do `self.sum()` since it works with the elements directly and has less transient elements.",
    "created_at": "2022-09-20T10:16:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34325",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34325#issuecomment-486802",
    "user": "tscrim"
}
```

Some quick comments about the `F_algebra`:

- The element's `coefficients` should return the nonzero coefficients, but the current implementation has different behavior.
- There should be a `from_vector` method on the parent. This is useful for the linear algebra methods.
- The `NN` can be a little funky when it comes to lazy imports not resolving correctly (#16522). It would be better to use `NonNegativeIntegers()` unless you specifically are looking for the algebraic aspects.
- Is there a reason why you are nailing `Indices` in the module level memory? It seems like the `str_to_index` is better as a method of the `F_algebra` and then you could access it by `self._indices` there (or `self.parent()._indices`).
- Instead of the recursive `basis_f_odd_iterator`, is it faster to use the iterators from `WeightedIntegerVectors` and `Permutations_mset` (which operate on lists)? It is a slightly more involved implementation, but I don't know how important speed is here.
- For the `product_on_basis`, it might be faster to do `self.sum()` since it works with the elements directly and has less transient elements.



---

archive/issue_comments_486803.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-20T11:50:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34325",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34325#issuecomment-486803",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_486804.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-21T07:06:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34325",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34325#issuecomment-486804",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_486805.json:
```json
{
    "body": "Hello,\n\nthanks a lot for the suggestions !\n\n> - The element's `coefficients` should return the nonzero coefficients, but the current implementation has different behavior.\n\nok, done by removing the wrong alias that I had added.\n\n> - There should be a `from_vector` method on the parent. This is useful for the linear algebra methods.\n\nwell, the difficulty is that it only makes sense for homogeneous elements, and the usual \"from_vector\" methods does not take the degree as input\n\n> - The `NN` can be a little funky when it comes to lazy imports not resolving correctly (#16522). It would be better to use `NonNegativeIntegers()` unless you specifically are looking for the algebraic aspects.\n\nI substituted that for NN and it works fine.\n\n> - Is there a reason why you are nailing `Indices` in the module level memory? It seems like the `str_to_index` is better as a method of the `F_algebra` and then you could access it by `self._indices` there (or `self.parent()._indices`).\n\nI would rather keep \"str_to_index\" as an independant auxiliary function. Why is it problematic to have Indices at the module level ? oh, I guess it will have to be initiated when the module is loaded..\n\n> - Instead of the recursive `basis_f_odd_iterator`, is it faster to use the iterators from `WeightedIntegerVectors` and `Permutations_mset` (which operate on lists)? It is a slightly more involved implementation, but I don't know how important speed is here.\n\nNot sure how to achieve \"words of any length in odd integers at least 3 with sum n\" using the existing tools. And speed generally matters in this file, indeed.\n\n> - For the `product_on_basis`, it might be faster to do `self.sum()` since it works with the elements directly and has less transient elements.\n\nI have not yet checked that last suggestion.",
    "created_at": "2022-09-21T07:07:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34325",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34325#issuecomment-486805",
    "user": "chapoton"
}
```

Hello,

thanks a lot for the suggestions !

> - The element's `coefficients` should return the nonzero coefficients, but the current implementation has different behavior.

ok, done by removing the wrong alias that I had added.

> - There should be a `from_vector` method on the parent. This is useful for the linear algebra methods.

well, the difficulty is that it only makes sense for homogeneous elements, and the usual "from_vector" methods does not take the degree as input

> - The `NN` can be a little funky when it comes to lazy imports not resolving correctly (#16522). It would be better to use `NonNegativeIntegers()` unless you specifically are looking for the algebraic aspects.

I substituted that for NN and it works fine.

> - Is there a reason why you are nailing `Indices` in the module level memory? It seems like the `str_to_index` is better as a method of the `F_algebra` and then you could access it by `self._indices` there (or `self.parent()._indices`).

I would rather keep "str_to_index" as an independant auxiliary function. Why is it problematic to have Indices at the module level ? oh, I guess it will have to be initiated when the module is loaded..

> - Instead of the recursive `basis_f_odd_iterator`, is it faster to use the iterators from `WeightedIntegerVectors` and `Permutations_mset` (which operate on lists)? It is a slightly more involved implementation, but I don't know how important speed is here.

Not sure how to achieve "words of any length in odd integers at least 3 with sum n" using the existing tools. And speed generally matters in this file, indeed.

> - For the `product_on_basis`, it might be faster to do `self.sum()` since it works with the elements directly and has less transient elements.

I have not yet checked that last suggestion.



---

archive/issue_comments_486806.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-21T07:22:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34325",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34325#issuecomment-486806",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_486807.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-21T07:37:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34325",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34325#issuecomment-486807",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_486808.json:
```json
{
    "body": "Replying to [comment:5 Fr\u00e9d\u00e9ric Chapoton]:\n> thanks a lot for the suggestions !\n\nThank you for all your work on Sage.\n\n> > - There should be a `from_vector` method on the parent. This is useful for the linear algebra methods.\n> \n> well, the difficulty is that it only makes sense for homogeneous elements, and the usual \"from_vector\" methods does not take the degree as input\n\nI see. This breaks the `CFM.from_vector(v.to_vector()) == v` loop though (although that is more for finite dimensional modules). Perhaps we could rename this here to `homogeneous_to_vector()` to make it more future-proof (if we implement a generic infinite dimensional version someday)?\n\n> > - Is there a reason why you are nailing `Indices` in the module level memory? It seems like the `str_to_index` is better as a method of the `F_algebra` and then you could access it by `self._indices` there (or `self.parent()._indices`).\n> \n> I would rather keep \"str_to_index\" as an independant auxiliary function. Why is it problematic to have Indices at the module level ? oh, I guess it will have to be initiated when the module is loaded..\n\nSubsequently it effectively gets nailed in memory. It's fairly lightweight (and only one of them), so its not a problem, but it still is something that gets carried around.\n\nAlso, you shouldn't need to set `self._indices = Indices`; that should be done by the `CFM.__init__()`.\n\n> > - Instead of the recursive `basis_f_odd_iterator`, is it faster to use the iterators from `WeightedIntegerVectors` and `Permutations_mset` (which operate on lists)? It is a slightly more involved implementation, but I don't know how important speed is here.\n> \n> Not sure how to achieve \"words of any length in odd integers at least 3 with sum n\" using the existing tools. And speed generally matters in this file, indeed.\n\nIf speed matters, then perhaps we should just Cythonize the file. It would allow you to replace the `self.parent()` with `self._parent`, which is faster.\n\nPerhaps iterating over the indices is not such an important operation for speed. Although it might be best to use lightweight classes (e.g., `tuple`) and implement shuffling without using the heavy `ShuffleProduct_w1w2` parent class. This becomes something like\n\n```python\n    def shuffle(t1, t2):\n        n1 = len(t1)\n        n2 = len(t2)\n        for iv in IntegerVectors(n1, n1 + n2, max_part=1): # can probably even make this iterator smarter\n            it1 = iter(t1)\n            it2 = iter(t2)\n            yield tuple([next(it1) if v else next(it2) for v in iv])\n```\n\n\n> > - For the `product_on_basis`, it might be faster to do `self.sum()` since it works with the elements directly and has less transient elements.\n> \n> I have not yet checked that last suggestion.\n\nYour changes look like they should be faster. Even more so if we can make the indices involve less transient objects and/or checks.",
    "created_at": "2022-09-21T09:31:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34325",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34325#issuecomment-486808",
    "user": "tscrim"
}
```

Replying to [comment:5 Frédéric Chapoton]:
> thanks a lot for the suggestions !

Thank you for all your work on Sage.

> > - There should be a `from_vector` method on the parent. This is useful for the linear algebra methods.
> 
> well, the difficulty is that it only makes sense for homogeneous elements, and the usual "from_vector" methods does not take the degree as input

I see. This breaks the `CFM.from_vector(v.to_vector()) == v` loop though (although that is more for finite dimensional modules). Perhaps we could rename this here to `homogeneous_to_vector()` to make it more future-proof (if we implement a generic infinite dimensional version someday)?

> > - Is there a reason why you are nailing `Indices` in the module level memory? It seems like the `str_to_index` is better as a method of the `F_algebra` and then you could access it by `self._indices` there (or `self.parent()._indices`).
> 
> I would rather keep "str_to_index" as an independant auxiliary function. Why is it problematic to have Indices at the module level ? oh, I guess it will have to be initiated when the module is loaded..

Subsequently it effectively gets nailed in memory. It's fairly lightweight (and only one of them), so its not a problem, but it still is something that gets carried around.

Also, you shouldn't need to set `self._indices = Indices`; that should be done by the `CFM.__init__()`.

> > - Instead of the recursive `basis_f_odd_iterator`, is it faster to use the iterators from `WeightedIntegerVectors` and `Permutations_mset` (which operate on lists)? It is a slightly more involved implementation, but I don't know how important speed is here.
> 
> Not sure how to achieve "words of any length in odd integers at least 3 with sum n" using the existing tools. And speed generally matters in this file, indeed.

If speed matters, then perhaps we should just Cythonize the file. It would allow you to replace the `self.parent()` with `self._parent`, which is faster.

Perhaps iterating over the indices is not such an important operation for speed. Although it might be best to use lightweight classes (e.g., `tuple`) and implement shuffling without using the heavy `ShuffleProduct_w1w2` parent class. This becomes something like

```python
    def shuffle(t1, t2):
        n1 = len(t1)
        n2 = len(t2)
        for iv in IntegerVectors(n1, n1 + n2, max_part=1): # can probably even make this iterator smarter
            it1 = iter(t1)
            it2 = iter(t2)
            yield tuple([next(it1) if v else next(it2) for v in iv])
```


> > - For the `product_on_basis`, it might be faster to do `self.sum()` since it works with the elements directly and has less transient elements.
> 
> I have not yet checked that last suggestion.

Your changes look like they should be faster. Even more so if we can make the indices involve less transient objects and/or checks.



---

archive/issue_comments_486809.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-21T11:18:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34325",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34325#issuecomment-486809",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_486810.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-21T13:59:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34325",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34325#issuecomment-486810",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_486811.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-22T08:02:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34325",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34325#issuecomment-486811",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_486812.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-22T12:46:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34325",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34325#issuecomment-486812",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_486813.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-22T12:55:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34325",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34325#issuecomment-486813",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_486814.json:
```json
{
    "body": "I guess it is now ready for review again.",
    "created_at": "2022-09-22T18:57:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34325",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34325#issuecomment-486814",
    "user": "chapoton"
}
```

I guess it is now ready for review again.



---

archive/issue_comments_486815.json:
```json
{
    "body": "maybe one should simplify (in F_algebra) the double method \"gen\" versus \"custom_gen\" ?",
    "created_at": "2022-09-22T19:22:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34325",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34325#issuecomment-486815",
    "user": "chapoton"
}
```

maybe one should simplify (in F_algebra) the double method "gen" versus "custom_gen" ?



---

archive/issue_comments_486816.json:
```json
{
    "body": "It does look a bit weird to have both `gen` and `custom_gen`. Is there a reason to have both? Perhaps it could be a little better with a different name than `custom_gen`? I am not sure what a good name might be though.",
    "created_at": "2022-09-23T07:21:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34325",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34325#issuecomment-486816",
    "user": "tscrim"
}
```

It does look a bit weird to have both `gen` and `custom_gen`. Is there a reason to have both? Perhaps it could be a little better with a different name than `custom_gen`? I am not sure what a good name might be though.



---

archive/issue_comments_486817.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-23T08:12:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34325",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34325#issuecomment-486817",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_486818.json:
```json
{
    "body": "So I have removed the previous method \"gen\" (rather useless and not natural) and renamed \"custom_gen\" to \"gen\".",
    "created_at": "2022-09-23T08:14:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34325",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34325#issuecomment-486818",
    "user": "chapoton"
}
```

So I have removed the previous method "gen" (rather useless and not natural) and renamed "custom_gen" to "gen".



---

archive/issue_comments_486819.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-23T10:15:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34325",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34325#issuecomment-486819",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_486820.json:
```json
{
    "body": "Thank you.\n\nDo we want to use `IntegerRange` rather than the more specific `NonNegativeIntegers()`? This would also make it different than `F_algebra` (not that they need to be the same).\n\nI think other than that, I would be happy to set a positive review (unless there are other changes you want to make).",
    "created_at": "2022-09-23T10:26:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34325",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34325#issuecomment-486820",
    "user": "tscrim"
}
```

Thank you.

Do we want to use `IntegerRange` rather than the more specific `NonNegativeIntegers()`? This would also make it different than `F_algebra` (not that they need to be the same).

I think other than that, I would be happy to set a positive review (unless there are other changes you want to make).



---

archive/issue_comments_486821.json:
```json
{
    "body": "Well, I want to exclude 0. No idea what nonnegative means, as always.",
    "created_at": "2022-09-23T11:45:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34325",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34325#issuecomment-486821",
    "user": "chapoton"
}
```

Well, I want to exclude 0. No idea what nonnegative means, as always.



---

archive/issue_comments_486822.json:
```json
{
    "body": "Ah, right. Duh. Then how about `PositiveIntegers()`?",
    "created_at": "2022-09-23T11:55:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34325",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34325#issuecomment-486822",
    "user": "tscrim"
}
```

Ah, right. Duh. Then how about `PositiveIntegers()`?



---

archive/issue_comments_486823.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-23T12:25:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34325",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34325#issuecomment-486823",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_486824.json:
```json
{
    "body": "Indeed, now using `PositiveIntegers`.\n\nI think I have no further changes to make.",
    "created_at": "2022-09-23T12:26:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34325",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34325#issuecomment-486824",
    "user": "chapoton"
}
```

Indeed, now using `PositiveIntegers`.

I think I have no further changes to make.



---

archive/issue_comments_486825.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-09-23T12:35:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34325",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34325#issuecomment-486825",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_486826.json:
```json
{
    "body": "Thanks. LGTM.",
    "created_at": "2022-09-23T12:35:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34325",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34325#issuecomment-486826",
    "user": "tscrim"
}
```

Thanks. LGTM.



---

archive/issue_comments_486827.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-09-27T22:27:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34325",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34325#issuecomment-486827",
    "user": "vbraun"
}
```

Resolution: fixed
