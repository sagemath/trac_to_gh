# Issue 34325: refactor multiple zeta values

Issue created by migration from https://trac.sagemath.org/ticket/34562

Original creator: chapoton

Original creation time: 2022-09-20 09:42:46

CC:  vdelecroix tscrim

This ticket mainly aims to separate the auxiliary F-algebra in another file.

This file implements a better custom-made F-algebra, with additional useful methods.




---

Comment by chapoton created at 2022-09-20 09:43:16

Changing status from new to needs_review.


---

Comment by chapoton created at 2022-09-20 09:43:16

New commits:


---

Comment by tscrim created at 2022-09-20 10:16:20

Some quick comments about the `F_algebra`:

- The element's `coefficients` should return the nonzero coefficients, but the current implementation has different behavior.
- There should be a `from_vector` method on the parent. This is useful for the linear algebra methods.
- The `NN` can be a little funky when it comes to lazy imports not resolving correctly (#16522). It would be better to use `NonNegativeIntegers()` unless you specifically are looking for the algebraic aspects.
- Is there a reason why you are nailing `Indices` in the module level memory? It seems like the `str_to_index` is better as a method of the `F_algebra` and then you could access it by `self._indices` there (or `self.parent()._indices`).
- Instead of the recursive `basis_f_odd_iterator`, is it faster to use the iterators from `WeightedIntegerVectors` and `Permutations_mset` (which operate on lists)? It is a slightly more involved implementation, but I don't know how important speed is here.
- For the `product_on_basis`, it might be faster to do `self.sum()` since it works with the elements directly and has less transient elements.


---

Comment by git created at 2022-09-20 11:50:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-21 07:06:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2022-09-21 07:07:42

Hello,

thanks a lot for the suggestions !

> - The element's `coefficients` should return the nonzero coefficients, but the current implementation has different behavior.

ok, done by removing the wrong alias that I had added.

> - There should be a `from_vector` method on the parent. This is useful for the linear algebra methods.

well, the difficulty is that it only makes sense for homogeneous elements, and the usual "from_vector" methods does not take the degree as input

> - The `NN` can be a little funky when it comes to lazy imports not resolving correctly (#16522). It would be better to use `NonNegativeIntegers()` unless you specifically are looking for the algebraic aspects.

I substituted that for NN and it works fine.

> - Is there a reason why you are nailing `Indices` in the module level memory? It seems like the `str_to_index` is better as a method of the `F_algebra` and then you could access it by `self._indices` there (or `self.parent()._indices`).

I would rather keep "str_to_index" as an independant auxiliary function. Why is it problematic to have Indices at the module level ? oh, I guess it will have to be initiated when the module is loaded..

> - Instead of the recursive `basis_f_odd_iterator`, is it faster to use the iterators from `WeightedIntegerVectors` and `Permutations_mset` (which operate on lists)? It is a slightly more involved implementation, but I don't know how important speed is here.

Not sure how to achieve "words of any length in odd integers at least 3 with sum n" using the existing tools. And speed generally matters in this file, indeed.

> - For the `product_on_basis`, it might be faster to do `self.sum()` since it works with the elements directly and has less transient elements.

I have not yet checked that last suggestion.


---

Comment by git created at 2022-09-21 07:22:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-21 07:37:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2022-09-21 09:31:40

Replying to [comment:5 Frédéric Chapoton]:
> thanks a lot for the suggestions !

Thank you for all your work on Sage.

> > - There should be a `from_vector` method on the parent. This is useful for the linear algebra methods.
> 
> well, the difficulty is that it only makes sense for homogeneous elements, and the usual "from_vector" methods does not take the degree as input

I see. This breaks the `CFM.from_vector(v.to_vector()) == v` loop though (although that is more for finite dimensional modules). Perhaps we could rename this here to `homogeneous_to_vector()` to make it more future-proof (if we implement a generic infinite dimensional version someday)?

> > - Is there a reason why you are nailing `Indices` in the module level memory? It seems like the `str_to_index` is better as a method of the `F_algebra` and then you could access it by `self._indices` there (or `self.parent()._indices`).
> 
> I would rather keep "str_to_index" as an independant auxiliary function. Why is it problematic to have Indices at the module level ? oh, I guess it will have to be initiated when the module is loaded..

Subsequently it effectively gets nailed in memory. It's fairly lightweight (and only one of them), so its not a problem, but it still is something that gets carried around.

Also, you shouldn't need to set `self._indices = Indices`; that should be done by the `CFM.__init__()`.

> > - Instead of the recursive `basis_f_odd_iterator`, is it faster to use the iterators from `WeightedIntegerVectors` and `Permutations_mset` (which operate on lists)? It is a slightly more involved implementation, but I don't know how important speed is here.
> 
> Not sure how to achieve "words of any length in odd integers at least 3 with sum n" using the existing tools. And speed generally matters in this file, indeed.

If speed matters, then perhaps we should just Cythonize the file. It would allow you to replace the `self.parent()` with `self._parent`, which is faster.

Perhaps iterating over the indices is not such an important operation for speed. Although it might be best to use lightweight classes (e.g., `tuple`) and implement shuffling without using the heavy `ShuffleProduct_w1w2` parent class. This becomes something like

```python
    def shuffle(t1, t2):
        n1 = len(t1)
        n2 = len(t2)
        for iv in IntegerVectors(n1, n1 + n2, max_part=1): # can probably even make this iterator smarter
            it1 = iter(t1)
            it2 = iter(t2)
            yield tuple([next(it1) if v else next(it2) for v in iv])
```


> > - For the `product_on_basis`, it might be faster to do `self.sum()` since it works with the elements directly and has less transient elements.
> 
> I have not yet checked that last suggestion.

Your changes look like they should be faster. Even more so if we can make the indices involve less transient objects and/or checks.


---

Comment by git created at 2022-09-21 11:18:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-21 13:59:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-22 08:02:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-22 12:46:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-22 12:55:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2022-09-22 18:57:31

I guess it is now ready for review again.


---

Comment by chapoton created at 2022-09-22 19:22:39

maybe one should simplify (in F_algebra) the double method "gen" versus "custom_gen" ?


---

Comment by tscrim created at 2022-09-23 07:21:22

It does look a bit weird to have both `gen` and `custom_gen`. Is there a reason to have both? Perhaps it could be a little better with a different name than `custom_gen`? I am not sure what a good name might be though.


---

Comment by git created at 2022-09-23 08:12:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2022-09-23 08:14:21

So I have removed the previous method "gen" (rather useless and not natural) and renamed "custom_gen" to "gen".


---

Comment by git created at 2022-09-23 10:15:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2022-09-23 10:26:22

Thank you.

Do we want to use `IntegerRange` rather than the more specific `NonNegativeIntegers()`? This would also make it different than `F_algebra` (not that they need to be the same).

I think other than that, I would be happy to set a positive review (unless there are other changes you want to make).


---

Comment by chapoton created at 2022-09-23 11:45:47

Well, I want to exclude 0. No idea what nonnegative means, as always.


---

Comment by tscrim created at 2022-09-23 11:55:11

Ah, right. Duh. Then how about `PositiveIntegers()`?


---

Comment by git created at 2022-09-23 12:25:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2022-09-23 12:26:06

Indeed, now using `PositiveIntegers`.

I think I have no further changes to make.


---

Comment by tscrim created at 2022-09-23 12:35:38

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2022-09-23 12:35:38

Thanks. LGTM.


---

Comment by vbraun created at 2022-09-27 22:27:54

Resolution: fixed
