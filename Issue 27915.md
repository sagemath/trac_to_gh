# Issue 27915: Planar graph layout does not respect clockwise ordering of neighbors in combinatorial embedding

Issue created by migration from https://trac.sagemath.org/ticket/28152

Original creator: rburing

Original creation time: 2019-07-10 09:43:27

Keywords: graph,planar,clockwise,embedding

Consider the claw S<sub>3</sub>:


```
S3 = Graph([[0,1,2,3],[[0,1],[0,2],[0,3]]])
```


The following combinatorial embedding is respected in the planar layout (the neighbors are in the given clockwise order):


```
S3.set_embedding({0: [1,2,3], 1: [0], 2: [0], 3: [0]})
S3.layout('planar', save_pos=True)
S3.show()
```


While this one isn't:


```
S3.set_embedding({0: [3,2,1], 1: [0], 2: [0], 3: [0]})
S3.layout('planar', save_pos=True)
S3.show()
```


In the latter, the neighbors are in the _counter_clockwise order (in fact the picture is the same as the former).

Strictly speaking, `layout_planar` (which is called by `layout`) does not promise to use the combinatorial embedding. But it does provide an option `on_embedding` which I assume should allow this:


```
S3.set_pos(S3.layout_planar(on_embedding={0: [3,2,1], 1: [0], 2: [0], 3: [0]}))
```


Still, the combinatorial embedding is not respected. I think this is because in `layout_planar` the line `G.is_planar(set_embedding=True)` executed unconditionally (totally ignoring `on_embedding`).


---

Comment by @hensc created at 2019-07-15 00:05:11

Changing status from new to needs_review.


---

Comment by @hensc created at 2019-07-15 00:05:11

New commits:


---

Comment by dcoudert created at 2019-07-15 02:38:52

A few stylistic comments. Recall that comments must be in 80 columns mode and that we do our best to follow the [pep8](https://www.python.org/dev/peps/pep-0008) conventions.


```diff
-        TESTS::
-
-            Check the dependence of the computed position on the given
-            combinatorial embedding (:trac:`28152`).
+        TESTS:
+
+        Check the dependence of the computed position on the given
+        combinatorial embedding (:trac:`28152`)::
```



```diff
-    all triangles, and return the set of newly created edges. Also comb_emb
+    all triangles, and return the set of newly created edges. Also ``comb_emb``
```


pep8

```diff
-            comb_emb[w].insert(comb_emb[w].index(x),u)
-            comb_emb[u].insert(comb_emb[u].index(v),w)
+            comb_emb[w].insert(comb_emb[w].index(x), u)
+            comb_emb[u].insert(comb_emb[u].index(v), w)
```


80 columns mode

```diff
-    # Up to this point we did not take the order of the external face into account.
-    # Since the combinatorial embedding of a triangulated is only unique up to
-    # the choice of the outer face and reflection, this might lead to a reflection
-    # of the Schnyder drawing resulting from this labeling which is not conformal
-    # with comb_emb any longer. Therefore, we might have to swap the labels 1 and 2.
+    # Up to this point we did not take the order of the external face into
+    # account. Since the combinatorial embedding of a triangulation is unique
+    # up to the choice of the outer face and reflection, this might lead
+    # to a reflection of the Schnyder drawing resulting from this labeling which
+    # is not conformal with comb_emb any longer. Therefore, we might have to
+    # swap the labels 1 and 2.
```

I also did minor changes in above text. Please check.

Passes all tests with py3. I have not fully tested yet de functionality.


---

Comment by chapoton created at 2019-07-15 06:32:44

one failing doctest in src/sage/graphs/planarity.pyx, see patchbot report


---

Comment by chapoton created at 2019-07-15 09:09:34

Changing status from needs_review to needs_work.


---

Comment by rburing created at 2019-07-15 09:42:55

Thanks for the effort so far. I suggest also to add a line of documentation, at least in `layout_planar`, explaining which combinatorial embedding is used when, e.g. "If `on_embedding` is provided then that combinatorial embedding is used for the layout. Otherwise: if a combinatorial embedding is set (e.g. using `set_embedding`) then that one is used, and if no combinatorial embedding is set then one is computed." (modify it to make it a true statement).


---

Comment by git created at 2019-07-15 10:36:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-15 10:42:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-15 10:46:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-18 19:49:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @hensc created at 2019-07-18 19:49:36

Changing status from needs_work to needs_review.


---

Comment by @hensc created at 2019-07-18 20:00:29

I fixed the pep8 and also fixed the bug that made the doctest fail.
Now the patchbot passed all tests.

I also made the documentation more precise about which combinatorial embedding is used. But unfortunately it is not as rburing thought (and I think to be more intuitive, too) that `on_embedding` is always used if it is given. If `set_embedding` is set to `True`, then `on_embedding` is ignored. So the question is if we could/should/want to change this behavior.


---

Comment by git created at 2019-07-21 09:00:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-30 10:11:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @hensc created at 2019-08-02 23:11:56

please review


---

Comment by dcoudert created at 2019-08-04 13:09:39

I have only a minor comment. Otherwise seems ok.

```diff
-            for (v,w) in labels[u]:
-                if labels[u][(v,w)] == 1:
-                    labels[u][(v,w)] = 2
-                elif labels[u][(v,w)] == 2:
-                    labels[u][(v,w)] = 1
+            for v, w in labels[u]:
+                if labels[u][v, w] == 1:
+                    labels[u][v, w] = 2
+                elif labels[u][v, w] == 2:
+                    labels[u][v, w] = 1
```



---

Comment by git created at 2019-08-05 12:44:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2019-08-05 16:05:47

OK, LGTM.


---

Comment by dcoudert created at 2019-08-05 16:05:47

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-08-08 21:24:33

Resolution: fixed
