# Issue 29939: Update matplotlib to 3.3

Issue created by migration from https://trac.sagemath.org/ticket/30176

Original creator: arojas

Original creation time: 2020-07-19 20:42:55

CC:  jhpalmieri fbissey mkoeppe @timokau egourgoulhon arojas @zlscherr




---

Comment by git created at 2020-07-19 20:45:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-19 21:03:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2020-07-19 21:10:50

Changing component from PLEASE CHANGE to packages: standard.


---

Comment by arojas created at 2020-07-19 21:10:50

Changing type from PLEASE CHANGE to enhancement.


---

Comment by arojas created at 2020-07-19 21:13:29

Still 3 test failures, all looking like

```
File "/usr/lib/python3.8/site-packages/sage/geometry/polyhedron/plot.py", line 1030, in sage.geometry.polyhedron.plot.Projection.render_2d
Failed example:
    q1.plot() + q2.plot() + q3.plot() + q4.plot()
Expected:
    Graphics object consisting of 17 graphics primitives
Got:
    doctest:warning
      File "/usr/bin/sage-runtests", line 177, in <module>
        err = DC.run()
      File "/usr/lib/python3.8/site-packages/sage/doctest/control.py", line 1196, in run
        self.run_doctests()
      File "/usr/lib/python3.8/site-packages/sage/doctest/control.py", line 897, in run_doctests
        self.dispatcher.dispatch()
      File "/usr/lib/python3.8/site-packages/sage/doctest/forker.py", line 2038, in dispatch
        self.parallel_dispatch()
      File "/usr/lib/python3.8/site-packages/sage/doctest/forker.py", line 1933, in parallel_dispatch
        w.start()  # This might take some time
      File "/usr/lib/python3.8/site-packages/sage/doctest/forker.py", line 2205, in start
        super(DocTestWorker, self).start()
      File "/usr/lib/python3.8/multiprocessing/process.py", line 121, in start
        self._popen = self._Popen(self)
      File "/usr/lib/python3.8/multiprocessing/context.py", line 224, in _Popen
        return _default_context.get_context().Process._Popen(process_obj)
      File "/usr/lib/python3.8/multiprocessing/context.py", line 277, in _Popen
        return Popen(process_obj)
      File "/usr/lib/python3.8/multiprocessing/popen_fork.py", line 19, in __init__
        self._launch(process_obj)
      File "/usr/lib/python3.8/multiprocessing/popen_fork.py", line 75, in _launch
        code = process_obj._bootstrap(parent_sentinel=child_r)
      File "/usr/lib/python3.8/multiprocessing/process.py", line 315, in _bootstrap
        self.run()
      File "/usr/lib/python3.8/site-packages/sage/doctest/forker.py", line 2177, in run
        task(self.options, self.outtmpfile, msgpipe, self.result_queue)
      File "/usr/lib/python3.8/site-packages/sage/doctest/forker.py", line 2506, in __call__
        doctests, extras = self._run(runner, options, results)
      File "/usr/lib/python3.8/site-packages/sage/doctest/forker.py", line 2552, in _run
        result = runner.run(test)
      File "/usr/lib/python3.8/site-packages/sage/doctest/forker.py", line 905, in run
        return self._run(test, compileflags, out)
      File "/usr/lib/python3.8/site-packages/sage/doctest/forker.py", line 707, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.8/site-packages/sage/doctest/forker.py", line 1131, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.geometry.polyhedron.plot.Projection.render_2d[8]>", line 1, in <module>
        q1.plot() + q2.plot() + q3.plot() + q4.plot()
      File "/usr/lib/python3.8/site-packages/sage/repl/rich_output/display_manager.py", line 811, in displayhook
        plain_text, rich_output = self._rich_output_formatter(obj, dict())
      File "/usr/lib/python3.8/site-packages/sage/repl/rich_output/display_manager.py", line 625, in _rich_output_formatter
        rich_output = self._call_rich_repr(obj, rich_repr_kwds)
      File "/usr/lib/python3.8/site-packages/sage/repl/rich_output/display_manager.py", line 590, in _call_rich_repr
        warnings.warn(
      File "/usr/lib/python3.8/warnings.py", line 109, in _showwarnmsg
        sw(msg.message, msg.category, msg.filename, msg.lineno,
    :
    sage.repl.rich_output.display_manager.RichReprWarning: Exception in _rich_repr_ while displaying object: The first element of 'code' must be equal to 'MOVETO' (1).  Your first code is 79
    Graphics object consisting of 17 graphics primitives
**********************************************************************
```



---

Comment by arojas created at 2020-07-20 13:09:54

Reported upstream: https://github.com/matplotlib/matplotlib/issues/17975


---

Comment by mkoeppe created at 2020-07-22 04:28:43

Upstream seems to have addressed it in https://github.com/matplotlib/matplotlib/pull/17982


---

Comment by git created at 2020-07-22 06:50:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-22 06:55:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2020-07-22 06:56:29

Changing status from new to needs_review.


---

Comment by arojas created at 2020-07-22 06:56:29

No more test failures on Arch -> needs review


---

Comment by mkoeppe created at 2020-07-22 07:06:22

Tests run at https://github.com/mkoeppe/sage/actions/runs/178114621


---

Comment by git created at 2020-07-22 11:13:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-23 05:04:06

Tests run at https://github.com/mkoeppe/sage/actions/runs/179391787


---

Comment by mkoeppe created at 2020-07-24 04:58:20

Fails on all platforms. For example https://github.com/mkoeppe/sage/runs/901333269

```
    error: Failed to download FreeType. Please download one of ['https://downloads.sourceforge.net/project/freetype/freetype2/2.6.1/freetype-2.6.1.tar.gz', 'https://download.savannah.gnu.org/releases/freetype/freetype-2.6.1.tar.gz'] and extract it into build/freetype-2.6.1 at the top-level of the source repository.
    Running setup.py install for matplotlib: finished with status 'error'
ERROR: Command errored out with exit status 1: /sage/local/bin/python3 -u -c 'import sys, setuptools, tokenize; sys.argv[0] = '"'"'/tmp/pip-req-build-_2y953_j/setup.py'"'"'; __file__='"'"'/tmp/pip-req-build-_2y953_j/setup.py'"'"';f=getattr(tokenize, '"'"'open'"'"', open)(__file__);code=f.read().replace('"'"'\r\n'"'"', '"'"'\n'"'"');f.close();exec(compile(code, __file__, '"'"'exec'"'"'))' --no-user-cfg install --record /tmp/pip-record-v8gxera1/install-record.txt --single-version-externally-managed --root /sage/local/var/tmp/sage/build/matplotlib-3.3.0.p0/inst --compile --install-headers /sage/local/var/tmp/sage/build/matplotlib-3.3.0.p0/inst/sage/local/include/python3.7m/matplotlib Check the logs for full command output.
Exception information:
Traceback (most recent call last):
  File "/sage/local/lib/python3.7/site-packages/pip/_internal/req/req_install.py", line 841, in install
    req_description=str(self.req),
  File "/sage/local/lib/python3.7/site-packages/pip/_internal/operations/install/legacy.py", line 86, in install
    raise LegacyInstallFailure
```



---

Comment by mkoeppe created at 2020-07-24 04:58:41

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-07-24 05:04:06

https://github.com/matplotlib/matplotlib/blob/v3.3.x/INSTALL.rst:
"By default ... Matplotlib downloads and builds its own copy of FreeType ... and uses its own copy of Qhull.
To force Matplotlib to use a copy of FreeType or Qhull already installed in your system, create a `setup.cfg` file ...."


---

Comment by arojas created at 2020-07-24 07:10:14

should we make qhull standard and build matplotlib against it?


---

Comment by mkoeppe created at 2020-07-24 15:51:13

Replying to [comment:17 arojas]:
> should we make qhull standard and build matplotlib against it?
+1


---

Comment by mkoeppe created at 2020-07-24 16:52:11

Of course, dealing with qhull is not very important and could be done on a follow up ticket. But the FreeType dependency needs to be fixed for this upgrade.


---

Comment by git created at 2020-07-24 20:39:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-24 20:45:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2020-07-24 20:45:42

Replying to [comment:19 mkoeppe]:
> Of course, dealing with qhull is not very important and could be done on a follow up ticket. But the FreeType dependency needs to be fixed for this upgrade.

It would also need cmake to become standard


---

Comment by arojas created at 2020-07-24 20:45:55

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2020-07-24 20:50:31

Replying to [comment:17 arojas]:
> should we make qhull standard and build matplotlib against it?

Why not just keep using matplotlib's version of qhull? Or conditionally do this if qhull is not available on the system?


---

Comment by mkoeppe created at 2020-07-24 20:52:14

Tests run at https://github.com/mkoeppe/sage/actions/runs/181664763


---

Comment by mkoeppe created at 2020-07-24 20:55:35

Replying to [comment:22 arojas]:
> Replying to [comment:19 mkoeppe]:
> > Of course, dealing with qhull is not very important and could be done on a follow up ticket. But the FreeType dependency needs to be fixed for this upgrade.
> 
> It would also need cmake to become standard

Is matplotlib using cmake now?


---

Comment by jhpalmieri created at 2020-07-24 20:56:18

Replying to [comment:26 mkoeppe]:
> Replying to [comment:22 arojas]:
> > Replying to [comment:19 mkoeppe]:
> > > Of course, dealing with qhull is not very important and could be done on a follow up ticket. But the FreeType dependency needs to be fixed for this upgrade.
> > 
> > It would also need cmake to become standard
> 
> Is matplotlib using cmake now?

No, qhull uses it, or at least our spkg does.


---

Comment by fbissey created at 2020-07-24 20:56:31

Replying to [comment:26 mkoeppe]:
> Replying to [comment:22 arojas]:
> > Replying to [comment:19 mkoeppe]:
> > > Of course, dealing with qhull is not very important and could be done on a follow up ticket. But the FreeType dependency needs to be fixed for this upgrade.
> > 
> > It would also need cmake to become standard
> 
> Is matplotlib using cmake now?

qhull is.


---

Comment by fbissey created at 2020-07-24 21:00:21

Replying to [comment:24 jhpalmieri]:
> Replying to [comment:17 arojas]:
> > should we make qhull standard and build matplotlib against it?
> 
> Why not just keep using matplotlib's version of qhull? Or conditionally do this if qhull is not available on the system?
> 

Unbundling is considered a good thing in general. About `qhull`, being able to use an external version of it in matplotlib has flip-floped. It wasn't possible in some previous releases. Matplotlib is the only package currently using qhull so I am not considering it a priority. If there were more of them, that would be more of a motivation.


---

Comment by jhpalmieri created at 2020-07-24 21:02:51

Although the [most recent qhull](http://www.qhull.org/download/qhull-2020-src-8.0.0.tgz) may not require `cmake`. It comes with a `Makefile`, but I am not necessarily the best person to evaluate whether it can be used in place of building with `cmake`.


---

Comment by mkoeppe created at 2020-07-25 18:26:01

Replying to [comment:25 mkoeppe]:
> Tests run at https://github.com/mkoeppe/sage/actions/runs/181664763

This looks clean on all platforms.

I think it would be better if the changed multigraphics doctest was adjusted to be more tolerant instead of just updating the result.

Nevertheless, a positive review from my side.


---

Comment by mkoeppe created at 2020-07-25 18:26:01

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-07-27 20:37:16

There is numerical noise on various buildbots, e.g.

```
**********************************************************************
File "src/sage/plot/multigraphics.py", line 1297, in sage.plot.multigraphics.GraphicsArray.position
Failed example:
    G.position(0)  # tol 1.0e-13
Expected:
    (0.025045451349937315,
     0.03415488992713045,
     0.4489880779745068,
     0.9345951100728696)
Got:
    (0.02494779509993732,
     0.03415488992713045,
     0.44913456234950677,
     0.9345951100728696)
Tolerance exceeded in 2 of 4:
    0.025045451349937315 vs 0.02494779509993732, tolerance 4e-3 > 1e-13
    0.4489880779745068 vs 0.44913456234950677, tolerance 4e-4 > 1e-13
**********************************************************************
File "src/sage/plot/multigraphics.py", line 1302, in sage.plot.multigraphics.GraphicsArray.position
Failed example:
    G.position(1)  # tol 1.0e-13
Expected:
    (0.5170637412999687,
     0.20212705964722733,
     0.4489880779745068,
     0.5986507706326758)
Got:
    (0.5170149131749686,
     0.20202940339722741,
     0.44913456234950666,
     0.5988460831326756)
Tolerance exceeded in 4 of 4:
    0.5170637412999687 vs 0.5170149131749686, tolerance 1e-4 > 1e-13
    0.20212705964722733 vs 0.20202940339722741, tolerance 5e-4 > 1e-13
    0.4489880779745068 vs 0.44913456234950666, tolerance 4e-4 > 1e-13
    0.5986507706326758 vs 0.5988460831326756, tolerance 4e-4 > 1e-13
**********************************************************************
1 item had failures:
   2 of   6 in sage.plot.multigraphics.GraphicsArray.position
    [192 tests, 2 failures, 20.75 s]
----------------------------------------------------------------------
sage -t --long --random-seed=0 src/sage/plot/multigraphics.py  # 2 doctests failed
----------------------------------------------------------------------
```



---

Comment by vbraun created at 2020-07-27 20:37:16

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2020-07-27 20:37:54


```
**********************************************************************
File "src/sage/plot/multigraphics.py", line 1297, in sage.plot.multigraphics.GraphicsArray.position
Failed example:
    G.position(0)  # tol 1.0e-13
Expected:
    (0.025045451349937315,
     0.03415488992713045,
     0.4489880779745068,
     0.9345951100728696)
Got:
    (0.02494779509993732,
     0.03415488992713045,
     0.44913456234950677,
     0.9345951100728696)
Tolerance exceeded in 2 of 4:
    0.025045451349937315 vs 0.02494779509993732, tolerance 4e-3 > 1e-13
    0.4489880779745068 vs 0.44913456234950677, tolerance 4e-4 > 1e-13
**********************************************************************
File "src/sage/plot/multigraphics.py", line 1302, in sage.plot.multigraphics.GraphicsArray.position
Failed example:
    G.position(1)  # tol 1.0e-13
Expected:
    (0.5170637412999687,
     0.20212705964722733,
     0.4489880779745068,
     0.5986507706326758)
Got:
    (0.5170149131749686,
     0.20202940339722741,
     0.44913456234950666,
     0.5988460831326756)
Tolerance exceeded in 4 of 4:
    0.5170637412999687 vs 0.5170149131749686, tolerance 1e-4 > 1e-13
    0.20212705964722733 vs 0.20202940339722741, tolerance 5e-4 > 1e-13
    0.4489880779745068 vs 0.44913456234950666, tolerance 4e-4 > 1e-13
    0.5986507706326758 vs 0.5988460831326756, tolerance 4e-4 > 1e-13
**********************************************************************
1 item had failures:
   2 of   6 in sage.plot.multigraphics.GraphicsArray.position
    [192 tests, 2 failures, 27.84 s]
----------------------------------------------------------------------
sage -t --long --random-seed=0 src/sage/plot/multigraphics.py  # 2 doctests failed
----------------------------------------------------------------------
```



---

Comment by git created at 2020-08-01 08:24:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2020-08-01 08:24:30

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2020-08-06 21:45:52


```
**********************************************************************
File "src/sage/plot/multigraphics.py", line 1297, in sage.plot.multigraphics.GraphicsArray.position
Failed example:
    G.position(0)  # tol 1.0e-3
Expected:
    (0.025045451349937315,
     0.03415488992713045,
     0.4489880779745068,
     0.9345951100728696)
Got:
    (0.02494779509993732,
     0.03415488992713045,
     0.44913456234950677,
     0.9345951100728696)
Tolerance exceeded in 1 of 4:
    0.025045451349937315 vs 0.02494779509993732, tolerance 4e-3 > 1e-3
**********************************************************************
1 item had failures:
   1 of   6 in sage.plot.multigraphics.GraphicsArray.position
    [192 tests, 1 failure, 33.68 s]
----------------------------------------------------------------------
sage -t --long --random-seed=0 src/sage/plot/multigraphics.py  # 1 doctest failed
----------------------------------------------------------------------
```



---

Comment by vbraun created at 2020-08-06 21:45:52

Changing status from positive_review to needs_work.


---

Comment by git created at 2020-08-07 09:15:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2020-08-07 09:16:09

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2020-08-09 08:47:29

Resolution: fixed


---

Comment by kcrisman created at 2020-12-15 14:03:48

Hi!  Is it possible that this change is responsible for the difference between the following two images?

* [This one](https://opentext.uleth.ca/apex-standard/images/img_sketch1c.svg)
* [This one](https://16913697885453631822.googlegroups.com/attach/9538235d19b10/img_sketch1c.svg?part=0.1&view=1&vt=ANaJVrGjnIDaV7eWDiVRwnImxBhO2LClXYxNTLe-9OBHaeiSulY6a_0WItVZbBtUH76EEqwIZs-vqF9NnF32b0k-n7sqwgiDzZCMRpJakCI4j8a_n1BfLJU)

Notice that not only is the image slightly narrower, but the labels now all have default of one place beyond the decimal point, which in the past was not desired for the evident reasons we see here.  That might be good for scientific plotting, but not for mathematical plotting.


---

Comment by kcrisman created at 2020-12-15 14:08:02

(Note that [this explanation of the difference](https://matplotlib.org/2.0.0/examples/pylab_examples/newscalarformatter_demo.html) doesn't really seem to have any examples relevant to this situation.)


---

Comment by mkoeppe created at 2021-01-02 20:14:50

Follow-up on qhull in #31148
