# Issue 24913: Eliminate dependence on VERSION.txt within Sage

Issue created by migration from https://trac.sagemath.org/ticket/25150

Original creator: embray

Original creation time: 2018-04-12 10:09:28

CC:  fbissey jdemeyer vbraun

As discussed on #25056, that ticket introduced a small, but annoying runtime dependency on a file that lives in `$SAGE_ROOT`, `VERSION.txt`, which creates problems for downstream distributions.

This proposes to eliminate practically all dependence on `VERSION.txt`, by instead writing the same string to a new variable `SAGE_VERSION_FULL` which is stored in both `src/bin/sage-version.sh` and `src/sage/version.py`.  Although mildly redundant, this is at least consistent.

Originally I thought to just outright remove `VERSION.txt` since at this point it is not used directly anywhere in sagelib or sage-the-distribution. However, there are probably various external utilities that look for that file--I can confirm that the patchbot is one such utility, if nothing else.  But there are likely others.  So it's harmless to keep it.


---

Comment by embray created at 2018-04-12 10:13:46

Changing status from new to needs_review.


---

Comment by git created at 2018-04-12 10:25:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2018-04-12 11:40:50

Why "blocker"? My gut feeling says that this ticket has a non-trivial chance of breaking stuff, so it should be treated as a normal ticket for Sage 8.3.


---

Comment by embray created at 2018-04-12 11:49:15

Because we don't want to add an additional annoyance to Sage 8.2 for downstream packagers that they'll have to work around, only to remove that workaround for the next version.  It's a simple change we can make now so why not?


---

Comment by fbissey created at 2018-04-12 11:55:36

For the record I have already worked around. I am not exactly convinced by the content of this ticket either. Admittedly some things have to be considered carefully, and I can see due diligence in action.


---

Comment by embray created at 2018-04-12 11:56:15

It doesn't break anything. VERSION.txt is a completely static file shipped in the Sage sources, generated by `sage-update-version`--nothing is changed about that.  Within Sage itself it's used in just three minor places to get...a string: `build/make/install` (badly--it should use `sage-version.sh` instead which it now does).  `src/bin/sage` (as added in #25056 in a less than ideal manner), and in a trivial way in `src/bin/sage-start`.


---

Comment by embray created at 2018-04-12 11:56:53

Replying to [comment:6 fbissey]:
> For the record I have already worked around. I am not exactly convinced by the content of this ticket either. Admittedly some things have to be considered carefully, and I can see due diligence in action.

You may have, but not Debian (which, granted, is in a state of limbo right now, but something we are hoping to fix), and conda at a minimum.


---

Comment by vbraun created at 2018-04-16 22:38:46

Conflicts... 

Also, we should probably fix this properly instead of a last-minute effort that may or may not improve things.


---

Comment by vbraun created at 2018-04-16 22:38:46

Changing priority from blocker to major.


---

Comment by embray created at 2018-04-17 16:03:54

I would say this is "properly"...


---

Comment by git created at 2018-04-17 16:06:19

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-04-17 16:08:39

Changing priority from major to blocker.


---

Comment by embray created at 2018-04-17 16:08:39

Please properly review this ticket.  It fixes an issue that was introduced in development by #25056 and is problematic for non-source-based Sage installs (~~including on Windows~~ it's not actually a problem here after all since I do install VERSION.txt; however, we should not be introducing known regressions at the last minute if we can easily fix them).  The fix was carefully considered and tested, but all you're telling me is that's "not proper" based on a "gut feeling".


---

Comment by jdemeyer created at 2018-04-17 20:55:12

I'll leave it to Volker to decide on the blocker status.

The reason for my "git feeling" is that tickets touching the build system have a tendency to introduce subtle breakage. And this isn't a simple bug-fix either, it's really adding new functionality.


---

Comment by fbissey created at 2018-04-17 21:54:02

I don't think `$SAGE_LOCAL/bin` is a good place for `sage-version.sh` but this is a matter in some other tickets. I was mainly surprised by the extents of the changes wrought by this ticket and the fact there is still a mention of `SAGE_ROOT` - but I should never take that branch so it's probably OK. There is stuff all over the place where I did not expect it. 

As Jeroen says it touches bits of the build system, while I don't expect any problem (and sage-on-gentoo doesn't really care) I understand him being worried about it.

At the end of the day, I'll probably patch less than before with this ticket.


---

Comment by vbraun created at 2018-04-17 22:50:11

Our existing implementation is far from ideal, but I also don't see a real improvement in this patch.

The way it should be is: there is a version py and sh file, for import/source in python and shell scripts. There shouldn't be python scripts looking at environment variables that where set elsewhere.

There should be some mechanism to check that `SAGE_ROOT` is not being used outside of the build system so this doesn't happen again, and that is not in the attached branch.


---

Comment by klee created at 2018-04-18 04:54:10

VERSION_FULL is actually a banner. So how about this change?

VERSION_FULL --> VERSION_BANNER


---

Comment by git created at 2018-04-18 14:03:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-04-18 14:06:01

Replying to [comment:14 fbissey]:
> I don't think `$SAGE_LOCAL/bin` is a good place for `sage-version.sh` but this is a matter in some other tickets. I was mainly surprised by the extents of the changes wrought by this ticket and the fact there is still a mention of `SAGE_ROOT` - but I should never take that branch so it's probably OK. There is stuff all over the place where I did not expect it. 

The only "mention of `SAGE_ROOT`" is as an alternative "$SAGE_LOCAL/bin/sage-version.sh" if it does not exist.

I agree that's not a great place for that file, but it's where it already existed.  I don't know what you do with it on gentoo (though having it there isn't the worst place for it).  I think I would rather do away with `sage-version.sh` and instead put that info in `sage-env-config`, but I was trying to keep this change as undisruptive as possible.

Which is why, while I'm sorry to make a fight over this, I just feel like it's a little unfair to unilaterally brush it off without due consideration, especially since it was only to address a legitimate complaint of a regression for downstream packagers.  I considered this change and its impact carefully. I don't necessarily expect anyone to take my word for that, but at least do me the same consideration.

I'll also note that at the very least [d87fd38c](https://git.sagemath.org/sage.git/commit/?id=d87fd38c91318ef231c9b0764d37fbac31389db3) is now necessary for the tests to pass on Docker.  We force `SAGE_BANNER=bare` on Docker due to a bug in Docker (I think now fixed, but still in older versions), and this test as written was assuming the default value of `SAGE_BANNER`.


---

Comment by embray created at 2018-04-18 14:14:29

Replying to [comment:15 vbraun]:
> Our existing implementation is far from ideal, but I also don't see a real improvement in this patch.
> 
> The way it should be is: there is a version py and sh file, for import/source in python and shell scripts. There shouldn't be python scripts looking at environment variables that where set elsewhere.
> 
> There should be some mechanism to check that `SAGE_ROOT` is not being used outside of the build system so this doesn't happen again, and that is not in the attached branch.

+1 to all of the above in principle.  However, you'll see in this branch that it actually eliminates several uses of `$SAGE_ROOT`, and leaves only one in the `sage` script, and only as a fallback if `$SAGE_LOCAL/bin/sage-version.sh` does not exist yet.  I agree that's still not ideal, but also somewhat necessary since currently the `sage` script serves as an entrypoint to runtime capabilities of Sage, and to the "build system" (a fact I've complained about in #25130).

The goal there was that at the very least, running `./sage --version` should work the same whether in a fresh clone of the repository (though that's actually already broken at the moment for unrelated reasons), or running some binary release with no `$SAGE_ROOT`.


---

Comment by git created at 2018-04-18 14:20:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-04-18 14:21:06

Replying to [comment:16 klee]:
> VERSION_FULL is actually a banner. So how about this change?
> 
> VERSION_FULL --> VERSION_BANNER

Yeah, I think I agree with that.


---

Comment by git created at 2018-04-18 14:26:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-04-18 14:27:35

The only problem with `SAGE_VERSION_BANNER` is it's potentially confusable with `SAGE_BANNER`.  But I think that's not a problem so long as it's kept undocumented, for internal use.


---

Comment by embray created at 2018-04-18 14:59:12

If this ticket is too much trouble, as a compromise we can at least merge [d87fd38c](https://git.sagemath.org/sage.git/commit/?id=d87fd38c91318ef231c9b0764d37fbac31389db3) which is actually a (possible) test regression introduced by #25056, and actually caught by the patchbot but we ignored it.

I'd also appreciate an alternate fix the issue raised in this ticket that would be more acceptable, but if I'm the only one who cares then don't worry about it I guess.


---

Comment by vbraun created at 2018-04-18 23:25:53

I'm fine with just d87fd38c; I'd prefer not to merge the entire ticket for 8.2; distro packagers either have the issue already patched, can do it easily enough, or can wait until 8.3


---

Comment by embray created at 2018-04-19 11:52:01

I still don't see what the big deal is, but okay.  I will downgrade this ticket it and make a separate one for the test fix.


---

Comment by embray created at 2018-04-19 11:52:17

Changing priority from blocker to critical.


---

Comment by saraedum created at 2018-04-21 19:33:21

Does this need review at the moment? I did not read through the entire discussion but it appears that this needs work first? Also, there are merge conflicts.


---

Comment by saraedum created at 2018-04-21 19:33:21

Changing status from needs_review to needs_work.


---

Comment by embray created at 2018-04-23 14:40:09

There is a merge conflict, since I guess Volker made another release (this ticket edits some files that are normally otherwise only changed during releases).  Otherwise, nobody has been able to provide particularly useful commentary on this ticket.


---

Comment by git created at 2018-04-23 14:43:15

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-04-23 14:43:47

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2018-04-24 01:11:20

I am actually OK with the ticket in this form. My last comment may not have been clear enough considering the answer I got from it. I am happy for it to move to the next stage.

However it is marked to merge in 8.3 and some bits will need rebasing as soon as 8.2 is released (version.py and version.sh) so I am bit concerned about changing to positive right now. But I approve of it.


---

Comment by saraedum created at 2018-05-14 15:14:55

Changing status from needs_review to needs_work.


---

Comment by saraedum created at 2018-05-14 15:14:55

there are merge conflicts.


---

Comment by git created at 2018-05-16 09:47:12

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-05-16 09:48:09

Rebased.  I still believe this to be better than the current situation, though I would welcome concrete feedback and/or criticism.


---

Comment by embray created at 2018-05-16 09:48:09

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2018-05-16 09:53:33

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2018-05-16 10:09:48

Why did you move sourcing of `sage-env` and handling of options like `--root` inside `src/bin/sage`?


---

Comment by jdemeyer created at 2018-05-16 10:09:48

Changing status from positive_review to needs_info.


---

Comment by embray created at 2018-05-16 15:34:59

Depending on how you read the diff, I didn't move it at all :)  At least, in terms of intent, what I was moving was:


```
if [ "$1" = '-dumpversion' -o "$1" = '--dumpversion' ]; then
        sage_version
        exit 0
fi

if [ "$1" = '-v' -o "$1" = '-version' -o "$1" = '--version' ]; then
        sage_version -v
        exit 0
fi

if [ "$1" = '-root'  -o "$1" = '--root' ]; then
    echo "$SAGE_ROOT"
    exit 0
fi

if [ $# -gt 0 ]; then
  if [ "$1" = '-h' -o "$1" = '-?' -o "$1" = '-help' -o "$1" = '--help' ]; then
     usage
  fi
  if [ "$1" = "-advanced" -o "$1" = "--advanced" ]; then
     usage_advanced
  fi
fi
```


which I felt should work even from a clean source checkout.  Previously these flags did not work in that case because sourcing sage-env would not work correctly.  In other words, from a clean source checkout you can now do:

`./sage --version`

`./sage --root`

and so on.


---

Comment by git created at 2018-05-31 09:57:23

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-05-31 09:57:54

Changing status from needs_info to needs_review.


---

Comment by embray created at 2018-05-31 09:57:54

Rebased again.


---

Comment by fbissey created at 2018-05-31 10:03:59

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2018-05-31 10:03:59

Let's try to get it in again.


---

Comment by vbraun created at 2018-06-01 15:42:12

Resolution: fixed
