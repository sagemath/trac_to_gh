# Issue 30343: sage_setup: Remove import-time dependency (`setup_requires`) on `pkgconfig`, `numpy`

Issue created by migration from https://trac.sagemath.org/ticket/30580

Original creator: mkoeppe

Original creation time: 2020-09-16 00:49:39

CC:  @tobiasdiez jhpalmieri fbissey dimpase

Just loading `src/setup.py` already pulls in Cython, `numpy`, and `pkgconfig` via `sage_setup`, so these distributions would have to be declared as `[build_system] requires` in `src/pyproject.toml` (ex `setup_requires`)

By moving some computations from import-time to runtime, we get rid of this dependency on `pkgconfig`, `numpy`.


---

Comment by git created at 2020-09-16 02:29:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-09-16 02:37:48

Changing priority from major to minor.


---

Comment by mkoeppe created at 2020-09-16 02:37:48

Changing status from new to needs_review.


---

Comment by git created at 2020-10-17 22:36:56

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-10-20 17:11:36

Ready for review.


---

Comment by dimpase created at 2020-11-07 08:34:08

the 1st line of the output seems to try to say something about `--version` I don't get:

```
$ python3 -u setup.py --no-user-cfg sdist >/tmp/res
/bin/sh: 1: --version: not found
distributions = ['']
warning: sdist: standard file not found: should have one of README, README.txt, README.rst

warning: no files found matching '*.hh' anywhere in distribution
...
```



---

Comment by mkoeppe created at 2020-11-07 17:41:00

Replying to [comment:9 dimpase]:
> the 1st line of the output seems to try to say something about `--version` I don't get:
> {{{
> $ python3 -u setup.py --no-user-cfg sdist >/tmp/res
> /bin/sh: 1: --version: not found

This is from `src/sage_setup/command/sage_build_cython.py`:

```
# Work around GCC-4.8 bug which miscompiles some sig_on() statements:
# * http://trac.sagemath.org/sage_trac/ticket/14460
# * http://trac.sagemath.org/sage_trac/ticket/20226
# * http://gcc.gnu.org/bugzilla/show_bug.cgi?id=56982
if subprocess.call("""$CC --version | grep -i 'gcc.* 4[.]8' >/dev/null """, shell=True) == 0:
    extra_compile_args.append('-fno-tree-copyrename')
```

This gives an (ignored) error when `CC` is not set -- this defect is not new in this ticket.


---

Comment by dimpase created at 2020-11-08 08:06:53

Do we need to support gcc 4.8 ? The last release of gcc 4.8.* was over 5 years ago.


---

Comment by dimpase created at 2020-11-08 15:06:56

lgtm - the gcc version could be bumped elsewhere


---

Comment by dimpase created at 2020-11-08 15:06:56

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-11-09 03:36:51

Replying to [comment:11 dimpase]:
> Do we need to support gcc 4.8 ? The last release of gcc 4.8.* was over 5 years ago.
Yes until we drop ubuntu trusty and similar.


---

Comment by mkoeppe created at 2020-11-09 03:40:52

Thanks for the review! I have opened #30876 for the issue with the unset `CC` environment variable.


---

Comment by vbraun created at 2020-11-29 12:00:40

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2020-11-29 12:00:40

Merge conflict


---

Comment by git created at 2020-11-29 18:59:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-11-29 19:00:27

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2020-12-06 12:49:08

Resolution: fixed
