# Issue 23378: Update pip to 9.0.1

Issue created by migration from https://trac.sagemath.org/ticket/23615

Original creator: mderickx

Original creation time: 2017-08-13 17:14:21

At #20913 pip was patched so that it works without ssl support, and this patch was also submitted upstream. Upstream has since merged the patch at ​https://github.com/pypa/pip/issues/1165 into 9.0.1. So it makes sense to upgrade pip to this new version in order to have an unpatched pip in sage.


---

Comment by mderickx created at 2017-08-13 19:06:15

New commits:


---

Comment by git created at 2017-08-14 04:15:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mderickx created at 2017-08-14 04:17:25

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2017-08-14 12:31:41

This looks very scary: `eval(stdout)`. If you want to parse JSON, I would recommend the [json module](https://docs.python.org/2/library/json.html).


---

Comment by jdemeyer created at 2017-08-14 12:31:41

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-08-14 16:26:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mderickx created at 2017-08-14 16:28:25

Yeah, I shouldn't have written that. Changed it into `json.loads(stdout)`.


---

Comment by mderickx created at 2017-08-14 16:28:25

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2017-08-14 18:23:39

Builds fine and passes tests for me on OS X. Note that on this machine, the `python2` log says that ssl is not built:

```
Python build finished, but the necessary bits to build these modules were not found:
_bsddb             _ssl               dl              
gdbm               imageop            linuxaudiodev   
ossaudiodev        spwd               sunaudiodev     
```

and `import ssl` raises an `ImportError`. So it's good that this new `pip` works.


---

Comment by jdemeyer created at 2017-08-15 13:07:46

Replying to [comment:8 jhpalmieri]:
> Builds fine and passes tests for me on OS X.

Build from scratch or just a regular upgrade? I'm going to test a build from scratch on Linux.


---

Comment by jhpalmieri created at 2017-08-15 14:36:21

Replying to [comment:9 jdemeyer]:
> Replying to [comment:8 jhpalmieri]:
> > Builds fine and passes tests for me on OS X.
> 
> Build from scratch or just a regular upgrade? I'm going to test a build from scratch on Linux.

Build from scratch.


---

Comment by jdemeyer created at 2017-08-23 08:18:01

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-09-02 09:33:59

Resolution: fixed


---

Comment by chapoton created at 2017-09-10 07:08:34

It seems that this breaks something with python3... :(

```
chapoton@icj-laptop:~/sage3$ ./sage -br
cd . && export                                    \
    SAGE_ROOT=/doesnotexist                               \
    SAGE_SRC=/doesnotexist                                \
    SAGE_SRC_ROOT=/doesnotexist                           \
    SAGE_DOC_SRC=/doesnotexist                            \
    SAGE_BUILD_DIR=/doesnotexist                          \
    SAGE_PKGS=/home/chapoton/sage3/build/pkgs                \
    SAGE_CYTHONIZED=/home/chapoton/sage3/src/build/cythonized      \
&& sage-python23 -u setup.py --no-user-cfg build install

Usage:   
  pip list [options]

no such option: --format
************************************************************************
Traceback (most recent call last):
  File "setup.py", line 69, in <module>
    from module_list import ext_modules, library_order, aliases
  File "/home/chapoton/sage3/src/module_list.py", line 166, in <module>
    from sage_setup.optional_extension import OptionalExtension
  File "/home/chapoton/sage3/src/sage_setup/optional_extension.py", line 24, in <module>
    all_packages = list_packages(local=True)
  File "/home/chapoton/sage3/src/sage/misc/package.py", line 226, in list_packages
    installed = installed_packages(exclude_pip)
  File "/home/chapoton/sage3/src/sage/misc/package.py", line 286, in installed_packages
    installed.update(pip_installed_packages())
  File "/home/chapoton/sage3/src/sage/misc/package.py", line 148, in pip_installed_packages
    return {package['name'].lower():package['version'] for package in json.loads(stdout)}
  File "/home/chapoton/sage3/local/lib/python3.6/json/__init__.py", line 354, in loads
    return _default_decoder.decode(s)
  File "/home/chapoton/sage3/local/lib/python3.6/json/decoder.py", line 339, in decode
    obj, end = self.raw_decode(s, idx=_w(s, 0).end())
  File "/home/chapoton/sage3/local/lib/python3.6/json/decoder.py", line 357, in raw_decode
    raise JSONDecodeError("Expecting value", s, err.value) from None
json.decoder.JSONDecodeError: Expecting value: line 1 column 1 (char 0)
************************************************************************
Error building the Sage library
************************************************************************
Makefile:34 : la recette pour la cible « sage » a échouée
make: *** [sage] Erreur 1
```



---

Comment by chapoton created at 2017-09-10 07:09:21

oh, wait a moment. I did not rebuild..


---

Comment by chapoton created at 2017-09-10 09:55:55

Apparently, this really did break the python3 build. I am not amused.


---

Comment by mderickx created at 2017-09-10 10:57:11

Hi Chapoton,

I would find it weird if this really did break the python3 build. The error message you posted is one that one would get if the installed pip is not actually 9.0.1:

For example on my machine with sage before this was merged

```
Maartens-MacBook-Pro:sagedev mderickx$ sage -pip -V
pip 8.1.2 from /Applications/sage/local/lib/python2.7/site-packages (python 2.7)
Maartens-MacBook-Pro:sagedev mderickx$ sage -pip list --format json

Usage:   
  pip list [options]

no such option: --format
```


and after it is merged


```
Maartens-MacBook-Pro:sagedev mderickx$ ./sage -pip -V
pip 9.0.1 from /Applications/sagedev/local/lib/python2.7/site-packages (python 2.7)
Maartens-MacBook-Pro:sagedev mderickx$ ./sage -pip list --format json
[{"version": "0.7.8", "name": "alabaster"}, ..., {"version": "4.2.0", "name": "zope.interface"}]
```


Could you give me the output of `sage -pip -V` and `ls $SAGE_ROOT/upstream | grep pip`?


---

Comment by mderickx created at 2017-09-10 11:02:18

A quick solution would be:


```
sage -pip uninstall pip
sage -i pip
```


This avoids doing:

```
make distclean
make install
```



---

Comment by chapoton created at 2017-09-10 11:07:35


```
chapoton@icj-laptop:~/sage3$ ./sage -pip -V
pip 9.0.1 from /home/chapoton/sage3/local/lib/python2.7/site-packages (python 2.7)
chapoton@icj-laptop:~/sage3$ ls upstream/pip*
upstream/pip-8.1.2.tar.gz  upstream/pip-9.0.1.tar.gz
chapoton@icj-laptop:~/sage3$ ./sage -pip list --format json
[{"version": "1.0.0", "name": "cypari2"}, {"version": "1.6.5", "name": "cysignals"}, {"version": "0.26", "name": "Cython"}, {"version": "9.0.1", "name": "pip"}, {"version": "33.1.1", "name": "setuptools"}]
```

so maybe this is a matter of pip versus pip3 ?

EDIT: in a sage shell, pip3 says version 9.0.1 too.


---

Comment by mderickx created at 2017-09-10 11:28:09

Weird, then the only possibility is that sage is picking up some pip from outside its installation.

Could you add the lines

```
proc = subprocess.Popen(["pip", "-V"], stdout=subprocess.PIPE)
stdout = str(proc.communicate()[0])
print(stdout)
```

before the lines:

```
proc = subprocess.Popen(["pip", "list", "--no-index", "--format", "json"], stdout=subprocess.PIPE)
     stdout = str(proc.communicate()[0])
```

in `src/sage/misc/package.py` in order to see which pip is being picked up at the point where the build fails?

Alternatively could you describe how to reproduce this error so I can look at it myself?


---

Comment by chapoton created at 2017-09-10 11:31:48

The result of the added print is 

```
b'pip 9.0.1 from /home/chapoton/sage3/local/lib/python2.7/site-packages (python 2.7)\n'
```

To reproduce, I think this is enough:

```
- git clone a new sage
- export SAGE_PYTHON3=yes
- make build
```



---

Comment by mderickx created at 2017-09-10 12:31:46

Ah I see the problem it is a unicode thing. If you do:

```
stdout = proc.communicate()[0].decode()
```

then everything should work. I will create a new ticket with a fix.


---

Comment by mderickx created at 2017-09-10 13:07:55

See #23822


---

Comment by chapoton created at 2018-08-16 10:14:57

I am hurt by all this again when going from sage 8.4.beta0 to 8.4.beta1.


---

Comment by jdemeyer created at 2018-08-16 10:18:04

Hurt by *what* again?


---

Comment by chapoton created at 2018-08-16 10:45:52

I got build failures for sagelib on the very same line

```
return {package['name'].lower():package['version'] for package in json.loads(stdout)}
```

but I have now realized that this is probably due to the existence of a personal "pip.conf".
