# Issue 34091: make sage.parallel.ncpus.ncpus() use os.cpu_count()

Issue created by migration from https://trac.sagemath.org/ticket/34328

Original creator: lorenz

Original creation time: 2022-08-10 05:30:31

Currently, `sage.parallel.ncpus.ncpus()` uses platform-specific code to determine the number of available CPUs for some specific systems. This functionality is now available in the standard `os` module as `cpu_count()`.


---

Comment by lorenz created at 2022-08-10 05:30:56

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2022-08-10 14:58:25

From https://docs.python.org/3/library/os.html#os.cpu_count it sounds like using `os.sched_getaffinity` would be a better choice when available. (It's not available on macOS.)


---

Comment by git created at 2022-08-23 02:13:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by lorenz created at 2022-08-23 02:20:10

Done.

However, here's an issue: In reality, the `ncpus()` function actually always returns `1` when `SAGE_NUM_THREADS` is not set. This is because `sage-num-threads.py`, which is called by `sage-env`, defaults to returning `1` if `SAGE_NUM_THREADS` isn't already in the environment.

Is this intentional? If yes: Should multi-threading really be disabled by default in 2022?


---

Comment by slelievre created at 2022-08-24 17:29:05

Previous discussions:

- #25779: sage.parallel.ncpus.ncpus() reports wrong number of cores
- #24937: `@`parallel only uses one thread if SAGE_NUM_THREADS is not set; ncpus is wrong
- #23713: Support SAGE_NUM_THREADS everywhere for parallellism
- [Ask Sage question 42439: `@`parallel: how to use all cpus](https://ask.sagemath.org/question/42439)
- [2019-03 sage-devel discussion: How would you like your parallel linear algebra?](https://groups.google.com/g/sage-devel/c/ZNcijpPhWuc)
- [2018-07 sage-devel discussion: How parallel should `@`parallel be?](https://groups.google.com/g/sage-devel/c/z45LTwQWxTc)

The three tickets above were revealed by this trac query:

- https://trac.sagemath.org/query?order=id&desc=1&summary=~ncpu

and the other discussions were linked to from one of them.

The documentation could clarify what choices were made and why.


---

Comment by mkoeppe created at 2022-08-24 17:35:15

Also #33317 Unify computation of number of parallel jobs
