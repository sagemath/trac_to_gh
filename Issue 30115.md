# Issue 30115: Interface to the KnotInfo and LinkInfo databases

Issue created by migration from https://trac.sagemath.org/ticket/30352

Original creator: soehms

Original creation time: 2020-08-14 07:01:25

CC:  mmarco mkoeppe fbissey

Keywords: knot, link, database

At the moment Sage offers just a small set of 250 named knots (`src/sage/knots/knot_table.py`) taken form the [Rolfsen table](http://katlas.math.toronto.edu/wiki/The_Rolfsen_Knot_Table). Proper named links aren't available at all.

Nowadays, larger databases for knots and links are available at the [Knot Atlas](http://katlas.math.toronto.edu/wiki/Main_Page) pages in RDF-format and at [KnotInfo](https://knotinfo.math.indiana.edu/) as XLS / XLSX -files. Since parsing of CSV files is already supported by Sage, this is a good start to produce a Sage packages from these files containing about 3000 knots and 4000 proper links together with a lot of their properties and invariants.

Such a package has a couple of advantages:

1. Perform cross-checks for about 7000 links of alternative implementations of certain methods.
2. Do cross-checks against results listed in the _KontInfo_ database.
3. Provide properties for these links that are not provided by Sage, yet.
4. Implement a link identification method for our link class (like _KnotFinder_).
5. Launch webpages containing additional information for a link or alternate graphical representations.

The aim of this ticket is to have the databases accessible in Sage together with conversion methods for the most important properties and invariants.

Many thanks to Allison Moore and Chuck Livingston for their kind permission to have this interface implemented and their offer to support us.


---

Comment by soehms created at 2020-08-14 07:44:07

Tarball for KnotInfo


---

Attachment

New commits:


---

Comment by git created at 2020-08-15 09:08:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-23 17:22:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2020-08-23 17:24:04

I add a sample of 20 links with about 20 of their properties as demonstration examples in order to have most of the doctests work on standard tests.


---

Comment by git created at 2020-11-01 07:38:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2020-11-01 07:43:25

I do the following:

1. Add a new class `KnotInfoSeries` improving the access to the links.
2. Add an link identification method (`identify_knotinfo`) to the class `Link` used in a new `is_isotopic` method.
3. Add some more conversion methods for link invariants to Sage objects.
4. Add `injection` methods to inject names of links and series of links easily into the namespace.
5. Add conversion to [SnapPy](https://snappy.math.uic.edu/index.html) links.
6. Some improvements in code sructure.
7. Dokumentation.

Now a state is reached where about a quarter of the more than 120 properties of links listed in the KnotInfo databases have conversions to Sage objects (whereas all of them can be accessed as string). Surely, useres will still miss conversion methods in the remaining cases. But, from my point of view the current set is sufficient for a start with that interface. More conversion methods can be added on demand. Therefore, I think this is ready for review.


---

Comment by soehms created at 2020-11-01 07:43:25

Changing status from new to needs_review.


---

Comment by tscrim created at 2020-11-02 01:54:52

I feel like there should be something added to the `features/databases.py` file to test that the package is installed rather than within the class itself. I think this is how we generally want to do things (but perhaps I am not the best person to ask about this).

I am not entirely convinced by name of the method `identify_knotinfo`. I am thinking `knotinfo` is easier to discover, but I am also not sure this is a good name too. You should add a doctest showing an example that is not covered by the database to show that works (not just when it cannot be uniquely determined).

Now for some minor things:

It would be good to limit things in the docstrings to ~80 characters per line.

Missing blankline:

```
    def __init__(self, crossing_number, is_knot, is_alternating, name_unoriented=None):
        r"""
        Python constructor.

        EXAMPLES::
            sage: from sage.knots.knotinfo import KnotInfoSeries
            sage: L6a = KnotInfoSeries(6, False, True); L6a
            Series of links L6a
            sage: TestSuite(L6a).run()
        """
```


You don't need to apologize `:P`:

```
NotImplementedError: Sorry, this link cannot be uniquely determined
```

Also, error messages should start with a lowercase.

Do you need this import?

```diff
             sage: from sage.databases.knotinfo_db import KnotInfoDataBase
-            sage: from sage.env import SAGE_SHARE
             sage: ki_db = KnotInfoDataBase()
             sage: ki_db.filename.links
             <KnotInfoFilename.links: ['https://linkinfo.sitehost.iu.edu/', 'linkinfo_data_complete']>
```

I don't see where it is used in the doctest.

The bullet points are overindented:

```
Briefly, these differences are:

   - ``pd_notation`` --        KnotInfo: counter clockwise Sage: clockwise, see note in
     :meth:`KnotInfoBase.link`

   - ``homfly_polynomial`` --  KnotInfo: ``v``  Sage: `1/a`, see note in :meth:`KnotInfoBase.homfly_polynomial`.

   - ``braid_notation``    --  This is used accordingly: The crossing of the braid generators are positive
     in both systems. Here it is listed because there could arise confusion from the source where they are
     taken from. There, the braid generators are assumed to have a negative crossing
     (see definition 3  of `Gittings, T., "Minimum Braids: A Complete Invariant of Knots and Links <https://arxiv.org/abs/math/0401051>`__).
```


A trivial thing: `Examples::` -> EXAMPLES::`


---

Comment by soehms created at 2020-11-03 08:17:11

Replying to [comment:11 tscrim]:

Thank you for having a look at this, Travis! Also, many thanks for the organization of that great Sage Days!

> I feel like there should be something added to the `features/databases.py` file to test that the package is installed rather than within the class itself. I think this is how we generally want to do things (but perhaps I am not the best person to ask about this).

Indeed, it seems so! I didn't notice that because only two of the databases did that and everything worked fine, so far. Surely, it would be no mistake to do it. So I will include that in the next commit.

> I am not entirely convinced by name of the method `identify_knotinfo`. I am thinking `knotinfo` is easier to discover, but I am also not sure this is a good name too.

What about `to_knotinfo`?

> You should add a doctest showing an example that is not covered by the database to show that works (not just when it cannot be uniquely determined).

I will add one in the next commit and fix the other minor issues, as well.


---

Comment by tscrim created at 2020-11-04 08:58:00

Replying to [comment:12 soehms]:
> Replying to [comment:11 tscrim]:
> 
> Thank you for having a look at this, Travis! Also, many thanks for the organization of that great Sage Days!

Thank you.

> > I am not entirely convinced by name of the method `identify_knotinfo`. I am thinking `knotinfo` is easier to discover, but I am also not sure this is a good name too.
> 
> What about `to_knotinfo`?

Better, but it is not really returning a `knotinfo()` object. I would be okay with `get_knotinfo()`.


---

Comment by git created at 2020-11-07 21:01:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2020-11-07 21:14:54

Replying to [comment:13 tscrim]:
> Replying to [comment:12 soehms]:
> > What about `to_knotinfo`?
> 
> Better, but it is not really returning a `knotinfo()` object. I would be okay with `get_knotinfo()`.
It's okay for me, as well. The same concerning all your other suggestions, as you can see from the recent commit.

Note, that the _SnapPy_  doctests don't work any more since #24483 introduced an incompatibility in 9.3.beta0 (`create_ComplexNumber` did move to another module harming the import of `snappy`).


---

Comment by git created at 2020-11-07 21:18:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-11-09 13:26:35

please rebase your branch, it's red (ie does not merge/show)


---

Comment by git created at 2020-11-09 15:52:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2020-11-09 15:56:12

Replying to [comment:17 dimpase]:
> please rebase your branch, it's red (ie does not merge/show)
Thanks for the hint. On the one hand, I could merge the branch into 9.3.beta1 without any conflicts. On the other hand I got a difference in  `build/pkgs/sage_sws2rst/src/test/Adding_Pictures_and_screenshots.sws` where I have absolutely no idea how this came up:


```diff
.../src/test/Adding_Pictures_and_screenshots.sws   |  Bin 281797 -> 281795 bytes
```


I replaced this by the develop branch version (hoping that fixes the issue).


---

Comment by dimpase created at 2020-11-09 20:02:19

Replying to [comment:19 soehms]:
> Replying to [comment:17 dimpase]:
> > please rebase your branch, it's red (ie does not merge/show)
> Thanks for the hint. On the one hand, I could merge the branch into 9.3.beta1 without any conflicts. On the other hand I got a difference in  `build/pkgs/sage_sws2rst/src/test/Adding_Pictures_and_screenshots.sws` where I have absolutely no idea how this came up:
> 
> {{{#!diff
> .../src/test/Adding_Pictures_and_screenshots.sws   |  Bin 281797 -> 281795 bytes
> }}}
this is from #28838 - which you somehow changed, judging by the file size.

> 
> I replaced this by the develop branch version (hoping that fixes the issue).
> 

Perhaps Matthias can have a look at this, qua the package structure.


---

Comment by tscrim created at 2020-11-09 22:47:45

It doesn't seem to be in the current diff according to trac.


---

Comment by mmarco created at 2020-11-10 12:53:00

A couple of suggestions:

Since Knotinfo uses yet another normalization for the HOMFLY polynomial, maybe we could add it to the options for Sage knots and links (maybe 'vz' could be a good name). It could simplify the code in the identification process.

Also, in the same identification, we don't really need to check for braid equality, braid conjugacy would be enough. Thanks to libbraiding we have a very fast `is conjugated` method.


---

Comment by soehms created at 2020-11-13 16:56:22

Replying to [comment:22 mmarco]:

Thanks a lot for your suggestions, Miguel!

> A couple of suggestions:
> 
> Since Knotinfo uses yet another normalization for the HOMFLY polynomial, maybe we could add it to the options for Sage knots and links (maybe 'vz' could be a good name). It could simplify the code in the identification process.

My approach is to keep the sage conventions fixed and do all necessary adaptions in the KnotInfo wrapper. There, I add to some of the conversion methods a keyword argument `sage_convention` which can be used to have the adaption performed.

So, are you suggesting to have `vz` instead of that, or in addition? If you mean _in addition_, I don't see an essential simplification. If not, I think it could be confusing if for one method (`homfly_polynomial`) the adaption is realized in class `Link` whereas for others (`jones_polynomial`, `alexander_polynomial`)  it would remain in `KnotInfo`. Therefore, if we want to move the adaption to class `Link`, I would prefer to do it in all cases.

> 
> Also, in the same identification, we don't really need to check for braid equality, braid conjugacy would be enough. Thanks to libbraiding we have a very fast `is conjugated` method.

Great! I missed that because I've tried `is_conjugate` (omitting the final `d`) which didn't terminate or results in an error from the Gap wrapper. That made me capitulate! Of course I will include that in the next commit.


BTW: As you predicted I encountered some other instances of the trivial diagram issue (#30346). In two cases you get errors (`is_alternating`, `khovanov_homology`) and in one case a wrong result (`jones_polynomial`). Furthermore, in `is_alternating` shouldn't we change this:


```
        if not self.is_knot():
            return False
```


into a `NotImplementedError`?

Shall I create a ticket for each case, or one for all? This is now #31001!


---

Comment by mmarco created at 2020-11-17 14:25:22

> So, are you suggesting to have `vz` instead of that, or in addition? If you mean _in addition_, I don't see an essential simplification. If not, I think it could be confusing if for one method (`homfly_polynomial`) the adaption is realized in class `Link` whereas for others (`jones_polynomial`, `alexander_polynomial`)  it would remain in `KnotInfo`. Therefore, if we want to move the adaption to class `Link`, I would prefer to do it in all cases.
> 

If this 'vz' normalization is used out there (and it is, as KnotInfo/LinkInfo uses it), it makes sense for Sage to acknowledge it, and provide the option of giving the HOMFLY polynomial in that notation. Users that are used to it might find it useful. And as a side effect, the code you are writing could be simpler.

The case of Alexander Polynomial might be different, since the ambiguity between different possible results comes from an ambiguous definition; instead of coming from different choice of notations.


---

Comment by soehms created at 2020-11-18 13:11:55

Replying to [comment:24 mmarco]:

> Users that are used to it might find it useful.

Now I know what you mean! I'll do that on a separate commit in order not to do too much at once. Currently, the defaults for `var1` and `var2` do not depend on the chosen `normalization` (they are `L` and `M` regardless whether `normalization=lm` or not). If you agree, I will take the occasion to have this more comfortable: More precisely, I would set the keyword defaults to `None` and change `None` according to the `normalization`.

> The case of Alexander Polynomial might be different, since the ambiguity between different possible results comes from an ambiguous definition; instead of coming from different choice of notations.

The ambiguity of definition could be dealt with a synchronization of normalization (which I realized up to sign). But you are right: in both other cases (Jones and Alexander polynomials) KnotInfo uses the same definition as we do. The differences come from the fact that KnotInfo avoids polynomials with negative or fractional exponents. I will leave the corresponding methods as they are, but maybe replace the keyword name `sage_convention` by something more specific.

What about my question concerning `is_alternating`?


---

Comment by git created at 2020-11-18 13:15:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2020-11-18 13:23:05

I do the following:

1. I use the braid method `is_conjugated` in `get_knotinfo` and `is_isotopic` according to Miguel's suggestion. To deal with the case where the braid's parents are different I implemented a helper method `_markov_move_cmp` for class `Link`. Here the embedding into a common parent via Markov moves II is realized.

2. I restructure  `get_knotinfo` since I found some algorithmic leaks leading to irritating results. For example amphicheiral knots were detected as mirror image of their KnotInfo equivalent. Another source of confusion has been the fact that `KnotInfo.L5a1_1.link()` has been identified as `KnotInfo.L5a1_0`. The reason is that both are isotopic (see the note I add to `get_knotinfo`). I prefer to raise an error in such a case and let the user apply the keyword `unique=False` to obtain both of them.

- Details of the restructuring: I remove the function `knotinfo_matching_list`. One part of its contents is now in a new method  `lower_list` of class `KnotInfoSeries` and the other part in a new method `_knotinfo_matching_list` of class `Link`. The latter method contains parts of the former `get_knotinfo` in addition.

3. I do some renaming and introduction of keywords in order to unify their usage, especially in the context of distinguishing between oriented and unoriented proper links.

4. I add `__gt__` to class `KnotInfoBase` in order to have `sorted` work for lists of KnotInfo items.


---

Comment by soehms created at 2020-12-01 22:06:24

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-12-03 11:09:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2020-12-03 11:14:35

Changing status from needs_work to needs_review.


---

Comment by soehms created at 2020-12-03 11:14:35

The commit above contains the following changes:

1. The changes announced in [comment 25](https://trac.sagemath.org/ticket/30352#comment:25) concerning Miguels suggestions.
2. new methods `_test_recover` for the classes `KnotInfoBase` and `KnotInfoSeries` in order to have `TestSuite` check if the items of the KnotInfo databases can be recovered correctly (up to ambiguities) from the different conversions to Sage.
3. Further changes regarding the method `get_knotinfo` and its auxillaries in order to improve its perfomance and remove bugs I detected using `_test_recover`.
4. In connection with the former item I add a couple of `cached_method` decorators.
5. Some further adaptions to database issues (trailing whitespaces in `symmetry_type` and the value of `determinant` for unknot).

Running `_test_recover` over the complete database (more than 28000 checks in sum) now takes about one and a half hour (on an i5). When I started to test this it didn't terminate after one night. At the moment there are still some failures (13 pairs of orientation mutants of proper links) all due to the current implementation of `mirror_image`. I opened ticket #30997 to have this fixed.

BTW: By what reason is `determinant` not implemented for proper links?


---

Comment by git created at 2020-12-04 08:13:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2020-12-04 08:54:09

Replying to [comment:30 soehms]:
> Running `_test_recover` over the complete database (more than 28000 checks in sum) now takes about one and a half hour (on an i5). When I started to test this it didn't terminate after one night. At the moment there are still some failures (13 pairs of orientation mutants of proper links) all due to the current implementation of `mirror_image`. I opened ticket #30997 to have this fixed.

Even if it takes 1.5 hours, that is still far too long as a default. You should use the `tester._max_runs` of the tester to limit the number that gets run as a default. This at least makes it much more controllable for the doctests to limit it to a few seconds (which it then is marked as `# long time`) with perhaps a < .5s run for the non-long tests.

Also, you will probably need to mark a lot of doctests as `# optional - database_knotinfo`.


---

Comment by soehms created at 2020-12-04 09:59:50

Replying to [comment:32 tscrim]:
> Replying to [comment:30 soehms]:

> Even if it takes 1.5 hours, that is still far too long as a default. You should use the `tester._max_runs` of the tester to limit the number that gets run as a default. This at least makes it much more controllable for the doctests to limit it to a few seconds (which it then is marked as `# long time`) with perhaps a < .5s run for the non-long tests.
> 

I didn't include the test of the complete database in the code. Only one over all proper alternating links with 5 crossings:


```
sage: %time TestSuite(KnotInfo.L5a1_0.series()).run()
CPU times: user 680 ms, sys: 52 ms, total: 732 ms
Wall time: 718 ms
```


I will mark this as long.
Thanks for your hint to `tester._max_runs`. I will checkout how I can apply it.

> Also, you will probably need to mark a lot of doctests as `# optional - database_knotinfo`.

No! All not maked tests run without the optional package by help of a small list of demonstration cases kept in static dictionaries.


---

Comment by tscrim created at 2020-12-09 07:47:52

Replying to [comment:33 soehms]:
> Replying to [comment:32 tscrim]:
> > Replying to [comment:30 soehms]:
> 
> > Even if it takes 1.5 hours, that is still far too long as a default. You should use the `tester._max_runs` of the tester to limit the number that gets run as a default. This at least makes it much more controllable for the doctests to limit it to a few seconds (which it then is marked as `# long time`) with perhaps a < .5s run for the non-long tests.
> > 
> 
> I didn't include the test of the complete database in the code. Only one over all proper alternating links with 5 crossings:
> 
> {{{
> sage: %time TestSuite(KnotInfo.L5a1_0.series()).run()
> CPU times: user 680 ms, sys: 52 ms, total: 732 ms
> Wall time: 718 ms
> }}}
> 
> I will mark this as long.

That is fine; it doesn't need to be marked as long.

> Thanks for your hint to `tester._max_runs`. I will checkout how I can apply it.

It is very easy to add a `TestSuite(KnotInfo).run()` test, which then will accidentally take a long time. Granted, it is on subsequent authors to avoid doing this, but a user might also do this, so this is now mostly a me being complete paranoid request.

> > Also, you will probably need to mark a lot of doctests as `# optional - database_knotinfo`.
> 
> No! All not maked tests run without the optional package by help of a small list of demonstration cases kept in static dictionaries.

I see. I am not sure how I feel about that as I feel like it could hide stuff accidentally. I am inclined to keep it, but perhaps someone else can comment on this.


---

Comment by soehms created at 2020-12-10 15:51:39

Replying to [comment:34 tscrim]:
> It is very easy to add a `TestSuite(KnotInfo).run()` test, which then will accidentally take a long time. Granted, it is on subsequent authors to avoid doing this, but a user might also do this, so this is now mostly a me being complete paranoid request.

This danger does not exist in this special case:


```
sage: TestSuite(KnotInfo).run(verbose=True)
running ._test_new() . . . pass
running ._test_pickling() . . . pass
```


This is because `KnotInfo` isn't inherited from `SageObject` which is not possible for `Enum`. Just the `TestSuite` for `KnotInfoSeries` use this method (indirectly). Obviously this `TestSuite` construction causes some confusion. I will try to improve this according to your hints!

BTW: The test that run 1.5 h was this (no way to do that accidentally, but sorry that I didn't make this clear enought):


```
sage: from sage.misc.sage_unittest import instance_tester
....: from sage.knots.knotinfo import KnotInfo
....: tester = instance_tester(KnotInfo)
....: def test_all():
....:     for L in KnotInfo:
....:         try:
....:             L._test_recover(tester=tester)
....:         except AssertionError:
....:             print(L)
....:
sage: %time test_all()
CPU times: user 1h 30min 45s, sys: 2.08 s, total: 1h 30min 47s
Wall time: 1h 30min 47s
```





> I feel like it could hide stuff accidentally.

What stuff do you mean? Future changes in the real database for the first twenty links? I think changes in the values of the properties used can be ruled out and adding new properties wouldn't hurt.

The great advantage of these demo examples is that the basic functionality of this interface is permanently tested. So if someone introduces something into another library code that is incompatible, he becomes aware of it.


---

Comment by soehms created at 2020-12-10 15:51:39

Changing status from needs_review to needs_work.


---

Comment by tscrim created at 2020-12-17 08:26:32

Replying to [comment:35 soehms]:
> Replying to [comment:34 tscrim]:
> > It is very easy to add a `TestSuite(KnotInfo).run()` test, which then will accidentally take a long time. Granted, it is on subsequent authors to avoid doing this, but a user might also do this, so this is now mostly a me being complete paranoid request.
> 
> This danger does not exist in this special case:
> 
> {{{
> sage: TestSuite(KnotInfo).run(verbose=True)
> running ._test_new() . . . pass
> running ._test_pickling() . . . pass
> }}}
> 
> This is because `KnotInfo` isn't inherited from `SageObject` which is not possible for `Enum`. Just the `TestSuite` for `KnotInfoSeries` use this method (indirectly). Obviously this `TestSuite` construction causes some confusion. I will try to improve this according to your hints!

Ah, I think I now understand as I was misunderstanding what `KnotInfoSeries` (which is what I meant before because of calling the `_test_recover`; sorry for this error too) was holding. I thought it was holding onto the entire database.

> BTW: The test that run 1.5 h was this (no way to do that accidentally, but sorry that I didn't make this clear enought):
> 
> {{{
> sage: from sage.misc.sage_unittest import instance_tester
> ....: from sage.knots.knotinfo import KnotInfo
> ....: tester = instance_tester(KnotInfo)
> ....: def test_all():
> ....:     for L in KnotInfo:
> ....:         try:
> ....:             L._test_recover(tester=tester)
> ....:         except AssertionError:
> ....:             print(L)
> ....:
> sage: %time test_all()
> CPU times: user 1h 30min 45s, sys: 2.08 s, total: 1h 30min 47s
> Wall time: 1h 30min 47s
> }}}
> 

I would have expected the database itself to have a consistency check like this.

> > I feel like it could hide stuff accidentally.
> 
> What stuff do you mean? Future changes in the real database for the first twenty links? I think changes in the values of the properties used can be ruled out and adding new properties wouldn't hurt.

The link with the database somehow becomes broken, such as they change the name of a column. So the code breaks once you install the database. Granted, I think this is unlikely. Looking over the design a bit more, having a future developer should not naturally avoid the methods that differentiate between the two.

> The great advantage of these demo examples is that the basic functionality of this interface is permanently tested. So if someone introduces something into another library code that is incompatible, he becomes aware of it.

I agree that it is an advantage to have it tested. Although I do believe it should not be done locally within Sage's library but with a more robust testing framework. Yet, I believe that the benefits here clearly outweigh the costs.


---

Comment by git created at 2020-12-18 17:48:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2020-12-18 17:51:20

I do the following changes:

1. I make TestSuite functionality more clear: I rename the former methods `_test_recover` to user visible boolean methods `is_recoverable`. I add a new `_test_recover` to class `KnotInfoSeries` which just runs the test using `is_recoverable` and the `tester` -option `max_samples`.

2. I add a new method `is_unique` to class `KnotInfoBase` which tests if a proper link is unique in the database under isotopy. This is needed in `get_knotinfo` and `is_isotopic` in order to give more reliable answers in unclear situations.
3. I extend `is_amphicheiral` to proper links by internal tests (needed for `get_knotinfo`, as well).
4. I remove option `oriented` from `get_knotinfo` and improve the quality of its answer in unclear situations.
5. I add a warning to the docstring of method `from_dowker_code` of class `Knot` according to a hint of Chuck Livingston.


---

Comment by soehms created at 2020-12-18 17:51:20

Changing status from needs_work to needs_review.


---

Comment by soehms created at 2020-12-18 17:56:41

Replying to [comment:36 tscrim]:
> Replying to [comment:35 soehms]:

> I would have expected the database itself to have a consistency check like this.

Do you mean on the installation procedure with option `-c`? I could run tests with larger samples there in addition to the doctests, shall I?

> The link with the database somehow becomes broken, such as they change the name of a column. So the code breaks once you install the database. Granted, I think this is unlikely. Looking over the design a bit more, having a future developer should not naturally avoid the methods that differentiate between the two.

If the package will be upgraded to a new database version then the patchbots would detect a change of a column-name that wasn't performed in the static dictionary. But unfortunately, they don't take package tickets. Indeed, in the case of this package it would make sense if they would.

> I agree that it is an advantage to have it tested. Although I do believe it should not be done locally within Sage's library but with a more robust testing framework. Yet, I believe that the benefits here clearly outweigh the costs.

What robust testing framework do you mean? If the database is not installed the all doctests of the ticket consume less than five seconds (on i5).


---

Comment by tscrim created at 2020-12-19 08:02:56

Replying to [comment:39 soehms]:
> Replying to [comment:36 tscrim]:
> > Replying to [comment:35 soehms]:
> 
> > I would have expected the database itself to have a consistency check like this.
> 
> Do you mean on the installation procedure with option `-c`? I could run tests with larger samples there in addition to the doctests, shall I?

No, I mean that there is a `_test_database` type method on the database class. The `-c` option is good, but I also think we shouldn't have that take too long.

> > I agree that it is an advantage to have it tested. Although I do believe it should not be done locally within Sage's library but with a more robust testing framework. Yet, I believe that the benefits here clearly outweigh the costs.
> 
> What robust testing framework do you mean? If the database is not installed the all doctests of the ticket consume less than five seconds (on i5).

There are patchbots/buildbots with the database that check that everything still works rather than a group of us with the database installed running tests after each beta release.


---

Comment by git created at 2020-12-22 15:38:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2020-12-22 15:42:05

Replying to [comment:40 tscrim]:
> Replying to [comment:39 soehms]:

> No, I mean that there is a `_test_database` type method on the database class.  The `-c` option is good, but I also think we shouldn't have that take too long.

I add such a `_test_database` method which tests for a random sample of 20 links (by default). I marked the `TestSuite` doctest as `long time`. It takes less than 2 seconds if the database isn't installed and about 20 seconds else (including loading of the database). In addition I had to do some changes since the installation was broken (because of the usage of `feature` and `UniqueRepresentation`). Furthermore, I make the `-c` installation option take this long doctest, as well.

> There are patchbots/buildbots with the database that check that everything still works rather than a group of us with the database installed running tests after each beta release.

Are such patchbots/buildbots already possible?


---

Comment by tscrim created at 2020-12-28 00:29:56

Replying to [comment:42 soehms]:
> Replying to [comment:40 tscrim]:
> > Replying to [comment:39 soehms]:
> 
> > No, I mean that there is a `_test_database` type method on the database class.  The `-c` option is good, but I also think we shouldn't have that take too long.
> 
> I add such a `_test_database` method which tests for a random sample of 20 links (by default). I marked the `TestSuite` doctest as `long time`. It takes less than 2 seconds if the database isn't installed and about 20 seconds else (including loading of the database). In addition I had to do some changes since the installation was broken (because of the usage of `feature` and `UniqueRepresentation`). Furthermore, I make the `-c` installation option take this long doctest, as well.

Thank you. I think that will help with the testing.

Dima, Miguel, anyone else have any additional comments before I set this to a positive review?

> > There are patchbots/buildbots with the database that check that everything still works rather than a group of us with the database installed running tests after each beta release.
> 
> Are such patchbots/buildbots already possible?

It is possible, but with all the different combinations, it is impossible to maintain as there is some different behavior depending on certain optional (experimental?) packages being installed. Although I would advocate for having at least one buildbot that has all optional (and possibly experimental) packages installed that runs tests.


---

Comment by mkoeppe created at 2021-01-17 19:28:29

Typo: `KontInfo` (3 times)


---

Comment by mkoeppe created at 2021-01-17 19:32:01

In terms of packaging, I think it would be much preferable to create a pip-installable package than to have a Sage specific upstream tarball.

See #30914 (Meta-ticket: Create upstream repositories, pip-installable packages for database packages)


---

Comment by mkoeppe created at 2021-01-17 19:34:48

Also, in `SPKG.rst` please follow the new format of the title from #29655


---

Comment by fbissey created at 2021-01-17 20:04:02

I see that upstream stores the original files in excel spreadsheets and it is then exported to cvs with some substitutions in libreoffice. That is not a sustainable approach unless you have some libreoffice automated scripting. 

I would recommend a python script using pandas [not included in sage] or a R script to perform such task.

Asides from those workflow issues some proper packaging as something pip installable would indeed be nice. It should be relatively trivial if we only install the data.


---

Comment by dimpase created at 2021-01-18 17:01:10

> I see that upstream stores the original files in excel spreadsheets and it is then exported to cvs with some substitutions in libreoffice.

I am sure this explains [`KontInfo`](https://www.google.com/search?q=google+translate+kont). (Pardon my French...)


---

Comment by soehms created at 2021-01-20 11:10:59

Replying to [comment:46 mkoeppe]:
> Typo: `KontInfo` (3 times)

Thanks!

> In terms of packaging, I think it would be much preferable to create a pip-
> installable package than to have a Sage specific upstream tarball.

I would like to do that, but I would prefer to do it in a follow-up ticket. Having never done this before, I will likely need advice and maybe help (plus time that I won't have until February). Are there any examples that I can see how I can do this?

> Also, in `SPKG.rst` please follow the new format of the title from #29655

I will do that!


---

Comment by soehms created at 2021-01-20 11:15:34

Replying to [comment:47 fbissey]:
> I see that upstream stores the original files in excel spreadsheets and it is then exported to cvs with some substitutions in libreoffice. That is not a sustainable approach unless you have some libreoffice automated scripting. 

I know, this was only intended as a temporary solution (after failing to use `pandoc`). I reported some minor (and non-significant) issues upstream and waited for them to provide new files. If not, the existing tarball is good enough to start.


> I would recommend a python script using pandas [not included in sage] or a R script to perform such task.

Thanks for your suggestions. I will see which one is appropriate to implement such a script.

> Asides from those workflow issues some proper packaging as something pip installable would indeed be nice. It should be relatively trivial if we only install the data.

Do you know examples that I can follow?


---

Comment by soehms created at 2021-01-20 12:01:48

Changing status from needs_review to needs_work.


---

Comment by fbissey created at 2021-01-20 19:24:37

Replying to [comment:50 soehms]:
> Replying to [comment:47 fbissey]:
> > I would recommend a python script using pandas [not included in sage] or a R script to perform such task.
> 
> Thanks for your suggestions. I will see which one is appropriate to implement such a script.
> 

Amusingly, I did the exact reverse for some people in the school of economics in my university. They had large csv files to download and they wanted to transform them into excel files - during the process we had to add some substitutions for missing values. They wanted the files in excel format as an input for STATA - I want to cry sometimes with some researchers. 

> > Asides from those workflow issues some proper packaging as something pip installable would indeed be nice. It should be relatively trivial if we only install the data.
> 
> Do you know examples that I can follow?

Good one. We have identified that as a need for our data packages but I don't think we have done it with any. I cannot think of a python package that is a pure data load either. Possibly because people do not usually bother which is sad.


---

Comment by mkoeppe created at 2021-01-20 19:57:32

A few more comments.

1. If you do `git grep SAGE_ROOT src/sage`, you will see that we have essentially eliminate use of this variable in the Sage library. This ticket reintroduces it, mixing Sage-the-distribution-specific code with Sage library code. That's not a good direction. In particular, Sage library code should not refer to `SAGE_ROOT/build/pkgs/%s/package-version.txt` at all - as this may not be available in downstream distribution packaging of Sage.

2. The purpose of subclasses `sage.features.StaticFile` is to provide an interface to discovering files in an installation. `KnotInfoFilename.knots.sobj_path` should use `sage.features.databases.DatabaseKnotInfo` to find the path, not the other way around.


---

Comment by mkoeppe created at 2021-01-20 20:13:46

I also don't fully understand the purpose of the data transformation that is happening at installation time, reading the csv files and creating many sobj files, in functions such as `_create_col_dict_sobj` etc. Each of the little files is storing a dictionary mapping strings to strings as a pickle (sobj)?


---

Comment by soehms created at 2021-01-21 12:48:27

Replying to [comment:52 fbissey]:
> Replying to [comment:50 soehms]:
> 
> Amusingly, I did the exact reverse for some people in the school of economics in my university. They had large csv files to download and they wanted to transform them into excel files - during the process we had to add some substitutions for missing values. They wanted the files in excel format as an input for STATA - I want to cry sometimes with some researchers. 
> 

I'm also amazed that pure math data is stored in Excel spreadsheets, but missing values haven't been a problem here so far (with the exception of the trivial knot, which I had to deal with separately in some cases). But there was a misplaced character and trailing and leading whitespaces (which of course can be handled using `strip`).

The reason why I converted them to `csv` is that I found no Excel reader included in Sage. You mentioned that `pandas` isn't included in Sage, as well. So, how can I use it in `spkg-install`?


> Good one. We have identified that as a need for our data packages but I don't think we have done it with any. I cannot think of a python package that is a pure data load either. Possibly because people do not usually bother which is sad.

I am open to try making a prototype. But that should be on a follow-up ticket.


---

Comment by soehms created at 2021-01-21 12:50:03

Replying to [comment:53 mkoeppe]:
> A few more comments.
> 
> 1. If you do `git grep SAGE_ROOT src/sage`, you will see that we have essentially eliminate use of this variable in the Sage library. This ticket reintroduces it, mixing Sage-the-distribution-specific code with Sage library code. That's not a good direction. In particular, Sage library code should not refer to `SAGE_ROOT/build/pkgs/%s/package-version.txt` at all - as this may not be available in downstream distribution packaging of Sage.
> 
> 2. The purpose of subclasses `sage.features.StaticFile` is to provide an interface to discovering files in an installation. `KnotInfoFilename.knots.sobj_path` should use `sage.features.databases.DatabaseKnotInfo` to find the path, not the other way around.
> 

Sorry, that I didn't realize that! Of course I will correct it!


---

Comment by soehms created at 2021-01-21 12:52:45

Replying to [comment:54 mkoeppe]:
> I also don't fully understand the purpose of the data transformation that is happening at installation time, reading the csv files and creating many sobj files, in functions such as `_create_col_dict_sobj` etc. Each of the little files is storing a dictionary mapping strings to strings as a pickle (sobj)?
> 
> 
Perhaps this is ridiculous given the size of these databases, but the purpose is to minimize the memory load. The user only needs a few of the 120 columns in the tables at a time (so why load them all each time).


---

Comment by git created at 2021-02-01 17:40:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2021-02-01 17:46:06

I do the following:

1. Changes which I have announced in comments 49, 50 and 56 according to review.
2. Upgrade to a new tarball since one of the both Excel files has changed (three additional columns and some whitespace erasing).
3. I add 2 more conversion methods (`three_genus` and `signature`) of link properties which have been of interest, recently (#31188).
4. One fix, since there was still a single link (`L10a171_1_1_0`) that caused `TestSuite` (with option `max_samples=infinity`) fail for class `KnotInfoDatabase`.
5. I put `KnotInfo` and `KnotInfoSeries` into the global namespace in case the database is installed.


---

Comment by soehms created at 2021-02-01 17:46:06

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-02-04 17:59:34

Some suggestions for the upstream repository (in the direction of #30914):
- Call it `database_knotinfo`, not `sagemath_knotinfo` -- it will be useful to a broader community (Python)
- It's redundant to put versioned tarballs in a git repository - put instead the unpacked tarball there and have git take care of versioning
- When done, I can send you a pull request that turns this repository into a pip-installable package


---

Comment by soehms created at 2021-02-06 19:45:20

Replying to [comment:61 mkoeppe]:
> Some suggestions for the upstream repository (in the direction of #30914):
> - Call it `database_knotinfo`, not `sagemath_knotinfo` -- it will be useful to a broader community (Python)
> - It's redundant to put versioned tarballs in a git repository - put instead the unpacked tarball there and have git take care of versioning
> - When done, I can send you a pull request that turns this repository into a pip-installable package

Sounds good! I hope the [new repository](https://github.com/soehms/database_knotinfo) is as expected. Please don't hesitate to make any changes you think are necessary! Many Thanks!


---

Comment by git created at 2021-02-15 08:10:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-03-24 02:04:25

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.


---

Comment by git created at 2021-05-15 17:59:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2021-05-15 18:03:27

Replying to [comment:61 mkoeppe]:

> - When done, I can send you a pull request that turns this repository into a pip-installable package

I've tried it now on my own and at least it is working. But since I needed a lot of trial error cycles I would appreciate it if you could have a look at it.

The current commit here concerns the adaption to the pip-installable package. Furthermore, it contains adaptations to SnapPy 3.0.1 and an addition of some verbose messages to `is_isotopic` (following a suggestion of knot theorists from the University of Regensburg).


---

Comment by tscrim created at 2021-05-21 02:01:34

I don't think it is necessary to cache `homfly_polynomial()` as all of the key computational aspects are cached and so you don't cache the "same" object even though someone changed the variable name.

Other than that, I am happy with the current state of things. Does anyone else have any comments or suggestions?


---

Comment by mkoeppe created at 2021-05-21 03:23:39

Looks great to me!


---

Comment by mkoeppe created at 2021-05-21 03:23:39

Changing status from needs_review to positive_review.


---

Comment by soehms created at 2021-05-21 07:09:35

> I don't think it is necessary to cache homfly_polynomial() as all of the key computational aspects are cached and so you don't cache the "same" object even though someone changed the variable name.

I agree that this is not that effective. In general, my consideration concerning caching was that with the database available you easily can have hundreds or thousands of invocations of any method. Anyway, I think that is nothing that could hurt, and thus would keep it for a start.

Many thanks to everyone who helped to have this interface realized!


---

Comment by vbraun created at 2021-06-06 13:19:25

Resolution: fixed


---

Comment by fbissey created at 2021-06-07 03:55:40

Follow up at #31921.


---

Comment by soehms created at 2021-10-26 15:50:32

Another follow up at #32760.
