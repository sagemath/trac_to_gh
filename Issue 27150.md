# Issue 27150: bug in saturation of points on elliptic curves over number fields

archive/issues_027150.json:
```json
{
    "body": "Keywords: elliptic curves, saturation\n\n\n```\nK.<a> = NumberField(x^2-x-26)\nE = EllipticCurve([a,1-a,0,93-16*a, 3150-560*a])\nP = E([65-35*a/3, (959*a-5377)/9])\nE.saturation([P],one_prime=2)\n```\n\nraises a TypeError.\n\nThis is curve http://www.lmfdb.org/EllipticCurve/2.2.105.1/5.1/a/1\n\nIssue created by migration from https://trac.sagemath.org/ticket/27387\n\n",
    "created_at": "2019-02-28T15:04:55Z",
    "labels": [
        "component: elliptic curves",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.7",
    "title": "bug in saturation of points on elliptic curves over number fields",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27150",
    "user": "https://github.com/JohnCremona"
}
```
Keywords: elliptic curves, saturation


```
K.<a> = NumberField(x^2-x-26)
E = EllipticCurve([a,1-a,0,93-16*a, 3150-560*a])
P = E([65-35*a/3, (959*a-5377)/9])
E.saturation([P],one_prime=2)
```

raises a TypeError.

This is curve http://www.lmfdb.org/EllipticCurve/2.2.105.1/5.1/a/1

Issue created by migration from https://trac.sagemath.org/ticket/27387





---

archive/issue_comments_382049.json:
```json
{
    "body": "In the example E has a 2-torsion point T and P+T can be halved so the saturation is not trivial:\n\n```\nP.division_points(2)\n[]\nT = E.torsion_points()[0]\n(P+T).division_points(2)\n[(-1/4*a + 3/4 : 59/8*a - 317/8 : 1), (-2*a + 11 : -19*a + 107 : 1)]\n```\n",
    "created_at": "2019-02-28T15:08:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27150#issuecomment-382049",
    "user": "https://github.com/JohnCremona"
}
```

In the example E has a 2-torsion point T and P+T can be halved so the saturation is not trivial:

```
P.division_points(2)
[]
T = E.torsion_points()[0]
(P+T).division_points(2)
[(-1/4*a + 3/4 : 59/8*a - 317/8 : 1), (-2*a + 11 : -19*a + 107 : 1)]
```




---

archive/issue_comments_382050.json:
```json
{
    "body": "The problem is caused by the following:\n\nLet K be a number field, E an elliptic curve over K, and Q a prime of K where E has good reduction.  Let P be a point in E(K) which has good reduction at Q, meaning that the affine coordinates of P are integral at Q.  Then Sage allows us to compute EmodQ = E.reduction(Q) and then one thinks that EmodQ(P) will be the image of P on the reduced curve, but it might not be!  In general, and certainly if the model of E is not minimal at Q, then EmodQ is formed by taking the local minimal model of E at Q and then reducing that.  Then, there is no reason why the reduced coordinates of P will satisfy the reduced equation.\n\nFor the curve in question there is no global minimal model, and the model is non-minimal at the prime Q=(2,a) above 2.  The saturation code excludes primes where E has good reduction in the proper mathematical sense, but it should also exclude primes where the model is non-minimal.\n\nSo a fix is to replace line 288 of saturation.py.  In progress.",
    "created_at": "2019-02-28T15:51:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27150#issuecomment-382050",
    "user": "https://github.com/JohnCremona"
}
```

The problem is caused by the following:

Let K be a number field, E an elliptic curve over K, and Q a prime of K where E has good reduction.  Let P be a point in E(K) which has good reduction at Q, meaning that the affine coordinates of P are integral at Q.  Then Sage allows us to compute EmodQ = E.reduction(Q) and then one thinks that EmodQ(P) will be the image of P on the reduced curve, but it might not be!  In general, and certainly if the model of E is not minimal at Q, then EmodQ is formed by taking the local minimal model of E at Q and then reducing that.  Then, there is no reason why the reduced coordinates of P will satisfy the reduced equation.

For the curve in question there is no global minimal model, and the model is non-minimal at the prime Q=(2,a) above 2.  The saturation code excludes primes where E has good reduction in the proper mathematical sense, but it should also exclude primes where the model is non-minimal.

So a fix is to replace line 288 of saturation.py.  In progress.



---

archive/issue_comments_382051.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-02-28T17:30:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27150#issuecomment-382051",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_382052.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-02-28T17:30:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27150#issuecomment-382052",
    "user": "https://github.com/JohnCremona"
}
```

New commits:



---

archive/issue_comments_382053.json:
```json
{
    "body": "indentation of new doctests is wrong in `src/sage/schemes/elliptic_curves/ell_number_field.py`",
    "created_at": "2019-02-28T19:03:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27150#issuecomment-382053",
    "user": "https://github.com/fchapoton"
}
```

indentation of new doctests is wrong in `src/sage/schemes/elliptic_curves/ell_number_field.py`



---

archive/issue_comments_382054.json:
```json
{
    "body": "Replying to [comment:2 cremona]:\n\n> For the curve in question there is no global minimal model, and the model is non-minimal at the prime Q=(2,a) above 2.  The saturation code excludes primes where E has good reduction in the proper mathematical sense, but it should also exclude primes where the model is non-minimal.\n\nI think you mean bad reduction here.\n\nI think the fix is correct besides the indentation of doctests. When I tried to fixed the indentation myself, the html output I get becomes very wrong so I'm not sure what I'm doing wrong.",
    "created_at": "2019-03-02T23:42:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27150#issuecomment-382054",
    "user": "https://github.com/kevinywlui"
}
```

Replying to [comment:2 cremona]:

> For the curve in question there is no global minimal model, and the model is non-minimal at the prime Q=(2,a) above 2.  The saturation code excludes primes where E has good reduction in the proper mathematical sense, but it should also exclude primes where the model is non-minimal.

I think you mean bad reduction here.

I think the fix is correct besides the indentation of doctests. When I tried to fixed the indentation myself, the html output I get becomes very wrong so I'm not sure what I'm doing wrong.



---

archive/issue_comments_382055.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-03-02T23:42:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27150#issuecomment-382055",
    "user": "https://github.com/kevinywlui"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_382056.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-03-03T11:55:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27150#issuecomment-382056",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_382057.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-03-03T11:57:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27150#issuecomment-382057",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_382058.json:
```json
{
    "body": "Thanks for the review.  You are right that I wrote \"good\" when I meant \"bad\".\n\nI have fixed the indentation issue in ell_number_field.py\n\nklui: please add your full name in the Reviewers field.",
    "created_at": "2019-03-03T11:57:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27150#issuecomment-382058",
    "user": "https://github.com/JohnCremona"
}
```

Thanks for the review.  You are right that I wrote "good" when I meant "bad".

I have fixed the indentation issue in ell_number_field.py

klui: please add your full name in the Reviewers field.



---

archive/issue_comments_382059.json:
```json
{
    "body": "Looks good to me.",
    "created_at": "2019-03-04T00:53:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27150#issuecomment-382059",
    "user": "https://github.com/kevinywlui"
}
```

Looks good to me.



---

archive/issue_comments_382060.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-03-04T00:53:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27150#issuecomment-382060",
    "user": "https://github.com/kevinywlui"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_068019.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-03-05T23:11:13Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27150",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27150#event-68019"
}
```



---

archive/issue_comments_382061.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-03-05T23:11:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27150#issuecomment-382061",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
