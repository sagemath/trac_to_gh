# Issue 29826: Upgrade Maxima to 5.44.0

Issue created by migration from https://trac.sagemath.org/ticket/30063

Original creator: pbruin

Original creation time: 2020-07-04 11:18:41

CC:  dimpase fbissey @timokau saraedum slelievre arojas kcrisman nbruin paulmasson

Upstream tarball can be downloaded via https://sourceforge.net/projects/maxima/files/Maxima-source/5.44.0-source/


---

Comment by mkoeppe created at 2020-07-06 00:35:33

Patches need to be removed or updated.
----
Last 10 new commits:


---

Comment by git created at 2020-07-19 06:04:38

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-07-19 06:19:26

Removing `bugfix3629.patch`, which is in 5.44.0

`0001-taylor2-Avoid-blowing-the-stack-when-diff-expand-isn.patch` does not apply. 5.44.0 has a different (simpler) change in this code.


---

Comment by git created at 2020-07-19 06:21:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-19 06:21:51

On macOS,

```
[maxima-5.44.0] /bin/bash /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/var/tmp/sage/build/maxima-5.44.0/src/missing makeinfo --html -c TEXI2HTML=1 --split=chapter --document-lang=en --output=. --css-include=../../../doc/info/manual.css --init-file  ../../../doc/info/texi2html.init  xmaxima.texi
[maxima-5.44.0] makeinfo: invalid option -- c
[maxima-5.44.0] Try `makeinfo --help' for more information.
```



---

Comment by mkoeppe created at 2020-07-19 06:22:28

This is `/usr/bin/makeinfo`

```
$ makeinfo --version
makeinfo (GNU texinfo) 4.8

Copyright (C) 2004 Free Software Foundation, Inc.
```



---

Comment by git created at 2020-07-19 07:14:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-19 07:17:59

Builds OK now on macOS. Haven't tested anything else


---

Comment by mkoeppe created at 2020-07-19 07:24:45

Tests run at https://github.com/mkoeppe/sage/actions/runs/174422230


---

Comment by dimpase created at 2020-07-19 07:46:32

Replying to [comment:12 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[07aa2f9](https://git.sagemath.org/sage.git/commit/?id=07aa2f93345d2cecee75e074dc9bbcb22074129c)||`build/pkgs/maxima/spkg-install.in: New workaround for makeinfo trouble`||

don't  they have an option not to build docs?


---

Comment by mkoeppe created at 2020-07-19 14:52:18

Unfortunately they don't.


---

Comment by arojas created at 2020-07-19 16:27:27

These are the test failures I get downstream (using system maxima):


```
**********************************************************************
File "/usr/lib/python3.8/site-packages/sage/interfaces/maxima_abstract.py", line 225, in sage.interfaces.maxima_abstract.MaximaAbstract.example
Failed example:
    maxima.example('arrays')
Expected:
    a[n]:=n*a[n-1]
                                    a  := n a
                                     n       n - 1
    a[0]:1
    a[5]
                                          120
    a[n]:=n
    a[6]
                                           6
    a[4]
                                          24
                                         done
Got:
                                     n       n - 1
    a[0]:1
    a[5]
                                          120
    a[n]:=n
    a[6]
                                           6
    a[4]
                                          24
                                         done
    <BLANKLINE>
**********************************************************************
File "/usr/lib/python3.8/site-packages/sage/interfaces/maxima_abstract.py", line 283, in sage.interfaces.maxima_abstract.MaximaAbstract.completions
Failed example:
    sorted(maxima.completions('gc', verbose=False))
Expected:
    ['gcd', 'gcdex', 'gcfactor', 'gctime']
Got:
    ['gcd', 'gcd\\-impl', 'gcdex', 'gcfactor', 'gcfactor\\-impl', 'gctime']
**********************************************************************
File "/usr/lib/python3.8/site-packages/sage/symbolic/expression.pyx", line 10031, in sage.symbolic.expression.Expression.simplify_hypergeometric
Failed example:
    hypergeometric_M(1, 3, x).simplify_hypergeometric()
Expected:
    -2*(x - e^x + 1)/x^2
Got:
    2*e^x*gamma_incomplete_lower(2, x)/x^2
**********************************************************************
File "/usr/lib/python3.8/site-packages/sage/symbolic/integration/integral.py", line 864, in sage.symbolic.integration.integral.integrate
Failed example:
    a = integral(log(cot(x) - 1), x, 0, pi/4); a  # long time (about 6 s)
Expected:
    -1/4*pi*log(2) - 1/2*I*dilog(I + 1) + 1/2*I*dilog(-I + 1) + 1/2*I*dilog(1/2*I + 1/2) - 1/2*I*dilog(-1/2*I + 1/2)
Got:
    1/4*pi*(I*pi + log(2)) - 1/2*pi*log(2) - 1/2*I*dilog(I + 1) + 1/2*I*dilog(-I + 1) + 1/2*I*dilog(1/2*I + 1/2) - 1/2*I*dilog(-1/2*I + 1/2)
**********************************************************************
File "/usr/lib/python3.8/site-packages/sage/symbolic/integration/integral.py", line 866, in sage.symbolic.integration.integral.integrate
Failed example:
    abs(N(a - pi*log(2)/8)) < 1e-15  # long time
Expected:
    True
Got:
    False
**********************************************************************
```


The first one needs a readjustment of the number of removed lines in https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/interfaces/maxima_abstract.py#n183

The ones in `integration/integral.py` are a known upstream issue since 5.43. The corresponding tests in maxima are disabled as known to fail, so maybe they can be tagged as known bug here.

The other two seem harmless.


---

Comment by git created at 2020-07-20 03:27:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-20 03:28:38

Replying to [comment:17 arojas]:
> The first one needs a readjustment of the number of removed lines in https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/interfaces/maxima_abstract.py#n183

I have fixed the first one by a method that I hope to be more robust.


---

Comment by mkoeppe created at 2020-07-20 04:06:39

Replying to [comment:17 arojas]:
> These are the test failures I get downstream (using system maxima):
> 
> {{{
> **********************************************************************
> File "/usr/lib/python3.8/site-packages/sage/interfaces/maxima_abstract.py", line 283, in sage.interfaces.maxima_abstract.MaximaAbstract.completions
> Failed example:
>     sorted(maxima.completions('gc', verbose=False))
> Expected:
>     ['gcd', 'gcdex', 'gcfactor', 'gctime']
> Got:
>     ['gcd', 'gcd\\-impl', 'gcdex', 'gcfactor', 'gcfactor\\-impl', 'gctime']
> **********************************************************************
> }}}

This is now https://sourceforge.net/p/maxima/bugs/3643/


---

Comment by git created at 2020-07-20 04:09:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-20 04:18:10

Replying to [comment:17 arojas]:
> These are the test failures I get downstream (using system maxima):
> 
> {{{
> **********************************************************************
> File "/usr/lib/python3.8/site-packages/sage/symbolic/expression.pyx", line 10031, in sage.symbolic.expression.Expression.simplify_hypergeometric
> Failed example:
>     hypergeometric_M(1, 3, x).simplify_hypergeometric()
> Expected:
>     -2*(x - e^x + 1)/x^2
> Got:
>     2*e^x*gamma_incomplete_lower(2, x)/x^2
> }}}

For this one I hope we can enroll the help of some symbolics experts. A related older ticket: #16697


---

Comment by dimpase created at 2020-07-20 10:38:43

Replying to [comment:22 mkoeppe]:
> Replying to [comment:17 arojas]:
> > These are the test failures I get downstream (using system maxima):
> > 
> > {{{
> > **********************************************************************
> > File "/usr/lib/python3.8/site-packages/sage/symbolic/expression.pyx", line 10031, in sage.symbolic.expression.Expression.simplify_hypergeometric
> > Failed example:
> >     hypergeometric_M(1, 3, x).simplify_hypergeometric()
> > Expected:
> >     -2*(x - e^x + 1)/x^2
> > Got:
> >     2*e^x*gamma_incomplete_lower(2, x)/x^2
> > }}}
> 
> For this one I hope we can enroll the help of some symbolics experts. A related older ticket: #16697
> 
M(1,3,x) = 1F1(1,3,x) - a.k.a Kummer function, whereas lower incomplete gamma is
gamma(a,x)=x<sup>a</sup>/a 1F1(a,a+1,-x), a=2, i.e.
the claim is that 1F1(1,3,x)=-exp(x) 1F1(2,3,-x).
So this seems to be Kummer transform from https://en.wikipedia.org/wiki/Confluent_hypergeometric_function#Kummer's_transformation 

but with a wrong sign (modulo typos...)

see also https://dlmf.nist.gov/13.6#E5


---

Comment by mkoeppe created at 2020-07-20 15:41:55

From the maxima 5.43 change log:

 * series expansion for expintegral_si and gamma_incomplete; breaks
   some existing tests, see commit 47a6afd.

From the maxima 5.44 change log:

 * gamma_incomplete_lower is now returned in the noun form in many places
 * Taylor expansion for gamma_incomplete_lower(1/2,z) now works
 * gamma_incomplete_lower now respects gamma_expand

I note the following:

```
sage: hypergeometric_M(1, 3, 1).n()
1.43656365691809
sage: hypergeometric_M(1, 3, 1).simplify_hypergeometric()
2*e*gamma_incomplete_lower(2, 1)
sage: hypergeometric_M(1, 3, 1).simplify_hypergeometric().n()
TypeError: cannot evaluate symbolic expression numerically
```



---

Comment by mkoeppe created at 2020-07-26 05:29:07

Changing status from new to needs_info.


---

Comment by kcrisman created at 2020-07-30 13:35:29

For the problem in comment:22 I recommend doing as Nils mentions in the recent sage-devel discussion around a Maxima infinite recursion error, and isolate which Maxima commands do this.   I believe `simplify_hypergeometric` is a Maxima command wrapper, so it should be completely replicated in Maxima.  By the way, in diagnosing this, a a few things to note.

```
sage: hypergeometric_M(1, 3, x)
hypergeometric_M(1, 3, x)
sage: maxima_calculus(hypergeometric_M(1,3,x))
kummer_m(1,3,_SAGE_VAR_x)
```

but

```
sage: B = hypergeometric_M(1, 3, x)
sage: B.generalized()
hypergeometric((1,), (3,), x)
sage: maxima_calculus(B.generalized())
hypergeometric([1],[3],_SAGE_VAR_x)
```

and also don't forget

```
sage: B.simplify_hypergeometric(algorithm='sage')
-2*(x - e^x + 1)/x^2
```

Unfortunately I don't have a chance to check out this update in order to diagnose the problem further.  I do note that the `hgfred` uses `maxima` and not `maxima_calculus`, though perhaps it is imported as such earlier in the file.


---

Comment by git created at 2020-08-14 09:11:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2020-08-14 09:22:44

I was working on upgrading Maxima too (as i did not see that ticket), so while i am not a symbolics expert, i fixed the `gamma_incomplete_lower` issue: that function was called `gamma_greek` by Maxima before.

I also marked the intergration regression as known bug.

I think it is ready for review now.


---

Comment by tmonteil created at 2020-08-14 09:22:44

Changing status from needs_info to needs_review.


---

Comment by tmonteil created at 2020-08-14 09:22:44

Changing type from task to enhancement.


---

Comment by tmonteil created at 2020-08-14 09:22:44

Changing priority from minor to major.


---

Comment by charpent created at 2020-08-14 09:36:59

I'm trying to test this one. `make` started to get`gcc 9.2.0` (whereas the system's `gcc` is at `10.1.0`).

WTF ?


---

Comment by tmonteil created at 2020-08-14 10:19:46

Replying to [comment:31 charpent]:
> I'm trying to test this one. `make` started to get`gcc 9.2.0` (whereas the system's `gcc` is at `10.1.0`).
> 
> WTF ?
>  

This is probably because #29674 has been merged. Is it not related to the current ticket.


---

Comment by charpent created at 2020-08-14 10:35:57

Replying to [comment:32 tmonteil]:
> Replying to [comment:31 charpent]:
> > I'm trying to test this one. `make` started to get`gcc 9.2.0` (whereas the system's `gcc` is at `10.1.0`).
> > 
> > WTF ?
> >  
> 
> This is probably because #29674 has been merged. Is it not related to the current ticket.

That was merged three months ago. I have rebuild and|or ipgraded my `sage` installation a few times since, and this never happened.

Furthermore, I tried reconfiguring with `./configure CC=gcc-9 CXX=g++-9 FC=gfortran-9 --enable-download-from-upstream-url` ; `configure` now wants to install a bunch of system packages that //were// accepted before. Its answers :

```
configure: notice: the following SPKGs did not find equivalent system packages: cbc coxeter3 fflas_ffpack gfortran gsl iml openblas r suitesparse
checking for the package system in use... debian
configure: hint: installing the following system packages is recommended and may avoid building some of the above SPKGs from source:
configure:   $ sudo apt-get update 
  $ sudo apt-get install coinor-cbc coinor-libcbc-dev fflas-ffpack gfortran libgsl-dev libiml-dev libopenblas-dev r-base-dev r-cran-lattice libsuitesparse-dev
configure: After installation, re-run configure using:
configure:   $ ./config.status --recheck && ./config.status
```


Attempting a (simulated) installation tells me that all those packages are already at their latest versions... and the check fails again.

I'm afraid to be stuck...


---

Comment by charpent created at 2020-08-14 10:48:46

Replying to [comment:33 charpent]:

[ Snip... ]

> I'm afraid to be stuck...

Re-reading my terminal I may have typed a small but devastating typo. I cleaned up and retried, and things seem to be OK for now.

//Deeply// sorry for the noise...


---

Comment by mkoeppe created at 2020-08-14 11:49:14

Replying to [comment:30 tmonteil]:
> I was working on upgrading Maxima too (as i did not see that ticket), so while i am not a symbolics expert, i fixed the `gamma_incomplete_lower` issue: that function was called `gamma_greek` by Maxima before.
> 
> I also marked the intergration regression as known bug.
> 
> I think it is ready for review now.

Thanks for working on this! 

Do we actually know whether this new Maxima version brings any improvements that are relevant for us -- given that there is this regression?


---

Comment by mkoeppe created at 2020-08-14 11:53:33

Replying to [comment:35 mkoeppe]:
> Do we actually know whether this new Maxima version brings any improvements that are relevant for us -- given that there is this regression?

OK, I see, #28538


---

Comment by mkoeppe created at 2020-08-14 11:55:54

Dima had a concern about a possible sign error in comment 23 above - could someone double check?


---

Comment by slelievre created at 2020-08-14 12:12:42

Tickets with this ticket as a dependency:

- https://trac.sagemath.org/query?dependencies=~30063&desc=1&order=id


---

Comment by charpent created at 2020-08-14 12:52:05

Changing status from needs_review to positive_review.


---

Comment by charpent created at 2020-08-14 12:52:05

Okay. `ptestlong` gives me the same (unrelated) failures as what I have already reported since `9.2.beta3` (IIRC).

Concerning comment 23 :

```
sage: hypergeometric_M(1, 3, x).simplify_hypergeometric()                       
-2*((x + 1)*e^(-x) - 1)*e^x/x^2
sage: hypergeometric_M(1, 3, x).simplify_hypergeometric().factor()              
-2*(x - e^x + 1)/x^2
```


which seems kosher :

```
sage: mathematica.FullSimplify(hypergeometric_M(1, 3, x)).sage().factor()       
-2*(x - e^x + 1)/x^2
```


==> (tentative) `positive_review`.

As always, cross-checks on various platforms are more than useful.

[ Only incidentally related... ] : I **//sternuously//** object to have to retain obsolete versions of the compilers in order to be able to compile //without being told so//. This problem, which appears only in //some// platforms, should be documented in the `README.md` ; furthermore, `./configure` should :
    * suggest the installation of the relevant packages for older versions (recompiling the `gcc` smalah takes a geological age or two...), **and**
    * suggest reconfiguring with the relevant arguments.

Where should this rant be //usefully// posted ? I am aware of too much tickets related to system configuration and options, and am a bit lost...


---

Comment by slabbe created at 2020-08-14 14:16:37

Reviewer name is missing, I am changing to needs work before the release manager needs to do it.


---

Comment by slabbe created at 2020-08-14 14:16:37

Changing status from positive_review to needs_work.


---

Comment by mkoeppe created at 2020-08-14 15:09:18

Also, this ticket should undergo portability testing before it should be set to "positive review".


---

Comment by mkoeppe created at 2020-08-14 15:14:48

Replying to [comment:39 charpent]:
>  `./configure` should :
>     * suggest the installation of the relevant packages for older versions (recompiling the `gcc` smalah takes a geological age or two...), **and**
>     * suggest reconfiguring with the relevant arguments.
> 
> Where should this ... be //usefully// posted ?

Try #29586 (Improve `configure`'s recommendations). It would be helpful to include the messages that `configure` prints on your system, and to explain what is missing.


---

Comment by mkoeppe created at 2020-08-14 15:16:32

Changing status from needs_work to needs_review.


---

Comment by charpent created at 2020-08-14 15:28:52

Adding my name (as I should have initially...), but keeping it at `needs_review`.


---

Comment by charpent created at 2020-08-14 15:31:41

Replying to [comment:41 mkoeppe]:
> Also, this ticket should undergo portability testing before it should be set to "positive review". 

I agree. But `trac` lacks a state of `tentative_positive_review`, which should be useful in similar situations (i. e. code changes with (known|potential) platform issues...).


---

Comment by charpent created at 2020-08-14 15:33:33

Replying to [comment:40 slabbe]:
> Reviewer name is missing, I am changing to needs work before the release manager needs to do it.

Damn ! I keep forgetting this. Old age ? Incipient Alzheimer's ?

Done, anyway.


---

Comment by mkoeppe created at 2020-08-15 00:31:09

All clean on debian and ubuntu, waiting for more results


---

Comment by pbruin created at 2020-08-15 06:41:59

Replying to [comment:30 tmonteil]:
> I was working on upgrading Maxima too (as i did not see that ticket), so while i am not a symbolics expert, i fixed the `gamma_incomplete_lower` issue: that function was called `gamma_greek` by Maxima before.
Nice solution!
> I also marked the intergration regression as known bug.
Would it be worth finding out when this regression was introduced in Maxima and try to add a patch to fix it?


---

Comment by dimpase created at 2020-08-15 07:00:15

Replying to [comment:42 mkoeppe]:
> Replying to [comment:39 charpent]:
> >  `./configure` should :
> >     * suggest the installation of the relevant packages for older versions (recompiling the `gcc` smalah takes a geological age or two...), **and**
> >     * suggest reconfiguring with the relevant arguments.
> > 
> > Where should this ... be //usefully// posted ?
> 
> Try #29586 (Improve `configure`'s recommendations). It would be helpful to include the messages that `configure` prints on your system, and to explain what is missing.

I would change the default ./configure outcomes of not finding gcc, gfortran, gmp, etc to Error.
(which can be overridden by specifying  explicit options)


---

Comment by tmonteil created at 2020-08-19 11:58:13

Replying to [comment:49 pbruin]:
> Replying to [comment:30 tmonteil]:
> > I was working on upgrading Maxima too (as i did not see that ticket), so while i am not a symbolics expert, i fixed the `gamma_incomplete_lower` issue: that function was called `gamma_greek` by Maxima before.
> Nice solution!
> > I also marked the intergration regression as known bug.
> Would it be worth finding out when this regression was introduced in Maxima and try to add a patch to fix it?

It goes far beyond my skills, as i never wrote a single line of lisp.

The best i can do is to [report the regression upstream](https://sourceforge.net/p/maxima/bugs/3649/) and follow its evolution to untag the corresponding doctest once it is fixed. I am not sure this regression should prevent us to update Maxima.


---

Comment by kcrisman created at 2020-08-19 12:10:46

> The best i can do is to [report the regression upstream](https://sourceforge.net/p/maxima/bugs/3649/) and follow its evolution to untag the corresponding doctest once it is fixed. I am not sure this regression should prevent us to update Maxima.

You can also open a new ticket for tracking that upstream report so we don't lose it (as opposed to only noticing the doctest change if Maxima fixes this, if anyone even tests the "known bug" doctests much).  I agree that if there is significant improvement introduced, then in practice we have often upgraded on a utilitarian view of things.


---

Comment by tmonteil created at 2020-08-19 12:32:51

Replying to [comment:52 kcrisman]:
> > The best i can do is to [report the regression upstream](https://sourceforge.net/p/maxima/bugs/3649/) and follow its evolution to untag the corresponding doctest once it is fixed. I am not sure this regression should prevent us to update Maxima.
> 
> You can also open a new ticket for tracking that upstream report so we don't lose it (as opposed to only noticing the doctest change if Maxima fixes this, if anyone even tests the "known bug" doctests much).  I agree that if there is significant improvement introduced, then in practice we have often upgraded on a utilitarian view of things.

Follow-up for tracking this issue: #30389


---

Comment by charpent created at 2020-08-19 12:40:23

Replying to [comment:52 kcrisman]:
> > The best i can do is to [report the regression upstream](https://sourceforge.net/p/maxima/bugs/3649/) and follow its evolution to untag the corresponding doctest once it is fixed. I am not sure this regression should prevent us to update Maxima.
> 
> You can also open a new ticket for tracking that upstream report so we don't lose it (as opposed to only noticing the doctest change if Maxima fixes this, if anyone even tests the "known bug" doctests much).  I agree that if there is significant improvement introduced, then in practice we have often upgraded on a utilitarian view of things.

Possibly related : #30379 and the fossil tickets mentioned therein...


---

Comment by charpent created at 2020-08-19 13:59:21

Replying to [comment:48 mkoeppe]:
> All clean on debian and ubuntu, waiting for more results

FWIW, worked again in upgrading to 9.2.beta9.


---

Comment by mkoeppe created at 2020-08-19 17:35:16

Changing status from needs_review to positive_review.


---

Comment by slelievre created at 2020-08-19 23:10:15

Changing keywords from "" to "upgrade, maxima".


---

Comment by vbraun created at 2020-08-20 22:22:49

Resolution: fixed
