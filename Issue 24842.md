# Issue 24842: Use _mul_long Matrix*int

archive/issues_024842.json:
```json
{
    "body": "Keywords: Matrix _mul_long\n\nsage.structure.element does support the use of _mul_long for a multiplication of the form Element*int. However, the multiplication of Matrix*int does not use that short-cut.\n\nIn fact, currently only one matrix type implements _mul_long, namely Matrix_gfpn_dense. Unfortunately it uses a conversion that does not coincide with the coercion into the base ring.\n\nSo, this ticket is about fixing both issues.\n\nIssue created by migration from https://trac.sagemath.org/ticket/25079\n\n",
    "created_at": "2018-04-02T15:20:56Z",
    "labels": [
        "component: coercion",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.3",
    "title": "Use _mul_long Matrix*int",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24842",
    "user": "https://github.com/simon-king-jena"
}
```
Keywords: Matrix _mul_long

sage.structure.element does support the use of _mul_long for a multiplication of the form Element*int. However, the multiplication of Matrix*int does not use that short-cut.

In fact, currently only one matrix type implements _mul_long, namely Matrix_gfpn_dense. Unfortunately it uses a conversion that does not coincide with the coercion into the base ring.

So, this ticket is about fixing both issues.

Issue created by migration from https://trac.sagemath.org/ticket/25079





---

archive/issue_comments_348499.json:
```json
{
    "body": "In the current branch, I am basically copying relevant parts of `Element.__mul__` into `Matrix.__mul__`. The timings improve considerably, at least for Matrix_gfpn_dense.\n\nWithout the branch:\n\n```\nsage: M = random_matrix(GF(9,'x'), 64,51)\nsage: c = int(4)\nsage: %timeit M*c\nThe slowest run took 173.53 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 10.3 \u00b5s per loop\nsage: %timeit c*M\nThe slowest run took 34.51 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 10.2 \u00b5s per loop\n```\n\n\nWith the branch:\n\n```\nsage: M = random_matrix(GF(9,'x'), 64,51)\nsage: c = int(4)\nsage: %timeit M*c\nThe slowest run took 25.57 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000000 loops, best of 3: 1.53 \u00b5s per loop\nsage: %timeit c*M\nThe slowest run took 26.66 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000000 loops, best of 3: 1.57 \u00b5s per loop\n```\n\n\nI didn't run the test suite yet, but for now I am asking for review...\n----\nNew commits:",
    "created_at": "2018-04-02T15:48:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348499",
    "user": "https://github.com/simon-king-jena"
}
```

In the current branch, I am basically copying relevant parts of `Element.__mul__` into `Matrix.__mul__`. The timings improve considerably, at least for Matrix_gfpn_dense.

Without the branch:

```
sage: M = random_matrix(GF(9,'x'), 64,51)
sage: c = int(4)
sage: %timeit M*c
The slowest run took 173.53 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 10.3 µs per loop
sage: %timeit c*M
The slowest run took 34.51 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 10.2 µs per loop
```


With the branch:

```
sage: M = random_matrix(GF(9,'x'), 64,51)
sage: c = int(4)
sage: %timeit M*c
The slowest run took 25.57 times longer than the fastest. This could mean that an intermediate result is being cached.
1000000 loops, best of 3: 1.53 µs per loop
sage: %timeit c*M
The slowest run took 26.66 times longer than the fastest. This could mean that an intermediate result is being cached.
1000000 loops, best of 3: 1.57 µs per loop
```


I didn't run the test suite yet, but for now I am asking for review...
----
New commits:



---

archive/issue_comments_348500.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-04-02T15:48:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348500",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_348501.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-04-02T15:50:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348501",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_348502.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-04-02T15:52:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348502",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_348503.json:
```json
{
    "body": "Sorry, I had forgotten to add a test. So, I changed the last commit (sorry for the forced push, but nobody was using the old commit yet).\n\nHere is what happens for other matrix types:\nWith the branch:\n\n```\nsage: M = random_matrix(GF(3,'x'), 64,51)\nsage: %timeit c*M\nThe slowest run took 52.64 times longer than the fastest. This could mean that an intermediate result is being cached.\n10000 loops, best of 3: 26 \u00b5s per loop\n```\n\nWithout the branch:\n\n```\nsage: M = random_matrix(GF(3,'x'), 64,51)\nsage: %timeit c*M\nThe slowest run took 123.98 times longer than the fastest. This could mean that an intermediate result is being cached.\n10000 loops, best of 3: 24.4 \u00b5s per loop\n```\n\nSo, it seems that enabling _mul_long (which basically means: Using the existing default _mul_long) seems to not slow down the old code substantially.",
    "created_at": "2018-04-02T15:54:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348503",
    "user": "https://github.com/simon-king-jena"
}
```

Sorry, I had forgotten to add a test. So, I changed the last commit (sorry for the forced push, but nobody was using the old commit yet).

Here is what happens for other matrix types:
With the branch:

```
sage: M = random_matrix(GF(3,'x'), 64,51)
sage: %timeit c*M
The slowest run took 52.64 times longer than the fastest. This could mean that an intermediate result is being cached.
10000 loops, best of 3: 26 µs per loop
```

Without the branch:

```
sage: M = random_matrix(GF(3,'x'), 64,51)
sage: %timeit c*M
The slowest run took 123.98 times longer than the fastest. This could mean that an intermediate result is being cached.
10000 loops, best of 3: 24.4 µs per loop
```

So, it seems that enabling _mul_long (which basically means: Using the existing default _mul_long) seems to not slow down the old code substantially.



---

archive/issue_comments_348504.json:
```json
{
    "body": "All tests pass (with meataxe installed)...",
    "created_at": "2018-04-02T18:09:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348504",
    "user": "https://github.com/simon-king-jena"
}
```

All tests pass (with meataxe installed)...



---

archive/issue_comments_348505.json:
```json
{
    "body": "I might review this, but I would rather do that after the dependencies have been merged.",
    "created_at": "2018-04-06T07:53:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348505",
    "user": "https://github.com/jdemeyer"
}
```

I might review this, but I would rather do that after the dependencies have been merged.



---

archive/issue_comments_348506.json:
```json
{
    "body": "Already this comment is wrong:\n\n```\nMultiply an MTX matrix with a field element represented by a Python integer.\n```\n\nIt's certainly not a Python integer, it's a C `long`. It would be fine for me to keep the old wording (\"an integer\").",
    "created_at": "2018-04-06T07:55:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348506",
    "user": "https://github.com/jdemeyer"
}
```

Already this comment is wrong:

```
Multiply an MTX matrix with a field element represented by a Python integer.
```

It's certainly not a Python integer, it's a C `long`. It would be fine for me to keep the old wording ("an integer").



---

archive/issue_comments_348507.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-04-06T07:55:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348507",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_348508.json:
```json
{
    "body": "The code in `src/sage/structure/element.pyx` looks strange. It's certainly inefficient because `have_same_parent()` calls `classify_elements` so you're effectively calling `classify_elements` twice. It's also missing the typical `return NotImplemented` fallback that other operators have.",
    "created_at": "2018-04-06T07:59:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348508",
    "user": "https://github.com/jdemeyer"
}
```

The code in `src/sage/structure/element.pyx` looks strange. It's certainly inefficient because `have_same_parent()` calls `classify_elements` so you're effectively calling `classify_elements` twice. It's also missing the typical `return NotImplemented` fallback that other operators have.



---

archive/issue_comments_348509.json:
```json
{
    "body": "Replying to [comment:8 jdemeyer]:\n> Already this comment is wrong:\n> {{{\n> Multiply an MTX matrix with a field element represented by a Python integer.\n> }}}\n> It's certainly not a Python integer, it's a C `long`. It would be fine for me to keep the old wording (\"an integer\").\n\nThis ticket is related with an error that was actually solved (but not via `_mul_long_`) and was of the form `M*int(1)`. That's why I wrote \"Python integer\".\n\nBut if you prefer \"C long\", I'm fine with it.",
    "created_at": "2018-04-06T10:37:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348509",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:8 jdemeyer]:
> Already this comment is wrong:
> {{{
> Multiply an MTX matrix with a field element represented by a Python integer.
> }}}
> It's certainly not a Python integer, it's a C `long`. It would be fine for me to keep the old wording ("an integer").

This ticket is related with an error that was actually solved (but not via `_mul_long_`) and was of the form `M*int(1)`. That's why I wrote "Python integer".

But if you prefer "C long", I'm fine with it.



---

archive/issue_comments_348510.json:
```json
{
    "body": "Replying to [comment:10 SimonKing]:\n> This ticket is related with an error that was actually solved (but not via `_mul_long_`) and was of the form `M*int(1)`. That's why I wrote \"Python integer\".\n\nRight, this ticket fixes a problem involving a Python integer. But the function `_mul_long` itself has nothing to do with Python integers.\n\n> But if you prefer \"C long\", I'm fine with it.\n\nEither that or revert to the old wording.",
    "created_at": "2018-04-06T10:40:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348510",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:10 SimonKing]:
> This ticket is related with an error that was actually solved (but not via `_mul_long_`) and was of the form `M*int(1)`. That's why I wrote "Python integer".

Right, this ticket fixes a problem involving a Python integer. But the function `_mul_long` itself has nothing to do with Python integers.

> But if you prefer "C long", I'm fine with it.

Either that or revert to the old wording.



---

archive/issue_comments_348511.json:
```json
{
    "body": "Replying to [comment:9 jdemeyer]:\n> The code in `src/sage/structure/element.pyx` looks strange. It's certainly inefficient because `have_same_parent()` calls `classify_elements` so you're effectively calling `classify_elements` twice. It's also missing the typical `return NotImplemented` fallback that other operators have.\n\nI copied it from some other place of `element.pyx` and it may very well be that I did wrong. So, I should call `classify_elements` in the beginning and then call `HAVE_SAME_PARENT(cl)` instead of `have_same_parents`.\n\nAnd I'll return to the original wording.",
    "created_at": "2018-04-06T10:42:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348511",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:9 jdemeyer]:
> The code in `src/sage/structure/element.pyx` looks strange. It's certainly inefficient because `have_same_parent()` calls `classify_elements` so you're effectively calling `classify_elements` twice. It's also missing the typical `return NotImplemented` fallback that other operators have.

I copied it from some other place of `element.pyx` and it may very well be that I did wrong. So, I should call `classify_elements` in the beginning and then call `HAVE_SAME_PARENT(cl)` instead of `have_same_parents`.

And I'll return to the original wording.



---

archive/issue_comments_348512.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-04-06T10:48:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348512",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_348513.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-04-06T10:49:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348513",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_348514.json:
```json
{
    "body": "Done!",
    "created_at": "2018-04-06T10:49:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348514",
    "user": "https://github.com/simon-king-jena"
}
```

Done!



---

archive/issue_comments_348515.json:
```json
{
    "body": "PS: I repeated the timings that I provided in comment:2 and comment:5.\n\n\n```\nsage: M = random_matrix(GF(9,'x'), 64,51)\nsage: type(M)\n<type 'sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense'>\nsage: c = int(4)\nsage: %timeit M*c\nThe slowest run took 29.39 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000000 loops, best of 3: 1.26 \u00b5s per loop\nsage: %timeit c*M\nThe slowest run took 15.87 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000000 loops, best of 3: 1.26 \u00b5s per loop\nsage: M = random_matrix(GF(3,'x'), 64,51)\nsage: type(M)\n<type 'sage.matrix.matrix_modn_dense_float.Matrix_modn_dense_float'>\nsage: %timeit M*c\nThe slowest run took 53.27 times longer than the fastest. This could mean that an intermediate result is being cached.\n10000 loops, best of 3: 20.7 \u00b5s per loop\nsage: %timeit c*M\n10000 loops, best of 3: 21 \u00b5s per loop\n```\n\n\nHence, there is now a slight improvement for Matrix_modn_dense_float (with the old branch, there was a small deterioration), and the improvement for Matrix_gfpn_dense is now even better. So, thank you for spotting the issue with `classify_elements` --- it had a noticeable effect.",
    "created_at": "2018-04-06T10:53:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348515",
    "user": "https://github.com/simon-king-jena"
}
```

PS: I repeated the timings that I provided in comment:2 and comment:5.


```
sage: M = random_matrix(GF(9,'x'), 64,51)
sage: type(M)
<type 'sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense'>
sage: c = int(4)
sage: %timeit M*c
The slowest run took 29.39 times longer than the fastest. This could mean that an intermediate result is being cached.
1000000 loops, best of 3: 1.26 µs per loop
sage: %timeit c*M
The slowest run took 15.87 times longer than the fastest. This could mean that an intermediate result is being cached.
1000000 loops, best of 3: 1.26 µs per loop
sage: M = random_matrix(GF(3,'x'), 64,51)
sage: type(M)
<type 'sage.matrix.matrix_modn_dense_float.Matrix_modn_dense_float'>
sage: %timeit M*c
The slowest run took 53.27 times longer than the fastest. This could mean that an intermediate result is being cached.
10000 loops, best of 3: 20.7 µs per loop
sage: %timeit c*M
10000 loops, best of 3: 21 µs per loop
```


Hence, there is now a slight improvement for Matrix_modn_dense_float (with the old branch, there was a small deterioration), and the improvement for Matrix_gfpn_dense is now even better. So, thank you for spotting the issue with `classify_elements` --- it had a noticeable effect.



---

archive/issue_comments_348516.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-05-15T10:34:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348516",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_348517.json:
```json
{
    "body": "Can you also add the `except TypeError: return NotImplemented` fallback from `Element.__mul__`",
    "created_at": "2018-05-15T10:34:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348517",
    "user": "https://github.com/jdemeyer"
}
```

Can you also add the `except TypeError: return NotImplemented` fallback from `Element.__mul__`



---

archive/issue_comments_348518.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-06-01T19:39:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348518",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_348519.json:
```json
{
    "body": "Replying to [comment:16 jdemeyer]:\n> Can you also add the `except TypeError: return NotImplemented` fallback from `Element.__mul__`\n\nDone, I think.",
    "created_at": "2018-06-01T19:40:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348519",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:16 jdemeyer]:
> Can you also add the `except TypeError: return NotImplemented` fallback from `Element.__mul__`

Done, I think.



---

archive/issue_comments_348520.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-06-01T19:40:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348520",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_348521.json:
```json
{
    "body": "Do you have any idea why the patchbot reports failing tests? I don't get those failures.",
    "created_at": "2018-06-02T15:18:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348521",
    "user": "https://github.com/simon-king-jena"
}
```

Do you have any idea why the patchbot reports failing tests? I don't get those failures.



---

archive/issue_comments_348522.json:
```json
{
    "body": "Please add tests for multiplying with a **negative** integer.",
    "created_at": "2018-06-04T07:52:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348522",
    "user": "https://github.com/jdemeyer"
}
```

Please add tests for multiplying with a **negative** integer.



---

archive/issue_comments_348523.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-06-04T07:56:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348523",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_348524.json:
```json
{
    "body": "Code looks good to me. So once you add the negative integer tests for meataxe, I will run full doctests. If that passes => positive review",
    "created_at": "2018-06-04T07:56:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348524",
    "user": "https://github.com/jdemeyer"
}
```

Code looks good to me. So once you add the negative integer tests for meataxe, I will run full doctests. If that passes => positive review



---

archive/issue_comments_348525.json:
```json
{
    "body": "Replying to [comment:22 jdemeyer]:\n> Code looks good to me. So once you add the negative integer tests for meataxe, I will run full doctests. If that passes => positive review\n\nGood catch --- there is in fact a bug for multiplication with a negative Python long.",
    "created_at": "2018-06-04T14:48:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348525",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:22 jdemeyer]:
> Code looks good to me. So once you add the negative integer tests for meataxe, I will run full doctests. If that passes => positive review

Good catch --- there is in fact a bug for multiplication with a negative Python long.



---

archive/issue_comments_348526.json:
```json
{
    "body": "Problem: Apparently `-1%3` evaluates to `-1`, not `2`. Is there an easy way to get a non-negative remainder?",
    "created_at": "2018-06-04T18:37:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348526",
    "user": "https://github.com/simon-king-jena"
}
```

Problem: Apparently `-1%3` evaluates to `-1`, not `2`. Is there an easy way to get a non-negative remainder?



---

archive/issue_comments_348527.json:
```json
{
    "body": "Strange enough: I just tried to create cython code in which `-1%3` evaluates to `-1`, but I failed --- but in the MeatAxe wrapper it does evaluate to `-1`. Why?",
    "created_at": "2018-06-04T18:42:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348527",
    "user": "https://github.com/simon-king-jena"
}
```

Strange enough: I just tried to create cython code in which `-1%3` evaluates to `-1`, but I failed --- but in the MeatAxe wrapper it does evaluate to `-1`. Why?



---

archive/issue_comments_348528.json:
```json
{
    "body": "Replying to [comment:25 SimonKing]:\n> Strange enough: I just tried to create cython code in which `-1%3` evaluates to `-1`, but I failed --- but in the MeatAxe wrapper it does evaluate to `-1`. Why?\n\nThe **Python** convention is rounding down, so -1 divided by 3 gives quotient -1 and remainder 2.\n\nThe **C** convention is truncating, so -1 divided by 3 gives quotient 0 and remainder -1.\n\nCython always uses the Python convention, unless the `cdivision=True` directive is set (which is not the default, but it is set in Sage) and one of the arguments is a C integer.\n\nExamples:\n\nPython integers, always Python convention:\n\n```\nsage: cython('''\n....: print((-1) % 3)\n....: ''')\n2\n```\n\n\nC integers, result depends on `cdivision`:\n\n```\nsage: cython('''\n....: print(<int>(-1) % <int>3)\n....: ''')\n2\n```\n\n\n\n```\nsage: cython('''\n....: cimport cython\n....: \n....: with cython.cdivision(True):\n....:     print(<int>(-1) % <int>3)\n....: ''')\n-1\n```\n\n\nIn fact, it suffices that one of the arguments is a C integer:\n\n\n```\nsage: cython('''\n....: cimport cython\n....: \n....: with cython.cdivision(True):\n....:     print(<int>(-1) % 3)\n....: ''')\n-1\nsage: cython('''\n....: cimport cython\n....: \n....: with cython.cdivision(True):\n....:     print((-1) % <int>3)\n....: ''')\n-1\n```\n\n\nSage is compiled with `cdivision=True` for historical reasons and for efficiency (`cdivision=False` adds a bit of overhead for every division of signed C integers).",
    "created_at": "2018-06-04T19:48:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348528",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:25 SimonKing]:
> Strange enough: I just tried to create cython code in which `-1%3` evaluates to `-1`, but I failed --- but in the MeatAxe wrapper it does evaluate to `-1`. Why?

The **Python** convention is rounding down, so -1 divided by 3 gives quotient -1 and remainder 2.

The **C** convention is truncating, so -1 divided by 3 gives quotient 0 and remainder -1.

Cython always uses the Python convention, unless the `cdivision=True` directive is set (which is not the default, but it is set in Sage) and one of the arguments is a C integer.

Examples:

Python integers, always Python convention:

```
sage: cython('''
....: print((-1) % 3)
....: ''')
2
```


C integers, result depends on `cdivision`:

```
sage: cython('''
....: print(<int>(-1) % <int>3)
....: ''')
2
```



```
sage: cython('''
....: cimport cython
....: 
....: with cython.cdivision(True):
....:     print(<int>(-1) % <int>3)
....: ''')
-1
```


In fact, it suffices that one of the arguments is a C integer:


```
sage: cython('''
....: cimport cython
....: 
....: with cython.cdivision(True):
....:     print(<int>(-1) % 3)
....: ''')
-1
sage: cython('''
....: cimport cython
....: 
....: with cython.cdivision(True):
....:     print((-1) % <int>3)
....: ''')
-1
```


Sage is compiled with `cdivision=True` for historical reasons and for efficiency (`cdivision=False` adds a bit of overhead for every division of signed C integers).



---

archive/issue_comments_348529.json:
```json
{
    "body": "Replying to [comment:26 jdemeyer]:\n> Sage is compiled with `cdivision=True` for historical reasons and for efficiency (`cdivision=False` adds a bit of overhead for every division of signed C integers).\n\nSo, the easiest way out is to use `with cython.cdivision(False)` in this single line of code, right?",
    "created_at": "2018-06-04T19:54:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348529",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:26 jdemeyer]:
> Sage is compiled with `cdivision=True` for historical reasons and for efficiency (`cdivision=False` adds a bit of overhead for every division of signed C integers).

So, the easiest way out is to use `with cython.cdivision(False)` in this single line of code, right?



---

archive/issue_comments_348530.json:
```json
{
    "body": "Replying to [comment:27 SimonKing]:\n> So, the easiest way out is to use `with cython.cdivision(False)` in this single line of code, right?\n\nSure.",
    "created_at": "2018-06-04T20:06:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348530",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:27 SimonKing]:
> So, the easiest way out is to use `with cython.cdivision(False)` in this single line of code, right?

Sure.



---

archive/issue_comments_348531.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-06-04T21:21:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348531",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_348532.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-06-04T21:23:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348532",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_348533.json:
```json
{
    "body": "Thank you for pointing me to the cdivision directive.\n\nI added a test showing that multiplication with a negative int works, and with that `make ptest` passes on my laptop. So, needs review.",
    "created_at": "2018-06-04T21:23:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348533",
    "user": "https://github.com/simon-king-jena"
}
```

Thank you for pointing me to the cdivision directive.

I added a test showing that multiplication with a negative int works, and with that `make ptest` passes on my laptop. So, needs review.



---

archive/issue_comments_348534.json:
```json
{
    "body": "Rebased on top of #25476.\n----\nNew commits:",
    "created_at": "2018-06-06T12:01:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348534",
    "user": "https://github.com/jdemeyer"
}
```

Rebased on top of #25476.
----
New commits:



---

archive/issue_comments_348535.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-06-06T12:09:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348535",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_348536.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-06-07T22:15:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24842#issuecomment-348536",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_023168.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2018-06-07T22:15:15Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24842",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24842#event-23168"
}
```
