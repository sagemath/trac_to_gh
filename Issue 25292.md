# Issue 25292: Implement Sieving to replace search enumeration

Issue created by migration from Trac.

Original creator: raghukul01

Original creation time: 2018-06-07 13:02:00

CC:  bhutz raghukul01

Keywords: gsoc2018

replace search enumeration for subschemes of dimension > 0 by sieving, to compute rational points


---

Comment by raghukul01 created at 2018-06-15 18:09:49

added projective version: initial commit
----
New commits:


---

Comment by git created at 2018-06-19 23:09:06

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by raghukul01 created at 2018-06-19 23:13:17

Changing status from new to needs_review.


---

Comment by bhutz created at 2018-06-22 18:12:54

Changing component from number theory to algebraic geometry.


---

Comment by bhutz created at 2018-06-22 18:12:54

first comments from the code by file:

- affine_rat_point

sieve:
- dimension 0 should be fine why do the docs limit to positive? We just have a better algorithm for dimension 0, so sieving shouldn't be needed.

- output B should be bound

-  I don't understand the point of the test, doesnt rational_point call sieve?

You can use dehomogenize to get the affine points back, but unfortunately the affine patch they are in is not exactly the same scheme as the original, so still need to coherence to the correct space

```
for point in proj_L:
   if point[0] != 0:
      LL.add(X(point.dehomomgenize(0)))
```



- need new line at end of file
----
- algebraic scheme

normalize:
 - needs short one line description before longer description.
 - need to define what it means to 'normalize'

 - I think QQbar should also work for BR as well as number field orders (the geenralization of ZZ for number fieds)

```
from sage.rings.number_field.order import is_NumberFieldOrder
```


so update NotImplemetedrError accordingly

- any reason not to use 'lcm' to get your 'mult' value?

```
L=[2*x^2 + 4*x*y, 1/8*x + 1/3*y]
lcm([c.denominator() for c in L[1].coefficients()])
```

- similarly for gcd

----
- proj_rat_point

sieve:
- dimen 0 should be fine why do docs limits to positive? We just have a better algorithm for dimension 0, so sieving shouldn't be needed.

- output B should be bound

- I think bound=14 would be a better test from the EC example (so it excludes 15)

- I don't understand the point of the test, shouldn't rational point call sieve?

- docs needs an ALGORITHM block

- need actual citation for the paper (should already be in the Sage references list, so just need the correct [xxxxx]_)


- lift all dimensions of given point -> lift all coordinates of given point

- can early exit the bound check

```
if coordinate.abs() > bound:
    bound_satisfied = False
    break
```


- this can be done in one step

```
points = modulo_points.pop()
```


- Is len_modulo_points used for anything??


main:
- don't use primes as a variable name

- need new line at end of file

----

Now some general comments
 - sieve needs to be added to the rational points logic. The user should not be importing and calling sieve directly. Rather, in rational_points(); sieve should be called under the appropriate condition. Similary for homset.points()


- In the following example

```
P.<x,y,z,q>=ProjectiveSpace(QQ,3)
Y=P.subscheme([x^2-3^2*y^2+z*q,x+z+4*q])
sieve(Y, 27)

```

need bound=27 to see the point of height 9? Is this avoidable or an artifact of the normalization of points since the point in question is height 27 as an integer point. Perhaps this just needs to be very clear in the documentation for the user.

Similar problem for affine, but there there is not a normalization problem, so we are truly missing points. Perhaps need to extend the bound you call the projective sieve with. Perhaps something like

```
bound*lcm(bound,(bound-1),...,(bound-N))
```

as worst case for affine?


---

Comment by bhutz created at 2018-06-22 18:12:54

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-06-26 13:46:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-06-27 05:39:55

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by raghukul01 created at 2018-06-27 05:44:56

len_modulo_points is used in parallel_function_combination() function

I have added most of the changes suggested, 2 things remain as of now:

 - I guess the paper is not present in the reference section.

 - changing the bound for affine sieve to  lcm(bound, bound -1,....), reduced the efficiency of the algorithm. It takes a lot of time (3-4 times) compared to basic enumeration. So I haven't added affine sieve in rational point logic till now. your views on this?


---

Comment by bhutz created at 2018-06-27 19:43:54

- It looks like it is [Hutz2015] in the reference file.

- I'm surprised by that. Could you post the example you are using to test? For very small bounds and dimension, enumeration could be faster, but sieving should quickly overtake enumeration.


---

Comment by raghukul01 created at 2018-06-27 20:02:43

Thanks for the reference file :)

Same test which was present earlier in affine sieve takes a lot of time

```
sage: A.<x,y> = AffineSpace(2, QQ)
sage: C = Curve(x^2+y^2-x)
sage: len(C.rational_points(12)) # long time (6 s)
12
sage: from sage.schemes.affine.affine_rational_point import sieve
sage: len(sieve(C, 12))
12
```



---

Comment by git created at 2018-06-28 10:55:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by raghukul01 created at 2018-06-29 14:09:19

Changing status from needs_work to needs_review.


---

Comment by raghukul01 created at 2018-06-29 14:09:19

Making it `needs review` since it is dependency for #25701 and deciding which algorithm to use for enumeration in affine spaces, can be done via other ticket. seems valid?


---

Comment by bhutz created at 2018-06-30 14:28:29

Changing status from needs_review to needs_work.


---

Comment by bhutz created at 2018-06-30 14:28:29

Most of the fixes look good. A few new things came up.

----

```
sage: enum_affine_rational_field(S(QQ), 3)
sage: enum_affine_rational_field(S(QQ), 3) # long time (10 s)
[(-2, 0, -3, -1)]
```


10s doc test is too long. Find a simpler example.

----


```
if BR == ZZ or BR == QQbar or BR in NumberFields() or is_NumberFieldOrder(BR):
```

remove ZZ check as that duplicates numberfieldorder

----


```
P = (1/div) * P
```


this can change the base_ring for rings, so should coerce to base ring

----


```
ALGORITHM:

This is an implementation of the algorithm in [Hutz2015]_.
```


the algorithm is not described in the reference, you need to provide a description of the algorithm. The reference was for the bound adjustment in the code where you just say 'proposition 4'

----
remove this


```
    This example illustrate efficiency of algorithm::

        sage: from sage.schemes.projective.projective_rational_point import sieve
        sage: P.<x,y,z,q>=ProjectiveSpace(QQ,3)
        sage: Y=P.subscheme([x^2-3^2*y^2+z*q,x+z+4*q])
        sage: len(sieve(Y, 6))
        2
        sage: from sage.schemes.projective.projective_rational_point import enum_projective_rational_field
        sage: len(enum_projective_rational_field(Y, 6)) # long time (5 s)
        2
```


showing the new method is faster than the old method is not a good use of cpu cycles

----


```
    if isinstance(X, AlgebraicScheme_subscheme): # needs to be done only if defining polynomials exist
        X.normalize_defining_polynomials()
```

err...sieve should never be called on something that is not subscheme

also, I think this check is better put into the normalize function anyway

----

for the affine version. I'm inclined to just drop that functionality. The needed bound is too large to be practical and for very small bounds it tends to be worse. I understand the thought to leave sieve in the affine_enum file, but from a user's perspective i think having them call rational points of the projective embedding themselves makes more sense and having unused code around is not a good practice.


---

Comment by git created at 2018-06-30 21:36:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by raghukul01 created at 2018-06-30 21:39:28

Changing status from needs_work to needs_review.


---

Comment by raghukul01 created at 2018-06-30 21:39:28


```
if isinstance(X, AlgebraicScheme_subscheme): # needs to be done only if defining polynomials exist
    X.normalize_defining_polynomials()
```


This is not required in `normalize_defining_polynomials()` since that is a function of `AlgebraicScheme_subscheme` class only.


---

Comment by git created at 2018-07-01 08:16:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bhutz created at 2018-07-01 21:23:47

Changing status from needs_review to needs_work.


---

Comment by bhutz created at 2018-07-01 21:23:47

I see just one issue. The change of parent for the dividing was not fixed by changing to BR.one(). As a specific example look at the parents here


```
P.<x,y,z>=ProjectiveSpace(ZZ,2)
X=P.subscheme([2*x+2*y+4*z])
X.defining_polynomials()[0].parent()
X.normalize_defining_polynomials()
X.defining_polynomials()[0].parent()
```

You need to coerce the result *after* division to be in BR.


---

Comment by git created at 2018-07-02 20:03:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by raghukul01 created at 2018-07-02 20:05:08

Changing status from needs_work to needs_review.


---

Comment by bhutz created at 2018-07-05 15:18:30

Changing status from needs_review to needs_work.


---

Comment by bhutz created at 2018-07-05 15:18:30

That should fix the coercion issue, but when I went to run the longtests the docs don't build


```
[dochtml] OSError: [schemes  ] /local/lib/python2.7/site-packages/sage/schemes/projective/projective_rational_point.py:docstring of sage.schemes.projective.projective_rational_point.sieve:29: WARNING: Block quote ends without a blank line; unexpected unindent.
```



---

Comment by git created at 2018-07-06 09:49:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by raghukul01 created at 2018-07-06 09:50:50

Changing status from needs_work to needs_review.


---

Comment by raghukul01 created at 2018-07-06 09:50:50

Error was due to indent in the output block.


---

Comment by bhutz created at 2018-07-06 15:21:54

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-07-08 13:05:20

Resolution: fixed
